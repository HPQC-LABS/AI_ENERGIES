#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.5                  1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057102        1
[INPUT] 0    0    [1    /1   ]  235.734736575        1
[INPUT] 0    0    [1    /1   ]  76.4330580808        1
[INPUT] 0    0    [1    /1   ]  10.0368852767        1
[INPUT] 0    0    [1    /1   ]  27.0505617402        1
[INPUT] 0    0    [1    /1   ]  0.381431405432       1
[INPUT] 0    0    [1    /1   ]  1.11706583507        1
[INPUT] 0    0    [1    /1   ]  2.88245389209        1
[INPUT] 1    0    [1    /1   ]  3.68488422918        1
[INPUT] 1    0    [1    /1   ]  12.4500387377        1
[INPUT] 1    0    [1    /1   ]  54.7853123067        1
[INPUT] 1    0    [1    /1   ]  0.330264004294       1
[INPUT] 1    0    [1    /1   ]  1.1441596434         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5, 1.0]], [0, [24413.794129990565, 1.0]], [0, [3661.4544699930652, 1.0]], [0, [833.2710571022795, 1.0]], [0, [235.7347365747029, 1.0]], [0, [76.43305808079762, 1.0]], [0, [10.036885276749757, 1.0]], [0, [27.05056174022394, 1.0]], [0, [0.381431405432048, 1.0]], [0, [1.1170658350677358, 1.0]], [0, [2.882453892092585, 1.0]], [1, [3.6848842291763377, 1.0]], [1, [12.450038737732893, 1.0]], [1, [54.78531230674078, 1.0]], [1, [0.330264004293878, 1.0]], [1, [1.1441596434027714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446999]
bas 3, expnt(s) = [833.2710571]
bas 4, expnt(s) = [235.73473657]
bas 5, expnt(s) = [76.43305808]
bas 6, expnt(s) = [10.03688528]
bas 7, expnt(s) = [27.05056174]
bas 8, expnt(s) = [0.38143141]
bas 9, expnt(s) = [1.11706584]
bas 10, expnt(s) = [2.88245389]
bas 11, expnt(s) = [3.68488423]
bas 12, expnt(s) = [12.45003874]
bas 13, expnt(s) = [54.78531231]
bas 14, expnt(s) = [0.330264]
bas 15, expnt(s) = [1.14415964]
CPU time:         1.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00000000e-01 1.50225109e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271057e+02 3.91836372e+02
 2.35734737e+02 1.51996193e+02 7.64330581e+01 6.53094387e+01
 1.00368853e+01 1.42466989e+01 2.70505617e+01 2.99672741e+01
 3.81431405e-01 1.22624531e+00 1.11706584e+00 2.74520070e+00
 2.88245389e+00 5.58903464e+00 3.68488423e+00 1.48940978e+01
 1.24500387e+01 6.82256640e+01 5.47853123e+01 4.34825064e+02
 3.30264004e-01 7.30400304e-01 1.14415964e+00 3.45217398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843511891411
cond(S) = 3379.2416408394624
E1 = -183.5775351272826  E_coul = 55.07853988692495
init E= -128.498995240358
    CPU time for initialize scf      0.14 sec, wall time      0.15 sec
  HOMO = -0.773942506849046  LUMO = 0.689700071702018
  mo_energy =
[-3.25553046e+01 -1.85276852e+00 -7.73942507e-01 -7.73942507e-01
 -7.73942507e-01  6.89700072e-01  1.11563080e+00  1.11563080e+00
  1.11563080e+00  3.00366824e+00  5.77786484e+00  5.77786484e+00
  5.77786484e+00  9.56140625e+00  2.42144834e+01  2.42144834e+01
  2.42144834e+01  3.68561886e+01  1.19115842e+02  1.19115842e+02
  1.19115842e+02  1.40733815e+02  5.04627398e+02  1.87209542e+03
  8.00159504e+03  4.77690364e+04]
E1 = -182.11325745883514  E_coul = 53.58468712248471
cycle= 1 E= -128.52857033635  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.177
    CPU time for cycle= 1      0.28 sec, wall time      0.29 sec
diis-norm(errvec)=0.462665
diis-c [-0.21405851  1.        ]
  HOMO = -0.879377513178656  LUMO = 0.668957464450863
  mo_energy =
[-3.28734294e+01 -1.96289422e+00 -8.79377513e-01 -8.79377513e-01
 -8.79377513e-01  6.68957464e-01  1.07754913e+00  1.07754913e+00
  1.07754913e+00  2.95159148e+00  5.64917216e+00  5.64917216e+00
  5.64917216e+00  9.43579512e+00  2.39799096e+01  2.39799096e+01
  2.39799096e+01  3.66163947e+01  1.18795430e+02  1.18795430e+02
  1.18795430e+02  1.40421466e+02  5.04270699e+02  1.87170263e+03
  8.00117322e+03  4.77685957e+04]
E1 = -182.84412525529498  E_coul = 54.31305603962461
cycle= 2 E= -128.53106921567  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0716
    CPU time for cycle= 2      0.08 sec, wall time      0.08 sec
diis-norm(errvec)=0.230843
diis-c [-6.05489489e-04  3.31909793e-01  6.68090207e-01]
  HOMO = -0.845071027044092  LUMO = 0.675769632085053
  mo_energy =
[-3.27685534e+01 -1.92681905e+00 -8.45071027e-01 -8.45071027e-01
 -8.45071027e-01  6.75769632e-01  1.09002520e+00  1.09002520e+00
  1.09002520e+00  2.96840529e+00  5.69103826e+00  5.69103826e+00
  5.69103826e+00  9.47669951e+00  2.40573614e+01  2.40573614e+01
  2.40573614e+01  3.66957855e+01  1.18900333e+02  1.18900333e+02
  1.18900333e+02  1.40524205e+02  5.04384160e+02  1.87182129e+03
  8.00129431e+03  4.77687177e+04]
E1 = -182.5991715173215  E_coul = 54.067258300550854
cycle= 3 E= -128.531913216771  delta_E= -0.000844  |g|= 0.000459  |ddm|= 0.0258
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000940157
diis-c [-1.28430701e-07 -2.14576055e-03 -5.33074660e-04  1.00267884e+00]
  HOMO = -0.845303863024663  LUMO = 0.675743189217828
  mo_energy =
[-3.27689704e+01 -1.92699193e+00 -8.45303863e-01 -8.45303863e-01
 -8.45303863e-01  6.75743189e-01  1.08997588e+00  1.08997588e+00
  1.08997588e+00  2.96832081e+00  5.69083425e+00  5.69083425e+00
  5.69083425e+00  9.47650276e+00  2.40570344e+01  2.40570344e+01
  2.40570344e+01  3.66954609e+01  1.18899904e+02  1.18899904e+02
  1.18899904e+02  1.40523789e+02  5.04383641e+02  1.87182066e+03
  8.00129359e+03  4.77687170e+04]
E1 = -182.59970287320138  E_coul = 54.06778963730964
cycle= 4 E= -128.531913235892  delta_E= -1.91e-08  |g|= 5.96e-05  |ddm|= 0.000797
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000124461
diis-c [-9.35860798e-10  3.23087873e-04  3.96954558e-04 -2.11484725e-01
  1.21076468e+00]
  HOMO = -0.845334474737549  LUMO = 0.675738205723861
  mo_energy =
[-3.27690207e+01 -1.92701113e+00 -8.45334475e-01 -8.45334475e-01
 -8.45334475e-01  6.75738206e-01  1.08996298e+00  1.08996298e+00
  1.08996298e+00  2.96830669e+00  5.69080025e+00  5.69080025e+00
  5.69080025e+00  9.47647248e+00  2.40569891e+01  2.40569891e+01
  2.40569891e+01  3.66954166e+01  1.18899853e+02  1.18899853e+02
  1.18899853e+02  1.40523738e+02  5.04383583e+02  1.87182060e+03
  8.00129352e+03  4.77687169e+04]
E1 = -182.59980233456386  E_coul = 54.06788909819971
cycle= 5 E= -128.531913236364  delta_E= -4.72e-10  |g|= 6.51e-06  |ddm|= 0.000158
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59980233456386  E_coul = 54.06788909819971
  HOMO = -0.845330858675576  LUMO = 0.675739301048831
  mo_energy =
[-3.27690127e+01 -1.92700683e+00 -8.45330859e-01 -8.45330859e-01
 -8.45330859e-01  6.75739301e-01  1.08996448e+00  1.08996448e+00
  1.08996448e+00  2.96830898e+00  5.69080465e+00  5.69080465e+00
  5.69080465e+00  9.47647704e+00  2.40569959e+01  2.40569959e+01
  2.40569959e+01  3.66954236e+01  1.18899861e+02  1.18899861e+02
  1.18899861e+02  1.40523746e+02  5.04383591e+02  1.87182060e+03
  8.00129353e+03  4.77687169e+04]
E1 = -182.59978443719828  E_coul = 54.0678712008318
Extra cycle  E= -128.531913236366  delta_E= -2.33e-12  |g|= 2.49e-06  |ddm|= 2.31e-06
    CPU time for scf_cycle      0.54 sec, wall time      0.57 sec
exp = [5.00000000e-01 2.44137941e+04 3.66145447e+03 8.33271057e+02
 2.35734737e+02 7.64330581e+01 1.00368853e+01 2.70505617e+01
 3.81431405e-01 1.11706584e+00 2.88245389e+00 3.68488423e+00
 1.24500387e+01 5.47853123e+01 3.30264004e-01 1.14415964e+00]
E = -128.53191323636648
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.5                  1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057102        1
[INPUT] 0    0    [1    /1   ]  235.734736575        1
[INPUT] 0    0    [1    /1   ]  76.4330580808        1
[INPUT] 0    0    [1    /1   ]  10.0368852767        1
[INPUT] 0    0    [1    /1   ]  27.0505617402        1
[INPUT] 0    0    [1    /1   ]  0.381431405432       1
[INPUT] 0    0    [1    /1   ]  1.11706583507        1
[INPUT] 0    0    [1    /1   ]  2.88245389209        1
[INPUT] 1    0    [1    /1   ]  3.68488422918        1
[INPUT] 1    0    [1    /1   ]  12.4500387377        1
[INPUT] 1    0    [1    /1   ]  54.7853123067        1
[INPUT] 1    0    [1    /1   ]  0.330264004294       1
[INPUT] 1    0    [1    /1   ]  1.1441596434         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5, 1.0]], [0, [24413.794129990565, 1.0]], [0, [3661.4544699930652, 1.0]], [0, [833.2710571022795, 1.0]], [0, [235.7347365747029, 1.0]], [0, [76.43305808079762, 1.0]], [0, [10.036885276749757, 1.0]], [0, [27.05056174022394, 1.0]], [0, [0.381431405432048, 1.0]], [0, [1.1170658350677358, 1.0]], [0, [2.882453892092585, 1.0]], [1, [3.6848842291763377, 1.0]], [1, [12.450038737732893, 1.0]], [1, [54.78531230674078, 1.0]], [1, [0.330264004293878, 1.0]], [1, [1.1441596434027714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446999]
bas 3, expnt(s) = [833.2710571]
bas 4, expnt(s) = [235.73473657]
bas 5, expnt(s) = [76.43305808]
bas 6, expnt(s) = [10.03688528]
bas 7, expnt(s) = [27.05056174]
bas 8, expnt(s) = [0.38143141]
bas 9, expnt(s) = [1.11706584]
bas 10, expnt(s) = [2.88245389]
bas 11, expnt(s) = [3.68488423]
bas 12, expnt(s) = [12.45003874]
bas 13, expnt(s) = [54.78531231]
bas 14, expnt(s) = [0.330264]
bas 15, expnt(s) = [1.14415964]
CPU time:         1.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00000000e-01 1.50225109e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271057e+02 3.91836372e+02
 2.35734737e+02 1.51996193e+02 7.64330581e+01 6.53094387e+01
 1.00368853e+01 1.42466989e+01 2.70505617e+01 2.99672741e+01
 3.81431405e-01 1.22624531e+00 1.11706584e+00 2.74520070e+00
 2.88245389e+00 5.58903464e+00 3.68488423e+00 1.48940978e+01
 1.24500387e+01 6.82256640e+01 5.47853123e+01 4.34825064e+02
 3.30264004e-01 7.30400304e-01 1.14415964e+00 3.45217398e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99843511891411
cond(S) = 3379.2416408394624
E1 = -183.5775351272826  E_coul = 55.07853988692495
init E= -128.498995240358
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773942506849046  LUMO = 0.689700071702018
  mo_energy =
[-3.25553046e+01 -1.85276852e+00 -7.73942507e-01 -7.73942507e-01
 -7.73942507e-01  6.89700072e-01  1.11563080e+00  1.11563080e+00
  1.11563080e+00  3.00366824e+00  5.77786484e+00  5.77786484e+00
  5.77786484e+00  9.56140625e+00  2.42144834e+01  2.42144834e+01
  2.42144834e+01  3.68561886e+01  1.19115842e+02  1.19115842e+02
  1.19115842e+02  1.40733815e+02  5.04627398e+02  1.87209542e+03
  8.00159504e+03  4.77690364e+04]
E1 = -182.11325745883514  E_coul = 53.58468712248471
cycle= 1 E= -128.52857033635  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.177
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462665
diis-c [-0.21405851  1.        ]
  HOMO = -0.879377513178656  LUMO = 0.668957464450863
  mo_energy =
[-3.28734294e+01 -1.96289422e+00 -8.79377513e-01 -8.79377513e-01
 -8.79377513e-01  6.68957464e-01  1.07754913e+00  1.07754913e+00
  1.07754913e+00  2.95159148e+00  5.64917216e+00  5.64917216e+00
  5.64917216e+00  9.43579512e+00  2.39799096e+01  2.39799096e+01
  2.39799096e+01  3.66163947e+01  1.18795430e+02  1.18795430e+02
  1.18795430e+02  1.40421466e+02  5.04270699e+02  1.87170263e+03
  8.00117322e+03  4.77685957e+04]
E1 = -182.84412525529498  E_coul = 54.31305603962461
cycle= 2 E= -128.53106921567  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0716
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230843
diis-c [-6.05489489e-04  3.31909793e-01  6.68090207e-01]
  HOMO = -0.845071027044092  LUMO = 0.675769632085053
  mo_energy =
[-3.27685534e+01 -1.92681905e+00 -8.45071027e-01 -8.45071027e-01
 -8.45071027e-01  6.75769632e-01  1.09002520e+00  1.09002520e+00
  1.09002520e+00  2.96840529e+00  5.69103826e+00  5.69103826e+00
  5.69103826e+00  9.47669951e+00  2.40573614e+01  2.40573614e+01
  2.40573614e+01  3.66957855e+01  1.18900333e+02  1.18900333e+02
  1.18900333e+02  1.40524205e+02  5.04384160e+02  1.87182129e+03
  8.00129431e+03  4.77687177e+04]
E1 = -182.5991715173215  E_coul = 54.067258300550854
cycle= 3 E= -128.531913216771  delta_E= -0.000844  |g|= 0.000459  |ddm|= 0.0258
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000940157
diis-c [-1.28430701e-07 -2.14576055e-03 -5.33074660e-04  1.00267884e+00]
  HOMO = -0.845303863024663  LUMO = 0.675743189217828
  mo_energy =
[-3.27689704e+01 -1.92699193e+00 -8.45303863e-01 -8.45303863e-01
 -8.45303863e-01  6.75743189e-01  1.08997588e+00  1.08997588e+00
  1.08997588e+00  2.96832081e+00  5.69083425e+00  5.69083425e+00
  5.69083425e+00  9.47650276e+00  2.40570344e+01  2.40570344e+01
  2.40570344e+01  3.66954609e+01  1.18899904e+02  1.18899904e+02
  1.18899904e+02  1.40523789e+02  5.04383641e+02  1.87182066e+03
  8.00129359e+03  4.77687170e+04]
E1 = -182.59970287320138  E_coul = 54.06778963730964
cycle= 4 E= -128.531913235892  delta_E= -1.91e-08  |g|= 5.96e-05  |ddm|= 0.000797
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000124461
diis-c [-9.35860798e-10  3.23087873e-04  3.96954558e-04 -2.11484725e-01
  1.21076468e+00]
  HOMO = -0.845334474737549  LUMO = 0.675738205723861
  mo_energy =
[-3.27690207e+01 -1.92701113e+00 -8.45334475e-01 -8.45334475e-01
 -8.45334475e-01  6.75738206e-01  1.08996298e+00  1.08996298e+00
  1.08996298e+00  2.96830669e+00  5.69080025e+00  5.69080025e+00
  5.69080025e+00  9.47647248e+00  2.40569891e+01  2.40569891e+01
  2.40569891e+01  3.66954166e+01  1.18899853e+02  1.18899853e+02
  1.18899853e+02  1.40523738e+02  5.04383583e+02  1.87182060e+03
  8.00129352e+03  4.77687169e+04]
E1 = -182.59980233456386  E_coul = 54.06788909819971
cycle= 5 E= -128.531913236364  delta_E= -4.72e-10  |g|= 6.51e-06  |ddm|= 0.000158
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59980233456386  E_coul = 54.06788909819971
  HOMO = -0.845330858675576  LUMO = 0.675739301048831
  mo_energy =
[-3.27690127e+01 -1.92700683e+00 -8.45330859e-01 -8.45330859e-01
 -8.45330859e-01  6.75739301e-01  1.08996448e+00  1.08996448e+00
  1.08996448e+00  2.96830898e+00  5.69080465e+00  5.69080465e+00
  5.69080465e+00  9.47647704e+00  2.40569959e+01  2.40569959e+01
  2.40569959e+01  3.66954236e+01  1.18899861e+02  1.18899861e+02
  1.18899861e+02  1.40523746e+02  5.04383591e+02  1.87182060e+03
  8.00129353e+03  4.77687169e+04]
E1 = -182.59978443719828  E_coul = 54.0678712008318
Extra cycle  E= -128.531913236366  delta_E= -2.33e-12  |g|= 2.49e-06  |ddm|= 2.31e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3379.2416408394624
E1 = -182.59978443719828  E_coul = 54.0678712008318
init E= -128.531913236366
    CPU time for initialize scf      0.48 sec, wall time      0.48 sec
  HOMO = -0.845332112101033  LUMO = 0.675739103462703
  mo_energy =
[-3.27690166e+01 -1.92700804e+00 -8.45332112e-01 -8.45332112e-01
 -8.45332112e-01  6.75739103e-01  1.08996404e+00  1.08996404e+00
  1.08996404e+00  2.96830844e+00  5.69080313e+00  5.69080313e+00
  5.69080313e+00  9.47647559e+00  2.40569930e+01  2.40569930e+01
  2.40569930e+01  3.66954206e+01  1.18899857e+02  1.18899857e+02
  1.18899857e+02  1.40523742e+02  5.04383587e+02  1.87182060e+03
  8.00129352e+03  4.77687169e+04]
E1 = -182.5997939998987  E_coul = 54.06788076353161
cycle= 1 E= -128.531913236367  delta_E= -6.25e-13  |g|= 1.31e-06  |ddm|= 1.06e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5997939998987  E_coul = 54.06788076353161
  HOMO = -0.845331440070026  LUMO = 0.675739245610974
  mo_energy =
[-3.27690146e+01 -1.92700732e+00 -8.45331440e-01 -8.45331440e-01
 -8.45331440e-01  6.75739246e-01  1.08996428e+00  1.08996428e+00
  1.08996428e+00  2.96830878e+00  5.69080395e+00  5.69080395e+00
  5.69080395e+00  9.47647640e+00  2.40569945e+01  2.40569945e+01
  2.40569945e+01  3.66954222e+01  1.18899859e+02  1.18899859e+02
  1.18899859e+02  1.40523744e+02  5.04383589e+02  1.87182060e+03
  8.00129352e+03  4.77687169e+04]
E1 = -182.5997892434279  E_coul = 54.06787600706056
Extra cycle  E= -128.531913236367  delta_E= -2.27e-13  |g|= 6.47e-07  |ddm|= 5.08e-07
    CPU time for scf_cycle      1.19 sec, wall time      1.20 sec
exp = [5.00000000e-01 2.44137941e+04 3.66145447e+03 8.33271057e+02
 2.35734737e+02 7.64330581e+01 1.00368853e+01 2.70505617e+01
 3.81431405e-01 1.11706584e+00 2.88245389e+00 3.68488423e+00
 1.24500387e+01 5.47853123e+01 3.30264004e-01 1.14415964e+00]
grad_E = [-9.04035454e-05 -1.15365659e-10  6.05376000e-09 -1.15279187e-07
  1.28532725e-06 -1.22602048e-05 -2.80977717e-04  9.85784500e-05
  1.44485054e-03 -4.34445890e-04  2.31942653e-04 -1.07176177e-05
  1.01964041e-06 -4.31894756e-09 -9.35590215e-05  4.73924944e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.500090403545       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057218        1
[INPUT] 0    0    [1    /1   ]  235.734735289        1
[INPUT] 0    0    [1    /1   ]  76.433070341         1
[INPUT] 0    0    [1    /1   ]  10.0371662545        1
[INPUT] 0    0    [1    /1   ]  27.0504631618        1
[INPUT] 0    0    [1    /1   ]  0.379986554892       1
[INPUT] 0    0    [1    /1   ]  1.11750028096        1
[INPUT] 0    0    [1    /1   ]  2.88222194944        1
[INPUT] 1    0    [1    /1   ]  3.68489494679        1
[INPUT] 1    0    [1    /1   ]  12.4500377181        1
[INPUT] 1    0    [1    /1   ]  54.7853123111        1
[INPUT] 1    0    [1    /1   ]  0.330357563315       1
[INPUT] 1    0    [1    /1   ]  1.14411225091        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5000904035454486, 1.0]], [0, [24413.79412999068, 1.0]], [0, [3661.4544699870116, 1.0]], [0, [833.2710572175587, 1.0]], [0, [235.73473528937566, 1.0]], [0, [76.43307034100246, 1.0]], [0, [10.037166254467087, 1.0]], [0, [27.050463161773894, 1.0]], [0, [0.3799865548923176, 1.0]], [0, [1.1175002809574506, 1.0]], [0, [2.8822219494394488, 1.0]], [1, [3.6848949467940537, 1.0]], [1, [12.450037718092481, 1.0]], [1, [54.78531231105973, 1.0]], [1, [0.3303575633154214, 1.0]], [1, [1.1441122509083412, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5000904]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446999]
bas 3, expnt(s) = [833.27105722]
bas 4, expnt(s) = [235.73473529]
bas 5, expnt(s) = [76.43307034]
bas 6, expnt(s) = [10.03716625]
bas 7, expnt(s) = [27.05046316]
bas 8, expnt(s) = [0.37998655]
bas 9, expnt(s) = [1.11750028]
bas 10, expnt(s) = [2.88222195]
bas 11, expnt(s) = [3.68489495]
bas 12, expnt(s) = [12.45003772]
bas 13, expnt(s) = [54.78531231]
bas 14, expnt(s) = [0.33035756]
bas 15, expnt(s) = [1.14411225]
CPU time:         7.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00090404e-01 1.50245480e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271057e+02 3.91836373e+02
 2.35734735e+02 1.51996193e+02 7.64330703e+01 6.53094466e+01
 1.00371663e+01 1.42469980e+01 2.70504632e+01 2.99671922e+01
 3.79986555e-01 1.22275993e+00 1.11750028e+00 2.74600140e+00
 2.88222195e+00 5.58869733e+00 3.68489495e+00 1.48941520e+01
 1.24500377e+01 6.82256570e+01 5.47853123e+01 4.34825064e+02
 3.30357563e-01 7.30658953e-01 1.14411225e+00 3.45199523e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998434647079417
cond(S) = 3286.8375979938946
E1 = -183.57754583240393  E_coul = 55.07854363353481
init E= -128.499002198869
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773942018407204  LUMO = 0.688190627926163
  mo_energy =
[-3.25553040e+01 -1.85276958e+00 -7.73942018e-01 -7.73942018e-01
 -7.73942018e-01  6.88190628e-01  1.11589207e+00  1.11589207e+00
  1.11589207e+00  2.99982606e+00  5.77808991e+00  5.77808991e+00
  5.77808991e+00  9.55657664e+00  2.42146310e+01  2.42146310e+01
  2.42146310e+01  3.68517282e+01  1.19115938e+02  1.19115938e+02
  1.19115938e+02  1.40730175e+02  5.04624222e+02  1.87209260e+03
  8.00159256e+03  4.77690343e+04]
E1 = -182.11358484785833  E_coul = 53.58501116932845
cycle= 1 E= -128.52857367853  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.176
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462627
diis-c [-0.21402355  1.        ]
  HOMO = -0.879350990879285  LUMO = 0.667502820017329
  mo_energy =
[-3.28733789e+01 -1.96286315e+00 -8.79350991e-01 -8.79350991e-01
 -8.79350991e-01  6.67502820e-01  1.07781804e+00  1.07781804e+00
  1.07781804e+00  2.94778814e+00  5.64943262e+00  5.64943262e+00
  5.64943262e+00  9.43099314e+00  2.39801004e+01  2.39801004e+01
  2.39801004e+01  3.66119709e+01  1.18795575e+02  1.18795575e+02
  1.18795575e+02  1.40417874e+02  5.04267573e+02  1.87169986e+03
  8.00117079e+03  4.77685937e+04]
E1 = -182.84431954748317  E_coul = 54.31324756714791
cycle= 2 E= -128.531071980335  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230812
diis-c [-6.05388981e-04  3.31897919e-01  6.68102081e-01]
  HOMO = -0.845050205674258  LUMO = 0.674299842783041
  mo_energy =
[-3.27685197e+01 -1.92679420e+00 -8.45050206e-01 -8.45050206e-01
 -8.45050206e-01  6.74299843e-01  1.09029351e+00  1.09029351e+00
  1.09029351e+00  2.96459286e+00  5.69129081e+00  5.69129081e+00
  5.69129081e+00  9.47189203e+00  2.40575394e+01  2.40575394e+01
  2.40575394e+01  3.66913505e+01  1.18900462e+02  1.18900462e+02
  1.18900462e+02  1.40520597e+02  5.04381016e+02  1.87181850e+03
  8.00129186e+03  4.77687157e+04]
E1 = -182.5994315433991  E_coul = 54.06751593153067
cycle= 3 E= -128.531915611868  delta_E= -0.000844  |g|= 0.000458  |ddm|= 0.0257
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000938471
diis-c [-1.29976985e-07 -2.14474858e-03 -5.42689860e-04  1.00268744e+00]
  HOMO = -0.845282185491128  LUMO = 0.674273878559162
  mo_energy =
[-3.27689354e+01 -1.92696582e+00 -8.45282185e-01 -8.45282185e-01
 -8.45282185e-01  6.74273879e-01  1.09024459e+00  1.09024459e+00
  1.09024459e+00  2.96450914e+00  5.69108786e+00  5.69108786e+00
  5.69108786e+00  9.47169642e+00  2.40572137e+01  2.40572137e+01
  2.40572137e+01  3.66910273e+01  1.18900034e+02  1.18900034e+02
  1.18900034e+02  1.40520182e+02  5.04380499e+02  1.87181787e+03
  8.00129114e+03  4.77687150e+04]
E1 = -182.59996111462587  E_coul = 54.06804548364136
cycle= 4 E= -128.531915630985  delta_E= -1.91e-08  |g|= 5.97e-05  |ddm|= 0.000779
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000124599
diis-c [-9.39997733e-10  3.24855315e-04  3.98419629e-04 -2.12509870e-01
  1.21178660e+00]
  HOMO = -0.845312743892561  LUMO = 0.674268960973788
  mo_energy =
[-3.27689856e+01 -1.92698486e+00 -8.45312744e-01 -8.45312744e-01
 -8.45312744e-01  6.74268961e-01  1.09023171e+00  1.09023171e+00
  1.09023171e+00  2.96449511e+00  5.69105393e+00  5.69105393e+00
  5.69105393e+00  9.47166624e+00  2.40571685e+01  2.40571685e+01
  2.40571685e+01  3.66909830e+01  1.18899984e+02  1.18899984e+02
  1.18899984e+02  1.40520132e+02  5.04380441e+02  1.87181781e+03
  8.00129107e+03  4.77687149e+04]
E1 = -182.60006046064035  E_coul = 54.06814482917977
cycle= 5 E= -128.531915631461  delta_E= -4.76e-10  |g|= 6.54e-06  |ddm|= 0.000154
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60006046064035  E_coul = 54.06814482917977
  HOMO = -0.845309109549049  LUMO = 0.674270057297649
  mo_energy =
[-3.27689775e+01 -1.92698055e+00 -8.45309110e-01 -8.45309110e-01
 -8.45309110e-01  6.74270057e-01  1.09023322e+00  1.09023322e+00
  1.09023322e+00  2.96449741e+00  5.69105836e+00  5.69105836e+00
  5.69105836e+00  9.47167082e+00  2.40571753e+01  2.40571753e+01
  2.40571753e+01  3.66909901e+01  1.18899991e+02  1.18899991e+02
  1.18899991e+02  1.40520140e+02  5.04380449e+02  1.87181781e+03
  8.00129108e+03  4.77687149e+04]
E1 = -182.6000424748573  E_coul = 54.06812684339406
Extra cycle  E= -128.531915631463  delta_E= -2.67e-12  |g|= 2.5e-06  |ddm|= 2.35e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [5.00090404e-01 2.44137941e+04 3.66145447e+03 8.33271057e+02
 2.35734735e+02 7.64330703e+01 1.00371663e+01 2.70504632e+01
 3.79986555e-01 1.11750028e+00 2.88222195e+00 3.68489495e+00
 1.24500377e+01 5.47853123e+01 3.30357563e-01 1.14411225e+00]
E = -128.53191563146325
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.500090403545       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271057218        1
[INPUT] 0    0    [1    /1   ]  235.734735289        1
[INPUT] 0    0    [1    /1   ]  76.433070341         1
[INPUT] 0    0    [1    /1   ]  10.0371662545        1
[INPUT] 0    0    [1    /1   ]  27.0504631618        1
[INPUT] 0    0    [1    /1   ]  0.379986554892       1
[INPUT] 0    0    [1    /1   ]  1.11750028096        1
[INPUT] 0    0    [1    /1   ]  2.88222194944        1
[INPUT] 1    0    [1    /1   ]  3.68489494679        1
[INPUT] 1    0    [1    /1   ]  12.4500377181        1
[INPUT] 1    0    [1    /1   ]  54.7853123111        1
[INPUT] 1    0    [1    /1   ]  0.330357563315       1
[INPUT] 1    0    [1    /1   ]  1.14411225091        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5000904035454486, 1.0]], [0, [24413.79412999068, 1.0]], [0, [3661.4544699870116, 1.0]], [0, [833.2710572175587, 1.0]], [0, [235.73473528937566, 1.0]], [0, [76.43307034100246, 1.0]], [0, [10.037166254467087, 1.0]], [0, [27.050463161773894, 1.0]], [0, [0.3799865548923176, 1.0]], [0, [1.1175002809574506, 1.0]], [0, [2.8822219494394488, 1.0]], [1, [3.6848949467940537, 1.0]], [1, [12.450037718092481, 1.0]], [1, [54.78531231105973, 1.0]], [1, [0.3303575633154214, 1.0]], [1, [1.1441122509083412, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5000904]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446999]
bas 3, expnt(s) = [833.27105722]
bas 4, expnt(s) = [235.73473529]
bas 5, expnt(s) = [76.43307034]
bas 6, expnt(s) = [10.03716625]
bas 7, expnt(s) = [27.05046316]
bas 8, expnt(s) = [0.37998655]
bas 9, expnt(s) = [1.11750028]
bas 10, expnt(s) = [2.88222195]
bas 11, expnt(s) = [3.68489495]
bas 12, expnt(s) = [12.45003772]
bas 13, expnt(s) = [54.78531231]
bas 14, expnt(s) = [0.33035756]
bas 15, expnt(s) = [1.14411225]
CPU time:         7.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00090404e-01 1.50245480e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271057e+02 3.91836373e+02
 2.35734735e+02 1.51996193e+02 7.64330703e+01 6.53094466e+01
 1.00371663e+01 1.42469980e+01 2.70504632e+01 2.99671922e+01
 3.79986555e-01 1.22275993e+00 1.11750028e+00 2.74600140e+00
 2.88222195e+00 5.58869733e+00 3.68489495e+00 1.48941520e+01
 1.24500377e+01 6.82256570e+01 5.47853123e+01 4.34825064e+02
 3.30357563e-01 7.30658953e-01 1.14411225e+00 3.45199523e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998434647079417
cond(S) = 3286.8375979938946
E1 = -183.57754583240393  E_coul = 55.07854363353481
init E= -128.499002198869
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.773942018407204  LUMO = 0.688190627926163
  mo_energy =
[-3.25553040e+01 -1.85276958e+00 -7.73942018e-01 -7.73942018e-01
 -7.73942018e-01  6.88190628e-01  1.11589207e+00  1.11589207e+00
  1.11589207e+00  2.99982606e+00  5.77808991e+00  5.77808991e+00
  5.77808991e+00  9.55657664e+00  2.42146310e+01  2.42146310e+01
  2.42146310e+01  3.68517282e+01  1.19115938e+02  1.19115938e+02
  1.19115938e+02  1.40730175e+02  5.04624222e+02  1.87209260e+03
  8.00159256e+03  4.77690343e+04]
E1 = -182.11358484785833  E_coul = 53.58501116932845
cycle= 1 E= -128.52857367853  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.176
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462627
diis-c [-0.21402355  1.        ]
  HOMO = -0.879350990879285  LUMO = 0.667502820017329
  mo_energy =
[-3.28733789e+01 -1.96286315e+00 -8.79350991e-01 -8.79350991e-01
 -8.79350991e-01  6.67502820e-01  1.07781804e+00  1.07781804e+00
  1.07781804e+00  2.94778814e+00  5.64943262e+00  5.64943262e+00
  5.64943262e+00  9.43099314e+00  2.39801004e+01  2.39801004e+01
  2.39801004e+01  3.66119709e+01  1.18795575e+02  1.18795575e+02
  1.18795575e+02  1.40417874e+02  5.04267573e+02  1.87169986e+03
  8.00117079e+03  4.77685937e+04]
E1 = -182.84431954748317  E_coul = 54.31324756714791
cycle= 2 E= -128.531071980335  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230812
diis-c [-6.05388981e-04  3.31897919e-01  6.68102081e-01]
  HOMO = -0.845050205674258  LUMO = 0.674299842783041
  mo_energy =
[-3.27685197e+01 -1.92679420e+00 -8.45050206e-01 -8.45050206e-01
 -8.45050206e-01  6.74299843e-01  1.09029351e+00  1.09029351e+00
  1.09029351e+00  2.96459286e+00  5.69129081e+00  5.69129081e+00
  5.69129081e+00  9.47189203e+00  2.40575394e+01  2.40575394e+01
  2.40575394e+01  3.66913505e+01  1.18900462e+02  1.18900462e+02
  1.18900462e+02  1.40520597e+02  5.04381016e+02  1.87181850e+03
  8.00129186e+03  4.77687157e+04]
E1 = -182.5994315433991  E_coul = 54.06751593153067
cycle= 3 E= -128.531915611868  delta_E= -0.000844  |g|= 0.000458  |ddm|= 0.0257
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000938471
diis-c [-1.29976985e-07 -2.14474858e-03 -5.42689860e-04  1.00268744e+00]
  HOMO = -0.845282185491128  LUMO = 0.674273878559162
  mo_energy =
[-3.27689354e+01 -1.92696582e+00 -8.45282185e-01 -8.45282185e-01
 -8.45282185e-01  6.74273879e-01  1.09024459e+00  1.09024459e+00
  1.09024459e+00  2.96450914e+00  5.69108786e+00  5.69108786e+00
  5.69108786e+00  9.47169642e+00  2.40572137e+01  2.40572137e+01
  2.40572137e+01  3.66910273e+01  1.18900034e+02  1.18900034e+02
  1.18900034e+02  1.40520182e+02  5.04380499e+02  1.87181787e+03
  8.00129114e+03  4.77687150e+04]
E1 = -182.59996111462587  E_coul = 54.06804548364136
cycle= 4 E= -128.531915630985  delta_E= -1.91e-08  |g|= 5.97e-05  |ddm|= 0.000779
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000124599
diis-c [-9.39997733e-10  3.24855315e-04  3.98419629e-04 -2.12509870e-01
  1.21178660e+00]
  HOMO = -0.845312743892561  LUMO = 0.674268960973788
  mo_energy =
[-3.27689856e+01 -1.92698486e+00 -8.45312744e-01 -8.45312744e-01
 -8.45312744e-01  6.74268961e-01  1.09023171e+00  1.09023171e+00
  1.09023171e+00  2.96449511e+00  5.69105393e+00  5.69105393e+00
  5.69105393e+00  9.47166624e+00  2.40571685e+01  2.40571685e+01
  2.40571685e+01  3.66909830e+01  1.18899984e+02  1.18899984e+02
  1.18899984e+02  1.40520132e+02  5.04380441e+02  1.87181781e+03
  8.00129107e+03  4.77687149e+04]
E1 = -182.60006046064035  E_coul = 54.06814482917977
cycle= 5 E= -128.531915631461  delta_E= -4.76e-10  |g|= 6.54e-06  |ddm|= 0.000154
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60006046064035  E_coul = 54.06814482917977
  HOMO = -0.845309109549049  LUMO = 0.674270057297649
  mo_energy =
[-3.27689775e+01 -1.92698055e+00 -8.45309110e-01 -8.45309110e-01
 -8.45309110e-01  6.74270057e-01  1.09023322e+00  1.09023322e+00
  1.09023322e+00  2.96449741e+00  5.69105836e+00  5.69105836e+00
  5.69105836e+00  9.47167082e+00  2.40571753e+01  2.40571753e+01
  2.40571753e+01  3.66909901e+01  1.18899991e+02  1.18899991e+02
  1.18899991e+02  1.40520140e+02  5.04380449e+02  1.87181781e+03
  8.00129108e+03  4.77687149e+04]
E1 = -182.6000424748573  E_coul = 54.06812684339406
Extra cycle  E= -128.531915631463  delta_E= -2.67e-12  |g|= 2.5e-06  |ddm|= 2.35e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3286.8375979938946
E1 = -182.6000424748573  E_coul = 54.06812684339406
init E= -128.531915631463
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845310368840661  LUMO = 0.674269858786527
  mo_energy =
[-3.27689815e+01 -1.92698176e+00 -8.45310369e-01 -8.45310369e-01
 -8.45310369e-01  6.74269859e-01  1.09023278e+00  1.09023278e+00
  1.09023278e+00  2.96449686e+00  5.69105683e+00  5.69105683e+00
  5.69105683e+00  9.47166937e+00  2.40571724e+01  2.40571724e+01
  2.40571724e+01  3.66909871e+01  1.18899987e+02  1.18899987e+02
  1.18899987e+02  1.40520136e+02  5.04380445e+02  1.87181781e+03
  8.00129108e+03  4.77687149e+04]
E1 = -182.60005208339751  E_coul = 54.06813645193374
cycle= 1 E= -128.531915631464  delta_E= -5.4e-13  |g|= 1.32e-06  |ddm|= 1.07e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60005208339751  E_coul = 54.06813645193374
  HOMO = -0.845309693522547  LUMO = 0.674270001237163
  mo_energy =
[-3.27689795e+01 -1.92698103e+00 -8.45309694e-01 -8.45309694e-01
 -8.45309694e-01  6.74270001e-01  1.09023302e+00  1.09023302e+00
  1.09023302e+00  2.96449721e+00  5.69105766e+00  5.69105766e+00
  5.69105766e+00  9.47167019e+00  2.40571739e+01  2.40571739e+01
  2.40571739e+01  3.66909886e+01  1.18899990e+02  1.18899990e+02
  1.18899990e+02  1.40520138e+02  5.04380447e+02  1.87181781e+03
  8.00129108e+03  4.77687149e+04]
E1 = -182.6000473044502  E_coul = 54.06813167298666
Extra cycle  E= -128.531915631464  delta_E= 2.56e-13  |g|= 6.5e-07  |ddm|= 5.06e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [5.00090404e-01 2.44137941e+04 3.66145447e+03 8.33271057e+02
 2.35734735e+02 7.64330703e+01 1.00371663e+01 2.70504632e+01
 3.79986555e-01 1.11750028e+00 2.88222195e+00 3.68489495e+00
 1.24500377e+01 5.47853123e+01 3.30357563e-01 1.14411225e+00]
grad_E = [-1.03406273e-04 -1.12167837e-10  5.88579260e-09 -1.11911096e-07
  1.24533672e-06 -1.19529316e-05 -2.77819657e-04  9.71357812e-05
  1.43760349e-03 -4.48071034e-04  2.33077758e-04  4.83017437e-05
 -4.64782935e-06  1.86804251e-07  6.24979958e-04 -2.54647397e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.501075156499       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446993        1
[INPUT] 0    0    [1    /1   ]  833.271058374        1
[INPUT] 0    0    [1    /1   ]  235.734722413        1
[INPUT] 0    0    [1    /1   ]  76.4331935364        1
[INPUT] 0    0    [1    /1   ]  10.0400090496        1
[INPUT] 0    0    [1    /1   ]  27.0494674667        1
[INPUT] 0    0    [1    /1   ]  0.365323301913       1
[INPUT] 0    0    [1    /1   ]  1.12198833251        1
[INPUT] 0    0    [1    /1   ]  2.87985655698        1
[INPUT] 1    0    [1    /1   ]  3.68470888791        1
[INPUT] 1    0    [1    /1   ]  12.4500556819        1
[INPUT] 1    0    [1    /1   ]  54.7853113994        1
[INPUT] 1    0    [1    /1   ]  0.327716710631       1
[INPUT] 1    0    [1    /1   ]  1.14514029294        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.501075156499001, 1.0]], [0, [24413.79412999184, 1.0]], [0, [3661.4544699262624, 1.0]], [0, [833.2710583735351, 1.0]], [0, [235.73472241278353, 1.0]], [0, [76.43319353638655, 1.0]], [0, [10.040009049556378, 1.0]], [0, [27.049467466703675, 1.0]], [0, [0.36532330191250584, 1.0]], [0, [1.121988332514068, 1.0]], [0, [2.8798565569776304, 1.0]], [1, [3.6847088879055514, 1.0]], [1, [12.450055681916993, 1.0]], [1, [54.785311399383446, 1.0]], [1, [0.32771671063052654, 1.0]], [1, [1.1451402929435095, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50107516]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446993]
bas 3, expnt(s) = [833.27105837]
bas 4, expnt(s) = [235.73472241]
bas 5, expnt(s) = [76.43319354]
bas 6, expnt(s) = [10.04000905]
bas 7, expnt(s) = [27.04946747]
bas 8, expnt(s) = [0.3653233]
bas 9, expnt(s) = [1.12198833]
bas 10, expnt(s) = [2.87985656]
bas 11, expnt(s) = [3.68470889]
bas 12, expnt(s) = [12.45005568]
bas 13, expnt(s) = [54.7853114]
bas 14, expnt(s) = [0.32771671]
bas 15, expnt(s) = [1.14514029]
CPU time:        10.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.01075156e-01 1.50467317e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271058e+02 3.91836373e+02
 2.35734722e+02 1.51996186e+02 7.64331935e+01 6.53095255e+01
 1.00400090e+01 1.42500242e+01 2.70494675e+01 2.99663649e+01
 3.65323302e-01 1.18719772e+00 1.12198833e+00 2.75426853e+00
 2.87985656e+00 5.58525707e+00 3.68470889e+00 1.48932119e+01
 1.24500557e+01 6.82257800e+01 5.47853114e+01 4.34825055e+02
 3.27716711e-01 7.23365225e-01 1.14514029e+00 3.45587291e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998463287962458
cond(S) = 2533.4487904427783
E1 = -183.5772142855033  E_coul = 55.07839959510494
init E= -128.498814690398
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773956924955372  LUMO = 0.672409578087376
  mo_energy =
[-3.25553158e+01 -1.85279765e+00 -7.73956925e-01 -7.73956925e-01
 -7.73956925e-01  6.72409578e-01  1.10838669e+00  1.10838669e+00
  1.10838669e+00  2.96053150e+00  5.77096919e+00  5.77096919e+00
  5.77096919e+00  9.50778405e+00  2.42097270e+01  2.42097270e+01
  2.42097270e+01  3.68069554e+01  1.19112808e+02  1.19112808e+02
  1.19112808e+02  1.40693765e+02  5.04592463e+02  1.87206434e+03
  8.00156774e+03  4.77690138e+04]
E1 = -182.103072087002  E_coul = 53.57453493312234
cycle= 1 E= -128.52853715388  delta_E= -0.0297  |g|= 0.202  |ddm|= 0.173
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.464411
diis-c [-0.2156779  1.       ]
  HOMO = -0.880223096037179  LUMO = 0.65180103282376
  mo_energy =
[-3.28750254e+01 -1.96384691e+00 -8.80223096e-01 -8.80223096e-01
 -8.80223096e-01  6.51801033e-01  1.07004534e+00  1.07004534e+00
  1.07004534e+00  2.90808350e+00  5.64119433e+00  5.64119433e+00
  5.64119433e+00  9.38113762e+00  2.39737920e+01  2.39737920e+01
  2.39737920e+01  3.65657676e+01  1.18790800e+02  1.18790800e+02
  1.18790800e+02  1.40379851e+02  5.04234154e+02  1.87166994e+03
  8.00114432e+03  4.77685715e+04]
E1 = -182.8383413104225  E_coul = 54.30728518508869
cycle= 2 E= -128.531056125334  delta_E= -0.00252  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.232153
diis-c [-6.09439588e-04  3.32334782e-01  6.67665218e-01]
  HOMO = -0.845728281019932  LUMO = 0.658506265402413
  mo_energy =
[-3.27696012e+01 -1.92757082e+00 -8.45728281e-01 -8.45728281e-01
 -8.45728281e-01  6.58506265e-01  1.08254745e+00  1.08254745e+00
  1.08254745e+00  2.92492379e+00  5.68331299e+00  5.68331299e+00
  5.68331299e+00  9.42228738e+00  2.40516634e+01  2.40516634e+01
  2.40516634e+01  3.66456015e+01  1.18896251e+02  1.18896251e+02
  1.18896251e+02  1.40483132e+02  5.04348203e+02  1.87178922e+03
  8.00126603e+03  4.77686942e+04]
E1 = -182.59131751448135  E_coul = 54.05940542318291
cycle= 3 E= -128.531912091298  delta_E= -0.000856  |g|= 0.000495  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000984812
diis-c [-1.19519675e-07 -2.22286614e-03 -4.70627034e-04  1.00269349e+00]
  HOMO = -0.845983852196452  LUMO = 0.658470445229019
  mo_energy =
[-3.27700477e+01 -1.92777221e+00 -8.45983852e-01 -8.45983852e-01
 -8.45983852e-01  6.58470445e-01  1.08248739e+00  1.08248739e+00
  1.08248739e+00  2.92482196e+00  5.68308233e+00  5.68308233e+00
  5.68308233e+00  9.42206289e+00  2.40513058e+01  2.40513058e+01
  2.40513058e+01  3.66452462e+01  1.18895793e+02  1.18895793e+02
  1.18895793e+02  1.40482687e+02  5.04347657e+02  1.87178856e+03
  8.00126529e+03  4.77686934e+04]
E1 = -182.59187615168884  E_coul = 54.059964039546
cycle= 4 E= -128.531912112143  delta_E= -2.08e-08  |g|= 6.12e-05  |ddm|= 0.000678
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000125062
diis-c [-8.82833031e-10  2.90590576e-04  3.74044307e-04 -1.92651550e-01
  1.19198692e+00]
  HOMO = -0.846016446221366  LUMO = 0.658464307632197
  mo_energy =
[-3.27701004e+01 -1.92779499e+00 -8.46016446e-01 -8.46016446e-01
 -8.46016446e-01  6.58464308e-01  1.08247346e+00  1.08247346e+00
  1.08247346e+00  2.92480577e+00  5.68304580e+00  5.68304580e+00
  5.68304580e+00  9.42202958e+00  2.40512576e+01  2.40512576e+01
  2.40512576e+01  3.66451988e+01  1.18895740e+02  1.18895740e+02
  1.18895740e+02  1.40482634e+02  5.04347597e+02  1.87178849e+03
  8.00126522e+03  4.77686933e+04]
E1 = -182.5919775075225  E_coul = 54.06006539492654
cycle= 5 E= -128.531912112596  delta_E= -4.53e-10  |g|= 6.17e-06  |ddm|= 0.000128
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5919775075225  E_coul = 54.06006539492654
  HOMO = -0.846013127420801  LUMO = 0.658465343148987
  mo_energy =
[-3.27700931e+01 -1.92779092e+00 -8.46013127e-01 -8.46013127e-01
 -8.46013127e-01  6.58465343e-01  1.08247484e+00  1.08247484e+00
  1.08247484e+00  2.92480793e+00  5.68304988e+00  5.68304988e+00
  5.68304988e+00  9.42203382e+00  2.40512639e+01  2.40512639e+01
  2.40512639e+01  3.66452053e+01  1.18895747e+02  1.18895747e+02
  1.18895747e+02  1.40482641e+02  5.04347604e+02  1.87178850e+03
  8.00126523e+03  4.77686933e+04]
E1 = -182.59196110507025  E_coul = 54.06004899247172
Extra cycle  E= -128.531912112599  delta_E= -2.59e-12  |g|= 2.29e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [5.01075156e-01 2.44137941e+04 3.66145447e+03 8.33271058e+02
 2.35734722e+02 7.64331935e+01 1.00400090e+01 2.70494675e+01
 3.65323302e-01 1.12198833e+00 2.87985656e+00 3.68470889e+00
 1.24500557e+01 5.47853114e+01 3.27716711e-01 1.14514029e+00]
E = -128.53191211259855
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.500525165245       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446996        1
[INPUT] 0    0    [1    /1   ]  833.271057728        1
[INPUT] 0    0    [1    /1   ]  235.734729604        1
[INPUT] 0    0    [1    /1   ]  76.4331247309        1
[INPUT] 0    0    [1    /1   ]  10.0384213291        1
[INPUT] 0    0    [1    /1   ]  27.0500235692        1
[INPUT] 0    0    [1    /1   ]  0.373512828903       1
[INPUT] 0    0    [1    /1   ]  1.11948172505        1
[INPUT] 0    0    [1    /1   ]  2.88117764483        1
[INPUT] 1    0    [1    /1   ]  3.68481280307        1
[INPUT] 1    0    [1    /1   ]  12.450045649         1
[INPUT] 1    0    [1    /1   ]  54.7853119086        1
[INPUT] 1    0    [1    /1   ]  0.329191644901       1
[INPUT] 1    0    [1    /1   ]  1.14456612444        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5005251652451197, 1.0]], [0, [24413.79412999119, 1.0]], [0, [3661.454469960191, 1.0]], [0, [833.2710577279144, 1.0]], [0, [235.73472960444823, 1.0]], [0, [76.43312473092269, 1.0]], [0, [10.038421329072731, 1.0]], [0, [27.050023569204487, 1.0]], [0, [0.3735128289032637, 1.0]], [0, [1.1194817250505376, 1.0]], [0, [2.8811776448314967, 1.0]], [1, [3.6848128030662157, 1.0]], [1, [12.450045648998247, 1.0]], [1, [54.78531190856088, 1.0]], [1, [0.329191644901342, 1.0]], [1, [1.1445661244417291, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50052517]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446996]
bas 3, expnt(s) = [833.27105773]
bas 4, expnt(s) = [235.7347296]
bas 5, expnt(s) = [76.43312473]
bas 6, expnt(s) = [10.03842133]
bas 7, expnt(s) = [27.05002357]
bas 8, expnt(s) = [0.37351283]
bas 9, expnt(s) = [1.11948173]
bas 10, expnt(s) = [2.88117764]
bas 11, expnt(s) = [3.6848128]
bas 12, expnt(s) = [12.45004565]
bas 13, expnt(s) = [54.78531191]
bas 14, expnt(s) = [0.32919164]
bas 15, expnt(s) = [1.14456612]
CPU time:        10.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00525165e-01 1.50343433e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271058e+02 3.91836373e+02
 2.35734730e+02 1.51996190e+02 7.64331247e+01 6.53094814e+01
 1.00384213e+01 1.42483341e+01 2.70500236e+01 2.99668270e+01
 3.73512829e-01 1.20710255e+00 1.11948173e+00 2.74965230e+00
 2.88117764e+00 5.58717857e+00 3.68481280e+00 1.48937370e+01
 1.24500456e+01 6.82257113e+01 5.47853119e+01 4.34825060e+02
 3.29191645e-01 7.27437018e-01 1.14456612e+00 3.45370709e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998449663308884
cond(S) = 2916.232942617575
E1 = -183.57742401963492  E_coul = 55.07848835519518
init E= -128.49893566444
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773949146606386  LUMO = 0.681305896364251
  mo_energy =
[-3.25553084e+01 -1.85278106e+00 -7.73949147e-01 -7.73949147e-01
 -7.73949147e-01  6.81305896e-01  1.11258370e+00  1.11258370e+00
  1.11258370e+00  2.98260493e+00  5.77494629e+00  5.77494629e+00
  5.77494629e+00  9.53508411e+00  2.42124646e+01  2.42124646e+01
  2.42124646e+01  3.68319593e+01  1.19114555e+02  1.19114555e+02
  1.19114555e+02  1.40714090e+02  5.04610190e+02  1.87208011e+03
  8.00158159e+03  4.77690253e+04]
E1 = -182.10893203359666  E_coul = 53.580367109823044
cycle= 1 E= -128.528564923774  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.174
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463426
diis-c [-0.21476336  1.        ]
  HOMO = -0.879738451374758  LUMO = 0.660648820319413
  mo_energy =
[-3.28741104e+01 -1.96329883e+00 -8.79738451e-01 -8.79738451e-01
 -8.79738451e-01  6.60648820e-01  1.07438986e+00  1.07438986e+00
  1.07438986e+00  2.93038492e+00  5.64579335e+00  5.64579335e+00
  5.64579335e+00  9.40902984e+00  2.39773097e+01  2.39773097e+01
  2.39773097e+01  3.65915663e+01  1.18793461e+02  1.18793461e+02
  1.18793461e+02  1.40401071e+02  5.04252802e+02  1.87168663e+03
  8.00115909e+03  4.77685839e+04]
E1 = -182.84167973504833  E_coul = 54.31060731600069
cycle= 2 E= -128.531072419048  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231409
diis-c [-6.07141954e-04  3.32090942e-01  6.67909058e-01]
  HOMO = -0.845351474751041  LUMO = 0.66740627267521
  mo_energy =
[-3.27689999e+01 -1.92713788e+00 -8.45351475e-01 -8.45351475e-01
 -8.45351475e-01  6.67406273e-01  1.08687740e+00  1.08687740e+00
  1.08687740e+00  2.94720551e+00  5.68776715e+00  5.68776715e+00
  5.68776715e+00  9.45003979e+00  2.40549408e+01  2.40549408e+01
  2.40549408e+01  3.66711477e+01  1.18898599e+02  1.18898599e+02
  1.18898599e+02  1.40504043e+02  5.04366515e+02  1.87180556e+03
  8.00128044e+03  4.77687062e+04]
E1 = -182.59584698133685  E_coul = 54.06392547440222
cycle= 3 E= -128.531921506935  delta_E= -0.000849  |g|= 0.000473  |ddm|= 0.0252
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000958147
diis-c [-1.24719271e-07 -2.17730176e-03 -5.08331056e-04  1.00268563e+00]
  HOMO = -0.845593773981182  LUMO = 0.667375948682717
  mo_energy =
[-3.27694291e+01 -1.92732255e+00 -8.45593774e-01 -8.45593774e-01
 -8.45593774e-01  6.67375949e-01  1.08682360e+00  1.08682360e+00
  1.08682360e+00  2.94711386e+00  5.68755208e+00  5.68755208e+00
  5.68755208e+00  9.44983154e+00  2.40546012e+01  2.40546012e+01
  2.40546012e+01  3.66708104e+01  1.18898157e+02  1.18898157e+02
  1.18898157e+02  1.40503615e+02  5.04365985e+02  1.87180492e+03
  8.00127972e+03  4.77687054e+04]
E1 = -182.59638904297853  E_coul = 54.06446751624305
cycle= 4 E= -128.531921526735  delta_E= -1.98e-08  |g|= 6.02e-05  |ddm|= 0.000729
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00012469
diis-c [-9.18642751e-10  3.10514412e-04  3.87476268e-04 -2.04033155e-01
  1.20333516e+00]
  HOMO = -0.845625245592945  LUMO = 0.667370481916963
  mo_energy =
[-3.27694804e+01 -1.92734326e+00 -8.45625246e-01 -8.45625246e-01
 -8.45625246e-01  6.67370482e-01  1.08681025e+00  1.08681025e+00
  1.08681025e+00  2.94709886e+00  5.68751699e+00  5.68751699e+00
  5.68751699e+00  9.44979997e+00  2.40545547e+01  2.40545547e+01
  2.40545547e+01  3.66707648e+01  1.18898105e+02  1.18898105e+02
  1.18898105e+02  1.40503563e+02  5.04365926e+02  1.87180485e+03
  8.00127965e+03  4.77687053e+04]
E1 = -182.59648931316195  E_coul = 54.06456778596183
cycle= 5 E= -128.5319215272  delta_E= -4.65e-10  |g|= 6.41e-06  |ddm|= 0.000141
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59648931316195  E_coul = 54.06456778596183
  HOMO = -0.845621730241326  LUMO = 0.667371558248181
  mo_energy =
[-3.27694727e+01 -1.92733902e+00 -8.45621730e-01 -8.45621730e-01
 -8.45621730e-01  6.67371558e-01  1.08681171e+00  1.08681171e+00
  1.08681171e+00  2.94710112e+00  5.68752129e+00  5.68752129e+00
  5.68752129e+00  9.44980442e+00  2.40545613e+01  2.40545613e+01
  2.40545613e+01  3.66707716e+01  1.18898113e+02  1.18898113e+02
  1.18898113e+02  1.40503571e+02  5.04365934e+02  1.87180486e+03
  8.00127966e+03  4.77687054e+04]
E1 = -182.59647195956873  E_coul = 54.0645504323661
Extra cycle  E= -128.531921527203  delta_E= -2.5e-12  |g|= 2.42e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [5.00525165e-01 2.44137941e+04 3.66145447e+03 8.33271058e+02
 2.35734730e+02 7.64331247e+01 1.00384213e+01 2.70500236e+01
 3.73512829e-01 1.11948173e+00 2.88117764e+00 3.68481280e+00
 1.24500456e+01 5.47853119e+01 3.29191645e-01 1.14456612e+00]
E = -128.53192152720263
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.500525165245       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446996        1
[INPUT] 0    0    [1    /1   ]  833.271057728        1
[INPUT] 0    0    [1    /1   ]  235.734729604        1
[INPUT] 0    0    [1    /1   ]  76.4331247309        1
[INPUT] 0    0    [1    /1   ]  10.0384213291        1
[INPUT] 0    0    [1    /1   ]  27.0500235692        1
[INPUT] 0    0    [1    /1   ]  0.373512828903       1
[INPUT] 0    0    [1    /1   ]  1.11948172505        1
[INPUT] 0    0    [1    /1   ]  2.88117764483        1
[INPUT] 1    0    [1    /1   ]  3.68481280307        1
[INPUT] 1    0    [1    /1   ]  12.450045649         1
[INPUT] 1    0    [1    /1   ]  54.7853119086        1
[INPUT] 1    0    [1    /1   ]  0.329191644901       1
[INPUT] 1    0    [1    /1   ]  1.14456612444        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5005251652451197, 1.0]], [0, [24413.79412999119, 1.0]], [0, [3661.454469960191, 1.0]], [0, [833.2710577279144, 1.0]], [0, [235.73472960444823, 1.0]], [0, [76.43312473092269, 1.0]], [0, [10.038421329072731, 1.0]], [0, [27.050023569204487, 1.0]], [0, [0.3735128289032637, 1.0]], [0, [1.1194817250505376, 1.0]], [0, [2.8811776448314967, 1.0]], [1, [3.6848128030662157, 1.0]], [1, [12.450045648998247, 1.0]], [1, [54.78531190856088, 1.0]], [1, [0.329191644901342, 1.0]], [1, [1.1445661244417291, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50052517]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446996]
bas 3, expnt(s) = [833.27105773]
bas 4, expnt(s) = [235.7347296]
bas 5, expnt(s) = [76.43312473]
bas 6, expnt(s) = [10.03842133]
bas 7, expnt(s) = [27.05002357]
bas 8, expnt(s) = [0.37351283]
bas 9, expnt(s) = [1.11948173]
bas 10, expnt(s) = [2.88117764]
bas 11, expnt(s) = [3.6848128]
bas 12, expnt(s) = [12.45004565]
bas 13, expnt(s) = [54.78531191]
bas 14, expnt(s) = [0.32919164]
bas 15, expnt(s) = [1.14456612]
CPU time:        10.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00525165e-01 1.50343433e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271058e+02 3.91836373e+02
 2.35734730e+02 1.51996190e+02 7.64331247e+01 6.53094814e+01
 1.00384213e+01 1.42483341e+01 2.70500236e+01 2.99668270e+01
 3.73512829e-01 1.20710255e+00 1.11948173e+00 2.74965230e+00
 2.88117764e+00 5.58717857e+00 3.68481280e+00 1.48937370e+01
 1.24500456e+01 6.82257113e+01 5.47853119e+01 4.34825060e+02
 3.29191645e-01 7.27437018e-01 1.14456612e+00 3.45370709e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998449663308884
cond(S) = 2916.232942617575
E1 = -183.57742401963492  E_coul = 55.07848835519518
init E= -128.49893566444
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773949146606386  LUMO = 0.681305896364251
  mo_energy =
[-3.25553084e+01 -1.85278106e+00 -7.73949147e-01 -7.73949147e-01
 -7.73949147e-01  6.81305896e-01  1.11258370e+00  1.11258370e+00
  1.11258370e+00  2.98260493e+00  5.77494629e+00  5.77494629e+00
  5.77494629e+00  9.53508411e+00  2.42124646e+01  2.42124646e+01
  2.42124646e+01  3.68319593e+01  1.19114555e+02  1.19114555e+02
  1.19114555e+02  1.40714090e+02  5.04610190e+02  1.87208011e+03
  8.00158159e+03  4.77690253e+04]
E1 = -182.10893203359666  E_coul = 53.580367109823044
cycle= 1 E= -128.528564923774  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.174
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463426
diis-c [-0.21476336  1.        ]
  HOMO = -0.879738451374758  LUMO = 0.660648820319413
  mo_energy =
[-3.28741104e+01 -1.96329883e+00 -8.79738451e-01 -8.79738451e-01
 -8.79738451e-01  6.60648820e-01  1.07438986e+00  1.07438986e+00
  1.07438986e+00  2.93038492e+00  5.64579335e+00  5.64579335e+00
  5.64579335e+00  9.40902984e+00  2.39773097e+01  2.39773097e+01
  2.39773097e+01  3.65915663e+01  1.18793461e+02  1.18793461e+02
  1.18793461e+02  1.40401071e+02  5.04252802e+02  1.87168663e+03
  8.00115909e+03  4.77685839e+04]
E1 = -182.84167973504833  E_coul = 54.31060731600069
cycle= 2 E= -128.531072419048  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0704
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231409
diis-c [-6.07141954e-04  3.32090942e-01  6.67909058e-01]
  HOMO = -0.845351474751041  LUMO = 0.66740627267521
  mo_energy =
[-3.27689999e+01 -1.92713788e+00 -8.45351475e-01 -8.45351475e-01
 -8.45351475e-01  6.67406273e-01  1.08687740e+00  1.08687740e+00
  1.08687740e+00  2.94720551e+00  5.68776715e+00  5.68776715e+00
  5.68776715e+00  9.45003979e+00  2.40549408e+01  2.40549408e+01
  2.40549408e+01  3.66711477e+01  1.18898599e+02  1.18898599e+02
  1.18898599e+02  1.40504043e+02  5.04366515e+02  1.87180556e+03
  8.00128044e+03  4.77687062e+04]
E1 = -182.59584698133685  E_coul = 54.06392547440222
cycle= 3 E= -128.531921506935  delta_E= -0.000849  |g|= 0.000473  |ddm|= 0.0252
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000958147
diis-c [-1.24719271e-07 -2.17730176e-03 -5.08331056e-04  1.00268563e+00]
  HOMO = -0.845593773981182  LUMO = 0.667375948682717
  mo_energy =
[-3.27694291e+01 -1.92732255e+00 -8.45593774e-01 -8.45593774e-01
 -8.45593774e-01  6.67375949e-01  1.08682360e+00  1.08682360e+00
  1.08682360e+00  2.94711386e+00  5.68755208e+00  5.68755208e+00
  5.68755208e+00  9.44983154e+00  2.40546012e+01  2.40546012e+01
  2.40546012e+01  3.66708104e+01  1.18898157e+02  1.18898157e+02
  1.18898157e+02  1.40503615e+02  5.04365985e+02  1.87180492e+03
  8.00127972e+03  4.77687054e+04]
E1 = -182.59638904297853  E_coul = 54.06446751624305
cycle= 4 E= -128.531921526735  delta_E= -1.98e-08  |g|= 6.02e-05  |ddm|= 0.000729
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00012469
diis-c [-9.18642751e-10  3.10514412e-04  3.87476268e-04 -2.04033155e-01
  1.20333516e+00]
  HOMO = -0.845625245592945  LUMO = 0.667370481916963
  mo_energy =
[-3.27694804e+01 -1.92734326e+00 -8.45625246e-01 -8.45625246e-01
 -8.45625246e-01  6.67370482e-01  1.08681025e+00  1.08681025e+00
  1.08681025e+00  2.94709886e+00  5.68751699e+00  5.68751699e+00
  5.68751699e+00  9.44979997e+00  2.40545547e+01  2.40545547e+01
  2.40545547e+01  3.66707648e+01  1.18898105e+02  1.18898105e+02
  1.18898105e+02  1.40503563e+02  5.04365926e+02  1.87180485e+03
  8.00127965e+03  4.77687053e+04]
E1 = -182.59648931316195  E_coul = 54.06456778596183
cycle= 5 E= -128.5319215272  delta_E= -4.65e-10  |g|= 6.41e-06  |ddm|= 0.000141
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59648931316195  E_coul = 54.06456778596183
  HOMO = -0.845621730241326  LUMO = 0.667371558248181
  mo_energy =
[-3.27694727e+01 -1.92733902e+00 -8.45621730e-01 -8.45621730e-01
 -8.45621730e-01  6.67371558e-01  1.08681171e+00  1.08681171e+00
  1.08681171e+00  2.94710112e+00  5.68752129e+00  5.68752129e+00
  5.68752129e+00  9.44980442e+00  2.40545613e+01  2.40545613e+01
  2.40545613e+01  3.66707716e+01  1.18898113e+02  1.18898113e+02
  1.18898113e+02  1.40503571e+02  5.04365934e+02  1.87180486e+03
  8.00127966e+03  4.77687054e+04]
E1 = -182.59647195956873  E_coul = 54.0645504323661
Extra cycle  E= -128.531921527203  delta_E= -2.5e-12  |g|= 2.42e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2916.232942617575
E1 = -182.59647195956873  E_coul = 54.0645504323661
init E= -128.531921527203
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845622947835619  LUMO = 0.667371372214912
  mo_energy =
[-3.27694765e+01 -1.92734019e+00 -8.45622948e-01 -8.45622948e-01
 -8.45622948e-01  6.67371372e-01  1.08681128e+00  1.08681128e+00
  1.08681128e+00  2.94710059e+00  5.68751981e+00  5.68751981e+00
  5.68751981e+00  9.44980302e+00  2.40545585e+01  2.40545585e+01
  2.40545585e+01  3.66707687e+01  1.18898109e+02  1.18898109e+02
  1.18898109e+02  1.40503567e+02  5.04365930e+02  1.87180485e+03
  8.00127965e+03  4.77687053e+04]
E1 = -182.59648125425778  E_coul = 54.0645597270548
cycle= 1 E= -128.531921527203  delta_E= -3.69e-13  |g|= 1.28e-06  |ddm|= 9.8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59648125425778  E_coul = 54.0645597270548
  HOMO = -0.845622295068048  LUMO = 0.667371509744339
  mo_energy =
[-3.27694745e+01 -1.92733948e+00 -8.45622295e-01 -8.45622295e-01
 -8.45622295e-01  6.67371510e-01  1.08681152e+00  1.08681152e+00
  1.08681152e+00  2.94710092e+00  5.68752061e+00  5.68752061e+00
  5.68752061e+00  9.44980381e+00  2.40545600e+01  2.40545600e+01
  2.40545600e+01  3.66707702e+01  1.18898111e+02  1.18898111e+02
  1.18898111e+02  1.40503569e+02  5.04365932e+02  1.87180486e+03
  8.00127965e+03  4.77687053e+04]
E1 = -182.59647662776717  E_coul = 54.06455510056381
Extra cycle  E= -128.531921527203  delta_E= -3.69e-13  |g|= 6.3e-07  |ddm|= 4.82e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [5.00525165e-01 2.44137941e+04 3.66145447e+03 8.33271058e+02
 2.35734730e+02 7.64331247e+01 1.00384213e+01 2.70500236e+01
 3.73512829e-01 1.11948173e+00 2.88117764e+00 3.68481280e+00
 1.24500456e+01 5.47853119e+01 3.29191645e-01 1.14456612e+00]
grad_E = [-1.57166841e-04 -9.81965584e-11  5.15203528e-09 -9.71982774e-08
  1.07079834e-06 -1.06143438e-05 -2.64365483e-04  9.08924085e-05
  1.41200414e-03 -5.03222405e-04  2.36808914e-04 -6.24493181e-04
  5.90063617e-05 -1.94386875e-06 -7.92634243e-03  3.28555839e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.502241847097       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446986        1
[INPUT] 0    0    [1    /1   ]  833.271059552        1
[INPUT] 0    0    [1    /1   ]  235.734709309        1
[INPUT] 0    0    [1    /1   ]  76.4333196904        1
[INPUT] 0    0    [1    /1   ]  10.0429614234        1
[INPUT] 0    0    [1    /1   ]  27.0484369656        1
[INPUT] 0    0    [1    /1   ]  0.34999613539        1
[INPUT] 0    0    [1    /1   ]  1.12683872724        1
[INPUT] 0    0    [1    /1   ]  2.87736222628        1
[INPUT] 1    0    [1    /1   ]  3.68483136856        1
[INPUT] 1    0    [1    /1   ]  12.4500449783        1
[INPUT] 1    0    [1    /1   ]  54.7853114232        1
[INPUT] 1    0    [1    /1   ]  0.32917499557        1
[INPUT] 1    0    [1    /1   ]  1.14449570679        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5022418470968194, 1.0]], [0, [24413.79412999302, 1.0]], [0, [3661.4544698642276, 1.0]], [0, [833.2710595521778, 1.0]], [0, [235.73470930936838, 1.0]], [0, [76.43331969044856, 1.0]], [0, [10.042961423419644, 1.0]], [0, [27.048436965594558, 1.0]], [0, [0.34999613538992286, 1.0]], [0, [1.1268387272383042, 1.0]], [0, [2.8773622262814103, 1.0]], [1, [3.6848313685609053, 1.0]], [1, [12.450044978253974, 1.0]], [1, [54.78531142317147, 1.0]], [1, [0.3291749955697107, 1.0]], [1, [1.1444957067935555, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50224185]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446986]
bas 3, expnt(s) = [833.27105955]
bas 4, expnt(s) = [235.73470931]
bas 5, expnt(s) = [76.43331969]
bas 6, expnt(s) = [10.04296142]
bas 7, expnt(s) = [27.04843697]
bas 8, expnt(s) = [0.34999614]
bas 9, expnt(s) = [1.12683873]
bas 10, expnt(s) = [2.87736223]
bas 11, expnt(s) = [3.68483137]
bas 12, expnt(s) = [12.45004498]
bas 13, expnt(s) = [54.78531142]
bas 14, expnt(s) = [0.329175]
bas 15, expnt(s) = [1.14449571]
CPU time:        13.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.02241847e-01 1.50729999e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271060e+02 3.91836373e+02
 2.35734709e+02 1.51996180e+02 7.64333197e+01 6.53096064e+01
 1.00429614e+01 1.42531669e+01 2.70484370e+01 2.99655087e+01
 3.49996135e-01 1.14964157e+00 1.12683873e+00 2.76319381e+00
 2.87736223e+00 5.58162850e+00 3.68483137e+00 1.48938308e+01
 1.24500450e+01 6.82257067e+01 5.47853114e+01 4.34825055e+02
 3.29174996e-01 7.27391029e-01 1.14449571e+00 3.45344149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998459932206028
cond(S) = 2001.0916433574232
E1 = -183.57744796084827  E_coul = 55.07848722227068
init E= -128.498960738578
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773950530541327  LUMO = 0.655475200946453
  mo_energy =
[-3.25553038e+01 -1.85280378e+00 -7.73950531e-01 -7.73950531e-01
 -7.73950531e-01  6.55475201e-01  1.11251060e+00  1.11251060e+00
  1.11251060e+00  2.91881068e+00  5.77470440e+00  5.77470440e+00
  5.77470440e+00  9.45748028e+00  2.42122232e+01  2.42122232e+01
  2.42122232e+01  3.67614651e+01  1.19114406e+02  1.19114406e+02
  1.19114406e+02  1.40656880e+02  5.04560325e+02  1.87203579e+03
  8.00154270e+03  4.77689931e+04]
E1 = -182.1082816920465  E_coul = 53.579681129476015
cycle= 1 E= -128.52860056257  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463717
diis-c [-0.21503332  1.        ]
  HOMO = -0.879802412488674  LUMO = 0.63553143509186
  mo_energy =
[-3.28742253e+01 -1.96335518e+00 -8.79802412e-01 -8.79802412e-01
 -8.79802412e-01  6.35531435e-01  1.07428716e+00  1.07428716e+00
  1.07428716e+00  2.86685422e+00  5.64548640e+00  5.64548640e+00
  5.64548640e+00  9.33127401e+00  2.39769728e+01  2.39769728e+01
  2.39769728e+01  3.65208847e+01  1.18793192e+02  1.18793192e+02
  1.18793192e+02  1.40343724e+02  5.04202808e+02  1.87164218e+03
  8.00112006e+03  4.77685516e+04]
E1 = -182.84141373905655  E_coul = 54.31030355514244
cycle= 2 E= -128.531110183914  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231604
diis-c [-6.07678167e-04  3.32138992e-01  6.67861008e-01]
  HOMO = -0.845399025703964  LUMO = 0.642060035079517
  mo_energy =
[-3.27690693e+01 -1.92717841e+00 -8.45399026e-01 -8.45399026e-01
 -8.45399026e-01  6.42060035e-01  1.08677997e+00  1.08677997e+00
  1.08677997e+00  2.88358833e+00  5.68747926e+00  5.68747926e+00
  5.68747926e+00  9.37233364e+00  2.40546388e+01  2.40546388e+01
  2.40546388e+01  3.66005299e+01  1.18898376e+02  1.18898376e+02
  1.18898376e+02  1.40446748e+02  5.04316570e+02  1.87176115e+03
  8.00124146e+03  4.77686739e+04]
E1 = -182.5954396464793  E_coul = 54.06347943902336
cycle= 3 E= -128.531960207456  delta_E= -0.00085  |g|= 0.000474  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000956582
diis-c [-1.37852920e-07 -2.19725888e-03 -5.90978304e-04  1.00278824e+00]
  HOMO = -0.845641229337019  LUMO = 0.642031217709152
  mo_energy =
[-3.27694959e+01 -1.92736090e+00 -8.45641229e-01 -8.45641229e-01
 -8.45641229e-01  6.42031218e-01  1.08672603e+00  1.08672603e+00
  1.08672603e+00  2.88349792e+00  5.68726491e+00  5.68726491e+00
  5.68726491e+00  9.37212651e+00  2.40543010e+01  2.40543010e+01
  2.40543010e+01  3.66001946e+01  1.18897937e+02  1.18897937e+02
  1.18897937e+02  1.40446322e+02  5.04316042e+02  1.87176051e+03
  8.00124074e+03  4.77686732e+04]
E1 = -182.5959722790355  E_coul = 54.06401205120245
cycle= 4 E= -128.531960227833  delta_E= -2.04e-08  |g|= 6.11e-05  |ddm|= 0.000564
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000126249
diis-c [-9.51046542e-10  3.18395603e-04  3.93725823e-04 -2.08263530e-01
  1.20755141e+00]
  HOMO = -0.845672979359397  LUMO = 0.642026000330251
  mo_energy =
[-3.27695472e+01 -1.92738132e+00 -8.45672979e-01 -8.45672979e-01
 -8.45672979e-01  6.42026000e-01  1.08671254e+00  1.08671254e+00
  1.08671254e+00  2.88348303e+00  5.68722962e+00  5.68722962e+00
  5.68722962e+00  9.37209487e+00  2.40542543e+01  2.40542543e+01
  2.40542543e+01  3.66001489e+01  1.18897885e+02  1.18897885e+02
  1.18897885e+02  1.40446271e+02  5.04315983e+02  1.87176045e+03
  8.00124067e+03  4.77686731e+04]
E1 = -182.5960720411103  E_coul = 54.064111812785626
cycle= 5 E= -128.531960228325  delta_E= -4.92e-10  |g|= 6.59e-06  |ddm|= 0.000108
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5960720411103  E_coul = 54.064111812785626
  HOMO = -0.84566934198093  LUMO = 0.642027074116772
  mo_energy =
[-3.27695392e+01 -1.92737696e+00 -8.45669342e-01 -8.45669342e-01
 -8.45669342e-01  6.42027074e-01  1.08671405e+00  1.08671405e+00
  1.08671405e+00  2.88348535e+00  5.68723406e+00  5.68723406e+00
  5.68723406e+00  9.37209947e+00  2.40542612e+01  2.40542612e+01
  2.40542612e+01  3.66001559e+01  1.18897893e+02  1.18897893e+02
  1.18897893e+02  1.40446279e+02  5.04315991e+02  1.87176045e+03
  8.00124068e+03  4.77686731e+04]
E1 = -182.59605418615914  E_coul = 54.06409395783195
Extra cycle  E= -128.531960228327  delta_E= -2.53e-12  |g|= 2.49e-06  |ddm|= 2.26e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [5.02241847e-01 2.44137941e+04 3.66145447e+03 8.33271060e+02
 2.35734709e+02 7.64333197e+01 1.00429614e+01 2.70484370e+01
 3.49996135e-01 1.12683873e+00 2.87736223e+00 3.68483137e+00
 1.24500450e+01 5.47853114e+01 3.29174996e-01 1.14449571e+00]
E = -128.5319602283272
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.502241847097       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446986        1
[INPUT] 0    0    [1    /1   ]  833.271059552        1
[INPUT] 0    0    [1    /1   ]  235.734709309        1
[INPUT] 0    0    [1    /1   ]  76.4333196904        1
[INPUT] 0    0    [1    /1   ]  10.0429614234        1
[INPUT] 0    0    [1    /1   ]  27.0484369656        1
[INPUT] 0    0    [1    /1   ]  0.34999613539        1
[INPUT] 0    0    [1    /1   ]  1.12683872724        1
[INPUT] 0    0    [1    /1   ]  2.87736222628        1
[INPUT] 1    0    [1    /1   ]  3.68483136856        1
[INPUT] 1    0    [1    /1   ]  12.4500449783        1
[INPUT] 1    0    [1    /1   ]  54.7853114232        1
[INPUT] 1    0    [1    /1   ]  0.32917499557        1
[INPUT] 1    0    [1    /1   ]  1.14449570679        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5022418470968194, 1.0]], [0, [24413.79412999302, 1.0]], [0, [3661.4544698642276, 1.0]], [0, [833.2710595521778, 1.0]], [0, [235.73470930936838, 1.0]], [0, [76.43331969044856, 1.0]], [0, [10.042961423419644, 1.0]], [0, [27.048436965594558, 1.0]], [0, [0.34999613538992286, 1.0]], [0, [1.1268387272383042, 1.0]], [0, [2.8773622262814103, 1.0]], [1, [3.6848313685609053, 1.0]], [1, [12.450044978253974, 1.0]], [1, [54.78531142317147, 1.0]], [1, [0.3291749955697107, 1.0]], [1, [1.1444957067935555, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50224185]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446986]
bas 3, expnt(s) = [833.27105955]
bas 4, expnt(s) = [235.73470931]
bas 5, expnt(s) = [76.43331969]
bas 6, expnt(s) = [10.04296142]
bas 7, expnt(s) = [27.04843697]
bas 8, expnt(s) = [0.34999614]
bas 9, expnt(s) = [1.12683873]
bas 10, expnt(s) = [2.87736223]
bas 11, expnt(s) = [3.68483137]
bas 12, expnt(s) = [12.45004498]
bas 13, expnt(s) = [54.78531142]
bas 14, expnt(s) = [0.329175]
bas 15, expnt(s) = [1.14449571]
CPU time:        13.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.02241847e-01 1.50729999e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271060e+02 3.91836373e+02
 2.35734709e+02 1.51996180e+02 7.64333197e+01 6.53096064e+01
 1.00429614e+01 1.42531669e+01 2.70484370e+01 2.99655087e+01
 3.49996135e-01 1.14964157e+00 1.12683873e+00 2.76319381e+00
 2.87736223e+00 5.58162850e+00 3.68483137e+00 1.48938308e+01
 1.24500450e+01 6.82257067e+01 5.47853114e+01 4.34825055e+02
 3.29174996e-01 7.27391029e-01 1.14449571e+00 3.45344149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998459932206028
cond(S) = 2001.0916433574232
E1 = -183.57744796084827  E_coul = 55.07848722227068
init E= -128.498960738578
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773950530541327  LUMO = 0.655475200946453
  mo_energy =
[-3.25553038e+01 -1.85280378e+00 -7.73950531e-01 -7.73950531e-01
 -7.73950531e-01  6.55475201e-01  1.11251060e+00  1.11251060e+00
  1.11251060e+00  2.91881068e+00  5.77470440e+00  5.77470440e+00
  5.77470440e+00  9.45748028e+00  2.42122232e+01  2.42122232e+01
  2.42122232e+01  3.67614651e+01  1.19114406e+02  1.19114406e+02
  1.19114406e+02  1.40656880e+02  5.04560325e+02  1.87203579e+03
  8.00154270e+03  4.77689931e+04]
E1 = -182.1082816920465  E_coul = 53.579681129476015
cycle= 1 E= -128.52860056257  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463717
diis-c [-0.21503332  1.        ]
  HOMO = -0.879802412488674  LUMO = 0.63553143509186
  mo_energy =
[-3.28742253e+01 -1.96335518e+00 -8.79802412e-01 -8.79802412e-01
 -8.79802412e-01  6.35531435e-01  1.07428716e+00  1.07428716e+00
  1.07428716e+00  2.86685422e+00  5.64548640e+00  5.64548640e+00
  5.64548640e+00  9.33127401e+00  2.39769728e+01  2.39769728e+01
  2.39769728e+01  3.65208847e+01  1.18793192e+02  1.18793192e+02
  1.18793192e+02  1.40343724e+02  5.04202808e+02  1.87164218e+03
  8.00112006e+03  4.77685516e+04]
E1 = -182.84141373905655  E_coul = 54.31030355514244
cycle= 2 E= -128.531110183914  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231604
diis-c [-6.07678167e-04  3.32138992e-01  6.67861008e-01]
  HOMO = -0.845399025703964  LUMO = 0.642060035079517
  mo_energy =
[-3.27690693e+01 -1.92717841e+00 -8.45399026e-01 -8.45399026e-01
 -8.45399026e-01  6.42060035e-01  1.08677997e+00  1.08677997e+00
  1.08677997e+00  2.88358833e+00  5.68747926e+00  5.68747926e+00
  5.68747926e+00  9.37233364e+00  2.40546388e+01  2.40546388e+01
  2.40546388e+01  3.66005299e+01  1.18898376e+02  1.18898376e+02
  1.18898376e+02  1.40446748e+02  5.04316570e+02  1.87176115e+03
  8.00124146e+03  4.77686739e+04]
E1 = -182.5954396464793  E_coul = 54.06347943902336
cycle= 3 E= -128.531960207456  delta_E= -0.00085  |g|= 0.000474  |ddm|= 0.024
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000956582
diis-c [-1.37852920e-07 -2.19725888e-03 -5.90978304e-04  1.00278824e+00]
  HOMO = -0.845641229337019  LUMO = 0.642031217709152
  mo_energy =
[-3.27694959e+01 -1.92736090e+00 -8.45641229e-01 -8.45641229e-01
 -8.45641229e-01  6.42031218e-01  1.08672603e+00  1.08672603e+00
  1.08672603e+00  2.88349792e+00  5.68726491e+00  5.68726491e+00
  5.68726491e+00  9.37212651e+00  2.40543010e+01  2.40543010e+01
  2.40543010e+01  3.66001946e+01  1.18897937e+02  1.18897937e+02
  1.18897937e+02  1.40446322e+02  5.04316042e+02  1.87176051e+03
  8.00124074e+03  4.77686732e+04]
E1 = -182.5959722790355  E_coul = 54.06401205120245
cycle= 4 E= -128.531960227833  delta_E= -2.04e-08  |g|= 6.11e-05  |ddm|= 0.000564
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000126249
diis-c [-9.51046542e-10  3.18395603e-04  3.93725823e-04 -2.08263530e-01
  1.20755141e+00]
  HOMO = -0.845672979359397  LUMO = 0.642026000330251
  mo_energy =
[-3.27695472e+01 -1.92738132e+00 -8.45672979e-01 -8.45672979e-01
 -8.45672979e-01  6.42026000e-01  1.08671254e+00  1.08671254e+00
  1.08671254e+00  2.88348303e+00  5.68722962e+00  5.68722962e+00
  5.68722962e+00  9.37209487e+00  2.40542543e+01  2.40542543e+01
  2.40542543e+01  3.66001489e+01  1.18897885e+02  1.18897885e+02
  1.18897885e+02  1.40446271e+02  5.04315983e+02  1.87176045e+03
  8.00124067e+03  4.77686731e+04]
E1 = -182.5960720411103  E_coul = 54.064111812785626
cycle= 5 E= -128.531960228325  delta_E= -4.92e-10  |g|= 6.59e-06  |ddm|= 0.000108
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5960720411103  E_coul = 54.064111812785626
  HOMO = -0.84566934198093  LUMO = 0.642027074116772
  mo_energy =
[-3.27695392e+01 -1.92737696e+00 -8.45669342e-01 -8.45669342e-01
 -8.45669342e-01  6.42027074e-01  1.08671405e+00  1.08671405e+00
  1.08671405e+00  2.88348535e+00  5.68723406e+00  5.68723406e+00
  5.68723406e+00  9.37209947e+00  2.40542612e+01  2.40542612e+01
  2.40542612e+01  3.66001559e+01  1.18897893e+02  1.18897893e+02
  1.18897893e+02  1.40446279e+02  5.04315991e+02  1.87176045e+03
  8.00124068e+03  4.77686731e+04]
E1 = -182.59605418615914  E_coul = 54.06409395783195
Extra cycle  E= -128.531960228327  delta_E= -2.53e-12  |g|= 2.49e-06  |ddm|= 2.26e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2001.0916433574232
E1 = -182.59605418615914  E_coul = 54.06409395783195
init E= -128.531960228327
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845670593145989  LUMO = 0.642026889095486
  mo_energy =
[-3.27695432e+01 -1.92737816e+00 -8.45670593e-01 -8.45670593e-01
 -8.45670593e-01  6.42026889e-01  1.08671361e+00  1.08671361e+00
  1.08671361e+00  2.88348481e+00  5.68723254e+00  5.68723254e+00
  5.68723254e+00  9.37209803e+00  2.40542583e+01  2.40542583e+01
  2.40542583e+01  3.66001530e+01  1.18897889e+02  1.18897889e+02
  1.18897889e+02  1.40446275e+02  5.04315987e+02  1.87176045e+03
  8.00124067e+03  4.77686731e+04]
E1 = -182.59606376005752  E_coul = 54.064103531729685
cycle= 1 E= -128.531960228328  delta_E= -6.25e-13  |g|= 1.31e-06  |ddm|= 9.83e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59606376005752  E_coul = 54.064103531729685
  HOMO = -0.845669920440915  LUMO = 0.642027025761429
  mo_energy =
[-3.27695412e+01 -1.92737743e+00 -8.45669920e-01 -8.45669920e-01
 -8.45669920e-01  6.42027026e-01  1.08671386e+00  1.08671386e+00
  1.08671386e+00  2.88348515e+00  5.68723336e+00  5.68723336e+00
  5.68723336e+00  9.37209884e+00  2.40542598e+01  2.40542598e+01
  2.40542598e+01  3.66001545e+01  1.18897891e+02  1.18897891e+02
  1.18897891e+02  1.40446277e+02  5.04315989e+02  1.87176045e+03
  8.00124067e+03  4.77686731e+04]
E1 = -182.59605899490253  E_coul = 54.064098766574816
Extra cycle  E= -128.531960228328  delta_E= 1.14e-13  |g|= 6.48e-07  |ddm|= 4.67e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [5.02241847e-01 2.44137941e+04 3.66145447e+03 8.33271060e+02
 2.35734709e+02 7.64333197e+01 1.00429614e+01 2.70484370e+01
 3.49996135e-01 1.12683873e+00 2.87736223e+00 3.68483137e+00
 1.24500450e+01 5.47853114e+01 3.29174996e-01 1.14449571e+00]
grad_E = [-2.87583195e-04 -4.67101794e-11  2.44819929e-09 -4.29646852e-08
  4.27103769e-07 -5.66523112e-06 -2.13430439e-04  6.76783875e-05
  1.25279815e-03 -7.41212939e-04  2.56013439e-04 -6.00497582e-04
  5.62079126e-05 -1.84275412e-06 -7.75470673e-03  3.20294245e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.511119464314       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446942        1
[INPUT] 0    0    [1    /1   ]  833.271068009        1
[INPUT] 0    0    [1    /1   ]  235.73461543         1
[INPUT] 0    0    [1    /1   ]  76.4342277485        1
[INPUT] 0    0    [1    /1   ]  10.0644324577        1
[INPUT] 0    0    [1    /1   ]  27.0409609369        1
[INPUT] 0    0    [1    /1   ]  0.23825002625        1
[INPUT] 0    0    [1    /1   ]  1.16324816091        1
[INPUT] 0    0    [1    /1   ]  2.8590055199         1
[INPUT] 1    0    [1    /1   ]  3.68488050283        1
[INPUT] 1    0    [1    /1   ]  12.4500481827        1
[INPUT] 1    0    [1    /1   ]  54.785308848         1
[INPUT] 1    0    [1    /1   ]  0.329263270271       1
[INPUT] 1    0    [1    /1   ]  1.14414783293        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5111194643136933, 1.0]], [0, [24413.79413000151, 1.0]], [0, [3661.454469418612, 1.0]], [0, [833.2710680089916, 1.0]], [0, [235.73461543028446, 1.0]], [0, [76.43422774846175, 1.0]], [0, [10.064432457685445, 1.0]], [0, [27.040960936876992, 1.0]], [0, [0.2382500262497893, 1.0]], [0, [1.1632481609080614, 1.0]], [0, [2.8590055199015927, 1.0]], [1, [3.6848805028337135, 1.0]], [1, [12.450048182698186, 1.0]], [1, [54.785308847982144, 1.0]], [1, [0.3292632702709869, 1.0]], [1, [1.144147832925339, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.51111946]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446942]
bas 3, expnt(s) = [833.27106801]
bas 4, expnt(s) = [235.73461543]
bas 5, expnt(s) = [76.43422775]
bas 6, expnt(s) = [10.06443246]
bas 7, expnt(s) = [27.04096094]
bas 8, expnt(s) = [0.23825003]
bas 9, expnt(s) = [1.16324816]
bas 10, expnt(s) = [2.85900552]
bas 11, expnt(s) = [3.6848805]
bas 12, expnt(s) = [12.45004818]
bas 13, expnt(s) = [54.78530885]
bas 14, expnt(s) = [0.32926327]
bas 15, expnt(s) = [1.14414783]
CPU time:        15.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.11119464e-01 1.52723841e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271068e+02 3.91836376e+02
 2.35734615e+02 1.51996135e+02 7.64342277e+01 6.53101883e+01
 1.00644325e+01 1.42760149e+01 2.70409609e+01 2.99592968e+01
 2.38250026e-01 8.61568361e-01 1.16324816e+00 2.82988838e+00
 2.85900552e+00 5.55490031e+00 3.68488050e+00 1.48940790e+01
 1.24500482e+01 6.82257287e+01 5.47853088e+01 4.34825030e+02
 3.29263270e-01 7.27634867e-01 1.14414783e+00 3.45212943e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487983871414
cond(S) = 747.3263123117024
E1 = -183.57739993287626  E_coul = 55.0785425951916
init E= -128.498857337685
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77395337110043  LUMO = 0.505922139521338
  mo_energy =
[-3.25552590e+01 -1.85286611e+00 -7.73953371e-01 -7.73953371e-01
 -7.73953371e-01  5.05922140e-01  1.11267083e+00  1.11267083e+00
  1.11267083e+00  2.57865437e+00  5.77410982e+00  5.77410982e+00
  5.77410982e+00  9.08308365e+00  2.42114287e+01  2.42114287e+01
  2.42114287e+01  3.64367967e+01  1.19113925e+02  1.19113925e+02
  1.19113925e+02  1.40396604e+02  5.04334103e+02  1.87183483e+03
  8.00136639e+03  4.77688472e+04]
E1 = -182.1068080330084  E_coul = 53.57812572658156
cycle= 1 E= -128.528682306427  delta_E= -0.0298  |g|= 0.202  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463683
diis-c [-0.21500155  1.        ]
  HOMO = -0.8799567795311  LUMO = 0.49016355526628
  mo_energy =
[-3.28744766e+01 -1.96346688e+00 -8.79956780e-01 -8.79956780e-01
 -8.79956780e-01  4.90163555e-01  1.07435476e+00  1.07435476e+00
  1.07435476e+00  2.52769159e+00  5.64474260e+00  5.64474260e+00
  5.64474260e+00  8.95599609e+00  2.39759658e+01  2.39759658e+01
  2.39759658e+01  3.61955141e+01  1.18792410e+02  1.18792410e+02
  1.18792410e+02  1.40083069e+02  5.03976265e+02  1.87144092e+03
  8.00094344e+03  4.77684055e+04]
E1 = -182.84116695548525  E_coul = 54.309968066456236
cycle= 2 E= -128.531198889029  delta_E= -0.00252  |g|=  0.1  |ddm|= 0.069
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2318
diis-c [-6.10658010e-04  3.32340524e-01  6.67659476e-01]
  HOMO = -0.845501709279767  LUMO = 0.495352221192668
  mo_energy =
[-3.27691872e+01 -1.92724328e+00 -8.45501709e-01 -8.45501709e-01
 -8.45501709e-01  4.95352221e-01  1.08686537e+00  1.08686537e+00
  1.08686537e+00  2.54410891e+00  5.68679309e+00  5.68679309e+00
  5.68679309e+00  8.99736685e+00  2.40537353e+01  2.40537353e+01
  2.40537353e+01  3.62754076e+01  1.18897726e+02  1.18897726e+02
  1.18897726e+02  1.40186258e+02  5.04090174e+02  1.87156004e+03
  8.00106499e+03  4.77685279e+04]
E1 = -182.59478410851167  E_coul = 54.06273232235288
cycle= 3 E= -128.532051786159  delta_E= -0.000853  |g|= 0.000468  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000943602
diis-c [-2.10630753e-07 -2.32083790e-03 -1.09174885e-03  1.00341259e+00]
  HOMO = -0.845739707322451  LUMO = 0.495331052911391
  mo_energy =
[-3.27695973e+01 -1.92741450e+00 -8.45739707e-01 -8.45739707e-01
 -8.45739707e-01  4.95331053e-01  1.08681177e+00  1.08681177e+00
  1.08681177e+00  2.54402508e+00  5.68658579e+00  5.68658579e+00
  5.68658579e+00  8.99716795e+00  2.40534104e+01  2.40534104e+01
  2.40534104e+01  3.62750855e+01  1.18897303e+02  1.18897303e+02
  1.18897303e+02  1.40185849e+02  5.04089661e+02  1.87155941e+03
  8.00106428e+03  4.77685272e+04]
E1 = -182.5952643329697  E_coul = 54.06321252397463
cycle= 4 E= -128.532051808995  delta_E= -2.28e-08  |g|= 6.36e-05  |ddm|= 0.000305
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132171
diis-c [-1.03097196e-09  3.33443150e-04  4.18655615e-04 -2.17386365e-01
  1.21663427e+00]
  HOMO = -0.845771964320299  LUMO = 0.495327091772278
  mo_energy =
[-3.27696475e+01 -1.92743352e+00 -8.45771964e-01 -8.45771964e-01
 -8.45771964e-01  4.95327092e-01  1.08679782e+00  1.08679782e+00
  1.08679782e+00  2.54401072e+00  5.68655034e+00  5.68655034e+00
  5.68655034e+00  8.99713649e+00  2.40533643e+01  2.40533643e+01
  2.40533643e+01  3.62750406e+01  1.18897252e+02  1.18897252e+02
  1.18897252e+02  1.40185798e+02  5.04089602e+02  1.87155935e+03
  8.00106421e+03  4.77685271e+04]
E1 = -182.59535865208704  E_coul = 54.0633068424871
cycle= 5 E= -128.5320518096  delta_E= -6.05e-10  |g|= 6.93e-06  |ddm|= 5.51e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59535865208704  E_coul = 54.0633068424871
  HOMO = -0.845768136052433  LUMO = 0.495328011083226
  mo_energy =
[-3.27696391e+01 -1.92742895e+00 -8.45768136e-01 -8.45768136e-01
 -8.45768136e-01  4.95328011e-01  1.08679942e+00  1.08679942e+00
  1.08679942e+00  2.54401316e+00  5.68655501e+00  5.68655501e+00
  5.68655501e+00  8.99714135e+00  2.40533715e+01  2.40533715e+01
  2.40533715e+01  3.62750479e+01  1.18897260e+02  1.18897260e+02
  1.18897260e+02  1.40185806e+02  5.04089611e+02  1.87155936e+03
  8.00106421e+03  4.77685271e+04]
E1 = -182.59534009750865  E_coul = 54.063288287905934
Extra cycle  E= -128.532051809603  delta_E= -2.76e-12  |g|= 2.59e-06  |ddm|= 2.71e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [5.11119464e-01 2.44137941e+04 3.66145447e+03 8.33271068e+02
 2.35734615e+02 7.64342277e+01 1.00644325e+01 2.70409609e+01
 2.38250026e-01 1.16324816e+00 2.85900552e+00 3.68488050e+00
 1.24500482e+01 5.47853088e+01 3.29263270e-01 1.14414783e+00]
E = -128.5320518096027
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.511119464314       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446942        1
[INPUT] 0    0    [1    /1   ]  833.271068009        1
[INPUT] 0    0    [1    /1   ]  235.73461543         1
[INPUT] 0    0    [1    /1   ]  76.4342277485        1
[INPUT] 0    0    [1    /1   ]  10.0644324577        1
[INPUT] 0    0    [1    /1   ]  27.0409609369        1
[INPUT] 0    0    [1    /1   ]  0.23825002625        1
[INPUT] 0    0    [1    /1   ]  1.16324816091        1
[INPUT] 0    0    [1    /1   ]  2.8590055199         1
[INPUT] 1    0    [1    /1   ]  3.68488050283        1
[INPUT] 1    0    [1    /1   ]  12.4500481827        1
[INPUT] 1    0    [1    /1   ]  54.785308848         1
[INPUT] 1    0    [1    /1   ]  0.329263270271       1
[INPUT] 1    0    [1    /1   ]  1.14414783293        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5111194643136933, 1.0]], [0, [24413.79413000151, 1.0]], [0, [3661.454469418612, 1.0]], [0, [833.2710680089916, 1.0]], [0, [235.73461543028446, 1.0]], [0, [76.43422774846175, 1.0]], [0, [10.064432457685445, 1.0]], [0, [27.040960936876992, 1.0]], [0, [0.2382500262497893, 1.0]], [0, [1.1632481609080614, 1.0]], [0, [2.8590055199015927, 1.0]], [1, [3.6848805028337135, 1.0]], [1, [12.450048182698186, 1.0]], [1, [54.785308847982144, 1.0]], [1, [0.3292632702709869, 1.0]], [1, [1.144147832925339, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.51111946]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446942]
bas 3, expnt(s) = [833.27106801]
bas 4, expnt(s) = [235.73461543]
bas 5, expnt(s) = [76.43422775]
bas 6, expnt(s) = [10.06443246]
bas 7, expnt(s) = [27.04096094]
bas 8, expnt(s) = [0.23825003]
bas 9, expnt(s) = [1.16324816]
bas 10, expnt(s) = [2.85900552]
bas 11, expnt(s) = [3.6848805]
bas 12, expnt(s) = [12.45004818]
bas 13, expnt(s) = [54.78530885]
bas 14, expnt(s) = [0.32926327]
bas 15, expnt(s) = [1.14414783]
CPU time:        16.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.11119464e-01 1.52723841e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271068e+02 3.91836376e+02
 2.35734615e+02 1.51996135e+02 7.64342277e+01 6.53101883e+01
 1.00644325e+01 1.42760149e+01 2.70409609e+01 2.99592968e+01
 2.38250026e-01 8.61568361e-01 1.16324816e+00 2.82988838e+00
 2.85900552e+00 5.55490031e+00 3.68488050e+00 1.48940790e+01
 1.24500482e+01 6.82257287e+01 5.47853088e+01 4.34825030e+02
 3.29263270e-01 7.27634867e-01 1.14414783e+00 3.45212943e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487983871414
cond(S) = 747.3263123117024
E1 = -183.57739993287626  E_coul = 55.0785425951916
init E= -128.498857337685
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77395337110043  LUMO = 0.505922139521338
  mo_energy =
[-3.25552590e+01 -1.85286611e+00 -7.73953371e-01 -7.73953371e-01
 -7.73953371e-01  5.05922140e-01  1.11267083e+00  1.11267083e+00
  1.11267083e+00  2.57865437e+00  5.77410982e+00  5.77410982e+00
  5.77410982e+00  9.08308365e+00  2.42114287e+01  2.42114287e+01
  2.42114287e+01  3.64367967e+01  1.19113925e+02  1.19113925e+02
  1.19113925e+02  1.40396604e+02  5.04334103e+02  1.87183483e+03
  8.00136639e+03  4.77688472e+04]
E1 = -182.1068080330084  E_coul = 53.57812572658156
cycle= 1 E= -128.528682306427  delta_E= -0.0298  |g|= 0.202  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463683
diis-c [-0.21500155  1.        ]
  HOMO = -0.8799567795311  LUMO = 0.49016355526628
  mo_energy =
[-3.28744766e+01 -1.96346688e+00 -8.79956780e-01 -8.79956780e-01
 -8.79956780e-01  4.90163555e-01  1.07435476e+00  1.07435476e+00
  1.07435476e+00  2.52769159e+00  5.64474260e+00  5.64474260e+00
  5.64474260e+00  8.95599609e+00  2.39759658e+01  2.39759658e+01
  2.39759658e+01  3.61955141e+01  1.18792410e+02  1.18792410e+02
  1.18792410e+02  1.40083069e+02  5.03976265e+02  1.87144092e+03
  8.00094344e+03  4.77684055e+04]
E1 = -182.84116695548525  E_coul = 54.309968066456236
cycle= 2 E= -128.531198889029  delta_E= -0.00252  |g|=  0.1  |ddm|= 0.069
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2318
diis-c [-6.10658010e-04  3.32340524e-01  6.67659476e-01]
  HOMO = -0.845501709279767  LUMO = 0.495352221192668
  mo_energy =
[-3.27691872e+01 -1.92724328e+00 -8.45501709e-01 -8.45501709e-01
 -8.45501709e-01  4.95352221e-01  1.08686537e+00  1.08686537e+00
  1.08686537e+00  2.54410891e+00  5.68679309e+00  5.68679309e+00
  5.68679309e+00  8.99736685e+00  2.40537353e+01  2.40537353e+01
  2.40537353e+01  3.62754076e+01  1.18897726e+02  1.18897726e+02
  1.18897726e+02  1.40186258e+02  5.04090174e+02  1.87156004e+03
  8.00106499e+03  4.77685279e+04]
E1 = -182.59478410851167  E_coul = 54.06273232235288
cycle= 3 E= -128.532051786159  delta_E= -0.000853  |g|= 0.000468  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000943602
diis-c [-2.10630753e-07 -2.32083790e-03 -1.09174885e-03  1.00341259e+00]
  HOMO = -0.845739707322451  LUMO = 0.495331052911391
  mo_energy =
[-3.27695973e+01 -1.92741450e+00 -8.45739707e-01 -8.45739707e-01
 -8.45739707e-01  4.95331053e-01  1.08681177e+00  1.08681177e+00
  1.08681177e+00  2.54402508e+00  5.68658579e+00  5.68658579e+00
  5.68658579e+00  8.99716795e+00  2.40534104e+01  2.40534104e+01
  2.40534104e+01  3.62750855e+01  1.18897303e+02  1.18897303e+02
  1.18897303e+02  1.40185849e+02  5.04089661e+02  1.87155941e+03
  8.00106428e+03  4.77685272e+04]
E1 = -182.5952643329697  E_coul = 54.06321252397463
cycle= 4 E= -128.532051808995  delta_E= -2.28e-08  |g|= 6.36e-05  |ddm|= 0.000305
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132171
diis-c [-1.03097196e-09  3.33443150e-04  4.18655615e-04 -2.17386365e-01
  1.21663427e+00]
  HOMO = -0.845771964320299  LUMO = 0.495327091772278
  mo_energy =
[-3.27696475e+01 -1.92743352e+00 -8.45771964e-01 -8.45771964e-01
 -8.45771964e-01  4.95327092e-01  1.08679782e+00  1.08679782e+00
  1.08679782e+00  2.54401072e+00  5.68655034e+00  5.68655034e+00
  5.68655034e+00  8.99713649e+00  2.40533643e+01  2.40533643e+01
  2.40533643e+01  3.62750406e+01  1.18897252e+02  1.18897252e+02
  1.18897252e+02  1.40185798e+02  5.04089602e+02  1.87155935e+03
  8.00106421e+03  4.77685271e+04]
E1 = -182.59535865208704  E_coul = 54.0633068424871
cycle= 5 E= -128.5320518096  delta_E= -6.05e-10  |g|= 6.93e-06  |ddm|= 5.51e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59535865208704  E_coul = 54.0633068424871
  HOMO = -0.845768136052433  LUMO = 0.495328011083226
  mo_energy =
[-3.27696391e+01 -1.92742895e+00 -8.45768136e-01 -8.45768136e-01
 -8.45768136e-01  4.95328011e-01  1.08679942e+00  1.08679942e+00
  1.08679942e+00  2.54401316e+00  5.68655501e+00  5.68655501e+00
  5.68655501e+00  8.99714135e+00  2.40533715e+01  2.40533715e+01
  2.40533715e+01  3.62750479e+01  1.18897260e+02  1.18897260e+02
  1.18897260e+02  1.40185806e+02  5.04089611e+02  1.87155936e+03
  8.00106421e+03  4.77685271e+04]
E1 = -182.59534009750865  E_coul = 54.063288287905934
Extra cycle  E= -128.532051809603  delta_E= -2.76e-12  |g|= 2.59e-06  |ddm|= 2.71e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 747.3263123117024
E1 = -182.59534009750865  E_coul = 54.063288287905934
init E= -128.532051809603
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.845769434375266  LUMO = 0.495327861978128
  mo_energy =
[-3.27696433e+01 -1.92743020e+00 -8.45769434e-01 -8.45769434e-01
 -8.45769434e-01  4.95327862e-01  1.08679897e+00  1.08679897e+00
  1.08679897e+00  2.54401262e+00  5.68655343e+00  5.68655343e+00
  5.68655343e+00  8.99713985e+00  2.40533685e+01  2.40533685e+01
  2.40533685e+01  3.62750449e+01  1.18897256e+02  1.18897256e+02
  1.18897256e+02  1.40185802e+02  5.04089606e+02  1.87155935e+03
  8.00106421e+03  4.77685271e+04]
E1 = -182.59535008940404  E_coul = 54.06329827980072
cycle= 1 E= -128.532051809603  delta_E= -6.25e-13  |g|= 1.37e-06  |ddm|= 9.91e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59535008940404  E_coul = 54.06329827980072
  HOMO = -0.845768731844234  LUMO = 0.495327975597471
  mo_energy =
[-3.27696411e+01 -1.92742943e+00 -8.45768732e-01 -8.45768732e-01
 -8.45768732e-01  4.95327976e-01  1.08679923e+00  1.08679923e+00
  1.08679923e+00  2.54401297e+00  5.68655429e+00  5.68655429e+00
  5.68655429e+00  8.99714071e+00  2.40533700e+01  2.40533700e+01
  2.40533700e+01  3.62750465e+01  1.18897258e+02  1.18897258e+02
  1.18897258e+02  1.40185804e+02  5.04089608e+02  1.87155935e+03
  8.00106421e+03  4.77685271e+04]
E1 = -182.59534511980746  E_coul = 54.06329331020435
Extra cycle  E= -128.532051809603  delta_E= 2.27e-13  |g|= 6.76e-07  |ddm|= 4.75e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [5.11119464e-01 2.44137941e+04 3.66145447e+03 8.33271068e+02
 2.35734615e+02 7.64342277e+01 1.00644325e+01 2.70409609e+01
 2.38250026e-01 1.16324816e+00 2.85900552e+00 3.68488050e+00
 1.24500482e+01 5.47853088e+01 3.29263270e-01 1.14414783e+00]
grad_E = [ 1.88254055e-03  2.06073718e-10 -1.08199838e-08  2.23523760e-07
 -2.73722036e-06  1.88434408e-05  5.64312816e-05 -4.88190026e-05
 -1.51078506e-03 -2.53376901e-03  4.42387378e-04 -4.33249223e-04
  3.85728928e-05 -1.22451511e-06 -5.81472502e-03  2.45748776e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.507295864371       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446956        1
[INPUT] 0    0    [1    /1   ]  833.271065346        1
[INPUT] 0    0    [1    /1   ]  235.734645189        1
[INPUT] 0    0    [1    /1   ]  76.4339457069        1
[INPUT] 0    0    [1    /1   ]  10.0580598458        1
[INPUT] 0    0    [1    /1   ]  27.0432022778        1
[INPUT] 0    0    [1    /1   ]  0.272192924241       1
[INPUT] 0    0    [1    /1   ]  1.15438621009        1
[INPUT] 0    0    [1    /1   ]  2.86408973776        1
[INPUT] 1    0    [1    /1   ]  3.6849112031         1
[INPUT] 1    0    [1    /1   ]  12.4500449684        1
[INPUT] 1    0    [1    /1   ]  54.7853096302        1
[INPUT] 1    0    [1    /1   ]  0.330123748771       1
[INPUT] 1    0    [1    /1   ]  1.14386029136        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5072958643712072, 1.0]], [0, [24413.794129998852, 1.0]], [0, [3661.454469558221, 1.0]], [0, [833.2710653457548, 1.0]], [0, [235.73464518890162, 1.0]], [0, [76.43394570692486, 1.0]], [0, [10.058059845801479, 1.0]], [0, [27.0432022777904, 1.0]], [0, [0.27219292424074887, 1.0]], [0, [1.1543862100898878, 1.0]], [0, [2.8640897377631425, 1.0]], [1, [3.684911203096417, 1.0]], [1, [12.450044968413827, 1.0]], [1, [54.785309630219224, 1.0]], [1, [0.3301237487705367, 1.0]], [1, [1.1438602913623994, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50729586]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446956]
bas 3, expnt(s) = [833.27106535]
bas 4, expnt(s) = [235.73464519]
bas 5, expnt(s) = [76.43394571]
bas 6, expnt(s) = [10.05805985]
bas 7, expnt(s) = [27.04320228]
bas 8, expnt(s) = [0.27219292]
bas 9, expnt(s) = [1.15438621]
bas 10, expnt(s) = [2.86408974]
bas 11, expnt(s) = [3.6849112]
bas 12, expnt(s) = [12.45004497]
bas 13, expnt(s) = [54.78530963]
bas 14, expnt(s) = [0.33012375]
bas 15, expnt(s) = [1.14386029]
CPU time:        18.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.07295864e-01 1.51866161e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271065e+02 3.91836375e+02
 2.35734645e+02 1.51996149e+02 7.64339457e+01 6.53100075e+01
 1.00580598e+01 1.42692348e+01 2.70432023e+01 2.99611592e+01
 2.72192924e-01 9.52078258e-01 1.15438621e+00 2.81370377e+00
 2.86408974e+00 5.56230745e+00 3.68491120e+00 1.48942341e+01
 1.24500450e+01 6.82257067e+01 5.47853096e+01 4.34825038e+02
 3.30123749e-01 7.30012594e-01 1.14386029e+00 3.45104500e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9984764920308
cond(S) = 908.4909910731313
E1 = -183.577581682878  E_coul = 55.078549856682464
init E= -128.499031826196
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773948026761577  LUMO = 0.556228564743278
  mo_energy =
[-3.25552765e+01 -1.85285984e+00 -7.73948027e-01 -7.73948027e-01
 -7.73948027e-01  5.56228565e-01  1.11511955e+00  1.11511955e+00
  1.11511955e+00  2.68845507e+00  5.77654230e+00  5.77654230e+00
  5.77654230e+00  9.20027561e+00  2.42131078e+01  2.42131078e+01
  2.42131078e+01  3.65378034e+01  1.19114954e+02  1.19114954e+02
  1.19114954e+02  1.40477656e+02  5.04404549e+02  1.87189741e+03
  8.00142129e+03  4.77688927e+04]
E1 = -182.11040984312172  E_coul = 53.58170432221445
cycle= 1 E= -128.528705520907  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46346
diis-c [-0.21479548  1.        ]
  HOMO = -0.879653809086352  LUMO = 0.539158928587404
  mo_energy =
[-3.28739223e+01 -1.96314209e+00 -8.79653809e-01 -8.79653809e-01
 -8.79653809e-01  5.39158929e-01  1.07690833e+00  1.07690833e+00
  1.07690833e+00  2.63743190e+00  5.64756164e+00  5.64756164e+00
  5.64756164e+00  9.07378760e+00  2.39781218e+01  2.39781218e+01
  2.39781218e+01  3.62971519e+01  1.18794018e+02  1.18794018e+02
  1.18794018e+02  1.40164707e+02  5.04047290e+02  1.87150406e+03
  8.00099891e+03  4.77684514e+04]
E1 = -182.84301921146718  E_coul = 54.31180535866901
cycle= 2 E= -128.531213852798  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0684
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231486
diis-c [-6.08450673e-04  3.32146753e-01  6.67853247e-01]
  HOMO = -0.845273429431695  LUMO = 0.544787323295862
  mo_energy =
[-3.27688442e+01 -1.92699611e+00 -8.45273429e-01 -8.45273429e-01
 -8.45273429e-01  5.44787323e-01  1.08940673e+00  1.08940673e+00
  1.08940673e+00  2.65389855e+00  5.68951393e+00  5.68951393e+00
  5.68951393e+00  9.11498289e+00  2.40557287e+01  2.40557287e+01
  2.40557287e+01  3.63768361e+01  1.18899123e+02  1.18899123e+02
  1.18899123e+02  1.40267678e+02  5.04160971e+02  1.87162295e+03
  8.00112022e+03  4.77685737e+04]
E1 = -182.59741859362546  E_coul = 54.06535648541053
cycle= 3 E= -128.532062108215  delta_E= -0.000848  |g|= 0.00046  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00093541
diis-c [-1.98014855e-07 -2.26351616e-03 -9.81873886e-04  1.00324539e+00]
  HOMO = -0.845505407047117  LUMO = 0.544767044472729
  mo_energy =
[-3.27692488e+01 -1.92716001e+00 -8.45505407e-01 -8.45505407e-01
 -8.45505407e-01  5.44767044e-01  1.08935665e+00  1.08935665e+00
  1.08935665e+00  2.65381918e+00  5.68931341e+00  5.68931341e+00
  5.68931341e+00  9.11479109e+00  2.40554105e+01  2.40554105e+01
  2.40554105e+01  3.63765209e+01  1.18898706e+02  1.18898706e+02
  1.18898706e+02  1.40267274e+02  5.04160463e+02  1.87162232e+03
  8.00111950e+03  4.77685729e+04]
E1 = -182.5979038144221  E_coul = 54.065841684360684
cycle= 4 E= -128.532062130061  delta_E= -2.18e-08  |g|= 6.31e-05  |ddm|= 0.000341
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131727
diis-c [-1.03836585e-09  3.42738480e-04  4.23128058e-04 -2.22618176e-01
  1.22185231e+00]
  HOMO = -0.845536969097701  LUMO = 0.544763138229146
  mo_energy =
[-3.27692985e+01 -1.92717795e+00 -8.45536969e-01 -8.45536969e-01
 -8.45536969e-01  5.44763138e-01  1.08934315e+00  1.08934315e+00
  1.08934315e+00  2.65380550e+00  5.68927879e+00  5.68927879e+00
  5.68927879e+00  9.11476065e+00  2.40553652e+01  2.40553652e+01
  2.40553652e+01  3.63764767e+01  1.18898656e+02  1.18898656e+02
  1.18898656e+02  1.40267224e+02  5.04160405e+02  1.87162226e+03
  8.00111943e+03  4.77685728e+04]
E1 = -182.59799924021152  E_coul = 54.06593710955392
cycle= 5 E= -128.532062130658  delta_E= -5.96e-10  |g|= 6.99e-06  |ddm|= 6.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59799924021152  E_coul = 54.06593710955392
  HOMO = -0.84553306219943  LUMO = 0.544764128939932
  mo_energy =
[-3.27692900e+01 -1.92717334e+00 -8.45533062e-01 -8.45533062e-01
 -8.45533062e-01  5.44764129e-01  1.08934478e+00  1.08934478e+00
  1.08934478e+00  2.65380795e+00  5.68928354e+00  5.68928354e+00
  5.68928354e+00  9.11476559e+00  2.40553725e+01  2.40553725e+01
  2.40553725e+01  3.63764842e+01  1.18898664e+02  1.18898664e+02
  1.18898664e+02  1.40267232e+02  5.04160413e+02  1.87162226e+03
  8.00111944e+03  4.77685728e+04]
E1 = -182.59798024152383  E_coul = 54.06591811086343
Extra cycle  E= -128.53206213066  delta_E= -2.79e-12  |g|= 2.65e-06  |ddm|= 2.68e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [5.07295864e-01 2.44137941e+04 3.66145447e+03 8.33271065e+02
 2.35734645e+02 7.64339457e+01 1.00580598e+01 2.70432023e+01
 2.72192924e-01 1.15438621e+00 2.86408974e+00 3.68491120e+00
 1.24500450e+01 5.47853096e+01 3.30123749e-01 1.14386029e+00]
E = -128.5320621306604
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.507295864371       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446956        1
[INPUT] 0    0    [1    /1   ]  833.271065346        1
[INPUT] 0    0    [1    /1   ]  235.734645189        1
[INPUT] 0    0    [1    /1   ]  76.4339457069        1
[INPUT] 0    0    [1    /1   ]  10.0580598458        1
[INPUT] 0    0    [1    /1   ]  27.0432022778        1
[INPUT] 0    0    [1    /1   ]  0.272192924241       1
[INPUT] 0    0    [1    /1   ]  1.15438621009        1
[INPUT] 0    0    [1    /1   ]  2.86408973776        1
[INPUT] 1    0    [1    /1   ]  3.6849112031         1
[INPUT] 1    0    [1    /1   ]  12.4500449684        1
[INPUT] 1    0    [1    /1   ]  54.7853096302        1
[INPUT] 1    0    [1    /1   ]  0.330123748771       1
[INPUT] 1    0    [1    /1   ]  1.14386029136        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5072958643712072, 1.0]], [0, [24413.794129998852, 1.0]], [0, [3661.454469558221, 1.0]], [0, [833.2710653457548, 1.0]], [0, [235.73464518890162, 1.0]], [0, [76.43394570692486, 1.0]], [0, [10.058059845801479, 1.0]], [0, [27.0432022777904, 1.0]], [0, [0.27219292424074887, 1.0]], [0, [1.1543862100898878, 1.0]], [0, [2.8640897377631425, 1.0]], [1, [3.684911203096417, 1.0]], [1, [12.450044968413827, 1.0]], [1, [54.785309630219224, 1.0]], [1, [0.3301237487705367, 1.0]], [1, [1.1438602913623994, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50729586]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446956]
bas 3, expnt(s) = [833.27106535]
bas 4, expnt(s) = [235.73464519]
bas 5, expnt(s) = [76.43394571]
bas 6, expnt(s) = [10.05805985]
bas 7, expnt(s) = [27.04320228]
bas 8, expnt(s) = [0.27219292]
bas 9, expnt(s) = [1.15438621]
bas 10, expnt(s) = [2.86408974]
bas 11, expnt(s) = [3.6849112]
bas 12, expnt(s) = [12.45004497]
bas 13, expnt(s) = [54.78530963]
bas 14, expnt(s) = [0.33012375]
bas 15, expnt(s) = [1.14386029]
CPU time:        18.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.07295864e-01 1.51866161e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271065e+02 3.91836375e+02
 2.35734645e+02 1.51996149e+02 7.64339457e+01 6.53100075e+01
 1.00580598e+01 1.42692348e+01 2.70432023e+01 2.99611592e+01
 2.72192924e-01 9.52078258e-01 1.15438621e+00 2.81370377e+00
 2.86408974e+00 5.56230745e+00 3.68491120e+00 1.48942341e+01
 1.24500450e+01 6.82257067e+01 5.47853096e+01 4.34825038e+02
 3.30123749e-01 7.30012594e-01 1.14386029e+00 3.45104500e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9984764920308
cond(S) = 908.4909910731313
E1 = -183.577581682878  E_coul = 55.078549856682464
init E= -128.499031826196
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.773948026761577  LUMO = 0.556228564743278
  mo_energy =
[-3.25552765e+01 -1.85285984e+00 -7.73948027e-01 -7.73948027e-01
 -7.73948027e-01  5.56228565e-01  1.11511955e+00  1.11511955e+00
  1.11511955e+00  2.68845507e+00  5.77654230e+00  5.77654230e+00
  5.77654230e+00  9.20027561e+00  2.42131078e+01  2.42131078e+01
  2.42131078e+01  3.65378034e+01  1.19114954e+02  1.19114954e+02
  1.19114954e+02  1.40477656e+02  5.04404549e+02  1.87189741e+03
  8.00142129e+03  4.77688927e+04]
E1 = -182.11040984312172  E_coul = 53.58170432221445
cycle= 1 E= -128.528705520907  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46346
diis-c [-0.21479548  1.        ]
  HOMO = -0.879653809086352  LUMO = 0.539158928587404
  mo_energy =
[-3.28739223e+01 -1.96314209e+00 -8.79653809e-01 -8.79653809e-01
 -8.79653809e-01  5.39158929e-01  1.07690833e+00  1.07690833e+00
  1.07690833e+00  2.63743190e+00  5.64756164e+00  5.64756164e+00
  5.64756164e+00  9.07378760e+00  2.39781218e+01  2.39781218e+01
  2.39781218e+01  3.62971519e+01  1.18794018e+02  1.18794018e+02
  1.18794018e+02  1.40164707e+02  5.04047290e+02  1.87150406e+03
  8.00099891e+03  4.77684514e+04]
E1 = -182.84301921146718  E_coul = 54.31180535866901
cycle= 2 E= -128.531213852798  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0684
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231486
diis-c [-6.08450673e-04  3.32146753e-01  6.67853247e-01]
  HOMO = -0.845273429431695  LUMO = 0.544787323295862
  mo_energy =
[-3.27688442e+01 -1.92699611e+00 -8.45273429e-01 -8.45273429e-01
 -8.45273429e-01  5.44787323e-01  1.08940673e+00  1.08940673e+00
  1.08940673e+00  2.65389855e+00  5.68951393e+00  5.68951393e+00
  5.68951393e+00  9.11498289e+00  2.40557287e+01  2.40557287e+01
  2.40557287e+01  3.63768361e+01  1.18899123e+02  1.18899123e+02
  1.18899123e+02  1.40267678e+02  5.04160971e+02  1.87162295e+03
  8.00112022e+03  4.77685737e+04]
E1 = -182.59741859362546  E_coul = 54.06535648541053
cycle= 3 E= -128.532062108215  delta_E= -0.000848  |g|= 0.00046  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00093541
diis-c [-1.98014855e-07 -2.26351616e-03 -9.81873886e-04  1.00324539e+00]
  HOMO = -0.845505407047117  LUMO = 0.544767044472729
  mo_energy =
[-3.27692488e+01 -1.92716001e+00 -8.45505407e-01 -8.45505407e-01
 -8.45505407e-01  5.44767044e-01  1.08935665e+00  1.08935665e+00
  1.08935665e+00  2.65381918e+00  5.68931341e+00  5.68931341e+00
  5.68931341e+00  9.11479109e+00  2.40554105e+01  2.40554105e+01
  2.40554105e+01  3.63765209e+01  1.18898706e+02  1.18898706e+02
  1.18898706e+02  1.40267274e+02  5.04160463e+02  1.87162232e+03
  8.00111950e+03  4.77685729e+04]
E1 = -182.5979038144221  E_coul = 54.065841684360684
cycle= 4 E= -128.532062130061  delta_E= -2.18e-08  |g|= 6.31e-05  |ddm|= 0.000341
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131727
diis-c [-1.03836585e-09  3.42738480e-04  4.23128058e-04 -2.22618176e-01
  1.22185231e+00]
  HOMO = -0.845536969097701  LUMO = 0.544763138229146
  mo_energy =
[-3.27692985e+01 -1.92717795e+00 -8.45536969e-01 -8.45536969e-01
 -8.45536969e-01  5.44763138e-01  1.08934315e+00  1.08934315e+00
  1.08934315e+00  2.65380550e+00  5.68927879e+00  5.68927879e+00
  5.68927879e+00  9.11476065e+00  2.40553652e+01  2.40553652e+01
  2.40553652e+01  3.63764767e+01  1.18898656e+02  1.18898656e+02
  1.18898656e+02  1.40267224e+02  5.04160405e+02  1.87162226e+03
  8.00111943e+03  4.77685728e+04]
E1 = -182.59799924021152  E_coul = 54.06593710955392
cycle= 5 E= -128.532062130658  delta_E= -5.96e-10  |g|= 6.99e-06  |ddm|= 6.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59799924021152  E_coul = 54.06593710955392
  HOMO = -0.84553306219943  LUMO = 0.544764128939932
  mo_energy =
[-3.27692900e+01 -1.92717334e+00 -8.45533062e-01 -8.45533062e-01
 -8.45533062e-01  5.44764129e-01  1.08934478e+00  1.08934478e+00
  1.08934478e+00  2.65380795e+00  5.68928354e+00  5.68928354e+00
  5.68928354e+00  9.11476559e+00  2.40553725e+01  2.40553725e+01
  2.40553725e+01  3.63764842e+01  1.18898664e+02  1.18898664e+02
  1.18898664e+02  1.40267232e+02  5.04160413e+02  1.87162226e+03
  8.00111944e+03  4.77685728e+04]
E1 = -182.59798024152383  E_coul = 54.06591811086343
Extra cycle  E= -128.53206213066  delta_E= -2.79e-12  |g|= 2.65e-06  |ddm|= 2.68e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 908.4909910731313
E1 = -182.59798024152383  E_coul = 54.06591811086343
init E= -128.53206213066
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845534389254911  LUMO = 0.544763958484835
  mo_energy =
[-3.27692942e+01 -1.92717463e+00 -8.45534389e-01 -8.45534389e-01
 -8.45534389e-01  5.44763958e-01  1.08934432e+00  1.08934432e+00
  1.08934432e+00  2.65380739e+00  5.68928192e+00  5.68928192e+00
  5.68928192e+00  9.11476405e+00  2.40553694e+01  2.40553694e+01
  2.40553694e+01  3.63764811e+01  1.18898660e+02  1.18898660e+02
  1.18898660e+02  1.40267228e+02  5.04160408e+02  1.87162226e+03
  8.00111944e+03  4.77685728e+04]
E1 = -182.5979904425293  E_coul = 54.06592831186836
cycle= 1 E= -128.532062130661  delta_E= -5.4e-13  |g|= 1.4e-06  |ddm|= 1.02e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5979904425293  E_coul = 54.06592831186836
  HOMO = -0.845533671587152  LUMO = 0.544764083680277
  mo_energy =
[-3.27692920e+01 -1.92717385e+00 -8.45533672e-01 -8.45533672e-01
 -8.45533672e-01  5.44764084e-01  1.08934458e+00  1.08934458e+00
  1.08934458e+00  2.65380775e+00  5.68928280e+00  5.68928280e+00
  5.68928280e+00  9.11476492e+00  2.40553710e+01  2.40553710e+01
  2.40553710e+01  3.63764827e+01  1.18898662e+02  1.18898662e+02
  1.18898662e+02  1.40267230e+02  5.04160411e+02  1.87162226e+03
  8.00111944e+03  4.77685728e+04]
E1 = -182.5979853707573  E_coul = 54.065923240096204
Extra cycle  E= -128.532062130661  delta_E= -1.71e-13  |g|= 6.9e-07  |ddm|= 4.82e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [5.07295864e-01 2.44137941e+04 3.66145447e+03 8.33271065e+02
 2.35734645e+02 7.64339457e+01 1.00580598e+01 2.70432023e+01
 2.72192924e-01 1.15438621e+00 2.86408974e+00 3.68491120e+00
 1.24500450e+01 5.47853096e+01 3.30123749e-01 1.14386029e+00]
grad_E = [ 4.25050806e-04  1.25459280e-10 -6.58913556e-09  1.38462195e-07
 -1.72501690e-06  1.09292752e-05 -3.99362388e-05 -1.02321660e-05
 -3.79559786e-05 -1.74290591e-03  3.37225381e-04  4.93584624e-05
 -6.50470158e-06  2.71284173e-07  2.17106345e-04 -9.64813568e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.507536045247       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446951        1
[INPUT] 0    0    [1    /1   ]  833.271066286        1
[INPUT] 0    0    [1    /1   ]  235.734634964        1
[INPUT] 0    0    [1    /1   ]  76.4340510012        1
[INPUT] 0    0    [1    /1   ]  10.060879038         1
[INPUT] 0    0    [1    /1   ]  27.0422465712        1
[INPUT] 0    0    [1    /1   ]  0.258096326531       1
[INPUT] 0    0    [1    /1   ]  1.1611637851         1
[INPUT] 0    0    [1    /1   ]  2.86131411126        1
[INPUT] 1    0    [1    /1   ]  3.68489693587        1
[INPUT] 1    0    [1    /1   ]  12.4500493901        1
[INPUT] 1    0    [1    /1   ]  54.7853091011        1
[INPUT] 1    0    [1    /1   ]  0.330258107114       1
[INPUT] 1    0    [1    /1   ]  1.14375264068        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.507536045247267, 1.0]], [0, [24413.794129999813, 1.0]], [0, [3661.4544695078944, 1.0]], [0, [833.2710662858035, 1.0]], [0, [235.73463496438077, 1.0]], [0, [76.43405100118302, 1.0]], [0, [10.060879038020449, 1.0]], [0, [27.042246571226787, 1.0]], [0, [0.2580963265308134, 1.0]], [0, [1.161163785102505, 1.0]], [0, [2.8613141112613008, 1.0]], [1, [3.684896935869148, 1.0]], [1, [12.450049390070433, 1.0]], [1, [54.78530910109102, 1.0]], [1, [0.33025810711446385, 1.0]], [1, [1.1437526406794527, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50753605]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446951]
bas 3, expnt(s) = [833.27106629]
bas 4, expnt(s) = [235.73463496]
bas 5, expnt(s) = [76.434051]
bas 6, expnt(s) = [10.06087904]
bas 7, expnt(s) = [27.04224657]
bas 8, expnt(s) = [0.25809633]
bas 9, expnt(s) = [1.16116379]
bas 10, expnt(s) = [2.86131411]
bas 11, expnt(s) = [3.68489694]
bas 12, expnt(s) = [12.45004939]
bas 13, expnt(s) = [54.7853091]
bas 14, expnt(s) = [0.33025811]
bas 15, expnt(s) = [1.14375264]
CPU time:        21.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.07536045e-01 1.51920084e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271066e+02 3.91836376e+02
 2.35734635e+02 1.51996144e+02 7.64340510e+01 6.53100750e+01
 1.00608790e+01 1.42722344e+01 2.70422466e+01 2.99603650e+01
 2.58096327e-01 9.14853158e-01 1.16116379e+00 2.82608445e+00
 2.86131411e+00 5.55826408e+00 3.68489694e+00 1.48941620e+01
 1.24500494e+01 6.82257369e+01 5.47853091e+01 4.34825032e+02
 3.30258107e-01 7.30384002e-01 1.14375264e+00 3.45063903e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99847722852937
cond(S) = 828.1232672592836
E1 = -183.57758929275286  E_coul = 55.0785611194611
init E= -128.499028173292
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77394727776633  LUMO = 0.535520306177571
  mo_energy =
[-3.25552717e+01 -1.85286603e+00 -7.73947278e-01 -7.73947278e-01
 -7.73947278e-01  5.35520306e-01  1.11548346e+00  1.11548346e+00
  1.11548346e+00  2.64289115e+00  5.77673712e+00  5.77673712e+00
  5.77673712e+00  9.15476434e+00  2.42131031e+01  2.42131031e+01
  2.42131031e+01  3.65009336e+01  1.19114924e+02  1.19114924e+02
  1.19114924e+02  1.40448856e+02  5.04379655e+02  1.87187532e+03
  8.00140192e+03  4.77688766e+04]
E1 = -182.11082725443654  E_coul = 53.582110913077464
cycle= 1 E= -128.528716341359  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463277
diis-c [-0.21462592  1.        ]
  HOMO = -0.879621640945993  LUMO = 0.519047957611895
  mo_energy =
[-3.28738589e+01 -1.96310344e+00 -8.79621641e-01 -8.79621641e-01
 -8.79621641e-01  5.19047958e-01  1.07727840e+00  1.07727840e+00
  1.07727840e+00  2.59199195e+00  5.64780209e+00  5.64780209e+00
  5.64780209e+00  9.02817918e+00  2.39781716e+01  2.39781716e+01
  2.39781716e+01  3.62602753e+01  1.18794047e+02  1.18794047e+02
  1.18794047e+02  1.40135954e+02  5.04022454e+02  1.87148203e+03
  8.00097959e+03  4.77684355e+04]
E1 = -182.843320514062  E_coul = 54.31209630354111
cycle= 2 E= -128.531224210521  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0685
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231402
diis-c [-6.08655499e-04  3.32152065e-01  6.67847935e-01]
  HOMO = -0.845246561405516  LUMO = 0.524487211969931
  mo_energy =
[-3.27687989e+01 -1.92696417e+00 -8.45246561e-01 -8.45246561e-01
 -8.45246561e-01  5.24487212e-01  1.08977665e+00  1.08977665e+00
  1.08977665e+00  2.60842366e+00  5.68974586e+00  5.68974586e+00
  5.68974586e+00  9.06941405e+00  2.40557649e+01  2.40557649e+01
  2.40557649e+01  3.63399643e+01  1.18899134e+02  1.18899134e+02
  1.18899134e+02  1.40238911e+02  5.04136116e+02  1.87160089e+03
  8.00110088e+03  4.77685577e+04]
E1 = -182.59778961887673  E_coul = 54.06571750728619
cycle= 3 E= -128.532072111591  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000931419
diis-c [-2.08222924e-07 -2.27838686e-03 -1.05832252e-03  1.00333671e+00]
  HOMO = -0.845476732912683  LUMO = 0.524468221157979
  mo_energy =
[-3.27691997e+01 -1.92712542e+00 -8.45476733e-01 -8.45476733e-01
 -8.45476733e-01  5.24468221e-01  1.08972721e+00  1.08972721e+00
  1.08972721e+00  2.60834593e+00  5.68954765e+00  5.68954765e+00
  5.68954765e+00  9.06922463e+00  2.40554501e+01  2.40554501e+01
  2.40554501e+01  3.63396524e+01  1.18898721e+02  1.18898721e+02
  1.18898721e+02  1.40238511e+02  5.04135611e+02  1.87160027e+03
  8.00110017e+03  4.77685569e+04]
E1 = -182.59826647404662  E_coul = 54.06619434045382
cycle= 4 E= -128.532072133593  delta_E= -2.2e-08  |g|= 6.32e-05  |ddm|= 0.000318
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132295
diis-c [-1.04322932e-09  3.43709211e-04  4.26940159e-04 -2.23428800e-01
  1.22265815e+00]
  HOMO = -0.845508172904501  LUMO = 0.524464518785721
  mo_energy =
[-3.27692491e+01 -1.92714300e+00 -8.45508173e-01 -8.45508173e-01
 -8.45508173e-01  5.24464519e-01  1.08971373e+00  1.08971373e+00
  1.08971373e+00  2.60833244e+00  5.68951322e+00  5.68951322e+00
  5.68951322e+00  9.06919442e+00  2.40554051e+01  2.40554051e+01
  2.40554051e+01  3.63396086e+01  1.18898671e+02  1.18898671e+02
  1.18898671e+02  1.40238461e+02  5.04135554e+02  1.87160021e+03
  8.00110010e+03  4.77685568e+04]
E1 = -182.5983608122817  E_coul = 54.066288678080326
cycle= 5 E= -128.532072134201  delta_E= -6.09e-10  |g|= 6.98e-06  |ddm|= 5.97e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983608122817  E_coul = 54.066288678080326
  HOMO = -0.845504272037578  LUMO = 0.524465478334735
  mo_energy =
[-3.27692405e+01 -1.92713841e+00 -8.45504272e-01 -8.45504272e-01
 -8.45504272e-01  5.24465478e-01  1.08971536e+00  1.08971536e+00
  1.08971536e+00  2.60833489e+00  5.68951796e+00  5.68951796e+00
  5.68951796e+00  9.06919935e+00  2.40554124e+01  2.40554124e+01
  2.40554124e+01  3.63396161e+01  1.18898679e+02  1.18898679e+02
  1.18898679e+02  1.40238469e+02  5.04135562e+02  1.87160021e+03
  8.00110011e+03  4.77685569e+04]
E1 = -182.59834184549797  E_coul = 54.066269711293614
Extra cycle  E= -128.532072134204  delta_E= -2.98e-12  |g|= 2.65e-06  |ddm|= 2.69e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [5.07536045e-01 2.44137941e+04 3.66145447e+03 8.33271066e+02
 2.35734635e+02 7.64340510e+01 1.00608790e+01 2.70422466e+01
 2.58096327e-01 1.16116379e+00 2.86131411e+00 3.68489694e+00
 1.24500494e+01 5.47853091e+01 3.30258107e-01 1.14375264e+00]
E = -128.53207213420436
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.507536045247       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446951        1
[INPUT] 0    0    [1    /1   ]  833.271066286        1
[INPUT] 0    0    [1    /1   ]  235.734634964        1
[INPUT] 0    0    [1    /1   ]  76.4340510012        1
[INPUT] 0    0    [1    /1   ]  10.060879038         1
[INPUT] 0    0    [1    /1   ]  27.0422465712        1
[INPUT] 0    0    [1    /1   ]  0.258096326531       1
[INPUT] 0    0    [1    /1   ]  1.1611637851         1
[INPUT] 0    0    [1    /1   ]  2.86131411126        1
[INPUT] 1    0    [1    /1   ]  3.68489693587        1
[INPUT] 1    0    [1    /1   ]  12.4500493901        1
[INPUT] 1    0    [1    /1   ]  54.7853091011        1
[INPUT] 1    0    [1    /1   ]  0.330258107114       1
[INPUT] 1    0    [1    /1   ]  1.14375264068        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.507536045247267, 1.0]], [0, [24413.794129999813, 1.0]], [0, [3661.4544695078944, 1.0]], [0, [833.2710662858035, 1.0]], [0, [235.73463496438077, 1.0]], [0, [76.43405100118302, 1.0]], [0, [10.060879038020449, 1.0]], [0, [27.042246571226787, 1.0]], [0, [0.2580963265308134, 1.0]], [0, [1.161163785102505, 1.0]], [0, [2.8613141112613008, 1.0]], [1, [3.684896935869148, 1.0]], [1, [12.450049390070433, 1.0]], [1, [54.78530910109102, 1.0]], [1, [0.33025810711446385, 1.0]], [1, [1.1437526406794527, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50753605]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446951]
bas 3, expnt(s) = [833.27106629]
bas 4, expnt(s) = [235.73463496]
bas 5, expnt(s) = [76.434051]
bas 6, expnt(s) = [10.06087904]
bas 7, expnt(s) = [27.04224657]
bas 8, expnt(s) = [0.25809633]
bas 9, expnt(s) = [1.16116379]
bas 10, expnt(s) = [2.86131411]
bas 11, expnt(s) = [3.68489694]
bas 12, expnt(s) = [12.45004939]
bas 13, expnt(s) = [54.7853091]
bas 14, expnt(s) = [0.33025811]
bas 15, expnt(s) = [1.14375264]
CPU time:        21.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.07536045e-01 1.51920084e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271066e+02 3.91836376e+02
 2.35734635e+02 1.51996144e+02 7.64340510e+01 6.53100750e+01
 1.00608790e+01 1.42722344e+01 2.70422466e+01 2.99603650e+01
 2.58096327e-01 9.14853158e-01 1.16116379e+00 2.82608445e+00
 2.86131411e+00 5.55826408e+00 3.68489694e+00 1.48941620e+01
 1.24500494e+01 6.82257369e+01 5.47853091e+01 4.34825032e+02
 3.30258107e-01 7.30384002e-01 1.14375264e+00 3.45063903e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99847722852937
cond(S) = 828.1232672592836
E1 = -183.57758929275286  E_coul = 55.0785611194611
init E= -128.499028173292
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77394727776633  LUMO = 0.535520306177571
  mo_energy =
[-3.25552717e+01 -1.85286603e+00 -7.73947278e-01 -7.73947278e-01
 -7.73947278e-01  5.35520306e-01  1.11548346e+00  1.11548346e+00
  1.11548346e+00  2.64289115e+00  5.77673712e+00  5.77673712e+00
  5.77673712e+00  9.15476434e+00  2.42131031e+01  2.42131031e+01
  2.42131031e+01  3.65009336e+01  1.19114924e+02  1.19114924e+02
  1.19114924e+02  1.40448856e+02  5.04379655e+02  1.87187532e+03
  8.00140192e+03  4.77688766e+04]
E1 = -182.11082725443654  E_coul = 53.582110913077464
cycle= 1 E= -128.528716341359  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.463277
diis-c [-0.21462592  1.        ]
  HOMO = -0.879621640945993  LUMO = 0.519047957611895
  mo_energy =
[-3.28738589e+01 -1.96310344e+00 -8.79621641e-01 -8.79621641e-01
 -8.79621641e-01  5.19047958e-01  1.07727840e+00  1.07727840e+00
  1.07727840e+00  2.59199195e+00  5.64780209e+00  5.64780209e+00
  5.64780209e+00  9.02817918e+00  2.39781716e+01  2.39781716e+01
  2.39781716e+01  3.62602753e+01  1.18794047e+02  1.18794047e+02
  1.18794047e+02  1.40135954e+02  5.04022454e+02  1.87148203e+03
  8.00097959e+03  4.77684355e+04]
E1 = -182.843320514062  E_coul = 54.31209630354111
cycle= 2 E= -128.531224210521  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0685
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231402
diis-c [-6.08655499e-04  3.32152065e-01  6.67847935e-01]
  HOMO = -0.845246561405516  LUMO = 0.524487211969931
  mo_energy =
[-3.27687989e+01 -1.92696417e+00 -8.45246561e-01 -8.45246561e-01
 -8.45246561e-01  5.24487212e-01  1.08977665e+00  1.08977665e+00
  1.08977665e+00  2.60842366e+00  5.68974586e+00  5.68974586e+00
  5.68974586e+00  9.06941405e+00  2.40557649e+01  2.40557649e+01
  2.40557649e+01  3.63399643e+01  1.18899134e+02  1.18899134e+02
  1.18899134e+02  1.40238911e+02  5.04136116e+02  1.87160089e+03
  8.00110088e+03  4.77685577e+04]
E1 = -182.59778961887673  E_coul = 54.06571750728619
cycle= 3 E= -128.532072111591  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000931419
diis-c [-2.08222924e-07 -2.27838686e-03 -1.05832252e-03  1.00333671e+00]
  HOMO = -0.845476732912683  LUMO = 0.524468221157979
  mo_energy =
[-3.27691997e+01 -1.92712542e+00 -8.45476733e-01 -8.45476733e-01
 -8.45476733e-01  5.24468221e-01  1.08972721e+00  1.08972721e+00
  1.08972721e+00  2.60834593e+00  5.68954765e+00  5.68954765e+00
  5.68954765e+00  9.06922463e+00  2.40554501e+01  2.40554501e+01
  2.40554501e+01  3.63396524e+01  1.18898721e+02  1.18898721e+02
  1.18898721e+02  1.40238511e+02  5.04135611e+02  1.87160027e+03
  8.00110017e+03  4.77685569e+04]
E1 = -182.59826647404662  E_coul = 54.06619434045382
cycle= 4 E= -128.532072133593  delta_E= -2.2e-08  |g|= 6.32e-05  |ddm|= 0.000318
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132295
diis-c [-1.04322932e-09  3.43709211e-04  4.26940159e-04 -2.23428800e-01
  1.22265815e+00]
  HOMO = -0.845508172904501  LUMO = 0.524464518785721
  mo_energy =
[-3.27692491e+01 -1.92714300e+00 -8.45508173e-01 -8.45508173e-01
 -8.45508173e-01  5.24464519e-01  1.08971373e+00  1.08971373e+00
  1.08971373e+00  2.60833244e+00  5.68951322e+00  5.68951322e+00
  5.68951322e+00  9.06919442e+00  2.40554051e+01  2.40554051e+01
  2.40554051e+01  3.63396086e+01  1.18898671e+02  1.18898671e+02
  1.18898671e+02  1.40238461e+02  5.04135554e+02  1.87160021e+03
  8.00110010e+03  4.77685568e+04]
E1 = -182.5983608122817  E_coul = 54.066288678080326
cycle= 5 E= -128.532072134201  delta_E= -6.09e-10  |g|= 6.98e-06  |ddm|= 5.97e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983608122817  E_coul = 54.066288678080326
  HOMO = -0.845504272037578  LUMO = 0.524465478334735
  mo_energy =
[-3.27692405e+01 -1.92713841e+00 -8.45504272e-01 -8.45504272e-01
 -8.45504272e-01  5.24465478e-01  1.08971536e+00  1.08971536e+00
  1.08971536e+00  2.60833489e+00  5.68951796e+00  5.68951796e+00
  5.68951796e+00  9.06919935e+00  2.40554124e+01  2.40554124e+01
  2.40554124e+01  3.63396161e+01  1.18898679e+02  1.18898679e+02
  1.18898679e+02  1.40238469e+02  5.04135562e+02  1.87160021e+03
  8.00110011e+03  4.77685569e+04]
E1 = -182.59834184549797  E_coul = 54.066269711293614
Extra cycle  E= -128.532072134204  delta_E= -2.98e-12  |g|= 2.65e-06  |ddm|= 2.69e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 828.1232672592836
E1 = -182.59834184549797  E_coul = 54.066269711293614
init E= -128.532072134204
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845505596960341  LUMO = 0.524465314371549
  mo_energy =
[-3.27692447e+01 -1.92713969e+00 -8.45505597e-01 -8.45505597e-01
 -8.45505597e-01  5.24465314e-01  1.08971490e+00  1.08971490e+00
  1.08971490e+00  2.60833433e+00  5.68951635e+00  5.68951635e+00
  5.68951635e+00  9.06919782e+00  2.40554093e+01  2.40554093e+01
  2.40554093e+01  3.63396129e+01  1.18898675e+02  1.18898675e+02
  1.18898675e+02  1.40238465e+02  5.04135557e+02  1.87160021e+03
  8.00110010e+03  4.77685569e+04]
E1 = -182.5983520308532  E_coul = 54.066279896648375
cycle= 1 E= -128.532072134205  delta_E= -4.55e-13  |g|= 1.39e-06  |ddm|= 1.01e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5983520308532  E_coul = 54.066279896648375
  HOMO = -0.845504880402419  LUMO = 0.524465435263833
  mo_energy =
[-3.27692426e+01 -1.92713891e+00 -8.45504880e-01 -8.45504880e-01
 -8.45504880e-01  5.24465435e-01  1.08971516e+00  1.08971516e+00
  1.08971516e+00  2.60833469e+00  5.68951723e+00  5.68951723e+00
  5.68951723e+00  9.06919869e+00  2.40554109e+01  2.40554109e+01
  2.40554109e+01  3.63396146e+01  1.18898677e+02  1.18898677e+02
  1.18898677e+02  1.40238467e+02  5.04135560e+02  1.87160021e+03
  8.00110010e+03  4.77685569e+04]
E1 = -182.59834696775528  E_coul = 54.0662748335504
Extra cycle  E= -128.532072134205  delta_E= -5.68e-14  |g|= 6.89e-07  |ddm|= 4.82e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [5.07536045e-01 2.44137941e+04 3.66145447e+03 8.33271066e+02
 2.35734635e+02 7.64340510e+01 1.00608790e+01 2.70422466e+01
 2.58096327e-01 1.16116379e+00 2.86131411e+00 3.68489694e+00
 1.24500494e+01 5.47853091e+01 3.30258107e-01 1.14375264e+00]
grad_E = [ 7.84277600e-04  1.55834170e-10 -8.18244663e-09  1.70463637e-07
 -2.10347342e-06  1.38347574e-05 -1.20205886e-05 -2.35461330e-05
 -4.10126739e-04 -1.90701456e-03  3.41342408e-04  1.43432217e-04
 -1.53700792e-05  5.64856145e-07  1.37388085e-03 -5.73367490e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.505963467247       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446942        1
[INPUT] 0    0    [1    /1   ]  833.271067981        1
[INPUT] 0    0    [1    /1   ]  235.734617062        1
[INPUT] 0    0    [1    /1   ]  76.4342521074        1
[INPUT] 0    0    [1    /1   ]  10.0670814551        1
[INPUT] 0    0    [1    /1   ]  27.0402027415        1
[INPUT] 0    0    [1    /1   ]  0.228377250008       1
[INPUT] 0    0    [1    /1   ]  1.18016878854        1
[INPUT] 0    0    [1    /1   ]  2.85449195364        1
[INPUT] 1    0    [1    /1   ]  3.68477698769        1
[INPUT] 1    0    [1    /1   ]  12.4500711188        1
[INPUT] 1    0    [1    /1   ]  54.7853074339        1
[INPUT] 1    0    [1    /1   ]  0.330311778981       1
[INPUT] 1    0    [1    /1   ]  1.14360989027        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5059634672472474, 1.0]], [0, [24413.79413000158, 1.0]], [0, [3661.454469415126, 1.0]], [0, [833.2710679808355, 1.0]], [0, [235.73461706228028, 1.0]], [0, [76.434252107389, 1.0]], [0, [10.067081455143843, 1.0]], [0, [27.040202741461464, 1.0]], [0, [0.2283772500082306, 1.0]], [0, [1.1801687885448329, 1.0]], [0, [2.8544919536397435, 1.0]], [1, [3.684776987693879, 1.0]], [1, [12.450071118752957, 1.0]], [1, [54.78530743388269, 1.0]], [1, [0.330311778981032, 1.0]], [1, [1.1436098902672331, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50596347]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446942]
bas 3, expnt(s) = [833.27106798]
bas 4, expnt(s) = [235.73461706]
bas 5, expnt(s) = [76.43425211]
bas 6, expnt(s) = [10.06708146]
bas 7, expnt(s) = [27.04020274]
bas 8, expnt(s) = [0.22837725]
bas 9, expnt(s) = [1.18016879]
bas 10, expnt(s) = [2.85449195]
bas 11, expnt(s) = [3.68477699]
bas 12, expnt(s) = [12.45007112]
bas 13, expnt(s) = [54.78530743]
bas 14, expnt(s) = [0.33031178]
bas 15, expnt(s) = [1.14360989]
CPU time:        23.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.05963467e-01 1.51566909e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271068e+02 3.91836376e+02
 2.35734617e+02 1.51996135e+02 7.64342521e+01 6.53102039e+01
 1.00670815e+01 1.42788329e+01 2.70402027e+01 2.99586667e+01
 2.28377250e-01 8.34650492e-01 1.18016879e+00 2.86070528e+00
 2.85449195e+00 5.54832179e+00 3.68477699e+00 1.48935560e+01
 1.24500711e+01 6.82258858e+01 5.47853074e+01 4.34825016e+02
 3.30311779e-01 7.30532377e-01 1.14360989e+00 3.45010070e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998478161512207
cond(S) = 702.9946684787841
E1 = -183.57759524180062  E_coul = 55.078573199794604
init E= -128.499022042006
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773946174917462  LUMO = 0.48846518110017
  mo_energy =
[-3.25552670e+01 -1.85287678e+00 -7.73946175e-01 -7.73946175e-01
 -7.73946175e-01  4.88465181e-01  1.11559807e+00  1.11559807e+00
  1.11559807e+00  2.54146922e+00  5.77646639e+00  5.77646639e+00
  5.77646639e+00  9.06214547e+00  2.42124468e+01  2.42124468e+01
  2.42124468e+01  3.64313828e+01  1.19114378e+02  1.19114378e+02
  1.19114378e+02  1.40396302e+02  5.04334561e+02  1.87183534e+03
  8.00136687e+03  4.77688477e+04]
E1 = -182.1111220452108  E_coul = 53.582386964439515
cycle= 1 E= -128.528735080771  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462795
diis-c [-0.21417888  1.        ]
  HOMO = -0.87959844816518  LUMO = 0.473339588341157
  mo_energy =
[-3.28738162e+01 -1.96308666e+00 -8.79598448e-01 -8.79598448e-01
 -8.79598448e-01  4.73339588e-01  1.07739747e+00  1.07739747e+00
  1.07739747e+00  2.49072799e+00  5.64756435e+00  5.64756435e+00
  5.64756435e+00  8.93520756e+00  2.39775528e+01  2.39775528e+01
  2.39775528e+01  3.61906411e+01  1.18793541e+02  1.18793541e+02
  1.18793541e+02  1.40083414e+02  5.03977396e+02  1.87144210e+03
  8.00094458e+03  4.77684065e+04]
E1 = -182.8435733721031  E_coul = 54.312330757919575
cycle= 2 E= -128.531242614184  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231205
diis-c [-6.09284202e-04  3.32192429e-01  6.67807571e-01]
  HOMO = -0.845226373371638  LUMO = 0.478346553988836
  mo_energy =
[-3.27687710e+01 -1.92695238e+00 -8.45226373e-01 -8.45226373e-01
 -8.45226373e-01  4.78346554e-01  1.08989449e+00  1.08989449e+00
  1.08989449e+00  2.50711019e+00  5.68950193e+00  5.68950193e+00
  5.68950193e+00  8.97656550e+00  2.40551360e+01  2.40551360e+01
  2.40551360e+01  3.62703591e+01  1.18898613e+02  1.18898613e+02
  1.18898613e+02  1.40186366e+02  5.04091044e+02  1.87156094e+03
  8.00106585e+03  4.77685287e+04]
E1 = -182.5980738127506  E_coul = 54.06598342804719
cycle= 3 E= -128.532090384703  delta_E= -0.000848  |g|= 0.000452  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000923684
diis-c [-2.23356258e-07 -2.31176654e-03 -1.20355707e-03  1.00351532e+00]
  HOMO = -0.84545448038963  LUMO = 0.478329419047186
  mo_energy =
[-3.27691664e+01 -1.92711148e+00 -8.45454480e-01 -8.45454480e-01
 -8.45454480e-01  4.78329419e-01  1.08984558e+00  1.08984558e+00
  1.08984558e+00  2.50703410e+00  5.68930628e+00  5.68930628e+00
  5.68930628e+00  8.97637824e+00  2.40548254e+01  2.40548254e+01
  2.40548254e+01  3.62700514e+01  1.18898206e+02  1.18898206e+02
  1.18898206e+02  1.40185971e+02  5.04090545e+02  1.87156033e+03
  8.00106515e+03  4.77685280e+04]
E1 = -182.59853652094154  E_coul = 54.066446114193674
cycle= 4 E= -128.532090406748  delta_E= -2.2e-08  |g|= 6.29e-05  |ddm|= 0.000274
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132191
diis-c [-1.03723982e-09  3.40842501e-04  4.29966391e-04 -2.22289739e-01
  1.22151893e+00]
  HOMO = -0.845485661005599  LUMO = 0.478326033274228
  mo_energy =
[-3.27692149e+01 -1.92712877e+00 -8.45485661e-01 -8.45485661e-01
 -8.45485661e-01  4.78326033e-01  1.08983214e+00  1.08983214e+00
  1.08983214e+00  2.50702079e+00  5.68927218e+00  5.68927218e+00
  5.68927218e+00  8.97634827e+00  2.40547810e+01  2.40547810e+01
  2.40547810e+01  3.62700083e+01  1.18898156e+02  1.18898156e+02
  1.18898156e+02  1.40185922e+02  5.04090488e+02  1.87156027e+03
  8.00106508e+03  4.77685279e+04]
E1 = -182.59862847313903  E_coul = 54.06653806577708
cycle= 5 E= -128.532090407362  delta_E= -6.14e-10  |g|= 6.9e-06  |ddm|= 5.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59862847313903  E_coul = 54.06653806577708
  HOMO = -0.845481829787446  LUMO = 0.47832691332861
  mo_energy =
[-3.27692065e+01 -1.92712423e+00 -8.45481830e-01 -8.45481830e-01
 -8.45481830e-01  4.78326913e-01  1.08983375e+00  1.08983375e+00
  1.08983375e+00  2.50702322e+00  5.68927684e+00  5.68927684e+00
  5.68927684e+00  8.97635315e+00  2.40547882e+01  2.40547882e+01
  2.40547882e+01  3.62700156e+01  1.18898165e+02  1.18898165e+02
  1.18898165e+02  1.40185930e+02  5.04090496e+02  1.87156027e+03
  8.00106509e+03  4.77685279e+04]
E1 = -182.59860984226572  E_coul = 54.06651943490075
Extra cycle  E= -128.532090407365  delta_E= -3.01e-12  |g|= 2.6e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [5.05963467e-01 2.44137941e+04 3.66145447e+03 8.33271068e+02
 2.35734617e+02 7.64342521e+01 1.00670815e+01 2.70402027e+01
 2.28377250e-01 1.18016879e+00 2.85449195e+00 3.68477699e+00
 1.24500711e+01 5.47853074e+01 3.30311779e-01 1.14360989e+00]
E = -128.53209040736496
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.505963467247       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446942        1
[INPUT] 0    0    [1    /1   ]  833.271067981        1
[INPUT] 0    0    [1    /1   ]  235.734617062        1
[INPUT] 0    0    [1    /1   ]  76.4342521074        1
[INPUT] 0    0    [1    /1   ]  10.0670814551        1
[INPUT] 0    0    [1    /1   ]  27.0402027415        1
[INPUT] 0    0    [1    /1   ]  0.228377250008       1
[INPUT] 0    0    [1    /1   ]  1.18016878854        1
[INPUT] 0    0    [1    /1   ]  2.85449195364        1
[INPUT] 1    0    [1    /1   ]  3.68477698769        1
[INPUT] 1    0    [1    /1   ]  12.4500711188        1
[INPUT] 1    0    [1    /1   ]  54.7853074339        1
[INPUT] 1    0    [1    /1   ]  0.330311778981       1
[INPUT] 1    0    [1    /1   ]  1.14360989027        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5059634672472474, 1.0]], [0, [24413.79413000158, 1.0]], [0, [3661.454469415126, 1.0]], [0, [833.2710679808355, 1.0]], [0, [235.73461706228028, 1.0]], [0, [76.434252107389, 1.0]], [0, [10.067081455143843, 1.0]], [0, [27.040202741461464, 1.0]], [0, [0.2283772500082306, 1.0]], [0, [1.1801687885448329, 1.0]], [0, [2.8544919536397435, 1.0]], [1, [3.684776987693879, 1.0]], [1, [12.450071118752957, 1.0]], [1, [54.78530743388269, 1.0]], [1, [0.330311778981032, 1.0]], [1, [1.1436098902672331, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50596347]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446942]
bas 3, expnt(s) = [833.27106798]
bas 4, expnt(s) = [235.73461706]
bas 5, expnt(s) = [76.43425211]
bas 6, expnt(s) = [10.06708146]
bas 7, expnt(s) = [27.04020274]
bas 8, expnt(s) = [0.22837725]
bas 9, expnt(s) = [1.18016879]
bas 10, expnt(s) = [2.85449195]
bas 11, expnt(s) = [3.68477699]
bas 12, expnt(s) = [12.45007112]
bas 13, expnt(s) = [54.78530743]
bas 14, expnt(s) = [0.33031178]
bas 15, expnt(s) = [1.14360989]
CPU time:        23.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.05963467e-01 1.51566909e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271068e+02 3.91836376e+02
 2.35734617e+02 1.51996135e+02 7.64342521e+01 6.53102039e+01
 1.00670815e+01 1.42788329e+01 2.70402027e+01 2.99586667e+01
 2.28377250e-01 8.34650492e-01 1.18016879e+00 2.86070528e+00
 2.85449195e+00 5.54832179e+00 3.68477699e+00 1.48935560e+01
 1.24500711e+01 6.82258858e+01 5.47853074e+01 4.34825016e+02
 3.30311779e-01 7.30532377e-01 1.14360989e+00 3.45010070e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998478161512207
cond(S) = 702.9946684787841
E1 = -183.57759524180062  E_coul = 55.078573199794604
init E= -128.499022042006
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773946174917462  LUMO = 0.48846518110017
  mo_energy =
[-3.25552670e+01 -1.85287678e+00 -7.73946175e-01 -7.73946175e-01
 -7.73946175e-01  4.88465181e-01  1.11559807e+00  1.11559807e+00
  1.11559807e+00  2.54146922e+00  5.77646639e+00  5.77646639e+00
  5.77646639e+00  9.06214547e+00  2.42124468e+01  2.42124468e+01
  2.42124468e+01  3.64313828e+01  1.19114378e+02  1.19114378e+02
  1.19114378e+02  1.40396302e+02  5.04334561e+02  1.87183534e+03
  8.00136687e+03  4.77688477e+04]
E1 = -182.1111220452108  E_coul = 53.582386964439515
cycle= 1 E= -128.528735080771  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462795
diis-c [-0.21417888  1.        ]
  HOMO = -0.87959844816518  LUMO = 0.473339588341157
  mo_energy =
[-3.28738162e+01 -1.96308666e+00 -8.79598448e-01 -8.79598448e-01
 -8.79598448e-01  4.73339588e-01  1.07739747e+00  1.07739747e+00
  1.07739747e+00  2.49072799e+00  5.64756435e+00  5.64756435e+00
  5.64756435e+00  8.93520756e+00  2.39775528e+01  2.39775528e+01
  2.39775528e+01  3.61906411e+01  1.18793541e+02  1.18793541e+02
  1.18793541e+02  1.40083414e+02  5.03977396e+02  1.87144210e+03
  8.00094458e+03  4.77684065e+04]
E1 = -182.8435733721031  E_coul = 54.312330757919575
cycle= 2 E= -128.531242614184  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231205
diis-c [-6.09284202e-04  3.32192429e-01  6.67807571e-01]
  HOMO = -0.845226373371638  LUMO = 0.478346553988836
  mo_energy =
[-3.27687710e+01 -1.92695238e+00 -8.45226373e-01 -8.45226373e-01
 -8.45226373e-01  4.78346554e-01  1.08989449e+00  1.08989449e+00
  1.08989449e+00  2.50711019e+00  5.68950193e+00  5.68950193e+00
  5.68950193e+00  8.97656550e+00  2.40551360e+01  2.40551360e+01
  2.40551360e+01  3.62703591e+01  1.18898613e+02  1.18898613e+02
  1.18898613e+02  1.40186366e+02  5.04091044e+02  1.87156094e+03
  8.00106585e+03  4.77685287e+04]
E1 = -182.5980738127506  E_coul = 54.06598342804719
cycle= 3 E= -128.532090384703  delta_E= -0.000848  |g|= 0.000452  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000923684
diis-c [-2.23356258e-07 -2.31176654e-03 -1.20355707e-03  1.00351532e+00]
  HOMO = -0.84545448038963  LUMO = 0.478329419047186
  mo_energy =
[-3.27691664e+01 -1.92711148e+00 -8.45454480e-01 -8.45454480e-01
 -8.45454480e-01  4.78329419e-01  1.08984558e+00  1.08984558e+00
  1.08984558e+00  2.50703410e+00  5.68930628e+00  5.68930628e+00
  5.68930628e+00  8.97637824e+00  2.40548254e+01  2.40548254e+01
  2.40548254e+01  3.62700514e+01  1.18898206e+02  1.18898206e+02
  1.18898206e+02  1.40185971e+02  5.04090545e+02  1.87156033e+03
  8.00106515e+03  4.77685280e+04]
E1 = -182.59853652094154  E_coul = 54.066446114193674
cycle= 4 E= -128.532090406748  delta_E= -2.2e-08  |g|= 6.29e-05  |ddm|= 0.000274
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132191
diis-c [-1.03723982e-09  3.40842501e-04  4.29966391e-04 -2.22289739e-01
  1.22151893e+00]
  HOMO = -0.845485661005599  LUMO = 0.478326033274228
  mo_energy =
[-3.27692149e+01 -1.92712877e+00 -8.45485661e-01 -8.45485661e-01
 -8.45485661e-01  4.78326033e-01  1.08983214e+00  1.08983214e+00
  1.08983214e+00  2.50702079e+00  5.68927218e+00  5.68927218e+00
  5.68927218e+00  8.97634827e+00  2.40547810e+01  2.40547810e+01
  2.40547810e+01  3.62700083e+01  1.18898156e+02  1.18898156e+02
  1.18898156e+02  1.40185922e+02  5.04090488e+02  1.87156027e+03
  8.00106508e+03  4.77685279e+04]
E1 = -182.59862847313903  E_coul = 54.06653806577708
cycle= 5 E= -128.532090407362  delta_E= -6.14e-10  |g|= 6.9e-06  |ddm|= 5.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59862847313903  E_coul = 54.06653806577708
  HOMO = -0.845481829787446  LUMO = 0.47832691332861
  mo_energy =
[-3.27692065e+01 -1.92712423e+00 -8.45481830e-01 -8.45481830e-01
 -8.45481830e-01  4.78326913e-01  1.08983375e+00  1.08983375e+00
  1.08983375e+00  2.50702322e+00  5.68927684e+00  5.68927684e+00
  5.68927684e+00  8.97635315e+00  2.40547882e+01  2.40547882e+01
  2.40547882e+01  3.62700156e+01  1.18898165e+02  1.18898165e+02
  1.18898165e+02  1.40185930e+02  5.04090496e+02  1.87156027e+03
  8.00106509e+03  4.77685279e+04]
E1 = -182.59860984226572  E_coul = 54.06651943490075
Extra cycle  E= -128.532090407365  delta_E= -3.01e-12  |g|= 2.6e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 702.9946684787841
E1 = -182.59860984226572  E_coul = 54.06651943490075
init E= -128.532090407365
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845483132486445  LUMO = 0.478326766919544
  mo_energy =
[-3.27692106e+01 -1.92712549e+00 -8.45483132e-01 -8.45483132e-01
 -8.45483132e-01  4.78326767e-01  1.08983329e+00  1.08983329e+00
  1.08983329e+00  2.50702268e+00  5.68927525e+00  5.68927525e+00
  5.68927525e+00  8.97635163e+00  2.40547852e+01  2.40547852e+01
  2.40547852e+01  3.62700125e+01  1.18898161e+02  1.18898161e+02
  1.18898161e+02  1.40185926e+02  5.04090492e+02  1.87156027e+03
  8.00106508e+03  4.77685279e+04]
E1 = -182.5986198519443  E_coul = 54.066529444578954
cycle= 1 E= -128.532090407365  delta_E= -3.98e-13  |g|= 1.37e-06  |ddm|= 9.88e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5986198519443  E_coul = 54.066529444578954
  HOMO = -0.845482428530237  LUMO = 0.47832687664185
  mo_energy =
[-3.27692085e+01 -1.92712472e+00 -8.45482429e-01 -8.45482429e-01
 -8.45482429e-01  4.78326877e-01  1.08983355e+00  1.08983355e+00
  1.08983355e+00  2.50702303e+00  5.68927611e+00  5.68927611e+00
  5.68927611e+00  8.97635249e+00  2.40547867e+01  2.40547867e+01
  2.40547867e+01  3.62700142e+01  1.18898163e+02  1.18898163e+02
  1.18898163e+02  1.40185928e+02  5.04090494e+02  1.87156027e+03
  8.00106509e+03  4.77685279e+04]
E1 = -182.59861487709756  E_coul = 54.06652446973203
Extra cycle  E= -128.532090407366  delta_E= -1.71e-13  |g|= 6.77e-07  |ddm|= 4.76e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [5.05963467e-01 2.44137941e+04 3.66145447e+03 8.33271068e+02
 2.35734617e+02 7.64342521e+01 1.00670815e+01 2.70402027e+01
 2.28377250e-01 1.18016879e+00 2.85449195e+00 3.68477699e+00
 1.24500711e+01 5.47853074e+01 3.30311779e-01 1.14360989e+00]
grad_E = [ 1.63859341e-03  2.15579044e-10 -1.13139581e-08  2.33345845e-07
 -2.84303846e-06  1.94375764e-05  3.03519631e-05 -4.78411546e-05
 -1.19856910e-03 -2.06100759e-03  2.98084397e-04  2.00859108e-04
 -1.99885541e-05  6.93544683e-07  2.07447761e-03 -8.58237637e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.501680708608       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446938        1
[INPUT] 0    0    [1    /1   ]  833.271068513        1
[INPUT] 0    0    [1    /1   ]  235.734612425        1
[INPUT] 0    0    [1    /1   ]  76.4343362762        1
[INPUT] 0    0    [1    /1   ]  10.0711217186        1
[INPUT] 0    0    [1    /1   ]  27.0389636698        1
[INPUT] 0    0    [1    /1   ]  0.211057925554       1
[INPUT] 0    0    [1    /1   ]  1.19849478784        1
[INPUT] 0    0    [1    /1   ]  2.84904339137        1
[INPUT] 1    0    [1    /1   ]  3.6845969342         1
[INPUT] 1    0    [1    /1   ]  12.4500995557        1
[INPUT] 1    0    [1    /1   ]  54.7853057412        1
[INPUT] 1    0    [1    /1   ]  0.330354107885       1
[INPUT] 1    0    [1    /1   ]  1.14350764918        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5016807086082539, 1.0]], [0, [24413.794130002207, 1.0]], [0, [3661.4544693822368, 1.0]], [0, [833.2710685132291, 1.0]], [0, [235.73461242523882, 1.0]], [0, [76.43433627623408, 1.0]], [0, [10.071121718583148, 1.0]], [0, [27.03896366975087, 1.0]], [0, [0.21105792555362407, 1.0]], [0, [1.1984947878410808, 1.0]], [0, [2.849043391368747, 1.0]], [1, [3.68459693420298, 1.0]], [1, [12.450099555683993, 1.0]], [1, [54.78530574120774, 1.0]], [1, [0.33035410788480096, 1.0]], [1, [1.1435076491807283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50168071]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446938]
bas 3, expnt(s) = [833.27106851]
bas 4, expnt(s) = [235.73461243]
bas 5, expnt(s) = [76.43433628]
bas 6, expnt(s) = [10.07112172]
bas 7, expnt(s) = [27.03896367]
bas 8, expnt(s) = [0.21105793]
bas 9, expnt(s) = [1.19849479]
bas 10, expnt(s) = [2.84904339]
bas 11, expnt(s) = [3.68459693]
bas 12, expnt(s) = [12.45009956]
bas 13, expnt(s) = [54.78530574]
bas 14, expnt(s) = [0.33035411]
bas 15, expnt(s) = [1.14350765]
CPU time:        26.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.01680709e-01 1.50603677e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271069e+02 3.91836376e+02
 2.35734612e+02 1.51996133e+02 7.64343363e+01 6.53102578e+01
 1.00711217e+01 1.42831306e+01 2.70389637e+01 2.99576371e+01
 2.11057926e-01 7.86712903e-01 1.19849479e+00 2.89395742e+00
 2.84904339e+00 5.54037705e+00 3.68459693e+00 1.48926463e+01
 1.24500996e+01 6.82260806e+01 5.47853057e+01 4.34824999e+02
 3.30354108e-01 7.30649400e-01 1.14350765e+00 3.44971514e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998477224507837
cond(S) = 647.6752665771578
E1 = -183.57763002395228  E_coul = 55.07856123717466
init E= -128.499068786778
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945285094932  LUMO = 0.458306371654675
  mo_energy =
[-3.25552754e+01 -1.85288624e+00 -7.73945285e-01 -7.73945285e-01
 -7.73945285e-01  4.58306372e-01  1.11568866e+00  1.11568866e+00
  1.11568866e+00  2.47696983e+00  5.77622529e+00  5.77622529e+00
  5.77622529e+00  9.01331776e+00  2.42117285e+01  2.42117285e+01
  2.42117285e+01  3.64025133e+01  1.19113731e+02  1.19113731e+02
  1.19113731e+02  1.40377332e+02  5.04318837e+02  1.87182148e+03
  8.00135474e+03  4.77688376e+04]
E1 = -182.11153243047042  E_coul = 53.58277408713138
cycle= 1 E= -128.528758343339  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462328
diis-c [-0.21374745  1.        ]
  HOMO = -0.879562609675191  LUMO = 0.444068173173474
  mo_energy =
[-3.28737611e+01 -1.96306587e+00 -8.79562610e-01 -8.79562610e-01
 -8.79562610e-01  4.44068173e-01  1.07750315e+00  1.07750315e+00
  1.07750315e+00  2.42627480e+00  5.64737106e+00  5.64737106e+00
  5.64737106e+00  8.88608151e+00  2.39768857e+01  2.39768857e+01
  2.39768857e+01  3.61617665e+01  1.18792964e+02  1.18792964e+02
  1.18792964e+02  1.40064494e+02  5.03961734e+02  1.87142830e+03
  8.00093251e+03  4.77683966e+04]
E1 = -182.84376508206745  E_coul = 54.31250055242086
cycle= 2 E= -128.531264529647  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0689
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23099
diis-c [-6.09481896e-04  3.32207976e-01  6.67792024e-01]
  HOMO = -0.845201323000504  LUMO = 0.448790341372308
  mo_energy =
[-3.27687501e+01 -1.92694366e+00 -8.45201323e-01 -8.45201323e-01
 -8.45201323e-01  4.48790341e-01  1.08999631e+00  1.08999631e+00
  1.08999631e+00  2.44264108e+00  5.68929335e+00  5.68929335e+00
  5.68929335e+00  8.92753806e+00  2.40544434e+01  2.40544434e+01
  2.40544434e+01  3.62414829e+01  1.18898002e+02  1.18898002e+02
  1.18898002e+02  1.40167417e+02  5.04075346e+02  1.87154711e+03
  8.00105374e+03  4.77685187e+04]
E1 = -182.59835192051193  E_coul = 54.066240139818
cycle= 3 E= -128.532111780694  delta_E= -0.000847  |g|= 0.000449  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000917458
diis-c [-2.28952652e-07 -2.33003626e-03 -1.28515618e-03  1.00361519e+00]
  HOMO = -0.845428271345925  LUMO = 0.448774335576876
  mo_energy =
[-3.27691423e+01 -1.92710219e+00 -8.45428271e-01 -8.45428271e-01
 -8.45428271e-01  4.48774336e-01  1.08994784e+00  1.08994784e+00
  1.08994784e+00  2.44256576e+00  5.68909899e+00  5.68909899e+00
  5.68909899e+00  8.92735144e+00  2.40541351e+01  2.40541351e+01
  2.40541351e+01  3.62411774e+01  1.18897597e+02  1.18897597e+02
  1.18897597e+02  1.40167025e+02  5.04074851e+02  1.87154650e+03
  8.00105304e+03  4.77685180e+04]
E1 = -182.598807669497  E_coul = 54.066695867074024
cycle= 4 E= -128.532111802423  delta_E= -2.17e-08  |g|= 6.22e-05  |ddm|= 0.000246
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131323
diis-c [-1.02621657e-09  3.38112175e-04  4.29850905e-04 -2.20929872e-01
  1.22016191e+00]
  HOMO = -0.845459149280451  LUMO = 0.448771155963153
  mo_energy =
[-3.27691901e+01 -1.92711934e+00 -8.45459149e-01 -8.45459149e-01
 -8.45459149e-01  4.48771156e-01  1.08993452e+00  1.08993452e+00
  1.08993452e+00  2.44255261e+00  5.68906522e+00  5.68906522e+00
  5.68906522e+00  8.92732168e+00  2.40540913e+01  2.40540913e+01
  2.40540913e+01  3.62411348e+01  1.18897549e+02  1.18897549e+02
  1.18897549e+02  1.40166977e+02  5.04074795e+02  1.87154643e+03
  8.00105298e+03  4.77685179e+04]
E1 = -182.59889802028073  E_coul = 54.06678621725359
cycle= 5 E= -128.532111803027  delta_E= -6.04e-10  |g|= 6.82e-06  |ddm|= 4.61e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59889802028073  E_coul = 54.06678621725359
  HOMO = -0.845455378066249  LUMO = 0.448771980219041
  mo_energy =
[-3.27691818e+01 -1.92711485e+00 -8.45455378e-01 -8.45455378e-01
 -8.45455378e-01  4.48771980e-01  1.08993610e+00  1.08993610e+00
  1.08993610e+00  2.44255500e+00  5.68906981e+00  5.68906981e+00
  5.68906981e+00  8.92732650e+00  2.40540983e+01  2.40540983e+01
  2.40540983e+01  3.62411421e+01  1.18897557e+02  1.18897557e+02
  1.18897557e+02  1.40166985e+02  5.04074803e+02  1.87154644e+03
  8.00105298e+03  4.77685179e+04]
E1 = -182.5988796844251  E_coul = 54.0667678813951
Extra cycle  E= -128.53211180303  delta_E= -2.87e-12  |g|= 2.56e-06  |ddm|= 2.52e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [5.01680709e-01 2.44137941e+04 3.66145447e+03 8.33271069e+02
 2.35734612e+02 7.64343363e+01 1.00711217e+01 2.70389637e+01
 2.11057926e-01 1.19849479e+00 2.84904339e+00 3.68459693e+00
 1.24500996e+01 5.47853057e+01 3.30354108e-01 1.14350765e+00]
E = -128.53211180303
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.501680708608       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446938        1
[INPUT] 0    0    [1    /1   ]  833.271068513        1
[INPUT] 0    0    [1    /1   ]  235.734612425        1
[INPUT] 0    0    [1    /1   ]  76.4343362762        1
[INPUT] 0    0    [1    /1   ]  10.0711217186        1
[INPUT] 0    0    [1    /1   ]  27.0389636698        1
[INPUT] 0    0    [1    /1   ]  0.211057925554       1
[INPUT] 0    0    [1    /1   ]  1.19849478784        1
[INPUT] 0    0    [1    /1   ]  2.84904339137        1
[INPUT] 1    0    [1    /1   ]  3.6845969342         1
[INPUT] 1    0    [1    /1   ]  12.4500995557        1
[INPUT] 1    0    [1    /1   ]  54.7853057412        1
[INPUT] 1    0    [1    /1   ]  0.330354107885       1
[INPUT] 1    0    [1    /1   ]  1.14350764918        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5016807086082539, 1.0]], [0, [24413.794130002207, 1.0]], [0, [3661.4544693822368, 1.0]], [0, [833.2710685132291, 1.0]], [0, [235.73461242523882, 1.0]], [0, [76.43433627623408, 1.0]], [0, [10.071121718583148, 1.0]], [0, [27.03896366975087, 1.0]], [0, [0.21105792555362407, 1.0]], [0, [1.1984947878410808, 1.0]], [0, [2.849043391368747, 1.0]], [1, [3.68459693420298, 1.0]], [1, [12.450099555683993, 1.0]], [1, [54.78530574120774, 1.0]], [1, [0.33035410788480096, 1.0]], [1, [1.1435076491807283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50168071]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446938]
bas 3, expnt(s) = [833.27106851]
bas 4, expnt(s) = [235.73461243]
bas 5, expnt(s) = [76.43433628]
bas 6, expnt(s) = [10.07112172]
bas 7, expnt(s) = [27.03896367]
bas 8, expnt(s) = [0.21105793]
bas 9, expnt(s) = [1.19849479]
bas 10, expnt(s) = [2.84904339]
bas 11, expnt(s) = [3.68459693]
bas 12, expnt(s) = [12.45009956]
bas 13, expnt(s) = [54.78530574]
bas 14, expnt(s) = [0.33035411]
bas 15, expnt(s) = [1.14350765]
CPU time:        26.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.01680709e-01 1.50603677e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271069e+02 3.91836376e+02
 2.35734612e+02 1.51996133e+02 7.64343363e+01 6.53102578e+01
 1.00711217e+01 1.42831306e+01 2.70389637e+01 2.99576371e+01
 2.11057926e-01 7.86712903e-01 1.19849479e+00 2.89395742e+00
 2.84904339e+00 5.54037705e+00 3.68459693e+00 1.48926463e+01
 1.24500996e+01 6.82260806e+01 5.47853057e+01 4.34824999e+02
 3.30354108e-01 7.30649400e-01 1.14350765e+00 3.44971514e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998477224507837
cond(S) = 647.6752665771578
E1 = -183.57763002395228  E_coul = 55.07856123717466
init E= -128.499068786778
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945285094932  LUMO = 0.458306371654675
  mo_energy =
[-3.25552754e+01 -1.85288624e+00 -7.73945285e-01 -7.73945285e-01
 -7.73945285e-01  4.58306372e-01  1.11568866e+00  1.11568866e+00
  1.11568866e+00  2.47696983e+00  5.77622529e+00  5.77622529e+00
  5.77622529e+00  9.01331776e+00  2.42117285e+01  2.42117285e+01
  2.42117285e+01  3.64025133e+01  1.19113731e+02  1.19113731e+02
  1.19113731e+02  1.40377332e+02  5.04318837e+02  1.87182148e+03
  8.00135474e+03  4.77688376e+04]
E1 = -182.11153243047042  E_coul = 53.58277408713138
cycle= 1 E= -128.528758343339  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462328
diis-c [-0.21374745  1.        ]
  HOMO = -0.879562609675191  LUMO = 0.444068173173474
  mo_energy =
[-3.28737611e+01 -1.96306587e+00 -8.79562610e-01 -8.79562610e-01
 -8.79562610e-01  4.44068173e-01  1.07750315e+00  1.07750315e+00
  1.07750315e+00  2.42627480e+00  5.64737106e+00  5.64737106e+00
  5.64737106e+00  8.88608151e+00  2.39768857e+01  2.39768857e+01
  2.39768857e+01  3.61617665e+01  1.18792964e+02  1.18792964e+02
  1.18792964e+02  1.40064494e+02  5.03961734e+02  1.87142830e+03
  8.00093251e+03  4.77683966e+04]
E1 = -182.84376508206745  E_coul = 54.31250055242086
cycle= 2 E= -128.531264529647  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0689
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23099
diis-c [-6.09481896e-04  3.32207976e-01  6.67792024e-01]
  HOMO = -0.845201323000504  LUMO = 0.448790341372308
  mo_energy =
[-3.27687501e+01 -1.92694366e+00 -8.45201323e-01 -8.45201323e-01
 -8.45201323e-01  4.48790341e-01  1.08999631e+00  1.08999631e+00
  1.08999631e+00  2.44264108e+00  5.68929335e+00  5.68929335e+00
  5.68929335e+00  8.92753806e+00  2.40544434e+01  2.40544434e+01
  2.40544434e+01  3.62414829e+01  1.18898002e+02  1.18898002e+02
  1.18898002e+02  1.40167417e+02  5.04075346e+02  1.87154711e+03
  8.00105374e+03  4.77685187e+04]
E1 = -182.59835192051193  E_coul = 54.066240139818
cycle= 3 E= -128.532111780694  delta_E= -0.000847  |g|= 0.000449  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000917458
diis-c [-2.28952652e-07 -2.33003626e-03 -1.28515618e-03  1.00361519e+00]
  HOMO = -0.845428271345925  LUMO = 0.448774335576876
  mo_energy =
[-3.27691423e+01 -1.92710219e+00 -8.45428271e-01 -8.45428271e-01
 -8.45428271e-01  4.48774336e-01  1.08994784e+00  1.08994784e+00
  1.08994784e+00  2.44256576e+00  5.68909899e+00  5.68909899e+00
  5.68909899e+00  8.92735144e+00  2.40541351e+01  2.40541351e+01
  2.40541351e+01  3.62411774e+01  1.18897597e+02  1.18897597e+02
  1.18897597e+02  1.40167025e+02  5.04074851e+02  1.87154650e+03
  8.00105304e+03  4.77685180e+04]
E1 = -182.598807669497  E_coul = 54.066695867074024
cycle= 4 E= -128.532111802423  delta_E= -2.17e-08  |g|= 6.22e-05  |ddm|= 0.000246
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131323
diis-c [-1.02621657e-09  3.38112175e-04  4.29850905e-04 -2.20929872e-01
  1.22016191e+00]
  HOMO = -0.845459149280451  LUMO = 0.448771155963153
  mo_energy =
[-3.27691901e+01 -1.92711934e+00 -8.45459149e-01 -8.45459149e-01
 -8.45459149e-01  4.48771156e-01  1.08993452e+00  1.08993452e+00
  1.08993452e+00  2.44255261e+00  5.68906522e+00  5.68906522e+00
  5.68906522e+00  8.92732168e+00  2.40540913e+01  2.40540913e+01
  2.40540913e+01  3.62411348e+01  1.18897549e+02  1.18897549e+02
  1.18897549e+02  1.40166977e+02  5.04074795e+02  1.87154643e+03
  8.00105298e+03  4.77685179e+04]
E1 = -182.59889802028073  E_coul = 54.06678621725359
cycle= 5 E= -128.532111803027  delta_E= -6.04e-10  |g|= 6.82e-06  |ddm|= 4.61e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59889802028073  E_coul = 54.06678621725359
  HOMO = -0.845455378066249  LUMO = 0.448771980219041
  mo_energy =
[-3.27691818e+01 -1.92711485e+00 -8.45455378e-01 -8.45455378e-01
 -8.45455378e-01  4.48771980e-01  1.08993610e+00  1.08993610e+00
  1.08993610e+00  2.44255500e+00  5.68906981e+00  5.68906981e+00
  5.68906981e+00  8.92732650e+00  2.40540983e+01  2.40540983e+01
  2.40540983e+01  3.62411421e+01  1.18897557e+02  1.18897557e+02
  1.18897557e+02  1.40166985e+02  5.04074803e+02  1.87154644e+03
  8.00105298e+03  4.77685179e+04]
E1 = -182.5988796844251  E_coul = 54.0667678813951
Extra cycle  E= -128.53211180303  delta_E= -2.87e-12  |g|= 2.56e-06  |ddm|= 2.52e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 647.6752665771578
E1 = -182.5988796844251  E_coul = 54.0667678813951
init E= -128.53211180303
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845456661038659  LUMO = 0.448771845336512
  mo_energy =
[-3.27691859e+01 -1.92711608e+00 -8.45456661e-01 -8.45456661e-01
 -8.45456661e-01  4.48771845e-01  1.08993565e+00  1.08993565e+00
  1.08993565e+00  2.44255447e+00  5.68906825e+00  5.68906825e+00
  5.68906825e+00  8.92732501e+00  2.40540954e+01  2.40540954e+01
  2.40540954e+01  3.62411390e+01  1.18897553e+02  1.18897553e+02
  1.18897553e+02  1.40166981e+02  5.04074799e+02  1.87154644e+03
  8.00105298e+03  4.77685179e+04]
E1 = -182.5988895353551  E_coul = 54.06677773232453
cycle= 1 E= -128.532111803031  delta_E= -5.68e-13  |g|= 1.35e-06  |ddm|= 9.71e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5988895353551  E_coul = 54.06677773232453
  HOMO = -0.845455968448921  LUMO = 0.448771947410384
  mo_energy =
[-3.27691838e+01 -1.92711533e+00 -8.45455968e-01 -8.45455968e-01
 -8.45455968e-01  4.48771947e-01  1.08993590e+00  1.08993590e+00
  1.08993590e+00  2.44255482e+00  5.68906910e+00  5.68906910e+00
  5.68906910e+00  8.92732586e+00  2.40540969e+01  2.40540969e+01
  2.40540969e+01  3.62411406e+01  1.18897555e+02  1.18897555e+02
  1.18897555e+02  1.40166983e+02  5.04074801e+02  1.87154644e+03
  8.00105298e+03  4.77685179e+04]
E1 = -182.5988846395872  E_coul = 54.06677283655625
Extra cycle  E= -128.532111803031  delta_E= -3.69e-13  |g|= 6.66e-07  |ddm|= 4.7e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [5.01680709e-01 2.44137941e+04 3.66145447e+03 8.33271069e+02
 2.35734612e+02 7.64343363e+01 1.00711217e+01 2.70389637e+01
 2.11057926e-01 1.19849479e+00 2.84904339e+00 3.68459693e+00
 1.24500996e+01 5.47853057e+01 3.30354108e-01 1.14350765e+00]
grad_E = [ 1.74869916e-03  2.42298838e-10 -1.27100531e-08  2.61342659e-07
 -3.16438132e-06  2.17219847e-05  2.48066852e-05 -5.49999690e-05
 -1.32836890e-03 -1.74713356e-03  1.79366414e-04  2.33437735e-04
 -2.14784605e-05  6.99436865e-07  2.49268311e-03 -1.04104251e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.487133850353       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446939        1
[INPUT] 0    0    [1    /1   ]  833.271068095        1
[INPUT] 0    0    [1    /1   ]  235.73462086         1
[INPUT] 0    0    [1    /1   ]  76.4343736632        1
[INPUT] 0    0    [1    /1   ]  10.0782669737        1
[INPUT] 0    0    [1    /1   ]  27.0370029024        1
[INPUT] 0    0    [1    /1   ]  0.185017438946       1
[INPUT] 0    0    [1    /1   ]  1.24330042555        1
[INPUT] 0    0    [1    /1   ]  2.83748401862        1
[INPUT] 1    0    [1    /1   ]  3.68403167256        1
[INPUT] 1    0    [1    /1   ]  12.4501796413        1
[INPUT] 1    0    [1    /1   ]  54.7853015743        1
[INPUT] 1    0    [1    /1   ]  0.330243760174       1
[INPUT] 1    0    [1    /1   ]  1.14342704536        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.48713385035306145, 1.0]], [0, [24413.794130002065, 1.0]], [0, [3661.4544693897037, 1.0]], [0, [833.2710680953828, 1.0]], [0, [235.7346208599894, 1.0]], [0, [76.43437366315847, 1.0]], [0, [10.078266973702819, 1.0]], [0, [27.0370029023525, 1.0]], [0, [0.18501743894648173, 1.0]], [0, [1.2433004255472269, 1.0]], [0, [2.837484018622271, 1.0]], [1, [3.6840316725588913, 1.0]], [1, [12.450179641316035, 1.0]], [1, [54.785301574273944, 1.0]], [1, [0.33024376017444196, 1.0]], [1, [1.1434270453554676, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.48713385]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446939]
bas 3, expnt(s) = [833.2710681]
bas 4, expnt(s) = [235.73462086]
bas 5, expnt(s) = [76.43437366]
bas 6, expnt(s) = [10.07826697]
bas 7, expnt(s) = [27.0370029]
bas 8, expnt(s) = [0.18501744]
bas 9, expnt(s) = [1.24330043]
bas 10, expnt(s) = [2.83748402]
bas 11, expnt(s) = [3.68403167]
bas 12, expnt(s) = [12.45017964]
bas 13, expnt(s) = [54.78530157]
bas 14, expnt(s) = [0.33024376]
bas 15, expnt(s) = [1.14342705]
CPU time:        28.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.87133850e-01 1.47316454e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271068e+02 3.91836376e+02
 2.35734621e+02 1.51996137e+02 7.64343737e+01 6.53102818e+01
 1.00782670e+01 1.42907301e+01 2.70370029e+01 2.99560078e+01
 1.85017439e-01 7.12729153e-01 1.24330043e+00 2.97472680e+00
 2.83748402e+00 5.52350934e+00 3.68403167e+00 1.48897905e+01
 1.24501796e+01 6.82266292e+01 5.47853016e+01 4.34824958e+02
 3.30243760e-01 7.30344340e-01 1.14342705e+00 3.44941119e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998474571416235
cond(S) = 583.2933138921046
E1 = -183.577493991839  E_coul = 55.0783922857795
init E= -128.499101706059
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773953655818926  LUMO = 0.408427206454815
  mo_energy =
[-3.25553327e+01 -1.85289894e+00 -7.73953656e-01 -7.73953656e-01
 -7.73953656e-01  4.08427206e-01  1.11531870e+00  1.11531870e+00
  1.11531870e+00  2.36766539e+00  5.77521594e+00  5.77521594e+00
  5.77521594e+00  8.95109714e+00  2.42095501e+01  2.42095501e+01
  2.42095501e+01  3.63866532e+01  1.19111762e+02  1.19111762e+02
  1.19111762e+02  1.40376844e+02  5.04320678e+02  1.87182343e+03
  8.00135652e+03  4.77688391e+04]
E1 = -182.1112224468625  E_coul = 53.58243208484207
cycle= 1 E= -128.52879036202  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461525
diis-c [-0.21300508  1.        ]
  HOMO = -0.879583578592109  LUMO = 0.395693815482691
  mo_energy =
[-3.28738471e+01 -1.96310233e+00 -8.79583579e-01 -8.79583579e-01
 -8.79583579e-01  3.95693815e-01  1.07714437e+00  1.07714437e+00
  1.07714437e+00  2.31691987e+00  5.64636326e+00  5.64636326e+00
  5.64636326e+00  8.82305972e+00  2.39746618e+01  2.39746618e+01
  2.39746618e+01  3.61458197e+01  1.18790985e+02  1.18790985e+02
  1.18790985e+02  1.40063956e+02  5.03963527e+02  1.87143018e+03
  8.00093422e+03  4.77683980e+04]
E1 = -182.84318259277796  E_coul = 54.311887997633654
cycle= 2 E= -128.531294595144  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0689
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230633
diis-c [-6.09834469e-04  3.32246553e-01  6.67753447e-01]
  HOMO = -0.845237775590952  LUMO = 0.39993047052549
  mo_energy =
[-3.27688786e+01 -1.92699584e+00 -8.45237776e-01 -8.45237776e-01
 -8.45237776e-01  3.99930471e-01  1.08962953e+00  1.08962953e+00
  1.08962953e+00  2.33328593e+00  5.68826404e+00  5.68826404e+00
  5.68826404e+00  8.86475545e+00  2.40521864e+01  2.40521864e+01
  2.40521864e+01  3.62255433e+01  1.18895981e+02  1.18895981e+02
  1.18895981e+02  1.40166842e+02  5.04077095e+02  1.87154894e+03
  8.00105540e+03  4.77685201e+04]
E1 = -182.5978212209147  E_coul = 54.06567978403793
cycle= 3 E= -128.532141436877  delta_E= -0.000847  |g|= 0.000449  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000916144
diis-c [-2.37387616e-07 -2.37403638e-03 -1.39956325e-03  1.00377360e+00]
  HOMO = -0.845466764892247  LUMO = 0.399915907894934
  mo_energy =
[-3.27692704e+01 -1.92715723e+00 -8.45466765e-01 -8.45466765e-01
 -8.45466765e-01  3.99915908e-01  1.08958059e+00  1.08958059e+00
  1.08958059e+00  2.33320982e+00  5.68806734e+00  5.68806734e+00
  5.68806734e+00  8.86456475e+00  2.40518768e+01  2.40518768e+01
  2.40518768e+01  3.62252368e+01  1.18895578e+02  1.18895578e+02
  1.18895578e+02  1.40166450e+02  5.04076602e+02  1.87154833e+03
  8.00105471e+03  4.77685193e+04]
E1 = -182.59827513645192  E_coul = 54.06613367833156
cycle= 4 E= -128.53214145812  delta_E= -2.12e-08  |g|= 6.13e-05  |ddm|= 0.000203
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130405
diis-c [-1.01927101e-09  3.36387093e-04  4.26608822e-04 -2.19154029e-01
  1.21839103e+00]
  HOMO = -0.845497327734543  LUMO = 0.399913078978017
  mo_energy =
[-3.27693171e+01 -1.92717425e+00 -8.45497328e-01 -8.45497328e-01
 -8.45497328e-01  3.99913079e-01  1.08956743e+00  1.08956743e+00
  1.08956743e+00  2.33319691e+00  5.68803389e+00  5.68803389e+00
  5.68803389e+00  8.86453510e+00  2.40518337e+01  2.40518337e+01
  2.40518337e+01  3.62251949e+01  1.18895530e+02  1.18895530e+02
  1.18895530e+02  1.40166403e+02  5.04076548e+02  1.87154827e+03
  8.00105464e+03  4.77685193e+04]
E1 = -182.59836371004795  E_coul = 54.06622225134262
cycle= 5 E= -128.532141458705  delta_E= -5.85e-10  |g|= 6.75e-06  |ddm|= 3.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59836371004795  E_coul = 54.06622225134262
  HOMO = -0.845493599254465  LUMO = 0.399913817613643
  mo_energy =
[-3.27693090e+01 -1.92716980e+00 -8.45493599e-01 -8.45493599e-01
 -8.45493599e-01  3.99913818e-01  1.08956899e+00  1.08956899e+00
  1.08956899e+00  2.33319930e+00  5.68803843e+00  5.68803843e+00
  5.68803843e+00  8.86453990e+00  2.40518407e+01  2.40518407e+01
  2.40518407e+01  3.62252020e+01  1.18895538e+02  1.18895538e+02
  1.18895538e+02  1.40166411e+02  5.04076555e+02  1.87154828e+03
  8.00105465e+03  4.77685193e+04]
E1 = -182.5983457414745  E_coul = 54.06620428276638
Extra cycle  E= -128.532141458708  delta_E= -2.79e-12  |g|= 2.51e-06  |ddm|= 2.26e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [4.87133850e-01 2.44137941e+04 3.66145447e+03 8.33271068e+02
 2.35734621e+02 7.64343737e+01 1.00782670e+01 2.70370029e+01
 1.85017439e-01 1.24330043e+00 2.83748402e+00 3.68403167e+00
 1.24501796e+01 5.47853016e+01 3.30243760e-01 1.14342705e+00]
E = -128.5321414587081
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.487133850353       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446939        1
[INPUT] 0    0    [1    /1   ]  833.271068095        1
[INPUT] 0    0    [1    /1   ]  235.73462086         1
[INPUT] 0    0    [1    /1   ]  76.4343736632        1
[INPUT] 0    0    [1    /1   ]  10.0782669737        1
[INPUT] 0    0    [1    /1   ]  27.0370029024        1
[INPUT] 0    0    [1    /1   ]  0.185017438946       1
[INPUT] 0    0    [1    /1   ]  1.24330042555        1
[INPUT] 0    0    [1    /1   ]  2.83748401862        1
[INPUT] 1    0    [1    /1   ]  3.68403167256        1
[INPUT] 1    0    [1    /1   ]  12.4501796413        1
[INPUT] 1    0    [1    /1   ]  54.7853015743        1
[INPUT] 1    0    [1    /1   ]  0.330243760174       1
[INPUT] 1    0    [1    /1   ]  1.14342704536        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.48713385035306145, 1.0]], [0, [24413.794130002065, 1.0]], [0, [3661.4544693897037, 1.0]], [0, [833.2710680953828, 1.0]], [0, [235.7346208599894, 1.0]], [0, [76.43437366315847, 1.0]], [0, [10.078266973702819, 1.0]], [0, [27.0370029023525, 1.0]], [0, [0.18501743894648173, 1.0]], [0, [1.2433004255472269, 1.0]], [0, [2.837484018622271, 1.0]], [1, [3.6840316725588913, 1.0]], [1, [12.450179641316035, 1.0]], [1, [54.785301574273944, 1.0]], [1, [0.33024376017444196, 1.0]], [1, [1.1434270453554676, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.48713385]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446939]
bas 3, expnt(s) = [833.2710681]
bas 4, expnt(s) = [235.73462086]
bas 5, expnt(s) = [76.43437366]
bas 6, expnt(s) = [10.07826697]
bas 7, expnt(s) = [27.0370029]
bas 8, expnt(s) = [0.18501744]
bas 9, expnt(s) = [1.24330043]
bas 10, expnt(s) = [2.83748402]
bas 11, expnt(s) = [3.68403167]
bas 12, expnt(s) = [12.45017964]
bas 13, expnt(s) = [54.78530157]
bas 14, expnt(s) = [0.33024376]
bas 15, expnt(s) = [1.14342705]
CPU time:        28.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.87133850e-01 1.47316454e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271068e+02 3.91836376e+02
 2.35734621e+02 1.51996137e+02 7.64343737e+01 6.53102818e+01
 1.00782670e+01 1.42907301e+01 2.70370029e+01 2.99560078e+01
 1.85017439e-01 7.12729153e-01 1.24330043e+00 2.97472680e+00
 2.83748402e+00 5.52350934e+00 3.68403167e+00 1.48897905e+01
 1.24501796e+01 6.82266292e+01 5.47853016e+01 4.34824958e+02
 3.30243760e-01 7.30344340e-01 1.14342705e+00 3.44941119e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998474571416235
cond(S) = 583.2933138921046
E1 = -183.577493991839  E_coul = 55.0783922857795
init E= -128.499101706059
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773953655818926  LUMO = 0.408427206454815
  mo_energy =
[-3.25553327e+01 -1.85289894e+00 -7.73953656e-01 -7.73953656e-01
 -7.73953656e-01  4.08427206e-01  1.11531870e+00  1.11531870e+00
  1.11531870e+00  2.36766539e+00  5.77521594e+00  5.77521594e+00
  5.77521594e+00  8.95109714e+00  2.42095501e+01  2.42095501e+01
  2.42095501e+01  3.63866532e+01  1.19111762e+02  1.19111762e+02
  1.19111762e+02  1.40376844e+02  5.04320678e+02  1.87182343e+03
  8.00135652e+03  4.77688391e+04]
E1 = -182.1112224468625  E_coul = 53.58243208484207
cycle= 1 E= -128.52879036202  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461525
diis-c [-0.21300508  1.        ]
  HOMO = -0.879583578592109  LUMO = 0.395693815482691
  mo_energy =
[-3.28738471e+01 -1.96310233e+00 -8.79583579e-01 -8.79583579e-01
 -8.79583579e-01  3.95693815e-01  1.07714437e+00  1.07714437e+00
  1.07714437e+00  2.31691987e+00  5.64636326e+00  5.64636326e+00
  5.64636326e+00  8.82305972e+00  2.39746618e+01  2.39746618e+01
  2.39746618e+01  3.61458197e+01  1.18790985e+02  1.18790985e+02
  1.18790985e+02  1.40063956e+02  5.03963527e+02  1.87143018e+03
  8.00093422e+03  4.77683980e+04]
E1 = -182.84318259277796  E_coul = 54.311887997633654
cycle= 2 E= -128.531294595144  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0689
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230633
diis-c [-6.09834469e-04  3.32246553e-01  6.67753447e-01]
  HOMO = -0.845237775590952  LUMO = 0.39993047052549
  mo_energy =
[-3.27688786e+01 -1.92699584e+00 -8.45237776e-01 -8.45237776e-01
 -8.45237776e-01  3.99930471e-01  1.08962953e+00  1.08962953e+00
  1.08962953e+00  2.33328593e+00  5.68826404e+00  5.68826404e+00
  5.68826404e+00  8.86475545e+00  2.40521864e+01  2.40521864e+01
  2.40521864e+01  3.62255433e+01  1.18895981e+02  1.18895981e+02
  1.18895981e+02  1.40166842e+02  5.04077095e+02  1.87154894e+03
  8.00105540e+03  4.77685201e+04]
E1 = -182.5978212209147  E_coul = 54.06567978403793
cycle= 3 E= -128.532141436877  delta_E= -0.000847  |g|= 0.000449  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000916144
diis-c [-2.37387616e-07 -2.37403638e-03 -1.39956325e-03  1.00377360e+00]
  HOMO = -0.845466764892247  LUMO = 0.399915907894934
  mo_energy =
[-3.27692704e+01 -1.92715723e+00 -8.45466765e-01 -8.45466765e-01
 -8.45466765e-01  3.99915908e-01  1.08958059e+00  1.08958059e+00
  1.08958059e+00  2.33320982e+00  5.68806734e+00  5.68806734e+00
  5.68806734e+00  8.86456475e+00  2.40518768e+01  2.40518768e+01
  2.40518768e+01  3.62252368e+01  1.18895578e+02  1.18895578e+02
  1.18895578e+02  1.40166450e+02  5.04076602e+02  1.87154833e+03
  8.00105471e+03  4.77685193e+04]
E1 = -182.59827513645192  E_coul = 54.06613367833156
cycle= 4 E= -128.53214145812  delta_E= -2.12e-08  |g|= 6.13e-05  |ddm|= 0.000203
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130405
diis-c [-1.01927101e-09  3.36387093e-04  4.26608822e-04 -2.19154029e-01
  1.21839103e+00]
  HOMO = -0.845497327734543  LUMO = 0.399913078978017
  mo_energy =
[-3.27693171e+01 -1.92717425e+00 -8.45497328e-01 -8.45497328e-01
 -8.45497328e-01  3.99913079e-01  1.08956743e+00  1.08956743e+00
  1.08956743e+00  2.33319691e+00  5.68803389e+00  5.68803389e+00
  5.68803389e+00  8.86453510e+00  2.40518337e+01  2.40518337e+01
  2.40518337e+01  3.62251949e+01  1.18895530e+02  1.18895530e+02
  1.18895530e+02  1.40166403e+02  5.04076548e+02  1.87154827e+03
  8.00105464e+03  4.77685193e+04]
E1 = -182.59836371004795  E_coul = 54.06622225134262
cycle= 5 E= -128.532141458705  delta_E= -5.85e-10  |g|= 6.75e-06  |ddm|= 3.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59836371004795  E_coul = 54.06622225134262
  HOMO = -0.845493599254465  LUMO = 0.399913817613643
  mo_energy =
[-3.27693090e+01 -1.92716980e+00 -8.45493599e-01 -8.45493599e-01
 -8.45493599e-01  3.99913818e-01  1.08956899e+00  1.08956899e+00
  1.08956899e+00  2.33319930e+00  5.68803843e+00  5.68803843e+00
  5.68803843e+00  8.86453990e+00  2.40518407e+01  2.40518407e+01
  2.40518407e+01  3.62252020e+01  1.18895538e+02  1.18895538e+02
  1.18895538e+02  1.40166411e+02  5.04076555e+02  1.87154828e+03
  8.00105465e+03  4.77685193e+04]
E1 = -182.5983457414745  E_coul = 54.06620428276638
Extra cycle  E= -128.532141458708  delta_E= -2.79e-12  |g|= 2.51e-06  |ddm|= 2.26e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 583.2933138921046
E1 = -182.5983457414745  E_coul = 54.06620428276638
init E= -128.532141458708
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845494856769513  LUMO = 0.399913700254415
  mo_energy =
[-3.27693130e+01 -1.92717100e+00 -8.45494857e-01 -8.45494857e-01
 -8.45494857e-01  3.99913700e-01  1.08956855e+00  1.08956855e+00
  1.08956855e+00  2.33319878e+00  5.68803690e+00  5.68803690e+00
  5.68803690e+00  8.86453843e+00  2.40518377e+01  2.40518377e+01
  2.40518377e+01  3.62251990e+01  1.18895534e+02  1.18895534e+02
  1.18895534e+02  1.40166407e+02  5.04076551e+02  1.87154827e+03
  8.00105464e+03  4.77685193e+04]
E1 = -182.59835540187945  E_coul = 54.066213943171014
cycle= 1 E= -128.532141458708  delta_E= -3.13e-13  |g|= 1.32e-06  |ddm|= 9.52e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59835540187945  E_coul = 54.066213943171014
  HOMO = -0.845494177750458  LUMO = 0.399913790307993
  mo_energy =
[-3.27693110e+01 -1.92717027e+00 -8.45494178e-01 -8.45494178e-01
 -8.45494178e-01  3.99913790e-01  1.08956880e+00  1.08956880e+00
  1.08956880e+00  2.33319912e+00  5.68803773e+00  5.68803773e+00
  5.68803773e+00  8.86453927e+00  2.40518393e+01  2.40518393e+01
  2.40518393e+01  3.62252006e+01  1.18895536e+02  1.18895536e+02
  1.18895536e+02  1.40166409e+02  5.04076553e+02  1.87154828e+03
  8.00105465e+03  4.77685193e+04]
E1 = -182.5983505999485  E_coul = 54.06620914123948
Extra cycle  E= -128.532141458709  delta_E= -5.97e-13  |g|= 6.53e-07  |ddm|= 4.62e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [4.87133850e-01 2.44137941e+04 3.66145447e+03 8.33271068e+02
 2.35734621e+02 7.64343737e+01 1.00782670e+01 2.70370029e+01
 1.85017439e-01 1.24330043e+00 2.83748402e+00 3.68403167e+00
 1.24501796e+01 5.47853016e+01 3.30243760e-01 1.14342705e+00]
grad_E = [-5.21111079e-04  2.58140623e-10 -1.35148591e-08  2.77525418e-07
 -3.31697226e-06  2.22596056e-05 -6.83405082e-05 -4.50564990e-05
 -3.98248534e-04  5.65854167e-06 -2.25294190e-04  1.52219391e-04
 -8.43902470e-06  1.21197282e-07  1.57804004e-03 -7.05850022e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.490722725219       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446943        1
[INPUT] 0    0    [1    /1   ]  833.271067301        1
[INPUT] 0    0    [1    /1   ]  235.73462889         1
[INPUT] 0    0    [1    /1   ]  76.4342731704        1
[INPUT] 0    0    [1    /1   ]  10.0747527996        1
[INPUT] 0    0    [1    /1   ]  27.0381460659        1
[INPUT] 0    0    [1    /1   ]  0.200921143444       1
[INPUT] 0    0    [1    /1   ]  1.22876002085        1
[INPUT] 0    0    [1    /1   ]  2.84213449285        1
[INPUT] 1    0    [1    /1   ]  3.68413652809        1
[INPUT] 1    0    [1    /1   ]  12.4501574136        1
[INPUT] 1    0    [1    /1   ]  54.785303031         1
[INPUT] 1    0    [1    /1   ]  0.330100831233       1
[INPUT] 1    0    [1    /1   ]  1.1435926744         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.49072272521923377, 1.0]], [0, [24413.79413000121, 1.0]], [0, [3661.4544694344427, 1.0]], [0, [833.2710673007732, 1.0]], [0, [235.7346288900525, 1.0]], [0, [76.4342731703833, 1.0]], [0, [10.074752799608394, 1.0]], [0, [27.0381460659117, 1.0]], [0, [0.2009211434439174, 1.0]], [0, [1.2287600208460006, 1.0]], [0, [2.842134492846893, 1.0]], [1, [3.684136528086685, 1.0]], [1, [12.450157413559024, 1.0]], [1, [54.78530303095301, 1.0]], [1, [0.33010083123304956, 1.0]], [1, [1.1435926743952285, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49072273]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446943]
bas 3, expnt(s) = [833.2710673]
bas 4, expnt(s) = [235.73462889]
bas 5, expnt(s) = [76.43427317]
bas 6, expnt(s) = [10.0747528]
bas 7, expnt(s) = [27.03814607]
bas 8, expnt(s) = [0.20092114]
bas 9, expnt(s) = [1.22876002]
bas 10, expnt(s) = [2.84213449]
bas 11, expnt(s) = [3.68413653]
bas 12, expnt(s) = [12.45015741]
bas 13, expnt(s) = [54.78530303]
bas 14, expnt(s) = [0.33010083]
bas 15, expnt(s) = [1.14359267]
CPU time:        31.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.90722725e-01 1.48129703e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271067e+02 3.91836376e+02
 2.35734629e+02 1.51996141e+02 7.64342732e+01 6.53102174e+01
 1.00747528e+01 1.42869927e+01 2.70381461e+01 2.99569577e+01
 2.00921143e-01 7.58200829e-01 1.22876002e+00 2.94859638e+00
 2.84213449e+00 5.53029748e+00 3.68413653e+00 1.48903202e+01
 1.24501574e+01 6.82264769e+01 5.47853030e+01 4.34824972e+02
 3.30100831e-01 7.29949247e-01 1.14359267e+00 3.45003577e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998478999678417
cond(S) = 614.8417234022158
E1 = -183.57755490439808  E_coul = 55.078427825140395
init E= -128.499127079258
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773952287261762  LUMO = 0.437630673641444
  mo_energy =
[-3.25553214e+01 -1.85290078e+00 -7.73952287e-01 -7.73952287e-01
 -7.73952287e-01  4.37630674e-01  1.11495533e+00  1.11495533e+00
  1.11495533e+00  2.43145282e+00  5.77520872e+00  5.77520872e+00
  5.77520872e+00  9.00222218e+00  2.42099767e+01  2.42099767e+01
  2.42099767e+01  3.64201485e+01  1.19112164e+02  1.19112164e+02
  1.19112164e+02  1.40400714e+02  5.04340895e+02  1.87184131e+03
  8.00137219e+03  4.77688521e+04]
E1 = -182.11057459670107  E_coul = 53.58178243737611
cycle= 1 E= -128.528792159325  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462131
diis-c [-0.21356514  1.        ]
  HOMO = -0.8796395528171  LUMO = 0.424005763896161
  mo_energy =
[-3.28739427e+01 -1.96316665e+00 -8.79639553e-01 -8.79639553e-01
 -8.79639553e-01  4.24005764e-01  1.07675801e+00  1.07675801e+00
  1.07675801e+00  2.38062322e+00  5.64627611e+00  5.64627611e+00
  5.64627611e+00  8.87442012e+00  2.39750002e+01  2.39750002e+01
  2.39750002e+01  3.61792835e+01  1.18791275e+02  1.18791275e+02
  1.18791275e+02  1.40087735e+02  5.03983641e+02  1.87144795e+03
  8.00094978e+03  4.77684108e+04]
E1 = -182.84289640902  E_coul = 54.31159825961792
cycle= 2 E= -128.531298149402  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230947
diis-c [-6.09785550e-04  3.32260473e-01  6.67739527e-01]
  HOMO = -0.845277207155574  LUMO = 0.428525781030809
  mo_energy =
[-3.27689258e+01 -1.92704264e+00 -8.45277207e-01 -8.45277207e-01
 -8.45277207e-01  4.28525781e-01  1.08924780e+00  1.08924780e+00
  1.08924780e+00  2.39701309e+00  5.68819962e+00  5.68819962e+00
  5.68819962e+00  8.91603542e+00  2.40525616e+01  2.40525616e+01
  2.40525616e+01  3.62590203e+01  1.18896319e+02  1.18896319e+02
  1.18896319e+02  1.40190664e+02  5.04097259e+02  1.87156677e+03
  8.00107102e+03  4.77685330e+04]
E1 = -182.59737889788678  E_coul = 54.06523300177262
cycle= 3 E= -128.532145896114  delta_E= -0.000848  |g|= 0.000452  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000918696
diis-c [-2.28990316e-07 -2.35497546e-03 -1.32785475e-03  1.00368283e+00]
  HOMO = -0.845507618666722  LUMO = 0.428509742322438
  mo_energy =
[-3.27693206e+01 -1.92720576e+00 -8.45507619e-01 -8.45507619e-01
 -8.45507619e-01  4.28509742e-01  1.08919819e+00  1.08919819e+00
  1.08919819e+00  2.39693546e+00  5.68800120e+00  5.68800120e+00
  5.68800120e+00  8.91584337e+00  2.40522494e+01  2.40522494e+01
  2.40522494e+01  3.62587113e+01  1.18895912e+02  1.18895912e+02
  1.18895912e+02  1.40190270e+02  5.04096763e+02  1.87156616e+03
  8.00107033e+03  4.77685322e+04]
E1 = -182.59783753715357  E_coul = 54.065691619677786
cycle= 4 E= -128.532145917476  delta_E= -2.14e-08  |g|= 6.16e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130197
diis-c [-1.02302391e-09  3.36641245e-04  4.24783410e-04 -2.19251895e-01
  1.21849047e+00]
  HOMO = -0.845538446962532  LUMO = 0.428506652133945
  mo_energy =
[-3.27693679e+01 -1.92722313e+00 -8.45538447e-01 -8.45538447e-01
 -8.45538447e-01  4.28506652e-01  1.08918491e+00  1.08918491e+00
  1.08918491e+00  2.39692228e+00  5.68796743e+00  5.68796743e+00
  5.68796743e+00  8.91581343e+00  2.40522059e+01  2.40522059e+01
  2.40522059e+01  3.62586689e+01  1.18895864e+02  1.18895864e+02
  1.18895864e+02  1.40190222e+02  5.04096708e+02  1.87156610e+03
  8.00107026e+03  4.77685322e+04]
E1 = -182.59792705841699  E_coul = 54.06578114035639
cycle= 5 E= -128.532145918061  delta_E= -5.85e-10  |g|= 6.8e-06  |ddm|= 4.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59792705841699  E_coul = 54.06578114035639
  HOMO = -0.84553468484936  LUMO = 0.428507442793483
  mo_energy =
[-3.27693597e+01 -1.92721864e+00 -8.45534685e-01 -8.45534685e-01
 -8.45534685e-01  4.28507443e-01  1.08918649e+00  1.08918649e+00
  1.08918649e+00  2.39692469e+00  5.68797201e+00  5.68797201e+00
  5.68797201e+00  8.91581826e+00  2.40522129e+01  2.40522129e+01
  2.40522129e+01  3.62586761e+01  1.18895872e+02  1.18895872e+02
  1.18895872e+02  1.40190230e+02  5.04096716e+02  1.87156610e+03
  8.00107027e+03  4.77685322e+04]
E1 = -182.59790889643335  E_coul = 54.06576297837002
Extra cycle  E= -128.532145918063  delta_E= -2.76e-12  |g|= 2.54e-06  |ddm|= 2.3e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [4.90722725e-01 2.44137941e+04 3.66145447e+03 8.33271067e+02
 2.35734629e+02 7.64342732e+01 1.00747528e+01 2.70381461e+01
 2.00921143e-01 1.22876002e+00 2.84213449e+00 3.68413653e+00
 1.24501574e+01 5.47853030e+01 3.30100831e-01 1.14359267e+00]
E = -128.53214591806335
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.490722725219       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446943        1
[INPUT] 0    0    [1    /1   ]  833.271067301        1
[INPUT] 0    0    [1    /1   ]  235.73462889         1
[INPUT] 0    0    [1    /1   ]  76.4342731704        1
[INPUT] 0    0    [1    /1   ]  10.0747527996        1
[INPUT] 0    0    [1    /1   ]  27.0381460659        1
[INPUT] 0    0    [1    /1   ]  0.200921143444       1
[INPUT] 0    0    [1    /1   ]  1.22876002085        1
[INPUT] 0    0    [1    /1   ]  2.84213449285        1
[INPUT] 1    0    [1    /1   ]  3.68413652809        1
[INPUT] 1    0    [1    /1   ]  12.4501574136        1
[INPUT] 1    0    [1    /1   ]  54.785303031         1
[INPUT] 1    0    [1    /1   ]  0.330100831233       1
[INPUT] 1    0    [1    /1   ]  1.1435926744         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.49072272521923377, 1.0]], [0, [24413.79413000121, 1.0]], [0, [3661.4544694344427, 1.0]], [0, [833.2710673007732, 1.0]], [0, [235.7346288900525, 1.0]], [0, [76.4342731703833, 1.0]], [0, [10.074752799608394, 1.0]], [0, [27.0381460659117, 1.0]], [0, [0.2009211434439174, 1.0]], [0, [1.2287600208460006, 1.0]], [0, [2.842134492846893, 1.0]], [1, [3.684136528086685, 1.0]], [1, [12.450157413559024, 1.0]], [1, [54.78530303095301, 1.0]], [1, [0.33010083123304956, 1.0]], [1, [1.1435926743952285, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49072273]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446943]
bas 3, expnt(s) = [833.2710673]
bas 4, expnt(s) = [235.73462889]
bas 5, expnt(s) = [76.43427317]
bas 6, expnt(s) = [10.0747528]
bas 7, expnt(s) = [27.03814607]
bas 8, expnt(s) = [0.20092114]
bas 9, expnt(s) = [1.22876002]
bas 10, expnt(s) = [2.84213449]
bas 11, expnt(s) = [3.68413653]
bas 12, expnt(s) = [12.45015741]
bas 13, expnt(s) = [54.78530303]
bas 14, expnt(s) = [0.33010083]
bas 15, expnt(s) = [1.14359267]
CPU time:        31.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.90722725e-01 1.48129703e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271067e+02 3.91836376e+02
 2.35734629e+02 1.51996141e+02 7.64342732e+01 6.53102174e+01
 1.00747528e+01 1.42869927e+01 2.70381461e+01 2.99569577e+01
 2.00921143e-01 7.58200829e-01 1.22876002e+00 2.94859638e+00
 2.84213449e+00 5.53029748e+00 3.68413653e+00 1.48903202e+01
 1.24501574e+01 6.82264769e+01 5.47853030e+01 4.34824972e+02
 3.30100831e-01 7.29949247e-01 1.14359267e+00 3.45003577e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998478999678417
cond(S) = 614.8417234022158
E1 = -183.57755490439808  E_coul = 55.078427825140395
init E= -128.499127079258
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773952287261762  LUMO = 0.437630673641444
  mo_energy =
[-3.25553214e+01 -1.85290078e+00 -7.73952287e-01 -7.73952287e-01
 -7.73952287e-01  4.37630674e-01  1.11495533e+00  1.11495533e+00
  1.11495533e+00  2.43145282e+00  5.77520872e+00  5.77520872e+00
  5.77520872e+00  9.00222218e+00  2.42099767e+01  2.42099767e+01
  2.42099767e+01  3.64201485e+01  1.19112164e+02  1.19112164e+02
  1.19112164e+02  1.40400714e+02  5.04340895e+02  1.87184131e+03
  8.00137219e+03  4.77688521e+04]
E1 = -182.11057459670107  E_coul = 53.58178243737611
cycle= 1 E= -128.528792159325  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462131
diis-c [-0.21356514  1.        ]
  HOMO = -0.8796395528171  LUMO = 0.424005763896161
  mo_energy =
[-3.28739427e+01 -1.96316665e+00 -8.79639553e-01 -8.79639553e-01
 -8.79639553e-01  4.24005764e-01  1.07675801e+00  1.07675801e+00
  1.07675801e+00  2.38062322e+00  5.64627611e+00  5.64627611e+00
  5.64627611e+00  8.87442012e+00  2.39750002e+01  2.39750002e+01
  2.39750002e+01  3.61792835e+01  1.18791275e+02  1.18791275e+02
  1.18791275e+02  1.40087735e+02  5.03983641e+02  1.87144795e+03
  8.00094978e+03  4.77684108e+04]
E1 = -182.84289640902  E_coul = 54.31159825961792
cycle= 2 E= -128.531298149402  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230947
diis-c [-6.09785550e-04  3.32260473e-01  6.67739527e-01]
  HOMO = -0.845277207155574  LUMO = 0.428525781030809
  mo_energy =
[-3.27689258e+01 -1.92704264e+00 -8.45277207e-01 -8.45277207e-01
 -8.45277207e-01  4.28525781e-01  1.08924780e+00  1.08924780e+00
  1.08924780e+00  2.39701309e+00  5.68819962e+00  5.68819962e+00
  5.68819962e+00  8.91603542e+00  2.40525616e+01  2.40525616e+01
  2.40525616e+01  3.62590203e+01  1.18896319e+02  1.18896319e+02
  1.18896319e+02  1.40190664e+02  5.04097259e+02  1.87156677e+03
  8.00107102e+03  4.77685330e+04]
E1 = -182.59737889788678  E_coul = 54.06523300177262
cycle= 3 E= -128.532145896114  delta_E= -0.000848  |g|= 0.000452  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000918696
diis-c [-2.28990316e-07 -2.35497546e-03 -1.32785475e-03  1.00368283e+00]
  HOMO = -0.845507618666722  LUMO = 0.428509742322438
  mo_energy =
[-3.27693206e+01 -1.92720576e+00 -8.45507619e-01 -8.45507619e-01
 -8.45507619e-01  4.28509742e-01  1.08919819e+00  1.08919819e+00
  1.08919819e+00  2.39693546e+00  5.68800120e+00  5.68800120e+00
  5.68800120e+00  8.91584337e+00  2.40522494e+01  2.40522494e+01
  2.40522494e+01  3.62587113e+01  1.18895912e+02  1.18895912e+02
  1.18895912e+02  1.40190270e+02  5.04096763e+02  1.87156616e+03
  8.00107033e+03  4.77685322e+04]
E1 = -182.59783753715357  E_coul = 54.065691619677786
cycle= 4 E= -128.532145917476  delta_E= -2.14e-08  |g|= 6.16e-05  |ddm|= 0.00022
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130197
diis-c [-1.02302391e-09  3.36641245e-04  4.24783410e-04 -2.19251895e-01
  1.21849047e+00]
  HOMO = -0.845538446962532  LUMO = 0.428506652133945
  mo_energy =
[-3.27693679e+01 -1.92722313e+00 -8.45538447e-01 -8.45538447e-01
 -8.45538447e-01  4.28506652e-01  1.08918491e+00  1.08918491e+00
  1.08918491e+00  2.39692228e+00  5.68796743e+00  5.68796743e+00
  5.68796743e+00  8.91581343e+00  2.40522059e+01  2.40522059e+01
  2.40522059e+01  3.62586689e+01  1.18895864e+02  1.18895864e+02
  1.18895864e+02  1.40190222e+02  5.04096708e+02  1.87156610e+03
  8.00107026e+03  4.77685322e+04]
E1 = -182.59792705841699  E_coul = 54.06578114035639
cycle= 5 E= -128.532145918061  delta_E= -5.85e-10  |g|= 6.8e-06  |ddm|= 4.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59792705841699  E_coul = 54.06578114035639
  HOMO = -0.84553468484936  LUMO = 0.428507442793483
  mo_energy =
[-3.27693597e+01 -1.92721864e+00 -8.45534685e-01 -8.45534685e-01
 -8.45534685e-01  4.28507443e-01  1.08918649e+00  1.08918649e+00
  1.08918649e+00  2.39692469e+00  5.68797201e+00  5.68797201e+00
  5.68797201e+00  8.91581826e+00  2.40522129e+01  2.40522129e+01
  2.40522129e+01  3.62586761e+01  1.18895872e+02  1.18895872e+02
  1.18895872e+02  1.40190230e+02  5.04096716e+02  1.87156610e+03
  8.00107027e+03  4.77685322e+04]
E1 = -182.59790889643335  E_coul = 54.06576297837002
Extra cycle  E= -128.532145918063  delta_E= -2.76e-12  |g|= 2.54e-06  |ddm|= 2.3e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 614.8417234022158
E1 = -182.59790889643335  E_coul = 54.06576297837002
init E= -128.532145918063
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845535955657778  LUMO = 0.428507315619779
  mo_energy =
[-3.27693637e+01 -1.92721986e+00 -8.45535956e-01 -8.45535956e-01
 -8.45535956e-01  4.28507316e-01  1.08918604e+00  1.08918604e+00
  1.08918604e+00  2.39692416e+00  5.68797047e+00  5.68797047e+00
  5.68797047e+00  8.91581678e+00  2.40522100e+01  2.40522100e+01
  2.40522100e+01  3.62586731e+01  1.18895868e+02  1.18895868e+02
  1.18895868e+02  1.40190226e+02  5.04096711e+02  1.87156610e+03
  8.00107026e+03  4.77685322e+04]
E1 = -182.5979186604067  E_coul = 54.065772742342595
cycle= 1 E= -128.532145918064  delta_E= -7.39e-13  |g|= 1.34e-06  |ddm|= 9.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5979186604067  E_coul = 54.065772742342595
  HOMO = -0.84553526927318  LUMO = 0.428507412578257
  mo_energy =
[-3.27693617e+01 -1.92721911e+00 -8.45535269e-01 -8.45535269e-01
 -8.45535269e-01  4.28507413e-01  1.08918630e+00  1.08918630e+00
  1.08918630e+00  2.39692451e+00  5.68797131e+00  5.68797131e+00
  5.68797131e+00  8.91581763e+00  2.40522115e+01  2.40522115e+01
  2.40522115e+01  3.62586747e+01  1.18895870e+02  1.18895870e+02
  1.18895870e+02  1.40190228e+02  5.04096714e+02  1.87156610e+03
  8.00107026e+03  4.77685322e+04]
E1 = -182.5979138061014  E_coul = 54.06576788803733
Extra cycle  E= -128.532145918064  delta_E= 2.84e-14  |g|= 6.61e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [4.90722725e-01 2.44137941e+04 3.66145447e+03 8.33271067e+02
 2.35734629e+02 7.64342732e+01 1.00747528e+01 2.70381461e+01
 2.00921143e-01 1.22876002e+00 2.84213449e+00 3.68413653e+00
 1.24501574e+01 5.47853030e+01 3.30100831e-01 1.14359267e+00]
grad_E = [-2.40525956e-04  2.34552595e-10 -1.22860571e-08  2.52794767e-07
 -3.03548295e-06  2.02520317e-05 -6.31880931e-05 -3.90904806e-05
 -2.11590865e-04 -3.44378613e-04 -1.30290966e-04  3.95857760e-05
  1.45076242e-06 -1.80628440e-07  3.44672259e-04 -1.50393250e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.490462594364       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446945        1
[INPUT] 0    0    [1    /1   ]  833.271066887        1
[INPUT] 0    0    [1    /1   ]  235.734633856        1
[INPUT] 0    0    [1    /1   ]  76.4342390119        1
[INPUT] 0    0    [1    /1   ]  10.0747434487        1
[INPUT] 0    0    [1    /1   ]  27.038233285         1
[INPUT] 0    0    [1    /1   ]  0.201896915515       1
[INPUT] 0    0    [1    /1   ]  1.2300847835         1
[INPUT] 0    0    [1    /1   ]  2.84215872386        1
[INPUT] 1    0    [1    /1   ]  3.68409832444        1
[INPUT] 1    0    [1    /1   ]  12.4501562629        1
[INPUT] 1    0    [1    /1   ]  54.7853031978        1
[INPUT] 1    0    [1    /1   ]  0.330058999853       1
[INPUT] 1    0    [1    /1   ]  1.1436239899         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.49046259436366324, 1.0]], [0, [24413.794130000824, 1.0]], [0, [3661.45446945462, 1.0]], [0, [833.2710668872771, 1.0]], [0, [235.73463385626164, 1.0]], [0, [76.43423901187016, 1.0]], [0, [10.074743448687853, 1.0]], [0, [27.038233284958924, 1.0]], [0, [0.20189691551494696, 1.0]], [0, [1.230084783502551, 1.0]], [0, [2.842158723858162, 1.0]], [1, [3.6840983244369236, 1.0]], [1, [12.450156262874435, 1.0]], [1, [54.78530319780062, 1.0]], [1, [0.3300589998530432, 1.0]], [1, [1.1436239899037226, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49046259]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446945]
bas 3, expnt(s) = [833.27106689]
bas 4, expnt(s) = [235.73463386]
bas 5, expnt(s) = [76.43423901]
bas 6, expnt(s) = [10.07474345]
bas 7, expnt(s) = [27.03823328]
bas 8, expnt(s) = [0.20189692]
bas 9, expnt(s) = [1.23008478]
bas 10, expnt(s) = [2.84215872]
bas 11, expnt(s) = [3.68409832]
bas 12, expnt(s) = [12.45015626]
bas 13, expnt(s) = [54.7853032]
bas 14, expnt(s) = [0.330059]
bas 15, expnt(s) = [1.14362399]
CPU time:        33.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.90462594e-01 1.48070807e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271067e+02 3.91836376e+02
 2.35734634e+02 1.51996144e+02 7.64342390e+01 6.53101955e+01
 1.00747434e+01 1.42869828e+01 2.70382333e+01 2.99570302e+01
 2.01896916e-01 7.60960804e-01 1.23008478e+00 2.95098029e+00
 2.84215872e+00 5.53033284e+00 3.68409832e+00 1.48901272e+01
 1.24501563e+01 6.82264690e+01 5.47853032e+01 4.34824974e+02
 3.30059000e-01 7.29833622e-01 1.14362399e+00 3.45015387e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99847931606681
cond(S) = 616.9284385920918
E1 = -183.57754055424115  E_coul = 55.078416285312116
init E= -128.499124268929
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773953130690952  LUMO = 0.439273169799825
  mo_energy =
[-3.25553247e+01 -1.85290094e+00 -7.73953131e-01 -7.73953131e-01
 -7.73953131e-01  4.39273170e-01  1.11484134e+00  1.11484134e+00
  1.11484134e+00  2.43568925e+00  5.77511308e+00  5.77511308e+00
  5.77511308e+00  9.00955907e+00  2.42098462e+01  2.42098462e+01
  2.42098462e+01  3.64289081e+01  1.19112037e+02  1.19112037e+02
  1.19112037e+02  1.40408849e+02  5.04348206e+02  1.87184784e+03
  8.00137792e+03  4.77688568e+04]
E1 = -182.1103885943257  E_coul = 53.58159634396527
cycle= 1 E= -128.52879225036  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462178
diis-c [-0.21360849  1.        ]
  HOMO = -0.879654863227368  LUMO = 0.425595047627496
  mo_energy =
[-3.28739736e+01 -1.96318322e+00 -8.79654863e-01 -8.79654863e-01
 -8.79654863e-01  4.25595048e-01  1.07663966e+00  1.07663966e+00
  1.07663966e+00  2.38481968e+00  5.64616239e+00  5.64616239e+00
  5.64616239e+00  8.88172225e+00  2.39748450e+01  2.39748450e+01
  2.39748450e+01  3.61880271e+01  1.18791121e+02  1.18791121e+02
  1.18791121e+02  1.40095844e+02  5.03990923e+02  1.87145445e+03
  8.00095549e+03  4.77684155e+04]
E1 = -182.84276613941992  E_coul = 54.31146767213773
cycle= 2 E= -128.531298467282  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0687
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230977
diis-c [-6.09825336e-04  3.32266514e-01  6.67733486e-01]
  HOMO = -0.845290237558267  LUMO = 0.430131298396939
  mo_energy =
[-3.27689496e+01 -1.92705670e+00 -8.45290238e-01 -8.45290238e-01
 -8.45290238e-01  4.30131298e-01  1.08912975e+00  1.08912975e+00
  1.08912975e+00  2.40122011e+00  5.68808899e+00  5.68808899e+00
  5.68808899e+00  8.92334598e+00  2.40524117e+01  2.40524117e+01
  2.40524117e+01  3.62677678e+01  1.18896172e+02  1.18896172e+02
  1.18896172e+02  1.40198779e+02  5.04104549e+02  1.87157327e+03
  8.00107673e+03  4.77685377e+04]
E1 = -182.5972178943143  E_coul = 54.0650715126223
cycle= 3 E= -128.532146381692  delta_E= -0.000848  |g|= 0.000453  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000919532
diis-c [-2.28121316e-07 -2.35541682e-03 -1.32226559e-03  1.00367768e+00]
  HOMO = -0.845521225012034  LUMO = 0.430115062748418
  mo_energy =
[-3.27693452e+01 -1.92722052e+00 -8.45521225e-01 -8.45521225e-01
 -8.45521225e-01  4.30115063e-01  1.08907992e+00  1.08907992e+00
  1.08907992e+00  2.40114202e+00  5.68788989e+00  5.68788989e+00
  5.68788989e+00  8.92315317e+00  2.40520987e+01  2.40520987e+01
  2.40520987e+01  3.62674579e+01  1.18895765e+02  1.18895765e+02
  1.18895765e+02  1.40198384e+02  5.04104052e+02  1.87157266e+03
  8.00107604e+03  4.77685370e+04]
E1 = -182.59767764506637  E_coul = 54.06553124200728
cycle= 4 E= -128.532146403059  delta_E= -2.14e-08  |g|= 6.16e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130127
diis-c [-1.02349514e-09  3.36570645e-04  4.24059354e-04 -2.19114914e-01
  1.21835428e+00]
  HOMO = -0.845552092100192  LUMO = 0.430111947664702
  mo_energy =
[-3.27693925e+01 -1.92723795e+00 -8.45552092e-01 -8.45552092e-01
 -8.45552092e-01  4.30111948e-01  1.08906663e+00  1.08906663e+00
  1.08906663e+00  2.40112880e+00  5.68785608e+00  5.68785608e+00
  5.68785608e+00  8.92312316e+00  2.40520551e+01  2.40520551e+01
  2.40520551e+01  3.62674155e+01  1.18895717e+02  1.18895717e+02
  1.18895717e+02  1.40198337e+02  5.04103997e+02  1.87157260e+03
  8.00107597e+03  4.77685369e+04]
E1 = -182.59776724639107  E_coul = 54.06562084274866
cycle= 5 E= -128.532146403642  delta_E= -5.83e-10  |g|= 6.8e-06  |ddm|= 4.24e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59776724639107  E_coul = 54.06562084274866
  HOMO = -0.845548326253742  LUMO = 0.430112741785851
  mo_energy =
[-3.27693843e+01 -1.92723345e+00 -8.45548326e-01 -8.45548326e-01
 -8.45548326e-01  4.30112742e-01  1.08906820e+00  1.08906820e+00
  1.08906820e+00  2.40113120e+00  5.68786066e+00  5.68786066e+00
  5.68786066e+00  8.92312800e+00  2.40520621e+01  2.40520621e+01
  2.40520621e+01  3.62674227e+01  1.18895725e+02  1.18895725e+02
  1.18895725e+02  1.40198344e+02  5.04104005e+02  1.87157261e+03
  8.00107598e+03  4.77685369e+04]
E1 = -182.59774907711554  E_coul = 54.065602673470394
Extra cycle  E= -128.532146403645  delta_E= -2.73e-12  |g|= 2.54e-06  |ddm|= 2.29e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [4.90462594e-01 2.44137941e+04 3.66145447e+03 8.33271067e+02
 2.35734634e+02 7.64342390e+01 1.00747434e+01 2.70382333e+01
 2.01896916e-01 1.23008478e+00 2.84215872e+00 3.68409832e+00
 1.24501563e+01 5.47853032e+01 3.30059000e-01 1.14362399e+00]
E = -128.53214640364513
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.490462594364       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446945        1
[INPUT] 0    0    [1    /1   ]  833.271066887        1
[INPUT] 0    0    [1    /1   ]  235.734633856        1
[INPUT] 0    0    [1    /1   ]  76.4342390119        1
[INPUT] 0    0    [1    /1   ]  10.0747434487        1
[INPUT] 0    0    [1    /1   ]  27.038233285         1
[INPUT] 0    0    [1    /1   ]  0.201896915515       1
[INPUT] 0    0    [1    /1   ]  1.2300847835         1
[INPUT] 0    0    [1    /1   ]  2.84215872386        1
[INPUT] 1    0    [1    /1   ]  3.68409832444        1
[INPUT] 1    0    [1    /1   ]  12.4501562629        1
[INPUT] 1    0    [1    /1   ]  54.7853031978        1
[INPUT] 1    0    [1    /1   ]  0.330058999853       1
[INPUT] 1    0    [1    /1   ]  1.1436239899         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.49046259436366324, 1.0]], [0, [24413.794130000824, 1.0]], [0, [3661.45446945462, 1.0]], [0, [833.2710668872771, 1.0]], [0, [235.73463385626164, 1.0]], [0, [76.43423901187016, 1.0]], [0, [10.074743448687853, 1.0]], [0, [27.038233284958924, 1.0]], [0, [0.20189691551494696, 1.0]], [0, [1.230084783502551, 1.0]], [0, [2.842158723858162, 1.0]], [1, [3.6840983244369236, 1.0]], [1, [12.450156262874435, 1.0]], [1, [54.78530319780062, 1.0]], [1, [0.3300589998530432, 1.0]], [1, [1.1436239899037226, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49046259]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446945]
bas 3, expnt(s) = [833.27106689]
bas 4, expnt(s) = [235.73463386]
bas 5, expnt(s) = [76.43423901]
bas 6, expnt(s) = [10.07474345]
bas 7, expnt(s) = [27.03823328]
bas 8, expnt(s) = [0.20189692]
bas 9, expnt(s) = [1.23008478]
bas 10, expnt(s) = [2.84215872]
bas 11, expnt(s) = [3.68409832]
bas 12, expnt(s) = [12.45015626]
bas 13, expnt(s) = [54.7853032]
bas 14, expnt(s) = [0.330059]
bas 15, expnt(s) = [1.14362399]
CPU time:        34.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.90462594e-01 1.48070807e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271067e+02 3.91836376e+02
 2.35734634e+02 1.51996144e+02 7.64342390e+01 6.53101955e+01
 1.00747434e+01 1.42869828e+01 2.70382333e+01 2.99570302e+01
 2.01896916e-01 7.60960804e-01 1.23008478e+00 2.95098029e+00
 2.84215872e+00 5.53033284e+00 3.68409832e+00 1.48901272e+01
 1.24501563e+01 6.82264690e+01 5.47853032e+01 4.34824974e+02
 3.30059000e-01 7.29833622e-01 1.14362399e+00 3.45015387e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99847931606681
cond(S) = 616.9284385920918
E1 = -183.57754055424115  E_coul = 55.078416285312116
init E= -128.499124268929
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773953130690952  LUMO = 0.439273169799825
  mo_energy =
[-3.25553247e+01 -1.85290094e+00 -7.73953131e-01 -7.73953131e-01
 -7.73953131e-01  4.39273170e-01  1.11484134e+00  1.11484134e+00
  1.11484134e+00  2.43568925e+00  5.77511308e+00  5.77511308e+00
  5.77511308e+00  9.00955907e+00  2.42098462e+01  2.42098462e+01
  2.42098462e+01  3.64289081e+01  1.19112037e+02  1.19112037e+02
  1.19112037e+02  1.40408849e+02  5.04348206e+02  1.87184784e+03
  8.00137792e+03  4.77688568e+04]
E1 = -182.1103885943257  E_coul = 53.58159634396527
cycle= 1 E= -128.52879225036  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462178
diis-c [-0.21360849  1.        ]
  HOMO = -0.879654863227368  LUMO = 0.425595047627496
  mo_energy =
[-3.28739736e+01 -1.96318322e+00 -8.79654863e-01 -8.79654863e-01
 -8.79654863e-01  4.25595048e-01  1.07663966e+00  1.07663966e+00
  1.07663966e+00  2.38481968e+00  5.64616239e+00  5.64616239e+00
  5.64616239e+00  8.88172225e+00  2.39748450e+01  2.39748450e+01
  2.39748450e+01  3.61880271e+01  1.18791121e+02  1.18791121e+02
  1.18791121e+02  1.40095844e+02  5.03990923e+02  1.87145445e+03
  8.00095549e+03  4.77684155e+04]
E1 = -182.84276613941992  E_coul = 54.31146767213773
cycle= 2 E= -128.531298467282  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0687
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230977
diis-c [-6.09825336e-04  3.32266514e-01  6.67733486e-01]
  HOMO = -0.845290237558267  LUMO = 0.430131298396939
  mo_energy =
[-3.27689496e+01 -1.92705670e+00 -8.45290238e-01 -8.45290238e-01
 -8.45290238e-01  4.30131298e-01  1.08912975e+00  1.08912975e+00
  1.08912975e+00  2.40122011e+00  5.68808899e+00  5.68808899e+00
  5.68808899e+00  8.92334598e+00  2.40524117e+01  2.40524117e+01
  2.40524117e+01  3.62677678e+01  1.18896172e+02  1.18896172e+02
  1.18896172e+02  1.40198779e+02  5.04104549e+02  1.87157327e+03
  8.00107673e+03  4.77685377e+04]
E1 = -182.5972178943143  E_coul = 54.0650715126223
cycle= 3 E= -128.532146381692  delta_E= -0.000848  |g|= 0.000453  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000919532
diis-c [-2.28121316e-07 -2.35541682e-03 -1.32226559e-03  1.00367768e+00]
  HOMO = -0.845521225012034  LUMO = 0.430115062748418
  mo_energy =
[-3.27693452e+01 -1.92722052e+00 -8.45521225e-01 -8.45521225e-01
 -8.45521225e-01  4.30115063e-01  1.08907992e+00  1.08907992e+00
  1.08907992e+00  2.40114202e+00  5.68788989e+00  5.68788989e+00
  5.68788989e+00  8.92315317e+00  2.40520987e+01  2.40520987e+01
  2.40520987e+01  3.62674579e+01  1.18895765e+02  1.18895765e+02
  1.18895765e+02  1.40198384e+02  5.04104052e+02  1.87157266e+03
  8.00107604e+03  4.77685370e+04]
E1 = -182.59767764506637  E_coul = 54.06553124200728
cycle= 4 E= -128.532146403059  delta_E= -2.14e-08  |g|= 6.16e-05  |ddm|= 0.000221
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130127
diis-c [-1.02349514e-09  3.36570645e-04  4.24059354e-04 -2.19114914e-01
  1.21835428e+00]
  HOMO = -0.845552092100192  LUMO = 0.430111947664702
  mo_energy =
[-3.27693925e+01 -1.92723795e+00 -8.45552092e-01 -8.45552092e-01
 -8.45552092e-01  4.30111948e-01  1.08906663e+00  1.08906663e+00
  1.08906663e+00  2.40112880e+00  5.68785608e+00  5.68785608e+00
  5.68785608e+00  8.92312316e+00  2.40520551e+01  2.40520551e+01
  2.40520551e+01  3.62674155e+01  1.18895717e+02  1.18895717e+02
  1.18895717e+02  1.40198337e+02  5.04103997e+02  1.87157260e+03
  8.00107597e+03  4.77685369e+04]
E1 = -182.59776724639107  E_coul = 54.06562084274866
cycle= 5 E= -128.532146403642  delta_E= -5.83e-10  |g|= 6.8e-06  |ddm|= 4.24e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59776724639107  E_coul = 54.06562084274866
  HOMO = -0.845548326253742  LUMO = 0.430112741785851
  mo_energy =
[-3.27693843e+01 -1.92723345e+00 -8.45548326e-01 -8.45548326e-01
 -8.45548326e-01  4.30112742e-01  1.08906820e+00  1.08906820e+00
  1.08906820e+00  2.40113120e+00  5.68786066e+00  5.68786066e+00
  5.68786066e+00  8.92312800e+00  2.40520621e+01  2.40520621e+01
  2.40520621e+01  3.62674227e+01  1.18895725e+02  1.18895725e+02
  1.18895725e+02  1.40198344e+02  5.04104005e+02  1.87157261e+03
  8.00107598e+03  4.77685369e+04]
E1 = -182.59774907711554  E_coul = 54.065602673470394
Extra cycle  E= -128.532146403645  delta_E= -2.73e-12  |g|= 2.54e-06  |ddm|= 2.29e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 616.9284385920918
E1 = -182.59774907711554  E_coul = 54.065602673470394
init E= -128.532146403645
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845549597528157  LUMO = 0.430112614109665
  mo_energy =
[-3.27693884e+01 -1.92723467e+00 -8.45549598e-01 -8.45549598e-01
 -8.45549598e-01  4.30112614e-01  1.08906776e+00  1.08906776e+00
  1.08906776e+00  2.40113068e+00  5.68785911e+00  5.68785911e+00
  5.68785911e+00  8.92312651e+00  2.40520592e+01  2.40520592e+01
  2.40520592e+01  3.62674197e+01  1.18895721e+02  1.18895721e+02
  1.18895721e+02  1.40198341e+02  5.04104000e+02  1.87157260e+03
  8.00107597e+03  4.77685369e+04]
E1 = -182.59775884592545  E_coul = 54.065612442279956
cycle= 1 E= -128.532146403645  delta_E= -3.69e-13  |g|= 1.34e-06  |ddm|= 9.62e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59775884592545  E_coul = 54.065612442279956
  HOMO = -0.845548910799493  LUMO = 0.430112711458499
  mo_energy =
[-3.27693863e+01 -1.92723393e+00 -8.45548911e-01 -8.45548911e-01
 -8.45548911e-01  4.30112711e-01  1.08906801e+00  1.08906801e+00
  1.08906801e+00  2.40113102e+00  5.68785996e+00  5.68785996e+00
  5.68785996e+00  8.92312736e+00  2.40520607e+01  2.40520607e+01
  2.40520607e+01  3.62674213e+01  1.18895723e+02  1.18895723e+02
  1.18895723e+02  1.40198343e+02  5.04104002e+02  1.87157261e+03
  8.00107597e+03  4.77685369e+04]
E1 = -182.59775398897273  E_coul = 54.06560758532719
Extra cycle  E= -128.532146403646  delta_E= -2.84e-14  |g|= 6.61e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [4.90462594e-01 2.44137941e+04 3.66145447e+03 8.33271067e+02
 2.35734634e+02 7.64342390e+01 1.00747434e+01 2.70382333e+01
 2.01896916e-01 1.23008478e+00 2.84215872e+00 3.68409832e+00
 1.24501563e+01 5.47853032e+01 3.30059000e-01 1.14362399e+00]
grad_E = [-4.11562343e-04  2.30840425e-10 -1.20903731e-08  2.48871212e-07
 -2.98775290e-06  1.98623859e-05 -7.09835952e-05 -3.68013014e-05
 -1.10479440e-04 -2.55037831e-04 -1.45292599e-04  4.92428273e-06
  5.14335721e-06 -3.11660597e-07 -2.22007590e-05  1.03612404e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.490818732829       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446951        1
[INPUT] 0    0    [1    /1   ]  833.271065833        1
[INPUT] 0    0    [1    /1   ]  235.734646504        1
[INPUT] 0    0    [1    /1   ]  76.4341528328        1
[INPUT] 0    0    [1    /1   ]  10.0748222782        1
[INPUT] 0    0    [1    /1   ]  27.0384366183        1
[INPUT] 0    0    [1    /1   ]  0.203685709039       1
[INPUT] 0    0    [1    /1   ]  1.23241292355        1
[INPUT] 0    0    [1    /1   ]  2.84247573185        1
[INPUT] 1    0    [1    /1   ]  3.68403383741        1
[INPUT] 1    0    [1    /1   ]  12.4501454824        1
[INPUT] 1    0    [1    /1   ]  54.7853039954        1
[INPUT] 1    0    [1    /1   ]  0.330021053323       1
[INPUT] 1    0    [1    /1   ]  1.14365577247        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.49081873282859323, 1.0]], [0, [24413.794129999842, 1.0]], [0, [3661.4544695060163, 1.0]], [0, [833.27106583307, 1.0]], [0, [235.7346465038236, 1.0]], [0, [76.43415283279103, 1.0]], [0, [10.07482227821321, 1.0]], [0, [27.038436618256082, 1.0]], [0, [0.203685709039442, 1.0]], [0, [1.2324129235548793, 1.0]], [0, [2.8424757318546443, 1.0]], [1, [3.684033837407541, 1.0]], [1, [12.450145482376747, 1.0]], [1, [54.785303995376616, 1.0]], [1, [0.33002105332343856, 1.0]], [1, [1.1436557724718932, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49081873]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446951]
bas 3, expnt(s) = [833.27106583]
bas 4, expnt(s) = [235.7346465]
bas 5, expnt(s) = [76.43415283]
bas 6, expnt(s) = [10.07482228]
bas 7, expnt(s) = [27.03843662]
bas 8, expnt(s) = [0.20368571]
bas 9, expnt(s) = [1.23241292]
bas 10, expnt(s) = [2.84247573]
bas 11, expnt(s) = [3.68403384]
bas 12, expnt(s) = [12.45014548]
bas 13, expnt(s) = [54.785304]
bas 14, expnt(s) = [0.33002105]
bas 15, expnt(s) = [1.14365577]
CPU time:        36.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.90818733e-01 1.48151438e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271066e+02 3.91836376e+02
 2.35734647e+02 1.51996150e+02 7.64341528e+01 6.53101403e+01
 1.00748223e+01 1.42870666e+01 2.70384366e+01 2.99571992e+01
 2.03685709e-01 7.66011772e-01 1.23241292e+00 2.95516822e+00
 2.84247573e+00 5.53079547e+00 3.68403384e+00 1.48898014e+01
 1.24501455e+01 6.82263952e+01 5.47853040e+01 4.34824982e+02
 3.30021053e-01 7.29728738e-01 1.14365577e+00 3.45027372e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99847957400084
cond(S) = 621.7802951156006
E1 = -183.5775248355103  E_coul = 55.078402718413564
init E= -128.499122117097
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773954091133965  LUMO = 0.442573848258089
  mo_energy =
[-3.25553288e+01 -1.85290103e+00 -7.73954091e-01 -7.73954091e-01
 -7.73954091e-01  4.42573848e-01  1.11473924e+00  1.11473924e+00
  1.11473924e+00  2.44542974e+00  5.77501552e+00  5.77501552e+00
  5.77501552e+00  9.02657376e+00  2.42096427e+01  2.42096427e+01
  2.42096427e+01  3.64493571e+01  1.19111809e+02  1.19111809e+02
  1.19111809e+02  1.40428090e+02  5.04365567e+02  1.87186335e+03
  8.00139156e+03  4.77688681e+04]
E1 = -182.1102137335729  E_coul = 53.581421016213824
cycle= 1 E= -128.528792717359  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462235
diis-c [-0.21366115  1.        ]
  HOMO = -0.87966915354398  LUMO = 0.428788590956684
  mo_energy =
[-3.28740036e+01 -1.96319855e+00 -8.79669154e-01 -8.79669154e-01
 -8.79669154e-01  4.28788591e-01  1.07653357e+00  1.07653357e+00
  1.07653357e+00  2.39446907e+00  5.64604868e+00  5.64604868e+00
  5.64604868e+00  8.89868366e+00  2.39746183e+01  2.39746183e+01
  2.39746183e+01  3.62084678e+01  1.18790867e+02  1.18790867e+02
  1.18790867e+02  1.40115065e+02  5.04008258e+02  1.87146993e+03
  8.00096909e+03  4.77684268e+04]
E1 = -182.84263702840067  E_coul = 54.3113379169453
cycle= 2 E= -128.531299111455  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0687
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23101
diis-c [-6.09865475e-04  3.32270843e-01  6.67729157e-01]
  HOMO = -0.845302648493461  LUMO = 0.433358392370358
  mo_energy =
[-3.27689736e+01 -1.92706994e+00 -8.45302648e-01 -8.45302648e-01
 -8.45302648e-01  4.33358392e-01  1.08902390e+00  1.08902390e+00
  1.08902390e+00  2.41089650e+00  5.68797771e+00  5.68797771e+00
  5.68797771e+00  8.94032187e+00  2.40521893e+01  2.40521893e+01
  2.40521893e+01  3.62882095e+01  1.18895925e+02  1.18895925e+02
  1.18895925e+02  1.40218004e+02  5.04121890e+02  1.87158876e+03
  8.00109034e+03  4.77685489e+04]
E1 = -182.59706127311162  E_coul = 54.064914102625025
cycle= 3 E= -128.532147170487  delta_E= -0.000848  |g|= 0.000454  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000920562
diis-c [-2.26867236e-07 -2.35497412e-03 -1.31288008e-03  1.00366785e+00]
  HOMO = -0.84553427372142  LUMO = 0.43334188627416
  mo_energy =
[-3.27693702e+01 -1.92723450e+00 -8.45534274e-01 -8.45534274e-01
 -8.45534274e-01  4.33341886e-01  1.08897382e+00  1.08897382e+00
  1.08897382e+00  2.41081782e+00  5.68777787e+00  5.68777787e+00
  5.68777787e+00  8.94012817e+00  2.40518755e+01  2.40518755e+01
  2.40518755e+01  3.62878988e+01  1.18895516e+02  1.18895516e+02
  1.18895516e+02  1.40217608e+02  5.04121392e+02  1.87158815e+03
  8.00108965e+03  4.77685482e+04]
E1 = -182.59752251939992  E_coul = 54.06537532753894
cycle= 4 E= -128.532147191861  delta_E= -2.14e-08  |g|= 6.16e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130052
diis-c [-1.02420138e-09  3.36582562e-04  4.23183742e-04 -2.19016083e-01
  1.21825632e+00]
  HOMO = -0.845565186186741  LUMO = 0.433338733837177
  mo_energy =
[-3.27694175e+01 -1.92725200e+00 -8.45565186e-01 -8.45565186e-01
 -8.45565186e-01  4.33338734e-01  1.08896052e+00  1.08896052e+00
  1.08896052e+00  2.41080453e+00  5.68774399e+00  5.68774399e+00
  5.68774399e+00  8.94009809e+00  2.40518318e+01  2.40518318e+01
  2.40518318e+01  3.62878563e+01  1.18895468e+02  1.18895468e+02
  1.18895468e+02  1.40217560e+02  5.04121337e+02  1.87158809e+03
  8.00108958e+03  4.77685481e+04]
E1 = -182.5976122437318  E_coul = 54.06546505128838
cycle= 5 E= -128.532147192443  delta_E= -5.82e-10  |g|= 6.81e-06  |ddm|= 4.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5976122437318  E_coul = 54.06546505128838
  HOMO = -0.84556141505762  LUMO = 0.433339534465402
  mo_energy =
[-3.27694093e+01 -1.92724750e+00 -8.45561415e-01 -8.45561415e-01
 -8.45561415e-01  4.33339534e-01  1.08896209e+00  1.08896209e+00
  1.08896209e+00  2.41080695e+00  5.68774858e+00  5.68774858e+00
  5.68774858e+00  8.94010293e+00  2.40518388e+01  2.40518388e+01
  2.40518388e+01  3.62878635e+01  1.18895476e+02  1.18895476e+02
  1.18895476e+02  1.40217568e+02  5.04121345e+02  1.87158810e+03
  8.00108959e+03  4.77685481e+04]
E1 = -182.59759406036218  E_coul = 54.065446867916236
Extra cycle  E= -128.532147192446  delta_E= -2.56e-12  |g|= 2.54e-06  |ddm|= 2.28e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [4.90818733e-01 2.44137941e+04 3.66145447e+03 8.33271066e+02
 2.35734647e+02 7.64341528e+01 1.00748223e+01 2.70384366e+01
 2.03685709e-01 1.23241292e+00 2.84247573e+00 3.68403384e+00
 1.24501455e+01 5.47853040e+01 3.30021053e-01 1.14365577e+00]
E = -128.53214719244596
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.490818732829       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446951        1
[INPUT] 0    0    [1    /1   ]  833.271065833        1
[INPUT] 0    0    [1    /1   ]  235.734646504        1
[INPUT] 0    0    [1    /1   ]  76.4341528328        1
[INPUT] 0    0    [1    /1   ]  10.0748222782        1
[INPUT] 0    0    [1    /1   ]  27.0384366183        1
[INPUT] 0    0    [1    /1   ]  0.203685709039       1
[INPUT] 0    0    [1    /1   ]  1.23241292355        1
[INPUT] 0    0    [1    /1   ]  2.84247573185        1
[INPUT] 1    0    [1    /1   ]  3.68403383741        1
[INPUT] 1    0    [1    /1   ]  12.4501454824        1
[INPUT] 1    0    [1    /1   ]  54.7853039954        1
[INPUT] 1    0    [1    /1   ]  0.330021053323       1
[INPUT] 1    0    [1    /1   ]  1.14365577247        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.49081873282859323, 1.0]], [0, [24413.794129999842, 1.0]], [0, [3661.4544695060163, 1.0]], [0, [833.27106583307, 1.0]], [0, [235.7346465038236, 1.0]], [0, [76.43415283279103, 1.0]], [0, [10.07482227821321, 1.0]], [0, [27.038436618256082, 1.0]], [0, [0.203685709039442, 1.0]], [0, [1.2324129235548793, 1.0]], [0, [2.8424757318546443, 1.0]], [1, [3.684033837407541, 1.0]], [1, [12.450145482376747, 1.0]], [1, [54.785303995376616, 1.0]], [1, [0.33002105332343856, 1.0]], [1, [1.1436557724718932, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49081873]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446951]
bas 3, expnt(s) = [833.27106583]
bas 4, expnt(s) = [235.7346465]
bas 5, expnt(s) = [76.43415283]
bas 6, expnt(s) = [10.07482228]
bas 7, expnt(s) = [27.03843662]
bas 8, expnt(s) = [0.20368571]
bas 9, expnt(s) = [1.23241292]
bas 10, expnt(s) = [2.84247573]
bas 11, expnt(s) = [3.68403384]
bas 12, expnt(s) = [12.45014548]
bas 13, expnt(s) = [54.785304]
bas 14, expnt(s) = [0.33002105]
bas 15, expnt(s) = [1.14365577]
CPU time:        36.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.90818733e-01 1.48151438e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271066e+02 3.91836376e+02
 2.35734647e+02 1.51996150e+02 7.64341528e+01 6.53101403e+01
 1.00748223e+01 1.42870666e+01 2.70384366e+01 2.99571992e+01
 2.03685709e-01 7.66011772e-01 1.23241292e+00 2.95516822e+00
 2.84247573e+00 5.53079547e+00 3.68403384e+00 1.48898014e+01
 1.24501455e+01 6.82263952e+01 5.47853040e+01 4.34824982e+02
 3.30021053e-01 7.29728738e-01 1.14365577e+00 3.45027372e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99847957400084
cond(S) = 621.7802951156006
E1 = -183.5775248355103  E_coul = 55.078402718413564
init E= -128.499122117097
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773954091133965  LUMO = 0.442573848258089
  mo_energy =
[-3.25553288e+01 -1.85290103e+00 -7.73954091e-01 -7.73954091e-01
 -7.73954091e-01  4.42573848e-01  1.11473924e+00  1.11473924e+00
  1.11473924e+00  2.44542974e+00  5.77501552e+00  5.77501552e+00
  5.77501552e+00  9.02657376e+00  2.42096427e+01  2.42096427e+01
  2.42096427e+01  3.64493571e+01  1.19111809e+02  1.19111809e+02
  1.19111809e+02  1.40428090e+02  5.04365567e+02  1.87186335e+03
  8.00139156e+03  4.77688681e+04]
E1 = -182.1102137335729  E_coul = 53.581421016213824
cycle= 1 E= -128.528792717359  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462235
diis-c [-0.21366115  1.        ]
  HOMO = -0.87966915354398  LUMO = 0.428788590956684
  mo_energy =
[-3.28740036e+01 -1.96319855e+00 -8.79669154e-01 -8.79669154e-01
 -8.79669154e-01  4.28788591e-01  1.07653357e+00  1.07653357e+00
  1.07653357e+00  2.39446907e+00  5.64604868e+00  5.64604868e+00
  5.64604868e+00  8.89868366e+00  2.39746183e+01  2.39746183e+01
  2.39746183e+01  3.62084678e+01  1.18790867e+02  1.18790867e+02
  1.18790867e+02  1.40115065e+02  5.04008258e+02  1.87146993e+03
  8.00096909e+03  4.77684268e+04]
E1 = -182.84263702840067  E_coul = 54.3113379169453
cycle= 2 E= -128.531299111455  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0687
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23101
diis-c [-6.09865475e-04  3.32270843e-01  6.67729157e-01]
  HOMO = -0.845302648493461  LUMO = 0.433358392370358
  mo_energy =
[-3.27689736e+01 -1.92706994e+00 -8.45302648e-01 -8.45302648e-01
 -8.45302648e-01  4.33358392e-01  1.08902390e+00  1.08902390e+00
  1.08902390e+00  2.41089650e+00  5.68797771e+00  5.68797771e+00
  5.68797771e+00  8.94032187e+00  2.40521893e+01  2.40521893e+01
  2.40521893e+01  3.62882095e+01  1.18895925e+02  1.18895925e+02
  1.18895925e+02  1.40218004e+02  5.04121890e+02  1.87158876e+03
  8.00109034e+03  4.77685489e+04]
E1 = -182.59706127311162  E_coul = 54.064914102625025
cycle= 3 E= -128.532147170487  delta_E= -0.000848  |g|= 0.000454  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000920562
diis-c [-2.26867236e-07 -2.35497412e-03 -1.31288008e-03  1.00366785e+00]
  HOMO = -0.84553427372142  LUMO = 0.43334188627416
  mo_energy =
[-3.27693702e+01 -1.92723450e+00 -8.45534274e-01 -8.45534274e-01
 -8.45534274e-01  4.33341886e-01  1.08897382e+00  1.08897382e+00
  1.08897382e+00  2.41081782e+00  5.68777787e+00  5.68777787e+00
  5.68777787e+00  8.94012817e+00  2.40518755e+01  2.40518755e+01
  2.40518755e+01  3.62878988e+01  1.18895516e+02  1.18895516e+02
  1.18895516e+02  1.40217608e+02  5.04121392e+02  1.87158815e+03
  8.00108965e+03  4.77685482e+04]
E1 = -182.59752251939992  E_coul = 54.06537532753894
cycle= 4 E= -128.532147191861  delta_E= -2.14e-08  |g|= 6.16e-05  |ddm|= 0.000222
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130052
diis-c [-1.02420138e-09  3.36582562e-04  4.23183742e-04 -2.19016083e-01
  1.21825632e+00]
  HOMO = -0.845565186186741  LUMO = 0.433338733837177
  mo_energy =
[-3.27694175e+01 -1.92725200e+00 -8.45565186e-01 -8.45565186e-01
 -8.45565186e-01  4.33338734e-01  1.08896052e+00  1.08896052e+00
  1.08896052e+00  2.41080453e+00  5.68774399e+00  5.68774399e+00
  5.68774399e+00  8.94009809e+00  2.40518318e+01  2.40518318e+01
  2.40518318e+01  3.62878563e+01  1.18895468e+02  1.18895468e+02
  1.18895468e+02  1.40217560e+02  5.04121337e+02  1.87158809e+03
  8.00108958e+03  4.77685481e+04]
E1 = -182.5976122437318  E_coul = 54.06546505128838
cycle= 5 E= -128.532147192443  delta_E= -5.82e-10  |g|= 6.81e-06  |ddm|= 4.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5976122437318  E_coul = 54.06546505128838
  HOMO = -0.84556141505762  LUMO = 0.433339534465402
  mo_energy =
[-3.27694093e+01 -1.92724750e+00 -8.45561415e-01 -8.45561415e-01
 -8.45561415e-01  4.33339534e-01  1.08896209e+00  1.08896209e+00
  1.08896209e+00  2.41080695e+00  5.68774858e+00  5.68774858e+00
  5.68774858e+00  8.94010293e+00  2.40518388e+01  2.40518388e+01
  2.40518388e+01  3.62878635e+01  1.18895476e+02  1.18895476e+02
  1.18895476e+02  1.40217568e+02  5.04121345e+02  1.87158810e+03
  8.00108959e+03  4.77685481e+04]
E1 = -182.59759406036218  E_coul = 54.065446867916236
Extra cycle  E= -128.532147192446  delta_E= -2.56e-12  |g|= 2.54e-06  |ddm|= 2.28e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 621.7802951156006
E1 = -182.59759406036218  E_coul = 54.065446867916236
init E= -128.532147192446
    CPU time for initialize scf      0.22 sec, wall time      0.21 sec
  HOMO = -0.845562687244406  LUMO = 0.433339405702524
  mo_energy =
[-3.27694134e+01 -1.92724873e+00 -8.45562687e-01 -8.45562687e-01
 -8.45562687e-01  4.33339406e-01  1.08896165e+00  1.08896165e+00
  1.08896165e+00  2.41080642e+00  5.68774703e+00  5.68774703e+00
  5.68774703e+00  8.94010145e+00  2.40518359e+01  2.40518359e+01
  2.40518359e+01  3.62878605e+01  1.18895472e+02  1.18895472e+02
  1.18895472e+02  1.40217564e+02  5.04121341e+02  1.87158809e+03
  8.00108958e+03  4.77685481e+04]
E1 = -182.5976038376028  E_coul = 54.06545664515622
cycle= 1 E= -128.532147192447  delta_E= -6.25e-13  |g|= 1.34e-06  |ddm|= 9.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5976038376028  E_coul = 54.06545664515622
  HOMO = -0.845561999913441  LUMO = 0.433339503843591
  mo_energy =
[-3.27694113e+01 -1.92724798e+00 -8.45562000e-01 -8.45562000e-01
 -8.45562000e-01  4.33339504e-01  1.08896190e+00  1.08896190e+00
  1.08896190e+00  2.41080676e+00  5.68774788e+00  5.68774788e+00
  5.68774788e+00  8.94010229e+00  2.40518374e+01  2.40518374e+01
  2.40518374e+01  3.62878621e+01  1.18895474e+02  1.18895474e+02
  1.18895474e+02  1.40217566e+02  5.04121343e+02  1.87158810e+03
  8.00108958e+03  4.77685481e+04]
E1 = -182.59759897623474  E_coul = 54.06545178378818
Extra cycle  E= -128.532147192447  delta_E= 2.84e-14  |g|= 6.62e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [4.90818733e-01 2.44137941e+04 3.66145447e+03 8.33271066e+02
 2.35734647e+02 7.64341528e+01 1.00748223e+01 2.70384366e+01
 2.03685709e-01 1.23241292e+00 2.84247573e+00 3.68403384e+00
 1.24501455e+01 5.47853040e+01 3.30021053e-01 1.14365577e+00]
grad_E = [-6.14471963e-04  2.24851741e-10 -1.17751429e-08  2.42559381e-07
 -2.91178442e-06  1.92527336e-05 -8.23943118e-05 -3.33375988e-05
  1.36513175e-05 -1.46699668e-04 -1.63010526e-04 -3.22492161e-05
  9.32098111e-06 -4.61494788e-07 -3.78715641e-04  1.72258487e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.492868739918       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446964        1
[INPUT] 0    0    [1    /1   ]  833.271063117        1
[INPUT] 0    0    [1    /1   ]  235.734679097        1
[INPUT] 0    0    [1    /1   ]  76.4339323366        1
[INPUT] 0    0    [1    /1   ]  10.075197258         1
[INPUT] 0    0    [1    /1   ]  27.0389243272        1
[INPUT] 0    0    [1    /1   ]  0.20729429431        1
[INPUT] 0    0    [1    /1   ]  1.23741151372        1
[INPUT] 0    0    [1    /1   ]  2.84353173872        1
[INPUT] 1    0    [1    /1   ]  3.68390564522        1
[INPUT] 1    0    [1    /1   ]  12.4501081611        1
[INPUT] 1    0    [1    /1   ]  54.7853064963        1
[INPUT] 1    0    [1    /1   ]  0.329968483339       1
[INPUT] 1    0    [1    /1   ]  1.14368714811        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.4928687399180771, 1.0]], [0, [24413.794129997317, 1.0]], [0, [3661.4544696383073, 1.0]], [0, [833.2710631168038, 1.0]], [0, [235.7346790965791, 1.0]], [0, [76.43393233655804, 1.0]], [0, [10.075197257968034, 1.0]], [0, [27.038924327224493, 1.0]], [0, [0.2072942943104673, 1.0]], [0, [1.2374115137246242, 1.0]], [0, [2.843531738717848, 1.0]], [1, [3.6839056452192223, 1.0]], [1, [12.450108161114589, 1.0]], [1, [54.785306496283724, 1.0]], [1, [0.3299684833385863, 1.0]], [1, [1.1436871481148598, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49286874]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446964]
bas 3, expnt(s) = [833.27106312]
bas 4, expnt(s) = [235.7346791]
bas 5, expnt(s) = [76.43393234]
bas 6, expnt(s) = [10.07519726]
bas 7, expnt(s) = [27.03892433]
bas 8, expnt(s) = [0.20729429]
bas 9, expnt(s) = [1.23741151]
bas 10, expnt(s) = [2.84353174]
bas 11, expnt(s) = [3.68390565]
bas 12, expnt(s) = [12.45010816]
bas 13, expnt(s) = [54.7853065]
bas 14, expnt(s) = [0.32996848]
bas 15, expnt(s) = [1.14368715]
CPU time:        39.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.92868740e-01 1.48615285e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271063e+02 3.91836375e+02
 2.35734679e+02 1.51996165e+02 7.64339323e+01 6.53099990e+01
 1.00751973e+01 1.42874654e+01 2.70389243e+01 2.99576044e+01
 2.07294294e-01 7.76167646e-01 1.23741151e+00 2.96415315e+00
 2.84353174e+00 5.53233645e+00 3.68390565e+00 1.48891538e+01
 1.24501082e+01 6.82261395e+01 5.47853065e+01 4.34825006e+02
 3.29968483e-01 7.29583441e-01 1.14368715e+00 3.45039204e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998480038641473
cond(S) = 633.4643691618335
E1 = -183.5775050888926  E_coul = 55.07838412805042
init E= -128.499120960842
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773955423663634  LUMO = 0.449706744346715
  mo_energy =
[-3.25553348e+01 -1.85290117e+00 -7.73955424e-01 -7.73955424e-01
 -7.73955424e-01  4.49706744e-01  1.11459398e+00  1.11459398e+00
  1.11459398e+00  2.46855123e+00  5.77482001e+00  5.77482001e+00
  5.77482001e+00  9.06792589e+00  2.42091815e+01  2.42091815e+01
  2.42091815e+01  3.64996271e+01  1.19111276e+02  1.19111276e+02
  1.19111276e+02  1.40475832e+02  5.04408753e+02  1.87190196e+03
  8.00142549e+03  4.77688962e+04]
E1 = -182.10998418520794  E_coul = 53.58119016722781
cycle= 1 E= -128.52879401798  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462323
diis-c [-0.21374221  1.        ]
  HOMO = -0.879687706463806  LUMO = 0.435685527505721
  mo_energy =
[-3.28740442e+01 -1.96321874e+00 -8.79687706e-01 -8.79687706e-01
 -8.79687706e-01  4.35685528e-01  1.07638357e+00  1.07638357e+00
  1.07638357e+00  2.41736169e+00  5.64583303e+00  5.64583303e+00
  5.64583303e+00  8.93992288e+00  2.39741266e+01  2.39741266e+01
  2.39741266e+01  3.62587369e+01  1.18790300e+02  1.18790300e+02
  1.18790300e+02  1.40162783e+02  5.04051409e+02  1.87150850e+03
  8.00100298e+03  4.77684548e+04]
E1 = -182.84246794059587  E_coul = 54.31116729333654
cycle= 2 E= -128.531300647259  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231057
diis-c [-6.09943540e-04  3.32274469e-01  6.67725531e-01]
  HOMO = -0.84531860178945  LUMO = 0.44032983724548
  mo_energy =
[-3.27690060e+01 -1.92708724e+00 -8.45318602e-01 -8.45318602e-01
 -8.45318602e-01  4.40329837e-01  1.08887410e+00  1.08887410e+00
  1.08887410e+00  2.43385977e+00  5.68776509e+00  5.68776509e+00
  5.68776509e+00  8.98159455e+00  2.40517035e+01  2.40517035e+01
  2.40517035e+01  3.63384768e+01  1.18895366e+02  1.18895366e+02
  1.18895366e+02  1.40265726e+02  5.04165048e+02  1.87162734e+03
  8.00112425e+03  4.77685770e+04]
E1 = -182.5968548311278  E_coul = 54.064705933072226
cycle= 3 E= -128.532148898056  delta_E= -0.000848  |g|= 0.000456  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000922293
diis-c [-2.24451350e-07 -2.35269899e-03 -1.29313529e-03  1.00364583e+00]
  HOMO = -0.845551171372121  LUMO = 0.440312825515536
  mo_energy =
[-3.27694041e+01 -1.92725293e+00 -8.45551171e-01 -8.45551171e-01
 -8.45551171e-01  4.40312826e-01  1.08882366e+00  1.08882366e+00
  1.08882366e+00  2.43378001e+00  5.68756413e+00  5.68756413e+00
  5.68756413e+00  8.98139945e+00  2.40513881e+01  2.40513881e+01
  2.40513881e+01  3.63381646e+01  1.18894956e+02  1.18894956e+02
  1.18894956e+02  1.40265328e+02  5.04164549e+02  1.87162673e+03
  8.00112355e+03  4.77685763e+04]
E1 = -182.59731872298906  E_coul = 54.065169803538936
cycle= 4 E= -128.53214891945  delta_E= -2.14e-08  |g|= 6.16e-05  |ddm|= 0.000225
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000129935
diis-c [-1.02483559e-09  3.36532158e-04  4.21673656e-04 -2.18864431e-01
  1.21810623e+00]
  HOMO = -0.845582159439471  LUMO = 0.440309597499824
  mo_energy =
[-3.27694516e+01 -1.92727055e+00 -8.45582159e-01 -8.45582159e-01
 -8.45582159e-01  4.40309597e-01  1.08881033e+00  1.08881033e+00
  1.08881033e+00  2.43376661e+00  5.68753016e+00  5.68753016e+00
  5.68753016e+00  8.98136923e+00  2.40513443e+01  2.40513443e+01
  2.40513443e+01  3.63381219e+01  1.18894908e+02  1.18894908e+02
  1.18894908e+02  1.40265280e+02  5.04164494e+02  1.87162666e+03
  8.00112348e+03  4.77685762e+04]
E1 = -182.5974086959349  E_coul = 54.065259775904735
cycle= 5 E= -128.53214892003  delta_E= -5.8e-10  |g|= 6.82e-06  |ddm|= 4.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5974086959349  E_coul = 54.065259775904735
  HOMO = -0.845578381140829  LUMO = 0.440310411741648
  mo_energy =
[-3.27694434e+01 -1.92726605e+00 -8.45578381e-01 -8.45578381e-01
 -8.45578381e-01  4.40310412e-01  1.08881191e+00  1.08881191e+00
  1.08881191e+00  2.43376903e+00  5.68753476e+00  5.68753476e+00
  5.68753476e+00  8.98137409e+00  2.40513514e+01  2.40513514e+01
  2.40513514e+01  3.63381292e+01  1.18894916e+02  1.18894916e+02
  1.18894916e+02  1.40265288e+02  5.04164502e+02  1.87162667e+03
  8.00112349e+03  4.77685762e+04]
E1 = -182.5973904910767  E_coul = 54.06524157104394
Extra cycle  E= -128.532148920033  delta_E= -2.61e-12  |g|= 2.54e-06  |ddm|= 2.27e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [4.92868740e-01 2.44137941e+04 3.66145447e+03 8.33271063e+02
 2.35734679e+02 7.64339323e+01 1.00751973e+01 2.70389243e+01
 2.07294294e-01 1.23741151e+00 2.84353174e+00 3.68390565e+00
 1.24501082e+01 5.47853065e+01 3.29968483e-01 1.14368715e+00]
E = -128.53214892003277
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:57:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.492868739918       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446964        1
[INPUT] 0    0    [1    /1   ]  833.271063117        1
[INPUT] 0    0    [1    /1   ]  235.734679097        1
[INPUT] 0    0    [1    /1   ]  76.4339323366        1
[INPUT] 0    0    [1    /1   ]  10.075197258         1
[INPUT] 0    0    [1    /1   ]  27.0389243272        1
[INPUT] 0    0    [1    /1   ]  0.20729429431        1
[INPUT] 0    0    [1    /1   ]  1.23741151372        1
[INPUT] 0    0    [1    /1   ]  2.84353173872        1
[INPUT] 1    0    [1    /1   ]  3.68390564522        1
[INPUT] 1    0    [1    /1   ]  12.4501081611        1
[INPUT] 1    0    [1    /1   ]  54.7853064963        1
[INPUT] 1    0    [1    /1   ]  0.329968483339       1
[INPUT] 1    0    [1    /1   ]  1.14368714811        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.4928687399180771, 1.0]], [0, [24413.794129997317, 1.0]], [0, [3661.4544696383073, 1.0]], [0, [833.2710631168038, 1.0]], [0, [235.7346790965791, 1.0]], [0, [76.43393233655804, 1.0]], [0, [10.075197257968034, 1.0]], [0, [27.038924327224493, 1.0]], [0, [0.2072942943104673, 1.0]], [0, [1.2374115137246242, 1.0]], [0, [2.843531738717848, 1.0]], [1, [3.6839056452192223, 1.0]], [1, [12.450108161114589, 1.0]], [1, [54.785306496283724, 1.0]], [1, [0.3299684833385863, 1.0]], [1, [1.1436871481148598, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49286874]
bas 1, expnt(s) = [24413.79413]
bas 2, expnt(s) = [3661.45446964]
bas 3, expnt(s) = [833.27106312]
bas 4, expnt(s) = [235.7346791]
bas 5, expnt(s) = [76.43393234]
bas 6, expnt(s) = [10.07519726]
bas 7, expnt(s) = [27.03892433]
bas 8, expnt(s) = [0.20729429]
bas 9, expnt(s) = [1.23741151]
bas 10, expnt(s) = [2.84353174]
bas 11, expnt(s) = [3.68390565]
bas 12, expnt(s) = [12.45010816]
bas 13, expnt(s) = [54.7853065]
bas 14, expnt(s) = [0.32996848]
bas 15, expnt(s) = [1.14368715]
CPU time:        39.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.92868740e-01 1.48615285e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271063e+02 3.91836375e+02
 2.35734679e+02 1.51996165e+02 7.64339323e+01 6.53099990e+01
 1.00751973e+01 1.42874654e+01 2.70389243e+01 2.99576044e+01
 2.07294294e-01 7.76167646e-01 1.23741151e+00 2.96415315e+00
 2.84353174e+00 5.53233645e+00 3.68390565e+00 1.48891538e+01
 1.24501082e+01 6.82261395e+01 5.47853065e+01 4.34825006e+02
 3.29968483e-01 7.29583441e-01 1.14368715e+00 3.45039204e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998480038641473
cond(S) = 633.4643691618335
E1 = -183.5775050888926  E_coul = 55.07838412805042
init E= -128.499120960842
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773955423663634  LUMO = 0.449706744346715
  mo_energy =
[-3.25553348e+01 -1.85290117e+00 -7.73955424e-01 -7.73955424e-01
 -7.73955424e-01  4.49706744e-01  1.11459398e+00  1.11459398e+00
  1.11459398e+00  2.46855123e+00  5.77482001e+00  5.77482001e+00
  5.77482001e+00  9.06792589e+00  2.42091815e+01  2.42091815e+01
  2.42091815e+01  3.64996271e+01  1.19111276e+02  1.19111276e+02
  1.19111276e+02  1.40475832e+02  5.04408753e+02  1.87190196e+03
  8.00142549e+03  4.77688962e+04]
E1 = -182.10998418520794  E_coul = 53.58119016722781
cycle= 1 E= -128.52879401798  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462323
diis-c [-0.21374221  1.        ]
  HOMO = -0.879687706463806  LUMO = 0.435685527505721
  mo_energy =
[-3.28740442e+01 -1.96321874e+00 -8.79687706e-01 -8.79687706e-01
 -8.79687706e-01  4.35685528e-01  1.07638357e+00  1.07638357e+00
  1.07638357e+00  2.41736169e+00  5.64583303e+00  5.64583303e+00
  5.64583303e+00  8.93992288e+00  2.39741266e+01  2.39741266e+01
  2.39741266e+01  3.62587369e+01  1.18790300e+02  1.18790300e+02
  1.18790300e+02  1.40162783e+02  5.04051409e+02  1.87150850e+03
  8.00100298e+03  4.77684548e+04]
E1 = -182.84246794059587  E_coul = 54.31116729333654
cycle= 2 E= -128.531300647259  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231057
diis-c [-6.09943540e-04  3.32274469e-01  6.67725531e-01]
  HOMO = -0.84531860178945  LUMO = 0.44032983724548
  mo_energy =
[-3.27690060e+01 -1.92708724e+00 -8.45318602e-01 -8.45318602e-01
 -8.45318602e-01  4.40329837e-01  1.08887410e+00  1.08887410e+00
  1.08887410e+00  2.43385977e+00  5.68776509e+00  5.68776509e+00
  5.68776509e+00  8.98159455e+00  2.40517035e+01  2.40517035e+01
  2.40517035e+01  3.63384768e+01  1.18895366e+02  1.18895366e+02
  1.18895366e+02  1.40265726e+02  5.04165048e+02  1.87162734e+03
  8.00112425e+03  4.77685770e+04]
E1 = -182.5968548311278  E_coul = 54.064705933072226
cycle= 3 E= -128.532148898056  delta_E= -0.000848  |g|= 0.000456  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000922293
diis-c [-2.24451350e-07 -2.35269899e-03 -1.29313529e-03  1.00364583e+00]
  HOMO = -0.845551171372121  LUMO = 0.440312825515536
  mo_energy =
[-3.27694041e+01 -1.92725293e+00 -8.45551171e-01 -8.45551171e-01
 -8.45551171e-01  4.40312826e-01  1.08882366e+00  1.08882366e+00
  1.08882366e+00  2.43378001e+00  5.68756413e+00  5.68756413e+00
  5.68756413e+00  8.98139945e+00  2.40513881e+01  2.40513881e+01
  2.40513881e+01  3.63381646e+01  1.18894956e+02  1.18894956e+02
  1.18894956e+02  1.40265328e+02  5.04164549e+02  1.87162673e+03
  8.00112355e+03  4.77685763e+04]
E1 = -182.59731872298906  E_coul = 54.065169803538936
cycle= 4 E= -128.53214891945  delta_E= -2.14e-08  |g|= 6.16e-05  |ddm|= 0.000225
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000129935
diis-c [-1.02483559e-09  3.36532158e-04  4.21673656e-04 -2.18864431e-01
  1.21810623e+00]
  HOMO = -0.845582159439471  LUMO = 0.440309597499824
  mo_energy =
[-3.27694516e+01 -1.92727055e+00 -8.45582159e-01 -8.45582159e-01
 -8.45582159e-01  4.40309597e-01  1.08881033e+00  1.08881033e+00
  1.08881033e+00  2.43376661e+00  5.68753016e+00  5.68753016e+00
  5.68753016e+00  8.98136923e+00  2.40513443e+01  2.40513443e+01
  2.40513443e+01  3.63381219e+01  1.18894908e+02  1.18894908e+02
  1.18894908e+02  1.40265280e+02  5.04164494e+02  1.87162666e+03
  8.00112348e+03  4.77685762e+04]
E1 = -182.5974086959349  E_coul = 54.065259775904735
cycle= 5 E= -128.53214892003  delta_E= -5.8e-10  |g|= 6.82e-06  |ddm|= 4.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5974086959349  E_coul = 54.065259775904735
  HOMO = -0.845578381140829  LUMO = 0.440310411741648
  mo_energy =
[-3.27694434e+01 -1.92726605e+00 -8.45578381e-01 -8.45578381e-01
 -8.45578381e-01  4.40310412e-01  1.08881191e+00  1.08881191e+00
  1.08881191e+00  2.43376903e+00  5.68753476e+00  5.68753476e+00
  5.68753476e+00  8.98137409e+00  2.40513514e+01  2.40513514e+01
  2.40513514e+01  3.63381292e+01  1.18894916e+02  1.18894916e+02
  1.18894916e+02  1.40265288e+02  5.04164502e+02  1.87162667e+03
  8.00112349e+03  4.77685762e+04]
E1 = -182.5973904910767  E_coul = 54.06524157104394
Extra cycle  E= -128.532148920033  delta_E= -2.61e-12  |g|= 2.54e-06  |ddm|= 2.27e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 633.4643691618335
E1 = -182.5973904910767  E_coul = 54.06524157104394
init E= -128.532148920033
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845579654733684  LUMO = 0.440310280621281
  mo_energy =
[-3.27694474e+01 -1.92726727e+00 -8.45579655e-01 -8.45579655e-01
 -8.45579655e-01  4.40310281e-01  1.08881147e+00  1.08881147e+00
  1.08881147e+00  2.43376850e+00  5.68753321e+00  5.68753321e+00
  5.68753321e+00  8.98137260e+00  2.40513484e+01  2.40513484e+01
  2.40513484e+01  3.63381262e+01  1.18894912e+02  1.18894912e+02
  1.18894912e+02  1.40265284e+02  5.04164497e+02  1.87162667e+03
  8.00112348e+03  4.77685762e+04]
E1 = -182.59740028098747  E_coul = 54.0652513609543
cycle= 1 E= -128.532148920033  delta_E= -3.98e-13  |g|= 1.34e-06  |ddm|= 9.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59740028098747  E_coul = 54.0652513609543
  HOMO = -0.845578966497366  LUMO = 0.440310380468931
  mo_energy =
[-3.27694454e+01 -1.92726652e+00 -8.45578966e-01 -8.45578966e-01
 -8.45578966e-01  4.40310380e-01  1.08881172e+00  1.08881172e+00
  1.08881172e+00  2.43376885e+00  5.68753405e+00  5.68753405e+00
  5.68753405e+00  8.98137345e+00  2.40513500e+01  2.40513500e+01
  2.40513500e+01  3.63381278e+01  1.18894914e+02  1.18894914e+02
  1.18894914e+02  1.40265286e+02  5.04164499e+02  1.87162667e+03
  8.00112348e+03  4.77685762e+04]
E1 = -182.5973954130244  E_coul = 54.06524649299108
Extra cycle  E= -128.532148920033  delta_E= -1.42e-13  |g|= 6.62e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [4.92868740e-01 2.44137941e+04 3.66145447e+03 8.33271063e+02
 2.35734679e+02 7.64339323e+01 1.00751973e+01 2.70389243e+01
 2.07294294e-01 1.23741151e+00 2.84353174e+00 3.68390565e+00
 1.24501082e+01 5.47853065e+01 3.29968483e-01 1.14368715e+00]
grad_E = [-8.72386317e-04  2.13764229e-10 -1.11921868e-08  2.30904851e-07
 -2.77279441e-06  1.81535110e-05 -1.02075602e-04 -2.72406927e-05
  1.83639851e-04 -1.61232889e-06 -1.86230557e-04 -8.47811874e-05
  1.54732910e-05 -6.82121135e-07 -8.58373564e-04  3.92887925e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.499819773329       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271055831        1
[INPUT] 0    0    [1    /1   ]  235.734766582        1
[INPUT] 0    0    [1    /1   ]  76.4333443873        1
[INPUT] 0    0    [1    /1   ]  10.0765820106        1
[INPUT] 0    0    [1    /1   ]  27.0401447897        1
[INPUT] 0    0    [1    /1   ]  0.215066019506       1
[INPUT] 0    0    [1    /1   ]  1.24998813589        1
[INPUT] 0    0    [1    /1   ]  2.84655023224        1
[INPUT] 1    0    [1    /1   ]  3.68361483889        1
[INPUT] 1    0    [1    /1   ]  12.449993741         1
[INPUT] 1    0    [1    /1   ]  54.7853138552        1
[INPUT] 1    0    [1    /1   ]  0.329887678541       1
[INPUT] 1    0    [1    /1   ]  1.14369270182        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.4998197733290323, 1.0]], [0, [24413.79412999055, 1.0]], [0, [3661.454469992734, 1.0]], [0, [833.2710558310274, 1.0]], [0, [235.73476658164714, 1.0]], [0, [76.43334438730817, 1.0]], [0, [10.076582010598246, 1.0]], [0, [27.040144789691887, 1.0]], [0, [0.21506601950626386, 1.0]], [0, [1.249988135893558, 1.0]], [0, [2.8465502322380583, 1.0]], [1, [3.683614838888312, 1.0]], [1, [12.449993740981384, 1.0]], [1, [54.78531385524945, 1.0]], [1, [0.3298876785411453, 1.0]], [1, [1.143692701815435, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49981977]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446999]
bas 3, expnt(s) = [833.27105583]
bas 4, expnt(s) = [235.73476658]
bas 5, expnt(s) = [76.43334439]
bas 6, expnt(s) = [10.07658201]
bas 7, expnt(s) = [27.04014479]
bas 8, expnt(s) = [0.21506602]
bas 9, expnt(s) = [1.24998814]
bas 10, expnt(s) = [2.84655023]
bas 11, expnt(s) = [3.68361484]
bas 12, expnt(s) = [12.44999374]
bas 13, expnt(s) = [54.78531386]
bas 14, expnt(s) = [0.32988768]
bas 15, expnt(s) = [1.1436927]
CPU time:        41.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.99819773e-01 1.50184495e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271056e+02 3.91836372e+02
 2.35734767e+02 1.51996208e+02 7.64333444e+01 6.53096222e+01
 1.00765820e+01 1.42889382e+01 2.70401448e+01 2.99586186e+01
 2.15066020e-01 7.97891562e-01 1.24998814e+00 2.98671953e+00
 2.84655023e+00 5.53674043e+00 3.68361484e+00 1.48876846e+01
 1.24499937e+01 6.82253558e+01 5.47853139e+01 4.34825079e+02
 3.29887679e-01 7.29360116e-01 1.14369270e+00 3.45041299e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998481030623015
cond(S) = 663.3515707818458
E1 = -183.57747818429485  E_coul = 55.078355141354606
init E= -128.49912304294
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773957531797062  LUMO = 0.466032049313888
  mo_energy =
[-3.25553446e+01 -1.85290145e+00 -7.73957532e-01 -7.73957532e-01
 -7.73957532e-01  4.66032049e-01  1.11435707e+00  1.11435707e+00
  1.11435707e+00  2.52578132e+00  5.77434085e+00  5.77434085e+00
  5.77434085e+00  9.17384536e+00  2.42079950e+01  2.42079950e+01
  2.42079950e+01  3.66304080e+01  1.19109891e+02  1.19109891e+02
  1.19109891e+02  1.40601047e+02  5.04522243e+02  1.87200345e+03
  8.00151471e+03  4.77689700e+04]
E1 = -182.10967313481365  E_coul = 53.580875526030404
cycle= 1 E= -128.528797608783  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462454
diis-c [-0.21386409  1.        ]
  HOMO = -0.879712187735797  LUMO = 0.451461153823486
  mo_energy =
[-3.28741028e+01 -1.96324627e+00 -8.79712188e-01 -8.79712188e-01
 -8.79712188e-01  4.51461154e-01  1.07614225e+00  1.07614225e+00
  1.07614225e+00  2.47399020e+00  5.64532982e+00  5.64532982e+00
  5.64532982e+00  9.04556221e+00  2.39728982e+01  2.39728982e+01
  2.39728982e+01  3.63895407e+01  1.18788867e+02  1.18788867e+02
  1.18788867e+02  1.40287979e+02  5.04164852e+02  1.87160993e+03
  8.00109214e+03  4.77685286e+04]
E1 = -182.84223916842757  E_coul = 54.31093461257973
cycle= 2 E= -128.531304555848  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0685
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231122
diis-c [-6.10128331e-04  3.32274119e-01  6.67725881e-01]
  HOMO = -0.845339247796718  LUMO = 0.456279886850954
  mo_energy =
[-3.27690528e+01 -1.92711051e+00 -8.45339248e-01 -8.45339248e-01
 -8.45339248e-01  4.56279887e-01  1.08863264e+00  1.08863264e+00
  1.08863264e+00  2.49067789e+00  5.68726547e+00  5.68726547e+00
  5.68726547e+00  9.08732193e+00  2.40504834e+01  2.40504834e+01
  2.40504834e+01  3.64692702e+01  1.18893945e+02  1.18893945e+02
  1.18893945e+02  1.40390923e+02  5.04278502e+02  1.87172878e+03
  8.00121342e+03  4.77686508e+04]
E1 = -182.59657279159947  E_coul = 54.06441972252371
cycle= 3 E= -128.532153069076  delta_E= -0.000849  |g|= 0.000458  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000925605
diis-c [-2.19258764e-07 -2.34552773e-03 -1.24798419e-03  1.00359351e+00]
  HOMO = -0.845573342545513  LUMO = 0.456261818993366
  mo_energy =
[-3.27694538e+01 -1.92727809e+00 -8.45573343e-01 -8.45573343e-01
 -8.45573343e-01  4.56261819e-01  1.08858161e+00  1.08858161e+00
  1.08858161e+00  2.49059595e+00  5.68706267e+00  5.68706267e+00
  5.68706267e+00  9.08712436e+00  2.40501654e+01  2.40501654e+01
  2.40501654e+01  3.64689555e+01  1.18893532e+02  1.18893532e+02
  1.18893532e+02  1.40390522e+02  5.04278000e+02  1.87172817e+03
  8.00121272e+03  4.77686500e+04]
E1 = -182.59704204690343  E_coul = 54.064888956397084
cycle= 4 E= -128.532153090506  delta_E= -2.14e-08  |g|= 6.17e-05  |ddm|= 0.000231
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000129722
diis-c [-1.02436667e-09  3.36201332e-04  4.18683875e-04 -2.18558248e-01
  1.21780336e+00]
  HOMO = -0.845604464866045  LUMO = 0.456258423822776
  mo_energy =
[-3.27695016e+01 -1.92729593e+00 -8.45604465e-01 -8.45604465e-01
 -8.45604465e-01  4.56258424e-01  1.08856824e+00  1.08856824e+00
  1.08856824e+00  2.49058226e+00  5.68702854e+00  5.68702854e+00
  5.68702854e+00  9.08709387e+00  2.40501214e+01  2.40501214e+01
  2.40501214e+01  3.64689125e+01  1.18893483e+02  1.18893483e+02
  1.18893483e+02  1.40390474e+02  5.04277944e+02  1.87172811e+03
  8.00121265e+03  4.77686500e+04]
E1 = -182.59713258175404  E_coul = 54.06497949067124
cycle= 5 E= -128.532153091083  delta_E= -5.76e-10  |g|= 6.83e-06  |ddm|= 4.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59713258175404  E_coul = 54.06497949067124
  HOMO = -0.845600678083069  LUMO = 0.45625926837575
  mo_energy =
[-3.27694933e+01 -1.92729142e+00 -8.45600678e-01 -8.45600678e-01
 -8.45600678e-01  4.56259268e-01  1.08856982e+00  1.08856982e+00
  1.08856982e+00  2.49058471e+00  5.68703314e+00  5.68703314e+00
  5.68703314e+00  9.08709874e+00  2.40501285e+01  2.40501285e+01
  2.40501285e+01  3.64689198e+01  1.18893491e+02  1.18893491e+02
  1.18893491e+02  1.40390482e+02  5.04277952e+02  1.87172811e+03
  8.00121266e+03  4.77686500e+04]
E1 = -182.59711434914178  E_coul = 54.064961258055995
Extra cycle  E= -128.532153091086  delta_E= -2.98e-12  |g|= 2.55e-06  |ddm|= 2.25e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [4.99819773e-01 2.44137941e+04 3.66145447e+03 8.33271056e+02
 2.35734767e+02 7.64333444e+01 1.00765820e+01 2.70401448e+01
 2.15066020e-01 1.24998814e+00 2.84655023e+00 3.68361484e+00
 1.24499937e+01 5.47853139e+01 3.29887679e-01 1.14369270e+00]
E = -128.53215309108577
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.499819773329       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45446999        1
[INPUT] 0    0    [1    /1   ]  833.271055831        1
[INPUT] 0    0    [1    /1   ]  235.734766582        1
[INPUT] 0    0    [1    /1   ]  76.4333443873        1
[INPUT] 0    0    [1    /1   ]  10.0765820106        1
[INPUT] 0    0    [1    /1   ]  27.0401447897        1
[INPUT] 0    0    [1    /1   ]  0.215066019506       1
[INPUT] 0    0    [1    /1   ]  1.24998813589        1
[INPUT] 0    0    [1    /1   ]  2.84655023224        1
[INPUT] 1    0    [1    /1   ]  3.68361483889        1
[INPUT] 1    0    [1    /1   ]  12.449993741         1
[INPUT] 1    0    [1    /1   ]  54.7853138552        1
[INPUT] 1    0    [1    /1   ]  0.329887678541       1
[INPUT] 1    0    [1    /1   ]  1.14369270182        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.4998197733290323, 1.0]], [0, [24413.79412999055, 1.0]], [0, [3661.454469992734, 1.0]], [0, [833.2710558310274, 1.0]], [0, [235.73476658164714, 1.0]], [0, [76.43334438730817, 1.0]], [0, [10.076582010598246, 1.0]], [0, [27.040144789691887, 1.0]], [0, [0.21506601950626386, 1.0]], [0, [1.249988135893558, 1.0]], [0, [2.8465502322380583, 1.0]], [1, [3.683614838888312, 1.0]], [1, [12.449993740981384, 1.0]], [1, [54.78531385524945, 1.0]], [1, [0.3298876785411453, 1.0]], [1, [1.143692701815435, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49981977]
bas 1, expnt(s) = [24413.79412999]
bas 2, expnt(s) = [3661.45446999]
bas 3, expnt(s) = [833.27105583]
bas 4, expnt(s) = [235.73476658]
bas 5, expnt(s) = [76.43334439]
bas 6, expnt(s) = [10.07658201]
bas 7, expnt(s) = [27.04014479]
bas 8, expnt(s) = [0.21506602]
bas 9, expnt(s) = [1.24998814]
bas 10, expnt(s) = [2.84655023]
bas 11, expnt(s) = [3.68361484]
bas 12, expnt(s) = [12.44999374]
bas 13, expnt(s) = [54.78531386]
bas 14, expnt(s) = [0.32988768]
bas 15, expnt(s) = [1.1436927]
CPU time:        42.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.99819773e-01 1.50184495e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271056e+02 3.91836372e+02
 2.35734767e+02 1.51996208e+02 7.64333444e+01 6.53096222e+01
 1.00765820e+01 1.42889382e+01 2.70401448e+01 2.99586186e+01
 2.15066020e-01 7.97891562e-01 1.24998814e+00 2.98671953e+00
 2.84655023e+00 5.53674043e+00 3.68361484e+00 1.48876846e+01
 1.24499937e+01 6.82253558e+01 5.47853139e+01 4.34825079e+02
 3.29887679e-01 7.29360116e-01 1.14369270e+00 3.45041299e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998481030623015
cond(S) = 663.3515707818458
E1 = -183.57747818429485  E_coul = 55.078355141354606
init E= -128.49912304294
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773957531797062  LUMO = 0.466032049313888
  mo_energy =
[-3.25553446e+01 -1.85290145e+00 -7.73957532e-01 -7.73957532e-01
 -7.73957532e-01  4.66032049e-01  1.11435707e+00  1.11435707e+00
  1.11435707e+00  2.52578132e+00  5.77434085e+00  5.77434085e+00
  5.77434085e+00  9.17384536e+00  2.42079950e+01  2.42079950e+01
  2.42079950e+01  3.66304080e+01  1.19109891e+02  1.19109891e+02
  1.19109891e+02  1.40601047e+02  5.04522243e+02  1.87200345e+03
  8.00151471e+03  4.77689700e+04]
E1 = -182.10967313481365  E_coul = 53.580875526030404
cycle= 1 E= -128.528797608783  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462454
diis-c [-0.21386409  1.        ]
  HOMO = -0.879712187735797  LUMO = 0.451461153823486
  mo_energy =
[-3.28741028e+01 -1.96324627e+00 -8.79712188e-01 -8.79712188e-01
 -8.79712188e-01  4.51461154e-01  1.07614225e+00  1.07614225e+00
  1.07614225e+00  2.47399020e+00  5.64532982e+00  5.64532982e+00
  5.64532982e+00  9.04556221e+00  2.39728982e+01  2.39728982e+01
  2.39728982e+01  3.63895407e+01  1.18788867e+02  1.18788867e+02
  1.18788867e+02  1.40287979e+02  5.04164852e+02  1.87160993e+03
  8.00109214e+03  4.77685286e+04]
E1 = -182.84223916842757  E_coul = 54.31093461257973
cycle= 2 E= -128.531304555848  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0685
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231122
diis-c [-6.10128331e-04  3.32274119e-01  6.67725881e-01]
  HOMO = -0.845339247796718  LUMO = 0.456279886850954
  mo_energy =
[-3.27690528e+01 -1.92711051e+00 -8.45339248e-01 -8.45339248e-01
 -8.45339248e-01  4.56279887e-01  1.08863264e+00  1.08863264e+00
  1.08863264e+00  2.49067789e+00  5.68726547e+00  5.68726547e+00
  5.68726547e+00  9.08732193e+00  2.40504834e+01  2.40504834e+01
  2.40504834e+01  3.64692702e+01  1.18893945e+02  1.18893945e+02
  1.18893945e+02  1.40390923e+02  5.04278502e+02  1.87172878e+03
  8.00121342e+03  4.77686508e+04]
E1 = -182.59657279159947  E_coul = 54.06441972252371
cycle= 3 E= -128.532153069076  delta_E= -0.000849  |g|= 0.000458  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000925605
diis-c [-2.19258764e-07 -2.34552773e-03 -1.24798419e-03  1.00359351e+00]
  HOMO = -0.845573342545513  LUMO = 0.456261818993366
  mo_energy =
[-3.27694538e+01 -1.92727809e+00 -8.45573343e-01 -8.45573343e-01
 -8.45573343e-01  4.56261819e-01  1.08858161e+00  1.08858161e+00
  1.08858161e+00  2.49059595e+00  5.68706267e+00  5.68706267e+00
  5.68706267e+00  9.08712436e+00  2.40501654e+01  2.40501654e+01
  2.40501654e+01  3.64689555e+01  1.18893532e+02  1.18893532e+02
  1.18893532e+02  1.40390522e+02  5.04278000e+02  1.87172817e+03
  8.00121272e+03  4.77686500e+04]
E1 = -182.59704204690343  E_coul = 54.064888956397084
cycle= 4 E= -128.532153090506  delta_E= -2.14e-08  |g|= 6.17e-05  |ddm|= 0.000231
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000129722
diis-c [-1.02436667e-09  3.36201332e-04  4.18683875e-04 -2.18558248e-01
  1.21780336e+00]
  HOMO = -0.845604464866045  LUMO = 0.456258423822776
  mo_energy =
[-3.27695016e+01 -1.92729593e+00 -8.45604465e-01 -8.45604465e-01
 -8.45604465e-01  4.56258424e-01  1.08856824e+00  1.08856824e+00
  1.08856824e+00  2.49058226e+00  5.68702854e+00  5.68702854e+00
  5.68702854e+00  9.08709387e+00  2.40501214e+01  2.40501214e+01
  2.40501214e+01  3.64689125e+01  1.18893483e+02  1.18893483e+02
  1.18893483e+02  1.40390474e+02  5.04277944e+02  1.87172811e+03
  8.00121265e+03  4.77686500e+04]
E1 = -182.59713258175404  E_coul = 54.06497949067124
cycle= 5 E= -128.532153091083  delta_E= -5.76e-10  |g|= 6.83e-06  |ddm|= 4.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59713258175404  E_coul = 54.06497949067124
  HOMO = -0.845600678083069  LUMO = 0.45625926837575
  mo_energy =
[-3.27694933e+01 -1.92729142e+00 -8.45600678e-01 -8.45600678e-01
 -8.45600678e-01  4.56259268e-01  1.08856982e+00  1.08856982e+00
  1.08856982e+00  2.49058471e+00  5.68703314e+00  5.68703314e+00
  5.68703314e+00  9.08709874e+00  2.40501285e+01  2.40501285e+01
  2.40501285e+01  3.64689198e+01  1.18893491e+02  1.18893491e+02
  1.18893491e+02  1.40390482e+02  5.04277952e+02  1.87172811e+03
  8.00121266e+03  4.77686500e+04]
E1 = -182.59711434914178  E_coul = 54.064961258055995
Extra cycle  E= -128.532153091086  delta_E= -2.98e-12  |g|= 2.55e-06  |ddm|= 2.25e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 663.3515707818458
E1 = -182.59711434914178  E_coul = 54.064961258055995
init E= -128.532153091086
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845601953504324  LUMO = 0.456259131872338
  mo_energy =
[-3.27694974e+01 -1.92729264e+00 -8.45601954e-01 -8.45601954e-01
 -8.45601954e-01  4.56259132e-01  1.08856937e+00  1.08856937e+00
  1.08856937e+00  2.49058417e+00  5.68703159e+00  5.68703159e+00
  5.68703159e+00  9.08709724e+00  2.40501255e+01  2.40501255e+01
  2.40501255e+01  3.64689168e+01  1.18893487e+02  1.18893487e+02
  1.18893487e+02  1.40390478e+02  5.04277948e+02  1.87172811e+03
  8.00121265e+03  4.77686500e+04]
E1 = -182.5971241554172  E_coul = 54.06497106433091
cycle= 1 E= -128.532153091086  delta_E= -5.12e-13  |g|= 1.34e-06  |ddm|= 9.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5971241554172  E_coul = 54.06497106433091
  HOMO = -0.845601264097613  LUMO = 0.456259235598904
  mo_energy =
[-3.27694953e+01 -1.92729189e+00 -8.45601264e-01 -8.45601264e-01
 -8.45601264e-01  4.56259236e-01  1.08856963e+00  1.08856963e+00
  1.08856963e+00  2.49058452e+00  5.68703244e+00  5.68703244e+00
  5.68703244e+00  9.08709809e+00  2.40501271e+01  2.40501271e+01
  2.40501271e+01  3.64689184e+01  1.18893489e+02  1.18893489e+02
  1.18893489e+02  1.40390480e+02  5.04277950e+02  1.87172811e+03
  8.00121265e+03  4.77686500e+04]
E1 = -182.59711927893264  E_coul = 54.064966187846395
Extra cycle  E= -128.532153091086  delta_E= 5.68e-14  |g|= 6.64e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [4.99819773e-01 2.44137941e+04 3.66145447e+03 8.33271056e+02
 2.35734767e+02 7.64333444e+01 1.00765820e+01 2.70401448e+01
 2.15066020e-01 1.24998814e+00 2.84655023e+00 3.68361484e+00
 1.24499937e+01 5.47853139e+01 3.29887679e-01 1.14369270e+00]
grad_E = [-1.21523726e-03  1.91027244e-10 -9.99755538e-09  2.07066609e-07
 -2.49055677e-06  1.59470407e-05 -1.41206637e-04 -1.51193138e-05
  4.48547499e-04  2.11149394e-04 -2.20061696e-04 -1.63031835e-04
  2.52712069e-05 -1.03366015e-06 -1.53393158e-03  7.05109697e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.515901864715       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447073        1
[INPUT] 0    0    [1    /1   ]  833.271040753        1
[INPUT] 0    0    [1    /1   ]  235.734947881        1
[INPUT] 0    0    [1    /1   ]  76.4321361898        1
[INPUT] 0    0    [1    /1   ]  10.0803690946        1
[INPUT] 0    0    [1    /1   ]  27.0424427728        1
[INPUT] 0    0    [1    /1   ]  0.226979296879       1
[INPUT] 0    0    [1    /1   ]  1.27643813172        1
[INPUT] 0    0    [1    /1   ]  2.85263809345        1
[INPUT] 1    0    [1    /1   ]  3.6830757267         1
[INPUT] 1    0    [1    /1   ]  12.4497359812        1
[INPUT] 1    0    [1    /1   ]  54.7853300064        1
[INPUT] 1    0    [1    /1   ]  0.329790418258       1
[INPUT] 1    0    [1    /1   ]  1.14359533054        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5159018647148794, 1.0]], [0, [24413.79412997657, 1.0]], [0, [3661.4544707250384, 1.0]], [0, [833.2710407525299, 1.0]], [0, [235.7349478814587, 1.0]], [0, [76.43213618975017, 1.0]], [0, [10.080369094633475, 1.0]], [0, [27.042442772779435, 1.0]], [0, [0.22697929687884003, 1.0]], [0, [1.2764381317230227, 1.0]], [0, [2.852638093448247, 1.0]], [1, [3.683075726695916, 1.0]], [1, [12.449735981209487, 1.0]], [1, [54.785330006389984, 1.0]], [1, [0.32979041825783506, 1.0]], [1, [1.1435953305390996, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.51590186]
bas 1, expnt(s) = [24413.79412998]
bas 2, expnt(s) = [3661.45447073]
bas 3, expnt(s) = [833.27104075]
bas 4, expnt(s) = [235.73494788]
bas 5, expnt(s) = [76.43213619]
bas 6, expnt(s) = [10.08036909]
bas 7, expnt(s) = [27.04244277]
bas 8, expnt(s) = [0.2269793]
bas 9, expnt(s) = [1.27643813]
bas 10, expnt(s) = [2.85263809]
bas 11, expnt(s) = [3.68307573]
bas 12, expnt(s) = [12.44973598]
bas 13, expnt(s) = [54.78533001]
bas 14, expnt(s) = [0.32979042]
bas 15, expnt(s) = [1.14359533]
CPU time:        44.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.15901865e-01 1.53794338e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271041e+02 3.91836367e+02
 2.35734948e+02 1.51996295e+02 7.64321362e+01 6.53088479e+01
 1.00803691e+01 1.42929656e+01 2.70424428e+01 2.99605281e+01
 2.26979297e-01 8.30815727e-01 1.27643813e+00 3.03399494e+00
 2.85263809e+00 5.54561904e+00 3.68307573e+00 1.48849611e+01
 1.24497360e+01 6.82235901e+01 5.47853300e+01 4.34825240e+02
 3.29790418e-01 7.29091331e-01 1.14359533e+00 3.45004579e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998482947749078
cond(S) = 721.7339230083456
E1 = -183.57745172276503  E_coul = 55.07831970537126
init E= -128.499132017394
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773960176395705  LUMO = 0.49343253211839
  mo_energy =
[-3.25553575e+01 -1.85290221e+00 -7.73960176e-01 -7.73960176e-01
 -7.73960176e-01  4.93432532e-01  1.11403811e+00  1.11403811e+00
  1.11403811e+00  2.63178998e+00  5.77335501e+00  5.77335501e+00
  5.77335501e+00  9.38141398e+00  2.42055366e+01  2.42055366e+01
  2.42055366e+01  3.68931838e+01  1.19107024e+02  1.19107024e+02
  1.19107024e+02  1.40855252e+02  5.04753178e+02  1.87221006e+03
  8.00169636e+03  4.77691204e+04]
E1 = -182.1093855566217  E_coul = 53.58058042329904
cycle= 1 E= -128.528805133323  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462546
diis-c [-0.21394892  1.        ]
  HOMO = -0.879733372527367  LUMO = 0.477913878609754
  mo_energy =
[-3.28741655e+01 -1.96327182e+00 -8.79733373e-01 -8.79733373e-01
 -8.79733373e-01  4.77913879e-01  1.07582437e+00  1.07582437e+00
  1.07582437e+00  2.57878549e+00  5.64432970e+00  5.64432970e+00
  5.64432970e+00  9.25254739e+00  2.39703995e+01  2.39703995e+01
  2.39703995e+01  3.66523831e+01  1.18785950e+02  1.18785950e+02
  1.18785950e+02  1.40542191e+02  5.04395745e+02  1.87181648e+03
  8.00127372e+03  4.77686789e+04]
E1 = -182.84203235114842  E_coul = 54.31071995219406
cycle= 2 E= -128.531312398954  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0682
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231157
diis-c [-6.10543583e-04  3.32262908e-01  6.67737092e-01]
  HOMO = -0.845356025181255  LUMO = 0.483034261969047
  mo_energy =
[-3.27691025e+01 -1.92713119e+00 -8.45356025e-01 -8.45356025e-01
 -8.45356025e-01  4.83034262e-01  1.08831353e+00  1.08831353e+00
  1.08831353e+00  2.59586049e+00  5.68626745e+00  5.68626745e+00
  5.68626745e+00  9.29449758e+00  2.40479936e+01  2.40479936e+01
  2.40479936e+01  3.67320888e+01  1.18891041e+02  1.18891041e+02
  1.18891041e+02  1.40645128e+02  5.04509403e+02  1.87193534e+03
  8.00139501e+03  4.77688011e+04]
E1 = -182.59631093468764  E_coul = 54.0641497685488
cycle= 3 E= -128.532161166139  delta_E= -0.000849  |g|= 0.000462  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000930864
diis-c [-2.11157789e-07 -2.33186229e-03 -1.17174667e-03  1.00350361e+00]
  HOMO = -0.845591965278277  LUMO = 0.483014497517616
  mo_energy =
[-3.27695078e+01 -1.92730116e+00 -8.45591965e-01 -8.45591965e-01
 -8.45591965e-01  4.83014498e-01  1.08826181e+00  1.08826181e+00
  1.08826181e+00  2.59577500e+00  5.68606240e+00  5.68606240e+00
  5.68606240e+00  9.29429652e+00  2.40476721e+01  2.40476721e+01
  2.40476721e+01  3.67317705e+01  1.18890624e+02  1.18890624e+02
  1.18890624e+02  1.40644723e+02  5.04508896e+02  1.87193472e+03
  8.00139431e+03  4.77688003e+04]
E1 = -182.5967887361581  E_coul = 54.06462754854255
cycle= 4 E= -128.532161187616  delta_E= -2.15e-08  |g|= 6.18e-05  |ddm|= 0.000242
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00012949
diis-c [-1.02037341e-09  3.35198712e-04  4.14072658e-04 -2.18002821e-01
  1.21725355e+00]
  HOMO = -0.845623265650248  LUMO = 0.483010822706783
  mo_energy =
[-3.27695561e+01 -1.92731931e+00 -8.45623266e-01 -8.45623266e-01
 -8.45623266e-01  4.83010823e-01  1.08824838e+00  1.08824838e+00
  1.08824838e+00  2.59576081e+00  5.68602803e+00  5.68602803e+00
  5.68602803e+00  9.29426560e+00  2.40476277e+01  2.40476277e+01
  2.40476277e+01  3.67317271e+01  1.18890575e+02  1.18890575e+02
  1.18890575e+02  1.40644674e+02  5.04508840e+02  1.87193466e+03
  8.00139424e+03  4.77688003e+04]
E1 = -182.59688025287676  E_coul = 54.064719064690266
cycle= 5 E= -128.532161188186  delta_E= -5.71e-10  |g|= 6.83e-06  |ddm|= 4.69e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59688025287676  E_coul = 54.064719064690266
  HOMO = -0.845619477391928  LUMO = 0.483011717074896
  mo_energy =
[-3.27695478e+01 -1.92731480e+00 -8.45619477e-01 -8.45619477e-01
 -8.45619477e-01  4.83011717e-01  1.08824996e+00  1.08824996e+00
  1.08824996e+00  2.59576330e+00  5.68603264e+00  5.68603264e+00
  5.68603264e+00  9.29427048e+00  2.40476347e+01  2.40476347e+01
  2.40476347e+01  3.67317344e+01  1.18890583e+02  1.18890583e+02
  1.18890583e+02  1.40644682e+02  5.04508848e+02  1.87193466e+03
  8.00139425e+03  4.77688003e+04]
E1 = -182.59686201774787  E_coul = 54.064700829558625
Extra cycle  E= -128.532161188189  delta_E= -2.76e-12  |g|= 2.55e-06  |ddm|= 2.22e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [5.15901865e-01 2.44137941e+04 3.66145447e+03 8.33271041e+02
 2.35734948e+02 7.64321362e+01 1.00803691e+01 2.70424428e+01
 2.26979297e-01 1.27643813e+00 2.85263809e+00 3.68307573e+00
 1.24497360e+01 5.47853300e+01 3.29790418e-01 1.14359533e+00]
E = -128.53216118818924
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.515901864715       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447073        1
[INPUT] 0    0    [1    /1   ]  833.271040753        1
[INPUT] 0    0    [1    /1   ]  235.734947881        1
[INPUT] 0    0    [1    /1   ]  76.4321361898        1
[INPUT] 0    0    [1    /1   ]  10.0803690946        1
[INPUT] 0    0    [1    /1   ]  27.0424427728        1
[INPUT] 0    0    [1    /1   ]  0.226979296879       1
[INPUT] 0    0    [1    /1   ]  1.27643813172        1
[INPUT] 0    0    [1    /1   ]  2.85263809345        1
[INPUT] 1    0    [1    /1   ]  3.6830757267         1
[INPUT] 1    0    [1    /1   ]  12.4497359812        1
[INPUT] 1    0    [1    /1   ]  54.7853300064        1
[INPUT] 1    0    [1    /1   ]  0.329790418258       1
[INPUT] 1    0    [1    /1   ]  1.14359533054        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5159018647148794, 1.0]], [0, [24413.79412997657, 1.0]], [0, [3661.4544707250384, 1.0]], [0, [833.2710407525299, 1.0]], [0, [235.7349478814587, 1.0]], [0, [76.43213618975017, 1.0]], [0, [10.080369094633475, 1.0]], [0, [27.042442772779435, 1.0]], [0, [0.22697929687884003, 1.0]], [0, [1.2764381317230227, 1.0]], [0, [2.852638093448247, 1.0]], [1, [3.683075726695916, 1.0]], [1, [12.449735981209487, 1.0]], [1, [54.785330006389984, 1.0]], [1, [0.32979041825783506, 1.0]], [1, [1.1435953305390996, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.51590186]
bas 1, expnt(s) = [24413.79412998]
bas 2, expnt(s) = [3661.45447073]
bas 3, expnt(s) = [833.27104075]
bas 4, expnt(s) = [235.73494788]
bas 5, expnt(s) = [76.43213619]
bas 6, expnt(s) = [10.08036909]
bas 7, expnt(s) = [27.04244277]
bas 8, expnt(s) = [0.2269793]
bas 9, expnt(s) = [1.27643813]
bas 10, expnt(s) = [2.85263809]
bas 11, expnt(s) = [3.68307573]
bas 12, expnt(s) = [12.44973598]
bas 13, expnt(s) = [54.78533001]
bas 14, expnt(s) = [0.32979042]
bas 15, expnt(s) = [1.14359533]
CPU time:        45.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.15901865e-01 1.53794338e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920096e+03 8.33271041e+02 3.91836367e+02
 2.35734948e+02 1.51996295e+02 7.64321362e+01 6.53088479e+01
 1.00803691e+01 1.42929656e+01 2.70424428e+01 2.99605281e+01
 2.26979297e-01 8.30815727e-01 1.27643813e+00 3.03399494e+00
 2.85263809e+00 5.54561904e+00 3.68307573e+00 1.48849611e+01
 1.24497360e+01 6.82235901e+01 5.47853300e+01 4.34825240e+02
 3.29790418e-01 7.29091331e-01 1.14359533e+00 3.45004579e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998482947749078
cond(S) = 721.7339230083456
E1 = -183.57745172276503  E_coul = 55.07831970537126
init E= -128.499132017394
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773960176395705  LUMO = 0.49343253211839
  mo_energy =
[-3.25553575e+01 -1.85290221e+00 -7.73960176e-01 -7.73960176e-01
 -7.73960176e-01  4.93432532e-01  1.11403811e+00  1.11403811e+00
  1.11403811e+00  2.63178998e+00  5.77335501e+00  5.77335501e+00
  5.77335501e+00  9.38141398e+00  2.42055366e+01  2.42055366e+01
  2.42055366e+01  3.68931838e+01  1.19107024e+02  1.19107024e+02
  1.19107024e+02  1.40855252e+02  5.04753178e+02  1.87221006e+03
  8.00169636e+03  4.77691204e+04]
E1 = -182.1093855566217  E_coul = 53.58058042329904
cycle= 1 E= -128.528805133323  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462546
diis-c [-0.21394892  1.        ]
  HOMO = -0.879733372527367  LUMO = 0.477913878609754
  mo_energy =
[-3.28741655e+01 -1.96327182e+00 -8.79733373e-01 -8.79733373e-01
 -8.79733373e-01  4.77913879e-01  1.07582437e+00  1.07582437e+00
  1.07582437e+00  2.57878549e+00  5.64432970e+00  5.64432970e+00
  5.64432970e+00  9.25254739e+00  2.39703995e+01  2.39703995e+01
  2.39703995e+01  3.66523831e+01  1.18785950e+02  1.18785950e+02
  1.18785950e+02  1.40542191e+02  5.04395745e+02  1.87181648e+03
  8.00127372e+03  4.77686789e+04]
E1 = -182.84203235114842  E_coul = 54.31071995219406
cycle= 2 E= -128.531312398954  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0682
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231157
diis-c [-6.10543583e-04  3.32262908e-01  6.67737092e-01]
  HOMO = -0.845356025181255  LUMO = 0.483034261969047
  mo_energy =
[-3.27691025e+01 -1.92713119e+00 -8.45356025e-01 -8.45356025e-01
 -8.45356025e-01  4.83034262e-01  1.08831353e+00  1.08831353e+00
  1.08831353e+00  2.59586049e+00  5.68626745e+00  5.68626745e+00
  5.68626745e+00  9.29449758e+00  2.40479936e+01  2.40479936e+01
  2.40479936e+01  3.67320888e+01  1.18891041e+02  1.18891041e+02
  1.18891041e+02  1.40645128e+02  5.04509403e+02  1.87193534e+03
  8.00139501e+03  4.77688011e+04]
E1 = -182.59631093468764  E_coul = 54.0641497685488
cycle= 3 E= -128.532161166139  delta_E= -0.000849  |g|= 0.000462  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000930864
diis-c [-2.11157789e-07 -2.33186229e-03 -1.17174667e-03  1.00350361e+00]
  HOMO = -0.845591965278277  LUMO = 0.483014497517616
  mo_energy =
[-3.27695078e+01 -1.92730116e+00 -8.45591965e-01 -8.45591965e-01
 -8.45591965e-01  4.83014498e-01  1.08826181e+00  1.08826181e+00
  1.08826181e+00  2.59577500e+00  5.68606240e+00  5.68606240e+00
  5.68606240e+00  9.29429652e+00  2.40476721e+01  2.40476721e+01
  2.40476721e+01  3.67317705e+01  1.18890624e+02  1.18890624e+02
  1.18890624e+02  1.40644723e+02  5.04508896e+02  1.87193472e+03
  8.00139431e+03  4.77688003e+04]
E1 = -182.5967887361581  E_coul = 54.06462754854255
cycle= 4 E= -128.532161187616  delta_E= -2.15e-08  |g|= 6.18e-05  |ddm|= 0.000242
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00012949
diis-c [-1.02037341e-09  3.35198712e-04  4.14072658e-04 -2.18002821e-01
  1.21725355e+00]
  HOMO = -0.845623265650248  LUMO = 0.483010822706783
  mo_energy =
[-3.27695561e+01 -1.92731931e+00 -8.45623266e-01 -8.45623266e-01
 -8.45623266e-01  4.83010823e-01  1.08824838e+00  1.08824838e+00
  1.08824838e+00  2.59576081e+00  5.68602803e+00  5.68602803e+00
  5.68602803e+00  9.29426560e+00  2.40476277e+01  2.40476277e+01
  2.40476277e+01  3.67317271e+01  1.18890575e+02  1.18890575e+02
  1.18890575e+02  1.40644674e+02  5.04508840e+02  1.87193466e+03
  8.00139424e+03  4.77688003e+04]
E1 = -182.59688025287676  E_coul = 54.064719064690266
cycle= 5 E= -128.532161188186  delta_E= -5.71e-10  |g|= 6.83e-06  |ddm|= 4.69e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59688025287676  E_coul = 54.064719064690266
  HOMO = -0.845619477391928  LUMO = 0.483011717074896
  mo_energy =
[-3.27695478e+01 -1.92731480e+00 -8.45619477e-01 -8.45619477e-01
 -8.45619477e-01  4.83011717e-01  1.08824996e+00  1.08824996e+00
  1.08824996e+00  2.59576330e+00  5.68603264e+00  5.68603264e+00
  5.68603264e+00  9.29427048e+00  2.40476347e+01  2.40476347e+01
  2.40476347e+01  3.67317344e+01  1.18890583e+02  1.18890583e+02
  1.18890583e+02  1.40644682e+02  5.04508848e+02  1.87193466e+03
  8.00139425e+03  4.77688003e+04]
E1 = -182.59686201774787  E_coul = 54.064700829558625
Extra cycle  E= -128.532161188189  delta_E= -2.76e-12  |g|= 2.55e-06  |ddm|= 2.22e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 721.7339230083456
E1 = -182.59686201774787  E_coul = 54.064700829558625
init E= -128.532161188189
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845620752962453  LUMO = 0.483011571597405
  mo_energy =
[-3.27695519e+01 -1.92731602e+00 -8.45620753e-01 -8.45620753e-01
 -8.45620753e-01  4.83011572e-01  1.08824951e+00  1.08824951e+00
  1.08824951e+00  2.59576275e+00  5.68603109e+00  5.68603109e+00
  5.68603109e+00  9.29426898e+00  2.40476318e+01  2.40476318e+01
  2.40476318e+01  3.67317313e+01  1.18890579e+02  1.18890579e+02
  1.18890579e+02  1.40644678e+02  5.04508844e+02  1.87193466e+03
  8.00139424e+03  4.77688003e+04]
E1 = -182.59687182674227  E_coul = 54.064710638552505
cycle= 1 E= -128.53216118819  delta_E= -5.4e-13  |g|= 1.34e-06  |ddm|= 9.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59687182674227  E_coul = 54.064710638552505
  HOMO = -0.84562006335606  LUMO = 0.483011681788158
  mo_energy =
[-3.27695498e+01 -1.92731527e+00 -8.45620063e-01 -8.45620063e-01
 -8.45620063e-01  4.83011682e-01  1.08824977e+00  1.08824977e+00
  1.08824977e+00  2.59576311e+00  5.68603193e+00  5.68603193e+00
  5.68603193e+00  9.29426984e+00  2.40476333e+01  2.40476333e+01
  2.40476333e+01  3.67317329e+01  1.18890581e+02  1.18890581e+02
  1.18890581e+02  1.40644680e+02  5.04508846e+02  1.87193466e+03
  8.00139424e+03  4.77688003e+04]
E1 = -182.59686694859874  E_coul = 54.06470576040875
Extra cycle  E= -128.53216118819  delta_E= -2.27e-13  |g|= 6.64e-07  |ddm|= 4.63e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [5.15901865e-01 2.44137941e+04 3.66145447e+03 8.33271041e+02
 2.35734948e+02 7.64321362e+01 1.00803691e+01 2.70424428e+01
 2.26979297e-01 1.27643813e+00 2.85263809e+00 3.68307573e+00
 1.24497360e+01 5.47853300e+01 3.29790418e-01 1.14359533e+00]
grad_E = [-1.51732895e-03  1.56728781e-10 -8.19599037e-09  1.71233092e-07
 -2.06933409e-06  1.26898548e-05 -2.01883929e-04  2.99995672e-06
  7.69019762e-04  4.35557746e-04 -2.56801358e-04 -2.44981277e-04
  3.69670978e-05 -1.45375494e-06 -2.17768102e-03  9.99992603e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.548184561411       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447211        1
[INPUT] 0    0    [1    /1   ]  833.271012188        1
[INPUT] 0    0    [1    /1   ]  235.735291998        1
[INPUT] 0    0    [1    /1   ]  76.4298675499        1
[INPUT] 0    0    [1    /1   ]  10.0896778842        1
[INPUT] 0    0    [1    /1   ]  27.0462505026        1
[INPUT] 0    0    [1    /1   ]  0.240360806595       1
[INPUT] 0    0    [1    /1   ]  1.33038322208        1
[INPUT] 0    0    [1    /1   ]  2.86307938762        1
[INPUT] 1    0    [1    /1   ]  3.68211544993        1
[INPUT] 1    0    [1    /1   ]  12.4492163162        1
[INPUT] 1    0    [1    /1   ]  54.7853619239        1
[INPUT] 1    0    [1    /1   ]  0.329677377115       1
[INPUT] 1    0    [1    /1   ]  1.14327081634        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5481845614112484, 1.0]], [0, [24413.794129950144, 1.0]], [0, [3661.4544721092398, 1.0]], [0, [833.2710121883945, 1.0]], [0, [235.7352919983856, 1.0]], [0, [76.42986754991938, 1.0]], [0, [10.089677884193406, 1.0]], [0, [27.046250502574, 1.0]], [0, [0.2403608065949693, 1.0]], [0, [1.3303832220804848, 1.0]], [0, [2.863079387624019, 1.0]], [1, [3.6821154499277857, 1.0]], [1, [12.449216316218248, 1.0]], [1, [54.785361923894165, 1.0]], [1, [0.3296773771153052, 1.0]], [1, [1.1432708163430876, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.54818456]
bas 1, expnt(s) = [24413.79412995]
bas 2, expnt(s) = [3661.45447211]
bas 3, expnt(s) = [833.27101219]
bas 4, expnt(s) = [235.735292]
bas 5, expnt(s) = [76.42986755]
bas 6, expnt(s) = [10.08967788]
bas 7, expnt(s) = [27.0462505]
bas 8, expnt(s) = [0.24036081]
bas 9, expnt(s) = [1.33038322]
bas 10, expnt(s) = [2.86307939]
bas 11, expnt(s) = [3.68211545]
bas 12, expnt(s) = [12.44921632]
bas 13, expnt(s) = [54.78536192]
bas 14, expnt(s) = [0.32967738]
bas 15, expnt(s) = [1.14327082]
CPU time:        47.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.48184561e-01 1.60957095e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920097e+03 8.33271012e+02 3.91836357e+02
 2.35735292e+02 1.51996462e+02 7.64298675e+01 6.53073940e+01
 1.00896779e+01 1.43028637e+01 2.70462505e+01 2.99636920e+01
 2.40360807e-01 8.67286854e-01 1.33038322e+00 3.12966313e+00
 2.86307939e+00 5.56083574e+00 3.68211545e+00 1.48801101e+01
 1.24492163e+01 6.82200305e+01 5.47853619e+01 4.34825556e+02
 3.29677377e-01 7.28778959e-01 1.14327082e+00 3.44882207e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487276907923
cond(S) = 823.1030732763078
E1 = -183.5774485966511  E_coul = 55.0782903594337
init E= -128.499158237217
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773962573029785  LUMO = 0.531105946256548
  mo_energy =
[-3.25553707e+01 -1.85290487e+00 -7.73962573e-01 -7.73962573e-01
 -7.73962573e-01  5.31105946e-01  1.11359910e+00  1.11359910e+00
  1.11359910e+00  2.80308277e+00  5.77141218e+00  5.77141218e+00
  5.77141218e+00  9.74745331e+00  2.42007580e+01  2.42007580e+01
  2.42007580e+01  3.73744556e+01  1.19101484e+02  1.19101484e+02
  1.19101484e+02  1.41327483e+02  5.05183493e+02  1.87259526e+03
  8.00203510e+03  4.77694007e+04]
E1 = -182.10915743300004  E_coul = 53.58033711911255
cycle= 1 E= -128.528820313887  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462455
diis-c [-0.2138643  1.       ]
  HOMO = -0.879748528297048  LUMO = 0.514210127649567
  mo_energy =
[-3.28742303e+01 -1.96329139e+00 -8.79748528e-01 -8.79748528e-01
 -8.79748528e-01  5.14210128e-01  1.07539459e+00  1.07539459e+00
  1.07539459e+00  2.74786180e+00  5.64239082e+00  5.64239082e+00
  5.64239082e+00  9.61740803e+00  2.39655851e+01  2.39655851e+01
  2.39655851e+01  3.71337612e+01  1.18780357e+02  1.18780357e+02
  1.18780357e+02  1.41014471e+02  5.04826024e+02  1.87220161e+03
  8.00161237e+03  4.77689592e+04]
E1 = -182.8419048027971  E_coul = 54.31057671469263
cycle= 2 E= -128.531328088104  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0679
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231087
diis-c [-6.11591623e-04  3.32237312e-01  6.67762688e-01]
  HOMO = -0.845364869445553  LUMO = 0.519769515333525
  mo_energy =
[-3.27691502e+01 -1.92714397e+00 -8.45364869e-01 -8.45364869e-01
 -8.45364869e-01  5.19769515e-01  1.08788088e+00  1.08788088e+00
  1.08788088e+00  2.76564976e+00  5.68432880e+00  5.68432880e+00
  5.68432880e+00  9.65975069e+00  2.40431907e+01  2.40431907e+01
  2.40431907e+01  3.72134318e+01  1.18885466e+02  1.18885466e+02
  1.18885466e+02  1.41117389e+02  5.04939690e+02  1.87232049e+03
  8.00173368e+03  4.77690814e+04]
E1 = -182.59612402711556  E_coul = 54.06394689764357
cycle= 3 E= -128.532177129472  delta_E= -0.000849  |g|= 0.000467  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000939306
diis-c [-2.02562639e-07 -2.31502820e-03 -1.07094870e-03  1.00338598e+00]
  HOMO = -0.845602794451246  LUMO = 0.519747388836297
  mo_energy =
[-3.27695612e+01 -1.92731642e+00 -8.45602794e-01 -8.45602794e-01
 -8.45602794e-01  5.19747389e-01  1.08782839e+00  1.08782839e+00
  1.08782839e+00  2.76555886e+00  5.68412133e+00  5.68412133e+00
  5.68412133e+00  9.65954498e+00  2.40428648e+01  2.40428648e+01
  2.40428648e+01  3.72131091e+01  1.18885043e+02  1.18885043e+02
  1.18885043e+02  1.41116979e+02  5.04939177e+02  1.87231986e+03
  8.00173297e+03  4.77690806e+04]
E1 = -182.5966133032172  E_coul = 54.06443615210717
cycle= 4 E= -128.53217715111  delta_E= -2.16e-08  |g|= 6.21e-05  |ddm|= 0.000254
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000129664
diis-c [-1.01272722e-09  3.33385838e-04  4.08250535e-04 -2.17255173e-01
  1.21651354e+00]
  HOMO = -0.845634339817572  LUMO = 0.519743313506909
  mo_energy =
[-3.27696101e+01 -1.92733494e+00 -8.45634340e-01 -8.45634340e-01
 -8.45634340e-01  5.19743314e-01  1.08781487e+00  1.08781487e+00
  1.08781487e+00  2.76554384e+00  5.68408666e+00  5.68408666e+00
  5.68408666e+00  9.65951341e+00  2.40428198e+01  2.40428198e+01
  2.40428198e+01  3.72130652e+01  1.18884994e+02  1.18884994e+02
  1.18884994e+02  1.41116929e+02  5.04939121e+02  1.87231980e+03
  8.00173290e+03  4.77690805e+04]
E1 = -182.59670628098766  E_coul = 54.064529129309015
cycle= 5 E= -128.532177151679  delta_E= -5.69e-10  |g|= 6.82e-06  |ddm|= 4.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59670628098766  E_coul = 54.064529129309015
  HOMO = -0.845630562591925  LUMO = 0.519744277764922
  mo_energy =
[-3.27696019e+01 -1.92733044e+00 -8.45630563e-01 -8.45630563e-01
 -8.45630563e-01  5.19744278e-01  1.08781645e+00  1.08781645e+00
  1.08781645e+00  2.76554642e+00  5.68409126e+00  5.68409126e+00
  5.68409126e+00  9.65951831e+00  2.40428269e+01  2.40428269e+01
  2.40428269e+01  3.72130724e+01  1.18885002e+02  1.18885002e+02
  1.18885002e+02  1.41116937e+02  5.04939128e+02  1.87231981e+03
  8.00173291e+03  4.77690806e+04]
E1 = -182.59668810078236  E_coul = 54.06451094910094
Extra cycle  E= -128.532177151681  delta_E= -2.79e-12  |g|= 2.54e-06  |ddm|= 2.21e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [5.48184561e-01 2.44137941e+04 3.66145447e+03 8.33271012e+02
 2.35735292e+02 7.64298675e+01 1.00896779e+01 2.70462505e+01
 2.40360807e-01 1.33038322e+00 2.86307939e+00 3.68211545e+00
 1.24492163e+01 5.47853619e+01 3.29677377e-01 1.14327082e+00]
E = -128.53217715168142
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.548184561411       1
[INPUT] 0    0    [1    /1   ]  24413.79413          1
[INPUT] 0    0    [1    /1   ]  3661.45447211        1
[INPUT] 0    0    [1    /1   ]  833.271012188        1
[INPUT] 0    0    [1    /1   ]  235.735291998        1
[INPUT] 0    0    [1    /1   ]  76.4298675499        1
[INPUT] 0    0    [1    /1   ]  10.0896778842        1
[INPUT] 0    0    [1    /1   ]  27.0462505026        1
[INPUT] 0    0    [1    /1   ]  0.240360806595       1
[INPUT] 0    0    [1    /1   ]  1.33038322208        1
[INPUT] 0    0    [1    /1   ]  2.86307938762        1
[INPUT] 1    0    [1    /1   ]  3.68211544993        1
[INPUT] 1    0    [1    /1   ]  12.4492163162        1
[INPUT] 1    0    [1    /1   ]  54.7853619239        1
[INPUT] 1    0    [1    /1   ]  0.329677377115       1
[INPUT] 1    0    [1    /1   ]  1.14327081634        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.5481845614112484, 1.0]], [0, [24413.794129950144, 1.0]], [0, [3661.4544721092398, 1.0]], [0, [833.2710121883945, 1.0]], [0, [235.7352919983856, 1.0]], [0, [76.42986754991938, 1.0]], [0, [10.089677884193406, 1.0]], [0, [27.046250502574, 1.0]], [0, [0.2403608065949693, 1.0]], [0, [1.3303832220804848, 1.0]], [0, [2.863079387624019, 1.0]], [1, [3.6821154499277857, 1.0]], [1, [12.449216316218248, 1.0]], [1, [54.785361923894165, 1.0]], [1, [0.3296773771153052, 1.0]], [1, [1.1432708163430876, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.54818456]
bas 1, expnt(s) = [24413.79412995]
bas 2, expnt(s) = [3661.45447211]
bas 3, expnt(s) = [833.27101219]
bas 4, expnt(s) = [235.735292]
bas 5, expnt(s) = [76.42986755]
bas 6, expnt(s) = [10.08967788]
bas 7, expnt(s) = [27.0462505]
bas 8, expnt(s) = [0.24036081]
bas 9, expnt(s) = [1.33038322]
bas 10, expnt(s) = [2.86307939]
bas 11, expnt(s) = [3.68211545]
bas 12, expnt(s) = [12.44921632]
bas 13, expnt(s) = [54.78536192]
bas 14, expnt(s) = [0.32967738]
bas 15, expnt(s) = [1.14327082]
CPU time:        47.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.48184561e-01 1.60957095e+00 2.44137941e+04 4.93448102e+03
 3.66145447e+03 1.18920097e+03 8.33271012e+02 3.91836357e+02
 2.35735292e+02 1.51996462e+02 7.64298675e+01 6.53073940e+01
 1.00896779e+01 1.43028637e+01 2.70462505e+01 2.99636920e+01
 2.40360807e-01 8.67286854e-01 1.33038322e+00 3.12966313e+00
 2.86307939e+00 5.56083574e+00 3.68211545e+00 1.48801101e+01
 1.24492163e+01 6.82200305e+01 5.47853619e+01 4.34825556e+02
 3.29677377e-01 7.28778959e-01 1.14327082e+00 3.44882207e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487276907923
cond(S) = 823.1030732763078
E1 = -183.5774485966511  E_coul = 55.0782903594337
init E= -128.499158237217
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.773962573029785  LUMO = 0.531105946256548
  mo_energy =
[-3.25553707e+01 -1.85290487e+00 -7.73962573e-01 -7.73962573e-01
 -7.73962573e-01  5.31105946e-01  1.11359910e+00  1.11359910e+00
  1.11359910e+00  2.80308277e+00  5.77141218e+00  5.77141218e+00
  5.77141218e+00  9.74745331e+00  2.42007580e+01  2.42007580e+01
  2.42007580e+01  3.73744556e+01  1.19101484e+02  1.19101484e+02
  1.19101484e+02  1.41327483e+02  5.05183493e+02  1.87259526e+03
  8.00203510e+03  4.77694007e+04]
E1 = -182.10915743300004  E_coul = 53.58033711911255
cycle= 1 E= -128.528820313887  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462455
diis-c [-0.2138643  1.       ]
  HOMO = -0.879748528297048  LUMO = 0.514210127649567
  mo_energy =
[-3.28742303e+01 -1.96329139e+00 -8.79748528e-01 -8.79748528e-01
 -8.79748528e-01  5.14210128e-01  1.07539459e+00  1.07539459e+00
  1.07539459e+00  2.74786180e+00  5.64239082e+00  5.64239082e+00
  5.64239082e+00  9.61740803e+00  2.39655851e+01  2.39655851e+01
  2.39655851e+01  3.71337612e+01  1.18780357e+02  1.18780357e+02
  1.18780357e+02  1.41014471e+02  5.04826024e+02  1.87220161e+03
  8.00161237e+03  4.77689592e+04]
E1 = -182.8419048027971  E_coul = 54.31057671469263
cycle= 2 E= -128.531328088104  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0679
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231087
diis-c [-6.11591623e-04  3.32237312e-01  6.67762688e-01]
  HOMO = -0.845364869445553  LUMO = 0.519769515333525
  mo_energy =
[-3.27691502e+01 -1.92714397e+00 -8.45364869e-01 -8.45364869e-01
 -8.45364869e-01  5.19769515e-01  1.08788088e+00  1.08788088e+00
  1.08788088e+00  2.76564976e+00  5.68432880e+00  5.68432880e+00
  5.68432880e+00  9.65975069e+00  2.40431907e+01  2.40431907e+01
  2.40431907e+01  3.72134318e+01  1.18885466e+02  1.18885466e+02
  1.18885466e+02  1.41117389e+02  5.04939690e+02  1.87232049e+03
  8.00173368e+03  4.77690814e+04]
E1 = -182.59612402711556  E_coul = 54.06394689764357
cycle= 3 E= -128.532177129472  delta_E= -0.000849  |g|= 0.000467  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000939306
diis-c [-2.02562639e-07 -2.31502820e-03 -1.07094870e-03  1.00338598e+00]
  HOMO = -0.845602794451246  LUMO = 0.519747388836297
  mo_energy =
[-3.27695612e+01 -1.92731642e+00 -8.45602794e-01 -8.45602794e-01
 -8.45602794e-01  5.19747389e-01  1.08782839e+00  1.08782839e+00
  1.08782839e+00  2.76555886e+00  5.68412133e+00  5.68412133e+00
  5.68412133e+00  9.65954498e+00  2.40428648e+01  2.40428648e+01
  2.40428648e+01  3.72131091e+01  1.18885043e+02  1.18885043e+02
  1.18885043e+02  1.41116979e+02  5.04939177e+02  1.87231986e+03
  8.00173297e+03  4.77690806e+04]
E1 = -182.5966133032172  E_coul = 54.06443615210717
cycle= 4 E= -128.53217715111  delta_E= -2.16e-08  |g|= 6.21e-05  |ddm|= 0.000254
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000129664
diis-c [-1.01272722e-09  3.33385838e-04  4.08250535e-04 -2.17255173e-01
  1.21651354e+00]
  HOMO = -0.845634339817572  LUMO = 0.519743313506909
  mo_energy =
[-3.27696101e+01 -1.92733494e+00 -8.45634340e-01 -8.45634340e-01
 -8.45634340e-01  5.19743314e-01  1.08781487e+00  1.08781487e+00
  1.08781487e+00  2.76554384e+00  5.68408666e+00  5.68408666e+00
  5.68408666e+00  9.65951341e+00  2.40428198e+01  2.40428198e+01
  2.40428198e+01  3.72130652e+01  1.18884994e+02  1.18884994e+02
  1.18884994e+02  1.41116929e+02  5.04939121e+02  1.87231980e+03
  8.00173290e+03  4.77690805e+04]
E1 = -182.59670628098766  E_coul = 54.064529129309015
cycle= 5 E= -128.532177151679  delta_E= -5.69e-10  |g|= 6.82e-06  |ddm|= 4.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59670628098766  E_coul = 54.064529129309015
  HOMO = -0.845630562591925  LUMO = 0.519744277764922
  mo_energy =
[-3.27696019e+01 -1.92733044e+00 -8.45630563e-01 -8.45630563e-01
 -8.45630563e-01  5.19744278e-01  1.08781645e+00  1.08781645e+00
  1.08781645e+00  2.76554642e+00  5.68409126e+00  5.68409126e+00
  5.68409126e+00  9.65951831e+00  2.40428269e+01  2.40428269e+01
  2.40428269e+01  3.72130724e+01  1.18885002e+02  1.18885002e+02
  1.18885002e+02  1.41116937e+02  5.04939128e+02  1.87231981e+03
  8.00173291e+03  4.77690806e+04]
E1 = -182.59668810078236  E_coul = 54.06451094910094
Extra cycle  E= -128.532177151681  delta_E= -2.79e-12  |g|= 2.54e-06  |ddm|= 2.21e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 823.1030732763078
E1 = -182.59668810078236  E_coul = 54.06451094910094
init E= -128.532177151681
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845631834423446  LUMO = 0.519744119881125
  mo_energy =
[-3.27696059e+01 -1.92733166e+00 -8.45631834e-01 -8.45631834e-01
 -8.45631834e-01  5.19744120e-01  1.08781601e+00  1.08781601e+00
  1.08781601e+00  2.76554584e+00  5.68408971e+00  5.68408971e+00
  5.68408971e+00  9.65951679e+00  2.40428239e+01  2.40428239e+01
  2.40428239e+01  3.72130694e+01  1.18884998e+02  1.18884998e+02
  1.18884998e+02  1.41116933e+02  5.04939124e+02  1.87231980e+03
  8.00173290e+03  4.77690805e+04]
E1 = -182.59669788362214  E_coul = 54.06452073194003
cycle= 1 E= -128.532177151682  delta_E= -6.82e-13  |g|= 1.34e-06  |ddm|= 9.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59669788362214  E_coul = 54.06452073194003
  HOMO = -0.845631146666132  LUMO = 0.519744239151493
  mo_energy =
[-3.27696039e+01 -1.92733091e+00 -8.45631147e-01 -8.45631147e-01
 -8.45631147e-01  5.19744239e-01  1.08781626e+00  1.08781626e+00
  1.08781626e+00  2.76554621e+00  5.68409055e+00  5.68409055e+00
  5.68409055e+00  9.65951765e+00  2.40428255e+01  2.40428255e+01
  2.40428255e+01  3.72130710e+01  1.18885000e+02  1.18885000e+02
  1.18885000e+02  1.41116935e+02  5.04939126e+02  1.87231980e+03
  8.00173291e+03  4.77690805e+04]
E1 = -182.59669301874746  E_coul = 54.064515867064976
Extra cycle  E= -128.532177151682  delta_E= -3.69e-13  |g|= 6.62e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [5.48184561e-01 2.44137941e+04 3.66145447e+03 8.33271012e+02
 2.35735292e+02 7.64298675e+01 1.00896779e+01 2.70462505e+01
 2.40360807e-01 1.33038322e+00 2.86307939e+00 3.68211545e+00
 1.24492163e+01 5.47853619e+01 3.29677377e-01 1.14327082e+00]
grad_E = [-1.58655431e-03  1.18177606e-10 -6.17162781e-09  1.31289754e-07
 -1.60687410e-06  9.18839081e-06 -2.79108811e-04  2.35943664e-05
  9.88890050e-04  5.62510728e-04 -2.78830649e-04 -3.08624686e-04
  4.93051215e-05 -1.89652073e-06 -2.53248874e-03  1.15785098e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.625441129894       1
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447534        1
[INPUT] 0    0    [1    /1   ]  833.270945311        1
[INPUT] 0    0    [1    /1   ]  235.736098993        1
[INPUT] 0    0    [1    /1   ]  76.4245925911        1
[INPUT] 0    0    [1    /1   ]  10.1154074458        1
[INPUT] 0    0    [1    /1   ]  27.0541545693        1
[INPUT] 0    0    [1    /1   ]  0.25542346772        1
[INPUT] 0    0    [1    /1   ]  1.46582295956        1
[INPUT] 0    0    [1    /1   ]  2.88501398175        1
[INPUT] 1    0    [1    /1   ]  3.67995407887        1
[INPUT] 1    0    [1    /1   ]  12.44794432          1
[INPUT] 1    0    [1    /1   ]  54.7854388552        1
[INPUT] 1    0    [1    /1   ]  0.32950946526        1
[INPUT] 1    0    [1    /1   ]  1.14231753443        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.6254411298937644, 1.0]], [0, [24413.79412988838, 1.0]], [0, [3661.454475344295, 1.0]], [0, [833.2709453111586, 1.0]], [0, [235.73609899303236, 1.0]], [0, [76.42459259108927, 1.0]], [0, [10.115407445839988, 1.0]], [0, [27.05415456934417, 1.0]], [0, [0.2554234677195648, 1.0]], [0, [1.465822959556576, 1.0]], [0, [2.885013981750203, 1.0]], [1, [3.679954078865066, 1.0]], [1, [12.44794431998456, 1.0]], [1, [54.78543885518962, 1.0]], [1, [0.329509465259774, 1.0]], [1, [1.142317534427178, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.62544113]
bas 1, expnt(s) = [24413.79412989]
bas 2, expnt(s) = [3661.45447534]
bas 3, expnt(s) = [833.27094531]
bas 4, expnt(s) = [235.73609899]
bas 5, expnt(s) = [76.42459259]
bas 6, expnt(s) = [10.11540745]
bas 7, expnt(s) = [27.05415457]
bas 8, expnt(s) = [0.25542347]
bas 9, expnt(s) = [1.46582296]
bas 10, expnt(s) = [2.88501398]
bas 11, expnt(s) = [3.67995408]
bas 12, expnt(s) = [12.44794432]
bas 13, expnt(s) = [54.78543886]
bas 14, expnt(s) = [0.32950947]
bas 15, expnt(s) = [1.14231753]
CPU time:        50.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 6.25441130e-01 1.77686672e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270945e+02 3.91836333e+02
 2.35736099e+02 1.51996852e+02 7.64245926e+01 6.53040135e+01
 1.01154074e+01 1.43302102e+01 2.70541546e+01 2.99702592e+01
 2.55423468e-01 9.07738220e-01 1.46582296e+00 3.36570590e+00
 2.88501398e+00 5.59275720e+00 3.67995408e+00 1.48691928e+01
 1.24479443e+01 6.82113176e+01 5.47854389e+01 4.34826320e+02
 3.29509465e-01 7.28315010e-01 1.14231753e+00 3.44522783e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497798088462
cond(S) = 1081.8238088603907
E1 = -183.57761941639686  E_coul = 55.078355177657905
init E= -128.499264238739
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.773958457204499  LUMO = 0.593632673838506
  mo_energy =
[-3.25553655e+01 -1.85290862e+00 -7.73958457e-01 -7.73958457e-01
 -7.73958457e-01  5.93632674e-01  1.11279778e+00  1.11279778e+00
  1.11279778e+00  3.14836194e+00  5.76675644e+00  5.76675644e+00
  5.76675644e+00  1.05466530e+01  2.41894014e+01  2.41894014e+01
  2.41894014e+01  3.84696668e+01  1.19088359e+02  1.19088359e+02
  1.19088359e+02  1.42419737e+02  5.06182326e+02  1.87349003e+03
  8.00282210e+03  4.77700522e+04]
E1 = -182.10893035623724  E_coul = 53.58007910188934
cycle= 1 E= -128.528851254348  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.461966
diis-c [-0.21341271  1.        ]
  HOMO = -0.879765746983633  LUMO = 0.574263169536795
  mo_energy =
[-3.28743084e+01 -1.96330772e+00 -8.79765747e-01 -8.79765747e-01
 -8.79765747e-01  5.74263170e-01  1.07460705e+00  1.07460705e+00
  1.07460705e+00  3.08824673e+00  5.63776724e+00  5.63776724e+00
  5.63776724e+00  1.04137341e+01  2.39541836e+01  2.39541836e+01
  2.39541836e+01  3.82291027e+01  1.18767139e+02  1.18767139e+02
  1.18767139e+02  1.42106864e+02  5.05824822e+02  1.87309628e+03
  8.00239926e+03  4.77696105e+04]
E1 = -182.84190722563199  E_coul = 54.31054666674499
cycle= 2 E= -128.531360558887  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.230794
diis-c [-6.14984984e-04  3.32182374e-01  6.67817626e-01]
  HOMO = -0.845367834568762  LUMO = 0.580610970543175
  mo_energy =
[-3.27691897e+01 -1.92714506e+00 -8.45367835e-01 -8.45367835e-01
 -8.45367835e-01  5.80610971e-01  1.08708670e+00  1.08708670e+00
  1.08708670e+00  3.10761555e+00  5.67970362e+00  5.67970362e+00
  5.67970362e+00  1.04570382e+01  2.40318150e+01  2.40318150e+01
  2.40318150e+01  3.83087307e+01  1.18872287e+02  1.18872287e+02
  1.18872287e+02  1.42209742e+02  5.05938507e+02  1.87321520e+03
  8.00252061e+03  4.77697327e+04]
E1 = -182.59601496217667  E_coul = 54.063804818520914
cycle= 3 E= -128.532210143656  delta_E= -0.00085  |g|= 0.000477  |ddm|= 0.023
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000959305
diis-c [-1.98422273e-07 -2.30267462e-03 -9.31073844e-04  1.00323375e+00]
  HOMO = -0.84560928466985  LUMO = 0.580584547760131
  mo_energy =
[-3.27696108e+01 -1.92732051e+00 -8.45609285e-01 -8.45609285e-01
 -8.45609285e-01  5.80584548e-01  1.08703252e+00  1.08703252e+00
  1.08703252e+00  3.10751354e+00  5.67949234e+00  5.67949234e+00
  5.67949234e+00  1.04568236e+01  2.40314815e+01  2.40314815e+01
  2.40314815e+01  3.83084002e+01  1.18871854e+02  1.18871854e+02
  1.18871854e+02  1.42209322e+02  5.05937983e+02  1.87321456e+03
  8.00251988e+03  4.77697320e+04]
E1 = -182.5965214701111  E_coul = 54.06431130374714
cycle= 4 E= -128.532210166364  delta_E= -2.27e-08  |g|= 6.36e-05  |ddm|= 0.000285
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132044
diis-c [-1.01707859e-09  3.32266148e-04  4.01974969e-04 -2.17180916e-01
  1.21644667e+00]
  HOMO = -0.845641548265019  LUMO = 0.580579736565533
  mo_energy =
[-3.27696614e+01 -1.92733962e+00 -8.45641548e-01 -8.45641548e-01
 -8.45641548e-01  5.80579737e-01  1.08701870e+00  1.08701870e+00
  1.08701870e+00  3.10749671e+00  5.67945690e+00  5.67945690e+00
  5.67945690e+00  1.04567905e+01  2.40314352e+01  2.40314352e+01
  2.40314352e+01  3.83083549e+01  1.18871802e+02  1.18871802e+02
  1.18871802e+02  1.42209271e+02  5.05937924e+02  1.87321450e+03
  8.00251981e+03  4.77697319e+04]
E1 = -182.59661720172159  E_coul = 54.06440703476771
cycle= 5 E= -128.532210166954  delta_E= -5.9e-10  |g|= 6.85e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59661720172159  E_coul = 54.06440703476771
  HOMO = -0.845637768359145  LUMO = 0.580580833241552
  mo_energy =
[-3.27696532e+01 -1.92733511e+00 -8.45637768e-01 -8.45637768e-01
 -8.45637768e-01  5.80580833e-01  1.08702028e+00  1.08702028e+00
  1.08702028e+00  3.10749948e+00  5.67946150e+00  5.67946150e+00
  5.67946150e+00  1.04567955e+01  2.40314423e+01  2.40314423e+01
  2.40314423e+01  3.83083621e+01  1.18871810e+02  1.18871810e+02
  1.18871810e+02  1.42209279e+02  5.05937932e+02  1.87321450e+03
  8.00251982e+03  4.77697319e+04]
E1 = -182.59659907745876  E_coul = 54.06438891050223
Extra cycle  E= -128.532210166957  delta_E= -2.67e-12  |g|= 2.54e-06  |ddm|= 2.36e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.14 sec
exp = [6.25441130e-01 2.44137941e+04 3.66145448e+03 8.33270945e+02
 2.35736099e+02 7.64245926e+01 1.01154074e+01 2.70541546e+01
 2.55423468e-01 1.46582296e+00 2.88501398e+00 3.67995408e+00
 1.24479443e+01 5.47854389e+01 3.29509465e-01 1.14231753e+00]
E = -128.53221016695653
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.625441129894       1
[INPUT] 0    0    [1    /1   ]  24413.7941299        1
[INPUT] 0    0    [1    /1   ]  3661.45447534        1
[INPUT] 0    0    [1    /1   ]  833.270945311        1
[INPUT] 0    0    [1    /1   ]  235.736098993        1
[INPUT] 0    0    [1    /1   ]  76.4245925911        1
[INPUT] 0    0    [1    /1   ]  10.1154074458        1
[INPUT] 0    0    [1    /1   ]  27.0541545693        1
[INPUT] 0    0    [1    /1   ]  0.25542346772        1
[INPUT] 0    0    [1    /1   ]  1.46582295956        1
[INPUT] 0    0    [1    /1   ]  2.88501398175        1
[INPUT] 1    0    [1    /1   ]  3.67995407887        1
[INPUT] 1    0    [1    /1   ]  12.44794432          1
[INPUT] 1    0    [1    /1   ]  54.7854388552        1
[INPUT] 1    0    [1    /1   ]  0.32950946526        1
[INPUT] 1    0    [1    /1   ]  1.14231753443        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.6254411298937644, 1.0]], [0, [24413.79412988838, 1.0]], [0, [3661.454475344295, 1.0]], [0, [833.2709453111586, 1.0]], [0, [235.73609899303236, 1.0]], [0, [76.42459259108927, 1.0]], [0, [10.115407445839988, 1.0]], [0, [27.05415456934417, 1.0]], [0, [0.2554234677195648, 1.0]], [0, [1.465822959556576, 1.0]], [0, [2.885013981750203, 1.0]], [1, [3.679954078865066, 1.0]], [1, [12.44794431998456, 1.0]], [1, [54.78543885518962, 1.0]], [1, [0.329509465259774, 1.0]], [1, [1.142317534427178, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.62544113]
bas 1, expnt(s) = [24413.79412989]
bas 2, expnt(s) = [3661.45447534]
bas 3, expnt(s) = [833.27094531]
bas 4, expnt(s) = [235.73609899]
bas 5, expnt(s) = [76.42459259]
bas 6, expnt(s) = [10.11540745]
bas 7, expnt(s) = [27.05415457]
bas 8, expnt(s) = [0.25542347]
bas 9, expnt(s) = [1.46582296]
bas 10, expnt(s) = [2.88501398]
bas 11, expnt(s) = [3.67995408]
bas 12, expnt(s) = [12.44794432]
bas 13, expnt(s) = [54.78543886]
bas 14, expnt(s) = [0.32950947]
bas 15, expnt(s) = [1.14231753]
CPU time:        51.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 6.25441130e-01 1.77686672e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270945e+02 3.91836333e+02
 2.35736099e+02 1.51996852e+02 7.64245926e+01 6.53040135e+01
 1.01154074e+01 1.43302102e+01 2.70541546e+01 2.99702592e+01
 2.55423468e-01 9.07738220e-01 1.46582296e+00 3.36570590e+00
 2.88501398e+00 5.59275720e+00 3.67995408e+00 1.48691928e+01
 1.24479443e+01 6.82113176e+01 5.47854389e+01 4.34826320e+02
 3.29509465e-01 7.28315010e-01 1.14231753e+00 3.44522783e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497798088462
cond(S) = 1081.8238088603907
E1 = -183.57761941639686  E_coul = 55.078355177657905
init E= -128.499264238739
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773958457204499  LUMO = 0.593632673838506
  mo_energy =
[-3.25553655e+01 -1.85290862e+00 -7.73958457e-01 -7.73958457e-01
 -7.73958457e-01  5.93632674e-01  1.11279778e+00  1.11279778e+00
  1.11279778e+00  3.14836194e+00  5.76675644e+00  5.76675644e+00
  5.76675644e+00  1.05466530e+01  2.41894014e+01  2.41894014e+01
  2.41894014e+01  3.84696668e+01  1.19088359e+02  1.19088359e+02
  1.19088359e+02  1.42419737e+02  5.06182326e+02  1.87349003e+03
  8.00282210e+03  4.77700522e+04]
E1 = -182.10893035623724  E_coul = 53.58007910188934
cycle= 1 E= -128.528851254348  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.159
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.461966
diis-c [-0.21341271  1.        ]
  HOMO = -0.879765746983633  LUMO = 0.574263169536795
  mo_energy =
[-3.28743084e+01 -1.96330772e+00 -8.79765747e-01 -8.79765747e-01
 -8.79765747e-01  5.74263170e-01  1.07460705e+00  1.07460705e+00
  1.07460705e+00  3.08824673e+00  5.63776724e+00  5.63776724e+00
  5.63776724e+00  1.04137341e+01  2.39541836e+01  2.39541836e+01
  2.39541836e+01  3.82291027e+01  1.18767139e+02  1.18767139e+02
  1.18767139e+02  1.42106864e+02  5.05824822e+02  1.87309628e+03
  8.00239926e+03  4.77696105e+04]
E1 = -182.84190722563199  E_coul = 54.31054666674499
cycle= 2 E= -128.531360558887  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.230794
diis-c [-6.14984984e-04  3.32182374e-01  6.67817626e-01]
  HOMO = -0.845367834568762  LUMO = 0.580610970543175
  mo_energy =
[-3.27691897e+01 -1.92714506e+00 -8.45367835e-01 -8.45367835e-01
 -8.45367835e-01  5.80610971e-01  1.08708670e+00  1.08708670e+00
  1.08708670e+00  3.10761555e+00  5.67970362e+00  5.67970362e+00
  5.67970362e+00  1.04570382e+01  2.40318150e+01  2.40318150e+01
  2.40318150e+01  3.83087307e+01  1.18872287e+02  1.18872287e+02
  1.18872287e+02  1.42209742e+02  5.05938507e+02  1.87321520e+03
  8.00252061e+03  4.77697327e+04]
E1 = -182.59601496217667  E_coul = 54.063804818520914
cycle= 3 E= -128.532210143656  delta_E= -0.00085  |g|= 0.000477  |ddm|= 0.023
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000959305
diis-c [-1.98422273e-07 -2.30267462e-03 -9.31073844e-04  1.00323375e+00]
  HOMO = -0.84560928466985  LUMO = 0.580584547760131
  mo_energy =
[-3.27696108e+01 -1.92732051e+00 -8.45609285e-01 -8.45609285e-01
 -8.45609285e-01  5.80584548e-01  1.08703252e+00  1.08703252e+00
  1.08703252e+00  3.10751354e+00  5.67949234e+00  5.67949234e+00
  5.67949234e+00  1.04568236e+01  2.40314815e+01  2.40314815e+01
  2.40314815e+01  3.83084002e+01  1.18871854e+02  1.18871854e+02
  1.18871854e+02  1.42209322e+02  5.05937983e+02  1.87321456e+03
  8.00251988e+03  4.77697320e+04]
E1 = -182.5965214701111  E_coul = 54.06431130374714
cycle= 4 E= -128.532210166364  delta_E= -2.27e-08  |g|= 6.36e-05  |ddm|= 0.000285
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000132044
diis-c [-1.01707859e-09  3.32266148e-04  4.01974969e-04 -2.17180916e-01
  1.21644667e+00]
  HOMO = -0.845641548265019  LUMO = 0.580579736565533
  mo_energy =
[-3.27696614e+01 -1.92733962e+00 -8.45641548e-01 -8.45641548e-01
 -8.45641548e-01  5.80579737e-01  1.08701870e+00  1.08701870e+00
  1.08701870e+00  3.10749671e+00  5.67945690e+00  5.67945690e+00
  5.67945690e+00  1.04567905e+01  2.40314352e+01  2.40314352e+01
  2.40314352e+01  3.83083549e+01  1.18871802e+02  1.18871802e+02
  1.18871802e+02  1.42209271e+02  5.05937924e+02  1.87321450e+03
  8.00251981e+03  4.77697319e+04]
E1 = -182.59661720172159  E_coul = 54.06440703476771
cycle= 5 E= -128.532210166954  delta_E= -5.9e-10  |g|= 6.85e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59661720172159  E_coul = 54.06440703476771
  HOMO = -0.845637768359145  LUMO = 0.580580833241552
  mo_energy =
[-3.27696532e+01 -1.92733511e+00 -8.45637768e-01 -8.45637768e-01
 -8.45637768e-01  5.80580833e-01  1.08702028e+00  1.08702028e+00
  1.08702028e+00  3.10749948e+00  5.67946150e+00  5.67946150e+00
  5.67946150e+00  1.04567955e+01  2.40314423e+01  2.40314423e+01
  2.40314423e+01  3.83083621e+01  1.18871810e+02  1.18871810e+02
  1.18871810e+02  1.42209279e+02  5.05937932e+02  1.87321450e+03
  8.00251982e+03  4.77697319e+04]
E1 = -182.59659907745876  E_coul = 54.06438891050223
Extra cycle  E= -128.532210166957  delta_E= -2.67e-12  |g|= 2.54e-06  |ddm|= 2.36e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.14 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1081.8238088603907
E1 = -182.59659907745876  E_coul = 54.06438891050223
init E= -128.532210166957
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845639035922793  LUMO = 0.580580653428007
  mo_energy =
[-3.27696572e+01 -1.92733632e+00 -8.45639036e-01 -8.45639036e-01
 -8.45639036e-01  5.80580653e-01  1.08701984e+00  1.08701984e+00
  1.08701984e+00  3.10749885e+00  5.67945996e+00  5.67945996e+00
  5.67945996e+00  1.04567940e+01  2.40314394e+01  2.40314394e+01
  2.40314394e+01  3.83083591e+01  1.18871806e+02  1.18871806e+02
  1.18871806e+02  1.42209275e+02  5.05937928e+02  1.87321450e+03
  8.00251981e+03  4.77697319e+04]
E1 = -182.59660885065404  E_coul = 54.0643986836969
cycle= 1 E= -128.532210166957  delta_E= -5.97e-13  |g|= 1.34e-06  |ddm|= 9.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59660885065404  E_coul = 54.0643986836969
  HOMO = -0.84563834876105  LUMO = 0.580580789450482
  mo_energy =
[-3.27696551e+01 -1.92733557e+00 -8.45638349e-01 -8.45638349e-01
 -8.45638349e-01  5.80580789e-01  1.08702009e+00  1.08702009e+00
  1.08702009e+00  3.10749925e+00  5.67946080e+00  5.67946080e+00
  5.67946080e+00  1.04567948e+01  2.40314409e+01  2.40314409e+01
  2.40314409e+01  3.83083607e+01  1.18871809e+02  1.18871809e+02
  1.18871809e+02  1.42209277e+02  5.05937930e+02  1.87321450e+03
  8.00251981e+03  4.77697319e+04]
E1 = -182.596603993298  E_coul = 54.06439382634068
Extra cycle  E= -128.532210166957  delta_E= -1.99e-13  |g|= 6.61e-07  |ddm|= 4.55e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [6.25441130e-01 2.44137941e+04 3.66145448e+03 8.33270945e+02
 2.35736099e+02 7.64245926e+01 1.01154074e+01 2.70541546e+01
 2.55423468e-01 1.46582296e+00 2.88501398e+00 3.67995408e+00
 1.24479443e+01 5.47854389e+01 3.29509465e-01 1.14231753e+00]
grad_E = [-5.44644116e-04  8.96052030e-11 -4.68264095e-09  1.03054814e-07
 -1.31748226e-06  7.39519357e-06 -3.53265326e-04  3.64603714e-05
 -9.83723744e-05  2.68056701e-04 -2.09455003e-04 -3.35597175e-04
  6.52920953e-05 -2.45836155e-06 -2.02736397e-03  9.52282038e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.761752618057       1
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.454481          1
[INPUT] 0    0    [1    /1   ]  833.270828528        1
[INPUT] 0    0    [1    /1   ]  235.737505786        1
[INPUT] 0    0    [1    /1   ]  76.4153163801        1
[INPUT] 0    0    [1    /1   ]  10.1541184255        1
[INPUT] 0    0    [1    /1   ]  27.0696895996        1
[INPUT] 0    0    [1    /1   ]  0.310230628875       1
[INPUT] 0    0    [1    /1   ]  1.67874702397        1
[INPUT] 0    0    [1    /1   ]  2.92991067324        1
[INPUT] 1    0    [1    /1   ]  3.67665286141        1
[INPUT] 1    0    [1    /1   ]  12.44565403          1
[INPUT] 1    0    [1    /1   ]  54.7855759638        1
[INPUT] 1    0    [1    /1   ]  0.329509286374       1
[INPUT] 1    0    [1    /1   ]  1.14055204578        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7617526180572356, 1.0]], [0, [24413.79412978034, 1.0]], [0, [3661.4544810035686, 1.0]], [0, [833.2708285281873, 1.0]], [0, [235.73750578594377, 1.0]], [0, [76.41531638010362, 1.0]], [0, [10.154118425475643, 1.0]], [0, [27.06968959962057, 1.0]], [0, [0.31023062887528596, 1.0]], [0, [1.6787470239666251, 1.0]], [0, [2.929910673240791, 1.0]], [1, [3.676652861410858, 1.0]], [1, [12.445654030014529, 1.0]], [1, [54.78557596383914, 1.0]], [1, [0.3295092863744129, 1.0]], [1, [1.1405520457846987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76175262]
bas 1, expnt(s) = [24413.79412978]
bas 2, expnt(s) = [3661.454481]
bas 3, expnt(s) = [833.27082853]
bas 4, expnt(s) = [235.73750579]
bas 5, expnt(s) = [76.41531638]
bas 6, expnt(s) = [10.15411843]
bas 7, expnt(s) = [27.0696896]
bas 8, expnt(s) = [0.31023063]
bas 9, expnt(s) = [1.67874702]
bas 10, expnt(s) = [2.92991067]
bas 11, expnt(s) = [3.67665286]
bas 12, expnt(s) = [12.44565403]
bas 13, expnt(s) = [54.78557596]
bas 14, expnt(s) = [0.32950929]
bas 15, expnt(s) = [1.14055205]
CPU time:        53.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.61752618e-01 2.06003923e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270829e+02 3.91836292e+02
 2.35737506e+02 1.51997532e+02 7.64153164e+01 6.52980686e+01
 1.01541184e+01 1.43713211e+01 2.70696896e+01 2.99831654e+01
 3.10230629e-01 1.05021576e+00 1.67874702e+00 3.72609537e+00
 2.92991067e+00 5.65790706e+00 3.67665286e+00 1.48525210e+01
 1.24456540e+01 6.81956303e+01 5.47855760e+01 4.34827680e+02
 3.29509286e-01 7.28314516e-01 1.14055205e+00 3.43857323e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998504068561523
cond(S) = 1951.2619567738416
E1 = -183.57780181125062  E_coul = 55.07841045676141
init E= -128.499391354489
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773954362650117  LUMO = 0.760826516966282
  mo_energy =
[-3.25553701e+01 -1.85290047e+00 -7.73954363e-01 -7.73954363e-01
 -7.73954363e-01  7.60826517e-01  1.11220875e+00  1.11220875e+00
  1.11220875e+00  3.84119078e+00  5.75976162e+00  5.75976162e+00
  5.75976162e+00  1.19793174e+01  2.41713926e+01  2.41713926e+01
  2.41713926e+01  4.04123229e+01  1.19066965e+02  1.19066965e+02
  1.19066965e+02  1.44364712e+02  5.07963451e+02  1.87508640e+03
  8.00422638e+03  4.77712146e+04]
E1 = -182.1105185749066  E_coul = 53.58164009280023
cycle= 1 E= -128.528878482106  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460866
diis-c [-0.21239716  1.        ]
  HOMO = -0.879621347212298  LUMO = 0.735771065956425
  mo_energy =
[-3.28741010e+01 -1.96317836e+00 -8.79621347e-01 -8.79621347e-01
 -8.79621347e-01  7.35771066e-01  1.07413682e+00  1.07413682e+00
  1.07413682e+00  3.77364728e+00  5.63103184e+00  5.63103184e+00
  5.63103184e+00  1.18423057e+01  2.39363815e+01  2.39363815e+01
  2.39363815e+01  4.01722474e+01  1.18745947e+02  1.18745947e+02
  1.18745947e+02  1.44052429e+02  5.07606270e+02  1.87469287e+03
  8.00380374e+03  4.77707731e+04]
E1 = -182.8430040376664  E_coul = 54.31161843165
cycle= 2 E= -128.531385606016  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0673
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230081
diis-c [-6.20043341e-04  3.32010609e-01  6.67989391e-01]
  HOMO = -0.845238126053604  LUMO = 0.743949706976506
  mo_energy =
[-3.27690261e+01 -1.92702914e+00 -8.45238126e-01 -8.45238126e-01
 -8.45238126e-01  7.43949707e-01  1.08659561e+00  1.08659561e+00
  1.08659561e+00  3.79544740e+00  5.67291677e+00  5.67291677e+00
  5.67291677e+00  1.18869955e+01  2.40139740e+01  2.40139740e+01
  2.40139740e+01  4.02517274e+01  1.18851053e+02  1.18851053e+02
  1.18851053e+02  1.44155131e+02  5.07719870e+02  1.87481173e+03
  8.00392504e+03  4.77708953e+04]
E1 = -182.5973580757112  E_coul = 54.06512440755451
cycle= 3 E= -128.532233668157  delta_E= -0.000848  |g|= 0.000477  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000970603
diis-c [-1.63947672e-07 -2.21493933e-03 -6.01080337e-04  1.00281602e+00]
  HOMO = -0.84547751946374  LUMO = 0.743916149535413
  mo_energy =
[-3.27694549e+01 -1.92720451e+00 -8.45477519e-01 -8.45477519e-01
 -8.45477519e-01  7.43916150e-01  1.08654338e+00  1.08654338e+00
  1.08654338e+00  3.79533355e+00  5.67270697e+00  5.67270697e+00
  5.67270697e+00  1.18867748e+01  2.40136374e+01  2.40136374e+01
  2.40136374e+01  4.02513929e+01  1.18850612e+02  1.18850612e+02
  1.18850612e+02  1.44154704e+02  5.07719337e+02  1.87481108e+03
  8.00392430e+03  4.77708945e+04]
E1 = -182.59789677139943  E_coul = 54.065663081749854
cycle= 4 E= -128.53223368965  delta_E= -2.15e-08  |g|= 6.28e-05  |ddm|= 0.000325
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131209
diis-c [-9.68514776e-10  3.25530810e-04  3.92111999e-04 -2.14374274e-01
  1.21365663e+00]
  HOMO = -0.845509349769707  LUMO = 0.743910056536371
  mo_energy =
[-3.27695065e+01 -1.92722384e+00 -8.45509350e-01 -8.45509350e-01
 -8.45509350e-01  7.43910057e-01  1.08652997e+00  1.08652997e+00
  1.08652997e+00  3.79531490e+00  5.67267184e+00  5.67267184e+00
  5.67267184e+00  1.18867409e+01  2.40135907e+01  2.40135907e+01
  2.40135907e+01  4.02513471e+01  1.18850560e+02  1.18850560e+02
  1.18850560e+02  1.44154652e+02  5.07719278e+02  1.87481102e+03
  8.00392423e+03  4.77708944e+04]
E1 = -182.59799752934552  E_coul = 54.065763839156396
cycle= 5 E= -128.532233690189  delta_E= -5.4e-10  |g|= 6.67e-06  |ddm|= 5.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59799752934552  E_coul = 54.065763839156396
  HOMO = -0.845505673198337  LUMO = 0.743911394992033
  mo_energy =
[-3.27694984e+01 -1.92721946e+00 -8.45505673e-01 -8.45505673e-01
 -8.45505673e-01  7.43911395e-01  1.08653151e+00  1.08653151e+00
  1.08653151e+00  3.79531784e+00  5.67267631e+00  5.67267631e+00
  5.67267631e+00  1.18867459e+01  2.40135976e+01  2.40135976e+01
  2.40135976e+01  4.02513541e+01  1.18850568e+02  1.18850568e+02
  1.18850568e+02  1.44154660e+02  5.07719285e+02  1.87481102e+03
  8.00392424e+03  4.77708945e+04]
E1 = -182.59797979215264  E_coul = 54.0657461019608
Extra cycle  E= -128.532233690192  delta_E= -2.73e-12  |g|= 2.48e-06  |ddm|= 2.31e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [7.61752618e-01 2.44137941e+04 3.66145448e+03 8.33270829e+02
 2.35737506e+02 7.64153164e+01 1.01541184e+01 2.70696896e+01
 3.10230629e-01 1.67874702e+00 2.92991067e+00 3.67665286e+00
 1.24456540e+01 5.47855760e+01 3.29509286e-01 1.14055205e+00]
E = -128.53223369019184
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.761752618057       1
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.454481          1
[INPUT] 0    0    [1    /1   ]  833.270828528        1
[INPUT] 0    0    [1    /1   ]  235.737505786        1
[INPUT] 0    0    [1    /1   ]  76.4153163801        1
[INPUT] 0    0    [1    /1   ]  10.1541184255        1
[INPUT] 0    0    [1    /1   ]  27.0696895996        1
[INPUT] 0    0    [1    /1   ]  0.310230628875       1
[INPUT] 0    0    [1    /1   ]  1.67874702397        1
[INPUT] 0    0    [1    /1   ]  2.92991067324        1
[INPUT] 1    0    [1    /1   ]  3.67665286141        1
[INPUT] 1    0    [1    /1   ]  12.44565403          1
[INPUT] 1    0    [1    /1   ]  54.7855759638        1
[INPUT] 1    0    [1    /1   ]  0.329509286374       1
[INPUT] 1    0    [1    /1   ]  1.14055204578        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7617526180572356, 1.0]], [0, [24413.79412978034, 1.0]], [0, [3661.4544810035686, 1.0]], [0, [833.2708285281873, 1.0]], [0, [235.73750578594377, 1.0]], [0, [76.41531638010362, 1.0]], [0, [10.154118425475643, 1.0]], [0, [27.06968959962057, 1.0]], [0, [0.31023062887528596, 1.0]], [0, [1.6787470239666251, 1.0]], [0, [2.929910673240791, 1.0]], [1, [3.676652861410858, 1.0]], [1, [12.445654030014529, 1.0]], [1, [54.78557596383914, 1.0]], [1, [0.3295092863744129, 1.0]], [1, [1.1405520457846987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76175262]
bas 1, expnt(s) = [24413.79412978]
bas 2, expnt(s) = [3661.454481]
bas 3, expnt(s) = [833.27082853]
bas 4, expnt(s) = [235.73750579]
bas 5, expnt(s) = [76.41531638]
bas 6, expnt(s) = [10.15411843]
bas 7, expnt(s) = [27.0696896]
bas 8, expnt(s) = [0.31023063]
bas 9, expnt(s) = [1.67874702]
bas 10, expnt(s) = [2.92991067]
bas 11, expnt(s) = [3.67665286]
bas 12, expnt(s) = [12.44565403]
bas 13, expnt(s) = [54.78557596]
bas 14, expnt(s) = [0.32950929]
bas 15, expnt(s) = [1.14055205]
CPU time:        54.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.61752618e-01 2.06003923e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270829e+02 3.91836292e+02
 2.35737506e+02 1.51997532e+02 7.64153164e+01 6.52980686e+01
 1.01541184e+01 1.43713211e+01 2.70696896e+01 2.99831654e+01
 3.10230629e-01 1.05021576e+00 1.67874702e+00 3.72609537e+00
 2.92991067e+00 5.65790706e+00 3.67665286e+00 1.48525210e+01
 1.24456540e+01 6.81956303e+01 5.47855760e+01 4.34827680e+02
 3.29509286e-01 7.28314516e-01 1.14055205e+00 3.43857323e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998504068561523
cond(S) = 1951.2619567738416
E1 = -183.57780181125062  E_coul = 55.07841045676141
init E= -128.499391354489
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773954362650117  LUMO = 0.760826516966282
  mo_energy =
[-3.25553701e+01 -1.85290047e+00 -7.73954363e-01 -7.73954363e-01
 -7.73954363e-01  7.60826517e-01  1.11220875e+00  1.11220875e+00
  1.11220875e+00  3.84119078e+00  5.75976162e+00  5.75976162e+00
  5.75976162e+00  1.19793174e+01  2.41713926e+01  2.41713926e+01
  2.41713926e+01  4.04123229e+01  1.19066965e+02  1.19066965e+02
  1.19066965e+02  1.44364712e+02  5.07963451e+02  1.87508640e+03
  8.00422638e+03  4.77712146e+04]
E1 = -182.1105185749066  E_coul = 53.58164009280023
cycle= 1 E= -128.528878482106  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460866
diis-c [-0.21239716  1.        ]
  HOMO = -0.879621347212298  LUMO = 0.735771065956425
  mo_energy =
[-3.28741010e+01 -1.96317836e+00 -8.79621347e-01 -8.79621347e-01
 -8.79621347e-01  7.35771066e-01  1.07413682e+00  1.07413682e+00
  1.07413682e+00  3.77364728e+00  5.63103184e+00  5.63103184e+00
  5.63103184e+00  1.18423057e+01  2.39363815e+01  2.39363815e+01
  2.39363815e+01  4.01722474e+01  1.18745947e+02  1.18745947e+02
  1.18745947e+02  1.44052429e+02  5.07606270e+02  1.87469287e+03
  8.00380374e+03  4.77707731e+04]
E1 = -182.8430040376664  E_coul = 54.31161843165
cycle= 2 E= -128.531385606016  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0673
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230081
diis-c [-6.20043341e-04  3.32010609e-01  6.67989391e-01]
  HOMO = -0.845238126053604  LUMO = 0.743949706976506
  mo_energy =
[-3.27690261e+01 -1.92702914e+00 -8.45238126e-01 -8.45238126e-01
 -8.45238126e-01  7.43949707e-01  1.08659561e+00  1.08659561e+00
  1.08659561e+00  3.79544740e+00  5.67291677e+00  5.67291677e+00
  5.67291677e+00  1.18869955e+01  2.40139740e+01  2.40139740e+01
  2.40139740e+01  4.02517274e+01  1.18851053e+02  1.18851053e+02
  1.18851053e+02  1.44155131e+02  5.07719870e+02  1.87481173e+03
  8.00392504e+03  4.77708953e+04]
E1 = -182.5973580757112  E_coul = 54.06512440755451
cycle= 3 E= -128.532233668157  delta_E= -0.000848  |g|= 0.000477  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000970603
diis-c [-1.63947672e-07 -2.21493933e-03 -6.01080337e-04  1.00281602e+00]
  HOMO = -0.84547751946374  LUMO = 0.743916149535413
  mo_energy =
[-3.27694549e+01 -1.92720451e+00 -8.45477519e-01 -8.45477519e-01
 -8.45477519e-01  7.43916150e-01  1.08654338e+00  1.08654338e+00
  1.08654338e+00  3.79533355e+00  5.67270697e+00  5.67270697e+00
  5.67270697e+00  1.18867748e+01  2.40136374e+01  2.40136374e+01
  2.40136374e+01  4.02513929e+01  1.18850612e+02  1.18850612e+02
  1.18850612e+02  1.44154704e+02  5.07719337e+02  1.87481108e+03
  8.00392430e+03  4.77708945e+04]
E1 = -182.59789677139943  E_coul = 54.065663081749854
cycle= 4 E= -128.53223368965  delta_E= -2.15e-08  |g|= 6.28e-05  |ddm|= 0.000325
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131209
diis-c [-9.68514776e-10  3.25530810e-04  3.92111999e-04 -2.14374274e-01
  1.21365663e+00]
  HOMO = -0.845509349769707  LUMO = 0.743910056536371
  mo_energy =
[-3.27695065e+01 -1.92722384e+00 -8.45509350e-01 -8.45509350e-01
 -8.45509350e-01  7.43910057e-01  1.08652997e+00  1.08652997e+00
  1.08652997e+00  3.79531490e+00  5.67267184e+00  5.67267184e+00
  5.67267184e+00  1.18867409e+01  2.40135907e+01  2.40135907e+01
  2.40135907e+01  4.02513471e+01  1.18850560e+02  1.18850560e+02
  1.18850560e+02  1.44154652e+02  5.07719278e+02  1.87481102e+03
  8.00392423e+03  4.77708944e+04]
E1 = -182.59799752934552  E_coul = 54.065763839156396
cycle= 5 E= -128.532233690189  delta_E= -5.4e-10  |g|= 6.67e-06  |ddm|= 5.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59799752934552  E_coul = 54.065763839156396
  HOMO = -0.845505673198337  LUMO = 0.743911394992033
  mo_energy =
[-3.27694984e+01 -1.92721946e+00 -8.45505673e-01 -8.45505673e-01
 -8.45505673e-01  7.43911395e-01  1.08653151e+00  1.08653151e+00
  1.08653151e+00  3.79531784e+00  5.67267631e+00  5.67267631e+00
  5.67267631e+00  1.18867459e+01  2.40135976e+01  2.40135976e+01
  2.40135976e+01  4.02513541e+01  1.18850568e+02  1.18850568e+02
  1.18850568e+02  1.44154660e+02  5.07719285e+02  1.87481102e+03
  8.00392424e+03  4.77708945e+04]
E1 = -182.59797979215264  E_coul = 54.0657461019608
Extra cycle  E= -128.532233690192  delta_E= -2.73e-12  |g|= 2.48e-06  |ddm|= 2.31e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1951.2619567738416
E1 = -182.59797979215264  E_coul = 54.0657461019608
init E= -128.532233690192
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845506913860151  LUMO = 0.743911163031851
  mo_energy =
[-3.27695024e+01 -1.92722065e+00 -8.45506914e-01 -8.45506914e-01
 -8.45506914e-01  7.43911163e-01  1.08653107e+00  1.08653107e+00
  1.08653107e+00  3.79531713e+00  5.67267480e+00  5.67267480e+00
  5.67267480e+00  1.18867443e+01  2.40135947e+01  2.40135947e+01
  2.40135947e+01  4.02513512e+01  1.18850564e+02  1.18850564e+02
  1.18850564e+02  1.44154656e+02  5.07719281e+02  1.87481102e+03
  8.00392423e+03  4.77708944e+04]
E1 = -182.5979893409423  E_coul = 54.06575565075008
cycle= 1 E= -128.532233690192  delta_E= -3.69e-13  |g|= 1.31e-06  |ddm|= 9.55e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5979893409423  E_coul = 54.06575565075008
  HOMO = -0.84550624252781  LUMO = 0.743911333583326
  mo_energy =
[-3.27695004e+01 -1.92721992e+00 -8.45506243e-01 -8.45506243e-01
 -8.45506243e-01  7.43911334e-01  1.08653132e+00  1.08653132e+00
  1.08653132e+00  3.79531757e+00  5.67267562e+00  5.67267562e+00
  5.67267562e+00  1.18867452e+01  2.40135963e+01  2.40135963e+01
  2.40135963e+01  4.02513528e+01  1.18850566e+02  1.18850566e+02
  1.18850566e+02  1.44154658e+02  5.07719283e+02  1.87481102e+03
  8.00392423e+03  4.77708944e+04]
E1 = -182.5979845958993  E_coul = 54.065750905706494
Extra cycle  E= -128.532233690193  delta_E= -5.97e-13  |g|= 6.46e-07  |ddm|= 4.43e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.31 sec
exp = [7.61752618e-01 2.44137941e+04 3.66145448e+03 8.33270829e+02
 2.35737506e+02 7.64153164e+01 1.01541184e+01 2.70696896e+01
 3.10230629e-01 1.67874702e+00 2.92991067e+00 3.67665286e+00
 1.24456540e+01 5.47855760e+01 3.29509286e-01 1.14055205e+00]
grad_E = [-5.92801851e-04  2.04632008e-11 -1.08841339e-09  3.38517744e-08
 -6.02509850e-07  3.10555926e-06 -4.37589304e-04  5.61648488e-05
  1.46743490e-03  1.59282776e-04 -1.02346820e-04 -1.37004070e-04
  6.55811546e-05 -2.41739990e-06  8.10986045e-04 -4.82644498e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.801135359957       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448269        1
[INPUT] 0    0    [1    /1   ]  833.270793534        1
[INPUT] 0    0    [1    /1   ]  235.737929186        1
[INPUT] 0    0    [1    /1   ]  76.4125789459        1
[INPUT] 0    0    [1    /1   ]  10.1704403272        1
[INPUT] 0    0    [1    /1   ]  27.0731160463        1
[INPUT] 0    0    [1    /1   ]  0.308174088919       1
[INPUT] 0    0    [1    /1   ]  1.75818399151        1
[INPUT] 0    0    [1    /1   ]  2.93909471918        1
[INPUT] 1    0    [1    /1   ]  3.67571476284        1
[INPUT] 1    0    [1    /1   ]  12.4449011688        1
[INPUT] 1    0    [1    /1   ]  54.7856193182        1
[INPUT] 1    0    [1    /1   ]  0.329368143833       1
[INPUT] 1    0    [1    /1   ]  1.14009195015        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8011353599570371, 1.0]], [0, [24413.79412974811, 1.0]], [0, [3661.4544826919628, 1.0]], [0, [833.2707935335487, 1.0]], [0, [235.73792918607055, 1.0]], [0, [76.4125789459181, 1.0]], [0, [10.170440327196799, 1.0]], [0, [27.0731160462973, 1.0]], [0, [0.3081740889190525, 1.0]], [0, [1.758183991514144, 1.0]], [0, [2.9390947191846992, 1.0]], [1, [3.6757147628384947, 1.0]], [1, [12.444901168798767, 1.0]], [1, [54.785619318211644, 1.0]], [1, [0.32936814383303364, 1.0]], [1, [1.1400919501505271, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80113536]
bas 1, expnt(s) = [24413.79412975]
bas 2, expnt(s) = [3661.45448269]
bas 3, expnt(s) = [833.27079353]
bas 4, expnt(s) = [235.73792919]
bas 5, expnt(s) = [76.41257895]
bas 6, expnt(s) = [10.17044033]
bas 7, expnt(s) = [27.07311605]
bas 8, expnt(s) = [0.30817409]
bas 9, expnt(s) = [1.75818399]
bas 10, expnt(s) = [2.93909472]
bas 11, expnt(s) = [3.67571476]
bas 12, expnt(s) = [12.44490117]
bas 13, expnt(s) = [54.78561932]
bas 14, expnt(s) = [0.32936814]
bas 15, expnt(s) = [1.14009195]
CPU time:        57.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.01135360e-01 2.13941211e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270794e+02 3.91836280e+02
 2.35737929e+02 1.51997737e+02 7.64125789e+01 6.52963142e+01
 1.01704403e+01 1.43886431e+01 2.70731160e+01 2.99860118e+01
 3.08174089e-01 1.04498995e+00 1.75818399e+00 3.85756511e+00
 2.93909472e+00 5.67120323e+00 3.67571476e+00 1.48477842e+01
 1.24449012e+01 6.81904737e+01 5.47856193e+01 4.34828110e+02
 3.29368144e-01 7.27924577e-01 1.14009195e+00 3.43683942e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998506773986215
cond(S) = 2270.0245028491236
E1 = -183.5779012339921  E_coul = 55.07851230963561
init E= -128.499388924356
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773948411549263  LUMO = 0.776833174828924
  mo_energy =
[-3.25553448e+01 -1.85289471e+00 -7.73948412e-01 -7.73948412e-01
 -7.73948412e-01  7.76833175e-01  1.11163691e+00  1.11163691e+00
  1.11163691e+00  3.98100927e+00  5.75736182e+00  5.75736182e+00
  5.75736182e+00  1.23467578e+01  2.41658986e+01  2.41658986e+01
  2.41658986e+01  4.09600931e+01  1.19060440e+02  1.19060440e+02
  1.19060440e+02  1.44932078e+02  5.08486809e+02  1.87555614e+03
  8.00463977e+03  4.77715568e+04]
E1 = -182.10958550216472  E_coul = 53.580709019238405
cycle= 1 E= -128.528876482926  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460843
diis-c [-0.21237607  1.        ]
  HOMO = -0.879711391015383  LUMO = 0.750953495148909
  mo_energy =
[-3.28742357e+01 -1.96324080e+00 -8.79711391e-01 -8.79711391e-01
 -8.79711391e-01  7.50953495e-01  1.07352386e+00  1.07352386e+00
  1.07352386e+00  3.91125063e+00  5.62856336e+00  5.62856336e+00
  5.62856336e+00  1.22081555e+01  2.39307616e+01  2.39307616e+01
  2.39307616e+01  4.07198335e+01  1.18739250e+02  1.18739250e+02
  1.18739250e+02  1.44619737e+02  5.08129499e+02  1.87516247e+03
  8.00421697e+03  4.77711152e+04]
E1 = -182.84246507524165  E_coul = 54.311078954755104
cycle= 2 E= -128.531386120487  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23008
diis-c [-6.23080434e-04  3.32016532e-01  6.67983468e-01]
  HOMO = -0.845310383807221  LUMO = 0.759388567160931
  mo_energy =
[-3.27691045e+01 -1.92707207e+00 -8.45310384e-01 -8.45310384e-01
 -8.45310384e-01  7.59388567e-01  1.08598221e+00  1.08598221e+00
  1.08598221e+00  3.93375620e+00  5.67046240e+00  5.67046240e+00
  5.67046240e+00  1.22533587e+01  2.40083938e+01  2.40083938e+01
  2.40083938e+01  4.07993613e+01  1.18844413e+02  1.18844413e+02
  1.18844413e+02  1.44722461e+02  5.08243149e+02  1.87528138e+03
  8.00433833e+03  4.77712374e+04]
E1 = -182.5966129993663  E_coul = 54.06437769919007
cycle= 3 E= -128.532235300176  delta_E= -0.000849  |g|= 0.000492  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992076
diis-c [-1.77348336e-07 -2.24734953e-03 -5.95225446e-04  1.00284257e+00]
  HOMO = -0.845555341648899  LUMO = 0.759352455440388
  mo_energy =
[-3.27695412e+01 -1.92725016e+00 -8.45555342e-01 -8.45555342e-01
 -8.45555342e-01  7.59352455e-01  1.08592716e+00  1.08592716e+00
  1.08592716e+00  3.93363477e+00  5.67024733e+00  5.67024733e+00
  5.67024733e+00  1.22531300e+01  2.40080498e+01  2.40080498e+01
  2.40080498e+01  4.07990192e+01  1.18843964e+02  1.18843964e+02
  1.18843964e+02  1.44722026e+02  5.08242606e+02  1.87528073e+03
  8.00433759e+03  4.77712367e+04]
E1 = -182.5971583071372  E_coul = 54.06492298342236
cycle= 4 E= -128.532235323715  delta_E= -2.35e-08  |g|= 6.55e-05  |ddm|= 0.000378
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135707
diis-c [-1.02720886e-09  3.33507358e-04  3.95824157e-04 -2.17770288e-01
  1.21704096e+00]
  HOMO = -0.845588294066405  LUMO = 0.759346030247175
  mo_energy =
[-3.27695943e+01 -1.92726984e+00 -8.45588294e-01 -8.45588294e-01
 -8.45588294e-01  7.59346030e-01  1.08591324e+00  1.08591324e+00
  1.08591324e+00  3.93361490e+00  5.67021110e+00  5.67021110e+00
  5.67021110e+00  1.22530947e+01  2.40080017e+01  2.40080017e+01
  2.40080017e+01  4.07989719e+01  1.18843910e+02  1.18843910e+02
  1.18843910e+02  1.44721973e+02  5.08242545e+02  1.87528066e+03
  8.00433751e+03  4.77712366e+04]
E1 = -182.59726105232232  E_coul = 54.06502572801263
cycle= 5 E= -128.53223532431  delta_E= -5.95e-10  |g|= 6.93e-06  |ddm|= 6.48e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59726105232232  E_coul = 54.06502572801263
  HOMO = -0.845584476611201  LUMO = 0.759347459864223
  mo_energy =
[-3.27695861e+01 -1.92726531e+00 -8.45584477e-01 -8.45584477e-01
 -8.45584477e-01  7.59347460e-01  1.08591484e+00  1.08591484e+00
  1.08591484e+00  3.93361804e+00  5.67021572e+00  5.67021572e+00
  5.67021572e+00  1.22530999e+01  2.40080088e+01  2.40080088e+01
  2.40080088e+01  4.07989792e+01  1.18843918e+02  1.18843918e+02
  1.18843918e+02  1.44721981e+02  5.08242553e+02  1.87528066e+03
  8.00433752e+03  4.77712366e+04]
E1 = -182.59724288726352  E_coul = 54.06500756295067
Extra cycle  E= -128.532235324313  delta_E= -3.18e-12  |g|= 2.54e-06  |ddm|= 2.78e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.01135360e-01 2.44137941e+04 3.66145448e+03 8.33270794e+02
 2.35737929e+02 7.64125789e+01 1.01704403e+01 2.70731160e+01
 3.08174089e-01 1.75818399e+00 2.93909472e+00 3.67571476e+00
 1.24449012e+01 5.47856193e+01 3.29368144e-01 1.14009195e+00]
E = -128.53223532431286
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783070059981       1
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.45448192        1
[INPUT] 0    0    [1    /1   ]  833.270809586        1
[INPUT] 0    0    [1    /1   ]  235.737734968        1
[INPUT] 0    0    [1    /1   ]  76.4138346373        1
[INPUT] 0    0    [1    /1   ]  10.1629532901        1
[INPUT] 0    0    [1    /1   ]  27.0715442972        1
[INPUT] 0    0    [1    /1   ]  0.309117446578       1
[INPUT] 0    0    [1    /1   ]  1.72174537453        1
[INPUT] 0    0    [1    /1   ]  2.93488189557        1
[INPUT] 1    0    [1    /1   ]  3.67614507905        1
[INPUT] 1    0    [1    /1   ]  12.4452465146        1
[INPUT] 1    0    [1    /1   ]  54.7855994311        1
[INPUT] 1    0    [1    /1   ]  0.32943288748        1
[INPUT] 1    0    [1    /1   ]  1.14030300111        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7830700599814425, 1.0]], [0, [24413.794129762893, 1.0]], [0, [3661.4544819174776, 1.0]], [0, [833.2708095859771, 1.0]], [0, [235.73773496774214, 1.0]], [0, [76.4138346373032, 1.0]], [0, [10.162953290069849, 1.0]], [0, [27.071544297249886, 1.0]], [0, [0.30911744657849827, 1.0]], [0, [1.7217453745293592, 1.0]], [0, [2.934881895573066, 1.0]], [1, [3.676145079045516, 1.0]], [1, [12.445246514578331, 1.0]], [1, [54.78559943108071, 1.0]], [1, [0.32943288748028454, 1.0]], [1, [1.1403030011146758, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78307006]
bas 1, expnt(s) = [24413.79412976]
bas 2, expnt(s) = [3661.45448192]
bas 3, expnt(s) = [833.27080959]
bas 4, expnt(s) = [235.73773497]
bas 5, expnt(s) = [76.41383464]
bas 6, expnt(s) = [10.16295329]
bas 7, expnt(s) = [27.0715443]
bas 8, expnt(s) = [0.30911745]
bas 9, expnt(s) = [1.72174537]
bas 10, expnt(s) = [2.9348819]
bas 11, expnt(s) = [3.67614508]
bas 12, expnt(s) = [12.44524651]
bas 13, expnt(s) = [54.78559943]
bas 14, expnt(s) = [0.32943289]
bas 15, expnt(s) = [1.140303]
CPU time:        57.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83070060e-01 2.10312695e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270810e+02 3.91836285e+02
 2.35737735e+02 1.51997643e+02 7.64138346e+01 6.52971190e+01
 1.01629533e+01 1.43806982e+01 2.70715443e+01 2.99847062e+01
 3.09117447e-01 1.04738816e+00 1.72174537e+00 3.79744697e+00
 2.93488190e+00 5.66510542e+00 3.67614508e+00 1.48499570e+01
 1.24452465e+01 6.81928391e+01 5.47855994e+01 4.34827913e+02
 3.29432887e-01 7.28103441e-01 1.14030300e+00 3.43763472e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998506538020862
cond(S) = 2113.9975198738107
E1 = -183.5778744472862  E_coul = 55.07846701129308
init E= -128.499407435993
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.77395091794664  LUMO = 0.769611634760348
  mo_energy =
[-3.25553565e+01 -1.85290007e+00 -7.73950918e-01 -7.73950918e-01
 -7.73950918e-01  7.69611635e-01  1.11189996e+00  1.11189996e+00
  1.11189996e+00  3.91714862e+00  5.75846319e+00  5.75846319e+00
  5.75846319e+00  1.21788125e+01  2.41684188e+01  2.41684188e+01
  2.41684188e+01  4.07091238e+01  1.19063433e+02  1.19063433e+02
  1.19063433e+02  1.44671747e+02  5.08246580e+02  1.87534050e+03
  8.00444999e+03  4.77713997e+04]
E1 = -182.11002741901518  E_coul = 53.58114466220803
cycle= 1 E= -128.528882756807  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.159
    CPU time for cycle= 1      0.02 sec, wall time      0.03 sec
diis-norm(errvec)=0.46085
diis-c [-0.21238314  1.        ]
  HOMO = -0.879668849567259  LUMO = 0.744107178325267
  mo_energy =
[-3.28741742e+01 -1.96321401e+00 -8.79668850e-01 -8.79668850e-01
 -8.79668850e-01  7.44107178e-01  1.07380659e+00  1.07380659e+00
  1.07380659e+00  3.84840040e+00  5.62969663e+00  5.62969663e+00
  5.62969663e+00  1.20409373e+01  2.39333399e+01  2.39333399e+01
  2.39333399e+01  4.04689513e+01  1.18742321e+02  1.18742321e+02
  1.18742321e+02  1.44359432e+02  5.07889329e+02  1.87494689e+03
  8.00402727e+03  4.77709581e+04]
E1 = -182.8427312340658  E_coul = 54.31133997634501
cycle= 2 E= -128.531391257721  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0674
    CPU time for cycle= 2      0.02 sec, wall time      0.03 sec
diis-norm(errvec)=0.230079
diis-c [-6.21661748e-04  3.32013660e-01  6.67986340e-01]
  HOMO = -0.845275706286822  LUMO = 0.752425748828834
  mo_energy =
[-3.27690683e+01 -1.92705395e+00 -8.45275706e-01 -8.45275706e-01
 -8.45275706e-01  7.52425749e-01  1.08626525e+00  1.08626525e+00
  1.08626525e+00  3.87058477e+00  5.67158952e+00  5.67158952e+00
  5.67158952e+00  1.20859066e+01  2.40109544e+01  2.40109544e+01
  2.40109544e+01  4.05484571e+01  1.18847459e+02  1.18847459e+02
  1.18847459e+02  1.44462147e+02  5.08002957e+02  1.87506579e+03
  8.00414860e+03  4.77710804e+04]
E1 = -182.59697442654183  E_coul = 54.06473449848677
cycle= 3 E= -128.532239928055  delta_E= -0.000849  |g|= 0.000485  |ddm|= 0.023
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000981685
diis-c [-1.70826231e-07 -2.23116479e-03 -5.97046281e-04  1.00282821e+00]
  HOMO = -0.845517917448968  LUMO = 0.752390870291951
  mo_energy =
[-3.27695011e+01 -1.92723067e+00 -8.45517917e-01 -8.45517917e-01
 -8.45517917e-01  7.52390870e-01  1.08621159e+00  1.08621159e+00
  1.08621159e+00  3.87046698e+00  5.67137706e+00  5.67137706e+00
  5.67137706e+00  1.20856818e+01  2.40106140e+01  2.40106140e+01
  2.40106140e+01  4.05481187e+01  1.18847014e+02  1.18847014e+02
  1.18847014e+02  1.44461716e+02  5.08002419e+02  1.87506513e+03
  8.00414786e+03  4.77710796e+04]
E1 = -182.5975165271884  E_coul = 54.06527657660624
cycle= 4 E= -128.532239950582  delta_E= -2.25e-08  |g|= 6.42e-05  |ddm|= 0.000351
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133547
diis-c [-9.98049229e-10  3.29619366e-04  3.94022016e-04 -2.16160231e-01
  1.21543659e+00]
  HOMO = -0.845550326071059  LUMO = 0.752384601863631
  mo_energy =
[-3.27695535e+01 -1.92725018e+00 -8.45550326e-01 -8.45550326e-01
 -8.45550326e-01  7.52384602e-01  1.08619792e+00  1.08619792e+00
  1.08619792e+00  3.87044769e+00  5.67134136e+00  5.67134136e+00
  5.67134136e+00  1.20856472e+01  2.40105666e+01  2.40105666e+01
  2.40105666e+01  4.05480721e+01  1.18846961e+02  1.18846961e+02
  1.18846961e+02  1.44461663e+02  5.08002358e+02  1.87506507e+03
  8.00414779e+03  4.77710795e+04]
E1 = -182.59761833286387  E_coul = 54.06537838171365
cycle= 5 E= -128.53223995115  delta_E= -5.68e-10  |g|= 6.8e-06  |ddm|= 6.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59761833286387  E_coul = 54.06537838171365
  HOMO = -0.845546576920356  LUMO = 0.752385988089089
  mo_energy =
[-3.27695453e+01 -1.92724572e+00 -8.45546577e-01 -8.45546577e-01
 -8.45546577e-01  7.52385988e-01  1.08619949e+00  1.08619949e+00
  1.08619949e+00  3.87045073e+00  5.67134591e+00  5.67134591e+00
  5.67134591e+00  1.20856522e+01  2.40105736e+01  2.40105736e+01
  2.40105736e+01  4.05480793e+01  1.18846969e+02  1.18846969e+02
  1.18846969e+02  1.44461671e+02  5.08002366e+02  1.87506507e+03
  8.00414779e+03  4.77710795e+04]
E1 = -182.5976003721828  E_coul = 54.065360421030086
Extra cycle  E= -128.532239951153  delta_E= -2.5e-12  |g|= 2.51e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.15 sec
exp = [7.83070060e-01 2.44137941e+04 3.66145448e+03 8.33270810e+02
 2.35737735e+02 7.64138346e+01 1.01629533e+01 2.70715443e+01
 3.09117447e-01 1.72174537e+00 2.93488190e+00 3.67614508e+00
 1.24452465e+01 5.47855994e+01 3.29432887e-01 1.14030300e+00]
E = -128.53223995115272
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783070059981       1
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.45448192        1
[INPUT] 0    0    [1    /1   ]  833.270809586        1
[INPUT] 0    0    [1    /1   ]  235.737734968        1
[INPUT] 0    0    [1    /1   ]  76.4138346373        1
[INPUT] 0    0    [1    /1   ]  10.1629532901        1
[INPUT] 0    0    [1    /1   ]  27.0715442972        1
[INPUT] 0    0    [1    /1   ]  0.309117446578       1
[INPUT] 0    0    [1    /1   ]  1.72174537453        1
[INPUT] 0    0    [1    /1   ]  2.93488189557        1
[INPUT] 1    0    [1    /1   ]  3.67614507905        1
[INPUT] 1    0    [1    /1   ]  12.4452465146        1
[INPUT] 1    0    [1    /1   ]  54.7855994311        1
[INPUT] 1    0    [1    /1   ]  0.32943288748        1
[INPUT] 1    0    [1    /1   ]  1.14030300111        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7830700599814425, 1.0]], [0, [24413.794129762893, 1.0]], [0, [3661.4544819174776, 1.0]], [0, [833.2708095859771, 1.0]], [0, [235.73773496774214, 1.0]], [0, [76.4138346373032, 1.0]], [0, [10.162953290069849, 1.0]], [0, [27.071544297249886, 1.0]], [0, [0.30911744657849827, 1.0]], [0, [1.7217453745293592, 1.0]], [0, [2.934881895573066, 1.0]], [1, [3.676145079045516, 1.0]], [1, [12.445246514578331, 1.0]], [1, [54.78559943108071, 1.0]], [1, [0.32943288748028454, 1.0]], [1, [1.1403030011146758, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78307006]
bas 1, expnt(s) = [24413.79412976]
bas 2, expnt(s) = [3661.45448192]
bas 3, expnt(s) = [833.27080959]
bas 4, expnt(s) = [235.73773497]
bas 5, expnt(s) = [76.41383464]
bas 6, expnt(s) = [10.16295329]
bas 7, expnt(s) = [27.0715443]
bas 8, expnt(s) = [0.30911745]
bas 9, expnt(s) = [1.72174537]
bas 10, expnt(s) = [2.9348819]
bas 11, expnt(s) = [3.67614508]
bas 12, expnt(s) = [12.44524651]
bas 13, expnt(s) = [54.78559943]
bas 14, expnt(s) = [0.32943289]
bas 15, expnt(s) = [1.140303]
CPU time:        58.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83070060e-01 2.10312695e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270810e+02 3.91836285e+02
 2.35737735e+02 1.51997643e+02 7.64138346e+01 6.52971190e+01
 1.01629533e+01 1.43806982e+01 2.70715443e+01 2.99847062e+01
 3.09117447e-01 1.04738816e+00 1.72174537e+00 3.79744697e+00
 2.93488190e+00 5.66510542e+00 3.67614508e+00 1.48499570e+01
 1.24452465e+01 6.81928391e+01 5.47855994e+01 4.34827913e+02
 3.29432887e-01 7.28103441e-01 1.14030300e+00 3.43763472e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998506538020862
cond(S) = 2113.9975198738107
E1 = -183.5778744472862  E_coul = 55.07846701129308
init E= -128.499407435993
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77395091794664  LUMO = 0.769611634760348
  mo_energy =
[-3.25553565e+01 -1.85290007e+00 -7.73950918e-01 -7.73950918e-01
 -7.73950918e-01  7.69611635e-01  1.11189996e+00  1.11189996e+00
  1.11189996e+00  3.91714862e+00  5.75846319e+00  5.75846319e+00
  5.75846319e+00  1.21788125e+01  2.41684188e+01  2.41684188e+01
  2.41684188e+01  4.07091238e+01  1.19063433e+02  1.19063433e+02
  1.19063433e+02  1.44671747e+02  5.08246580e+02  1.87534050e+03
  8.00444999e+03  4.77713997e+04]
E1 = -182.11002741901518  E_coul = 53.58114466220803
cycle= 1 E= -128.528882756807  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46085
diis-c [-0.21238314  1.        ]
  HOMO = -0.879668849567259  LUMO = 0.744107178325267
  mo_energy =
[-3.28741742e+01 -1.96321401e+00 -8.79668850e-01 -8.79668850e-01
 -8.79668850e-01  7.44107178e-01  1.07380659e+00  1.07380659e+00
  1.07380659e+00  3.84840040e+00  5.62969663e+00  5.62969663e+00
  5.62969663e+00  1.20409373e+01  2.39333399e+01  2.39333399e+01
  2.39333399e+01  4.04689513e+01  1.18742321e+02  1.18742321e+02
  1.18742321e+02  1.44359432e+02  5.07889329e+02  1.87494689e+03
  8.00402727e+03  4.77709581e+04]
E1 = -182.8427312340658  E_coul = 54.31133997634501
cycle= 2 E= -128.531391257721  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230079
diis-c [-6.21661748e-04  3.32013660e-01  6.67986340e-01]
  HOMO = -0.845275706286822  LUMO = 0.752425748828834
  mo_energy =
[-3.27690683e+01 -1.92705395e+00 -8.45275706e-01 -8.45275706e-01
 -8.45275706e-01  7.52425749e-01  1.08626525e+00  1.08626525e+00
  1.08626525e+00  3.87058477e+00  5.67158952e+00  5.67158952e+00
  5.67158952e+00  1.20859066e+01  2.40109544e+01  2.40109544e+01
  2.40109544e+01  4.05484571e+01  1.18847459e+02  1.18847459e+02
  1.18847459e+02  1.44462147e+02  5.08002957e+02  1.87506579e+03
  8.00414860e+03  4.77710804e+04]
E1 = -182.59697442654183  E_coul = 54.06473449848677
cycle= 3 E= -128.532239928055  delta_E= -0.000849  |g|= 0.000485  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000981685
diis-c [-1.70826231e-07 -2.23116479e-03 -5.97046281e-04  1.00282821e+00]
  HOMO = -0.845517917448968  LUMO = 0.752390870291951
  mo_energy =
[-3.27695011e+01 -1.92723067e+00 -8.45517917e-01 -8.45517917e-01
 -8.45517917e-01  7.52390870e-01  1.08621159e+00  1.08621159e+00
  1.08621159e+00  3.87046698e+00  5.67137706e+00  5.67137706e+00
  5.67137706e+00  1.20856818e+01  2.40106140e+01  2.40106140e+01
  2.40106140e+01  4.05481187e+01  1.18847014e+02  1.18847014e+02
  1.18847014e+02  1.44461716e+02  5.08002419e+02  1.87506513e+03
  8.00414786e+03  4.77710796e+04]
E1 = -182.5975165271884  E_coul = 54.06527657660624
cycle= 4 E= -128.532239950582  delta_E= -2.25e-08  |g|= 6.42e-05  |ddm|= 0.000351
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133547
diis-c [-9.98049229e-10  3.29619366e-04  3.94022016e-04 -2.16160231e-01
  1.21543659e+00]
  HOMO = -0.845550326071059  LUMO = 0.752384601863631
  mo_energy =
[-3.27695535e+01 -1.92725018e+00 -8.45550326e-01 -8.45550326e-01
 -8.45550326e-01  7.52384602e-01  1.08619792e+00  1.08619792e+00
  1.08619792e+00  3.87044769e+00  5.67134136e+00  5.67134136e+00
  5.67134136e+00  1.20856472e+01  2.40105666e+01  2.40105666e+01
  2.40105666e+01  4.05480721e+01  1.18846961e+02  1.18846961e+02
  1.18846961e+02  1.44461663e+02  5.08002358e+02  1.87506507e+03
  8.00414779e+03  4.77710795e+04]
E1 = -182.59761833286387  E_coul = 54.06537838171365
cycle= 5 E= -128.53223995115  delta_E= -5.68e-10  |g|= 6.8e-06  |ddm|= 6.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59761833286387  E_coul = 54.06537838171365
  HOMO = -0.845546576920356  LUMO = 0.752385988089089
  mo_energy =
[-3.27695453e+01 -1.92724572e+00 -8.45546577e-01 -8.45546577e-01
 -8.45546577e-01  7.52385988e-01  1.08619949e+00  1.08619949e+00
  1.08619949e+00  3.87045073e+00  5.67134591e+00  5.67134591e+00
  5.67134591e+00  1.20856522e+01  2.40105736e+01  2.40105736e+01
  2.40105736e+01  4.05480793e+01  1.18846969e+02  1.18846969e+02
  1.18846969e+02  1.44461671e+02  5.08002366e+02  1.87506507e+03
  8.00414779e+03  4.77710795e+04]
E1 = -182.5976003721828  E_coul = 54.065360421030086
Extra cycle  E= -128.532239951153  delta_E= -2.5e-12  |g|= 2.51e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2113.9975198738107
E1 = -182.5976003721828  E_coul = 54.065360421030086
init E= -128.532239951153
    CPU time for initialize scf      0.29 sec, wall time      0.31 sec
  HOMO = -0.845547831939686  LUMO = 0.752385749487534
  mo_energy =
[-3.27695493e+01 -1.92724693e+00 -8.45547832e-01 -8.45547832e-01
 -8.45547832e-01  7.52385749e-01  1.08619905e+00  1.08619905e+00
  1.08619905e+00  3.87045001e+00  5.67134438e+00  5.67134438e+00
  5.67134438e+00  1.20856506e+01  2.40105707e+01  2.40105707e+01
  2.40105707e+01  4.05480763e+01  1.18846965e+02  1.18846965e+02
  1.18846965e+02  1.44461667e+02  5.08002362e+02  1.87506507e+03
  8.00414779e+03  4.77710795e+04]
E1 = -182.59761006017814  E_coul = 54.065370109024634
cycle= 1 E= -128.532239951154  delta_E= -7.96e-13  |g|= 1.33e-06  |ddm|= 9.74e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59761006017814  E_coul = 54.065370109024634
  HOMO = -0.845547150595059  LUMO = 0.752385925406013
  mo_energy =
[-3.27695473e+01 -1.92724619e+00 -8.45547151e-01 -8.45547151e-01
 -8.45547151e-01  7.52385925e-01  1.08619930e+00  1.08619930e+00
  1.08619930e+00  3.87045046e+00  5.67134521e+00  5.67134521e+00
  5.67134521e+00  1.20856515e+01  2.40105722e+01  2.40105722e+01
  2.40105722e+01  4.05480779e+01  1.18846967e+02  1.18846967e+02
  1.18846967e+02  1.44461669e+02  5.08002364e+02  1.87506507e+03
  8.00414779e+03  4.77710795e+04]
E1 = -182.59760524742399  E_coul = 54.06536529627064
Extra cycle  E= -128.532239951153  delta_E= 1.71e-13  |g|= 6.55e-07  |ddm|= 4.5e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.38 sec
exp = [7.83070060e-01 2.44137941e+04 3.66145448e+03 8.33270810e+02
 2.35737735e+02 7.64138346e+01 1.01629533e+01 2.70715443e+01
 3.09117447e-01 1.72174537e+00 2.93488190e+00 3.67614508e+00
 1.24452465e+01 5.47855994e+01 3.29432887e-01 1.14030300e+00]
grad_E = [ 1.05677995e-04  4.07304646e-11 -2.16431496e-09  5.58673875e-08
 -8.87828346e-07  5.57060688e-06 -4.09247984e-04  4.30828089e-05
 -8.63663525e-05  2.45784602e-05 -7.03247119e-05 -1.45076399e-04
  6.91914384e-05 -2.51201007e-06  8.95593412e-04 -5.22572900e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.794187735465       1
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.45448239        1
[INPUT] 0    0    [1    /1   ]  833.270799828        1
[INPUT] 0    0    [1    /1   ]  235.737852867        1
[INPUT] 0    0    [1    /1   ]  76.4130615042        1
[INPUT] 0    0    [1    /1   ]  10.1669213003        1
[INPUT] 0    0    [1    /1   ]  27.0727018256        1
[INPUT] 0    0    [1    /1   ]  0.312361217908       1
[INPUT] 0    0    [1    /1   ]  1.74059250199        1
[INPUT] 0    0    [1    /1   ]  2.93835496437        1
[INPUT] 1    0    [1    /1   ]  3.67607768723        1
[INPUT] 1    0    [1    /1   ]  12.4449772101        1
[INPUT] 1    0    [1    /1   ]  54.7856136574        1
[INPUT] 1    0    [1    /1   ]  0.32932212463        1
[INPUT] 1    0    [1    /1   ]  1.14036276357        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7941877354650648, 1.0]], [0, [24413.794129753885, 1.0]], [0, [3661.454482389253, 1.0]], [0, [833.2707998280248, 1.0]], [0, [235.73785286737652, 1.0]], [0, [76.41306150416067, 1.0]], [0, [10.166921300284123, 1.0]], [0, [27.072701825629956, 1.0]], [0, [0.31236121790801724, 1.0]], [0, [1.7405925019925639, 1.0]], [0, [2.9383549643718827, 1.0]], [1, [3.6760776872285668, 1.0]], [1, [12.444977210062861, 1.0]], [1, [54.78561365736642, 1.0]], [1, [0.3293221246304182, 1.0]], [1, [1.1403627635658515, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79418774]
bas 1, expnt(s) = [24413.79412975]
bas 2, expnt(s) = [3661.45448239]
bas 3, expnt(s) = [833.27079983]
bas 4, expnt(s) = [235.73785287]
bas 5, expnt(s) = [76.4130615]
bas 6, expnt(s) = [10.1669213]
bas 7, expnt(s) = [27.07270183]
bas 8, expnt(s) = [0.31236122]
bas 9, expnt(s) = [1.7405925]
bas 10, expnt(s) = [2.93835496]
bas 11, expnt(s) = [3.67607769]
bas 12, expnt(s) = [12.44497721]
bas 13, expnt(s) = [54.78561366]
bas 14, expnt(s) = [0.32932212]
bas 15, expnt(s) = [1.14036276]
CPU time:        61.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.94187735e-01 2.12548188e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270800e+02 3.91836282e+02
 2.35737853e+02 1.51997700e+02 7.64130615e+01 6.52966235e+01
 1.01669213e+01 1.43849091e+01 2.70727018e+01 2.99856677e+01
 3.12361218e-01 1.05562060e+00 1.74059250e+00 3.82858114e+00
 2.93835496e+00 5.67013264e+00 3.67607769e+00 1.48496167e+01
 1.24449772e+01 6.81909946e+01 5.47856137e+01 4.34828054e+02
 3.29322125e-01 7.27797448e-01 1.14036276e+00 3.43785992e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998507310941248
cond(S) = 2219.327733558585
E1 = -183.57787308365002  E_coul = 55.07847019078346
init E= -128.499402892867
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773951003786138  LUMO = 0.781405643016977
  mo_energy =
[-3.25553564e+01 -1.85289905e+00 -7.73951004e-01 -7.73951004e-01
 -7.73951004e-01  7.81405643e-01  1.11159255e+00  1.11159255e+00
  1.11159255e+00  3.96913923e+00  5.75817474e+00  5.75817474e+00
  5.75817474e+00  1.22912891e+01  2.41678154e+01  2.41678154e+01
  2.41678154e+01  4.08678135e+01  1.19062343e+02  1.19062343e+02
  1.19062343e+02  1.44834003e+02  5.08395927e+02  1.87547450e+03
  8.00456791e+03  4.77714973e+04]
E1 = -182.1096358376603  E_coul = 53.58075389712243
cycle= 1 E= -128.528881940538  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460834
diis-c [-0.21236806  1.        ]
  HOMO = -0.879701104024516  LUMO = 0.755476140381881
  mo_energy =
[-3.28742351e+01 -1.96325234e+00 -8.79701104e-01 -8.79701104e-01
 -8.79701104e-01  7.55476140e-01  1.07348922e+00  1.07348922e+00
  1.07348922e+00  3.89978822e+00  5.62936605e+00  5.62936605e+00
  5.62936605e+00  1.21530162e+01  2.39326860e+01  2.39326860e+01
  2.39326860e+01  4.06275959e+01  1.18741169e+02  1.18741169e+02
  1.18741169e+02  1.44521658e+02  5.08038624e+02  1.87508084e+03
  8.00414512e+03  4.77710557e+04]
E1 = -182.8425013545185  E_coul = 54.31111016861097
cycle= 2 E= -128.531391185908  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230081
diis-c [-6.22372257e-04  3.32022349e-01  6.67977651e-01]
  HOMO = -0.845300841408803  LUMO = 0.763927145923397
  mo_energy =
[-3.27691076e+01 -1.92708438e+00 -8.45300841e-01 -8.45300841e-01
 -8.45300841e-01  7.63927146e-01  1.08594865e+00  1.08594865e+00
  1.08594865e+00  3.92216340e+00  5.67126851e+00  5.67126851e+00
  5.67126851e+00  1.21981126e+01  2.40103162e+01  2.40103162e+01
  2.40103162e+01  4.07071147e+01  1.18846329e+02  1.18846329e+02
  1.18846329e+02  1.44624384e+02  5.08152272e+02  1.87519975e+03
  8.00426648e+03  4.77711780e+04]
E1 = -182.59666396172886  E_coul = 54.06442365247469
cycle= 3 E= -128.532240309254  delta_E= -0.000849  |g|= 0.000487  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000984809
diis-c [-1.67712198e-07 -2.22997538e-03 -5.71582583e-04  1.00280156e+00]
  HOMO = -0.845544264238759  LUMO = 0.763891017860934
  mo_energy =
[-3.27695426e+01 -1.92726281e+00 -8.45544264e-01 -8.45544264e-01
 -8.45544264e-01  7.63891018e-01  1.08589447e+00  1.08589447e+00
  1.08589447e+00  3.92204341e+00  5.67105456e+00  5.67105456e+00
  5.67105456e+00  1.21978856e+01  2.40099738e+01  2.40099738e+01
  2.40099738e+01  4.07067742e+01  1.18845881e+02  1.18845881e+02
  1.18845881e+02  1.44623950e+02  5.08151731e+02  1.87519910e+03
  8.00426574e+03  4.77711772e+04]
E1 = -182.59720995474268  E_coul = 54.064969622960156
cycle= 4 E= -128.532240331783  delta_E= -2.25e-08  |g|= 6.42e-05  |ddm|= 0.000357
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013342
diis-c [-9.93090500e-10  3.27706788e-04  3.91984515e-04 -2.15004349e-01
  1.21428466e+00]
  HOMO = -0.845576748617833  LUMO = 0.76388456836726
  mo_energy =
[-3.27695952e+01 -1.92728255e+00 -8.45576749e-01 -8.45576749e-01
 -8.45576749e-01  7.63884568e-01  1.08588077e+00  1.08588077e+00
  1.08588077e+00  3.92202383e+00  5.67101875e+00  5.67101875e+00
  5.67101875e+00  1.21978507e+01  2.40099262e+01  2.40099262e+01
  2.40099262e+01  4.07067275e+01  1.18845828e+02  1.18845828e+02
  1.18845828e+02  1.44623897e+02  5.08151671e+02  1.87519903e+03
  8.00426566e+03  4.77711771e+04]
E1 = -182.5973121895143  E_coul = 54.06507185716974
cycle= 5 E= -128.532240332345  delta_E= -5.62e-10  |g|= 6.78e-06  |ddm|= 6.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5973121895143  E_coul = 54.06507185716974
  HOMO = -0.845573016730316  LUMO = 0.763885970721115
  mo_energy =
[-3.27695871e+01 -1.92727810e+00 -8.45573017e-01 -8.45573017e-01
 -8.45573017e-01  7.63885971e-01  1.08588233e+00  1.08588233e+00
  1.08588233e+00  3.92202689e+00  5.67102327e+00  5.67102327e+00
  5.67102327e+00  1.21978557e+01  2.40099332e+01  2.40099332e+01
  2.40099332e+01  4.07067346e+01  1.18845836e+02  1.18845836e+02
  1.18845836e+02  1.44623905e+02  5.08151679e+02  1.87519904e+03
  8.00426567e+03  4.77711771e+04]
E1 = -182.59729431962216  E_coul = 54.06505398727489
Extra cycle  E= -128.532240332347  delta_E= -2.73e-12  |g|= 2.5e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [7.94187735e-01 2.44137941e+04 3.66145448e+03 8.33270800e+02
 2.35737853e+02 7.64130615e+01 1.01669213e+01 2.70727018e+01
 3.12361218e-01 1.74059250e+00 2.93835496e+00 3.67607769e+00
 1.24449772e+01 5.47856137e+01 3.29322125e-01 1.14036276e+00]
E = -128.53224033234727
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.794187735465       1
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.45448239        1
[INPUT] 0    0    [1    /1   ]  833.270799828        1
[INPUT] 0    0    [1    /1   ]  235.737852867        1
[INPUT] 0    0    [1    /1   ]  76.4130615042        1
[INPUT] 0    0    [1    /1   ]  10.1669213003        1
[INPUT] 0    0    [1    /1   ]  27.0727018256        1
[INPUT] 0    0    [1    /1   ]  0.312361217908       1
[INPUT] 0    0    [1    /1   ]  1.74059250199        1
[INPUT] 0    0    [1    /1   ]  2.93835496437        1
[INPUT] 1    0    [1    /1   ]  3.67607768723        1
[INPUT] 1    0    [1    /1   ]  12.4449772101        1
[INPUT] 1    0    [1    /1   ]  54.7856136574        1
[INPUT] 1    0    [1    /1   ]  0.32932212463        1
[INPUT] 1    0    [1    /1   ]  1.14036276357        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7941877354650648, 1.0]], [0, [24413.794129753885, 1.0]], [0, [3661.454482389253, 1.0]], [0, [833.2707998280248, 1.0]], [0, [235.73785286737652, 1.0]], [0, [76.41306150416067, 1.0]], [0, [10.166921300284123, 1.0]], [0, [27.072701825629956, 1.0]], [0, [0.31236121790801724, 1.0]], [0, [1.7405925019925639, 1.0]], [0, [2.9383549643718827, 1.0]], [1, [3.6760776872285668, 1.0]], [1, [12.444977210062861, 1.0]], [1, [54.78561365736642, 1.0]], [1, [0.3293221246304182, 1.0]], [1, [1.1403627635658515, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79418774]
bas 1, expnt(s) = [24413.79412975]
bas 2, expnt(s) = [3661.45448239]
bas 3, expnt(s) = [833.27079983]
bas 4, expnt(s) = [235.73785287]
bas 5, expnt(s) = [76.4130615]
bas 6, expnt(s) = [10.1669213]
bas 7, expnt(s) = [27.07270183]
bas 8, expnt(s) = [0.31236122]
bas 9, expnt(s) = [1.7405925]
bas 10, expnt(s) = [2.93835496]
bas 11, expnt(s) = [3.67607769]
bas 12, expnt(s) = [12.44497721]
bas 13, expnt(s) = [54.78561366]
bas 14, expnt(s) = [0.32932212]
bas 15, expnt(s) = [1.14036276]
CPU time:        62.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.94187735e-01 2.12548188e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270800e+02 3.91836282e+02
 2.35737853e+02 1.51997700e+02 7.64130615e+01 6.52966235e+01
 1.01669213e+01 1.43849091e+01 2.70727018e+01 2.99856677e+01
 3.12361218e-01 1.05562060e+00 1.74059250e+00 3.82858114e+00
 2.93835496e+00 5.67013264e+00 3.67607769e+00 1.48496167e+01
 1.24449772e+01 6.81909946e+01 5.47856137e+01 4.34828054e+02
 3.29322125e-01 7.27797448e-01 1.14036276e+00 3.43785992e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998507310941248
cond(S) = 2219.327733558585
E1 = -183.57787308365002  E_coul = 55.07847019078346
init E= -128.499402892867
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773951003786138  LUMO = 0.781405643016977
  mo_energy =
[-3.25553564e+01 -1.85289905e+00 -7.73951004e-01 -7.73951004e-01
 -7.73951004e-01  7.81405643e-01  1.11159255e+00  1.11159255e+00
  1.11159255e+00  3.96913923e+00  5.75817474e+00  5.75817474e+00
  5.75817474e+00  1.22912891e+01  2.41678154e+01  2.41678154e+01
  2.41678154e+01  4.08678135e+01  1.19062343e+02  1.19062343e+02
  1.19062343e+02  1.44834003e+02  5.08395927e+02  1.87547450e+03
  8.00456791e+03  4.77714973e+04]
E1 = -182.1096358376603  E_coul = 53.58075389712243
cycle= 1 E= -128.528881940538  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460834
diis-c [-0.21236806  1.        ]
  HOMO = -0.879701104024516  LUMO = 0.755476140381881
  mo_energy =
[-3.28742351e+01 -1.96325234e+00 -8.79701104e-01 -8.79701104e-01
 -8.79701104e-01  7.55476140e-01  1.07348922e+00  1.07348922e+00
  1.07348922e+00  3.89978822e+00  5.62936605e+00  5.62936605e+00
  5.62936605e+00  1.21530162e+01  2.39326860e+01  2.39326860e+01
  2.39326860e+01  4.06275959e+01  1.18741169e+02  1.18741169e+02
  1.18741169e+02  1.44521658e+02  5.08038624e+02  1.87508084e+03
  8.00414512e+03  4.77710557e+04]
E1 = -182.8425013545185  E_coul = 54.31111016861097
cycle= 2 E= -128.531391185908  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230081
diis-c [-6.22372257e-04  3.32022349e-01  6.67977651e-01]
  HOMO = -0.845300841408803  LUMO = 0.763927145923397
  mo_energy =
[-3.27691076e+01 -1.92708438e+00 -8.45300841e-01 -8.45300841e-01
 -8.45300841e-01  7.63927146e-01  1.08594865e+00  1.08594865e+00
  1.08594865e+00  3.92216340e+00  5.67126851e+00  5.67126851e+00
  5.67126851e+00  1.21981126e+01  2.40103162e+01  2.40103162e+01
  2.40103162e+01  4.07071147e+01  1.18846329e+02  1.18846329e+02
  1.18846329e+02  1.44624384e+02  5.08152272e+02  1.87519975e+03
  8.00426648e+03  4.77711780e+04]
E1 = -182.59666396172886  E_coul = 54.06442365247469
cycle= 3 E= -128.532240309254  delta_E= -0.000849  |g|= 0.000487  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000984809
diis-c [-1.67712198e-07 -2.22997538e-03 -5.71582583e-04  1.00280156e+00]
  HOMO = -0.845544264238759  LUMO = 0.763891017860934
  mo_energy =
[-3.27695426e+01 -1.92726281e+00 -8.45544264e-01 -8.45544264e-01
 -8.45544264e-01  7.63891018e-01  1.08589447e+00  1.08589447e+00
  1.08589447e+00  3.92204341e+00  5.67105456e+00  5.67105456e+00
  5.67105456e+00  1.21978856e+01  2.40099738e+01  2.40099738e+01
  2.40099738e+01  4.07067742e+01  1.18845881e+02  1.18845881e+02
  1.18845881e+02  1.44623950e+02  5.08151731e+02  1.87519910e+03
  8.00426574e+03  4.77711772e+04]
E1 = -182.59720995474268  E_coul = 54.064969622960156
cycle= 4 E= -128.532240331783  delta_E= -2.25e-08  |g|= 6.42e-05  |ddm|= 0.000357
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013342
diis-c [-9.93090500e-10  3.27706788e-04  3.91984515e-04 -2.15004349e-01
  1.21428466e+00]
  HOMO = -0.845576748617833  LUMO = 0.76388456836726
  mo_energy =
[-3.27695952e+01 -1.92728255e+00 -8.45576749e-01 -8.45576749e-01
 -8.45576749e-01  7.63884568e-01  1.08588077e+00  1.08588077e+00
  1.08588077e+00  3.92202383e+00  5.67101875e+00  5.67101875e+00
  5.67101875e+00  1.21978507e+01  2.40099262e+01  2.40099262e+01
  2.40099262e+01  4.07067275e+01  1.18845828e+02  1.18845828e+02
  1.18845828e+02  1.44623897e+02  5.08151671e+02  1.87519903e+03
  8.00426566e+03  4.77711771e+04]
E1 = -182.5973121895143  E_coul = 54.06507185716974
cycle= 5 E= -128.532240332345  delta_E= -5.62e-10  |g|= 6.78e-06  |ddm|= 6.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5973121895143  E_coul = 54.06507185716974
  HOMO = -0.845573016730316  LUMO = 0.763885970721115
  mo_energy =
[-3.27695871e+01 -1.92727810e+00 -8.45573017e-01 -8.45573017e-01
 -8.45573017e-01  7.63885971e-01  1.08588233e+00  1.08588233e+00
  1.08588233e+00  3.92202689e+00  5.67102327e+00  5.67102327e+00
  5.67102327e+00  1.21978557e+01  2.40099332e+01  2.40099332e+01
  2.40099332e+01  4.07067346e+01  1.18845836e+02  1.18845836e+02
  1.18845836e+02  1.44623905e+02  5.08151679e+02  1.87519904e+03
  8.00426567e+03  4.77711771e+04]
E1 = -182.59729431962216  E_coul = 54.06505398727489
Extra cycle  E= -128.532240332347  delta_E= -2.73e-12  |g|= 2.5e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2219.327733558585
E1 = -182.59729431962216  E_coul = 54.06505398727489
init E= -128.532240332347
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845574265635935  LUMO = 0.763885729810057
  mo_energy =
[-3.27695911e+01 -1.92727930e+00 -8.45574266e-01 -8.45574266e-01
 -8.45574266e-01  7.63885730e-01  1.08588189e+00  1.08588189e+00
  1.08588189e+00  3.92202616e+00  5.67102175e+00  5.67102175e+00
  5.67102175e+00  1.21978542e+01  2.40099303e+01  2.40099303e+01
  2.40099303e+01  4.07067316e+01  1.18845832e+02  1.18845832e+02
  1.18845832e+02  1.44623901e+02  5.08151674e+02  1.87519903e+03
  8.00426567e+03  4.77711771e+04]
E1 = -182.59730396134034  E_coul = 54.06506362899296
cycle= 1 E= -128.532240332347  delta_E= -1.14e-13  |g|= 1.32e-06  |ddm|= 9.7e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59730396134034  E_coul = 54.06506362899296
  HOMO = -0.845573587600372  LUMO = 0.76388590770899
  mo_energy =
[-3.27695890e+01 -1.92727856e+00 -8.45573588e-01 -8.45573588e-01
 -8.45573588e-01  7.63885908e-01  1.08588214e+00  1.08588214e+00
  1.08588214e+00  3.92202661e+00  5.67102258e+00  5.67102258e+00
  5.67102258e+00  1.21978551e+01  2.40099318e+01  2.40099318e+01
  2.40099318e+01  4.07067332e+01  1.18845834e+02  1.18845834e+02
  1.18845834e+02  1.44623903e+02  5.08151677e+02  1.87519904e+03
  8.00426567e+03  4.77711771e+04]
E1 = -182.59729917130858  E_coul = 54.06505883896094
Extra cycle  E= -128.532240332348  delta_E= -2.56e-13  |g|= 6.52e-07  |ddm|= 4.48e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [7.94187735e-01 2.44137941e+04 3.66145448e+03 8.33270800e+02
 2.35737853e+02 7.64130615e+01 1.01669213e+01 2.70727018e+01
 3.12361218e-01 1.74059250e+00 2.93835496e+00 3.67607769e+00
 1.24449772e+01 5.47856137e+01 3.29322125e-01 1.14036276e+00]
grad_E = [ 1.50507571e-04  4.29849480e-11 -2.28672166e-09  5.85701595e-08
 -9.30258579e-07  6.01803866e-06 -4.06241123e-04  4.06624031e-05
 -8.18754989e-05  1.29239101e-05 -6.30522851e-05 -2.19167023e-04
  7.56660467e-05 -2.66971431e-06  2.90403099e-05 -1.50432406e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.795614793294       1
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.45448247        1
[INPUT] 0    0    [1    /1   ]  833.270798203        1
[INPUT] 0    0    [1    /1   ]  235.737872995        1
[INPUT] 0    0    [1    /1   ]  76.4129309167        1
[INPUT] 0    0    [1    /1   ]  10.1684798513        1
[INPUT] 0    0    [1    /1   ]  27.0727684585        1
[INPUT] 0    0    [1    /1   ]  0.312645413234       1
[INPUT] 0    0    [1    /1   ]  1.74382124551        1
[INPUT] 0    0    [1    /1   ]  2.93892840836        1
[INPUT] 1    0    [1    /1   ]  3.67652647701        1
[INPUT] 1    0    [1    /1   ]  12.4447757372        1
[INPUT] 1    0    [1    /1   ]  54.7856215323        1
[INPUT] 1    0    [1    /1   ]  0.329280893625       1
[INPUT] 1    0    [1    /1   ]  1.14067926791        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7956147932943428, 1.0]], [0, [24413.794129752412, 1.0]], [0, [3661.4544824665136, 1.0]], [0, [833.2707982033692, 1.0]], [0, [235.73787299485755, 1.0]], [0, [76.41293091670087, 1.0]], [0, [10.168479851328712, 1.0]], [0, [27.0727684585223, 1.0]], [0, [0.3126454132335049, 1.0]], [0, [1.7438212455095337, 1.0]], [0, [2.93892840835965, 1.0]], [1, [3.6765264770125765, 1.0]], [1, [12.444775737201233, 1.0]], [1, [54.7856215323162, 1.0]], [1, [0.3292808936245591, 1.0]], [1, [1.1406792679071216, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79561479]
bas 1, expnt(s) = [24413.79412975]
bas 2, expnt(s) = [3661.45448247]
bas 3, expnt(s) = [833.2707982]
bas 4, expnt(s) = [235.73787299]
bas 5, expnt(s) = [76.41293092]
bas 6, expnt(s) = [10.16847985]
bas 7, expnt(s) = [27.07276846]
bas 8, expnt(s) = [0.31264541]
bas 9, expnt(s) = [1.74382125]
bas 10, expnt(s) = [2.93892841]
bas 11, expnt(s) = [3.67652648]
bas 12, expnt(s) = [12.44477574]
bas 13, expnt(s) = [54.78562153]
bas 14, expnt(s) = [0.32928089]
bas 15, expnt(s) = [1.14067927]
CPU time:        65.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.95614793e-01 2.12834566e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270798e+02 3.91836281e+02
 2.35737873e+02 1.51997710e+02 7.64129309e+01 6.52965398e+01
 1.01684799e+01 1.43865629e+01 2.70727685e+01 2.99857231e+01
 3.12645413e-01 1.05634084e+00 1.74382125e+00 3.83390633e+00
 2.93892841e+00 5.67096255e+00 3.67652648e+00 1.48518829e+01
 1.24447757e+01 6.81896146e+01 5.47856215e+01 4.34828132e+02
 3.29280894e-01 7.27683550e-01 1.14067927e+00 3.43905267e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998506891024082
cond(S) = 2233.9167402835274
E1 = -183.57786458497878  E_coul = 55.078469968288864
init E= -128.49939461669
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773951069032336  LUMO = 0.782709314412693
  mo_energy =
[-3.25553567e+01 -1.85289900e+00 -7.73951069e-01 -7.73951069e-01
 -7.73951069e-01  7.82709314e-01  1.11157691e+00  1.11157691e+00
  1.11157691e+00  3.97591231e+00  5.75919057e+00  5.75919057e+00
  5.75919057e+00  1.23075887e+01  2.41698659e+01  2.41698659e+01
  2.41698659e+01  4.08931394e+01  1.19063802e+02  1.19063802e+02
  1.19063802e+02  1.44861559e+02  5.08421697e+02  1.87549769e+03
  8.00458833e+03  4.77715143e+04]
E1 = -182.10932022236722  E_coul = 53.58043856774057
cycle= 1 E= -128.528881654627  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460867
diis-c [-0.21239808  1.        ]
  HOMO = -0.879728090607185  LUMO = 0.756717388633269
  mo_energy =
[-3.28742818e+01 -1.96328288e+00 -8.79728091e-01 -8.79728091e-01
 -8.79728091e-01  7.56717389e-01  1.07345481e+00  1.07345481e+00
  1.07345481e+00  3.90645154e+00  5.63033253e+00  5.63033253e+00
  5.63033253e+00  1.21692202e+01  2.39346969e+01  2.39346969e+01
  2.39346969e+01  4.06528779e+01  1.18742583e+02  1.18742583e+02
  1.18742583e+02  1.44549174e+02  5.08064348e+02  1.87510399e+03
  8.00416550e+03  4.77710725e+04]
E1 = -182.8422939728445  E_coul = 54.31090258838165
cycle= 2 E= -128.531391384463  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230108
diis-c [-6.22575668e-04  3.32032695e-01  6.67967305e-01]
  HOMO = -0.845323324492385  LUMO = 0.765185017739078
  mo_energy =
[-3.27691402e+01 -1.92711009e+00 -8.45323324e-01 -8.45323324e-01
 -8.45323324e-01  7.65185018e-01  1.08591767e+00  1.08591767e+00
  1.08591767e+00  3.92885733e+00  5.67224602e+00  5.67224602e+00
  5.67224602e+00  1.22143432e+01  2.40123375e+01  2.40123375e+01
  2.40123375e+01  4.07324087e+01  1.18847755e+02  1.18847755e+02
  1.18847755e+02  1.44651911e+02  5.08178011e+02  1.87522292e+03
  8.00428687e+03  4.77711948e+04]
E1 = -182.59639749200775  E_coul = 54.06415665703145
cycle= 3 E= -128.532240834976  delta_E= -0.000849  |g|= 0.000489  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000987151
diis-c [-1.66765285e-07 -2.23262812e-03 -5.63508326e-04  1.00279614e+00]
  HOMO = -0.845567851584549  LUMO = 0.765148244116455
  mo_energy =
[-3.27695768e+01 -1.92728991e+00 -8.45567852e-01 -8.45567852e-01
 -8.45567852e-01  7.65148244e-01  1.08586295e+00  1.08586295e+00
  1.08586295e+00  3.92873614e+00  5.67203074e+00  5.67203074e+00
  5.67203074e+00  1.22141146e+01  2.40119935e+01  2.40119935e+01
  2.40119935e+01  4.07320666e+01  1.18847307e+02  1.18847307e+02
  1.18847307e+02  1.44651477e+02  5.08177469e+02  1.87522226e+03
  8.00428613e+03  4.77711940e+04]
E1 = -182.5969454975182  E_coul = 54.0647046399423
cycle= 4 E= -128.532240857576  delta_E= -2.26e-08  |g|= 6.42e-05  |ddm|= 0.000358
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133393
diis-c [-9.91472609e-10  3.26656547e-04  3.90625064e-04 -2.14302376e-01
  1.21358509e+00]
  HOMO = -0.845600423829557  LUMO = 0.765141714121254
  mo_energy =
[-3.27696296e+01 -1.92730982e+00 -8.45600424e-01 -8.45600424e-01
 -8.45600424e-01  7.65141714e-01  1.08584920e+00  1.08584920e+00
  1.08584920e+00  3.92871643e+00  5.67199481e+00  5.67199481e+00
  5.67199481e+00  1.22140795e+01  2.40119458e+01  2.40119458e+01
  2.40119458e+01  4.07320197e+01  1.18847253e+02  1.18847253e+02
  1.18847253e+02  1.44651424e+02  5.08177409e+02  1.87522219e+03
  8.00428606e+03  4.77711940e+04]
E1 = -182.59704786682656  E_coul = 54.06480700869066
cycle= 5 E= -128.532240858136  delta_E= -5.6e-10  |g|= 6.77e-06  |ddm|= 6.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59704786682656  E_coul = 54.06480700869066
  HOMO = -0.845596699715318  LUMO = 0.765143118359985
  mo_energy =
[-3.27696215e+01 -1.92730537e+00 -8.45596700e-01 -8.45596700e-01
 -8.45596700e-01  7.65143118e-01  1.08585076e+00  1.08585076e+00
  1.08585076e+00  3.92871948e+00  5.67199932e+00  5.67199932e+00
  5.67199932e+00  1.22140846e+01  2.40119527e+01  2.40119527e+01
  2.40119527e+01  4.07320268e+01  1.18847261e+02  1.18847261e+02
  1.18847261e+02  1.44651431e+02  5.08177416e+02  1.87522220e+03
  8.00428606e+03  4.77711940e+04]
E1 = -182.59703004457438  E_coul = 54.06478918643552
Extra cycle  E= -128.532240858139  delta_E= -2.96e-12  |g|= 2.49e-06  |ddm|= 2.53e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [7.95614793e-01 2.44137941e+04 3.66145448e+03 8.33270798e+02
 2.35737873e+02 7.64129309e+01 1.01684799e+01 2.70727685e+01
 3.12645413e-01 1.74382125e+00 2.93892841e+00 3.67652648e+00
 1.24447757e+01 5.47856215e+01 3.29280894e-01 1.14067927e+00]
E = -128.53224085813886
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.795614793294       1
[INPUT] 0    0    [1    /1   ]  24413.7941298        1
[INPUT] 0    0    [1    /1   ]  3661.45448247        1
[INPUT] 0    0    [1    /1   ]  833.270798203        1
[INPUT] 0    0    [1    /1   ]  235.737872995        1
[INPUT] 0    0    [1    /1   ]  76.4129309167        1
[INPUT] 0    0    [1    /1   ]  10.1684798513        1
[INPUT] 0    0    [1    /1   ]  27.0727684585        1
[INPUT] 0    0    [1    /1   ]  0.312645413234       1
[INPUT] 0    0    [1    /1   ]  1.74382124551        1
[INPUT] 0    0    [1    /1   ]  2.93892840836        1
[INPUT] 1    0    [1    /1   ]  3.67652647701        1
[INPUT] 1    0    [1    /1   ]  12.4447757372        1
[INPUT] 1    0    [1    /1   ]  54.7856215323        1
[INPUT] 1    0    [1    /1   ]  0.329280893625       1
[INPUT] 1    0    [1    /1   ]  1.14067926791        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7956147932943428, 1.0]], [0, [24413.794129752412, 1.0]], [0, [3661.4544824665136, 1.0]], [0, [833.2707982033692, 1.0]], [0, [235.73787299485755, 1.0]], [0, [76.41293091670087, 1.0]], [0, [10.168479851328712, 1.0]], [0, [27.0727684585223, 1.0]], [0, [0.3126454132335049, 1.0]], [0, [1.7438212455095337, 1.0]], [0, [2.93892840835965, 1.0]], [1, [3.6765264770125765, 1.0]], [1, [12.444775737201233, 1.0]], [1, [54.7856215323162, 1.0]], [1, [0.3292808936245591, 1.0]], [1, [1.1406792679071216, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79561479]
bas 1, expnt(s) = [24413.79412975]
bas 2, expnt(s) = [3661.45448247]
bas 3, expnt(s) = [833.2707982]
bas 4, expnt(s) = [235.73787299]
bas 5, expnt(s) = [76.41293092]
bas 6, expnt(s) = [10.16847985]
bas 7, expnt(s) = [27.07276846]
bas 8, expnt(s) = [0.31264541]
bas 9, expnt(s) = [1.74382125]
bas 10, expnt(s) = [2.93892841]
bas 11, expnt(s) = [3.67652648]
bas 12, expnt(s) = [12.44477574]
bas 13, expnt(s) = [54.78562153]
bas 14, expnt(s) = [0.32928089]
bas 15, expnt(s) = [1.14067927]
CPU time:        65.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.95614793e-01 2.12834566e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270798e+02 3.91836281e+02
 2.35737873e+02 1.51997710e+02 7.64129309e+01 6.52965398e+01
 1.01684799e+01 1.43865629e+01 2.70727685e+01 2.99857231e+01
 3.12645413e-01 1.05634084e+00 1.74382125e+00 3.83390633e+00
 2.93892841e+00 5.67096255e+00 3.67652648e+00 1.48518829e+01
 1.24447757e+01 6.81896146e+01 5.47856215e+01 4.34828132e+02
 3.29280894e-01 7.27683550e-01 1.14067927e+00 3.43905267e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998506891024082
cond(S) = 2233.9167402835274
E1 = -183.57786458497878  E_coul = 55.078469968288864
init E= -128.49939461669
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773951069032336  LUMO = 0.782709314412693
  mo_energy =
[-3.25553567e+01 -1.85289900e+00 -7.73951069e-01 -7.73951069e-01
 -7.73951069e-01  7.82709314e-01  1.11157691e+00  1.11157691e+00
  1.11157691e+00  3.97591231e+00  5.75919057e+00  5.75919057e+00
  5.75919057e+00  1.23075887e+01  2.41698659e+01  2.41698659e+01
  2.41698659e+01  4.08931394e+01  1.19063802e+02  1.19063802e+02
  1.19063802e+02  1.44861559e+02  5.08421697e+02  1.87549769e+03
  8.00458833e+03  4.77715143e+04]
E1 = -182.10932022236722  E_coul = 53.58043856774057
cycle= 1 E= -128.528881654627  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.460867
diis-c [-0.21239808  1.        ]
  HOMO = -0.879728090607185  LUMO = 0.756717388633269
  mo_energy =
[-3.28742818e+01 -1.96328288e+00 -8.79728091e-01 -8.79728091e-01
 -8.79728091e-01  7.56717389e-01  1.07345481e+00  1.07345481e+00
  1.07345481e+00  3.90645154e+00  5.63033253e+00  5.63033253e+00
  5.63033253e+00  1.21692202e+01  2.39346969e+01  2.39346969e+01
  2.39346969e+01  4.06528779e+01  1.18742583e+02  1.18742583e+02
  1.18742583e+02  1.44549174e+02  5.08064348e+02  1.87510399e+03
  8.00416550e+03  4.77710725e+04]
E1 = -182.8422939728445  E_coul = 54.31090258838165
cycle= 2 E= -128.531391384463  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0675
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.230108
diis-c [-6.22575668e-04  3.32032695e-01  6.67967305e-01]
  HOMO = -0.845323324492385  LUMO = 0.765185017739078
  mo_energy =
[-3.27691402e+01 -1.92711009e+00 -8.45323324e-01 -8.45323324e-01
 -8.45323324e-01  7.65185018e-01  1.08591767e+00  1.08591767e+00
  1.08591767e+00  3.92885733e+00  5.67224602e+00  5.67224602e+00
  5.67224602e+00  1.22143432e+01  2.40123375e+01  2.40123375e+01
  2.40123375e+01  4.07324087e+01  1.18847755e+02  1.18847755e+02
  1.18847755e+02  1.44651911e+02  5.08178011e+02  1.87522292e+03
  8.00428687e+03  4.77711948e+04]
E1 = -182.59639749200775  E_coul = 54.06415665703145
cycle= 3 E= -128.532240834976  delta_E= -0.000849  |g|= 0.000489  |ddm|= 0.023
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000987151
diis-c [-1.66765285e-07 -2.23262812e-03 -5.63508326e-04  1.00279614e+00]
  HOMO = -0.845567851584549  LUMO = 0.765148244116455
  mo_energy =
[-3.27695768e+01 -1.92728991e+00 -8.45567852e-01 -8.45567852e-01
 -8.45567852e-01  7.65148244e-01  1.08586295e+00  1.08586295e+00
  1.08586295e+00  3.92873614e+00  5.67203074e+00  5.67203074e+00
  5.67203074e+00  1.22141146e+01  2.40119935e+01  2.40119935e+01
  2.40119935e+01  4.07320666e+01  1.18847307e+02  1.18847307e+02
  1.18847307e+02  1.44651477e+02  5.08177469e+02  1.87522226e+03
  8.00428613e+03  4.77711940e+04]
E1 = -182.5969454975182  E_coul = 54.0647046399423
cycle= 4 E= -128.532240857576  delta_E= -2.26e-08  |g|= 6.42e-05  |ddm|= 0.000358
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000133393
diis-c [-9.91472609e-10  3.26656547e-04  3.90625064e-04 -2.14302376e-01
  1.21358509e+00]
  HOMO = -0.845600423829557  LUMO = 0.765141714121254
  mo_energy =
[-3.27696296e+01 -1.92730982e+00 -8.45600424e-01 -8.45600424e-01
 -8.45600424e-01  7.65141714e-01  1.08584920e+00  1.08584920e+00
  1.08584920e+00  3.92871643e+00  5.67199481e+00  5.67199481e+00
  5.67199481e+00  1.22140795e+01  2.40119458e+01  2.40119458e+01
  2.40119458e+01  4.07320197e+01  1.18847253e+02  1.18847253e+02
  1.18847253e+02  1.44651424e+02  5.08177409e+02  1.87522219e+03
  8.00428606e+03  4.77711940e+04]
E1 = -182.59704786682656  E_coul = 54.06480700869066
cycle= 5 E= -128.532240858136  delta_E= -5.6e-10  |g|= 6.77e-06  |ddm|= 6.23e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59704786682656  E_coul = 54.06480700869066
  HOMO = -0.845596699715318  LUMO = 0.765143118359985
  mo_energy =
[-3.27696215e+01 -1.92730537e+00 -8.45596700e-01 -8.45596700e-01
 -8.45596700e-01  7.65143118e-01  1.08585076e+00  1.08585076e+00
  1.08585076e+00  3.92871948e+00  5.67199932e+00  5.67199932e+00
  5.67199932e+00  1.22140846e+01  2.40119527e+01  2.40119527e+01
  2.40119527e+01  4.07320268e+01  1.18847261e+02  1.18847261e+02
  1.18847261e+02  1.44651431e+02  5.08177416e+02  1.87522220e+03
  8.00428606e+03  4.77711940e+04]
E1 = -182.59703004457438  E_coul = 54.06478918643552
Extra cycle  E= -128.532240858139  delta_E= -2.96e-12  |g|= 2.49e-06  |ddm|= 2.53e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2233.9167402835274
E1 = -182.59703004457438  E_coul = 54.06478918643552
init E= -128.532240858139
    CPU time for initialize scf      0.32 sec, wall time      0.36 sec
  HOMO = -0.84559794545869  LUMO = 0.76514287802957
  mo_energy =
[-3.27696254e+01 -1.92730657e+00 -8.45597945e-01 -8.45597945e-01
 -8.45597945e-01  7.65142878e-01  1.08585033e+00  1.08585033e+00
  1.08585033e+00  3.92871875e+00  5.67199781e+00  5.67199781e+00
  5.67199781e+00  1.22140830e+01  2.40119498e+01  2.40119498e+01
  2.40119498e+01  4.07320239e+01  1.18847257e+02  1.18847257e+02
  1.18847257e+02  1.44651428e+02  5.08177412e+02  1.87522219e+03
  8.00428606e+03  4.77711940e+04]
E1 = -182.5970396631143  E_coul = 54.06479880497507
cycle= 1 E= -128.532240858139  delta_E= -3.69e-13  |g|= 1.32e-06  |ddm|= 9.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5970396631143  E_coul = 54.06479880497507
  HOMO = -0.845597269092295  LUMO = 0.765143055911718
  mo_energy =
[-3.27696234e+01 -1.92730583e+00 -8.45597269e-01 -8.45597269e-01
 -8.45597269e-01  7.65143056e-01  1.08585058e+00  1.08585058e+00
  1.08585058e+00  3.92871921e+00  5.67199864e+00  5.67199864e+00
  5.67199864e+00  1.22140839e+01  2.40119513e+01  2.40119513e+01
  2.40119513e+01  4.07320254e+01  1.18847259e+02  1.18847259e+02
  1.18847259e+02  1.44651430e+02  5.08177414e+02  1.87522220e+03
  8.00428606e+03  4.77711940e+04]
E1 = -182.59703488439223  E_coul = 54.06479402625282
Extra cycle  E= -128.532240858139  delta_E= -1.71e-13  |g|= 6.5e-07  |ddm|= 4.47e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.45 sec
exp = [7.95614793e-01 2.44137941e+04 3.66145448e+03 8.33270798e+02
 2.35737873e+02 7.64129309e+01 1.01684799e+01 2.70727685e+01
 3.12645413e-01 1.74382125e+00 2.93892841e+00 3.67652648e+00
 1.24447757e+01 5.47856215e+01 3.29280894e-01 1.14067927e+00]
grad_E = [ 1.63135052e-04  4.93699924e-11 -2.62253177e-09  6.53519461e-08
 -1.01224980e-06  6.66125135e-06 -4.01534072e-04  3.78012002e-05
 -1.03907708e-04  1.03574099e-05 -6.25343612e-05 -2.80761882e-04
  7.66479503e-05 -2.57956865e-06 -8.02209733e-04  2.42504573e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.804178885229       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448295        1
[INPUT] 0    0    [1    /1   ]  833.270787959        1
[INPUT] 0    0    [1    /1   ]  235.738000088        1
[INPUT] 0    0    [1    /1   ]  76.4121055546        1
[INPUT] 0    0    [1    /1   ]  10.178548924         1
[INPUT] 0    0    [1    /1   ]  27.0731671742        1
[INPUT] 0    0    [1    /1   ]  0.314743132911       1
[INPUT] 0    0    [1    /1   ]  1.76424796056        1
[INPUT] 0    0    [1    /1   ]  2.94251879632        1
[INPUT] 1    0    [1    /1   ]  3.67954511223        1
[INPUT] 1    0    [1    /1   ]  12.4434651963        1
[INPUT] 1    0    [1    /1   ]  54.7856720888        1
[INPUT] 1    0    [1    /1   ]  0.329409527329       1
[INPUT] 1    0    [1    /1   ]  1.14244044769        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8041788852289348, 1.0]], [0, [24413.794129743128, 1.0]], [0, [3661.4544829533133, 1.0]], [0, [833.2707879589639, 1.0]], [0, [235.73800008793043, 1.0]], [0, [76.4121055545754, 1.0]], [0, [10.178548923952668, 1.0]], [0, [27.073167174168653, 1.0]], [0, [0.3147431329112227, 1.0]], [0, [1.7642479605642276, 1.0]], [0, [2.9425187963226596, 1.0]], [1, [3.679545112227334, 1.0]], [1, [12.443465196250598, 1.0]], [1, [54.785672088810735, 1.0]], [1, [0.3294095273289617, 1.0]], [1, [1.1424404476889156, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80417889]
bas 1, expnt(s) = [24413.79412974]
bas 2, expnt(s) = [3661.45448295]
bas 3, expnt(s) = [833.27078796]
bas 4, expnt(s) = [235.73800009]
bas 5, expnt(s) = [76.41210555]
bas 6, expnt(s) = [10.17854892]
bas 7, expnt(s) = [27.07316717]
bas 8, expnt(s) = [0.31474313]
bas 9, expnt(s) = [1.76424796]
bas 10, expnt(s) = [2.9425188]
bas 11, expnt(s) = [3.67954511]
bas 12, expnt(s) = [12.4434652]
bas 13, expnt(s) = [54.78567209]
bas 14, expnt(s) = [0.32940953]
bas 15, expnt(s) = [1.14244045]
CPU time:        69.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.04178885e-01 2.14550496e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270788e+02 3.91836278e+02
 2.35738000e+02 1.51997771e+02 7.64121056e+01 6.52960108e+01
 1.01785489e+01 1.43972460e+01 2.70731672e+01 2.99860543e+01
 3.14743133e-01 1.06165210e+00 1.76424796e+00 3.86753936e+00
 2.94251880e+00 5.67615777e+00 3.67954511e+00 1.48671272e+01
 1.24434652e+01 6.81806386e+01 5.47856721e+01 4.34828634e+02
 3.29409527e-01 7.28038904e-01 1.14244045e+00 3.44569122e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998499920952707
cond(S) = 2328.671668825544
E1 = -183.5778431144849  E_coul = 55.078478930481175
init E= -128.499364184004
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773949491178693  LUMO = 0.791389730074261
  mo_energy =
[-3.25553587e+01 -1.85289755e+00 -7.73949491e-01 -7.73949491e-01
 -7.73949491e-01  7.91389730e-01  1.11254631e+00  1.11254631e+00
  1.11254631e+00  4.01886073e+00  5.76652591e+00  5.76652591e+00
  5.76652591e+00  1.24100903e+01  2.41836579e+01  2.41836579e+01
  2.41836579e+01  4.10527910e+01  1.19073629e+02  1.19073629e+02
  1.19073629e+02  1.45035762e+02  5.08584738e+02  1.87564446e+03
  8.00471758e+03  4.77716213e+04]
E1 = -182.10890993142013  E_coul = 53.58002596415613
cycle= 1 E= -128.528883967264  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460835
diis-c [-0.21236898  1.        ]
  HOMO = -0.879766517035289  LUMO = 0.765061526149673
  mo_energy =
[-3.28743293e+01 -1.96332780e+00 -8.79766517e-01 -8.79766517e-01
 -8.79766517e-01  7.65061526e-01  1.07435035e+00  1.07435035e+00
  1.07435035e+00  3.94883148e+00  5.63752486e+00  5.63752486e+00
  5.63752486e+00  1.22712872e+01  2.39484500e+01  2.39484500e+01
  2.39484500e+01  4.08124586e+01  1.18752367e+02  1.18752367e+02
  1.18752367e+02  1.44723356e+02  5.08227352e+02  1.87525071e+03
  8.00429471e+03  4.77711795e+04]
E1 = -182.84190777630525  E_coul = 54.310514017180054
cycle= 2 E= -128.531393759125  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230097
diis-c [-6.23260611e-04  3.32035907e-01  6.67964093e-01]
  HOMO = -0.845361490362209  LUMO = 0.773628438810761
  mo_energy =
[-3.27691819e+01 -1.92715471e+00 -8.45361490e-01 -8.45361490e-01
 -8.45361490e-01  7.73628439e-01  1.08683035e+00  1.08683035e+00
  1.08683035e+00  3.97140824e+00  5.67947032e+00  5.67947032e+00
  5.67947032e+00  1.23165387e+01  2.40260925e+01  2.40260925e+01
  2.40260925e+01  4.08920017e+01  1.18857544e+02  1.18857544e+02
  1.18857544e+02  1.44826091e+02  5.08341018e+02  1.87536965e+03
  8.00441609e+03  4.77713018e+04]
E1 = -182.5959571513777  E_coul = 54.063713696767785
cycle= 3 E= -128.53224345461  delta_E= -0.00085  |g|= 0.000494  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000994408
diis-c [-1.63920343e-07 -2.23913576e-03 -5.34314584e-04  1.00277345e+00]
  HOMO = -0.845608951436816  LUMO = 0.773589713077181
  mo_energy =
[-3.27696229e+01 -1.92733821e+00 -8.45608951e-01 -8.45608951e-01
 -8.45608951e-01  7.73589713e-01  1.08677416e+00  1.08677416e+00
  1.08677416e+00  3.97128336e+00  5.67925137e+00  5.67925137e+00
  5.67925137e+00  1.23163056e+01  2.40257441e+01  2.40257441e+01
  2.40257441e+01  4.08916552e+01  1.18857091e+02  1.18857091e+02
  1.18857091e+02  1.44825652e+02  5.08340473e+02  1.87536899e+03
  8.00441534e+03  4.77713010e+04]
E1 = -182.5965121246767  E_coul = 54.0642686472866
cycle= 4 E= -128.53224347739  delta_E= -2.28e-08  |g|= 6.43e-05  |ddm|= 0.000364
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133341
diis-c [-9.86087192e-10  3.24239298e-04  3.86622571e-04 -2.12512081e-01
  1.21180122e+00]
  HOMO = -0.845641718004735  LUMO = 0.773582948153201
  mo_energy =
[-3.27696759e+01 -1.92735850e+00 -8.45641718e-01 -8.45641718e-01
 -8.45641718e-01  7.73582948e-01  1.08676030e+00  1.08676030e+00
  1.08676030e+00  3.97126324e+00  5.67921516e+00  5.67921516e+00
  5.67921516e+00  1.23162701e+01  2.40256961e+01  2.40256961e+01
  2.40256961e+01  4.08916079e+01  1.18857037e+02  1.18857037e+02
  1.18857037e+02  1.44825599e+02  5.08340412e+02  1.87536892e+03
  8.00441527e+03  4.77713010e+04]
E1 = -182.5966149262254  E_coul = 54.06437144828123
cycle= 5 E= -128.532243477944  delta_E= -5.54e-10  |g|= 6.75e-06  |ddm|= 6.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5966149262254  E_coul = 54.06437144828123
  HOMO = -0.845638016613287  LUMO = 0.773584364582921
  mo_energy =
[-3.27696679e+01 -1.92735408e+00 -8.45638017e-01 -8.45638017e-01
 -8.45638017e-01  7.73584365e-01  1.08676186e+00  1.08676186e+00
  1.08676186e+00  3.97126630e+00  5.67921966e+00  5.67921966e+00
  5.67921966e+00  1.23162752e+01  2.40257030e+01  2.40257030e+01
  2.40257030e+01  4.08916150e+01  1.18857045e+02  1.18857045e+02
  1.18857045e+02  1.44825606e+02  5.08340420e+02  1.87536893e+03
  8.00441527e+03  4.77713010e+04]
E1 = -182.59659724278538  E_coul = 54.06435376483816
Extra cycle  E= -128.532243477947  delta_E= -3.04e-12  |g|= 2.48e-06  |ddm|= 2.53e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.04178885e-01 2.44137941e+04 3.66145448e+03 8.33270788e+02
 2.35738000e+02 7.64121056e+01 1.01785489e+01 2.70731672e+01
 3.14743133e-01 1.76424796e+00 2.94251880e+00 3.67954511e+00
 1.24434652e+01 5.47856721e+01 3.29409527e-01 1.14244045e+00]
E = -128.53224347794722
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.804178885229       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448295        1
[INPUT] 0    0    [1    /1   ]  833.270787959        1
[INPUT] 0    0    [1    /1   ]  235.738000088        1
[INPUT] 0    0    [1    /1   ]  76.4121055546        1
[INPUT] 0    0    [1    /1   ]  10.178548924         1
[INPUT] 0    0    [1    /1   ]  27.0731671742        1
[INPUT] 0    0    [1    /1   ]  0.314743132911       1
[INPUT] 0    0    [1    /1   ]  1.76424796056        1
[INPUT] 0    0    [1    /1   ]  2.94251879632        1
[INPUT] 1    0    [1    /1   ]  3.67954511223        1
[INPUT] 1    0    [1    /1   ]  12.4434651963        1
[INPUT] 1    0    [1    /1   ]  54.7856720888        1
[INPUT] 1    0    [1    /1   ]  0.329409527329       1
[INPUT] 1    0    [1    /1   ]  1.14244044769        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8041788852289348, 1.0]], [0, [24413.794129743128, 1.0]], [0, [3661.4544829533133, 1.0]], [0, [833.2707879589639, 1.0]], [0, [235.73800008793043, 1.0]], [0, [76.4121055545754, 1.0]], [0, [10.178548923952668, 1.0]], [0, [27.073167174168653, 1.0]], [0, [0.3147431329112227, 1.0]], [0, [1.7642479605642276, 1.0]], [0, [2.9425187963226596, 1.0]], [1, [3.679545112227334, 1.0]], [1, [12.443465196250598, 1.0]], [1, [54.785672088810735, 1.0]], [1, [0.3294095273289617, 1.0]], [1, [1.1424404476889156, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80417889]
bas 1, expnt(s) = [24413.79412974]
bas 2, expnt(s) = [3661.45448295]
bas 3, expnt(s) = [833.27078796]
bas 4, expnt(s) = [235.73800009]
bas 5, expnt(s) = [76.41210555]
bas 6, expnt(s) = [10.17854892]
bas 7, expnt(s) = [27.07316717]
bas 8, expnt(s) = [0.31474313]
bas 9, expnt(s) = [1.76424796]
bas 10, expnt(s) = [2.9425188]
bas 11, expnt(s) = [3.67954511]
bas 12, expnt(s) = [12.4434652]
bas 13, expnt(s) = [54.78567209]
bas 14, expnt(s) = [0.32940953]
bas 15, expnt(s) = [1.14244045]
CPU time:        69.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.04178885e-01 2.14550496e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270788e+02 3.91836278e+02
 2.35738000e+02 1.51997771e+02 7.64121056e+01 6.52960108e+01
 1.01785489e+01 1.43972460e+01 2.70731672e+01 2.99860543e+01
 3.14743133e-01 1.06165210e+00 1.76424796e+00 3.86753936e+00
 2.94251880e+00 5.67615777e+00 3.67954511e+00 1.48671272e+01
 1.24434652e+01 6.81806386e+01 5.47856721e+01 4.34828634e+02
 3.29409527e-01 7.28038904e-01 1.14244045e+00 3.44569122e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998499920952707
cond(S) = 2328.671668825544
E1 = -183.5778431144849  E_coul = 55.078478930481175
init E= -128.499364184004
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773949491178693  LUMO = 0.791389730074261
  mo_energy =
[-3.25553587e+01 -1.85289755e+00 -7.73949491e-01 -7.73949491e-01
 -7.73949491e-01  7.91389730e-01  1.11254631e+00  1.11254631e+00
  1.11254631e+00  4.01886073e+00  5.76652591e+00  5.76652591e+00
  5.76652591e+00  1.24100903e+01  2.41836579e+01  2.41836579e+01
  2.41836579e+01  4.10527910e+01  1.19073629e+02  1.19073629e+02
  1.19073629e+02  1.45035762e+02  5.08584738e+02  1.87564446e+03
  8.00471758e+03  4.77716213e+04]
E1 = -182.10890993142013  E_coul = 53.58002596415613
cycle= 1 E= -128.528883967264  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460835
diis-c [-0.21236898  1.        ]
  HOMO = -0.879766517035289  LUMO = 0.765061526149673
  mo_energy =
[-3.28743293e+01 -1.96332780e+00 -8.79766517e-01 -8.79766517e-01
 -8.79766517e-01  7.65061526e-01  1.07435035e+00  1.07435035e+00
  1.07435035e+00  3.94883148e+00  5.63752486e+00  5.63752486e+00
  5.63752486e+00  1.22712872e+01  2.39484500e+01  2.39484500e+01
  2.39484500e+01  4.08124586e+01  1.18752367e+02  1.18752367e+02
  1.18752367e+02  1.44723356e+02  5.08227352e+02  1.87525071e+03
  8.00429471e+03  4.77711795e+04]
E1 = -182.84190777630525  E_coul = 54.310514017180054
cycle= 2 E= -128.531393759125  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230097
diis-c [-6.23260611e-04  3.32035907e-01  6.67964093e-01]
  HOMO = -0.845361490362209  LUMO = 0.773628438810761
  mo_energy =
[-3.27691819e+01 -1.92715471e+00 -8.45361490e-01 -8.45361490e-01
 -8.45361490e-01  7.73628439e-01  1.08683035e+00  1.08683035e+00
  1.08683035e+00  3.97140824e+00  5.67947032e+00  5.67947032e+00
  5.67947032e+00  1.23165387e+01  2.40260925e+01  2.40260925e+01
  2.40260925e+01  4.08920017e+01  1.18857544e+02  1.18857544e+02
  1.18857544e+02  1.44826091e+02  5.08341018e+02  1.87536965e+03
  8.00441609e+03  4.77713018e+04]
E1 = -182.5959571513777  E_coul = 54.063713696767785
cycle= 3 E= -128.53224345461  delta_E= -0.00085  |g|= 0.000494  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000994408
diis-c [-1.63920343e-07 -2.23913576e-03 -5.34314584e-04  1.00277345e+00]
  HOMO = -0.845608951436816  LUMO = 0.773589713077181
  mo_energy =
[-3.27696229e+01 -1.92733821e+00 -8.45608951e-01 -8.45608951e-01
 -8.45608951e-01  7.73589713e-01  1.08677416e+00  1.08677416e+00
  1.08677416e+00  3.97128336e+00  5.67925137e+00  5.67925137e+00
  5.67925137e+00  1.23163056e+01  2.40257441e+01  2.40257441e+01
  2.40257441e+01  4.08916552e+01  1.18857091e+02  1.18857091e+02
  1.18857091e+02  1.44825652e+02  5.08340473e+02  1.87536899e+03
  8.00441534e+03  4.77713010e+04]
E1 = -182.5965121246767  E_coul = 54.0642686472866
cycle= 4 E= -128.53224347739  delta_E= -2.28e-08  |g|= 6.43e-05  |ddm|= 0.000364
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133341
diis-c [-9.86087192e-10  3.24239298e-04  3.86622571e-04 -2.12512081e-01
  1.21180122e+00]
  HOMO = -0.845641718004735  LUMO = 0.773582948153201
  mo_energy =
[-3.27696759e+01 -1.92735850e+00 -8.45641718e-01 -8.45641718e-01
 -8.45641718e-01  7.73582948e-01  1.08676030e+00  1.08676030e+00
  1.08676030e+00  3.97126324e+00  5.67921516e+00  5.67921516e+00
  5.67921516e+00  1.23162701e+01  2.40256961e+01  2.40256961e+01
  2.40256961e+01  4.08916079e+01  1.18857037e+02  1.18857037e+02
  1.18857037e+02  1.44825599e+02  5.08340412e+02  1.87536892e+03
  8.00441527e+03  4.77713010e+04]
E1 = -182.5966149262254  E_coul = 54.06437144828123
cycle= 5 E= -128.532243477944  delta_E= -5.54e-10  |g|= 6.75e-06  |ddm|= 6.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5966149262254  E_coul = 54.06437144828123
  HOMO = -0.845638016613287  LUMO = 0.773584364582921
  mo_energy =
[-3.27696679e+01 -1.92735408e+00 -8.45638017e-01 -8.45638017e-01
 -8.45638017e-01  7.73584365e-01  1.08676186e+00  1.08676186e+00
  1.08676186e+00  3.97126630e+00  5.67921966e+00  5.67921966e+00
  5.67921966e+00  1.23162752e+01  2.40257030e+01  2.40257030e+01
  2.40257030e+01  4.08916150e+01  1.18857045e+02  1.18857045e+02
  1.18857045e+02  1.44825606e+02  5.08340420e+02  1.87536893e+03
  8.00441527e+03  4.77713010e+04]
E1 = -182.59659724278538  E_coul = 54.06435376483816
Extra cycle  E= -128.532243477947  delta_E= -3.04e-12  |g|= 2.48e-06  |ddm|= 2.53e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2328.671668825544
E1 = -182.59659724278538  E_coul = 54.06435376483816
init E= -128.532243477947
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845639253027971  LUMO = 0.773584124113683
  mo_energy =
[-3.27696718e+01 -1.92735526e+00 -8.45639253e-01 -8.45639253e-01
 -8.45639253e-01  7.73584124e-01  1.08676143e+00  1.08676143e+00
  1.08676143e+00  3.97126558e+00  5.67921815e+00  5.67921815e+00
  5.67921815e+00  1.23162736e+01  2.40257002e+01  2.40257002e+01
  2.40257002e+01  4.08916120e+01  1.18857041e+02  1.18857041e+02
  1.18857041e+02  1.44825603e+02  5.08340415e+02  1.87536892e+03
  8.00441527e+03  4.77713010e+04]
E1 = -182.59660679157113  E_coul = 54.06436331362349
cycle= 1 E= -128.532243477948  delta_E= -4.26e-13  |g|= 1.31e-06  |ddm|= 9.62e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59660679157113  E_coul = 54.06436331362349
  HOMO = -0.845638581673082  LUMO = 0.773584302956202
  mo_energy =
[-3.27696698e+01 -1.92735453e+00 -8.45638582e-01 -8.45638582e-01
 -8.45638582e-01  7.73584303e-01  1.08676167e+00  1.08676167e+00
  1.08676167e+00  3.97126603e+00  5.67921897e+00  5.67921897e+00
  5.67921897e+00  1.23162745e+01  2.40257017e+01  2.40257017e+01
  2.40257017e+01  4.08916136e+01  1.18857043e+02  1.18857043e+02
  1.18857043e+02  1.44825605e+02  5.08340417e+02  1.87536892e+03
  8.00441527e+03  4.77713010e+04]
E1 = -182.59660204729292  E_coul = 54.064358569345316
Extra cycle  E= -128.532243477948  delta_E= 5.68e-14  |g|= 6.46e-07  |ddm|= 4.44e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.04178885e-01 2.44137941e+04 3.66145448e+03 8.33270788e+02
 2.35738000e+02 7.64121056e+01 1.01785489e+01 2.70731672e+01
 3.14743133e-01 1.76424796e+00 2.94251880e+00 3.67954511e+00
 1.24434652e+01 5.47856721e+01 3.29409527e-01 1.14244045e+00]
grad_E = [ 1.97993622e-04  9.03123453e-11 -4.77509443e-09  1.08828642e-07
 -1.53702006e-06  1.07688768e-05 -3.72625471e-04  1.97273387e-05
 -1.33877291e-04  1.82770287e-06 -6.09302359e-05 -3.81465189e-04
  5.35694033e-05 -9.95010500e-07 -2.95148882e-03  1.34803105e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.80967949256        1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448341        1
[INPUT] 0    0    [1    /1   ]  833.270778214        1
[INPUT] 0    0    [1    /1   ]  235.738123557        1
[INPUT] 0    0    [1    /1   ]  76.4113085887        1
[INPUT] 0    0    [1    /1   ]  10.1926205569        1
[INPUT] 0    0    [1    /1   ]  27.0729367652        1
[INPUT] 0    0    [1    /1   ]  0.31583566801        1
[INPUT] 0    0    [1    /1   ]  1.78417794773        1
[INPUT] 0    0    [1    /1   ]  2.9458364819         1
[INPUT] 1    0    [1    /1   ]  3.68469688152        1
[INPUT] 1    0    [1    /1   ]  12.4414882655        1
[INPUT] 1    0    [1    /1   ]  54.7857441829        1
[INPUT] 1    0    [1    /1   ]  0.329903148672       1
[INPUT] 1    0    [1    /1   ]  1.14504480604        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8096794925601444, 1.0]], [0, [24413.79412973443, 1.0]], [0, [3661.4544834098874, 1.0]], [0, [833.270778213908, 1.0]], [0, [235.73812355696472, 1.0]], [0, [76.41130858872975, 1.0]], [0, [10.192620556891994, 1.0]], [0, [27.072936765248837, 1.0]], [0, [0.3158356680096916, 1.0]], [0, [1.7841779477302608, 1.0]], [0, [2.945836481902627, 1.0]], [1, [3.684696881522236, 1.0]], [1, [12.441488265472739, 1.0]], [1, [54.78574418289869, 1.0]], [1, [0.32990314867193726, 1.0]], [1, [1.145044806039126, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80967949]
bas 1, expnt(s) = [24413.79412973]
bas 2, expnt(s) = [3661.45448341]
bas 3, expnt(s) = [833.27077821]
bas 4, expnt(s) = [235.73812356]
bas 5, expnt(s) = [76.41130859]
bas 6, expnt(s) = [10.19262056]
bas 7, expnt(s) = [27.07293677]
bas 8, expnt(s) = [0.31583567]
bas 9, expnt(s) = [1.78417795]
bas 10, expnt(s) = [2.94583648]
bas 11, expnt(s) = [3.68469688]
bas 12, expnt(s) = [12.44148827]
bas 13, expnt(s) = [54.78574418]
bas 14, expnt(s) = [0.32990315]
bas 15, expnt(s) = [1.14504481]
CPU time:        72.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09679493e-01 2.15650207e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270778e+02 3.91836274e+02
 2.35738124e+02 1.51997831e+02 7.64113086e+01 6.52955001e+01
 1.01926206e+01 1.44121714e+01 2.70729368e+01 2.99858629e+01
 3.15835668e-01 1.06441480e+00 1.78417795e+00 3.90026081e+00
 2.94583648e+00 5.68095699e+00 3.68469688e+00 1.48931513e+01
 1.24414883e+01 6.81670987e+01 5.47857442e+01 4.34829349e+02
 3.29903149e-01 7.29402871e-01 1.14504481e+00 3.45551270e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486220801997
cond(S) = 2405.1168728507578
E1 = -183.57782748529638  E_coul = 55.07849670970355
init E= -128.499330775593
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945795368503  LUMO = 0.796884573737787
  mo_energy =
[-3.25553616e+01 -1.85289558e+00 -7.73945795e-01 -7.73945795e-01
 -7.73945795e-01  7.96884574e-01  1.11487229e+00  1.11487229e+00
  1.11487229e+00  4.05060386e+00  5.77896287e+00  5.77896287e+00
  5.77896287e+00  1.24950620e+01  2.42069084e+01  2.42069084e+01
  2.42069084e+01  4.11984091e+01  1.19090725e+02  1.19090725e+02
  1.19090725e+02  1.45203474e+02  5.08743768e+02  1.87578798e+03
  8.00484405e+03  4.77717260e+04]
E1 = -182.10941569247376  E_coul = 53.58052543808053
cycle= 1 E= -128.528890254393  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460673
diis-c [-0.21221987  1.        ]
  HOMO = -0.879731385176839  LUMO = 0.770359672256001
  mo_energy =
[-3.28742242e+01 -1.96328939e+00 -8.79731385e-01 -8.79731385e-01
 -8.79731385e-01  7.70359672e-01  1.07659206e+00  1.07659206e+00
  1.07659206e+00  3.98015431e+00  5.64985569e+00  5.64985569e+00
  5.64985569e+00  1.23559286e+01  2.39717902e+01  2.39717902e+01
  2.39717902e+01  4.09581069e+01  1.18769580e+02  1.18769580e+02
  1.18769580e+02  1.44891191e+02  5.08386499e+02  1.87539434e+03
  8.00442129e+03  4.77712844e+04]
E1 = -182.8419804339364  E_coul = 54.31058242269242
cycle= 2 E= -128.531398011244  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229981
diis-c [-6.23513337e-04  3.32000548e-01  6.67999452e-01]
  HOMO = -0.84534617902145  LUMO = 0.778986524263548
  mo_energy =
[-3.27691275e+01 -1.92713771e+00 -8.45346179e-01 -8.45346179e-01
 -8.45346179e-01  7.78986524e-01  1.08909615e+00  1.08909615e+00
  1.08909615e+00  4.00286003e+00  5.69182570e+00  5.69182570e+00
  5.69182570e+00  1.24012783e+01  2.40493910e+01  2.40493910e+01
  2.40493910e+01  4.10376271e+01  1.18874703e+02  1.18874703e+02
  1.18874703e+02  1.44993870e+02  5.08500109e+02  1.87551322e+03
  8.00454261e+03  4.77714066e+04]
E1 = -182.59617701675114  E_coul = 54.063930240278076
cycle= 3 E= -128.532246776473  delta_E= -0.000849  |g|= 0.000496  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999215
diis-c [-1.63525881e-07 -2.24422836e-03 -5.19118501e-04  1.00276335e+00]
  HOMO = -0.845595054945976  LUMO = 0.778946884468627
  mo_energy =
[-3.27695706e+01 -1.92732276e+00 -8.45595055e-01 -8.45595055e-01
 -8.45595055e-01  7.78946884e-01  1.08903912e+00  1.08903912e+00
  1.08903912e+00  4.00273315e+00  5.69160480e+00  5.69160480e+00
  5.69160480e+00  1.24010428e+01  2.40490405e+01  2.40490405e+01
  2.40490405e+01  4.10372783e+01  1.18874248e+02  1.18874248e+02
  1.18874248e+02  1.44993429e+02  5.08499562e+02  1.87551256e+03
  8.00454186e+03  4.77714058e+04]
E1 = -182.59673674820468  E_coul = 54.06448994881537
cycle= 4 E= -128.532246799389  delta_E= -2.29e-08  |g|= 6.44e-05  |ddm|= 0.000367
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133454
diis-c [-9.85254486e-10  3.24502374e-04  3.84528797e-04 -2.12178217e-01
  1.21146919e+00]
  HOMO = -0.845627877760897  LUMO = 0.778940039495
  mo_energy =
[-3.27696237e+01 -1.92734314e+00 -8.45627878e-01 -8.45627878e-01
 -8.45627878e-01  7.78940039e-01  1.08902521e+00  1.08902521e+00
  1.08902521e+00  4.00271285e+00  5.69156850e+00  5.69156850e+00
  5.69156850e+00  1.24010072e+01  2.40489924e+01  2.40489924e+01
  2.40489924e+01  4.10372310e+01  1.18874195e+02  1.18874195e+02
  1.18874195e+02  1.44993375e+02  5.08499501e+02  1.87551249e+03
  8.00454179e+03  4.77714057e+04]
E1 = -182.59683971706488  E_coul = 54.064592917122084
cycle= 5 E= -128.532246799943  delta_E= -5.54e-10  |g|= 6.74e-06  |ddm|= 6.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59683971706488  E_coul = 54.064592917122084
  HOMO = -0.845624179258985  LUMO = 0.778941465956662
  mo_energy =
[-3.27696157e+01 -1.92733871e+00 -8.45624179e-01 -8.45624179e-01
 -8.45624179e-01  7.78941466e-01  1.08902677e+00  1.08902677e+00
  1.08902677e+00  4.00271593e+00  5.69157299e+00  5.69157299e+00
  5.69157299e+00  1.24010122e+01  2.40489993e+01  2.40489993e+01
  2.40489993e+01  4.10372381e+01  1.18874202e+02  1.18874202e+02
  1.18874202e+02  1.44993383e+02  5.08499509e+02  1.87551250e+03
  8.00454180e+03  4.77714057e+04]
E1 = -182.59682207207254  E_coul = 54.06457527212698
Extra cycle  E= -128.532246799946  delta_E= -2.76e-12  |g|= 2.47e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [8.09679493e-01 2.44137941e+04 3.66145448e+03 8.33270778e+02
 2.35738124e+02 7.64113086e+01 1.01926206e+01 2.70729368e+01
 3.15835668e-01 1.78417795e+00 2.94583648e+00 3.68469688e+00
 1.24414883e+01 5.47857442e+01 3.29903149e-01 1.14504481e+00]
E = -128.53224679994557
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.80967949256        1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448341        1
[INPUT] 0    0    [1    /1   ]  833.270778214        1
[INPUT] 0    0    [1    /1   ]  235.738123557        1
[INPUT] 0    0    [1    /1   ]  76.4113085887        1
[INPUT] 0    0    [1    /1   ]  10.1926205569        1
[INPUT] 0    0    [1    /1   ]  27.0729367652        1
[INPUT] 0    0    [1    /1   ]  0.31583566801        1
[INPUT] 0    0    [1    /1   ]  1.78417794773        1
[INPUT] 0    0    [1    /1   ]  2.9458364819         1
[INPUT] 1    0    [1    /1   ]  3.68469688152        1
[INPUT] 1    0    [1    /1   ]  12.4414882655        1
[INPUT] 1    0    [1    /1   ]  54.7857441829        1
[INPUT] 1    0    [1    /1   ]  0.329903148672       1
[INPUT] 1    0    [1    /1   ]  1.14504480604        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8096794925601444, 1.0]], [0, [24413.79412973443, 1.0]], [0, [3661.4544834098874, 1.0]], [0, [833.270778213908, 1.0]], [0, [235.73812355696472, 1.0]], [0, [76.41130858872975, 1.0]], [0, [10.192620556891994, 1.0]], [0, [27.072936765248837, 1.0]], [0, [0.3158356680096916, 1.0]], [0, [1.7841779477302608, 1.0]], [0, [2.945836481902627, 1.0]], [1, [3.684696881522236, 1.0]], [1, [12.441488265472739, 1.0]], [1, [54.78574418289869, 1.0]], [1, [0.32990314867193726, 1.0]], [1, [1.145044806039126, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80967949]
bas 1, expnt(s) = [24413.79412973]
bas 2, expnt(s) = [3661.45448341]
bas 3, expnt(s) = [833.27077821]
bas 4, expnt(s) = [235.73812356]
bas 5, expnt(s) = [76.41130859]
bas 6, expnt(s) = [10.19262056]
bas 7, expnt(s) = [27.07293677]
bas 8, expnt(s) = [0.31583567]
bas 9, expnt(s) = [1.78417795]
bas 10, expnt(s) = [2.94583648]
bas 11, expnt(s) = [3.68469688]
bas 12, expnt(s) = [12.44148827]
bas 13, expnt(s) = [54.78574418]
bas 14, expnt(s) = [0.32990315]
bas 15, expnt(s) = [1.14504481]
CPU time:        73.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09679493e-01 2.15650207e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270778e+02 3.91836274e+02
 2.35738124e+02 1.51997831e+02 7.64113086e+01 6.52955001e+01
 1.01926206e+01 1.44121714e+01 2.70729368e+01 2.99858629e+01
 3.15835668e-01 1.06441480e+00 1.78417795e+00 3.90026081e+00
 2.94583648e+00 5.68095699e+00 3.68469688e+00 1.48931513e+01
 1.24414883e+01 6.81670987e+01 5.47857442e+01 4.34829349e+02
 3.29903149e-01 7.29402871e-01 1.14504481e+00 3.45551270e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486220801997
cond(S) = 2405.1168728507578
E1 = -183.57782748529638  E_coul = 55.07849670970355
init E= -128.499330775593
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945795368503  LUMO = 0.796884573737787
  mo_energy =
[-3.25553616e+01 -1.85289558e+00 -7.73945795e-01 -7.73945795e-01
 -7.73945795e-01  7.96884574e-01  1.11487229e+00  1.11487229e+00
  1.11487229e+00  4.05060386e+00  5.77896287e+00  5.77896287e+00
  5.77896287e+00  1.24950620e+01  2.42069084e+01  2.42069084e+01
  2.42069084e+01  4.11984091e+01  1.19090725e+02  1.19090725e+02
  1.19090725e+02  1.45203474e+02  5.08743768e+02  1.87578798e+03
  8.00484405e+03  4.77717260e+04]
E1 = -182.10941569247376  E_coul = 53.58052543808053
cycle= 1 E= -128.528890254393  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460673
diis-c [-0.21221987  1.        ]
  HOMO = -0.879731385176839  LUMO = 0.770359672256001
  mo_energy =
[-3.28742242e+01 -1.96328939e+00 -8.79731385e-01 -8.79731385e-01
 -8.79731385e-01  7.70359672e-01  1.07659206e+00  1.07659206e+00
  1.07659206e+00  3.98015431e+00  5.64985569e+00  5.64985569e+00
  5.64985569e+00  1.23559286e+01  2.39717902e+01  2.39717902e+01
  2.39717902e+01  4.09581069e+01  1.18769580e+02  1.18769580e+02
  1.18769580e+02  1.44891191e+02  5.08386499e+02  1.87539434e+03
  8.00442129e+03  4.77712844e+04]
E1 = -182.8419804339364  E_coul = 54.31058242269242
cycle= 2 E= -128.531398011244  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229981
diis-c [-6.23513337e-04  3.32000548e-01  6.67999452e-01]
  HOMO = -0.84534617902145  LUMO = 0.778986524263548
  mo_energy =
[-3.27691275e+01 -1.92713771e+00 -8.45346179e-01 -8.45346179e-01
 -8.45346179e-01  7.78986524e-01  1.08909615e+00  1.08909615e+00
  1.08909615e+00  4.00286003e+00  5.69182570e+00  5.69182570e+00
  5.69182570e+00  1.24012783e+01  2.40493910e+01  2.40493910e+01
  2.40493910e+01  4.10376271e+01  1.18874703e+02  1.18874703e+02
  1.18874703e+02  1.44993870e+02  5.08500109e+02  1.87551322e+03
  8.00454261e+03  4.77714066e+04]
E1 = -182.59617701675114  E_coul = 54.063930240278076
cycle= 3 E= -128.532246776473  delta_E= -0.000849  |g|= 0.000496  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999215
diis-c [-1.63525881e-07 -2.24422836e-03 -5.19118501e-04  1.00276335e+00]
  HOMO = -0.845595054945976  LUMO = 0.778946884468627
  mo_energy =
[-3.27695706e+01 -1.92732276e+00 -8.45595055e-01 -8.45595055e-01
 -8.45595055e-01  7.78946884e-01  1.08903912e+00  1.08903912e+00
  1.08903912e+00  4.00273315e+00  5.69160480e+00  5.69160480e+00
  5.69160480e+00  1.24010428e+01  2.40490405e+01  2.40490405e+01
  2.40490405e+01  4.10372783e+01  1.18874248e+02  1.18874248e+02
  1.18874248e+02  1.44993429e+02  5.08499562e+02  1.87551256e+03
  8.00454186e+03  4.77714058e+04]
E1 = -182.59673674820468  E_coul = 54.06448994881537
cycle= 4 E= -128.532246799389  delta_E= -2.29e-08  |g|= 6.44e-05  |ddm|= 0.000367
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133454
diis-c [-9.85254486e-10  3.24502374e-04  3.84528797e-04 -2.12178217e-01
  1.21146919e+00]
  HOMO = -0.845627877760897  LUMO = 0.778940039495
  mo_energy =
[-3.27696237e+01 -1.92734314e+00 -8.45627878e-01 -8.45627878e-01
 -8.45627878e-01  7.78940039e-01  1.08902521e+00  1.08902521e+00
  1.08902521e+00  4.00271285e+00  5.69156850e+00  5.69156850e+00
  5.69156850e+00  1.24010072e+01  2.40489924e+01  2.40489924e+01
  2.40489924e+01  4.10372310e+01  1.18874195e+02  1.18874195e+02
  1.18874195e+02  1.44993375e+02  5.08499501e+02  1.87551249e+03
  8.00454179e+03  4.77714057e+04]
E1 = -182.59683971706488  E_coul = 54.064592917122084
cycle= 5 E= -128.532246799943  delta_E= -5.54e-10  |g|= 6.74e-06  |ddm|= 6.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59683971706488  E_coul = 54.064592917122084
  HOMO = -0.845624179258985  LUMO = 0.778941465956662
  mo_energy =
[-3.27696157e+01 -1.92733871e+00 -8.45624179e-01 -8.45624179e-01
 -8.45624179e-01  7.78941466e-01  1.08902677e+00  1.08902677e+00
  1.08902677e+00  4.00271593e+00  5.69157299e+00  5.69157299e+00
  5.69157299e+00  1.24010122e+01  2.40489993e+01  2.40489993e+01
  2.40489993e+01  4.10372381e+01  1.18874202e+02  1.18874202e+02
  1.18874202e+02  1.44993383e+02  5.08499509e+02  1.87551250e+03
  8.00454180e+03  4.77714057e+04]
E1 = -182.59682207207254  E_coul = 54.06457527212698
Extra cycle  E= -128.532246799946  delta_E= -2.76e-12  |g|= 2.47e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2405.1168728507578
E1 = -182.59682207207254  E_coul = 54.06457527212698
init E= -128.532246799946
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845625412955297  LUMO = 0.778941224300256
  mo_energy =
[-3.27696196e+01 -1.92733989e+00 -8.45625413e-01 -8.45625413e-01
 -8.45625413e-01  7.78941224e-01  1.08902633e+00  1.08902633e+00
  1.08902633e+00  4.00271520e+00  5.69157149e+00  5.69157149e+00
  5.69157149e+00  1.24010106e+01  2.40489964e+01  2.40489964e+01
  2.40489964e+01  4.10372351e+01  1.18874198e+02  1.18874198e+02
  1.18874198e+02  1.44993379e+02  5.08499505e+02  1.87551249e+03
  8.00454179e+03  4.77714057e+04]
E1 = -182.59683160058012  E_coul = 54.06458480063403
cycle= 1 E= -128.532246799946  delta_E= -5.12e-13  |g|= 1.31e-06  |ddm|= 9.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59683160058012  E_coul = 54.06458480063403
  HOMO = -0.845624743061977  LUMO = 0.778941404132678
  mo_energy =
[-3.27696176e+01 -1.92733917e+00 -8.45624743e-01 -8.45624743e-01
 -8.45624743e-01  7.78941404e-01  1.08902658e+00  1.08902658e+00
  1.08902658e+00  4.00271566e+00  5.69157231e+00  5.69157231e+00
  5.69157231e+00  1.24010115e+01  2.40489979e+01  2.40489979e+01
  2.40489979e+01  4.10372367e+01  1.18874200e+02  1.18874200e+02
  1.18874200e+02  1.44993381e+02  5.08499507e+02  1.87551250e+03
  8.00454179e+03  4.77714057e+04]
E1 = -182.59682686684474  E_coul = 54.06458006689865
Extra cycle  E= -128.532246799946  delta_E=    0  |g|= 6.44e-07  |ddm|= 4.43e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [8.09679493e-01 2.44137941e+04 3.66145448e+03 8.33270778e+02
 2.35738124e+02 7.64113086e+01 1.01926206e+01 2.70729368e+01
 3.15835668e-01 1.78417795e+00 2.94583648e+00 3.68469688e+00
 1.24414883e+01 5.47857442e+01 3.29903149e-01 1.14504481e+00]
grad_E = [ 2.08726253e-04  1.57770868e-10 -8.31770479e-09  1.80224451e-07
 -2.39034271e-06  1.73554353e-05 -3.26978598e-04 -8.71532866e-06
 -1.57544868e-04 -1.88128123e-06 -6.42301243e-05 -2.87517126e-04
 -1.02286996e-05  2.46618276e-06 -3.91646873e-03  1.96953929e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.810970115655       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448374        1
[INPUT] 0    0    [1    /1   ]  833.270770957        1
[INPUT] 0    0    [1    /1   ]  235.738218026        1
[INPUT] 0    0    [1    /1   ]  76.4107013094        1
[INPUT] 0    0    [1    /1   ]  10.2073844517        1
[INPUT] 0    0    [1    /1   ]  27.0722063032        1
[INPUT] 0    0    [1    /1   ]  0.315945054794       1
[INPUT] 0    0    [1    /1   ]  1.79920604661        1
[INPUT] 0    0    [1    /1   ]  2.94820213532        1
[INPUT] 1    0    [1    /1   ]  3.69050575031        1
[INPUT] 1    0    [1    /1   ]  12.4394117056        1
[INPUT] 1    0    [1    /1   ]  54.7858154462        1
[INPUT] 1    0    [1    /1   ]  0.330671068703       1
[INPUT] 1    0    [1    /1   ]  1.14758178549        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8109701156551361, 1.0]], [0, [24413.794129728078, 1.0]], [0, [3661.454483743685, 1.0]], [0, [833.2707709565465, 1.0]], [0, [235.73821802586474, 1.0]], [0, [76.41070130939099, 1.0]], [0, [10.207384451715598, 1.0]], [0, [27.072206303199653, 1.0]], [0, [0.31594505479383106, 1.0]], [0, [1.7992060466058937, 1.0]], [0, [2.9482021353154897, 1.0]], [1, [3.690505750311689, 1.0]], [1, [12.439411705554654, 1.0]], [1, [54.785815446198285, 1.0]], [1, [0.3306710687034113, 1.0]], [1, [1.147581785494676, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81097012]
bas 1, expnt(s) = [24413.79412973]
bas 2, expnt(s) = [3661.45448374]
bas 3, expnt(s) = [833.27077096]
bas 4, expnt(s) = [235.73821803]
bas 5, expnt(s) = [76.41070131]
bas 6, expnt(s) = [10.20738445]
bas 7, expnt(s) = [27.0722063]
bas 8, expnt(s) = [0.31594505]
bas 9, expnt(s) = [1.79920605]
bas 10, expnt(s) = [2.94820214]
bas 11, expnt(s) = [3.69050575]
bas 12, expnt(s) = [12.43941171]
bas 13, expnt(s) = [54.78581545]
bas 14, expnt(s) = [0.33067107]
bas 15, expnt(s) = [1.14758179]
CPU time:        75.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.10970116e-01 2.15907964e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270771e+02 3.91836272e+02
 2.35738218e+02 1.51997877e+02 7.64107013e+01 6.52951109e+01
 1.02073845e+01 1.44278254e+01 2.70722063e+01 2.99852561e+01
 3.15945055e-01 1.06469128e+00 1.79920605e+00 3.92487383e+00
 2.94820214e+00 5.68437822e+00 3.69050575e+00 1.49225056e+01
 1.24394117e+01 6.81528772e+01 5.47858154e+01 4.34830056e+02
 3.30671069e-01 7.31525789e-01 1.14758179e+00 3.46508546e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998469636693564
cond(S) = 2445.547313045418
E1 = -183.5778285694854  E_coul = 55.07851944900397
init E= -128.499309120481
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773940743622644  LUMO = 0.798505184556905
  mo_energy =
[-3.25553649e+01 -1.85289345e+00 -7.73940744e-01 -7.73940744e-01
 -7.73940744e-01  7.98505185e-01  1.11798129e+00  1.11798129e+00
  1.11798129e+00  4.06532795e+00  5.79267929e+00  5.79267929e+00
  5.79267929e+00  1.25453301e+01  2.42325409e+01  2.42325409e+01
  2.42325409e+01  4.12991898e+01  1.19109885e+02  1.19109885e+02
  1.19109885e+02  1.45328567e+02  5.08864424e+02  1.87589722e+03
  8.00494040e+03  4.77718058e+04]
E1 = -182.1110090813936  E_coul = 53.58210958799438
cycle= 1 E= -128.528899493399  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460382
diis-c [-0.21195115  1.        ]
  HOMO = -0.879605891933638  LUMO = 0.771965753298112
  mo_energy =
[-3.28739484e+01 -1.96314915e+00 -8.79605892e-01 -8.79605892e-01
 -8.79605892e-01  7.71965753e-01  1.07964529e+00  1.07964529e+00
  1.07964529e+00  3.99471651e+00  5.66357087e+00  5.66357087e+00
  5.66357087e+00  1.24060742e+01  2.39976560e+01  2.39976560e+01
  2.39976560e+01  4.10590494e+01  1.18789029e+02  1.18789029e+02
  1.18789029e+02  1.45016564e+02  5.08507442e+02  1.87550386e+03
  8.00451791e+03  4.77713645e+04]
E1 = -182.84269215258172  E_coul = 54.311288981602736
cycle= 2 E= -128.531403170979  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229759
diis-c [-6.23162893e-04  3.31925349e-01  6.68074651e-01]
  HOMO = -0.845259757477591  LUMO = 0.780603652735446
  mo_energy =
[-3.27689593e+01 -1.92703964e+00 -8.45259757e-01 -8.45259757e-01
 -8.45259757e-01  7.80603653e-01  1.09217131e+00  1.09217131e+00
  1.09217131e+00  4.01748014e+00  5.70554323e+00  5.70554323e+00
  5.70554323e+00  1.24514652e+01  2.40751724e+01  2.40751724e+01
  2.40751724e+01  4.11385073e+01  1.18894042e+02  1.18894042e+02
  1.18894042e+02  1.45119136e+02  5.08620936e+02  1.87562263e+03
  8.00463911e+03  4.77714866e+04]
E1 = -182.59725570494092  E_coul = 54.06500594424841
cycle= 3 E= -128.532249760693  delta_E= -0.000847  |g|= 0.000494  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00099793
diis-c [-1.65974351e-07 -2.24292123e-03 -5.26243014e-04  1.00276916e+00]
  HOMO = -0.845507079941496  LUMO = 0.780564911697944
  mo_energy =
[-3.27694002e+01 -1.92722244e+00 -8.45507080e-01 -8.45507080e-01
 -8.45507080e-01  7.80564912e-01  1.09211482e+00  1.09211482e+00
  1.09211482e+00  4.01735443e+00  5.70532388e+00  5.70532388e+00
  5.70532388e+00  1.24512314e+01  2.40748241e+01  2.40748241e+01
  2.40748241e+01  4.11381606e+01  1.18893589e+02  1.18893589e+02
  1.18893589e+02  1.45118697e+02  5.08620391e+02  1.87562197e+03
  8.00463837e+03  4.77714858e+04]
E1 = -182.59781507429327  E_coul = 54.0655652907385
cycle= 4 E= -128.532249783555  delta_E= -2.29e-08  |g|= 6.43e-05  |ddm|= 0.000364
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133654
diis-c [-9.89257867e-10  3.28209722e-04  3.85976516e-04 -2.13957088e-01
  1.21324290e+00]
  HOMO = -0.845539711425067  LUMO = 0.780558222925961
  mo_energy =
[-3.27694530e+01 -1.92724242e+00 -8.45539711e-01 -8.45539711e-01
 -8.45539711e-01  7.80558223e-01  1.09210098e+00  1.09210098e+00
  1.09210098e+00  4.01733434e+00  5.70528780e+00  5.70528780e+00
  5.70528780e+00  1.24511960e+01  2.40747763e+01  2.40747763e+01
  2.40747763e+01  4.11381136e+01  1.18893536e+02  1.18893536e+02
  1.18893536e+02  1.45118644e+02  5.08620330e+02  1.87562190e+03
  8.00463829e+03  4.77714857e+04]
E1 = -182.5979178121782  E_coul = 54.06566802806528
cycle= 5 E= -128.532249784113  delta_E= -5.58e-10  |g|= 6.77e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5979178121782  E_coul = 54.06566802806528
  HOMO = -0.845535989795653  LUMO = 0.780559655518326
  mo_energy =
[-3.27694449e+01 -1.92723798e+00 -8.45535990e-01 -8.45535990e-01
 -8.45535990e-01  7.80559656e-01  1.09210255e+00  1.09210255e+00
  1.09210255e+00  4.01733744e+00  5.70529232e+00  5.70529232e+00
  5.70529232e+00  1.24512011e+01  2.40747832e+01  2.40747832e+01
  2.40747832e+01  4.11381207e+01  1.18893544e+02  1.18893544e+02
  1.18893544e+02  1.45118652e+02  5.08620338e+02  1.87562190e+03
  8.00463830e+03  4.77714857e+04]
E1 = -182.59790005816922  E_coul = 54.065650274053404
Extra cycle  E= -128.532249784116  delta_E= -2.9e-12  |g|= 2.49e-06  |ddm|= 2.56e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.10970116e-01 2.44137941e+04 3.66145448e+03 8.33270771e+02
 2.35738218e+02 7.64107013e+01 1.02073845e+01 2.70722063e+01
 3.15945055e-01 1.79920605e+00 2.94820214e+00 3.69050575e+00
 1.24394117e+01 5.47858154e+01 3.30671069e-01 1.14758179e+00]
E = -128.5322497841158
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.810970115655       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448374        1
[INPUT] 0    0    [1    /1   ]  833.270770957        1
[INPUT] 0    0    [1    /1   ]  235.738218026        1
[INPUT] 0    0    [1    /1   ]  76.4107013094        1
[INPUT] 0    0    [1    /1   ]  10.2073844517        1
[INPUT] 0    0    [1    /1   ]  27.0722063032        1
[INPUT] 0    0    [1    /1   ]  0.315945054794       1
[INPUT] 0    0    [1    /1   ]  1.79920604661        1
[INPUT] 0    0    [1    /1   ]  2.94820213532        1
[INPUT] 1    0    [1    /1   ]  3.69050575031        1
[INPUT] 1    0    [1    /1   ]  12.4394117056        1
[INPUT] 1    0    [1    /1   ]  54.7858154462        1
[INPUT] 1    0    [1    /1   ]  0.330671068703       1
[INPUT] 1    0    [1    /1   ]  1.14758178549        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8109701156551361, 1.0]], [0, [24413.794129728078, 1.0]], [0, [3661.454483743685, 1.0]], [0, [833.2707709565465, 1.0]], [0, [235.73821802586474, 1.0]], [0, [76.41070130939099, 1.0]], [0, [10.207384451715598, 1.0]], [0, [27.072206303199653, 1.0]], [0, [0.31594505479383106, 1.0]], [0, [1.7992060466058937, 1.0]], [0, [2.9482021353154897, 1.0]], [1, [3.690505750311689, 1.0]], [1, [12.439411705554654, 1.0]], [1, [54.785815446198285, 1.0]], [1, [0.3306710687034113, 1.0]], [1, [1.147581785494676, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81097012]
bas 1, expnt(s) = [24413.79412973]
bas 2, expnt(s) = [3661.45448374]
bas 3, expnt(s) = [833.27077096]
bas 4, expnt(s) = [235.73821803]
bas 5, expnt(s) = [76.41070131]
bas 6, expnt(s) = [10.20738445]
bas 7, expnt(s) = [27.0722063]
bas 8, expnt(s) = [0.31594505]
bas 9, expnt(s) = [1.79920605]
bas 10, expnt(s) = [2.94820214]
bas 11, expnt(s) = [3.69050575]
bas 12, expnt(s) = [12.43941171]
bas 13, expnt(s) = [54.78581545]
bas 14, expnt(s) = [0.33067107]
bas 15, expnt(s) = [1.14758179]
CPU time:        76.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.10970116e-01 2.15907964e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270771e+02 3.91836272e+02
 2.35738218e+02 1.51997877e+02 7.64107013e+01 6.52951109e+01
 1.02073845e+01 1.44278254e+01 2.70722063e+01 2.99852561e+01
 3.15945055e-01 1.06469128e+00 1.79920605e+00 3.92487383e+00
 2.94820214e+00 5.68437822e+00 3.69050575e+00 1.49225056e+01
 1.24394117e+01 6.81528772e+01 5.47858154e+01 4.34830056e+02
 3.30671069e-01 7.31525789e-01 1.14758179e+00 3.46508546e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998469636693564
cond(S) = 2445.547313045418
E1 = -183.5778285694854  E_coul = 55.07851944900397
init E= -128.499309120481
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773940743622644  LUMO = 0.798505184556905
  mo_energy =
[-3.25553649e+01 -1.85289345e+00 -7.73940744e-01 -7.73940744e-01
 -7.73940744e-01  7.98505185e-01  1.11798129e+00  1.11798129e+00
  1.11798129e+00  4.06532795e+00  5.79267929e+00  5.79267929e+00
  5.79267929e+00  1.25453301e+01  2.42325409e+01  2.42325409e+01
  2.42325409e+01  4.12991898e+01  1.19109885e+02  1.19109885e+02
  1.19109885e+02  1.45328567e+02  5.08864424e+02  1.87589722e+03
  8.00494040e+03  4.77718058e+04]
E1 = -182.1110090813936  E_coul = 53.58210958799438
cycle= 1 E= -128.528899493399  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460382
diis-c [-0.21195115  1.        ]
  HOMO = -0.879605891933638  LUMO = 0.771965753298112
  mo_energy =
[-3.28739484e+01 -1.96314915e+00 -8.79605892e-01 -8.79605892e-01
 -8.79605892e-01  7.71965753e-01  1.07964529e+00  1.07964529e+00
  1.07964529e+00  3.99471651e+00  5.66357087e+00  5.66357087e+00
  5.66357087e+00  1.24060742e+01  2.39976560e+01  2.39976560e+01
  2.39976560e+01  4.10590494e+01  1.18789029e+02  1.18789029e+02
  1.18789029e+02  1.45016564e+02  5.08507442e+02  1.87550386e+03
  8.00451791e+03  4.77713645e+04]
E1 = -182.84269215258172  E_coul = 54.311288981602736
cycle= 2 E= -128.531403170979  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229759
diis-c [-6.23162893e-04  3.31925349e-01  6.68074651e-01]
  HOMO = -0.845259757477591  LUMO = 0.780603652735446
  mo_energy =
[-3.27689593e+01 -1.92703964e+00 -8.45259757e-01 -8.45259757e-01
 -8.45259757e-01  7.80603653e-01  1.09217131e+00  1.09217131e+00
  1.09217131e+00  4.01748014e+00  5.70554323e+00  5.70554323e+00
  5.70554323e+00  1.24514652e+01  2.40751724e+01  2.40751724e+01
  2.40751724e+01  4.11385073e+01  1.18894042e+02  1.18894042e+02
  1.18894042e+02  1.45119136e+02  5.08620936e+02  1.87562263e+03
  8.00463911e+03  4.77714866e+04]
E1 = -182.59725570494092  E_coul = 54.06500594424841
cycle= 3 E= -128.532249760693  delta_E= -0.000847  |g|= 0.000494  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00099793
diis-c [-1.65974351e-07 -2.24292123e-03 -5.26243014e-04  1.00276916e+00]
  HOMO = -0.845507079941496  LUMO = 0.780564911697944
  mo_energy =
[-3.27694002e+01 -1.92722244e+00 -8.45507080e-01 -8.45507080e-01
 -8.45507080e-01  7.80564912e-01  1.09211482e+00  1.09211482e+00
  1.09211482e+00  4.01735443e+00  5.70532388e+00  5.70532388e+00
  5.70532388e+00  1.24512314e+01  2.40748241e+01  2.40748241e+01
  2.40748241e+01  4.11381606e+01  1.18893589e+02  1.18893589e+02
  1.18893589e+02  1.45118697e+02  5.08620391e+02  1.87562197e+03
  8.00463837e+03  4.77714858e+04]
E1 = -182.59781507429327  E_coul = 54.0655652907385
cycle= 4 E= -128.532249783555  delta_E= -2.29e-08  |g|= 6.43e-05  |ddm|= 0.000364
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133654
diis-c [-9.89257867e-10  3.28209722e-04  3.85976516e-04 -2.13957088e-01
  1.21324290e+00]
  HOMO = -0.845539711425067  LUMO = 0.780558222925961
  mo_energy =
[-3.27694530e+01 -1.92724242e+00 -8.45539711e-01 -8.45539711e-01
 -8.45539711e-01  7.80558223e-01  1.09210098e+00  1.09210098e+00
  1.09210098e+00  4.01733434e+00  5.70528780e+00  5.70528780e+00
  5.70528780e+00  1.24511960e+01  2.40747763e+01  2.40747763e+01
  2.40747763e+01  4.11381136e+01  1.18893536e+02  1.18893536e+02
  1.18893536e+02  1.45118644e+02  5.08620330e+02  1.87562190e+03
  8.00463829e+03  4.77714857e+04]
E1 = -182.5979178121782  E_coul = 54.06566802806528
cycle= 5 E= -128.532249784113  delta_E= -5.58e-10  |g|= 6.77e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5979178121782  E_coul = 54.06566802806528
  HOMO = -0.845535989795653  LUMO = 0.780559655518326
  mo_energy =
[-3.27694449e+01 -1.92723798e+00 -8.45535990e-01 -8.45535990e-01
 -8.45535990e-01  7.80559656e-01  1.09210255e+00  1.09210255e+00
  1.09210255e+00  4.01733744e+00  5.70529232e+00  5.70529232e+00
  5.70529232e+00  1.24512011e+01  2.40747832e+01  2.40747832e+01
  2.40747832e+01  4.11381207e+01  1.18893544e+02  1.18893544e+02
  1.18893544e+02  1.45118652e+02  5.08620338e+02  1.87562190e+03
  8.00463830e+03  4.77714857e+04]
E1 = -182.59790005816922  E_coul = 54.065650274053404
Extra cycle  E= -128.532249784116  delta_E= -2.9e-12  |g|= 2.49e-06  |ddm|= 2.56e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2445.547313045418
E1 = -182.59790005816922  E_coul = 54.065650274053404
init E= -128.532249784116
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845537230541478  LUMO = 0.78055941075053
  mo_energy =
[-3.27694489e+01 -1.92723917e+00 -8.45537231e-01 -8.45537231e-01
 -8.45537231e-01  7.80559411e-01  1.09210211e+00  1.09210211e+00
  1.09210211e+00  4.01733670e+00  5.70529081e+00  5.70529081e+00
  5.70529081e+00  1.24511995e+01  2.40747804e+01  2.40747804e+01
  2.40747804e+01  4.11381177e+01  1.18893540e+02  1.18893540e+02
  1.18893540e+02  1.45118648e+02  5.08620333e+02  1.87562190e+03
  8.00463829e+03  4.77714857e+04]
E1 = -182.59790963848178  E_coul = 54.065659854365485
cycle= 1 E= -128.532249784116  delta_E= -4.83e-13  |g|= 1.31e-06  |ddm|= 9.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59790963848178  E_coul = 54.065659854365485
  HOMO = -0.845536556928546  LUMO = 0.780559591756916
  mo_energy =
[-3.27694469e+01 -1.92723843e+00 -8.45536557e-01 -8.45536557e-01
 -8.45536557e-01  7.80559592e-01  1.09210236e+00  1.09210236e+00
  1.09210236e+00  4.01733716e+00  5.70529164e+00  5.70529164e+00
  5.70529164e+00  1.24512004e+01  2.40747819e+01  2.40747819e+01
  2.40747819e+01  4.11381193e+01  1.18893542e+02  1.18893542e+02
  1.18893542e+02  1.45118650e+02  5.08620335e+02  1.87562190e+03
  8.00463830e+03  4.77714857e+04]
E1 = -182.5979048801943  E_coul = 54.06565509607768
Extra cycle  E= -128.532249784117  delta_E= -3.41e-13  |g|= 6.48e-07  |ddm|= 4.46e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [8.10970116e-01 2.44137941e+04 3.66145448e+03 8.33270771e+02
 2.35738218e+02 7.64107013e+01 1.02073845e+01 2.70722063e+01
 3.15945055e-01 1.79920605e+00 2.94820214e+00 3.69050575e+00
 1.24394117e+01 5.47858154e+01 3.30671069e-01 1.14758179e+00]
grad_E = [ 1.68418136e-04  2.34533957e-10 -1.23456658e-08  2.61344869e-07
 -3.35459355e-06  2.47471892e-05 -2.76924897e-04 -4.01717135e-05
 -1.06360758e-04  3.06098393e-06 -7.18973482e-05  5.69157737e-05
 -1.04665634e-04  7.10067046e-06 -2.69420927e-03  1.56000247e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.809065592331       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448382        1
[INPUT] 0    0    [1    /1   ]  833.270769111        1
[INPUT] 0    0    [1    /1   ]  235.738243821        1
[INPUT] 0    0    [1    /1   ]  76.410535022         1
[INPUT] 0    0    [1    /1   ]  10.214017293         1
[INPUT] 0    0    [1    /1   ]  27.071667205         1
[INPUT] 0    0    [1    /1   ]  0.315339074062       1
[INPUT] 0    0    [1    /1   ]  1.8029523047         1
[INPUT] 0    0    [1    /1   ]  2.94864412082        1
[INPUT] 1    0    [1    /1   ]  3.69291661957        1
[INPUT] 1    0    [1    /1   ]  12.4386341463        1
[INPUT] 1    0    [1    /1   ]  54.7858367818        1
[INPUT] 1    0    [1    /1   ]  0.331112766243       1
[INPUT] 1    0    [1    /1   ]  1.14830635319        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8090655923307077, 1.0]], [0, [24413.79412972655, 1.0]], [0, [3661.4544838243273, 1.0]], [0, [833.270769111196, 1.0]], [0, [235.73824382076995, 1.0]], [0, [76.41053502203376, 1.0]], [0, [10.214017293047277, 1.0]], [0, [27.071667204976457, 1.0]], [0, [0.3153390740616395, 1.0]], [0, [1.8029523046962714, 1.0]], [0, [2.9486441208244183, 1.0]], [1, [3.692916619565611, 1.0]], [1, [12.43863414628337, 1.0]], [1, [54.78583678184301, 1.0]], [1, [0.33111276624345615, 1.0]], [1, [1.1483063531859576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80906559]
bas 1, expnt(s) = [24413.79412973]
bas 2, expnt(s) = [3661.45448382]
bas 3, expnt(s) = [833.27076911]
bas 4, expnt(s) = [235.73824382]
bas 5, expnt(s) = [76.41053502]
bas 6, expnt(s) = [10.21401729]
bas 7, expnt(s) = [27.0716672]
bas 8, expnt(s) = [0.31533907]
bas 9, expnt(s) = [1.8029523]
bas 10, expnt(s) = [2.94864412]
bas 11, expnt(s) = [3.69291662]
bas 12, expnt(s) = [12.43863415]
bas 13, expnt(s) = [54.78583678]
bas 14, expnt(s) = [0.33111277]
bas 15, expnt(s) = [1.14830635]
CPU time:        79.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09065592e-01 2.15527565e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270769e+02 3.91836271e+02
 2.35738244e+02 1.51997889e+02 7.64105350e+01 6.52950043e+01
 1.02140173e+01 1.44348563e+01 2.70716672e+01 2.99848083e+01
 3.15339074e-01 1.06315936e+00 1.80295230e+00 3.93100144e+00
 2.94864412e+00 5.68501734e+00 3.69291662e+00 1.49346920e+01
 1.24386341e+01 6.81475521e+01 5.47858368e+01 4.34830268e+02
 3.31112766e-01 7.32747423e-01 1.14830635e+00 3.46782044e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99846227641438
cond(S) = 2440.0963636185634
E1 = -183.57783922823614  E_coul = 55.078530214242846
init E= -128.499309013993
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773938143447064  LUMO = 0.796786287502564
  mo_energy =
[-3.25553665e+01 -1.85289267e+00 -7.73938143e-01 -7.73938143e-01
 -7.73938143e-01  7.96786288e-01  1.11951917e+00  1.11951917e+00
  1.11951917e+00  4.06151807e+00  5.79793234e+00  5.79793234e+00
  5.79793234e+00  1.25467340e+01  2.42425068e+01  2.42425068e+01
  2.42425068e+01  4.13163990e+01  1.19117504e+02  1.19117504e+02
  1.19117504e+02  1.45357390e+02  5.08893805e+02  1.87592409e+03
  8.00496415e+03  4.77718255e+04]
E1 = -182.11233247688554  E_coul = 53.5834272665315
cycle= 1 E= -128.528905210354  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46019
diis-c [-0.2117748  1.       ]
  HOMO = -0.879498328063304  LUMO = 0.770351896421
  mo_energy =
[-3.28737327e+01 -1.96302809e+00 -8.79498328e-01 -8.79498328e-01
 -8.79498328e-01  7.70351896e-01  1.08118835e+00  1.08118835e+00
  1.08118835e+00  3.99098687e+00  5.66890157e+00  5.66890157e+00
  5.66890157e+00  1.24075445e+01  2.40078035e+01  2.40078035e+01
  2.40078035e+01  4.10764035e+01  1.18796872e+02  1.18796872e+02
  1.18796872e+02  1.45045597e+02  5.08537042e+02  1.87553095e+03
  8.00454188e+03  4.77713844e+04]
E1 = -182.84340433107064  E_coul = 54.31199824921927
cycle= 2 E= -128.531406081851  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229609
diis-c [-6.22677625e-04  3.31872183e-01  6.68127817e-01]
  HOMO = -0.84517880945068  LUMO = 0.778965449100163
  mo_energy =
[-3.27688197e+01 -1.92694727e+00 -8.45178809e-01 -8.45178809e-01
 -8.45178809e-01  7.78965449e-01  1.09371938e+00  1.09371938e+00
  1.09371938e+00  4.01373604e+00  5.71085857e+00  5.71085857e+00
  5.71085857e+00  1.24529229e+01  2.40852618e+01  2.40852618e+01
  2.40852618e+01  4.11558141e+01  1.18901807e+02  1.18901807e+02
  1.18901807e+02  1.45148095e+02  5.08650454e+02  1.87564963e+03
  8.00466300e+03  4.77715064e+04]
E1 = -182.598248015782  E_coul = 54.06599695912617
cycle= 3 E= -128.532251056656  delta_E= -0.000845  |g|= 0.00049  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992882
diis-c [-1.69030266e-07 -2.23770220e-03 -5.46077372e-04  1.00278378e+00]
  HOMO = -0.845423347945426  LUMO = 0.778928349168133
  mo_energy =
[-3.27692565e+01 -1.92712640e+00 -8.45423348e-01 -8.45423348e-01
 -8.45423348e-01  7.78928349e-01  1.09366415e+00  1.09366415e+00
  1.09366415e+00  4.01361306e+00  5.71064243e+00  5.71064243e+00
  5.71064243e+00  1.24526927e+01  2.40849175e+01  2.40849175e+01
  2.40849175e+01  4.11554714e+01  1.18901359e+02  1.18901359e+02
  1.18901359e+02  1.45147660e+02  5.08649913e+02  1.87564897e+03
  8.00466225e+03  4.77715056e+04]
E1 = -182.59880327992536  E_coul = 54.066552200560025
cycle= 4 E= -128.532251079365  delta_E= -2.27e-08  |g|= 6.42e-05  |ddm|= 0.00036
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013382
diis-c [-9.94011007e-10  3.31953594e-04  3.89324689e-04 -2.16117924e-01
  1.21539665e+00]
  HOMO = -0.845455729079556  LUMO = 0.778921885081664
  mo_energy =
[-3.27693090e+01 -1.92714588e+00 -8.45455729e-01 -8.45455729e-01
 -8.45455729e-01  7.78921885e-01  1.09365042e+00  1.09365042e+00
  1.09365042e+00  4.01359331e+00  5.71060667e+00  5.71060667e+00
  5.71060667e+00  1.24526577e+01  2.40848701e+01  2.40848701e+01
  2.40848701e+01  4.11554247e+01  1.18901305e+02  1.18901305e+02
  1.18901305e+02  1.45147607e+02  5.08649852e+02  1.87564890e+03
  8.00466218e+03  4.77715055e+04]
E1 = -182.59890565272144  E_coul = 54.066654572791506
cycle= 5 E= -128.53225107993  delta_E= -5.65e-10  |g|= 6.8e-06  |ddm|= 6.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59890565272144  E_coul = 54.066654572791506
  HOMO = -0.84545198199897  LUMO = 0.778923317212758
  mo_energy =
[-3.27693009e+01 -1.92714142e+00 -8.45451982e-01 -8.45451982e-01
 -8.45451982e-01  7.78923317e-01  1.09365200e+00  1.09365200e+00
  1.09365200e+00  4.01359643e+00  5.71061122e+00  5.71061122e+00
  5.71061122e+00  1.24526628e+01  2.40848771e+01  2.40848771e+01
  2.40848771e+01  4.11554319e+01  1.18901313e+02  1.18901313e+02
  1.18901313e+02  1.45147615e+02  5.08649860e+02  1.87564891e+03
  8.00466219e+03  4.77715055e+04]
E1 = -182.59888775760285  E_coul = 54.06663667767011
Extra cycle  E= -128.532251079933  delta_E= -2.79e-12  |g|= 2.5e-06  |ddm|= 2.59e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.09065592e-01 2.44137941e+04 3.66145448e+03 8.33270769e+02
 2.35738244e+02 7.64105350e+01 1.02140173e+01 2.70716672e+01
 3.15339074e-01 1.80295230e+00 2.94864412e+00 3.69291662e+00
 1.24386341e+01 5.47858368e+01 3.31112766e-01 1.14830635e+00]
E = -128.53225107993273
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.809065592331       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448382        1
[INPUT] 0    0    [1    /1   ]  833.270769111        1
[INPUT] 0    0    [1    /1   ]  235.738243821        1
[INPUT] 0    0    [1    /1   ]  76.410535022         1
[INPUT] 0    0    [1    /1   ]  10.214017293         1
[INPUT] 0    0    [1    /1   ]  27.071667205         1
[INPUT] 0    0    [1    /1   ]  0.315339074062       1
[INPUT] 0    0    [1    /1   ]  1.8029523047         1
[INPUT] 0    0    [1    /1   ]  2.94864412082        1
[INPUT] 1    0    [1    /1   ]  3.69291661957        1
[INPUT] 1    0    [1    /1   ]  12.4386341463        1
[INPUT] 1    0    [1    /1   ]  54.7858367818        1
[INPUT] 1    0    [1    /1   ]  0.331112766243       1
[INPUT] 1    0    [1    /1   ]  1.14830635319        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8090655923307077, 1.0]], [0, [24413.79412972655, 1.0]], [0, [3661.4544838243273, 1.0]], [0, [833.270769111196, 1.0]], [0, [235.73824382076995, 1.0]], [0, [76.41053502203376, 1.0]], [0, [10.214017293047277, 1.0]], [0, [27.071667204976457, 1.0]], [0, [0.3153390740616395, 1.0]], [0, [1.8029523046962714, 1.0]], [0, [2.9486441208244183, 1.0]], [1, [3.692916619565611, 1.0]], [1, [12.43863414628337, 1.0]], [1, [54.78583678184301, 1.0]], [1, [0.33111276624345615, 1.0]], [1, [1.1483063531859576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80906559]
bas 1, expnt(s) = [24413.79412973]
bas 2, expnt(s) = [3661.45448382]
bas 3, expnt(s) = [833.27076911]
bas 4, expnt(s) = [235.73824382]
bas 5, expnt(s) = [76.41053502]
bas 6, expnt(s) = [10.21401729]
bas 7, expnt(s) = [27.0716672]
bas 8, expnt(s) = [0.31533907]
bas 9, expnt(s) = [1.8029523]
bas 10, expnt(s) = [2.94864412]
bas 11, expnt(s) = [3.69291662]
bas 12, expnt(s) = [12.43863415]
bas 13, expnt(s) = [54.78583678]
bas 14, expnt(s) = [0.33111277]
bas 15, expnt(s) = [1.14830635]
CPU time:        79.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09065592e-01 2.15527565e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270769e+02 3.91836271e+02
 2.35738244e+02 1.51997889e+02 7.64105350e+01 6.52950043e+01
 1.02140173e+01 1.44348563e+01 2.70716672e+01 2.99848083e+01
 3.15339074e-01 1.06315936e+00 1.80295230e+00 3.93100144e+00
 2.94864412e+00 5.68501734e+00 3.69291662e+00 1.49346920e+01
 1.24386341e+01 6.81475521e+01 5.47858368e+01 4.34830268e+02
 3.31112766e-01 7.32747423e-01 1.14830635e+00 3.46782044e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99846227641438
cond(S) = 2440.0963636185634
E1 = -183.57783922823614  E_coul = 55.078530214242846
init E= -128.499309013993
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773938143447064  LUMO = 0.796786287502564
  mo_energy =
[-3.25553665e+01 -1.85289267e+00 -7.73938143e-01 -7.73938143e-01
 -7.73938143e-01  7.96786288e-01  1.11951917e+00  1.11951917e+00
  1.11951917e+00  4.06151807e+00  5.79793234e+00  5.79793234e+00
  5.79793234e+00  1.25467340e+01  2.42425068e+01  2.42425068e+01
  2.42425068e+01  4.13163990e+01  1.19117504e+02  1.19117504e+02
  1.19117504e+02  1.45357390e+02  5.08893805e+02  1.87592409e+03
  8.00496415e+03  4.77718255e+04]
E1 = -182.11233247688554  E_coul = 53.5834272665315
cycle= 1 E= -128.528905210354  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46019
diis-c [-0.2117748  1.       ]
  HOMO = -0.879498328063304  LUMO = 0.770351896421
  mo_energy =
[-3.28737327e+01 -1.96302809e+00 -8.79498328e-01 -8.79498328e-01
 -8.79498328e-01  7.70351896e-01  1.08118835e+00  1.08118835e+00
  1.08118835e+00  3.99098687e+00  5.66890157e+00  5.66890157e+00
  5.66890157e+00  1.24075445e+01  2.40078035e+01  2.40078035e+01
  2.40078035e+01  4.10764035e+01  1.18796872e+02  1.18796872e+02
  1.18796872e+02  1.45045597e+02  5.08537042e+02  1.87553095e+03
  8.00454188e+03  4.77713844e+04]
E1 = -182.84340433107064  E_coul = 54.31199824921927
cycle= 2 E= -128.531406081851  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229609
diis-c [-6.22677625e-04  3.31872183e-01  6.68127817e-01]
  HOMO = -0.84517880945068  LUMO = 0.778965449100163
  mo_energy =
[-3.27688197e+01 -1.92694727e+00 -8.45178809e-01 -8.45178809e-01
 -8.45178809e-01  7.78965449e-01  1.09371938e+00  1.09371938e+00
  1.09371938e+00  4.01373604e+00  5.71085857e+00  5.71085857e+00
  5.71085857e+00  1.24529229e+01  2.40852618e+01  2.40852618e+01
  2.40852618e+01  4.11558141e+01  1.18901807e+02  1.18901807e+02
  1.18901807e+02  1.45148095e+02  5.08650454e+02  1.87564963e+03
  8.00466300e+03  4.77715064e+04]
E1 = -182.598248015782  E_coul = 54.06599695912617
cycle= 3 E= -128.532251056656  delta_E= -0.000845  |g|= 0.00049  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000992882
diis-c [-1.69030266e-07 -2.23770220e-03 -5.46077372e-04  1.00278378e+00]
  HOMO = -0.845423347945426  LUMO = 0.778928349168133
  mo_energy =
[-3.27692565e+01 -1.92712640e+00 -8.45423348e-01 -8.45423348e-01
 -8.45423348e-01  7.78928349e-01  1.09366415e+00  1.09366415e+00
  1.09366415e+00  4.01361306e+00  5.71064243e+00  5.71064243e+00
  5.71064243e+00  1.24526927e+01  2.40849175e+01  2.40849175e+01
  2.40849175e+01  4.11554714e+01  1.18901359e+02  1.18901359e+02
  1.18901359e+02  1.45147660e+02  5.08649913e+02  1.87564897e+03
  8.00466225e+03  4.77715056e+04]
E1 = -182.59880327992536  E_coul = 54.066552200560025
cycle= 4 E= -128.532251079365  delta_E= -2.27e-08  |g|= 6.42e-05  |ddm|= 0.00036
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013382
diis-c [-9.94011007e-10  3.31953594e-04  3.89324689e-04 -2.16117924e-01
  1.21539665e+00]
  HOMO = -0.845455729079556  LUMO = 0.778921885081664
  mo_energy =
[-3.27693090e+01 -1.92714588e+00 -8.45455729e-01 -8.45455729e-01
 -8.45455729e-01  7.78921885e-01  1.09365042e+00  1.09365042e+00
  1.09365042e+00  4.01359331e+00  5.71060667e+00  5.71060667e+00
  5.71060667e+00  1.24526577e+01  2.40848701e+01  2.40848701e+01
  2.40848701e+01  4.11554247e+01  1.18901305e+02  1.18901305e+02
  1.18901305e+02  1.45147607e+02  5.08649852e+02  1.87564890e+03
  8.00466218e+03  4.77715055e+04]
E1 = -182.59890565272144  E_coul = 54.066654572791506
cycle= 5 E= -128.53225107993  delta_E= -5.65e-10  |g|= 6.8e-06  |ddm|= 6.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59890565272144  E_coul = 54.066654572791506
  HOMO = -0.84545198199897  LUMO = 0.778923317212758
  mo_energy =
[-3.27693009e+01 -1.92714142e+00 -8.45451982e-01 -8.45451982e-01
 -8.45451982e-01  7.78923317e-01  1.09365200e+00  1.09365200e+00
  1.09365200e+00  4.01359643e+00  5.71061122e+00  5.71061122e+00
  5.71061122e+00  1.24526628e+01  2.40848771e+01  2.40848771e+01
  2.40848771e+01  4.11554319e+01  1.18901313e+02  1.18901313e+02
  1.18901313e+02  1.45147615e+02  5.08649860e+02  1.87564891e+03
  8.00466219e+03  4.77715055e+04]
E1 = -182.59888775760285  E_coul = 54.06663667767011
Extra cycle  E= -128.532251079933  delta_E= -2.79e-12  |g|= 2.5e-06  |ddm|= 2.59e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2440.0963636185634
E1 = -182.59888775760285  E_coul = 54.06663667767011
init E= -128.532251079933
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845453232022053  LUMO = 0.778923069772007
  mo_energy =
[-3.27693049e+01 -1.92714262e+00 -8.45453232e-01 -8.45453232e-01
 -8.45453232e-01  7.78923070e-01  1.09365156e+00  1.09365156e+00
  1.09365156e+00  4.01359568e+00  5.71060970e+00  5.71060970e+00
  5.71060970e+00  1.24526612e+01  2.40848742e+01  2.40848742e+01
  2.40848742e+01  4.11554289e+01  1.18901309e+02  1.18901309e+02
  1.18901309e+02  1.45147611e+02  5.08649856e+02  1.87564891e+03
  8.00466218e+03  4.77715055e+04]
E1 = -182.598897405891  E_coul = 54.06664632595787
cycle= 1 E= -128.532251079933  delta_E= -3.98e-13  |g|= 1.32e-06  |ddm|= 9.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.598897405891  E_coul = 54.06664632595787
  HOMO = -0.84545255351854  LUMO = 0.778923251411574
  mo_energy =
[-3.27693028e+01 -1.92714189e+00 -8.45452554e-01 -8.45452554e-01
 -8.45452554e-01  7.78923251e-01  1.09365181e+00  1.09365181e+00
  1.09365181e+00  4.01359615e+00  5.71061053e+00  5.71061053e+00
  5.71061053e+00  1.24526621e+01  2.40848757e+01  2.40848757e+01
  2.40848757e+01  4.11554305e+01  1.18901311e+02  1.18901311e+02
  1.18901311e+02  1.45147613e+02  5.08649858e+02  1.87564891e+03
  8.00466219e+03  4.77715055e+04]
E1 = -182.59889261474495  E_coul = 54.066641534811836
Extra cycle  E= -128.532251079933  delta_E=    0  |g|= 6.52e-07  |ddm|= 4.49e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.31 sec
exp = [8.09065592e-01 2.44137941e+04 3.66145448e+03 8.33270769e+02
 2.35738244e+02 7.64105350e+01 1.02140173e+01 2.70716672e+01
 3.15339074e-01 1.80295230e+00 2.94864412e+00 3.69291662e+00
 1.24386341e+01 5.47858368e+01 3.31112766e-01 1.14830635e+00]
grad_E = [ 1.24094585e-04  2.72012464e-10 -1.43108424e-08  3.00901240e-07
 -3.82261446e-06  2.83160359e-05 -2.53153075e-04 -5.51896725e-05
 -5.42359673e-05  1.01738730e-05 -7.75715252e-05  3.76322816e-04
 -1.61110572e-04  9.59454101e-06 -6.14170112e-04  6.03919703e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.80771191281        1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448386        1
[INPUT] 0    0    [1    /1   ]  833.270768369        1
[INPUT] 0    0    [1    /1   ]  235.73825431         1
[INPUT] 0    0    [1    /1   ]  76.4104629548        1
[INPUT] 0    0    [1    /1   ]  10.2166047337        1
[INPUT] 0    0    [1    /1   ]  27.0715079933        1
[INPUT] 0    0    [1    /1   ]  0.314941506886       1
[INPUT] 0    0    [1    /1   ]  1.80391372738        1
[INPUT] 0    0    [1    /1   ]  2.94869953017        1
[INPUT] 1    0    [1    /1   ]  3.69312076379        1
[INPUT] 1    0    [1    /1   ]  12.4386185239        1
[INPUT] 1    0    [1    /1   ]  54.7858292552        1
[INPUT] 1    0    [1    /1   ]  0.331235288154       1
[INPUT] 1    0    [1    /1   ]  1.14807162107        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8077119128103601, 1.0]], [0, [24413.794129725935, 1.0]], [0, [3661.454483856788, 1.0]], [0, [833.2707683689791, 1.0]], [0, [235.73825430968202, 1.0]], [0, [76.41046295482012, 1.0]], [0, [10.21660473367428, 1.0]], [0, [27.071507993336667, 1.0]], [0, [0.3149415068858832, 1.0]], [0, [1.8039137273824142, 1.0]], [0, [2.948699530170853, 1.0]], [1, [3.6931207637866295, 1.0]], [1, [12.438618523897757, 1.0]], [1, [54.78582925517047, 1.0]], [1, [0.33123528815395575, 1.0]], [1, [1.1480716210657045, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80771191]
bas 1, expnt(s) = [24413.79412973]
bas 2, expnt(s) = [3661.45448386]
bas 3, expnt(s) = [833.27076837]
bas 4, expnt(s) = [235.73825431]
bas 5, expnt(s) = [76.41046295]
bas 6, expnt(s) = [10.21660473]
bas 7, expnt(s) = [27.07150799]
bas 8, expnt(s) = [0.31494151]
bas 9, expnt(s) = [1.80391373]
bas 10, expnt(s) = [2.94869953]
bas 11, expnt(s) = [3.69312076]
bas 12, expnt(s) = [12.43861852]
bas 13, expnt(s) = [54.78582926]
bas 14, expnt(s) = [0.33123529]
bas 15, expnt(s) = [1.14807162]
CPU time:        82.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.07711913e-01 2.15257053e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270768e+02 3.91836271e+02
 2.35738254e+02 1.51997894e+02 7.64104630e+01 6.52949581e+01
 1.02166047e+01 1.44375988e+01 2.70715080e+01 2.99846760e+01
 3.14941507e-01 1.06215390e+00 1.80391373e+00 3.93257349e+00
 2.94869953e+00 5.68509747e+00 3.69312076e+00 1.49357240e+01
 1.24386185e+01 6.81474451e+01 5.47858293e+01 4.34830193e+02
 3.31235288e-01 7.33086362e-01 1.14807162e+00 3.46693437e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998461496473553
cond(S) = 2432.6862347446913
E1 = -183.57784536467048  E_coul = 55.078531331595656
init E= -128.499314033075
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.773937634602649  LUMO = 0.795528707122204
  mo_energy =
[-3.25553672e+01 -1.85289279e+00 -7.73937635e-01 -7.73937635e-01
 -7.73937635e-01  7.95528707e-01  1.11979513e+00  1.11979513e+00
  1.11979513e+00  4.05764377e+00  5.79788515e+00  5.79788515e+00
  5.79788515e+00  1.25427492e+01  2.42426411e+01  2.42426411e+01
  2.42426411e+01  4.13173517e+01  1.19117712e+02  1.19117712e+02
  1.19117712e+02  1.45363215e+02  5.08900451e+02  1.87593028e+03
  8.00496965e+03  4.77718301e+04]
E1 = -182.1129515274851  E_coul = 53.584043874005474
cycle= 1 E= -128.52890765348  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460121
diis-c [-0.21171118  1.        ]
  HOMO = -0.879446733986345  LUMO = 0.769161490036363
  mo_energy =
[-3.28736371e+01 -1.96296990e+00 -8.79446734e-01 -8.79446734e-01
 -8.79446734e-01  7.69161490e-01  1.08148838e+00  1.08148838e+00
  1.08148838e+00  3.98717665e+00  5.66892178e+00  5.66892178e+00
  5.66892178e+00  1.24036077e+01  2.40080179e+01  2.40080179e+01
  2.40080179e+01  4.10774214e+01  1.18797177e+02  1.18797177e+02
  1.18797177e+02  1.45051514e+02  5.08543785e+02  1.87553724e+03
  8.00454747e+03  4.77713890e+04]
E1 = -182.84379031403023  E_coul = 54.31238285028232
cycle= 2 E= -128.531407463748  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229553
diis-c [-6.22455372e-04  3.31851608e-01  6.68148392e-01]
  HOMO = -0.845137138293416  LUMO = 0.777759561768262
  mo_energy =
[-3.27687541e+01 -1.92689974e+00 -8.45137138e-01 -8.45137138e-01
 -8.45137138e-01  7.77759562e-01  1.09401629e+00  1.09401629e+00
  1.09401629e+00  4.00991348e+00  5.71086509e+00  5.71086509e+00
  5.71086509e+00  1.24489784e+01  2.40854541e+01  2.40854541e+01
  2.40854541e+01  4.11568142e+01  1.18902083e+02  1.18902083e+02
  1.18902083e+02  1.45153983e+02  5.08657165e+02  1.87565588e+03
  8.00466856e+03  4.77715110e+04]
E1 = -182.59875446918957  E_coul = 54.066502702310025
cycle= 3 E= -128.53225176688  delta_E= -0.000844  |g|= 0.000486  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000988684
diis-c [-1.70763842e-07 -2.23320492e-03 -5.61106012e-04  1.00279431e+00]
  HOMO = -0.845379691563111  LUMO = 0.777723575456137
  mo_energy =
[-3.27691880e+01 -1.92707636e+00 -8.45379692e-01 -8.45379692e-01
 -8.45379692e-01  7.77723575e-01  1.09396201e+00  1.09396201e+00
  1.09396201e+00  4.00979245e+00  5.71065131e+00  5.71065131e+00
  5.71065131e+00  1.24487507e+01  2.40851127e+01  2.40851127e+01
  2.40851127e+01  4.11564744e+01  1.18901637e+02  1.18901637e+02
  1.18901637e+02  1.45153551e+02  5.08656626e+02  1.87565523e+03
  8.00466782e+03  4.77715102e+04]
E1 = -182.59930615356782  E_coul = 54.06705436410767
cycle= 4 E= -128.53225178946  delta_E= -2.26e-08  |g|= 6.42e-05  |ddm|= 0.000357
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133878
diis-c [-9.96605839e-10  3.33922432e-04  3.91902013e-04 -2.17390105e-01
  1.21666428e+00]
  HOMO = -0.845411908194335  LUMO = 0.777717251030765
  mo_energy =
[-3.27692403e+01 -1.92709553e+00 -8.45411908e-01 -8.45411908e-01
 -8.45411908e-01  7.77717251e-01  1.09394837e+00  1.09394837e+00
  1.09394837e+00  4.00977292e+00  5.71061576e+00  5.71061576e+00
  5.71061576e+00  1.24487160e+01  2.40850655e+01  2.40850655e+01
  2.40850655e+01  4.11564280e+01  1.18901584e+02  1.18901584e+02
  1.18901584e+02  1.45153499e+02  5.08656566e+02  1.87565516e+03
  8.00466774e+03  4.77715102e+04]
E1 = -182.5994082862432  E_coul = 54.06715649621532
cycle= 5 E= -128.532251790028  delta_E= -5.68e-10  |g|= 6.81e-06  |ddm|= 6.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5994082862432  E_coul = 54.06715649621532
  HOMO = -0.845408147845159  LUMO = 0.777718681550769
  mo_energy =
[-3.27692321e+01 -1.92709107e+00 -8.45408148e-01 -8.45408148e-01
 -8.45408148e-01  7.77718682e-01  1.09394996e+00  1.09394996e+00
  1.09394996e+00  4.00977604e+00  5.71062032e+00  5.71062032e+00
  5.71062032e+00  1.24487211e+01  2.40850725e+01  2.40850725e+01
  2.40850725e+01  4.11564352e+01  1.18901592e+02  1.18901592e+02
  1.18901592e+02  1.45153506e+02  5.08656574e+02  1.87565517e+03
  8.00466775e+03  4.77715102e+04]
E1 = -182.59939030816514  E_coul = 54.06713851813439
Extra cycle  E= -128.532251790031  delta_E= -2.87e-12  |g|= 2.51e-06  |ddm|= 2.6e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [8.07711913e-01 2.44137941e+04 3.66145448e+03 8.33270768e+02
 2.35738254e+02 7.64104630e+01 1.02166047e+01 2.70715080e+01
 3.14941507e-01 1.80391373e+00 2.94869953e+00 3.69312076e+00
 1.24386185e+01 5.47858293e+01 3.31235288e-01 1.14807162e+00]
E = -128.53225179003076
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.80771191281        1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448386        1
[INPUT] 0    0    [1    /1   ]  833.270768369        1
[INPUT] 0    0    [1    /1   ]  235.73825431         1
[INPUT] 0    0    [1    /1   ]  76.4104629548        1
[INPUT] 0    0    [1    /1   ]  10.2166047337        1
[INPUT] 0    0    [1    /1   ]  27.0715079933        1
[INPUT] 0    0    [1    /1   ]  0.314941506886       1
[INPUT] 0    0    [1    /1   ]  1.80391372738        1
[INPUT] 0    0    [1    /1   ]  2.94869953017        1
[INPUT] 1    0    [1    /1   ]  3.69312076379        1
[INPUT] 1    0    [1    /1   ]  12.4386185239        1
[INPUT] 1    0    [1    /1   ]  54.7858292552        1
[INPUT] 1    0    [1    /1   ]  0.331235288154       1
[INPUT] 1    0    [1    /1   ]  1.14807162107        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8077119128103601, 1.0]], [0, [24413.794129725935, 1.0]], [0, [3661.454483856788, 1.0]], [0, [833.2707683689791, 1.0]], [0, [235.73825430968202, 1.0]], [0, [76.41046295482012, 1.0]], [0, [10.21660473367428, 1.0]], [0, [27.071507993336667, 1.0]], [0, [0.3149415068858832, 1.0]], [0, [1.8039137273824142, 1.0]], [0, [2.948699530170853, 1.0]], [1, [3.6931207637866295, 1.0]], [1, [12.438618523897757, 1.0]], [1, [54.78582925517047, 1.0]], [1, [0.33123528815395575, 1.0]], [1, [1.1480716210657045, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80771191]
bas 1, expnt(s) = [24413.79412973]
bas 2, expnt(s) = [3661.45448386]
bas 3, expnt(s) = [833.27076837]
bas 4, expnt(s) = [235.73825431]
bas 5, expnt(s) = [76.41046295]
bas 6, expnt(s) = [10.21660473]
bas 7, expnt(s) = [27.07150799]
bas 8, expnt(s) = [0.31494151]
bas 9, expnt(s) = [1.80391373]
bas 10, expnt(s) = [2.94869953]
bas 11, expnt(s) = [3.69312076]
bas 12, expnt(s) = [12.43861852]
bas 13, expnt(s) = [54.78582926]
bas 14, expnt(s) = [0.33123529]
bas 15, expnt(s) = [1.14807162]
CPU time:        83.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.07711913e-01 2.15257053e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270768e+02 3.91836271e+02
 2.35738254e+02 1.51997894e+02 7.64104630e+01 6.52949581e+01
 1.02166047e+01 1.44375988e+01 2.70715080e+01 2.99846760e+01
 3.14941507e-01 1.06215390e+00 1.80391373e+00 3.93257349e+00
 2.94869953e+00 5.68509747e+00 3.69312076e+00 1.49357240e+01
 1.24386185e+01 6.81474451e+01 5.47858293e+01 4.34830193e+02
 3.31235288e-01 7.33086362e-01 1.14807162e+00 3.46693437e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998461496473553
cond(S) = 2432.6862347446913
E1 = -183.57784536467048  E_coul = 55.078531331595656
init E= -128.499314033075
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773937634602649  LUMO = 0.795528707122204
  mo_energy =
[-3.25553672e+01 -1.85289279e+00 -7.73937635e-01 -7.73937635e-01
 -7.73937635e-01  7.95528707e-01  1.11979513e+00  1.11979513e+00
  1.11979513e+00  4.05764377e+00  5.79788515e+00  5.79788515e+00
  5.79788515e+00  1.25427492e+01  2.42426411e+01  2.42426411e+01
  2.42426411e+01  4.13173517e+01  1.19117712e+02  1.19117712e+02
  1.19117712e+02  1.45363215e+02  5.08900451e+02  1.87593028e+03
  8.00496965e+03  4.77718301e+04]
E1 = -182.1129515274851  E_coul = 53.584043874005474
cycle= 1 E= -128.52890765348  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460121
diis-c [-0.21171118  1.        ]
  HOMO = -0.879446733986345  LUMO = 0.769161490036363
  mo_energy =
[-3.28736371e+01 -1.96296990e+00 -8.79446734e-01 -8.79446734e-01
 -8.79446734e-01  7.69161490e-01  1.08148838e+00  1.08148838e+00
  1.08148838e+00  3.98717665e+00  5.66892178e+00  5.66892178e+00
  5.66892178e+00  1.24036077e+01  2.40080179e+01  2.40080179e+01
  2.40080179e+01  4.10774214e+01  1.18797177e+02  1.18797177e+02
  1.18797177e+02  1.45051514e+02  5.08543785e+02  1.87553724e+03
  8.00454747e+03  4.77713890e+04]
E1 = -182.84379031403023  E_coul = 54.31238285028232
cycle= 2 E= -128.531407463748  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229553
diis-c [-6.22455372e-04  3.31851608e-01  6.68148392e-01]
  HOMO = -0.845137138293416  LUMO = 0.777759561768262
  mo_energy =
[-3.27687541e+01 -1.92689974e+00 -8.45137138e-01 -8.45137138e-01
 -8.45137138e-01  7.77759562e-01  1.09401629e+00  1.09401629e+00
  1.09401629e+00  4.00991348e+00  5.71086509e+00  5.71086509e+00
  5.71086509e+00  1.24489784e+01  2.40854541e+01  2.40854541e+01
  2.40854541e+01  4.11568142e+01  1.18902083e+02  1.18902083e+02
  1.18902083e+02  1.45153983e+02  5.08657165e+02  1.87565588e+03
  8.00466856e+03  4.77715110e+04]
E1 = -182.59875446918957  E_coul = 54.066502702310025
cycle= 3 E= -128.53225176688  delta_E= -0.000844  |g|= 0.000486  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000988684
diis-c [-1.70763842e-07 -2.23320492e-03 -5.61106012e-04  1.00279431e+00]
  HOMO = -0.845379691563111  LUMO = 0.777723575456137
  mo_energy =
[-3.27691880e+01 -1.92707636e+00 -8.45379692e-01 -8.45379692e-01
 -8.45379692e-01  7.77723575e-01  1.09396201e+00  1.09396201e+00
  1.09396201e+00  4.00979245e+00  5.71065131e+00  5.71065131e+00
  5.71065131e+00  1.24487507e+01  2.40851127e+01  2.40851127e+01
  2.40851127e+01  4.11564744e+01  1.18901637e+02  1.18901637e+02
  1.18901637e+02  1.45153551e+02  5.08656626e+02  1.87565523e+03
  8.00466782e+03  4.77715102e+04]
E1 = -182.59930615356782  E_coul = 54.06705436410767
cycle= 4 E= -128.53225178946  delta_E= -2.26e-08  |g|= 6.42e-05  |ddm|= 0.000357
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133878
diis-c [-9.96605839e-10  3.33922432e-04  3.91902013e-04 -2.17390105e-01
  1.21666428e+00]
  HOMO = -0.845411908194335  LUMO = 0.777717251030765
  mo_energy =
[-3.27692403e+01 -1.92709553e+00 -8.45411908e-01 -8.45411908e-01
 -8.45411908e-01  7.77717251e-01  1.09394837e+00  1.09394837e+00
  1.09394837e+00  4.00977292e+00  5.71061576e+00  5.71061576e+00
  5.71061576e+00  1.24487160e+01  2.40850655e+01  2.40850655e+01
  2.40850655e+01  4.11564280e+01  1.18901584e+02  1.18901584e+02
  1.18901584e+02  1.45153499e+02  5.08656566e+02  1.87565516e+03
  8.00466774e+03  4.77715102e+04]
E1 = -182.5994082862432  E_coul = 54.06715649621532
cycle= 5 E= -128.532251790028  delta_E= -5.68e-10  |g|= 6.81e-06  |ddm|= 6.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5994082862432  E_coul = 54.06715649621532
  HOMO = -0.845408147845159  LUMO = 0.777718681550769
  mo_energy =
[-3.27692321e+01 -1.92709107e+00 -8.45408148e-01 -8.45408148e-01
 -8.45408148e-01  7.77718682e-01  1.09394996e+00  1.09394996e+00
  1.09394996e+00  4.00977604e+00  5.71062032e+00  5.71062032e+00
  5.71062032e+00  1.24487211e+01  2.40850725e+01  2.40850725e+01
  2.40850725e+01  4.11564352e+01  1.18901592e+02  1.18901592e+02
  1.18901592e+02  1.45153506e+02  5.08656574e+02  1.87565517e+03
  8.00466775e+03  4.77715102e+04]
E1 = -182.59939030816514  E_coul = 54.06713851813439
Extra cycle  E= -128.532251790031  delta_E= -2.87e-12  |g|= 2.51e-06  |ddm|= 2.6e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2432.6862347446913
E1 = -182.59939030816514  E_coul = 54.06713851813439
init E= -128.532251790031
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845409403356563  LUMO = 0.777718432571189
  mo_energy =
[-3.27692361e+01 -1.92709228e+00 -8.45409403e-01 -8.45409403e-01
 -8.45409403e-01  7.77718433e-01  1.09394952e+00  1.09394952e+00
  1.09394952e+00  4.00977529e+00  5.71061879e+00  5.71061879e+00
  5.71061879e+00  1.24487195e+01  2.40850696e+01  2.40850696e+01
  2.40850696e+01  4.11564322e+01  1.18901588e+02  1.18901588e+02
  1.18901588e+02  1.45153503e+02  5.08656569e+02  1.87565516e+03
  8.00466774e+03  4.77715102e+04]
E1 = -182.5993999962026  E_coul = 54.0671482061712
cycle= 1 E= -128.532251790031  delta_E= -6.54e-13  |g|= 1.33e-06  |ddm|= 9.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5993999962026  E_coul = 54.0671482061712
  HOMO = -0.84540872198811  LUMO = 0.777718614515547
  mo_energy =
[-3.27692341e+01 -1.92709154e+00 -8.45408722e-01 -8.45408722e-01
 -8.45408722e-01  7.77718615e-01  1.09394977e+00  1.09394977e+00
  1.09394977e+00  4.00977575e+00  5.71061963e+00  5.71061963e+00
  5.71061963e+00  1.24487204e+01  2.40850712e+01  2.40850712e+01
  2.40850712e+01  4.11564337e+01  1.18901590e+02  1.18901590e+02
  1.18901590e+02  1.45153505e+02  5.08656572e+02  1.87565516e+03
  8.00466775e+03  4.77715102e+04]
E1 = -182.59939518568106  E_coul = 54.067143395649666
Extra cycle  E= -128.532251790031  delta_E=    0  |g|= 6.55e-07  |ddm|= 4.51e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [8.07711913e-01 2.44137941e+04 3.66145448e+03 8.33270768e+02
 2.35738254e+02 7.64104630e+01 1.02166047e+01 2.70715080e+01
 3.14941507e-01 1.80391373e+00 2.94869953e+00 3.69312076e+00
 1.24386185e+01 5.47858293e+01 3.31235288e-01 1.14807162e+00]
grad_E = [ 9.78205379e-05  2.86400984e-10 -1.50651285e-08  3.16096498e-07
 -4.00251631e-06  2.96929986e-05 -2.44034229e-04 -6.09871850e-05
 -2.22969787e-05  1.47487522e-05 -8.03206416e-05  5.53847510e-04
 -1.80893492e-04  1.03051261e-05  8.11728382e-04 -1.24820834e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.80639620357        1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448396        1
[INPUT] 0    0    [1    /1   ]  833.270766094        1
[INPUT] 0    0    [1    /1   ]  235.738284197        1
[INPUT] 0    0    [1    /1   ]  76.4102565513        1
[INPUT] 0    0    [1    /1   ]  10.2208401283        1
[INPUT] 0    0    [1    /1   ]  27.0714806412        1
[INPUT] 0    0    [1    /1   ]  0.314484470853       1
[INPUT] 0    0    [1    /1   ]  1.80680061392        1
[INPUT] 0    0    [1    /1   ]  2.94907497012        1
[INPUT] 1    0    [1    /1   ]  3.6924419723         1
[INPUT] 1    0    [1    /1   ]  12.4389189851        1
[INPUT] 1    0    [1    /1   ]  54.7858005697        1
[INPUT] 1    0    [1    /1   ]  0.331250927317       1
[INPUT] 1    0    [1    /1   ]  1.14734889176        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8063962035703038, 1.0]], [0, [24413.79412972394, 1.0]], [0, [3661.454483961686, 1.0]], [0, [833.2707660944792, 1.0]], [0, [235.73828419727295, 1.0]], [0, [76.41025655133939, 1.0]], [0, [10.220840128293418, 1.0]], [0, [27.071480641224877, 1.0]], [0, [0.31448447085328995, 1.0]], [0, [1.80680061391771, 1.0]], [0, [2.949074970122833, 1.0]], [1, [3.692441972302732, 1.0]], [1, [12.438918985095233, 1.0]], [1, [54.78580056970375, 1.0]], [1, [0.33125092731710615, 1.0]], [1, [1.1473488917595838, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8063962]
bas 1, expnt(s) = [24413.79412972]
bas 2, expnt(s) = [3661.45448396]
bas 3, expnt(s) = [833.27076609]
bas 4, expnt(s) = [235.7382842]
bas 5, expnt(s) = [76.41025655]
bas 6, expnt(s) = [10.22084013]
bas 7, expnt(s) = [27.07148064]
bas 8, expnt(s) = [0.31448447]
bas 9, expnt(s) = [1.80680061]
bas 10, expnt(s) = [2.94907497]
bas 11, expnt(s) = [3.69244197]
bas 12, expnt(s) = [12.43891899]
bas 13, expnt(s) = [54.78580057]
bas 14, expnt(s) = [0.33125093]
bas 15, expnt(s) = [1.14734889]
CPU time:        86.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.06396204e-01 2.14994020e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270766e+02 3.91836270e+02
 2.35738284e+02 1.51997909e+02 7.64102566e+01 6.52948258e+01
 1.02208401e+01 1.44420875e+01 2.70714806e+01 2.99846533e+01
 3.14484471e-01 1.06099766e+00 1.80680061e+00 3.93729265e+00
 2.94907497e+00 5.68564034e+00 3.69244197e+00 1.49322926e+01
 1.24389190e+01 6.81495028e+01 5.47858006e+01 4.34829908e+02
 3.31250927e-01 7.33129628e-01 1.14734889e+00 3.46420647e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998463420790726
cond(S) = 2429.639857198166
E1 = -183.57784617511092  E_coul = 55.07852778807806
init E= -128.499318387033
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773937919290818  LUMO = 0.794279669831965
  mo_energy =
[-3.25553681e+01 -1.85289348e+00 -7.73937919e-01 -7.73937919e-01
 -7.73937919e-01  7.94279670e-01  1.11959009e+00  1.11959009e+00
  1.11959009e+00  4.05506401e+00  5.79551029e+00  5.79551029e+00
  5.79551029e+00  1.25443615e+01  2.42385578e+01  2.42385578e+01
  2.42385578e+01  4.13300646e+01  1.19114752e+02  1.19114752e+02
  1.19114752e+02  1.45383956e+02  5.08921655e+02  1.87594967e+03
  8.00498680e+03  4.77718443e+04]
E1 = -182.11343307260148  E_coul = 53.58452322324637
cycle= 1 E= -128.528909849355  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460091
diis-c [-0.21168355  1.        ]
  HOMO = -0.879405453098703  LUMO = 0.767972037309477
  mo_energy =
[-3.28735681e+01 -1.96292340e+00 -8.79405453e-01 -8.79405453e-01
 -8.79405453e-01  7.67972037e-01  1.08132257e+00  1.08132257e+00
  1.08132257e+00  3.98462323e+00  5.66662807e+00  5.66662807e+00
  5.66662807e+00  1.24052193e+01  2.40039925e+01  2.40039925e+01
  2.40039925e+01  4.10901700e+01  1.18794288e+02  1.18794288e+02
  1.18794288e+02  1.45072322e+02  5.08565060e+02  1.87555670e+03
  8.00456469e+03  4.77714033e+04]
E1 = -182.84414117049621  E_coul = 54.312732098422465
cycle= 2 E= -128.531409072074  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229527
diis-c [-6.22380644e-04  3.31840623e-01  6.68159377e-01]
  HOMO = -0.845101193786137  LUMO = 0.776557321808474
  mo_energy =
[-3.27687029e+01 -1.92685895e+00 -8.45101194e-01 -8.45101194e-01
 -8.45101194e-01  7.76557322e-01  1.09384291e+00  1.09384291e+00
  1.09384291e+00  4.00736096e+00  5.70855478e+00  5.70855478e+00
  5.70855478e+00  1.24506001e+01  2.40814165e+01  2.40814165e+01
  2.40814165e+01  4.11695574e+01  1.18899177e+02  1.18899177e+02
  1.18899177e+02  1.45174774e+02  5.08678421e+02  1.87567533e+03
  8.00468575e+03  4.77715253e+04]
E1 = -182.5991894868614  E_coul = 54.066936555168255
cycle= 3 E= -128.532252931693  delta_E= -0.000844  |g|= 0.000483  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000983327
diis-c [-1.72379355e-07 -2.22760872e-03 -5.79673926e-04  1.00280728e+00]
  HOMO = -0.845341484430323  LUMO = 0.776522540468075
  mo_energy =
[-3.27691335e+01 -1.92703279e+00 -8.45341484e-01 -8.45341484e-01
 -8.45341484e-01  7.76522540e-01  1.09378976e+00  1.09378976e+00
  1.09378976e+00  4.00724204e+00  5.70834374e+00  5.70834374e+00
  5.70834374e+00  1.24503753e+01  2.40810784e+01  2.40810784e+01
  2.40810784e+01  4.11692208e+01  1.18898734e+02  1.18898734e+02
  1.18898734e+02  1.45174346e+02  5.08677885e+02  1.87567468e+03
  8.00468502e+03  4.77715245e+04]
E1 = -182.59973650598067  E_coul = 54.06748355187381
cycle= 4 E= -128.532252954107  delta_E= -2.24e-08  |g|= 6.41e-05  |ddm|= 0.000355
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013388
diis-c [-9.99129012e-10  3.35682867e-04  3.95063080e-04 -2.18646690e-01
  1.21791594e+00]
  HOMO = -0.8453735206728  LUMO = 0.776516357960494
  mo_energy =
[-3.27691856e+01 -1.92705164e+00 -8.45373521e-01 -8.45373521e-01
 -8.45373521e-01  7.76516358e-01  1.09377622e+00  1.09377622e+00
  1.09377622e+00  4.00722273e+00  5.70830842e+00  5.70830842e+00
  5.70830842e+00  1.24503409e+01  2.40810315e+01  2.40810315e+01
  2.40810315e+01  4.11691747e+01  1.18898681e+02  1.18898681e+02
  1.18898681e+02  1.45174293e+02  5.08677825e+02  1.87567461e+03
  8.00468494e+03  4.77715244e+04]
E1 = -182.599838363281  E_coul = 54.06758540860318
cycle= 5 E= -128.532252954678  delta_E= -5.71e-10  |g|= 6.82e-06  |ddm|= 6.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.599838363281  E_coul = 54.06758540860318
  HOMO = -0.845369748615532  LUMO = 0.776517786339825
  mo_energy =
[-3.27691774e+01 -1.92704718e+00 -8.45369749e-01 -8.45369749e-01
 -8.45369749e-01  7.76517786e-01  1.09377780e+00  1.09377780e+00
  1.09377780e+00  4.00722585e+00  5.70831300e+00  5.70831300e+00
  5.70831300e+00  1.24503461e+01  2.40810385e+01  2.40810385e+01
  2.40810385e+01  4.11691819e+01  1.18898689e+02  1.18898689e+02
  1.18898689e+02  1.45174301e+02  5.08677833e+02  1.87567461e+03
  8.00468495e+03  4.77715244e+04]
E1 = -182.5998203040104  E_coul = 54.06756734932995
Extra cycle  E= -128.53225295468  delta_E= -2.61e-12  |g|= 2.53e-06  |ddm|= 2.61e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.06396204e-01 2.44137941e+04 3.66145448e+03 8.33270766e+02
 2.35738284e+02 7.64102566e+01 1.02208401e+01 2.70714806e+01
 3.14484471e-01 1.80680061e+00 2.94907497e+00 3.69244197e+00
 1.24389190e+01 5.47858006e+01 3.31250927e-01 1.14734889e+00]
E = -128.53225295468044
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.80639620357        1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448396        1
[INPUT] 0    0    [1    /1   ]  833.270766094        1
[INPUT] 0    0    [1    /1   ]  235.738284197        1
[INPUT] 0    0    [1    /1   ]  76.4102565513        1
[INPUT] 0    0    [1    /1   ]  10.2208401283        1
[INPUT] 0    0    [1    /1   ]  27.0714806412        1
[INPUT] 0    0    [1    /1   ]  0.314484470853       1
[INPUT] 0    0    [1    /1   ]  1.80680061392        1
[INPUT] 0    0    [1    /1   ]  2.94907497012        1
[INPUT] 1    0    [1    /1   ]  3.6924419723         1
[INPUT] 1    0    [1    /1   ]  12.4389189851        1
[INPUT] 1    0    [1    /1   ]  54.7858005697        1
[INPUT] 1    0    [1    /1   ]  0.331250927317       1
[INPUT] 1    0    [1    /1   ]  1.14734889176        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8063962035703038, 1.0]], [0, [24413.79412972394, 1.0]], [0, [3661.454483961686, 1.0]], [0, [833.2707660944792, 1.0]], [0, [235.73828419727295, 1.0]], [0, [76.41025655133939, 1.0]], [0, [10.220840128293418, 1.0]], [0, [27.071480641224877, 1.0]], [0, [0.31448447085328995, 1.0]], [0, [1.80680061391771, 1.0]], [0, [2.949074970122833, 1.0]], [1, [3.692441972302732, 1.0]], [1, [12.438918985095233, 1.0]], [1, [54.78580056970375, 1.0]], [1, [0.33125092731710615, 1.0]], [1, [1.1473488917595838, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8063962]
bas 1, expnt(s) = [24413.79412972]
bas 2, expnt(s) = [3661.45448396]
bas 3, expnt(s) = [833.27076609]
bas 4, expnt(s) = [235.7382842]
bas 5, expnt(s) = [76.41025655]
bas 6, expnt(s) = [10.22084013]
bas 7, expnt(s) = [27.07148064]
bas 8, expnt(s) = [0.31448447]
bas 9, expnt(s) = [1.80680061]
bas 10, expnt(s) = [2.94907497]
bas 11, expnt(s) = [3.69244197]
bas 12, expnt(s) = [12.43891899]
bas 13, expnt(s) = [54.78580057]
bas 14, expnt(s) = [0.33125093]
bas 15, expnt(s) = [1.14734889]
CPU time:        86.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.06396204e-01 2.14994020e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270766e+02 3.91836270e+02
 2.35738284e+02 1.51997909e+02 7.64102566e+01 6.52948258e+01
 1.02208401e+01 1.44420875e+01 2.70714806e+01 2.99846533e+01
 3.14484471e-01 1.06099766e+00 1.80680061e+00 3.93729265e+00
 2.94907497e+00 5.68564034e+00 3.69244197e+00 1.49322926e+01
 1.24389190e+01 6.81495028e+01 5.47858006e+01 4.34829908e+02
 3.31250927e-01 7.33129628e-01 1.14734889e+00 3.46420647e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998463420790726
cond(S) = 2429.639857198166
E1 = -183.57784617511092  E_coul = 55.07852778807806
init E= -128.499318387033
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773937919290818  LUMO = 0.794279669831965
  mo_energy =
[-3.25553681e+01 -1.85289348e+00 -7.73937919e-01 -7.73937919e-01
 -7.73937919e-01  7.94279670e-01  1.11959009e+00  1.11959009e+00
  1.11959009e+00  4.05506401e+00  5.79551029e+00  5.79551029e+00
  5.79551029e+00  1.25443615e+01  2.42385578e+01  2.42385578e+01
  2.42385578e+01  4.13300646e+01  1.19114752e+02  1.19114752e+02
  1.19114752e+02  1.45383956e+02  5.08921655e+02  1.87594967e+03
  8.00498680e+03  4.77718443e+04]
E1 = -182.11343307260148  E_coul = 53.58452322324637
cycle= 1 E= -128.528909849355  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460091
diis-c [-0.21168355  1.        ]
  HOMO = -0.879405453098703  LUMO = 0.767972037309477
  mo_energy =
[-3.28735681e+01 -1.96292340e+00 -8.79405453e-01 -8.79405453e-01
 -8.79405453e-01  7.67972037e-01  1.08132257e+00  1.08132257e+00
  1.08132257e+00  3.98462323e+00  5.66662807e+00  5.66662807e+00
  5.66662807e+00  1.24052193e+01  2.40039925e+01  2.40039925e+01
  2.40039925e+01  4.10901700e+01  1.18794288e+02  1.18794288e+02
  1.18794288e+02  1.45072322e+02  5.08565060e+02  1.87555670e+03
  8.00456469e+03  4.77714033e+04]
E1 = -182.84414117049621  E_coul = 54.312732098422465
cycle= 2 E= -128.531409072074  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229527
diis-c [-6.22380644e-04  3.31840623e-01  6.68159377e-01]
  HOMO = -0.845101193786137  LUMO = 0.776557321808474
  mo_energy =
[-3.27687029e+01 -1.92685895e+00 -8.45101194e-01 -8.45101194e-01
 -8.45101194e-01  7.76557322e-01  1.09384291e+00  1.09384291e+00
  1.09384291e+00  4.00736096e+00  5.70855478e+00  5.70855478e+00
  5.70855478e+00  1.24506001e+01  2.40814165e+01  2.40814165e+01
  2.40814165e+01  4.11695574e+01  1.18899177e+02  1.18899177e+02
  1.18899177e+02  1.45174774e+02  5.08678421e+02  1.87567533e+03
  8.00468575e+03  4.77715253e+04]
E1 = -182.5991894868614  E_coul = 54.066936555168255
cycle= 3 E= -128.532252931693  delta_E= -0.000844  |g|= 0.000483  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000983327
diis-c [-1.72379355e-07 -2.22760872e-03 -5.79673926e-04  1.00280728e+00]
  HOMO = -0.845341484430323  LUMO = 0.776522540468075
  mo_energy =
[-3.27691335e+01 -1.92703279e+00 -8.45341484e-01 -8.45341484e-01
 -8.45341484e-01  7.76522540e-01  1.09378976e+00  1.09378976e+00
  1.09378976e+00  4.00724204e+00  5.70834374e+00  5.70834374e+00
  5.70834374e+00  1.24503753e+01  2.40810784e+01  2.40810784e+01
  2.40810784e+01  4.11692208e+01  1.18898734e+02  1.18898734e+02
  1.18898734e+02  1.45174346e+02  5.08677885e+02  1.87567468e+03
  8.00468502e+03  4.77715245e+04]
E1 = -182.59973650598067  E_coul = 54.06748355187381
cycle= 4 E= -128.532252954107  delta_E= -2.24e-08  |g|= 6.41e-05  |ddm|= 0.000355
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013388
diis-c [-9.99129012e-10  3.35682867e-04  3.95063080e-04 -2.18646690e-01
  1.21791594e+00]
  HOMO = -0.8453735206728  LUMO = 0.776516357960494
  mo_energy =
[-3.27691856e+01 -1.92705164e+00 -8.45373521e-01 -8.45373521e-01
 -8.45373521e-01  7.76516358e-01  1.09377622e+00  1.09377622e+00
  1.09377622e+00  4.00722273e+00  5.70830842e+00  5.70830842e+00
  5.70830842e+00  1.24503409e+01  2.40810315e+01  2.40810315e+01
  2.40810315e+01  4.11691747e+01  1.18898681e+02  1.18898681e+02
  1.18898681e+02  1.45174293e+02  5.08677825e+02  1.87567461e+03
  8.00468494e+03  4.77715244e+04]
E1 = -182.599838363281  E_coul = 54.06758540860318
cycle= 5 E= -128.532252954678  delta_E= -5.71e-10  |g|= 6.82e-06  |ddm|= 6.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.599838363281  E_coul = 54.06758540860318
  HOMO = -0.845369748615532  LUMO = 0.776517786339825
  mo_energy =
[-3.27691774e+01 -1.92704718e+00 -8.45369749e-01 -8.45369749e-01
 -8.45369749e-01  7.76517786e-01  1.09377780e+00  1.09377780e+00
  1.09377780e+00  4.00722585e+00  5.70831300e+00  5.70831300e+00
  5.70831300e+00  1.24503461e+01  2.40810385e+01  2.40810385e+01
  2.40810385e+01  4.11691819e+01  1.18898689e+02  1.18898689e+02
  1.18898689e+02  1.45174301e+02  5.08677833e+02  1.87567461e+03
  8.00468495e+03  4.77715244e+04]
E1 = -182.5998203040104  E_coul = 54.06756734932995
Extra cycle  E= -128.53225295468  delta_E= -2.61e-12  |g|= 2.53e-06  |ddm|= 2.61e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2429.639857198166
E1 = -182.5998203040104  E_coul = 54.06756734932995
init E= -128.53225295468
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845371009521503  LUMO = 0.776517535767406
  mo_energy =
[-3.27691814e+01 -1.92704839e+00 -8.45371010e-01 -8.45371010e-01
 -8.45371010e-01  7.76517536e-01  1.09377736e+00  1.09377736e+00
  1.09377736e+00  4.00722510e+00  5.70831146e+00  5.70831146e+00
  5.70831146e+00  1.24503444e+01  2.40810356e+01  2.40810356e+01
  2.40810356e+01  4.11691789e+01  1.18898685e+02  1.18898685e+02
  1.18898685e+02  1.45174297e+02  5.08677828e+02  1.87567461e+03
  8.00468494e+03  4.77715244e+04]
E1 = -182.5998300307426  E_coul = 54.06757707606141
cycle= 1 E= -128.532252954681  delta_E= -7.39e-13  |g|= 1.33e-06  |ddm|= 9.8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5998300307426  E_coul = 54.06757707606141
  HOMO = -0.845370325359394  LUMO = 0.776517718025078
  mo_energy =
[-3.27691793e+01 -1.92704765e+00 -8.45370325e-01 -8.45370325e-01
 -8.45370325e-01  7.76517718e-01  1.09377761e+00  1.09377761e+00
  1.09377761e+00  4.00722557e+00  5.70831230e+00  5.70831230e+00
  5.70831230e+00  1.24503453e+01  2.40810371e+01  2.40810371e+01
  2.40810371e+01  4.11691805e+01  1.18898687e+02  1.18898687e+02
  1.18898687e+02  1.45174299e+02  5.08677831e+02  1.87567461e+03
  8.00468495e+03  4.77715244e+04]
E1 = -182.5998252012231  E_coul = 54.0675722465414
Extra cycle  E= -128.532252954682  delta_E= -5.12e-13  |g|= 6.57e-07  |ddm|= 4.53e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [8.06396204e-01 2.44137941e+04 3.66145448e+03 8.33270766e+02
 2.35738284e+02 7.64102566e+01 1.02208401e+01 2.70714806e+01
 3.14484471e-01 1.80680061e+00 2.94907497e+00 3.69244197e+00
 1.24389190e+01 5.47858006e+01 3.31250927e-01 1.14734889e+00]
grad_E = [ 6.60630805e-05  3.07388774e-10 -1.61658120e-08  3.38311608e-07
 -4.26707669e-06  3.17405812e-05 -2.30227463e-04 -6.97166174e-05
  1.27119135e-05  2.03127336e-05 -8.38277807e-05  7.24725088e-04
 -1.91053347e-04  1.04700943e-05  2.35616582e-03 -9.70068043e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.806811663525       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448437        1
[INPUT] 0    0    [1    /1   ]  833.270757489        1
[INPUT] 0    0    [1    /1   ]  235.73839391         1
[INPUT] 0    0    [1    /1   ]  76.409509752         1
[INPUT] 0    0    [1    /1   ]  10.2320954224        1
[INPUT] 0    0    [1    /1   ]  27.0718372145        1
[INPUT] 0    0    [1    /1   ]  0.314301523699       1
[INPUT] 0    0    [1    /1   ]  1.81930775206        1
[INPUT] 0    0    [1    /1   ]  2.95109466997        1
[INPUT] 1    0    [1    /1   ]  3.6903978957         1
[INPUT] 1    0    [1    /1   ]  12.439661966         1
[INPUT] 1    0    [1    /1   ]  54.7857310883        1
[INPUT] 1    0    [1    /1   ]  0.331116394825       1
[INPUT] 1    0    [1    /1   ]  1.14589591655        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8068116635250137, 1.0]], [0, [24413.79412971625, 1.0]], [0, [3661.4544843658214, 1.0]], [0, [833.2707574888835, 1.0]], [0, [235.73839391036287, 1.0]], [0, [76.40950975198263, 1.0]], [0, [10.232095422425523, 1.0]], [0, [27.071837214453076, 1.0]], [0, [0.31430152369931874, 1.0]], [0, [1.81930775206027, 1.0]], [0, [2.9510946699727487, 1.0]], [1, [3.690397895696048, 1.0]], [1, [12.439661966014512, 1.0]], [1, [54.7857310882699, 1.0]], [1, [0.33111639482534244, 1.0]], [1, [1.1458959165505374, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80681166]
bas 1, expnt(s) = [24413.79412972]
bas 2, expnt(s) = [3661.45448437]
bas 3, expnt(s) = [833.27075749]
bas 4, expnt(s) = [235.73839391]
bas 5, expnt(s) = [76.40950975]
bas 6, expnt(s) = [10.23209542]
bas 7, expnt(s) = [27.07183721]
bas 8, expnt(s) = [0.31430152]
bas 9, expnt(s) = [1.81930775]
bas 10, expnt(s) = [2.95109467]
bas 11, expnt(s) = [3.6903979]
bas 12, expnt(s) = [12.43966197]
bas 13, expnt(s) = [54.78573109]
bas 14, expnt(s) = [0.33111639]
bas 15, expnt(s) = [1.14589592]
CPU time:        89.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.06811664e-01 2.15077089e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270757e+02 3.91836267e+02
 2.35738394e+02 1.51997962e+02 7.64095098e+01 6.52943472e+01
 1.02320954e+01 1.44540136e+01 2.70718372e+01 2.99849495e+01
 3.14301524e-01 1.06053472e+00 1.81930775e+00 3.95771623e+00
 2.95109467e+00 5.68856049e+00 3.69039790e+00 1.49219605e+01
 1.24396620e+01 6.81545911e+01 5.47857311e+01 4.34829219e+02
 3.31116395e-01 7.32757460e-01 1.14589592e+00 3.45872360e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998469216641865
cond(S) = 2460.623316722866
E1 = -183.57783419706908  E_coul = 55.078518382556844
init E= -128.499315814512
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773939223340652  LUMO = 0.794806679067119
  mo_energy =
[-3.25553696e+01 -1.85289494e+00 -7.73939223e-01 -7.73939223e-01
 -7.73939223e-01  7.94806679e-01  1.11869520e+00  1.11869520e+00
  1.11869520e+00  4.06464866e+00  5.78965931e+00  5.78965931e+00
  5.78965931e+00  1.25822385e+01  2.42280324e+01  2.42280324e+01
  2.42280324e+01  4.14085865e+01  1.19106832e+02  1.19106832e+02
  1.19106832e+02  1.45482956e+02  5.09017927e+02  1.87603696e+03
  8.00506381e+03  4.77719081e+04]
E1 = -182.1137461381545  E_coul = 53.58483378244954
cycle= 1 E= -128.528912355705  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460109
diis-c [-0.21170026  1.        ]
  HOMO = -0.879376510632214  LUMO = 0.768481900269014
  mo_energy =
[-3.28735327e+01 -1.96289140e+00 -8.79376511e-01 -8.79376511e-01
 -8.79376511e-01  7.68481900e-01  1.08049034e+00  1.08049034e+00
  1.08049034e+00  3.99403666e+00  5.66088346e+00  5.66088346e+00
  5.66088346e+00  1.24429020e+01  2.39934981e+01  2.39934981e+01
  2.39934981e+01  4.11686706e+01  1.18786403e+02  1.18786403e+02
  1.18786403e+02  1.45171365e+02  5.08661375e+02  1.87564403e+03
  8.00464173e+03  4.77714671e+04]
E1 = -182.84445804570063  E_coul = 54.31304643349283
cycle= 2 E= -128.531411612208  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229539
diis-c [-6.22735481e-04  3.31842777e-01  6.68157223e-01]
  HOMO = -0.845071564504648  LUMO = 0.777079489614802
  mo_energy =
[-3.27686701e+01 -1.92682613e+00 -8.45071565e-01 -8.45071565e-01
 -8.45071565e-01  7.77079490e-01  1.09299635e+00  1.09299635e+00
  1.09299635e+00  4.01684106e+00  5.70278790e+00  5.70278790e+00
  5.70278790e+00  1.24883598e+01  2.40709225e+01  2.40709225e+01
  2.40709225e+01  4.12480751e+01  1.18891291e+02  1.18891291e+02
  1.18891291e+02  1.45273812e+02  5.08774731e+02  1.87576265e+03
  8.00476279e+03  4.77715891e+04]
E1 = -182.59954473705133  E_coul = 54.06728941606413
cycle= 3 E= -128.532255320987  delta_E= -0.000844  |g|= 0.000478  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000975819
diis-c [-1.73544415e-07 -2.21962449e-03 -6.03279737e-04  1.00282290e+00]
  HOMO = -0.845309070491718  LUMO = 0.777045999669776
  mo_energy =
[-3.27690964e+01 -1.92699669e+00 -8.45309070e-01 -8.45309070e-01
 -8.45309070e-01  7.77046000e-01  1.09294461e+00  1.09294461e+00
  1.09294461e+00  4.01672435e+00  5.70258029e+00  5.70258029e+00
  5.70258029e+00  1.24881383e+01  2.40705885e+01  2.40705885e+01
  2.40705885e+01  4.12477426e+01  1.18890852e+02  1.18890852e+02
  1.18890852e+02  1.45273388e+02  5.08774199e+02  1.87576200e+03
  8.00476206e+03  4.77715883e+04]
E1 = -182.600085268794  E_coul = 54.067829925640275
cycle= 4 E= -128.532255343154  delta_E= -2.22e-08  |g|= 6.39e-05  |ddm|= 0.000352
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133756
diis-c [-1.00152875e-09  3.37170470e-04  3.99326537e-04 -2.19901445e-01
  1.21916495e+00]
  HOMO = -0.845340889297912  LUMO = 0.777039952396081
  mo_energy =
[-3.27691481e+01 -1.92701520e+00 -8.45340889e-01 -8.45340889e-01
 -8.45340889e-01  7.77039952e-01  1.09293119e+00  1.09293119e+00
  1.09293119e+00  4.01670525e+00  5.70254525e+00  5.70254525e+00
  5.70254525e+00  1.24881041e+01  2.40705419e+01  2.40705419e+01
  2.40705419e+01  4.12476969e+01  1.18890800e+02  1.18890800e+02
  1.18890800e+02  1.45273336e+02  5.08774139e+02  1.87576193e+03
  8.00476198e+03  4.77715882e+04]
E1 = -182.60018680231175  E_coul = 54.06793145858544
cycle= 5 E= -128.532255343726  delta_E= -5.73e-10  |g|= 6.82e-06  |ddm|= 6.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60018680231175  E_coul = 54.06793145858544
  HOMO = -0.845337107811814  LUMO = 0.777041380896993
  mo_energy =
[-3.27691399e+01 -1.92701073e+00 -8.45337108e-01 -8.45337108e-01
 -8.45337108e-01  7.77041381e-01  1.09293278e+00  1.09293278e+00
  1.09293278e+00  4.01670839e+00  5.70254984e+00  5.70254984e+00
  5.70254984e+00  1.24881093e+01  2.40705490e+01  2.40705490e+01
  2.40705490e+01  4.12477041e+01  1.18890808e+02  1.18890808e+02
  1.18890808e+02  1.45273344e+02  5.08774147e+02  1.87576194e+03
  8.00476199e+03  4.77715883e+04]
E1 = -182.6001686654325  E_coul = 54.067913321703685
Extra cycle  E= -128.532255343729  delta_E= -2.5e-12  |g|= 2.54e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.06811664e-01 2.44137941e+04 3.66145448e+03 8.33270757e+02
 2.35738394e+02 7.64095098e+01 1.02320954e+01 2.70718372e+01
 3.14301524e-01 1.81930775e+00 2.95109467e+00 3.69039790e+00
 1.24396620e+01 5.47857311e+01 3.31116395e-01 1.14589592e+00]
E = -128.53225534372882
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.806811663525       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448437        1
[INPUT] 0    0    [1    /1   ]  833.270757489        1
[INPUT] 0    0    [1    /1   ]  235.73839391         1
[INPUT] 0    0    [1    /1   ]  76.409509752         1
[INPUT] 0    0    [1    /1   ]  10.2320954224        1
[INPUT] 0    0    [1    /1   ]  27.0718372145        1
[INPUT] 0    0    [1    /1   ]  0.314301523699       1
[INPUT] 0    0    [1    /1   ]  1.81930775206        1
[INPUT] 0    0    [1    /1   ]  2.95109466997        1
[INPUT] 1    0    [1    /1   ]  3.6903978957         1
[INPUT] 1    0    [1    /1   ]  12.439661966         1
[INPUT] 1    0    [1    /1   ]  54.7857310883        1
[INPUT] 1    0    [1    /1   ]  0.331116394825       1
[INPUT] 1    0    [1    /1   ]  1.14589591655        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8068116635250137, 1.0]], [0, [24413.79412971625, 1.0]], [0, [3661.4544843658214, 1.0]], [0, [833.2707574888835, 1.0]], [0, [235.73839391036287, 1.0]], [0, [76.40950975198263, 1.0]], [0, [10.232095422425523, 1.0]], [0, [27.071837214453076, 1.0]], [0, [0.31430152369931874, 1.0]], [0, [1.81930775206027, 1.0]], [0, [2.9510946699727487, 1.0]], [1, [3.690397895696048, 1.0]], [1, [12.439661966014512, 1.0]], [1, [54.7857310882699, 1.0]], [1, [0.33111639482534244, 1.0]], [1, [1.1458959165505374, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80681166]
bas 1, expnt(s) = [24413.79412972]
bas 2, expnt(s) = [3661.45448437]
bas 3, expnt(s) = [833.27075749]
bas 4, expnt(s) = [235.73839391]
bas 5, expnt(s) = [76.40950975]
bas 6, expnt(s) = [10.23209542]
bas 7, expnt(s) = [27.07183721]
bas 8, expnt(s) = [0.31430152]
bas 9, expnt(s) = [1.81930775]
bas 10, expnt(s) = [2.95109467]
bas 11, expnt(s) = [3.6903979]
bas 12, expnt(s) = [12.43966197]
bas 13, expnt(s) = [54.78573109]
bas 14, expnt(s) = [0.33111639]
bas 15, expnt(s) = [1.14589592]
CPU time:        90.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.06811664e-01 2.15077089e+00 2.44137941e+04 4.93448102e+03
 3.66145448e+03 1.18920097e+03 8.33270757e+02 3.91836267e+02
 2.35738394e+02 1.51997962e+02 7.64095098e+01 6.52943472e+01
 1.02320954e+01 1.44540136e+01 2.70718372e+01 2.99849495e+01
 3.14301524e-01 1.06053472e+00 1.81930775e+00 3.95771623e+00
 2.95109467e+00 5.68856049e+00 3.69039790e+00 1.49219605e+01
 1.24396620e+01 6.81545911e+01 5.47857311e+01 4.34829219e+02
 3.31116395e-01 7.32757460e-01 1.14589592e+00 3.45872360e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998469216641865
cond(S) = 2460.623316722866
E1 = -183.57783419706908  E_coul = 55.078518382556844
init E= -128.499315814512
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773939223340652  LUMO = 0.794806679067119
  mo_energy =
[-3.25553696e+01 -1.85289494e+00 -7.73939223e-01 -7.73939223e-01
 -7.73939223e-01  7.94806679e-01  1.11869520e+00  1.11869520e+00
  1.11869520e+00  4.06464866e+00  5.78965931e+00  5.78965931e+00
  5.78965931e+00  1.25822385e+01  2.42280324e+01  2.42280324e+01
  2.42280324e+01  4.14085865e+01  1.19106832e+02  1.19106832e+02
  1.19106832e+02  1.45482956e+02  5.09017927e+02  1.87603696e+03
  8.00506381e+03  4.77719081e+04]
E1 = -182.1137461381545  E_coul = 53.58483378244954
cycle= 1 E= -128.528912355705  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460109
diis-c [-0.21170026  1.        ]
  HOMO = -0.879376510632214  LUMO = 0.768481900269014
  mo_energy =
[-3.28735327e+01 -1.96289140e+00 -8.79376511e-01 -8.79376511e-01
 -8.79376511e-01  7.68481900e-01  1.08049034e+00  1.08049034e+00
  1.08049034e+00  3.99403666e+00  5.66088346e+00  5.66088346e+00
  5.66088346e+00  1.24429020e+01  2.39934981e+01  2.39934981e+01
  2.39934981e+01  4.11686706e+01  1.18786403e+02  1.18786403e+02
  1.18786403e+02  1.45171365e+02  5.08661375e+02  1.87564403e+03
  8.00464173e+03  4.77714671e+04]
E1 = -182.84445804570063  E_coul = 54.31304643349283
cycle= 2 E= -128.531411612208  delta_E= -0.0025  |g|= 0.0998  |ddm|= 0.0674
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229539
diis-c [-6.22735481e-04  3.31842777e-01  6.68157223e-01]
  HOMO = -0.845071564504648  LUMO = 0.777079489614802
  mo_energy =
[-3.27686701e+01 -1.92682613e+00 -8.45071565e-01 -8.45071565e-01
 -8.45071565e-01  7.77079490e-01  1.09299635e+00  1.09299635e+00
  1.09299635e+00  4.01684106e+00  5.70278790e+00  5.70278790e+00
  5.70278790e+00  1.24883598e+01  2.40709225e+01  2.40709225e+01
  2.40709225e+01  4.12480751e+01  1.18891291e+02  1.18891291e+02
  1.18891291e+02  1.45273812e+02  5.08774731e+02  1.87576265e+03
  8.00476279e+03  4.77715891e+04]
E1 = -182.59954473705133  E_coul = 54.06728941606413
cycle= 3 E= -128.532255320987  delta_E= -0.000844  |g|= 0.000478  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000975819
diis-c [-1.73544415e-07 -2.21962449e-03 -6.03279737e-04  1.00282290e+00]
  HOMO = -0.845309070491718  LUMO = 0.777045999669776
  mo_energy =
[-3.27690964e+01 -1.92699669e+00 -8.45309070e-01 -8.45309070e-01
 -8.45309070e-01  7.77046000e-01  1.09294461e+00  1.09294461e+00
  1.09294461e+00  4.01672435e+00  5.70258029e+00  5.70258029e+00
  5.70258029e+00  1.24881383e+01  2.40705885e+01  2.40705885e+01
  2.40705885e+01  4.12477426e+01  1.18890852e+02  1.18890852e+02
  1.18890852e+02  1.45273388e+02  5.08774199e+02  1.87576200e+03
  8.00476206e+03  4.77715883e+04]
E1 = -182.600085268794  E_coul = 54.067829925640275
cycle= 4 E= -128.532255343154  delta_E= -2.22e-08  |g|= 6.39e-05  |ddm|= 0.000352
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133756
diis-c [-1.00152875e-09  3.37170470e-04  3.99326537e-04 -2.19901445e-01
  1.21916495e+00]
  HOMO = -0.845340889297912  LUMO = 0.777039952396081
  mo_energy =
[-3.27691481e+01 -1.92701520e+00 -8.45340889e-01 -8.45340889e-01
 -8.45340889e-01  7.77039952e-01  1.09293119e+00  1.09293119e+00
  1.09293119e+00  4.01670525e+00  5.70254525e+00  5.70254525e+00
  5.70254525e+00  1.24881041e+01  2.40705419e+01  2.40705419e+01
  2.40705419e+01  4.12476969e+01  1.18890800e+02  1.18890800e+02
  1.18890800e+02  1.45273336e+02  5.08774139e+02  1.87576193e+03
  8.00476198e+03  4.77715882e+04]
E1 = -182.60018680231175  E_coul = 54.06793145858544
cycle= 5 E= -128.532255343726  delta_E= -5.73e-10  |g|= 6.82e-06  |ddm|= 6.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60018680231175  E_coul = 54.06793145858544
  HOMO = -0.845337107811814  LUMO = 0.777041380896993
  mo_energy =
[-3.27691399e+01 -1.92701073e+00 -8.45337108e-01 -8.45337108e-01
 -8.45337108e-01  7.77041381e-01  1.09293278e+00  1.09293278e+00
  1.09293278e+00  4.01670839e+00  5.70254984e+00  5.70254984e+00
  5.70254984e+00  1.24881093e+01  2.40705490e+01  2.40705490e+01
  2.40705490e+01  4.12477041e+01  1.18890808e+02  1.18890808e+02
  1.18890808e+02  1.45273344e+02  5.08774147e+02  1.87576194e+03
  8.00476199e+03  4.77715883e+04]
E1 = -182.6001686654325  E_coul = 54.067913321703685
Extra cycle  E= -128.532255343729  delta_E= -2.5e-12  |g|= 2.54e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2460.623316722866
E1 = -182.6001686654325  E_coul = 54.067913321703685
init E= -128.532255343729
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845338373880055  LUMO = 0.777041127963485
  mo_energy =
[-3.27691439e+01 -1.92701195e+00 -8.45338374e-01 -8.45338374e-01
 -8.45338374e-01  7.77041128e-01  1.09293234e+00  1.09293234e+00
  1.09293234e+00  4.01670762e+00  5.70254830e+00  5.70254830e+00
  5.70254830e+00  1.24881076e+01  2.40705460e+01  2.40705460e+01
  2.40705460e+01  4.12477011e+01  1.18890804e+02  1.18890804e+02
  1.18890804e+02  1.45273340e+02  5.08774143e+02  1.87576194e+03
  8.00476199e+03  4.77715882e+04]
E1 = -182.60017842866947  E_coul = 54.06792308494031
cycle= 1 E= -128.532255343729  delta_E= -3.41e-13  |g|= 1.34e-06  |ddm|= 9.83e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60017842866947  E_coul = 54.06792308494031
  HOMO = -0.845337687070352  LUMO = 0.7770413109759
  mo_energy =
[-3.27691419e+01 -1.92701121e+00 -8.45337687e-01 -8.45337687e-01
 -8.45337687e-01  7.77041311e-01  1.09293259e+00  1.09293259e+00
  1.09293259e+00  4.01670810e+00  5.70254914e+00  5.70254914e+00
  5.70254914e+00  1.24881085e+01  2.40705476e+01  2.40705476e+01
  2.40705476e+01  4.12477027e+01  1.18890806e+02  1.18890806e+02
  1.18890806e+02  1.45273342e+02  5.08774145e+02  1.87576194e+03
  8.00476199e+03  4.77715882e+04]
E1 = -182.6001735810416  E_coul = 54.067918237312455
Extra cycle  E= -128.532255343729  delta_E= 2.84e-14  |g|= 6.6e-07  |ddm|= 4.54e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [8.06811664e-01 2.44137941e+04 3.66145448e+03 8.33270757e+02
 2.35738394e+02 7.64095098e+01 1.02320954e+01 2.70718372e+01
 3.14301524e-01 1.81930775e+00 2.95109467e+00 3.69039790e+00
 1.24396620e+01 5.47857311e+01 3.31116395e-01 1.14589592e+00]
grad_E = [ 2.44002142e-05  3.57055552e-10 -1.87717171e-08  3.90996566e-07
 -4.89798378e-06  3.66682814e-05 -1.96648739e-04 -9.09005717e-05
  5.62380115e-05  2.65449108e-05 -8.92833944e-05  8.83596718e-04
 -1.86180263e-04  9.79550728e-06  4.12334123e-03 -1.99947111e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.811988384612       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448537        1
[INPUT] 0    0    [1    /1   ]  833.270736278        1
[INPUT] 0    0    [1    /1   ]  235.738661913        1
[INPUT] 0    0    [1    /1   ]  76.4076956679        1
[INPUT] 0    0    [1    /1   ]  10.2565417638        1
[INPUT] 0    0    [1    /1   ]  27.0730075529        1
[INPUT] 0    0    [1    /1   ]  0.315066479576       1
[INPUT] 0    0    [1    /1   ]  1.85147481441        1
[INPUT] 0    0    [1    /1   ]  2.95658796926        1
[INPUT] 1    0    [1    /1   ]  3.6864248366         1
[INPUT] 1    0    [1    /1   ]  12.4409496787        1
[INPUT] 1    0    [1    /1   ]  54.7856014001        1
[INPUT] 1    0    [1    /1   ]  0.330728290684       1
[INPUT] 1    0    [1    /1   ]  1.14370781418        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8119883846118052, 1.0]], [0, [24413.794129697188, 1.0]], [0, [3661.454485367001, 1.0]], [0, [833.2707362776686, 1.0]], [0, [235.73866191253055, 1.0]], [0, [76.4076956678649, 1.0]], [0, [10.256541763751542, 1.0]], [0, [27.07300755294471, 1.0]], [0, [0.3150664795759498, 1.0]], [0, [1.851474814406681, 1.0]], [0, [2.956587969263258, 1.0]], [1, [3.686424836600125, 1.0]], [1, [12.440949678719518, 1.0]], [1, [54.78560140011541, 1.0]], [1, [0.33072829068426984, 1.0]], [1, [1.143707814181617, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81198838]
bas 1, expnt(s) = [24413.7941297]
bas 2, expnt(s) = [3661.45448537]
bas 3, expnt(s) = [833.27073628]
bas 4, expnt(s) = [235.73866191]
bas 5, expnt(s) = [76.40769567]
bas 6, expnt(s) = [10.25654176]
bas 7, expnt(s) = [27.07300755]
bas 8, expnt(s) = [0.31506648]
bas 9, expnt(s) = [1.85147481]
bas 10, expnt(s) = [2.95658797]
bas 11, expnt(s) = [3.68642484]
bas 12, expnt(s) = [12.44094968]
bas 13, expnt(s) = [54.7856014]
bas 14, expnt(s) = [0.33072829]
bas 15, expnt(s) = [1.14370781]
CPU time:        93.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.11988385e-01 2.16111256e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270736e+02 3.91836259e+02
 2.35738662e+02 1.51998091e+02 7.64076957e+01 6.52931845e+01
 1.02565418e+01 1.44799059e+01 2.70730076e+01 2.99859217e+01
 3.15066480e-01 1.06247000e+00 1.85147481e+00 4.01008318e+00
 2.95658797e+00 5.69650035e+00 3.68642484e+00 1.49018821e+01
 1.24409497e+01 6.81634101e+01 5.47856014e+01 4.34827932e+02
 3.30728291e-01 7.31684029e-01 1.14370781e+00 3.45046998e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998480180522892
cond(S) = 2576.957543291617
E1 = -183.577797143897  E_coul = 55.07850401426636
init E= -128.499293129631
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773941857526116  LUMO = 0.800199332698506
  mo_energy =
[-3.25553710e+01 -1.85289702e+00 -7.73941858e-01 -7.73941858e-01
 -7.73941858e-01  8.00199333e-01  1.11681120e+00  1.11681120e+00
  1.11681120e+00  4.10325090e+00  5.77955390e+00  5.77955390e+00
  5.77955390e+00  1.27003224e+01  2.42092143e+01  2.42092143e+01
  2.42092143e+01  4.16267396e+01  1.19092320e+02  1.19092320e+02
  1.19092320e+02  1.45744736e+02  5.09269589e+02  1.87626465e+03
  8.00526458e+03  4.77720744e+04]
E1 = -182.11347795486998  E_coul = 53.584563523585224
cycle= 1 E= -128.528914431285  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460225
diis-c [-0.21180665  1.        ]
  HOMO = -0.879394015888033  LUMO = 0.773647867752075
  mo_energy =
[-3.28735964e+01 -1.96291293e+00 -8.79394016e-01 -8.79394016e-01
 -8.79394016e-01  7.73647868e-01  1.07868193e+00  1.07868193e+00
  1.07868193e+00  4.03201627e+00  5.65087637e+00  5.65087637e+00
  5.65087637e+00  1.25603708e+01  2.39746308e+01  2.39746308e+01
  2.39746308e+01  4.13866673e+01  1.18771826e+02  1.18771826e+02
  1.18771826e+02  1.45433107e+02  5.08912990e+02  1.87587167e+03
  8.00484244e+03  4.77716334e+04]
E1 = -182.84449163457975  E_coul = 54.313076549772376
cycle= 2 E= -128.531415084807  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.22963
diis-c [-6.24041711e-04  3.31873705e-01  6.68126295e-01]
  HOMO = -0.845075409749695  LUMO = 0.78232149995249
  mo_energy =
[-3.27687001e+01 -1.92683282e+00 -8.45075410e-01 -8.45075410e-01
 -8.45075410e-01  7.82321500e-01  1.09116728e+00  1.09116728e+00
  1.09116728e+00  4.05503028e+00  5.69275869e+00  5.69275869e+00
  5.69275869e+00  1.26060429e+01  2.40520835e+01  2.40520835e+01
  2.40520835e+01  4.14661355e+01  1.18876749e+02  1.18876749e+02
  1.18876749e+02  1.45535580e+02  5.09026378e+02  1.87599032e+03
  8.00496354e+03  4.77717554e+04]
E1 = -182.59948969639842  E_coul = 54.067230302256306
cycle= 3 E= -128.532259394142  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000967935
diis-c [-1.72639160e-07 -2.21093835e-03 -6.22926038e-04  1.00283386e+00]
  HOMO = -0.845310735620907  LUMO = 0.782288600871084
  mo_energy =
[-3.27691229e+01 -1.92700110e+00 -8.45310736e-01 -8.45310736e-01
 -8.45310736e-01  7.82288601e-01  1.09111673e+00  1.09111673e+00
  1.09111673e+00  4.05491440e+00  5.69255385e+00  5.69255385e+00
  5.69255385e+00  1.26058232e+01  2.40517528e+01  2.40517528e+01
  2.40517528e+01  4.14658061e+01  1.18876315e+02  1.18876315e+02
  1.18876315e+02  1.45535159e+02  5.09025850e+02  1.87598968e+03
  8.00496281e+03  4.77717546e+04]
E1 = -182.60002358363397  E_coul = 54.06776416761457
cycle= 4 E= -128.532259416019  delta_E= -2.19e-08  |g|= 6.37e-05  |ddm|= 0.000351
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133388
diis-c [-1.00241238e-09  3.37150134e-04  4.03473473e-04 -2.20361744e-01
  1.21962112e+00]
  HOMO = -0.845342395055807  LUMO = 0.782282573910831
  mo_energy =
[-3.27691744e+01 -1.92701943e+00 -8.45342395e-01 -8.45342395e-01
 -8.45342395e-01  7.82282574e-01  1.09110342e+00  1.09110342e+00
  1.09110342e+00  4.05489529e+00  5.69251902e+00  5.69251902e+00
  5.69251902e+00  1.26057892e+01  2.40517065e+01  2.40517065e+01
  2.40517065e+01  4.14657606e+01  1.18876262e+02  1.18876262e+02
  1.18876262e+02  1.45535107e+02  5.09025790e+02  1.87598961e+03
  8.00496274e+03  4.77717545e+04]
E1 = -182.6001249015039  E_coul = 54.06786548491464
cycle= 5 E= -128.532259416589  delta_E= -5.7e-10  |g|= 6.82e-06  |ddm|= 6.2e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6001249015039  E_coul = 54.06786548491464
  HOMO = -0.845338613246702  LUMO = 0.782284010615351
  mo_energy =
[-3.27691662e+01 -1.92701496e+00 -8.45338613e-01 -8.45338613e-01
 -8.45338613e-01  7.82284011e-01  1.09110501e+00  1.09110501e+00
  1.09110501e+00  4.05489844e+00  5.69252360e+00  5.69252360e+00
  5.69252360e+00  1.26057943e+01  2.40517135e+01  2.40517135e+01
  2.40517135e+01  4.14657678e+01  1.18876271e+02  1.18876271e+02
  1.18876271e+02  1.45535115e+02  5.09025798e+02  1.87598962e+03
  8.00496274e+03  4.77717545e+04]
E1 = -182.60010674003288  E_coul = 54.06784732344075
Extra cycle  E= -128.532259416592  delta_E= -2.87e-12  |g|= 2.54e-06  |ddm|= 2.65e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.11988385e-01 2.44137941e+04 3.66145449e+03 8.33270736e+02
 2.35738662e+02 7.64076957e+01 1.02565418e+01 2.70730076e+01
 3.15066480e-01 1.85147481e+00 2.95658797e+00 3.68642484e+00
 1.24409497e+01 5.47856014e+01 3.30728291e-01 1.14370781e+00]
E = -128.53225941659213
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.811988384612       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448537        1
[INPUT] 0    0    [1    /1   ]  833.270736278        1
[INPUT] 0    0    [1    /1   ]  235.738661913        1
[INPUT] 0    0    [1    /1   ]  76.4076956679        1
[INPUT] 0    0    [1    /1   ]  10.2565417638        1
[INPUT] 0    0    [1    /1   ]  27.0730075529        1
[INPUT] 0    0    [1    /1   ]  0.315066479576       1
[INPUT] 0    0    [1    /1   ]  1.85147481441        1
[INPUT] 0    0    [1    /1   ]  2.95658796926        1
[INPUT] 1    0    [1    /1   ]  3.6864248366         1
[INPUT] 1    0    [1    /1   ]  12.4409496787        1
[INPUT] 1    0    [1    /1   ]  54.7856014001        1
[INPUT] 1    0    [1    /1   ]  0.330728290684       1
[INPUT] 1    0    [1    /1   ]  1.14370781418        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8119883846118052, 1.0]], [0, [24413.794129697188, 1.0]], [0, [3661.454485367001, 1.0]], [0, [833.2707362776686, 1.0]], [0, [235.73866191253055, 1.0]], [0, [76.4076956678649, 1.0]], [0, [10.256541763751542, 1.0]], [0, [27.07300755294471, 1.0]], [0, [0.3150664795759498, 1.0]], [0, [1.851474814406681, 1.0]], [0, [2.956587969263258, 1.0]], [1, [3.686424836600125, 1.0]], [1, [12.440949678719518, 1.0]], [1, [54.78560140011541, 1.0]], [1, [0.33072829068426984, 1.0]], [1, [1.143707814181617, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81198838]
bas 1, expnt(s) = [24413.7941297]
bas 2, expnt(s) = [3661.45448537]
bas 3, expnt(s) = [833.27073628]
bas 4, expnt(s) = [235.73866191]
bas 5, expnt(s) = [76.40769567]
bas 6, expnt(s) = [10.25654176]
bas 7, expnt(s) = [27.07300755]
bas 8, expnt(s) = [0.31506648]
bas 9, expnt(s) = [1.85147481]
bas 10, expnt(s) = [2.95658797]
bas 11, expnt(s) = [3.68642484]
bas 12, expnt(s) = [12.44094968]
bas 13, expnt(s) = [54.7856014]
bas 14, expnt(s) = [0.33072829]
bas 15, expnt(s) = [1.14370781]
CPU time:        93.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.11988385e-01 2.16111256e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270736e+02 3.91836259e+02
 2.35738662e+02 1.51998091e+02 7.64076957e+01 6.52931845e+01
 1.02565418e+01 1.44799059e+01 2.70730076e+01 2.99859217e+01
 3.15066480e-01 1.06247000e+00 1.85147481e+00 4.01008318e+00
 2.95658797e+00 5.69650035e+00 3.68642484e+00 1.49018821e+01
 1.24409497e+01 6.81634101e+01 5.47856014e+01 4.34827932e+02
 3.30728291e-01 7.31684029e-01 1.14370781e+00 3.45046998e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998480180522892
cond(S) = 2576.957543291617
E1 = -183.577797143897  E_coul = 55.07850401426636
init E= -128.499293129631
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773941857526116  LUMO = 0.800199332698506
  mo_energy =
[-3.25553710e+01 -1.85289702e+00 -7.73941858e-01 -7.73941858e-01
 -7.73941858e-01  8.00199333e-01  1.11681120e+00  1.11681120e+00
  1.11681120e+00  4.10325090e+00  5.77955390e+00  5.77955390e+00
  5.77955390e+00  1.27003224e+01  2.42092143e+01  2.42092143e+01
  2.42092143e+01  4.16267396e+01  1.19092320e+02  1.19092320e+02
  1.19092320e+02  1.45744736e+02  5.09269589e+02  1.87626465e+03
  8.00526458e+03  4.77720744e+04]
E1 = -182.11347795486998  E_coul = 53.584563523585224
cycle= 1 E= -128.528914431285  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460225
diis-c [-0.21180665  1.        ]
  HOMO = -0.879394015888033  LUMO = 0.773647867752075
  mo_energy =
[-3.28735964e+01 -1.96291293e+00 -8.79394016e-01 -8.79394016e-01
 -8.79394016e-01  7.73647868e-01  1.07868193e+00  1.07868193e+00
  1.07868193e+00  4.03201627e+00  5.65087637e+00  5.65087637e+00
  5.65087637e+00  1.25603708e+01  2.39746308e+01  2.39746308e+01
  2.39746308e+01  4.13866673e+01  1.18771826e+02  1.18771826e+02
  1.18771826e+02  1.45433107e+02  5.08912990e+02  1.87587167e+03
  8.00484244e+03  4.77716334e+04]
E1 = -182.84449163457975  E_coul = 54.313076549772376
cycle= 2 E= -128.531415084807  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.22963
diis-c [-6.24041711e-04  3.31873705e-01  6.68126295e-01]
  HOMO = -0.845075409749695  LUMO = 0.78232149995249
  mo_energy =
[-3.27687001e+01 -1.92683282e+00 -8.45075410e-01 -8.45075410e-01
 -8.45075410e-01  7.82321500e-01  1.09116728e+00  1.09116728e+00
  1.09116728e+00  4.05503028e+00  5.69275869e+00  5.69275869e+00
  5.69275869e+00  1.26060429e+01  2.40520835e+01  2.40520835e+01
  2.40520835e+01  4.14661355e+01  1.18876749e+02  1.18876749e+02
  1.18876749e+02  1.45535580e+02  5.09026378e+02  1.87599032e+03
  8.00496354e+03  4.77717554e+04]
E1 = -182.59948969639842  E_coul = 54.067230302256306
cycle= 3 E= -128.532259394142  delta_E= -0.000844  |g|= 0.000474  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000967935
diis-c [-1.72639160e-07 -2.21093835e-03 -6.22926038e-04  1.00283386e+00]
  HOMO = -0.845310735620907  LUMO = 0.782288600871084
  mo_energy =
[-3.27691229e+01 -1.92700110e+00 -8.45310736e-01 -8.45310736e-01
 -8.45310736e-01  7.82288601e-01  1.09111673e+00  1.09111673e+00
  1.09111673e+00  4.05491440e+00  5.69255385e+00  5.69255385e+00
  5.69255385e+00  1.26058232e+01  2.40517528e+01  2.40517528e+01
  2.40517528e+01  4.14658061e+01  1.18876315e+02  1.18876315e+02
  1.18876315e+02  1.45535159e+02  5.09025850e+02  1.87598968e+03
  8.00496281e+03  4.77717546e+04]
E1 = -182.60002358363397  E_coul = 54.06776416761457
cycle= 4 E= -128.532259416019  delta_E= -2.19e-08  |g|= 6.37e-05  |ddm|= 0.000351
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133388
diis-c [-1.00241238e-09  3.37150134e-04  4.03473473e-04 -2.20361744e-01
  1.21962112e+00]
  HOMO = -0.845342395055807  LUMO = 0.782282573910831
  mo_energy =
[-3.27691744e+01 -1.92701943e+00 -8.45342395e-01 -8.45342395e-01
 -8.45342395e-01  7.82282574e-01  1.09110342e+00  1.09110342e+00
  1.09110342e+00  4.05489529e+00  5.69251902e+00  5.69251902e+00
  5.69251902e+00  1.26057892e+01  2.40517065e+01  2.40517065e+01
  2.40517065e+01  4.14657606e+01  1.18876262e+02  1.18876262e+02
  1.18876262e+02  1.45535107e+02  5.09025790e+02  1.87598961e+03
  8.00496274e+03  4.77717545e+04]
E1 = -182.6001249015039  E_coul = 54.06786548491464
cycle= 5 E= -128.532259416589  delta_E= -5.7e-10  |g|= 6.82e-06  |ddm|= 6.2e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6001249015039  E_coul = 54.06786548491464
  HOMO = -0.845338613246702  LUMO = 0.782284010615351
  mo_energy =
[-3.27691662e+01 -1.92701496e+00 -8.45338613e-01 -8.45338613e-01
 -8.45338613e-01  7.82284011e-01  1.09110501e+00  1.09110501e+00
  1.09110501e+00  4.05489844e+00  5.69252360e+00  5.69252360e+00
  5.69252360e+00  1.26057943e+01  2.40517135e+01  2.40517135e+01
  2.40517135e+01  4.14657678e+01  1.18876271e+02  1.18876271e+02
  1.18876271e+02  1.45535115e+02  5.09025798e+02  1.87598962e+03
  8.00496274e+03  4.77717545e+04]
E1 = -182.60010674003288  E_coul = 54.06784732344075
Extra cycle  E= -128.532259416592  delta_E= -2.87e-12  |g|= 2.54e-06  |ddm|= 2.65e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2576.957543291617
E1 = -182.60010674003288  E_coul = 54.06784732344075
init E= -128.532259416592
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845339880936261  LUMO = 0.782283754555181
  mo_energy =
[-3.27691702e+01 -1.92701619e+00 -8.45339881e-01 -8.45339881e-01
 -8.45339881e-01  7.82283755e-01  1.09110456e+00  1.09110456e+00
  1.09110456e+00  4.05489768e+00  5.69252206e+00  5.69252206e+00
  5.69252206e+00  1.26057927e+01  2.40517106e+01  2.40517106e+01
  2.40517106e+01  4.14657648e+01  1.18876266e+02  1.18876266e+02
  1.18876266e+02  1.45535111e+02  5.09025793e+02  1.87598962e+03
  8.00496274e+03  4.77717545e+04]
E1 = -182.6001165145435  E_coul = 54.06785709795098
cycle= 1 E= -128.532259416593  delta_E= -3.98e-13  |g|= 1.34e-06  |ddm|= 9.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6001165145435  E_coul = 54.06785709795098
  HOMO = -0.845339193281711  LUMO = 0.78228393921432
  mo_energy =
[-3.27691681e+01 -1.92701544e+00 -8.45339193e-01 -8.45339193e-01
 -8.45339193e-01  7.82283939e-01  1.09110482e+00  1.09110482e+00
  1.09110482e+00  4.05489815e+00  5.69252290e+00  5.69252290e+00
  5.69252290e+00  1.26057936e+01  2.40517121e+01  2.40517121e+01
  2.40517121e+01  4.14657664e+01  1.18876269e+02  1.18876269e+02
  1.18876269e+02  1.45535113e+02  5.09025796e+02  1.87598962e+03
  8.00496274e+03  4.77717545e+04]
E1 = -182.6001116609013  E_coul = 54.067852244308575
Extra cycle  E= -128.532259416593  delta_E= -1.99e-13  |g|= 6.61e-07  |ddm|= 4.55e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [8.11988385e-01 2.44137941e+04 3.66145449e+03 8.33270736e+02
 2.35738662e+02 7.64076957e+01 1.02565418e+01 2.70730076e+01
 3.15066480e-01 1.85147481e+00 2.95658797e+00 3.68642484e+00
 1.24409497e+01 5.47856014e+01 3.30728291e-01 1.14370781e+00]
grad_E = [-1.14823927e-05  4.58077298e-10 -2.40722489e-08  4.98285264e-07
 -6.18570003e-06  4.67713234e-05 -1.27866819e-04 -1.34310400e-04
  8.62368898e-05  2.84645459e-05 -9.65444941e-05  8.92439709e-04
 -1.46637683e-04  7.49634990e-06  5.24113073e-03 -2.74833047e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823208612647       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448689        1
[INPUT] 0    0    [1    /1   ]  833.270704074        1
[INPUT] 0    0    [1    /1   ]  235.739066882        1
[INPUT] 0    0    [1    /1   ]  76.4049618792        1
[INPUT] 0    0    [1    /1   ]  10.2910154042        1
[INPUT] 0    0    [1    /1   ]  27.0750259335        1
[INPUT] 0    0    [1    /1   ]  0.31732937349        1
[INPUT] 0    0    [1    /1   ]  1.90115602427        1
[INPUT] 0    0    [1    /1   ]  2.9653942559         1
[INPUT] 1    0    [1    /1   ]  3.68176875718        1
[INPUT] 1    0    [1    /1   ]  12.4422797024        1
[INPUT] 1    0    [1    /1   ]  54.785447359         1
[INPUT] 1    0    [1    /1   ]  0.330159411142       1
[INPUT] 1    0    [1    /1   ]  1.14183057831        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8232086126468724, 1.0]], [0, [24413.79412966816, 1.0]], [0, [3661.4544868910716, 1.0]], [0, [833.270704073871, 1.0]], [0, [235.7390668821864, 1.0]], [0, [76.40496187916439, 1.0]], [0, [10.291015404249377, 1.0]], [0, [27.075025933473317, 1.0]], [0, [0.31732937348959095, 1.0]], [0, [1.9011560242723406, 1.0]], [0, [2.9653942558975914, 1.0]], [1, [3.6817687571793223, 1.0]], [1, [12.442279702409946, 1.0]], [1, [54.78544735899058, 1.0]], [1, [0.3301594111415108, 1.0]], [1, [1.1418305783098521, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82320861]
bas 1, expnt(s) = [24413.79412967]
bas 2, expnt(s) = [3661.45448689]
bas 3, expnt(s) = [833.27070407]
bas 4, expnt(s) = [235.73906688]
bas 5, expnt(s) = [76.40496188]
bas 6, expnt(s) = [10.2910154]
bas 7, expnt(s) = [27.07502593]
bas 8, expnt(s) = [0.31732937]
bas 9, expnt(s) = [1.90115602]
bas 10, expnt(s) = [2.96539426]
bas 11, expnt(s) = [3.68176876]
bas 12, expnt(s) = [12.4422797]
bas 13, expnt(s) = [54.78544736]
bas 14, expnt(s) = [0.33015941]
bas 15, expnt(s) = [1.14183058]
CPU time:        96.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23208613e-01 2.18347113e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270704e+02 3.91836248e+02
 2.35739067e+02 1.51998287e+02 7.64049619e+01 6.52914324e+01
 1.02910154e+01 1.45163923e+01 2.70750259e+01 2.99875983e+01
 3.17329373e-01 1.06818809e+00 1.90115602e+00 4.09051834e+00
 2.96539426e+00 5.70922102e+00 3.68176876e+00 1.48783588e+01
 1.24422797e+01 6.81725192e+01 5.47854474e+01 4.34826404e+02
 3.30159411e-01 7.30111172e-01 1.14183058e+00 3.44339210e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99849249768155
cond(S) = 2805.4022417967817
E1 = -183.57773872106048  E_coul = 55.078494756726
init E= -128.499243964334
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944770877722  LUMO = 0.811943691103991
  mo_energy =
[-3.25553707e+01 -1.85289831e+00 -7.73944771e-01 -7.73944771e-01
 -7.73944771e-01  8.11943691e-01  1.11451549e+00  1.11451549e+00
  1.11451549e+00  4.17408188e+00  5.76916589e+00  5.76916589e+00
  5.76916589e+00  1.28989027e+01  2.41889883e+01  2.41889883e+01
  2.41889883e+01  4.19771079e+01  1.19076270e+02  1.19076270e+02
  1.19076270e+02  1.46156346e+02  5.09663336e+02  1.87662059e+03
  8.00557836e+03  4.77723342e+04]
E1 = -182.112313916746  E_coul = 53.583399477774
cycle= 1 E= -128.528914438972  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460435
diis-c [-0.21200052  1.        ]
  HOMO = -0.879486242036028  LUMO = 0.784895089472927
  mo_energy =
[-3.28737983e+01 -1.96301996e+00 -8.79486242e-01 -8.79486242e-01
 -8.79486242e-01  7.84895089e-01  1.07642719e+00  1.07642719e+00
  1.07642719e+00  4.10175548e+00  5.64049637e+00  5.64049637e+00
  5.64049637e+00  1.27579253e+01  2.39542428e+01  2.39542428e+01
  2.39542428e+01  4.17367253e+01  1.18755568e+02  1.18755568e+02
  1.18755568e+02  1.45844562e+02  5.09306557e+02  1.87622742e+03
  8.00515603e+03  4.77718931e+04]
E1 = -182.84395518368407  E_coul = 54.31253722851369
cycle= 2 E= -128.53141795517  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229801
diis-c [-6.26327517e-04  3.31935622e-01  6.68064378e-01]
  HOMO = -0.845140259369971  LUMO = 0.793721810558319
  mo_energy =
[-3.27688268e+01 -1.92691023e+00 -8.45140259e-01 -8.45140259e-01
 -8.45140259e-01  7.93721811e-01  1.08889582e+00  1.08889582e+00
  1.08889582e+00  4.12511829e+00  5.68237303e+00  5.68237303e+00
  5.68237303e+00  1.28039350e+01  2.40317537e+01  2.40317537e+01
  2.40317537e+01  4.18163015e+01  1.18860569e+02  1.18860569e+02
  1.18860569e+02  1.45947095e+02  5.09420020e+02  1.87634616e+03
  8.00527721e+03  4.77720151e+04]
E1 = -182.59869295151054  E_coul = 54.06642913280525
cycle= 3 E= -128.532263818705  delta_E= -0.000846  |g|= 0.000474  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000965298
diis-c [-1.68111216e-07 -2.20738135e-03 -6.18772912e-04  1.00282615e+00]
  HOMO = -0.845376311615401  LUMO = 0.793687571790663
  mo_energy =
[-3.27692501e+01 -1.92708000e+00 -8.45376312e-01 -8.45376312e-01
 -8.45376312e-01  7.93687572e-01  1.08884505e+00  1.08884505e+00
  1.08884505e+00  4.12499971e+00  5.68216752e+00  5.68216752e+00
  5.68216752e+00  1.28037129e+01  2.40314223e+01  2.40314223e+01
  2.40314223e+01  4.18159712e+01  1.18860134e+02  1.18860134e+02
  1.18860134e+02  1.45946674e+02  5.09419492e+02  1.87634551e+03
  8.00527648e+03  4.77720144e+04]
E1 = -182.59922504179556  E_coul = 54.06696120137621
cycle= 4 E= -128.532263840419  delta_E= -2.17e-08  |g|= 6.35e-05  |ddm|= 0.000356
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132791
diis-c [-9.99347918e-10  3.34136064e-04  4.04053885e-04 -2.18858601e-01
  1.21812041e+00]
  HOMO = -0.845408050589258  LUMO = 0.793681308595528
  mo_energy =
[-3.27693017e+01 -1.92709865e+00 -8.45408051e-01 -8.45408051e-01
 -8.45408051e-01  7.93681309e-01  1.08883172e+00  1.08883172e+00
  1.08883172e+00  4.12498016e+00  5.68213257e+00  5.68213257e+00
  5.68213257e+00  1.28036785e+01  2.40313758e+01  2.40313758e+01
  2.40313758e+01  4.18159254e+01  1.18860081e+02  1.18860081e+02
  1.18860081e+02  1.45946622e+02  5.09419432e+02  1.87634545e+03
  8.00527641e+03  4.77720143e+04]
E1 = -182.5993265341588  E_coul = 54.06706269317999
cycle= 5 E= -128.532263840979  delta_E= -5.59e-10  |g|= 6.8e-06  |ddm|= 6.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5993265341588  E_coul = 54.06706269317999
  HOMO = -0.845404286262952  LUMO = 0.793682764731885
  mo_energy =
[-3.27692935e+01 -1.92709420e+00 -8.45404286e-01 -8.45404286e-01
 -8.45404286e-01  7.93682765e-01  1.08883330e+00  1.08883330e+00
  1.08883330e+00  4.12498334e+00  5.68213714e+00  5.68213714e+00
  5.68213714e+00  1.28036837e+01  2.40313828e+01  2.40313828e+01
  2.40313828e+01  4.18159326e+01  1.18860090e+02  1.18860090e+02
  1.18860090e+02  1.45946630e+02  5.09419440e+02  1.87634545e+03
  8.00527642e+03  4.77720143e+04]
E1 = -182.59930847301956  E_coul = 54.067044632037614
Extra cycle  E= -128.532263840982  delta_E= -3.15e-12  |g|= 2.52e-06  |ddm|= 2.67e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.23208613e-01 2.44137941e+04 3.66145449e+03 8.33270704e+02
 2.35739067e+02 7.64049619e+01 1.02910154e+01 2.70750259e+01
 3.17329373e-01 1.90115602e+00 2.96539426e+00 3.68176876e+00
 1.24422797e+01 5.47854474e+01 3.30159411e-01 1.14183058e+00]
E = -128.53226384098195
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823208612647       1
[INPUT] 0    0    [1    /1   ]  24413.7941297        1
[INPUT] 0    0    [1    /1   ]  3661.45448689        1
[INPUT] 0    0    [1    /1   ]  833.270704074        1
[INPUT] 0    0    [1    /1   ]  235.739066882        1
[INPUT] 0    0    [1    /1   ]  76.4049618792        1
[INPUT] 0    0    [1    /1   ]  10.2910154042        1
[INPUT] 0    0    [1    /1   ]  27.0750259335        1
[INPUT] 0    0    [1    /1   ]  0.31732937349        1
[INPUT] 0    0    [1    /1   ]  1.90115602427        1
[INPUT] 0    0    [1    /1   ]  2.9653942559         1
[INPUT] 1    0    [1    /1   ]  3.68176875718        1
[INPUT] 1    0    [1    /1   ]  12.4422797024        1
[INPUT] 1    0    [1    /1   ]  54.785447359         1
[INPUT] 1    0    [1    /1   ]  0.330159411142       1
[INPUT] 1    0    [1    /1   ]  1.14183057831        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8232086126468724, 1.0]], [0, [24413.79412966816, 1.0]], [0, [3661.4544868910716, 1.0]], [0, [833.270704073871, 1.0]], [0, [235.7390668821864, 1.0]], [0, [76.40496187916439, 1.0]], [0, [10.291015404249377, 1.0]], [0, [27.075025933473317, 1.0]], [0, [0.31732937348959095, 1.0]], [0, [1.9011560242723406, 1.0]], [0, [2.9653942558975914, 1.0]], [1, [3.6817687571793223, 1.0]], [1, [12.442279702409946, 1.0]], [1, [54.78544735899058, 1.0]], [1, [0.3301594111415108, 1.0]], [1, [1.1418305783098521, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82320861]
bas 1, expnt(s) = [24413.79412967]
bas 2, expnt(s) = [3661.45448689]
bas 3, expnt(s) = [833.27070407]
bas 4, expnt(s) = [235.73906688]
bas 5, expnt(s) = [76.40496188]
bas 6, expnt(s) = [10.2910154]
bas 7, expnt(s) = [27.07502593]
bas 8, expnt(s) = [0.31732937]
bas 9, expnt(s) = [1.90115602]
bas 10, expnt(s) = [2.96539426]
bas 11, expnt(s) = [3.68176876]
bas 12, expnt(s) = [12.4422797]
bas 13, expnt(s) = [54.78544736]
bas 14, expnt(s) = [0.33015941]
bas 15, expnt(s) = [1.14183058]
CPU time:        97.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23208613e-01 2.18347113e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270704e+02 3.91836248e+02
 2.35739067e+02 1.51998287e+02 7.64049619e+01 6.52914324e+01
 1.02910154e+01 1.45163923e+01 2.70750259e+01 2.99875983e+01
 3.17329373e-01 1.06818809e+00 1.90115602e+00 4.09051834e+00
 2.96539426e+00 5.70922102e+00 3.68176876e+00 1.48783588e+01
 1.24422797e+01 6.81725192e+01 5.47854474e+01 4.34826404e+02
 3.30159411e-01 7.30111172e-01 1.14183058e+00 3.44339210e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99849249768155
cond(S) = 2805.4022417967817
E1 = -183.57773872106048  E_coul = 55.078494756726
init E= -128.499243964334
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944770877722  LUMO = 0.811943691103991
  mo_energy =
[-3.25553707e+01 -1.85289831e+00 -7.73944771e-01 -7.73944771e-01
 -7.73944771e-01  8.11943691e-01  1.11451549e+00  1.11451549e+00
  1.11451549e+00  4.17408188e+00  5.76916589e+00  5.76916589e+00
  5.76916589e+00  1.28989027e+01  2.41889883e+01  2.41889883e+01
  2.41889883e+01  4.19771079e+01  1.19076270e+02  1.19076270e+02
  1.19076270e+02  1.46156346e+02  5.09663336e+02  1.87662059e+03
  8.00557836e+03  4.77723342e+04]
E1 = -182.112313916746  E_coul = 53.583399477774
cycle= 1 E= -128.528914438972  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460435
diis-c [-0.21200052  1.        ]
  HOMO = -0.879486242036028  LUMO = 0.784895089472927
  mo_energy =
[-3.28737983e+01 -1.96301996e+00 -8.79486242e-01 -8.79486242e-01
 -8.79486242e-01  7.84895089e-01  1.07642719e+00  1.07642719e+00
  1.07642719e+00  4.10175548e+00  5.64049637e+00  5.64049637e+00
  5.64049637e+00  1.27579253e+01  2.39542428e+01  2.39542428e+01
  2.39542428e+01  4.17367253e+01  1.18755568e+02  1.18755568e+02
  1.18755568e+02  1.45844562e+02  5.09306557e+02  1.87622742e+03
  8.00515603e+03  4.77718931e+04]
E1 = -182.84395518368407  E_coul = 54.31253722851369
cycle= 2 E= -128.53141795517  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229801
diis-c [-6.26327517e-04  3.31935622e-01  6.68064378e-01]
  HOMO = -0.845140259369971  LUMO = 0.793721810558319
  mo_energy =
[-3.27688268e+01 -1.92691023e+00 -8.45140259e-01 -8.45140259e-01
 -8.45140259e-01  7.93721811e-01  1.08889582e+00  1.08889582e+00
  1.08889582e+00  4.12511829e+00  5.68237303e+00  5.68237303e+00
  5.68237303e+00  1.28039350e+01  2.40317537e+01  2.40317537e+01
  2.40317537e+01  4.18163015e+01  1.18860569e+02  1.18860569e+02
  1.18860569e+02  1.45947095e+02  5.09420020e+02  1.87634616e+03
  8.00527721e+03  4.77720151e+04]
E1 = -182.59869295151054  E_coul = 54.06642913280525
cycle= 3 E= -128.532263818705  delta_E= -0.000846  |g|= 0.000474  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000965298
diis-c [-1.68111216e-07 -2.20738135e-03 -6.18772912e-04  1.00282615e+00]
  HOMO = -0.845376311615401  LUMO = 0.793687571790663
  mo_energy =
[-3.27692501e+01 -1.92708000e+00 -8.45376312e-01 -8.45376312e-01
 -8.45376312e-01  7.93687572e-01  1.08884505e+00  1.08884505e+00
  1.08884505e+00  4.12499971e+00  5.68216752e+00  5.68216752e+00
  5.68216752e+00  1.28037129e+01  2.40314223e+01  2.40314223e+01
  2.40314223e+01  4.18159712e+01  1.18860134e+02  1.18860134e+02
  1.18860134e+02  1.45946674e+02  5.09419492e+02  1.87634551e+03
  8.00527648e+03  4.77720144e+04]
E1 = -182.59922504179556  E_coul = 54.06696120137621
cycle= 4 E= -128.532263840419  delta_E= -2.17e-08  |g|= 6.35e-05  |ddm|= 0.000356
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132791
diis-c [-9.99347918e-10  3.34136064e-04  4.04053885e-04 -2.18858601e-01
  1.21812041e+00]
  HOMO = -0.845408050589258  LUMO = 0.793681308595528
  mo_energy =
[-3.27693017e+01 -1.92709865e+00 -8.45408051e-01 -8.45408051e-01
 -8.45408051e-01  7.93681309e-01  1.08883172e+00  1.08883172e+00
  1.08883172e+00  4.12498016e+00  5.68213257e+00  5.68213257e+00
  5.68213257e+00  1.28036785e+01  2.40313758e+01  2.40313758e+01
  2.40313758e+01  4.18159254e+01  1.18860081e+02  1.18860081e+02
  1.18860081e+02  1.45946622e+02  5.09419432e+02  1.87634545e+03
  8.00527641e+03  4.77720143e+04]
E1 = -182.5993265341588  E_coul = 54.06706269317999
cycle= 5 E= -128.532263840979  delta_E= -5.59e-10  |g|= 6.8e-06  |ddm|= 6.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5993265341588  E_coul = 54.06706269317999
  HOMO = -0.845404286262952  LUMO = 0.793682764731885
  mo_energy =
[-3.27692935e+01 -1.92709420e+00 -8.45404286e-01 -8.45404286e-01
 -8.45404286e-01  7.93682765e-01  1.08883330e+00  1.08883330e+00
  1.08883330e+00  4.12498334e+00  5.68213714e+00  5.68213714e+00
  5.68213714e+00  1.28036837e+01  2.40313828e+01  2.40313828e+01
  2.40313828e+01  4.18159326e+01  1.18860090e+02  1.18860090e+02
  1.18860090e+02  1.45946630e+02  5.09419440e+02  1.87634545e+03
  8.00527642e+03  4.77720143e+04]
E1 = -182.59930847301956  E_coul = 54.067044632037614
Extra cycle  E= -128.532263840982  delta_E= -3.15e-12  |g|= 2.52e-06  |ddm|= 2.67e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2805.4022417967817
E1 = -182.59930847301956  E_coul = 54.067044632037614
init E= -128.532263840982
    CPU time for initialize scf      0.25 sec, wall time      0.26 sec
  HOMO = -0.845405547217749  LUMO = 0.793682506215711
  mo_energy =
[-3.27692975e+01 -1.92709541e+00 -8.45405547e-01 -8.45405547e-01
 -8.45405547e-01  7.93682506e-01  1.08883286e+00  1.08883286e+00
  1.08883286e+00  4.12498256e+00  5.68213560e+00  5.68213560e+00
  5.68213560e+00  1.28036820e+01  2.40313799e+01  2.40313799e+01
  2.40313799e+01  4.18159296e+01  1.18860085e+02  1.18860085e+02
  1.18860085e+02  1.45946626e+02  5.09419436e+02  1.87634545e+03
  8.00527641e+03  4.77720143e+04]
E1 = -182.59931819980508  E_coul = 54.067054358822745
cycle= 1 E= -128.532263840982  delta_E= -3.98e-13  |g|= 1.33e-06  |ddm|= 9.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59931819980508  E_coul = 54.067054358822745
  HOMO = -0.845404862962021  LUMO = 0.793682693192418
  mo_energy =
[-3.27692955e+01 -1.92709467e+00 -8.45404863e-01 -8.45404863e-01
 -8.45404863e-01  7.93682693e-01  1.08883311e+00  1.08883311e+00
  1.08883311e+00  4.12498304e+00  5.68213644e+00  5.68213644e+00
  5.68213644e+00  1.28036829e+01  2.40313814e+01  2.40313814e+01
  2.40313814e+01  4.18159312e+01  1.18860088e+02  1.18860088e+02
  1.18860088e+02  1.45946628e+02  5.09419438e+02  1.87634545e+03
  8.00527642e+03  4.77720143e+04]
E1 = -182.59931336897515  E_coul = 54.06704952799298
Extra cycle  E= -128.532263840982  delta_E= 1.71e-13  |g|= 6.58e-07  |ddm|= 4.54e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.33 sec
exp = [8.23208613e-01 2.44137941e+04 3.66145449e+03 8.33270704e+02
 2.35739067e+02 7.64049619e+01 1.02910154e+01 2.70750259e+01
 3.17329373e-01 1.90115602e+00 2.96539426e+00 3.68176876e+00
 1.24422797e+01 5.47854474e+01 3.30159411e-01 1.14183058e+00]
grad_E = [-2.73391236e-06  5.92540631e-10 -3.11258431e-08  6.41227330e-07
 -7.90303539e-06  6.02870877e-05 -3.67152649e-05 -1.92026876e-04
  6.88027778e-05  1.86046346e-05 -1.02574460e-04  5.84507337e-04
 -6.84501006e-05  3.76606673e-06  4.19894056e-03 -2.32101623e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.830272787547       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448785        1
[INPUT] 0    0    [1    /1   ]  833.270683733        1
[INPUT] 0    0    [1    /1   ]  235.739322712        1
[INPUT] 0    0    [1    /1   ]  76.4032298575        1
[INPUT] 0    0    [1    /1   ]  10.3126322812        1
[INPUT] 0    0    [1    /1   ]  27.0763721145        1
[INPUT] 0    0    [1    /1   ]  0.31893231531        1
[INPUT] 0    0    [1    /1   ]  1.9313463333         1
[INPUT] 0    0    [1    /1   ]  2.97108433558        1
[INPUT] 1    0    [1    /1   ]  3.67977840012        1
[INPUT] 1    0    [1    /1   ]  12.4427513521        1
[INPUT] 1    0    [1    /1   ]  54.7853685642        1
[INPUT] 1    0    [1    /1   ]  0.329805118864       1
[INPUT] 1    0    [1    /1   ]  1.14166675554        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8302727875470136, 1.0]], [0, [24413.79412964982, 1.0]], [0, [3661.454487853834, 1.0]], [0, [833.270683733292, 1.0]], [0, [235.73932271177222, 1.0]], [0, [76.40322985745709, 1.0]], [0, [10.312632281234372, 1.0]], [0, [27.076372114513173, 1.0]], [0, [0.31893231530964095, 1.0]], [0, [1.9313463332976346, 1.0]], [0, [2.9710843355799907, 1.0]], [1, [3.6797784001222227, 1.0]], [1, [12.44275135208289, 1.0]], [1, [54.785368564243484, 1.0]], [1, [0.3298051188642452, 1.0]], [1, [1.141666755538865, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83027279]
bas 1, expnt(s) = [24413.79412965]
bas 2, expnt(s) = [3661.45448785]
bas 3, expnt(s) = [833.27068373]
bas 4, expnt(s) = [235.73932271]
bas 5, expnt(s) = [76.40322986]
bas 6, expnt(s) = [10.31263228]
bas 7, expnt(s) = [27.07637211]
bas 8, expnt(s) = [0.31893232]
bas 9, expnt(s) = [1.93134633]
bas 10, expnt(s) = [2.97108434]
bas 11, expnt(s) = [3.6797784]
bas 12, expnt(s) = [12.44275135]
bas 13, expnt(s) = [54.78536856]
bas 14, expnt(s) = [0.32980512]
bas 15, expnt(s) = [1.14166676]
CPU time:       100.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.30272788e-01 2.19750882e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270684e+02 3.91836241e+02
 2.35739323e+02 1.51998411e+02 7.64032299e+01 6.52903224e+01
 1.03126323e+01 1.45392557e+01 2.70763721e+01 2.99887166e+01
 3.18932315e-01 1.07223238e+00 1.93134633e+00 4.13914027e+00
 2.97108434e+00 5.71743530e+00 3.67977840e+00 1.48683055e+01
 1.24427514e+01 6.81757494e+01 5.47853686e+01 4.34825622e+02
 3.29805119e-01 7.29131956e-01 1.14166676e+00 3.44277457e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497352693716
cond(S) = 2962.8041964982644
E1 = -183.57768967213747  E_coul = 55.07849296696786
init E= -128.49919670517
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773946122793069  LUMO = 0.819643162807597
  mo_energy =
[-3.25553700e+01 -1.85289831e+00 -7.73946123e-01 -7.73946123e-01
 -7.73946123e-01  8.19643163e-01  1.11343657e+00  1.11343657e+00
  1.11343657e+00  4.21847713e+00  5.76605734e+00  5.76605734e+00
  5.76605734e+00  1.30216282e+01  2.41820986e+01  2.41820986e+01
  2.41820986e+01  4.21940660e+01  1.19070480e+02  1.19070480e+02
  1.19070480e+02  1.46412225e+02  5.09908476e+02  1.87684226e+03
  8.00577379e+03  4.77724961e+04]
E1 = -182.11101522526556  E_coul = 53.58210250122487
cycle= 1 E= -128.528912724041  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460613
diis-c [-0.21216448  1.        ]
  HOMO = -0.879593081176807  LUMO = 0.792245780703568
  mo_energy =
[-3.28740053e+01 -1.96314314e+00 -8.79593081e-01 -8.79593081e-01
 -8.79593081e-01  7.92245781e-01  1.07532202e+00  1.07532202e+00
  1.07532202e+00  4.14543614e+00  5.63729030e+00  5.63729030e+00
  5.63729030e+00  1.28799637e+01  2.39471855e+01  2.39471855e+01
  2.39471855e+01  4.19534210e+01  1.18749568e+02  1.18749568e+02
  1.18749568e+02  1.46100264e+02  5.09551504e+02  1.87644889e+03
  8.00535127e+03  4.77720547e+04]
E1 = -182.84318506103435  E_coul = 54.311766458426305
cycle= 2 E= -128.531418602608  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229947
diis-c [-6.27950733e-04  3.31989389e-01  6.68010611e-01]
  HOMO = -0.845224674086848  LUMO = 0.8011718612235
  mo_energy =
[-3.27689683e+01 -1.92700929e+00 -8.45224674e-01 -8.45224674e-01
 -8.45224674e-01  8.01171861e-01  1.08779045e+00  1.08779045e+00
  1.08779045e+00  4.16901499e+00  5.67918366e+00  5.67918366e+00
  5.67918366e+00  1.29261868e+01  2.40247450e+01  2.40247450e+01
  2.40247450e+01  4.20330790e+01  1.18854635e+02  1.18854635e+02
  1.18854635e+02  1.46202853e+02  5.09665034e+02  1.87656770e+03
  8.00547252e+03  4.77721769e+04]
E1 = -182.59766438032565  E_coul = 54.065398445793
cycle= 3 E= -128.532265934533  delta_E= -0.000847  |g|= 0.000479  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000969594
diis-c [-1.63181056e-07 -2.21239669e-03 -5.96925522e-04  1.00280932e+00]
  HOMO = -0.845463963597441  LUMO = 0.801135249540433
  mo_energy =
[-3.27693959e+01 -1.92718350e+00 -8.45463964e-01 -8.45463964e-01
 -8.45463964e-01  8.01135250e-01  1.08773816e+00  1.08773816e+00
  1.08773816e+00  4.16889202e+00  5.67897433e+00  5.67897433e+00
  5.67897433e+00  1.29259595e+01  2.40244092e+01  2.40244092e+01
  2.40244092e+01  4.20327440e+01  1.18854195e+02  1.18854195e+02
  1.18854195e+02  1.46202428e+02  5.09664502e+02  1.87656706e+03
  8.00547179e+03  4.77721761e+04]
E1 = -182.59820054621554  E_coul = 54.06593458990462
cycle= 4 E= -128.532265956311  delta_E= -2.18e-08  |g|= 6.35e-05  |ddm|= 0.000362
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132305
diis-c [-9.92954871e-10  3.29761268e-04  4.00453828e-04 -2.16193807e-01
  1.21546359e+00]
  HOMO = -0.845495960636313  LUMO = 0.801128659582921
  mo_energy =
[-3.27694479e+01 -1.92720275e+00 -8.45495961e-01 -8.45495961e-01
 -8.45495961e-01  8.01128660e-01  1.08772470e+00  1.08772470e+00
  1.08772470e+00  4.16887191e+00  5.67893904e+00  5.67893904e+00
  5.67893904e+00  1.29259245e+01  2.40243623e+01  2.40243623e+01
  2.40243623e+01  4.20326978e+01  1.18854143e+02  1.18854143e+02
  1.18854143e+02  1.46202376e+02  5.09664442e+02  1.87656699e+03
  8.00547172e+03  4.77721760e+04]
E1 = -182.5983023806444  E_coul = 54.06603642378471
cycle= 5 E= -128.53226595686  delta_E= -5.49e-10  |g|= 6.76e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983023806444  E_coul = 54.06603642378471
  HOMO = -0.845492226445073  LUMO = 0.801130127107351
  mo_energy =
[-3.27694398e+01 -1.92719831e+00 -8.45492226e-01 -8.45492226e-01
 -8.45492226e-01  8.01130127e-01  1.08772627e+00  1.08772627e+00
  1.08772627e+00  4.16887510e+00  5.67894357e+00  5.67894357e+00
  5.67894357e+00  1.29259296e+01  2.40243693e+01  2.40243693e+01
  2.40243693e+01  4.20327049e+01  1.18854151e+02  1.18854151e+02
  1.18854151e+02  1.46202384e+02  5.09664450e+02  1.87656700e+03
  8.00547172e+03  4.77721760e+04]
E1 = -182.5982845032962  E_coul = 54.06601854643397
Extra cycle  E= -128.532265956862  delta_E= -2.53e-12  |g|= 2.5e-06  |ddm|= 2.66e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.30272788e-01 2.44137941e+04 3.66145449e+03 8.33270684e+02
 2.35739323e+02 7.64032299e+01 1.03126323e+01 2.70763721e+01
 3.18932315e-01 1.93134633e+00 2.97108434e+00 3.67977840e+00
 1.24427514e+01 5.47853686e+01 3.29805119e-01 1.14166676e+00]
E = -128.53226595686223
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:58:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.830272787547       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448785        1
[INPUT] 0    0    [1    /1   ]  833.270683733        1
[INPUT] 0    0    [1    /1   ]  235.739322712        1
[INPUT] 0    0    [1    /1   ]  76.4032298575        1
[INPUT] 0    0    [1    /1   ]  10.3126322812        1
[INPUT] 0    0    [1    /1   ]  27.0763721145        1
[INPUT] 0    0    [1    /1   ]  0.31893231531        1
[INPUT] 0    0    [1    /1   ]  1.9313463333         1
[INPUT] 0    0    [1    /1   ]  2.97108433558        1
[INPUT] 1    0    [1    /1   ]  3.67977840012        1
[INPUT] 1    0    [1    /1   ]  12.4427513521        1
[INPUT] 1    0    [1    /1   ]  54.7853685642        1
[INPUT] 1    0    [1    /1   ]  0.329805118864       1
[INPUT] 1    0    [1    /1   ]  1.14166675554        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8302727875470136, 1.0]], [0, [24413.79412964982, 1.0]], [0, [3661.454487853834, 1.0]], [0, [833.270683733292, 1.0]], [0, [235.73932271177222, 1.0]], [0, [76.40322985745709, 1.0]], [0, [10.312632281234372, 1.0]], [0, [27.076372114513173, 1.0]], [0, [0.31893231530964095, 1.0]], [0, [1.9313463332976346, 1.0]], [0, [2.9710843355799907, 1.0]], [1, [3.6797784001222227, 1.0]], [1, [12.44275135208289, 1.0]], [1, [54.785368564243484, 1.0]], [1, [0.3298051188642452, 1.0]], [1, [1.141666755538865, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83027279]
bas 1, expnt(s) = [24413.79412965]
bas 2, expnt(s) = [3661.45448785]
bas 3, expnt(s) = [833.27068373]
bas 4, expnt(s) = [235.73932271]
bas 5, expnt(s) = [76.40322986]
bas 6, expnt(s) = [10.31263228]
bas 7, expnt(s) = [27.07637211]
bas 8, expnt(s) = [0.31893232]
bas 9, expnt(s) = [1.93134633]
bas 10, expnt(s) = [2.97108434]
bas 11, expnt(s) = [3.6797784]
bas 12, expnt(s) = [12.44275135]
bas 13, expnt(s) = [54.78536856]
bas 14, expnt(s) = [0.32980512]
bas 15, expnt(s) = [1.14166676]
CPU time:       100.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.30272788e-01 2.19750882e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270684e+02 3.91836241e+02
 2.35739323e+02 1.51998411e+02 7.64032299e+01 6.52903224e+01
 1.03126323e+01 1.45392557e+01 2.70763721e+01 2.99887166e+01
 3.18932315e-01 1.07223238e+00 1.93134633e+00 4.13914027e+00
 2.97108434e+00 5.71743530e+00 3.67977840e+00 1.48683055e+01
 1.24427514e+01 6.81757494e+01 5.47853686e+01 4.34825622e+02
 3.29805119e-01 7.29131956e-01 1.14166676e+00 3.44277457e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497352693716
cond(S) = 2962.8041964982644
E1 = -183.57768967213747  E_coul = 55.07849296696786
init E= -128.49919670517
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773946122793069  LUMO = 0.819643162807597
  mo_energy =
[-3.25553700e+01 -1.85289831e+00 -7.73946123e-01 -7.73946123e-01
 -7.73946123e-01  8.19643163e-01  1.11343657e+00  1.11343657e+00
  1.11343657e+00  4.21847713e+00  5.76605734e+00  5.76605734e+00
  5.76605734e+00  1.30216282e+01  2.41820986e+01  2.41820986e+01
  2.41820986e+01  4.21940660e+01  1.19070480e+02  1.19070480e+02
  1.19070480e+02  1.46412225e+02  5.09908476e+02  1.87684226e+03
  8.00577379e+03  4.77724961e+04]
E1 = -182.11101522526556  E_coul = 53.58210250122487
cycle= 1 E= -128.528912724041  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460613
diis-c [-0.21216448  1.        ]
  HOMO = -0.879593081176807  LUMO = 0.792245780703568
  mo_energy =
[-3.28740053e+01 -1.96314314e+00 -8.79593081e-01 -8.79593081e-01
 -8.79593081e-01  7.92245781e-01  1.07532202e+00  1.07532202e+00
  1.07532202e+00  4.14543614e+00  5.63729030e+00  5.63729030e+00
  5.63729030e+00  1.28799637e+01  2.39471855e+01  2.39471855e+01
  2.39471855e+01  4.19534210e+01  1.18749568e+02  1.18749568e+02
  1.18749568e+02  1.46100264e+02  5.09551504e+02  1.87644889e+03
  8.00535127e+03  4.77720547e+04]
E1 = -182.84318506103435  E_coul = 54.311766458426305
cycle= 2 E= -128.531418602608  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229947
diis-c [-6.27950733e-04  3.31989389e-01  6.68010611e-01]
  HOMO = -0.845224674086848  LUMO = 0.8011718612235
  mo_energy =
[-3.27689683e+01 -1.92700929e+00 -8.45224674e-01 -8.45224674e-01
 -8.45224674e-01  8.01171861e-01  1.08779045e+00  1.08779045e+00
  1.08779045e+00  4.16901499e+00  5.67918366e+00  5.67918366e+00
  5.67918366e+00  1.29261868e+01  2.40247450e+01  2.40247450e+01
  2.40247450e+01  4.20330790e+01  1.18854635e+02  1.18854635e+02
  1.18854635e+02  1.46202853e+02  5.09665034e+02  1.87656770e+03
  8.00547252e+03  4.77721769e+04]
E1 = -182.59766438032565  E_coul = 54.065398445793
cycle= 3 E= -128.532265934533  delta_E= -0.000847  |g|= 0.000479  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000969594
diis-c [-1.63181056e-07 -2.21239669e-03 -5.96925522e-04  1.00280932e+00]
  HOMO = -0.845463963597441  LUMO = 0.801135249540433
  mo_energy =
[-3.27693959e+01 -1.92718350e+00 -8.45463964e-01 -8.45463964e-01
 -8.45463964e-01  8.01135250e-01  1.08773816e+00  1.08773816e+00
  1.08773816e+00  4.16889202e+00  5.67897433e+00  5.67897433e+00
  5.67897433e+00  1.29259595e+01  2.40244092e+01  2.40244092e+01
  2.40244092e+01  4.20327440e+01  1.18854195e+02  1.18854195e+02
  1.18854195e+02  1.46202428e+02  5.09664502e+02  1.87656706e+03
  8.00547179e+03  4.77721761e+04]
E1 = -182.59820054621554  E_coul = 54.06593458990462
cycle= 4 E= -128.532265956311  delta_E= -2.18e-08  |g|= 6.35e-05  |ddm|= 0.000362
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132305
diis-c [-9.92954871e-10  3.29761268e-04  4.00453828e-04 -2.16193807e-01
  1.21546359e+00]
  HOMO = -0.845495960636313  LUMO = 0.801128659582921
  mo_energy =
[-3.27694479e+01 -1.92720275e+00 -8.45495961e-01 -8.45495961e-01
 -8.45495961e-01  8.01128660e-01  1.08772470e+00  1.08772470e+00
  1.08772470e+00  4.16887191e+00  5.67893904e+00  5.67893904e+00
  5.67893904e+00  1.29259245e+01  2.40243623e+01  2.40243623e+01
  2.40243623e+01  4.20326978e+01  1.18854143e+02  1.18854143e+02
  1.18854143e+02  1.46202376e+02  5.09664442e+02  1.87656699e+03
  8.00547172e+03  4.77721760e+04]
E1 = -182.5983023806444  E_coul = 54.06603642378471
cycle= 5 E= -128.53226595686  delta_E= -5.49e-10  |g|= 6.76e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983023806444  E_coul = 54.06603642378471
  HOMO = -0.845492226445073  LUMO = 0.801130127107351
  mo_energy =
[-3.27694398e+01 -1.92719831e+00 -8.45492226e-01 -8.45492226e-01
 -8.45492226e-01  8.01130127e-01  1.08772627e+00  1.08772627e+00
  1.08772627e+00  4.16887510e+00  5.67894357e+00  5.67894357e+00
  5.67894357e+00  1.29259296e+01  2.40243693e+01  2.40243693e+01
  2.40243693e+01  4.20327049e+01  1.18854151e+02  1.18854151e+02
  1.18854151e+02  1.46202384e+02  5.09664450e+02  1.87656700e+03
  8.00547172e+03  4.77721760e+04]
E1 = -182.5982845032962  E_coul = 54.06601854643397
Extra cycle  E= -128.532265956862  delta_E= -2.53e-12  |g|= 2.5e-06  |ddm|= 2.66e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2962.8041964982644
E1 = -182.5982845032962  E_coul = 54.06601854643397
init E= -128.532265956862
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845493475139152  LUMO = 0.801129869854609
  mo_energy =
[-3.27694438e+01 -1.92719952e+00 -8.45493475e-01 -8.45493475e-01
 -8.45493475e-01  8.01129870e-01  1.08772583e+00  1.08772583e+00
  1.08772583e+00  4.16887432e+00  5.67894205e+00  5.67894205e+00
  5.67894205e+00  1.29259280e+01  2.40243664e+01  2.40243664e+01
  2.40243664e+01  4.20327019e+01  1.18854147e+02  1.18854147e+02
  1.18854147e+02  1.46202380e+02  5.09664446e+02  1.87656699e+03
  8.00547172e+03  4.77721760e+04]
E1 = -182.59829414089847  E_coul = 54.0660281840358
cycle= 1 E= -128.532265956863  delta_E= -4.26e-13  |g|= 1.32e-06  |ddm|= 9.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59829414089847  E_coul = 54.0660281840358
  HOMO = -0.84549279728474  LUMO = 0.801130057390495
  mo_energy =
[-3.27694417e+01 -1.92719878e+00 -8.45492797e-01 -8.45492797e-01
 -8.45492797e-01  8.01130057e-01  1.08772608e+00  1.08772608e+00
  1.08772608e+00  4.16887480e+00  5.67894288e+00  5.67894288e+00
  5.67894288e+00  1.29259289e+01  2.40243679e+01  2.40243679e+01
  2.40243679e+01  4.20327035e+01  1.18854149e+02  1.18854149e+02
  1.18854149e+02  1.46202382e+02  5.09664448e+02  1.87656700e+03
  8.00547172e+03  4.77721760e+04]
E1 = -182.59828935352922  E_coul = 54.06602339666642
Extra cycle  E= -128.532265956863  delta_E= -1.42e-13  |g|= 6.52e-07  |ddm|= 4.51e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.30272788e-01 2.44137941e+04 3.66145449e+03 8.33270684e+02
 2.35739323e+02 7.64032299e+01 1.03126323e+01 2.70763721e+01
 3.18932315e-01 1.93134633e+00 2.97108434e+00 3.67977840e+00
 1.24427514e+01 5.47853686e+01 3.29805119e-01 1.14166676e+00]
grad_E = [ 9.90955490e-07  6.74809522e-10 -3.54396988e-08  7.28715449e-07
 -8.95346281e-06  6.85623234e-05  1.84311089e-05 -2.27075988e-04
  8.21051572e-05  1.15092263e-05 -1.06405865e-04  1.52405664e-04
 -4.95191686e-06  1.17695968e-06  1.51809932e-03 -9.01213276e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.833521966462       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.4544881         1
[INPUT] 0    0    [1    /1   ]  833.270678694        1
[INPUT] 0    0    [1    /1   ]  235.739384868        1
[INPUT] 0    0    [1    /1   ]  76.4028062066        1
[INPUT] 0    0    [1    /1   ]  10.3158690091        1
[INPUT] 0    0    [1    /1   ]  27.0769903075        1
[INPUT] 0    0    [1    /1   ]  0.31973350979        1
[INPUT] 0    0    [1    /1   ]  1.93844950726        1
[INPUT] 0    0    [1    /1   ]  2.97261530725        1
[INPUT] 1    0    [1    /1   ]  3.6800740756         1
[INPUT] 1    0    [1    /1   ]  12.4425404112        1
[INPUT] 1    0    [1    /1   ]  54.785372169         1
[INPUT] 1    0    [1    /1   ]  0.329779352585       1
[INPUT] 1    0    [1    /1   ]  1.14222741204        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8335219664617816, 1.0]], [0, [24413.79412964522, 1.0]], [0, [3661.454488095327, 1.0]], [0, [833.2706786943968, 1.0]], [0, [235.73938486794682, 1.0]], [0, [76.40280620661444, 1.0]], [0, [10.315869009081261, 1.0]], [0, [27.07699030749738, 1.0]], [0, [0.31973350979015724, 1.0]], [0, [1.9384495072570795, 1.0]], [0, [2.9726153072502717, 1.0]], [1, [3.6800740756017327, 1.0]], [1, [12.44254041124311, 1.0]], [1, [54.78537216903988, 1.0]], [1, [0.32977935258454044, 1.0]], [1, [1.1422274120430465, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83352197]
bas 1, expnt(s) = [24413.79412965]
bas 2, expnt(s) = [3661.4544881]
bas 3, expnt(s) = [833.27067869]
bas 4, expnt(s) = [235.73938487]
bas 5, expnt(s) = [76.40280621]
bas 6, expnt(s) = [10.31586901]
bas 7, expnt(s) = [27.07699031]
bas 8, expnt(s) = [0.31973351]
bas 9, expnt(s) = [1.93844951]
bas 10, expnt(s) = [2.97261531]
bas 11, expnt(s) = [3.68007408]
bas 12, expnt(s) = [12.44254041]
bas 13, expnt(s) = [54.78537217]
bas 14, expnt(s) = [0.32977935]
bas 15, expnt(s) = [1.14222741]
CPU time:       104.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.33521966e-01 2.20395545e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270679e+02 3.91836239e+02
 2.35739385e+02 1.51998441e+02 7.64028062e+01 6.52900508e+01
 1.03158690e+01 1.45426780e+01 2.70769903e+01 2.99892301e+01
 3.19733510e-01 1.07425192e+00 1.93844951e+00 4.15055233e+00
 2.97261531e+00 5.71964477e+00 3.68007408e+00 1.48697988e+01
 1.24425404e+01 6.81743047e+01 5.47853722e+01 4.34825658e+02
 3.29779353e-01 7.29060751e-01 1.14222741e+00 3.44488807e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998495914128803
cond(S) = 3014.069076897854
E1 = -183.57768210529525  E_coul = 55.078498371553266
init E= -128.499183733742
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945717307673  LUMO = 0.822949204404907
  mo_energy =
[-3.25553694e+01 -1.85289751e+00 -7.73945717e-01 -7.73945717e-01
 -7.73945717e-01  8.22949204e-01  1.11355871e+00  1.11355871e+00
  1.11355871e+00  4.23421378e+00  5.76769361e+00  5.76769361e+00
  5.76769361e+00  1.30584225e+01  2.41845808e+01  2.41845808e+01
  2.41845808e+01  4.22513548e+01  1.19072087e+02  1.19072087e+02
  1.19072087e+02  1.46475359e+02  5.09967992e+02  1.87689591e+03
  8.00582105e+03  4.77725352e+04]
E1 = -182.11058519107402  E_coul = 53.58167299367394
cycle= 1 E= -128.5289121974  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460638
diis-c [-0.2121878  1.       ]
  HOMO = -0.879629952841311  LUMO = 0.795412865337326
  mo_energy =
[-3.28740679e+01 -1.96318522e+00 -8.79629953e-01 -8.79629953e-01
 -8.79629953e-01  7.95412865e-01  1.07541172e+00  1.07541172e+00
  1.07541172e+00  4.16095476e+00  5.63886126e+00  5.63886126e+00
  5.63886126e+00  1.29165806e+01  2.39496170e+01  2.39496170e+01
  2.39496170e+01  4.20106464e+01  1.18751111e+02  1.18751111e+02
  1.18751111e+02  1.46163345e+02  5.09610960e+02  1.87650249e+03
  8.00539847e+03  4.77720938e+04]
E1 = -182.84287141817924  E_coul = 54.31145282981681
cycle= 2 E= -128.531418588362  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229972
diis-c [-6.28367618e-04  3.32000667e-01  6.67999333e-01]
  HOMO = -0.845256861749588  LUMO = 0.804377360403806
  mo_energy =
[-3.27690152e+01 -1.92704633e+00 -8.45256862e-01 -8.45256862e-01
 -8.45256862e-01  8.04377360e-01  1.08788595e+00  1.08788595e+00
  1.08788595e+00  4.18459565e+00  5.68076697e+00  5.68076697e+00
  5.68076697e+00  1.29628535e+01  2.40271871e+01  2.40271871e+01
  2.40271871e+01  4.20903196e+01  1.18856193e+02  1.18856193e+02
  1.18856193e+02  1.46265947e+02  5.09724505e+02  1.87662131e+03
  8.00551975e+03  4.77722160e+04]
E1 = -182.59727532587482  E_coul = 54.06500900824272
cycle= 3 E= -128.532266317632  delta_E= -0.000848  |g|= 0.000482  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000973933
diis-c [-1.61425255e-07 -2.21696765e-03 -5.80904088e-04  1.00279787e+00]
  HOMO = -0.845498140831596  LUMO = 0.80433950223133
  mo_energy =
[-3.27694457e+01 -1.92722303e+00 -8.45498141e-01 -8.45498141e-01
 -8.45498141e-01  8.04339502e-01  1.08783268e+00  1.08783268e+00
  1.08783268e+00  4.18447042e+00  5.68055524e+00  5.68055524e+00
  5.68055524e+00  1.29626234e+01  2.40268484e+01  2.40268484e+01
  2.40268484e+01  4.20899817e+01  1.18855751e+02  1.18855751e+02
  1.18855751e+02  1.46265518e+02  5.09723971e+02  1.87662067e+03
  8.00551901e+03  4.77722152e+04]
E1 = -182.59781532274704  E_coul = 54.06554898320914
cycle= 4 E= -128.532266339538  delta_E= -2.19e-08  |g|= 6.35e-05  |ddm|= 0.000365
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132261
diis-c [-9.90351493e-10  3.27979426e-04  3.97875675e-04 -2.14964162e-01
  1.21423831e+00]
  HOMO = -0.845530293473301  LUMO = 0.80433275863641
  mo_energy =
[-3.27694979e+01 -1.92724256e+00 -8.45530293e-01 -8.45530293e-01
 -8.45530293e-01  8.04332759e-01  1.08781914e+00  1.08781914e+00
  1.08781914e+00  4.18445006e+00  5.68051975e+00  5.68051975e+00
  5.68051975e+00  1.29625881e+01  2.40268012e+01  2.40268012e+01
  2.40268012e+01  4.20899352e+01  1.18855698e+02  1.18855698e+02
  1.18855698e+02  1.46265466e+02  5.09723911e+02  1.87662060e+03
  8.00551894e+03  4.77722151e+04]
E1 = -182.59791740293488  E_coul = 54.06565106285143
cycle= 5 E= -128.532266340083  delta_E= -5.46e-10  |g|= 6.75e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59791740293488  E_coul = 54.06565106285143
  HOMO = -0.845526572477191  LUMO = 0.804334231041946
  mo_energy =
[-3.27694898e+01 -1.92723814e+00 -8.45526572e-01 -8.45526572e-01
 -8.45526572e-01  8.04334231e-01  1.08782070e+00  1.08782070e+00
  1.08782070e+00  4.18445324e+00  5.68052426e+00  5.68052426e+00
  5.68052426e+00  1.29625932e+01  2.40268082e+01  2.40268082e+01
  2.40268082e+01  4.20899423e+01  1.18855706e+02  1.18855706e+02
  1.18855706e+02  1.46265474e+02  5.09723919e+02  1.87662061e+03
  8.00551894e+03  4.77722151e+04]
E1 = -182.59789961257326  E_coul = 54.06563327248696
Extra cycle  E= -128.532266340086  delta_E= -2.84e-12  |g|= 2.49e-06  |ddm|= 2.66e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.33521966e-01 2.44137941e+04 3.66145449e+03 8.33270679e+02
 2.35739385e+02 7.64028062e+01 1.03158690e+01 2.70769903e+01
 3.19733510e-01 1.93844951e+00 2.97261531e+00 3.68007408e+00
 1.24425404e+01 5.47853722e+01 3.29779353e-01 1.14222741e+00]
E = -128.5322663400863
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.833521966462       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.4544881         1
[INPUT] 0    0    [1    /1   ]  833.270678694        1
[INPUT] 0    0    [1    /1   ]  235.739384868        1
[INPUT] 0    0    [1    /1   ]  76.4028062066        1
[INPUT] 0    0    [1    /1   ]  10.3158690091        1
[INPUT] 0    0    [1    /1   ]  27.0769903075        1
[INPUT] 0    0    [1    /1   ]  0.31973350979        1
[INPUT] 0    0    [1    /1   ]  1.93844950726        1
[INPUT] 0    0    [1    /1   ]  2.97261530725        1
[INPUT] 1    0    [1    /1   ]  3.6800740756         1
[INPUT] 1    0    [1    /1   ]  12.4425404112        1
[INPUT] 1    0    [1    /1   ]  54.785372169         1
[INPUT] 1    0    [1    /1   ]  0.329779352585       1
[INPUT] 1    0    [1    /1   ]  1.14222741204        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8335219664617816, 1.0]], [0, [24413.79412964522, 1.0]], [0, [3661.454488095327, 1.0]], [0, [833.2706786943968, 1.0]], [0, [235.73938486794682, 1.0]], [0, [76.40280620661444, 1.0]], [0, [10.315869009081261, 1.0]], [0, [27.07699030749738, 1.0]], [0, [0.31973350979015724, 1.0]], [0, [1.9384495072570795, 1.0]], [0, [2.9726153072502717, 1.0]], [1, [3.6800740756017327, 1.0]], [1, [12.44254041124311, 1.0]], [1, [54.78537216903988, 1.0]], [1, [0.32977935258454044, 1.0]], [1, [1.1422274120430465, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83352197]
bas 1, expnt(s) = [24413.79412965]
bas 2, expnt(s) = [3661.4544881]
bas 3, expnt(s) = [833.27067869]
bas 4, expnt(s) = [235.73938487]
bas 5, expnt(s) = [76.40280621]
bas 6, expnt(s) = [10.31586901]
bas 7, expnt(s) = [27.07699031]
bas 8, expnt(s) = [0.31973351]
bas 9, expnt(s) = [1.93844951]
bas 10, expnt(s) = [2.97261531]
bas 11, expnt(s) = [3.68007408]
bas 12, expnt(s) = [12.44254041]
bas 13, expnt(s) = [54.78537217]
bas 14, expnt(s) = [0.32977935]
bas 15, expnt(s) = [1.14222741]
CPU time:       104.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.33521966e-01 2.20395545e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270679e+02 3.91836239e+02
 2.35739385e+02 1.51998441e+02 7.64028062e+01 6.52900508e+01
 1.03158690e+01 1.45426780e+01 2.70769903e+01 2.99892301e+01
 3.19733510e-01 1.07425192e+00 1.93844951e+00 4.15055233e+00
 2.97261531e+00 5.71964477e+00 3.68007408e+00 1.48697988e+01
 1.24425404e+01 6.81743047e+01 5.47853722e+01 4.34825658e+02
 3.29779353e-01 7.29060751e-01 1.14222741e+00 3.44488807e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998495914128803
cond(S) = 3014.069076897854
E1 = -183.57768210529525  E_coul = 55.078498371553266
init E= -128.499183733742
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945717307673  LUMO = 0.822949204404907
  mo_energy =
[-3.25553694e+01 -1.85289751e+00 -7.73945717e-01 -7.73945717e-01
 -7.73945717e-01  8.22949204e-01  1.11355871e+00  1.11355871e+00
  1.11355871e+00  4.23421378e+00  5.76769361e+00  5.76769361e+00
  5.76769361e+00  1.30584225e+01  2.41845808e+01  2.41845808e+01
  2.41845808e+01  4.22513548e+01  1.19072087e+02  1.19072087e+02
  1.19072087e+02  1.46475359e+02  5.09967992e+02  1.87689591e+03
  8.00582105e+03  4.77725352e+04]
E1 = -182.11058519107402  E_coul = 53.58167299367394
cycle= 1 E= -128.5289121974  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460638
diis-c [-0.2121878  1.       ]
  HOMO = -0.879629952841311  LUMO = 0.795412865337326
  mo_energy =
[-3.28740679e+01 -1.96318522e+00 -8.79629953e-01 -8.79629953e-01
 -8.79629953e-01  7.95412865e-01  1.07541172e+00  1.07541172e+00
  1.07541172e+00  4.16095476e+00  5.63886126e+00  5.63886126e+00
  5.63886126e+00  1.29165806e+01  2.39496170e+01  2.39496170e+01
  2.39496170e+01  4.20106464e+01  1.18751111e+02  1.18751111e+02
  1.18751111e+02  1.46163345e+02  5.09610960e+02  1.87650249e+03
  8.00539847e+03  4.77720938e+04]
E1 = -182.84287141817924  E_coul = 54.31145282981681
cycle= 2 E= -128.531418588362  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229972
diis-c [-6.28367618e-04  3.32000667e-01  6.67999333e-01]
  HOMO = -0.845256861749588  LUMO = 0.804377360403806
  mo_energy =
[-3.27690152e+01 -1.92704633e+00 -8.45256862e-01 -8.45256862e-01
 -8.45256862e-01  8.04377360e-01  1.08788595e+00  1.08788595e+00
  1.08788595e+00  4.18459565e+00  5.68076697e+00  5.68076697e+00
  5.68076697e+00  1.29628535e+01  2.40271871e+01  2.40271871e+01
  2.40271871e+01  4.20903196e+01  1.18856193e+02  1.18856193e+02
  1.18856193e+02  1.46265947e+02  5.09724505e+02  1.87662131e+03
  8.00551975e+03  4.77722160e+04]
E1 = -182.59727532587482  E_coul = 54.06500900824272
cycle= 3 E= -128.532266317632  delta_E= -0.000848  |g|= 0.000482  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000973933
diis-c [-1.61425255e-07 -2.21696765e-03 -5.80904088e-04  1.00279787e+00]
  HOMO = -0.845498140831596  LUMO = 0.80433950223133
  mo_energy =
[-3.27694457e+01 -1.92722303e+00 -8.45498141e-01 -8.45498141e-01
 -8.45498141e-01  8.04339502e-01  1.08783268e+00  1.08783268e+00
  1.08783268e+00  4.18447042e+00  5.68055524e+00  5.68055524e+00
  5.68055524e+00  1.29626234e+01  2.40268484e+01  2.40268484e+01
  2.40268484e+01  4.20899817e+01  1.18855751e+02  1.18855751e+02
  1.18855751e+02  1.46265518e+02  5.09723971e+02  1.87662067e+03
  8.00551901e+03  4.77722152e+04]
E1 = -182.59781532274704  E_coul = 54.06554898320914
cycle= 4 E= -128.532266339538  delta_E= -2.19e-08  |g|= 6.35e-05  |ddm|= 0.000365
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132261
diis-c [-9.90351493e-10  3.27979426e-04  3.97875675e-04 -2.14964162e-01
  1.21423831e+00]
  HOMO = -0.845530293473301  LUMO = 0.80433275863641
  mo_energy =
[-3.27694979e+01 -1.92724256e+00 -8.45530293e-01 -8.45530293e-01
 -8.45530293e-01  8.04332759e-01  1.08781914e+00  1.08781914e+00
  1.08781914e+00  4.18445006e+00  5.68051975e+00  5.68051975e+00
  5.68051975e+00  1.29625881e+01  2.40268012e+01  2.40268012e+01
  2.40268012e+01  4.20899352e+01  1.18855698e+02  1.18855698e+02
  1.18855698e+02  1.46265466e+02  5.09723911e+02  1.87662060e+03
  8.00551894e+03  4.77722151e+04]
E1 = -182.59791740293488  E_coul = 54.06565106285143
cycle= 5 E= -128.532266340083  delta_E= -5.46e-10  |g|= 6.75e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59791740293488  E_coul = 54.06565106285143
  HOMO = -0.845526572477191  LUMO = 0.804334231041946
  mo_energy =
[-3.27694898e+01 -1.92723814e+00 -8.45526572e-01 -8.45526572e-01
 -8.45526572e-01  8.04334231e-01  1.08782070e+00  1.08782070e+00
  1.08782070e+00  4.18445324e+00  5.68052426e+00  5.68052426e+00
  5.68052426e+00  1.29625932e+01  2.40268082e+01  2.40268082e+01
  2.40268082e+01  4.20899423e+01  1.18855706e+02  1.18855706e+02
  1.18855706e+02  1.46265474e+02  5.09723919e+02  1.87662061e+03
  8.00551894e+03  4.77722151e+04]
E1 = -182.59789961257326  E_coul = 54.06563327248696
Extra cycle  E= -128.532266340086  delta_E= -2.84e-12  |g|= 2.49e-06  |ddm|= 2.66e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3014.069076897854
E1 = -182.59789961257326  E_coul = 54.06563327248696
init E= -128.532266340086
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845527815339708  LUMO = 0.804333974673949
  mo_energy =
[-3.27694938e+01 -1.92723933e+00 -8.45527815e-01 -8.45527815e-01
 -8.45527815e-01  8.04333975e-01  1.08782027e+00  1.08782027e+00
  1.08782027e+00  4.18445247e+00  5.68052275e+00  5.68052275e+00
  5.68052275e+00  1.29625916e+01  2.40268053e+01  2.40268053e+01
  2.40268053e+01  4.20899393e+01  1.18855702e+02  1.18855702e+02
  1.18855702e+02  1.46265470e+02  5.09723914e+02  1.87662060e+03
  8.00551894e+03  4.77722151e+04]
E1 = -182.59790920800233  E_coul = 54.06564286791544
cycle= 1 E= -128.532266340087  delta_E= -5.97e-13  |g|= 1.31e-06  |ddm|= 9.69e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59790920800233  E_coul = 54.06564286791544
  HOMO = -0.845527140516261  LUMO = 0.804334162320151
  mo_energy =
[-3.27694917e+01 -1.92723860e+00 -8.45527141e-01 -8.45527141e-01
 -8.45527141e-01  8.04334162e-01  1.08782052e+00  1.08782052e+00
  1.08782052e+00  4.18445295e+00  5.68052357e+00  5.68052357e+00
  5.68052357e+00  1.29625925e+01  2.40268068e+01  2.40268068e+01
  2.40268068e+01  4.20899409e+01  1.18855704e+02  1.18855704e+02
  1.18855704e+02  1.46265472e+02  5.09723917e+02  1.87662060e+03
  8.00551894e+03  4.77722151e+04]
E1 = -182.59790444141072  E_coul = 54.0656381013237
Extra cycle  E= -128.532266340087  delta_E= -1.14e-13  |g|= 6.49e-07  |ddm|= 4.49e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.33521966e-01 2.44137941e+04 3.66145449e+03 8.33270679e+02
 2.35739385e+02 7.64028062e+01 1.03158690e+01 2.70769903e+01
 3.19733510e-01 1.93844951e+00 2.97261531e+00 3.68007408e+00
 1.24425404e+01 5.47853722e+01 3.29779353e-01 1.14222741e+00]
grad_E = [ 3.65589046e-05  6.82335242e-10 -3.58358919e-08  7.36840275e-07
 -9.05503124e-06  6.94128752e-05  2.47841682e-05 -2.30932142e-04
  3.91200864e-05  4.97574430e-06 -1.05087085e-04 -2.67855665e-05
  9.77037896e-06  7.75392941e-07  1.36932219e-04 -1.14582787e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.831483545192       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448801        1
[INPUT] 0    0    [1    /1   ]  833.270680484        1
[INPUT] 0    0    [1    /1   ]  235.739362713        1
[INPUT] 0    0    [1    /1   ]  76.4029391756        1
[INPUT] 0    0    [1    /1   ]  10.3136120961        1
[INPUT] 0    0    [1    /1   ]  27.0770934434        1
[INPUT] 0    0    [1    /1   ]  0.31925381259        1
[INPUT] 0    0    [1    /1   ]  1.93303168565        1
[INPUT] 0    0    [1    /1   ]  2.97196109577        1
[INPUT] 1    0    [1    /1   ]  3.68049101335        1
[INPUT] 1    0    [1    /1   ]  12.4424452519        1
[INPUT] 1    0    [1    /1   ]  54.7853790529        1
[INPUT] 1    0    [1    /1   ]  0.329797828833       1
[INPUT] 1    0    [1    /1   ]  1.14258244239        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8314835451923946, 1.0]], [0, [24413.794129646834, 1.0]], [0, [3661.454488010718, 1.0]], [0, [833.2706804843283, 1.0]], [0, [235.73936271266058, 1.0]], [0, [76.4029391756298, 1.0]], [0, [10.31361209610647, 1.0]], [0, [27.077093443405833, 1.0]], [0, [0.31925381259033336, 1.0]], [0, [1.9330316856485763, 1.0]], [0, [2.971961095771326, 1.0]], [1, [3.680491013351183, 1.0]], [1, [12.442445251879077, 1.0]], [1, [54.78537905292505, 1.0]], [1, [0.32979782883349945, 1.0]], [1, [1.142582442391639, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83148355]
bas 1, expnt(s) = [24413.79412965]
bas 2, expnt(s) = [3661.45448801]
bas 3, expnt(s) = [833.27068048]
bas 4, expnt(s) = [235.73936271]
bas 5, expnt(s) = [76.40293918]
bas 6, expnt(s) = [10.3136121]
bas 7, expnt(s) = [27.07709344]
bas 8, expnt(s) = [0.31925381]
bas 9, expnt(s) = [1.93303169]
bas 10, expnt(s) = [2.9719611]
bas 11, expnt(s) = [3.68049101]
bas 12, expnt(s) = [12.44244525]
bas 13, expnt(s) = [54.78537905]
bas 14, expnt(s) = [0.32979783]
bas 15, expnt(s) = [1.14258244]
CPU time:       107.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.31483545e-01 2.19991180e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270680e+02 3.91836240e+02
 2.35739363e+02 1.51998430e+02 7.64029392e+01 6.52901361e+01
 1.03136121e+01 1.45402917e+01 2.70770934e+01 2.99893158e+01
 3.19253813e-01 1.07304292e+00 1.93303169e+00 4.14184893e+00
 2.97196110e+00 5.71870066e+00 3.68049101e+00 1.48719047e+01
 1.24424453e+01 6.81736530e+01 5.47853791e+01 4.34825726e+02
 3.29797829e-01 7.29111810e-01 1.14258244e+00 3.44622656e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998494784659602
cond(S) = 2976.3457407404635
E1 = -183.57768028738923  E_coul = 55.078497570896914
init E= -128.499182716492
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945647375459  LUMO = 0.820873561387207
  mo_energy =
[-3.25553698e+01 -1.85289755e+00 -7.73945647e-01 -7.73945647e-01
 -7.73945647e-01  8.20873561e-01  1.11373579e+00  1.11373579e+00
  1.11373579e+00  4.22386391e+00  5.76901264e+00  5.76901264e+00
  5.76901264e+00  1.30335142e+01  2.41869615e+01  2.41869615e+01
  2.41869615e+01  4.22125807e+01  1.19073995e+02  1.19073995e+02
  1.19073995e+02  1.46433409e+02  5.09928902e+02  1.87686074e+03
  8.00579009e+03  4.77725096e+04]
E1 = -182.11044764986715  E_coul = 53.58153552882646
cycle= 1 E= -128.528912121041  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460655
diis-c [-0.21220273  1.        ]
  HOMO = -0.879642026811925  LUMO = 0.793404234117864
  mo_energy =
[-3.28740870e+01 -1.96319877e+00 -8.79642027e-01 -8.79642027e-01
 -8.79642027e-01  7.93404234e-01  1.07557217e+00  1.07557217e+00
  1.07557217e+00  4.15071790e+00  5.64014934e+00  5.64014934e+00
  5.64014934e+00  1.28917492e+01  2.39519821e+01  2.39519821e+01
  2.39519821e+01  4.19718640e+01  1.18753001e+02  1.18753001e+02
  1.18753001e+02  1.46121371e+02  5.09571849e+02  1.87646730e+03
  8.00536748e+03  4.77720681e+04]
E1 = -182.84275819375912  E_coul = 54.31133958873549
cycle= 2 E= -128.531418605024  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229983
diis-c [-6.28242659e-04  3.32004273e-01  6.67995727e-01]
  HOMO = -0.845268070762069  LUMO = 0.802345071346538
  mo_energy =
[-3.27690309e+01 -1.92705904e+00 -8.45268071e-01 -8.45268071e-01
 -8.45268071e-01  8.02345071e-01  1.08805004e+00  1.08805004e+00
  1.08805004e+00  4.17431866e+00  5.68206137e+00  5.68206137e+00
  5.68206137e+00  1.29379929e+01  2.40295542e+01  2.40295542e+01
  2.40295542e+01  4.20515374e+01  1.18858086e+02  1.18858086e+02
  1.18858086e+02  1.46223977e+02  5.09685399e+02  1.87658613e+03
  8.00548876e+03  4.77721903e+04]
E1 = -182.59714100058096  E_coul = 54.06487456121955
cycle= 3 E= -128.532266439361  delta_E= -0.000848  |g|= 0.000483  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000975588
diis-c [-1.61227375e-07 -2.21957587e-03 -5.77792293e-04  1.00279737e+00]
  HOMO = -0.845510106528106  LUMO = 0.802306919531675
  mo_energy =
[-3.27694624e+01 -1.92723667e+00 -8.45510107e-01 -8.45510107e-01
 -8.45510107e-01  8.02306920e-01  1.08799638e+00  1.08799638e+00
  1.08799638e+00  4.17419292e+00  5.68184871e+00  5.68184871e+00
  5.68184871e+00  1.29377620e+01  2.40292145e+01  2.40292145e+01
  2.40292145e+01  4.20511985e+01  1.18857643e+02  1.18857643e+02
  1.18857643e+02  1.46223548e+02  5.09684864e+02  1.87658548e+03
  8.00548803e+03  4.77721896e+04]
E1 = -182.5976822968736  E_coul = 54.06541583554886
cycle= 4 E= -128.532266461325  delta_E= -2.2e-08  |g|= 6.36e-05  |ddm|= 0.000365
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132245
diis-c [-9.89262150e-10  3.27413298e-04  3.96768826e-04 -2.14556553e-01
  1.21383237e+00]
  HOMO = -0.845542315493745  LUMO = 0.802300148912272
  mo_energy =
[-3.27695147e+01 -1.92725630e+00 -8.45542315e-01 -8.45542315e-01
 -8.45542315e-01  8.02300149e-01  1.08798281e+00  1.08798281e+00
  1.08798281e+00  4.17417252e+00  5.68181314e+00  5.68181314e+00
  5.68181314e+00  1.29377266e+01  2.40291673e+01  2.40291673e+01
  2.40291673e+01  4.20511519e+01  1.18857590e+02  1.18857590e+02
  1.18857590e+02  1.46223496e+02  5.09684804e+02  1.87658541e+03
  8.00548795e+03  4.77721895e+04]
E1 = -182.59778438838765  E_coul = 54.06551792651814
cycle= 5 E= -128.53226646187  delta_E= -5.45e-10  |g|= 6.75e-06  |ddm|= 6.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59778438838765  E_coul = 54.06551792651814
  HOMO = -0.845538599159935  LUMO = 0.802301617695373
  mo_energy =
[-3.27695066e+01 -1.92725188e+00 -8.45538599e-01 -8.45538599e-01
 -8.45538599e-01  8.02301618e-01  1.08798436e+00  1.08798436e+00
  1.08798436e+00  4.17417570e+00  5.68181765e+00  5.68181765e+00
  5.68181765e+00  1.29377318e+01  2.40291742e+01  2.40291742e+01
  2.40291742e+01  4.20511590e+01  1.18857598e+02  1.18857598e+02
  1.18857598e+02  1.46223503e+02  5.09684812e+02  1.87658542e+03
  8.00548796e+03  4.77721895e+04]
E1 = -182.59776662688603  E_coul = 54.06550016501359
Extra cycle  E= -128.532266461872  delta_E= -2.93e-12  |g|= 2.49e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [8.31483545e-01 2.44137941e+04 3.66145449e+03 8.33270680e+02
 2.35739363e+02 7.64029392e+01 1.03136121e+01 2.70770934e+01
 3.19253813e-01 1.93303169e+00 2.97196110e+00 3.68049101e+00
 1.24424453e+01 5.47853791e+01 3.29797829e-01 1.14258244e+00]
E = -128.53226646187244
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.831483545192       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448801        1
[INPUT] 0    0    [1    /1   ]  833.270680484        1
[INPUT] 0    0    [1    /1   ]  235.739362713        1
[INPUT] 0    0    [1    /1   ]  76.4029391756        1
[INPUT] 0    0    [1    /1   ]  10.3136120961        1
[INPUT] 0    0    [1    /1   ]  27.0770934434        1
[INPUT] 0    0    [1    /1   ]  0.31925381259        1
[INPUT] 0    0    [1    /1   ]  1.93303168565        1
[INPUT] 0    0    [1    /1   ]  2.97196109577        1
[INPUT] 1    0    [1    /1   ]  3.68049101335        1
[INPUT] 1    0    [1    /1   ]  12.4424452519        1
[INPUT] 1    0    [1    /1   ]  54.7853790529        1
[INPUT] 1    0    [1    /1   ]  0.329797828833       1
[INPUT] 1    0    [1    /1   ]  1.14258244239        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8314835451923946, 1.0]], [0, [24413.794129646834, 1.0]], [0, [3661.454488010718, 1.0]], [0, [833.2706804843283, 1.0]], [0, [235.73936271266058, 1.0]], [0, [76.4029391756298, 1.0]], [0, [10.31361209610647, 1.0]], [0, [27.077093443405833, 1.0]], [0, [0.31925381259033336, 1.0]], [0, [1.9330316856485763, 1.0]], [0, [2.971961095771326, 1.0]], [1, [3.680491013351183, 1.0]], [1, [12.442445251879077, 1.0]], [1, [54.78537905292505, 1.0]], [1, [0.32979782883349945, 1.0]], [1, [1.142582442391639, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83148355]
bas 1, expnt(s) = [24413.79412965]
bas 2, expnt(s) = [3661.45448801]
bas 3, expnt(s) = [833.27068048]
bas 4, expnt(s) = [235.73936271]
bas 5, expnt(s) = [76.40293918]
bas 6, expnt(s) = [10.3136121]
bas 7, expnt(s) = [27.07709344]
bas 8, expnt(s) = [0.31925381]
bas 9, expnt(s) = [1.93303169]
bas 10, expnt(s) = [2.9719611]
bas 11, expnt(s) = [3.68049101]
bas 12, expnt(s) = [12.44244525]
bas 13, expnt(s) = [54.78537905]
bas 14, expnt(s) = [0.32979783]
bas 15, expnt(s) = [1.14258244]
CPU time:       108.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.31483545e-01 2.19991180e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270680e+02 3.91836240e+02
 2.35739363e+02 1.51998430e+02 7.64029392e+01 6.52901361e+01
 1.03136121e+01 1.45402917e+01 2.70770934e+01 2.99893158e+01
 3.19253813e-01 1.07304292e+00 1.93303169e+00 4.14184893e+00
 2.97196110e+00 5.71870066e+00 3.68049101e+00 1.48719047e+01
 1.24424453e+01 6.81736530e+01 5.47853791e+01 4.34825726e+02
 3.29797829e-01 7.29111810e-01 1.14258244e+00 3.44622656e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998494784659602
cond(S) = 2976.3457407404635
E1 = -183.57768028738923  E_coul = 55.078497570896914
init E= -128.499182716492
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945647375459  LUMO = 0.820873561387207
  mo_energy =
[-3.25553698e+01 -1.85289755e+00 -7.73945647e-01 -7.73945647e-01
 -7.73945647e-01  8.20873561e-01  1.11373579e+00  1.11373579e+00
  1.11373579e+00  4.22386391e+00  5.76901264e+00  5.76901264e+00
  5.76901264e+00  1.30335142e+01  2.41869615e+01  2.41869615e+01
  2.41869615e+01  4.22125807e+01  1.19073995e+02  1.19073995e+02
  1.19073995e+02  1.46433409e+02  5.09928902e+02  1.87686074e+03
  8.00579009e+03  4.77725096e+04]
E1 = -182.11044764986715  E_coul = 53.58153552882646
cycle= 1 E= -128.528912121041  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460655
diis-c [-0.21220273  1.        ]
  HOMO = -0.879642026811925  LUMO = 0.793404234117864
  mo_energy =
[-3.28740870e+01 -1.96319877e+00 -8.79642027e-01 -8.79642027e-01
 -8.79642027e-01  7.93404234e-01  1.07557217e+00  1.07557217e+00
  1.07557217e+00  4.15071790e+00  5.64014934e+00  5.64014934e+00
  5.64014934e+00  1.28917492e+01  2.39519821e+01  2.39519821e+01
  2.39519821e+01  4.19718640e+01  1.18753001e+02  1.18753001e+02
  1.18753001e+02  1.46121371e+02  5.09571849e+02  1.87646730e+03
  8.00536748e+03  4.77720681e+04]
E1 = -182.84275819375912  E_coul = 54.31133958873549
cycle= 2 E= -128.531418605024  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229983
diis-c [-6.28242659e-04  3.32004273e-01  6.67995727e-01]
  HOMO = -0.845268070762069  LUMO = 0.802345071346538
  mo_energy =
[-3.27690309e+01 -1.92705904e+00 -8.45268071e-01 -8.45268071e-01
 -8.45268071e-01  8.02345071e-01  1.08805004e+00  1.08805004e+00
  1.08805004e+00  4.17431866e+00  5.68206137e+00  5.68206137e+00
  5.68206137e+00  1.29379929e+01  2.40295542e+01  2.40295542e+01
  2.40295542e+01  4.20515374e+01  1.18858086e+02  1.18858086e+02
  1.18858086e+02  1.46223977e+02  5.09685399e+02  1.87658613e+03
  8.00548876e+03  4.77721903e+04]
E1 = -182.59714100058096  E_coul = 54.06487456121955
cycle= 3 E= -128.532266439361  delta_E= -0.000848  |g|= 0.000483  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000975588
diis-c [-1.61227375e-07 -2.21957587e-03 -5.77792293e-04  1.00279737e+00]
  HOMO = -0.845510106528106  LUMO = 0.802306919531675
  mo_energy =
[-3.27694624e+01 -1.92723667e+00 -8.45510107e-01 -8.45510107e-01
 -8.45510107e-01  8.02306920e-01  1.08799638e+00  1.08799638e+00
  1.08799638e+00  4.17419292e+00  5.68184871e+00  5.68184871e+00
  5.68184871e+00  1.29377620e+01  2.40292145e+01  2.40292145e+01
  2.40292145e+01  4.20511985e+01  1.18857643e+02  1.18857643e+02
  1.18857643e+02  1.46223548e+02  5.09684864e+02  1.87658548e+03
  8.00548803e+03  4.77721896e+04]
E1 = -182.5976822968736  E_coul = 54.06541583554886
cycle= 4 E= -128.532266461325  delta_E= -2.2e-08  |g|= 6.36e-05  |ddm|= 0.000365
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132245
diis-c [-9.89262150e-10  3.27413298e-04  3.96768826e-04 -2.14556553e-01
  1.21383237e+00]
  HOMO = -0.845542315493745  LUMO = 0.802300148912272
  mo_energy =
[-3.27695147e+01 -1.92725630e+00 -8.45542315e-01 -8.45542315e-01
 -8.45542315e-01  8.02300149e-01  1.08798281e+00  1.08798281e+00
  1.08798281e+00  4.17417252e+00  5.68181314e+00  5.68181314e+00
  5.68181314e+00  1.29377266e+01  2.40291673e+01  2.40291673e+01
  2.40291673e+01  4.20511519e+01  1.18857590e+02  1.18857590e+02
  1.18857590e+02  1.46223496e+02  5.09684804e+02  1.87658541e+03
  8.00548795e+03  4.77721895e+04]
E1 = -182.59778438838765  E_coul = 54.06551792651814
cycle= 5 E= -128.53226646187  delta_E= -5.45e-10  |g|= 6.75e-06  |ddm|= 6.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59778438838765  E_coul = 54.06551792651814
  HOMO = -0.845538599159935  LUMO = 0.802301617695373
  mo_energy =
[-3.27695066e+01 -1.92725188e+00 -8.45538599e-01 -8.45538599e-01
 -8.45538599e-01  8.02301618e-01  1.08798436e+00  1.08798436e+00
  1.08798436e+00  4.17417570e+00  5.68181765e+00  5.68181765e+00
  5.68181765e+00  1.29377318e+01  2.40291742e+01  2.40291742e+01
  2.40291742e+01  4.20511590e+01  1.18857598e+02  1.18857598e+02
  1.18857598e+02  1.46223503e+02  5.09684812e+02  1.87658542e+03
  8.00548796e+03  4.77721895e+04]
E1 = -182.59776662688603  E_coul = 54.06550016501359
Extra cycle  E= -128.532266461872  delta_E= -2.93e-12  |g|= 2.49e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2976.3457407404635
E1 = -182.59776662688603  E_coul = 54.06550016501359
init E= -128.532266461872
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845539840128427  LUMO = 0.802301362761504
  mo_energy =
[-3.27695106e+01 -1.92725307e+00 -8.45539840e-01 -8.45539840e-01
 -8.45539840e-01  8.02301363e-01  1.08798393e+00  1.08798393e+00
  1.08798393e+00  4.17417493e+00  5.68181614e+00  5.68181614e+00
  5.68181614e+00  1.29377301e+01  2.40291713e+01  2.40291713e+01
  2.40291713e+01  4.20511561e+01  1.18857594e+02  1.18857594e+02
  1.18857594e+02  1.46223500e+02  5.09684807e+02  1.87658542e+03
  8.00548795e+03  4.77721895e+04]
E1 = -182.59777620810038  E_coul = 54.06550974622755
cycle= 1 E= -128.532266461873  delta_E= -3.98e-13  |g|= 1.31e-06  |ddm|= 9.67e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59777620810038  E_coul = 54.06550974622755
  HOMO = -0.845539166333852  LUMO = 0.80230154969954
  mo_energy =
[-3.27695085e+01 -1.92725234e+00 -8.45539166e-01 -8.45539166e-01
 -8.45539166e-01  8.02301550e-01  1.08798418e+00  1.08798418e+00
  1.08798418e+00  4.17417541e+00  5.68181697e+00  5.68181697e+00
  5.68181697e+00  1.29377310e+01  2.40291728e+01  2.40291728e+01
  2.40291728e+01  4.20511577e+01  1.18857596e+02  1.18857596e+02
  1.18857596e+02  1.46223502e+02  5.09684809e+02  1.87658542e+03
  8.00548796e+03  4.77721895e+04]
E1 = -182.59777144848758  E_coul = 54.065504986614826
Extra cycle  E= -128.532266461873  delta_E= 8.53e-14  |g|= 6.48e-07  |ddm|= 4.48e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [8.31483545e-01 2.44137941e+04 3.66145449e+03 8.33270680e+02
 2.35739363e+02 7.64029392e+01 1.03136121e+01 2.70770934e+01
 3.19253813e-01 1.93303169e+00 2.97196110e+00 3.68049101e+00
 1.24424453e+01 5.47853791e+01 3.29797829e-01 1.14258244e+00]
grad_E = [ 1.66122121e-05  6.72887356e-10 -3.53407477e-08  7.26843491e-07
 -8.93655972e-06  6.85084450e-05  1.93030997e-05 -2.27278086e-04
  6.58051550e-05  8.66752963e-06 -1.05699849e-04 -8.76298024e-05
  1.18355094e-05  7.93983076e-07 -4.28773390e-04  2.11105934e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.832833463599       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448812        1
[INPUT] 0    0    [1    /1   ]  833.27067824         1
[INPUT] 0    0    [1    /1   ]  235.739389149        1
[INPUT] 0    0    [1    /1   ]  76.4027323126        1
[INPUT] 0    0    [1    /1   ]  10.3115358262        1
[INPUT] 0    0    [1    /1   ]  27.0780732446        1
[INPUT] 0    0    [1    /1   ]  0.319619041772       1
[INPUT] 0    0    [1    /1   ]  1.93239561814        1
[INPUT] 0    0    [1    /1   ]  2.97245812621        1
[INPUT] 1    0    [1    /1   ]  3.68100266958        1
[INPUT] 1    0    [1    /1   ]  12.4422397153        1
[INPUT] 1    0    [1    /1   ]  54.7853914379        1
[INPUT] 1    0    [1    /1   ]  0.329844970579       1
[INPUT] 1    0    [1    /1   ]  1.14299532683        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8328334635992308, 1.0]], [0, [24413.7941296447, 1.0]], [0, [3661.4544881227202, 1.0]], [0, [833.2706782400834, 1.0]], [0, [235.73938914860258, 1.0]], [0, [76.40273231259214, 1.0]], [0, [10.311535826163473, 1.0]], [0, [27.0780732445818, 1.0]], [0, [0.3196190417715929, 1.0]], [0, [1.9323956181350044, 1.0]], [0, [2.9724581262108427, 1.0]], [1, [3.6810026695774956, 1.0]], [1, [12.442239715295262, 1.0]], [1, [54.785391437943915, 1.0]], [1, [0.32984497057883605, 1.0]], [1, [1.1429953268315642, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83283346]
bas 1, expnt(s) = [24413.79412964]
bas 2, expnt(s) = [3661.45448812]
bas 3, expnt(s) = [833.27067824]
bas 4, expnt(s) = [235.73938915]
bas 5, expnt(s) = [76.40273231]
bas 6, expnt(s) = [10.31153583]
bas 7, expnt(s) = [27.07807324]
bas 8, expnt(s) = [0.31961904]
bas 9, expnt(s) = [1.93239562]
bas 10, expnt(s) = [2.97245813]
bas 11, expnt(s) = [3.68100267]
bas 12, expnt(s) = [12.44223972]
bas 13, expnt(s) = [54.78539144]
bas 14, expnt(s) = [0.32984497]
bas 15, expnt(s) = [1.14299533]
CPU time:       111.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.32833464e-01 2.20258993e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270678e+02 3.91836239e+02
 2.35739389e+02 1.51998443e+02 7.64027323e+01 6.52900035e+01
 1.03115358e+01 1.45380963e+01 2.70780732e+01 2.99901296e+01
 3.19619042e-01 1.07396347e+00 1.93239562e+00 4.14082672e+00
 2.97245813e+00 5.71941794e+00 3.68100267e+00 1.48744891e+01
 1.24422397e+01 6.81722453e+01 5.47853914e+01 4.34825849e+02
 3.29844971e-01 7.29242087e-01 1.14299533e+00 3.44778329e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998492892363677
cond(S) = 2982.5614474641466
E1 = -183.5776881793077  E_coul = 55.07850251261417
init E= -128.499185666694
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.773945078093115  LUMO = 0.822127666381019
  mo_energy =
[-3.25553695e+01 -1.85289688e+00 -7.73945078e-01 -7.73945078e-01
 -7.73945078e-01  8.22127666e-01  1.11401740e+00  1.11401740e+00
  1.11401740e+00  4.22804870e+00  5.77066139e+00  5.77066139e+00
  5.77066139e+00  1.30392066e+01  2.41897859e+01  2.41897859e+01
  2.41897859e+01  4.22160358e+01  1.19076057e+02  1.19076057e+02
  1.19076057e+02  1.46434421e+02  5.09929558e+02  1.87686127e+03
  8.00579054e+03  4.77725100e+04]
E1 = -182.1103856645706  E_coul = 53.5814732717856
cycle= 1 E= -128.528912392785  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460637
diis-c [-0.21218612  1.        ]
  HOMO = -0.879648194442498  LUMO = 0.79461347808767
  mo_energy =
[-3.28740930e+01 -1.96320549e+00 -8.79648194e-01 -8.79648194e-01
 -8.79648194e-01  7.94613478e-01  1.07583598e+00  1.07583598e+00
  1.07583598e+00  4.15486970e+00  5.64177161e+00  5.64177161e+00
  5.64177161e+00  1.28974377e+01  2.39548017e+01  2.39548017e+01
  2.39548017e+01  4.19753233e+01  1.18755057e+02  1.18755057e+02
  1.18755057e+02  1.46122379e+02  5.09572499e+02  1.87646782e+03
  8.00536793e+03  4.77720685e+04]
E1 = -182.8426797528366  E_coul = 54.31126095104426
cycle= 2 E= -128.531418801792  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229972
diis-c [-6.28250867e-04  3.32001720e-01  6.67998280e-01]
  HOMO = -0.845275099794865  LUMO = 0.803566653807118
  mo_energy =
[-3.27690379e+01 -1.92706667e+00 -8.45275100e-01 -8.45275100e-01
 -8.45275100e-01  8.03566654e-01  1.08831784e+00  1.08831784e+00
  1.08831784e+00  4.17847794e+00  5.68368875e+00  5.68368875e+00
  5.68368875e+00  1.29436791e+01  2.40323722e+01  2.40323722e+01
  2.40323722e+01  4.20549921e+01  1.18860141e+02  1.18860141e+02
  1.18860141e+02  1.46224984e+02  5.09686048e+02  1.87658665e+03
  8.00548921e+03  4.77721907e+04]
E1 = -182.59705716528217  E_coul = 54.06479052171623
cycle= 3 E= -128.532266643566  delta_E= -0.000848  |g|= 0.000485  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000978023
diis-c [-1.60870070e-07 -2.22188647e-03 -5.69633252e-04  1.00279152e+00]
  HOMO = -0.845517977760167  LUMO = 0.803528034991408
  mo_energy =
[-3.27694708e+01 -1.92724526e+00 -8.45517978e-01 -8.45517978e-01
 -8.45517978e-01  8.03528035e-01  1.08826376e+00  1.08826376e+00
  1.08826376e+00  4.17835137e+00  5.68347507e+00  5.68347507e+00
  5.68347507e+00  1.29434470e+01  2.40320312e+01  2.40320312e+01
  2.40320312e+01  4.20546519e+01  1.18859696e+02  1.18859696e+02
  1.18859696e+02  1.46224553e+02  5.09685511e+02  1.87658600e+03
  8.00548847e+03  4.77721899e+04]
E1 = -182.59760056163145  E_coul = 54.0653338960163
cycle= 4 E= -128.532266665615  delta_E= -2.2e-08  |g|= 6.36e-05  |ddm|= 0.000367
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013232
diis-c [-9.88755336e-10  3.26988316e-04  3.95574999e-04 -2.14187266e-01
  1.21346470e+00]
  HOMO = -0.845550253767636  LUMO = 0.803521212659013
  mo_energy =
[-3.27695231e+01 -1.92726500e+00 -8.45550254e-01 -8.45550254e-01
 -8.45550254e-01  8.03521213e-01  1.08825015e+00  1.08825015e+00
  1.08825015e+00  4.17833089e+00  5.68343942e+00  5.68343942e+00
  5.68343942e+00  1.29434116e+01  2.40319839e+01  2.40319839e+01
  2.40319839e+01  4.20546052e+01  1.18859643e+02  1.18859643e+02
  1.18859643e+02  1.46224500e+02  5.09685451e+02  1.87658593e+03
  8.00548840e+03  4.77721898e+04]
E1 = -182.5977027839179  E_coul = 54.06543611775841
cycle= 5 E= -128.53226666616  delta_E= -5.44e-10  |g|= 6.74e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5977027839179  E_coul = 54.06543611775841
  HOMO = -0.8455465405711  LUMO = 0.803522683584537
  mo_energy =
[-3.27695151e+01 -1.92726058e+00 -8.45546541e-01 -8.45546541e-01
 -8.45546541e-01  8.03522684e-01  1.08825171e+00  1.08825171e+00
  1.08825171e+00  4.17833406e+00  5.68344392e+00  5.68344392e+00
  5.68344392e+00  1.29434167e+01  2.40319908e+01  2.40319908e+01
  2.40319908e+01  4.20546123e+01  1.18859651e+02  1.18859651e+02
  1.18859651e+02  1.46224508e+02  5.09685459e+02  1.87658594e+03
  8.00548840e+03  4.77721898e+04]
E1 = -182.59768504812996  E_coul = 54.065418381967774
Extra cycle  E= -128.532266666162  delta_E= -2.67e-12  |g|= 2.48e-06  |ddm|= 2.65e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.32833464e-01 2.44137941e+04 3.66145449e+03 8.33270678e+02
 2.35739389e+02 7.64027323e+01 1.03115358e+01 2.70780732e+01
 3.19619042e-01 1.93239562e+00 2.97245813e+00 3.68100267e+00
 1.24422397e+01 5.47853914e+01 3.29844971e-01 1.14299533e+00]
E = -128.53226666616217
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.832833463599       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448812        1
[INPUT] 0    0    [1    /1   ]  833.27067824         1
[INPUT] 0    0    [1    /1   ]  235.739389149        1
[INPUT] 0    0    [1    /1   ]  76.4027323126        1
[INPUT] 0    0    [1    /1   ]  10.3115358262        1
[INPUT] 0    0    [1    /1   ]  27.0780732446        1
[INPUT] 0    0    [1    /1   ]  0.319619041772       1
[INPUT] 0    0    [1    /1   ]  1.93239561814        1
[INPUT] 0    0    [1    /1   ]  2.97245812621        1
[INPUT] 1    0    [1    /1   ]  3.68100266958        1
[INPUT] 1    0    [1    /1   ]  12.4422397153        1
[INPUT] 1    0    [1    /1   ]  54.7853914379        1
[INPUT] 1    0    [1    /1   ]  0.329844970579       1
[INPUT] 1    0    [1    /1   ]  1.14299532683        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8328334635992308, 1.0]], [0, [24413.7941296447, 1.0]], [0, [3661.4544881227202, 1.0]], [0, [833.2706782400834, 1.0]], [0, [235.73938914860258, 1.0]], [0, [76.40273231259214, 1.0]], [0, [10.311535826163473, 1.0]], [0, [27.0780732445818, 1.0]], [0, [0.3196190417715929, 1.0]], [0, [1.9323956181350044, 1.0]], [0, [2.9724581262108427, 1.0]], [1, [3.6810026695774956, 1.0]], [1, [12.442239715295262, 1.0]], [1, [54.785391437943915, 1.0]], [1, [0.32984497057883605, 1.0]], [1, [1.1429953268315642, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83283346]
bas 1, expnt(s) = [24413.79412964]
bas 2, expnt(s) = [3661.45448812]
bas 3, expnt(s) = [833.27067824]
bas 4, expnt(s) = [235.73938915]
bas 5, expnt(s) = [76.40273231]
bas 6, expnt(s) = [10.31153583]
bas 7, expnt(s) = [27.07807324]
bas 8, expnt(s) = [0.31961904]
bas 9, expnt(s) = [1.93239562]
bas 10, expnt(s) = [2.97245813]
bas 11, expnt(s) = [3.68100267]
bas 12, expnt(s) = [12.44223972]
bas 13, expnt(s) = [54.78539144]
bas 14, expnt(s) = [0.32984497]
bas 15, expnt(s) = [1.14299533]
CPU time:       112.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.32833464e-01 2.20258993e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270678e+02 3.91836239e+02
 2.35739389e+02 1.51998443e+02 7.64027323e+01 6.52900035e+01
 1.03115358e+01 1.45380963e+01 2.70780732e+01 2.99901296e+01
 3.19619042e-01 1.07396347e+00 1.93239562e+00 4.14082672e+00
 2.97245813e+00 5.71941794e+00 3.68100267e+00 1.48744891e+01
 1.24422397e+01 6.81722453e+01 5.47853914e+01 4.34825849e+02
 3.29844971e-01 7.29242087e-01 1.14299533e+00 3.44778329e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998492892363677
cond(S) = 2982.5614474641466
E1 = -183.5776881793077  E_coul = 55.07850251261417
init E= -128.499185666694
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945078093115  LUMO = 0.822127666381019
  mo_energy =
[-3.25553695e+01 -1.85289688e+00 -7.73945078e-01 -7.73945078e-01
 -7.73945078e-01  8.22127666e-01  1.11401740e+00  1.11401740e+00
  1.11401740e+00  4.22804870e+00  5.77066139e+00  5.77066139e+00
  5.77066139e+00  1.30392066e+01  2.41897859e+01  2.41897859e+01
  2.41897859e+01  4.22160358e+01  1.19076057e+02  1.19076057e+02
  1.19076057e+02  1.46434421e+02  5.09929558e+02  1.87686127e+03
  8.00579054e+03  4.77725100e+04]
E1 = -182.1103856645706  E_coul = 53.5814732717856
cycle= 1 E= -128.528912392785  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460637
diis-c [-0.21218612  1.        ]
  HOMO = -0.879648194442498  LUMO = 0.79461347808767
  mo_energy =
[-3.28740930e+01 -1.96320549e+00 -8.79648194e-01 -8.79648194e-01
 -8.79648194e-01  7.94613478e-01  1.07583598e+00  1.07583598e+00
  1.07583598e+00  4.15486970e+00  5.64177161e+00  5.64177161e+00
  5.64177161e+00  1.28974377e+01  2.39548017e+01  2.39548017e+01
  2.39548017e+01  4.19753233e+01  1.18755057e+02  1.18755057e+02
  1.18755057e+02  1.46122379e+02  5.09572499e+02  1.87646782e+03
  8.00536793e+03  4.77720685e+04]
E1 = -182.8426797528366  E_coul = 54.31126095104426
cycle= 2 E= -128.531418801792  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229972
diis-c [-6.28250867e-04  3.32001720e-01  6.67998280e-01]
  HOMO = -0.845275099794865  LUMO = 0.803566653807118
  mo_energy =
[-3.27690379e+01 -1.92706667e+00 -8.45275100e-01 -8.45275100e-01
 -8.45275100e-01  8.03566654e-01  1.08831784e+00  1.08831784e+00
  1.08831784e+00  4.17847794e+00  5.68368875e+00  5.68368875e+00
  5.68368875e+00  1.29436791e+01  2.40323722e+01  2.40323722e+01
  2.40323722e+01  4.20549921e+01  1.18860141e+02  1.18860141e+02
  1.18860141e+02  1.46224984e+02  5.09686048e+02  1.87658665e+03
  8.00548921e+03  4.77721907e+04]
E1 = -182.59705716528217  E_coul = 54.06479052171623
cycle= 3 E= -128.532266643566  delta_E= -0.000848  |g|= 0.000485  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000978023
diis-c [-1.60870070e-07 -2.22188647e-03 -5.69633252e-04  1.00279152e+00]
  HOMO = -0.845517977760167  LUMO = 0.803528034991408
  mo_energy =
[-3.27694708e+01 -1.92724526e+00 -8.45517978e-01 -8.45517978e-01
 -8.45517978e-01  8.03528035e-01  1.08826376e+00  1.08826376e+00
  1.08826376e+00  4.17835137e+00  5.68347507e+00  5.68347507e+00
  5.68347507e+00  1.29434470e+01  2.40320312e+01  2.40320312e+01
  2.40320312e+01  4.20546519e+01  1.18859696e+02  1.18859696e+02
  1.18859696e+02  1.46224553e+02  5.09685511e+02  1.87658600e+03
  8.00548847e+03  4.77721899e+04]
E1 = -182.59760056163145  E_coul = 54.0653338960163
cycle= 4 E= -128.532266665615  delta_E= -2.2e-08  |g|= 6.36e-05  |ddm|= 0.000367
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013232
diis-c [-9.88755336e-10  3.26988316e-04  3.95574999e-04 -2.14187266e-01
  1.21346470e+00]
  HOMO = -0.845550253767636  LUMO = 0.803521212659013
  mo_energy =
[-3.27695231e+01 -1.92726500e+00 -8.45550254e-01 -8.45550254e-01
 -8.45550254e-01  8.03521213e-01  1.08825015e+00  1.08825015e+00
  1.08825015e+00  4.17833089e+00  5.68343942e+00  5.68343942e+00
  5.68343942e+00  1.29434116e+01  2.40319839e+01  2.40319839e+01
  2.40319839e+01  4.20546052e+01  1.18859643e+02  1.18859643e+02
  1.18859643e+02  1.46224500e+02  5.09685451e+02  1.87658593e+03
  8.00548840e+03  4.77721898e+04]
E1 = -182.5977027839179  E_coul = 54.06543611775841
cycle= 5 E= -128.53226666616  delta_E= -5.44e-10  |g|= 6.74e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5977027839179  E_coul = 54.06543611775841
  HOMO = -0.8455465405711  LUMO = 0.803522683584537
  mo_energy =
[-3.27695151e+01 -1.92726058e+00 -8.45546541e-01 -8.45546541e-01
 -8.45546541e-01  8.03522684e-01  1.08825171e+00  1.08825171e+00
  1.08825171e+00  4.17833406e+00  5.68344392e+00  5.68344392e+00
  5.68344392e+00  1.29434167e+01  2.40319908e+01  2.40319908e+01
  2.40319908e+01  4.20546123e+01  1.18859651e+02  1.18859651e+02
  1.18859651e+02  1.46224508e+02  5.09685459e+02  1.87658594e+03
  8.00548840e+03  4.77721898e+04]
E1 = -182.59768504812996  E_coul = 54.065418381967774
Extra cycle  E= -128.532266666162  delta_E= -2.67e-12  |g|= 2.48e-06  |ddm|= 2.65e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2982.5614474641466
E1 = -182.59768504812996  E_coul = 54.065418381967774
init E= -128.532266666162
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845547779798533  LUMO = 0.803522428905042
  mo_energy =
[-3.27695190e+01 -1.92726177e+00 -8.45547780e-01 -8.45547780e-01
 -8.45547780e-01  8.03522429e-01  1.08825128e+00  1.08825128e+00
  1.08825128e+00  4.17833329e+00  5.68344241e+00  5.68344241e+00
  5.68344241e+00  1.29434151e+01  2.40319879e+01  2.40319879e+01
  2.40319879e+01  4.20546094e+01  1.18859647e+02  1.18859647e+02
  1.18859647e+02  1.46224504e+02  5.09685454e+02  1.87658594e+03
  8.00548840e+03  4.77721898e+04]
E1 = -182.59769461713998  E_coul = 54.065427950977586
cycle= 1 E= -128.532266666162  delta_E= -2.27e-13  |g|= 1.31e-06  |ddm|= 9.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59769461713998  E_coul = 54.065427950977586
  HOMO = -0.845547106882778  LUMO = 0.803522615916748
  mo_energy =
[-3.27695170e+01 -1.92726104e+00 -8.45547107e-01 -8.45547107e-01
 -8.45547107e-01  8.03522616e-01  1.08825152e+00  1.08825152e+00
  1.08825152e+00  4.17833377e+00  5.68344324e+00  5.68344324e+00
  5.68344324e+00  1.29434160e+01  2.40319895e+01  2.40319895e+01
  2.40319895e+01  4.20546109e+01  1.18859649e+02  1.18859649e+02
  1.18859649e+02  1.46224506e+02  5.09685457e+02  1.87658594e+03
  8.00548840e+03  4.77721898e+04]
E1 = -182.59768986363719  E_coul = 54.06542319747442
Extra cycle  E= -128.532266666163  delta_E= -3.69e-13  |g|= 6.47e-07  |ddm|= 4.48e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.32833464e-01 2.44137941e+04 3.66145449e+03 8.33270678e+02
 2.35739389e+02 7.64027323e+01 1.03115358e+01 2.70780732e+01
 3.19619042e-01 1.93239562e+00 2.97245813e+00 3.68100267e+00
 1.24422397e+01 5.47853914e+01 3.29844971e-01 1.14299533e+00]
grad_E = [ 4.84030192e-05  6.54803394e-10 -3.43958009e-08  7.07908163e-07
 -8.71881978e-06  6.69256886e-05  1.05686078e-05 -2.21275130e-04
  2.30469135e-05  4.56305818e-06 -1.03241327e-04 -1.40706990e-04
  1.19358424e-05  9.20977197e-07 -9.03932274e-04  5.10319773e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.831216314964       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448835        1
[INPUT] 0    0    [1    /1   ]  833.270673662        1
[INPUT] 0    0    [1    /1   ]  235.739444684        1
[INPUT] 0    0    [1    /1   ]  76.4022625875        1
[INPUT] 0    0    [1    /1   ]  10.3078296674        1
[INPUT] 0    0    [1    /1   ]  27.0803952196        1
[INPUT] 0    0    [1    /1   ]  0.319246648995       1
[INPUT] 0    0    [1    /1   ]  1.925375814          1
[INPUT] 0    0    [1    /1   ]  2.97294796211        1
[INPUT] 1    0    [1    /1   ]  3.68169557863        1
[INPUT] 1    0    [1    /1   ]  12.4420868648        1
[INPUT] 1    0    [1    /1   ]  54.7853924677        1
[INPUT] 1    0    [1    /1   ]  0.329902236477       1
[INPUT] 1    0    [1    /1   ]  1.14353687251        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.831216314964176, 1.0]], [0, [24413.794129640384, 1.0]], [0, [3661.4544883495196, 1.0]], [0, [833.2706736621999, 1.0]], [0, [235.7394446844381, 1.0]], [0, [76.40226258753646, 1.0]], [0, [10.307829667409877, 1.0]], [0, [27.080395219641765, 1.0]], [0, [0.3192466489947855, 1.0]], [0, [1.9253758140027433, 1.0]], [0, [2.9729479621148234, 1.0]], [1, [3.681695578626132, 1.0]], [1, [12.442086864815021, 1.0]], [1, [54.78539246771722, 1.0]], [1, [0.3299022364770006, 1.0]], [1, [1.1435368725056407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83121631]
bas 1, expnt(s) = [24413.79412964]
bas 2, expnt(s) = [3661.45448835]
bas 3, expnt(s) = [833.27067366]
bas 4, expnt(s) = [235.73944468]
bas 5, expnt(s) = [76.40226259]
bas 6, expnt(s) = [10.30782967]
bas 7, expnt(s) = [27.08039522]
bas 8, expnt(s) = [0.31924665]
bas 9, expnt(s) = [1.92537581]
bas 10, expnt(s) = [2.97294796]
bas 11, expnt(s) = [3.68169558]
bas 12, expnt(s) = [12.44208686]
bas 13, expnt(s) = [54.78539247]
bas 14, expnt(s) = [0.32990224]
bas 15, expnt(s) = [1.14353687]
CPU time:       115.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.31216315e-01 2.19938150e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270674e+02 3.91836237e+02
 2.35739445e+02 1.51998470e+02 7.64022626e+01 6.52897024e+01
 1.03078297e+01 1.45341771e+01 2.70803952e+01 2.99920584e+01
 3.19246649e-01 1.07302486e+00 1.92537581e+00 4.12953982e+00
 2.97294796e+00 5.72012481e+00 3.68169558e+00 1.48779891e+01
 1.24420869e+01 6.81711984e+01 5.47853925e+01 4.34825859e+02
 3.29902236e-01 7.29400350e-01 1.14353687e+00 3.44982534e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99849066575926
cond(S) = 2937.478225707475
E1 = -183.57769655076072  E_coul = 55.078504558080084
init E= -128.499191992681
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944649126033  LUMO = 0.820380837425499
  mo_energy =
[-3.25553699e+01 -1.85289659e+00 -7.73944649e-01 -7.73944649e-01
 -7.73944649e-01  8.20380837e-01  1.11437311e+00  1.11437311e+00
  1.11437311e+00  4.21826606e+00  5.77281950e+00  5.77281950e+00
  5.77281950e+00  1.30140307e+01  2.41936619e+01  2.41936619e+01
  2.41936619e+01  4.21756519e+01  1.19079160e+02  1.19079160e+02
  1.19079160e+02  1.46392178e+02  5.09891621e+02  1.87682736e+03
  8.00576072e+03  4.77724853e+04]
E1 = -182.1102826198212  E_coul = 53.58136968356333
cycle= 1 E= -128.528912936258  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460638
diis-c [-0.21218711  1.        ]
  HOMO = -0.8796579530727  LUMO = 0.792925069489329
  mo_energy =
[-3.28741052e+01 -1.96321608e+00 -8.79657953e-01 -8.79657953e-01
 -8.79657953e-01  7.92925069e-01  1.07616828e+00  1.07616828e+00
  1.07616828e+00  4.14520598e+00  5.64389255e+00  5.64389255e+00
  5.64389255e+00  1.28723504e+01  2.39586676e+01  2.39586676e+01
  2.39586676e+01  4.19349384e+01  1.18758148e+02  1.18758148e+02
  1.18758148e+02  1.46080117e+02  5.09534547e+02  1.87643390e+03
  8.00533810e+03  4.77720438e+04]
E1 = -182.84256756709857  E_coul = 54.31114827531297
cycle= 2 E= -128.531419291786  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229972
diis-c [-6.28095342e-04  3.32001353e-01  6.67998647e-01]
  HOMO = -0.845285485744723  LUMO = 0.801856983538846
  mo_energy =
[-3.27690504e+01 -1.92707801e+00 -8.45285486e-01 -8.45285486e-01
 -8.45285486e-01  8.01856984e-01  1.08865553e+00  1.08865553e+00
  1.08865553e+00  4.16877145e+00  5.68581712e+00  5.68581712e+00
  5.68581712e+00  1.29185578e+01  2.40362371e+01  2.40362371e+01
  2.40362371e+01  4.20146037e+01  1.18863231e+02  1.18863231e+02
  1.18863231e+02  1.46182724e+02  5.09648097e+02  1.87655273e+03
  8.00545938e+03  4.77721660e+04]
E1 = -182.59693377715027  E_coul = 54.06466660615834
cycle= 3 E= -128.532267170992  delta_E= -0.000848  |g|= 0.000487  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000980693
diis-c [-1.60771233e-07 -2.22543917e-03 -5.63657702e-04  1.00278910e+00]
  HOMO = -0.845529378079917  LUMO = 0.801817958717995
  mo_energy =
[-3.27694847e+01 -1.92725778e+00 -8.45529378e-01 -8.45529378e-01
 -8.45529378e-01  8.01817959e-01  1.08860092e+00  1.08860092e+00
  1.08860092e+00  4.16864416e+00  5.68560220e+00  5.68560220e+00
  5.68560220e+00  1.29183246e+01  2.40358947e+01  2.40358947e+01
  2.40358947e+01  4.20142620e+01  1.18862785e+02  1.18862785e+02
  1.18862785e+02  1.46182292e+02  5.09647559e+02  1.87655208e+03
  8.00545864e+03  4.77721652e+04]
E1 = -182.5974792837878  E_coul = 54.06521209064525
cycle= 4 E= -128.532267193143  delta_E= -2.22e-08  |g|= 6.37e-05  |ddm|= 0.000366
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132379
diis-c [-9.88028438e-10  3.26476428e-04  3.94123067e-04 -2.13752325e-01
  1.21303173e+00]
  HOMO = -0.845561734031193  LUMO = 0.801811099577564
  mo_energy =
[-3.27695372e+01 -1.92727763e+00 -8.45561734e-01 -8.45561734e-01
 -8.45561734e-01  8.01811100e-01  1.08858727e+00  1.08858727e+00
  1.08858727e+00  4.16862362e+00  5.68556644e+00  5.68556644e+00
  5.68556644e+00  1.29182891e+01  2.40358473e+01  2.40358473e+01
  2.40358473e+01  4.20142152e+01  1.18862732e+02  1.18862732e+02
  1.18862732e+02  1.46182240e+02  5.09647499e+02  1.87655201e+03
  8.00545857e+03  4.77721651e+04]
E1 = -182.59758157455843  E_coul = 54.065314380871584
cycle= 5 E= -128.532267193687  delta_E= -5.44e-10  |g|= 6.74e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59758157455843  E_coul = 54.065314380871584
  HOMO = -0.845558024703807  LUMO = 0.801812567842234
  mo_energy =
[-3.27695291e+01 -1.92727321e+00 -8.45558025e-01 -8.45558025e-01
 -8.45558025e-01  8.01812568e-01  1.08858882e+00  1.08858882e+00
  1.08858882e+00  4.16862679e+00  5.68557095e+00  5.68557095e+00
  5.68557095e+00  1.29182942e+01  2.40358542e+01  2.40358542e+01
  2.40358542e+01  4.20142223e+01  1.18862740e+02  1.18862740e+02
  1.18862740e+02  1.46182247e+02  5.09647506e+02  1.87655202e+03
  8.00545857e+03  4.77721652e+04]
E1 = -182.59756386760557  E_coul = 54.06529667391563
Extra cycle  E= -128.53226719369  delta_E= -3.1e-12  |g|= 2.48e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.31216315e-01 2.44137941e+04 3.66145449e+03 8.33270674e+02
 2.35739445e+02 7.64022626e+01 1.03078297e+01 2.70803952e+01
 3.19246649e-01 1.92537581e+00 2.97294796e+00 3.68169558e+00
 1.24420869e+01 5.47853925e+01 3.29902236e-01 1.14353687e+00]
E = -128.53226719368993
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.831216314964       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448835        1
[INPUT] 0    0    [1    /1   ]  833.270673662        1
[INPUT] 0    0    [1    /1   ]  235.739444684        1
[INPUT] 0    0    [1    /1   ]  76.4022625875        1
[INPUT] 0    0    [1    /1   ]  10.3078296674        1
[INPUT] 0    0    [1    /1   ]  27.0803952196        1
[INPUT] 0    0    [1    /1   ]  0.319246648995       1
[INPUT] 0    0    [1    /1   ]  1.925375814          1
[INPUT] 0    0    [1    /1   ]  2.97294796211        1
[INPUT] 1    0    [1    /1   ]  3.68169557863        1
[INPUT] 1    0    [1    /1   ]  12.4420868648        1
[INPUT] 1    0    [1    /1   ]  54.7853924677        1
[INPUT] 1    0    [1    /1   ]  0.329902236477       1
[INPUT] 1    0    [1    /1   ]  1.14353687251        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.831216314964176, 1.0]], [0, [24413.794129640384, 1.0]], [0, [3661.4544883495196, 1.0]], [0, [833.2706736621999, 1.0]], [0, [235.7394446844381, 1.0]], [0, [76.40226258753646, 1.0]], [0, [10.307829667409877, 1.0]], [0, [27.080395219641765, 1.0]], [0, [0.3192466489947855, 1.0]], [0, [1.9253758140027433, 1.0]], [0, [2.9729479621148234, 1.0]], [1, [3.681695578626132, 1.0]], [1, [12.442086864815021, 1.0]], [1, [54.78539246771722, 1.0]], [1, [0.3299022364770006, 1.0]], [1, [1.1435368725056407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83121631]
bas 1, expnt(s) = [24413.79412964]
bas 2, expnt(s) = [3661.45448835]
bas 3, expnt(s) = [833.27067366]
bas 4, expnt(s) = [235.73944468]
bas 5, expnt(s) = [76.40226259]
bas 6, expnt(s) = [10.30782967]
bas 7, expnt(s) = [27.08039522]
bas 8, expnt(s) = [0.31924665]
bas 9, expnt(s) = [1.92537581]
bas 10, expnt(s) = [2.97294796]
bas 11, expnt(s) = [3.68169558]
bas 12, expnt(s) = [12.44208686]
bas 13, expnt(s) = [54.78539247]
bas 14, expnt(s) = [0.32990224]
bas 15, expnt(s) = [1.14353687]
CPU time:       115.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.31216315e-01 2.19938150e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270674e+02 3.91836237e+02
 2.35739445e+02 1.51998470e+02 7.64022626e+01 6.52897024e+01
 1.03078297e+01 1.45341771e+01 2.70803952e+01 2.99920584e+01
 3.19246649e-01 1.07302486e+00 1.92537581e+00 4.12953982e+00
 2.97294796e+00 5.72012481e+00 3.68169558e+00 1.48779891e+01
 1.24420869e+01 6.81711984e+01 5.47853925e+01 4.34825859e+02
 3.29902236e-01 7.29400350e-01 1.14353687e+00 3.44982534e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99849066575926
cond(S) = 2937.478225707475
E1 = -183.57769655076072  E_coul = 55.078504558080084
init E= -128.499191992681
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944649126033  LUMO = 0.820380837425499
  mo_energy =
[-3.25553699e+01 -1.85289659e+00 -7.73944649e-01 -7.73944649e-01
 -7.73944649e-01  8.20380837e-01  1.11437311e+00  1.11437311e+00
  1.11437311e+00  4.21826606e+00  5.77281950e+00  5.77281950e+00
  5.77281950e+00  1.30140307e+01  2.41936619e+01  2.41936619e+01
  2.41936619e+01  4.21756519e+01  1.19079160e+02  1.19079160e+02
  1.19079160e+02  1.46392178e+02  5.09891621e+02  1.87682736e+03
  8.00576072e+03  4.77724853e+04]
E1 = -182.1102826198212  E_coul = 53.58136968356333
cycle= 1 E= -128.528912936258  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460638
diis-c [-0.21218711  1.        ]
  HOMO = -0.8796579530727  LUMO = 0.792925069489329
  mo_energy =
[-3.28741052e+01 -1.96321608e+00 -8.79657953e-01 -8.79657953e-01
 -8.79657953e-01  7.92925069e-01  1.07616828e+00  1.07616828e+00
  1.07616828e+00  4.14520598e+00  5.64389255e+00  5.64389255e+00
  5.64389255e+00  1.28723504e+01  2.39586676e+01  2.39586676e+01
  2.39586676e+01  4.19349384e+01  1.18758148e+02  1.18758148e+02
  1.18758148e+02  1.46080117e+02  5.09534547e+02  1.87643390e+03
  8.00533810e+03  4.77720438e+04]
E1 = -182.84256756709857  E_coul = 54.31114827531297
cycle= 2 E= -128.531419291786  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229972
diis-c [-6.28095342e-04  3.32001353e-01  6.67998647e-01]
  HOMO = -0.845285485744723  LUMO = 0.801856983538846
  mo_energy =
[-3.27690504e+01 -1.92707801e+00 -8.45285486e-01 -8.45285486e-01
 -8.45285486e-01  8.01856984e-01  1.08865553e+00  1.08865553e+00
  1.08865553e+00  4.16877145e+00  5.68581712e+00  5.68581712e+00
  5.68581712e+00  1.29185578e+01  2.40362371e+01  2.40362371e+01
  2.40362371e+01  4.20146037e+01  1.18863231e+02  1.18863231e+02
  1.18863231e+02  1.46182724e+02  5.09648097e+02  1.87655273e+03
  8.00545938e+03  4.77721660e+04]
E1 = -182.59693377715027  E_coul = 54.06466660615834
cycle= 3 E= -128.532267170992  delta_E= -0.000848  |g|= 0.000487  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000980693
diis-c [-1.60771233e-07 -2.22543917e-03 -5.63657702e-04  1.00278910e+00]
  HOMO = -0.845529378079917  LUMO = 0.801817958717995
  mo_energy =
[-3.27694847e+01 -1.92725778e+00 -8.45529378e-01 -8.45529378e-01
 -8.45529378e-01  8.01817959e-01  1.08860092e+00  1.08860092e+00
  1.08860092e+00  4.16864416e+00  5.68560220e+00  5.68560220e+00
  5.68560220e+00  1.29183246e+01  2.40358947e+01  2.40358947e+01
  2.40358947e+01  4.20142620e+01  1.18862785e+02  1.18862785e+02
  1.18862785e+02  1.46182292e+02  5.09647559e+02  1.87655208e+03
  8.00545864e+03  4.77721652e+04]
E1 = -182.5974792837878  E_coul = 54.06521209064525
cycle= 4 E= -128.532267193143  delta_E= -2.22e-08  |g|= 6.37e-05  |ddm|= 0.000366
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132379
diis-c [-9.88028438e-10  3.26476428e-04  3.94123067e-04 -2.13752325e-01
  1.21303173e+00]
  HOMO = -0.845561734031193  LUMO = 0.801811099577564
  mo_energy =
[-3.27695372e+01 -1.92727763e+00 -8.45561734e-01 -8.45561734e-01
 -8.45561734e-01  8.01811100e-01  1.08858727e+00  1.08858727e+00
  1.08858727e+00  4.16862362e+00  5.68556644e+00  5.68556644e+00
  5.68556644e+00  1.29182891e+01  2.40358473e+01  2.40358473e+01
  2.40358473e+01  4.20142152e+01  1.18862732e+02  1.18862732e+02
  1.18862732e+02  1.46182240e+02  5.09647499e+02  1.87655201e+03
  8.00545857e+03  4.77721651e+04]
E1 = -182.59758157455843  E_coul = 54.065314380871584
cycle= 5 E= -128.532267193687  delta_E= -5.44e-10  |g|= 6.74e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59758157455843  E_coul = 54.065314380871584
  HOMO = -0.845558024703807  LUMO = 0.801812567842234
  mo_energy =
[-3.27695291e+01 -1.92727321e+00 -8.45558025e-01 -8.45558025e-01
 -8.45558025e-01  8.01812568e-01  1.08858882e+00  1.08858882e+00
  1.08858882e+00  4.16862679e+00  5.68557095e+00  5.68557095e+00
  5.68557095e+00  1.29182942e+01  2.40358542e+01  2.40358542e+01
  2.40358542e+01  4.20142223e+01  1.18862740e+02  1.18862740e+02
  1.18862740e+02  1.46182247e+02  5.09647506e+02  1.87655202e+03
  8.00545857e+03  4.77721652e+04]
E1 = -182.59756386760557  E_coul = 54.06529667391563
Extra cycle  E= -128.53226719369  delta_E= -3.1e-12  |g|= 2.48e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2937.478225707475
E1 = -182.59756386760557  E_coul = 54.06529667391563
init E= -128.53226719369
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845559262025833  LUMO = 0.801812314555584
  mo_energy =
[-3.27695331e+01 -1.92727440e+00 -8.45559262e-01 -8.45559262e-01
 -8.45559262e-01  8.01812315e-01  1.08858839e+00  1.08858839e+00
  1.08858839e+00  4.16862602e+00  5.68556944e+00  5.68556944e+00
  5.68556944e+00  1.29182925e+01  2.40358513e+01  2.40358513e+01
  2.40358513e+01  4.20142194e+01  1.18862736e+02  1.18862736e+02
  1.18862736e+02  1.46182243e+02  5.09647502e+02  1.87655202e+03
  8.00545857e+03  4.77721651e+04]
E1 = -182.59757342280062  E_coul = 54.06530622911041
cycle= 1 E= -128.53226719369  delta_E= -2.84e-13  |g|= 1.31e-06  |ddm|= 9.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59757342280062  E_coul = 54.06530622911041
  HOMO = -0.84555859011219  LUMO = 0.80181250093298
  mo_energy =
[-3.27695310e+01 -1.92727367e+00 -8.45558590e-01 -8.45558590e-01
 -8.45558590e-01  8.01812501e-01  1.08858864e+00  1.08858864e+00
  1.08858864e+00  4.16862650e+00  5.68557026e+00  5.68557026e+00
  5.68557026e+00  1.29182935e+01  2.40358528e+01  2.40358528e+01
  2.40358528e+01  4.20142209e+01  1.18862738e+02  1.18862738e+02
  1.18862738e+02  1.46182245e+02  5.09647504e+02  1.87655202e+03
  8.00545857e+03  4.77721652e+04]
E1 = -182.59756867615098  E_coul = 54.06530148246054
Extra cycle  E= -128.53226719369  delta_E= -2.27e-13  |g|= 6.46e-07  |ddm|= 4.47e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [8.31216315e-01 2.44137941e+04 3.66145449e+03 8.33270674e+02
 2.35739445e+02 7.64022626e+01 1.03078297e+01 2.70803952e+01
 3.19246649e-01 1.92537581e+00 2.97294796e+00 3.68169558e+00
 1.24420869e+01 5.47853925e+01 3.29902236e-01 1.14353687e+00]
grad_E = [ 4.89098679e-05  6.20621230e-10 -3.26092632e-08  6.72203126e-07
 -8.31040320e-06  6.40125582e-05 -4.60727824e-06 -2.10525805e-04
  1.85177089e-05  6.24942065e-06 -1.01850189e-04 -2.11501753e-04
  1.24692667e-05  1.04765626e-06 -1.55537460e-03  9.11524915e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.829907818526       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448974        1
[INPUT] 0    0    [1    /1   ]  833.270645139        1
[INPUT] 0    0    [1    /1   ]  235.739794842        1
[INPUT] 0    0    [1    /1   ]  76.3995366033        1
[INPUT] 0    0    [1    /1   ]  10.3041636045        1
[INPUT] 0    0    [1    /1   ]  27.0901142539        1
[INPUT] 0    0    [1    /1   ]  0.318962292934       1
[INPUT] 0    0    [1    /1   ]  1.91598732209        1
[INPUT] 0    0    [1    /1   ]  2.97788682966        1
[INPUT] 1    0    [1    /1   ]  3.68313094075        1
[INPUT] 1    0    [1    /1   ]  12.441832739         1
[INPUT] 1    0    [1    /1   ]  54.785354239         1
[INPUT] 1    0    [1    /1   ]  0.330032257178       1
[INPUT] 1    0    [1    /1   ]  1.14466481843        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8299078185258483, 1.0]], [0, [24413.794129613914, 1.0]], [0, [3661.4544897399965, 1.0]], [0, [833.2706451387801, 1.0]], [0, [235.739794841839, 1.0]], [0, [76.39953660330349, 1.0]], [0, [10.304163604524286, 1.0]], [0, [27.090114253916205, 1.0]], [0, [0.31896229293422795, 1.0]], [0, [1.9159873220932975, 1.0]], [0, [2.9778868296636327, 1.0]], [1, [3.6831309407495545, 1.0]], [1, [12.44183273901455, 1.0]], [1, [54.78535423900034, 1.0]], [1, [0.33003225717800505, 1.0]], [1, [1.1446648184296395, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82990782]
bas 1, expnt(s) = [24413.79412961]
bas 2, expnt(s) = [3661.45448974]
bas 3, expnt(s) = [833.27064514]
bas 4, expnt(s) = [235.73979484]
bas 5, expnt(s) = [76.3995366]
bas 6, expnt(s) = [10.3041636]
bas 7, expnt(s) = [27.09011425]
bas 8, expnt(s) = [0.31896229]
bas 9, expnt(s) = [1.91598732]
bas 10, expnt(s) = [2.97788683]
bas 11, expnt(s) = [3.68313094]
bas 12, expnt(s) = [12.44183274]
bas 13, expnt(s) = [54.78535424]
bas 14, expnt(s) = [0.33003226]
bas 15, expnt(s) = [1.14466482]
CPU time:       119.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.29907819e-01 2.19678430e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270645e+02 3.91836227e+02
 2.35739795e+02 1.51998639e+02 7.63995366e+01 6.52879553e+01
 1.03041636e+01 1.45303001e+01 2.70901143e+01 3.00001310e+01
 3.18962293e-01 1.07230797e+00 1.91598732e+00 4.11442829e+00
 2.97788683e+00 5.72725033e+00 3.68313094e+00 1.48852400e+01
 1.24418327e+01 6.81694580e+01 5.47853542e+01 4.34825480e+02
 3.30032257e-01 7.29759705e-01 1.14466482e+00 3.45407936e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998485711886008
cond(S) = 2869.409434370503
E1 = -183.57772144009837  E_coul = 55.078511182316944
init E= -128.499210257781
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943511786214  LUMO = 0.818911146503276
  mo_energy =
[-3.25553708e+01 -1.85289571e+00 -7.73943512e-01 -7.73943512e-01
 -7.73943512e-01  8.18911147e-01  1.11514633e+00  1.11514633e+00
  1.11514633e+00  4.20902544e+00  5.77734759e+00  5.77734759e+00
  5.77734759e+00  1.29918320e+01  2.42018127e+01  2.42018127e+01
  2.42018127e+01  4.21466521e+01  1.19085760e+02  1.19085760e+02
  1.19085760e+02  1.46374894e+02  5.09883864e+02  1.87682172e+03
  8.00575602e+03  4.77724815e+04]
E1 = -182.11010860013647  E_coul = 53.58119365108834
cycle= 1 E= -128.528914949048  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460633
diis-c [-0.21218265  1.        ]
  HOMO = -0.879675050559569  LUMO = 0.791500463565093
  mo_energy =
[-3.28741243e+01 -1.96323460e+00 -8.79675051e-01 -8.79675051e-01
 -8.79675051e-01  7.91500464e-01  1.07689327e+00  1.07689327e+00
  1.07689327e+00  4.13607014e+00  5.64834738e+00  5.64834738e+00
  5.64834738e+00  1.28502034e+01  2.39668022e+01  2.39668022e+01
  2.39668022e+01  4.19059129e+01  1.18764730e+02  1.18764730e+02
  1.18764730e+02  1.46062804e+02  5.09526769e+02  1.87642824e+03
  8.00533338e+03  4.77720400e+04]
E1 = -182.84235537960896  E_coul = 54.3109342639426
cycle= 2 E= -128.531421115666  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229966
diis-c [-6.28020652e-04  3.31998153e-01  6.68001847e-01]
  HOMO = -0.845304720258326  LUMO = 0.800412744416307
  mo_energy =
[-3.27690722e+01 -1.92709893e+00 -8.45304720e-01 -8.45304720e-01
 -8.45304720e-01  8.00412744e-01  1.08939163e+00  1.08939163e+00
  1.08939163e+00  4.15959316e+00  5.69028633e+00  5.69028633e+00
  5.69028633e+00  1.28963844e+01  2.40443682e+01  2.40443682e+01
  2.40443682e+01  4.19855785e+01  1.18869810e+02  1.18869810e+02
  1.18869810e+02  1.46165412e+02  5.09640316e+02  1.87654707e+03
  8.00545466e+03  4.77721621e+04]
E1 = -182.59670636662864  E_coul = 54.06443734163729
cycle= 3 E= -128.532269024991  delta_E= -0.000848  |g|= 0.00049  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000986359
diis-c [-1.60403045e-07 -2.23248562e-03 -5.49567942e-04  1.00278205e+00]
  HOMO = -0.845550699799559  LUMO = 0.800372782332078
  mo_energy =
[-3.27695096e+01 -1.92728109e+00 -8.45550700e-01 -8.45550700e-01
 -8.45550700e-01  8.00372782e-01  1.08933594e+00  1.08933594e+00
  1.08933594e+00  4.15946416e+00  5.69006886e+00  5.69006886e+00
  5.69006886e+00  1.28961486e+01  2.40440228e+01  2.40440228e+01
  2.40440228e+01  4.19852338e+01  1.18869361e+02  1.18869361e+02
  1.18869361e+02  1.46164977e+02  5.09639776e+02  1.87654642e+03
  8.00545392e+03  4.77721614e+04]
E1 = -182.597256410456  E_coul = 54.06498736309881
cycle= 4 E= -128.532269047357  delta_E= -2.24e-08  |g|= 6.39e-05  |ddm|= 0.000368
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132535
diis-c [-9.86978457e-10  3.25474686e-04  3.91278084e-04 -2.12869354e-01
  1.21215260e+00]
  HOMO = -0.845583222331745  LUMO = 0.800365831312909
  mo_energy =
[-3.27695623e+01 -1.92730119e+00 -8.45583222e-01 -8.45583222e-01
 -8.45583222e-01  8.00365831e-01  1.08932219e+00  1.08932219e+00
  1.08932219e+00  4.15944346e+00  5.69003289e+00  5.69003289e+00
  5.69003289e+00  1.28961128e+01  2.40439751e+01  2.40439751e+01
  2.40439751e+01  4.19851868e+01  1.18869307e+02  1.18869307e+02
  1.18869307e+02  1.46164924e+02  5.09639715e+02  1.87654635e+03
  8.00545385e+03  4.77721613e+04]
E1 = -182.5973589040593  E_coul = 54.065089856157336
cycle= 5 E= -128.532269047902  delta_E= -5.45e-10  |g|= 6.74e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5973589040593  E_coul = 54.065089856157336
  HOMO = -0.845579520179732  LUMO = 0.800367297819151
  mo_energy =
[-3.27695543e+01 -1.92729677e+00 -8.45579520e-01 -8.45579520e-01
 -8.45579520e-01  8.00367298e-01  1.08932375e+00  1.08932375e+00
  1.08932375e+00  4.15944663e+00  5.69003739e+00  5.69003739e+00
  5.69003739e+00  1.28961179e+01  2.40439820e+01  2.40439820e+01
  2.40439820e+01  4.19851938e+01  1.18869315e+02  1.18869315e+02
  1.18869315e+02  1.46164932e+02  5.09639723e+02  1.87654636e+03
  8.00545385e+03  4.77721613e+04]
E1 = -182.59734125341336  E_coul = 54.06507220550873
Extra cycle  E= -128.532269047905  delta_E= -2.67e-12  |g|= 2.47e-06  |ddm|= 2.62e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.29907819e-01 2.44137941e+04 3.66145449e+03 8.33270645e+02
 2.35739795e+02 7.63995366e+01 1.03041636e+01 2.70901143e+01
 3.18962293e-01 1.91598732e+00 2.97788683e+00 3.68313094e+00
 1.24418327e+01 5.47853542e+01 3.30032257e-01 1.14466482e+00]
E = -128.53226904790463
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.829907818526       1
[INPUT] 0    0    [1    /1   ]  24413.7941296        1
[INPUT] 0    0    [1    /1   ]  3661.45448974        1
[INPUT] 0    0    [1    /1   ]  833.270645139        1
[INPUT] 0    0    [1    /1   ]  235.739794842        1
[INPUT] 0    0    [1    /1   ]  76.3995366033        1
[INPUT] 0    0    [1    /1   ]  10.3041636045        1
[INPUT] 0    0    [1    /1   ]  27.0901142539        1
[INPUT] 0    0    [1    /1   ]  0.318962292934       1
[INPUT] 0    0    [1    /1   ]  1.91598732209        1
[INPUT] 0    0    [1    /1   ]  2.97788682966        1
[INPUT] 1    0    [1    /1   ]  3.68313094075        1
[INPUT] 1    0    [1    /1   ]  12.441832739         1
[INPUT] 1    0    [1    /1   ]  54.785354239         1
[INPUT] 1    0    [1    /1   ]  0.330032257178       1
[INPUT] 1    0    [1    /1   ]  1.14466481843        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8299078185258483, 1.0]], [0, [24413.794129613914, 1.0]], [0, [3661.4544897399965, 1.0]], [0, [833.2706451387801, 1.0]], [0, [235.739794841839, 1.0]], [0, [76.39953660330349, 1.0]], [0, [10.304163604524286, 1.0]], [0, [27.090114253916205, 1.0]], [0, [0.31896229293422795, 1.0]], [0, [1.9159873220932975, 1.0]], [0, [2.9778868296636327, 1.0]], [1, [3.6831309407495545, 1.0]], [1, [12.44183273901455, 1.0]], [1, [54.78535423900034, 1.0]], [1, [0.33003225717800505, 1.0]], [1, [1.1446648184296395, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82990782]
bas 1, expnt(s) = [24413.79412961]
bas 2, expnt(s) = [3661.45448974]
bas 3, expnt(s) = [833.27064514]
bas 4, expnt(s) = [235.73979484]
bas 5, expnt(s) = [76.3995366]
bas 6, expnt(s) = [10.3041636]
bas 7, expnt(s) = [27.09011425]
bas 8, expnt(s) = [0.31896229]
bas 9, expnt(s) = [1.91598732]
bas 10, expnt(s) = [2.97788683]
bas 11, expnt(s) = [3.68313094]
bas 12, expnt(s) = [12.44183274]
bas 13, expnt(s) = [54.78535424]
bas 14, expnt(s) = [0.33003226]
bas 15, expnt(s) = [1.14466482]
CPU time:       119.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.29907819e-01 2.19678430e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270645e+02 3.91836227e+02
 2.35739795e+02 1.51998639e+02 7.63995366e+01 6.52879553e+01
 1.03041636e+01 1.45303001e+01 2.70901143e+01 3.00001310e+01
 3.18962293e-01 1.07230797e+00 1.91598732e+00 4.11442829e+00
 2.97788683e+00 5.72725033e+00 3.68313094e+00 1.48852400e+01
 1.24418327e+01 6.81694580e+01 5.47853542e+01 4.34825480e+02
 3.30032257e-01 7.29759705e-01 1.14466482e+00 3.45407936e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998485711886008
cond(S) = 2869.409434370503
E1 = -183.57772144009837  E_coul = 55.078511182316944
init E= -128.499210257781
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943511786214  LUMO = 0.818911146503276
  mo_energy =
[-3.25553708e+01 -1.85289571e+00 -7.73943512e-01 -7.73943512e-01
 -7.73943512e-01  8.18911147e-01  1.11514633e+00  1.11514633e+00
  1.11514633e+00  4.20902544e+00  5.77734759e+00  5.77734759e+00
  5.77734759e+00  1.29918320e+01  2.42018127e+01  2.42018127e+01
  2.42018127e+01  4.21466521e+01  1.19085760e+02  1.19085760e+02
  1.19085760e+02  1.46374894e+02  5.09883864e+02  1.87682172e+03
  8.00575602e+03  4.77724815e+04]
E1 = -182.11010860013647  E_coul = 53.58119365108834
cycle= 1 E= -128.528914949048  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460633
diis-c [-0.21218265  1.        ]
  HOMO = -0.879675050559569  LUMO = 0.791500463565093
  mo_energy =
[-3.28741243e+01 -1.96323460e+00 -8.79675051e-01 -8.79675051e-01
 -8.79675051e-01  7.91500464e-01  1.07689327e+00  1.07689327e+00
  1.07689327e+00  4.13607014e+00  5.64834738e+00  5.64834738e+00
  5.64834738e+00  1.28502034e+01  2.39668022e+01  2.39668022e+01
  2.39668022e+01  4.19059129e+01  1.18764730e+02  1.18764730e+02
  1.18764730e+02  1.46062804e+02  5.09526769e+02  1.87642824e+03
  8.00533338e+03  4.77720400e+04]
E1 = -182.84235537960896  E_coul = 54.3109342639426
cycle= 2 E= -128.531421115666  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229966
diis-c [-6.28020652e-04  3.31998153e-01  6.68001847e-01]
  HOMO = -0.845304720258326  LUMO = 0.800412744416307
  mo_energy =
[-3.27690722e+01 -1.92709893e+00 -8.45304720e-01 -8.45304720e-01
 -8.45304720e-01  8.00412744e-01  1.08939163e+00  1.08939163e+00
  1.08939163e+00  4.15959316e+00  5.69028633e+00  5.69028633e+00
  5.69028633e+00  1.28963844e+01  2.40443682e+01  2.40443682e+01
  2.40443682e+01  4.19855785e+01  1.18869810e+02  1.18869810e+02
  1.18869810e+02  1.46165412e+02  5.09640316e+02  1.87654707e+03
  8.00545466e+03  4.77721621e+04]
E1 = -182.59670636662864  E_coul = 54.06443734163729
cycle= 3 E= -128.532269024991  delta_E= -0.000848  |g|= 0.00049  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000986359
diis-c [-1.60403045e-07 -2.23248562e-03 -5.49567942e-04  1.00278205e+00]
  HOMO = -0.845550699799559  LUMO = 0.800372782332078
  mo_energy =
[-3.27695096e+01 -1.92728109e+00 -8.45550700e-01 -8.45550700e-01
 -8.45550700e-01  8.00372782e-01  1.08933594e+00  1.08933594e+00
  1.08933594e+00  4.15946416e+00  5.69006886e+00  5.69006886e+00
  5.69006886e+00  1.28961486e+01  2.40440228e+01  2.40440228e+01
  2.40440228e+01  4.19852338e+01  1.18869361e+02  1.18869361e+02
  1.18869361e+02  1.46164977e+02  5.09639776e+02  1.87654642e+03
  8.00545392e+03  4.77721614e+04]
E1 = -182.597256410456  E_coul = 54.06498736309881
cycle= 4 E= -128.532269047357  delta_E= -2.24e-08  |g|= 6.39e-05  |ddm|= 0.000368
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132535
diis-c [-9.86978457e-10  3.25474686e-04  3.91278084e-04 -2.12869354e-01
  1.21215260e+00]
  HOMO = -0.845583222331745  LUMO = 0.800365831312909
  mo_energy =
[-3.27695623e+01 -1.92730119e+00 -8.45583222e-01 -8.45583222e-01
 -8.45583222e-01  8.00365831e-01  1.08932219e+00  1.08932219e+00
  1.08932219e+00  4.15944346e+00  5.69003289e+00  5.69003289e+00
  5.69003289e+00  1.28961128e+01  2.40439751e+01  2.40439751e+01
  2.40439751e+01  4.19851868e+01  1.18869307e+02  1.18869307e+02
  1.18869307e+02  1.46164924e+02  5.09639715e+02  1.87654635e+03
  8.00545385e+03  4.77721613e+04]
E1 = -182.5973589040593  E_coul = 54.065089856157336
cycle= 5 E= -128.532269047902  delta_E= -5.45e-10  |g|= 6.74e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5973589040593  E_coul = 54.065089856157336
  HOMO = -0.845579520179732  LUMO = 0.800367297819151
  mo_energy =
[-3.27695543e+01 -1.92729677e+00 -8.45579520e-01 -8.45579520e-01
 -8.45579520e-01  8.00367298e-01  1.08932375e+00  1.08932375e+00
  1.08932375e+00  4.15944663e+00  5.69003739e+00  5.69003739e+00
  5.69003739e+00  1.28961179e+01  2.40439820e+01  2.40439820e+01
  2.40439820e+01  4.19851938e+01  1.18869315e+02  1.18869315e+02
  1.18869315e+02  1.46164932e+02  5.09639723e+02  1.87654636e+03
  8.00545385e+03  4.77721613e+04]
E1 = -182.59734125341336  E_coul = 54.06507220550873
Extra cycle  E= -128.532269047905  delta_E= -2.67e-12  |g|= 2.47e-06  |ddm|= 2.62e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2869.409434370503
E1 = -182.59734125341336  E_coul = 54.06507220550873
init E= -128.532269047905
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845580753761182  LUMO = 0.800367046578728
  mo_energy =
[-3.27695582e+01 -1.92729795e+00 -8.45580754e-01 -8.45580754e-01
 -8.45580754e-01  8.00367047e-01  1.08932332e+00  1.08932332e+00
  1.08932332e+00  4.15944587e+00  5.69003589e+00  5.69003589e+00
  5.69003589e+00  1.28961163e+01  2.40439791e+01  2.40439791e+01
  2.40439791e+01  4.19851909e+01  1.18869311e+02  1.18869311e+02
  1.18869311e+02  1.46164928e+02  5.09639719e+02  1.87654635e+03
  8.00545385e+03  4.77721613e+04]
E1 = -182.5973507817885  E_coul = 54.0650817338834
cycle= 1 E= -128.532269047905  delta_E= -4.55e-13  |g|= 1.31e-06  |ddm|= 9.62e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5973507817885  E_coul = 54.0650817338834
  HOMO = -0.845580083791951  LUMO = 0.800367232177168
  mo_energy =
[-3.27695562e+01 -1.92729722e+00 -8.45580084e-01 -8.45580084e-01
 -8.45580084e-01  8.00367232e-01  1.08932356e+00  1.08932356e+00
  1.08932356e+00  4.15944634e+00  5.69003671e+00  5.69003671e+00
  5.69003671e+00  1.28961172e+01  2.40439806e+01  2.40439806e+01
  2.40439806e+01  4.19851924e+01  1.18869313e+02  1.18869313e+02
  1.18869313e+02  1.46164930e+02  5.09639721e+02  1.87654635e+03
  8.00545385e+03  4.77721613e+04]
E1 = -182.59734604847952  E_coul = 54.065077000574384
Extra cycle  E= -128.532269047905  delta_E= -5.68e-14  |g|= 6.44e-07  |ddm|= 4.46e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [8.29907819e-01 2.44137941e+04 3.66145449e+03 8.33270645e+02
 2.35739795e+02 7.63995366e+01 1.03041636e+01 2.70901143e+01
 3.18962293e-01 1.91598732e+00 2.97788683e+00 3.68313094e+00
 1.24418327e+01 5.47853542e+01 3.30032257e-01 1.14466482e+00]
grad_E = [ 7.42012750e-05  5.26789602e-10 -2.77109002e-08  5.74961597e-07
 -7.22167206e-06  5.66274005e-05 -3.78223959e-05 -1.85329144e-04
 -2.26554862e-05  6.20675192e-06 -9.70272828e-05 -3.57272362e-04
  1.39306903e-05  1.27977700e-06 -2.84790127e-03  1.72412295e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.827692462126       1
[INPUT] 0    0    [1    /1   ]  24413.7941295        1
[INPUT] 0    0    [1    /1   ]  3661.45449381        1
[INPUT] 0    0    [1    /1   ]  833.270561177        1
[INPUT] 0    0    [1    /1   ]  235.740830463        1
[INPUT] 0    0    [1    /1   ]  76.3916035524        1
[INPUT] 0    0    [1    /1   ]  10.3081113806        1
[INPUT] 0    0    [1    /1   ]  27.1156332534        1
[INPUT] 0    0    [1    /1   ]  0.318374652386       1
[INPUT] 0    0    [1    /1   ]  1.90693858285        1
[INPUT] 0    0    [1    /1   ]  2.99326055134        1
[INPUT] 1    0    [1    /1   ]  3.68527227548        1
[INPUT] 1    0    [1    /1   ]  12.4417373925        1
[INPUT] 1    0    [1    /1   ]  54.7851900586        1
[INPUT] 1    0    [1    /1   ]  0.330227010411       1
[INPUT] 1    0    [1    /1   ]  1.14631302361        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8276924621256505, 1.0]], [0, [24413.79412953635, 1.0]], [0, [3661.4544938145004, 1.0]], [0, [833.2705611770718, 1.0]], [0, [235.74083046303068, 1.0]], [0, [76.39160355243072, 1.0]], [0, [10.308111380560227, 1.0]], [0, [27.115633253369094, 1.0]], [0, [0.318374652385799, 1.0]], [0, [1.9069385828535146, 1.0]], [0, [2.993260551343875, 1.0]], [1, [3.685272275478611, 1.0]], [1, [12.441737392501267, 1.0]], [1, [54.78519005860166, 1.0]], [1, [0.3302270104107887, 1.0]], [1, [1.146313023611674, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82769246]
bas 1, expnt(s) = [24413.79412954]
bas 2, expnt(s) = [3661.45449381]
bas 3, expnt(s) = [833.27056118]
bas 4, expnt(s) = [235.74083046]
bas 5, expnt(s) = [76.39160355]
bas 6, expnt(s) = [10.30811138]
bas 7, expnt(s) = [27.11563325]
bas 8, expnt(s) = [0.31837465]
bas 9, expnt(s) = [1.90693858]
bas 10, expnt(s) = [2.99326055]
bas 11, expnt(s) = [3.68527228]
bas 12, expnt(s) = [12.44173739]
bas 13, expnt(s) = [54.78519006]
bas 14, expnt(s) = [0.33022701]
bas 15, expnt(s) = [1.14631302]
CPU time:       122.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.27692462e-01 2.19238476e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270561e+02 3.91836198e+02
 2.35740830e+02 1.51999140e+02 7.63916036e+01 6.52828708e+01
 1.03081114e+01 1.45344751e+01 2.71156333e+01 3.00213237e+01
 3.18374652e-01 1.07082595e+00 1.90693858e+00 4.09984609e+00
 2.99326055e+00 5.74941180e+00 3.68527228e+00 1.48960584e+01
 1.24417374e+01 6.81688050e+01 5.47851901e+01 4.34823851e+02
 3.30227010e-01 7.30298037e-01 1.14631302e+00 3.46029739e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998478339820194
cond(S) = 2761.249279522091
E1 = -183.57776349931976  E_coul = 55.078518781413976
init E= -128.499244717906
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773941857239993  LUMO = 0.816714860464283
  mo_energy =
[-3.25553737e+01 -1.85289482e+00 -7.73941857e-01 -7.73941857e-01
 -7.73941857e-01  8.16714860e-01  1.11629043e+00  1.11629043e+00
  1.11629043e+00  4.19936268e+00  5.78400586e+00  5.78400586e+00
  5.78400586e+00  1.29840095e+01  2.42141544e+01  2.42141544e+01
  2.42141544e+01  4.21711080e+01  1.19096244e+02  1.19096244e+02
  1.19096244e+02  1.46454249e+02  5.09984226e+02  1.87691632e+03
  8.00584018e+03  4.77725513e+04]
E1 = -182.10987289672414  E_coul = 53.58095323047528
cycle= 1 E= -128.528919666249  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460655
diis-c [-0.21220262  1.        ]
  HOMO = -0.879698583568786  LUMO = 0.789363923244432
  mo_energy =
[-3.28741503e+01 -1.96326033e+00 -8.79698584e-01 -8.79698584e-01
 -8.79698584e-01  7.89363923e-01  1.07796742e+00  1.07796742e+00
  1.07796742e+00  4.12644920e+00  5.65489973e+00  5.65489973e+00
  5.65489973e+00  1.28422650e+01  2.39791212e+01  2.39791212e+01
  2.39791212e+01  4.19302594e+01  1.18775192e+02  1.18775192e+02
  1.18775192e+02  1.46142116e+02  5.09627108e+02  1.87652281e+03
  8.00541753e+03  4.77721098e+04]
E1 = -182.8420578099433  E_coul = 54.31063228241755
cycle= 2 E= -128.531425527526  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229974
diis-c [-6.28283417e-04  3.31994862e-01  6.68005138e-01]
  HOMO = -0.845331728545879  LUMO = 0.798249621604014
  mo_energy =
[-3.27691034e+01 -1.92712856e+00 -8.45331729e-01 -8.45331729e-01
 -8.45331729e-01  7.98249622e-01  1.09048200e+00  1.09048200e+00
  1.09048200e+00  4.14994660e+00  5.69685945e+00  5.69685945e+00
  5.69685945e+00  1.28884714e+01  2.40566818e+01  2.40566818e+01
  2.40566818e+01  4.20099493e+01  1.18880265e+02  1.18880265e+02
  1.18880265e+02  1.46244725e+02  5.09740651e+02  1.87664164e+03
  8.00553880e+03  4.77722320e+04]
E1 = -182.59639068606083  E_coul = 54.06411722376823
cycle= 3 E= -128.532273462293  delta_E= -0.000848  |g|= 0.000495  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993924
diis-c [-1.59900625e-07 -2.24273602e-03 -5.32751321e-04  1.00277549e+00]
  HOMO = -0.845580589256894  LUMO = 0.79820835156432
  mo_energy =
[-3.27695448e+01 -1.92731404e+00 -8.45580589e-01 -8.45580589e-01
 -8.45580589e-01  7.98208352e-01  1.09042481e+00  1.09042481e+00
  1.09042481e+00  4.14981507e+00  5.69663845e+00  5.69663845e+00
  5.69663845e+00  1.28882318e+01  2.40563322e+01  2.40563322e+01
  2.40563322e+01  4.20096004e+01  1.18879812e+02  1.18879812e+02
  1.18879812e+02  1.46244286e+02  5.09740106e+02  1.87664098e+03
  8.00553805e+03  4.77722312e+04]
E1 = -182.59694660242812  E_coul = 54.06467311747464
cycle= 4 E= -128.532273484953  delta_E= -2.27e-08  |g|= 6.41e-05  |ddm|= 0.000368
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132738
diis-c [-9.86147655e-10  3.24108976e-04  3.87699483e-04 -2.11640276e-01
  1.21092847e+00]
  HOMO = -0.845613343369508  LUMO = 0.79820127188544
  mo_energy =
[-3.27695978e+01 -1.92733447e+00 -8.45613343e-01 -8.45613343e-01
 -8.45613343e-01  7.98201272e-01  1.09041092e+00  1.09041092e+00
  1.09041092e+00  4.14979413e+00  5.69660219e+00  5.69660219e+00
  5.69660219e+00  1.28881957e+01  2.40562842e+01  2.40562842e+01
  2.40562842e+01  4.20095530e+01  1.18879758e+02  1.18879758e+02
  1.18879758e+02  1.46244232e+02  5.09740045e+02  1.87664091e+03
  8.00553798e+03  4.77722311e+04]
E1 = -182.5970493632614  E_coul = 54.0647758777636
cycle= 5 E= -128.532273485498  delta_E= -5.44e-10  |g|= 6.73e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5970493632614  E_coul = 54.0647758777636
  HOMO = -0.84560965038563  LUMO = 0.798202736302807
  mo_energy =
[-3.27695898e+01 -1.92733006e+00 -8.45609650e-01 -8.45609650e-01
 -8.45609650e-01  7.98202736e-01  1.09041248e+00  1.09041248e+00
  1.09041248e+00  4.14979729e+00  5.69660668e+00  5.69660668e+00
  5.69660668e+00  1.28882008e+01  2.40562911e+01  2.40562911e+01
  2.40562911e+01  4.20095601e+01  1.18879766e+02  1.18879766e+02
  1.18879766e+02  1.46244240e+02  5.09740053e+02  1.87664092e+03
  8.00553799e+03  4.77722311e+04]
E1 = -182.59703178453154  E_coul = 54.06475829903089
Extra cycle  E= -128.532273485501  delta_E= -2.84e-12  |g|= 2.46e-06  |ddm|= 2.6e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.27692462e-01 2.44137941e+04 3.66145449e+03 8.33270561e+02
 2.35740830e+02 7.63916036e+01 1.03081114e+01 2.71156333e+01
 3.18374652e-01 1.90693858e+00 2.99326055e+00 3.68527228e+00
 1.24417374e+01 5.47851901e+01 3.30227010e-01 1.14631302e+00]
E = -128.53227348550064
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.827692462126       1
[INPUT] 0    0    [1    /1   ]  24413.7941295        1
[INPUT] 0    0    [1    /1   ]  3661.45449381        1
[INPUT] 0    0    [1    /1   ]  833.270561177        1
[INPUT] 0    0    [1    /1   ]  235.740830463        1
[INPUT] 0    0    [1    /1   ]  76.3916035524        1
[INPUT] 0    0    [1    /1   ]  10.3081113806        1
[INPUT] 0    0    [1    /1   ]  27.1156332534        1
[INPUT] 0    0    [1    /1   ]  0.318374652386       1
[INPUT] 0    0    [1    /1   ]  1.90693858285        1
[INPUT] 0    0    [1    /1   ]  2.99326055134        1
[INPUT] 1    0    [1    /1   ]  3.68527227548        1
[INPUT] 1    0    [1    /1   ]  12.4417373925        1
[INPUT] 1    0    [1    /1   ]  54.7851900586        1
[INPUT] 1    0    [1    /1   ]  0.330227010411       1
[INPUT] 1    0    [1    /1   ]  1.14631302361        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8276924621256505, 1.0]], [0, [24413.79412953635, 1.0]], [0, [3661.4544938145004, 1.0]], [0, [833.2705611770718, 1.0]], [0, [235.74083046303068, 1.0]], [0, [76.39160355243072, 1.0]], [0, [10.308111380560227, 1.0]], [0, [27.115633253369094, 1.0]], [0, [0.318374652385799, 1.0]], [0, [1.9069385828535146, 1.0]], [0, [2.993260551343875, 1.0]], [1, [3.685272275478611, 1.0]], [1, [12.441737392501267, 1.0]], [1, [54.78519005860166, 1.0]], [1, [0.3302270104107887, 1.0]], [1, [1.146313023611674, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82769246]
bas 1, expnt(s) = [24413.79412954]
bas 2, expnt(s) = [3661.45449381]
bas 3, expnt(s) = [833.27056118]
bas 4, expnt(s) = [235.74083046]
bas 5, expnt(s) = [76.39160355]
bas 6, expnt(s) = [10.30811138]
bas 7, expnt(s) = [27.11563325]
bas 8, expnt(s) = [0.31837465]
bas 9, expnt(s) = [1.90693858]
bas 10, expnt(s) = [2.99326055]
bas 11, expnt(s) = [3.68527228]
bas 12, expnt(s) = [12.44173739]
bas 13, expnt(s) = [54.78519006]
bas 14, expnt(s) = [0.33022701]
bas 15, expnt(s) = [1.14631302]
CPU time:       123.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.27692462e-01 2.19238476e+00 2.44137941e+04 4.93448102e+03
 3.66145449e+03 1.18920097e+03 8.33270561e+02 3.91836198e+02
 2.35740830e+02 1.51999140e+02 7.63916036e+01 6.52828708e+01
 1.03081114e+01 1.45344751e+01 2.71156333e+01 3.00213237e+01
 3.18374652e-01 1.07082595e+00 1.90693858e+00 4.09984609e+00
 2.99326055e+00 5.74941180e+00 3.68527228e+00 1.48960584e+01
 1.24417374e+01 6.81688050e+01 5.47851901e+01 4.34823851e+02
 3.30227010e-01 7.30298037e-01 1.14631302e+00 3.46029739e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998478339820194
cond(S) = 2761.249279522091
E1 = -183.57776349931976  E_coul = 55.078518781413976
init E= -128.499244717906
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773941857239993  LUMO = 0.816714860464283
  mo_energy =
[-3.25553737e+01 -1.85289482e+00 -7.73941857e-01 -7.73941857e-01
 -7.73941857e-01  8.16714860e-01  1.11629043e+00  1.11629043e+00
  1.11629043e+00  4.19936268e+00  5.78400586e+00  5.78400586e+00
  5.78400586e+00  1.29840095e+01  2.42141544e+01  2.42141544e+01
  2.42141544e+01  4.21711080e+01  1.19096244e+02  1.19096244e+02
  1.19096244e+02  1.46454249e+02  5.09984226e+02  1.87691632e+03
  8.00584018e+03  4.77725513e+04]
E1 = -182.10987289672414  E_coul = 53.58095323047528
cycle= 1 E= -128.528919666249  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460655
diis-c [-0.21220262  1.        ]
  HOMO = -0.879698583568786  LUMO = 0.789363923244432
  mo_energy =
[-3.28741503e+01 -1.96326033e+00 -8.79698584e-01 -8.79698584e-01
 -8.79698584e-01  7.89363923e-01  1.07796742e+00  1.07796742e+00
  1.07796742e+00  4.12644920e+00  5.65489973e+00  5.65489973e+00
  5.65489973e+00  1.28422650e+01  2.39791212e+01  2.39791212e+01
  2.39791212e+01  4.19302594e+01  1.18775192e+02  1.18775192e+02
  1.18775192e+02  1.46142116e+02  5.09627108e+02  1.87652281e+03
  8.00541753e+03  4.77721098e+04]
E1 = -182.8420578099433  E_coul = 54.31063228241755
cycle= 2 E= -128.531425527526  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0676
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229974
diis-c [-6.28283417e-04  3.31994862e-01  6.68005138e-01]
  HOMO = -0.845331728545879  LUMO = 0.798249621604014
  mo_energy =
[-3.27691034e+01 -1.92712856e+00 -8.45331729e-01 -8.45331729e-01
 -8.45331729e-01  7.98249622e-01  1.09048200e+00  1.09048200e+00
  1.09048200e+00  4.14994660e+00  5.69685945e+00  5.69685945e+00
  5.69685945e+00  1.28884714e+01  2.40566818e+01  2.40566818e+01
  2.40566818e+01  4.20099493e+01  1.18880265e+02  1.18880265e+02
  1.18880265e+02  1.46244725e+02  5.09740651e+02  1.87664164e+03
  8.00553880e+03  4.77722320e+04]
E1 = -182.59639068606083  E_coul = 54.06411722376823
cycle= 3 E= -128.532273462293  delta_E= -0.000848  |g|= 0.000495  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993924
diis-c [-1.59900625e-07 -2.24273602e-03 -5.32751321e-04  1.00277549e+00]
  HOMO = -0.845580589256894  LUMO = 0.79820835156432
  mo_energy =
[-3.27695448e+01 -1.92731404e+00 -8.45580589e-01 -8.45580589e-01
 -8.45580589e-01  7.98208352e-01  1.09042481e+00  1.09042481e+00
  1.09042481e+00  4.14981507e+00  5.69663845e+00  5.69663845e+00
  5.69663845e+00  1.28882318e+01  2.40563322e+01  2.40563322e+01
  2.40563322e+01  4.20096004e+01  1.18879812e+02  1.18879812e+02
  1.18879812e+02  1.46244286e+02  5.09740106e+02  1.87664098e+03
  8.00553805e+03  4.77722312e+04]
E1 = -182.59694660242812  E_coul = 54.06467311747464
cycle= 4 E= -128.532273484953  delta_E= -2.27e-08  |g|= 6.41e-05  |ddm|= 0.000368
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132738
diis-c [-9.86147655e-10  3.24108976e-04  3.87699483e-04 -2.11640276e-01
  1.21092847e+00]
  HOMO = -0.845613343369508  LUMO = 0.79820127188544
  mo_energy =
[-3.27695978e+01 -1.92733447e+00 -8.45613343e-01 -8.45613343e-01
 -8.45613343e-01  7.98201272e-01  1.09041092e+00  1.09041092e+00
  1.09041092e+00  4.14979413e+00  5.69660219e+00  5.69660219e+00
  5.69660219e+00  1.28881957e+01  2.40562842e+01  2.40562842e+01
  2.40562842e+01  4.20095530e+01  1.18879758e+02  1.18879758e+02
  1.18879758e+02  1.46244232e+02  5.09740045e+02  1.87664091e+03
  8.00553798e+03  4.77722311e+04]
E1 = -182.5970493632614  E_coul = 54.0647758777636
cycle= 5 E= -128.532273485498  delta_E= -5.44e-10  |g|= 6.73e-06  |ddm|= 6.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5970493632614  E_coul = 54.0647758777636
  HOMO = -0.84560965038563  LUMO = 0.798202736302807
  mo_energy =
[-3.27695898e+01 -1.92733006e+00 -8.45609650e-01 -8.45609650e-01
 -8.45609650e-01  7.98202736e-01  1.09041248e+00  1.09041248e+00
  1.09041248e+00  4.14979729e+00  5.69660668e+00  5.69660668e+00
  5.69660668e+00  1.28882008e+01  2.40562911e+01  2.40562911e+01
  2.40562911e+01  4.20095601e+01  1.18879766e+02  1.18879766e+02
  1.18879766e+02  1.46244240e+02  5.09740053e+02  1.87664092e+03
  8.00553799e+03  4.77722311e+04]
E1 = -182.59703178453154  E_coul = 54.06475829903089
Extra cycle  E= -128.532273485501  delta_E= -2.84e-12  |g|= 2.46e-06  |ddm|= 2.6e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2761.249279522091
E1 = -182.59703178453154  E_coul = 54.06475829903089
init E= -128.532273485501
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845610879221152  LUMO = 0.798202487747326
  mo_energy =
[-3.27695937e+01 -1.92733123e+00 -8.45610879e-01 -8.45610879e-01
 -8.45610879e-01  7.98202488e-01  1.09041205e+00  1.09041205e+00
  1.09041205e+00  4.14979653e+00  5.69660518e+00  5.69660518e+00
  5.69660518e+00  1.28881992e+01  2.40562882e+01  2.40562882e+01
  2.40562882e+01  4.20095572e+01  1.18879762e+02  1.18879762e+02
  1.18879762e+02  1.46244236e+02  5.09740049e+02  1.87664091e+03
  8.00553798e+03  4.77722311e+04]
E1 = -182.59704127864185  E_coul = 54.06476779314086
cycle= 1 E= -128.532273485501  delta_E= -3.41e-13  |g|= 1.3e-06  |ddm|= 9.58e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59704127864185  E_coul = 54.06476779314086
  HOMO = -0.845610211743588  LUMO = 0.798202672337501
  mo_energy =
[-3.27695917e+01 -1.92733051e+00 -8.45610212e-01 -8.45610212e-01
 -8.45610212e-01  7.98202672e-01  1.09041229e+00  1.09041229e+00
  1.09041229e+00  4.14979700e+00  5.69660600e+00  5.69660600e+00
  5.69660600e+00  1.28882001e+01  2.40562897e+01  2.40562897e+01
  2.40562897e+01  4.20095587e+01  1.18879764e+02  1.18879764e+02
  1.18879764e+02  1.46244238e+02  5.09740051e+02  1.87664091e+03
  8.00553798e+03  4.77722311e+04]
E1 = -182.59703656233006  E_coul = 54.064763076829095
Extra cycle  E= -128.532273485501  delta_E=    0  |g|= 6.42e-07  |ddm|= 4.44e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [8.27692462e-01 2.44137941e+04 3.66145449e+03 8.33270561e+02
 2.35740830e+02 7.63916036e+01 1.03081114e+01 2.71156333e+01
 3.18374652e-01 1.90693858e+00 2.99326055e+00 3.68527228e+00
 1.24417374e+01 5.47851901e+01 3.30227010e-01 1.14631302e+00]
grad_E = [ 9.84401937e-05  3.40990987e-10 -1.80176137e-08  3.83865390e-07
 -5.12393912e-06  4.31585972e-05 -8.73543667e-05 -1.43662158e-04
 -7.03328791e-05  8.87508691e-06 -8.96682271e-05 -5.67365328e-04
  1.67938630e-05  1.52660778e-06 -4.70095405e-03  2.89044863e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.826175007784       1
[INPUT] 0    0    [1    /1   ]  24413.7941293        1
[INPUT] 0    0    [1    /1   ]  3661.45450496        1
[INPUT] 0    0    [1    /1   ]  833.270330983        1
[INPUT] 0    0    [1    /1   ]  235.743675824        1
[INPUT] 0    0    [1    /1   ]  76.3699986237        1
[INPUT] 0    0    [1    /1   ]  10.3387258999        1
[INPUT] 0    0    [1    /1   ]  27.1812438028        1
[INPUT] 0    0    [1    /1   ]  0.317723084122       1
[INPUT] 0    0    [1    /1   ]  1.91045489809        1
[INPUT] 0    0    [1    /1   ]  3.03685191826        1
[INPUT] 1    0    [1    /1   ]  3.68847276096        1
[INPUT] 1    0    [1    /1   ]  12.4422328192        1
[INPUT] 1    0    [1    /1   ]  54.7846818413        1
[INPUT] 1    0    [1    /1   ]  0.330524522693       1
[INPUT] 1    0    [1    /1   ]  1.1486674929         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8261750077839689, 1.0]], [0, [24413.794129324157, 1.0]], [0, [3661.454504960681, 1.0]], [0, [833.2703309831617, 1.0]], [0, [235.74367582360836, 1.0]], [0, [76.36999862374256, 1.0]], [0, [10.338725899916861, 1.0]], [0, [27.181243802849153, 1.0]], [0, [0.31772308412153694, 1.0]], [0, [1.910454898086311, 1.0]], [0, [3.0368519182550355, 1.0]], [1, [3.6884727609648427, 1.0]], [1, [12.442232819183458, 1.0]], [1, [54.78468184134913, 1.0]], [1, [0.3305245226934756, 1.0]], [1, [1.148667492898924, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82617501]
bas 1, expnt(s) = [24413.79412932]
bas 2, expnt(s) = [3661.45450496]
bas 3, expnt(s) = [833.27033098]
bas 4, expnt(s) = [235.74367582]
bas 5, expnt(s) = [76.36999862]
bas 6, expnt(s) = [10.3387259]
bas 7, expnt(s) = [27.1812438]
bas 8, expnt(s) = [0.31772308]
bas 9, expnt(s) = [1.9104549]
bas 10, expnt(s) = [3.03685192]
bas 11, expnt(s) = [3.68847276]
bas 12, expnt(s) = [12.44223282]
bas 13, expnt(s) = [54.78468184]
bas 14, expnt(s) = [0.33052452]
bas 15, expnt(s) = [1.14866749]
CPU time:       126.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.26175008e-01 2.18936950e+00 2.44137941e+04 4.93448102e+03
 3.66145450e+03 1.18920097e+03 8.33270331e+02 3.91836116e+02
 2.35743676e+02 1.52000516e+02 7.63699986e+01 6.52690229e+01
 1.03387259e+01 1.45668380e+01 2.71812438e+01 3.00757883e+01
 3.17723084e-01 1.06918191e+00 1.91045490e+00 4.10551475e+00
 3.03685192e+00 5.81209542e+00 3.68847276e+00 1.49122309e+01
 1.24422328e+01 6.81721981e+01 5.47846818e+01 4.34818809e+02
 3.30524523e-01 7.31120567e-01 1.14866749e+00 3.46918377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998467353087324
cond(S) = 2617.1360000542873
E1 = -183.5778400065941  E_coul = 55.07852749471794
init E= -128.499312511876
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773939336838883  LUMO = 0.815916329735372
  mo_energy =
[-3.25553808e+01 -1.85289405e+00 -7.73939337e-01 -7.73939337e-01
 -7.73939337e-01  8.15916330e-01  1.11798186e+00  1.11798186e+00
  1.11798186e+00  4.20663023e+00  5.79367169e+00  5.79367169e+00
  5.79367169e+00  1.30607236e+01  2.42329165e+01  2.42329165e+01
  2.42329165e+01  4.24130044e+01  1.19113246e+02  1.19113246e+02
  1.19113246e+02  1.46872696e+02  5.10448188e+02  1.87734592e+03
  8.00622095e+03  4.77728671e+04]
E1 = -182.10962173944162  E_coul = 53.58069081945475
cycle= 1 E= -128.528930919987  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460736
diis-c [-0.21227782  1.        ]
  HOMO = -0.879725435234921  LUMO = 0.788550343025233
  mo_energy =
[-3.28741761e+01 -1.96329035e+00 -8.79725435e-01 -8.79725435e-01
 -8.79725435e-01  7.88550343e-01  1.07956113e+00  1.07956113e+00
  1.07956113e+00  4.13337023e+00  5.66442034e+00  5.66442034e+00
  5.66442034e+00  1.29182515e+01  2.39978582e+01  2.39978582e+01
  2.39978582e+01  4.21718200e+01  1.18792175e+02  1.18792175e+02
  1.18792175e+02  1.46560512e+02  5.10091063e+02  1.87695239e+03
  8.00579828e+03  4.77724256e+04]
E1 = -182.84168536216438  E_coul = 54.31024916865645
cycle= 2 E= -128.531436193508  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230012
diis-c [-6.29729024e-04  3.31990888e-01  6.68009112e-01]
  HOMO = -0.845365160874736  LUMO = 0.797430630961768
  mo_energy =
[-3.27691411e+01 -1.92716588e+00 -8.45365161e-01 -8.45365161e-01
 -8.45365161e-01  7.97430631e-01  1.09209874e+00  1.09209874e+00
  1.09209874e+00  4.15696379e+00  5.70640842e+00  5.70640842e+00
  5.70640842e+00  1.29646820e+01  2.40754088e+01  2.40754088e+01
  2.40754088e+01  4.22516045e+01  1.18897235e+02  1.18897235e+02
  1.18897235e+02  1.46663119e+02  5.10204591e+02  1.87707121e+03
  8.00591954e+03  4.77725477e+04]
E1 = -182.5960103871789  E_coul = 54.06372631482761
cycle= 3 E= -128.532284072351  delta_E= -0.000848  |g|= 0.000501  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100303
diis-c [-1.58966537e-07 -2.25651168e-03 -5.15219671e-04  1.00277173e+00]
  HOMO = -0.845617678921766  LUMO = 0.797387524617159
  mo_energy =
[-3.27695874e+01 -1.92735559e+00 -8.45617679e-01 -8.45617679e-01
 -8.45617679e-01  7.97387525e-01  1.09203960e+00  1.09203960e+00
  1.09203960e+00  4.15682832e+00  5.70618290e+00  5.70618290e+00
  5.70618290e+00  1.29644368e+01  2.40750541e+01  2.40750541e+01
  2.40750541e+01  4.22512502e+01  1.18896777e+02  1.18896777e+02
  1.18896777e+02  1.46662674e+02  5.10204042e+02  1.87707054e+03
  8.00591879e+03  4.77725470e+04]
E1 = -182.59657309202757  E_coul = 54.06428899665634
cycle= 4 E= -128.532284095371  delta_E= -2.3e-08  |g|= 6.44e-05  |ddm|= 0.000369
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132976
diis-c [-9.86497352e-10  3.22401585e-04  3.83998334e-04 -2.10027332e-01
  1.20932093e+00]
  HOMO = -0.845650728824041  LUMO = 0.797380255726695
  mo_energy =
[-3.27696408e+01 -1.92737646e+00 -8.45650729e-01 -8.45650729e-01
 -8.45650729e-01  7.97380256e-01  1.09202553e+00  1.09202553e+00
  1.09202553e+00  4.15680697e+00  5.70614626e+00  5.70614626e+00
  5.70614626e+00  1.29644002e+01  2.40750057e+01  2.40750057e+01
  2.40750057e+01  4.22512024e+01  1.18896723e+02  1.18896723e+02
  1.18896723e+02  1.46662621e+02  5.10203981e+02  1.87707047e+03
  8.00591872e+03  4.77725469e+04]
E1 = -182.59667622316854  E_coul = 54.06439212725373
cycle= 5 E= -128.532284095915  delta_E= -5.44e-10  |g|= 6.73e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59667622316854  E_coul = 54.06439212725373
  HOMO = -0.845647045688614  LUMO = 0.797381722297835
  mo_energy =
[-3.27696328e+01 -1.92737204e+00 -8.45647046e-01 -8.45647046e-01
 -8.45647046e-01  7.97381722e-01  1.09202709e+00  1.09202709e+00
  1.09202709e+00  4.15681014e+00  5.70615075e+00  5.70615075e+00
  5.70615075e+00  1.29644053e+01  2.40750125e+01  2.40750125e+01
  2.40750125e+01  4.22512094e+01  1.18896730e+02  1.18896730e+02
  1.18896730e+02  1.46662628e+02  5.10203988e+02  1.87707048e+03
  8.00591872e+03  4.77725469e+04]
E1 = -182.59665872345562  E_coul = 54.06437462753778
Extra cycle  E= -128.532284095918  delta_E= -3.04e-12  |g|= 2.45e-06  |ddm|= 2.58e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.26175008e-01 2.44137941e+04 3.66145450e+03 8.33270331e+02
 2.35743676e+02 7.63699986e+01 1.03387259e+01 2.71812438e+01
 3.17723084e-01 1.91045490e+00 3.03685192e+00 3.68847276e+00
 1.24422328e+01 5.47846818e+01 3.30524523e-01 1.14866749e+00]
E = -128.53228409591784
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.826175007784       1
[INPUT] 0    0    [1    /1   ]  24413.7941293        1
[INPUT] 0    0    [1    /1   ]  3661.45450496        1
[INPUT] 0    0    [1    /1   ]  833.270330983        1
[INPUT] 0    0    [1    /1   ]  235.743675824        1
[INPUT] 0    0    [1    /1   ]  76.3699986237        1
[INPUT] 0    0    [1    /1   ]  10.3387258999        1
[INPUT] 0    0    [1    /1   ]  27.1812438028        1
[INPUT] 0    0    [1    /1   ]  0.317723084122       1
[INPUT] 0    0    [1    /1   ]  1.91045489809        1
[INPUT] 0    0    [1    /1   ]  3.03685191826        1
[INPUT] 1    0    [1    /1   ]  3.68847276096        1
[INPUT] 1    0    [1    /1   ]  12.4422328192        1
[INPUT] 1    0    [1    /1   ]  54.7846818413        1
[INPUT] 1    0    [1    /1   ]  0.330524522693       1
[INPUT] 1    0    [1    /1   ]  1.1486674929         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8261750077839689, 1.0]], [0, [24413.794129324157, 1.0]], [0, [3661.454504960681, 1.0]], [0, [833.2703309831617, 1.0]], [0, [235.74367582360836, 1.0]], [0, [76.36999862374256, 1.0]], [0, [10.338725899916861, 1.0]], [0, [27.181243802849153, 1.0]], [0, [0.31772308412153694, 1.0]], [0, [1.910454898086311, 1.0]], [0, [3.0368519182550355, 1.0]], [1, [3.6884727609648427, 1.0]], [1, [12.442232819183458, 1.0]], [1, [54.78468184134913, 1.0]], [1, [0.3305245226934756, 1.0]], [1, [1.148667492898924, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82617501]
bas 1, expnt(s) = [24413.79412932]
bas 2, expnt(s) = [3661.45450496]
bas 3, expnt(s) = [833.27033098]
bas 4, expnt(s) = [235.74367582]
bas 5, expnt(s) = [76.36999862]
bas 6, expnt(s) = [10.3387259]
bas 7, expnt(s) = [27.1812438]
bas 8, expnt(s) = [0.31772308]
bas 9, expnt(s) = [1.9104549]
bas 10, expnt(s) = [3.03685192]
bas 11, expnt(s) = [3.68847276]
bas 12, expnt(s) = [12.44223282]
bas 13, expnt(s) = [54.78468184]
bas 14, expnt(s) = [0.33052452]
bas 15, expnt(s) = [1.14866749]
CPU time:       127.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.26175008e-01 2.18936950e+00 2.44137941e+04 4.93448102e+03
 3.66145450e+03 1.18920097e+03 8.33270331e+02 3.91836116e+02
 2.35743676e+02 1.52000516e+02 7.63699986e+01 6.52690229e+01
 1.03387259e+01 1.45668380e+01 2.71812438e+01 3.00757883e+01
 3.17723084e-01 1.06918191e+00 1.91045490e+00 4.10551475e+00
 3.03685192e+00 5.81209542e+00 3.68847276e+00 1.49122309e+01
 1.24422328e+01 6.81721981e+01 5.47846818e+01 4.34818809e+02
 3.30524523e-01 7.31120567e-01 1.14866749e+00 3.46918377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998467353087324
cond(S) = 2617.1360000542873
E1 = -183.5778400065941  E_coul = 55.07852749471794
init E= -128.499312511876
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773939336838883  LUMO = 0.815916329735372
  mo_energy =
[-3.25553808e+01 -1.85289405e+00 -7.73939337e-01 -7.73939337e-01
 -7.73939337e-01  8.15916330e-01  1.11798186e+00  1.11798186e+00
  1.11798186e+00  4.20663023e+00  5.79367169e+00  5.79367169e+00
  5.79367169e+00  1.30607236e+01  2.42329165e+01  2.42329165e+01
  2.42329165e+01  4.24130044e+01  1.19113246e+02  1.19113246e+02
  1.19113246e+02  1.46872696e+02  5.10448188e+02  1.87734592e+03
  8.00622095e+03  4.77728671e+04]
E1 = -182.10962173944162  E_coul = 53.58069081945475
cycle= 1 E= -128.528930919987  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460736
diis-c [-0.21227782  1.        ]
  HOMO = -0.879725435234921  LUMO = 0.788550343025233
  mo_energy =
[-3.28741761e+01 -1.96329035e+00 -8.79725435e-01 -8.79725435e-01
 -8.79725435e-01  7.88550343e-01  1.07956113e+00  1.07956113e+00
  1.07956113e+00  4.13337023e+00  5.66442034e+00  5.66442034e+00
  5.66442034e+00  1.29182515e+01  2.39978582e+01  2.39978582e+01
  2.39978582e+01  4.21718200e+01  1.18792175e+02  1.18792175e+02
  1.18792175e+02  1.46560512e+02  5.10091063e+02  1.87695239e+03
  8.00579828e+03  4.77724256e+04]
E1 = -182.84168536216438  E_coul = 54.31024916865645
cycle= 2 E= -128.531436193508  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0677
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230012
diis-c [-6.29729024e-04  3.31990888e-01  6.68009112e-01]
  HOMO = -0.845365160874736  LUMO = 0.797430630961768
  mo_energy =
[-3.27691411e+01 -1.92716588e+00 -8.45365161e-01 -8.45365161e-01
 -8.45365161e-01  7.97430631e-01  1.09209874e+00  1.09209874e+00
  1.09209874e+00  4.15696379e+00  5.70640842e+00  5.70640842e+00
  5.70640842e+00  1.29646820e+01  2.40754088e+01  2.40754088e+01
  2.40754088e+01  4.22516045e+01  1.18897235e+02  1.18897235e+02
  1.18897235e+02  1.46663119e+02  5.10204591e+02  1.87707121e+03
  8.00591954e+03  4.77725477e+04]
E1 = -182.5960103871789  E_coul = 54.06372631482761
cycle= 3 E= -128.532284072351  delta_E= -0.000848  |g|= 0.000501  |ddm|= 0.0231
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100303
diis-c [-1.58966537e-07 -2.25651168e-03 -5.15219671e-04  1.00277173e+00]
  HOMO = -0.845617678921766  LUMO = 0.797387524617159
  mo_energy =
[-3.27695874e+01 -1.92735559e+00 -8.45617679e-01 -8.45617679e-01
 -8.45617679e-01  7.97387525e-01  1.09203960e+00  1.09203960e+00
  1.09203960e+00  4.15682832e+00  5.70618290e+00  5.70618290e+00
  5.70618290e+00  1.29644368e+01  2.40750541e+01  2.40750541e+01
  2.40750541e+01  4.22512502e+01  1.18896777e+02  1.18896777e+02
  1.18896777e+02  1.46662674e+02  5.10204042e+02  1.87707054e+03
  8.00591879e+03  4.77725470e+04]
E1 = -182.59657309202757  E_coul = 54.06428899665634
cycle= 4 E= -128.532284095371  delta_E= -2.3e-08  |g|= 6.44e-05  |ddm|= 0.000369
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132976
diis-c [-9.86497352e-10  3.22401585e-04  3.83998334e-04 -2.10027332e-01
  1.20932093e+00]
  HOMO = -0.845650728824041  LUMO = 0.797380255726695
  mo_energy =
[-3.27696408e+01 -1.92737646e+00 -8.45650729e-01 -8.45650729e-01
 -8.45650729e-01  7.97380256e-01  1.09202553e+00  1.09202553e+00
  1.09202553e+00  4.15680697e+00  5.70614626e+00  5.70614626e+00
  5.70614626e+00  1.29644002e+01  2.40750057e+01  2.40750057e+01
  2.40750057e+01  4.22512024e+01  1.18896723e+02  1.18896723e+02
  1.18896723e+02  1.46662621e+02  5.10203981e+02  1.87707047e+03
  8.00591872e+03  4.77725469e+04]
E1 = -182.59667622316854  E_coul = 54.06439212725373
cycle= 5 E= -128.532284095915  delta_E= -5.44e-10  |g|= 6.73e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59667622316854  E_coul = 54.06439212725373
  HOMO = -0.845647045688614  LUMO = 0.797381722297835
  mo_energy =
[-3.27696328e+01 -1.92737204e+00 -8.45647046e-01 -8.45647046e-01
 -8.45647046e-01  7.97381722e-01  1.09202709e+00  1.09202709e+00
  1.09202709e+00  4.15681014e+00  5.70615075e+00  5.70615075e+00
  5.70615075e+00  1.29644053e+01  2.40750125e+01  2.40750125e+01
  2.40750125e+01  4.22512094e+01  1.18896730e+02  1.18896730e+02
  1.18896730e+02  1.46662628e+02  5.10203988e+02  1.87707048e+03
  8.00591872e+03  4.77725469e+04]
E1 = -182.59665872345562  E_coul = 54.06437462753778
Extra cycle  E= -128.532284095918  delta_E= -3.04e-12  |g|= 2.45e-06  |ddm|= 2.58e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2617.1360000542873
E1 = -182.59665872345562  E_coul = 54.06437462753778
init E= -128.532284095918
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845648269360074  LUMO = 0.797381476028997
  mo_energy =
[-3.27696367e+01 -1.92737321e+00 -8.45648269e-01 -8.45648269e-01
 -8.45648269e-01  7.97381476e-01  1.09202666e+00  1.09202666e+00
  1.09202666e+00  4.15680939e+00  5.70614926e+00  5.70614926e+00
  5.70614926e+00  1.29644037e+01  2.40750097e+01  2.40750097e+01
  2.40750097e+01  4.22512065e+01  1.18896727e+02  1.18896727e+02
  1.18896727e+02  1.46662625e+02  5.10203984e+02  1.87707048e+03
  8.00591872e+03  4.77725469e+04]
E1 = -182.59666817989012  E_coul = 54.06438408397188
cycle= 1 E= -128.532284095918  delta_E= -3.98e-13  |g|= 1.3e-06  |ddm|= 9.53e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59666817989012  E_coul = 54.06438408397188
  HOMO = -0.845647604637803  LUMO = 0.797381660035366
  mo_energy =
[-3.27696347e+01 -1.92737249e+00 -8.45647605e-01 -8.45647605e-01
 -8.45647605e-01  7.97381660e-01  1.09202691e+00  1.09202691e+00
  1.09202691e+00  4.15680986e+00  5.70615007e+00  5.70615007e+00
  5.70615007e+00  1.29644046e+01  2.40750112e+01  2.40750112e+01
  2.40750112e+01  4.22512080e+01  1.18896729e+02  1.18896729e+02
  1.18896729e+02  1.46662627e+02  5.10203986e+02  1.87707048e+03
  8.00591872e+03  4.77725469e+04]
E1 = -182.59666348218758  E_coul = 54.06437938626936
Extra cycle  E= -128.532284095918  delta_E= 2.84e-14  |g|= 6.39e-07  |ddm|= 4.43e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.26175008e-01 2.44137941e+04 3.66145450e+03 8.33270331e+02
 2.35743676e+02 7.63699986e+01 1.03387259e+01 2.71812438e+01
 3.17723084e-01 1.91045490e+00 3.03685192e+00 3.68847276e+00
 1.24422328e+01 5.47846818e+01 3.30524523e-01 1.14866749e+00]
grad_E = [ 1.18613417e-04 -4.42833467e-11  2.08290113e-09 -9.31486001e-09
 -8.87313286e-07  1.76057648e-05 -1.57933844e-04 -7.40812821e-05
 -1.22499658e-04  1.69093358e-05 -7.72610799e-05 -8.50849490e-04
  2.11469831e-05  1.72076939e-06 -7.19450157e-03  4.47238043e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.8281633527         1
[INPUT] 0    0    [1    /1   ]  24413.7941289        1
[INPUT] 0    0    [1    /1   ]  3661.45452919        1
[INPUT] 0    0    [1    /1   ]  833.26982984         1
[INPUT] 0    0    [1    /1   ]  235.749878484        1
[INPUT] 0    0    [1    /1   ]  76.3231252553        1
[INPUT] 0    0    [1    /1   ]  10.4297503322        1
[INPUT] 0    0    [1    /1   ]  27.318820406         1
[INPUT] 0    0    [1    /1   ]  0.31729776722        1
[INPUT] 0    0    [1    /1   ]  1.95252102811        1
[INPUT] 0    0    [1    /1   ]  3.13351716988        1
[INPUT] 1    0    [1    /1   ]  3.69203319594        1
[INPUT] 1    0    [1    /1   ]  12.4443011091        1
[INPUT] 1    0    [1    /1   ]  54.7834998885        1
[INPUT] 1    0    [1    /1   ]  0.33086195317        1
[INPUT] 1    0    [1    /1   ]  1.15099432088        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.828163352699586, 1.0]], [0, [24413.79412886281, 1.0]], [0, [3661.4545291948784, 1.0]], [0, [833.2698298403036, 1.0]], [0, [235.7498784835983, 1.0]], [0, [76.32312525534934, 1.0]], [0, [10.429750332237589, 1.0]], [0, [27.318820406011465, 1.0]], [0, [0.31729776721965214, 1.0]], [0, [1.952521028112237, 1.0]], [0, [3.1335171698762228, 1.0]], [1, [3.6920331959385733, 1.0]], [1, [12.444301109144044, 1.0]], [1, [54.78349988851382, 1.0]], [1, [0.3308619531698205, 1.0]], [1, [1.150994320876454, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82816335]
bas 1, expnt(s) = [24413.79412886]
bas 2, expnt(s) = [3661.45452919]
bas 3, expnt(s) = [833.26982984]
bas 4, expnt(s) = [235.74987848]
bas 5, expnt(s) = [76.32312526]
bas 6, expnt(s) = [10.42975033]
bas 7, expnt(s) = [27.31882041]
bas 8, expnt(s) = [0.31729777]
bas 9, expnt(s) = [1.95252103]
bas 10, expnt(s) = [3.13351717]
bas 11, expnt(s) = [3.6920332]
bas 12, expnt(s) = [12.44430111]
bas 13, expnt(s) = [54.78349989]
bas 14, expnt(s) = [0.33086195]
bas 15, expnt(s) = [1.15099432]
CPU time:       130.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.28163353e-01 2.19332016e+00 2.44137941e+04 4.93448102e+03
 3.66145453e+03 1.18920098e+03 8.33269830e+02 3.91835940e+02
 2.35749878e+02 1.52003516e+02 7.63231253e+01 6.52389756e+01
 1.04297503e+01 1.46629198e+01 2.73188204e+01 3.01898866e+01
 3.17297767e-01 1.06810829e+00 1.95252103e+00 4.17312904e+00
 3.13351717e+00 5.95030303e+00 3.69203320e+00 1.49302263e+01
 1.24443011e+01 6.81863638e+01 5.47834999e+01 4.34807083e+02
 3.30861953e-01 7.32053681e-01 1.15099432e+00 3.47797030e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998455935561848
cond(S) = 2478.8919087098834
E1 = -183.5779601553434  E_coul = 55.07853260030407
init E= -128.499427555039
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773936711641503  LUMO = 0.819948452640892
  mo_energy =
[-3.25553943e+01 -1.85289385e+00 -7.73936712e-01 -7.73936712e-01
 -7.73936712e-01  8.19948453e-01  1.11978117e+00  1.11978117e+00
  1.11978117e+00  4.26232566e+00  5.80362366e+00  5.80362366e+00
  5.80362366e+00  1.33458756e+01  2.42543996e+01  2.42543996e+01
  2.42543996e+01  4.31499036e+01  1.19135230e+02  1.19135230e+02
  1.19135230e+02  1.48026383e+02  5.11687843e+02  1.87848880e+03
  8.00723297e+03  4.77737062e+04]
E1 = -182.10957140683956  E_coul = 53.58061868497521
cycle= 1 E= -128.528952721864  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460936
diis-c [-0.21246181  1.        ]
  HOMO = -0.879736595292564  LUMO = 0.792349678104684
  mo_energy =
[-3.28741755e+01 -1.96330348e+00 -8.79736595e-01 -8.79736595e-01
 -8.79736595e-01  7.92349678e-01  1.08126929e+00  1.08126929e+00
  1.08126929e+00  4.18776166e+00  5.67424128e+00  5.67424128e+00
  5.67424128e+00  1.32013536e+01  2.40193313e+01  2.40193313e+01
  2.40193313e+01  4.29079521e+01  1.18814175e+02  1.18814175e+02
  1.18814175e+02  1.47714163e+02  5.11330769e+02  1.87809530e+03
  8.00681034e+03  4.77732647e+04]
E1 = -182.84144104242992  E_coul = 54.3099839806118
cycle= 2 E= -128.531457061818  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0679
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230116
diis-c [-6.33720354e-04  3.31989299e-01  6.68010701e-01]
  HOMO = -0.845386462593133  LUMO = 0.801295317063841
  mo_energy =
[-3.27691631e+01 -1.92719015e+00 -8.45386463e-01 -8.45386463e-01
 -8.45386463e-01  8.01295317e-01  1.09382931e+00  1.09382931e+00
  1.09382931e+00  4.21176455e+00  5.71625491e+00  5.71625491e+00
  5.71625491e+00  1.32484510e+01  2.40968673e+01  2.40968673e+01
  2.40968673e+01  4.29879751e+01  1.18919210e+02  1.18919210e+02
  1.18919210e+02  1.47816761e+02  5.11444264e+02  1.87821409e+03
  8.00693157e+03  4.77733869e+04]
E1 = -182.5958002140107  E_coul = 54.06349554185879
cycle= 3 E= -128.532304672152  delta_E= -0.000848  |g|= 0.000505  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100781
diis-c [-1.57638081e-07 -2.26807200e-03 -5.14287418e-04  1.00278236e+00]
  HOMO = -0.845641457514922  LUMO = 0.801250505426124
  mo_energy =
[-3.27696119e+01 -1.92738275e+00 -8.45641458e-01 -8.45641458e-01
 -8.45641458e-01  8.01250505e-01  1.09376879e+00  1.09376879e+00
  1.09376879e+00  4.21162448e+00  5.71602625e+00  5.71602625e+00
  5.71602625e+00  1.32481998e+01  2.40965096e+01  2.40965096e+01
  2.40965096e+01  4.29876168e+01  1.18918749e+02  1.18918749e+02
  1.18918749e+02  1.47816314e+02  5.11443713e+02  1.87821342e+03
  8.00693082e+03  4.77733861e+04]
E1 = -182.59636560661858  E_coul = 54.06406091126752
cycle= 4 E= -128.532304695351  delta_E= -2.32e-08  |g|= 6.45e-05  |ddm|= 0.000365
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133105
diis-c [-9.90532061e-10  3.21451945e-04  3.83708515e-04 -2.08852523e-01
  1.20814736e+00]
  HOMO = -0.845674719412149  LUMO = 0.801243040561643
  mo_energy =
[-3.27696655e+01 -1.92740395e+00 -8.45674719e-01 -8.45674719e-01
 -8.45674719e-01  8.01243041e-01  1.09375459e+00  1.09375459e+00
  1.09375459e+00  4.21160257e+00  5.71598932e+00  5.71598932e+00
  5.71598932e+00  1.32481625e+01  2.40964608e+01  2.40964608e+01
  2.40964608e+01  4.29875686e+01  1.18918695e+02  1.18918695e+02
  1.18918695e+02  1.47816260e+02  5.11443651e+02  1.87821336e+03
  8.00693075e+03  4.77733860e+04]
E1 = -182.59646908953772  E_coul = 54.064164393644575
cycle= 5 E= -128.532304695893  delta_E= -5.42e-10  |g|= 6.74e-06  |ddm|= 6.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59646908953772  E_coul = 54.064164393644575
  HOMO = -0.845671034702947  LUMO = 0.801244521826413
  mo_energy =
[-3.27696575e+01 -1.92739952e+00 -8.45671035e-01 -8.45671035e-01
 -8.45671035e-01  8.01244522e-01  1.09375615e+00  1.09375615e+00
  1.09375615e+00  4.21160579e+00  5.71599381e+00  5.71599381e+00
  5.71599381e+00  1.32481676e+01  2.40964677e+01  2.40964677e+01
  2.40964677e+01  4.29875756e+01  1.18918703e+02  1.18918703e+02
  1.18918703e+02  1.47816268e+02  5.11443659e+02  1.87821336e+03
  8.00693075e+03  4.77733860e+04]
E1 = -182.59645159911017  E_coul = 54.064146903214464
Extra cycle  E= -128.532304695896  delta_E= -2.56e-12  |g|= 2.45e-06  |ddm|= 2.59e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.28163353e-01 2.44137941e+04 3.66145453e+03 8.33269830e+02
 2.35749878e+02 7.63231253e+01 1.04297503e+01 2.73188204e+01
 3.17297767e-01 1.95252103e+00 3.13351717e+00 3.69203320e+00
 1.24443011e+01 5.47834999e+01 3.30861953e-01 1.15099432e+00]
E = -128.5323046958957
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.8281633527         1
[INPUT] 0    0    [1    /1   ]  24413.7941289        1
[INPUT] 0    0    [1    /1   ]  3661.45452919        1
[INPUT] 0    0    [1    /1   ]  833.26982984         1
[INPUT] 0    0    [1    /1   ]  235.749878484        1
[INPUT] 0    0    [1    /1   ]  76.3231252553        1
[INPUT] 0    0    [1    /1   ]  10.4297503322        1
[INPUT] 0    0    [1    /1   ]  27.318820406         1
[INPUT] 0    0    [1    /1   ]  0.31729776722        1
[INPUT] 0    0    [1    /1   ]  1.95252102811        1
[INPUT] 0    0    [1    /1   ]  3.13351716988        1
[INPUT] 1    0    [1    /1   ]  3.69203319594        1
[INPUT] 1    0    [1    /1   ]  12.4443011091        1
[INPUT] 1    0    [1    /1   ]  54.7834998885        1
[INPUT] 1    0    [1    /1   ]  0.33086195317        1
[INPUT] 1    0    [1    /1   ]  1.15099432088        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.828163352699586, 1.0]], [0, [24413.79412886281, 1.0]], [0, [3661.4545291948784, 1.0]], [0, [833.2698298403036, 1.0]], [0, [235.7498784835983, 1.0]], [0, [76.32312525534934, 1.0]], [0, [10.429750332237589, 1.0]], [0, [27.318820406011465, 1.0]], [0, [0.31729776721965214, 1.0]], [0, [1.952521028112237, 1.0]], [0, [3.1335171698762228, 1.0]], [1, [3.6920331959385733, 1.0]], [1, [12.444301109144044, 1.0]], [1, [54.78349988851382, 1.0]], [1, [0.3308619531698205, 1.0]], [1, [1.150994320876454, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82816335]
bas 1, expnt(s) = [24413.79412886]
bas 2, expnt(s) = [3661.45452919]
bas 3, expnt(s) = [833.26982984]
bas 4, expnt(s) = [235.74987848]
bas 5, expnt(s) = [76.32312526]
bas 6, expnt(s) = [10.42975033]
bas 7, expnt(s) = [27.31882041]
bas 8, expnt(s) = [0.31729777]
bas 9, expnt(s) = [1.95252103]
bas 10, expnt(s) = [3.13351717]
bas 11, expnt(s) = [3.6920332]
bas 12, expnt(s) = [12.44430111]
bas 13, expnt(s) = [54.78349989]
bas 14, expnt(s) = [0.33086195]
bas 15, expnt(s) = [1.15099432]
CPU time:       131.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.28163353e-01 2.19332016e+00 2.44137941e+04 4.93448102e+03
 3.66145453e+03 1.18920098e+03 8.33269830e+02 3.91835940e+02
 2.35749878e+02 1.52003516e+02 7.63231253e+01 6.52389756e+01
 1.04297503e+01 1.46629198e+01 2.73188204e+01 3.01898866e+01
 3.17297767e-01 1.06810829e+00 1.95252103e+00 4.17312904e+00
 3.13351717e+00 5.95030303e+00 3.69203320e+00 1.49302263e+01
 1.24443011e+01 6.81863638e+01 5.47834999e+01 4.34807083e+02
 3.30861953e-01 7.32053681e-01 1.15099432e+00 3.47797030e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998455935561848
cond(S) = 2478.8919087098834
E1 = -183.5779601553434  E_coul = 55.07853260030407
init E= -128.499427555039
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773936711641503  LUMO = 0.819948452640892
  mo_energy =
[-3.25553943e+01 -1.85289385e+00 -7.73936712e-01 -7.73936712e-01
 -7.73936712e-01  8.19948453e-01  1.11978117e+00  1.11978117e+00
  1.11978117e+00  4.26232566e+00  5.80362366e+00  5.80362366e+00
  5.80362366e+00  1.33458756e+01  2.42543996e+01  2.42543996e+01
  2.42543996e+01  4.31499036e+01  1.19135230e+02  1.19135230e+02
  1.19135230e+02  1.48026383e+02  5.11687843e+02  1.87848880e+03
  8.00723297e+03  4.77737062e+04]
E1 = -182.10957140683956  E_coul = 53.58061868497521
cycle= 1 E= -128.528952721864  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460936
diis-c [-0.21246181  1.        ]
  HOMO = -0.879736595292564  LUMO = 0.792349678104684
  mo_energy =
[-3.28741755e+01 -1.96330348e+00 -8.79736595e-01 -8.79736595e-01
 -8.79736595e-01  7.92349678e-01  1.08126929e+00  1.08126929e+00
  1.08126929e+00  4.18776166e+00  5.67424128e+00  5.67424128e+00
  5.67424128e+00  1.32013536e+01  2.40193313e+01  2.40193313e+01
  2.40193313e+01  4.29079521e+01  1.18814175e+02  1.18814175e+02
  1.18814175e+02  1.47714163e+02  5.11330769e+02  1.87809530e+03
  8.00681034e+03  4.77732647e+04]
E1 = -182.84144104242992  E_coul = 54.3099839806118
cycle= 2 E= -128.531457061818  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0679
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230116
diis-c [-6.33720354e-04  3.31989299e-01  6.68010701e-01]
  HOMO = -0.845386462593133  LUMO = 0.801295317063841
  mo_energy =
[-3.27691631e+01 -1.92719015e+00 -8.45386463e-01 -8.45386463e-01
 -8.45386463e-01  8.01295317e-01  1.09382931e+00  1.09382931e+00
  1.09382931e+00  4.21176455e+00  5.71625491e+00  5.71625491e+00
  5.71625491e+00  1.32484510e+01  2.40968673e+01  2.40968673e+01
  2.40968673e+01  4.29879751e+01  1.18919210e+02  1.18919210e+02
  1.18919210e+02  1.47816761e+02  5.11444264e+02  1.87821409e+03
  8.00693157e+03  4.77733869e+04]
E1 = -182.5958002140107  E_coul = 54.06349554185879
cycle= 3 E= -128.532304672152  delta_E= -0.000848  |g|= 0.000505  |ddm|= 0.0232
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100781
diis-c [-1.57638081e-07 -2.26807200e-03 -5.14287418e-04  1.00278236e+00]
  HOMO = -0.845641457514922  LUMO = 0.801250505426124
  mo_energy =
[-3.27696119e+01 -1.92738275e+00 -8.45641458e-01 -8.45641458e-01
 -8.45641458e-01  8.01250505e-01  1.09376879e+00  1.09376879e+00
  1.09376879e+00  4.21162448e+00  5.71602625e+00  5.71602625e+00
  5.71602625e+00  1.32481998e+01  2.40965096e+01  2.40965096e+01
  2.40965096e+01  4.29876168e+01  1.18918749e+02  1.18918749e+02
  1.18918749e+02  1.47816314e+02  5.11443713e+02  1.87821342e+03
  8.00693082e+03  4.77733861e+04]
E1 = -182.59636560661858  E_coul = 54.06406091126752
cycle= 4 E= -128.532304695351  delta_E= -2.32e-08  |g|= 6.45e-05  |ddm|= 0.000365
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133105
diis-c [-9.90532061e-10  3.21451945e-04  3.83708515e-04 -2.08852523e-01
  1.20814736e+00]
  HOMO = -0.845674719412149  LUMO = 0.801243040561643
  mo_energy =
[-3.27696655e+01 -1.92740395e+00 -8.45674719e-01 -8.45674719e-01
 -8.45674719e-01  8.01243041e-01  1.09375459e+00  1.09375459e+00
  1.09375459e+00  4.21160257e+00  5.71598932e+00  5.71598932e+00
  5.71598932e+00  1.32481625e+01  2.40964608e+01  2.40964608e+01
  2.40964608e+01  4.29875686e+01  1.18918695e+02  1.18918695e+02
  1.18918695e+02  1.47816260e+02  5.11443651e+02  1.87821336e+03
  8.00693075e+03  4.77733860e+04]
E1 = -182.59646908953772  E_coul = 54.064164393644575
cycle= 5 E= -128.532304695893  delta_E= -5.42e-10  |g|= 6.74e-06  |ddm|= 6.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59646908953772  E_coul = 54.064164393644575
  HOMO = -0.845671034702947  LUMO = 0.801244521826413
  mo_energy =
[-3.27696575e+01 -1.92739952e+00 -8.45671035e-01 -8.45671035e-01
 -8.45671035e-01  8.01244522e-01  1.09375615e+00  1.09375615e+00
  1.09375615e+00  4.21160579e+00  5.71599381e+00  5.71599381e+00
  5.71599381e+00  1.32481676e+01  2.40964677e+01  2.40964677e+01
  2.40964677e+01  4.29875756e+01  1.18918703e+02  1.18918703e+02
  1.18918703e+02  1.47816268e+02  5.11443659e+02  1.87821336e+03
  8.00693075e+03  4.77733860e+04]
E1 = -182.59645159911017  E_coul = 54.064146903214464
Extra cycle  E= -128.532304695896  delta_E= -2.56e-12  |g|= 2.45e-06  |ddm|= 2.59e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2478.8919087098834
E1 = -182.59645159911017  E_coul = 54.064146903214464
init E= -128.532304695896
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845672257935444  LUMO = 0.801244274194965
  mo_energy =
[-3.27696614e+01 -1.92740069e+00 -8.45672258e-01 -8.45672258e-01
 -8.45672258e-01  8.01244274e-01  1.09375572e+00  1.09375572e+00
  1.09375572e+00  4.21160502e+00  5.71599232e+00  5.71599232e+00
  5.71599232e+00  1.32481660e+01  2.40964649e+01  2.40964649e+01
  2.40964649e+01  4.29875727e+01  1.18918699e+02  1.18918699e+02
  1.18918699e+02  1.47816264e+02  5.11443655e+02  1.87821336e+03
  8.00693075e+03  4.77733860e+04]
E1 = -182.59646105221702  E_coul = 54.06415635632084
cycle= 1 E= -128.532304695896  delta_E= -4.83e-13  |g|= 1.3e-06  |ddm|= 9.5e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59646105221702  E_coul = 54.06415635632084
  HOMO = -0.845671593517177  LUMO = 0.801244459647949
  mo_energy =
[-3.27696594e+01 -1.92739997e+00 -8.45671594e-01 -8.45671594e-01
 -8.45671594e-01  8.01244460e-01  1.09375597e+00  1.09375597e+00
  1.09375597e+00  4.21160550e+00  5.71599314e+00  5.71599314e+00
  5.71599314e+00  1.32481669e+01  2.40964664e+01  2.40964664e+01
  2.40964664e+01  4.29875743e+01  1.18918701e+02  1.18918701e+02
  1.18918701e+02  1.47816266e+02  5.11443657e+02  1.87821336e+03
  8.00693075e+03  4.77733860e+04]
E1 = -182.59645635590593  E_coul = 54.06415166000928
Extra cycle  E= -128.532304695897  delta_E= -4.55e-13  |g|= 6.39e-07  |ddm|= 4.45e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.28163353e-01 2.44137941e+04 3.66145453e+03 8.33269830e+02
 2.35749878e+02 7.63231253e+01 1.04297503e+01 2.73188204e+01
 3.17297767e-01 1.95252103e+00 3.13351717e+00 3.69203320e+00
 1.24443011e+01 5.47834999e+01 3.30861953e-01 1.15099432e+00]
grad_E = [ 7.29653938e-05 -7.23001717e-10  3.75343479e-08 -6.96324833e-07
  6.39866829e-06 -2.32915053e-05 -2.32198079e-04  2.02778917e-05
 -1.10095010e-04  4.35602190e-05 -6.04726848e-05 -1.08751055e-03
  2.49696528e-05  1.56513034e-06 -9.28470115e-03  5.83439661e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.841750024142       1
[INPUT] 0    0    [1    /1   ]  24413.7941282        1
[INPUT] 0    0    [1    /1   ]  3661.45456636        1
[INPUT] 0    0    [1    /1   ]  833.269060573        1
[INPUT] 0    0    [1    /1   ]  235.759408834        1
[INPUT] 0    0    [1    /1   ]  76.2513815232        1
[INPUT] 0    0    [1    /1   ]  10.5971862325        1
[INPUT] 0    0    [1    /1   ]  27.5237312468        1
[INPUT] 0    0    [1    /1   ]  0.318835698189       1
[INPUT] 0    0    [1    /1   ]  2.06263419277        1
[INPUT] 0    0    [1    /1   ]  3.28455624491        1
[INPUT] 1    0    [1    /1   ]  3.69332965371        1
[INPUT] 1    0    [1    /1   ]  12.448574328         1
[INPUT] 1    0    [1    /1   ]  54.7816104905        1
[INPUT] 1    0    [1    /1   ]  0.330986313285       1
[INPUT] 1    0    [1    /1   ]  1.15113461836        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8417500241424662, 1.0]], [0, [24413.794128155336, 1.0]], [0, [3661.4545663577946, 1.0]], [0, [833.2690605730959, 1.0]], [0, [235.75940883367065, 1.0]], [0, [76.25138152322914, 1.0]], [0, [10.597186232495497, 1.0]], [0, [27.523731246764406, 1.0]], [0, [0.3188356981891845, 1.0]], [0, [2.062634192768506, 1.0]], [0, [3.28455624490598, 1.0]], [1, [3.693329653709057, 1.0]], [1, [12.44857432798496, 1.0]], [1, [54.78161049052144, 1.0]], [1, [0.3309863132852151, 1.0]], [1, [1.1511346183564688, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84175002]
bas 1, expnt(s) = [24413.79412816]
bas 2, expnt(s) = [3661.45456636]
bas 3, expnt(s) = [833.26906057]
bas 4, expnt(s) = [235.75940883]
bas 5, expnt(s) = [76.25138152]
bas 6, expnt(s) = [10.59718623]
bas 7, expnt(s) = [27.52373125]
bas 8, expnt(s) = [0.3188357]
bas 9, expnt(s) = [2.06263419]
bas 10, expnt(s) = [3.28455624]
bas 11, expnt(s) = [3.69332965]
bas 12, expnt(s) = [12.44857433]
bas 13, expnt(s) = [54.78161049]
bas 14, expnt(s) = [0.33098631]
bas 15, expnt(s) = [1.15113462]
CPU time:       134.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.41750024e-01 2.22025255e+00 2.44137941e+04 4.93448102e+03
 3.66145457e+03 1.18920099e+03 8.33269061e+02 3.91835668e+02
 2.35759409e+02 1.52008124e+02 7.62513815e+01 6.51929768e+01
 1.05971862e+01 1.48391132e+01 2.75237312e+01 3.03595623e+01
 3.18835698e-01 1.07198876e+00 2.06263419e+00 4.34842200e+00
 3.28455624e+00 6.16414082e+00 3.69332965e+00 1.49367800e+01
 1.24485743e+01 6.82156330e+01 5.47816105e+01 4.34788338e+02
 3.30986313e-01 7.32397641e-01 1.15113462e+00 3.47850023e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998454279556137
cond(S) = 2497.7512487181802
E1 = -183.57811120707362  E_coul = 55.078534631893405
init E= -128.49957657518
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77393621565219  LUMO = 0.836752548657502
  mo_energy =
[-3.25554092e+01 -1.85289258e+00 -7.73936216e-01 -7.73936216e-01
 -7.73936216e-01  8.36752549e-01  1.12019438e+00  1.12019438e+00
  1.12019438e+00  4.41289790e+00  5.80526458e+00  5.80526458e+00
  5.80526458e+00  1.39583290e+01  2.42635038e+01  2.42635038e+01
  2.42635038e+01  4.45684150e+01  1.19150202e+02  1.19150202e+02
  1.19150202e+02  1.50120786e+02  5.13897949e+02  1.88052188e+03
  8.00903246e+03  4.77751981e+04]
E1 = -182.11004666107084  E_coul = 53.5810650185261
cycle= 1 E= -128.528981642545  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461237
diis-c [-0.21273919  1.        ]
  HOMO = -0.879701234641382  LUMO = 0.80842637988855
  mo_energy =
[-3.28741134e+01 -1.96326187e+00 -8.79701235e-01 -8.79701235e-01
 -8.79701235e-01  8.08426380e-01  1.08168941e+00  1.08168941e+00
  1.08168941e+00  4.33553476e+00  5.67590077e+00  5.67590077e+00
  5.67590077e+00  1.38101362e+01  2.40284660e+01  2.40284660e+01
  2.40284660e+01  4.43252685e+01  1.18829225e+02  1.18829225e+02
  1.18829225e+02  1.49808602e+02  5.13541024e+02  1.88012849e+03
  8.00860991e+03  4.77747567e+04]
E1 = -182.8417274844256  E_coul = 54.310242380375904
cycle= 2 E= -128.53148510405  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0683
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230281
diis-c [-6.40965992e-04  3.31993063e-01  6.68006937e-01]
  HOMO = -0.845360372341262  LUMO = 0.81760647111158
  mo_energy =
[-3.27691277e+01 -1.92715838e+00 -8.45360372e-01 -8.45360372e-01
 -8.45360372e-01  8.17606471e-01  1.09425011e+00  1.09425011e+00
  1.09425011e+00  4.36045149e+00  5.71791097e+00  5.71791097e+00
  5.71791097e+00  1.38584608e+01  2.41059910e+01  2.41059910e+01
  2.41059910e+01  4.44056876e+01  1.18934232e+02  1.18934232e+02
  1.18934232e+02  1.49911182e+02  5.13654470e+02  1.88024724e+03
  8.00873112e+03  4.77748788e+04]
E1 = -182.59618968090192  E_coul = 54.063857495879915
cycle= 3 E= -128.532332185022  delta_E= -0.000847  |g|= 0.0005  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000998337
diis-c [-1.56345207e-07 -2.26371749e-03 -5.50600017e-04  1.00281432e+00]
  HOMO = -0.845612807831386  LUMO = 0.817561571676582
  mo_energy =
[-3.27695709e+01 -1.92734802e+00 -8.45612808e-01 -8.45612808e-01
 -8.45612808e-01  8.17561572e-01  1.09419080e+00  1.09419080e+00
  1.09419080e+00  4.36030891e+00  5.71768529e+00  5.71768529e+00
  5.71768529e+00  1.38582080e+01  2.41056378e+01  2.41056378e+01
  2.41056378e+01  4.44053324e+01  1.18933777e+02  1.18933777e+02
  1.18933777e+02  1.49910741e+02  5.13653925e+02  1.88024658e+03
  8.00873037e+03  4.77748780e+04]
E1 = -182.59674569985066  E_coul = 54.064413492039115
cycle= 4 E= -128.532332207812  delta_E= -2.28e-08  |g|= 6.44e-05  |ddm|= 0.000359
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133062
diis-c [-1.00142473e-09  3.23601661e-04  3.92598620e-04 -2.09959475e-01
  1.20924327e+00]
  HOMO = -0.845645923960243  LUMO = 0.817554028581114
  mo_energy =
[-3.27696244e+01 -1.92736898e+00 -8.45645924e-01 -8.45645924e-01
 -8.45645924e-01  8.17554029e-01  1.09417670e+00  1.09417670e+00
  1.09417670e+00  4.36028649e+00  5.71764853e+00  5.71764853e+00
  5.71764853e+00  1.38581702e+01  2.41055893e+01  2.41055893e+01
  2.41055893e+01  4.44052842e+01  1.18933723e+02  1.18933723e+02
  1.18933723e+02  1.49910687e+02  5.13653864e+02  1.88024651e+03
  8.00873030e+03  4.77748780e+04]
E1 = -182.5968494517268  E_coul = 54.06451724337528
cycle= 5 E= -128.532332208352  delta_E= -5.4e-10  |g|= 6.79e-06  |ddm|= 6.06e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5968494517268  E_coul = 54.06451724337528
  HOMO = -0.845642200768776  LUMO = 0.817555553706265
  mo_energy =
[-3.27696164e+01 -1.92736452e+00 -8.45642201e-01 -8.45642201e-01
 -8.45642201e-01  8.17555554e-01  1.09417828e+00  1.09417828e+00
  1.09417828e+00  4.36028983e+00  5.71765306e+00  5.71765306e+00
  5.71765306e+00  1.38581755e+01  2.41055962e+01  2.41055962e+01
  2.41055962e+01  4.44052913e+01  1.18933731e+02  1.18933731e+02
  1.18933731e+02  1.49910694e+02  5.13653871e+02  1.88024652e+03
  8.00873030e+03  4.77748780e+04]
E1 = -182.59683175382077  E_coul = 54.06449954546647
Extra cycle  E= -128.532332208354  delta_E= -2.76e-12  |g|= 2.48e-06  |ddm|= 2.68e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.41750024e-01 2.44137941e+04 3.66145457e+03 8.33269061e+02
 2.35759409e+02 7.62513815e+01 1.05971862e+01 2.75237312e+01
 3.18835698e-01 2.06263419e+00 3.28455624e+00 3.69332965e+00
 1.24485743e+01 5.47816105e+01 3.30986313e-01 1.15113462e+00]
E = -128.5323322083543
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.841750024142       1
[INPUT] 0    0    [1    /1   ]  24413.7941282        1
[INPUT] 0    0    [1    /1   ]  3661.45456636        1
[INPUT] 0    0    [1    /1   ]  833.269060573        1
[INPUT] 0    0    [1    /1   ]  235.759408834        1
[INPUT] 0    0    [1    /1   ]  76.2513815232        1
[INPUT] 0    0    [1    /1   ]  10.5971862325        1
[INPUT] 0    0    [1    /1   ]  27.5237312468        1
[INPUT] 0    0    [1    /1   ]  0.318835698189       1
[INPUT] 0    0    [1    /1   ]  2.06263419277        1
[INPUT] 0    0    [1    /1   ]  3.28455624491        1
[INPUT] 1    0    [1    /1   ]  3.69332965371        1
[INPUT] 1    0    [1    /1   ]  12.448574328         1
[INPUT] 1    0    [1    /1   ]  54.7816104905        1
[INPUT] 1    0    [1    /1   ]  0.330986313285       1
[INPUT] 1    0    [1    /1   ]  1.15113461836        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8417500241424662, 1.0]], [0, [24413.794128155336, 1.0]], [0, [3661.4545663577946, 1.0]], [0, [833.2690605730959, 1.0]], [0, [235.75940883367065, 1.0]], [0, [76.25138152322914, 1.0]], [0, [10.597186232495497, 1.0]], [0, [27.523731246764406, 1.0]], [0, [0.3188356981891845, 1.0]], [0, [2.062634192768506, 1.0]], [0, [3.28455624490598, 1.0]], [1, [3.693329653709057, 1.0]], [1, [12.44857432798496, 1.0]], [1, [54.78161049052144, 1.0]], [1, [0.3309863132852151, 1.0]], [1, [1.1511346183564688, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84175002]
bas 1, expnt(s) = [24413.79412816]
bas 2, expnt(s) = [3661.45456636]
bas 3, expnt(s) = [833.26906057]
bas 4, expnt(s) = [235.75940883]
bas 5, expnt(s) = [76.25138152]
bas 6, expnt(s) = [10.59718623]
bas 7, expnt(s) = [27.52373125]
bas 8, expnt(s) = [0.3188357]
bas 9, expnt(s) = [2.06263419]
bas 10, expnt(s) = [3.28455624]
bas 11, expnt(s) = [3.69332965]
bas 12, expnt(s) = [12.44857433]
bas 13, expnt(s) = [54.78161049]
bas 14, expnt(s) = [0.33098631]
bas 15, expnt(s) = [1.15113462]
CPU time:       134.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.41750024e-01 2.22025255e+00 2.44137941e+04 4.93448102e+03
 3.66145457e+03 1.18920099e+03 8.33269061e+02 3.91835668e+02
 2.35759409e+02 1.52008124e+02 7.62513815e+01 6.51929768e+01
 1.05971862e+01 1.48391132e+01 2.75237312e+01 3.03595623e+01
 3.18835698e-01 1.07198876e+00 2.06263419e+00 4.34842200e+00
 3.28455624e+00 6.16414082e+00 3.69332965e+00 1.49367800e+01
 1.24485743e+01 6.82156330e+01 5.47816105e+01 4.34788338e+02
 3.30986313e-01 7.32397641e-01 1.15113462e+00 3.47850023e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998454279556137
cond(S) = 2497.7512487181802
E1 = -183.57811120707362  E_coul = 55.078534631893405
init E= -128.49957657518
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77393621565219  LUMO = 0.836752548657502
  mo_energy =
[-3.25554092e+01 -1.85289258e+00 -7.73936216e-01 -7.73936216e-01
 -7.73936216e-01  8.36752549e-01  1.12019438e+00  1.12019438e+00
  1.12019438e+00  4.41289790e+00  5.80526458e+00  5.80526458e+00
  5.80526458e+00  1.39583290e+01  2.42635038e+01  2.42635038e+01
  2.42635038e+01  4.45684150e+01  1.19150202e+02  1.19150202e+02
  1.19150202e+02  1.50120786e+02  5.13897949e+02  1.88052188e+03
  8.00903246e+03  4.77751981e+04]
E1 = -182.11004666107084  E_coul = 53.5810650185261
cycle= 1 E= -128.528981642545  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461237
diis-c [-0.21273919  1.        ]
  HOMO = -0.879701234641382  LUMO = 0.80842637988855
  mo_energy =
[-3.28741134e+01 -1.96326187e+00 -8.79701235e-01 -8.79701235e-01
 -8.79701235e-01  8.08426380e-01  1.08168941e+00  1.08168941e+00
  1.08168941e+00  4.33553476e+00  5.67590077e+00  5.67590077e+00
  5.67590077e+00  1.38101362e+01  2.40284660e+01  2.40284660e+01
  2.40284660e+01  4.43252685e+01  1.18829225e+02  1.18829225e+02
  1.18829225e+02  1.49808602e+02  5.13541024e+02  1.88012849e+03
  8.00860991e+03  4.77747567e+04]
E1 = -182.8417274844256  E_coul = 54.310242380375904
cycle= 2 E= -128.53148510405  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0683
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230281
diis-c [-6.40965992e-04  3.31993063e-01  6.68006937e-01]
  HOMO = -0.845360372341262  LUMO = 0.81760647111158
  mo_energy =
[-3.27691277e+01 -1.92715838e+00 -8.45360372e-01 -8.45360372e-01
 -8.45360372e-01  8.17606471e-01  1.09425011e+00  1.09425011e+00
  1.09425011e+00  4.36045149e+00  5.71791097e+00  5.71791097e+00
  5.71791097e+00  1.38584608e+01  2.41059910e+01  2.41059910e+01
  2.41059910e+01  4.44056876e+01  1.18934232e+02  1.18934232e+02
  1.18934232e+02  1.49911182e+02  5.13654470e+02  1.88024724e+03
  8.00873112e+03  4.77748788e+04]
E1 = -182.59618968090192  E_coul = 54.063857495879915
cycle= 3 E= -128.532332185022  delta_E= -0.000847  |g|= 0.0005  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000998337
diis-c [-1.56345207e-07 -2.26371749e-03 -5.50600017e-04  1.00281432e+00]
  HOMO = -0.845612807831386  LUMO = 0.817561571676582
  mo_energy =
[-3.27695709e+01 -1.92734802e+00 -8.45612808e-01 -8.45612808e-01
 -8.45612808e-01  8.17561572e-01  1.09419080e+00  1.09419080e+00
  1.09419080e+00  4.36030891e+00  5.71768529e+00  5.71768529e+00
  5.71768529e+00  1.38582080e+01  2.41056378e+01  2.41056378e+01
  2.41056378e+01  4.44053324e+01  1.18933777e+02  1.18933777e+02
  1.18933777e+02  1.49910741e+02  5.13653925e+02  1.88024658e+03
  8.00873037e+03  4.77748780e+04]
E1 = -182.59674569985066  E_coul = 54.064413492039115
cycle= 4 E= -128.532332207812  delta_E= -2.28e-08  |g|= 6.44e-05  |ddm|= 0.000359
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133062
diis-c [-1.00142473e-09  3.23601661e-04  3.92598620e-04 -2.09959475e-01
  1.20924327e+00]
  HOMO = -0.845645923960243  LUMO = 0.817554028581114
  mo_energy =
[-3.27696244e+01 -1.92736898e+00 -8.45645924e-01 -8.45645924e-01
 -8.45645924e-01  8.17554029e-01  1.09417670e+00  1.09417670e+00
  1.09417670e+00  4.36028649e+00  5.71764853e+00  5.71764853e+00
  5.71764853e+00  1.38581702e+01  2.41055893e+01  2.41055893e+01
  2.41055893e+01  4.44052842e+01  1.18933723e+02  1.18933723e+02
  1.18933723e+02  1.49910687e+02  5.13653864e+02  1.88024651e+03
  8.00873030e+03  4.77748780e+04]
E1 = -182.5968494517268  E_coul = 54.06451724337528
cycle= 5 E= -128.532332208352  delta_E= -5.4e-10  |g|= 6.79e-06  |ddm|= 6.06e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5968494517268  E_coul = 54.06451724337528
  HOMO = -0.845642200768776  LUMO = 0.817555553706265
  mo_energy =
[-3.27696164e+01 -1.92736452e+00 -8.45642201e-01 -8.45642201e-01
 -8.45642201e-01  8.17555554e-01  1.09417828e+00  1.09417828e+00
  1.09417828e+00  4.36028983e+00  5.71765306e+00  5.71765306e+00
  5.71765306e+00  1.38581755e+01  2.41055962e+01  2.41055962e+01
  2.41055962e+01  4.44052913e+01  1.18933731e+02  1.18933731e+02
  1.18933731e+02  1.49910694e+02  5.13653871e+02  1.88024652e+03
  8.00873030e+03  4.77748780e+04]
E1 = -182.59683175382077  E_coul = 54.06449954546647
Extra cycle  E= -128.532332208354  delta_E= -2.76e-12  |g|= 2.48e-06  |ddm|= 2.68e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2497.7512487181802
E1 = -182.59683175382077  E_coul = 54.06449954546647
init E= -128.532332208354
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.84564343798819  LUMO = 0.81755529460697
  mo_energy =
[-3.27696203e+01 -1.92736570e+00 -8.45643438e-01 -8.45643438e-01
 -8.45643438e-01  8.17555295e-01  1.09417784e+00  1.09417784e+00
  1.09417784e+00  4.36028902e+00  5.71765155e+00  5.71765155e+00
  5.71765155e+00  1.38581738e+01  2.41055933e+01  2.41055933e+01
  2.41055933e+01  4.44052884e+01  1.18933727e+02  1.18933727e+02
  1.18933727e+02  1.49910691e+02  5.13653867e+02  1.88024651e+03
  8.00873030e+03  4.77748780e+04]
E1 = -182.59684131196244  E_coul = 54.06450910360737
cycle= 1 E= -128.532332208355  delta_E= -7.67e-13  |g|= 1.31e-06  |ddm|= 9.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59684131196244  E_coul = 54.06450910360737
  HOMO = -0.845642766075303  LUMO = 0.817555486738642
  mo_energy =
[-3.27696183e+01 -1.92736497e+00 -8.45642766e-01 -8.45642766e-01
 -8.45642766e-01  8.17555487e-01  1.09417809e+00  1.09417809e+00
  1.09417809e+00  4.36028952e+00  5.71765238e+00  5.71765238e+00
  5.71765238e+00  1.38581748e+01  2.41055949e+01  2.41055949e+01
  2.41055949e+01  4.44052900e+01  1.18933729e+02  1.18933729e+02
  1.18933729e+02  1.49910693e+02  5.13653869e+02  1.88024652e+03
  8.00873030e+03  4.77748780e+04]
E1 = -182.59683656313626  E_coul = 54.06450435478143
Extra cycle  E= -128.532332208355  delta_E= 2.27e-13  |g|= 6.46e-07  |ddm|= 4.55e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [8.41750024e-01 2.44137941e+04 3.66145457e+03 8.33269061e+02
 2.35759409e+02 7.62513815e+01 1.05971862e+01 2.75237312e+01
 3.18835698e-01 2.06263419e+00 3.28455624e+00 3.69332965e+00
 1.24485743e+01 5.47816105e+01 3.30986313e-01 1.15113462e+00]
grad_E = [-7.02065265e-05 -1.57670428e-09  8.22191007e-08 -1.55226766e-06
  1.53315948e-05 -6.90958826e-05 -2.67905295e-04  1.03012700e-04
 -3.16072359e-05  9.22570211e-05 -4.09351797e-05 -9.92334914e-04
  2.31287534e-05  6.81842626e-07 -8.46388985e-03  5.42161409e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.874001539914       1
[INPUT] 0    0    [1    /1   ]  24413.7941276        1
[INPUT] 0    0    [1    /1   ]  3661.45459765        1
[INPUT] 0    0    [1    /1   ]  833.268412012        1
[INPUT] 0    0    [1    /1   ]  235.767452461        1
[INPUT] 0    0    [1    /1   ]  76.1911887396        1
[INPUT] 0    0    [1    /1   ]  10.768697411         1
[INPUT] 0    0    [1    /1   ]  27.6889507766        1
[INPUT] 0    0    [1    /1   ]  0.325476549513       1
[INPUT] 0    0    [1    /1   ]  2.21752329016        1
[INPUT] 0    0    [1    /1   ]  3.41628874195        1
[INPUT] 1    0    [1    /1   ]  3.69029772608        1
[INPUT] 1    0    [1    /1   ]  12.4529281951        1
[INPUT] 1    0    [1    /1   ]  54.7799776869        1
[INPUT] 1    0    [1    /1   ]  0.330664607277       1
[INPUT] 1    0    [1    /1   ]  1.1479466014         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8740015399143668, 1.0]], [0, [24413.794127559646, 1.0]], [0, [3661.454597647494, 1.0]], [0, [833.2684120124437, 1.0]], [0, [235.76745246057337, 1.0]], [0, [76.19118873956936, 1.0]], [0, [10.768697410997058, 1.0]], [0, [27.688950776604955, 1.0]], [0, [0.3254765495133362, 1.0]], [0, [2.217523290157398, 1.0]], [0, [3.4162887419518984, 1.0]], [1, [3.6902977260783865, 1.0]], [1, [12.45292819507175, 1.0]], [1, [54.77997768689073, 1.0]], [1, [0.33066460727730956, 1.0]], [1, [1.1479466014044792, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.87400154]
bas 1, expnt(s) = [24413.79412756]
bas 2, expnt(s) = [3661.45459765]
bas 3, expnt(s) = [833.26841201]
bas 4, expnt(s) = [235.76745246]
bas 5, expnt(s) = [76.19118874]
bas 6, expnt(s) = [10.76869741]
bas 7, expnt(s) = [27.68895078]
bas 8, expnt(s) = [0.32547655]
bas 9, expnt(s) = [2.21752329]
bas 10, expnt(s) = [3.41628874]
bas 11, expnt(s) = [3.69029773]
bas 12, expnt(s) = [12.4529282]
bas 13, expnt(s) = [54.77997769]
bas 14, expnt(s) = [0.33066461]
bas 15, expnt(s) = [1.1479466]
CPU time:       138.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.74001540e-01 2.28375322e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268412e+02 3.91835440e+02
 2.35767452e+02 1.52012014e+02 7.61911887e+01 6.51543755e+01
 1.07686974e+01 1.50188751e+01 2.76889508e+01 3.04961418e+01
 3.25476550e-01 1.08869142e+00 2.21752329e+00 4.59109381e+00
 3.41628874e+00 6.34864366e+00 3.69029773e+00 1.49214542e+01
 1.24529282e+01 6.82454572e+01 5.47799777e+01 4.34772139e+02
 3.30664607e-01 7.31507921e-01 1.14794660e+00 3.46646246e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998467029610463
cond(S) = 2873.204217524999
E1 = -183.57822726676577  E_coul = 55.078541967007936
init E= -128.499685299758
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773938313313192  LUMO = 0.873487804939246
  mo_energy =
[-3.25554152e+01 -1.85288910e+00 -7.73938313e-01 -7.73938313e-01
 -7.73938313e-01  8.73487805e-01  1.11813769e+00  1.11813769e+00
  1.11813769e+00  4.65468412e+00  5.79326385e+00  5.79326385e+00
  5.79326385e+00  1.47470495e+01  2.42474039e+01  2.42474039e+01
  2.42474039e+01  4.61812727e+01  1.19143407e+02  1.19143407e+02
  1.19143407e+02  1.52342350e+02  5.16190967e+02  1.88262498e+03
  8.01089273e+03  4.77767402e+04]
E1 = -182.11082854844727  E_coul = 53.58182670226655
cycle= 1 E= -128.529001846181  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461459
diis-c [-0.21294413  1.        ]
  HOMO = -0.879633700767521  LUMO = 0.843774776634706
  mo_energy =
[-3.28740238e+01 -1.96318302e+00 -8.79633701e-01 -8.79633701e-01
 -8.79633701e-01  8.43774777e-01  1.07977499e+00  1.07977499e+00
  1.07977499e+00  4.57373727e+00  5.66411285e+00  5.66411285e+00
  5.66411285e+00  1.45950707e+01  2.40124181e+01  2.40124181e+01
  2.40124181e+01  4.59370895e+01  1.18822522e+02  1.18822522e+02
  1.18822522e+02  1.52030280e+02  5.15834221e+02  1.88223171e+03
  8.01047029e+03  4.77762989e+04]
E1 = -182.84250719656555  E_coul = 54.31100179223478
cycle= 2 E= -128.531505404331  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0691
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230412
diis-c [-6.48837092e-04  3.32001282e-01  6.67998718e-01]
  HOMO = -0.845292361456462  LUMO = 0.853413898634588
  mo_energy =
[-3.27690449e+01 -1.92707798e+00 -8.45292361e-01 -8.45292361e-01
 -8.45292361e-01  8.53413899e-01  1.09230340e+00  1.09230340e+00
  1.09230340e+00  4.59984642e+00  5.70608174e+00  5.70608174e+00
  5.70608174e+00  1.46446851e+01  2.40899499e+01  2.40899499e+01
  2.40899499e+01  4.60178732e+01  1.18927525e+02  1.18927525e+02
  1.18927525e+02  1.52132841e+02  5.15947635e+02  1.88235044e+03
  8.01059148e+03  4.77764210e+04]
E1 = -182.59707305722472  E_coul = 54.06472096136929
cycle= 3 E= -128.532352095855  delta_E= -0.000847  |g|= 0.000487  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000977158
diis-c [-1.54261648e-07 -2.23964661e-03 -6.00696015e-04  1.00284034e+00]
  HOMO = -0.845537417873477  LUMO = 0.853370465248994
  mo_energy =
[-3.27694761e+01 -1.92725906e+00 -8.45537418e-01 -8.45537418e-01
 -8.45537418e-01  8.53370465e-01  1.09224790e+00  1.09224790e+00
  1.09224790e+00  4.59970475e+00  5.70586502e+00  5.70586502e+00
  5.70586502e+00  1.46444368e+01  2.40896080e+01  2.40896080e+01
  2.40896080e+01  4.60175278e+01  1.18927082e+02  1.18927082e+02
  1.18927082e+02  1.52132411e+02  5.15947102e+02  1.88234980e+03
  8.01059075e+03  4.77764202e+04]
E1 = -182.5976110676261  E_coul = 54.06525894986759
cycle= 4 E= -128.532352117759  delta_E= -2.19e-08  |g|= 6.4e-05  |ddm|= 0.000361
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132933
diis-c [-1.01441521e-09  3.27819691e-04  4.08738404e-04 -2.13005391e-01
  1.21226883e+00]
  HOMO = -0.84557003566891  LUMO = 0.853362937154303
  mo_energy =
[-3.27695292e+01 -1.92727928e+00 -8.45570036e-01 -8.45570036e-01
 -8.45570036e-01  8.53362937e-01  1.09223414e+00  1.09223414e+00
  1.09223414e+00  4.59968204e+00  5.70582885e+00  5.70582885e+00
  5.70582885e+00  1.46443989e+01  2.40895600e+01  2.40895600e+01
  2.40895600e+01  4.60174801e+01  1.18927028e+02  1.18927028e+02
  1.18927028e+02  1.52132358e+02  5.15947041e+02  1.88234973e+03
  8.01059068e+03  4.77764201e+04]
E1 = -182.5977152484558  E_coul = 54.06536313015963
cycle= 5 E= -128.532352118296  delta_E= -5.38e-10  |g|= 6.85e-06  |ddm|= 6.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5977152484558  E_coul = 54.06536313015963
  HOMO = -0.84556625399052  LUMO = 0.853364537032627
  mo_energy =
[-3.27695209e+01 -1.92727478e+00 -8.45566254e-01 -8.45566254e-01
 -8.45566254e-01  8.53364537e-01  1.09223573e+00  1.09223573e+00
  1.09223573e+00  4.59968555e+00  5.70583345e+00  5.70583345e+00
  5.70583345e+00  1.46444044e+01  2.40895670e+01  2.40895670e+01
  2.40895670e+01  4.60174873e+01  1.18927036e+02  1.18927036e+02
  1.18927036e+02  1.52132366e+02  5.15947049e+02  1.88234974e+03
  8.01059068e+03  4.77764201e+04]
E1 = -182.59769720703972  E_coul = 54.06534508874034
Extra cycle  E= -128.532352118299  delta_E= -3.18e-12  |g|= 2.52e-06  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.74001540e-01 2.44137941e+04 3.66145460e+03 8.33268412e+02
 2.35767452e+02 7.61911887e+01 1.07686974e+01 2.76889508e+01
 3.25476550e-01 2.21752329e+00 3.41628874e+00 3.69029773e+00
 1.24529282e+01 5.47799777e+01 3.30664607e-01 1.14794660e+00]
E = -128.53235211829937
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.874001539914       1
[INPUT] 0    0    [1    /1   ]  24413.7941276        1
[INPUT] 0    0    [1    /1   ]  3661.45459765        1
[INPUT] 0    0    [1    /1   ]  833.268412012        1
[INPUT] 0    0    [1    /1   ]  235.767452461        1
[INPUT] 0    0    [1    /1   ]  76.1911887396        1
[INPUT] 0    0    [1    /1   ]  10.768697411         1
[INPUT] 0    0    [1    /1   ]  27.6889507766        1
[INPUT] 0    0    [1    /1   ]  0.325476549513       1
[INPUT] 0    0    [1    /1   ]  2.21752329016        1
[INPUT] 0    0    [1    /1   ]  3.41628874195        1
[INPUT] 1    0    [1    /1   ]  3.69029772608        1
[INPUT] 1    0    [1    /1   ]  12.4529281951        1
[INPUT] 1    0    [1    /1   ]  54.7799776869        1
[INPUT] 1    0    [1    /1   ]  0.330664607277       1
[INPUT] 1    0    [1    /1   ]  1.1479466014         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8740015399143668, 1.0]], [0, [24413.794127559646, 1.0]], [0, [3661.454597647494, 1.0]], [0, [833.2684120124437, 1.0]], [0, [235.76745246057337, 1.0]], [0, [76.19118873956936, 1.0]], [0, [10.768697410997058, 1.0]], [0, [27.688950776604955, 1.0]], [0, [0.3254765495133362, 1.0]], [0, [2.217523290157398, 1.0]], [0, [3.4162887419518984, 1.0]], [1, [3.6902977260783865, 1.0]], [1, [12.45292819507175, 1.0]], [1, [54.77997768689073, 1.0]], [1, [0.33066460727730956, 1.0]], [1, [1.1479466014044792, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.87400154]
bas 1, expnt(s) = [24413.79412756]
bas 2, expnt(s) = [3661.45459765]
bas 3, expnt(s) = [833.26841201]
bas 4, expnt(s) = [235.76745246]
bas 5, expnt(s) = [76.19118874]
bas 6, expnt(s) = [10.76869741]
bas 7, expnt(s) = [27.68895078]
bas 8, expnt(s) = [0.32547655]
bas 9, expnt(s) = [2.21752329]
bas 10, expnt(s) = [3.41628874]
bas 11, expnt(s) = [3.69029773]
bas 12, expnt(s) = [12.4529282]
bas 13, expnt(s) = [54.77997769]
bas 14, expnt(s) = [0.33066461]
bas 15, expnt(s) = [1.1479466]
CPU time:       138.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.74001540e-01 2.28375322e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268412e+02 3.91835440e+02
 2.35767452e+02 1.52012014e+02 7.61911887e+01 6.51543755e+01
 1.07686974e+01 1.50188751e+01 2.76889508e+01 3.04961418e+01
 3.25476550e-01 1.08869142e+00 2.21752329e+00 4.59109381e+00
 3.41628874e+00 6.34864366e+00 3.69029773e+00 1.49214542e+01
 1.24529282e+01 6.82454572e+01 5.47799777e+01 4.34772139e+02
 3.30664607e-01 7.31507921e-01 1.14794660e+00 3.46646246e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998467029610463
cond(S) = 2873.204217524999
E1 = -183.57822726676577  E_coul = 55.078541967007936
init E= -128.499685299758
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773938313313192  LUMO = 0.873487804939246
  mo_energy =
[-3.25554152e+01 -1.85288910e+00 -7.73938313e-01 -7.73938313e-01
 -7.73938313e-01  8.73487805e-01  1.11813769e+00  1.11813769e+00
  1.11813769e+00  4.65468412e+00  5.79326385e+00  5.79326385e+00
  5.79326385e+00  1.47470495e+01  2.42474039e+01  2.42474039e+01
  2.42474039e+01  4.61812727e+01  1.19143407e+02  1.19143407e+02
  1.19143407e+02  1.52342350e+02  5.16190967e+02  1.88262498e+03
  8.01089273e+03  4.77767402e+04]
E1 = -182.11082854844727  E_coul = 53.58182670226655
cycle= 1 E= -128.529001846181  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461459
diis-c [-0.21294413  1.        ]
  HOMO = -0.879633700767521  LUMO = 0.843774776634706
  mo_energy =
[-3.28740238e+01 -1.96318302e+00 -8.79633701e-01 -8.79633701e-01
 -8.79633701e-01  8.43774777e-01  1.07977499e+00  1.07977499e+00
  1.07977499e+00  4.57373727e+00  5.66411285e+00  5.66411285e+00
  5.66411285e+00  1.45950707e+01  2.40124181e+01  2.40124181e+01
  2.40124181e+01  4.59370895e+01  1.18822522e+02  1.18822522e+02
  1.18822522e+02  1.52030280e+02  5.15834221e+02  1.88223171e+03
  8.01047029e+03  4.77762989e+04]
E1 = -182.84250719656555  E_coul = 54.31100179223478
cycle= 2 E= -128.531505404331  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0691
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230412
diis-c [-6.48837092e-04  3.32001282e-01  6.67998718e-01]
  HOMO = -0.845292361456462  LUMO = 0.853413898634588
  mo_energy =
[-3.27690449e+01 -1.92707798e+00 -8.45292361e-01 -8.45292361e-01
 -8.45292361e-01  8.53413899e-01  1.09230340e+00  1.09230340e+00
  1.09230340e+00  4.59984642e+00  5.70608174e+00  5.70608174e+00
  5.70608174e+00  1.46446851e+01  2.40899499e+01  2.40899499e+01
  2.40899499e+01  4.60178732e+01  1.18927525e+02  1.18927525e+02
  1.18927525e+02  1.52132841e+02  5.15947635e+02  1.88235044e+03
  8.01059148e+03  4.77764210e+04]
E1 = -182.59707305722472  E_coul = 54.06472096136929
cycle= 3 E= -128.532352095855  delta_E= -0.000847  |g|= 0.000487  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000977158
diis-c [-1.54261648e-07 -2.23964661e-03 -6.00696015e-04  1.00284034e+00]
  HOMO = -0.845537417873477  LUMO = 0.853370465248994
  mo_energy =
[-3.27694761e+01 -1.92725906e+00 -8.45537418e-01 -8.45537418e-01
 -8.45537418e-01  8.53370465e-01  1.09224790e+00  1.09224790e+00
  1.09224790e+00  4.59970475e+00  5.70586502e+00  5.70586502e+00
  5.70586502e+00  1.46444368e+01  2.40896080e+01  2.40896080e+01
  2.40896080e+01  4.60175278e+01  1.18927082e+02  1.18927082e+02
  1.18927082e+02  1.52132411e+02  5.15947102e+02  1.88234980e+03
  8.01059075e+03  4.77764202e+04]
E1 = -182.5976110676261  E_coul = 54.06525894986759
cycle= 4 E= -128.532352117759  delta_E= -2.19e-08  |g|= 6.4e-05  |ddm|= 0.000361
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132933
diis-c [-1.01441521e-09  3.27819691e-04  4.08738404e-04 -2.13005391e-01
  1.21226883e+00]
  HOMO = -0.84557003566891  LUMO = 0.853362937154303
  mo_energy =
[-3.27695292e+01 -1.92727928e+00 -8.45570036e-01 -8.45570036e-01
 -8.45570036e-01  8.53362937e-01  1.09223414e+00  1.09223414e+00
  1.09223414e+00  4.59968204e+00  5.70582885e+00  5.70582885e+00
  5.70582885e+00  1.46443989e+01  2.40895600e+01  2.40895600e+01
  2.40895600e+01  4.60174801e+01  1.18927028e+02  1.18927028e+02
  1.18927028e+02  1.52132358e+02  5.15947041e+02  1.88234973e+03
  8.01059068e+03  4.77764201e+04]
E1 = -182.5977152484558  E_coul = 54.06536313015963
cycle= 5 E= -128.532352118296  delta_E= -5.38e-10  |g|= 6.85e-06  |ddm|= 6.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5977152484558  E_coul = 54.06536313015963
  HOMO = -0.84556625399052  LUMO = 0.853364537032627
  mo_energy =
[-3.27695209e+01 -1.92727478e+00 -8.45566254e-01 -8.45566254e-01
 -8.45566254e-01  8.53364537e-01  1.09223573e+00  1.09223573e+00
  1.09223573e+00  4.59968555e+00  5.70583345e+00  5.70583345e+00
  5.70583345e+00  1.46444044e+01  2.40895670e+01  2.40895670e+01
  2.40895670e+01  4.60174873e+01  1.18927036e+02  1.18927036e+02
  1.18927036e+02  1.52132366e+02  5.15947049e+02  1.88234974e+03
  8.01059068e+03  4.77764201e+04]
E1 = -182.59769720703972  E_coul = 54.06534508874034
Extra cycle  E= -128.532352118299  delta_E= -3.18e-12  |g|= 2.52e-06  |ddm|= 2.89e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2873.204217524999
E1 = -182.59769720703972  E_coul = 54.06534508874034
init E= -128.532352118299
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845567514041843  LUMO = 0.853364255471912
  mo_energy =
[-3.27695250e+01 -1.92727600e+00 -8.45567514e-01 -8.45567514e-01
 -8.45567514e-01  8.53364255e-01  1.09223529e+00  1.09223529e+00
  1.09223529e+00  4.59968467e+00  5.70583191e+00  5.70583191e+00
  5.70583191e+00  1.46444026e+01  2.40895641e+01  2.40895641e+01
  2.40895641e+01  4.60174843e+01  1.18927032e+02  1.18927032e+02
  1.18927032e+02  1.52132362e+02  5.15947044e+02  1.88234973e+03
  8.01059068e+03  4.77764201e+04]
E1 = -182.59770693662963  E_coul = 54.06535481833016
cycle= 1 E= -128.532352118299  delta_E= -1.14e-13  |g|= 1.33e-06  |ddm|= 9.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59770693662963  E_coul = 54.06535481833016
  HOMO = -0.845566829794228  LUMO = 0.853364460019425
  mo_energy =
[-3.27695229e+01 -1.92727525e+00 -8.45566830e-01 -8.45566830e-01
 -8.45566830e-01  8.53364460e-01  1.09223554e+00  1.09223554e+00
  1.09223554e+00  4.59968521e+00  5.70583275e+00  5.70583275e+00
  5.70583275e+00  1.46444036e+01  2.40895657e+01  2.40895657e+01
  2.40895657e+01  4.60174859e+01  1.18927034e+02  1.18927034e+02
  1.18927034e+02  1.52132364e+02  5.15947047e+02  1.88234973e+03
  8.01059068e+03  4.77764201e+04]
E1 = -182.5977021023286  E_coul = 54.065349984028835
Extra cycle  E= -128.5323521183  delta_E= -2.84e-13  |g|= 6.58e-07  |ddm|= 4.7e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.74001540e-01 2.44137941e+04 3.66145460e+03 8.33268412e+02
 2.35767452e+02 7.61911887e+01 1.07686974e+01 2.76889508e+01
 3.25476550e-01 2.21752329e+00 3.41628874e+00 3.69029773e+00
 1.24529282e+01 5.47799777e+01 3.30664607e-01 1.14794660e+00]
grad_E = [ 7.48050779e-07 -2.10875878e-09  1.10084950e-07 -2.07717437e-06
  2.06018889e-05 -9.15927996e-05 -2.25343638e-04  1.16991818e-04
 -2.00374766e-04  9.12051268e-05 -2.79482226e-05 -4.96749137e-04
  1.66735206e-05 -7.05868674e-07 -4.21146279e-03  2.78374149e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.884591308046       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460866        1
[INPUT] 0    0    [1    /1   ]  833.268182789        1
[INPUT] 0    0    [1    /1   ]  235.770312011        1
[INPUT] 0    0    [1    /1   ]  76.1698823624        1
[INPUT] 0    0    [1    /1   ]  10.8557101046        1
[INPUT] 0    0    [1    /1   ]  27.7430495209        1
[INPUT] 0    0    [1    /1   ]  0.328126090756       1
[INPUT] 0    0    [1    /1   ]  2.29644717178        1
[INPUT] 0    0    [1    /1   ]  3.46485291144        1
[INPUT] 1    0    [1    /1   ]  3.68677998221        1
[INPUT] 1    0    [1    /1   ]  12.4552986263        1
[INPUT] 1    0    [1    /1   ]  54.7793115286        1
[INPUT] 1    0    [1    /1   ]  0.330220340882       1
[INPUT] 1    0    [1    /1   ]  1.14480709481        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8845913080455132, 1.0]], [0, [24413.794127350015, 1.0]], [0, [3661.4546086603555, 1.0]], [0, [833.268182788501, 1.0]], [0, [235.77031201066143, 1.0]], [0, [76.16988236242962, 1.0]], [0, [10.855710104587914, 1.0]], [0, [27.743049520868446, 1.0]], [0, [0.3281260907562239, 1.0]], [0, [2.2964471717789667, 1.0]], [0, [3.464852911444751, 1.0]], [1, [3.6867799822061214, 1.0]], [1, [12.455298626283131, 1.0]], [1, [54.779311528552675, 1.0]], [1, [0.3302203408820142, 1.0]], [1, [1.1448070948052769, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.88459131]
bas 1, expnt(s) = [24413.79412735]
bas 2, expnt(s) = [3661.45460866]
bas 3, expnt(s) = [833.26818279]
bas 4, expnt(s) = [235.77031201]
bas 5, expnt(s) = [76.16988236]
bas 6, expnt(s) = [10.8557101]
bas 7, expnt(s) = [27.74304952]
bas 8, expnt(s) = [0.32812609]
bas 9, expnt(s) = [2.29644717]
bas 10, expnt(s) = [3.46485291]
bas 11, expnt(s) = [3.68677998]
bas 12, expnt(s) = [12.45529863]
bas 13, expnt(s) = [54.77931153]
bas 14, expnt(s) = [0.33022034]
bas 15, expnt(s) = [1.14480709]
CPU time:       141.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.84591308e-01 2.30447513e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268183e+02 3.91835359e+02
 2.35770312e+02 1.52013397e+02 7.61698824e+01 6.51407100e+01
 1.08557101e+01 1.51097995e+01 2.77430495e+01 3.05408185e+01
 3.28126091e-01 1.09533155e+00 2.29644717e+00 4.71310775e+00
 3.46485291e+00 6.41621084e+00 3.68677998e+00 1.49036766e+01
 1.24552986e+01 6.82616958e+01 5.47793115e+01 4.34765531e+02
 3.30220341e-01 7.30279600e-01 1.14480709e+00 3.45461602e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998481594537846
cond(S) = 3124.032136243617
E1 = -183.57821860547193  E_coul = 55.07851581834434
init E= -128.499702787128
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773942476565613  LUMO = 0.887862583083494
  mo_energy =
[-3.25554214e+01 -1.85289023e+00 -7.73942477e-01 -7.73942477e-01
 -7.73942477e-01  8.87862583e-01  1.11573615e+00  1.11573615e+00
  1.11573615e+00  4.75617710e+00  5.78064598e+00  5.78064598e+00
  5.78064598e+00  1.50912003e+01  2.42276036e+01  2.42276036e+01
  2.42276036e+01  4.68927996e+01  1.19130315e+02  1.19130315e+02
  1.19130315e+02  1.53311532e+02  5.17182562e+02  1.88353356e+03
  8.01169626e+03  4.77774063e+04]
E1 = -182.11112992674975  E_coul = 53.58212256648574
cycle= 1 E= -128.529007360264  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461659
diis-c [-0.21312879  1.        ]
  HOMO = -0.879601502584405  LUMO = 0.857610938348356
  mo_energy =
[-3.28740087e+01 -1.96315042e+00 -8.79601503e-01 -8.79601503e-01
 -8.79601503e-01  8.57610938e-01  1.07750855e+00  1.07750855e+00
  1.07750855e+00  4.67370003e+00  5.65166793e+00  5.65166793e+00
  5.65166793e+00  1.49375821e+01  2.39926235e+01  2.39926235e+01
  2.39926235e+01  4.66481405e+01  1.18809449e+02  1.18809449e+02
  1.18809449e+02  1.52999495e+02  5.16825874e+02  1.88314032e+03
  8.01127384e+03  4.77769649e+04]
E1 = -182.84303034181804  E_coul = 54.31151839816086
cycle= 2 E= -128.531511943657  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230546
diis-c [-6.52388355e-04  3.32030152e-01  6.67969848e-01]
  HOMO = -0.845249658053822  LUMO = 0.867436786864929
  mo_energy =
[-3.27690097e+01 -1.92703366e+00 -8.45249658e-01 -8.45249658e-01
 -8.45249658e-01  8.67436787e-01  1.09000627e+00  1.09000627e+00
  1.09000627e+00  4.70033198e+00  5.69360567e+00  5.69360567e+00
  5.69360567e+00  1.49877698e+01  2.40701790e+01  2.40701790e+01
  2.40701790e+01  4.67291066e+01  1.18914475e+02  1.18914475e+02
  1.18914475e+02  1.53102070e+02  5.16939299e+02  1.88325907e+03
  8.01139505e+03  4.77770871e+04]
E1 = -182.59760050993407  E_coul = 54.065241688490666
cycle= 3 E= -128.532358821443  delta_E= -0.000847  |g|= 0.000475  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000956675
diis-c [-1.52282963e-07 -2.21661404e-03 -6.49621568e-04  1.00286624e+00]
  HOMO = -0.845488001887661  LUMO = 0.867395752582508
  mo_energy =
[-3.27694302e+01 -1.92720758e+00 -8.45488002e-01 -8.45488002e-01
 -8.45488002e-01  8.67395753e-01  1.08995423e+00  1.08995423e+00
  1.08995423e+00  4.70019419e+00  5.69339696e+00  5.69339696e+00
  5.69339696e+00  1.49875282e+01  2.40698472e+01  2.40698472e+01
  2.40698472e+01  4.67287708e+01  1.18914043e+02  1.18914043e+02
  1.18914043e+02  1.53101651e+02  5.16938776e+02  1.88325843e+03
  8.01139432e+03  4.77770863e+04]
E1 = -182.59812228892736  E_coul = 54.065763446499155
cycle= 4 E= -128.532358842428  delta_E= -2.1e-08  |g|= 6.32e-05  |ddm|= 0.000355
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132071
diis-c [-1.01255364e-09  3.29205530e-04  4.19947031e-04 -2.14793293e-01
  1.21404414e+00]
  HOMO = -0.845520061939846  LUMO = 0.867388398574523
  mo_energy =
[-3.27694826e+01 -1.92722715e+00 -8.45520062e-01 -8.45520062e-01
 -8.45520062e-01  8.67388399e-01  1.08994080e+00  1.08994080e+00
  1.08994080e+00  4.70017171e+00  5.69336144e+00  5.69336144e+00
  5.69336144e+00  1.49874908e+01  2.40697999e+01  2.40697999e+01
  2.40697999e+01  4.67287237e+01  1.18913990e+02  1.18913990e+02
  1.18913990e+02  1.53101598e+02  5.16938716e+02  1.88325837e+03
  8.01139425e+03  4.77770862e+04]
E1 = -182.59822612255456  E_coul = 54.06586727959657
cycle= 5 E= -128.532358842958  delta_E= -5.3e-10  |g|= 6.85e-06  |ddm|= 5.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59822612255456  E_coul = 54.06586727959657
  HOMO = -0.845516268422828  LUMO = 0.867390018026184
  mo_energy =
[-3.27694743e+01 -1.92722266e+00 -8.45516268e-01 -8.45516268e-01
 -8.45516268e-01  8.67390018e-01  1.08994239e+00  1.08994239e+00
  1.08994239e+00  4.70017526e+00  5.69336604e+00  5.69336604e+00
  5.69336604e+00  1.49874963e+01  2.40698070e+01  2.40698070e+01
  2.40698070e+01  4.67287310e+01  1.18913998e+02  1.18913998e+02
  1.18913998e+02  1.53101606e+02  5.16938724e+02  1.88325837e+03
  8.01139426e+03  4.77770862e+04]
E1 = -182.598207923446  E_coul = 54.065849080485194
Extra cycle  E= -128.532358842961  delta_E= -2.84e-12  |g|= 2.54e-06  |ddm|= 2.97e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.84591308e-01 2.44137941e+04 3.66145461e+03 8.33268183e+02
 2.35770312e+02 7.61698824e+01 1.08557101e+01 2.77430495e+01
 3.28126091e-01 2.29644717e+00 3.46485291e+00 3.68677998e+00
 1.24552986e+01 5.47793115e+01 3.30220341e-01 1.14480709e+00]
E = -128.53235884296083
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.884591308046       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460866        1
[INPUT] 0    0    [1    /1   ]  833.268182789        1
[INPUT] 0    0    [1    /1   ]  235.770312011        1
[INPUT] 0    0    [1    /1   ]  76.1698823624        1
[INPUT] 0    0    [1    /1   ]  10.8557101046        1
[INPUT] 0    0    [1    /1   ]  27.7430495209        1
[INPUT] 0    0    [1    /1   ]  0.328126090756       1
[INPUT] 0    0    [1    /1   ]  2.29644717178        1
[INPUT] 0    0    [1    /1   ]  3.46485291144        1
[INPUT] 1    0    [1    /1   ]  3.68677998221        1
[INPUT] 1    0    [1    /1   ]  12.4552986263        1
[INPUT] 1    0    [1    /1   ]  54.7793115286        1
[INPUT] 1    0    [1    /1   ]  0.330220340882       1
[INPUT] 1    0    [1    /1   ]  1.14480709481        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8845913080455132, 1.0]], [0, [24413.794127350015, 1.0]], [0, [3661.4546086603555, 1.0]], [0, [833.268182788501, 1.0]], [0, [235.77031201066143, 1.0]], [0, [76.16988236242962, 1.0]], [0, [10.855710104587914, 1.0]], [0, [27.743049520868446, 1.0]], [0, [0.3281260907562239, 1.0]], [0, [2.2964471717789667, 1.0]], [0, [3.464852911444751, 1.0]], [1, [3.6867799822061214, 1.0]], [1, [12.455298626283131, 1.0]], [1, [54.779311528552675, 1.0]], [1, [0.3302203408820142, 1.0]], [1, [1.1448070948052769, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.88459131]
bas 1, expnt(s) = [24413.79412735]
bas 2, expnt(s) = [3661.45460866]
bas 3, expnt(s) = [833.26818279]
bas 4, expnt(s) = [235.77031201]
bas 5, expnt(s) = [76.16988236]
bas 6, expnt(s) = [10.8557101]
bas 7, expnt(s) = [27.74304952]
bas 8, expnt(s) = [0.32812609]
bas 9, expnt(s) = [2.29644717]
bas 10, expnt(s) = [3.46485291]
bas 11, expnt(s) = [3.68677998]
bas 12, expnt(s) = [12.45529863]
bas 13, expnt(s) = [54.77931153]
bas 14, expnt(s) = [0.33022034]
bas 15, expnt(s) = [1.14480709]
CPU time:       142.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.84591308e-01 2.30447513e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268183e+02 3.91835359e+02
 2.35770312e+02 1.52013397e+02 7.61698824e+01 6.51407100e+01
 1.08557101e+01 1.51097995e+01 2.77430495e+01 3.05408185e+01
 3.28126091e-01 1.09533155e+00 2.29644717e+00 4.71310775e+00
 3.46485291e+00 6.41621084e+00 3.68677998e+00 1.49036766e+01
 1.24552986e+01 6.82616958e+01 5.47793115e+01 4.34765531e+02
 3.30220341e-01 7.30279600e-01 1.14480709e+00 3.45461602e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998481594537846
cond(S) = 3124.032136243617
E1 = -183.57821860547193  E_coul = 55.07851581834434
init E= -128.499702787128
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773942476565613  LUMO = 0.887862583083494
  mo_energy =
[-3.25554214e+01 -1.85289023e+00 -7.73942477e-01 -7.73942477e-01
 -7.73942477e-01  8.87862583e-01  1.11573615e+00  1.11573615e+00
  1.11573615e+00  4.75617710e+00  5.78064598e+00  5.78064598e+00
  5.78064598e+00  1.50912003e+01  2.42276036e+01  2.42276036e+01
  2.42276036e+01  4.68927996e+01  1.19130315e+02  1.19130315e+02
  1.19130315e+02  1.53311532e+02  5.17182562e+02  1.88353356e+03
  8.01169626e+03  4.77774063e+04]
E1 = -182.11112992674975  E_coul = 53.58212256648574
cycle= 1 E= -128.529007360264  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461659
diis-c [-0.21312879  1.        ]
  HOMO = -0.879601502584405  LUMO = 0.857610938348356
  mo_energy =
[-3.28740087e+01 -1.96315042e+00 -8.79601503e-01 -8.79601503e-01
 -8.79601503e-01  8.57610938e-01  1.07750855e+00  1.07750855e+00
  1.07750855e+00  4.67370003e+00  5.65166793e+00  5.65166793e+00
  5.65166793e+00  1.49375821e+01  2.39926235e+01  2.39926235e+01
  2.39926235e+01  4.66481405e+01  1.18809449e+02  1.18809449e+02
  1.18809449e+02  1.52999495e+02  5.16825874e+02  1.88314032e+03
  8.01127384e+03  4.77769649e+04]
E1 = -182.84303034181804  E_coul = 54.31151839816086
cycle= 2 E= -128.531511943657  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230546
diis-c [-6.52388355e-04  3.32030152e-01  6.67969848e-01]
  HOMO = -0.845249658053822  LUMO = 0.867436786864929
  mo_energy =
[-3.27690097e+01 -1.92703366e+00 -8.45249658e-01 -8.45249658e-01
 -8.45249658e-01  8.67436787e-01  1.09000627e+00  1.09000627e+00
  1.09000627e+00  4.70033198e+00  5.69360567e+00  5.69360567e+00
  5.69360567e+00  1.49877698e+01  2.40701790e+01  2.40701790e+01
  2.40701790e+01  4.67291066e+01  1.18914475e+02  1.18914475e+02
  1.18914475e+02  1.53102070e+02  5.16939299e+02  1.88325907e+03
  8.01139505e+03  4.77770871e+04]
E1 = -182.59760050993407  E_coul = 54.065241688490666
cycle= 3 E= -128.532358821443  delta_E= -0.000847  |g|= 0.000475  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000956675
diis-c [-1.52282963e-07 -2.21661404e-03 -6.49621568e-04  1.00286624e+00]
  HOMO = -0.845488001887661  LUMO = 0.867395752582508
  mo_energy =
[-3.27694302e+01 -1.92720758e+00 -8.45488002e-01 -8.45488002e-01
 -8.45488002e-01  8.67395753e-01  1.08995423e+00  1.08995423e+00
  1.08995423e+00  4.70019419e+00  5.69339696e+00  5.69339696e+00
  5.69339696e+00  1.49875282e+01  2.40698472e+01  2.40698472e+01
  2.40698472e+01  4.67287708e+01  1.18914043e+02  1.18914043e+02
  1.18914043e+02  1.53101651e+02  5.16938776e+02  1.88325843e+03
  8.01139432e+03  4.77770863e+04]
E1 = -182.59812228892736  E_coul = 54.065763446499155
cycle= 4 E= -128.532358842428  delta_E= -2.1e-08  |g|= 6.32e-05  |ddm|= 0.000355
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132071
diis-c [-1.01255364e-09  3.29205530e-04  4.19947031e-04 -2.14793293e-01
  1.21404414e+00]
  HOMO = -0.845520061939846  LUMO = 0.867388398574523
  mo_energy =
[-3.27694826e+01 -1.92722715e+00 -8.45520062e-01 -8.45520062e-01
 -8.45520062e-01  8.67388399e-01  1.08994080e+00  1.08994080e+00
  1.08994080e+00  4.70017171e+00  5.69336144e+00  5.69336144e+00
  5.69336144e+00  1.49874908e+01  2.40697999e+01  2.40697999e+01
  2.40697999e+01  4.67287237e+01  1.18913990e+02  1.18913990e+02
  1.18913990e+02  1.53101598e+02  5.16938716e+02  1.88325837e+03
  8.01139425e+03  4.77770862e+04]
E1 = -182.59822612255456  E_coul = 54.06586727959657
cycle= 5 E= -128.532358842958  delta_E= -5.3e-10  |g|= 6.85e-06  |ddm|= 5.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59822612255456  E_coul = 54.06586727959657
  HOMO = -0.845516268422828  LUMO = 0.867390018026184
  mo_energy =
[-3.27694743e+01 -1.92722266e+00 -8.45516268e-01 -8.45516268e-01
 -8.45516268e-01  8.67390018e-01  1.08994239e+00  1.08994239e+00
  1.08994239e+00  4.70017526e+00  5.69336604e+00  5.69336604e+00
  5.69336604e+00  1.49874963e+01  2.40698070e+01  2.40698070e+01
  2.40698070e+01  4.67287310e+01  1.18913998e+02  1.18913998e+02
  1.18913998e+02  1.53101606e+02  5.16938724e+02  1.88325837e+03
  8.01139426e+03  4.77770862e+04]
E1 = -182.598207923446  E_coul = 54.065849080485194
Extra cycle  E= -128.532358842961  delta_E= -2.84e-12  |g|= 2.54e-06  |ddm|= 2.97e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3124.032136243617
E1 = -182.598207923446  E_coul = 54.065849080485194
init E= -128.532358842961
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845517539218298  LUMO = 0.867389725805651
  mo_energy =
[-3.27694784e+01 -1.92722389e+00 -8.45517539e-01 -8.45517539e-01
 -8.45517539e-01  8.67389726e-01  1.08994194e+00  1.08994194e+00
  1.08994194e+00  4.70017436e+00  5.69336449e+00  5.69336449e+00
  5.69336449e+00  1.49874945e+01  2.40698041e+01  2.40698041e+01
  2.40698041e+01  4.67287279e+01  1.18913994e+02  1.18913994e+02
  1.18913994e+02  1.53101602e+02  5.16938719e+02  1.88325837e+03
  8.01139425e+03  4.77770862e+04]
E1 = -182.59821772268265  E_coul = 54.06585887972135
cycle= 1 E= -128.532358842961  delta_E= -4.55e-13  |g|= 1.34e-06  |ddm|= 9.79e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59821772268265  E_coul = 54.06585887972135
  HOMO = -0.845516849948626  LUMO = 0.867389935239178
  mo_energy =
[-3.27694763e+01 -1.92722314e+00 -8.45516850e-01 -8.45516850e-01
 -8.45516850e-01  8.67389935e-01  1.08994219e+00  1.08994219e+00
  1.08994219e+00  4.70017491e+00  5.69336534e+00  5.69336534e+00
  5.69336534e+00  1.49874955e+01  2.40698056e+01  2.40698056e+01
  2.40698056e+01  4.67287296e+01  1.18913996e+02  1.18913996e+02
  1.18913996e+02  1.53101604e+02  5.16938722e+02  1.88325837e+03
  8.01139426e+03  4.77770862e+04]
E1 = -182.5982128528437  E_coul = 54.06585400988209
Extra cycle  E= -128.532358842962  delta_E= -3.13e-13  |g|= 6.63e-07  |ddm|= 4.77e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.84591308e-01 2.44137941e+04 3.66145461e+03 8.33268183e+02
 2.35770312e+02 7.61698824e+01 1.08557101e+01 2.77430495e+01
 3.28126091e-01 2.29644717e+00 3.46485291e+00 3.68677998e+00
 1.24552986e+01 5.47793115e+01 3.30220341e-01 1.14480709e+00]
grad_E = [-2.34425686e-04 -2.16179555e-09  1.12801908e-07 -2.12178896e-06
  2.08042426e-05 -8.80253273e-05 -1.55360146e-04  8.18330254e-05
  2.10151403e-04  1.15736058e-04 -3.02340001e-05 -9.23077646e-05
  1.49568326e-05 -1.79448894e-06 -1.03506931e-03  6.17221756e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.897555271287       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460845        1
[INPUT] 0    0    [1    /1   ]  833.268186153        1
[INPUT] 0    0    [1    /1   ]  235.770284077        1
[INPUT] 0    0    [1    /1   ]  76.1702896285        1
[INPUT] 0    0    [1    /1   ]  10.8812147481        1
[INPUT] 0    0    [1    /1   ]  27.7366945033        1
[INPUT] 0    0    [1    /1   ]  0.330861049714       1
[INPUT] 0    0    [1    /1   ]  2.34047129997        1
[INPUT] 0    0    [1    /1   ]  3.46778224112        1
[INPUT] 1    0    [1    /1   ]  3.68540782795        1
[INPUT] 1    0    [1    /1   ]  12.4552669399        1
[INPUT] 1    0    [1    /1   ]  54.7793049894        1
[INPUT] 1    0    [1    /1   ]  0.330086145252       1
[INPUT] 1    0    [1    /1   ]  1.14371958924        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8975552712873562, 1.0]], [0, [24413.79412735398, 1.0]], [0, [3661.454608452199, 1.0]], [0, [833.2681861531911, 1.0]], [0, [235.77028407687172, 1.0]], [0, [76.1702896285396, 1.0]], [0, [10.881214748074836, 1.0]], [0, [27.73669450334862, 1.0]], [0, [0.3308610497144962, 1.0]], [0, [2.3404712999653356, 1.0]], [0, [3.4677822411190755, 1.0]], [1, [3.6854078279477362, 1.0]], [1, [12.45526693990971, 1.0]], [1, [54.7793049893557, 1.0]], [1, [0.33008614525199537, 1.0]], [1, [1.143719589237544, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.89755527]
bas 1, expnt(s) = [24413.79412735]
bas 2, expnt(s) = [3661.45460845]
bas 3, expnt(s) = [833.26818615]
bas 4, expnt(s) = [235.77028408]
bas 5, expnt(s) = [76.17028963]
bas 6, expnt(s) = [10.88121475]
bas 7, expnt(s) = [27.7366945]
bas 8, expnt(s) = [0.33086105]
bas 9, expnt(s) = [2.3404713]
bas 10, expnt(s) = [3.46778224]
bas 11, expnt(s) = [3.68540783]
bas 12, expnt(s) = [12.45526694]
bas 13, expnt(s) = [54.77930499]
bas 14, expnt(s) = [0.33008615]
bas 15, expnt(s) = [1.14371959]
CPU time:       145.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.97555271e-01 2.32975861e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268186e+02 3.91835360e+02
 2.35770284e+02 1.52013383e+02 7.61702896e+01 6.51409712e+01
 1.08812147e+01 1.51364162e+01 2.77366945e+01 3.05355714e+01
 3.30861050e-01 1.10217170e+00 2.34047130e+00 4.78071126e+00
 3.46778224e+00 6.42027880e+00 3.68540783e+00 1.48967433e+01
 1.24552669e+01 6.82614788e+01 5.47793050e+01 4.34765466e+02
 3.30086145e-01 7.29908654e-01 1.14371959e+00 3.45051438e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998485149625349
cond(S) = 3422.75490339502
E1 = -183.57820310191516  E_coul = 55.078525984864626
init E= -128.499677117051
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773942325429654  LUMO = 0.901215008989446
  mo_energy =
[-3.25554190e+01 -1.85288909e+00 -7.73942325e-01 -7.73942325e-01
 -7.73942325e-01  9.01215009e-01  1.11496205e+00  1.11496205e+00
  1.11496205e+00  4.82838794e+00  5.77625922e+00  5.77625922e+00
  5.77625922e+00  1.52710733e+01  2.42194649e+01  2.42194649e+01
  2.42194649e+01  4.71839403e+01  1.19123044e+02  1.19123044e+02
  1.19123044e+02  1.53636931e+02  5.17488211e+02  1.88380933e+03
  8.01193928e+03  4.77776075e+04]
E1 = -182.11125376685015  E_coul = 53.582245629524195
cycle= 1 E= -128.529008137326  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46165
diis-c [-0.21312074  1.        ]
  HOMO = -0.879590398977963  LUMO = 0.870485642711971
  mo_energy =
[-3.28739945e+01 -1.96313698e+00 -8.79590399e-01 -8.79590399e-01
 -8.79590399e-01  8.70485643e-01  1.07677664e+00  1.07677664e+00
  1.07677664e+00  4.74507105e+00  5.64734660e+00  5.64734660e+00
  5.64734660e+00  1.51168675e+01  2.39844969e+01  2.39844969e+01
  2.39844969e+01  4.69392092e+01  1.18802188e+02  1.18802188e+02
  1.18802188e+02  1.53324942e+02  5.17131552e+02  1.88341612e+03
  8.01151688e+03  4.77771662e+04]
E1 = -182.84318723694898  E_coul = 54.311674281856
cycle= 2 E= -128.531512955093  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230545
diis-c [-6.53753322e-04  3.32030930e-01  6.67969070e-01]
  HOMO = -0.845236865048862  LUMO = 0.880468318175607
  mo_energy =
[-3.27689921e+01 -1.92701788e+00 -8.45236865e-01 -8.45236865e-01
 -8.45236865e-01  8.80468318e-01  1.08926318e+00  1.08926318e+00
  1.08926318e+00  4.77198246e+00  5.68927043e+00  5.68927043e+00
  5.68927043e+00  1.51672565e+01  2.40620556e+01  2.40620556e+01
  2.40620556e+01  4.70202042e+01  1.18907219e+02  1.18907219e+02
  1.18907219e+02  1.53427508e+02  5.17244976e+02  1.88353487e+03
  8.01163809e+03  4.77772883e+04]
E1 = -182.59776570535556  E_coul = 54.06540587747285
cycle= 3 E= -128.532359827883  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000953155
diis-c [-1.51999090e-07 -2.21139510e-03 -6.55288529e-04  1.00286668e+00]
  HOMO = -0.845473839242144  LUMO = 0.880427399922294
  mo_energy =
[-3.27694106e+01 -1.92719000e+00 -8.45473839e-01 -8.45473839e-01
 -8.45473839e-01  8.80427400e-01  1.08921189e+00  1.08921189e+00
  1.08921189e+00  4.77184466e+00  5.68906352e+00  5.68906352e+00
  5.68906352e+00  1.51670158e+01  2.40617258e+01  2.40617258e+01
  2.40617258e+01  4.70198703e+01  1.18906788e+02  1.18906788e+02
  1.18906788e+02  1.53427091e+02  5.17244455e+02  1.88353424e+03
  8.01163737e+03  4.77772876e+04]
E1 = -182.5982843193006  E_coul = 54.065924470498786
cycle= 4 E= -128.532359848802  delta_E= -2.09e-08  |g|= 6.33e-05  |ddm|= 0.000365
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132262
diis-c [-1.01943426e-09  3.30508875e-04  4.23710455e-04 -2.15653886e-01
  1.21489967e+00]
  HOMO = -0.845505839059385  LUMO = 0.880420015803371
  mo_energy =
[-3.27694629e+01 -1.92720942e+00 -8.45505839e-01 -8.45505839e-01
 -8.45505839e-01  8.80420016e-01  1.08919851e+00  1.08919851e+00
  1.08919851e+00  4.77182207e+00  5.68902809e+00  5.68902809e+00
  5.68902809e+00  1.51669784e+01  2.40616786e+01  2.40616786e+01
  2.40616786e+01  4.70198232e+01  1.18906735e+02  1.18906735e+02
  1.18906735e+02  1.53427038e+02  5.17244395e+02  1.88353417e+03
  8.01163730e+03  4.77772875e+04]
E1 = -182.59838841174215  E_coul = 54.06602856240837
cycle= 5 E= -128.532359849334  delta_E= -5.32e-10  |g|= 6.87e-06  |ddm|= 6.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59838841174215  E_coul = 54.06602856240837
  HOMO = -0.845502027195567  LUMO = 0.880421661792238
  mo_energy =
[-3.27694546e+01 -1.92720492e+00 -8.45502027e-01 -8.45502027e-01
 -8.45502027e-01  8.80421662e-01  1.08920011e+00  1.08920011e+00
  1.08920011e+00  4.77182567e+00  5.68903271e+00  5.68903271e+00
  5.68903271e+00  1.51669840e+01  2.40616857e+01  2.40616857e+01
  2.40616857e+01  4.70198306e+01  1.18906743e+02  1.18906743e+02
  1.18906743e+02  1.53427046e+02  5.17244403e+02  1.88353418e+03
  8.01163731e+03  4.77772875e+04]
E1 = -182.59837012926218  E_coul = 54.06601027992567
Extra cycle  E= -128.532359849337  delta_E= -2.73e-12  |g|= 2.55e-06  |ddm|= 3.09e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.97555271e-01 2.44137941e+04 3.66145461e+03 8.33268186e+02
 2.35770284e+02 7.61702896e+01 1.08812147e+01 2.77366945e+01
 3.30861050e-01 2.34047130e+00 3.46778224e+00 3.68540783e+00
 1.24552669e+01 5.47793050e+01 3.30086145e-01 1.14371959e+00]
E = -128.5323598493365
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.897555271287       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460845        1
[INPUT] 0    0    [1    /1   ]  833.268186153        1
[INPUT] 0    0    [1    /1   ]  235.770284077        1
[INPUT] 0    0    [1    /1   ]  76.1702896285        1
[INPUT] 0    0    [1    /1   ]  10.8812147481        1
[INPUT] 0    0    [1    /1   ]  27.7366945033        1
[INPUT] 0    0    [1    /1   ]  0.330861049714       1
[INPUT] 0    0    [1    /1   ]  2.34047129997        1
[INPUT] 0    0    [1    /1   ]  3.46778224112        1
[INPUT] 1    0    [1    /1   ]  3.68540782795        1
[INPUT] 1    0    [1    /1   ]  12.4552669399        1
[INPUT] 1    0    [1    /1   ]  54.7793049894        1
[INPUT] 1    0    [1    /1   ]  0.330086145252       1
[INPUT] 1    0    [1    /1   ]  1.14371958924        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8975552712873562, 1.0]], [0, [24413.79412735398, 1.0]], [0, [3661.454608452199, 1.0]], [0, [833.2681861531911, 1.0]], [0, [235.77028407687172, 1.0]], [0, [76.1702896285396, 1.0]], [0, [10.881214748074836, 1.0]], [0, [27.73669450334862, 1.0]], [0, [0.3308610497144962, 1.0]], [0, [2.3404712999653356, 1.0]], [0, [3.4677822411190755, 1.0]], [1, [3.6854078279477362, 1.0]], [1, [12.45526693990971, 1.0]], [1, [54.7793049893557, 1.0]], [1, [0.33008614525199537, 1.0]], [1, [1.143719589237544, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.89755527]
bas 1, expnt(s) = [24413.79412735]
bas 2, expnt(s) = [3661.45460845]
bas 3, expnt(s) = [833.26818615]
bas 4, expnt(s) = [235.77028408]
bas 5, expnt(s) = [76.17028963]
bas 6, expnt(s) = [10.88121475]
bas 7, expnt(s) = [27.7366945]
bas 8, expnt(s) = [0.33086105]
bas 9, expnt(s) = [2.3404713]
bas 10, expnt(s) = [3.46778224]
bas 11, expnt(s) = [3.68540783]
bas 12, expnt(s) = [12.45526694]
bas 13, expnt(s) = [54.77930499]
bas 14, expnt(s) = [0.33008615]
bas 15, expnt(s) = [1.14371959]
CPU time:       146.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.97555271e-01 2.32975861e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268186e+02 3.91835360e+02
 2.35770284e+02 1.52013383e+02 7.61702896e+01 6.51409712e+01
 1.08812147e+01 1.51364162e+01 2.77366945e+01 3.05355714e+01
 3.30861050e-01 1.10217170e+00 2.34047130e+00 4.78071126e+00
 3.46778224e+00 6.42027880e+00 3.68540783e+00 1.48967433e+01
 1.24552669e+01 6.82614788e+01 5.47793050e+01 4.34765466e+02
 3.30086145e-01 7.29908654e-01 1.14371959e+00 3.45051438e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998485149625349
cond(S) = 3422.75490339502
E1 = -183.57820310191516  E_coul = 55.078525984864626
init E= -128.499677117051
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773942325429654  LUMO = 0.901215008989446
  mo_energy =
[-3.25554190e+01 -1.85288909e+00 -7.73942325e-01 -7.73942325e-01
 -7.73942325e-01  9.01215009e-01  1.11496205e+00  1.11496205e+00
  1.11496205e+00  4.82838794e+00  5.77625922e+00  5.77625922e+00
  5.77625922e+00  1.52710733e+01  2.42194649e+01  2.42194649e+01
  2.42194649e+01  4.71839403e+01  1.19123044e+02  1.19123044e+02
  1.19123044e+02  1.53636931e+02  5.17488211e+02  1.88380933e+03
  8.01193928e+03  4.77776075e+04]
E1 = -182.11125376685015  E_coul = 53.582245629524195
cycle= 1 E= -128.529008137326  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46165
diis-c [-0.21312074  1.        ]
  HOMO = -0.879590398977963  LUMO = 0.870485642711971
  mo_energy =
[-3.28739945e+01 -1.96313698e+00 -8.79590399e-01 -8.79590399e-01
 -8.79590399e-01  8.70485643e-01  1.07677664e+00  1.07677664e+00
  1.07677664e+00  4.74507105e+00  5.64734660e+00  5.64734660e+00
  5.64734660e+00  1.51168675e+01  2.39844969e+01  2.39844969e+01
  2.39844969e+01  4.69392092e+01  1.18802188e+02  1.18802188e+02
  1.18802188e+02  1.53324942e+02  5.17131552e+02  1.88341612e+03
  8.01151688e+03  4.77771662e+04]
E1 = -182.84318723694898  E_coul = 54.311674281856
cycle= 2 E= -128.531512955093  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230545
diis-c [-6.53753322e-04  3.32030930e-01  6.67969070e-01]
  HOMO = -0.845236865048862  LUMO = 0.880468318175607
  mo_energy =
[-3.27689921e+01 -1.92701788e+00 -8.45236865e-01 -8.45236865e-01
 -8.45236865e-01  8.80468318e-01  1.08926318e+00  1.08926318e+00
  1.08926318e+00  4.77198246e+00  5.68927043e+00  5.68927043e+00
  5.68927043e+00  1.51672565e+01  2.40620556e+01  2.40620556e+01
  2.40620556e+01  4.70202042e+01  1.18907219e+02  1.18907219e+02
  1.18907219e+02  1.53427508e+02  5.17244976e+02  1.88353487e+03
  8.01163809e+03  4.77772883e+04]
E1 = -182.59776570535556  E_coul = 54.06540587747285
cycle= 3 E= -128.532359827883  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000953155
diis-c [-1.51999090e-07 -2.21139510e-03 -6.55288529e-04  1.00286668e+00]
  HOMO = -0.845473839242144  LUMO = 0.880427399922294
  mo_energy =
[-3.27694106e+01 -1.92719000e+00 -8.45473839e-01 -8.45473839e-01
 -8.45473839e-01  8.80427400e-01  1.08921189e+00  1.08921189e+00
  1.08921189e+00  4.77184466e+00  5.68906352e+00  5.68906352e+00
  5.68906352e+00  1.51670158e+01  2.40617258e+01  2.40617258e+01
  2.40617258e+01  4.70198703e+01  1.18906788e+02  1.18906788e+02
  1.18906788e+02  1.53427091e+02  5.17244455e+02  1.88353424e+03
  8.01163737e+03  4.77772876e+04]
E1 = -182.5982843193006  E_coul = 54.065924470498786
cycle= 4 E= -128.532359848802  delta_E= -2.09e-08  |g|= 6.33e-05  |ddm|= 0.000365
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132262
diis-c [-1.01943426e-09  3.30508875e-04  4.23710455e-04 -2.15653886e-01
  1.21489967e+00]
  HOMO = -0.845505839059385  LUMO = 0.880420015803371
  mo_energy =
[-3.27694629e+01 -1.92720942e+00 -8.45505839e-01 -8.45505839e-01
 -8.45505839e-01  8.80420016e-01  1.08919851e+00  1.08919851e+00
  1.08919851e+00  4.77182207e+00  5.68902809e+00  5.68902809e+00
  5.68902809e+00  1.51669784e+01  2.40616786e+01  2.40616786e+01
  2.40616786e+01  4.70198232e+01  1.18906735e+02  1.18906735e+02
  1.18906735e+02  1.53427038e+02  5.17244395e+02  1.88353417e+03
  8.01163730e+03  4.77772875e+04]
E1 = -182.59838841174215  E_coul = 54.06602856240837
cycle= 5 E= -128.532359849334  delta_E= -5.32e-10  |g|= 6.87e-06  |ddm|= 6.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59838841174215  E_coul = 54.06602856240837
  HOMO = -0.845502027195567  LUMO = 0.880421661792238
  mo_energy =
[-3.27694546e+01 -1.92720492e+00 -8.45502027e-01 -8.45502027e-01
 -8.45502027e-01  8.80421662e-01  1.08920011e+00  1.08920011e+00
  1.08920011e+00  4.77182567e+00  5.68903271e+00  5.68903271e+00
  5.68903271e+00  1.51669840e+01  2.40616857e+01  2.40616857e+01
  2.40616857e+01  4.70198306e+01  1.18906743e+02  1.18906743e+02
  1.18906743e+02  1.53427046e+02  5.17244403e+02  1.88353418e+03
  8.01163731e+03  4.77772875e+04]
E1 = -182.59837012926218  E_coul = 54.06601027992567
Extra cycle  E= -128.532359849337  delta_E= -2.73e-12  |g|= 2.55e-06  |ddm|= 3.09e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3422.75490339502
E1 = -182.59837012926218  E_coul = 54.06601027992567
init E= -128.532359849337
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845503303353315  LUMO = 0.880421362557347
  mo_energy =
[-3.27694587e+01 -1.92720616e+00 -8.45503303e-01 -8.45503303e-01
 -8.45503303e-01  8.80421363e-01  1.08919966e+00  1.08919966e+00
  1.08919966e+00  4.77182475e+00  5.68903115e+00  5.68903115e+00
  5.68903115e+00  1.51669822e+01  2.40616828e+01  2.40616828e+01
  2.40616828e+01  4.70198275e+01  1.18906739e+02  1.18906739e+02
  1.18906739e+02  1.53427042e+02  5.17244399e+02  1.88353417e+03
  8.01163730e+03  4.77772875e+04]
E1 = -182.59837997286252  E_coul = 54.066020123525945
cycle= 1 E= -128.532359849337  delta_E= -5.68e-14  |g|= 1.35e-06  |ddm|= 9.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59837997286252  E_coul = 54.066020123525945
  HOMO = -0.845502610869237  LUMO = 0.880421576082932
  mo_energy =
[-3.27694566e+01 -1.92720541e+00 -8.45502611e-01 -8.45502611e-01
 -8.45502611e-01  8.80421576e-01  1.08919992e+00  1.08919992e+00
  1.08919992e+00  4.77182531e+00  5.68903200e+00  5.68903200e+00
  5.68903200e+00  1.51669832e+01  2.40616843e+01  2.40616843e+01
  2.40616843e+01  4.70198291e+01  1.18906741e+02  1.18906741e+02
  1.18906741e+02  1.53427044e+02  5.17244401e+02  1.88353417e+03
  8.01163730e+03  4.77772875e+04]
E1 = -182.59837508113688  E_coul = 54.066015231799966
Extra cycle  E= -128.532359849337  delta_E= -3.41e-13  |g|= 6.66e-07  |ddm|= 4.82e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [8.97555271e-01 2.44137941e+04 3.66145461e+03 8.33268186e+02
 2.35770284e+02 7.61702896e+01 1.08812147e+01 2.77366945e+01
 3.30861050e-01 2.34047130e+00 3.46778224e+00 3.68540783e+00
 1.24552669e+01 5.47793050e+01 3.30086145e-01 1.14371959e+00]
grad_E = [ 2.02663471e-05 -2.02145789e-09  1.05373628e-07 -1.97564218e-06
  1.90785008e-05 -7.61559434e-05 -9.16072615e-05  3.94575583e-05
 -1.98758736e-04  7.51239999e-05 -3.95653174e-05  5.60341328e-05
  1.15840083e-05 -1.88205422e-06  2.01466705e-04 -1.79916055e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.889958776169       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460636        1
[INPUT] 0    0    [1    /1   ]  833.268229003        1
[INPUT] 0    0    [1    /1   ]  235.769764865        1
[INPUT] 0    0    [1    /1   ]  76.1740778129        1
[INPUT] 0    0    [1    /1   ]  10.8779895584        1
[INPUT] 0    0    [1    /1   ]  27.7256306519        1
[INPUT] 0    0    [1    /1   ]  0.329231831527       1
[INPUT] 0    0    [1    /1   ]  2.32813151927        1
[INPUT] 0    0    [1    /1   ]  3.45962257446        1
[INPUT] 1    0    [1    /1   ]  3.68546135283        1
[INPUT] 1    0    [1    /1   ]  12.45518653          1
[INPUT] 1    0    [1    /1   ]  54.7793726461        1
[INPUT] 1    0    [1    /1   ]  0.330086610666       1
[INPUT] 1    0    [1    /1   ]  1.14373182642        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.889958776168837, 1.0]], [0, [24413.794127393845, 1.0]], [0, [3661.4546063602256, 1.0]], [0, [833.268229002651, 1.0]], [0, [235.7697648648082, 1.0]], [0, [76.17407781286728, 1.0]], [0, [10.877989558360717, 1.0]], [0, [27.725630651870766, 1.0]], [0, [0.3292318315267031, 1.0]], [0, [2.328131519267751, 1.0]], [0, [3.4596225744618314, 1.0]], [1, [3.685461352825444, 1.0]], [1, [12.455186530013915, 1.0]], [1, [54.77937264610874, 1.0]], [1, [0.33008661066642303, 1.0]], [1, [1.1437318264153467, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.88995878]
bas 1, expnt(s) = [24413.79412739]
bas 2, expnt(s) = [3661.45460636]
bas 3, expnt(s) = [833.268229]
bas 4, expnt(s) = [235.76976486]
bas 5, expnt(s) = [76.17407781]
bas 6, expnt(s) = [10.87798956]
bas 7, expnt(s) = [27.72563065]
bas 8, expnt(s) = [0.32923183]
bas 9, expnt(s) = [2.32813152]
bas 10, expnt(s) = [3.45962257]
bas 11, expnt(s) = [3.68546135]
bas 12, expnt(s) = [12.45518653]
bas 13, expnt(s) = [54.77937265]
bas 14, expnt(s) = [0.33008661]
bas 15, expnt(s) = [1.14373183]
CPU time:       149.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.89958776e-01 2.31495441e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268229e+02 3.91835375e+02
 2.35769765e+02 1.52013132e+02 7.61740778e+01 6.51434010e+01
 1.08779896e+01 1.51330512e+01 2.77256307e+01 3.05264358e+01
 3.29231832e-01 1.09809873e+00 2.32813152e+00 4.76179459e+00
 3.45962257e+00 6.40894532e+00 3.68546135e+00 1.48970138e+01
 1.24551865e+01 6.82609279e+01 5.47793726e+01 4.34766137e+02
 3.30086611e-01 7.29909940e-01 1.14373183e+00 3.45056053e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998485976490283
cond(S) = 3336.9596531178668
E1 = -183.57817574246442  E_coul = 55.078512906286946
init E= -128.499662836177
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77394321084709  LUMO = 0.893752089123353
  mo_energy =
[-3.25554217e+01 -1.85289073e+00 -7.73943211e-01 -7.73943211e-01
 -7.73943211e-01  8.93752089e-01  1.11496749e+00  1.11496749e+00
  1.11496749e+00  4.79306246e+00  5.77633224e+00  5.77633224e+00
  5.77633224e+00  1.51900361e+01  2.42195750e+01  2.42195750e+01
  2.42195750e+01  4.70572753e+01  1.19123087e+02  1.19123087e+02
  1.19123087e+02  1.53485204e+02  5.17336783e+02  1.88367127e+03
  8.01181732e+03  4.77775065e+04]
E1 = -182.1112738495238  E_coul = 53.582265316196086
cycle= 1 E= -128.529008533328  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461678
diis-c [-0.21314699  1.        ]
  HOMO = -0.879587674584186  LUMO = 0.86328576741199
  mo_energy =
[-3.28739940e+01 -1.96313596e+00 -8.79587675e-01 -8.79587675e-01
 -8.79587675e-01  8.63285767e-01  1.07678515e+00  1.07678515e+00
  1.07678515e+00  4.71012017e+00  5.64742034e+00  5.64742034e+00
  5.64742034e+00  1.50360765e+01  2.39846113e+01  2.39846113e+01
  2.39846113e+01  4.68125792e+01  1.18802237e+02  1.18802237e+02
  1.18802237e+02  1.53173206e+02  5.16980121e+02  1.88327805e+03
  8.01139492e+03  4.77770651e+04]
E1 = -182.84321915688201  E_coul = 54.31170581131086
cycle= 2 E= -128.531513345571  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230563
diis-c [-6.53150600e-04  3.32036346e-01  6.67963654e-01]
  HOMO = -0.845233595626981  LUMO = 0.873185295589277
  mo_energy =
[-3.27689916e+01 -1.92701661e+00 -8.45233596e-01 -8.45233596e-01
 -8.45233596e-01  8.73185296e-01  1.08927214e+00  1.08927214e+00
  1.08927214e+00  4.73691141e+00  5.68934503e+00  5.68934503e+00
  5.68934503e+00  1.50863857e+01  2.40621703e+01  2.40621703e+01
  2.40621703e+01  4.68935654e+01  1.18907267e+02  1.18907267e+02
  1.18907267e+02  1.53275777e+02  5.17093546e+02  1.88339681e+03
  8.01151613e+03  4.77771873e+04]
E1 = -182.59780086768944  E_coul = 54.0654406494766
cycle= 3 E= -128.532360218213  delta_E= -0.000847  |g|= 0.000471  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950427
diis-c [-1.52062529e-07 -2.20922331e-03 -6.64464130e-04  1.00287369e+00]
  HOMO = -0.845469855050534  LUMO = 0.87314501358801
  mo_energy =
[-3.27694088e+01 -1.92718815e+00 -8.45469855e-01 -8.45469855e-01
 -8.45469855e-01  8.73145014e-01  1.08922117e+00  1.08922117e+00
  1.08922117e+00  4.73677489e+00  5.68913888e+00  5.68913888e+00
  5.68913888e+00  1.50861463e+01  2.40618416e+01  2.40618416e+01
  2.40618416e+01  4.68932327e+01  1.18906838e+02  1.18906838e+02
  1.18906838e+02  1.53275361e+02  5.17093027e+02  1.88339617e+03
  8.01151541e+03  4.77771865e+04]
E1 = -182.5983175368559  E_coul = 54.06595729787699
cycle= 4 E= -128.532360238979  delta_E= -2.08e-08  |g|= 6.31e-05  |ddm|= 0.000358
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131908
diis-c [-1.01477610e-09  3.30118313e-04  4.23723009e-04 -2.15618964e-01
  1.21486512e+00]
  HOMO = -0.845501756892788  LUMO = 0.873137714996224
  mo_energy =
[-3.27694610e+01 -1.92720750e+00 -8.45501757e-01 -8.45501757e-01
 -8.45501757e-01  8.73137715e-01  1.08920784e+00  1.08920784e+00
  1.08920784e+00  4.73675247e+00  5.68910356e+00  5.68910356e+00
  5.68910356e+00  1.50861091e+01  2.40617946e+01  2.40617946e+01
  2.40617946e+01  4.68931858e+01  1.18906785e+02  1.18906785e+02
  1.18906785e+02  1.53275308e+02  5.17092967e+02  1.88339611e+03
  8.01151534e+03  4.77771864e+04]
E1 = -182.59842126612693  E_coul = 54.066061026619025
cycle= 5 E= -128.532360239508  delta_E= -5.29e-10  |g|= 6.85e-06  |ddm|= 6.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59842126612693  E_coul = 54.066061026619025
  HOMO = -0.845497954878819  LUMO = 0.873139344399628
  mo_energy =
[-3.27694527e+01 -1.92720301e+00 -8.45497955e-01 -8.45497955e-01
 -8.45497955e-01  8.73139344e-01  1.08920943e+00  1.08920943e+00
  1.08920943e+00  4.73675605e+00  5.68910817e+00  5.68910817e+00
  5.68910817e+00  1.50861146e+01  2.40618017e+01  2.40618017e+01
  2.40618017e+01  4.68931931e+01  1.18906793e+02  1.18906793e+02
  1.18906793e+02  1.53275316e+02  5.17092975e+02  1.88339611e+03
  8.01151535e+03  4.77771864e+04]
E1 = -182.59840300738162  E_coul = 54.06604276787084
Extra cycle  E= -128.532360239511  delta_E= -2.87e-12  |g|= 2.55e-06  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.89958776e-01 2.44137941e+04 3.66145461e+03 8.33268229e+02
 2.35769765e+02 7.61740778e+01 1.08779896e+01 2.77256307e+01
 3.29231832e-01 2.32813152e+00 3.45962257e+00 3.68546135e+00
 1.24551865e+01 5.47793726e+01 3.30086611e-01 1.14373183e+00]
E = -128.53236023951078
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.889958776169       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460636        1
[INPUT] 0    0    [1    /1   ]  833.268229003        1
[INPUT] 0    0    [1    /1   ]  235.769764865        1
[INPUT] 0    0    [1    /1   ]  76.1740778129        1
[INPUT] 0    0    [1    /1   ]  10.8779895584        1
[INPUT] 0    0    [1    /1   ]  27.7256306519        1
[INPUT] 0    0    [1    /1   ]  0.329231831527       1
[INPUT] 0    0    [1    /1   ]  2.32813151927        1
[INPUT] 0    0    [1    /1   ]  3.45962257446        1
[INPUT] 1    0    [1    /1   ]  3.68546135283        1
[INPUT] 1    0    [1    /1   ]  12.45518653          1
[INPUT] 1    0    [1    /1   ]  54.7793726461        1
[INPUT] 1    0    [1    /1   ]  0.330086610666       1
[INPUT] 1    0    [1    /1   ]  1.14373182642        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.889958776168837, 1.0]], [0, [24413.794127393845, 1.0]], [0, [3661.4546063602256, 1.0]], [0, [833.268229002651, 1.0]], [0, [235.7697648648082, 1.0]], [0, [76.17407781286728, 1.0]], [0, [10.877989558360717, 1.0]], [0, [27.725630651870766, 1.0]], [0, [0.3292318315267031, 1.0]], [0, [2.328131519267751, 1.0]], [0, [3.4596225744618314, 1.0]], [1, [3.685461352825444, 1.0]], [1, [12.455186530013915, 1.0]], [1, [54.77937264610874, 1.0]], [1, [0.33008661066642303, 1.0]], [1, [1.1437318264153467, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.88995878]
bas 1, expnt(s) = [24413.79412739]
bas 2, expnt(s) = [3661.45460636]
bas 3, expnt(s) = [833.268229]
bas 4, expnt(s) = [235.76976486]
bas 5, expnt(s) = [76.17407781]
bas 6, expnt(s) = [10.87798956]
bas 7, expnt(s) = [27.72563065]
bas 8, expnt(s) = [0.32923183]
bas 9, expnt(s) = [2.32813152]
bas 10, expnt(s) = [3.45962257]
bas 11, expnt(s) = [3.68546135]
bas 12, expnt(s) = [12.45518653]
bas 13, expnt(s) = [54.77937265]
bas 14, expnt(s) = [0.33008661]
bas 15, expnt(s) = [1.14373183]
CPU time:       150.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.89958776e-01 2.31495441e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268229e+02 3.91835375e+02
 2.35769765e+02 1.52013132e+02 7.61740778e+01 6.51434010e+01
 1.08779896e+01 1.51330512e+01 2.77256307e+01 3.05264358e+01
 3.29231832e-01 1.09809873e+00 2.32813152e+00 4.76179459e+00
 3.45962257e+00 6.40894532e+00 3.68546135e+00 1.48970138e+01
 1.24551865e+01 6.82609279e+01 5.47793726e+01 4.34766137e+02
 3.30086611e-01 7.29909940e-01 1.14373183e+00 3.45056053e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998485976490283
cond(S) = 3336.9596531178668
E1 = -183.57817574246442  E_coul = 55.078512906286946
init E= -128.499662836177
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77394321084709  LUMO = 0.893752089123353
  mo_energy =
[-3.25554217e+01 -1.85289073e+00 -7.73943211e-01 -7.73943211e-01
 -7.73943211e-01  8.93752089e-01  1.11496749e+00  1.11496749e+00
  1.11496749e+00  4.79306246e+00  5.77633224e+00  5.77633224e+00
  5.77633224e+00  1.51900361e+01  2.42195750e+01  2.42195750e+01
  2.42195750e+01  4.70572753e+01  1.19123087e+02  1.19123087e+02
  1.19123087e+02  1.53485204e+02  5.17336783e+02  1.88367127e+03
  8.01181732e+03  4.77775065e+04]
E1 = -182.1112738495238  E_coul = 53.582265316196086
cycle= 1 E= -128.529008533328  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461678
diis-c [-0.21314699  1.        ]
  HOMO = -0.879587674584186  LUMO = 0.86328576741199
  mo_energy =
[-3.28739940e+01 -1.96313596e+00 -8.79587675e-01 -8.79587675e-01
 -8.79587675e-01  8.63285767e-01  1.07678515e+00  1.07678515e+00
  1.07678515e+00  4.71012017e+00  5.64742034e+00  5.64742034e+00
  5.64742034e+00  1.50360765e+01  2.39846113e+01  2.39846113e+01
  2.39846113e+01  4.68125792e+01  1.18802237e+02  1.18802237e+02
  1.18802237e+02  1.53173206e+02  5.16980121e+02  1.88327805e+03
  8.01139492e+03  4.77770651e+04]
E1 = -182.84321915688201  E_coul = 54.31170581131086
cycle= 2 E= -128.531513345571  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230563
diis-c [-6.53150600e-04  3.32036346e-01  6.67963654e-01]
  HOMO = -0.845233595626981  LUMO = 0.873185295589277
  mo_energy =
[-3.27689916e+01 -1.92701661e+00 -8.45233596e-01 -8.45233596e-01
 -8.45233596e-01  8.73185296e-01  1.08927214e+00  1.08927214e+00
  1.08927214e+00  4.73691141e+00  5.68934503e+00  5.68934503e+00
  5.68934503e+00  1.50863857e+01  2.40621703e+01  2.40621703e+01
  2.40621703e+01  4.68935654e+01  1.18907267e+02  1.18907267e+02
  1.18907267e+02  1.53275777e+02  5.17093546e+02  1.88339681e+03
  8.01151613e+03  4.77771873e+04]
E1 = -182.59780086768944  E_coul = 54.0654406494766
cycle= 3 E= -128.532360218213  delta_E= -0.000847  |g|= 0.000471  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950427
diis-c [-1.52062529e-07 -2.20922331e-03 -6.64464130e-04  1.00287369e+00]
  HOMO = -0.845469855050534  LUMO = 0.87314501358801
  mo_energy =
[-3.27694088e+01 -1.92718815e+00 -8.45469855e-01 -8.45469855e-01
 -8.45469855e-01  8.73145014e-01  1.08922117e+00  1.08922117e+00
  1.08922117e+00  4.73677489e+00  5.68913888e+00  5.68913888e+00
  5.68913888e+00  1.50861463e+01  2.40618416e+01  2.40618416e+01
  2.40618416e+01  4.68932327e+01  1.18906838e+02  1.18906838e+02
  1.18906838e+02  1.53275361e+02  5.17093027e+02  1.88339617e+03
  8.01151541e+03  4.77771865e+04]
E1 = -182.5983175368559  E_coul = 54.06595729787699
cycle= 4 E= -128.532360238979  delta_E= -2.08e-08  |g|= 6.31e-05  |ddm|= 0.000358
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131908
diis-c [-1.01477610e-09  3.30118313e-04  4.23723009e-04 -2.15618964e-01
  1.21486512e+00]
  HOMO = -0.845501756892788  LUMO = 0.873137714996224
  mo_energy =
[-3.27694610e+01 -1.92720750e+00 -8.45501757e-01 -8.45501757e-01
 -8.45501757e-01  8.73137715e-01  1.08920784e+00  1.08920784e+00
  1.08920784e+00  4.73675247e+00  5.68910356e+00  5.68910356e+00
  5.68910356e+00  1.50861091e+01  2.40617946e+01  2.40617946e+01
  2.40617946e+01  4.68931858e+01  1.18906785e+02  1.18906785e+02
  1.18906785e+02  1.53275308e+02  5.17092967e+02  1.88339611e+03
  8.01151534e+03  4.77771864e+04]
E1 = -182.59842126612693  E_coul = 54.066061026619025
cycle= 5 E= -128.532360239508  delta_E= -5.29e-10  |g|= 6.85e-06  |ddm|= 6.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59842126612693  E_coul = 54.066061026619025
  HOMO = -0.845497954878819  LUMO = 0.873139344399628
  mo_energy =
[-3.27694527e+01 -1.92720301e+00 -8.45497955e-01 -8.45497955e-01
 -8.45497955e-01  8.73139344e-01  1.08920943e+00  1.08920943e+00
  1.08920943e+00  4.73675605e+00  5.68910817e+00  5.68910817e+00
  5.68910817e+00  1.50861146e+01  2.40618017e+01  2.40618017e+01
  2.40618017e+01  4.68931931e+01  1.18906793e+02  1.18906793e+02
  1.18906793e+02  1.53275316e+02  5.17092975e+02  1.88339611e+03
  8.01151535e+03  4.77771864e+04]
E1 = -182.59840300738162  E_coul = 54.06604276787084
Extra cycle  E= -128.532360239511  delta_E= -2.87e-12  |g|= 2.55e-06  |ddm|= 3.05e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3336.9596531178668
E1 = -182.59840300738162  E_coul = 54.06604276787084
init E= -128.532360239511
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.84549922960013  LUMO = 0.873139048123997
  mo_energy =
[-3.27694568e+01 -1.92720424e+00 -8.45499230e-01 -8.45499230e-01
 -8.45499230e-01  8.73139048e-01  1.08920898e+00  1.08920898e+00
  1.08920898e+00  4.73675514e+00  5.68910661e+00  5.68910661e+00
  5.68910661e+00  1.50861128e+01  2.40617987e+01  2.40617987e+01
  2.40617987e+01  4.68931901e+01  1.18906789e+02  1.18906789e+02
  1.18906789e+02  1.53275312e+02  5.17092970e+02  1.88339611e+03
  8.01151534e+03  4.77771864e+04]
E1 = -182.5984128352505  E_coul = 54.06605259573929
cycle= 1 E= -128.532360239511  delta_E= -4.26e-13  |g|= 1.35e-06  |ddm|= 9.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5984128352505  E_coul = 54.06605259573929
  HOMO = -0.845498538252653  LUMO = 0.873139259551875
  mo_energy =
[-3.27694547e+01 -1.92720349e+00 -8.45498538e-01 -8.45498538e-01
 -8.45498538e-01  8.73139260e-01  1.08920923e+00  1.08920923e+00
  1.08920923e+00  4.73675569e+00  5.68910746e+00  5.68910746e+00
  5.68910746e+00  1.50861138e+01  2.40618003e+01  2.40618003e+01
  2.40618003e+01  4.68931917e+01  1.18906791e+02  1.18906791e+02
  1.18906791e+02  1.53275314e+02  5.17092972e+02  1.88339611e+03
  8.01151534e+03  4.77771864e+04]
E1 = -182.59840795109528  E_coul = 54.066047711583714
Extra cycle  E= -128.532360239512  delta_E= -3.69e-13  |g|= 6.65e-07  |ddm|= 4.81e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.89958776e-01 2.44137941e+04 3.66145461e+03 8.33268229e+02
 2.35769765e+02 7.61740778e+01 1.08779896e+01 2.77256307e+01
 3.29231832e-01 2.32813152e+00 3.45962257e+00 3.68546135e+00
 1.24551865e+01 5.47793726e+01 3.30086611e-01 1.14373183e+00]
grad_E = [-2.08289677e-04 -1.95055909e-09  1.01640717e-07 -1.90348892e-06
  1.82812985e-05 -7.14341425e-05 -7.70629043e-05  2.63951979e-05
  1.56018287e-04  1.01013320e-04 -4.19142576e-05  6.18271928e-05
  9.93565391e-06 -1.79416010e-06  1.73393247e-04 -1.74245874e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.890607232381       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460586        1
[INPUT] 0    0    [1    /1   ]  833.268239089        1
[INPUT] 0    0    [1    /1   ]  235.769645013        1
[INPUT] 0    0    [1    /1   ]  76.1749003902        1
[INPUT] 0    0    [1    /1   ]  10.8749600368        1
[INPUT] 0    0    [1    /1   ]  27.7237112346        1
[INPUT] 0    0    [1    /1   ]  0.329608205358       1
[INPUT] 0    0    [1    /1   ]  2.32520158507        1
[INPUT] 0    0    [1    /1   ]  3.45829962613        1
[INPUT] 1    0    [1    /1   ]  3.68576674117        1
[INPUT] 1    0    [1    /1   ]  12.4549981173        1
[INPUT] 1    0    [1    /1   ]  54.7794037063        1
[INPUT] 1    0    [1    /1   ]  0.33013747029        1
[INPUT] 1    0    [1    /1   ]  1.14399739179        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.890607232380923, 1.0]], [0, [24413.7941274033, 1.0]], [0, [3661.454605864345, 1.0]], [0, [833.2682390893069, 1.0]], [0, [235.76964501338858, 1.0]], [0, [76.17490039020305, 1.0]], [0, [10.87496003677835, 1.0]], [0, [27.723711234621042, 1.0]], [0, [0.32960820535765295, 1.0]], [0, [2.3252015850709604, 1.0]], [0, [3.458299626127785, 1.0]], [1, [3.68576674116674, 1.0]], [1, [12.45499811732211, 1.0]], [1, [54.77940370630487, 1.0]], [1, [0.3301374702898647, 1.0]], [1, [1.1439973917902349, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.89060723]
bas 1, expnt(s) = [24413.7941274]
bas 2, expnt(s) = [3661.45460586]
bas 3, expnt(s) = [833.26823909]
bas 4, expnt(s) = [235.76964501]
bas 5, expnt(s) = [76.17490039]
bas 6, expnt(s) = [10.87496004]
bas 7, expnt(s) = [27.72371123]
bas 8, expnt(s) = [0.32960821]
bas 9, expnt(s) = [2.32520159]
bas 10, expnt(s) = [3.45829963]
bas 11, expnt(s) = [3.68576674]
bas 12, expnt(s) = [12.45499812]
bas 13, expnt(s) = [54.77940371]
bas 14, expnt(s) = [0.33013747]
bas 15, expnt(s) = [1.14399739]
CPU time:       153.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.90607232e-01 2.31621936e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268239e+02 3.91835379e+02
 2.35769645e+02 1.52013074e+02 7.61749004e+01 6.51439286e+01
 1.08749600e+01 1.51298902e+01 2.77237112e+01 3.05248508e+01
 3.29608205e-01 1.09904009e+00 2.32520159e+00 4.75729937e+00
 3.45829963e+00 6.40710716e+00 3.68576674e+00 1.48985568e+01
 1.24549981e+01 6.82596371e+01 5.47794037e+01 4.34766445e+02
 3.30137470e-01 7.30050523e-01 1.14399739e+00 3.45156205e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998484476941837
cond(S) = 3332.2485232872514
E1 = -183.57817894726017  E_coul = 55.07851649602213
init E= -128.499662451238
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773942728315294  LUMO = 0.894715510979376
  mo_energy =
[-3.25554214e+01 -1.85289044e+00 -7.73942728e-01 -7.73942728e-01
 -7.73942728e-01  8.94715511e-01  1.11521015e+00  1.11521015e+00
  1.11521015e+00  4.79392969e+00  5.77745424e+00  5.77745424e+00
  5.77745424e+00  1.51843210e+01  2.42213251e+01  2.42213251e+01
  2.42213251e+01  4.70394938e+01  1.19124243e+02  1.19124243e+02
  1.19124243e+02  1.53458044e+02  5.17308265e+02  1.88364505e+03
  8.01179412e+03  4.77774872e+04]
E1 = -182.11132473287407  E_coul = 53.582315663664986
cycle= 1 E= -128.529009069209  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461643
diis-c [-0.21311434  1.        ]
  HOMO = -0.879583911564448  LUMO = 0.864225344413868
  mo_energy =
[-3.28739833e+01 -1.96313282e+00 -8.79583912e-01 -8.79583912e-01
 -8.79583912e-01  8.64225344e-01  1.07701873e+00  1.07701873e+00
  1.07701873e+00  4.71102072e+00  5.64853510e+00  5.64853510e+00
  5.64853510e+00  1.50304227e+01  2.39863714e+01  2.39863714e+01
  2.39863714e+01  4.67948271e+01  1.18803403e+02  1.18803403e+02
  1.18803403e+02  1.53146058e+02  5.16951613e+02  1.88325185e+03
  8.01137172e+03  4.77770459e+04]
E1 = -182.84321917666975  E_coul = 54.31170554059878
cycle= 2 E= -128.531513636071  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230541
diis-c [-6.53012922e-04  3.32031265e-01  6.67968735e-01]
  HOMO = -0.845232131097632  LUMO = 0.874131675099004
  mo_energy =
[-3.27689866e+01 -1.92701592e+00 -8.45232131e-01 -8.45232131e-01
 -8.45232131e-01  8.74131675e-01  1.08950804e+00  1.08950804e+00
  1.08950804e+00  4.73779977e+00  5.69046069e+00  5.69046069e+00
  5.69046069e+00  1.50807099e+01  2.40639253e+01  2.40639253e+01
  2.40639253e+01  4.68758017e+01  1.18908428e+02  1.18908428e+02
  1.18908428e+02  1.53248622e+02  5.17065033e+02  1.88337060e+03
  8.01149293e+03  4.77771680e+04]
E1 = -182.5978155783261  E_coul = 54.065455170736755
cycle= 3 E= -128.532360407589  delta_E= -0.000847  |g|= 0.000472  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951496
diis-c [-1.51662033e-07 -2.20978852e-03 -6.59138092e-04  1.00286893e+00]
  HOMO = -0.845468738289267  LUMO = 0.874091157573083
  mo_energy =
[-3.27694045e+01 -1.92718793e+00 -8.45468738e-01 -8.45468738e-01
 -8.45468738e-01  8.74091158e-01  1.08945689e+00  1.08945689e+00
  1.08945689e+00  4.73766291e+00  5.69025408e+00  5.69025408e+00
  5.69025408e+00  1.50804700e+01  2.40635961e+01  2.40635961e+01
  2.40635961e+01  4.68754684e+01  1.18907998e+02  1.18907998e+02
  1.18907998e+02  1.53248206e+02  5.17064513e+02  1.88336996e+03
  8.01149221e+03  4.77771673e+04]
E1 = -182.5983334750708  E_coul = 54.06597304669865
cycle= 4 E= -128.532360428372  delta_E= -2.08e-08  |g|= 6.31e-05  |ddm|= 0.000359
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131868
diis-c [-1.01330558e-09  3.29767818e-04  4.22831604e-04 -2.15362086e-01
  1.21460949e+00]
  HOMO = -0.845500652048961  LUMO = 0.874083834528404
  mo_energy =
[-3.27694567e+01 -1.92720732e+00 -8.45500652e-01 -8.45500652e-01
 -8.45500652e-01  8.74083835e-01  1.08944354e+00  1.08944354e+00
  1.08944354e+00  4.73764048e+00  5.69021874e+00  5.69021874e+00
  5.69021874e+00  1.50804328e+01  2.40635490e+01  2.40635490e+01
  2.40635490e+01  4.68754215e+01  1.18907945e+02  1.18907945e+02
  1.18907945e+02  1.53248153e+02  5.17064453e+02  1.88336989e+03
  8.01149214e+03  4.77771672e+04]
E1 = -182.59843722643268  E_coul = 54.0660767975324
cycle= 5 E= -128.5323604289  delta_E= -5.28e-10  |g|= 6.85e-06  |ddm|= 6.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59843722643268  E_coul = 54.0660767975324
  HOMO = -0.845496855338824  LUMO = 0.874085463704338
  mo_energy =
[-3.27694484e+01 -1.92720283e+00 -8.45496855e-01 -8.45496855e-01
 -8.45496855e-01  8.74085464e-01  1.08944513e+00  1.08944513e+00
  1.08944513e+00  4.73764405e+00  5.69022335e+00  5.69022335e+00
  5.69022335e+00  1.50804383e+01  2.40635561e+01  2.40635561e+01
  2.40635561e+01  4.68754288e+01  1.18907953e+02  1.18907953e+02
  1.18907953e+02  1.53248161e+02  5.17064461e+02  1.88336990e+03
  8.01149214e+03  4.77771672e+04]
E1 = -182.598418996362  E_coul = 54.066058567458725
Extra cycle  E= -128.532360428903  delta_E= -2.98e-12  |g|= 2.55e-06  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.90607232e-01 2.44137941e+04 3.66145461e+03 8.33268239e+02
 2.35769645e+02 7.61749004e+01 1.08749600e+01 2.77237112e+01
 3.29608205e-01 2.32520159e+00 3.45829963e+00 3.68576674e+00
 1.24549981e+01 5.47794037e+01 3.30137470e-01 1.14399739e+00]
E = -128.53236042890327
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.890607232381       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460586        1
[INPUT] 0    0    [1    /1   ]  833.268239089        1
[INPUT] 0    0    [1    /1   ]  235.769645013        1
[INPUT] 0    0    [1    /1   ]  76.1749003902        1
[INPUT] 0    0    [1    /1   ]  10.8749600368        1
[INPUT] 0    0    [1    /1   ]  27.7237112346        1
[INPUT] 0    0    [1    /1   ]  0.329608205358       1
[INPUT] 0    0    [1    /1   ]  2.32520158507        1
[INPUT] 0    0    [1    /1   ]  3.45829962613        1
[INPUT] 1    0    [1    /1   ]  3.68576674117        1
[INPUT] 1    0    [1    /1   ]  12.4549981173        1
[INPUT] 1    0    [1    /1   ]  54.7794037063        1
[INPUT] 1    0    [1    /1   ]  0.33013747029        1
[INPUT] 1    0    [1    /1   ]  1.14399739179        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.890607232380923, 1.0]], [0, [24413.7941274033, 1.0]], [0, [3661.454605864345, 1.0]], [0, [833.2682390893069, 1.0]], [0, [235.76964501338858, 1.0]], [0, [76.17490039020305, 1.0]], [0, [10.87496003677835, 1.0]], [0, [27.723711234621042, 1.0]], [0, [0.32960820535765295, 1.0]], [0, [2.3252015850709604, 1.0]], [0, [3.458299626127785, 1.0]], [1, [3.68576674116674, 1.0]], [1, [12.45499811732211, 1.0]], [1, [54.77940370630487, 1.0]], [1, [0.3301374702898647, 1.0]], [1, [1.1439973917902349, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.89060723]
bas 1, expnt(s) = [24413.7941274]
bas 2, expnt(s) = [3661.45460586]
bas 3, expnt(s) = [833.26823909]
bas 4, expnt(s) = [235.76964501]
bas 5, expnt(s) = [76.17490039]
bas 6, expnt(s) = [10.87496004]
bas 7, expnt(s) = [27.72371123]
bas 8, expnt(s) = [0.32960821]
bas 9, expnt(s) = [2.32520159]
bas 10, expnt(s) = [3.45829963]
bas 11, expnt(s) = [3.68576674]
bas 12, expnt(s) = [12.45499812]
bas 13, expnt(s) = [54.77940371]
bas 14, expnt(s) = [0.33013747]
bas 15, expnt(s) = [1.14399739]
CPU time:       154.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.90607232e-01 2.31621936e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268239e+02 3.91835379e+02
 2.35769645e+02 1.52013074e+02 7.61749004e+01 6.51439286e+01
 1.08749600e+01 1.51298902e+01 2.77237112e+01 3.05248508e+01
 3.29608205e-01 1.09904009e+00 2.32520159e+00 4.75729937e+00
 3.45829963e+00 6.40710716e+00 3.68576674e+00 1.48985568e+01
 1.24549981e+01 6.82596371e+01 5.47794037e+01 4.34766445e+02
 3.30137470e-01 7.30050523e-01 1.14399739e+00 3.45156205e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998484476941837
cond(S) = 3332.2485232872514
E1 = -183.57817894726017  E_coul = 55.07851649602213
init E= -128.499662451238
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773942728315294  LUMO = 0.894715510979376
  mo_energy =
[-3.25554214e+01 -1.85289044e+00 -7.73942728e-01 -7.73942728e-01
 -7.73942728e-01  8.94715511e-01  1.11521015e+00  1.11521015e+00
  1.11521015e+00  4.79392969e+00  5.77745424e+00  5.77745424e+00
  5.77745424e+00  1.51843210e+01  2.42213251e+01  2.42213251e+01
  2.42213251e+01  4.70394938e+01  1.19124243e+02  1.19124243e+02
  1.19124243e+02  1.53458044e+02  5.17308265e+02  1.88364505e+03
  8.01179412e+03  4.77774872e+04]
E1 = -182.11132473287407  E_coul = 53.582315663664986
cycle= 1 E= -128.529009069209  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461643
diis-c [-0.21311434  1.        ]
  HOMO = -0.879583911564448  LUMO = 0.864225344413868
  mo_energy =
[-3.28739833e+01 -1.96313282e+00 -8.79583912e-01 -8.79583912e-01
 -8.79583912e-01  8.64225344e-01  1.07701873e+00  1.07701873e+00
  1.07701873e+00  4.71102072e+00  5.64853510e+00  5.64853510e+00
  5.64853510e+00  1.50304227e+01  2.39863714e+01  2.39863714e+01
  2.39863714e+01  4.67948271e+01  1.18803403e+02  1.18803403e+02
  1.18803403e+02  1.53146058e+02  5.16951613e+02  1.88325185e+03
  8.01137172e+03  4.77770459e+04]
E1 = -182.84321917666975  E_coul = 54.31170554059878
cycle= 2 E= -128.531513636071  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230541
diis-c [-6.53012922e-04  3.32031265e-01  6.67968735e-01]
  HOMO = -0.845232131097632  LUMO = 0.874131675099004
  mo_energy =
[-3.27689866e+01 -1.92701592e+00 -8.45232131e-01 -8.45232131e-01
 -8.45232131e-01  8.74131675e-01  1.08950804e+00  1.08950804e+00
  1.08950804e+00  4.73779977e+00  5.69046069e+00  5.69046069e+00
  5.69046069e+00  1.50807099e+01  2.40639253e+01  2.40639253e+01
  2.40639253e+01  4.68758017e+01  1.18908428e+02  1.18908428e+02
  1.18908428e+02  1.53248622e+02  5.17065033e+02  1.88337060e+03
  8.01149293e+03  4.77771680e+04]
E1 = -182.5978155783261  E_coul = 54.065455170736755
cycle= 3 E= -128.532360407589  delta_E= -0.000847  |g|= 0.000472  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951496
diis-c [-1.51662033e-07 -2.20978852e-03 -6.59138092e-04  1.00286893e+00]
  HOMO = -0.845468738289267  LUMO = 0.874091157573083
  mo_energy =
[-3.27694045e+01 -1.92718793e+00 -8.45468738e-01 -8.45468738e-01
 -8.45468738e-01  8.74091158e-01  1.08945689e+00  1.08945689e+00
  1.08945689e+00  4.73766291e+00  5.69025408e+00  5.69025408e+00
  5.69025408e+00  1.50804700e+01  2.40635961e+01  2.40635961e+01
  2.40635961e+01  4.68754684e+01  1.18907998e+02  1.18907998e+02
  1.18907998e+02  1.53248206e+02  5.17064513e+02  1.88336996e+03
  8.01149221e+03  4.77771673e+04]
E1 = -182.5983334750708  E_coul = 54.06597304669865
cycle= 4 E= -128.532360428372  delta_E= -2.08e-08  |g|= 6.31e-05  |ddm|= 0.000359
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131868
diis-c [-1.01330558e-09  3.29767818e-04  4.22831604e-04 -2.15362086e-01
  1.21460949e+00]
  HOMO = -0.845500652048961  LUMO = 0.874083834528404
  mo_energy =
[-3.27694567e+01 -1.92720732e+00 -8.45500652e-01 -8.45500652e-01
 -8.45500652e-01  8.74083835e-01  1.08944354e+00  1.08944354e+00
  1.08944354e+00  4.73764048e+00  5.69021874e+00  5.69021874e+00
  5.69021874e+00  1.50804328e+01  2.40635490e+01  2.40635490e+01
  2.40635490e+01  4.68754215e+01  1.18907945e+02  1.18907945e+02
  1.18907945e+02  1.53248153e+02  5.17064453e+02  1.88336989e+03
  8.01149214e+03  4.77771672e+04]
E1 = -182.59843722643268  E_coul = 54.0660767975324
cycle= 5 E= -128.5323604289  delta_E= -5.28e-10  |g|= 6.85e-06  |ddm|= 6.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59843722643268  E_coul = 54.0660767975324
  HOMO = -0.845496855338824  LUMO = 0.874085463704338
  mo_energy =
[-3.27694484e+01 -1.92720283e+00 -8.45496855e-01 -8.45496855e-01
 -8.45496855e-01  8.74085464e-01  1.08944513e+00  1.08944513e+00
  1.08944513e+00  4.73764405e+00  5.69022335e+00  5.69022335e+00
  5.69022335e+00  1.50804383e+01  2.40635561e+01  2.40635561e+01
  2.40635561e+01  4.68754288e+01  1.18907953e+02  1.18907953e+02
  1.18907953e+02  1.53248161e+02  5.17064461e+02  1.88336990e+03
  8.01149214e+03  4.77771672e+04]
E1 = -182.598418996362  E_coul = 54.066058567458725
Extra cycle  E= -128.532360428903  delta_E= -2.98e-12  |g|= 2.55e-06  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3332.2485232872514
E1 = -182.598418996362  E_coul = 54.066058567458725
init E= -128.532360428903
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.84549812811899  LUMO = 0.874085167815646
  mo_energy =
[-3.27694525e+01 -1.92720406e+00 -8.45498128e-01 -8.45498128e-01
 -8.45498128e-01  8.74085168e-01  1.08944469e+00  1.08944469e+00
  1.08944469e+00  4.73764314e+00  5.69022179e+00  5.69022179e+00
  5.69022179e+00  1.50804365e+01  2.40635531e+01  2.40635531e+01
  2.40635531e+01  4.68754257e+01  1.18907949e+02  1.18907949e+02
  1.18907949e+02  1.53248157e+02  5.17064456e+02  1.88336990e+03
  8.01149214e+03  4.77771672e+04]
E1 = -182.59842880922665  E_coul = 54.06606838032289
cycle= 1 E= -128.532360428904  delta_E= -4.83e-13  |g|= 1.34e-06  |ddm|= 9.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59842880922665  E_coul = 54.06606838032289
  HOMO = -0.845497437845657  LUMO = 0.874085379110906
  mo_energy =
[-3.27694504e+01 -1.92720332e+00 -8.45497438e-01 -8.45497438e-01
 -8.45497438e-01  8.74085379e-01  1.08944494e+00  1.08944494e+00
  1.08944494e+00  4.73764369e+00  5.69022264e+00  5.69022264e+00
  5.69022264e+00  1.50804375e+01  2.40635547e+01  2.40635547e+01
  2.40635547e+01  4.68754274e+01  1.18907951e+02  1.18907951e+02
  1.18907951e+02  1.53248159e+02  5.17064459e+02  1.88336990e+03
  8.01149214e+03  4.77771672e+04]
E1 = -182.59842393261584  E_coul = 54.066063503712286
Extra cycle  E= -128.532360428904  delta_E= 1.99e-13  |g|= 6.64e-07  |ddm|= 4.8e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.90607232e-01 2.44137941e+04 3.66145461e+03 8.33268239e+02
 2.35769645e+02 7.61749004e+01 1.08749600e+01 2.77237112e+01
 3.29608205e-01 2.32520159e+00 3.45829963e+00 3.68576674e+00
 1.24549981e+01 5.47794037e+01 3.30137470e-01 1.14399739e+00]
grad_E = [-1.92236161e-04 -1.94777141e-09  1.01496319e-07 -1.90097730e-06
  1.82632386e-05 -7.14833284e-05 -7.86322574e-05  2.72460153e-05
  1.71678357e-04  9.74266875e-05 -4.22051924e-05  3.36134846e-05
  9.48973842e-06 -1.68528286e-06 -1.37268718e-05 -2.36468752e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.889156205614       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460367        1
[INPUT] 0    0    [1    /1   ]  833.268282743        1
[INPUT] 0    0    [1    /1   ]  235.769153347        1
[INPUT] 0    0    [1    /1   ]  76.1778920605        1
[INPUT] 0    0    [1    /1   ]  10.8647113451        1
[INPUT] 0    0    [1    /1   ]  27.7181823732        1
[INPUT] 0    0    [1    /1   ]  0.329416971708       1
[INPUT] 0    0    [1    /1   ]  2.30286708041        1
[INPUT] 0    0    [1    /1   ]  3.45438551881        1
[INPUT] 1    0    [1    /1   ]  3.68722952893        1
[INPUT] 1    0    [1    /1   ]  12.4542920113        1
[INPUT] 1    0    [1    /1   ]  54.7795038372        1
[INPUT] 1    0    [1    /1   ]  0.330380896405       1
[INPUT] 1    0    [1    /1   ]  1.14521650835        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8891562056143192, 1.0]], [0, [24413.794127445213, 1.0]], [0, [3661.4546036706997, 1.0]], [0, [833.2682827426967, 1.0]], [0, [235.76915334672094, 1.0]], [0, [76.17789206048059, 1.0]], [0, [10.864711345132696, 1.0]], [0, [27.71818237322287, 1.0]], [0, [0.3294169717078142, 1.0]], [0, [2.302867080409866, 1.0]], [0, [3.4543855188100068, 1.0]], [1, [3.68722952893062, 1.0]], [1, [12.454292011299312, 1.0]], [1, [54.77950383724187, 1.0]], [1, [0.3303808964049591, 1.0]], [1, [1.1452165083538295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.88915621]
bas 1, expnt(s) = [24413.79412745]
bas 2, expnt(s) = [3661.45460367]
bas 3, expnt(s) = [833.26828274]
bas 4, expnt(s) = [235.76915335]
bas 5, expnt(s) = [76.17789206]
bas 6, expnt(s) = [10.86471135]
bas 7, expnt(s) = [27.71818237]
bas 8, expnt(s) = [0.32941697]
bas 9, expnt(s) = [2.30286708]
bas 10, expnt(s) = [3.45438552]
bas 11, expnt(s) = [3.68722953]
bas 12, expnt(s) = [12.45429201]
bas 13, expnt(s) = [54.77950384]
bas 14, expnt(s) = [0.3303809]
bas 15, expnt(s) = [1.14521651]
CPU time:       157.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.89156206e-01 2.31338850e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268283e+02 3.91835394e+02
 2.35769153e+02 1.52012836e+02 7.61778921e+01 6.51458474e+01
 1.08647113e+01 1.51191950e+01 2.77181824e+01 3.05202850e+01
 3.29416972e-01 1.09856182e+00 2.30286708e+00 4.72298621e+00
 3.45438552e+00 6.40166771e+00 3.68722953e+00 1.49059482e+01
 1.24542920e+01 6.82547999e+01 5.47795038e+01 4.34767438e+02
 3.30380896e-01 7.30723461e-01 1.14521651e+00 3.45616042e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998477863592939
cond(S) = 3221.566633327485
E1 = -183.5781906763073  E_coul = 55.078533071122166
init E= -128.499657605185
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773940481269564  LUMO = 0.892737089874001
  mo_energy =
[-3.25554193e+01 -1.85288969e+00 -7.73940481e-01 -7.73940481e-01
 -7.73940481e-01  8.92737090e-01  1.11635302e+00  1.11635302e+00
  1.11635302e+00  4.77407747e+00  5.78267935e+00  5.78267935e+00
  5.78267935e+00  1.51149027e+01  2.42297319e+01  2.42297319e+01
  2.42297319e+01  4.69112725e+01  1.19130186e+02  1.19130186e+02
  1.19130186e+02  1.53300446e+02  5.17153588e+02  1.88350468e+03
  8.01167021e+03  4.77773846e+04]
E1 = -182.11150495455405  E_coul = 53.582493474907565
cycle= 1 E= -128.529011479646  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461517
diis-c [-0.21299786  1.        ]
  HOMO = -0.879572359271262  LUMO = 0.862339161488192
  mo_energy =
[-3.28739418e+01 -1.96312016e+00 -8.79572359e-01 -8.79572359e-01
 -8.79572359e-01  8.62339161e-01  1.07811581e+00  1.07811581e+00
  1.07811581e+00  4.69150939e+00  5.65372131e+00  5.65372131e+00
  5.65372131e+00  1.49613437e+01  2.39948159e+01  2.39948159e+01
  2.39948159e+01  4.66667016e+01  1.18809387e+02  1.18809387e+02
  1.18809387e+02  1.52988490e+02  5.16796971e+02  1.88311152e+03
  8.01124786e+03  4.77769433e+04]
E1 = -182.8431840622393  E_coul = 54.311669020736154
cycle= 2 E= -128.531515041503  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230455
diis-c [-6.52258635e-04  3.32010437e-01  6.67989563e-01]
  HOMO = -0.845230368788309  LUMO = 0.872212165570986
  mo_energy =
[-3.27689694e+01 -1.92701385e+00 -8.45230369e-01 -8.45230369e-01
 -8.45230369e-01  8.72212166e-01  1.09061634e+00  1.09061634e+00
  1.09061634e+00  4.71817051e+00  5.69565222e+00  5.69565222e+00
  5.69565222e+00  1.50115096e+01  2.40723485e+01  2.40723485e+01
  2.40723485e+01  4.67476357e+01  1.18914386e+02  1.18914386e+02
  1.18914386e+02  1.53091034e+02  5.16910367e+02  1.88323024e+03
  8.01136905e+03  4.77770654e+04]
E1 = -182.59783902170088  E_coul = 54.06547762504183
cycle= 3 E= -128.532361396659  delta_E= -0.000846  |g|= 0.000476  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000957385
diis-c [-1.52013113e-07 -2.21601177e-03 -6.43157738e-04  1.00285917e+00]
  HOMO = -0.845468831153264  LUMO = 0.872170884348896
  mo_energy =
[-3.27693903e+01 -1.92718782e+00 -8.45468831e-01 -8.45468831e-01
 -8.45468831e-01  8.72170884e-01  1.09056420e+00  1.09056420e+00
  1.09056420e+00  4.71803238e+00  5.69544337e+00  5.69544337e+00
  5.69544337e+00  1.50112677e+01  2.40720164e+01  2.40720164e+01
  2.40720164e+01  4.67472996e+01  1.18913953e+02  1.18913953e+02
  1.18913953e+02  1.53090615e+02  5.16909844e+02  1.88322960e+03
  8.01136832e+03  4.77770646e+04]
E1 = -182.59836181646688  E_coul = 54.06600039876706
cycle= 4 E= -128.5323614177  delta_E= -2.1e-08  |g|= 6.33e-05  |ddm|= 0.00036
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132121
diis-c [-1.01411172e-09  3.29680333e-04  4.19836599e-04 -2.14941094e-01
  1.21419158e+00]
  HOMO = -0.845500892558552  LUMO = 0.872163504535527
  mo_energy =
[-3.27694427e+01 -1.92720737e+00 -8.45500893e-01 -8.45500893e-01
 -8.45500893e-01  8.72163505e-01  1.09055076e+00  1.09055076e+00
  1.09055076e+00  4.71800987e+00  5.69540786e+00  5.69540786e+00
  5.69540786e+00  1.50112303e+01  2.40719691e+01  2.40719691e+01
  2.40719691e+01  4.67472525e+01  1.18913900e+02  1.18913900e+02
  1.18913900e+02  1.53090562e+02  5.16909784e+02  1.88322953e+03
  8.01136825e+03  4.77770646e+04]
E1 = -182.59846568564714  E_coul = 54.06610426741688
cycle= 5 E= -128.53236141823  delta_E= -5.3e-10  |g|= 6.85e-06  |ddm|= 6.03e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59846568564714  E_coul = 54.06610426741688
  HOMO = -0.845497098969908  LUMO = 0.87216513126799
  mo_energy =
[-3.27694344e+01 -1.92720288e+00 -8.45497099e-01 -8.45497099e-01
 -8.45497099e-01  8.72165131e-01  1.09055235e+00  1.09055235e+00
  1.09055235e+00  4.71801343e+00  5.69541246e+00  5.69541246e+00
  5.69541246e+00  1.50112359e+01  2.40719762e+01  2.40719762e+01
  2.40719762e+01  4.67472598e+01  1.18913908e+02  1.18913908e+02
  1.18913908e+02  1.53090570e+02  5.16909792e+02  1.88322954e+03
  8.01136826e+03  4.77770646e+04]
E1 = -182.59844750518798  E_coul = 54.06608608695454
Extra cycle  E= -128.532361418233  delta_E= -3.18e-12  |g|= 2.54e-06  |ddm|= 3e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [8.89156206e-01 2.44137941e+04 3.66145460e+03 8.33268283e+02
 2.35769153e+02 7.61778921e+01 1.08647113e+01 2.77181824e+01
 3.29416972e-01 2.30286708e+00 3.45438552e+00 3.68722953e+00
 1.24542920e+01 5.47795038e+01 3.30380896e-01 1.14521651e+00]
E = -128.53236141823345
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.889156205614       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460367        1
[INPUT] 0    0    [1    /1   ]  833.268282743        1
[INPUT] 0    0    [1    /1   ]  235.769153347        1
[INPUT] 0    0    [1    /1   ]  76.1778920605        1
[INPUT] 0    0    [1    /1   ]  10.8647113451        1
[INPUT] 0    0    [1    /1   ]  27.7181823732        1
[INPUT] 0    0    [1    /1   ]  0.329416971708       1
[INPUT] 0    0    [1    /1   ]  2.30286708041        1
[INPUT] 0    0    [1    /1   ]  3.45438551881        1
[INPUT] 1    0    [1    /1   ]  3.68722952893        1
[INPUT] 1    0    [1    /1   ]  12.4542920113        1
[INPUT] 1    0    [1    /1   ]  54.7795038372        1
[INPUT] 1    0    [1    /1   ]  0.330380896405       1
[INPUT] 1    0    [1    /1   ]  1.14521650835        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8891562056143192, 1.0]], [0, [24413.794127445213, 1.0]], [0, [3661.4546036706997, 1.0]], [0, [833.2682827426967, 1.0]], [0, [235.76915334672094, 1.0]], [0, [76.17789206048059, 1.0]], [0, [10.864711345132696, 1.0]], [0, [27.71818237322287, 1.0]], [0, [0.3294169717078142, 1.0]], [0, [2.302867080409866, 1.0]], [0, [3.4543855188100068, 1.0]], [1, [3.68722952893062, 1.0]], [1, [12.454292011299312, 1.0]], [1, [54.77950383724187, 1.0]], [1, [0.3303808964049591, 1.0]], [1, [1.1452165083538295, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.88915621]
bas 1, expnt(s) = [24413.79412745]
bas 2, expnt(s) = [3661.45460367]
bas 3, expnt(s) = [833.26828274]
bas 4, expnt(s) = [235.76915335]
bas 5, expnt(s) = [76.17789206]
bas 6, expnt(s) = [10.86471135]
bas 7, expnt(s) = [27.71818237]
bas 8, expnt(s) = [0.32941697]
bas 9, expnt(s) = [2.30286708]
bas 10, expnt(s) = [3.45438552]
bas 11, expnt(s) = [3.68722953]
bas 12, expnt(s) = [12.45429201]
bas 13, expnt(s) = [54.77950384]
bas 14, expnt(s) = [0.3303809]
bas 15, expnt(s) = [1.14521651]
CPU time:       158.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.89156206e-01 2.31338850e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268283e+02 3.91835394e+02
 2.35769153e+02 1.52012836e+02 7.61778921e+01 6.51458474e+01
 1.08647113e+01 1.51191950e+01 2.77181824e+01 3.05202850e+01
 3.29416972e-01 1.09856182e+00 2.30286708e+00 4.72298621e+00
 3.45438552e+00 6.40166771e+00 3.68722953e+00 1.49059482e+01
 1.24542920e+01 6.82547999e+01 5.47795038e+01 4.34767438e+02
 3.30380896e-01 7.30723461e-01 1.14521651e+00 3.45616042e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998477863592939
cond(S) = 3221.566633327485
E1 = -183.5781906763073  E_coul = 55.078533071122166
init E= -128.499657605185
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773940481269564  LUMO = 0.892737089874001
  mo_energy =
[-3.25554193e+01 -1.85288969e+00 -7.73940481e-01 -7.73940481e-01
 -7.73940481e-01  8.92737090e-01  1.11635302e+00  1.11635302e+00
  1.11635302e+00  4.77407747e+00  5.78267935e+00  5.78267935e+00
  5.78267935e+00  1.51149027e+01  2.42297319e+01  2.42297319e+01
  2.42297319e+01  4.69112725e+01  1.19130186e+02  1.19130186e+02
  1.19130186e+02  1.53300446e+02  5.17153588e+02  1.88350468e+03
  8.01167021e+03  4.77773846e+04]
E1 = -182.11150495455405  E_coul = 53.582493474907565
cycle= 1 E= -128.529011479646  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461517
diis-c [-0.21299786  1.        ]
  HOMO = -0.879572359271262  LUMO = 0.862339161488192
  mo_energy =
[-3.28739418e+01 -1.96312016e+00 -8.79572359e-01 -8.79572359e-01
 -8.79572359e-01  8.62339161e-01  1.07811581e+00  1.07811581e+00
  1.07811581e+00  4.69150939e+00  5.65372131e+00  5.65372131e+00
  5.65372131e+00  1.49613437e+01  2.39948159e+01  2.39948159e+01
  2.39948159e+01  4.66667016e+01  1.18809387e+02  1.18809387e+02
  1.18809387e+02  1.52988490e+02  5.16796971e+02  1.88311152e+03
  8.01124786e+03  4.77769433e+04]
E1 = -182.8431840622393  E_coul = 54.311669020736154
cycle= 2 E= -128.531515041503  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230455
diis-c [-6.52258635e-04  3.32010437e-01  6.67989563e-01]
  HOMO = -0.845230368788309  LUMO = 0.872212165570986
  mo_energy =
[-3.27689694e+01 -1.92701385e+00 -8.45230369e-01 -8.45230369e-01
 -8.45230369e-01  8.72212166e-01  1.09061634e+00  1.09061634e+00
  1.09061634e+00  4.71817051e+00  5.69565222e+00  5.69565222e+00
  5.69565222e+00  1.50115096e+01  2.40723485e+01  2.40723485e+01
  2.40723485e+01  4.67476357e+01  1.18914386e+02  1.18914386e+02
  1.18914386e+02  1.53091034e+02  5.16910367e+02  1.88323024e+03
  8.01136905e+03  4.77770654e+04]
E1 = -182.59783902170088  E_coul = 54.06547762504183
cycle= 3 E= -128.532361396659  delta_E= -0.000846  |g|= 0.000476  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000957385
diis-c [-1.52013113e-07 -2.21601177e-03 -6.43157738e-04  1.00285917e+00]
  HOMO = -0.845468831153264  LUMO = 0.872170884348896
  mo_energy =
[-3.27693903e+01 -1.92718782e+00 -8.45468831e-01 -8.45468831e-01
 -8.45468831e-01  8.72170884e-01  1.09056420e+00  1.09056420e+00
  1.09056420e+00  4.71803238e+00  5.69544337e+00  5.69544337e+00
  5.69544337e+00  1.50112677e+01  2.40720164e+01  2.40720164e+01
  2.40720164e+01  4.67472996e+01  1.18913953e+02  1.18913953e+02
  1.18913953e+02  1.53090615e+02  5.16909844e+02  1.88322960e+03
  8.01136832e+03  4.77770646e+04]
E1 = -182.59836181646688  E_coul = 54.06600039876706
cycle= 4 E= -128.5323614177  delta_E= -2.1e-08  |g|= 6.33e-05  |ddm|= 0.00036
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132121
diis-c [-1.01411172e-09  3.29680333e-04  4.19836599e-04 -2.14941094e-01
  1.21419158e+00]
  HOMO = -0.845500892558552  LUMO = 0.872163504535527
  mo_energy =
[-3.27694427e+01 -1.92720737e+00 -8.45500893e-01 -8.45500893e-01
 -8.45500893e-01  8.72163505e-01  1.09055076e+00  1.09055076e+00
  1.09055076e+00  4.71800987e+00  5.69540786e+00  5.69540786e+00
  5.69540786e+00  1.50112303e+01  2.40719691e+01  2.40719691e+01
  2.40719691e+01  4.67472525e+01  1.18913900e+02  1.18913900e+02
  1.18913900e+02  1.53090562e+02  5.16909784e+02  1.88322953e+03
  8.01136825e+03  4.77770646e+04]
E1 = -182.59846568564714  E_coul = 54.06610426741688
cycle= 5 E= -128.53236141823  delta_E= -5.3e-10  |g|= 6.85e-06  |ddm|= 6.03e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59846568564714  E_coul = 54.06610426741688
  HOMO = -0.845497098969908  LUMO = 0.87216513126799
  mo_energy =
[-3.27694344e+01 -1.92720288e+00 -8.45497099e-01 -8.45497099e-01
 -8.45497099e-01  8.72165131e-01  1.09055235e+00  1.09055235e+00
  1.09055235e+00  4.71801343e+00  5.69541246e+00  5.69541246e+00
  5.69541246e+00  1.50112359e+01  2.40719762e+01  2.40719762e+01
  2.40719762e+01  4.67472598e+01  1.18913908e+02  1.18913908e+02
  1.18913908e+02  1.53090570e+02  5.16909792e+02  1.88322954e+03
  8.01136826e+03  4.77770646e+04]
E1 = -182.59844750518798  E_coul = 54.06608608695454
Extra cycle  E= -128.532361418233  delta_E= -3.18e-12  |g|= 2.54e-06  |ddm|= 3e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3221.566633327485
E1 = -182.59844750518798  E_coul = 54.06608608695454
init E= -128.532361418233
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845498368283662  LUMO = 0.872164837803958
  mo_energy =
[-3.27694385e+01 -1.92720411e+00 -8.45498368e-01 -8.45498368e-01
 -8.45498368e-01  8.72164838e-01  1.09055191e+00  1.09055191e+00
  1.09055191e+00  4.71801252e+00  5.69541092e+00  5.69541092e+00
  5.69541092e+00  1.50112340e+01  2.40719733e+01  2.40719733e+01
  2.40719733e+01  4.67472567e+01  1.18913904e+02  1.18913904e+02
  1.18913904e+02  1.53090566e+02  5.16909787e+02  1.88322954e+03
  8.01136825e+03  4.77770646e+04]
E1 = -182.59845729550025  E_coul = 54.06609587726679
cycle= 1 E= -128.532361418233  delta_E=    0  |g|= 1.34e-06  |ddm|= 9.79e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59845729550025  E_coul = 54.06609587726679
  HOMO = -0.845497679626891  LUMO = 0.872165048086732
  mo_energy =
[-3.27694364e+01 -1.92720336e+00 -8.45497680e-01 -8.45497680e-01
 -8.45497680e-01  8.72165048e-01  1.09055216e+00  1.09055216e+00
  1.09055216e+00  4.71801307e+00  5.69541176e+00  5.69541176e+00
  5.69541176e+00  1.50112350e+01  2.40719748e+01  2.40719748e+01
  2.40719748e+01  4.67472584e+01  1.18913906e+02  1.18913906e+02
  1.18913906e+02  1.53090568e+02  5.16909789e+02  1.88322954e+03
  8.01136825e+03  4.77770646e+04]
E1 = -182.59845243064487  E_coul = 54.06609101241119
Extra cycle  E= -128.532361418234  delta_E= -2.27e-13  |g|= 6.62e-07  |ddm|= 4.77e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.89156206e-01 2.44137941e+04 3.66145460e+03 8.33268283e+02
 2.35769153e+02 7.61778921e+01 1.08647113e+01 2.77181824e+01
 3.29416972e-01 2.30286708e+00 3.45438552e+00 3.68722953e+00
 1.24542920e+01 5.47795038e+01 3.30380896e-01 1.14521651e+00]
grad_E = [-8.48448111e-05 -1.93729054e-09  1.00951796e-07 -1.89135672e-06
  1.81862701e-05 -7.14656934e-05 -7.94297238e-05  2.87281212e-05
  2.70288399e-05  8.17769829e-05 -4.61183891e-05 -8.49666189e-05
  6.56283343e-06 -1.18755613e-06 -7.66986005e-04  6.20925000e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 22:59:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.886171985074       1
[INPUT] 0    0    [1    /1   ]  24413.7941275        1
[INPUT] 0    0    [1    /1   ]  3661.45460114        1
[INPUT] 0    0    [1    /1   ]  833.268330917        1
[INPUT] 0    0    [1    /1   ]  235.768672759        1
[INPUT] 0    0    [1    /1   ]  76.1799119622        1
[INPUT] 0    0    [1    /1   ]  10.8589868293        1
[INPUT] 0    0    [1    /1   ]  27.718240681         1
[INPUT] 0    0    [1    /1   ]  0.329656536567       1
[INPUT] 0    0    [1    /1   ]  2.26473027658        1
[INPUT] 0    0    [1    /1   ]  3.45608616496        1
[INPUT] 1    0    [1    /1   ]  3.68867816293        1
[INPUT] 1    0    [1    /1   ]  12.4536997212        1
[INPUT] 1    0    [1    /1   ]  54.7795562213        1
[INPUT] 1    0    [1    /1   ]  0.330642996513       1
[INPUT] 1    0    [1    /1   ]  1.14642979348        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8861719850738934, 1.0]], [0, [24413.79412749377, 1.0]], [0, [3661.454601138858, 1.0]], [0, [833.268330916584, 1.0]], [0, [235.76867275943778, 1.0]], [0, [76.17991196221807, 1.0]], [0, [10.858986829338514, 1.0]], [0, [27.71824068104309, 1.0]], [0, [0.32965653656721805, 1.0]], [0, [2.264730276582365, 1.0]], [0, [3.456086164955186, 1.0]], [1, [3.688678162932956, 1.0]], [1, [12.453699721243309, 1.0]], [1, [54.779556221283265, 1.0]], [1, [0.3306429965129148, 1.0]], [1, [1.1464297934835201, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.88617199]
bas 1, expnt(s) = [24413.79412749]
bas 2, expnt(s) = [3661.45460114]
bas 3, expnt(s) = [833.26833092]
bas 4, expnt(s) = [235.76867276]
bas 5, expnt(s) = [76.17991196]
bas 6, expnt(s) = [10.85898683]
bas 7, expnt(s) = [27.71824068]
bas 8, expnt(s) = [0.32965654]
bas 9, expnt(s) = [2.26473028]
bas 10, expnt(s) = [3.45608616]
bas 11, expnt(s) = [3.68867816]
bas 12, expnt(s) = [12.45369972]
bas 13, expnt(s) = [54.77955622]
bas 14, expnt(s) = [0.330643]
bas 15, expnt(s) = [1.14642979]
CPU time:       161.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.86171985e-01 2.30756284e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268331e+02 3.91835411e+02
 2.35768673e+02 1.52012604e+02 7.61799120e+01 6.51471429e+01
 1.08589868e+01 1.51132200e+01 2.77182407e+01 3.05203332e+01
 3.29656537e-01 1.09916096e+00 2.26473028e+00 4.66420241e+00
 3.45608616e+00 6.40403129e+00 3.68867816e+00 1.49132689e+01
 1.24536997e+01 6.82507424e+01 5.47795562e+01 4.34767958e+02
 3.30642997e-01 7.31448162e-01 1.14642979e+00 3.46073801e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998471009672716
cond(S) = 3016.816905360759
E1 = -183.5782030633631  E_coul = 55.07854783945534
init E= -128.499655223908
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773938230493124  LUMO = 0.890520064611539
  mo_energy =
[-3.25554175e+01 -1.85288983e+00 -7.73938230e-01 -7.73938230e-01
 -7.73938230e-01  8.90520065e-01  1.11755065e+00  1.11755065e+00
  1.11755065e+00  4.74329870e+00  5.78794616e+00  5.78794616e+00
  5.78794616e+00  1.50125402e+01  2.42382530e+01  2.42382530e+01
  2.42382530e+01  4.67462233e+01  1.19136392e+02  1.19136392e+02
  1.19136392e+02  1.53124371e+02  5.16991922e+02  1.88336023e+03
  8.01154313e+03  4.77772794e+04]
E1 = -182.11181790052962  E_coul = 53.58280282002041
cycle= 1 E= -128.529015080509  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46134
diis-c [-0.21283433  1.        ]
  HOMO = -0.879549132769717  LUMO = 0.860254922488942
  mo_energy =
[-3.28738786e+01 -1.96309870e+00 -8.79549133e-01 -8.79549133e-01
 -8.79549133e-01  8.60254922e-01  1.07927254e+00  1.07927254e+00
  1.07927254e+00  4.66127569e+00  5.65896273e+00  5.65896273e+00
  5.65896273e+00  1.48594464e+01  2.40033930e+01  2.40033930e+01
  2.40033930e+01  4.65017412e+01  1.18815655e+02  1.18815655e+02
  1.18815655e+02  1.52812452e+02  5.16635360e+02  1.88296713e+03
  8.01112085e+03  4.77768382e+04]
E1 = -182.8432321674158  E_coul = 54.3117147941067
cycle= 2 E= -128.531517373309  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0694
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230341
diis-c [-6.51257784e-04  3.31985573e-01  6.68014427e-01]
  HOMO = -0.845219064489027  LUMO = 0.870082451574147
  mo_energy =
[-3.27689369e+01 -1.92700527e+00 -8.45219064e-01 -8.45219064e-01
 -8.45219064e-01  8.70082452e-01  1.09178375e+00  1.09178375e+00
  1.09178375e+00  4.68775409e+00  5.70089609e+00  5.70089609e+00
  5.70089609e+00  1.49094509e+01  2.40808998e+01  2.40808998e+01
  2.40808998e+01  4.65826388e+01  1.18920623e+02  1.18920623e+02
  1.18920623e+02  1.52914975e+02  5.16748727e+02  1.88308582e+03
  8.01124200e+03  4.77769602e+04]
E1 = -182.59796922858106  E_coul = 54.065606050119285
cycle= 3 E= -128.532363178462  delta_E= -0.000846  |g|= 0.000478  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000962036
diis-c [-1.51351928e-07 -2.21963179e-03 -6.24923438e-04  1.00284456e+00]
  HOMO = -0.845458981651961  LUMO = 0.870040567326125
  mo_energy =
[-3.27693604e+01 -1.92718101e+00 -8.45458982e-01 -8.45458982e-01
 -8.45458982e-01  8.70040567e-01  1.09173080e+00  1.09173080e+00
  1.09173080e+00  4.68761531e+00  5.70068539e+00  5.70068539e+00
  5.70068539e+00  1.49092075e+01  2.40805653e+01  2.40805653e+01
  2.40805653e+01  4.65823003e+01  1.18920187e+02  1.18920187e+02
  1.18920187e+02  1.52914553e+02  5.16748201e+02  1.88308518e+03
  8.01124127e+03  4.77769595e+04]
E1 = -182.5984967698431  E_coul = 54.06613357019392
cycle= 4 E= -128.532363199649  delta_E= -2.12e-08  |g|= 6.33e-05  |ddm|= 0.000359
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132077
diis-c [-1.00999598e-09  3.28848400e-04  4.16449038e-04 -2.14184346e-01
  1.21343905e+00]
  HOMO = -0.845491116760503  LUMO = 0.870033146506626
  mo_energy =
[-3.27694128e+01 -1.92720071e+00 -8.45491117e-01 -8.45491117e-01
 -8.45491117e-01  8.70033147e-01  1.09171730e+00  1.09171730e+00
  1.09171730e+00  4.68759281e+00  5.70064978e+00  5.70064978e+00
  5.70064978e+00  1.49091701e+01  2.40805179e+01  2.40805179e+01
  2.40805179e+01  4.65822531e+01  1.18920134e+02  1.18920134e+02
  1.18920134e+02  1.52914500e+02  5.16748141e+02  1.88308511e+03
  8.01124120e+03  4.77769594e+04]
E1 = -182.59860062326734  E_coul = 54.06623742308887
cycle= 5 E= -128.532363200178  delta_E= -5.29e-10  |g|= 6.83e-06  |ddm|= 6.01e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59860062326734  E_coul = 54.06623742308887
  HOMO = -0.845487341749369  LUMO = 0.870034763143638
  mo_energy =
[-3.27694046e+01 -1.92719624e+00 -8.45487342e-01 -8.45487342e-01
 -8.45487342e-01  8.70034763e-01  1.09171888e+00  1.09171888e+00
  1.09171888e+00  4.68759634e+00  5.70065436e+00  5.70065436e+00
  5.70065436e+00  1.49091756e+01  2.40805250e+01  2.40805250e+01
  2.40805250e+01  4.65822604e+01  1.18920142e+02  1.18920142e+02
  1.18920142e+02  1.52914508e+02  5.16748149e+02  1.88308512e+03
  8.01124121e+03  4.77769594e+04]
E1 = -182.5985825497537  E_coul = 54.066219349571995
Extra cycle  E= -128.532363200182  delta_E= -3.21e-12  |g|= 2.53e-06  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.86171985e-01 2.44137941e+04 3.66145460e+03 8.33268331e+02
 2.35768673e+02 7.61799120e+01 1.08589868e+01 2.77182407e+01
 3.29656537e-01 2.26473028e+00 3.45608616e+00 3.68867816e+00
 1.24536997e+01 5.47795562e+01 3.30642997e-01 1.14642979e+00]
E = -128.5323632001817
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.886171985074       1
[INPUT] 0    0    [1    /1   ]  24413.7941275        1
[INPUT] 0    0    [1    /1   ]  3661.45460114        1
[INPUT] 0    0    [1    /1   ]  833.268330917        1
[INPUT] 0    0    [1    /1   ]  235.768672759        1
[INPUT] 0    0    [1    /1   ]  76.1799119622        1
[INPUT] 0    0    [1    /1   ]  10.8589868293        1
[INPUT] 0    0    [1    /1   ]  27.718240681         1
[INPUT] 0    0    [1    /1   ]  0.329656536567       1
[INPUT] 0    0    [1    /1   ]  2.26473027658        1
[INPUT] 0    0    [1    /1   ]  3.45608616496        1
[INPUT] 1    0    [1    /1   ]  3.68867816293        1
[INPUT] 1    0    [1    /1   ]  12.4536997212        1
[INPUT] 1    0    [1    /1   ]  54.7795562213        1
[INPUT] 1    0    [1    /1   ]  0.330642996513       1
[INPUT] 1    0    [1    /1   ]  1.14642979348        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8861719850738934, 1.0]], [0, [24413.79412749377, 1.0]], [0, [3661.454601138858, 1.0]], [0, [833.268330916584, 1.0]], [0, [235.76867275943778, 1.0]], [0, [76.17991196221807, 1.0]], [0, [10.858986829338514, 1.0]], [0, [27.71824068104309, 1.0]], [0, [0.32965653656721805, 1.0]], [0, [2.264730276582365, 1.0]], [0, [3.456086164955186, 1.0]], [1, [3.688678162932956, 1.0]], [1, [12.453699721243309, 1.0]], [1, [54.779556221283265, 1.0]], [1, [0.3306429965129148, 1.0]], [1, [1.1464297934835201, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.88617199]
bas 1, expnt(s) = [24413.79412749]
bas 2, expnt(s) = [3661.45460114]
bas 3, expnt(s) = [833.26833092]
bas 4, expnt(s) = [235.76867276]
bas 5, expnt(s) = [76.17991196]
bas 6, expnt(s) = [10.85898683]
bas 7, expnt(s) = [27.71824068]
bas 8, expnt(s) = [0.32965654]
bas 9, expnt(s) = [2.26473028]
bas 10, expnt(s) = [3.45608616]
bas 11, expnt(s) = [3.68867816]
bas 12, expnt(s) = [12.45369972]
bas 13, expnt(s) = [54.77955622]
bas 14, expnt(s) = [0.330643]
bas 15, expnt(s) = [1.14642979]
CPU time:       162.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.86171985e-01 2.30756284e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268331e+02 3.91835411e+02
 2.35768673e+02 1.52012604e+02 7.61799120e+01 6.51471429e+01
 1.08589868e+01 1.51132200e+01 2.77182407e+01 3.05203332e+01
 3.29656537e-01 1.09916096e+00 2.26473028e+00 4.66420241e+00
 3.45608616e+00 6.40403129e+00 3.68867816e+00 1.49132689e+01
 1.24536997e+01 6.82507424e+01 5.47795562e+01 4.34767958e+02
 3.30642997e-01 7.31448162e-01 1.14642979e+00 3.46073801e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998471009672716
cond(S) = 3016.816905360759
E1 = -183.5782030633631  E_coul = 55.07854783945534
init E= -128.499655223908
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773938230493124  LUMO = 0.890520064611539
  mo_energy =
[-3.25554175e+01 -1.85288983e+00 -7.73938230e-01 -7.73938230e-01
 -7.73938230e-01  8.90520065e-01  1.11755065e+00  1.11755065e+00
  1.11755065e+00  4.74329870e+00  5.78794616e+00  5.78794616e+00
  5.78794616e+00  1.50125402e+01  2.42382530e+01  2.42382530e+01
  2.42382530e+01  4.67462233e+01  1.19136392e+02  1.19136392e+02
  1.19136392e+02  1.53124371e+02  5.16991922e+02  1.88336023e+03
  8.01154313e+03  4.77772794e+04]
E1 = -182.11181790052962  E_coul = 53.58280282002041
cycle= 1 E= -128.529015080509  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46134
diis-c [-0.21283433  1.        ]
  HOMO = -0.879549132769717  LUMO = 0.860254922488942
  mo_energy =
[-3.28738786e+01 -1.96309870e+00 -8.79549133e-01 -8.79549133e-01
 -8.79549133e-01  8.60254922e-01  1.07927254e+00  1.07927254e+00
  1.07927254e+00  4.66127569e+00  5.65896273e+00  5.65896273e+00
  5.65896273e+00  1.48594464e+01  2.40033930e+01  2.40033930e+01
  2.40033930e+01  4.65017412e+01  1.18815655e+02  1.18815655e+02
  1.18815655e+02  1.52812452e+02  5.16635360e+02  1.88296713e+03
  8.01112085e+03  4.77768382e+04]
E1 = -182.8432321674158  E_coul = 54.3117147941067
cycle= 2 E= -128.531517373309  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0694
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230341
diis-c [-6.51257784e-04  3.31985573e-01  6.68014427e-01]
  HOMO = -0.845219064489027  LUMO = 0.870082451574147
  mo_energy =
[-3.27689369e+01 -1.92700527e+00 -8.45219064e-01 -8.45219064e-01
 -8.45219064e-01  8.70082452e-01  1.09178375e+00  1.09178375e+00
  1.09178375e+00  4.68775409e+00  5.70089609e+00  5.70089609e+00
  5.70089609e+00  1.49094509e+01  2.40808998e+01  2.40808998e+01
  2.40808998e+01  4.65826388e+01  1.18920623e+02  1.18920623e+02
  1.18920623e+02  1.52914975e+02  5.16748727e+02  1.88308582e+03
  8.01124200e+03  4.77769602e+04]
E1 = -182.59796922858106  E_coul = 54.065606050119285
cycle= 3 E= -128.532363178462  delta_E= -0.000846  |g|= 0.000478  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000962036
diis-c [-1.51351928e-07 -2.21963179e-03 -6.24923438e-04  1.00284456e+00]
  HOMO = -0.845458981651961  LUMO = 0.870040567326125
  mo_energy =
[-3.27693604e+01 -1.92718101e+00 -8.45458982e-01 -8.45458982e-01
 -8.45458982e-01  8.70040567e-01  1.09173080e+00  1.09173080e+00
  1.09173080e+00  4.68761531e+00  5.70068539e+00  5.70068539e+00
  5.70068539e+00  1.49092075e+01  2.40805653e+01  2.40805653e+01
  2.40805653e+01  4.65823003e+01  1.18920187e+02  1.18920187e+02
  1.18920187e+02  1.52914553e+02  5.16748201e+02  1.88308518e+03
  8.01124127e+03  4.77769595e+04]
E1 = -182.5984967698431  E_coul = 54.06613357019392
cycle= 4 E= -128.532363199649  delta_E= -2.12e-08  |g|= 6.33e-05  |ddm|= 0.000359
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132077
diis-c [-1.00999598e-09  3.28848400e-04  4.16449038e-04 -2.14184346e-01
  1.21343905e+00]
  HOMO = -0.845491116760503  LUMO = 0.870033146506626
  mo_energy =
[-3.27694128e+01 -1.92720071e+00 -8.45491117e-01 -8.45491117e-01
 -8.45491117e-01  8.70033147e-01  1.09171730e+00  1.09171730e+00
  1.09171730e+00  4.68759281e+00  5.70064978e+00  5.70064978e+00
  5.70064978e+00  1.49091701e+01  2.40805179e+01  2.40805179e+01
  2.40805179e+01  4.65822531e+01  1.18920134e+02  1.18920134e+02
  1.18920134e+02  1.52914500e+02  5.16748141e+02  1.88308511e+03
  8.01124120e+03  4.77769594e+04]
E1 = -182.59860062326734  E_coul = 54.06623742308887
cycle= 5 E= -128.532363200178  delta_E= -5.29e-10  |g|= 6.83e-06  |ddm|= 6.01e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59860062326734  E_coul = 54.06623742308887
  HOMO = -0.845487341749369  LUMO = 0.870034763143638
  mo_energy =
[-3.27694046e+01 -1.92719624e+00 -8.45487342e-01 -8.45487342e-01
 -8.45487342e-01  8.70034763e-01  1.09171888e+00  1.09171888e+00
  1.09171888e+00  4.68759634e+00  5.70065436e+00  5.70065436e+00
  5.70065436e+00  1.49091756e+01  2.40805250e+01  2.40805250e+01
  2.40805250e+01  4.65822604e+01  1.18920142e+02  1.18920142e+02
  1.18920142e+02  1.52914508e+02  5.16748149e+02  1.88308512e+03
  8.01124121e+03  4.77769594e+04]
E1 = -182.5985825497537  E_coul = 54.066219349571995
Extra cycle  E= -128.532363200182  delta_E= -3.21e-12  |g|= 2.53e-06  |ddm|= 2.92e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3016.816905360759
E1 = -182.5985825497537  E_coul = 54.066219349571995
init E= -128.532363200182
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.845488603800974  LUMO = 0.870034473445671
  mo_energy =
[-3.27694087e+01 -1.92719746e+00 -8.45488604e-01 -8.45488604e-01
 -8.45488604e-01  8.70034473e-01  1.09171844e+00  1.09171844e+00
  1.09171844e+00  4.68759545e+00  5.70065282e+00  5.70065282e+00
  5.70065282e+00  1.49091738e+01  2.40805221e+01  2.40805221e+01
  2.40805221e+01  4.65822574e+01  1.18920138e+02  1.18920138e+02
  1.18920138e+02  1.52914504e+02  5.16748144e+02  1.88308511e+03
  8.01124120e+03  4.77769594e+04]
E1 = -182.5985922848231  E_coul = 54.06622908464119
cycle= 1 E= -128.532363200182  delta_E= -2.27e-13  |g|= 1.33e-06  |ddm|= 9.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5985922848231  E_coul = 54.06622908464119
  HOMO = -0.845487919099009  LUMO = 0.870034681800944
  mo_energy =
[-3.27694066e+01 -1.92719672e+00 -8.45487919e-01 -8.45487919e-01
 -8.45487919e-01  8.70034682e-01  1.09171869e+00  1.09171869e+00
  1.09171869e+00  4.68759599e+00  5.70065366e+00  5.70065366e+00
  5.70065366e+00  1.49091748e+01  2.40805236e+01  2.40805236e+01
  2.40805236e+01  4.65822590e+01  1.18920140e+02  1.18920140e+02
  1.18920140e+02  1.52914506e+02  5.16748147e+02  1.88308512e+03
  8.01124120e+03  4.77769594e+04]
E1 = -182.59858744798063  E_coul = 54.066224247798694
Extra cycle  E= -128.532363200182  delta_E= -2.84e-14  |g|= 6.58e-07  |ddm|= 4.72e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.86171985e-01 2.44137941e+04 3.66145460e+03 8.33268331e+02
 2.35768673e+02 7.61799120e+01 1.08589868e+01 2.77182407e+01
 3.29656537e-01 2.26473028e+00 3.45608616e+00 3.68867816e+00
 1.24536997e+01 5.47795562e+01 3.30642997e-01 1.14642979e+00]
grad_E = [-1.46619329e-05 -1.93811842e-09  1.00998724e-07 -1.89283886e-06
  1.82161286e-05 -7.17695132e-05 -7.35405129e-05  2.88712309e-05
  6.09181030e-05  6.29883393e-05 -5.33092752e-05 -1.98443425e-04
  3.98649316e-06 -7.35838148e-07 -1.41166039e-03  1.22122050e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.870635615621       1
[INPUT] 0    0    [1    /1   ]  24413.7941276        1
[INPUT] 0    0    [1    /1   ]  3661.45459666        1
[INPUT] 0    0    [1    /1   ]  833.268411514        1
[INPUT] 0    0    [1    /1   ]  235.768008667        1
[INPUT] 0    0    [1    /1   ]  76.1803057075        1
[INPUT] 0    0    [1    /1   ]  10.8570645741        1
[INPUT] 0    0    [1    /1   ]  27.7338244247        1
[INPUT] 0    0    [1    /1   ]  0.327097352883       1
[INPUT] 0    0    [1    /1   ]  2.15645620489        1
[INPUT] 0    0    [1    /1   ]  3.47078591739        1
[INPUT] 1    0    [1    /1   ]  3.69097584286        1
[INPUT] 1    0    [1    /1   ]  12.4532858724        1
[INPUT] 1    0    [1    /1   ]  54.7794971982        1
[INPUT] 1    0    [1    /1   ]  0.331049803072       1
[INPUT] 1    0    [1    /1   ]  1.14830135502        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8706356156212752, 1.0]], [0, [24413.794127580113, 1.0]], [0, [3661.454596657753, 1.0]], [0, [833.268411514478, 1.0]], [0, [235.76800866747158, 1.0]], [0, [76.18030570747212, 1.0]], [0, [10.857064574116286, 1.0]], [0, [27.73382442465065, 1.0]], [0, [0.32709735288275427, 1.0]], [0, [2.1564562048876224, 1.0]], [0, [3.4707859173923863, 1.0]], [1, [3.6909758428594803, 1.0]], [1, [12.453285872395393, 1.0]], [1, [54.779497198153344, 1.0]], [1, [0.33104980307171433, 1.0]], [1, [1.148301355023866, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.87063562]
bas 1, expnt(s) = [24413.79412758]
bas 2, expnt(s) = [3661.45459666]
bas 3, expnt(s) = [833.26841151]
bas 4, expnt(s) = [235.76800867]
bas 5, expnt(s) = [76.18030571]
bas 6, expnt(s) = [10.85706457]
bas 7, expnt(s) = [27.73382442]
bas 8, expnt(s) = [0.32709735]
bas 9, expnt(s) = [2.1564562]
bas 10, expnt(s) = [3.47078592]
bas 11, expnt(s) = [3.69097584]
bas 12, expnt(s) = [12.45328587]
bas 13, expnt(s) = [54.7794972]
bas 14, expnt(s) = [0.3310498]
bas 15, expnt(s) = [1.14830136]
CPU time:       165.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.70635616e-01 2.27715371e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268412e+02 3.91835439e+02
 2.35768009e+02 1.52012283e+02 7.61803057e+01 6.51473954e+01
 1.08570646e+01 1.51112134e+01 2.77338244e+01 3.05332016e+01
 3.27097353e-01 1.09275499e+00 2.15645620e+00 4.49593999e+00
 3.47078592e+00 6.42444912e+00 3.69097584e+00 1.49248817e+01
 1.24532859e+01 6.82479074e+01 5.47794972e+01 4.34767373e+02
 3.31049803e-01 7.32573256e-01 1.14830136e+00 3.46780157e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998460946997387
cond(S) = 2479.422805086245
E1 = -183.57822631497868  E_coul = 55.07857230562522
init E= -128.499654009353
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773934665600478  LUMO = 0.874230428971813
  mo_energy =
[-3.25554125e+01 -1.85289242e+00 -7.73934666e-01 -7.73934666e-01
 -7.73934666e-01  8.74230429e-01  1.11940634e+00  1.11940634e+00
  1.11940634e+00  4.62598440e+00  5.79611199e+00  5.79611199e+00
  5.79611199e+00  1.46939963e+01  2.42521135e+01  2.42521135e+01
  2.42521135e+01  4.62970787e+01  1.19147514e+02  1.19147514e+02
  1.19147514e+02  1.52703046e+02  5.16630109e+02  1.88304188e+03
  8.01126404e+03  4.77770485e+04]
E1 = -182.11221210298282  E_coul = 53.58319050132732
cycle= 1 E= -128.529021601656  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461071
diis-c [-0.21258649  1.        ]
  HOMO = -0.879522921117568  LUMO = 0.844633318904553
  mo_energy =
[-3.28737906e+01 -1.96307279e+00 -8.79522921e-01 -8.79522921e-01
 -8.79522921e-01  8.44633319e-01  1.08105818e+00  1.08105818e+00
  1.08105818e+00  4.54561830e+00  5.66707972e+00  5.66707972e+00
  5.66707972e+00  1.45420337e+01  2.40173267e+01  2.40173267e+01
  2.40173267e+01  4.60526403e+01  1.18826861e+02  1.18826861e+02
  1.18826861e+02  1.52391121e+02  5.16273609e+02  1.88264887e+03
  8.01084186e+03  4.77766074e+04]
E1 = -182.84325259571526  E_coul = 54.31173045611264
cycle= 2 E= -128.531522139603  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230168
diis-c [-6.48971169e-04  3.31950799e-01  6.68049201e-01]
  HOMO = -0.845209799895856  LUMO = 0.854241913166597
  mo_energy =
[-3.27688916e+01 -1.92699792e+00 -8.45209800e-01 -8.45209800e-01
 -8.45209800e-01  8.54241913e-01  1.09358643e+00  1.09358643e+00
  1.09358643e+00  4.57154785e+00  5.70901898e+00  5.70901898e+00
  5.70901898e+00  1.45916508e+01  2.40947979e+01  2.40947979e+01
  2.40947979e+01  4.61335134e+01  1.18931784e+02  1.18931784e+02
  1.18931784e+02  1.52493632e+02  5.16386940e+02  1.88276752e+03
  8.01096297e+03  4.77767295e+04]
E1 = -182.5980948681426  E_coul = 54.06572766341706
cycle= 3 E= -128.532367204726  delta_E= -0.000845  |g|= 0.000484  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000971515
diis-c [-1.53046548e-07 -2.23105824e-03 -6.04345167e-04  1.00283540e+00]
  HOMO = -0.845452670644152  LUMO = 0.854199612156298
  mo_energy =
[-3.27693198e+01 -1.92717666e+00 -8.45452671e-01 -8.45452671e-01
 -8.45452671e-01  8.54199612e-01  1.09353181e+00  1.09353181e+00
  1.09353181e+00  4.57140895e+00  5.70880478e+00  5.70880478e+00
  5.70880478e+00  1.45914052e+01  2.40944589e+01  2.40944589e+01
  2.40944589e+01  4.61331706e+01  1.18931344e+02  1.18931344e+02
  1.18931344e+02  1.52493205e+02  5.16386410e+02  1.88276687e+03
  8.01096223e+03  4.77767287e+04]
E1 = -182.59862954631  E_coul = 54.066262319852875
cycle= 4 E= -128.532367226457  delta_E= -2.17e-08  |g|= 6.38e-05  |ddm|= 0.000356
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132588
diis-c [-1.01260341e-09  3.29110844e-04  4.12004696e-04 -2.13716152e-01
  1.21297504e+00]
  HOMO = -0.845485086722023  LUMO = 0.854192216552112
  mo_energy =
[-3.27693726e+01 -1.92719662e+00 -8.45485087e-01 -8.45485087e-01
 -8.45485087e-01  8.54192217e-01  1.09351813e+00  1.09351813e+00
  1.09351813e+00  4.57138658e+00  5.70876886e+00  5.70876886e+00
  5.70876886e+00  1.45913677e+01  2.40944112e+01  2.40944112e+01
  2.40944112e+01  4.61331230e+01  1.18931291e+02  1.18931291e+02
  1.18931291e+02  1.52493152e+02  5.16386349e+02  1.88276680e+03
  8.01096216e+03  4.77767286e+04]
E1 = -182.59873336408558  E_coul = 54.06636613709106
cycle= 5 E= -128.532367226995  delta_E= -5.37e-10  |g|= 6.82e-06  |ddm|= 5.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59873336408558  E_coul = 54.06636613709106
  HOMO = -0.845481322047323  LUMO = 0.85419380431136
  mo_energy =
[-3.27693644e+01 -1.92719215e+00 -8.45481322e-01 -8.45481322e-01
 -8.45481322e-01  8.54193804e-01  1.09351971e+00  1.09351971e+00
  1.09351971e+00  4.57139004e+00  5.70877344e+00  5.70877344e+00
  5.70877344e+00  1.45913732e+01  2.40944183e+01  2.40944183e+01
  2.40944183e+01  4.61331303e+01  1.18931299e+02  1.18931299e+02
  1.18931299e+02  1.52493160e+02  5.16386357e+02  1.88276681e+03
  8.01096217e+03  4.77767286e+04]
E1 = -182.59871539451032  E_coul = 54.06634816751324
Extra cycle  E= -128.532367226997  delta_E= -2.56e-12  |g|= 2.51e-06  |ddm|= 2.79e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.70635616e-01 2.44137941e+04 3.66145460e+03 8.33268412e+02
 2.35768009e+02 7.61803057e+01 1.08570646e+01 2.77338244e+01
 3.27097353e-01 2.15645620e+00 3.47078592e+00 3.69097584e+00
 1.24532859e+01 5.47794972e+01 3.31049803e-01 1.14830136e+00]
E = -128.53236722699708
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.870635615621       1
[INPUT] 0    0    [1    /1   ]  24413.7941276        1
[INPUT] 0    0    [1    /1   ]  3661.45459666        1
[INPUT] 0    0    [1    /1   ]  833.268411514        1
[INPUT] 0    0    [1    /1   ]  235.768008667        1
[INPUT] 0    0    [1    /1   ]  76.1803057075        1
[INPUT] 0    0    [1    /1   ]  10.8570645741        1
[INPUT] 0    0    [1    /1   ]  27.7338244247        1
[INPUT] 0    0    [1    /1   ]  0.327097352883       1
[INPUT] 0    0    [1    /1   ]  2.15645620489        1
[INPUT] 0    0    [1    /1   ]  3.47078591739        1
[INPUT] 1    0    [1    /1   ]  3.69097584286        1
[INPUT] 1    0    [1    /1   ]  12.4532858724        1
[INPUT] 1    0    [1    /1   ]  54.7794971982        1
[INPUT] 1    0    [1    /1   ]  0.331049803072       1
[INPUT] 1    0    [1    /1   ]  1.14830135502        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8706356156212752, 1.0]], [0, [24413.794127580113, 1.0]], [0, [3661.454596657753, 1.0]], [0, [833.268411514478, 1.0]], [0, [235.76800866747158, 1.0]], [0, [76.18030570747212, 1.0]], [0, [10.857064574116286, 1.0]], [0, [27.73382442465065, 1.0]], [0, [0.32709735288275427, 1.0]], [0, [2.1564562048876224, 1.0]], [0, [3.4707859173923863, 1.0]], [1, [3.6909758428594803, 1.0]], [1, [12.453285872395393, 1.0]], [1, [54.779497198153344, 1.0]], [1, [0.33104980307171433, 1.0]], [1, [1.148301355023866, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.87063562]
bas 1, expnt(s) = [24413.79412758]
bas 2, expnt(s) = [3661.45459666]
bas 3, expnt(s) = [833.26841151]
bas 4, expnt(s) = [235.76800867]
bas 5, expnt(s) = [76.18030571]
bas 6, expnt(s) = [10.85706457]
bas 7, expnt(s) = [27.73382442]
bas 8, expnt(s) = [0.32709735]
bas 9, expnt(s) = [2.1564562]
bas 10, expnt(s) = [3.47078592]
bas 11, expnt(s) = [3.69097584]
bas 12, expnt(s) = [12.45328587]
bas 13, expnt(s) = [54.7794972]
bas 14, expnt(s) = [0.3310498]
bas 15, expnt(s) = [1.14830136]
CPU time:       166.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.70635616e-01 2.27715371e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268412e+02 3.91835439e+02
 2.35768009e+02 1.52012283e+02 7.61803057e+01 6.51473954e+01
 1.08570646e+01 1.51112134e+01 2.77338244e+01 3.05332016e+01
 3.27097353e-01 1.09275499e+00 2.15645620e+00 4.49593999e+00
 3.47078592e+00 6.42444912e+00 3.69097584e+00 1.49248817e+01
 1.24532859e+01 6.82479074e+01 5.47794972e+01 4.34767373e+02
 3.31049803e-01 7.32573256e-01 1.14830136e+00 3.46780157e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998460946997387
cond(S) = 2479.422805086245
E1 = -183.57822631497868  E_coul = 55.07857230562522
init E= -128.499654009353
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773934665600478  LUMO = 0.874230428971813
  mo_energy =
[-3.25554125e+01 -1.85289242e+00 -7.73934666e-01 -7.73934666e-01
 -7.73934666e-01  8.74230429e-01  1.11940634e+00  1.11940634e+00
  1.11940634e+00  4.62598440e+00  5.79611199e+00  5.79611199e+00
  5.79611199e+00  1.46939963e+01  2.42521135e+01  2.42521135e+01
  2.42521135e+01  4.62970787e+01  1.19147514e+02  1.19147514e+02
  1.19147514e+02  1.52703046e+02  5.16630109e+02  1.88304188e+03
  8.01126404e+03  4.77770485e+04]
E1 = -182.11221210298282  E_coul = 53.58319050132732
cycle= 1 E= -128.529021601656  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461071
diis-c [-0.21258649  1.        ]
  HOMO = -0.879522921117568  LUMO = 0.844633318904553
  mo_energy =
[-3.28737906e+01 -1.96307279e+00 -8.79522921e-01 -8.79522921e-01
 -8.79522921e-01  8.44633319e-01  1.08105818e+00  1.08105818e+00
  1.08105818e+00  4.54561830e+00  5.66707972e+00  5.66707972e+00
  5.66707972e+00  1.45420337e+01  2.40173267e+01  2.40173267e+01
  2.40173267e+01  4.60526403e+01  1.18826861e+02  1.18826861e+02
  1.18826861e+02  1.52391121e+02  5.16273609e+02  1.88264887e+03
  8.01084186e+03  4.77766074e+04]
E1 = -182.84325259571526  E_coul = 54.31173045611264
cycle= 2 E= -128.531522139603  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0688
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230168
diis-c [-6.48971169e-04  3.31950799e-01  6.68049201e-01]
  HOMO = -0.845209799895856  LUMO = 0.854241913166597
  mo_energy =
[-3.27688916e+01 -1.92699792e+00 -8.45209800e-01 -8.45209800e-01
 -8.45209800e-01  8.54241913e-01  1.09358643e+00  1.09358643e+00
  1.09358643e+00  4.57154785e+00  5.70901898e+00  5.70901898e+00
  5.70901898e+00  1.45916508e+01  2.40947979e+01  2.40947979e+01
  2.40947979e+01  4.61335134e+01  1.18931784e+02  1.18931784e+02
  1.18931784e+02  1.52493632e+02  5.16386940e+02  1.88276752e+03
  8.01096297e+03  4.77767295e+04]
E1 = -182.5980948681426  E_coul = 54.06572766341706
cycle= 3 E= -128.532367204726  delta_E= -0.000845  |g|= 0.000484  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000971515
diis-c [-1.53046548e-07 -2.23105824e-03 -6.04345167e-04  1.00283540e+00]
  HOMO = -0.845452670644152  LUMO = 0.854199612156298
  mo_energy =
[-3.27693198e+01 -1.92717666e+00 -8.45452671e-01 -8.45452671e-01
 -8.45452671e-01  8.54199612e-01  1.09353181e+00  1.09353181e+00
  1.09353181e+00  4.57140895e+00  5.70880478e+00  5.70880478e+00
  5.70880478e+00  1.45914052e+01  2.40944589e+01  2.40944589e+01
  2.40944589e+01  4.61331706e+01  1.18931344e+02  1.18931344e+02
  1.18931344e+02  1.52493205e+02  5.16386410e+02  1.88276687e+03
  8.01096223e+03  4.77767287e+04]
E1 = -182.59862954631  E_coul = 54.066262319852875
cycle= 4 E= -128.532367226457  delta_E= -2.17e-08  |g|= 6.38e-05  |ddm|= 0.000356
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132588
diis-c [-1.01260341e-09  3.29110844e-04  4.12004696e-04 -2.13716152e-01
  1.21297504e+00]
  HOMO = -0.845485086722023  LUMO = 0.854192216552112
  mo_energy =
[-3.27693726e+01 -1.92719662e+00 -8.45485087e-01 -8.45485087e-01
 -8.45485087e-01  8.54192217e-01  1.09351813e+00  1.09351813e+00
  1.09351813e+00  4.57138658e+00  5.70876886e+00  5.70876886e+00
  5.70876886e+00  1.45913677e+01  2.40944112e+01  2.40944112e+01
  2.40944112e+01  4.61331230e+01  1.18931291e+02  1.18931291e+02
  1.18931291e+02  1.52493152e+02  5.16386349e+02  1.88276680e+03
  8.01096216e+03  4.77767286e+04]
E1 = -182.59873336408558  E_coul = 54.06636613709106
cycle= 5 E= -128.532367226995  delta_E= -5.37e-10  |g|= 6.82e-06  |ddm|= 5.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59873336408558  E_coul = 54.06636613709106
  HOMO = -0.845481322047323  LUMO = 0.85419380431136
  mo_energy =
[-3.27693644e+01 -1.92719215e+00 -8.45481322e-01 -8.45481322e-01
 -8.45481322e-01  8.54193804e-01  1.09351971e+00  1.09351971e+00
  1.09351971e+00  4.57139004e+00  5.70877344e+00  5.70877344e+00
  5.70877344e+00  1.45913732e+01  2.40944183e+01  2.40944183e+01
  2.40944183e+01  4.61331303e+01  1.18931299e+02  1.18931299e+02
  1.18931299e+02  1.52493160e+02  5.16386357e+02  1.88276681e+03
  8.01096217e+03  4.77767286e+04]
E1 = -182.59871539451032  E_coul = 54.06634816751324
Extra cycle  E= -128.532367226997  delta_E= -2.56e-12  |g|= 2.51e-06  |ddm|= 2.79e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2479.422805086245
E1 = -182.59871539451032  E_coul = 54.06634816751324
init E= -128.532367226997
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845482576940638  LUMO = 0.854193524339702
  mo_energy =
[-3.27693684e+01 -1.92719336e+00 -8.45482577e-01 -8.45482577e-01
 -8.45482577e-01  8.54193524e-01  1.09351927e+00  1.09351927e+00
  1.09351927e+00  4.57138918e+00  5.70877191e+00  5.70877191e+00
  5.70877191e+00  1.45913714e+01  2.40944154e+01  2.40944154e+01
  2.40944154e+01  4.61331273e+01  1.18931295e+02  1.18931295e+02
  1.18931295e+02  1.52493156e+02  5.16386353e+02  1.88276681e+03
  8.01096216e+03  4.77767286e+04]
E1 = -182.59872508166146  E_coul = 54.06635785466384
cycle= 1 E= -128.532367226998  delta_E= -5.4e-13  |g|= 1.33e-06  |ddm|= 9.69e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59872508166146  E_coul = 54.06635785466384
  HOMO = -0.84548189567489  LUMO = 0.854193727450013
  mo_energy =
[-3.27693664e+01 -1.92719262e+00 -8.45481896e-01 -8.45481896e-01
 -8.45481896e-01  8.54193727e-01  1.09351953e+00  1.09351953e+00
  1.09351953e+00  4.57138971e+00  5.70877274e+00  5.70877274e+00
  5.70877274e+00  1.45913724e+01  2.40944169e+01  2.40944169e+01
  2.40944169e+01  4.61331289e+01  1.18931297e+02  1.18931297e+02
  1.18931297e+02  1.52493158e+02  5.16386355e+02  1.88276681e+03
  8.01096217e+03  4.77767286e+04]
E1 = -182.59872026984615  E_coul = 54.066353042848256
Extra cycle  E= -128.532367226998  delta_E= -2.84e-13  |g|= 6.55e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.70635616e-01 2.44137941e+04 3.66145460e+03 8.33268412e+02
 2.35768009e+02 7.61803057e+01 1.08570646e+01 2.77338244e+01
 3.27097353e-01 2.15645620e+00 3.47078592e+00 3.69097584e+00
 1.24532859e+01 5.47794972e+01 3.31049803e-01 1.14830136e+00]
grad_E = [ 2.36723008e-04 -1.98943264e-09  1.03699018e-07 -1.94537006e-06
  1.87878509e-05 -7.47012025e-05 -5.01561188e-05  3.05530132e-05
 -2.21029008e-04  3.88132096e-06 -7.27308176e-05 -3.72872202e-04
  1.96252183e-06 -2.26706229e-07 -2.34226381e-03  2.12041295e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.854508945866       1
[INPUT] 0    0    [1    /1   ]  24413.7941276        1
[INPUT] 0    0    [1    /1   ]  3661.45459651        1
[INPUT] 0    0    [1    /1   ]  833.268401722        1
[INPUT] 0    0    [1    /1   ]  235.768477756        1
[INPUT] 0    0    [1    /1   ]  76.172109377         1
[INPUT] 0    0    [1    /1   ]  10.8857609962        1
[INPUT] 0    0    [1    /1   ]  27.7725671406        1
[INPUT] 0    0    [1    /1   ]  0.324809070324       1
[INPUT] 0    0    [1    /1   ]  2.06756305633        1
[INPUT] 0    0    [1    /1   ]  3.50444289171        1
[INPUT] 1    0    [1    /1   ]  3.69103606005        1
[INPUT] 1    0    [1    /1   ]  12.4542955808        1
[INPUT] 1    0    [1    /1   ]  54.7791424407        1
[INPUT] 1    0    [1    /1   ]  0.331069750969       1
[INPUT] 1    0    [1    /1   ]  1.14829248001        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8545089458657994, 1.0]], [0, [24413.79412758393, 1.0]], [0, [3661.45459651358, 1.0]], [0, [833.2684017218586, 1.0]], [0, [235.76847775647025, 1.0]], [0, [76.17210937698027, 1.0]], [0, [10.885760996219268, 1.0]], [0, [27.77256714061215, 1.0]], [0, [0.32480907032379525, 1.0]], [0, [2.067563056327862, 1.0]], [0, [3.504442891710793, 1.0]], [1, [3.6910360600486887, 1.0]], [1, [12.454295580839053, 1.0]], [1, [54.779142440700085, 1.0]], [1, [0.3310697509685134, 1.0]], [1, [1.1482924800050587, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.85450895]
bas 1, expnt(s) = [24413.79412758]
bas 2, expnt(s) = [3661.45459651]
bas 3, expnt(s) = [833.26840172]
bas 4, expnt(s) = [235.76847776]
bas 5, expnt(s) = [76.17210938]
bas 6, expnt(s) = [10.885761]
bas 7, expnt(s) = [27.77256714]
bas 8, expnt(s) = [0.32480907]
bas 9, expnt(s) = [2.06756306]
bas 10, expnt(s) = [3.50444289]
bas 11, expnt(s) = [3.69103606]
bas 12, expnt(s) = [12.45429558]
bas 13, expnt(s) = [54.77914244]
bas 14, expnt(s) = [0.33106975]
bas 15, expnt(s) = [1.14829248]
CPU time:       170.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.54508946e-01 2.24544532e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268402e+02 3.91835436e+02
 2.35768478e+02 1.52012510e+02 7.61721094e+01 6.51421384e+01
 1.08857610e+01 1.51411590e+01 2.77725671e+01 3.05651860e+01
 3.24809070e-01 1.08701650e+00 2.06756306e+00 4.35621290e+00
 3.50444289e+00 6.47111719e+00 3.69103606e+00 1.49251860e+01
 1.24542956e+01 6.82548244e+01 5.47791424e+01 4.34763853e+02
 3.31069751e-01 7.32628434e-01 1.14829248e+00 3.46776807e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998461299213433
cond(S) = 2100.8510611112383
E1 = -183.57823316887297  E_coul = 55.07857368267106
init E= -128.499659486202
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773934642286687  LUMO = 0.859332112380845
  mo_energy =
[-3.25554096e+01 -1.85289652e+00 -7.73934642e-01 -7.73934642e-01
 -7.73934642e-01  8.59332112e-01  1.11946547e+00  1.11946547e+00
  1.11946547e+00  4.52326125e+00  5.79618444e+00  5.79618444e+00
  5.79618444e+00  1.44523261e+01  2.42533787e+01  2.42533787e+01
  2.42533787e+01  4.60493298e+01  1.19150327e+02  1.19150327e+02
  1.19150327e+02  1.52584986e+02  5.16588013e+02  1.88301809e+03
  8.01124579e+03  4.77770340e+04]
E1 = -182.11231674662582  E_coul = 53.58329083435485
cycle= 1 E= -128.529025912271  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460993
diis-c [-0.21251486  1.        ]
  HOMO = -0.879516195083132  LUMO = 0.830341742741194
  mo_energy =
[-3.28737654e+01 -1.96307003e+00 -8.79516195e-01 -8.79516195e-01
 -8.79516195e-01  8.30341743e-01  1.08111715e+00  1.08111715e+00
  1.08111715e+00  4.44424429e+00  5.66716052e+00  5.66716052e+00
  5.66716052e+00  1.43009673e+01  2.40186055e+01  2.40186055e+01
  2.40186055e+01  4.58046789e+01  1.18829695e+02  1.18829695e+02
  1.18829695e+02  1.52272985e+02  5.16231524e+02  1.88262512e+03
  8.01082365e+03  4.77765929e+04]
E1 = -182.8433245452793  E_coul = 54.311798281200105
cycle= 2 E= -128.531526264079  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230129
diis-c [-6.47950275e-04  3.31951162e-01  6.68048838e-01]
  HOMO = -0.845204681302253  LUMO = 0.839756150587886
  mo_energy =
[-3.27688706e+01 -1.92699710e+00 -8.45204681e-01 -8.45204681e-01
 -8.45204681e-01  8.39756151e-01  1.09364494e+00  1.09364494e+00
  1.09364494e+00  4.46973551e+00  5.70909809e+00  5.70909809e+00
  5.70909809e+00  1.43503854e+01  2.40960754e+01  2.40960754e+01
  2.40960754e+01  4.58856271e+01  1.18934614e+02  1.18934614e+02
  1.18934614e+02  1.52375526e+02  5.16344857e+02  1.88274376e+03
  8.01094475e+03  4.77767149e+04]
E1 = -182.59817572913232  E_coul = 54.065804465564725
cycle= 3 E= -128.532371263568  delta_E= -0.000845  |g|= 0.000485  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000971572
diis-c [-1.53614473e-07 -2.23283667e-03 -6.08415630e-04  1.00284125e+00]
  HOMO = -0.845447714585181  LUMO = 0.83971460189862
  mo_energy =
[-3.27692991e+01 -1.92717601e+00 -8.45447715e-01 -8.45447715e-01
 -8.45447715e-01  8.39714602e-01  1.09359012e+00  1.09359012e+00
  1.09359012e+00  4.46959867e+00  5.70888377e+00  5.70888377e+00
  5.70888377e+00  1.43501407e+01  2.40957363e+01  2.40957363e+01
  2.40957363e+01  4.58852839e+01  1.18934173e+02  1.18934173e+02
  1.18934173e+02  1.52375099e+02  5.16344327e+02  1.88274311e+03
  8.01094402e+03  4.77767141e+04]
E1 = -182.5987096923327  E_coul = 54.066338406897486
cycle= 4 E= -128.532371285435  delta_E= -2.19e-08  |g|= 6.39e-05  |ddm|= 0.000352
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132627
diis-c [-1.01272452e-09  3.29022288e-04  4.12296752e-04 -2.13613051e-01
  1.21287173e+00]
  HOMO = -0.845480197635275  LUMO = 0.839707314676439
  mo_energy =
[-3.27693519e+01 -1.92719603e+00 -8.45480198e-01 -8.45480198e-01
 -8.45480198e-01  8.39707315e-01  1.09357639e+00  1.09357639e+00
  1.09357639e+00  4.46957656e+00  5.70884780e+00  5.70884780e+00
  5.70884780e+00  1.43501032e+01  2.40956885e+01  2.40956885e+01
  2.40956885e+01  4.58852363e+01  1.18934120e+02  1.18934120e+02
  1.18934120e+02  1.52375045e+02  5.16344266e+02  1.88274305e+03
  8.01094394e+03  4.77767141e+04]
E1 = -182.59881327112012  E_coul = 54.066441985143456
cycle= 5 E= -128.532371285977  delta_E= -5.41e-10  |g|= 6.81e-06  |ddm|= 5.94e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59881327112012  E_coul = 54.066441985143456
  HOMO = -0.845476445926456  LUMO = 0.839708871554189
  mo_energy =
[-3.27693437e+01 -1.92719157e+00 -8.45476446e-01 -8.45476446e-01
 -8.45476446e-01  8.39708872e-01  1.09357797e+00  1.09357797e+00
  1.09357797e+00  4.46957998e+00  5.70885236e+00  5.70885236e+00
  5.70885236e+00  1.43501086e+01  2.40956955e+01  2.40956955e+01
  2.40956955e+01  4.58852435e+01  1.18934128e+02  1.18934128e+02
  1.18934128e+02  1.52375053e+02  5.16344274e+02  1.88274305e+03
  8.01094395e+03  4.77767141e+04]
E1 = -182.59879536249073  E_coul = 54.066424076511254
Extra cycle  E= -128.532371285979  delta_E= -2.81e-12  |g|= 2.51e-06  |ddm|= 2.7e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [8.54508946e-01 2.44137941e+04 3.66145460e+03 8.33268402e+02
 2.35768478e+02 7.61721094e+01 1.08857610e+01 2.77725671e+01
 3.24809070e-01 2.06756306e+00 3.50444289e+00 3.69103606e+00
 1.24542956e+01 5.47791424e+01 3.31069751e-01 1.14829248e+00]
E = -128.53237128597948
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.854508945866       1
[INPUT] 0    0    [1    /1   ]  24413.7941276        1
[INPUT] 0    0    [1    /1   ]  3661.45459651        1
[INPUT] 0    0    [1    /1   ]  833.268401722        1
[INPUT] 0    0    [1    /1   ]  235.768477756        1
[INPUT] 0    0    [1    /1   ]  76.172109377         1
[INPUT] 0    0    [1    /1   ]  10.8857609962        1
[INPUT] 0    0    [1    /1   ]  27.7725671406        1
[INPUT] 0    0    [1    /1   ]  0.324809070324       1
[INPUT] 0    0    [1    /1   ]  2.06756305633        1
[INPUT] 0    0    [1    /1   ]  3.50444289171        1
[INPUT] 1    0    [1    /1   ]  3.69103606005        1
[INPUT] 1    0    [1    /1   ]  12.4542955808        1
[INPUT] 1    0    [1    /1   ]  54.7791424407        1
[INPUT] 1    0    [1    /1   ]  0.331069750969       1
[INPUT] 1    0    [1    /1   ]  1.14829248001        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8545089458657994, 1.0]], [0, [24413.79412758393, 1.0]], [0, [3661.45459651358, 1.0]], [0, [833.2684017218586, 1.0]], [0, [235.76847775647025, 1.0]], [0, [76.17210937698027, 1.0]], [0, [10.885760996219268, 1.0]], [0, [27.77256714061215, 1.0]], [0, [0.32480907032379525, 1.0]], [0, [2.067563056327862, 1.0]], [0, [3.504442891710793, 1.0]], [1, [3.6910360600486887, 1.0]], [1, [12.454295580839053, 1.0]], [1, [54.779142440700085, 1.0]], [1, [0.3310697509685134, 1.0]], [1, [1.1482924800050587, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.85450895]
bas 1, expnt(s) = [24413.79412758]
bas 2, expnt(s) = [3661.45459651]
bas 3, expnt(s) = [833.26840172]
bas 4, expnt(s) = [235.76847776]
bas 5, expnt(s) = [76.17210938]
bas 6, expnt(s) = [10.885761]
bas 7, expnt(s) = [27.77256714]
bas 8, expnt(s) = [0.32480907]
bas 9, expnt(s) = [2.06756306]
bas 10, expnt(s) = [3.50444289]
bas 11, expnt(s) = [3.69103606]
bas 12, expnt(s) = [12.45429558]
bas 13, expnt(s) = [54.77914244]
bas 14, expnt(s) = [0.33106975]
bas 15, expnt(s) = [1.14829248]
CPU time:       170.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.54508946e-01 2.24544532e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268402e+02 3.91835436e+02
 2.35768478e+02 1.52012510e+02 7.61721094e+01 6.51421384e+01
 1.08857610e+01 1.51411590e+01 2.77725671e+01 3.05651860e+01
 3.24809070e-01 1.08701650e+00 2.06756306e+00 4.35621290e+00
 3.50444289e+00 6.47111719e+00 3.69103606e+00 1.49251860e+01
 1.24542956e+01 6.82548244e+01 5.47791424e+01 4.34763853e+02
 3.31069751e-01 7.32628434e-01 1.14829248e+00 3.46776807e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998461299213433
cond(S) = 2100.8510611112383
E1 = -183.57823316887297  E_coul = 55.07857368267106
init E= -128.499659486202
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773934642286687  LUMO = 0.859332112380845
  mo_energy =
[-3.25554096e+01 -1.85289652e+00 -7.73934642e-01 -7.73934642e-01
 -7.73934642e-01  8.59332112e-01  1.11946547e+00  1.11946547e+00
  1.11946547e+00  4.52326125e+00  5.79618444e+00  5.79618444e+00
  5.79618444e+00  1.44523261e+01  2.42533787e+01  2.42533787e+01
  2.42533787e+01  4.60493298e+01  1.19150327e+02  1.19150327e+02
  1.19150327e+02  1.52584986e+02  5.16588013e+02  1.88301809e+03
  8.01124579e+03  4.77770340e+04]
E1 = -182.11231674662582  E_coul = 53.58329083435485
cycle= 1 E= -128.529025912271  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460993
diis-c [-0.21251486  1.        ]
  HOMO = -0.879516195083132  LUMO = 0.830341742741194
  mo_energy =
[-3.28737654e+01 -1.96307003e+00 -8.79516195e-01 -8.79516195e-01
 -8.79516195e-01  8.30341743e-01  1.08111715e+00  1.08111715e+00
  1.08111715e+00  4.44424429e+00  5.66716052e+00  5.66716052e+00
  5.66716052e+00  1.43009673e+01  2.40186055e+01  2.40186055e+01
  2.40186055e+01  4.58046789e+01  1.18829695e+02  1.18829695e+02
  1.18829695e+02  1.52272985e+02  5.16231524e+02  1.88262512e+03
  8.01082365e+03  4.77765929e+04]
E1 = -182.8433245452793  E_coul = 54.311798281200105
cycle= 2 E= -128.531526264079  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230129
diis-c [-6.47950275e-04  3.31951162e-01  6.68048838e-01]
  HOMO = -0.845204681302253  LUMO = 0.839756150587886
  mo_energy =
[-3.27688706e+01 -1.92699710e+00 -8.45204681e-01 -8.45204681e-01
 -8.45204681e-01  8.39756151e-01  1.09364494e+00  1.09364494e+00
  1.09364494e+00  4.46973551e+00  5.70909809e+00  5.70909809e+00
  5.70909809e+00  1.43503854e+01  2.40960754e+01  2.40960754e+01
  2.40960754e+01  4.58856271e+01  1.18934614e+02  1.18934614e+02
  1.18934614e+02  1.52375526e+02  5.16344857e+02  1.88274376e+03
  8.01094475e+03  4.77767149e+04]
E1 = -182.59817572913232  E_coul = 54.065804465564725
cycle= 3 E= -128.532371263568  delta_E= -0.000845  |g|= 0.000485  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000971572
diis-c [-1.53614473e-07 -2.23283667e-03 -6.08415630e-04  1.00284125e+00]
  HOMO = -0.845447714585181  LUMO = 0.83971460189862
  mo_energy =
[-3.27692991e+01 -1.92717601e+00 -8.45447715e-01 -8.45447715e-01
 -8.45447715e-01  8.39714602e-01  1.09359012e+00  1.09359012e+00
  1.09359012e+00  4.46959867e+00  5.70888377e+00  5.70888377e+00
  5.70888377e+00  1.43501407e+01  2.40957363e+01  2.40957363e+01
  2.40957363e+01  4.58852839e+01  1.18934173e+02  1.18934173e+02
  1.18934173e+02  1.52375099e+02  5.16344327e+02  1.88274311e+03
  8.01094402e+03  4.77767141e+04]
E1 = -182.5987096923327  E_coul = 54.066338406897486
cycle= 4 E= -128.532371285435  delta_E= -2.19e-08  |g|= 6.39e-05  |ddm|= 0.000352
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132627
diis-c [-1.01272452e-09  3.29022288e-04  4.12296752e-04 -2.13613051e-01
  1.21287173e+00]
  HOMO = -0.845480197635275  LUMO = 0.839707314676439
  mo_energy =
[-3.27693519e+01 -1.92719603e+00 -8.45480198e-01 -8.45480198e-01
 -8.45480198e-01  8.39707315e-01  1.09357639e+00  1.09357639e+00
  1.09357639e+00  4.46957656e+00  5.70884780e+00  5.70884780e+00
  5.70884780e+00  1.43501032e+01  2.40956885e+01  2.40956885e+01
  2.40956885e+01  4.58852363e+01  1.18934120e+02  1.18934120e+02
  1.18934120e+02  1.52375045e+02  5.16344266e+02  1.88274305e+03
  8.01094394e+03  4.77767141e+04]
E1 = -182.59881327112012  E_coul = 54.066441985143456
cycle= 5 E= -128.532371285977  delta_E= -5.41e-10  |g|= 6.81e-06  |ddm|= 5.94e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59881327112012  E_coul = 54.066441985143456
  HOMO = -0.845476445926456  LUMO = 0.839708871554189
  mo_energy =
[-3.27693437e+01 -1.92719157e+00 -8.45476446e-01 -8.45476446e-01
 -8.45476446e-01  8.39708872e-01  1.09357797e+00  1.09357797e+00
  1.09357797e+00  4.46957998e+00  5.70885236e+00  5.70885236e+00
  5.70885236e+00  1.43501086e+01  2.40956955e+01  2.40956955e+01
  2.40956955e+01  4.58852435e+01  1.18934128e+02  1.18934128e+02
  1.18934128e+02  1.52375053e+02  5.16344274e+02  1.88274305e+03
  8.01094395e+03  4.77767141e+04]
E1 = -182.59879536249073  E_coul = 54.066424076511254
Extra cycle  E= -128.532371285979  delta_E= -2.81e-12  |g|= 2.51e-06  |ddm|= 2.7e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2100.8510611112383
E1 = -182.59879536249073  E_coul = 54.066424076511254
init E= -128.532371285979
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845477696780232  LUMO = 0.839708599125529
  mo_energy =
[-3.27693477e+01 -1.92719277e+00 -8.45477697e-01 -8.45477697e-01
 -8.45477697e-01  8.39708599e-01  1.09357754e+00  1.09357754e+00
  1.09357754e+00  4.46957913e+00  5.70885083e+00  5.70885083e+00
  5.70885083e+00  1.43501069e+01  2.40956926e+01  2.40956926e+01
  2.40956926e+01  4.58852405e+01  1.18934124e+02  1.18934124e+02
  1.18934124e+02  1.52375049e+02  5.16344269e+02  1.88274305e+03
  8.01094394e+03  4.77767141e+04]
E1 = -182.59880501906198  E_coul = 54.066433733081944
cycle= 1 E= -128.53237128598  delta_E= -5.68e-13  |g|= 1.32e-06  |ddm|= 9.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59880501906198  E_coul = 54.066433733081944
  HOMO = -0.845477017707644  LUMO = 0.839708797678946
  mo_energy =
[-3.27693457e+01 -1.92719204e+00 -8.45477018e-01 -8.45477018e-01
 -8.45477018e-01  8.39708798e-01  1.09357779e+00  1.09357779e+00
  1.09357779e+00  4.46957965e+00  5.70885166e+00  5.70885166e+00
  5.70885166e+00  1.43501079e+01  2.40956942e+01  2.40956942e+01
  2.40956942e+01  4.58852421e+01  1.18934126e+02  1.18934126e+02
  1.18934126e+02  1.52375051e+02  5.16344272e+02  1.88274305e+03
  8.01094395e+03  4.77767141e+04]
E1 = -182.5988002228653  E_coul = 54.0664289368852
Extra cycle  E= -128.53237128598  delta_E= -5.68e-14  |g|= 6.53e-07  |ddm|= 4.61e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.54508946e-01 2.44137941e+04 3.66145460e+03 8.33268402e+02
 2.35768478e+02 7.61721094e+01 1.08857610e+01 2.77725671e+01
 3.24809070e-01 2.06756306e+00 3.50444289e+00 3.69103606e+00
 1.24542956e+01 5.47791424e+01 3.31069751e-01 1.14829248e+00]
grad_E = [ 3.79527063e-04 -2.08386186e-09  1.08644797e-07 -2.03850702e-06
  1.97072695e-05 -7.80009824e-05 -4.83867521e-06  2.45101333e-05
 -2.84284133e-04 -5.89627560e-05 -9.19659256e-05 -3.77111540e-04
  6.87775124e-06 -6.53013111e-07 -2.19264905e-03  2.06684920e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.841064886407       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460437        1
[INPUT] 0    0    [1    /1   ]  833.268229587        1
[INPUT] 0    0    [1    /1   ]  235.770864442        1
[INPUT] 0    0    [1    /1   ]  76.1508967357        1
[INPUT] 0    0    [1    /1   ]  10.9568580827        1
[INPUT] 0    0    [1    /1   ]  27.8416225983        1
[INPUT] 0    0    [1    /1   ]  0.322217830169       1
[INPUT] 0    0    [1    /1   ]  2.03845467881        1
[INPUT] 0    0    [1    /1   ]  3.56081523687        1
[INPUT] 1    0    [1    /1   ]  3.68846549456        1
[INPUT] 1    0    [1    /1   ]  12.4570766875        1
[INPUT] 1    0    [1    /1   ]  54.7783939468        1
[INPUT] 1    0    [1    /1   ]  0.330599802857       1
[INPUT] 1    0    [1    /1   ]  1.14601938049        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8410648864071798, 1.0]], [0, [24413.794127435136, 1.0]], [0, [3661.454604370159, 1.0]], [0, [833.268229586664, 1.0]], [0, [235.7708644418192, 1.0]], [0, [76.1508967357012, 1.0]], [0, [10.95685808266599, 1.0]], [0, [27.841622598295753, 1.0]], [0, [0.3222178301688389, 1.0]], [0, [2.0384546788128204, 1.0]], [0, [3.5608152368700012, 1.0]], [1, [3.6884654945599227, 1.0]], [1, [12.457076687491456, 1.0]], [1, [54.778393946823705, 1.0]], [1, [0.33059980285727514, 1.0]], [1, [1.146019380494613, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84106489]
bas 1, expnt(s) = [24413.79412744]
bas 2, expnt(s) = [3661.45460437]
bas 3, expnt(s) = [833.26822959]
bas 4, expnt(s) = [235.77086444]
bas 5, expnt(s) = [76.15089674]
bas 6, expnt(s) = [10.95685808]
bas 7, expnt(s) = [27.8416226]
bas 8, expnt(s) = [0.32221783]
bas 9, expnt(s) = [2.03845468]
bas 10, expnt(s) = [3.56081524]
bas 11, expnt(s) = [3.68846549]
bas 12, expnt(s) = [12.45707669]
bas 13, expnt(s) = [54.77839395]
bas 14, expnt(s) = [0.3305998]
bas 15, expnt(s) = [1.14601938]
CPU time:       174.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.41064886e-01 2.21889704e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268230e+02 3.91835375e+02
 2.35770864e+02 1.52013664e+02 7.61508967e+01 6.51285322e+01
 1.09568581e+01 1.52152661e+01 2.78416226e+01 3.06221677e+01
 3.22217830e-01 1.08050604e+00 2.03845468e+00 4.31013447e+00
 3.56081524e+00 6.54903187e+00 3.68846549e+00 1.49121941e+01
 1.24570767e+01 6.82738770e+01 5.47783939e+01 4.34756427e+02
 3.30599803e-01 7.31328722e-01 1.14601938e+00 3.45918943e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998474897044172
cond(S) = 1897.8531419380943
E1 = -183.57822521468262  E_coul = 55.078541002867105
init E= -128.499684211816
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773939198129063  LUMO = 0.847916730934764
  mo_energy =
[-3.25554117e+01 -1.85290293e+00 -7.73939198e-01 -7.73939198e-01
 -7.73939198e-01  8.47916731e-01  1.11728831e+00  1.11728831e+00
  1.11728831e+00  4.47178397e+00  5.78646418e+00  5.78646418e+00
  5.78646418e+00  1.44138096e+01  2.42396488e+01  2.42396488e+01
  2.42396488e+01  4.62139604e+01  1.19143396e+02  1.19143396e+02
  1.19143396e+02  1.53011641e+02  5.17097379e+02  1.88349818e+03
  8.01167294e+03  4.77773885e+04]
E1 = -182.11195403236536  E_coul = 53.58292581728724
cycle= 1 E= -128.529028215078  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461231
diis-c [-0.21273418  1.        ]
  HOMO = -0.879542129126315  LUMO = 0.819326063011127
  mo_energy =
[-3.28738395e+01 -1.96310401e+00 -8.79542129e-01 -8.79542129e-01
 -8.79542129e-01  8.19326063e-01  1.07902294e+00  1.07902294e+00
  1.07902294e+00  4.39311314e+00  5.65750468e+00  5.65750468e+00
  5.65750468e+00  1.42619368e+01  2.40047977e+01  2.40047977e+01
  2.40047977e+01  4.59687583e+01  1.18822690e+02  1.18822690e+02
  1.18822690e+02  1.52699485e+02  5.16740824e+02  1.88310514e+03
  8.01125072e+03  4.77769474e+04]
E1 = -182.84339173900221  E_coul = 54.3118612530294
cycle= 2 E= -128.531530485973  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2303
diis-c [-6.49266031e-04  3.32001749e-01  6.67998251e-01]
  HOMO = -0.845211529488474  LUMO = 0.82861820681957
  mo_energy =
[-3.27688972e+01 -1.92701075e+00 -8.45211529e-01 -8.45211529e-01
 -8.45211529e-01  8.28618207e-01  1.09152980e+00  1.09152980e+00
  1.09152980e+00  4.41850360e+00  5.69943450e+00  5.69943450e+00
  5.69943450e+00  1.43115426e+01  2.40823120e+01  2.40823120e+01
  2.40823120e+01  4.60499102e+01  1.18927658e+02  1.18927658e+02
  1.18927658e+02  1.52802100e+02  5.16854207e+02  1.88322383e+03
  8.01137188e+03  4.77770695e+04]
E1 = -182.59811754159847  E_coul = 54.06574119005453
cycle= 3 E= -128.532376351544  delta_E= -0.000846  |g|= 0.000478  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000959219
diis-c [-1.53169593e-07 -2.22310608e-03 -6.49196665e-04  1.00287230e+00]
  HOMO = -0.845451165626801  LUMO = 0.828578681507099
  mo_energy =
[-3.27693198e+01 -1.92718619e+00 -8.45451166e-01 -8.45451166e-01
 -8.45451166e-01  8.28578682e-01  1.09147671e+00  1.09147671e+00
  1.09147671e+00  4.41837052e+00  5.69922434e+00  5.69922434e+00
  5.69922434e+00  1.43113020e+01  2.40819783e+01  2.40819783e+01
  2.40819783e+01  4.60495720e+01  1.18927224e+02  1.18927224e+02
  1.18927224e+02  1.52801678e+02  5.16853683e+02  1.88322319e+03
  8.01137115e+03  4.77770687e+04]
E1 = -182.59864032882334  E_coul = 54.06626395585109
cycle= 4 E= -128.532376372972  delta_E= -2.14e-08  |g|= 6.35e-05  |ddm|= 0.000342
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132048
diis-c [-1.01150427e-09  3.28911663e-04  4.18765843e-04 -2.14196645e-01
  1.21344897e+00]
  HOMO = -0.84548342457291  LUMO = 0.82857158772116
  mo_energy =
[-3.27693723e+01 -1.92720597e+00 -8.45483425e-01 -8.45483425e-01
 -8.45483425e-01  8.28571588e-01  1.09146311e+00  1.09146311e+00
  1.09146311e+00  4.41834873e+00  5.69918864e+00  5.69918864e+00
  5.69918864e+00  1.43112647e+01  2.40819308e+01  2.40819308e+01
  2.40819308e+01  4.60495247e+01  1.18927171e+02  1.18927171e+02
  1.18927171e+02  1.52801625e+02  5.16853622e+02  1.88322313e+03
  8.01137108e+03  4.77770686e+04]
E1 = -182.59874338692921  E_coul = 54.06636701341771
cycle= 5 E= -128.532376373512  delta_E= -5.39e-10  |g|= 6.8e-06  |ddm|= 5.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59874338692921  E_coul = 54.06636701341771
  HOMO = -0.845479678137892  LUMO = 0.828573120492812
  mo_energy =
[-3.27693641e+01 -1.92720152e+00 -8.45479678e-01 -8.45479678e-01
 -8.45479678e-01  8.28573120e-01  1.09146468e+00  1.09146468e+00
  1.09146468e+00  4.41835212e+00  5.69919319e+00  5.69919319e+00
  5.69919319e+00  1.43112702e+01  2.40819378e+01  2.40819378e+01
  2.40819378e+01  4.60495319e+01  1.18927179e+02  1.18927179e+02
  1.18927179e+02  1.52801633e+02  5.16853630e+02  1.88322313e+03
  8.01137109e+03  4.77770687e+04]
E1 = -182.59872543622566  E_coul = 54.06634906271151
Extra cycle  E= -128.532376373514  delta_E= -2.64e-12  |g|= 2.51e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.41064886e-01 2.44137941e+04 3.66145460e+03 8.33268230e+02
 2.35770864e+02 7.61508967e+01 1.09568581e+01 2.78416226e+01
 3.22217830e-01 2.03845468e+00 3.56081524e+00 3.68846549e+00
 1.24570767e+01 5.47783939e+01 3.30599803e-01 1.14601938e+00]
E = -128.53237637351415
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.841064886407       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460437        1
[INPUT] 0    0    [1    /1   ]  833.268229587        1
[INPUT] 0    0    [1    /1   ]  235.770864442        1
[INPUT] 0    0    [1    /1   ]  76.1508967357        1
[INPUT] 0    0    [1    /1   ]  10.9568580827        1
[INPUT] 0    0    [1    /1   ]  27.8416225983        1
[INPUT] 0    0    [1    /1   ]  0.322217830169       1
[INPUT] 0    0    [1    /1   ]  2.03845467881        1
[INPUT] 0    0    [1    /1   ]  3.56081523687        1
[INPUT] 1    0    [1    /1   ]  3.68846549456        1
[INPUT] 1    0    [1    /1   ]  12.4570766875        1
[INPUT] 1    0    [1    /1   ]  54.7783939468        1
[INPUT] 1    0    [1    /1   ]  0.330599802857       1
[INPUT] 1    0    [1    /1   ]  1.14601938049        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8410648864071798, 1.0]], [0, [24413.794127435136, 1.0]], [0, [3661.454604370159, 1.0]], [0, [833.268229586664, 1.0]], [0, [235.7708644418192, 1.0]], [0, [76.1508967357012, 1.0]], [0, [10.95685808266599, 1.0]], [0, [27.841622598295753, 1.0]], [0, [0.3222178301688389, 1.0]], [0, [2.0384546788128204, 1.0]], [0, [3.5608152368700012, 1.0]], [1, [3.6884654945599227, 1.0]], [1, [12.457076687491456, 1.0]], [1, [54.778393946823705, 1.0]], [1, [0.33059980285727514, 1.0]], [1, [1.146019380494613, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84106489]
bas 1, expnt(s) = [24413.79412744]
bas 2, expnt(s) = [3661.45460437]
bas 3, expnt(s) = [833.26822959]
bas 4, expnt(s) = [235.77086444]
bas 5, expnt(s) = [76.15089674]
bas 6, expnt(s) = [10.95685808]
bas 7, expnt(s) = [27.8416226]
bas 8, expnt(s) = [0.32221783]
bas 9, expnt(s) = [2.03845468]
bas 10, expnt(s) = [3.56081524]
bas 11, expnt(s) = [3.68846549]
bas 12, expnt(s) = [12.45707669]
bas 13, expnt(s) = [54.77839395]
bas 14, expnt(s) = [0.3305998]
bas 15, expnt(s) = [1.14601938]
CPU time:       175.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.41064886e-01 2.21889704e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268230e+02 3.91835375e+02
 2.35770864e+02 1.52013664e+02 7.61508967e+01 6.51285322e+01
 1.09568581e+01 1.52152661e+01 2.78416226e+01 3.06221677e+01
 3.22217830e-01 1.08050604e+00 2.03845468e+00 4.31013447e+00
 3.56081524e+00 6.54903187e+00 3.68846549e+00 1.49121941e+01
 1.24570767e+01 6.82738770e+01 5.47783939e+01 4.34756427e+02
 3.30599803e-01 7.31328722e-01 1.14601938e+00 3.45918943e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998474897044172
cond(S) = 1897.8531419380943
E1 = -183.57822521468262  E_coul = 55.078541002867105
init E= -128.499684211816
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773939198129063  LUMO = 0.847916730934764
  mo_energy =
[-3.25554117e+01 -1.85290293e+00 -7.73939198e-01 -7.73939198e-01
 -7.73939198e-01  8.47916731e-01  1.11728831e+00  1.11728831e+00
  1.11728831e+00  4.47178397e+00  5.78646418e+00  5.78646418e+00
  5.78646418e+00  1.44138096e+01  2.42396488e+01  2.42396488e+01
  2.42396488e+01  4.62139604e+01  1.19143396e+02  1.19143396e+02
  1.19143396e+02  1.53011641e+02  5.17097379e+02  1.88349818e+03
  8.01167294e+03  4.77773885e+04]
E1 = -182.11195403236536  E_coul = 53.58292581728724
cycle= 1 E= -128.529028215078  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461231
diis-c [-0.21273418  1.        ]
  HOMO = -0.879542129126315  LUMO = 0.819326063011127
  mo_energy =
[-3.28738395e+01 -1.96310401e+00 -8.79542129e-01 -8.79542129e-01
 -8.79542129e-01  8.19326063e-01  1.07902294e+00  1.07902294e+00
  1.07902294e+00  4.39311314e+00  5.65750468e+00  5.65750468e+00
  5.65750468e+00  1.42619368e+01  2.40047977e+01  2.40047977e+01
  2.40047977e+01  4.59687583e+01  1.18822690e+02  1.18822690e+02
  1.18822690e+02  1.52699485e+02  5.16740824e+02  1.88310514e+03
  8.01125072e+03  4.77769474e+04]
E1 = -182.84339173900221  E_coul = 54.3118612530294
cycle= 2 E= -128.531530485973  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2303
diis-c [-6.49266031e-04  3.32001749e-01  6.67998251e-01]
  HOMO = -0.845211529488474  LUMO = 0.82861820681957
  mo_energy =
[-3.27688972e+01 -1.92701075e+00 -8.45211529e-01 -8.45211529e-01
 -8.45211529e-01  8.28618207e-01  1.09152980e+00  1.09152980e+00
  1.09152980e+00  4.41850360e+00  5.69943450e+00  5.69943450e+00
  5.69943450e+00  1.43115426e+01  2.40823120e+01  2.40823120e+01
  2.40823120e+01  4.60499102e+01  1.18927658e+02  1.18927658e+02
  1.18927658e+02  1.52802100e+02  5.16854207e+02  1.88322383e+03
  8.01137188e+03  4.77770695e+04]
E1 = -182.59811754159847  E_coul = 54.06574119005453
cycle= 3 E= -128.532376351544  delta_E= -0.000846  |g|= 0.000478  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000959219
diis-c [-1.53169593e-07 -2.22310608e-03 -6.49196665e-04  1.00287230e+00]
  HOMO = -0.845451165626801  LUMO = 0.828578681507099
  mo_energy =
[-3.27693198e+01 -1.92718619e+00 -8.45451166e-01 -8.45451166e-01
 -8.45451166e-01  8.28578682e-01  1.09147671e+00  1.09147671e+00
  1.09147671e+00  4.41837052e+00  5.69922434e+00  5.69922434e+00
  5.69922434e+00  1.43113020e+01  2.40819783e+01  2.40819783e+01
  2.40819783e+01  4.60495720e+01  1.18927224e+02  1.18927224e+02
  1.18927224e+02  1.52801678e+02  5.16853683e+02  1.88322319e+03
  8.01137115e+03  4.77770687e+04]
E1 = -182.59864032882334  E_coul = 54.06626395585109
cycle= 4 E= -128.532376372972  delta_E= -2.14e-08  |g|= 6.35e-05  |ddm|= 0.000342
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132048
diis-c [-1.01150427e-09  3.28911663e-04  4.18765843e-04 -2.14196645e-01
  1.21344897e+00]
  HOMO = -0.84548342457291  LUMO = 0.82857158772116
  mo_energy =
[-3.27693723e+01 -1.92720597e+00 -8.45483425e-01 -8.45483425e-01
 -8.45483425e-01  8.28571588e-01  1.09146311e+00  1.09146311e+00
  1.09146311e+00  4.41834873e+00  5.69918864e+00  5.69918864e+00
  5.69918864e+00  1.43112647e+01  2.40819308e+01  2.40819308e+01
  2.40819308e+01  4.60495247e+01  1.18927171e+02  1.18927171e+02
  1.18927171e+02  1.52801625e+02  5.16853622e+02  1.88322313e+03
  8.01137108e+03  4.77770686e+04]
E1 = -182.59874338692921  E_coul = 54.06636701341771
cycle= 5 E= -128.532376373512  delta_E= -5.39e-10  |g|= 6.8e-06  |ddm|= 5.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59874338692921  E_coul = 54.06636701341771
  HOMO = -0.845479678137892  LUMO = 0.828573120492812
  mo_energy =
[-3.27693641e+01 -1.92720152e+00 -8.45479678e-01 -8.45479678e-01
 -8.45479678e-01  8.28573120e-01  1.09146468e+00  1.09146468e+00
  1.09146468e+00  4.41835212e+00  5.69919319e+00  5.69919319e+00
  5.69919319e+00  1.43112702e+01  2.40819378e+01  2.40819378e+01
  2.40819378e+01  4.60495319e+01  1.18927179e+02  1.18927179e+02
  1.18927179e+02  1.52801633e+02  5.16853630e+02  1.88322313e+03
  8.01137109e+03  4.77770687e+04]
E1 = -182.59872543622566  E_coul = 54.06634906271151
Extra cycle  E= -128.532376373514  delta_E= -2.64e-12  |g|= 2.51e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1897.8531419380943
E1 = -182.59872543622566  E_coul = 54.06634906271151
init E= -128.532376373514
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845480932170082  LUMO = 0.828572850717014
  mo_energy =
[-3.27693681e+01 -1.92720273e+00 -8.45480932e-01 -8.45480932e-01
 -8.45480932e-01  8.28572851e-01  1.09146424e+00  1.09146424e+00
  1.09146424e+00  4.41835128e+00  5.69919166e+00  5.69919166e+00
  5.69919166e+00  1.43112684e+01  2.40819349e+01  2.40819349e+01
  2.40819349e+01  4.60495289e+01  1.18927175e+02  1.18927175e+02
  1.18927175e+02  1.52801629e+02  5.16853626e+02  1.88322313e+03
  8.01137108e+03  4.77770686e+04]
E1 = -182.59873510956498  E_coul = 54.06635873605001
cycle= 1 E= -128.532376373515  delta_E= -8.24e-13  |g|= 1.33e-06  |ddm|= 9.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59873510956498  E_coul = 54.06635873605001
  HOMO = -0.845480251904202  LUMO = 0.828573046859674
  mo_energy =
[-3.27693661e+01 -1.92720199e+00 -8.45480252e-01 -8.45480252e-01
 -8.45480252e-01  8.28573047e-01  1.09146449e+00  1.09146449e+00
  1.09146449e+00  4.41835180e+00  5.69919250e+00  5.69919250e+00
  5.69919250e+00  1.43112694e+01  2.40819365e+01  2.40819365e+01
  2.40819365e+01  4.60495305e+01  1.18927177e+02  1.18927177e+02
  1.18927177e+02  1.52801631e+02  5.16853628e+02  1.88322313e+03
  8.01137108e+03  4.77770687e+04]
E1 = -182.59873030415747  E_coul = 54.06635393064246
Extra cycle  E= -128.532376373515  delta_E= -2.84e-14  |g|= 6.54e-07  |ddm|= 4.61e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.41064886e-01 2.44137941e+04 3.66145460e+03 8.33268230e+02
 2.35770864e+02 7.61508967e+01 1.09568581e+01 2.78416226e+01
 3.22217830e-01 2.03845468e+00 3.56081524e+00 3.68846549e+00
 1.24570767e+01 5.47783939e+01 3.30599803e-01 1.14601938e+00]
grad_E = [ 2.27186731e-04 -2.24888572e-09  1.17281823e-07 -2.19915114e-06
  2.12497303e-05 -8.30144657e-05  4.45963648e-05  1.56447659e-05
  1.77725704e-05 -5.85550844e-05 -1.10806120e-04 -1.77307920e-04
  1.95465912e-05 -2.18926458e-06 -8.84818204e-04  9.10445722e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.824161050719       1
[INPUT] 0    0    [1    /1   ]  24413.7941273        1
[INPUT] 0    0    [1    /1   ]  3661.45461033        1
[INPUT] 0    0    [1    /1   ]  833.268103368        1
[INPUT] 0    0    [1    /1   ]  235.772509521        1
[INPUT] 0    0    [1    /1   ]  76.1373449526        1
[INPUT] 0    0    [1    /1   ]  10.9893706208        1
[INPUT] 0    0    [1    /1   ]  27.884772941         1
[INPUT] 0    0    [1    /1   ]  0.316502620168       1
[INPUT] 0    0    [1    /1   ]  2.01774420023        1
[INPUT] 0    0    [1    /1   ]  3.59012381769        1
[INPUT] 1    0    [1    /1   ]  3.68672086861        1
[INPUT] 1    0    [1    /1   ]  12.4591871316        1
[INPUT] 1    0    [1    /1   ]  54.777919226         1
[INPUT] 1    0    [1    /1   ]  0.330201872363       1
[INPUT] 1    0    [1    /1   ]  1.14430777412        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8241610507190332, 1.0]], [0, [24413.794127321977, 1.0]], [0, [3661.4546103283255, 1.0]], [0, [833.2681033680556, 1.0]], [0, [235.77250952077097, 1.0]], [0, [76.13734495264234, 1.0]], [0, [10.989370620819784, 1.0]], [0, [27.884772941036037, 1.0]], [0, [0.3165026201680807, 1.0]], [0, [2.0177442002337584, 1.0]], [0, [3.5901238176930788, 1.0]], [1, [3.686720868610698, 1.0]], [1, [12.45918713163111, 1.0]], [1, [54.777919225954776, 1.0]], [1, [0.33020187236345816, 1.0]], [1, [1.1443077741216447, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82416105]
bas 1, expnt(s) = [24413.79412732]
bas 2, expnt(s) = [3661.45461033]
bas 3, expnt(s) = [833.26810337]
bas 4, expnt(s) = [235.77250952]
bas 5, expnt(s) = [76.13734495]
bas 6, expnt(s) = [10.98937062]
bas 7, expnt(s) = [27.88477294]
bas 8, expnt(s) = [0.31650262]
bas 9, expnt(s) = [2.0177442]
bas 10, expnt(s) = [3.59012382]
bas 11, expnt(s) = [3.68672087]
bas 12, expnt(s) = [12.45918713]
bas 13, expnt(s) = [54.77791923]
bas 14, expnt(s) = [0.33020187]
bas 15, expnt(s) = [1.14430777]
CPU time:       178.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.24161051e-01 2.18536553e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268103e+02 3.91835331e+02
 2.35772510e+02 1.52014459e+02 7.61373450e+01 6.51198393e+01
 1.09893706e+01 1.52491150e+01 2.78847729e+01 3.06577557e+01
 3.16502620e-01 1.06610016e+00 2.01774420e+00 4.27724970e+00
 3.59012382e+00 6.58941855e+00 3.68672087e+00 1.49033779e+01
 1.24591871e+01 6.82883357e+01 5.47779192e+01 4.34751718e+02
 3.30201872e-01 7.30228547e-01 1.14430777e+00 3.45273266e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486285117428
cond(S) = 1753.8364833586625
E1 = -183.57822092934717  E_coul = 55.07850777882144
init E= -128.499713150526
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943357502713  LUMO = 0.828301586264036
  mo_energy =
[-3.25554141e+01 -1.85290868e+00 -7.73943358e-01 -7.73943358e-01
 -7.73943358e-01  8.28301586e-01  1.11551436e+00  1.11551436e+00
  1.11551436e+00  4.39848166e+00  5.77910804e+00  5.77910804e+00
  5.77910804e+00  1.43185565e+01  2.42297481e+01  2.42297481e+01
  2.42297481e+01  4.62109493e+01  1.19138858e+02  1.19138858e+02
  1.19138858e+02  1.53153633e+02  5.17293971e+02  1.88368719e+03
  8.01184186e+03  4.77775289e+04]
E1 = -182.11139113251582  E_coul = 53.58236399092035
cycle= 1 E= -128.529027141595  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461543
diis-c [-0.21302232  1.        ]
  HOMO = -0.879586517775162  LUMO = 0.800338753979126
  mo_energy =
[-3.28739434e+01 -1.96314968e+00 -8.79586518e-01 -8.79586518e-01
 -8.79586518e-01  8.00338754e-01  1.07730292e+00  1.07730292e+00
  1.07730292e+00  4.32030093e+00  5.65016570e+00  5.65016570e+00
  5.65016570e+00  1.41664478e+01  2.39947950e+01  2.39947950e+01
  2.39947950e+01  4.59653731e+01  1.18818048e+02  1.18818048e+02
  1.18818048e+02  1.52841312e+02  5.16937309e+02  1.88329404e+03
  8.01141954e+03  4.77770877e+04]
E1 = -182.8432810564673  E_coul = 54.31174955716473
cycle= 2 E= -128.531531499303  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0687
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230509
diis-c [-6.49865675e-04  3.32053690e-01  6.67946310e-01]
  HOMO = -0.845236000650783  LUMO = 0.809433433048439
  mo_energy =
[-3.27689499e+01 -1.92703549e+00 -8.45236001e-01 -8.45236001e-01
 -8.45236001e-01  8.09433433e-01  1.08979539e+00  1.08979539e+00
  1.08979539e+00  4.34553864e+00  5.69209763e+00  5.69209763e+00
  5.69209763e+00  1.42161426e+01  2.40723551e+01  2.40723551e+01
  2.40723551e+01  4.60466635e+01  1.18923069e+02  1.18923069e+02
  1.18923069e+02  1.52943998e+02  5.17050747e+02  1.88341279e+03
  8.01154075e+03  4.77772098e+04]
E1 = -182.5978573528516  E_coul = 54.06547900890797
cycle= 3 E= -128.532378343944  delta_E= -0.000847  |g|= 0.000474  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951366
diis-c [-1.56319193e-07 -2.22237129e-03 -6.96234050e-04  1.00291861e+00]
  HOMO = -0.845473578024624  LUMO = 0.809395835672405
  mo_energy =
[-3.27693682e+01 -1.92720830e+00 -8.45473578e-01 -8.45473578e-01
 -8.45473578e-01  8.09395836e-01  1.08974335e+00  1.08974335e+00
  1.08974335e+00  4.34540857e+00  5.69189017e+00  5.69189017e+00
  5.69189017e+00  1.42159050e+01  2.40720250e+01  2.40720250e+01
  2.40720250e+01  4.60463288e+01  1.18922639e+02  1.18922639e+02
  1.18922639e+02  1.52943580e+02  5.17050227e+02  1.88341216e+03
  8.01154003e+03  4.77772091e+04]
E1 = -182.5983705964163  E_coul = 54.065992231136946
cycle= 4 E= -128.532378365279  delta_E= -2.13e-08  |g|= 6.36e-05  |ddm|= 0.000334
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132145
diis-c [-1.02008176e-09  3.30588996e-04  4.24517177e-04 -2.15532760e-01
  1.21477765e+00]
  HOMO = -0.845505791669725  LUMO = 0.809388967264555
  mo_energy =
[-3.27694205e+01 -1.92722788e+00 -8.45505792e-01 -8.45505792e-01
 -8.45505792e-01  8.09388967e-01  1.08972977e+00  1.08972977e+00
  1.08972977e+00  4.34538705e+00  5.69185457e+00  5.69185457e+00
  5.69185457e+00  1.42158679e+01  2.40719777e+01  2.40719777e+01
  2.40719777e+01  4.60462816e+01  1.18922586e+02  1.18922586e+02
  1.18922586e+02  1.52943528e+02  5.17050167e+02  1.88341209e+03
  8.01153995e+03  4.77772090e+04]
E1 = -182.59847319506596  E_coul = 54.06609482924072
cycle= 5 E= -128.532378365825  delta_E= -5.46e-10  |g|= 6.83e-06  |ddm|= 5.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59847319506596  E_coul = 54.06609482924072
  HOMO = -0.845502019460815  LUMO = 0.809390476864666
  mo_energy =
[-3.27694123e+01 -1.92722341e+00 -8.45502019e-01 -8.45502019e-01
 -8.45502019e-01  8.09390477e-01  1.08973136e+00  1.08973136e+00
  1.08973136e+00  4.34539044e+00  5.69185915e+00  5.69185915e+00
  5.69185915e+00  1.42158734e+01  2.40719848e+01  2.40719848e+01
  2.40719848e+01  4.60462889e+01  1.18922594e+02  1.18922594e+02
  1.18922594e+02  1.52943536e+02  5.17050174e+02  1.88341210e+03
  8.01153996e+03  4.77772090e+04]
E1 = -182.59845509084192  E_coul = 54.06607672501373
Extra cycle  E= -128.532378365828  delta_E= -2.96e-12  |g|= 2.53e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.24161051e-01 2.44137941e+04 3.66145461e+03 8.33268103e+02
 2.35772510e+02 7.61373450e+01 1.09893706e+01 2.78847729e+01
 3.16502620e-01 2.01774420e+00 3.59012382e+00 3.68672087e+00
 1.24591871e+01 5.47779192e+01 3.30201872e-01 1.14430777e+00]
E = -128.5323783658282
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.824161050719       1
[INPUT] 0    0    [1    /1   ]  24413.7941273        1
[INPUT] 0    0    [1    /1   ]  3661.45461033        1
[INPUT] 0    0    [1    /1   ]  833.268103368        1
[INPUT] 0    0    [1    /1   ]  235.772509521        1
[INPUT] 0    0    [1    /1   ]  76.1373449526        1
[INPUT] 0    0    [1    /1   ]  10.9893706208        1
[INPUT] 0    0    [1    /1   ]  27.884772941         1
[INPUT] 0    0    [1    /1   ]  0.316502620168       1
[INPUT] 0    0    [1    /1   ]  2.01774420023        1
[INPUT] 0    0    [1    /1   ]  3.59012381769        1
[INPUT] 1    0    [1    /1   ]  3.68672086861        1
[INPUT] 1    0    [1    /1   ]  12.4591871316        1
[INPUT] 1    0    [1    /1   ]  54.777919226         1
[INPUT] 1    0    [1    /1   ]  0.330201872363       1
[INPUT] 1    0    [1    /1   ]  1.14430777412        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8241610507190332, 1.0]], [0, [24413.794127321977, 1.0]], [0, [3661.4546103283255, 1.0]], [0, [833.2681033680556, 1.0]], [0, [235.77250952077097, 1.0]], [0, [76.13734495264234, 1.0]], [0, [10.989370620819784, 1.0]], [0, [27.884772941036037, 1.0]], [0, [0.3165026201680807, 1.0]], [0, [2.0177442002337584, 1.0]], [0, [3.5901238176930788, 1.0]], [1, [3.686720868610698, 1.0]], [1, [12.45918713163111, 1.0]], [1, [54.777919225954776, 1.0]], [1, [0.33020187236345816, 1.0]], [1, [1.1443077741216447, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82416105]
bas 1, expnt(s) = [24413.79412732]
bas 2, expnt(s) = [3661.45461033]
bas 3, expnt(s) = [833.26810337]
bas 4, expnt(s) = [235.77250952]
bas 5, expnt(s) = [76.13734495]
bas 6, expnt(s) = [10.98937062]
bas 7, expnt(s) = [27.88477294]
bas 8, expnt(s) = [0.31650262]
bas 9, expnt(s) = [2.0177442]
bas 10, expnt(s) = [3.59012382]
bas 11, expnt(s) = [3.68672087]
bas 12, expnt(s) = [12.45918713]
bas 13, expnt(s) = [54.77791923]
bas 14, expnt(s) = [0.33020187]
bas 15, expnt(s) = [1.14430777]
CPU time:       179.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.24161051e-01 2.18536553e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268103e+02 3.91835331e+02
 2.35772510e+02 1.52014459e+02 7.61373450e+01 6.51198393e+01
 1.09893706e+01 1.52491150e+01 2.78847729e+01 3.06577557e+01
 3.16502620e-01 1.06610016e+00 2.01774420e+00 4.27724970e+00
 3.59012382e+00 6.58941855e+00 3.68672087e+00 1.49033779e+01
 1.24591871e+01 6.82883357e+01 5.47779192e+01 4.34751718e+02
 3.30201872e-01 7.30228547e-01 1.14430777e+00 3.45273266e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486285117428
cond(S) = 1753.8364833586625
E1 = -183.57822092934717  E_coul = 55.07850777882144
init E= -128.499713150526
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773943357502713  LUMO = 0.828301586264036
  mo_energy =
[-3.25554141e+01 -1.85290868e+00 -7.73943358e-01 -7.73943358e-01
 -7.73943358e-01  8.28301586e-01  1.11551436e+00  1.11551436e+00
  1.11551436e+00  4.39848166e+00  5.77910804e+00  5.77910804e+00
  5.77910804e+00  1.43185565e+01  2.42297481e+01  2.42297481e+01
  2.42297481e+01  4.62109493e+01  1.19138858e+02  1.19138858e+02
  1.19138858e+02  1.53153633e+02  5.17293971e+02  1.88368719e+03
  8.01184186e+03  4.77775289e+04]
E1 = -182.11139113251582  E_coul = 53.58236399092035
cycle= 1 E= -128.529027141595  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461543
diis-c [-0.21302232  1.        ]
  HOMO = -0.879586517775162  LUMO = 0.800338753979126
  mo_energy =
[-3.28739434e+01 -1.96314968e+00 -8.79586518e-01 -8.79586518e-01
 -8.79586518e-01  8.00338754e-01  1.07730292e+00  1.07730292e+00
  1.07730292e+00  4.32030093e+00  5.65016570e+00  5.65016570e+00
  5.65016570e+00  1.41664478e+01  2.39947950e+01  2.39947950e+01
  2.39947950e+01  4.59653731e+01  1.18818048e+02  1.18818048e+02
  1.18818048e+02  1.52841312e+02  5.16937309e+02  1.88329404e+03
  8.01141954e+03  4.77770877e+04]
E1 = -182.8432810564673  E_coul = 54.31174955716473
cycle= 2 E= -128.531531499303  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0687
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230509
diis-c [-6.49865675e-04  3.32053690e-01  6.67946310e-01]
  HOMO = -0.845236000650783  LUMO = 0.809433433048439
  mo_energy =
[-3.27689499e+01 -1.92703549e+00 -8.45236001e-01 -8.45236001e-01
 -8.45236001e-01  8.09433433e-01  1.08979539e+00  1.08979539e+00
  1.08979539e+00  4.34553864e+00  5.69209763e+00  5.69209763e+00
  5.69209763e+00  1.42161426e+01  2.40723551e+01  2.40723551e+01
  2.40723551e+01  4.60466635e+01  1.18923069e+02  1.18923069e+02
  1.18923069e+02  1.52943998e+02  5.17050747e+02  1.88341279e+03
  8.01154075e+03  4.77772098e+04]
E1 = -182.5978573528516  E_coul = 54.06547900890797
cycle= 3 E= -128.532378343944  delta_E= -0.000847  |g|= 0.000474  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951366
diis-c [-1.56319193e-07 -2.22237129e-03 -6.96234050e-04  1.00291861e+00]
  HOMO = -0.845473578024624  LUMO = 0.809395835672405
  mo_energy =
[-3.27693682e+01 -1.92720830e+00 -8.45473578e-01 -8.45473578e-01
 -8.45473578e-01  8.09395836e-01  1.08974335e+00  1.08974335e+00
  1.08974335e+00  4.34540857e+00  5.69189017e+00  5.69189017e+00
  5.69189017e+00  1.42159050e+01  2.40720250e+01  2.40720250e+01
  2.40720250e+01  4.60463288e+01  1.18922639e+02  1.18922639e+02
  1.18922639e+02  1.52943580e+02  5.17050227e+02  1.88341216e+03
  8.01154003e+03  4.77772091e+04]
E1 = -182.5983705964163  E_coul = 54.065992231136946
cycle= 4 E= -128.532378365279  delta_E= -2.13e-08  |g|= 6.36e-05  |ddm|= 0.000334
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132145
diis-c [-1.02008176e-09  3.30588996e-04  4.24517177e-04 -2.15532760e-01
  1.21477765e+00]
  HOMO = -0.845505791669725  LUMO = 0.809388967264555
  mo_energy =
[-3.27694205e+01 -1.92722788e+00 -8.45505792e-01 -8.45505792e-01
 -8.45505792e-01  8.09388967e-01  1.08972977e+00  1.08972977e+00
  1.08972977e+00  4.34538705e+00  5.69185457e+00  5.69185457e+00
  5.69185457e+00  1.42158679e+01  2.40719777e+01  2.40719777e+01
  2.40719777e+01  4.60462816e+01  1.18922586e+02  1.18922586e+02
  1.18922586e+02  1.52943528e+02  5.17050167e+02  1.88341209e+03
  8.01153995e+03  4.77772090e+04]
E1 = -182.59847319506596  E_coul = 54.06609482924072
cycle= 5 E= -128.532378365825  delta_E= -5.46e-10  |g|= 6.83e-06  |ddm|= 5.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59847319506596  E_coul = 54.06609482924072
  HOMO = -0.845502019460815  LUMO = 0.809390476864666
  mo_energy =
[-3.27694123e+01 -1.92722341e+00 -8.45502019e-01 -8.45502019e-01
 -8.45502019e-01  8.09390477e-01  1.08973136e+00  1.08973136e+00
  1.08973136e+00  4.34539044e+00  5.69185915e+00  5.69185915e+00
  5.69185915e+00  1.42158734e+01  2.40719848e+01  2.40719848e+01
  2.40719848e+01  4.60462889e+01  1.18922594e+02  1.18922594e+02
  1.18922594e+02  1.52943536e+02  5.17050174e+02  1.88341210e+03
  8.01153996e+03  4.77772090e+04]
E1 = -182.59845509084192  E_coul = 54.06607672501373
Extra cycle  E= -128.532378365828  delta_E= -2.96e-12  |g|= 2.53e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1753.8364833586625
E1 = -182.59845509084192  E_coul = 54.06607672501373
init E= -128.532378365828
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.845503284097373  LUMO = 0.809390210507673
  mo_energy =
[-3.27694163e+01 -1.92722463e+00 -8.45503284e-01 -8.45503284e-01
 -8.45503284e-01  8.09390211e-01  1.08973092e+00  1.08973092e+00
  1.08973092e+00  4.34538960e+00  5.69185761e+00  5.69185761e+00
  5.69185761e+00  1.42158716e+01  2.40719818e+01  2.40719818e+01
  2.40719818e+01  4.60462859e+01  1.18922590e+02  1.18922590e+02
  1.18922590e+02  1.52943532e+02  5.17050170e+02  1.88341209e+03
  8.01153996e+03  4.77772090e+04]
E1 = -182.5984648450496  E_coul = 54.066086479221035
cycle= 1 E= -128.532378365829  delta_E= -3.41e-13  |g|= 1.34e-06  |ddm|= 9.71e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5984648450496  E_coul = 54.066086479221035
  HOMO = -0.845502598065934  LUMO = 0.809390403916395
  mo_energy =
[-3.27694143e+01 -1.92722388e+00 -8.45502598e-01 -8.45502598e-01
 -8.45502598e-01  8.09390404e-01  1.08973117e+00  1.08973117e+00
  1.08973117e+00  4.34539012e+00  5.69185845e+00  5.69185845e+00
  5.69185845e+00  1.42158726e+01  2.40719834e+01  2.40719834e+01
  2.40719834e+01  4.60462875e+01  1.18922592e+02  1.18922592e+02
  1.18922592e+02  1.52943534e+02  5.17050172e+02  1.88341210e+03
  8.01153996e+03  4.77772090e+04]
E1 = -182.59845999868392  E_coul = 54.06608163285532
Extra cycle  E= -128.532378365829  delta_E= -5.68e-14  |g|= 6.6e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [8.24161051e-01 2.44137941e+04 3.66145461e+03 8.33268103e+02
 2.35772510e+02 7.61373450e+01 1.09893706e+01 2.78847729e+01
 3.16502620e-01 2.01774420e+00 3.59012382e+00 3.68672087e+00
 1.24591871e+01 5.47779192e+01 3.30201872e-01 1.14430777e+00]
grad_E = [ 7.23399154e-05 -2.40499953e-09  1.25492241e-07 -2.35478990e-06
  2.28763437e-05 -9.08322138e-05  4.39511368e-05  2.81762445e-05
  2.39097863e-05 -2.34912159e-05 -1.17918161e-04 -1.12472166e-05
  2.55364412e-05 -3.19170993e-06 -7.42100529e-05  6.40724962e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.816215941979       1
[INPUT] 0    0    [1    /1   ]  24413.7941273        1
[INPUT] 0    0    [1    /1   ]  3661.45460888        1
[INPUT] 0    0    [1    /1   ]  833.268132756        1
[INPUT] 0    0    [1    /1   ]  235.772167435        1
[INPUT] 0    0    [1    /1   ]  76.1395150126        1
[INPUT] 0    0    [1    /1   ]  10.9779669633        1
[INPUT] 0    0    [1    /1   ]  27.8811549649        1
[INPUT] 0    0    [1    /1   ]  0.314185695177       1
[INPUT] 0    0    [1    /1   ]  1.99399513126        1
[INPUT] 0    0    [1    /1   ]  3.58509389029        1
[INPUT] 1    0    [1    /1   ]  3.68667505711        1
[INPUT] 1    0    [1    /1   ]  12.459296493         1
[INPUT] 1    0    [1    /1   ]  54.7779571309        1
[INPUT] 1    0    [1    /1   ]  0.330172474754       1
[INPUT] 1    0    [1    /1   ]  1.14420419993        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8162159419794653, 1.0]], [0, [24413.794127349713, 1.0]], [0, [3661.4546088754305, 1.0]], [0, [833.2681327559152, 1.0]], [0, [235.772167435028, 1.0]], [0, [76.13951501259666, 1.0]], [0, [10.977966963349353, 1.0]], [0, [27.88115496494631, 1.0]], [0, [0.3141856951774093, 1.0]], [0, [1.9939951312597435, 1.0]], [0, [3.585093890294142, 1.0]], [1, [3.686675057111415, 1.0]], [1, [12.45929649304776, 1.0]], [1, [54.77795713089508, 1.0]], [1, [0.33017247475355666, 1.0]], [1, [1.144204199934545, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81621594]
bas 1, expnt(s) = [24413.79412735]
bas 2, expnt(s) = [3661.45460888]
bas 3, expnt(s) = [833.26813276]
bas 4, expnt(s) = [235.77216744]
bas 5, expnt(s) = [76.13951501]
bas 6, expnt(s) = [10.97796696]
bas 7, expnt(s) = [27.88115496]
bas 8, expnt(s) = [0.3141857]
bas 9, expnt(s) = [1.99399513]
bas 10, expnt(s) = [3.58509389]
bas 11, expnt(s) = [3.68667506]
bas 12, expnt(s) = [12.45929649]
bas 13, expnt(s) = [54.77795713]
bas 14, expnt(s) = [0.33017247]
bas 15, expnt(s) = [1.1442042]
CPU time:       182.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.16215942e-01 2.16954583e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268133e+02 3.91835341e+02
 2.35772167e+02 1.52014294e+02 7.61395150e+01 6.51212314e+01
 1.09779670e+01 1.52372455e+01 2.78811550e+01 3.06547723e+01
 3.14185695e-01 1.06024157e+00 1.99399513e+00 4.23943611e+00
 3.58509389e+00 6.58249328e+00 3.68667506e+00 1.49031464e+01
 1.24592965e+01 6.82890850e+01 5.47779571e+01 4.34752094e+02
 3.30172475e-01 7.30147283e-01 1.14420420e+00 3.45234202e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487319533883
cond(S) = 1692.6896059788694
E1 = -183.57822141396687  E_coul = 55.07850401103416
init E= -128.499717402933
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943819175607  LUMO = 0.818975768344799
  mo_energy =
[-3.25554137e+01 -1.85290998e+00 -7.73943819e-01 -7.73943819e-01
 -7.73943819e-01  8.18975768e-01  1.11539010e+00  1.11539010e+00
  1.11539010e+00  4.35114438e+00  5.77868355e+00  5.77868355e+00
  5.77868355e+00  1.42038348e+01  2.42292865e+01  2.42292865e+01
  2.42292865e+01  4.60328937e+01  1.19138799e+02  1.19138799e+02
  1.19138799e+02  1.52951890e+02  5.17100468e+02  1.88351208e+03
  8.01168743e+03  4.77774010e+04]
E1 = -182.11130261396306  E_coul = 53.58227569627241
cycle= 1 E= -128.529026917691  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461586
diis-c [-0.21306127  1.        ]
  HOMO = -0.879594397214889  LUMO = 0.791344136245721
  mo_energy =
[-3.28739572e+01 -1.96315659e+00 -8.79594397e-01 -8.79594397e-01
 -8.79594397e-01  7.91344136e-01  1.07717937e+00  1.07717937e+00
  1.07717937e+00  4.27352409e+00  5.64973582e+00  5.64973582e+00
  5.64973582e+00  1.40520853e+01  2.39943197e+01  2.39943197e+01
  2.39943197e+01  4.57873367e+01  1.18817975e+02  1.18817975e+02
  1.18817975e+02  1.52639533e+02  5.16743781e+02  1.88311891e+03
  8.01126509e+03  4.77769598e+04]
E1 = -182.84324761969435  E_coul = 54.311716081812484
cycle= 2 E= -128.531531537882  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230536
diis-c [-6.49145619e-04  3.32060352e-01  6.67939648e-01]
  HOMO = -0.845241498303314  LUMO = 0.800332948953218
  mo_energy =
[-3.27689573e+01 -1.92704002e+00 -8.45241498e-01 -8.45241498e-01
 -8.45241498e-01  8.00332949e-01  1.08967129e+00  1.08967129e+00
  1.08967129e+00  4.29857951e+00  5.69166967e+00  5.69166967e+00
  5.69166967e+00  1.41016609e+01  2.40718851e+01  2.40718851e+01
  2.40718851e+01  4.58686220e+01  1.18923003e+02  1.18923003e+02
  1.18923003e+02  1.52742233e+02  5.16857229e+02  1.88323767e+03
  8.01138631e+03  4.77770819e+04]
E1 = -182.59780173304097  E_coul = 54.06542321749693
cycle= 3 E= -128.532378515544  delta_E= -0.000847  |g|= 0.000474  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951527
diis-c [-1.58009006e-07 -2.22504047e-03 -7.05505685e-04  1.00293055e+00]
  HOMO = -0.845479160253336  LUMO = 0.800295837976639
  mo_energy =
[-3.27693755e+01 -1.92721272e+00 -8.45479160e-01 -8.45479160e-01
 -8.45479160e-01  8.00295838e-01  1.08961917e+00  1.08961917e+00
  1.08961917e+00  4.29845038e+00  5.69146219e+00  5.69146219e+00
  5.69146219e+00  1.41014238e+01  2.40715551e+01  2.40715551e+01
  2.40715551e+01  4.58682874e+01  1.18922573e+02  1.18922573e+02
  1.18922573e+02  1.52741815e+02  5.16856709e+02  1.88323704e+03
  8.01138559e+03  4.77770811e+04]
E1 = -182.59831400148332  E_coul = 54.065935464490316
cycle= 4 E= -128.532378536993  delta_E= -2.14e-08  |g|= 6.37e-05  |ddm|= 0.000334
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132326
diis-c [-1.02344316e-09  3.31266750e-04  4.24906378e-04 -2.15904343e-01
  1.21514817e+00]
  HOMO = -0.845511423709138  LUMO = 0.80028904704026
  mo_energy =
[-3.27694278e+01 -1.92723228e+00 -8.45511424e-01 -8.45511424e-01
 -8.45511424e-01  8.00289047e-01  1.08960557e+00  1.08960557e+00
  1.08960557e+00  4.29842898e+00  5.69142655e+00  5.69142655e+00
  5.69142655e+00  1.41013868e+01  2.40715078e+01  2.40715078e+01
  2.40715078e+01  4.58682402e+01  1.18922520e+02  1.18922520e+02
  1.18922520e+02  1.52741762e+02  5.16856649e+02  1.88323697e+03
  8.01138552e+03  4.77770810e+04]
E1 = -182.5984164497  E_coul = 54.06603791215667
cycle= 5 E= -128.532378537543  delta_E= -5.5e-10  |g|= 6.85e-06  |ddm|= 5.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5984164497  E_coul = 54.06603791215667
  HOMO = -0.845507643216721  LUMO = 0.800290544097483
  mo_energy =
[-3.27694196e+01 -1.92722780e+00 -8.45507643e-01 -8.45507643e-01
 -8.45507643e-01  8.00290544e-01  1.08960716e+00  1.08960716e+00
  1.08960716e+00  4.29843236e+00  5.69143114e+00  5.69143114e+00
  5.69143114e+00  1.41013923e+01  2.40715148e+01  2.40715148e+01
  2.40715148e+01  4.58682476e+01  1.18922528e+02  1.18922528e+02
  1.18922528e+02  1.52741770e+02  5.16856657e+02  1.88323698e+03
  8.01138552e+03  4.77770811e+04]
E1 = -182.598398309768  E_coul = 54.06601977222156
Extra cycle  E= -128.532378537546  delta_E= -3.1e-12  |g|= 2.54e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [8.16215942e-01 2.44137941e+04 3.66145461e+03 8.33268133e+02
 2.35772167e+02 7.61395150e+01 1.09779670e+01 2.78811550e+01
 3.14185695e-01 1.99399513e+00 3.58509389e+00 3.68667506e+00
 1.24592965e+01 5.47779571e+01 3.30172475e-01 1.14420420e+00]
E = -128.53237853754644
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.816215941979       1
[INPUT] 0    0    [1    /1   ]  24413.7941273        1
[INPUT] 0    0    [1    /1   ]  3661.45460888        1
[INPUT] 0    0    [1    /1   ]  833.268132756        1
[INPUT] 0    0    [1    /1   ]  235.772167435        1
[INPUT] 0    0    [1    /1   ]  76.1395150126        1
[INPUT] 0    0    [1    /1   ]  10.9779669633        1
[INPUT] 0    0    [1    /1   ]  27.8811549649        1
[INPUT] 0    0    [1    /1   ]  0.314185695177       1
[INPUT] 0    0    [1    /1   ]  1.99399513126        1
[INPUT] 0    0    [1    /1   ]  3.58509389029        1
[INPUT] 1    0    [1    /1   ]  3.68667505711        1
[INPUT] 1    0    [1    /1   ]  12.459296493         1
[INPUT] 1    0    [1    /1   ]  54.7779571309        1
[INPUT] 1    0    [1    /1   ]  0.330172474754       1
[INPUT] 1    0    [1    /1   ]  1.14420419993        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8162159419794653, 1.0]], [0, [24413.794127349713, 1.0]], [0, [3661.4546088754305, 1.0]], [0, [833.2681327559152, 1.0]], [0, [235.772167435028, 1.0]], [0, [76.13951501259666, 1.0]], [0, [10.977966963349353, 1.0]], [0, [27.88115496494631, 1.0]], [0, [0.3141856951774093, 1.0]], [0, [1.9939951312597435, 1.0]], [0, [3.585093890294142, 1.0]], [1, [3.686675057111415, 1.0]], [1, [12.45929649304776, 1.0]], [1, [54.77795713089508, 1.0]], [1, [0.33017247475355666, 1.0]], [1, [1.144204199934545, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81621594]
bas 1, expnt(s) = [24413.79412735]
bas 2, expnt(s) = [3661.45460888]
bas 3, expnt(s) = [833.26813276]
bas 4, expnt(s) = [235.77216744]
bas 5, expnt(s) = [76.13951501]
bas 6, expnt(s) = [10.97796696]
bas 7, expnt(s) = [27.88115496]
bas 8, expnt(s) = [0.3141857]
bas 9, expnt(s) = [1.99399513]
bas 10, expnt(s) = [3.58509389]
bas 11, expnt(s) = [3.68667506]
bas 12, expnt(s) = [12.45929649]
bas 13, expnt(s) = [54.77795713]
bas 14, expnt(s) = [0.33017247]
bas 15, expnt(s) = [1.1442042]
CPU time:       183.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.16215942e-01 2.16954583e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268133e+02 3.91835341e+02
 2.35772167e+02 1.52014294e+02 7.61395150e+01 6.51212314e+01
 1.09779670e+01 1.52372455e+01 2.78811550e+01 3.06547723e+01
 3.14185695e-01 1.06024157e+00 1.99399513e+00 4.23943611e+00
 3.58509389e+00 6.58249328e+00 3.68667506e+00 1.49031464e+01
 1.24592965e+01 6.82890850e+01 5.47779571e+01 4.34752094e+02
 3.30172475e-01 7.30147283e-01 1.14420420e+00 3.45234202e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487319533883
cond(S) = 1692.6896059788694
E1 = -183.57822141396687  E_coul = 55.07850401103416
init E= -128.499717402933
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773943819175607  LUMO = 0.818975768344799
  mo_energy =
[-3.25554137e+01 -1.85290998e+00 -7.73943819e-01 -7.73943819e-01
 -7.73943819e-01  8.18975768e-01  1.11539010e+00  1.11539010e+00
  1.11539010e+00  4.35114438e+00  5.77868355e+00  5.77868355e+00
  5.77868355e+00  1.42038348e+01  2.42292865e+01  2.42292865e+01
  2.42292865e+01  4.60328937e+01  1.19138799e+02  1.19138799e+02
  1.19138799e+02  1.52951890e+02  5.17100468e+02  1.88351208e+03
  8.01168743e+03  4.77774010e+04]
E1 = -182.11130261396306  E_coul = 53.58227569627241
cycle= 1 E= -128.529026917691  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461586
diis-c [-0.21306127  1.        ]
  HOMO = -0.879594397214889  LUMO = 0.791344136245721
  mo_energy =
[-3.28739572e+01 -1.96315659e+00 -8.79594397e-01 -8.79594397e-01
 -8.79594397e-01  7.91344136e-01  1.07717937e+00  1.07717937e+00
  1.07717937e+00  4.27352409e+00  5.64973582e+00  5.64973582e+00
  5.64973582e+00  1.40520853e+01  2.39943197e+01  2.39943197e+01
  2.39943197e+01  4.57873367e+01  1.18817975e+02  1.18817975e+02
  1.18817975e+02  1.52639533e+02  5.16743781e+02  1.88311891e+03
  8.01126509e+03  4.77769598e+04]
E1 = -182.84324761969435  E_coul = 54.311716081812484
cycle= 2 E= -128.531531537882  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230536
diis-c [-6.49145619e-04  3.32060352e-01  6.67939648e-01]
  HOMO = -0.845241498303314  LUMO = 0.800332948953218
  mo_energy =
[-3.27689573e+01 -1.92704002e+00 -8.45241498e-01 -8.45241498e-01
 -8.45241498e-01  8.00332949e-01  1.08967129e+00  1.08967129e+00
  1.08967129e+00  4.29857951e+00  5.69166967e+00  5.69166967e+00
  5.69166967e+00  1.41016609e+01  2.40718851e+01  2.40718851e+01
  2.40718851e+01  4.58686220e+01  1.18923003e+02  1.18923003e+02
  1.18923003e+02  1.52742233e+02  5.16857229e+02  1.88323767e+03
  8.01138631e+03  4.77770819e+04]
E1 = -182.59780173304097  E_coul = 54.06542321749693
cycle= 3 E= -128.532378515544  delta_E= -0.000847  |g|= 0.000474  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951527
diis-c [-1.58009006e-07 -2.22504047e-03 -7.05505685e-04  1.00293055e+00]
  HOMO = -0.845479160253336  LUMO = 0.800295837976639
  mo_energy =
[-3.27693755e+01 -1.92721272e+00 -8.45479160e-01 -8.45479160e-01
 -8.45479160e-01  8.00295838e-01  1.08961917e+00  1.08961917e+00
  1.08961917e+00  4.29845038e+00  5.69146219e+00  5.69146219e+00
  5.69146219e+00  1.41014238e+01  2.40715551e+01  2.40715551e+01
  2.40715551e+01  4.58682874e+01  1.18922573e+02  1.18922573e+02
  1.18922573e+02  1.52741815e+02  5.16856709e+02  1.88323704e+03
  8.01138559e+03  4.77770811e+04]
E1 = -182.59831400148332  E_coul = 54.065935464490316
cycle= 4 E= -128.532378536993  delta_E= -2.14e-08  |g|= 6.37e-05  |ddm|= 0.000334
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132326
diis-c [-1.02344316e-09  3.31266750e-04  4.24906378e-04 -2.15904343e-01
  1.21514817e+00]
  HOMO = -0.845511423709138  LUMO = 0.80028904704026
  mo_energy =
[-3.27694278e+01 -1.92723228e+00 -8.45511424e-01 -8.45511424e-01
 -8.45511424e-01  8.00289047e-01  1.08960557e+00  1.08960557e+00
  1.08960557e+00  4.29842898e+00  5.69142655e+00  5.69142655e+00
  5.69142655e+00  1.41013868e+01  2.40715078e+01  2.40715078e+01
  2.40715078e+01  4.58682402e+01  1.18922520e+02  1.18922520e+02
  1.18922520e+02  1.52741762e+02  5.16856649e+02  1.88323697e+03
  8.01138552e+03  4.77770810e+04]
E1 = -182.5984164497  E_coul = 54.06603791215667
cycle= 5 E= -128.532378537543  delta_E= -5.5e-10  |g|= 6.85e-06  |ddm|= 5.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5984164497  E_coul = 54.06603791215667
  HOMO = -0.845507643216721  LUMO = 0.800290544097483
  mo_energy =
[-3.27694196e+01 -1.92722780e+00 -8.45507643e-01 -8.45507643e-01
 -8.45507643e-01  8.00290544e-01  1.08960716e+00  1.08960716e+00
  1.08960716e+00  4.29843236e+00  5.69143114e+00  5.69143114e+00
  5.69143114e+00  1.41013923e+01  2.40715148e+01  2.40715148e+01
  2.40715148e+01  4.58682476e+01  1.18922528e+02  1.18922528e+02
  1.18922528e+02  1.52741770e+02  5.16856657e+02  1.88323698e+03
  8.01138552e+03  4.77770811e+04]
E1 = -182.598398309768  E_coul = 54.06601977222156
Extra cycle  E= -128.532378537546  delta_E= -3.1e-12  |g|= 2.54e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1692.6896059788694
E1 = -182.598398309768  E_coul = 54.06601977222156
init E= -128.532378537546
    CPU time for initialize scf      0.25 sec, wall time      0.26 sec
  HOMO = -0.84550891029351  LUMO = 0.800290280602184
  mo_energy =
[-3.27694236e+01 -1.92722902e+00 -8.45508910e-01 -8.45508910e-01
 -8.45508910e-01  8.00290281e-01  1.08960672e+00  1.08960672e+00
  1.08960672e+00  4.29843152e+00  5.69142960e+00  5.69142960e+00
  5.69142960e+00  1.41013905e+01  2.40715119e+01  2.40715119e+01
  2.40715119e+01  4.58682445e+01  1.18922524e+02  1.18922524e+02
  1.18922524e+02  1.52741767e+02  5.16856653e+02  1.88323697e+03
  8.01138552e+03  4.77770810e+04]
E1 = -182.59840808442803  E_coul = 54.06602954688121
cycle= 1 E= -128.532378537547  delta_E= -3.98e-13  |g|= 1.34e-06  |ddm|= 9.72e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59840808442803  E_coul = 54.06602954688121
  HOMO = -0.845508222806317  LUMO = 0.800290472180688
  mo_energy =
[-3.27694216e+01 -1.92722827e+00 -8.45508223e-01 -8.45508223e-01
 -8.45508223e-01  8.00290472e-01  1.08960697e+00  1.08960697e+00
  1.08960697e+00  4.29843204e+00  5.69143044e+00  5.69143044e+00
  5.69143044e+00  1.41013915e+01  2.40715134e+01  2.40715134e+01
  2.40715134e+01  4.58682461e+01  1.18922526e+02  1.18922526e+02
  1.18922526e+02  1.52741769e+02  5.16856655e+02  1.88323697e+03
  8.01138552e+03  4.77770811e+04]
E1 = -182.598403227939  E_coul = 54.06602469039211
Extra cycle  E= -128.532378537547  delta_E= -5.68e-14  |g|= 6.61e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [8.16215942e-01 2.44137941e+04 3.66145461e+03 8.33268133e+02
 2.35772167e+02 7.61395150e+01 1.09779670e+01 2.78811550e+01
 3.14185695e-01 1.99399513e+00 3.58509389e+00 3.68667506e+00
 1.24592965e+01 5.47779571e+01 3.30172475e-01 1.14420420e+00]
grad_E = [ 9.55256977e-05 -2.41354248e-09  1.25952536e-07 -2.36460414e-06
  2.30185780e-05 -9.21518955e-05  3.85214504e-05  3.36044144e-05
 -6.88738836e-05 -2.99756046e-05 -1.19107652e-04  7.67265383e-06
  2.43465029e-05 -3.18188500e-06 -2.15525216e-05 -1.82659275e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.813341490179       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.4546073         1
[INPUT] 0    0    [1    /1   ]  833.268166287        1
[INPUT] 0    0    [1    /1   ]  235.771726537        1
[INPUT] 0    0    [1    /1   ]  76.1431226505        1
[INPUT] 0    0    [1    /1   ]  10.9654632871        1
[INPUT] 0    0    [1    /1   ]  27.8704894907        1
[INPUT] 0    0    [1    /1   ]  0.313342105282       1
[INPUT] 0    0    [1    /1   ]  1.9904565881         1
[INPUT] 0    0    [1    /1   ]  3.5755144184         1
[INPUT] 1    0    [1    /1   ]  3.68655908693        1
[INPUT] 1    0    [1    /1   ]  12.4591500626        1
[INPUT] 1    0    [1    /1   ]  54.778057662         1
[INPUT] 1    0    [1    /1   ]  0.330156879354       1
[INPUT] 1    0    [1    /1   ]  1.14411521069        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8133414901786263, 1.0]], [0, [24413.794127379566, 1.0]], [0, [3661.4546073032043, 1.0]], [0, [833.2681662867344, 1.0]], [0, [235.77172653669868, 1.0]], [0, [76.143122650514, 1.0]], [0, [10.965463287140713, 1.0]], [0, [27.87048949068686, 1.0]], [0, [0.31334210528234546, 1.0]], [0, [1.9904565881022709, 1.0]], [0, [3.5755144184027974, 1.0]], [1, [3.686559086930946, 1.0]], [1, [12.459150062605941, 1.0]], [1, [54.77805766197649, 1.0]], [1, [0.33015687935408855, 1.0]], [1, [1.1441152106903458, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81334149]
bas 1, expnt(s) = [24413.79412738]
bas 2, expnt(s) = [3661.4546073]
bas 3, expnt(s) = [833.26816629]
bas 4, expnt(s) = [235.77172654]
bas 5, expnt(s) = [76.14312265]
bas 6, expnt(s) = [10.96546329]
bas 7, expnt(s) = [27.87048949]
bas 8, expnt(s) = [0.31334211]
bas 9, expnt(s) = [1.99045659]
bas 10, expnt(s) = [3.57551442]
bas 11, expnt(s) = [3.68655909]
bas 12, expnt(s) = [12.45915006]
bas 13, expnt(s) = [54.77805766]
bas 14, expnt(s) = [0.33015688]
bas 15, expnt(s) = [1.14411521]
CPU time:       186.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.13341490e-01 2.16381297e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268166e+02 3.91835353e+02
 2.35771727e+02 1.52014081e+02 7.61431227e+01 6.51235455e+01
 1.09654633e+01 1.52242274e+01 2.78704895e+01 3.06459770e+01
 3.13342105e-01 1.05810579e+00 1.99045659e+00 4.23379238e+00
 3.57551442e+00 6.56929742e+00 3.68655909e+00 1.49025604e+01
 1.24591501e+01 6.82880818e+01 5.47780577e+01 4.34753091e+02
 3.30156879e-01 7.30104174e-01 1.14411521e+00 3.45200640e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487950266682
cond(S) = 1687.3295121429237
E1 = -183.57821769769853  E_coul = 55.078498949697064
init E= -128.499718748001
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944249586015  LUMO = 0.815681306678225
  mo_energy =
[-3.25554147e+01 -1.85291042e+00 -7.73944250e-01 -7.73944250e-01
 -7.73944250e-01  8.15681307e-01  1.11531270e+00  1.11531270e+00
  1.11531270e+00  4.33615495e+00  5.77830770e+00  5.77830770e+00
  5.77830770e+00  1.41622008e+01  2.42284438e+01  2.42284438e+01
  2.42284438e+01  4.59431499e+01  1.19137887e+02  1.19137887e+02
  1.19137887e+02  1.52820809e+02  5.16961994e+02  1.88338430e+03
  8.01157426e+03  4.77773072e+04]
E1 = -182.111289817674  E_coul = 53.58226293483224
cycle= 1 E= -128.529026882842  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461609
diis-c [-0.21308258  1.        ]
  HOMO = -0.879594961571863  LUMO = 0.78816412057551
  mo_energy =
[-3.28739616e+01 -1.96315701e+00 -8.79594962e-01 -8.79594962e-01
 -8.79594962e-01  7.88164121e-01  1.07710604e+00  1.07710604e+00
  1.07710604e+00  4.25871451e+00  5.64936318e+00  5.64936318e+00
  5.64936318e+00  1.40106368e+01  2.39934747e+01  2.39934747e+01
  2.39934747e+01  4.56976595e+01  1.18817061e+02  1.18817061e+02
  1.18817061e+02  1.52508451e+02  5.16605298e+02  1.88299113e+03
  8.01115192e+03  4.77768659e+04]
E1 = -182.84325457454565  E_coul = 54.31172299254087
cycle= 2 E= -128.531531582005  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230549
diis-c [-6.48725295e-04  3.32063056e-01  6.67936944e-01]
  HOMO = -0.845241146235706  LUMO = 0.797116995129552
  mo_energy =
[-3.27689596e+01 -1.92703953e+00 -8.45241146e-01 -8.45241146e-01
 -8.45241146e-01  7.97116995e-01  1.08959731e+00  1.08959731e+00
  1.08959731e+00  4.28371235e+00  5.69129676e+00  5.69129676e+00
  5.69129676e+00  1.40601516e+01  2.40710416e+01  2.40710416e+01
  2.40710416e+01  4.57789236e+01  1.18922090e+02  1.18922090e+02
  1.18922090e+02  1.52611152e+02  5.16718750e+02  1.88310989e+03
  8.01127314e+03  4.77769880e+04]
E1 = -182.59780470720509  E_coul = 54.06542611443563
cycle= 3 E= -128.532378592769  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950683
diis-c [-1.58469653e-07 -2.22467978e-03 -7.10235175e-04  1.00293491e+00]
  HOMO = -0.845478530380841  LUMO = 0.797080181329284
  mo_energy =
[-3.27693774e+01 -1.92721193e+00 -8.45478530e-01 -8.45478530e-01
 -8.45478530e-01  7.97080181e-01  1.08954533e+00  1.08954533e+00
  1.08954533e+00  4.28358380e+00  5.69108960e+00  5.69108960e+00
  5.69108960e+00  1.40599151e+01  2.40707120e+01  2.40707120e+01
  2.40707120e+01  4.57785896e+01  1.18921660e+02  1.18921660e+02
  1.18921660e+02  1.52610735e+02  5.16718230e+02  1.88310926e+03
  8.01127242e+03  4.77769873e+04]
E1 = -182.59831624315896  E_coul = 54.065937628978105
cycle= 4 E= -128.532378614181  delta_E= -2.14e-08  |g|= 6.36e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132256
diis-c [-1.02284271e-09  3.31415664e-04  4.24950436e-04 -2.16048134e-01
  1.21529177e+00]
  HOMO = -0.845510760620751  LUMO = 0.797073433610754
  mo_energy =
[-3.27694297e+01 -1.92723145e+00 -8.45510761e-01 -8.45510761e-01
 -8.45510761e-01  7.97073434e-01  1.08953175e+00  1.08953175e+00
  1.08953175e+00  4.28356248e+00  5.69105400e+00  5.69105400e+00
  5.69105400e+00  1.40598782e+01  2.40706647e+01  2.40706647e+01
  2.40706647e+01  4.57785425e+01  1.18921607e+02  1.18921607e+02
  1.18921607e+02  1.52610682e+02  5.16718170e+02  1.88310919e+03
  8.01127234e+03  4.77769872e+04]
E1 = -182.59841855541978  E_coul = 54.06603994068851
cycle= 5 E= -128.532378614731  delta_E= -5.5e-10  |g|= 6.85e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59841855541978  E_coul = 54.06603994068851
  HOMO = -0.845506979193606  LUMO = 0.797074925034725
  mo_energy =
[-3.27694214e+01 -1.92722696e+00 -8.45506979e-01 -8.45506979e-01
 -8.45506979e-01  7.97074925e-01  1.08953333e+00  1.08953333e+00
  1.08953333e+00  4.28356585e+00  5.69105859e+00  5.69105859e+00
  5.69105859e+00  1.40598836e+01  2.40706718e+01  2.40706718e+01
  2.40706718e+01  4.57785498e+01  1.18921616e+02  1.18921616e+02
  1.18921616e+02  1.52610690e+02  5.16718178e+02  1.88310920e+03
  8.01127235e+03  4.77769872e+04]
E1 = -182.5984004037053  E_coul = 54.06602178897113
Extra cycle  E= -128.532378614734  delta_E= -2.9e-12  |g|= 2.54e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.13341490e-01 2.44137941e+04 3.66145461e+03 8.33268166e+02
 2.35771727e+02 7.61431227e+01 1.09654633e+01 2.78704895e+01
 3.13342105e-01 1.99045659e+00 3.57551442e+00 3.68655909e+00
 1.24591501e+01 5.47780577e+01 3.30156879e-01 1.14411521e+00]
E = -128.53237861473417
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.813341490179       1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.4546073         1
[INPUT] 0    0    [1    /1   ]  833.268166287        1
[INPUT] 0    0    [1    /1   ]  235.771726537        1
[INPUT] 0    0    [1    /1   ]  76.1431226505        1
[INPUT] 0    0    [1    /1   ]  10.9654632871        1
[INPUT] 0    0    [1    /1   ]  27.8704894907        1
[INPUT] 0    0    [1    /1   ]  0.313342105282       1
[INPUT] 0    0    [1    /1   ]  1.9904565881         1
[INPUT] 0    0    [1    /1   ]  3.5755144184         1
[INPUT] 1    0    [1    /1   ]  3.68655908693        1
[INPUT] 1    0    [1    /1   ]  12.4591500626        1
[INPUT] 1    0    [1    /1   ]  54.778057662         1
[INPUT] 1    0    [1    /1   ]  0.330156879354       1
[INPUT] 1    0    [1    /1   ]  1.14411521069        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8133414901786263, 1.0]], [0, [24413.794127379566, 1.0]], [0, [3661.4546073032043, 1.0]], [0, [833.2681662867344, 1.0]], [0, [235.77172653669868, 1.0]], [0, [76.143122650514, 1.0]], [0, [10.965463287140713, 1.0]], [0, [27.87048949068686, 1.0]], [0, [0.31334210528234546, 1.0]], [0, [1.9904565881022709, 1.0]], [0, [3.5755144184027974, 1.0]], [1, [3.686559086930946, 1.0]], [1, [12.459150062605941, 1.0]], [1, [54.77805766197649, 1.0]], [1, [0.33015687935408855, 1.0]], [1, [1.1441152106903458, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81334149]
bas 1, expnt(s) = [24413.79412738]
bas 2, expnt(s) = [3661.4546073]
bas 3, expnt(s) = [833.26816629]
bas 4, expnt(s) = [235.77172654]
bas 5, expnt(s) = [76.14312265]
bas 6, expnt(s) = [10.96546329]
bas 7, expnt(s) = [27.87048949]
bas 8, expnt(s) = [0.31334211]
bas 9, expnt(s) = [1.99045659]
bas 10, expnt(s) = [3.57551442]
bas 11, expnt(s) = [3.68655909]
bas 12, expnt(s) = [12.45915006]
bas 13, expnt(s) = [54.77805766]
bas 14, expnt(s) = [0.33015688]
bas 15, expnt(s) = [1.14411521]
CPU time:       187.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.13341490e-01 2.16381297e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268166e+02 3.91835353e+02
 2.35771727e+02 1.52014081e+02 7.61431227e+01 6.51235455e+01
 1.09654633e+01 1.52242274e+01 2.78704895e+01 3.06459770e+01
 3.13342105e-01 1.05810579e+00 1.99045659e+00 4.23379238e+00
 3.57551442e+00 6.56929742e+00 3.68655909e+00 1.49025604e+01
 1.24591501e+01 6.82880818e+01 5.47780577e+01 4.34753091e+02
 3.30156879e-01 7.30104174e-01 1.14411521e+00 3.45200640e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487950266682
cond(S) = 1687.3295121429237
E1 = -183.57821769769853  E_coul = 55.078498949697064
init E= -128.499718748001
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944249586015  LUMO = 0.815681306678225
  mo_energy =
[-3.25554147e+01 -1.85291042e+00 -7.73944250e-01 -7.73944250e-01
 -7.73944250e-01  8.15681307e-01  1.11531270e+00  1.11531270e+00
  1.11531270e+00  4.33615495e+00  5.77830770e+00  5.77830770e+00
  5.77830770e+00  1.41622008e+01  2.42284438e+01  2.42284438e+01
  2.42284438e+01  4.59431499e+01  1.19137887e+02  1.19137887e+02
  1.19137887e+02  1.52820809e+02  5.16961994e+02  1.88338430e+03
  8.01157426e+03  4.77773072e+04]
E1 = -182.111289817674  E_coul = 53.58226293483224
cycle= 1 E= -128.529026882842  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461609
diis-c [-0.21308258  1.        ]
  HOMO = -0.879594961571863  LUMO = 0.78816412057551
  mo_energy =
[-3.28739616e+01 -1.96315701e+00 -8.79594962e-01 -8.79594962e-01
 -8.79594962e-01  7.88164121e-01  1.07710604e+00  1.07710604e+00
  1.07710604e+00  4.25871451e+00  5.64936318e+00  5.64936318e+00
  5.64936318e+00  1.40106368e+01  2.39934747e+01  2.39934747e+01
  2.39934747e+01  4.56976595e+01  1.18817061e+02  1.18817061e+02
  1.18817061e+02  1.52508451e+02  5.16605298e+02  1.88299113e+03
  8.01115192e+03  4.77768659e+04]
E1 = -182.84325457454565  E_coul = 54.31172299254087
cycle= 2 E= -128.531531582005  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230549
diis-c [-6.48725295e-04  3.32063056e-01  6.67936944e-01]
  HOMO = -0.845241146235706  LUMO = 0.797116995129552
  mo_energy =
[-3.27689596e+01 -1.92703953e+00 -8.45241146e-01 -8.45241146e-01
 -8.45241146e-01  7.97116995e-01  1.08959731e+00  1.08959731e+00
  1.08959731e+00  4.28371235e+00  5.69129676e+00  5.69129676e+00
  5.69129676e+00  1.40601516e+01  2.40710416e+01  2.40710416e+01
  2.40710416e+01  4.57789236e+01  1.18922090e+02  1.18922090e+02
  1.18922090e+02  1.52611152e+02  5.16718750e+02  1.88310989e+03
  8.01127314e+03  4.77769880e+04]
E1 = -182.59780470720509  E_coul = 54.06542611443563
cycle= 3 E= -128.532378592769  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950683
diis-c [-1.58469653e-07 -2.22467978e-03 -7.10235175e-04  1.00293491e+00]
  HOMO = -0.845478530380841  LUMO = 0.797080181329284
  mo_energy =
[-3.27693774e+01 -1.92721193e+00 -8.45478530e-01 -8.45478530e-01
 -8.45478530e-01  7.97080181e-01  1.08954533e+00  1.08954533e+00
  1.08954533e+00  4.28358380e+00  5.69108960e+00  5.69108960e+00
  5.69108960e+00  1.40599151e+01  2.40707120e+01  2.40707120e+01
  2.40707120e+01  4.57785896e+01  1.18921660e+02  1.18921660e+02
  1.18921660e+02  1.52610735e+02  5.16718230e+02  1.88310926e+03
  8.01127242e+03  4.77769873e+04]
E1 = -182.59831624315896  E_coul = 54.065937628978105
cycle= 4 E= -128.532378614181  delta_E= -2.14e-08  |g|= 6.36e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132256
diis-c [-1.02284271e-09  3.31415664e-04  4.24950436e-04 -2.16048134e-01
  1.21529177e+00]
  HOMO = -0.845510760620751  LUMO = 0.797073433610754
  mo_energy =
[-3.27694297e+01 -1.92723145e+00 -8.45510761e-01 -8.45510761e-01
 -8.45510761e-01  7.97073434e-01  1.08953175e+00  1.08953175e+00
  1.08953175e+00  4.28356248e+00  5.69105400e+00  5.69105400e+00
  5.69105400e+00  1.40598782e+01  2.40706647e+01  2.40706647e+01
  2.40706647e+01  4.57785425e+01  1.18921607e+02  1.18921607e+02
  1.18921607e+02  1.52610682e+02  5.16718170e+02  1.88310919e+03
  8.01127234e+03  4.77769872e+04]
E1 = -182.59841855541978  E_coul = 54.06603994068851
cycle= 5 E= -128.532378614731  delta_E= -5.5e-10  |g|= 6.85e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59841855541978  E_coul = 54.06603994068851
  HOMO = -0.845506979193606  LUMO = 0.797074925034725
  mo_energy =
[-3.27694214e+01 -1.92722696e+00 -8.45506979e-01 -8.45506979e-01
 -8.45506979e-01  7.97074925e-01  1.08953333e+00  1.08953333e+00
  1.08953333e+00  4.28356585e+00  5.69105859e+00  5.69105859e+00
  5.69105859e+00  1.40598836e+01  2.40706718e+01  2.40706718e+01
  2.40706718e+01  4.57785498e+01  1.18921616e+02  1.18921616e+02
  1.18921616e+02  1.52610690e+02  5.16718178e+02  1.88310920e+03
  8.01127235e+03  4.77769872e+04]
E1 = -182.5984004037053  E_coul = 54.06602178897113
Extra cycle  E= -128.532378614734  delta_E= -2.9e-12  |g|= 2.54e-06  |ddm|= 2.64e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1687.3295121429237
E1 = -182.5984004037053  E_coul = 54.06602178897113
init E= -128.532378614734
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.84550824711263  LUMO = 0.797074662388953
  mo_energy =
[-3.27694255e+01 -1.92722818e+00 -8.45508247e-01 -8.45508247e-01
 -8.45508247e-01  7.97074662e-01  1.08953289e+00  1.08953289e+00
  1.08953289e+00  4.28356502e+00  5.69105705e+00  5.69105705e+00
  5.69105705e+00  1.40598818e+01  2.40706688e+01  2.40706688e+01
  2.40706688e+01  4.57785467e+01  1.18921612e+02  1.18921612e+02
  1.18921612e+02  1.52610686e+02  5.16718173e+02  1.88310919e+03
  8.01127235e+03  4.77769872e+04]
E1 = -182.59841018362619  E_coul = 54.06603156889157
cycle= 1 E= -128.532378614735  delta_E= -4.55e-13  |g|= 1.34e-06  |ddm|= 9.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59841018362619  E_coul = 54.06603156889157
  HOMO = -0.845507559252663  LUMO = 0.797074853289892
  mo_energy =
[-3.27694234e+01 -1.92722744e+00 -8.45507559e-01 -8.45507559e-01
 -8.45507559e-01  7.97074853e-01  1.08953314e+00  1.08953314e+00
  1.08953314e+00  4.28356553e+00  5.69105789e+00  5.69105789e+00
  5.69105789e+00  1.40598828e+01  2.40706704e+01  2.40706704e+01
  2.40706704e+01  4.57785484e+01  1.18921614e+02  1.18921614e+02
  1.18921614e+02  1.52610688e+02  5.16718175e+02  1.88310919e+03
  8.01127235e+03  4.77769872e+04]
E1 = -182.59840532441004  E_coul = 54.06602670967492
Extra cycle  E= -128.532378614735  delta_E= -4.83e-13  |g|= 6.61e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [8.13341490e-01 2.44137941e+04 3.66145461e+03 8.33268166e+02
 2.35771727e+02 7.61431227e+01 1.09654633e+01 2.78704895e+01
 3.13342105e-01 1.99045659e+00 3.57551442e+00 3.68655909e+00
 1.24591501e+01 5.47780577e+01 3.30156879e-01 1.14411521e+00]
grad_E = [ 1.90314540e-05 -2.39083938e-09  1.24766156e-07 -2.34280608e-06
  2.28181341e-05 -9.16618480e-05  2.96020546e-05  3.59247984e-05
  1.73416061e-05 -1.10470864e-05 -1.17854834e-04  2.09550099e-05
  2.32165221e-05 -3.11996510e-06  4.39514696e-05 -5.52763800e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.81232920796        1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460601        1
[INPUT] 0    0    [1    /1   ]  833.268192652        1
[INPUT] 0    0    [1    /1   ]  235.771411567        1
[INPUT] 0    0    [1    /1   ]  76.1453222452        1
[INPUT] 0    0    [1    /1   ]  10.9592056681        1
[INPUT] 0    0    [1    /1   ]  27.8649551935        1
[INPUT] 0    0    [1    /1   ]  0.313255232076       1
[INPUT] 0    0    [1    /1   ]  1.98462473724        1
[INPUT] 0    0    [1    /1   ]  3.57134228089        1
[INPUT] 1    0    [1    /1   ]  3.68656814799        1
[INPUT] 1    0    [1    /1   ]  12.4589895992        1
[INPUT] 1    0    [1    /1   ]  54.778117584         1
[INPUT] 1    0    [1    /1   ]  0.330173172223       1
[INPUT] 1    0    [1    /1   ]  1.14416268616        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8123292079600289, 1.0]], [0, [24413.794127404235, 1.0]], [0, [3661.454606008944, 1.0]], [0, [833.2681926520855, 1.0]], [0, [235.77141156721518, 1.0]], [0, [76.14532224518216, 1.0]], [0, [10.959205668076526, 1.0]], [0, [27.864955193471, 1.0]], [0, [0.3132552320759219, 1.0]], [0, [1.9846247372363501, 1.0]], [0, [3.571342280889076, 1.0]], [1, [3.6865681479949535, 1.0]], [1, [12.458989599248811, 1.0]], [1, [54.778117584040984, 1.0]], [1, [0.33017317222294773, 1.0]], [1, [1.1441626861562368, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81232921]
bas 1, expnt(s) = [24413.7941274]
bas 2, expnt(s) = [3661.45460601]
bas 3, expnt(s) = [833.26819265]
bas 4, expnt(s) = [235.77141157]
bas 5, expnt(s) = [76.14532225]
bas 6, expnt(s) = [10.95920567]
bas 7, expnt(s) = [27.86495519]
bas 8, expnt(s) = [0.31325523]
bas 9, expnt(s) = [1.98462474]
bas 10, expnt(s) = [3.57134228]
bas 11, expnt(s) = [3.68656815]
bas 12, expnt(s) = [12.4589896]
bas 13, expnt(s) = [54.77811758]
bas 14, expnt(s) = [0.33017317]
bas 15, expnt(s) = [1.14416269]
CPU time:       190.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12329208e-01 2.16179285e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268193e+02 3.91835362e+02
 2.35771412e+02 1.52013928e+02 7.61453222e+01 6.51249565e+01
 1.09592057e+01 1.52177110e+01 2.78649552e+01 3.06414128e+01
 3.13255232e-01 1.05788577e+00 1.98462474e+00 4.22448551e+00
 3.57134228e+00 6.56354747e+00 3.68656815e+00 1.49026062e+01
 1.24589896e+01 6.82869824e+01 5.47781176e+01 4.34753686e+02
 3.30173172e-01 7.30149211e-01 1.14416269e+00 3.45218545e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487602735135
cond(S) = 1680.1315822936997
E1 = -183.57821746446797  E_coul = 55.07849997800584
init E= -128.499717486462
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944123308565  LUMO = 0.814756568658916
  mo_energy =
[-3.25554145e+01 -1.85291044e+00 -7.73944123e-01 -7.73944123e-01
 -7.73944123e-01  8.14756569e-01  1.11537793e+00  1.11537793e+00
  1.11537793e+00  4.32819298e+00  5.77850662e+00  5.77850662e+00
  5.77850662e+00  1.41347050e+01  2.42285130e+01  2.42285130e+01
  2.42285130e+01  4.58872855e+01  1.19137658e+02  1.19137658e+02
  1.19137658e+02  1.52744143e+02  5.16882968e+02  1.88331186e+03
  8.01151018e+03  4.77772540e+04]
E1 = -182.11132184631205  E_coul = 53.58229477531077
cycle= 1 E= -128.529027071001  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461594
diis-c [-0.21306895  1.        ]
  HOMO = -0.879592397311109  LUMO = 0.787281584473493
  mo_energy =
[-3.28739559e+01 -1.96315443e+00 -8.79592397e-01 -8.79592397e-01
 -8.79592397e-01  7.87281584e-01  1.07716996e+00  1.07716996e+00
  1.07716996e+00  4.25088867e+00  5.64956399e+00  5.64956399e+00
  5.64956399e+00  1.39832799e+01  2.39935499e+01  2.39935499e+01
  2.39935499e+01  4.56418361e+01  1.18816837e+02  1.18816837e+02
  1.18816837e+02  1.52431789e+02  5.16526276e+02  1.88291869e+03
  8.01108784e+03  4.77768128e+04]
E1 = -182.8432671930841  E_coul = 54.311735514864964
cycle= 2 E= -128.531531678219  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230539
diis-c [-6.48439448e-04  3.32060896e-01  6.67939104e-01]
  HOMO = -0.845239420966732  LUMO = 0.796220976246198
  mo_energy =
[-3.27689562e+01 -1.92703786e+00 -8.45239421e-01 -8.45239421e-01
 -8.45239421e-01  7.96220976e-01  1.08966162e+00  1.08966162e+00
  1.08966162e+00  4.27584221e+00  5.69149690e+00  5.69149690e+00
  5.69149690e+00  1.40327483e+01  2.40711146e+01  2.40711146e+01
  2.40711146e+01  4.57230863e+01  1.18921864e+02  1.18921864e+02
  1.18921864e+02  1.52534488e+02  5.16639725e+02  1.88303745e+03
  8.01120906e+03  4.77769349e+04]
E1 = -182.59782414979304  E_coul = 54.06544550514572
cycle= 3 E= -128.532378644647  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950973
diis-c [-1.58535617e-07 -2.22481880e-03 -7.09155114e-04  1.00293397e+00]
  HOMO = -0.845476868702887  LUMO = 0.796184192456804
  mo_energy =
[-3.27693742e+01 -1.92721033e+00 -8.45476869e-01 -8.45476869e-01
 -8.45476869e-01  7.96184192e-01  1.08960960e+00  1.08960960e+00
  1.08960960e+00  4.27571381e+00  5.69128966e+00  5.69128966e+00
  5.69128966e+00  1.40325119e+01  2.40707849e+01  2.40707849e+01
  2.40707849e+01  4.57227523e+01  1.18921434e+02  1.18921434e+02
  1.18921434e+02  1.52534071e+02  5.16639206e+02  1.88303681e+03
  8.01120834e+03  4.77769342e+04]
E1 = -182.5983359917963  E_coul = 54.065957325724604
cycle= 4 E= -128.532378666072  delta_E= -2.14e-08  |g|= 6.36e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132251
diis-c [-1.02245106e-09  3.31396724e-04  4.24637746e-04 -2.16029943e-01
  1.21527391e+00]
  HOMO = -0.845509100715609  LUMO = 0.796177452518863
  mo_energy =
[-3.27694264e+01 -1.92722985e+00 -8.45509101e-01 -8.45509101e-01
 -8.45509101e-01  7.96177453e-01  1.08959601e+00  1.08959601e+00
  1.08959601e+00  4.27569252e+00  5.69125406e+00  5.69125406e+00
  5.69125406e+00  1.40324749e+01  2.40707376e+01  2.40707376e+01
  2.40707376e+01  4.57227051e+01  1.18921381e+02  1.18921381e+02
  1.18921381e+02  1.52534018e+02  5.16639145e+02  1.88303675e+03
  8.01120826e+03  4.77769341e+04]
E1 = -182.5984382790083  E_coul = 54.06605961238584
cycle= 5 E= -128.532378666622  delta_E= -5.51e-10  |g|= 6.84e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5984382790083  E_coul = 54.06605961238584
  HOMO = -0.845505320548208  LUMO = 0.796178941652476
  mo_energy =
[-3.27694182e+01 -1.92722537e+00 -8.45505321e-01 -8.45505321e-01
 -8.45505321e-01  7.96178942e-01  1.08959759e+00  1.08959759e+00
  1.08959759e+00  4.27569589e+00  5.69125865e+00  5.69125865e+00
  5.69125865e+00  1.40324804e+01  2.40707447e+01  2.40707447e+01
  2.40707447e+01  4.57227125e+01  1.18921389e+02  1.18921389e+02
  1.18921389e+02  1.52534026e+02  5.16639153e+02  1.88303675e+03
  8.01120827e+03  4.77769341e+04]
E1 = -182.59842013361353  E_coul = 54.06604146698798
Extra cycle  E= -128.532378666626  delta_E= -3.13e-12  |g|= 2.54e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.12329208e-01 2.44137941e+04 3.66145461e+03 8.33268193e+02
 2.35771412e+02 7.61453222e+01 1.09592057e+01 2.78649552e+01
 3.13255232e-01 1.98462474e+00 3.57134228e+00 3.68656815e+00
 1.24589896e+01 5.47781176e+01 3.30173172e-01 1.14416269e+00]
E = -128.53237866662556
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.81232920796        1
[INPUT] 0    0    [1    /1   ]  24413.7941274        1
[INPUT] 0    0    [1    /1   ]  3661.45460601        1
[INPUT] 0    0    [1    /1   ]  833.268192652        1
[INPUT] 0    0    [1    /1   ]  235.771411567        1
[INPUT] 0    0    [1    /1   ]  76.1453222452        1
[INPUT] 0    0    [1    /1   ]  10.9592056681        1
[INPUT] 0    0    [1    /1   ]  27.8649551935        1
[INPUT] 0    0    [1    /1   ]  0.313255232076       1
[INPUT] 0    0    [1    /1   ]  1.98462473724        1
[INPUT] 0    0    [1    /1   ]  3.57134228089        1
[INPUT] 1    0    [1    /1   ]  3.68656814799        1
[INPUT] 1    0    [1    /1   ]  12.4589895992        1
[INPUT] 1    0    [1    /1   ]  54.778117584         1
[INPUT] 1    0    [1    /1   ]  0.330173172223       1
[INPUT] 1    0    [1    /1   ]  1.14416268616        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8123292079600289, 1.0]], [0, [24413.794127404235, 1.0]], [0, [3661.454606008944, 1.0]], [0, [833.2681926520855, 1.0]], [0, [235.77141156721518, 1.0]], [0, [76.14532224518216, 1.0]], [0, [10.959205668076526, 1.0]], [0, [27.864955193471, 1.0]], [0, [0.3132552320759219, 1.0]], [0, [1.9846247372363501, 1.0]], [0, [3.571342280889076, 1.0]], [1, [3.6865681479949535, 1.0]], [1, [12.458989599248811, 1.0]], [1, [54.778117584040984, 1.0]], [1, [0.33017317222294773, 1.0]], [1, [1.1441626861562368, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81232921]
bas 1, expnt(s) = [24413.7941274]
bas 2, expnt(s) = [3661.45460601]
bas 3, expnt(s) = [833.26819265]
bas 4, expnt(s) = [235.77141157]
bas 5, expnt(s) = [76.14532225]
bas 6, expnt(s) = [10.95920567]
bas 7, expnt(s) = [27.86495519]
bas 8, expnt(s) = [0.31325523]
bas 9, expnt(s) = [1.98462474]
bas 10, expnt(s) = [3.57134228]
bas 11, expnt(s) = [3.68656815]
bas 12, expnt(s) = [12.4589896]
bas 13, expnt(s) = [54.77811758]
bas 14, expnt(s) = [0.33017317]
bas 15, expnt(s) = [1.14416269]
CPU time:       191.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12329208e-01 2.16179285e+00 2.44137941e+04 4.93448102e+03
 3.66145461e+03 1.18920100e+03 8.33268193e+02 3.91835362e+02
 2.35771412e+02 1.52013928e+02 7.61453222e+01 6.51249565e+01
 1.09592057e+01 1.52177110e+01 2.78649552e+01 3.06414128e+01
 3.13255232e-01 1.05788577e+00 1.98462474e+00 4.22448551e+00
 3.57134228e+00 6.56354747e+00 3.68656815e+00 1.49026062e+01
 1.24589896e+01 6.82869824e+01 5.47781176e+01 4.34753686e+02
 3.30173172e-01 7.30149211e-01 1.14416269e+00 3.45218545e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998487602735135
cond(S) = 1680.1315822936997
E1 = -183.57821746446797  E_coul = 55.07849997800584
init E= -128.499717486462
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944123308565  LUMO = 0.814756568658916
  mo_energy =
[-3.25554145e+01 -1.85291044e+00 -7.73944123e-01 -7.73944123e-01
 -7.73944123e-01  8.14756569e-01  1.11537793e+00  1.11537793e+00
  1.11537793e+00  4.32819298e+00  5.77850662e+00  5.77850662e+00
  5.77850662e+00  1.41347050e+01  2.42285130e+01  2.42285130e+01
  2.42285130e+01  4.58872855e+01  1.19137658e+02  1.19137658e+02
  1.19137658e+02  1.52744143e+02  5.16882968e+02  1.88331186e+03
  8.01151018e+03  4.77772540e+04]
E1 = -182.11132184631205  E_coul = 53.58229477531077
cycle= 1 E= -128.529027071001  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461594
diis-c [-0.21306895  1.        ]
  HOMO = -0.879592397311109  LUMO = 0.787281584473493
  mo_energy =
[-3.28739559e+01 -1.96315443e+00 -8.79592397e-01 -8.79592397e-01
 -8.79592397e-01  7.87281584e-01  1.07716996e+00  1.07716996e+00
  1.07716996e+00  4.25088867e+00  5.64956399e+00  5.64956399e+00
  5.64956399e+00  1.39832799e+01  2.39935499e+01  2.39935499e+01
  2.39935499e+01  4.56418361e+01  1.18816837e+02  1.18816837e+02
  1.18816837e+02  1.52431789e+02  5.16526276e+02  1.88291869e+03
  8.01108784e+03  4.77768128e+04]
E1 = -182.8432671930841  E_coul = 54.311735514864964
cycle= 2 E= -128.531531678219  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230539
diis-c [-6.48439448e-04  3.32060896e-01  6.67939104e-01]
  HOMO = -0.845239420966732  LUMO = 0.796220976246198
  mo_energy =
[-3.27689562e+01 -1.92703786e+00 -8.45239421e-01 -8.45239421e-01
 -8.45239421e-01  7.96220976e-01  1.08966162e+00  1.08966162e+00
  1.08966162e+00  4.27584221e+00  5.69149690e+00  5.69149690e+00
  5.69149690e+00  1.40327483e+01  2.40711146e+01  2.40711146e+01
  2.40711146e+01  4.57230863e+01  1.18921864e+02  1.18921864e+02
  1.18921864e+02  1.52534488e+02  5.16639725e+02  1.88303745e+03
  8.01120906e+03  4.77769349e+04]
E1 = -182.59782414979304  E_coul = 54.06544550514572
cycle= 3 E= -128.532378644647  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950973
diis-c [-1.58535617e-07 -2.22481880e-03 -7.09155114e-04  1.00293397e+00]
  HOMO = -0.845476868702887  LUMO = 0.796184192456804
  mo_energy =
[-3.27693742e+01 -1.92721033e+00 -8.45476869e-01 -8.45476869e-01
 -8.45476869e-01  7.96184192e-01  1.08960960e+00  1.08960960e+00
  1.08960960e+00  4.27571381e+00  5.69128966e+00  5.69128966e+00
  5.69128966e+00  1.40325119e+01  2.40707849e+01  2.40707849e+01
  2.40707849e+01  4.57227523e+01  1.18921434e+02  1.18921434e+02
  1.18921434e+02  1.52534071e+02  5.16639206e+02  1.88303681e+03
  8.01120834e+03  4.77769342e+04]
E1 = -182.5983359917963  E_coul = 54.065957325724604
cycle= 4 E= -128.532378666072  delta_E= -2.14e-08  |g|= 6.36e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132251
diis-c [-1.02245106e-09  3.31396724e-04  4.24637746e-04 -2.16029943e-01
  1.21527391e+00]
  HOMO = -0.845509100715609  LUMO = 0.796177452518863
  mo_energy =
[-3.27694264e+01 -1.92722985e+00 -8.45509101e-01 -8.45509101e-01
 -8.45509101e-01  7.96177453e-01  1.08959601e+00  1.08959601e+00
  1.08959601e+00  4.27569252e+00  5.69125406e+00  5.69125406e+00
  5.69125406e+00  1.40324749e+01  2.40707376e+01  2.40707376e+01
  2.40707376e+01  4.57227051e+01  1.18921381e+02  1.18921381e+02
  1.18921381e+02  1.52534018e+02  5.16639145e+02  1.88303675e+03
  8.01120826e+03  4.77769341e+04]
E1 = -182.5984382790083  E_coul = 54.06605961238584
cycle= 5 E= -128.532378666622  delta_E= -5.51e-10  |g|= 6.84e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5984382790083  E_coul = 54.06605961238584
  HOMO = -0.845505320548208  LUMO = 0.796178941652476
  mo_energy =
[-3.27694182e+01 -1.92722537e+00 -8.45505321e-01 -8.45505321e-01
 -8.45505321e-01  7.96178942e-01  1.08959759e+00  1.08959759e+00
  1.08959759e+00  4.27569589e+00  5.69125865e+00  5.69125865e+00
  5.69125865e+00  1.40324804e+01  2.40707447e+01  2.40707447e+01
  2.40707447e+01  4.57227125e+01  1.18921389e+02  1.18921389e+02
  1.18921389e+02  1.52534026e+02  5.16639153e+02  1.88303675e+03
  8.01120827e+03  4.77769341e+04]
E1 = -182.59842013361353  E_coul = 54.06604146698798
Extra cycle  E= -128.532378666626  delta_E= -3.13e-12  |g|= 2.54e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1680.1315822936997
E1 = -182.59842013361353  E_coul = 54.06604146698798
init E= -128.532378666626
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.84550658804034  LUMO = 0.79617867955139
  mo_energy =
[-3.27694222e+01 -1.92722659e+00 -8.45506588e-01 -8.45506588e-01
 -8.45506588e-01  7.96178680e-01  1.08959715e+00  1.08959715e+00
  1.08959715e+00  4.27569506e+00  5.69125710e+00  5.69125710e+00
  5.69125710e+00  1.40324786e+01  2.40707417e+01  2.40707417e+01
  2.40707417e+01  4.57227094e+01  1.18921385e+02  1.18921385e+02
  1.18921385e+02  1.52534022e+02  5.16639149e+02  1.88303675e+03
  8.01120826e+03  4.77769341e+04]
E1 = -182.59842991019963  E_coul = 54.06605124357381
cycle= 1 E= -128.532378666626  delta_E= -2.56e-13  |g|= 1.34e-06  |ddm|= 9.72e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59842991019963  E_coul = 54.06605124357381
  HOMO = -0.845505900418809  LUMO = 0.796178870115326
  mo_energy =
[-3.27694202e+01 -1.92722584e+00 -8.45505900e-01 -8.45505900e-01
 -8.45505900e-01  7.96178870e-01  1.08959740e+00  1.08959740e+00
  1.08959740e+00  4.27569557e+00  5.69125795e+00  5.69125795e+00
  5.69125795e+00  1.40324796e+01  2.40707433e+01  2.40707433e+01
  2.40707433e+01  4.57227110e+01  1.18921387e+02  1.18921387e+02
  1.18921387e+02  1.52534024e+02  5.16639151e+02  1.88303675e+03
  8.01120827e+03  4.77769341e+04]
E1 = -182.59842505269302  E_coul = 54.0660463860672
Extra cycle  E= -128.532378666626  delta_E=    0  |g|= 6.61e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [8.12329208e-01 2.44137941e+04 3.66145461e+03 8.33268193e+02
 2.35771412e+02 7.61453222e+01 1.09592057e+01 2.78649552e+01
 3.13255232e-01 1.98462474e+00 3.57134228e+00 3.68656815e+00
 1.24589896e+01 5.47781176e+01 3.30173172e-01 1.14416269e+00]
grad_E = [ 2.77704470e-05 -2.37418692e-09  1.23892653e-07 -2.32650278e-06
  2.26561235e-05 -9.10078313e-05  2.94096860e-05  3.54091903e-05
  2.10768984e-05 -1.53014284e-05 -1.17972768e-04  1.46269293e-05
  2.31789149e-05 -3.07581436e-06  4.27659829e-05 -3.33427111e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.81104250021        1
[INPUT] 0    0    [1    /1   ]  24413.7941275        1
[INPUT] 0    0    [1    /1   ]  3661.45460321        1
[INPUT] 0    0    [1    /1   ]  833.268248873        1
[INPUT] 0    0    [1    /1   ]  235.770761807        1
[INPUT] 0    0    [1    /1   ]  76.1495835789        1
[INPUT] 0    0    [1    /1   ]  10.9486738416        1
[INPUT] 0    0    [1    /1   ]  27.8549139541        1
[INPUT] 0    0    [1    /1   ]  0.313340708635       1
[INPUT] 0    0    [1    /1   ]  1.9755119655         1
[INPUT] 0    0    [1    /1   ]  3.56464294257        1
[INPUT] 1    0    [1    /1   ]  3.68650212465        1
[INPUT] 1    0    [1    /1   ]  12.4586084705        1
[INPUT] 1    0    [1    /1   ]  54.7782360873        1
[INPUT] 1    0    [1    /1   ]  0.330203014999       1
[INPUT] 1    0    [1    /1   ]  1.14422701012        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8110425002098304, 1.0]], [0, [24413.79412745769, 1.0]], [0, [3661.45460320742, 1.0]], [0, [833.2682488728487, 1.0]], [0, [235.7707618070667, 1.0]], [0, [76.14958357889716, 1.0]], [0, [10.948673841610162, 1.0]], [0, [27.85491395405241, 1.0]], [0, [0.3133407086345367, 1.0]], [0, [1.9755119654976927, 1.0]], [0, [3.5646429425686024, 1.0]], [1, [3.6865021246531313, 1.0]], [1, [12.458608470522723, 1.0]], [1, [54.77823608729999, 1.0]], [1, [0.33020301499869076, 1.0]], [1, [1.1442270101185077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8110425]
bas 1, expnt(s) = [24413.79412746]
bas 2, expnt(s) = [3661.45460321]
bas 3, expnt(s) = [833.26824887]
bas 4, expnt(s) = [235.77076181]
bas 5, expnt(s) = [76.14958358]
bas 6, expnt(s) = [10.94867384]
bas 7, expnt(s) = [27.85491395]
bas 8, expnt(s) = [0.31334071]
bas 9, expnt(s) = [1.97551197]
bas 10, expnt(s) = [3.56464294]
bas 11, expnt(s) = [3.68650212]
bas 12, expnt(s) = [12.45860847]
bas 13, expnt(s) = [54.77823609]
bas 14, expnt(s) = [0.33020301]
bas 15, expnt(s) = [1.14422701]
CPU time:       194.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.11042500e-01 2.15922417e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268249e+02 3.91835382e+02
 2.35770762e+02 1.52013614e+02 7.61495836e+01 6.51276899e+01
 1.09486738e+01 1.52067415e+01 2.78549140e+01 3.06331311e+01
 3.13340709e-01 1.05810226e+00 1.97551197e+00 4.20992901e+00
 3.56464294e+00 6.55431108e+00 3.68650212e+00 1.49022726e+01
 1.24586085e+01 6.82843712e+01 5.47782361e+01 4.34754861e+02
 3.30203015e-01 7.30231706e-01 1.14422701e+00 3.45242805e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486993833726
cond(S) = 1670.839972162653
E1 = -183.57821685214242  E_coul = 55.07850185841723
init E= -128.499714993725
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943884449633  LUMO = 0.81389213095595
  mo_energy =
[-3.25554142e+01 -1.85291037e+00 -7.73943884e-01 -7.73943884e-01
 -7.73943884e-01  8.13892131e-01  1.11549031e+00  1.11549031e+00
  1.11549031e+00  4.31732337e+00  5.77875520e+00  5.77875520e+00
  5.77875520e+00  1.40934657e+01  2.42282313e+01  2.42282313e+01
  2.42282313e+01  4.57996780e+01  1.19136671e+02  1.19136671e+02
  1.19136671e+02  1.52620529e+02  5.16754798e+02  1.88319441e+03
  8.01140627e+03  4.77771679e+04]
E1 = -182.11139725750164  E_coul = 53.58236974378396
cycle= 1 E= -128.529027513718  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461563
diis-c [-0.2130402  1.       ]
  HOMO = -0.879586116429521  LUMO = 0.786467016897991
  mo_energy =
[-3.28739433e+01 -1.96314834e+00 -8.79586116e-01 -8.79586116e-01
 -8.79586116e-01  7.86467017e-01  1.07728139e+00  1.07728139e+00
  1.07728139e+00  4.24022767e+00  5.64981974e+00  5.64981974e+00
  5.64981974e+00  1.39422658e+01  2.39932820e+01  2.39932820e+01
  2.39932820e+01  4.55543021e+01  1.18815862e+02  1.18815862e+02
  1.18815862e+02  1.52308187e+02  5.16398114e+02  1.88280125e+03
  8.01098395e+03  4.77767267e+04]
E1 = -182.84330112330008  E_coul = 54.3117692017132
cycle= 2 E= -128.531531921587  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230518
diis-c [-6.47972695e-04  3.32056398e-01  6.67943602e-01]
  HOMO = -0.845234925771005  LUMO = 0.795390614584488
  mo_energy =
[-3.27689486e+01 -1.92703369e+00 -8.45234926e-01 -8.45234926e-01
 -8.45234926e-01  7.95390615e-01  1.08977346e+00  1.08977346e+00
  1.08977346e+00  4.26511359e+00  5.69175043e+00  5.69175043e+00
  5.69175043e+00  1.39916591e+01  2.40708419e+01  2.40708419e+01
  2.40708419e+01  4.56355276e+01  1.18920884e+02  1.18920884e+02
  1.18920884e+02  1.52410882e+02  5.16511560e+02  1.88292001e+03
  8.01110516e+03  4.77768488e+04]
E1 = -182.59787384229637  E_coul = 54.0654950531645
cycle= 3 E= -128.532378789132  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951256
diis-c [-1.58427895e-07 -2.22449226e-03 -7.06592643e-04  1.00293108e+00]
  HOMO = -0.84547241016381  LUMO = 0.79535387167481
  mo_energy =
[-3.27693667e+01 -1.92720624e+00 -8.45472410e-01 -8.45472410e-01
 -8.45472410e-01  7.95353872e-01  1.08972141e+00  1.08972141e+00
  1.08972141e+00  4.26498547e+00  5.69154313e+00  5.69154313e+00
  5.69154313e+00  1.39914229e+01  2.40705121e+01  2.40705121e+01
  2.40705121e+01  4.56351935e+01  1.18920454e+02  1.18920454e+02
  1.18920454e+02  1.52410465e+02  5.16511040e+02  1.88291937e+03
  8.01110444e+03  4.77768480e+04]
E1 = -182.5983861933934  E_coul = 54.06600738283848
cycle= 4 E= -128.532378810555  delta_E= -2.14e-08  |g|= 6.36e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132198
diis-c [-1.02109828e-09  3.31262712e-04  4.24081629e-04 -2.15956900e-01
  1.21520156e+00]
  HOMO = -0.845504632383012  LUMO = 0.795347141838723
  mo_energy =
[-3.27694190e+01 -1.92722577e+00 -8.45504632e-01 -8.45504632e-01
 -8.45504632e-01  7.95347142e-01  1.08970782e+00  1.08970782e+00
  1.08970782e+00  4.26496423e+00  5.69150754e+00  5.69150754e+00
  5.69150754e+00  1.39913861e+01  2.40704648e+01  2.40704648e+01
  2.40704648e+01  4.56351464e+01  1.18920401e+02  1.18920401e+02
  1.18920401e+02  1.52410412e+02  5.16510980e+02  1.88291930e+03
  8.01110437e+03  4.77768480e+04]
E1 = -182.5984884365469  E_coul = 54.06610962544165
cycle= 5 E= -128.532378811105  delta_E= -5.5e-10  |g|= 6.84e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5984884365469  E_coul = 54.06610962544165
  HOMO = -0.845500856052786  LUMO = 0.795348627456892
  mo_energy =
[-3.27694107e+01 -1.92722128e+00 -8.45500856e-01 -8.45500856e-01
 -8.45500856e-01  7.95348627e-01  1.08970941e+00  1.08970941e+00
  1.08970941e+00  4.26496759e+00  5.69151213e+00  5.69151213e+00
  5.69151213e+00  1.39913915e+01  2.40704719e+01  2.40704719e+01
  2.40704719e+01  4.56351537e+01  1.18920409e+02  1.18920409e+02
  1.18920409e+02  1.52410420e+02  5.16510988e+02  1.88291931e+03
  8.01110438e+03  4.77768480e+04]
E1 = -182.59847030789103  E_coul = 54.06609149678279
Extra cycle  E= -128.532378811108  delta_E= -2.98e-12  |g|= 2.53e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [8.11042500e-01 2.44137941e+04 3.66145460e+03 8.33268249e+02
 2.35770762e+02 7.61495836e+01 1.09486738e+01 2.78549140e+01
 3.13340709e-01 1.97551197e+00 3.56464294e+00 3.68650212e+00
 1.24586085e+01 5.47782361e+01 3.30203015e-01 1.14422701e+00]
E = -128.53237881110823
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.81104250021        1
[INPUT] 0    0    [1    /1   ]  24413.7941275        1
[INPUT] 0    0    [1    /1   ]  3661.45460321        1
[INPUT] 0    0    [1    /1   ]  833.268248873        1
[INPUT] 0    0    [1    /1   ]  235.770761807        1
[INPUT] 0    0    [1    /1   ]  76.1495835789        1
[INPUT] 0    0    [1    /1   ]  10.9486738416        1
[INPUT] 0    0    [1    /1   ]  27.8549139541        1
[INPUT] 0    0    [1    /1   ]  0.313340708635       1
[INPUT] 0    0    [1    /1   ]  1.9755119655         1
[INPUT] 0    0    [1    /1   ]  3.56464294257        1
[INPUT] 1    0    [1    /1   ]  3.68650212465        1
[INPUT] 1    0    [1    /1   ]  12.4586084705        1
[INPUT] 1    0    [1    /1   ]  54.7782360873        1
[INPUT] 1    0    [1    /1   ]  0.330203014999       1
[INPUT] 1    0    [1    /1   ]  1.14422701012        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8110425002098304, 1.0]], [0, [24413.79412745769, 1.0]], [0, [3661.45460320742, 1.0]], [0, [833.2682488728487, 1.0]], [0, [235.7707618070667, 1.0]], [0, [76.14958357889716, 1.0]], [0, [10.948673841610162, 1.0]], [0, [27.85491395405241, 1.0]], [0, [0.3133407086345367, 1.0]], [0, [1.9755119654976927, 1.0]], [0, [3.5646429425686024, 1.0]], [1, [3.6865021246531313, 1.0]], [1, [12.458608470522723, 1.0]], [1, [54.77823608729999, 1.0]], [1, [0.33020301499869076, 1.0]], [1, [1.1442270101185077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8110425]
bas 1, expnt(s) = [24413.79412746]
bas 2, expnt(s) = [3661.45460321]
bas 3, expnt(s) = [833.26824887]
bas 4, expnt(s) = [235.77076181]
bas 5, expnt(s) = [76.14958358]
bas 6, expnt(s) = [10.94867384]
bas 7, expnt(s) = [27.85491395]
bas 8, expnt(s) = [0.31334071]
bas 9, expnt(s) = [1.97551197]
bas 10, expnt(s) = [3.56464294]
bas 11, expnt(s) = [3.68650212]
bas 12, expnt(s) = [12.45860847]
bas 13, expnt(s) = [54.77823609]
bas 14, expnt(s) = [0.33020301]
bas 15, expnt(s) = [1.14422701]
CPU time:       195.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.11042500e-01 2.15922417e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268249e+02 3.91835382e+02
 2.35770762e+02 1.52013614e+02 7.61495836e+01 6.51276899e+01
 1.09486738e+01 1.52067415e+01 2.78549140e+01 3.06331311e+01
 3.13340709e-01 1.05810226e+00 1.97551197e+00 4.20992901e+00
 3.56464294e+00 6.55431108e+00 3.68650212e+00 1.49022726e+01
 1.24586085e+01 6.82843712e+01 5.47782361e+01 4.34754861e+02
 3.30203015e-01 7.30231706e-01 1.14422701e+00 3.45242805e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486993833726
cond(S) = 1670.839972162653
E1 = -183.57821685214242  E_coul = 55.07850185841723
init E= -128.499714993725
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943884449633  LUMO = 0.81389213095595
  mo_energy =
[-3.25554142e+01 -1.85291037e+00 -7.73943884e-01 -7.73943884e-01
 -7.73943884e-01  8.13892131e-01  1.11549031e+00  1.11549031e+00
  1.11549031e+00  4.31732337e+00  5.77875520e+00  5.77875520e+00
  5.77875520e+00  1.40934657e+01  2.42282313e+01  2.42282313e+01
  2.42282313e+01  4.57996780e+01  1.19136671e+02  1.19136671e+02
  1.19136671e+02  1.52620529e+02  5.16754798e+02  1.88319441e+03
  8.01140627e+03  4.77771679e+04]
E1 = -182.11139725750164  E_coul = 53.58236974378396
cycle= 1 E= -128.529027513718  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461563
diis-c [-0.2130402  1.       ]
  HOMO = -0.879586116429521  LUMO = 0.786467016897991
  mo_energy =
[-3.28739433e+01 -1.96314834e+00 -8.79586116e-01 -8.79586116e-01
 -8.79586116e-01  7.86467017e-01  1.07728139e+00  1.07728139e+00
  1.07728139e+00  4.24022767e+00  5.64981974e+00  5.64981974e+00
  5.64981974e+00  1.39422658e+01  2.39932820e+01  2.39932820e+01
  2.39932820e+01  4.55543021e+01  1.18815862e+02  1.18815862e+02
  1.18815862e+02  1.52308187e+02  5.16398114e+02  1.88280125e+03
  8.01098395e+03  4.77767267e+04]
E1 = -182.84330112330008  E_coul = 54.3117692017132
cycle= 2 E= -128.531531921587  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230518
diis-c [-6.47972695e-04  3.32056398e-01  6.67943602e-01]
  HOMO = -0.845234925771005  LUMO = 0.795390614584488
  mo_energy =
[-3.27689486e+01 -1.92703369e+00 -8.45234926e-01 -8.45234926e-01
 -8.45234926e-01  7.95390615e-01  1.08977346e+00  1.08977346e+00
  1.08977346e+00  4.26511359e+00  5.69175043e+00  5.69175043e+00
  5.69175043e+00  1.39916591e+01  2.40708419e+01  2.40708419e+01
  2.40708419e+01  4.56355276e+01  1.18920884e+02  1.18920884e+02
  1.18920884e+02  1.52410882e+02  5.16511560e+02  1.88292001e+03
  8.01110516e+03  4.77768488e+04]
E1 = -182.59787384229637  E_coul = 54.0654950531645
cycle= 3 E= -128.532378789132  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951256
diis-c [-1.58427895e-07 -2.22449226e-03 -7.06592643e-04  1.00293108e+00]
  HOMO = -0.84547241016381  LUMO = 0.79535387167481
  mo_energy =
[-3.27693667e+01 -1.92720624e+00 -8.45472410e-01 -8.45472410e-01
 -8.45472410e-01  7.95353872e-01  1.08972141e+00  1.08972141e+00
  1.08972141e+00  4.26498547e+00  5.69154313e+00  5.69154313e+00
  5.69154313e+00  1.39914229e+01  2.40705121e+01  2.40705121e+01
  2.40705121e+01  4.56351935e+01  1.18920454e+02  1.18920454e+02
  1.18920454e+02  1.52410465e+02  5.16511040e+02  1.88291937e+03
  8.01110444e+03  4.77768480e+04]
E1 = -182.5983861933934  E_coul = 54.06600738283848
cycle= 4 E= -128.532378810555  delta_E= -2.14e-08  |g|= 6.36e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132198
diis-c [-1.02109828e-09  3.31262712e-04  4.24081629e-04 -2.15956900e-01
  1.21520156e+00]
  HOMO = -0.845504632383012  LUMO = 0.795347141838723
  mo_energy =
[-3.27694190e+01 -1.92722577e+00 -8.45504632e-01 -8.45504632e-01
 -8.45504632e-01  7.95347142e-01  1.08970782e+00  1.08970782e+00
  1.08970782e+00  4.26496423e+00  5.69150754e+00  5.69150754e+00
  5.69150754e+00  1.39913861e+01  2.40704648e+01  2.40704648e+01
  2.40704648e+01  4.56351464e+01  1.18920401e+02  1.18920401e+02
  1.18920401e+02  1.52410412e+02  5.16510980e+02  1.88291930e+03
  8.01110437e+03  4.77768480e+04]
E1 = -182.5984884365469  E_coul = 54.06610962544165
cycle= 5 E= -128.532378811105  delta_E= -5.5e-10  |g|= 6.84e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5984884365469  E_coul = 54.06610962544165
  HOMO = -0.845500856052786  LUMO = 0.795348627456892
  mo_energy =
[-3.27694107e+01 -1.92722128e+00 -8.45500856e-01 -8.45500856e-01
 -8.45500856e-01  7.95348627e-01  1.08970941e+00  1.08970941e+00
  1.08970941e+00  4.26496759e+00  5.69151213e+00  5.69151213e+00
  5.69151213e+00  1.39913915e+01  2.40704719e+01  2.40704719e+01
  2.40704719e+01  4.56351537e+01  1.18920409e+02  1.18920409e+02
  1.18920409e+02  1.52410420e+02  5.16510988e+02  1.88291931e+03
  8.01110438e+03  4.77768480e+04]
E1 = -182.59847030789103  E_coul = 54.06609149678279
Extra cycle  E= -128.532378811108  delta_E= -2.98e-12  |g|= 2.53e-06  |ddm|= 2.63e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1670.839972162653
E1 = -182.59847030789103  E_coul = 54.06609149678279
init E= -128.532378811108
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845502122418116  LUMO = 0.795348366127837
  mo_energy =
[-3.27694148e+01 -1.92722250e+00 -8.45502122e-01 -8.45502122e-01
 -8.45502122e-01  7.95348366e-01  1.08970897e+00  1.08970897e+00
  1.08970897e+00  4.26496676e+00  5.69151059e+00  5.69151059e+00
  5.69151059e+00  1.39913897e+01  2.40704689e+01  2.40704689e+01
  2.40704689e+01  4.56351506e+01  1.18920405e+02  1.18920405e+02
  1.18920405e+02  1.52410416e+02  5.16510983e+02  1.88291931e+03
  8.01110437e+03  4.77768480e+04]
E1 = -182.59848007523476  E_coul = 54.066101264126246
cycle= 1 E= -128.532378811109  delta_E= -2.84e-13  |g|= 1.34e-06  |ddm|= 9.71e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59848007523476  E_coul = 54.066101264126246
  HOMO = -0.845501435456835  LUMO = 0.795348556200396
  mo_energy =
[-3.27694127e+01 -1.92722176e+00 -8.45501435e-01 -8.45501435e-01
 -8.45501435e-01  7.95348556e-01  1.08970922e+00  1.08970922e+00
  1.08970922e+00  4.26496727e+00  5.69151143e+00  5.69151143e+00
  5.69151143e+00  1.39913907e+01  2.40704705e+01  2.40704705e+01
  2.40704705e+01  4.56351523e+01  1.18920407e+02  1.18920407e+02
  1.18920407e+02  1.52410418e+02  5.16510986e+02  1.88291931e+03
  8.01110437e+03  4.77768480e+04]
E1 = -182.59847522240207  E_coul = 54.066096411293394
Extra cycle  E= -128.532378811109  delta_E= -1.71e-13  |g|= 6.61e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [8.11042500e-01 2.44137941e+04 3.66145460e+03 8.33268249e+02
 2.35770762e+02 7.61495836e+01 1.09486738e+01 2.78549140e+01
 3.13340709e-01 1.97551197e+00 3.56464294e+00 3.68650212e+00
 1.24586085e+01 5.47782361e+01 3.30203015e-01 1.14422701e+00]
grad_E = [ 3.39612525e-05 -2.34029701e-09  1.22114169e-07 -2.29319242e-06
  2.23206635e-05 -8.95662915e-05  2.96728893e-05  3.37315333e-05
  5.46117684e-05 -2.16642578e-05 -1.18045629e-04  3.53213119e-07
  2.37707508e-05 -3.00885908e-06  6.16612712e-05  2.36471122e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.809446134545       1
[INPUT] 0    0    [1    /1   ]  24413.7941276        1
[INPUT] 0    0    [1    /1   ]  3661.45459835        1
[INPUT] 0    0    [1    /1   ]  833.268344673        1
[INPUT] 0    0    [1    /1   ]  235.769699968        1
[INPUT] 0    0    [1    /1   ]  76.1559335119        1
[INPUT] 0    0    [1    /1   ]  10.9352597399        1
[INPUT] 0    0    [1    /1   ]  27.8418382304        1
[INPUT] 0    0    [1    /1   ]  0.313533562968       1
[INPUT] 0    0    [1    /1   ]  1.96364965814        1
[INPUT] 0    0    [1    /1   ]  3.55752940834        1
[INPUT] 1    0    [1    /1   ]  3.68632122616        1
[INPUT] 1    0    [1    /1   ]  12.4578888291        1
[INPUT] 1    0    [1    /1   ]  54.7784173064        1
[INPUT] 1    0    [1    /1   ]  0.330242122405       1
[INPUT] 1    0    [1    /1   ]  1.14429259361        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8094461345453751, 1.0]], [0, [24413.794127550515, 1.0]], [0, [3661.4545983485286, 1.0]], [0, [833.2683446728151, 1.0]], [0, [235.76969996787153, 1.0]], [0, [76.1559335118944, 1.0]], [0, [10.935259739879925, 1.0]], [0, [27.841838230400125, 1.0]], [0, [0.3135335629676629, 1.0]], [0, [1.9636496581441871, 1.0]], [0, [3.557529408344482, 1.0]], [1, [3.6863212261559153, 1.0]], [1, [12.457888829138136, 1.0]], [1, [54.77841730638484, 1.0]], [1, [0.3302421224051743, 1.0]], [1, [1.144292593606138, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80944613]
bas 1, expnt(s) = [24413.79412755]
bas 2, expnt(s) = [3661.45459835]
bas 3, expnt(s) = [833.26834467]
bas 4, expnt(s) = [235.76969997]
bas 5, expnt(s) = [76.15593351]
bas 6, expnt(s) = [10.93525974]
bas 7, expnt(s) = [27.84183823]
bas 8, expnt(s) = [0.31353356]
bas 9, expnt(s) = [1.96364966]
bas 10, expnt(s) = [3.55752941]
bas 11, expnt(s) = [3.68632123]
bas 12, expnt(s) = [12.45788883]
bas 13, expnt(s) = [54.77841731]
bas 14, expnt(s) = [0.33024212]
bas 15, expnt(s) = [1.14429259]
CPU time:       198.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09446135e-01 2.15603591e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268345e+02 3.91835416e+02
 2.35769700e+02 1.52013101e+02 7.61559335e+01 6.51317630e+01
 1.09352597e+01 1.51927661e+01 2.78418382e+01 3.06223456e+01
 3.13533563e-01 1.05859065e+00 1.96364966e+00 4.19095530e+00
 3.55752941e+00 6.54449889e+00 3.68632123e+00 1.49013585e+01
 1.24578888e+01 6.82794409e+01 5.47784173e+01 4.34756659e+02
 3.30242122e-01 7.30339813e-01 1.14429259e+00 3.45267541e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486227776777
cond(S) = 1657.9716948109258
E1 = -183.57821633240727  E_coul = 55.07850445814591
init E= -128.499711874261
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943550164721  LUMO = 0.812987349937317
  mo_energy =
[-3.25554139e+01 -1.85291021e+00 -7.73943550e-01 -7.73943550e-01
 -7.73943550e-01  8.12987350e-01  1.11563168e+00  1.11563168e+00
  1.11563168e+00  4.30398413e+00  5.77897028e+00  5.77897028e+00
  5.77897028e+00  1.40429508e+01  2.42272934e+01  2.42272934e+01
  2.42272934e+01  4.56924457e+01  1.19134395e+02  1.19134395e+02
  1.19134395e+02  1.52468167e+02  5.16597512e+02  1.88305081e+03
  8.01127930e+03  4.77770627e+04]
E1 = -182.11150534458957  E_coul = 53.58247709137849
cycle= 1 E= -128.529028253211  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461522
diis-c [-0.21300224  1.        ]
  HOMO = -0.879577019617503  LUMO = 0.785620806770659
  mo_energy =
[-3.28739258e+01 -1.96313955e+00 -8.79577020e-01 -8.79577020e-01
 -8.79577020e-01  7.85620807e-01  1.07742243e+00  1.07742243e+00
  1.07742243e+00  4.22715020e+00  5.65004727e+00  5.65004727e+00
  5.65004727e+00  1.38920270e+01  2.39923649e+01  2.39923649e+01
  2.39923649e+01  4.54471625e+01  1.18813603e+02  1.18813603e+02
  1.18813603e+02  1.52155843e+02  5.16240841e+02  1.88265767e+03
  8.01085700e+03  4.77766214e+04]
E1 = -182.84335135584234  E_coul = 54.31181897418812
cycle= 2 E= -128.531532381654  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0685
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230491
diis-c [-6.47394130e-04  3.32050433e-01  6.67949567e-01]
  HOMO = -0.845228329642488  LUMO = 0.794525924822499
  mo_energy =
[-3.27689380e+01 -1.92702758e+00 -8.45228330e-01 -8.45228330e-01
 -8.45228330e-01  7.94525925e-01  1.08991482e+00  1.08991482e+00
  1.08991482e+00  4.25195141e+00  5.69197417e+00  5.69197417e+00
  5.69197417e+00  1.39413285e+01  2.40699176e+01  2.40699176e+01
  2.40699176e+01  4.55283568e+01  1.18918619e+02  1.18918619e+02
  1.18918619e+02  1.52258531e+02  5.16354280e+02  1.88277642e+03
  8.01097820e+03  4.77767436e+04]
E1 = -182.59794654092283  E_coul = 54.065567431113756
cycle= 3 E= -128.532379109809  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951463
diis-c [-1.58197664e-07 -2.22383057e-03 -7.03325597e-04  1.00292716e+00]
  HOMO = -0.845465819248967  LUMO = 0.794489238418623
  mo_energy =
[-3.27693563e+01 -1.92720020e+00 -8.45465819e-01 -8.45465819e-01
 -8.45465819e-01  7.94489238e-01  1.08986275e+00  1.08986275e+00
  1.08986275e+00  4.25182367e+00  5.69176683e+00  5.69176683e+00
  5.69176683e+00  1.39410926e+01  2.40695877e+01  2.40695877e+01
  2.40695877e+01  4.55280226e+01  1.18918188e+02  1.18918188e+02
  1.18918188e+02  1.52258113e+02  5.16353760e+02  1.88277579e+03
  8.01097748e+03  4.77767428e+04]
E1 = -182.5984594510661  E_coul = 54.06608031984548
cycle= 4 E= -128.532379131221  delta_E= -2.14e-08  |g|= 6.36e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132115
diis-c [-1.01912259e-09  3.31045800e-04  4.23424613e-04 -2.15847981e-01
  1.21509351e+00]
  HOMO = -0.845498024153376  LUMO = 0.794482520959188
  mo_energy =
[-3.27694085e+01 -1.92721973e+00 -8.45498024e-01 -8.45498024e-01
 -8.45498024e-01  7.94482521e-01  1.08984917e+00  1.08984917e+00
  1.08984917e+00  4.25180250e+00  5.69173126e+00  5.69173126e+00
  5.69173126e+00  1.39410558e+01  2.40695405e+01  2.40695405e+01
  2.40695405e+01  4.55279756e+01  1.18918135e+02  1.18918135e+02
  1.18918135e+02  1.52258061e+02  5.16353700e+02  1.88277572e+03
  8.01097740e+03  4.77767427e+04]
E1 = -182.59856163719775  E_coul = 54.06618250542768
cycle= 5 E= -128.53237913177  delta_E= -5.49e-10  |g|= 6.83e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59856163719775  E_coul = 54.06618250542768
  HOMO = -0.845494253406738  LUMO = 0.794484002076985
  mo_energy =
[-3.27694003e+01 -1.92721525e+00 -8.45494253e-01 -8.45494253e-01
 -8.45494253e-01  7.94484002e-01  1.08985075e+00  1.08985075e+00
  1.08985075e+00  4.25180585e+00  5.69173584e+00  5.69173584e+00
  5.69173584e+00  1.39410613e+01  2.40695475e+01  2.40695475e+01
  2.40695475e+01  4.55279829e+01  1.18918144e+02  1.18918144e+02
  1.18918144e+02  1.52258069e+02  5.16353708e+02  1.88277573e+03
  8.01097741e+03  4.77767427e+04]
E1 = -182.5985435322033  E_coul = 54.066164400430516
Extra cycle  E= -128.532379131773  delta_E= -2.73e-12  |g|= 2.53e-06  |ddm|= 2.62e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [8.09446135e-01 2.44137941e+04 3.66145460e+03 8.33268345e+02
 2.35769700e+02 7.61559335e+01 1.09352597e+01 2.78418382e+01
 3.13533563e-01 1.96364966e+00 3.55752941e+00 3.68632123e+00
 1.24578888e+01 5.47784173e+01 3.30242122e-01 1.14429259e+00]
E = -128.53237913177279
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.809446134545       1
[INPUT] 0    0    [1    /1   ]  24413.7941276        1
[INPUT] 0    0    [1    /1   ]  3661.45459835        1
[INPUT] 0    0    [1    /1   ]  833.268344673        1
[INPUT] 0    0    [1    /1   ]  235.769699968        1
[INPUT] 0    0    [1    /1   ]  76.1559335119        1
[INPUT] 0    0    [1    /1   ]  10.9352597399        1
[INPUT] 0    0    [1    /1   ]  27.8418382304        1
[INPUT] 0    0    [1    /1   ]  0.313533562968       1
[INPUT] 0    0    [1    /1   ]  1.96364965814        1
[INPUT] 0    0    [1    /1   ]  3.55752940834        1
[INPUT] 1    0    [1    /1   ]  3.68632122616        1
[INPUT] 1    0    [1    /1   ]  12.4578888291        1
[INPUT] 1    0    [1    /1   ]  54.7784173064        1
[INPUT] 1    0    [1    /1   ]  0.330242122405       1
[INPUT] 1    0    [1    /1   ]  1.14429259361        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8094461345453751, 1.0]], [0, [24413.794127550515, 1.0]], [0, [3661.4545983485286, 1.0]], [0, [833.2683446728151, 1.0]], [0, [235.76969996787153, 1.0]], [0, [76.1559335118944, 1.0]], [0, [10.935259739879925, 1.0]], [0, [27.841838230400125, 1.0]], [0, [0.3135335629676629, 1.0]], [0, [1.9636496581441871, 1.0]], [0, [3.557529408344482, 1.0]], [1, [3.6863212261559153, 1.0]], [1, [12.457888829138136, 1.0]], [1, [54.77841730638484, 1.0]], [1, [0.3302421224051743, 1.0]], [1, [1.144292593606138, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80944613]
bas 1, expnt(s) = [24413.79412755]
bas 2, expnt(s) = [3661.45459835]
bas 3, expnt(s) = [833.26834467]
bas 4, expnt(s) = [235.76969997]
bas 5, expnt(s) = [76.15593351]
bas 6, expnt(s) = [10.93525974]
bas 7, expnt(s) = [27.84183823]
bas 8, expnt(s) = [0.31353356]
bas 9, expnt(s) = [1.96364966]
bas 10, expnt(s) = [3.55752941]
bas 11, expnt(s) = [3.68632123]
bas 12, expnt(s) = [12.45788883]
bas 13, expnt(s) = [54.77841731]
bas 14, expnt(s) = [0.33024212]
bas 15, expnt(s) = [1.14429259]
CPU time:       199.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09446135e-01 2.15603591e+00 2.44137941e+04 4.93448102e+03
 3.66145460e+03 1.18920100e+03 8.33268345e+02 3.91835416e+02
 2.35769700e+02 1.52013101e+02 7.61559335e+01 6.51317630e+01
 1.09352597e+01 1.51927661e+01 2.78418382e+01 3.06223456e+01
 3.13533563e-01 1.05859065e+00 1.96364966e+00 4.19095530e+00
 3.55752941e+00 6.54449889e+00 3.68632123e+00 1.49013585e+01
 1.24578888e+01 6.82794409e+01 5.47784173e+01 4.34756659e+02
 3.30242122e-01 7.30339813e-01 1.14429259e+00 3.45267541e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486227776777
cond(S) = 1657.9716948109258
E1 = -183.57821633240727  E_coul = 55.07850445814591
init E= -128.499711874261
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943550164721  LUMO = 0.812987349937317
  mo_energy =
[-3.25554139e+01 -1.85291021e+00 -7.73943550e-01 -7.73943550e-01
 -7.73943550e-01  8.12987350e-01  1.11563168e+00  1.11563168e+00
  1.11563168e+00  4.30398413e+00  5.77897028e+00  5.77897028e+00
  5.77897028e+00  1.40429508e+01  2.42272934e+01  2.42272934e+01
  2.42272934e+01  4.56924457e+01  1.19134395e+02  1.19134395e+02
  1.19134395e+02  1.52468167e+02  5.16597512e+02  1.88305081e+03
  8.01127930e+03  4.77770627e+04]
E1 = -182.11150534458957  E_coul = 53.58247709137849
cycle= 1 E= -128.529028253211  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461522
diis-c [-0.21300224  1.        ]
  HOMO = -0.879577019617503  LUMO = 0.785620806770659
  mo_energy =
[-3.28739258e+01 -1.96313955e+00 -8.79577020e-01 -8.79577020e-01
 -8.79577020e-01  7.85620807e-01  1.07742243e+00  1.07742243e+00
  1.07742243e+00  4.22715020e+00  5.65004727e+00  5.65004727e+00
  5.65004727e+00  1.38920270e+01  2.39923649e+01  2.39923649e+01
  2.39923649e+01  4.54471625e+01  1.18813603e+02  1.18813603e+02
  1.18813603e+02  1.52155843e+02  5.16240841e+02  1.88265767e+03
  8.01085700e+03  4.77766214e+04]
E1 = -182.84335135584234  E_coul = 54.31181897418812
cycle= 2 E= -128.531532381654  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0685
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230491
diis-c [-6.47394130e-04  3.32050433e-01  6.67949567e-01]
  HOMO = -0.845228329642488  LUMO = 0.794525924822499
  mo_energy =
[-3.27689380e+01 -1.92702758e+00 -8.45228330e-01 -8.45228330e-01
 -8.45228330e-01  7.94525925e-01  1.08991482e+00  1.08991482e+00
  1.08991482e+00  4.25195141e+00  5.69197417e+00  5.69197417e+00
  5.69197417e+00  1.39413285e+01  2.40699176e+01  2.40699176e+01
  2.40699176e+01  4.55283568e+01  1.18918619e+02  1.18918619e+02
  1.18918619e+02  1.52258531e+02  5.16354280e+02  1.88277642e+03
  8.01097820e+03  4.77767436e+04]
E1 = -182.59794654092283  E_coul = 54.065567431113756
cycle= 3 E= -128.532379109809  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951463
diis-c [-1.58197664e-07 -2.22383057e-03 -7.03325597e-04  1.00292716e+00]
  HOMO = -0.845465819248967  LUMO = 0.794489238418623
  mo_energy =
[-3.27693563e+01 -1.92720020e+00 -8.45465819e-01 -8.45465819e-01
 -8.45465819e-01  7.94489238e-01  1.08986275e+00  1.08986275e+00
  1.08986275e+00  4.25182367e+00  5.69176683e+00  5.69176683e+00
  5.69176683e+00  1.39410926e+01  2.40695877e+01  2.40695877e+01
  2.40695877e+01  4.55280226e+01  1.18918188e+02  1.18918188e+02
  1.18918188e+02  1.52258113e+02  5.16353760e+02  1.88277579e+03
  8.01097748e+03  4.77767428e+04]
E1 = -182.5984594510661  E_coul = 54.06608031984548
cycle= 4 E= -128.532379131221  delta_E= -2.14e-08  |g|= 6.36e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132115
diis-c [-1.01912259e-09  3.31045800e-04  4.23424613e-04 -2.15847981e-01
  1.21509351e+00]
  HOMO = -0.845498024153376  LUMO = 0.794482520959188
  mo_energy =
[-3.27694085e+01 -1.92721973e+00 -8.45498024e-01 -8.45498024e-01
 -8.45498024e-01  7.94482521e-01  1.08984917e+00  1.08984917e+00
  1.08984917e+00  4.25180250e+00  5.69173126e+00  5.69173126e+00
  5.69173126e+00  1.39410558e+01  2.40695405e+01  2.40695405e+01
  2.40695405e+01  4.55279756e+01  1.18918135e+02  1.18918135e+02
  1.18918135e+02  1.52258061e+02  5.16353700e+02  1.88277572e+03
  8.01097740e+03  4.77767427e+04]
E1 = -182.59856163719775  E_coul = 54.06618250542768
cycle= 5 E= -128.53237913177  delta_E= -5.49e-10  |g|= 6.83e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59856163719775  E_coul = 54.06618250542768
  HOMO = -0.845494253406738  LUMO = 0.794484002076985
  mo_energy =
[-3.27694003e+01 -1.92721525e+00 -8.45494253e-01 -8.45494253e-01
 -8.45494253e-01  7.94484002e-01  1.08985075e+00  1.08985075e+00
  1.08985075e+00  4.25180585e+00  5.69173584e+00  5.69173584e+00
  5.69173584e+00  1.39410613e+01  2.40695475e+01  2.40695475e+01
  2.40695475e+01  4.55279829e+01  1.18918144e+02  1.18918144e+02
  1.18918144e+02  1.52258069e+02  5.16353708e+02  1.88277573e+03
  8.01097741e+03  4.77767427e+04]
E1 = -182.5985435322033  E_coul = 54.066164400430516
Extra cycle  E= -128.532379131773  delta_E= -2.73e-12  |g|= 2.53e-06  |ddm|= 2.62e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1657.9716948109258
E1 = -182.5985435322033  E_coul = 54.066164400430516
init E= -128.532379131773
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.84549551818106  LUMO = 0.794483741706418
  mo_energy =
[-3.27694043e+01 -1.92721647e+00 -8.45495518e-01 -8.45495518e-01
 -8.45495518e-01  7.94483742e-01  1.08985031e+00  1.08985031e+00
  1.08985031e+00  4.25180502e+00  5.69173430e+00  5.69173430e+00
  5.69173430e+00  1.39410595e+01  2.40695446e+01  2.40695446e+01
  2.40695446e+01  4.55279798e+01  1.18918140e+02  1.18918140e+02
  1.18918140e+02  1.52258065e+02  5.16353704e+02  1.88277572e+03
  8.01097741e+03  4.77767427e+04]
E1 = -182.59855328637002  E_coul = 54.0661741545966
cycle= 1 E= -128.532379131773  delta_E= -6.25e-13  |g|= 1.34e-06  |ddm|= 9.7e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59855328637002  E_coul = 54.0661741545966
  HOMO = -0.845494832161087  LUMO = 0.79448393116129
  mo_energy =
[-3.27694023e+01 -1.92721573e+00 -8.45494832e-01 -8.45494832e-01
 -8.45494832e-01  7.94483931e-01  1.08985056e+00  1.08985056e+00
  1.08985056e+00  4.25180553e+00  5.69173514e+00  5.69173514e+00
  5.69173514e+00  1.39410605e+01  2.40695462e+01  2.40695462e+01
  2.40695462e+01  4.55279814e+01  1.18918142e+02  1.18918142e+02
  1.18918142e+02  1.52258067e+02  5.16353706e+02  1.88277572e+03
  8.01097741e+03  4.77767427e+04]
E1 = -182.59854844018778  E_coul = 54.06616930841441
Extra cycle  E= -128.532379131773  delta_E= 2.84e-14  |g|= 6.6e-07  |ddm|= 4.64e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.09446135e-01 2.44137941e+04 3.66145460e+03 8.33268345e+02
 2.35769700e+02 7.61559335e+01 1.09352597e+01 2.78418382e+01
 3.13533563e-01 1.96364966e+00 3.55752941e+00 3.68632123e+00
 1.24578888e+01 5.47784173e+01 3.30242122e-01 1.14429259e+00]
grad_E = [ 3.93166108e-05 -2.29231235e-09  1.19597213e-07 -2.24609353e-06
  2.18474700e-05 -8.75246979e-05  2.98915545e-05  3.12824787e-05
  1.08512764e-04 -2.97930471e-05 -1.17765275e-04 -2.09638998e-05
  2.47278883e-05 -2.88705392e-06  9.99362482e-05  4.93795252e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.806703682093       1
[INPUT] 0    0    [1    /1   ]  24413.7941278        1
[INPUT] 0    0    [1    /1   ]  3661.45458734        1
[INPUT] 0    0    [1    /1   ]  833.268558229        1
[INPUT] 0    0    [1    /1   ]  235.767429611        1
[INPUT] 0    0    [1    /1   ]  76.1681406828        1
[INPUT] 0    0    [1    /1   ]  10.9147995178        1
[INPUT] 0    0    [1    /1   ]  27.8213761974        1
[INPUT] 0    0    [1    /1   ]  0.313866883872       1
[INPUT] 0    0    [1    /1   ]  1.9439508888         1
[INPUT] 0    0    [1    /1   ]  3.55075561447        1
[INPUT] 1    0    [1    /1   ]  3.68582933971        1
[INPUT] 1    0    [1    /1   ]  12.4561351886        1
[INPUT] 1    0    [1    /1   ]  54.7787761936        1
[INPUT] 1    0    [1    /1   ]  0.330300925409       1
[INPUT] 1    0    [1    /1   ]  1.14435682006        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8067036820929956, 1.0]], [0, [24413.79412776113, 1.0]], [0, [3661.4545873360817, 1.0]], [0, [833.2685582288572, 1.0]], [0, [235.76742961063812, 1.0]], [0, [76.16814068275896, 1.0]], [0, [10.914799517789886, 1.0]], [0, [27.82137619740094, 1.0]], [0, [0.3138668838719331, 1.0]], [0, [1.94395088880003, 1.0]], [0, [3.5507556144703267, 1.0]], [1, [3.685829339705545, 1.0]], [1, [12.456135188612562, 1.0]], [1, [54.778776193553064, 1.0]], [1, [0.33030092540884, 1.0]], [1, [1.1443568200552245, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80670368]
bas 1, expnt(s) = [24413.79412776]
bas 2, expnt(s) = [3661.45458734]
bas 3, expnt(s) = [833.26855823]
bas 4, expnt(s) = [235.76742961]
bas 5, expnt(s) = [76.16814068]
bas 6, expnt(s) = [10.91479952]
bas 7, expnt(s) = [27.8213762]
bas 8, expnt(s) = [0.31386688]
bas 9, expnt(s) = [1.94395089]
bas 10, expnt(s) = [3.55075561]
bas 11, expnt(s) = [3.68582934]
bas 12, expnt(s) = [12.45613519]
bas 13, expnt(s) = [54.77877619]
bas 14, expnt(s) = [0.33030093]
bas 15, expnt(s) = [1.14435682]
CPU time:       202.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.06703682e-01 2.15055500e+00 2.44137941e+04 4.93448102e+03
 3.66145459e+03 1.18920099e+03 8.33268558e+02 3.91835491e+02
 2.35767430e+02 1.52012003e+02 7.61681407e+01 6.51395929e+01
 1.09147995e+01 1.51714415e+01 2.78213762e+01 3.06054649e+01
 3.13866884e-01 1.05943458e+00 1.94395089e+00 4.15938375e+00
 3.55075561e+00 6.53515076e+00 3.68582934e+00 1.48988731e+01
 1.24561352e+01 6.82674269e+01 5.47787762e+01 4.34760220e+02
 3.30300925e-01 7.30502372e-01 1.14435682e+00 3.45291765e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99848513641167
cond(S) = 1632.4084013701283
E1 = -183.57821575246976  E_coul = 55.078508789177086
init E= -128.499706963293
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773942984589791  LUMO = 0.811532362535646
  mo_energy =
[-3.25554138e+01 -1.85290985e+00 -7.73942985e-01 -7.73942985e-01
 -7.73942985e-01  8.11532363e-01  1.11583339e+00  1.11583339e+00
  1.11583339e+00  4.28255906e+00  5.77906371e+00  5.77906371e+00
  5.77906371e+00  1.39667138e+01  2.42244230e+01  2.42244230e+01
  2.42244230e+01  4.55353238e+01  1.19128255e+02  1.19128255e+02
  1.19128255e+02  1.52244982e+02  5.16370056e+02  1.88284483e+03
  8.01109737e+03  4.77769119e+04]
E1 = -182.11168127860128  E_coul = 53.582651482713665
cycle= 1 E= -128.529029795888  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461462
diis-c [-0.212947  1.      ]
  HOMO = -0.879562098699683  LUMO = 0.784260930849275
  mo_energy =
[-3.28738980e+01 -1.96312518e+00 -8.79562099e-01 -8.79562099e-01
 -8.79562099e-01  7.84260931e-01  1.07762509e+00  1.07762509e+00
  1.07762509e+00  4.20613482e+00  5.65016548e+00  5.65016548e+00
  5.65016548e+00  1.38161869e+01  2.39895322e+01  2.39895322e+01
  2.39895322e+01  4.52901734e+01  1.18807490e+02  1.18807490e+02
  1.18807490e+02  1.51932685e+02  5.16013405e+02  1.88245172e+03
  8.01067510e+03  4.77764707e+04]
E1 = -182.84343483559422  E_coul = 54.31190136084542
cycle= 2 E= -128.531533474749  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0684
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230451
diis-c [-6.46544022e-04  3.32041750e-01  6.67958250e-01]
  HOMO = -0.845217443126066  LUMO = 0.793136026049115
  mo_energy =
[-3.27689214e+01 -1.92701753e+00 -8.45217443e-01 -8.45217443e-01
 -8.45217443e-01  7.93136026e-01  1.09011753e+00  1.09011753e+00
  1.09011753e+00  4.23080359e+00  5.69208476e+00  5.69208476e+00
  5.69208476e+00  1.38653565e+01  2.40670721e+01  2.40670721e+01
  2.40670721e+01  4.53713231e+01  1.18912494e+02  1.18912494e+02
  1.18912494e+02  1.52035363e+02  5.16126836e+02  1.88257046e+03
  8.01079629e+03  4.77765928e+04]
E1 = -182.5980663699871  E_coul = 54.06568639066967
cycle= 3 E= -128.532379979317  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951489
diis-c [-1.57748058e-07 -2.22258322e-03 -6.99042174e-04  1.00292163e+00]
  HOMO = -0.845454882760146  LUMO = 0.793099446265556
  mo_energy =
[-3.27693399e+01 -1.92719022e+00 -8.45454883e-01 -8.45454883e-01
 -8.45454883e-01  7.93099446e-01  1.09006546e+00  1.09006546e+00
  1.09006546e+00  4.23067649e+00  5.69187745e+00  5.69187745e+00
  5.69187745e+00  1.38651212e+01  2.40667421e+01  2.40667421e+01
  2.40667421e+01  4.53709890e+01  1.18912064e+02  1.18912064e+02
  1.18912064e+02  1.52034946e+02  5.16126315e+02  1.88256982e+03
  8.01079557e+03  4.77765921e+04]
E1 = -182.5985798526087  E_coul = 54.06619985190848
cycle= 4 E= -128.5323800007  delta_E= -2.14e-08  |g|= 6.35e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131974
diis-c [-1.01594799e-09  3.30643853e-04  4.22596167e-04 -2.15662584e-01
  1.21490934e+00]
  HOMO = -0.845487058657727  LUMO = 0.793092748561688
  mo_energy =
[-3.27693921e+01 -1.92720975e+00 -8.45487059e-01 -8.45487059e-01
 -8.45487059e-01  7.93092749e-01  1.09005189e+00  1.09005189e+00
  1.09005189e+00  4.23065542e+00  5.69184191e+00  5.69184191e+00
  5.69184191e+00  1.38650845e+01  2.40666949e+01  2.40666949e+01
  2.40666949e+01  4.53709419e+01  1.18912011e+02  1.18912011e+02
  1.18912011e+02  1.52034893e+02  5.16126255e+02  1.88256976e+03
  8.01079549e+03  4.77765920e+04]
E1 = -182.59868194996858  E_coul = 54.06630194872082
cycle= 5 E= -128.532380001248  delta_E= -5.48e-10  |g|= 6.82e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59868194996858  E_coul = 54.06630194872082
  HOMO = -0.845483297158505  LUMO = 0.793094222316708
  mo_energy =
[-3.27693839e+01 -1.92720528e+00 -8.45483297e-01 -8.45483297e-01
 -8.45483297e-01  7.93094222e-01  1.09005347e+00  1.09005347e+00
  1.09005347e+00  4.23065875e+00  5.69184647e+00  5.69184647e+00
  5.69184647e+00  1.38650899e+01  2.40667019e+01  2.40667019e+01
  2.40667019e+01  4.53709492e+01  1.18912019e+02  1.18912019e+02
  1.18912019e+02  1.52034901e+02  5.16126263e+02  1.88256976e+03
  8.01079550e+03  4.77765920e+04]
E1 = -182.59866388338168  E_coul = 54.06628388213074
Extra cycle  E= -128.532380001251  delta_E= -3.18e-12  |g|= 2.53e-06  |ddm|= 2.6e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [8.06703682e-01 2.44137941e+04 3.66145459e+03 8.33268558e+02
 2.35767430e+02 7.61681407e+01 1.09147995e+01 2.78213762e+01
 3.13866884e-01 1.94395089e+00 3.55075561e+00 3.68582934e+00
 1.24561352e+01 5.47787762e+01 3.30300925e-01 1.14435682e+00]
E = -128.53238000125094
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.806703682093       1
[INPUT] 0    0    [1    /1   ]  24413.7941278        1
[INPUT] 0    0    [1    /1   ]  3661.45458734        1
[INPUT] 0    0    [1    /1   ]  833.268558229        1
[INPUT] 0    0    [1    /1   ]  235.767429611        1
[INPUT] 0    0    [1    /1   ]  76.1681406828        1
[INPUT] 0    0    [1    /1   ]  10.9147995178        1
[INPUT] 0    0    [1    /1   ]  27.8213761974        1
[INPUT] 0    0    [1    /1   ]  0.313866883872       1
[INPUT] 0    0    [1    /1   ]  1.9439508888         1
[INPUT] 0    0    [1    /1   ]  3.55075561447        1
[INPUT] 1    0    [1    /1   ]  3.68582933971        1
[INPUT] 1    0    [1    /1   ]  12.4561351886        1
[INPUT] 1    0    [1    /1   ]  54.7787761936        1
[INPUT] 1    0    [1    /1   ]  0.330300925409       1
[INPUT] 1    0    [1    /1   ]  1.14435682006        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8067036820929956, 1.0]], [0, [24413.79412776113, 1.0]], [0, [3661.4545873360817, 1.0]], [0, [833.2685582288572, 1.0]], [0, [235.76742961063812, 1.0]], [0, [76.16814068275896, 1.0]], [0, [10.914799517789886, 1.0]], [0, [27.82137619740094, 1.0]], [0, [0.3138668838719331, 1.0]], [0, [1.94395088880003, 1.0]], [0, [3.5507556144703267, 1.0]], [1, [3.685829339705545, 1.0]], [1, [12.456135188612562, 1.0]], [1, [54.778776193553064, 1.0]], [1, [0.33030092540884, 1.0]], [1, [1.1443568200552245, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80670368]
bas 1, expnt(s) = [24413.79412776]
bas 2, expnt(s) = [3661.45458734]
bas 3, expnt(s) = [833.26855823]
bas 4, expnt(s) = [235.76742961]
bas 5, expnt(s) = [76.16814068]
bas 6, expnt(s) = [10.91479952]
bas 7, expnt(s) = [27.8213762]
bas 8, expnt(s) = [0.31386688]
bas 9, expnt(s) = [1.94395089]
bas 10, expnt(s) = [3.55075561]
bas 11, expnt(s) = [3.68582934]
bas 12, expnt(s) = [12.45613519]
bas 13, expnt(s) = [54.77877619]
bas 14, expnt(s) = [0.33030093]
bas 15, expnt(s) = [1.14435682]
CPU time:       203.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.06703682e-01 2.15055500e+00 2.44137941e+04 4.93448102e+03
 3.66145459e+03 1.18920099e+03 8.33268558e+02 3.91835491e+02
 2.35767430e+02 1.52012003e+02 7.61681407e+01 6.51395929e+01
 1.09147995e+01 1.51714415e+01 2.78213762e+01 3.06054649e+01
 3.13866884e-01 1.05943458e+00 1.94395089e+00 4.15938375e+00
 3.55075561e+00 6.53515076e+00 3.68582934e+00 1.48988731e+01
 1.24561352e+01 6.82674269e+01 5.47787762e+01 4.34760220e+02
 3.30300925e-01 7.30502372e-01 1.14435682e+00 3.45291765e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99848513641167
cond(S) = 1632.4084013701283
E1 = -183.57821575246976  E_coul = 55.078508789177086
init E= -128.499706963293
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773942984589791  LUMO = 0.811532362535646
  mo_energy =
[-3.25554138e+01 -1.85290985e+00 -7.73942985e-01 -7.73942985e-01
 -7.73942985e-01  8.11532363e-01  1.11583339e+00  1.11583339e+00
  1.11583339e+00  4.28255906e+00  5.77906371e+00  5.77906371e+00
  5.77906371e+00  1.39667138e+01  2.42244230e+01  2.42244230e+01
  2.42244230e+01  4.55353238e+01  1.19128255e+02  1.19128255e+02
  1.19128255e+02  1.52244982e+02  5.16370056e+02  1.88284483e+03
  8.01109737e+03  4.77769119e+04]
E1 = -182.11168127860128  E_coul = 53.582651482713665
cycle= 1 E= -128.529029795888  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461462
diis-c [-0.212947  1.      ]
  HOMO = -0.879562098699683  LUMO = 0.784260930849275
  mo_energy =
[-3.28738980e+01 -1.96312518e+00 -8.79562099e-01 -8.79562099e-01
 -8.79562099e-01  7.84260931e-01  1.07762509e+00  1.07762509e+00
  1.07762509e+00  4.20613482e+00  5.65016548e+00  5.65016548e+00
  5.65016548e+00  1.38161869e+01  2.39895322e+01  2.39895322e+01
  2.39895322e+01  4.52901734e+01  1.18807490e+02  1.18807490e+02
  1.18807490e+02  1.51932685e+02  5.16013405e+02  1.88245172e+03
  8.01067510e+03  4.77764707e+04]
E1 = -182.84343483559422  E_coul = 54.31190136084542
cycle= 2 E= -128.531533474749  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0684
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230451
diis-c [-6.46544022e-04  3.32041750e-01  6.67958250e-01]
  HOMO = -0.845217443126066  LUMO = 0.793136026049115
  mo_energy =
[-3.27689214e+01 -1.92701753e+00 -8.45217443e-01 -8.45217443e-01
 -8.45217443e-01  7.93136026e-01  1.09011753e+00  1.09011753e+00
  1.09011753e+00  4.23080359e+00  5.69208476e+00  5.69208476e+00
  5.69208476e+00  1.38653565e+01  2.40670721e+01  2.40670721e+01
  2.40670721e+01  4.53713231e+01  1.18912494e+02  1.18912494e+02
  1.18912494e+02  1.52035363e+02  5.16126836e+02  1.88257046e+03
  8.01079629e+03  4.77765928e+04]
E1 = -182.5980663699871  E_coul = 54.06568639066967
cycle= 3 E= -128.532379979317  delta_E= -0.000847  |g|= 0.000473  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000951489
diis-c [-1.57748058e-07 -2.22258322e-03 -6.99042174e-04  1.00292163e+00]
  HOMO = -0.845454882760146  LUMO = 0.793099446265556
  mo_energy =
[-3.27693399e+01 -1.92719022e+00 -8.45454883e-01 -8.45454883e-01
 -8.45454883e-01  7.93099446e-01  1.09006546e+00  1.09006546e+00
  1.09006546e+00  4.23067649e+00  5.69187745e+00  5.69187745e+00
  5.69187745e+00  1.38651212e+01  2.40667421e+01  2.40667421e+01
  2.40667421e+01  4.53709890e+01  1.18912064e+02  1.18912064e+02
  1.18912064e+02  1.52034946e+02  5.16126315e+02  1.88256982e+03
  8.01079557e+03  4.77765921e+04]
E1 = -182.5985798526087  E_coul = 54.06619985190848
cycle= 4 E= -128.5323800007  delta_E= -2.14e-08  |g|= 6.35e-05  |ddm|= 0.000332
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131974
diis-c [-1.01594799e-09  3.30643853e-04  4.22596167e-04 -2.15662584e-01
  1.21490934e+00]
  HOMO = -0.845487058657727  LUMO = 0.793092748561688
  mo_energy =
[-3.27693921e+01 -1.92720975e+00 -8.45487059e-01 -8.45487059e-01
 -8.45487059e-01  7.93092749e-01  1.09005189e+00  1.09005189e+00
  1.09005189e+00  4.23065542e+00  5.69184191e+00  5.69184191e+00
  5.69184191e+00  1.38650845e+01  2.40666949e+01  2.40666949e+01
  2.40666949e+01  4.53709419e+01  1.18912011e+02  1.18912011e+02
  1.18912011e+02  1.52034893e+02  5.16126255e+02  1.88256976e+03
  8.01079549e+03  4.77765920e+04]
E1 = -182.59868194996858  E_coul = 54.06630194872082
cycle= 5 E= -128.532380001248  delta_E= -5.48e-10  |g|= 6.82e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59868194996858  E_coul = 54.06630194872082
  HOMO = -0.845483297158505  LUMO = 0.793094222316708
  mo_energy =
[-3.27693839e+01 -1.92720528e+00 -8.45483297e-01 -8.45483297e-01
 -8.45483297e-01  7.93094222e-01  1.09005347e+00  1.09005347e+00
  1.09005347e+00  4.23065875e+00  5.69184647e+00  5.69184647e+00
  5.69184647e+00  1.38650899e+01  2.40667019e+01  2.40667019e+01
  2.40667019e+01  4.53709492e+01  1.18912019e+02  1.18912019e+02
  1.18912019e+02  1.52034901e+02  5.16126263e+02  1.88256976e+03
  8.01079550e+03  4.77765920e+04]
E1 = -182.59866388338168  E_coul = 54.06628388213074
Extra cycle  E= -128.532380001251  delta_E= -3.18e-12  |g|= 2.53e-06  |ddm|= 2.6e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1632.4084013701283
E1 = -182.59866388338168  E_coul = 54.06628388213074
init E= -128.532380001251
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845484559355749  LUMO = 0.793093963496082
  mo_energy =
[-3.27693879e+01 -1.92720649e+00 -8.45484559e-01 -8.45484559e-01
 -8.45484559e-01  7.93093963e-01  1.09005302e+00  1.09005302e+00
  1.09005302e+00  4.23065793e+00  5.69184494e+00  5.69184494e+00
  5.69184494e+00  1.38650881e+01  2.40666990e+01  2.40666990e+01
  2.40666990e+01  4.53709462e+01  1.18912015e+02  1.18912015e+02
  1.18912015e+02  1.52034897e+02  5.16126259e+02  1.88256976e+03
  8.01079550e+03  4.77765920e+04]
E1 = -182.5986736160837  E_coul = 54.066293614832624
cycle= 1 E= -128.532380001251  delta_E= -1.14e-13  |g|= 1.33e-06  |ddm|= 9.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5986736160837  E_coul = 54.066293614832624
  HOMO = -0.845483874869323  LUMO = 0.793094151948817
  mo_energy =
[-3.27693858e+01 -1.92720575e+00 -8.45483875e-01 -8.45483875e-01
 -8.45483875e-01  7.93094152e-01  1.09005328e+00  1.09005328e+00
  1.09005328e+00  4.23065843e+00  5.69184577e+00  5.69184577e+00
  5.69184577e+00  1.38650891e+01  2.40667005e+01  2.40667005e+01
  2.40667005e+01  4.53709478e+01  1.18912017e+02  1.18912017e+02
  1.18912017e+02  1.52034899e+02  5.16126261e+02  1.88256976e+03
  8.01079550e+03  4.77765920e+04]
E1 = -182.59866878072825  E_coul = 54.06628877947706
Extra cycle  E= -128.532380001251  delta_E= -1.14e-13  |g|= 6.58e-07  |ddm|= 4.62e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [8.06703682e-01 2.44137941e+04 3.66145459e+03 8.33268558e+02
 2.35767430e+02 7.61681407e+01 1.09147995e+01 2.78213762e+01
 3.13866884e-01 1.94395089e+00 3.55075561e+00 3.68582934e+00
 1.24561352e+01 5.47787762e+01 3.30300925e-01 1.14435682e+00]
grad_E = [ 4.83062211e-05 -2.20691393e-09  1.15121249e-07 -2.16247096e-06
  2.10112025e-05 -8.39074238e-05  3.01425719e-05  2.67724381e-05
  1.99733186e-04 -4.35557390e-05 -1.16447968e-04 -5.84339724e-05
  2.58244475e-05 -2.55807855e-06  1.74087759e-04  1.27490818e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.802441472283       1
[INPUT] 0    0    [1    /1   ]  24413.7941282        1
[INPUT] 0    0    [1    /1   ]  3661.45456345        1
[INPUT] 0    0    [1    /1   ]  833.269014852        1
[INPUT] 0    0    [1    /1   ]  235.762756638        1
[INPUT] 0    0    [1    /1   ]  76.1905866948        1
[INPUT] 0    0    [1    /1   ]  10.8888303112        1
[INPUT] 0    0    [1    /1   ]  27.7939018076        1
[INPUT] 0    0    [1    /1   ]  0.314377563602       1
[INPUT] 0    0    [1    /1   ]  1.91513611328        1
[INPUT] 0    0    [1    /1   ]  3.55331647374        1
[INPUT] 1    0    [1    /1   ]  3.68464173547        1
[INPUT] 1    0    [1    /1   ]  12.4520891114        1
[INPUT] 1    0    [1    /1   ]  54.7794599536        1
[INPUT] 1    0    [1    /1   ]  0.330369807107       1
[INPUT] 1    0    [1    /1   ]  1.14434392274        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8024414722833706, 1.0]], [0, [24413.794128218407, 1.0]], [0, [3661.4545634493065, 1.0]], [0, [833.2690148521563, 1.0]], [0, [235.76275663788527, 1.0]], [0, [76.19058669479583, 1.0]], [0, [10.888830311199802, 1.0]], [0, [27.7939018076414, 1.0]], [0, [0.3143775636017588, 1.0]], [0, [1.9151361132825708, 1.0]], [0, [3.5533164737409533, 1.0]], [1, [3.68464173546626, 1.0]], [1, [12.452089111441724, 1.0]], [1, [54.77945995363207, 1.0]], [1, [0.33036980710691005, 1.0]], [1, [1.144343922742051, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80244147]
bas 1, expnt(s) = [24413.79412822]
bas 2, expnt(s) = [3661.45456345]
bas 3, expnt(s) = [833.26901485]
bas 4, expnt(s) = [235.76275664]
bas 5, expnt(s) = [76.19058669]
bas 6, expnt(s) = [10.88883031]
bas 7, expnt(s) = [27.79390181]
bas 8, expnt(s) = [0.31437756]
bas 9, expnt(s) = [1.91513611]
bas 10, expnt(s) = [3.55331647]
bas 11, expnt(s) = [3.68464174]
bas 12, expnt(s) = [12.45208911]
bas 13, expnt(s) = [54.77945995]
bas 14, expnt(s) = [0.33036981]
bas 15, expnt(s) = [1.14434392]
CPU time:       206.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.02441472e-01 2.14202753e+00 2.44137941e+04 4.93448102e+03
 3.66145456e+03 1.18920099e+03 8.33269015e+02 3.91835652e+02
 2.35762757e+02 1.52009743e+02 7.61905867e+01 6.51539894e+01
 1.08888303e+01 1.51443608e+01 2.77939018e+01 3.05827943e+01
 3.14377564e-01 1.06072714e+00 1.91513611e+00 4.11305729e+00
 3.55331647e+00 6.53868538e+00 3.68464174e+00 1.48928727e+01
 1.24520891e+01 6.82397092e+01 5.47794600e+01 4.34767003e+02
 3.30369807e-01 7.30692803e-01 1.14434392e+00 3.45286900e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998484005121025
cond(S) = 1585.7056887947604
E1 = -183.57821502176554  E_coul = 55.07851508613973
init E= -128.499699935626
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773942135081679  LUMO = 0.809494661209325
  mo_energy =
[-3.25554144e+01 -1.85290910e+00 -7.73942135e-01 -7.73942135e-01
 -7.73942135e-01  8.09494661e-01  1.11604179e+00  1.11604179e+00
  1.11604179e+00  4.25282689e+00  5.77855638e+00  5.77855638e+00
  5.77855638e+00  1.38736968e+01  2.42168956e+01  2.42168956e+01
  2.42168956e+01  4.53560262e+01  1.19113166e+02  1.19113166e+02
  1.19113166e+02  1.51989308e+02  5.16117518e+02  1.88262096e+03
  8.01090023e+03  4.77767487e+04]
E1 = -182.1119207667412  E_coul = 53.582887926585656
cycle= 1 E= -128.529032840156  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461398
diis-c [-0.2128881  1.       ]
  HOMO = -0.879541498836251  LUMO = 0.78235772835152
  mo_energy =
[-3.28738620e+01 -1.96310556e+00 -8.79541499e-01 -8.79541499e-01
 -8.79541499e-01  7.82357728e-01  1.07783825e+00  1.07783825e+00
  1.07783825e+00  4.17694128e+00  5.64970342e+00  5.64970342e+00
  5.64970342e+00  1.37235961e+01  2.39820669e+01  2.39820669e+01
  2.39820669e+01  4.51110186e+01  1.18792437e+02  1.18792437e+02
  1.18792437e+02  1.51677047e+02  5.15760893e+02  1.88222788e+03
  8.01047799e+03  4.77763075e+04]
E1 = -182.84355189609863  E_coul = 54.31201598052945
cycle= 2 E= -128.531535915569  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0684
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230408
diis-c [-6.45569025e-04  3.32032462e-01  6.67967538e-01]
  HOMO = -0.845202289826371  LUMO = 0.79119025450255
  mo_energy =
[-3.27689008e+01 -1.92700371e+00 -8.45202290e-01 -8.45202290e-01
 -8.45202290e-01  7.91190255e-01  1.09032966e+00  1.09032966e+00
  1.09032966e+00  4.20143616e+00  5.69160860e+00  5.69160860e+00
  5.69160860e+00  1.37726245e+01  2.40595856e+01  2.40595856e+01
  2.40595856e+01  4.51921201e+01  1.18897426e+02  1.18897426e+02
  1.18897426e+02  1.51779710e+02  5.15874310e+02  1.88234660e+03
  8.01059916e+03  4.77764296e+04]
E1 = -182.59823241326288  E_coul = 54.06585029009576
cycle= 3 E= -128.532382123167  delta_E= -0.000846  |g|= 0.000473  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950779
diis-c [-1.56924997e-07 -2.22046384e-03 -6.95581981e-04  1.00291605e+00]
  HOMO = -0.845439532462308  LUMO = 0.791153852084165
  mo_energy =
[-3.27693190e+01 -1.92717638e+00 -8.45439532e-01 -8.45439532e-01
 -8.45439532e-01  7.91153852e-01  1.09027764e+00  1.09027764e+00
  1.09027764e+00  4.20130999e+00  5.69140148e+00  5.69140148e+00
  5.69140148e+00  1.37723899e+01  2.40592559e+01  2.40592559e+01
  2.40592559e+01  4.51917862e+01  1.18896995e+02  1.18896995e+02
  1.18896995e+02  1.51779293e+02  5.15873790e+02  1.88234596e+03
  8.01059844e+03  4.77764288e+04]
E1 = -182.59874586496932  E_coul = 54.06636372048258
cycle= 4 E= -128.532382144487  delta_E= -2.13e-08  |g|= 6.34e-05  |ddm|= 0.000331
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131762
diis-c [-1.01159415e-09  3.29938511e-04  4.22020958e-04 -2.15370518e-01
  1.21461856e+00]
  HOMO = -0.845471667984832  LUMO = 0.791147180010733
  mo_energy =
[-3.27693712e+01 -1.92719592e+00 -8.45471668e-01 -8.45471668e-01
 -8.45471668e-01  7.91147180e-01  1.09026407e+00  1.09026407e+00
  1.09026407e+00  4.20128907e+00  5.69136598e+00  5.69136598e+00
  5.69136598e+00  1.37723533e+01  2.40592087e+01  2.40592087e+01
  2.40592087e+01  4.51917393e+01  1.18896943e+02  1.18896943e+02
  1.18896943e+02  1.51779241e+02  5.15873730e+02  1.88234590e+03
  8.01059837e+03  4.77764288e+04]
E1 = -182.59884784939723  E_coul = 54.06646570436499
cycle= 5 E= -128.532382145032  delta_E= -5.45e-10  |g|= 6.79e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59884784939723  E_coul = 54.06646570436499
  HOMO = -0.845467919924561  LUMO = 0.791148643271917
  mo_energy =
[-3.27693630e+01 -1.92719147e+00 -8.45467920e-01 -8.45467920e-01
 -8.45467920e-01  7.91148643e-01  1.09026565e+00  1.09026565e+00
  1.09026565e+00  4.20129237e+00  5.69137053e+00  5.69137053e+00
  5.69137053e+00  1.37723587e+01  2.40592157e+01  2.40592157e+01
  2.40592157e+01  4.51917465e+01  1.18896951e+02  1.18896951e+02
  1.18896951e+02  1.51779249e+02  5.15873738e+02  1.88234590e+03
  8.01059838e+03  4.77764288e+04]
E1 = -182.59882983686907  E_coul = 54.0664476918342
Extra cycle  E= -128.532382145035  delta_E= -2.64e-12  |g|= 2.52e-06  |ddm|= 2.57e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.02441472e-01 2.44137941e+04 3.66145456e+03 8.33269015e+02
 2.35762757e+02 7.61905867e+01 1.08888303e+01 2.77939018e+01
 3.14377564e-01 1.91513611e+00 3.55331647e+00 3.68464174e+00
 1.24520891e+01 5.47794600e+01 3.30369807e-01 1.14434392e+00]
E = -128.5323821450349
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.802441472283       1
[INPUT] 0    0    [1    /1   ]  24413.7941282        1
[INPUT] 0    0    [1    /1   ]  3661.45456345        1
[INPUT] 0    0    [1    /1   ]  833.269014852        1
[INPUT] 0    0    [1    /1   ]  235.762756638        1
[INPUT] 0    0    [1    /1   ]  76.1905866948        1
[INPUT] 0    0    [1    /1   ]  10.8888303112        1
[INPUT] 0    0    [1    /1   ]  27.7939018076        1
[INPUT] 0    0    [1    /1   ]  0.314377563602       1
[INPUT] 0    0    [1    /1   ]  1.91513611328        1
[INPUT] 0    0    [1    /1   ]  3.55331647374        1
[INPUT] 1    0    [1    /1   ]  3.68464173547        1
[INPUT] 1    0    [1    /1   ]  12.4520891114        1
[INPUT] 1    0    [1    /1   ]  54.7794599536        1
[INPUT] 1    0    [1    /1   ]  0.330369807107       1
[INPUT] 1    0    [1    /1   ]  1.14434392274        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8024414722833706, 1.0]], [0, [24413.794128218407, 1.0]], [0, [3661.4545634493065, 1.0]], [0, [833.2690148521563, 1.0]], [0, [235.76275663788527, 1.0]], [0, [76.19058669479583, 1.0]], [0, [10.888830311199802, 1.0]], [0, [27.7939018076414, 1.0]], [0, [0.3143775636017588, 1.0]], [0, [1.9151361132825708, 1.0]], [0, [3.5533164737409533, 1.0]], [1, [3.68464173546626, 1.0]], [1, [12.452089111441724, 1.0]], [1, [54.77945995363207, 1.0]], [1, [0.33036980710691005, 1.0]], [1, [1.144343922742051, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80244147]
bas 1, expnt(s) = [24413.79412822]
bas 2, expnt(s) = [3661.45456345]
bas 3, expnt(s) = [833.26901485]
bas 4, expnt(s) = [235.76275664]
bas 5, expnt(s) = [76.19058669]
bas 6, expnt(s) = [10.88883031]
bas 7, expnt(s) = [27.79390181]
bas 8, expnt(s) = [0.31437756]
bas 9, expnt(s) = [1.91513611]
bas 10, expnt(s) = [3.55331647]
bas 11, expnt(s) = [3.68464174]
bas 12, expnt(s) = [12.45208911]
bas 13, expnt(s) = [54.77945995]
bas 14, expnt(s) = [0.33036981]
bas 15, expnt(s) = [1.14434392]
CPU time:       207.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.02441472e-01 2.14202753e+00 2.44137941e+04 4.93448102e+03
 3.66145456e+03 1.18920099e+03 8.33269015e+02 3.91835652e+02
 2.35762757e+02 1.52009743e+02 7.61905867e+01 6.51539894e+01
 1.08888303e+01 1.51443608e+01 2.77939018e+01 3.05827943e+01
 3.14377564e-01 1.06072714e+00 1.91513611e+00 4.11305729e+00
 3.55331647e+00 6.53868538e+00 3.68464174e+00 1.48928727e+01
 1.24520891e+01 6.82397092e+01 5.47794600e+01 4.34767003e+02
 3.30369807e-01 7.30692803e-01 1.14434392e+00 3.45286900e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998484005121025
cond(S) = 1585.7056887947604
E1 = -183.57821502176554  E_coul = 55.07851508613973
init E= -128.499699935626
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773942135081679  LUMO = 0.809494661209325
  mo_energy =
[-3.25554144e+01 -1.85290910e+00 -7.73942135e-01 -7.73942135e-01
 -7.73942135e-01  8.09494661e-01  1.11604179e+00  1.11604179e+00
  1.11604179e+00  4.25282689e+00  5.77855638e+00  5.77855638e+00
  5.77855638e+00  1.38736968e+01  2.42168956e+01  2.42168956e+01
  2.42168956e+01  4.53560262e+01  1.19113166e+02  1.19113166e+02
  1.19113166e+02  1.51989308e+02  5.16117518e+02  1.88262096e+03
  8.01090023e+03  4.77767487e+04]
E1 = -182.1119207667412  E_coul = 53.582887926585656
cycle= 1 E= -128.529032840156  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461398
diis-c [-0.2128881  1.       ]
  HOMO = -0.879541498836251  LUMO = 0.78235772835152
  mo_energy =
[-3.28738620e+01 -1.96310556e+00 -8.79541499e-01 -8.79541499e-01
 -8.79541499e-01  7.82357728e-01  1.07783825e+00  1.07783825e+00
  1.07783825e+00  4.17694128e+00  5.64970342e+00  5.64970342e+00
  5.64970342e+00  1.37235961e+01  2.39820669e+01  2.39820669e+01
  2.39820669e+01  4.51110186e+01  1.18792437e+02  1.18792437e+02
  1.18792437e+02  1.51677047e+02  5.15760893e+02  1.88222788e+03
  8.01047799e+03  4.77763075e+04]
E1 = -182.84355189609863  E_coul = 54.31201598052945
cycle= 2 E= -128.531535915569  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0684
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230408
diis-c [-6.45569025e-04  3.32032462e-01  6.67967538e-01]
  HOMO = -0.845202289826371  LUMO = 0.79119025450255
  mo_energy =
[-3.27689008e+01 -1.92700371e+00 -8.45202290e-01 -8.45202290e-01
 -8.45202290e-01  7.91190255e-01  1.09032966e+00  1.09032966e+00
  1.09032966e+00  4.20143616e+00  5.69160860e+00  5.69160860e+00
  5.69160860e+00  1.37726245e+01  2.40595856e+01  2.40595856e+01
  2.40595856e+01  4.51921201e+01  1.18897426e+02  1.18897426e+02
  1.18897426e+02  1.51779710e+02  5.15874310e+02  1.88234660e+03
  8.01059916e+03  4.77764296e+04]
E1 = -182.59823241326288  E_coul = 54.06585029009576
cycle= 3 E= -128.532382123167  delta_E= -0.000846  |g|= 0.000473  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950779
diis-c [-1.56924997e-07 -2.22046384e-03 -6.95581981e-04  1.00291605e+00]
  HOMO = -0.845439532462308  LUMO = 0.791153852084165
  mo_energy =
[-3.27693190e+01 -1.92717638e+00 -8.45439532e-01 -8.45439532e-01
 -8.45439532e-01  7.91153852e-01  1.09027764e+00  1.09027764e+00
  1.09027764e+00  4.20130999e+00  5.69140148e+00  5.69140148e+00
  5.69140148e+00  1.37723899e+01  2.40592559e+01  2.40592559e+01
  2.40592559e+01  4.51917862e+01  1.18896995e+02  1.18896995e+02
  1.18896995e+02  1.51779293e+02  5.15873790e+02  1.88234596e+03
  8.01059844e+03  4.77764288e+04]
E1 = -182.59874586496932  E_coul = 54.06636372048258
cycle= 4 E= -128.532382144487  delta_E= -2.13e-08  |g|= 6.34e-05  |ddm|= 0.000331
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131762
diis-c [-1.01159415e-09  3.29938511e-04  4.22020958e-04 -2.15370518e-01
  1.21461856e+00]
  HOMO = -0.845471667984832  LUMO = 0.791147180010733
  mo_energy =
[-3.27693712e+01 -1.92719592e+00 -8.45471668e-01 -8.45471668e-01
 -8.45471668e-01  7.91147180e-01  1.09026407e+00  1.09026407e+00
  1.09026407e+00  4.20128907e+00  5.69136598e+00  5.69136598e+00
  5.69136598e+00  1.37723533e+01  2.40592087e+01  2.40592087e+01
  2.40592087e+01  4.51917393e+01  1.18896943e+02  1.18896943e+02
  1.18896943e+02  1.51779241e+02  5.15873730e+02  1.88234590e+03
  8.01059837e+03  4.77764288e+04]
E1 = -182.59884784939723  E_coul = 54.06646570436499
cycle= 5 E= -128.532382145032  delta_E= -5.45e-10  |g|= 6.79e-06  |ddm|= 5.76e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59884784939723  E_coul = 54.06646570436499
  HOMO = -0.845467919924561  LUMO = 0.791148643271917
  mo_energy =
[-3.27693630e+01 -1.92719147e+00 -8.45467920e-01 -8.45467920e-01
 -8.45467920e-01  7.91148643e-01  1.09026565e+00  1.09026565e+00
  1.09026565e+00  4.20129237e+00  5.69137053e+00  5.69137053e+00
  5.69137053e+00  1.37723587e+01  2.40592157e+01  2.40592157e+01
  2.40592157e+01  4.51917465e+01  1.18896951e+02  1.18896951e+02
  1.18896951e+02  1.51779249e+02  5.15873738e+02  1.88234590e+03
  8.01059838e+03  4.77764288e+04]
E1 = -182.59882983686907  E_coul = 54.0664476918342
Extra cycle  E= -128.532382145035  delta_E= -2.64e-12  |g|= 2.52e-06  |ddm|= 2.57e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1585.7056887947604
E1 = -182.59882983686907  E_coul = 54.0664476918342
init E= -128.532382145035
    CPU time for initialize scf      0.26 sec, wall time      0.27 sec
  HOMO = -0.845469178509466  LUMO = 0.791148386638434
  mo_energy =
[-3.27693670e+01 -1.92719268e+00 -8.45469179e-01 -8.45469179e-01
 -8.45469179e-01  7.91148387e-01  1.09026521e+00  1.09026521e+00
  1.09026521e+00  4.20129155e+00  5.69136900e+00  5.69136900e+00
  5.69136900e+00  1.37723569e+01  2.40592128e+01  2.40592128e+01
  2.40592128e+01  4.51917435e+01  1.18896947e+02  1.18896947e+02
  1.18896947e+02  1.51779245e+02  5.15873733e+02  1.88234590e+03
  8.01059837e+03  4.77764288e+04]
E1 = -182.59883953925174  E_coul = 54.06645739421634
cycle= 1 E= -128.532382145035  delta_E= -5.12e-13  |g|= 1.33e-06  |ddm|= 9.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59883953925174  E_coul = 54.06645739421634
  HOMO = -0.84546849619076  LUMO = 0.791148573676176
  mo_energy =
[-3.27693649e+01 -1.92719194e+00 -8.45468496e-01 -8.45468496e-01
 -8.45468496e-01  7.91148574e-01  1.09026546e+00  1.09026546e+00
  1.09026546e+00  4.20129205e+00  5.69136984e+00  5.69136984e+00
  5.69136984e+00  1.37723579e+01  2.40592144e+01  2.40592144e+01
  2.40592144e+01  4.51917451e+01  1.18896949e+02  1.18896949e+02
  1.18896949e+02  1.51779247e+02  5.15873735e+02  1.88234590e+03
  8.01059838e+03  4.77764288e+04]
E1 = -182.59883471915825  E_coul = 54.06645257412278
Extra cycle  E= -128.532382145035  delta_E= -5.68e-14  |g|= 6.56e-07  |ddm|= 4.6e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.36 sec
exp = [8.02441472e-01 2.44137941e+04 3.66145456e+03 8.33269015e+02
 2.35762757e+02 7.61905867e+01 1.08888303e+01 2.77939018e+01
 3.14377564e-01 1.91513611e+00 3.55331647e+00 3.68464174e+00
 1.24520891e+01 5.47794600e+01 3.30369807e-01 1.14434392e+00]
grad_E = [ 6.46342037e-05 -2.06453899e-09  1.07667692e-07 -2.02350406e-06
  1.96304284e-05 -7.79039949e-05  3.03116915e-05  1.88178975e-05
  3.33462287e-04 -6.53721596e-05 -1.12217626e-04 -1.16991074e-04
  2.55588626e-05 -1.71449860e-06  2.93713281e-04  2.45644497e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.796782765051       1
[INPUT] 0    0    [1    /1   ]  24413.7941292        1
[INPUT] 0    0    [1    /1   ]  3661.45451125        1
[INPUT] 0    0    [1    /1   ]  833.270001287        1
[INPUT] 0    0    [1    /1   ]  235.752980548        1
[INPUT] 0    0    [1    /1   ]  76.2326644245        1
[INPUT] 0    0    [1    /1   ]  10.8643610584        1
[INPUT] 0    0    [1    /1   ]  27.7629699145        1
[INPUT] 0    0    [1    /1   ]  0.315273389121       1
[INPUT] 0    0    [1    /1   ]  1.87944096605        1
[INPUT] 0    0    [1    /1   ]  3.5888705605         1
[INPUT] 1    0    [1    /1   ]  3.68184981683        1
[INPUT] 1    0    [1    /1   ]  12.4427829174        1
[INPUT] 1    0    [1    /1   ]  54.7807941961        1
[INPUT] 1    0    [1    /1   ]  0.330415741719       1
[INPUT] 1    0    [1    /1   ]  1.14405322727        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7967827650506976, 1.0]], [0, [24413.794129218455, 1.0]], [0, [3661.454511248687, 1.0]], [0, [833.2700012869673, 1.0]], [0, [235.75298054788286, 1.0]], [0, [76.23266442453438, 1.0]], [0, [10.864361058380386, 1.0]], [0, [27.762969914523822, 1.0]], [0, [0.31527338912092273, 1.0]], [0, [1.879440966051095, 1.0]], [0, [3.588870560500846, 1.0]], [1, [3.6818498168284197, 1.0]], [1, [12.442782917402468, 1.0]], [1, [54.78079419609512, 1.0]], [1, [0.3304157417188525, 1.0]], [1, [1.1440532272722972, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79678277]
bas 1, expnt(s) = [24413.79412922]
bas 2, expnt(s) = [3661.45451125]
bas 3, expnt(s) = [833.27000129]
bas 4, expnt(s) = [235.75298055]
bas 5, expnt(s) = [76.23266442]
bas 6, expnt(s) = [10.86436106]
bas 7, expnt(s) = [27.76296991]
bas 8, expnt(s) = [0.31527339]
bas 9, expnt(s) = [1.87944097]
bas 10, expnt(s) = [3.58887056]
bas 11, expnt(s) = [3.68184982]
bas 12, expnt(s) = [12.44278292]
bas 13, expnt(s) = [54.7807942]
bas 14, expnt(s) = [0.33041574]
bas 15, expnt(s) = [1.14405323]
CPU time:       210.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.96782765e-01 2.13068855e+00 2.44137941e+04 4.93448102e+03
 3.66145451e+03 1.18920097e+03 8.33270001e+02 3.91836000e+02
 2.35752981e+02 1.52005016e+02 7.62326644e+01 6.51809744e+01
 1.08643611e+01 1.51188294e+01 2.77629699e+01 3.05572640e+01
 3.15273389e-01 1.06299326e+00 1.87944097e+00 4.05542656e+00
 3.58887056e+00 6.58769328e+00 3.68184982e+00 1.48787683e+01
 1.24427829e+01 6.81759656e+01 5.47807942e+01 4.34780240e+02
 3.30415742e-01 7.30819800e-01 1.14405323e+00 3.45177263e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998483723233502
cond(S) = 1508.7858936975376
E1 = -183.57821345696857  E_coul = 55.07852298398543
init E= -128.499690472983
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773940952349219  LUMO = 0.807752458808665
  mo_energy =
[-3.25554176e+01 -1.85290750e+00 -7.73940952e-01 -7.73940952e-01
 -7.73940952e-01  8.07752459e-01  1.11609157e+00  1.11609157e+00
  1.11609157e+00  4.22133910e+00  5.77621946e+00  5.77621946e+00
  5.77621946e+00  1.38073476e+01  2.41981769e+01  2.41981769e+01
  2.41981769e+01  4.52612573e+01  1.19077030e+02  1.19077030e+02
  1.19077030e+02  1.51843827e+02  5.15998651e+02  1.88253196e+03
  8.01082389e+03  4.77766859e+04]
E1 = -182.11219064105873  E_coul = 53.58315169806718
cycle= 1 E= -128.529038942992  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461373
diis-c [-0.21286495  1.        ]
  HOMO = -0.87951732855413  LUMO = 0.780755332766669
  mo_energy =
[-3.28738271e+01 -1.96308338e+00 -8.79517329e-01 -8.79517329e-01
 -8.79517329e-01  7.80755333e-01  1.07790316e+00  1.07790316e+00
  1.07790316e+00  4.14596192e+00  5.64744981e+00  5.64744981e+00
  5.64744981e+00  1.36573775e+01  2.39634491e+01  2.39634491e+01
  2.39634491e+01  4.50163080e+01  1.18756336e+02  1.18756336e+02
  1.18756336e+02  1.51531602e+02  5.15642052e+02  1.88213892e+03
  8.01040168e+03  4.77762448e+04]
E1 = -182.8436930386949  E_coul = 54.31215167913573
cycle= 2 E= -128.531541359559  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0683
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230391
diis-c [-6.45013207e-04  3.32028902e-01  6.67971098e-01]
  HOMO = -0.845184135577096  LUMO = 0.789543364180579
  mo_energy =
[-3.27688831e+01 -1.92698791e+00 -8.45184136e-01 -8.45184136e-01
 -8.45184136e-01  7.89543364e-01  1.09039030e+00  1.09039030e+00
  1.09039030e+00  4.17029337e+00  5.68932862e+00  5.68932862e+00
  5.68932862e+00  1.37063641e+01  2.40409336e+01  2.40409336e+01
  2.40409336e+01  4.50973893e+01  1.18861308e+02  1.18861308e+02
  1.18861308e+02  1.51634249e+02  5.15755453e+02  1.88225762e+03
  8.01052284e+03  4.77763668e+04]
E1 = -182.5984276179493  E_coul = 54.06604036596507
cycle= 3 E= -128.532387251984  delta_E= -0.000846  |g|= 0.000471  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000947831
diis-c [-1.55254091e-07 -2.21660091e-03 -6.97592774e-04  1.00291419e+00]
  HOMO = -0.845420782113798  LUMO = 0.789507211000292
  mo_energy =
[-3.27693002e+01 -1.92716026e+00 -8.45420782e-01 -8.45420782e-01
 -8.45420782e-01  7.89507211e-01  1.09033849e+00  1.09033849e+00
  1.09033849e+00  4.17016838e+00  5.68912220e+00  5.68912220e+00
  5.68912220e+00  1.37061304e+01  2.40406049e+01  2.40406049e+01
  2.40406049e+01  4.50970564e+01  1.18860879e+02  1.18860879e+02
  1.18860879e+02  1.51633833e+02  5.15754935e+02  1.88225699e+03
  8.01052212e+03  4.77763661e+04]
E1 = -182.5989388384196  E_coul = 54.06655156526669
cycle= 4 E= -128.532387273153  delta_E= -2.12e-08  |g|= 6.33e-05  |ddm|= 0.00033
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131436
diis-c [-1.00599400e-09  3.28587654e-04  4.22797595e-04 -2.14879566e-01
  1.21412818e+00]
  HOMO = -0.845452862748909  LUMO = 0.789500557766671
  mo_energy =
[-3.27693523e+01 -1.92717982e+00 -8.45452863e-01 -8.45452863e-01
 -8.45452863e-01  7.89500558e-01  1.09032495e+00  1.09032495e+00
  1.09032495e+00  4.17014760e+00  5.68908677e+00  5.68908677e+00
  5.68908677e+00  1.37060939e+01  2.40405578e+01  2.40405578e+01
  2.40405578e+01  4.50970095e+01  1.18860826e+02  1.18860826e+02
  1.18860826e+02  1.51633780e+02  5.15754875e+02  1.88225692e+03
  8.01052205e+03  4.77763660e+04]
E1 = -182.59904071790731  E_coul = 54.06665344421247
cycle= 5 E= -128.532387273695  delta_E= -5.42e-10  |g|= 6.76e-06  |ddm|= 5.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59904071790731  E_coul = 54.06665344421247
  HOMO = -0.845449133529622  LUMO = 0.789502008619923
  mo_energy =
[-3.27693441e+01 -1.92717538e+00 -8.45449134e-01 -8.45449134e-01
 -8.45449134e-01  7.89502009e-01  1.09032651e+00  1.09032651e+00
  1.09032651e+00  4.17015086e+00  5.68909129e+00  5.68909129e+00
  5.68909129e+00  1.37060992e+01  2.40405647e+01  2.40405647e+01
  2.40405647e+01  4.50970167e+01  1.18860834e+02  1.18860834e+02
  1.18860834e+02  1.51633788e+02  5.15754883e+02  1.88225693e+03
  8.01052205e+03  4.77763660e+04]
E1 = -182.59902277660606  E_coul = 54.06663550290847
Extra cycle  E= -128.532387273698  delta_E= -2.76e-12  |g|= 2.51e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [7.96782765e-01 2.44137941e+04 3.66145451e+03 8.33270001e+02
 2.35752981e+02 7.62326644e+01 1.08643611e+01 2.77629699e+01
 3.15273389e-01 1.87944097e+00 3.58887056e+00 3.68184982e+00
 1.24427829e+01 5.47807942e+01 3.30415742e-01 1.14405323e+00]
E = -128.5323872736976
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.796782765051       1
[INPUT] 0    0    [1    /1   ]  24413.7941292        1
[INPUT] 0    0    [1    /1   ]  3661.45451125        1
[INPUT] 0    0    [1    /1   ]  833.270001287        1
[INPUT] 0    0    [1    /1   ]  235.752980548        1
[INPUT] 0    0    [1    /1   ]  76.2326644245        1
[INPUT] 0    0    [1    /1   ]  10.8643610584        1
[INPUT] 0    0    [1    /1   ]  27.7629699145        1
[INPUT] 0    0    [1    /1   ]  0.315273389121       1
[INPUT] 0    0    [1    /1   ]  1.87944096605        1
[INPUT] 0    0    [1    /1   ]  3.5888705605         1
[INPUT] 1    0    [1    /1   ]  3.68184981683        1
[INPUT] 1    0    [1    /1   ]  12.4427829174        1
[INPUT] 1    0    [1    /1   ]  54.7807941961        1
[INPUT] 1    0    [1    /1   ]  0.330415741719       1
[INPUT] 1    0    [1    /1   ]  1.14405322727        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7967827650506976, 1.0]], [0, [24413.794129218455, 1.0]], [0, [3661.454511248687, 1.0]], [0, [833.2700012869673, 1.0]], [0, [235.75298054788286, 1.0]], [0, [76.23266442453438, 1.0]], [0, [10.864361058380386, 1.0]], [0, [27.762969914523822, 1.0]], [0, [0.31527338912092273, 1.0]], [0, [1.879440966051095, 1.0]], [0, [3.588870560500846, 1.0]], [1, [3.6818498168284197, 1.0]], [1, [12.442782917402468, 1.0]], [1, [54.78079419609512, 1.0]], [1, [0.3304157417188525, 1.0]], [1, [1.1440532272722972, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79678277]
bas 1, expnt(s) = [24413.79412922]
bas 2, expnt(s) = [3661.45451125]
bas 3, expnt(s) = [833.27000129]
bas 4, expnt(s) = [235.75298055]
bas 5, expnt(s) = [76.23266442]
bas 6, expnt(s) = [10.86436106]
bas 7, expnt(s) = [27.76296991]
bas 8, expnt(s) = [0.31527339]
bas 9, expnt(s) = [1.87944097]
bas 10, expnt(s) = [3.58887056]
bas 11, expnt(s) = [3.68184982]
bas 12, expnt(s) = [12.44278292]
bas 13, expnt(s) = [54.7807942]
bas 14, expnt(s) = [0.33041574]
bas 15, expnt(s) = [1.14405323]
CPU time:       211.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.96782765e-01 2.13068855e+00 2.44137941e+04 4.93448102e+03
 3.66145451e+03 1.18920097e+03 8.33270001e+02 3.91836000e+02
 2.35752981e+02 1.52005016e+02 7.62326644e+01 6.51809744e+01
 1.08643611e+01 1.51188294e+01 2.77629699e+01 3.05572640e+01
 3.15273389e-01 1.06299326e+00 1.87944097e+00 4.05542656e+00
 3.58887056e+00 6.58769328e+00 3.68184982e+00 1.48787683e+01
 1.24427829e+01 6.81759656e+01 5.47807942e+01 4.34780240e+02
 3.30415742e-01 7.30819800e-01 1.14405323e+00 3.45177263e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998483723233502
cond(S) = 1508.7858936975376
E1 = -183.57821345696857  E_coul = 55.07852298398543
init E= -128.499690472983
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773940952349219  LUMO = 0.807752458808665
  mo_energy =
[-3.25554176e+01 -1.85290750e+00 -7.73940952e-01 -7.73940952e-01
 -7.73940952e-01  8.07752459e-01  1.11609157e+00  1.11609157e+00
  1.11609157e+00  4.22133910e+00  5.77621946e+00  5.77621946e+00
  5.77621946e+00  1.38073476e+01  2.41981769e+01  2.41981769e+01
  2.41981769e+01  4.52612573e+01  1.19077030e+02  1.19077030e+02
  1.19077030e+02  1.51843827e+02  5.15998651e+02  1.88253196e+03
  8.01082389e+03  4.77766859e+04]
E1 = -182.11219064105873  E_coul = 53.58315169806718
cycle= 1 E= -128.529038942992  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461373
diis-c [-0.21286495  1.        ]
  HOMO = -0.87951732855413  LUMO = 0.780755332766669
  mo_energy =
[-3.28738271e+01 -1.96308338e+00 -8.79517329e-01 -8.79517329e-01
 -8.79517329e-01  7.80755333e-01  1.07790316e+00  1.07790316e+00
  1.07790316e+00  4.14596192e+00  5.64744981e+00  5.64744981e+00
  5.64744981e+00  1.36573775e+01  2.39634491e+01  2.39634491e+01
  2.39634491e+01  4.50163080e+01  1.18756336e+02  1.18756336e+02
  1.18756336e+02  1.51531602e+02  5.15642052e+02  1.88213892e+03
  8.01040168e+03  4.77762448e+04]
E1 = -182.8436930386949  E_coul = 54.31215167913573
cycle= 2 E= -128.531541359559  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0683
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230391
diis-c [-6.45013207e-04  3.32028902e-01  6.67971098e-01]
  HOMO = -0.845184135577096  LUMO = 0.789543364180579
  mo_energy =
[-3.27688831e+01 -1.92698791e+00 -8.45184136e-01 -8.45184136e-01
 -8.45184136e-01  7.89543364e-01  1.09039030e+00  1.09039030e+00
  1.09039030e+00  4.17029337e+00  5.68932862e+00  5.68932862e+00
  5.68932862e+00  1.37063641e+01  2.40409336e+01  2.40409336e+01
  2.40409336e+01  4.50973893e+01  1.18861308e+02  1.18861308e+02
  1.18861308e+02  1.51634249e+02  5.15755453e+02  1.88225762e+03
  8.01052284e+03  4.77763668e+04]
E1 = -182.5984276179493  E_coul = 54.06604036596507
cycle= 3 E= -128.532387251984  delta_E= -0.000846  |g|= 0.000471  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000947831
diis-c [-1.55254091e-07 -2.21660091e-03 -6.97592774e-04  1.00291419e+00]
  HOMO = -0.845420782113798  LUMO = 0.789507211000292
  mo_energy =
[-3.27693002e+01 -1.92716026e+00 -8.45420782e-01 -8.45420782e-01
 -8.45420782e-01  7.89507211e-01  1.09033849e+00  1.09033849e+00
  1.09033849e+00  4.17016838e+00  5.68912220e+00  5.68912220e+00
  5.68912220e+00  1.37061304e+01  2.40406049e+01  2.40406049e+01
  2.40406049e+01  4.50970564e+01  1.18860879e+02  1.18860879e+02
  1.18860879e+02  1.51633833e+02  5.15754935e+02  1.88225699e+03
  8.01052212e+03  4.77763661e+04]
E1 = -182.5989388384196  E_coul = 54.06655156526669
cycle= 4 E= -128.532387273153  delta_E= -2.12e-08  |g|= 6.33e-05  |ddm|= 0.00033
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131436
diis-c [-1.00599400e-09  3.28587654e-04  4.22797595e-04 -2.14879566e-01
  1.21412818e+00]
  HOMO = -0.845452862748909  LUMO = 0.789500557766671
  mo_energy =
[-3.27693523e+01 -1.92717982e+00 -8.45452863e-01 -8.45452863e-01
 -8.45452863e-01  7.89500558e-01  1.09032495e+00  1.09032495e+00
  1.09032495e+00  4.17014760e+00  5.68908677e+00  5.68908677e+00
  5.68908677e+00  1.37060939e+01  2.40405578e+01  2.40405578e+01
  2.40405578e+01  4.50970095e+01  1.18860826e+02  1.18860826e+02
  1.18860826e+02  1.51633780e+02  5.15754875e+02  1.88225692e+03
  8.01052205e+03  4.77763660e+04]
E1 = -182.59904071790731  E_coul = 54.06665344421247
cycle= 5 E= -128.532387273695  delta_E= -5.42e-10  |g|= 6.76e-06  |ddm|= 5.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59904071790731  E_coul = 54.06665344421247
  HOMO = -0.845449133529622  LUMO = 0.789502008619923
  mo_energy =
[-3.27693441e+01 -1.92717538e+00 -8.45449134e-01 -8.45449134e-01
 -8.45449134e-01  7.89502009e-01  1.09032651e+00  1.09032651e+00
  1.09032651e+00  4.17015086e+00  5.68909129e+00  5.68909129e+00
  5.68909129e+00  1.37060992e+01  2.40405647e+01  2.40405647e+01
  2.40405647e+01  4.50970167e+01  1.18860834e+02  1.18860834e+02
  1.18860834e+02  1.51633788e+02  5.15754883e+02  1.88225693e+03
  8.01052205e+03  4.77763660e+04]
E1 = -182.59902277660606  E_coul = 54.06663550290847
Extra cycle  E= -128.532387273698  delta_E= -2.76e-12  |g|= 2.51e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1508.7858936975376
E1 = -182.59902277660606  E_coul = 54.06663550290847
init E= -128.532387273698
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845450387395059  LUMO = 0.789501754498663
  mo_energy =
[-3.27693481e+01 -1.92717659e+00 -8.45450387e-01 -8.45450387e-01
 -8.45450387e-01  7.89501754e-01  1.09032607e+00  1.09032607e+00
  1.09032607e+00  4.17015006e+00  5.68908977e+00  5.68908977e+00
  5.68908977e+00  1.37060975e+01  2.40405618e+01  2.40405618e+01
  2.40405618e+01  4.50970137e+01  1.18860830e+02  1.18860830e+02
  1.18860830e+02  1.51633784e+02  5.15754878e+02  1.88225692e+03
  8.01052205e+03  4.77763660e+04]
E1 = -182.59903243873072  E_coul = 54.06664516503259
cycle= 1 E= -128.532387273698  delta_E= -5.4e-13  |g|= 1.32e-06  |ddm|= 9.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59903243873072  E_coul = 54.06664516503259
  HOMO = -0.845449707957919  LUMO = 0.789501939912671
  mo_energy =
[-3.27693461e+01 -1.92717585e+00 -8.45449708e-01 -8.45449708e-01
 -8.45449708e-01  7.89501940e-01  1.09032632e+00  1.09032632e+00
  1.09032632e+00  4.17015055e+00  5.68909060e+00  5.68909060e+00
  5.68909060e+00  1.37060985e+01  2.40405634e+01  2.40405634e+01
  2.40405634e+01  4.50970153e+01  1.18860832e+02  1.18860832e+02
  1.18860832e+02  1.51633786e+02  5.15754880e+02  1.88225693e+03
  8.01052205e+03  4.77763660e+04]
E1 = -182.59902763880575  E_coul = 54.066640365107695
Extra cycle  E= -128.532387273698  delta_E= 8.53e-14  |g|= 6.53e-07  |ddm|= 4.58e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [7.96782765e-01 2.44137941e+04 3.66145451e+03 8.33270001e+02
 2.35752981e+02 7.62326644e+01 1.08643611e+01 2.77629699e+01
 3.15273389e-01 1.87944097e+00 3.58887056e+00 3.68184982e+00
 1.24427829e+01 5.47807942e+01 3.30415742e-01 1.14405323e+00]
grad_E = [ 8.76225249e-05 -1.82655151e-09  9.52300044e-08 -1.79214695e-06
  1.73514631e-05 -6.79029140e-05  2.97260493e-05  4.38790722e-06
  5.29517116e-04 -9.75565532e-05 -1.00538326e-04 -2.04014988e-04
  1.98534758e-05  3.89227687e-07  4.66606928e-04  4.17860747e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.792458264501       1
[INPUT] 0    0    [1    /1   ]  24413.7941312        1
[INPUT] 0    0    [1    /1   ]  3661.45440803        1
[INPUT] 0    0    [1    /1   ]  833.27193314         1
[INPUT] 0    0    [1    /1   ]  235.734362551        1
[INPUT] 0    0    [1    /1   ]  76.3044672155        1
[INPUT] 0    0    [1    /1   ]  10.8690536278        1
[INPUT] 0    0    [1    /1   ]  27.7492730271        1
[INPUT] 0    0    [1    /1   ]  0.316840151564       1
[INPUT] 0    0    [1    /1   ]  1.85694423295        1
[INPUT] 0    0    [1    /1   ]  3.70826724084        1
[INPUT] 1    0    [1    /1   ]  3.67600859553        1
[INPUT] 1    0    [1    /1   ]  12.4235802311        1
[INPUT] 1    0    [1    /1   ]  54.7831745165        1
[INPUT] 1    0    [1    /1   ]  0.330337663947       1
[INPUT] 1    0    [1    /1   ]  1.14305779153        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7924582645014734, 1.0]], [0, [24413.79413119718, 1.0]], [0, [3661.454408026554, 1.0]], [0, [833.2719331397474, 1.0]], [0, [235.73436255119728, 1.0]], [0, [76.30446721553261, 1.0]], [0, [10.869053627791086, 1.0]], [0, [27.749273027058887, 1.0]], [0, [0.31684015156404693, 1.0]], [0, [1.8569442329452266, 1.0]], [0, [3.7082672408381514, 1.0]], [1, [3.6760085955328985, 1.0]], [1, [12.423580231105829, 1.0]], [1, [54.7831745165238, 1.0]], [1, [0.33033766394707353, 1.0]], [1, [1.143057791528628, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79245826]
bas 1, expnt(s) = [24413.7941312]
bas 2, expnt(s) = [3661.45440803]
bas 3, expnt(s) = [833.27193314]
bas 4, expnt(s) = [235.73436255]
bas 5, expnt(s) = [76.30446722]
bas 6, expnt(s) = [10.86905363]
bas 7, expnt(s) = [27.74927303]
bas 8, expnt(s) = [0.31684015]
bas 9, expnt(s) = [1.85694423]
bas 10, expnt(s) = [3.70826724]
bas 11, expnt(s) = [3.6760086]
bas 12, expnt(s) = [12.42358023]
bas 13, expnt(s) = [54.78317452]
bas 14, expnt(s) = [0.33033766]
bas 15, expnt(s) = [1.14305779]
CPU time:       214.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.92458265e-01 2.12200950e+00 2.44137941e+04 4.93448102e+03
 3.66145441e+03 1.18920095e+03 8.33271933e+02 3.91836681e+02
 2.35734363e+02 1.51996012e+02 7.63044672e+01 6.52270140e+01
 1.08690536e+01 1.51237268e+01 2.77492730e+01 3.05459567e+01
 3.16840152e-01 1.06695274e+00 1.85694423e+00 4.01896450e+00
 3.70826724e+00 6.75139150e+00 3.67600860e+00 1.48492678e+01
 1.24235802e+01 6.80444728e+01 5.47831745e+01 4.34803855e+02
 3.30337664e-01 7.30603939e-01 1.14305779e+00 3.44801882e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486811324243
cond(S) = 1410.3410729002712
E1 = -183.57821099242943  E_coul = 55.07852761264594
init E= -128.499683379784
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77393971912555  LUMO = 0.80964127520452
  mo_energy =
[-3.25554271e+01 -1.85290483e+00 -7.73939719e-01 -7.73939719e-01
 -7.73939719e-01  8.09641275e-01  1.11553618e+00  1.11553618e+00
  1.11553618e+00  4.21882500e+00  5.76962474e+00  5.76962474e+00
  5.76962474e+00  1.39123716e+01  2.41574515e+01  2.41574515e+01
  2.41574515e+01  4.55772183e+01  1.19000312e+02  1.19000312e+02
  1.19000312e+02  1.52251043e+02  5.16489283e+02  1.88302628e+03
  8.01126649e+03  4.77770538e+04]
E1 = -182.11232905682573  E_coul = 53.58327870370729
cycle= 1 E= -128.529050353118  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461483
diis-c [-0.21296674  1.        ]
  HOMO = -0.879501512831254  LUMO = 0.782634960696214
  mo_energy =
[-3.28738272e+01 -1.96307261e+00 -8.79501513e-01 -8.79501513e-01
 -8.79501513e-01  7.82634961e-01  1.07738650e+00  1.07738650e+00
  1.07738650e+00  4.14329397e+00  5.64099602e+00  5.64099602e+00
  5.64099602e+00  1.37613169e+01  2.39228686e+01  2.39228686e+01
  2.39228686e+01  4.53319718e+01  1.18679622e+02  1.18679622e+02
  1.18679622e+02  1.51938827e+02  5.16132689e+02  1.88263324e+03
  8.01084427e+03  4.77766127e+04]
E1 = -182.8437968777441  E_coul = 54.31224438028937
cycle= 2 E= -128.531552497455  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0684
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.230469
diis-c [-6.46526762e-04  3.32048810e-01  6.67951190e-01]
  HOMO = -0.845170857781344  LUMO = 0.791425262283091
  mo_energy =
[-3.27688919e+01 -1.92697969e+00 -8.45170858e-01 -8.45170858e-01
 -8.45170858e-01  7.91425262e-01  1.08986194e+00  1.08986194e+00
  1.08986194e+00  4.16767807e+00  5.68282969e+00  5.68282969e+00
  5.68282969e+00  1.38106685e+01  2.40003044e+01  2.40003044e+01
  2.40003044e+01  4.54131516e+01  1.18784586e+02  1.18784586e+02
  1.18784586e+02  1.52041463e+02  5.16246078e+02  1.88275193e+03
  8.01096542e+03  4.77767348e+04]
E1 = -182.59855571238054  E_coul = 54.06615742124154
cycle= 3 E= -128.532398291139  delta_E= -0.000846  |g|= 0.000467  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000939233
diis-c [-1.51789135e-07 -2.20931734e-03 -7.16535357e-04  1.00292585e+00]
  HOMO = -0.845405925301404  LUMO = 0.791389353988043
  mo_energy =
[-3.27693052e+01 -1.92715091e+00 -8.45405925e-01 -8.45405925e-01
 -8.45405925e-01  7.91389354e-01  1.08981080e+00  1.08981080e+00
  1.08981080e+00  4.16755394e+00  5.68262520e+00  5.68262520e+00
  5.68262520e+00  1.38104355e+01  2.39999788e+01  2.39999788e+01
  2.39999788e+01  4.54128214e+01  1.18784161e+02  1.18784161e+02
  1.18784161e+02  1.52041050e+02  5.16245564e+02  1.88275130e+03
  8.01096471e+03  4.77767340e+04]
E1 = -182.5990590017643  E_coul = 54.06666068983264
cycle= 4 E= -128.532398311932  delta_E= -2.08e-08  |g|= 6.3e-05  |ddm|= 0.000326
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130888
diis-c [-9.98839453e-10  3.25874269e-04  4.27340106e-04 -2.13990589e-01
  1.21323737e+00]
  HOMO = -0.845437917151035  LUMO = 0.791382672124622
  mo_energy =
[-3.27693572e+01 -1.92717053e+00 -8.45437917e-01 -8.45437917e-01
 -8.45437917e-01  7.91382672e-01  1.08979730e+00  1.08979730e+00
  1.08979730e+00  4.16753315e+00  5.68258986e+00  5.68258986e+00
  5.68258986e+00  1.38103989e+01  2.39999317e+01  2.39999317e+01
  2.39999317e+01  4.54127745e+01  1.18784108e+02  1.18784108e+02
  1.18784108e+02  1.52040998e+02  5.16245504e+02  1.88275123e+03
  8.01096463e+03  4.77767339e+04]
E1 = -182.59916085357327  E_coul = 54.066762541106826
cycle= 5 E= -128.532398312466  delta_E= -5.35e-10  |g|= 6.72e-06  |ddm|= 5.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59916085357327  E_coul = 54.066762541106826
  HOMO = -0.845434214197911  LUMO = 0.791384114991083
  mo_energy =
[-3.27693491e+01 -1.92716612e+00 -8.45434214e-01 -8.45434214e-01
 -8.45434214e-01  7.91384115e-01  1.08979885e+00  1.08979885e+00
  1.08979885e+00  4.16753639e+00  5.68259436e+00  5.68259436e+00
  5.68259436e+00  1.38104043e+01  2.39999387e+01  2.39999387e+01
  2.39999387e+01  4.54127817e+01  1.18784116e+02  1.18784116e+02
  1.18784116e+02  1.52041006e+02  5.16245512e+02  1.88275124e+03
  8.01096464e+03  4.77767340e+04]
E1 = -182.5991430018643  E_coul = 54.0667446893955
Extra cycle  E= -128.532398312469  delta_E= -2.33e-12  |g|= 2.5e-06  |ddm|= 2.5e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [7.92458265e-01 2.44137941e+04 3.66145441e+03 8.33271933e+02
 2.35734363e+02 7.63044672e+01 1.08690536e+01 2.77492730e+01
 3.16840152e-01 1.85694423e+00 3.70826724e+00 3.67600860e+00
 1.24235802e+01 5.47831745e+01 3.30337664e-01 1.14305779e+00]
E = -128.53239831246879
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.792458264501       1
[INPUT] 0    0    [1    /1   ]  24413.7941312        1
[INPUT] 0    0    [1    /1   ]  3661.45440803        1
[INPUT] 0    0    [1    /1   ]  833.27193314         1
[INPUT] 0    0    [1    /1   ]  235.734362551        1
[INPUT] 0    0    [1    /1   ]  76.3044672155        1
[INPUT] 0    0    [1    /1   ]  10.8690536278        1
[INPUT] 0    0    [1    /1   ]  27.7492730271        1
[INPUT] 0    0    [1    /1   ]  0.316840151564       1
[INPUT] 0    0    [1    /1   ]  1.85694423295        1
[INPUT] 0    0    [1    /1   ]  3.70826724084        1
[INPUT] 1    0    [1    /1   ]  3.67600859553        1
[INPUT] 1    0    [1    /1   ]  12.4235802311        1
[INPUT] 1    0    [1    /1   ]  54.7831745165        1
[INPUT] 1    0    [1    /1   ]  0.330337663947       1
[INPUT] 1    0    [1    /1   ]  1.14305779153        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7924582645014734, 1.0]], [0, [24413.79413119718, 1.0]], [0, [3661.454408026554, 1.0]], [0, [833.2719331397474, 1.0]], [0, [235.73436255119728, 1.0]], [0, [76.30446721553261, 1.0]], [0, [10.869053627791086, 1.0]], [0, [27.749273027058887, 1.0]], [0, [0.31684015156404693, 1.0]], [0, [1.8569442329452266, 1.0]], [0, [3.7082672408381514, 1.0]], [1, [3.6760085955328985, 1.0]], [1, [12.423580231105829, 1.0]], [1, [54.7831745165238, 1.0]], [1, [0.33033766394707353, 1.0]], [1, [1.143057791528628, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79245826]
bas 1, expnt(s) = [24413.7941312]
bas 2, expnt(s) = [3661.45440803]
bas 3, expnt(s) = [833.27193314]
bas 4, expnt(s) = [235.73436255]
bas 5, expnt(s) = [76.30446722]
bas 6, expnt(s) = [10.86905363]
bas 7, expnt(s) = [27.74927303]
bas 8, expnt(s) = [0.31684015]
bas 9, expnt(s) = [1.85694423]
bas 10, expnt(s) = [3.70826724]
bas 11, expnt(s) = [3.6760086]
bas 12, expnt(s) = [12.42358023]
bas 13, expnt(s) = [54.78317452]
bas 14, expnt(s) = [0.33033766]
bas 15, expnt(s) = [1.14305779]
CPU time:       215.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.92458265e-01 2.12200950e+00 2.44137941e+04 4.93448102e+03
 3.66145441e+03 1.18920095e+03 8.33271933e+02 3.91836681e+02
 2.35734363e+02 1.51996012e+02 7.63044672e+01 6.52270140e+01
 1.08690536e+01 1.51237268e+01 2.77492730e+01 3.05459567e+01
 3.16840152e-01 1.06695274e+00 1.85694423e+00 4.01896450e+00
 3.70826724e+00 6.75139150e+00 3.67600860e+00 1.48492678e+01
 1.24235802e+01 6.80444728e+01 5.47831745e+01 4.34803855e+02
 3.30337664e-01 7.30603939e-01 1.14305779e+00 3.44801882e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998486811324243
cond(S) = 1410.3410729002712
E1 = -183.57821099242943  E_coul = 55.07852761264594
init E= -128.499683379784
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77393971912555  LUMO = 0.80964127520452
  mo_energy =
[-3.25554271e+01 -1.85290483e+00 -7.73939719e-01 -7.73939719e-01
 -7.73939719e-01  8.09641275e-01  1.11553618e+00  1.11553618e+00
  1.11553618e+00  4.21882500e+00  5.76962474e+00  5.76962474e+00
  5.76962474e+00  1.39123716e+01  2.41574515e+01  2.41574515e+01
  2.41574515e+01  4.55772183e+01  1.19000312e+02  1.19000312e+02
  1.19000312e+02  1.52251043e+02  5.16489283e+02  1.88302628e+03
  8.01126649e+03  4.77770538e+04]
E1 = -182.11232905682573  E_coul = 53.58327870370729
cycle= 1 E= -128.529050353118  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.161
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461483
diis-c [-0.21296674  1.        ]
  HOMO = -0.879501512831254  LUMO = 0.782634960696214
  mo_energy =
[-3.28738272e+01 -1.96307261e+00 -8.79501513e-01 -8.79501513e-01
 -8.79501513e-01  7.82634961e-01  1.07738650e+00  1.07738650e+00
  1.07738650e+00  4.14329397e+00  5.64099602e+00  5.64099602e+00
  5.64099602e+00  1.37613169e+01  2.39228686e+01  2.39228686e+01
  2.39228686e+01  4.53319718e+01  1.18679622e+02  1.18679622e+02
  1.18679622e+02  1.51938827e+02  5.16132689e+02  1.88263324e+03
  8.01084427e+03  4.77766127e+04]
E1 = -182.8437968777441  E_coul = 54.31224438028937
cycle= 2 E= -128.531552497455  delta_E= -0.0025  |g|= 0.0999  |ddm|= 0.0684
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230469
diis-c [-6.46526762e-04  3.32048810e-01  6.67951190e-01]
  HOMO = -0.845170857781344  LUMO = 0.791425262283091
  mo_energy =
[-3.27688919e+01 -1.92697969e+00 -8.45170858e-01 -8.45170858e-01
 -8.45170858e-01  7.91425262e-01  1.08986194e+00  1.08986194e+00
  1.08986194e+00  4.16767807e+00  5.68282969e+00  5.68282969e+00
  5.68282969e+00  1.38106685e+01  2.40003044e+01  2.40003044e+01
  2.40003044e+01  4.54131516e+01  1.18784586e+02  1.18784586e+02
  1.18784586e+02  1.52041463e+02  5.16246078e+02  1.88275193e+03
  8.01096542e+03  4.77767348e+04]
E1 = -182.59855571238054  E_coul = 54.06615742124154
cycle= 3 E= -128.532398291139  delta_E= -0.000846  |g|= 0.000467  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000939233
diis-c [-1.51789135e-07 -2.20931734e-03 -7.16535357e-04  1.00292585e+00]
  HOMO = -0.845405925301404  LUMO = 0.791389353988043
  mo_energy =
[-3.27693052e+01 -1.92715091e+00 -8.45405925e-01 -8.45405925e-01
 -8.45405925e-01  7.91389354e-01  1.08981080e+00  1.08981080e+00
  1.08981080e+00  4.16755394e+00  5.68262520e+00  5.68262520e+00
  5.68262520e+00  1.38104355e+01  2.39999788e+01  2.39999788e+01
  2.39999788e+01  4.54128214e+01  1.18784161e+02  1.18784161e+02
  1.18784161e+02  1.52041050e+02  5.16245564e+02  1.88275130e+03
  8.01096471e+03  4.77767340e+04]
E1 = -182.5990590017643  E_coul = 54.06666068983264
cycle= 4 E= -128.532398311932  delta_E= -2.08e-08  |g|= 6.3e-05  |ddm|= 0.000326
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130888
diis-c [-9.98839453e-10  3.25874269e-04  4.27340106e-04 -2.13990589e-01
  1.21323737e+00]
  HOMO = -0.845437917151035  LUMO = 0.791382672124622
  mo_energy =
[-3.27693572e+01 -1.92717053e+00 -8.45437917e-01 -8.45437917e-01
 -8.45437917e-01  7.91382672e-01  1.08979730e+00  1.08979730e+00
  1.08979730e+00  4.16753315e+00  5.68258986e+00  5.68258986e+00
  5.68258986e+00  1.38103989e+01  2.39999317e+01  2.39999317e+01
  2.39999317e+01  4.54127745e+01  1.18784108e+02  1.18784108e+02
  1.18784108e+02  1.52040998e+02  5.16245504e+02  1.88275123e+03
  8.01096463e+03  4.77767339e+04]
E1 = -182.59916085357327  E_coul = 54.066762541106826
cycle= 5 E= -128.532398312466  delta_E= -5.35e-10  |g|= 6.72e-06  |ddm|= 5.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59916085357327  E_coul = 54.066762541106826
  HOMO = -0.845434214197911  LUMO = 0.791384114991083
  mo_energy =
[-3.27693491e+01 -1.92716612e+00 -8.45434214e-01 -8.45434214e-01
 -8.45434214e-01  7.91384115e-01  1.08979885e+00  1.08979885e+00
  1.08979885e+00  4.16753639e+00  5.68259436e+00  5.68259436e+00
  5.68259436e+00  1.38104043e+01  2.39999387e+01  2.39999387e+01
  2.39999387e+01  4.54127817e+01  1.18784116e+02  1.18784116e+02
  1.18784116e+02  1.52041006e+02  5.16245512e+02  1.88275124e+03
  8.01096464e+03  4.77767340e+04]
E1 = -182.5991430018643  E_coul = 54.0667446893955
Extra cycle  E= -128.532398312469  delta_E= -2.33e-12  |g|= 2.5e-06  |ddm|= 2.5e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1410.3410729002712
E1 = -182.5991430018643  E_coul = 54.0667446893955
init E= -128.532398312469
    CPU time for initialize scf      0.26 sec, wall time      0.25 sec
  HOMO = -0.845435462222122  LUMO = 0.791383862204702
  mo_energy =
[-3.27693531e+01 -1.92716732e+00 -8.45435462e-01 -8.45435462e-01
 -8.45435462e-01  7.91383862e-01  1.08979842e+00  1.08979842e+00
  1.08979842e+00  4.16753559e+00  5.68259284e+00  5.68259284e+00
  5.68259284e+00  1.38104025e+01  2.39999358e+01  2.39999358e+01
  2.39999358e+01  4.54127786e+01  1.18784112e+02  1.18784112e+02
  1.18784112e+02  1.52041002e+02  5.16245508e+02  1.88275124e+03
  8.01096464e+03  4.77767339e+04]
E1 = -182.59915261252058  E_coul = 54.066754300051414
cycle= 1 E= -128.532398312469  delta_E= -3.98e-13  |g|= 1.32e-06  |ddm|= 9.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59915261252058  E_coul = 54.066754300051414
  HOMO = -0.845434786475438  LUMO = 0.791384046751953
  mo_energy =
[-3.27693511e+01 -1.92716659e+00 -8.45434786e-01 -8.45434786e-01
 -8.45434786e-01  7.91384047e-01  1.08979867e+00  1.08979867e+00
  1.08979867e+00  4.16753609e+00  5.68259366e+00  5.68259366e+00
  5.68259366e+00  1.38104035e+01  2.39999373e+01  2.39999373e+01
  2.39999373e+01  4.54127802e+01  1.18784114e+02  1.18784114e+02
  1.18784114e+02  1.52041004e+02  5.16245510e+02  1.88275124e+03
  8.01096464e+03  4.77767339e+04]
E1 = -182.5991478380156  E_coul = 54.06674952554595
Extra cycle  E= -128.53239831247  delta_E= -4.55e-13  |g|= 6.5e-07  |ddm|= 4.56e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [7.92458265e-01 2.44137941e+04 3.66145441e+03 8.33271933e+02
 2.35734363e+02 7.63044672e+01 1.08690536e+01 2.77492730e+01
 3.16840152e-01 1.85694423e+00 3.70826724e+00 3.67600860e+00
 1.24235802e+01 5.47831745e+01 3.30337664e-01 1.14305779e+00]
grad_E = [ 6.43828591e-05 -1.47951744e-09  7.71433347e-08 -1.45706763e-06
  1.41030461e-05 -5.36008361e-05  2.46451980e-05 -1.80219699e-05
  8.53458223e-04 -1.21793378e-04 -7.64101135e-05 -3.10561089e-04
 -6.97394131e-08  5.00628209e-06  6.47532789e-04  6.27479268e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.788207465458       1
[INPUT] 0    0    [1    /1   ]  24413.7941347        1
[INPUT] 0    0    [1    /1   ]  3661.45422796        1
[INPUT] 0    0    [1    /1   ]  833.275270748        1
[INPUT] 0    0    [1    /1   ]  235.703125581        1
[INPUT] 0    0    [1    /1   ]  76.4097245405        1
[INPUT] 0    0    [1    /1   ]  10.9640221886        1
[INPUT] 0    0    [1    /1   ]  27.8104081133        1
[INPUT] 0    0    [1    /1   ]  0.316942864697       1
[INPUT] 0    0    [1    /1   ]  1.86828236527        1
[INPUT] 0    0    [1    /1   ]  4.00096425265        1
[INPUT] 1    0    [1    /1   ]  3.66531228079        1
[INPUT] 1    0    [1    /1   ]  12.3891785461        1
[INPUT] 1    0    [1    /1   ]  54.7868275387        1
[INPUT] 1    0    [1    /1   ]  0.329914879093       1
[INPUT] 1    0    [1    /1   ]  1.14059377531        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.788207465457581, 1.0]], [0, [24413.794134651176, 1.0]], [0, [3661.4542279584666, 1.0]], [0, [833.2752707476494, 1.0]], [0, [235.70312558053612, 1.0]], [0, [76.40972454045978, 1.0]], [0, [10.96402218860248, 1.0]], [0, [27.810408113340788, 1.0]], [0, [0.3169428646974856, 1.0]], [0, [1.868282365273102, 1.0]], [0, [4.000964252646473, 1.0]], [1, [3.6653122807870586, 1.0]], [1, [12.389178546117098, 1.0]], [1, [54.78682753870253, 1.0]], [1, [0.32991487909259587, 1.0]], [1, [1.1405937753060433, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78820747]
bas 1, expnt(s) = [24413.79413465]
bas 2, expnt(s) = [3661.45422796]
bas 3, expnt(s) = [833.27527075]
bas 4, expnt(s) = [235.70312558]
bas 5, expnt(s) = [76.40972454]
bas 6, expnt(s) = [10.96402219]
bas 7, expnt(s) = [27.81040811]
bas 8, expnt(s) = [0.31694286]
bas 9, expnt(s) = [1.86828237]
bas 10, expnt(s) = [4.00096425]
bas 11, expnt(s) = [3.66531228]
bas 12, expnt(s) = [12.38917855]
bas 13, expnt(s) = [54.78682754]
bas 14, expnt(s) = [0.32991488]
bas 15, expnt(s) = [1.14059378]
CPU time:       219.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.88207465e-01 2.11346681e+00 2.44137941e+04 4.93448102e+03
 3.66145423e+03 1.18920091e+03 8.33275271e+02 3.91837859e+02
 2.35703126e+02 1.51980906e+02 7.64097245e+01 6.52944848e+01
 1.09640222e+01 1.52227268e+01 2.78104081e+01 3.05964152e+01
 3.16942865e-01 1.06721214e+00 1.86828237e+00 4.03735474e+00
 4.00096425e+00 7.14724266e+00 3.66531228e+00 1.47952777e+01
 1.23891785e+01 6.78090301e+01 5.47868275e+01 4.34840097e+02
 3.29914879e-01 7.29435290e-01 1.14059378e+00 3.43873049e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998499043416826
cond(S) = 1291.3877155333162
E1 = -183.57822138412476  E_coul = 55.078517674965475
init E= -128.499703709159
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773939461507138  LUMO = 0.812173721023131
  mo_energy =
[-3.25554468e+01 -1.85290330e+00 -7.73939462e-01 -7.73939462e-01
 -7.73939462e-01  8.12173721e-01  1.11345481e+00  1.11345481e+00
  1.11345481e+00  4.26136766e+00  5.75475611e+00  5.75475611e+00
  5.75475611e+00  1.43643972e+01  2.40806590e+01  2.40806590e+01
  2.40806590e+01  4.68008427e+01  1.18858968e+02  1.18858968e+02
  1.18858968e+02  1.53974197e+02  5.18432944e+02  1.88489927e+03
  8.01293471e+03  4.77784390e+04]
E1 = -182.11187418920392  E_coul = 53.58280497662015
cycle= 1 E= -128.529069212584  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461873
diis-c [-0.2133263  1.       ]
  HOMO = -0.879530829922518  LUMO = 0.785028112988842
  mo_energy =
[-3.28739466e+01 -1.96311331e+00 -8.79530830e-01 -8.79530830e-01
 -8.79530830e-01  7.85028113e-01  1.07538657e+00  1.07538657e+00
  1.07538657e+00  4.18431923e+00  5.62632989e+00  5.62632989e+00
  5.62632989e+00  1.42096759e+01  2.38462310e+01  2.38462310e+01
  2.38462310e+01  4.65543610e+01  1.18538171e+02  1.18538171e+02
  1.18538171e+02  1.53661850e+02  5.18076267e+02  1.88450611e+03
  8.01251236e+03  4.77779978e+04]
E1 = -182.84368215487763  E_coul = 54.31210940295107
cycle= 2 E= -128.531572751927  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230757
diis-c [-6.52827866e-04  3.32132143e-01  6.67867857e-01]
  HOMO = -0.84518744541754  LUMO = 0.793860257308334
  mo_energy =
[-3.27689800e+01 -1.92700669e+00 -8.45187445e-01 -8.45187445e-01
 -8.45187445e-01  7.93860257e-01  1.08783644e+00  1.08783644e+00
  1.08783644e+00  4.20920021e+00  5.66809815e+00  5.66809815e+00
  5.66809815e+00  1.42602581e+01  2.39236168e+01  2.39236168e+01
  2.39236168e+01  4.66359555e+01  1.18643168e+02  1.18643168e+02
  1.18643168e+02  1.53764520e+02  5.18189677e+02  1.88462483e+03
  8.01263354e+03  4.77781199e+04]
E1 = -182.59833247392257  E_coul = 54.06591314775249
cycle= 3 E= -128.53241932617  delta_E= -0.000847  |g|= 0.000459  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000919746
diis-c [-1.46899496e-07 -2.19940268e-03 -7.81284115e-04  1.00298069e+00]
  HOMO = -0.845419103520042  LUMO = 0.793824892274299
  mo_energy =
[-3.27693843e+01 -1.92717504e+00 -8.45419104e-01 -8.45419104e-01
 -8.45419104e-01  7.93824892e-01  1.08778683e+00  1.08778683e+00
  1.08778683e+00  4.20907642e+00  5.66789795e+00  5.66789795e+00
  5.66789795e+00  1.42600255e+01  2.39232983e+01  2.39232983e+01
  2.39232983e+01  4.66356310e+01  1.18642752e+02  1.18642752e+02
  1.18642752e+02  1.53764117e+02  5.18189173e+02  1.88462422e+03
  8.01263284e+03  4.77781191e+04]
E1 = -182.59881552382666  E_coul = 54.06639617757285
cycle= 4 E= -128.532419346254  delta_E= -2.01e-08  |g|= 6.26e-05  |ddm|= 0.000316
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130213
diis-c [-9.92672850e-10  3.21357124e-04  4.40371027e-04 -2.12734771e-01
  1.21197304e+00]
  HOMO = -0.845450995552452  LUMO = 0.793818135034528
  mo_energy =
[-3.27694363e+01 -1.92719476e+00 -8.45450996e-01 -8.45450996e-01
 -8.45450996e-01  7.93818135e-01  1.08777341e+00  1.08777341e+00
  1.08777341e+00  4.20905532e+00  5.66786272e+00  5.66786272e+00
  5.66786272e+00  1.42599883e+01  2.39232513e+01  2.39232513e+01
  2.39232513e+01  4.66355840e+01  1.18642699e+02  1.18642699e+02
  1.18642699e+02  1.53764064e+02  5.18189113e+02  1.88462415e+03
  8.01263277e+03  4.77781190e+04]
E1 = -182.5989174714793  E_coul = 54.06649812470121
cycle= 5 E= -128.532419346778  delta_E= -5.24e-10  |g|= 6.68e-06  |ddm|= 5.51e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5989174714793  E_coul = 54.06649812470121
  HOMO = -0.845447322883301  LUMO = 0.793819574495286
  mo_energy =
[-3.27694283e+01 -1.92719038e+00 -8.45447323e-01 -8.45447323e-01
 -8.45447323e-01  7.93819574e-01  1.08777495e+00  1.08777495e+00
  1.08777495e+00  4.20905859e+00  5.66786717e+00  5.66786717e+00
  5.66786717e+00  1.42599937e+01  2.39232582e+01  2.39232582e+01
  2.39232582e+01  4.66355912e+01  1.18642707e+02  1.18642707e+02
  1.18642707e+02  1.53764072e+02  5.18189121e+02  1.88462416e+03
  8.01263278e+03  4.77781191e+04]
E1 = -182.59889970667865  E_coul = 54.06648035989784
Extra cycle  E= -128.532419346781  delta_E= -2.73e-12  |g|= 2.48e-06  |ddm|= 2.44e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [7.88207465e-01 2.44137941e+04 3.66145423e+03 8.33275271e+02
 2.35703126e+02 7.64097245e+01 1.09640222e+01 2.78104081e+01
 3.16942865e-01 1.86828237e+00 4.00096425e+00 3.66531228e+00
 1.23891785e+01 5.47868275e+01 3.29914879e-01 1.14059378e+00]
E = -128.5324193467808
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:00:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.788207465458       1
[INPUT] 0    0    [1    /1   ]  24413.7941347        1
[INPUT] 0    0    [1    /1   ]  3661.45422796        1
[INPUT] 0    0    [1    /1   ]  833.275270748        1
[INPUT] 0    0    [1    /1   ]  235.703125581        1
[INPUT] 0    0    [1    /1   ]  76.4097245405        1
[INPUT] 0    0    [1    /1   ]  10.9640221886        1
[INPUT] 0    0    [1    /1   ]  27.8104081133        1
[INPUT] 0    0    [1    /1   ]  0.316942864697       1
[INPUT] 0    0    [1    /1   ]  1.86828236527        1
[INPUT] 0    0    [1    /1   ]  4.00096425265        1
[INPUT] 1    0    [1    /1   ]  3.66531228079        1
[INPUT] 1    0    [1    /1   ]  12.3891785461        1
[INPUT] 1    0    [1    /1   ]  54.7868275387        1
[INPUT] 1    0    [1    /1   ]  0.329914879093       1
[INPUT] 1    0    [1    /1   ]  1.14059377531        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.788207465457581, 1.0]], [0, [24413.794134651176, 1.0]], [0, [3661.4542279584666, 1.0]], [0, [833.2752707476494, 1.0]], [0, [235.70312558053612, 1.0]], [0, [76.40972454045978, 1.0]], [0, [10.96402218860248, 1.0]], [0, [27.810408113340788, 1.0]], [0, [0.3169428646974856, 1.0]], [0, [1.868282365273102, 1.0]], [0, [4.000964252646473, 1.0]], [1, [3.6653122807870586, 1.0]], [1, [12.389178546117098, 1.0]], [1, [54.78682753870253, 1.0]], [1, [0.32991487909259587, 1.0]], [1, [1.1405937753060433, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78820747]
bas 1, expnt(s) = [24413.79413465]
bas 2, expnt(s) = [3661.45422796]
bas 3, expnt(s) = [833.27527075]
bas 4, expnt(s) = [235.70312558]
bas 5, expnt(s) = [76.40972454]
bas 6, expnt(s) = [10.96402219]
bas 7, expnt(s) = [27.81040811]
bas 8, expnt(s) = [0.31694286]
bas 9, expnt(s) = [1.86828237]
bas 10, expnt(s) = [4.00096425]
bas 11, expnt(s) = [3.66531228]
bas 12, expnt(s) = [12.38917855]
bas 13, expnt(s) = [54.78682754]
bas 14, expnt(s) = [0.32991488]
bas 15, expnt(s) = [1.14059378]
CPU time:       219.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.88207465e-01 2.11346681e+00 2.44137941e+04 4.93448102e+03
 3.66145423e+03 1.18920091e+03 8.33275271e+02 3.91837859e+02
 2.35703126e+02 1.51980906e+02 7.64097245e+01 6.52944848e+01
 1.09640222e+01 1.52227268e+01 2.78104081e+01 3.05964152e+01
 3.16942865e-01 1.06721214e+00 1.86828237e+00 4.03735474e+00
 4.00096425e+00 7.14724266e+00 3.66531228e+00 1.47952777e+01
 1.23891785e+01 6.78090301e+01 5.47868275e+01 4.34840097e+02
 3.29914879e-01 7.29435290e-01 1.14059378e+00 3.43873049e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998499043416826
cond(S) = 1291.3877155333162
E1 = -183.57822138412476  E_coul = 55.078517674965475
init E= -128.499703709159
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773939461507138  LUMO = 0.812173721023131
  mo_energy =
[-3.25554468e+01 -1.85290330e+00 -7.73939462e-01 -7.73939462e-01
 -7.73939462e-01  8.12173721e-01  1.11345481e+00  1.11345481e+00
  1.11345481e+00  4.26136766e+00  5.75475611e+00  5.75475611e+00
  5.75475611e+00  1.43643972e+01  2.40806590e+01  2.40806590e+01
  2.40806590e+01  4.68008427e+01  1.18858968e+02  1.18858968e+02
  1.18858968e+02  1.53974197e+02  5.18432944e+02  1.88489927e+03
  8.01293471e+03  4.77784390e+04]
E1 = -182.11187418920392  E_coul = 53.58280497662015
cycle= 1 E= -128.529069212584  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461873
diis-c [-0.2133263  1.       ]
  HOMO = -0.879530829922518  LUMO = 0.785028112988842
  mo_energy =
[-3.28739466e+01 -1.96311331e+00 -8.79530830e-01 -8.79530830e-01
 -8.79530830e-01  7.85028113e-01  1.07538657e+00  1.07538657e+00
  1.07538657e+00  4.18431923e+00  5.62632989e+00  5.62632989e+00
  5.62632989e+00  1.42096759e+01  2.38462310e+01  2.38462310e+01
  2.38462310e+01  4.65543610e+01  1.18538171e+02  1.18538171e+02
  1.18538171e+02  1.53661850e+02  5.18076267e+02  1.88450611e+03
  8.01251236e+03  4.77779978e+04]
E1 = -182.84368215487763  E_coul = 54.31210940295107
cycle= 2 E= -128.531572751927  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0686
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230757
diis-c [-6.52827866e-04  3.32132143e-01  6.67867857e-01]
  HOMO = -0.84518744541754  LUMO = 0.793860257308334
  mo_energy =
[-3.27689800e+01 -1.92700669e+00 -8.45187445e-01 -8.45187445e-01
 -8.45187445e-01  7.93860257e-01  1.08783644e+00  1.08783644e+00
  1.08783644e+00  4.20920021e+00  5.66809815e+00  5.66809815e+00
  5.66809815e+00  1.42602581e+01  2.39236168e+01  2.39236168e+01
  2.39236168e+01  4.66359555e+01  1.18643168e+02  1.18643168e+02
  1.18643168e+02  1.53764520e+02  5.18189677e+02  1.88462483e+03
  8.01263354e+03  4.77781199e+04]
E1 = -182.59833247392257  E_coul = 54.06591314775249
cycle= 3 E= -128.53241932617  delta_E= -0.000847  |g|= 0.000459  |ddm|= 0.0234
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000919746
diis-c [-1.46899496e-07 -2.19940268e-03 -7.81284115e-04  1.00298069e+00]
  HOMO = -0.845419103520042  LUMO = 0.793824892274299
  mo_energy =
[-3.27693843e+01 -1.92717504e+00 -8.45419104e-01 -8.45419104e-01
 -8.45419104e-01  7.93824892e-01  1.08778683e+00  1.08778683e+00
  1.08778683e+00  4.20907642e+00  5.66789795e+00  5.66789795e+00
  5.66789795e+00  1.42600255e+01  2.39232983e+01  2.39232983e+01
  2.39232983e+01  4.66356310e+01  1.18642752e+02  1.18642752e+02
  1.18642752e+02  1.53764117e+02  5.18189173e+02  1.88462422e+03
  8.01263284e+03  4.77781191e+04]
E1 = -182.59881552382666  E_coul = 54.06639617757285
cycle= 4 E= -128.532419346254  delta_E= -2.01e-08  |g|= 6.26e-05  |ddm|= 0.000316
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130213
diis-c [-9.92672850e-10  3.21357124e-04  4.40371027e-04 -2.12734771e-01
  1.21197304e+00]
  HOMO = -0.845450995552452  LUMO = 0.793818135034528
  mo_energy =
[-3.27694363e+01 -1.92719476e+00 -8.45450996e-01 -8.45450996e-01
 -8.45450996e-01  7.93818135e-01  1.08777341e+00  1.08777341e+00
  1.08777341e+00  4.20905532e+00  5.66786272e+00  5.66786272e+00
  5.66786272e+00  1.42599883e+01  2.39232513e+01  2.39232513e+01
  2.39232513e+01  4.66355840e+01  1.18642699e+02  1.18642699e+02
  1.18642699e+02  1.53764064e+02  5.18189113e+02  1.88462415e+03
  8.01263277e+03  4.77781190e+04]
E1 = -182.5989174714793  E_coul = 54.06649812470121
cycle= 5 E= -128.532419346778  delta_E= -5.24e-10  |g|= 6.68e-06  |ddm|= 5.51e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5989174714793  E_coul = 54.06649812470121
  HOMO = -0.845447322883301  LUMO = 0.793819574495286
  mo_energy =
[-3.27694283e+01 -1.92719038e+00 -8.45447323e-01 -8.45447323e-01
 -8.45447323e-01  7.93819574e-01  1.08777495e+00  1.08777495e+00
  1.08777495e+00  4.20905859e+00  5.66786717e+00  5.66786717e+00
  5.66786717e+00  1.42599937e+01  2.39232582e+01  2.39232582e+01
  2.39232582e+01  4.66355912e+01  1.18642707e+02  1.18642707e+02
  1.18642707e+02  1.53764072e+02  5.18189121e+02  1.88462416e+03
  8.01263278e+03  4.77781191e+04]
E1 = -182.59889970667865  E_coul = 54.06648035989784
Extra cycle  E= -128.532419346781  delta_E= -2.73e-12  |g|= 2.48e-06  |ddm|= 2.44e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1291.3877155333162
E1 = -182.59889970667865  E_coul = 54.06648035989784
init E= -128.532419346781
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845448565488453  LUMO = 0.793819321920258
  mo_energy =
[-3.27694322e+01 -1.92719157e+00 -8.45448565e-01 -8.45448565e-01
 -8.45448565e-01  7.93819322e-01  1.08777451e+00  1.08777451e+00
  1.08777451e+00  4.20905777e+00  5.66786567e+00  5.66786567e+00
  5.66786567e+00  1.42599919e+01  2.39232553e+01  2.39232553e+01
  2.39232553e+01  4.66355881e+01  1.18642703e+02  1.18642703e+02
  1.18642703e+02  1.53764068e+02  5.18189117e+02  1.88462415e+03
  8.01263277e+03  4.77781190e+04]
E1 = -182.598909266754  E_coul = 54.06648991997291
cycle= 1 E= -128.532419346781  delta_E= -2.56e-13  |g|= 1.31e-06  |ddm|= 9.47e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.598909266754  E_coul = 54.06648991997291
  HOMO = -0.845447893385705  LUMO = 0.793819506380334
  mo_energy =
[-3.27694302e+01 -1.92719084e+00 -8.45447893e-01 -8.45447893e-01
 -8.45447893e-01  7.93819506e-01  1.08777476e+00  1.08777476e+00
  1.08777476e+00  4.20905827e+00  5.66786649e+00  5.66786649e+00
  5.66786649e+00  1.42599929e+01  2.39232568e+01  2.39232568e+01
  2.39232568e+01  4.66355897e+01  1.18642705e+02  1.18642705e+02
  1.18642705e+02  1.53764070e+02  5.18189119e+02  1.88462416e+03
  8.01263277e+03  4.77781190e+04]
E1 = -182.59890451639293  E_coul = 54.06648516961143
Extra cycle  E= -128.532419346781  delta_E= -4.26e-13  |g|= 6.47e-07  |ddm|= 4.56e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [7.88207465e-01 2.44137941e+04 3.66145423e+03 8.33275271e+02
 2.35703126e+02 7.64097245e+01 1.09640222e+01 2.78104081e+01
 3.16942865e-01 1.86828237e+00 4.00096425e+00 3.66531228e+00
 1.23891785e+01 5.47868275e+01 3.29914879e-01 1.14059378e+00]
grad_E = [-1.14294630e-04 -1.13651546e-09  5.93881397e-08 -1.13502374e-06
  1.11867912e-05 -4.20354547e-05  3.24164070e-06 -3.46247201e-05
  1.32010905e-03 -9.52187556e-05 -3.94151342e-05 -3.85913654e-04
 -4.82503807e-05  1.37157879e-05  7.25937707e-04  7.56232118e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.780608023931       1
[INPUT] 0    0    [1    /1   ]  24413.7941394        1
[INPUT] 0    0    [1    /1   ]  3661.45398017        1
[INPUT] 0    0    [1    /1   ]  833.279817792        1
[INPUT] 0    0    [1    /1   ]  235.661895073        1
[INPUT] 0    0    [1    /1   ]  76.5262355289        1
[INPUT] 0    0    [1    /1   ]  11.2172966634        1
[INPUT] 0    0    [1    /1   ]  28.0157805168        1
[INPUT] 0    0    [1    /1   ]  0.311234717796       1
[INPUT] 0    0    [1    /1   ]  1.92173953905        1
[INPUT] 0    0    [1    /1   ]  4.52244696564        1
[INPUT] 1    0    [1    /1   ]  3.65013409577        1
[INPUT] 1    0    [1    /1   ]  12.341051934         1
[INPUT] 1    0    [1    /1   ]  54.7910840312        1
[INPUT] 1    0    [1    /1   ]  0.328944316673       1
[INPUT] 1    0    [1    /1   ]  1.13628378151        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7806080239311951, 1.0]], [0, [24413.79413940719, 1.0]], [0, [3661.453980174349, 1.0]], [0, [833.2798177924516, 1.0]], [0, [235.6618950725253, 1.0]], [0, [76.52623552894077, 1.0]], [0, [11.217296663439242, 1.0]], [0, [28.015780516756084, 1.0]], [0, [0.31123471779610035, 1.0]], [0, [1.9217395390502614, 1.0]], [0, [4.522446965640308, 1.0]], [1, [3.6501340957669615, 1.0]], [1, [12.341051934010281, 1.0]], [1, [54.79108403118797, 1.0]], [1, [0.3289443166728754, 1.0]], [1, [1.1362837815136169, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78060802]
bas 1, expnt(s) = [24413.79413941]
bas 2, expnt(s) = [3661.45398017]
bas 3, expnt(s) = [833.27981779]
bas 4, expnt(s) = [235.66189507]
bas 5, expnt(s) = [76.52623553]
bas 6, expnt(s) = [11.21729666]
bas 7, expnt(s) = [28.01578052]
bas 8, expnt(s) = [0.31123472]
bas 9, expnt(s) = [1.92173954]
bas 10, expnt(s) = [4.52244697]
bas 11, expnt(s) = [3.6501341]
bas 12, expnt(s) = [12.34105193]
bas 13, expnt(s) = [54.79108403]
bas 14, expnt(s) = [0.32894432]
bas 15, expnt(s) = [1.13628378]
CPU time:       223.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.80608024e-01 2.09816570e+00 2.44137941e+04 4.93448102e+03
 3.66145398e+03 1.18920085e+03 8.33279818e+02 3.91839462e+02
 2.35661895e+02 1.51960967e+02 7.65262355e+01 6.53691423e+01
 1.12172967e+01 1.54857120e+01 2.80157805e+01 3.07657190e+01
 3.11234718e-01 1.05276406e+00 1.92173954e+00 4.12368914e+00
 4.52244697e+00 7.83511069e+00 3.65013410e+00 1.47187327e+01
 1.23410519e+01 6.74799291e+01 5.47910840e+01 4.34882327e+02
 3.28944317e-01 7.26753909e-01 1.13628378e+00 3.42249563e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998525213404134
cond(S) = 1215.4175768847726
E1 = -183.57827253349498  E_coul = 55.078486910733965
init E= -128.499785622761
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773941382555965  LUMO = 0.804598907267627
  mo_energy =
[-3.25554726e+01 -1.85290597e+00 -7.73941383e-01 -7.73941383e-01
 -7.73941383e-01  8.04598907e-01  1.10910696e+00  1.10910696e+00
  1.10910696e+00  4.33061365e+00  5.73006991e+00  5.73006991e+00
  5.73006991e+00  1.52250924e+01  2.39685566e+01  2.39685566e+01
  2.39685566e+01  4.92319416e+01  1.18656395e+02  1.18656395e+02
  1.18656395e+02  1.57597198e+02  5.22498024e+02  1.88877879e+03
  8.01638701e+03  4.77813050e+04]
E1 = -182.11018598967468  E_coul = 53.58109836755091
cycle= 1 E= -128.529087622124  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462477
diis-c [-0.21388463  1.        ]
  HOMO = -0.879659557281038  LUMO = 0.777452930321416
  mo_energy =
[-3.28742833e+01 -1.96325880e+00 -8.79659557e-01 -8.79659557e-01
 -8.79659557e-01  7.77452930e-01  1.07116360e+00  1.07116360e+00
  1.07116360e+00  4.25052155e+00  5.60184613e+00  5.60184613e+00
  5.60184613e+00  1.50635874e+01  2.37341893e+01  2.37341893e+01
  2.37341893e+01  4.89827806e+01  1.18335280e+02  1.18335280e+02
  1.18335280e+02  1.57284397e+02  5.22141084e+02  1.88838530e+03
  8.01596430e+03  4.77808634e+04]
E1 = -182.84307075210666  E_coul = 54.3114748087484
cycle= 2 E= -128.531595943358  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0691
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231263
diis-c [-6.65664089e-04  3.32312570e-01  6.67687430e-01]
  HOMO = -0.845272194238146  LUMO = 0.78628002558207
  mo_energy =
[-3.27692019e+01 -1.92710549e+00 -8.45272194e-01 -8.45272194e-01
 -8.45272194e-01  7.86280026e-01  1.08357306e+00  1.08357306e+00
  1.08357306e+00  4.27639644e+00  5.64354771e+00  5.64354771e+00
  5.64354771e+00  1.51164488e+01  2.38115615e+01  2.38115615e+01
  2.38115615e+01  4.90652798e+01  1.18440394e+02  1.18440394e+02
  1.18440394e+02  1.57387216e+02  5.22254590e+02  1.88850414e+03
  8.01608561e+03  4.77809856e+04]
E1 = -182.59733904396316  E_coul = 54.06489399426377
cycle= 3 E= -128.532445049699  delta_E= -0.000849  |g|= 0.000446  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000889611
diis-c [-1.43796970e-07 -2.19249537e-03 -9.10004031e-04  1.00310250e+00]
  HOMO = -0.84549865837027  LUMO = 0.786246084266113
  mo_energy =
[-3.27695913e+01 -1.92726873e+00 -8.45498658e-01 -8.45498658e-01
 -8.45498658e-01  7.86246084e-01  1.08352588e+00  1.08352588e+00
  1.08352588e+00  4.27627284e+00  5.64335426e+00  5.64335426e+00
  5.64335426e+00  1.51162167e+01  2.38112545e+01  2.38112545e+01
  2.38112545e+01  4.90649646e+01  1.18439993e+02  1.18439993e+02
  1.18439993e+02  1.57386827e+02  5.22254103e+02  1.88850354e+03
  8.01608492e+03  4.77809849e+04]
E1 = -182.59778723796853  E_coul = 54.0653421690555
cycle= 4 E= -128.532445068913  delta_E= -1.92e-08  |g|= 6.25e-05  |ddm|= 0.0003
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130143
diis-c [-9.94720367e-10  3.16643905e-04  4.65274620e-04 -2.11920017e-01
  1.21113810e+00]
  HOMO = -0.845530552311893  LUMO = 0.786239288469396
  mo_energy =
[-3.27696434e+01 -1.92728855e+00 -8.45530552e-01 -8.45530552e-01
 -8.45530552e-01  7.86239288e-01  1.08351252e+00  1.08351252e+00
  1.08351252e+00  4.27625109e+00  5.64331906e+00  5.64331906e+00
  5.64331906e+00  1.51161785e+01  2.38112075e+01  2.38112075e+01
  2.38112075e+01  4.90649172e+01  1.18439940e+02  1.18439940e+02
  1.18439940e+02  1.57386774e+02  5.22254043e+02  1.88850347e+03
  8.01608485e+03  4.77809848e+04]
E1 = -182.59788960927526  E_coul = 54.065444539842055
cycle= 5 E= -128.532445069433  delta_E= -5.2e-10  |g|= 6.65e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59788960927526  E_coul = 54.065444539842055
  HOMO = -0.845526896615814  LUMO = 0.786240722623201
  mo_energy =
[-3.27696354e+01 -1.92728418e+00 -8.45526897e-01 -8.45526897e-01
 -8.45526897e-01  7.86240723e-01  1.08351404e+00  1.08351404e+00
  1.08351404e+00  4.27625445e+00  5.64332349e+00  5.64332349e+00
  5.64332349e+00  1.51161841e+01  2.38112143e+01  2.38112143e+01
  2.38112143e+01  4.90649244e+01  1.18439948e+02  1.18439948e+02
  1.18439948e+02  1.57386782e+02  5.22254051e+02  1.88850348e+03
  8.01608486e+03  4.77809848e+04]
E1 = -182.5978718702051  E_coul = 54.065426800768975
Extra cycle  E= -128.532445069436  delta_E= -2.9e-12  |g|= 2.48e-06  |ddm|= 2.4e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [7.80608024e-01 2.44137941e+04 3.66145398e+03 8.33279818e+02
 2.35661895e+02 7.65262355e+01 1.12172967e+01 2.80157805e+01
 3.11234718e-01 1.92173954e+00 4.52244697e+00 3.65013410e+00
 1.23410519e+01 5.47910840e+01 3.28944317e-01 1.13628378e+00]
E = -128.5324450694361
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.780608023931       1
[INPUT] 0    0    [1    /1   ]  24413.7941394        1
[INPUT] 0    0    [1    /1   ]  3661.45398017        1
[INPUT] 0    0    [1    /1   ]  833.279817792        1
[INPUT] 0    0    [1    /1   ]  235.661895073        1
[INPUT] 0    0    [1    /1   ]  76.5262355289        1
[INPUT] 0    0    [1    /1   ]  11.2172966634        1
[INPUT] 0    0    [1    /1   ]  28.0157805168        1
[INPUT] 0    0    [1    /1   ]  0.311234717796       1
[INPUT] 0    0    [1    /1   ]  1.92173953905        1
[INPUT] 0    0    [1    /1   ]  4.52244696564        1
[INPUT] 1    0    [1    /1   ]  3.65013409577        1
[INPUT] 1    0    [1    /1   ]  12.341051934         1
[INPUT] 1    0    [1    /1   ]  54.7910840312        1
[INPUT] 1    0    [1    /1   ]  0.328944316673       1
[INPUT] 1    0    [1    /1   ]  1.13628378151        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7806080239311951, 1.0]], [0, [24413.79413940719, 1.0]], [0, [3661.453980174349, 1.0]], [0, [833.2798177924516, 1.0]], [0, [235.6618950725253, 1.0]], [0, [76.52623552894077, 1.0]], [0, [11.217296663439242, 1.0]], [0, [28.015780516756084, 1.0]], [0, [0.31123471779610035, 1.0]], [0, [1.9217395390502614, 1.0]], [0, [4.522446965640308, 1.0]], [1, [3.6501340957669615, 1.0]], [1, [12.341051934010281, 1.0]], [1, [54.79108403118797, 1.0]], [1, [0.3289443166728754, 1.0]], [1, [1.1362837815136169, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78060802]
bas 1, expnt(s) = [24413.79413941]
bas 2, expnt(s) = [3661.45398017]
bas 3, expnt(s) = [833.27981779]
bas 4, expnt(s) = [235.66189507]
bas 5, expnt(s) = [76.52623553]
bas 6, expnt(s) = [11.21729666]
bas 7, expnt(s) = [28.01578052]
bas 8, expnt(s) = [0.31123472]
bas 9, expnt(s) = [1.92173954]
bas 10, expnt(s) = [4.52244697]
bas 11, expnt(s) = [3.6501341]
bas 12, expnt(s) = [12.34105193]
bas 13, expnt(s) = [54.79108403]
bas 14, expnt(s) = [0.32894432]
bas 15, expnt(s) = [1.13628378]
CPU time:       224.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.80608024e-01 2.09816570e+00 2.44137941e+04 4.93448102e+03
 3.66145398e+03 1.18920085e+03 8.33279818e+02 3.91839462e+02
 2.35661895e+02 1.51960967e+02 7.65262355e+01 6.53691423e+01
 1.12172967e+01 1.54857120e+01 2.80157805e+01 3.07657190e+01
 3.11234718e-01 1.05276406e+00 1.92173954e+00 4.12368914e+00
 4.52244697e+00 7.83511069e+00 3.65013410e+00 1.47187327e+01
 1.23410519e+01 6.74799291e+01 5.47910840e+01 4.34882327e+02
 3.28944317e-01 7.26753909e-01 1.13628378e+00 3.42249563e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998525213404134
cond(S) = 1215.4175768847726
E1 = -183.57827253349498  E_coul = 55.078486910733965
init E= -128.499785622761
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773941382555965  LUMO = 0.804598907267627
  mo_energy =
[-3.25554726e+01 -1.85290597e+00 -7.73941383e-01 -7.73941383e-01
 -7.73941383e-01  8.04598907e-01  1.10910696e+00  1.10910696e+00
  1.10910696e+00  4.33061365e+00  5.73006991e+00  5.73006991e+00
  5.73006991e+00  1.52250924e+01  2.39685566e+01  2.39685566e+01
  2.39685566e+01  4.92319416e+01  1.18656395e+02  1.18656395e+02
  1.18656395e+02  1.57597198e+02  5.22498024e+02  1.88877879e+03
  8.01638701e+03  4.77813050e+04]
E1 = -182.11018598967468  E_coul = 53.58109836755091
cycle= 1 E= -128.529087622124  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462477
diis-c [-0.21388463  1.        ]
  HOMO = -0.879659557281038  LUMO = 0.777452930321416
  mo_energy =
[-3.28742833e+01 -1.96325880e+00 -8.79659557e-01 -8.79659557e-01
 -8.79659557e-01  7.77452930e-01  1.07116360e+00  1.07116360e+00
  1.07116360e+00  4.25052155e+00  5.60184613e+00  5.60184613e+00
  5.60184613e+00  1.50635874e+01  2.37341893e+01  2.37341893e+01
  2.37341893e+01  4.89827806e+01  1.18335280e+02  1.18335280e+02
  1.18335280e+02  1.57284397e+02  5.22141084e+02  1.88838530e+03
  8.01596430e+03  4.77808634e+04]
E1 = -182.84307075210666  E_coul = 54.3114748087484
cycle= 2 E= -128.531595943358  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0691
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231263
diis-c [-6.65664089e-04  3.32312570e-01  6.67687430e-01]
  HOMO = -0.845272194238146  LUMO = 0.78628002558207
  mo_energy =
[-3.27692019e+01 -1.92710549e+00 -8.45272194e-01 -8.45272194e-01
 -8.45272194e-01  7.86280026e-01  1.08357306e+00  1.08357306e+00
  1.08357306e+00  4.27639644e+00  5.64354771e+00  5.64354771e+00
  5.64354771e+00  1.51164488e+01  2.38115615e+01  2.38115615e+01
  2.38115615e+01  4.90652798e+01  1.18440394e+02  1.18440394e+02
  1.18440394e+02  1.57387216e+02  5.22254590e+02  1.88850414e+03
  8.01608561e+03  4.77809856e+04]
E1 = -182.59733904396316  E_coul = 54.06489399426377
cycle= 3 E= -128.532445049699  delta_E= -0.000849  |g|= 0.000446  |ddm|= 0.0235
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000889611
diis-c [-1.43796970e-07 -2.19249537e-03 -9.10004031e-04  1.00310250e+00]
  HOMO = -0.84549865837027  LUMO = 0.786246084266113
  mo_energy =
[-3.27695913e+01 -1.92726873e+00 -8.45498658e-01 -8.45498658e-01
 -8.45498658e-01  7.86246084e-01  1.08352588e+00  1.08352588e+00
  1.08352588e+00  4.27627284e+00  5.64335426e+00  5.64335426e+00
  5.64335426e+00  1.51162167e+01  2.38112545e+01  2.38112545e+01
  2.38112545e+01  4.90649646e+01  1.18439993e+02  1.18439993e+02
  1.18439993e+02  1.57386827e+02  5.22254103e+02  1.88850354e+03
  8.01608492e+03  4.77809849e+04]
E1 = -182.59778723796853  E_coul = 54.0653421690555
cycle= 4 E= -128.532445068913  delta_E= -1.92e-08  |g|= 6.25e-05  |ddm|= 0.0003
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130143
diis-c [-9.94720367e-10  3.16643905e-04  4.65274620e-04 -2.11920017e-01
  1.21113810e+00]
  HOMO = -0.845530552311893  LUMO = 0.786239288469396
  mo_energy =
[-3.27696434e+01 -1.92728855e+00 -8.45530552e-01 -8.45530552e-01
 -8.45530552e-01  7.86239288e-01  1.08351252e+00  1.08351252e+00
  1.08351252e+00  4.27625109e+00  5.64331906e+00  5.64331906e+00
  5.64331906e+00  1.51161785e+01  2.38112075e+01  2.38112075e+01
  2.38112075e+01  4.90649172e+01  1.18439940e+02  1.18439940e+02
  1.18439940e+02  1.57386774e+02  5.22254043e+02  1.88850347e+03
  8.01608485e+03  4.77809848e+04]
E1 = -182.59788960927526  E_coul = 54.065444539842055
cycle= 5 E= -128.532445069433  delta_E= -5.2e-10  |g|= 6.65e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59788960927526  E_coul = 54.065444539842055
  HOMO = -0.845526896615814  LUMO = 0.786240722623201
  mo_energy =
[-3.27696354e+01 -1.92728418e+00 -8.45526897e-01 -8.45526897e-01
 -8.45526897e-01  7.86240723e-01  1.08351404e+00  1.08351404e+00
  1.08351404e+00  4.27625445e+00  5.64332349e+00  5.64332349e+00
  5.64332349e+00  1.51161841e+01  2.38112143e+01  2.38112143e+01
  2.38112143e+01  4.90649244e+01  1.18439948e+02  1.18439948e+02
  1.18439948e+02  1.57386782e+02  5.22254051e+02  1.88850348e+03
  8.01608486e+03  4.77809848e+04]
E1 = -182.5978718702051  E_coul = 54.065426800768975
Extra cycle  E= -128.532445069436  delta_E= -2.9e-12  |g|= 2.48e-06  |ddm|= 2.4e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1215.4175768847726
E1 = -182.5978718702051  E_coul = 54.065426800768975
init E= -128.532445069436
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845528138155892  LUMO = 0.786240471148698
  mo_energy =
[-3.27696393e+01 -1.92728537e+00 -8.45528138e-01 -8.45528138e-01
 -8.45528138e-01  7.86240471e-01  1.08351361e+00  1.08351361e+00
  1.08351361e+00  4.27625360e+00  5.64332199e+00  5.64332199e+00
  5.64332199e+00  1.51161822e+01  2.38112115e+01  2.38112115e+01
  2.38112115e+01  4.90649213e+01  1.18439944e+02  1.18439944e+02
  1.18439944e+02  1.57386778e+02  5.22254047e+02  1.88850347e+03
  8.01608485e+03  4.77809848e+04]
E1 = -182.59788141577366  E_coul = 54.06543634633734
cycle= 1 E= -128.532445069436  delta_E= -1.99e-13  |g|= 1.31e-06  |ddm|= 9.44e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59788141577366  E_coul = 54.06543634633734
  HOMO = -0.845527467133635  LUMO = 0.786240655108816
  mo_energy =
[-3.27696373e+01 -1.92728464e+00 -8.45527467e-01 -8.45527467e-01
 -8.45527467e-01  7.86240655e-01  1.08351386e+00  1.08351386e+00
  1.08351386e+00  4.27625412e+00  5.64332280e+00  5.64332280e+00
  5.64332280e+00  1.51161832e+01  2.38112130e+01  2.38112130e+01
  2.38112130e+01  4.90649229e+01  1.18439946e+02  1.18439946e+02
  1.18439946e+02  1.57386780e+02  5.22254049e+02  1.88850347e+03
  8.01608486e+03  4.77809848e+04]
E1 = -182.59787667039555  E_coul = 54.06543160095894
Extra cycle  E= -128.532445069437  delta_E= -3.13e-13  |g|= 6.46e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [7.80608024e-01 2.44137941e+04 3.66145398e+03 8.33279818e+02
 2.35661895e+02 7.65262355e+01 1.12172967e+01 2.80157805e+01
 3.11234718e-01 1.92173954e+00 4.52244697e+00 3.65013410e+00
 1.23410519e+01 5.47910840e+01 3.28944317e-01 1.13628378e+00]
grad_E = [-6.90756219e-04 -1.08982595e-09  5.72606436e-08 -1.12040732e-06
  1.17077651e-05 -4.97781990e-05 -6.23617419e-05 -7.48505821e-06
  1.78688584e-03  9.15536013e-05  1.06654953e-05 -3.40561371e-04
 -1.33966504e-04  2.66022806e-05  4.40177958e-04  6.47614430e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.773536339921       1
[INPUT] 0    0    [1    /1   ]  24413.7941412        1
[INPUT] 0    0    [1    /1   ]  3661.45388566        1
[INPUT] 0    0    [1    /1   ]  833.281520267        1
[INPUT] 0    0    [1    /1   ]  235.647400251        1
[INPUT] 0    0    [1    /1   ]  76.5507622696        1
[INPUT] 0    0    [1    /1   ]  11.4071759271        1
[INPUT] 0    0    [1    /1   ]  28.1790946073        1
[INPUT] 0    0    [1    /1   ]  0.303519545672       1
[INPUT] 0    0    [1    /1   ]  1.92918412722        1
[INPUT] 0    0    [1    /1   ]  4.80528464617        1
[INPUT] 1    0    [1    /1   ]  3.64428018543        1
[INPUT] 1    0    [1    /1   ]  12.3227931503        1
[INPUT] 1    0    [1    /1   ]  54.7920706272        1
[INPUT] 1    0    [1    /1   ]  0.328193070667       1
[INPUT] 1    0    [1    /1   ]  1.13382577474        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7735363399209894, 1.0]], [0, [24413.794141223632, 1.0]], [0, [3661.4538856577533, 1.0]], [0, [833.2815202673457, 1.0]], [0, [235.6474002508035, 1.0]], [0, [76.55076226963727, 1.0]], [0, [11.40717592710956, 1.0]], [0, [28.17909460726973, 1.0]], [0, [0.3035195456721706, 1.0]], [0, [1.929184127218904, 1.0]], [0, [4.805284646173445, 1.0]], [1, [3.644280185425239, 1.0]], [1, [12.322793150268632, 1.0]], [1, [54.79207062717498, 1.0]], [1, [0.32819307066681136, 1.0]], [1, [1.133825774744437, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77353634]
bas 1, expnt(s) = [24413.79414122]
bas 2, expnt(s) = [3661.45388566]
bas 3, expnt(s) = [833.28152027]
bas 4, expnt(s) = [235.64740025]
bas 5, expnt(s) = [76.55076227]
bas 6, expnt(s) = [11.40717593]
bas 7, expnt(s) = [28.17909461]
bas 8, expnt(s) = [0.30351955]
bas 9, expnt(s) = [1.92918413]
bas 10, expnt(s) = [4.80528465]
bas 11, expnt(s) = [3.64428019]
bas 12, expnt(s) = [12.32279315]
bas 13, expnt(s) = [54.79207063]
bas 14, expnt(s) = [0.32819307]
bas 15, expnt(s) = [1.13382577]
CPU time:       227.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.73536340e-01 2.08389372e+00 2.44137941e+04 4.93448102e+03
 3.66145389e+03 1.18920082e+03 8.33281520e+02 3.91840063e+02
 2.35647400e+02 1.51953957e+02 7.65507623e+01 6.53848548e+01
 1.14071759e+01 1.56818981e+01 2.81790946e+01 3.09001296e+01
 3.03519546e-01 1.03313012e+00 1.92918413e+00 4.13566435e+00
 4.80528465e+00 8.19982084e+00 3.64428019e+00 1.46892321e+01
 1.23227932e+01 6.73551551e+01 5.47920706e+01 4.34892115e+02
 3.28193071e-01 7.24679793e-01 1.13382577e+00 3.41324372e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998543483645445
cond(S) = 1196.3883716277908
E1 = -183.578284049411  E_coul = 55.07845678326439
init E= -128.499827266147
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944460291411  LUMO = 0.787935857557383
  mo_energy =
[-3.25554829e+01 -1.85291103e+00 -7.73944460e-01 -7.73944460e-01
 -7.73944460e-01  7.87935858e-01  1.10602139e+00  1.10602139e+00
  1.10602139e+00  4.31875453e+00  5.71697655e+00  5.71697655e+00
  5.71697655e+00  1.55956879e+01  2.39217913e+01  2.39217913e+01
  2.39217913e+01  5.05243369e+01  1.18575479e+02  1.18575479e+02
  1.18575479e+02  1.59706172e+02  5.24892126e+02  1.89105566e+03
  8.01841328e+03  4.77829872e+04]
E1 = -182.10843899885842  E_coul = 53.57934806920444
cycle= 1 E= -128.529090929654  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462767
diis-c [-0.21415333  1.        ]
  HOMO = -0.879803519812248  LUMO = 0.761156472522599
  mo_energy =
[-3.28745886e+01 -1.96340393e+00 -8.79803520e-01 -8.79803520e-01
 -8.79803520e-01  7.61156473e-01  1.06812248e+00  1.06812248e+00
  1.06812248e+00  4.23749383e+00  5.58874396e+00  5.58874396e+00
  5.58874396e+00  1.54306803e+01  2.36872879e+01  2.36872879e+01
  2.36872879e+01  5.02733999e+01  1.18254064e+02  1.18254064e+02
  1.18254064e+02  1.59392924e+02  5.24534911e+02  1.89066187e+03
  8.01799024e+03  4.77825453e+04]
E1 = -182.8422751020245  E_coul = 54.31067131421541
cycle= 2 E= -128.531603787809  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0695
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231538
diis-c [-0.00067283  0.33242869  0.66757131]
  HOMO = -0.845375933514066  LUMO = 0.769859025903373
  mo_energy =
[-3.27693957e+01 -1.92720781e+00 -8.45375934e-01 -8.45375934e-01
 -8.45375934e-01  7.69859026e-01  1.08051058e+00  1.08051058e+00
  1.08051058e+00  4.26374316e+00  5.63044370e+00  5.63044370e+00
  5.63044370e+00  1.54847155e+01  2.37647082e+01  2.37647082e+01
  2.37647082e+01  5.03564979e+01  1.18359290e+02  1.18359290e+02
  1.18359290e+02  1.59495898e+02  5.24648525e+02  1.89078082e+03
  8.01811168e+03  4.77826676e+04]
E1 = -182.59615845145166  E_coul = 54.06370320060548
cycle= 3 E= -128.532455250846  delta_E= -0.000851  |g|= 0.000448  |ddm|= 0.0236
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000884616
diis-c [-1.48292396e-07 -2.20730095e-03 -9.78823101e-04  1.00318612e+00]
  HOMO = -0.845602869956738  LUMO = 0.769825363162705
  mo_energy =
[-3.27697819e+01 -1.92737047e+00 -8.45602870e-01 -8.45602870e-01
 -8.45602870e-01  7.69825363e-01  1.08046311e+00  1.08046311e+00
  1.08046311e+00  4.26361789e+00  5.63025061e+00  5.63025061e+00
  5.63025061e+00  1.54844806e+01  2.37644029e+01  2.37644029e+01
  2.37644029e+01  5.03561831e+01  1.18358892e+02  1.18358892e+02
  1.18358892e+02  1.59495511e+02  5.24648041e+02  1.89078023e+03
  8.01811100e+03  4.77826669e+04]
E1 = -182.59659164895066  E_coul = 54.06413637836538
cycle= 4 E= -128.532455270585  delta_E= -1.97e-08  |g|= 6.36e-05  |ddm|= 0.000306
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132037
diis-c [-1.02018766e-09  3.17125379e-04  4.79374503e-04 -2.12666208e-01
  1.21186971e+00]
  HOMO = -0.845635347315945  LUMO = 0.769818524314576
  mo_energy =
[-3.27698348e+01 -1.92739061e+00 -8.45635347e-01 -8.45635347e-01
 -8.45635347e-01  7.69818524e-01  1.08044951e+00  1.08044951e+00
  1.08044951e+00  4.26359551e+00  5.63021483e+00  5.63021483e+00
  5.63021483e+00  1.54844413e+01  2.37643551e+01  2.37643551e+01
  2.37643551e+01  5.03561348e+01  1.18358839e+02  1.18358839e+02
  1.18358839e+02  1.59495458e+02  5.24647981e+02  1.89078016e+03
  8.01811093e+03  4.77826668e+04]
E1 = -182.59669490962574  E_coul = 54.06423963849609
cycle= 5 E= -128.53245527113  delta_E= -5.44e-10  |g|= 6.74e-06  |ddm|= 5.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59669490962574  E_coul = 54.06423963849609
  HOMO = -0.845631650944621  LUMO = 0.769819960231142
  mo_energy =
[-3.27698267e+01 -1.92738619e+00 -8.45631651e-01 -8.45631651e-01
 -8.45631651e-01  7.69819960e-01  1.08045105e+00  1.08045105e+00
  1.08045105e+00  4.26359894e+00  5.63021930e+00  5.63021930e+00
  5.63021930e+00  1.54844470e+01  2.37643621e+01  2.37643621e+01
  2.37643621e+01  5.03561421e+01  1.18358847e+02  1.18358847e+02
  1.18358847e+02  1.59495466e+02  5.24647988e+02  1.89078017e+03
  8.01811093e+03  4.77826668e+04]
E1 = -182.59667705419616  E_coul = 54.06422178306405
Extra cycle  E= -128.532455271132  delta_E= -2.44e-12  |g|= 2.5e-06  |ddm|= 2.48e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [7.73536340e-01 2.44137941e+04 3.66145389e+03 8.33281520e+02
 2.35647400e+02 7.65507623e+01 1.14071759e+01 2.81790946e+01
 3.03519546e-01 1.92918413e+00 4.80528465e+00 3.64428019e+00
 1.23227932e+01 5.47920706e+01 3.28193071e-01 1.13382577e+00]
E = -128.5324552711321
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.773536339921       1
[INPUT] 0    0    [1    /1   ]  24413.7941412        1
[INPUT] 0    0    [1    /1   ]  3661.45388566        1
[INPUT] 0    0    [1    /1   ]  833.281520267        1
[INPUT] 0    0    [1    /1   ]  235.647400251        1
[INPUT] 0    0    [1    /1   ]  76.5507622696        1
[INPUT] 0    0    [1    /1   ]  11.4071759271        1
[INPUT] 0    0    [1    /1   ]  28.1790946073        1
[INPUT] 0    0    [1    /1   ]  0.303519545672       1
[INPUT] 0    0    [1    /1   ]  1.92918412722        1
[INPUT] 0    0    [1    /1   ]  4.80528464617        1
[INPUT] 1    0    [1    /1   ]  3.64428018543        1
[INPUT] 1    0    [1    /1   ]  12.3227931503        1
[INPUT] 1    0    [1    /1   ]  54.7920706272        1
[INPUT] 1    0    [1    /1   ]  0.328193070667       1
[INPUT] 1    0    [1    /1   ]  1.13382577474        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7735363399209894, 1.0]], [0, [24413.794141223632, 1.0]], [0, [3661.4538856577533, 1.0]], [0, [833.2815202673457, 1.0]], [0, [235.6474002508035, 1.0]], [0, [76.55076226963727, 1.0]], [0, [11.40717592710956, 1.0]], [0, [28.17909460726973, 1.0]], [0, [0.3035195456721706, 1.0]], [0, [1.929184127218904, 1.0]], [0, [4.805284646173445, 1.0]], [1, [3.644280185425239, 1.0]], [1, [12.322793150268632, 1.0]], [1, [54.79207062717498, 1.0]], [1, [0.32819307066681136, 1.0]], [1, [1.133825774744437, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77353634]
bas 1, expnt(s) = [24413.79414122]
bas 2, expnt(s) = [3661.45388566]
bas 3, expnt(s) = [833.28152027]
bas 4, expnt(s) = [235.64740025]
bas 5, expnt(s) = [76.55076227]
bas 6, expnt(s) = [11.40717593]
bas 7, expnt(s) = [28.17909461]
bas 8, expnt(s) = [0.30351955]
bas 9, expnt(s) = [1.92918413]
bas 10, expnt(s) = [4.80528465]
bas 11, expnt(s) = [3.64428019]
bas 12, expnt(s) = [12.32279315]
bas 13, expnt(s) = [54.79207063]
bas 14, expnt(s) = [0.32819307]
bas 15, expnt(s) = [1.13382577]
CPU time:       228.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.73536340e-01 2.08389372e+00 2.44137941e+04 4.93448102e+03
 3.66145389e+03 1.18920082e+03 8.33281520e+02 3.91840063e+02
 2.35647400e+02 1.51953957e+02 7.65507623e+01 6.53848548e+01
 1.14071759e+01 1.56818981e+01 2.81790946e+01 3.09001296e+01
 3.03519546e-01 1.03313012e+00 1.92918413e+00 4.13566435e+00
 4.80528465e+00 8.19982084e+00 3.64428019e+00 1.46892321e+01
 1.23227932e+01 6.73551551e+01 5.47920706e+01 4.34892115e+02
 3.28193071e-01 7.24679793e-01 1.13382577e+00 3.41324372e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998543483645445
cond(S) = 1196.3883716277908
E1 = -183.578284049411  E_coul = 55.07845678326439
init E= -128.499827266147
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944460291411  LUMO = 0.787935857557383
  mo_energy =
[-3.25554829e+01 -1.85291103e+00 -7.73944460e-01 -7.73944460e-01
 -7.73944460e-01  7.87935858e-01  1.10602139e+00  1.10602139e+00
  1.10602139e+00  4.31875453e+00  5.71697655e+00  5.71697655e+00
  5.71697655e+00  1.55956879e+01  2.39217913e+01  2.39217913e+01
  2.39217913e+01  5.05243369e+01  1.18575479e+02  1.18575479e+02
  1.18575479e+02  1.59706172e+02  5.24892126e+02  1.89105566e+03
  8.01841328e+03  4.77829872e+04]
E1 = -182.10843899885842  E_coul = 53.57934806920444
cycle= 1 E= -128.529090929654  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462767
diis-c [-0.21415333  1.        ]
  HOMO = -0.879803519812248  LUMO = 0.761156472522599
  mo_energy =
[-3.28745886e+01 -1.96340393e+00 -8.79803520e-01 -8.79803520e-01
 -8.79803520e-01  7.61156473e-01  1.06812248e+00  1.06812248e+00
  1.06812248e+00  4.23749383e+00  5.58874396e+00  5.58874396e+00
  5.58874396e+00  1.54306803e+01  2.36872879e+01  2.36872879e+01
  2.36872879e+01  5.02733999e+01  1.18254064e+02  1.18254064e+02
  1.18254064e+02  1.59392924e+02  5.24534911e+02  1.89066187e+03
  8.01799024e+03  4.77825453e+04]
E1 = -182.8422751020245  E_coul = 54.31067131421541
cycle= 2 E= -128.531603787809  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0695
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.231538
diis-c [-0.00067283  0.33242869  0.66757131]
  HOMO = -0.845375933514066  LUMO = 0.769859025903373
  mo_energy =
[-3.27693957e+01 -1.92720781e+00 -8.45375934e-01 -8.45375934e-01
 -8.45375934e-01  7.69859026e-01  1.08051058e+00  1.08051058e+00
  1.08051058e+00  4.26374316e+00  5.63044370e+00  5.63044370e+00
  5.63044370e+00  1.54847155e+01  2.37647082e+01  2.37647082e+01
  2.37647082e+01  5.03564979e+01  1.18359290e+02  1.18359290e+02
  1.18359290e+02  1.59495898e+02  5.24648525e+02  1.89078082e+03
  8.01811168e+03  4.77826676e+04]
E1 = -182.59615845145166  E_coul = 54.06370320060548
cycle= 3 E= -128.532455250846  delta_E= -0.000851  |g|= 0.000448  |ddm|= 0.0236
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000884616
diis-c [-1.48292396e-07 -2.20730095e-03 -9.78823101e-04  1.00318612e+00]
  HOMO = -0.845602869956738  LUMO = 0.769825363162705
  mo_energy =
[-3.27697819e+01 -1.92737047e+00 -8.45602870e-01 -8.45602870e-01
 -8.45602870e-01  7.69825363e-01  1.08046311e+00  1.08046311e+00
  1.08046311e+00  4.26361789e+00  5.63025061e+00  5.63025061e+00
  5.63025061e+00  1.54844806e+01  2.37644029e+01  2.37644029e+01
  2.37644029e+01  5.03561831e+01  1.18358892e+02  1.18358892e+02
  1.18358892e+02  1.59495511e+02  5.24648041e+02  1.89078023e+03
  8.01811100e+03  4.77826669e+04]
E1 = -182.59659164895066  E_coul = 54.06413637836538
cycle= 4 E= -128.532455270585  delta_E= -1.97e-08  |g|= 6.36e-05  |ddm|= 0.000306
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000132037
diis-c [-1.02018766e-09  3.17125379e-04  4.79374503e-04 -2.12666208e-01
  1.21186971e+00]
  HOMO = -0.845635347315945  LUMO = 0.769818524314576
  mo_energy =
[-3.27698348e+01 -1.92739061e+00 -8.45635347e-01 -8.45635347e-01
 -8.45635347e-01  7.69818524e-01  1.08044951e+00  1.08044951e+00
  1.08044951e+00  4.26359551e+00  5.63021483e+00  5.63021483e+00
  5.63021483e+00  1.54844413e+01  2.37643551e+01  2.37643551e+01
  2.37643551e+01  5.03561348e+01  1.18358839e+02  1.18358839e+02
  1.18358839e+02  1.59495458e+02  5.24647981e+02  1.89078016e+03
  8.01811093e+03  4.77826668e+04]
E1 = -182.59669490962574  E_coul = 54.06423963849609
cycle= 5 E= -128.53245527113  delta_E= -5.44e-10  |g|= 6.74e-06  |ddm|= 5.35e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59669490962574  E_coul = 54.06423963849609
  HOMO = -0.845631650944621  LUMO = 0.769819960231142
  mo_energy =
[-3.27698267e+01 -1.92738619e+00 -8.45631651e-01 -8.45631651e-01
 -8.45631651e-01  7.69819960e-01  1.08045105e+00  1.08045105e+00
  1.08045105e+00  4.26359894e+00  5.63021930e+00  5.63021930e+00
  5.63021930e+00  1.54844470e+01  2.37643621e+01  2.37643621e+01
  2.37643621e+01  5.03561421e+01  1.18358847e+02  1.18358847e+02
  1.18358847e+02  1.59495466e+02  5.24647988e+02  1.89078017e+03
  8.01811093e+03  4.77826668e+04]
E1 = -182.59667705419616  E_coul = 54.06422178306405
Extra cycle  E= -128.532455271132  delta_E= -2.44e-12  |g|= 2.5e-06  |ddm|= 2.48e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1196.3883716277908
E1 = -182.59667705419616  E_coul = 54.06422178306405
init E= -128.532455271132
    CPU time for initialize scf      0.27 sec, wall time      0.27 sec
  HOMO = -0.845632900316928  LUMO = 0.769819712412454
  mo_energy =
[-3.27698307e+01 -1.92738738e+00 -8.45632900e-01 -8.45632900e-01
 -8.45632900e-01  7.69819712e-01  1.08045062e+00  1.08045062e+00
  1.08045062e+00  4.26359808e+00  5.63021779e+00  5.63021779e+00
  5.63021779e+00  1.54844450e+01  2.37643592e+01  2.37643592e+01
  2.37643592e+01  5.03561390e+01  1.18358843e+02  1.18358843e+02
  1.18358843e+02  1.59495462e+02  5.24647984e+02  1.89078016e+03
  8.01811093e+03  4.77826668e+04]
E1 = -182.59668668029752  E_coul = 54.06423140916451
cycle= 1 E= -128.532455271133  delta_E= -9.09e-13  |g|= 1.32e-06  |ddm|= 9.53e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59668668029752  E_coul = 54.06423140916451
  HOMO = -0.845632223547121  LUMO = 0.769819895330225
  mo_energy =
[-3.27698286e+01 -1.92738665e+00 -8.45632224e-01 -8.45632224e-01
 -8.45632224e-01  7.69819895e-01  1.08045086e+00  1.08045086e+00
  1.08045086e+00  4.26359861e+00  5.63021861e+00  5.63021861e+00
  5.63021861e+00  1.54844461e+01  2.37643607e+01  2.37643607e+01
  2.37643607e+01  5.03561406e+01  1.18358845e+02  1.18358845e+02
  1.18358845e+02  1.59495464e+02  5.24647986e+02  1.89078017e+03
  8.01811093e+03  4.77826668e+04]
E1 = -182.5966818946577  E_coul = 54.06422662352503
Extra cycle  E= -128.532455271133  delta_E= 3.41e-13  |g|= 6.51e-07  |ddm|= 4.64e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.33 sec
exp = [7.73536340e-01 2.44137941e+04 3.66145389e+03 8.33281520e+02
 2.35647400e+02 7.65507623e+01 1.14071759e+01 2.81790946e+01
 3.03519546e-01 1.92918413e+00 4.80528465e+00 3.64428019e+00
 1.23227932e+01 5.47920706e+01 3.28193071e-01 1.13382577e+00]
grad_E = [-2.25874095e-04 -1.31429275e-09  6.91272752e-08 -1.35662842e-06
  1.43810108e-05 -6.41188594e-05 -7.46500247e-05  1.80726824e-05
  6.21518793e-04 -1.74895539e-05  3.26786470e-05 -1.62888310e-04
 -1.84776403e-04  3.21182872e-05  5.61287609e-06  2.76806881e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.822735450634       1
[INPUT] 0    0    [1    /1   ]  24413.7941417        1
[INPUT] 0    0    [1    /1   ]  3661.45386003        1
[INPUT] 0    0    [1    /1   ]  833.281939961        1
[INPUT] 0    0    [1    /1   ]  235.645051411        1
[INPUT] 0    0    [1    /1   ]  76.5329479565        1
[INPUT] 0    0    [1    /1   ]  11.6279286123        1
[INPUT] 0    0    [1    /1   ]  28.3148211016        1
[INPUT] 0    0    [1    /1   ]  0.308608515266       1
[INPUT] 0    0    [1    /1   ]  2.10743947431        1
[INPUT] 0    0    [1    /1   ]  4.99726113346        1
[INPUT] 1    0    [1    /1   ]  3.64239476387        1
[INPUT] 1    0    [1    /1   ]  12.3154083307        1
[INPUT] 1    0    [1    /1   ]  54.791736119         1
[INPUT] 1    0    [1    /1   ]  0.3277062667         1
[INPUT] 1    0    [1    /1   ]  1.13266007111        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8227354506340115, 1.0]], [0, [24413.794141718903, 1.0]], [0, [3661.453860025039, 1.0]], [0, [833.2819399605589, 1.0]], [0, [235.6450514107812, 1.0]], [0, [76.53294795650474, 1.0]], [0, [11.627928612348894, 1.0]], [0, [28.314821101617916, 1.0]], [0, [0.308608515265807, 1.0]], [0, [2.1074394743114264, 1.0]], [0, [4.997261133457322, 1.0]], [1, [3.642394763874629, 1.0]], [1, [12.315408330656759, 1.0]], [1, [54.79173611904676, 1.0]], [1, [0.32770626670010505, 1.0]], [1, [1.132660071109251, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82273545]
bas 1, expnt(s) = [24413.79414172]
bas 2, expnt(s) = [3661.45386003]
bas 3, expnt(s) = [833.28193996]
bas 4, expnt(s) = [235.64505141]
bas 5, expnt(s) = [76.53294796]
bas 6, expnt(s) = [11.62792861]
bas 7, expnt(s) = [28.3148211]
bas 8, expnt(s) = [0.30860852]
bas 9, expnt(s) = [2.10743947]
bas 10, expnt(s) = [4.99726113]
bas 11, expnt(s) = [3.64239476]
bas 12, expnt(s) = [12.31540833]
bas 13, expnt(s) = [54.79173612]
bas 14, expnt(s) = [0.32770627]
bas 15, expnt(s) = [1.13266007]
CPU time:       231.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.22735451e-01 2.18252980e+00 2.44137941e+04 4.93448102e+03
 3.66145386e+03 1.18920082e+03 8.33281940e+02 3.91840211e+02
 2.35645051e+02 1.51952821e+02 7.65329480e+01 6.53734426e+01
 1.16279286e+01 1.59089601e+01 2.83148211e+01 3.10116869e+01
 3.08608515e-01 1.04609458e+00 2.10743947e+00 4.41907484e+00
 4.99726113e+00 8.44430784e+00 3.64239476e+00 1.46797331e+01
 1.23154083e+01 6.73047030e+01 5.47917361e+01 4.34888796e+02
 3.27706267e-01 7.23336409e-01 1.13266007e+00 3.40885777e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99855203396621
cond(S) = 1367.470358994829
E1 = -183.57825882390736  E_coul = 55.07845495605397
init E= -128.499803867853
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944760866581  LUMO = 0.828948594702216
  mo_energy =
[-3.25554881e+01 -1.85290674e+00 -7.73944761e-01 -7.73944761e-01
 -7.73944761e-01  8.28948595e-01  1.10415854e+00  1.10415854e+00
  1.10415854e+00  4.64736020e+00  5.71085601e+00  5.71085601e+00
  5.71085601e+00  1.66494365e+01  2.39031365e+01  2.39031365e+01
  2.39031365e+01  5.25388315e+01  1.18542294e+02  1.18542294e+02
  1.18542294e+02  1.62426600e+02  5.27742831e+02  1.89370191e+03
  8.02075884e+03  4.77849326e+04]
E1 = -182.10717141609027  E_coul = 53.57808701053005
cycle= 1 E= -128.52908440556  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462831
diis-c [-0.2142121  1.       ]
  HOMO = -0.879911058191897  LUMO = 0.800333355189441
  mo_energy =
[-3.28747931e+01 -1.96350744e+00 -8.79911058e-01 -8.79911058e-01
 -8.79911058e-01  8.00333355e-01  1.06627255e+00  1.06627255e+00
  1.06627255e+00  4.56096096e+00  5.58255762e+00  5.58255762e+00
  5.58255762e+00  1.64803287e+01  2.36684991e+01  2.36684991e+01
  2.36684991e+01  5.22866628e+01  1.18220680e+02  1.18220680e+02
  1.18220680e+02  1.62113179e+02  5.27385498e+02  1.89330794e+03
  8.02033559e+03  4.77844904e+04]
E1 = -182.84158659626408  E_coul = 54.30998661967459
cycle= 2 E= -128.531599976589  delta_E= -0.00252  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231653
diis-c [-0.00068251  0.33249392  0.66750608]
  HOMO = -0.84545925744413  LUMO = 0.80961700390772
  mo_energy =
[-3.27695301e+01 -1.92728481e+00 -8.45459257e-01 -8.45459257e-01
 -8.45459257e-01  8.09617004e-01  1.07865073e+00  1.07865073e+00
  1.07865073e+00  4.58887269e+00  5.62426893e+00  5.62426893e+00
  5.62426893e+00  1.65357266e+01  2.37459587e+01  2.37459587e+01
  2.37459587e+01  5.23701660e+01  1.18325977e+02  1.18325977e+02
  1.18325977e+02  1.62216207e+02  5.27499160e+02  1.89342696e+03
  8.02045710e+03  4.77846129e+04]
E1 = -182.5952200742432  E_coul = 54.06276713449285
cycle= 3 E= -128.53245293975  delta_E= -0.000853  |g|= 0.000451  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000885722
diis-c [-1.47743947e-07 -2.21555934e-03 -9.89046752e-04  1.00320461e+00]
  HOMO = -0.84568757961272  LUMO = 0.809580668944064
  mo_energy =
[-3.27699160e+01 -1.92744810e+00 -8.45687580e-01 -8.45687580e-01
 -8.45687580e-01  8.09580669e-01  1.07860292e+00  1.07860292e+00
  1.07860292e+00  4.58873869e+00  5.62407472e+00  5.62407472e+00
  5.62407472e+00  1.65354857e+01  2.37456527e+01  2.37456527e+01
  2.37456527e+01  5.23698494e+01  1.18325580e+02  1.18325580e+02
  1.18325580e+02  1.62215821e+02  5.27498677e+02  1.89342637e+03
  8.02045642e+03  4.77846121e+04]
E1 = -182.59565015157577  E_coul = 54.06319719183937
cycle= 4 E= -128.532452959736  delta_E= -2e-08  |g|= 6.44e-05  |ddm|= 0.000308
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133664
diis-c [-1.04871927e-09  3.18919418e-04  4.89156703e-04 -2.13299918e-01
  1.21249184e+00]
  HOMO = -0.845720427042911  LUMO = 0.809573352499082
  mo_energy =
[-3.27699696e+01 -1.92746843e+00 -8.45720427e-01 -8.45720427e-01
 -8.45720427e-01  8.09573352e-01  1.07858924e+00  1.07858924e+00
  1.07858924e+00  4.58871483e+00  5.62403854e+00  5.62403854e+00
  5.62403854e+00  1.65354451e+01  2.37456044e+01  2.37456044e+01
  2.37456044e+01  5.23698004e+01  1.18325526e+02  1.18325526e+02
  1.18325526e+02  1.62215767e+02  5.27498616e+02  1.89342630e+03
  8.02045635e+03  4.77846121e+04]
E1 = -182.5957551962446  E_coul = 54.063302235954396
cycle= 5 E= -128.53245296029  delta_E= -5.54e-10  |g|= 6.83e-06  |ddm|= 5.33e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5957551962446  E_coul = 54.063302235954396
  HOMO = -0.845716674989395  LUMO = 0.809574894463474
  mo_energy =
[-3.27699614e+01 -1.92746395e+00 -8.45716675e-01 -8.45716675e-01
 -8.45716675e-01  8.09574894e-01  1.07859080e+00  1.07859080e+00
  1.07859080e+00  4.58871849e+00  5.62404307e+00  5.62404307e+00
  5.62404307e+00  1.65354510e+01  2.37456114e+01  2.37456114e+01
  2.37456114e+01  5.23698078e+01  1.18325534e+02  1.18325534e+02
  1.18325534e+02  1.62215775e+02  5.27498623e+02  1.89342631e+03
  8.02045636e+03  4.77846121e+04]
E1 = -182.59573720510076  E_coul = 54.06328424480772
Extra cycle  E= -128.532452960293  delta_E= -2.84e-12  |g|= 2.52e-06  |ddm|= 2.52e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [8.22735451e-01 2.44137941e+04 3.66145386e+03 8.33281940e+02
 2.35645051e+02 7.65329480e+01 1.16279286e+01 2.83148211e+01
 3.08608515e-01 2.10743947e+00 4.99726113e+00 3.64239476e+00
 1.23154083e+01 5.47917361e+01 3.27706267e-01 1.13266007e+00]
E = -128.53245296029303
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.795094021024       1
[INPUT] 0    0    [1    /1   ]  24413.7941414        1
[INPUT] 0    0    [1    /1   ]  3661.45387443        1
[INPUT] 0    0    [1    /1   ]  833.281704165        1
[INPUT] 0    0    [1    /1   ]  235.646371054        1
[INPUT] 0    0    [1    /1   ]  76.5429565334        1
[INPUT] 0    0    [1    /1   ]  11.5039036102        1
[INPUT] 0    0    [1    /1   ]  28.2385661798        1
[INPUT] 0    0    [1    /1   ]  0.305749390522       1
[INPUT] 0    0    [1    /1   ]  2.00729065947        1
[INPUT] 0    0    [1    /1   ]  4.88940340019        1
[INPUT] 1    0    [1    /1   ]  3.64345404617        1
[INPUT] 1    0    [1    /1   ]  12.3195573278        1
[INPUT] 1    0    [1    /1   ]  54.791924055         1
[INPUT] 1    0    [1    /1   ]  0.327979766716       1
[INPUT] 1    0    [1    /1   ]  1.13331499585        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7950940210238608, 1.0]], [0, [24413.794141440645, 1.0]], [0, [3661.4538744262113, 1.0]], [0, [833.2817041652318, 1.0]], [0, [235.64637105447397, 1.0]], [0, [76.54295653339506, 1.0]], [0, [11.503903610232753, 1.0]], [0, [28.238566179823874, 1.0]], [0, [0.3057493905220448, 1.0]], [0, [2.007290659467365, 1.0]], [0, [4.889403400194335, 1.0]], [1, [3.643454046173056, 1.0]], [1, [12.319557327834287, 1.0]], [1, [54.791924055022555, 1.0]], [1, [0.32797976671635826, 1.0]], [1, [1.1333149958530382, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79509402]
bas 1, expnt(s) = [24413.79414144]
bas 2, expnt(s) = [3661.45387443]
bas 3, expnt(s) = [833.28170417]
bas 4, expnt(s) = [235.64637105]
bas 5, expnt(s) = [76.54295653]
bas 6, expnt(s) = [11.50390361]
bas 7, expnt(s) = [28.23856618]
bas 8, expnt(s) = [0.30574939]
bas 9, expnt(s) = [2.00729066]
bas 10, expnt(s) = [4.8894034]
bas 11, expnt(s) = [3.64345405]
bas 12, expnt(s) = [12.31955733]
bas 13, expnt(s) = [54.79192406]
bas 14, expnt(s) = [0.32797977]
bas 15, expnt(s) = [1.133315]
CPU time:       232.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.95094021e-01 2.12730073e+00 2.44137941e+04 4.93448102e+03
 3.66145387e+03 1.18920082e+03 8.33281704e+02 3.91840127e+02
 2.35646371e+02 1.51953459e+02 7.65429565e+01 6.53798544e+01
 1.15039036e+01 1.57815244e+01 2.82385662e+01 3.09490274e+01
 3.05749391e-01 1.03881742e+00 2.00729066e+00 4.26061922e+00
 4.88940340e+00 8.30724324e+00 3.64345405e+00 1.46850697e+01
 1.23195573e+01 6.73330475e+01 5.47919241e+01 4.34890661e+02
 3.27979767e-01 7.24091098e-01 1.13331500e+00 3.41132178e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9985477905485
cond(S) = 1267.9061380015446
E1 = -183.57828125241662  E_coul = 55.0784559446921
init E= -128.499825307725
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944603560326  LUMO = 0.805895068251438
  mo_energy =
[-3.25554857e+01 -1.85291084e+00 -7.73944604e-01 -7.73944604e-01
 -7.73944604e-01  8.05895068e-01  1.10520589e+00  1.10520589e+00
  1.10520589e+00  4.46249040e+00  5.71429553e+00  5.71429553e+00
  5.71429553e+00  1.60582913e+01  2.39136165e+01  2.39136165e+01
  2.39136165e+01  5.14087041e+01  1.18560937e+02  1.18560937e+02
  1.18560937e+02  1.60898824e+02  5.26140589e+02  1.89221417e+03
  8.01944006e+03  4.77838388e+04]
E1 = -182.10791481739219  E_coul = 53.57882241260271
cycle= 1 E= -128.529092404789  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462786
diis-c [-0.21417065  1.        ]
  HOMO = -0.879848015370758  LUMO = 0.778311807447754
  mo_energy =
[-3.28746743e+01 -1.96344976e+00 -8.79848015e-01 -8.79848015e-01
 -8.79848015e-01  7.78311807e-01  1.06731463e+00  1.06731463e+00
  1.06731463e+00  4.37895401e+00  5.58603606e+00  5.58603606e+00
  5.58603606e+00  1.58914601e+01  2.36790580e+01  2.36790580e+01
  2.36790580e+01  5.11572303e+01  1.18239440e+02  1.18239440e+02
  1.18239440e+02  1.60585507e+02  5.25783329e+02  1.89182030e+03
  8.01901693e+03  4.77833967e+04]
E1 = -182.84200405680375  E_coul = 54.31039764339996
cycle= 2 E= -128.531606413404  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0695
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231586
diis-c [-0.00067706  0.33245911  0.66754089]
  HOMO = -0.84540986790637  LUMO = 0.787269113598869
  mo_energy =
[-3.27694513e+01 -1.92724216e+00 -8.45409868e-01 -8.45409868e-01
 -8.45409868e-01  7.87269114e-01  1.07969839e+00  1.07969839e+00
  1.07969839e+00  4.40593997e+00  5.62774079e+00  5.62774079e+00
  5.62774079e+00  1.59461021e+01  2.37564953e+01  2.37564953e+01
  2.37564953e+01  5.12405059e+01  1.18344697e+02  1.18344697e+02
  1.18344697e+02  1.60688503e+02  5.25896963e+02  1.89193929e+03
  8.01913840e+03  4.77835191e+04]
E1 = -182.5957806735586  E_coul = 54.063322145873606
cycle= 3 E= -128.532458527685  delta_E= -0.000852  |g|= 0.000448  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883931
diis-c [-1.47434129e-07 -2.20912986e-03 -9.83607711e-04  1.00319274e+00]
  HOMO = -0.845637105442565  LUMO = 0.787234363626038
  mo_energy =
[-3.27698369e+01 -1.92740494e+00 -8.45637105e-01 -8.45637105e-01
 -8.45637105e-01  7.87234364e-01  1.07965092e+00  1.07965092e+00
  1.07965092e+00  4.40581108e+00  5.62754751e+00  5.62754751e+00
  5.62754751e+00  1.59458649e+01  2.37561900e+01  2.37561900e+01
  2.37561900e+01  5.12401907e+01  1.18344300e+02  1.18344300e+02
  1.18344300e+02  1.60688117e+02  5.25896479e+02  1.89193870e+03
  8.01913772e+03  4.77835184e+04]
E1 = -182.59621209535905  E_coul = 54.063753547925124
cycle= 4 E= -128.532458547434  delta_E= -1.97e-08  |g|= 6.38e-05  |ddm|= 0.000305
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132525
diis-c [-1.02950114e-09  3.17456971e-04  4.83409611e-04 -2.12754153e-01
  1.21195329e+00]
  HOMO = -0.845669688972075  LUMO = 0.787227321689766
  mo_energy =
[-3.27698900e+01 -1.92742515e+00 -8.45669689e-01 -8.45669689e-01
 -8.45669689e-01  7.87227322e-01  1.07963731e+00  1.07963731e+00
  1.07963731e+00  4.40578807e+00  5.62751161e+00  5.62751161e+00
  5.62751161e+00  1.59458251e+01  2.37561421e+01  2.37561421e+01
  2.37561421e+01  5.12401422e+01  1.18344246e+02  1.18344246e+02
  1.18344246e+02  1.60688063e+02  5.25896419e+02  1.89193863e+03
  8.01913765e+03  4.77835183e+04]
E1 = -182.59631602825084  E_coul = 54.06385748027158
cycle= 5 E= -128.532458547979  delta_E= -5.45e-10  |g|= 6.76e-06  |ddm|= 5.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59631602825084  E_coul = 54.06385748027158
  HOMO = -0.84566597649494  LUMO = 0.787228800770872
  mo_energy =
[-3.27698819e+01 -1.92742071e+00 -8.45665976e-01 -8.45665976e-01
 -8.45665976e-01  7.87228801e-01  1.07963885e+00  1.07963885e+00
  1.07963885e+00  4.40579160e+00  5.62751610e+00  5.62751610e+00
  5.62751610e+00  1.59458308e+01  2.37561490e+01  2.37561490e+01
  2.37561490e+01  5.12401495e+01  1.18344254e+02  1.18344254e+02
  1.18344254e+02  1.60688071e+02  5.25896426e+02  1.89193864e+03
  8.01913766e+03  4.77835183e+04]
E1 = -182.59629814088984  E_coul = 54.06383959290759
Extra cycle  E= -128.532458547982  delta_E= -2.98e-12  |g|= 2.5e-06  |ddm|= 2.48e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [7.95094021e-01 2.44137941e+04 3.66145387e+03 8.33281704e+02
 2.35646371e+02 7.65429565e+01 1.15039036e+01 2.82385662e+01
 3.05749391e-01 2.00729066e+00 4.88940340e+00 3.64345405e+00
 1.23195573e+01 5.47919241e+01 3.27979767e-01 1.13331500e+00]
E = -128.53245854798226
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.795094021024       1
[INPUT] 0    0    [1    /1   ]  24413.7941414        1
[INPUT] 0    0    [1    /1   ]  3661.45387443        1
[INPUT] 0    0    [1    /1   ]  833.281704165        1
[INPUT] 0    0    [1    /1   ]  235.646371054        1
[INPUT] 0    0    [1    /1   ]  76.5429565334        1
[INPUT] 0    0    [1    /1   ]  11.5039036102        1
[INPUT] 0    0    [1    /1   ]  28.2385661798        1
[INPUT] 0    0    [1    /1   ]  0.305749390522       1
[INPUT] 0    0    [1    /1   ]  2.00729065947        1
[INPUT] 0    0    [1    /1   ]  4.88940340019        1
[INPUT] 1    0    [1    /1   ]  3.64345404617        1
[INPUT] 1    0    [1    /1   ]  12.3195573278        1
[INPUT] 1    0    [1    /1   ]  54.791924055         1
[INPUT] 1    0    [1    /1   ]  0.327979766716       1
[INPUT] 1    0    [1    /1   ]  1.13331499585        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7950940210238608, 1.0]], [0, [24413.794141440645, 1.0]], [0, [3661.4538744262113, 1.0]], [0, [833.2817041652318, 1.0]], [0, [235.64637105447397, 1.0]], [0, [76.54295653339506, 1.0]], [0, [11.503903610232753, 1.0]], [0, [28.238566179823874, 1.0]], [0, [0.3057493905220448, 1.0]], [0, [2.007290659467365, 1.0]], [0, [4.889403400194335, 1.0]], [1, [3.643454046173056, 1.0]], [1, [12.319557327834287, 1.0]], [1, [54.791924055022555, 1.0]], [1, [0.32797976671635826, 1.0]], [1, [1.1333149958530382, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79509402]
bas 1, expnt(s) = [24413.79414144]
bas 2, expnt(s) = [3661.45387443]
bas 3, expnt(s) = [833.28170417]
bas 4, expnt(s) = [235.64637105]
bas 5, expnt(s) = [76.54295653]
bas 6, expnt(s) = [11.50390361]
bas 7, expnt(s) = [28.23856618]
bas 8, expnt(s) = [0.30574939]
bas 9, expnt(s) = [2.00729066]
bas 10, expnt(s) = [4.8894034]
bas 11, expnt(s) = [3.64345405]
bas 12, expnt(s) = [12.31955733]
bas 13, expnt(s) = [54.79192406]
bas 14, expnt(s) = [0.32797977]
bas 15, expnt(s) = [1.133315]
CPU time:       233.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.95094021e-01 2.12730073e+00 2.44137941e+04 4.93448102e+03
 3.66145387e+03 1.18920082e+03 8.33281704e+02 3.91840127e+02
 2.35646371e+02 1.51953459e+02 7.65429565e+01 6.53798544e+01
 1.15039036e+01 1.57815244e+01 2.82385662e+01 3.09490274e+01
 3.05749391e-01 1.03881742e+00 2.00729066e+00 4.26061922e+00
 4.88940340e+00 8.30724324e+00 3.64345405e+00 1.46850697e+01
 1.23195573e+01 6.73330475e+01 5.47919241e+01 4.34890661e+02
 3.27979767e-01 7.24091098e-01 1.13331500e+00 3.41132178e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9985477905485
cond(S) = 1267.9061380015446
E1 = -183.57828125241662  E_coul = 55.0784559446921
init E= -128.499825307725
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944603560326  LUMO = 0.805895068251438
  mo_energy =
[-3.25554857e+01 -1.85291084e+00 -7.73944604e-01 -7.73944604e-01
 -7.73944604e-01  8.05895068e-01  1.10520589e+00  1.10520589e+00
  1.10520589e+00  4.46249040e+00  5.71429553e+00  5.71429553e+00
  5.71429553e+00  1.60582913e+01  2.39136165e+01  2.39136165e+01
  2.39136165e+01  5.14087041e+01  1.18560937e+02  1.18560937e+02
  1.18560937e+02  1.60898824e+02  5.26140589e+02  1.89221417e+03
  8.01944006e+03  4.77838388e+04]
E1 = -182.10791481739219  E_coul = 53.57882241260271
cycle= 1 E= -128.529092404789  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462786
diis-c [-0.21417065  1.        ]
  HOMO = -0.879848015370758  LUMO = 0.778311807447754
  mo_energy =
[-3.28746743e+01 -1.96344976e+00 -8.79848015e-01 -8.79848015e-01
 -8.79848015e-01  7.78311807e-01  1.06731463e+00  1.06731463e+00
  1.06731463e+00  4.37895401e+00  5.58603606e+00  5.58603606e+00
  5.58603606e+00  1.58914601e+01  2.36790580e+01  2.36790580e+01
  2.36790580e+01  5.11572303e+01  1.18239440e+02  1.18239440e+02
  1.18239440e+02  1.60585507e+02  5.25783329e+02  1.89182030e+03
  8.01901693e+03  4.77833967e+04]
E1 = -182.84200405680375  E_coul = 54.31039764339996
cycle= 2 E= -128.531606413404  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0695
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231586
diis-c [-0.00067706  0.33245911  0.66754089]
  HOMO = -0.84540986790637  LUMO = 0.787269113598869
  mo_energy =
[-3.27694513e+01 -1.92724216e+00 -8.45409868e-01 -8.45409868e-01
 -8.45409868e-01  7.87269114e-01  1.07969839e+00  1.07969839e+00
  1.07969839e+00  4.40593997e+00  5.62774079e+00  5.62774079e+00
  5.62774079e+00  1.59461021e+01  2.37564953e+01  2.37564953e+01
  2.37564953e+01  5.12405059e+01  1.18344697e+02  1.18344697e+02
  1.18344697e+02  1.60688503e+02  5.25896963e+02  1.89193929e+03
  8.01913840e+03  4.77835191e+04]
E1 = -182.5957806735586  E_coul = 54.063322145873606
cycle= 3 E= -128.532458527685  delta_E= -0.000852  |g|= 0.000448  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883931
diis-c [-1.47434129e-07 -2.20912986e-03 -9.83607711e-04  1.00319274e+00]
  HOMO = -0.845637105442565  LUMO = 0.787234363626038
  mo_energy =
[-3.27698369e+01 -1.92740494e+00 -8.45637105e-01 -8.45637105e-01
 -8.45637105e-01  7.87234364e-01  1.07965092e+00  1.07965092e+00
  1.07965092e+00  4.40581108e+00  5.62754751e+00  5.62754751e+00
  5.62754751e+00  1.59458649e+01  2.37561900e+01  2.37561900e+01
  2.37561900e+01  5.12401907e+01  1.18344300e+02  1.18344300e+02
  1.18344300e+02  1.60688117e+02  5.25896479e+02  1.89193870e+03
  8.01913772e+03  4.77835184e+04]
E1 = -182.59621209535905  E_coul = 54.063753547925124
cycle= 4 E= -128.532458547434  delta_E= -1.97e-08  |g|= 6.38e-05  |ddm|= 0.000305
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132525
diis-c [-1.02950114e-09  3.17456971e-04  4.83409611e-04 -2.12754153e-01
  1.21195329e+00]
  HOMO = -0.845669688972075  LUMO = 0.787227321689766
  mo_energy =
[-3.27698900e+01 -1.92742515e+00 -8.45669689e-01 -8.45669689e-01
 -8.45669689e-01  7.87227322e-01  1.07963731e+00  1.07963731e+00
  1.07963731e+00  4.40578807e+00  5.62751161e+00  5.62751161e+00
  5.62751161e+00  1.59458251e+01  2.37561421e+01  2.37561421e+01
  2.37561421e+01  5.12401422e+01  1.18344246e+02  1.18344246e+02
  1.18344246e+02  1.60688063e+02  5.25896419e+02  1.89193863e+03
  8.01913765e+03  4.77835183e+04]
E1 = -182.59631602825084  E_coul = 54.06385748027158
cycle= 5 E= -128.532458547979  delta_E= -5.45e-10  |g|= 6.76e-06  |ddm|= 5.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59631602825084  E_coul = 54.06385748027158
  HOMO = -0.84566597649494  LUMO = 0.787228800770872
  mo_energy =
[-3.27698819e+01 -1.92742071e+00 -8.45665976e-01 -8.45665976e-01
 -8.45665976e-01  7.87228801e-01  1.07963885e+00  1.07963885e+00
  1.07963885e+00  4.40579160e+00  5.62751610e+00  5.62751610e+00
  5.62751610e+00  1.59458308e+01  2.37561490e+01  2.37561490e+01
  2.37561490e+01  5.12401495e+01  1.18344254e+02  1.18344254e+02
  1.18344254e+02  1.60688071e+02  5.25896426e+02  1.89193864e+03
  8.01913766e+03  4.77835183e+04]
E1 = -182.59629814088984  E_coul = 54.06383959290759
Extra cycle  E= -128.532458547982  delta_E= -2.98e-12  |g|= 2.5e-06  |ddm|= 2.48e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1267.9061380015446
E1 = -182.59629814088984  E_coul = 54.06383959290759
init E= -128.532458547982
    CPU time for initialize scf      0.30 sec, wall time      0.33 sec
  HOMO = -0.845667227746891  LUMO = 0.787228544799306
  mo_energy =
[-3.27698859e+01 -1.92742191e+00 -8.45667228e-01 -8.45667228e-01
 -8.45667228e-01  7.87228545e-01  1.07963842e+00  1.07963842e+00
  1.07963842e+00  4.40579071e+00  5.62751459e+00  5.62751459e+00
  5.62751459e+00  1.59458288e+01  2.37561461e+01  2.37561461e+01
  2.37561461e+01  5.12401464e+01  1.18344250e+02  1.18344250e+02
  1.18344250e+02  1.60688067e+02  5.25896422e+02  1.89193863e+03
  8.01913765e+03  4.77835183e+04]
E1 = -182.59630778951305  E_coul = 54.06384924153059
cycle= 1 E= -128.532458547982  delta_E= -1.99e-13  |g|= 1.32e-06  |ddm|= 9.55e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59630778951305  E_coul = 54.06384924153059
  HOMO = -0.845666549337334  LUMO = 0.787228733361232
  mo_energy =
[-3.27698838e+01 -1.92742117e+00 -8.45666549e-01 -8.45666549e-01
 -8.45666549e-01  7.87228733e-01  1.07963866e+00  1.07963866e+00
  1.07963866e+00  4.40579126e+00  5.62751541e+00  5.62751541e+00
  5.62751541e+00  1.59458299e+01  2.37561477e+01  2.37561477e+01
  2.37561477e+01  5.12401480e+01  1.18344252e+02  1.18344252e+02
  1.18344252e+02  1.60688069e+02  5.25896424e+02  1.89193864e+03
  8.01913765e+03  4.77835183e+04]
E1 = -182.59630299232725  E_coul = 54.0638444443445
Extra cycle  E= -128.532458547983  delta_E= -2.84e-13  |g|= 6.53e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.39 sec
exp = [7.95094021e-01 2.44137941e+04 3.66145387e+03 8.33281704e+02
 2.35646371e+02 7.65429565e+01 1.15039036e+01 2.82385662e+01
 3.05749391e-01 2.00729066e+00 4.88940340e+00 3.64345405e+00
 1.23195573e+01 5.47919241e+01 3.27979767e-01 1.13331500e+00]
grad_E = [-2.84551526e-04 -1.37555675e-09  7.23170141e-08 -1.41553521e-06
  1.48958382e-05 -6.48162541e-05 -6.18481795e-05  9.76321708e-06
  2.95911220e-04  1.02572427e-04  2.39320190e-05 -1.00426181e-04
 -2.00124282e-04  3.33379659e-05 -3.06699455e-04  2.19432100e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.797325850374       1
[INPUT] 0    0    [1    /1   ]  24413.7941407        1
[INPUT] 0    0    [1    /1   ]  3661.45391204        1
[INPUT] 0    0    [1    /1   ]  833.280996834        1
[INPUT] 0    0    [1    /1   ]  235.653284475        1
[INPUT] 0    0    [1    /1   ]  76.5148671887        1
[INPUT] 0    0    [1    /1   ]  11.5284546191        1
[INPUT] 0    0    [1    /1   ]  28.2493914266        1
[INPUT] 0    0    [1    /1   ]  0.305636442257       1
[INPUT] 0    0    [1    /1   ]  2.00083651922        1
[INPUT] 0    0    [1    /1   ]  4.8559226736         1
[INPUT] 1    0    [1    /1   ]  3.64530730106        1
[INPUT] 1    0    [1    /1   ]  12.3272167591        1
[INPUT] 1    0    [1    /1   ]  54.790884614         1
[INPUT] 1    0    [1    /1   ]  0.327928988645       1
[INPUT] 1    0    [1    /1   ]  1.13334816229        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7973258503744407, 1.0]], [0, [24413.794140719856, 1.0]], [0, [3661.453912041286, 1.0]], [0, [833.280996833615, 1.0]], [0, [235.65328447490757, 1.0]], [0, [76.51486718867133, 1.0]], [0, [11.52845461908437, 1.0]], [0, [28.249391426578335, 1.0]], [0, [0.30563644225720943, 1.0]], [0, [2.0008365192151, 1.0]], [0, [4.855922673597994, 1.0]], [1, [3.6453073010636587, 1.0]], [1, [12.327216759135908, 1.0]], [1, [54.790884613952365, 1.0]], [1, [0.32792898864532666, 1.0]], [1, [1.1333481622896662, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79732585]
bas 1, expnt(s) = [24413.79414072]
bas 2, expnt(s) = [3661.45391204]
bas 3, expnt(s) = [833.28099683]
bas 4, expnt(s) = [235.65328447]
bas 5, expnt(s) = [76.51486719]
bas 6, expnt(s) = [11.52845462]
bas 7, expnt(s) = [28.24939143]
bas 8, expnt(s) = [0.30563644]
bas 9, expnt(s) = [2.00083652]
bas 10, expnt(s) = [4.85592267]
bas 11, expnt(s) = [3.6453073]
bas 12, expnt(s) = [12.32721676]
bas 13, expnt(s) = [54.79088461]
bas 14, expnt(s) = [0.32792899]
bas 15, expnt(s) = [1.13334816]
CPU time:       237.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.97325850e-01 2.13177767e+00 2.44137941e+04 4.93448102e+03
 3.66145391e+03 1.18920083e+03 8.33280997e+02 3.91839878e+02
 2.35653284e+02 1.51956803e+02 7.65148672e+01 6.53618590e+01
 1.15284546e+01 1.58067777e+01 2.82493914e+01 3.09579252e+01
 3.05636442e-01 1.03852959e+00 2.00083652e+00 4.25034055e+00
 4.85592267e+00 8.26454305e+00 3.64530730e+00 1.46944073e+01
 1.23272168e+01 6.73853802e+01 5.47908846e+01 4.34880348e+02
 3.27928989e-01 7.23950970e-01 1.13334816e+00 3.41144657e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998548231927625
cond(S) = 1261.3219436929303
E1 = -183.57824831946954  E_coul = 55.07844909974845
init E= -128.499799219721
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945760999333  LUMO = 0.806263274066283
  mo_energy =
[-3.25554854e+01 -1.85291179e+00 -7.73945761e-01 -7.73945761e-01
 -7.73945761e-01  8.06263274e-01  1.10505825e+00  1.10505825e+00
  1.10505825e+00  4.45909023e+00  5.71530066e+00  5.71530066e+00
  5.71530066e+00  1.60111120e+01  2.39269674e+01  2.39269674e+01
  2.39269674e+01  5.13317611e+01  1.18588866e+02  1.18588866e+02
  1.18588866e+02  1.60838630e+02  5.26063667e+02  1.89212976e+03
  8.01936383e+03  4.77837753e+04]
E1 = -182.10776790095824  E_coul = 53.57867463635282
cycle= 1 E= -128.529093264605  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462772
diis-c [-0.21415762  1.        ]
  HOMO = -0.879862731586719  LUMO = 0.778662830277593
  mo_energy =
[-3.28746939e+01 -1.96346074e+00 -8.79862732e-01 -8.79862732e-01
 -8.79862732e-01  7.78662830e-01  1.06715838e+00  1.06715838e+00
  1.06715838e+00  4.37570124e+00  5.58699489e+00  5.58699489e+00
  5.58699489e+00  1.58445533e+01  2.36923390e+01  2.36923390e+01
  2.36923390e+01  5.10802730e+01  1.18267346e+02  1.18267346e+02
  1.18267346e+02  1.60525278e+02  5.25706386e+02  1.89173587e+03
  8.01894069e+03  4.77833332e+04]
E1 = -182.84191134723977  E_coul = 54.31030371163933
cycle= 2 E= -128.5316076356  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231572
diis-c [-0.00067675  0.33245347  0.66754653]
  HOMO = -0.845421913965467  LUMO = 0.787624347831171
  mo_energy =
[-3.27694617e+01 -1.92725017e+00 -8.45421914e-01 -8.45421914e-01
 -8.45421914e-01  7.87624348e-01  1.07954245e+00  1.07954245e+00
  1.07954245e+00  4.40263668e+00  5.62871471e+00  5.62871471e+00
  5.62871471e+00  1.58991022e+01  2.37698002e+01  2.37698002e+01
  2.37698002e+01  5.11635539e+01  1.18372612e+02  1.18372612e+02
  1.18372612e+02  1.60628289e+02  5.25820031e+02  1.89185487e+03
  8.01906216e+03  4.77834556e+04]
E1 = -182.59565246481958  E_coul = 54.063192552819366
cycle= 3 E= -128.532459912  delta_E= -0.000852  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000889412
diis-c [-1.49127869e-07 -2.21538968e-03 -9.74043819e-04  1.00318943e+00]
  HOMO = -0.845650627466987  LUMO = 0.787589103588946
  mo_energy =
[-3.27698500e+01 -1.92741407e+00 -8.45650627e-01 -8.45650627e-01
 -8.45650627e-01  7.87589104e-01  1.07949427e+00  1.07949427e+00
  1.07949427e+00  4.40250666e+00  5.62851989e+00  5.62851989e+00
  5.62851989e+00  1.58988634e+01  2.37694926e+01  2.37694926e+01
  2.37694926e+01  5.11632364e+01  1.18372212e+02  1.18372212e+02
  1.18372212e+02  1.60627900e+02  5.25819545e+02  1.89185428e+03
  8.01906148e+03  4.77834549e+04]
E1 = -182.59608718120896  E_coul = 54.063627249040216
cycle= 4 E= -128.532459932169  delta_E= -2.02e-08  |g|= 6.43e-05  |ddm|= 0.000312
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133158
diis-c [-1.03936438e-09  3.18496192e-04  4.82132152e-04 -2.13080589e-01
  1.21227996e+00]
  HOMO = -0.845683428634551  LUMO = 0.787582009273801
  mo_energy =
[-3.27699034e+01 -1.92743439e+00 -8.45683429e-01 -8.45683429e-01
 -8.45683429e-01  7.87582009e-01  1.07948055e+00  1.07948055e+00
  1.07948055e+00  4.40248351e+00  5.62848377e+00  5.62848377e+00
  5.62848377e+00  1.58988234e+01  2.37694444e+01  2.37694444e+01
  2.37694444e+01  5.11631876e+01  1.18372158e+02  1.18372158e+02
  1.18372158e+02  1.60627847e+02  5.25819484e+02  1.89185421e+03
  8.01906141e+03  4.77834548e+04]
E1 = -182.59619136004352  E_coul = 54.06373142731994
cycle= 5 E= -128.532459932724  delta_E= -5.55e-10  |g|= 6.8e-06  |ddm|= 5.4e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59619136004352  E_coul = 54.06373142731994
  HOMO = -0.845679698098973  LUMO = 0.787583497404524
  mo_energy =
[-3.27698952e+01 -1.92742993e+00 -8.45679698e-01 -8.45679698e-01
 -8.45679698e-01  7.87583497e-01  1.07948211e+00  1.07948211e+00
  1.07948211e+00  4.40248705e+00  5.62848828e+00  5.62848828e+00
  5.62848828e+00  1.58988291e+01  2.37694514e+01  2.37694514e+01
  2.37694514e+01  5.11631949e+01  1.18372166e+02  1.18372166e+02
  1.18372166e+02  1.60627855e+02  5.25819492e+02  1.89185421e+03
  8.01906142e+03  4.77834548e+04]
E1 = -182.59617343105552  E_coul = 54.06371349832917
Extra cycle  E= -128.532459932726  delta_E= -2.76e-12  |g|= 2.51e-06  |ddm|= 2.53e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [7.97325850e-01 2.44137941e+04 3.66145391e+03 8.33280997e+02
 2.35653284e+02 7.65148672e+01 1.15284546e+01 2.82493914e+01
 3.05636442e-01 2.00083652e+00 4.85592267e+00 3.64530730e+00
 1.23272168e+01 5.47908846e+01 3.27928989e-01 1.13334816e+00]
E = -128.53245993272634
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.797325850374       1
[INPUT] 0    0    [1    /1   ]  24413.7941407        1
[INPUT] 0    0    [1    /1   ]  3661.45391204        1
[INPUT] 0    0    [1    /1   ]  833.280996834        1
[INPUT] 0    0    [1    /1   ]  235.653284475        1
[INPUT] 0    0    [1    /1   ]  76.5148671887        1
[INPUT] 0    0    [1    /1   ]  11.5284546191        1
[INPUT] 0    0    [1    /1   ]  28.2493914266        1
[INPUT] 0    0    [1    /1   ]  0.305636442257       1
[INPUT] 0    0    [1    /1   ]  2.00083651922        1
[INPUT] 0    0    [1    /1   ]  4.8559226736         1
[INPUT] 1    0    [1    /1   ]  3.64530730106        1
[INPUT] 1    0    [1    /1   ]  12.3272167591        1
[INPUT] 1    0    [1    /1   ]  54.790884614         1
[INPUT] 1    0    [1    /1   ]  0.327928988645       1
[INPUT] 1    0    [1    /1   ]  1.13334816229        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7973258503744407, 1.0]], [0, [24413.794140719856, 1.0]], [0, [3661.453912041286, 1.0]], [0, [833.280996833615, 1.0]], [0, [235.65328447490757, 1.0]], [0, [76.51486718867133, 1.0]], [0, [11.52845461908437, 1.0]], [0, [28.249391426578335, 1.0]], [0, [0.30563644225720943, 1.0]], [0, [2.0008365192151, 1.0]], [0, [4.855922673597994, 1.0]], [1, [3.6453073010636587, 1.0]], [1, [12.327216759135908, 1.0]], [1, [54.790884613952365, 1.0]], [1, [0.32792898864532666, 1.0]], [1, [1.1333481622896662, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79732585]
bas 1, expnt(s) = [24413.79414072]
bas 2, expnt(s) = [3661.45391204]
bas 3, expnt(s) = [833.28099683]
bas 4, expnt(s) = [235.65328447]
bas 5, expnt(s) = [76.51486719]
bas 6, expnt(s) = [11.52845462]
bas 7, expnt(s) = [28.24939143]
bas 8, expnt(s) = [0.30563644]
bas 9, expnt(s) = [2.00083652]
bas 10, expnt(s) = [4.85592267]
bas 11, expnt(s) = [3.6453073]
bas 12, expnt(s) = [12.32721676]
bas 13, expnt(s) = [54.79088461]
bas 14, expnt(s) = [0.32792899]
bas 15, expnt(s) = [1.13334816]
CPU time:       238.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.97325850e-01 2.13177767e+00 2.44137941e+04 4.93448102e+03
 3.66145391e+03 1.18920083e+03 8.33280997e+02 3.91839878e+02
 2.35653284e+02 1.51956803e+02 7.65148672e+01 6.53618590e+01
 1.15284546e+01 1.58067777e+01 2.82493914e+01 3.09579252e+01
 3.05636442e-01 1.03852959e+00 2.00083652e+00 4.25034055e+00
 4.85592267e+00 8.26454305e+00 3.64530730e+00 1.46944073e+01
 1.23272168e+01 6.73853802e+01 5.47908846e+01 4.34880348e+02
 3.27928989e-01 7.23950970e-01 1.13334816e+00 3.41144657e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998548231927625
cond(S) = 1261.3219436929303
E1 = -183.57824831946954  E_coul = 55.07844909974845
init E= -128.499799219721
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945760999333  LUMO = 0.806263274066283
  mo_energy =
[-3.25554854e+01 -1.85291179e+00 -7.73945761e-01 -7.73945761e-01
 -7.73945761e-01  8.06263274e-01  1.10505825e+00  1.10505825e+00
  1.10505825e+00  4.45909023e+00  5.71530066e+00  5.71530066e+00
  5.71530066e+00  1.60111120e+01  2.39269674e+01  2.39269674e+01
  2.39269674e+01  5.13317611e+01  1.18588866e+02  1.18588866e+02
  1.18588866e+02  1.60838630e+02  5.26063667e+02  1.89212976e+03
  8.01936383e+03  4.77837753e+04]
E1 = -182.10776790095824  E_coul = 53.57867463635282
cycle= 1 E= -128.529093264605  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462772
diis-c [-0.21415762  1.        ]
  HOMO = -0.879862731586719  LUMO = 0.778662830277593
  mo_energy =
[-3.28746939e+01 -1.96346074e+00 -8.79862732e-01 -8.79862732e-01
 -8.79862732e-01  7.78662830e-01  1.06715838e+00  1.06715838e+00
  1.06715838e+00  4.37570124e+00  5.58699489e+00  5.58699489e+00
  5.58699489e+00  1.58445533e+01  2.36923390e+01  2.36923390e+01
  2.36923390e+01  5.10802730e+01  1.18267346e+02  1.18267346e+02
  1.18267346e+02  1.60525278e+02  5.25706386e+02  1.89173587e+03
  8.01894069e+03  4.77833332e+04]
E1 = -182.84191134723977  E_coul = 54.31030371163933
cycle= 2 E= -128.5316076356  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231572
diis-c [-0.00067675  0.33245347  0.66754653]
  HOMO = -0.845421913965467  LUMO = 0.787624347831171
  mo_energy =
[-3.27694617e+01 -1.92725017e+00 -8.45421914e-01 -8.45421914e-01
 -8.45421914e-01  7.87624348e-01  1.07954245e+00  1.07954245e+00
  1.07954245e+00  4.40263668e+00  5.62871471e+00  5.62871471e+00
  5.62871471e+00  1.58991022e+01  2.37698002e+01  2.37698002e+01
  2.37698002e+01  5.11635539e+01  1.18372612e+02  1.18372612e+02
  1.18372612e+02  1.60628289e+02  5.25820031e+02  1.89185487e+03
  8.01906216e+03  4.77834556e+04]
E1 = -182.59565246481958  E_coul = 54.063192552819366
cycle= 3 E= -128.532459912  delta_E= -0.000852  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000889412
diis-c [-1.49127869e-07 -2.21538968e-03 -9.74043819e-04  1.00318943e+00]
  HOMO = -0.845650627466987  LUMO = 0.787589103588946
  mo_energy =
[-3.27698500e+01 -1.92741407e+00 -8.45650627e-01 -8.45650627e-01
 -8.45650627e-01  7.87589104e-01  1.07949427e+00  1.07949427e+00
  1.07949427e+00  4.40250666e+00  5.62851989e+00  5.62851989e+00
  5.62851989e+00  1.58988634e+01  2.37694926e+01  2.37694926e+01
  2.37694926e+01  5.11632364e+01  1.18372212e+02  1.18372212e+02
  1.18372212e+02  1.60627900e+02  5.25819545e+02  1.89185428e+03
  8.01906148e+03  4.77834549e+04]
E1 = -182.59608718120896  E_coul = 54.063627249040216
cycle= 4 E= -128.532459932169  delta_E= -2.02e-08  |g|= 6.43e-05  |ddm|= 0.000312
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133158
diis-c [-1.03936438e-09  3.18496192e-04  4.82132152e-04 -2.13080589e-01
  1.21227996e+00]
  HOMO = -0.845683428634551  LUMO = 0.787582009273801
  mo_energy =
[-3.27699034e+01 -1.92743439e+00 -8.45683429e-01 -8.45683429e-01
 -8.45683429e-01  7.87582009e-01  1.07948055e+00  1.07948055e+00
  1.07948055e+00  4.40248351e+00  5.62848377e+00  5.62848377e+00
  5.62848377e+00  1.58988234e+01  2.37694444e+01  2.37694444e+01
  2.37694444e+01  5.11631876e+01  1.18372158e+02  1.18372158e+02
  1.18372158e+02  1.60627847e+02  5.25819484e+02  1.89185421e+03
  8.01906141e+03  4.77834548e+04]
E1 = -182.59619136004352  E_coul = 54.06373142731994
cycle= 5 E= -128.532459932724  delta_E= -5.55e-10  |g|= 6.8e-06  |ddm|= 5.4e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59619136004352  E_coul = 54.06373142731994
  HOMO = -0.845679698098973  LUMO = 0.787583497404524
  mo_energy =
[-3.27698952e+01 -1.92742993e+00 -8.45679698e-01 -8.45679698e-01
 -8.45679698e-01  7.87583497e-01  1.07948211e+00  1.07948211e+00
  1.07948211e+00  4.40248705e+00  5.62848828e+00  5.62848828e+00
  5.62848828e+00  1.58988291e+01  2.37694514e+01  2.37694514e+01
  2.37694514e+01  5.11631949e+01  1.18372166e+02  1.18372166e+02
  1.18372166e+02  1.60627855e+02  5.25819492e+02  1.89185421e+03
  8.01906142e+03  4.77834548e+04]
E1 = -182.59617343105552  E_coul = 54.06371349832917
Extra cycle  E= -128.532459932726  delta_E= -2.76e-12  |g|= 2.51e-06  |ddm|= 2.53e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1261.3219436929303
E1 = -182.59617343105552  E_coul = 54.06371349832917
init E= -128.532459932726
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845680951938907  LUMO = 0.787583241157149
  mo_energy =
[-3.27698992e+01 -1.92743114e+00 -8.45680952e-01 -8.45680952e-01
 -8.45680952e-01  7.87583241e-01  1.07948167e+00  1.07948167e+00
  1.07948167e+00  4.40248616e+00  5.62848676e+00  5.62848676e+00
  5.62848676e+00  1.58988272e+01  2.37694485e+01  2.37694485e+01
  2.37694485e+01  5.11631918e+01  1.18372162e+02  1.18372162e+02
  1.18372162e+02  1.60627851e+02  5.25819487e+02  1.89185421e+03
  8.01906141e+03  4.77834548e+04]
E1 = -182.5961831095298  E_coul = 54.06372317680299
cycle= 1 E= -128.532459932727  delta_E= -4.55e-13  |g|= 1.33e-06  |ddm|= 9.59e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5961831095298  E_coul = 54.06372317680299
  HOMO = -0.845680271381759  LUMO = 0.787583430428403
  mo_energy =
[-3.27698972e+01 -1.92743040e+00 -8.45680271e-01 -8.45680271e-01
 -8.45680271e-01  7.87583430e-01  1.07948192e+00  1.07948192e+00
  1.07948192e+00  4.40248671e+00  5.62848759e+00  5.62848759e+00
  5.62848759e+00  1.58988283e+01  2.37694500e+01  2.37694500e+01
  2.37694500e+01  5.11631934e+01  1.18372164e+02  1.18372164e+02
  1.18372164e+02  1.60627853e+02  5.25819489e+02  1.89185421e+03
  8.01906141e+03  4.77834548e+04]
E1 = -182.59617829814516  E_coul = 54.06371836541828
Extra cycle  E= -128.532459932727  delta_E= -8.53e-14  |g|= 6.55e-07  |ddm|= 4.67e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [7.97325850e-01 2.44137941e+04 3.66145391e+03 8.33280997e+02
 2.35653284e+02 7.65148672e+01 1.15284546e+01 2.82493914e+01
 3.05636442e-01 2.00083652e+00 4.85592267e+00 3.64530730e+00
 1.23272168e+01 5.47908846e+01 3.27928989e-01 1.13334816e+00]
grad_E = [ 2.25429208e-04 -1.41646161e-09  7.43766860e-08 -1.44733219e-06
  1.49816478e-05 -6.19951448e-05 -1.24891861e-05 -1.19489409e-05
 -3.94886580e-04 -4.01499376e-05  3.16715249e-06 -2.39719633e-05
 -1.90283619e-04  3.12922069e-05 -1.54214865e-04 -5.89305179e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.793488040613       1
[INPUT] 0    0    [1    /1   ]  24413.7941409        1
[INPUT] 0    0    [1    /1   ]  3661.45390096        1
[INPUT] 0    0    [1    /1   ]  833.281195512        1
[INPUT] 0    0    [1    /1   ]  235.651622894        1
[INPUT] 0    0    [1    /1   ]  76.5171487604        1
[INPUT] 0    0    [1    /1   ]  11.5585804056        1
[INPUT] 0    0    [1    /1   ]  28.2705011598        1
[INPUT] 0    0    [1    /1   ]  0.305149300064       1
[INPUT] 0    0    [1    /1   ]  1.99550623216        1
[INPUT] 0    0    [1    /1   ]  4.8918009199         1
[INPUT] 1    0    [1    /1   ]  3.64444607138        1
[INPUT] 1    0    [1    /1   ]  12.3254783081        1
[INPUT] 1    0    [1    /1   ]  54.7909205737        1
[INPUT] 1    0    [1    /1   ]  0.327902321132       1
[INPUT] 1    0    [1    /1   ]  1.13307943034        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7934880406132465, 1.0]], [0, [24413.79414093296, 1.0]], [0, [3661.453900956572, 1.0]], [0, [833.2811955116761, 1.0]], [0, [235.6516228935982, 1.0]], [0, [76.51714876036871, 1.0]], [0, [11.558580405602111, 1.0]], [0, [28.270501159780885, 1.0]], [0, [0.3051493000640131, 1.0]], [0, [1.995506232162292, 1.0]], [0, [4.891800919903703, 1.0]], [1, [3.6444460713807683, 1.0]], [1, [12.325478308059123, 1.0]], [1, [54.790920573668195, 1.0]], [1, [0.3279023211320426, 1.0]], [1, [1.1330794303367069, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79348804]
bas 1, expnt(s) = [24413.79414093]
bas 2, expnt(s) = [3661.45390096]
bas 3, expnt(s) = [833.28119551]
bas 4, expnt(s) = [235.65162289]
bas 5, expnt(s) = [76.51714876]
bas 6, expnt(s) = [11.55858041]
bas 7, expnt(s) = [28.27050116]
bas 8, expnt(s) = [0.3051493]
bas 9, expnt(s) = [1.99550623]
bas 10, expnt(s) = [4.89180092]
bas 11, expnt(s) = [3.64444607]
bas 12, expnt(s) = [12.32547831]
bas 13, expnt(s) = [54.79092057]
bas 14, expnt(s) = [0.32790232]
bas 15, expnt(s) = [1.13307943]
CPU time:       241.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.93488041e-01 2.12407728e+00 2.44137941e+04 4.93448102e+03
 3.66145390e+03 1.18920083e+03 8.33281196e+02 3.91839948e+02
 2.35651623e+02 1.51955999e+02 7.65171488e+01 6.53633208e+01
 1.15585804e+01 1.58377469e+01 2.82705012e+01 3.09752739e+01
 3.05149300e-01 1.03728789e+00 1.99550623e+00 4.24184544e+00
 4.89180092e+00 8.31029814e+00 3.64444607e+00 1.46900679e+01
 1.23254783e+01 6.73735016e+01 5.47909206e+01 4.34880705e+02
 3.27902321e-01 7.23877381e-01 1.13307943e+00 3.41043547e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99854943413105
cond(S) = 1254.2582389384131
E1 = -183.57825548588227  E_coul = 55.07844780024302
init E= -128.499807685639
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945906715234  LUMO = 0.803586681439125
  mo_energy =
[-3.25554862e+01 -1.85291190e+00 -7.73945907e-01 -7.73945907e-01
 -7.73945907e-01  8.03586681e-01  1.10489093e+00  1.10489093e+00
  1.10489093e+00  4.44644318e+00  5.71392335e+00  5.71392335e+00
  5.71392335e+00  1.60310454e+01  2.39216511e+01  2.39216511e+01
  2.39216511e+01  5.14694899e+01  1.18580155e+02  1.18580155e+02
  1.18580155e+02  1.61091217e+02  5.26357936e+02  1.89241093e+03
  8.01961434e+03  4.77839833e+04]
E1 = -182.10781147718637  E_coul = 53.57871776968161
cycle= 1 E= -128.529093707505  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462765
diis-c [-0.21415137  1.        ]
  HOMO = -0.879857614380014  LUMO = 0.776091370035021
  mo_energy =
[-3.28746915e+01 -1.96345717e+00 -8.79857614e-01 -8.79857614e-01
 -8.79857614e-01  7.76091370e-01  1.06700411e+00  1.06700411e+00
  1.06700411e+00  4.36310554e+00  5.58564341e+00  5.58564341e+00
  5.58564341e+00  1.58641380e+01  2.36870395e+01  2.36870395e+01
  2.36870395e+01  5.12177945e+01  1.18258638e+02  1.18258638e+02
  1.18258638e+02  1.60777839e+02  5.26000660e+02  1.89201705e+03
  8.01919120e+03  4.77835412e+04]
E1 = -182.8419765200361  E_coul = 54.31036836688575
cycle= 2 E= -128.53160815315  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231576
diis-c [-0.00067744  0.33245947  0.66754053]
  HOMO = -0.845415859935306  LUMO = 0.785020538144276
  mo_energy =
[-3.27694581e+01 -1.92724566e+00 -8.45415860e-01 -8.45415860e-01
 -8.45415860e-01  7.85020538e-01  1.07938572e+00  1.07938572e+00
  1.07938572e+00  4.39002757e+00  5.62735705e+00  5.62735705e+00
  5.62735705e+00  1.59188077e+01  2.37644980e+01  2.37644980e+01
  2.37644980e+01  5.13011480e+01  1.18363906e+02  1.18363906e+02
  1.18363906e+02  1.60880860e+02  5.26114305e+02  1.89213605e+03
  8.01931268e+03  4.77836636e+04]
E1 = -182.59572135330018  E_coul = 54.063260910797844
cycle= 3 E= -128.532460442502  delta_E= -0.000852  |g|= 0.00045  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000885856
diis-c [-1.48478002e-07 -2.21177319e-03 -9.82280051e-04  1.00319405e+00]
  HOMO = -0.845643547077887  LUMO = 0.784985796216647
  mo_energy =
[-3.27698446e+01 -1.92740864e+00 -8.45643547e-01 -8.45643547e-01
 -8.45643547e-01  7.84985796e-01  1.07933803e+00  1.07933803e+00
  1.07933803e+00  4.38989862e+00  5.62716338e+00  5.62716338e+00
  5.62716338e+00  1.59185699e+01  2.37641920e+01  2.37641920e+01
  2.37641920e+01  5.13008319e+01  1.18363508e+02  1.18363508e+02
  1.18363508e+02  1.60880473e+02  5.26113821e+02  1.89213546e+03
  8.01931200e+03  4.77836629e+04]
E1 = -182.59615333292766  E_coul = 54.06369287045496
cycle= 4 E= -128.532460462473  delta_E= -2e-08  |g|= 6.41e-05  |ddm|= 0.000309
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001329
diis-c [-1.03484703e-09  3.17989978e-04  4.83669438e-04 -2.12997326e-01
  1.21219567e+00]
  HOMO = -0.845676246174606  LUMO = 0.784978755233761
  mo_energy =
[-3.27698979e+01 -1.92742890e+00 -8.45676246e-01 -8.45676246e-01
 -8.45676246e-01  7.84978755e-01  1.07932436e+00  1.07932436e+00
  1.07932436e+00  4.38987558e+00  5.62712737e+00  5.62712737e+00
  5.62712737e+00  1.59185300e+01  2.37641440e+01  2.37641440e+01
  2.37641440e+01  5.13007832e+01  1.18363454e+02  1.18363454e+02
  1.18363454e+02  1.60880419e+02  5.26113760e+02  1.89213539e+03
  8.01931192e+03  4.77836629e+04]
E1 = -182.5962573865162  E_coul = 54.06379692349155
cycle= 5 E= -128.532460463025  delta_E= -5.52e-10  |g|= 6.78e-06  |ddm|= 5.37e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5962573865162  E_coul = 54.06379692349155
  HOMO = -0.845672526257393  LUMO = 0.784980233986968
  mo_energy =
[-3.27698897e+01 -1.92742445e+00 -8.45672526e-01 -8.45672526e-01
 -8.45672526e-01  7.84980234e-01  1.07932591e+00  1.07932591e+00
  1.07932591e+00  4.38987911e+00  5.62713186e+00  5.62713186e+00
  5.62713186e+00  1.59185358e+01  2.37641509e+01  2.37641509e+01
  2.37641509e+01  5.13007905e+01  1.18363462e+02  1.18363462e+02
  1.18363462e+02  1.60880427e+02  5.26113768e+02  1.89213539e+03
  8.01931193e+03  4.77836629e+04]
E1 = -182.59623948270882  E_coul = 54.06377901968144
Extra cycle  E= -128.532460463027  delta_E= -2.7e-12  |g|= 2.51e-06  |ddm|= 2.51e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [7.93488041e-01 2.44137941e+04 3.66145390e+03 8.33281196e+02
 2.35651623e+02 7.65171488e+01 1.15585804e+01 2.82705012e+01
 3.05149300e-01 1.99550623e+00 4.89180092e+00 3.64444607e+00
 1.23254783e+01 5.47909206e+01 3.27902321e-01 1.13307943e+00]
E = -128.53246046302738
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.793488040613       1
[INPUT] 0    0    [1    /1   ]  24413.7941409        1
[INPUT] 0    0    [1    /1   ]  3661.45390096        1
[INPUT] 0    0    [1    /1   ]  833.281195512        1
[INPUT] 0    0    [1    /1   ]  235.651622894        1
[INPUT] 0    0    [1    /1   ]  76.5171487604        1
[INPUT] 0    0    [1    /1   ]  11.5585804056        1
[INPUT] 0    0    [1    /1   ]  28.2705011598        1
[INPUT] 0    0    [1    /1   ]  0.305149300064       1
[INPUT] 0    0    [1    /1   ]  1.99550623216        1
[INPUT] 0    0    [1    /1   ]  4.8918009199         1
[INPUT] 1    0    [1    /1   ]  3.64444607138        1
[INPUT] 1    0    [1    /1   ]  12.3254783081        1
[INPUT] 1    0    [1    /1   ]  54.7909205737        1
[INPUT] 1    0    [1    /1   ]  0.327902321132       1
[INPUT] 1    0    [1    /1   ]  1.13307943034        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7934880406132465, 1.0]], [0, [24413.79414093296, 1.0]], [0, [3661.453900956572, 1.0]], [0, [833.2811955116761, 1.0]], [0, [235.6516228935982, 1.0]], [0, [76.51714876036871, 1.0]], [0, [11.558580405602111, 1.0]], [0, [28.270501159780885, 1.0]], [0, [0.3051493000640131, 1.0]], [0, [1.995506232162292, 1.0]], [0, [4.891800919903703, 1.0]], [1, [3.6444460713807683, 1.0]], [1, [12.325478308059123, 1.0]], [1, [54.790920573668195, 1.0]], [1, [0.3279023211320426, 1.0]], [1, [1.1330794303367069, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79348804]
bas 1, expnt(s) = [24413.79414093]
bas 2, expnt(s) = [3661.45390096]
bas 3, expnt(s) = [833.28119551]
bas 4, expnt(s) = [235.65162289]
bas 5, expnt(s) = [76.51714876]
bas 6, expnt(s) = [11.55858041]
bas 7, expnt(s) = [28.27050116]
bas 8, expnt(s) = [0.3051493]
bas 9, expnt(s) = [1.99550623]
bas 10, expnt(s) = [4.89180092]
bas 11, expnt(s) = [3.64444607]
bas 12, expnt(s) = [12.32547831]
bas 13, expnt(s) = [54.79092057]
bas 14, expnt(s) = [0.32790232]
bas 15, expnt(s) = [1.13307943]
CPU time:       242.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.93488041e-01 2.12407728e+00 2.44137941e+04 4.93448102e+03
 3.66145390e+03 1.18920083e+03 8.33281196e+02 3.91839948e+02
 2.35651623e+02 1.51955999e+02 7.65171488e+01 6.53633208e+01
 1.15585804e+01 1.58377469e+01 2.82705012e+01 3.09752739e+01
 3.05149300e-01 1.03728789e+00 1.99550623e+00 4.24184544e+00
 4.89180092e+00 8.31029814e+00 3.64444607e+00 1.46900679e+01
 1.23254783e+01 6.73735016e+01 5.47909206e+01 4.34880705e+02
 3.27902321e-01 7.23877381e-01 1.13307943e+00 3.41043547e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99854943413105
cond(S) = 1254.2582389384131
E1 = -183.57825548588227  E_coul = 55.07844780024302
init E= -128.499807685639
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945906715234  LUMO = 0.803586681439125
  mo_energy =
[-3.25554862e+01 -1.85291190e+00 -7.73945907e-01 -7.73945907e-01
 -7.73945907e-01  8.03586681e-01  1.10489093e+00  1.10489093e+00
  1.10489093e+00  4.44644318e+00  5.71392335e+00  5.71392335e+00
  5.71392335e+00  1.60310454e+01  2.39216511e+01  2.39216511e+01
  2.39216511e+01  5.14694899e+01  1.18580155e+02  1.18580155e+02
  1.18580155e+02  1.61091217e+02  5.26357936e+02  1.89241093e+03
  8.01961434e+03  4.77839833e+04]
E1 = -182.10781147718637  E_coul = 53.57871776968161
cycle= 1 E= -128.529093707505  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462765
diis-c [-0.21415137  1.        ]
  HOMO = -0.879857614380014  LUMO = 0.776091370035021
  mo_energy =
[-3.28746915e+01 -1.96345717e+00 -8.79857614e-01 -8.79857614e-01
 -8.79857614e-01  7.76091370e-01  1.06700411e+00  1.06700411e+00
  1.06700411e+00  4.36310554e+00  5.58564341e+00  5.58564341e+00
  5.58564341e+00  1.58641380e+01  2.36870395e+01  2.36870395e+01
  2.36870395e+01  5.12177945e+01  1.18258638e+02  1.18258638e+02
  1.18258638e+02  1.60777839e+02  5.26000660e+02  1.89201705e+03
  8.01919120e+03  4.77835412e+04]
E1 = -182.8419765200361  E_coul = 54.31036836688575
cycle= 2 E= -128.53160815315  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231576
diis-c [-0.00067744  0.33245947  0.66754053]
  HOMO = -0.845415859935306  LUMO = 0.785020538144276
  mo_energy =
[-3.27694581e+01 -1.92724566e+00 -8.45415860e-01 -8.45415860e-01
 -8.45415860e-01  7.85020538e-01  1.07938572e+00  1.07938572e+00
  1.07938572e+00  4.39002757e+00  5.62735705e+00  5.62735705e+00
  5.62735705e+00  1.59188077e+01  2.37644980e+01  2.37644980e+01
  2.37644980e+01  5.13011480e+01  1.18363906e+02  1.18363906e+02
  1.18363906e+02  1.60880860e+02  5.26114305e+02  1.89213605e+03
  8.01931268e+03  4.77836636e+04]
E1 = -182.59572135330018  E_coul = 54.063260910797844
cycle= 3 E= -128.532460442502  delta_E= -0.000852  |g|= 0.00045  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000885856
diis-c [-1.48478002e-07 -2.21177319e-03 -9.82280051e-04  1.00319405e+00]
  HOMO = -0.845643547077887  LUMO = 0.784985796216647
  mo_energy =
[-3.27698446e+01 -1.92740864e+00 -8.45643547e-01 -8.45643547e-01
 -8.45643547e-01  7.84985796e-01  1.07933803e+00  1.07933803e+00
  1.07933803e+00  4.38989862e+00  5.62716338e+00  5.62716338e+00
  5.62716338e+00  1.59185699e+01  2.37641920e+01  2.37641920e+01
  2.37641920e+01  5.13008319e+01  1.18363508e+02  1.18363508e+02
  1.18363508e+02  1.60880473e+02  5.26113821e+02  1.89213546e+03
  8.01931200e+03  4.77836629e+04]
E1 = -182.59615333292766  E_coul = 54.06369287045496
cycle= 4 E= -128.532460462473  delta_E= -2e-08  |g|= 6.41e-05  |ddm|= 0.000309
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001329
diis-c [-1.03484703e-09  3.17989978e-04  4.83669438e-04 -2.12997326e-01
  1.21219567e+00]
  HOMO = -0.845676246174606  LUMO = 0.784978755233761
  mo_energy =
[-3.27698979e+01 -1.92742890e+00 -8.45676246e-01 -8.45676246e-01
 -8.45676246e-01  7.84978755e-01  1.07932436e+00  1.07932436e+00
  1.07932436e+00  4.38987558e+00  5.62712737e+00  5.62712737e+00
  5.62712737e+00  1.59185300e+01  2.37641440e+01  2.37641440e+01
  2.37641440e+01  5.13007832e+01  1.18363454e+02  1.18363454e+02
  1.18363454e+02  1.60880419e+02  5.26113760e+02  1.89213539e+03
  8.01931192e+03  4.77836629e+04]
E1 = -182.5962573865162  E_coul = 54.06379692349155
cycle= 5 E= -128.532460463025  delta_E= -5.52e-10  |g|= 6.78e-06  |ddm|= 5.37e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5962573865162  E_coul = 54.06379692349155
  HOMO = -0.845672526257393  LUMO = 0.784980233986968
  mo_energy =
[-3.27698897e+01 -1.92742445e+00 -8.45672526e-01 -8.45672526e-01
 -8.45672526e-01  7.84980234e-01  1.07932591e+00  1.07932591e+00
  1.07932591e+00  4.38987911e+00  5.62713186e+00  5.62713186e+00
  5.62713186e+00  1.59185358e+01  2.37641509e+01  2.37641509e+01
  2.37641509e+01  5.13007905e+01  1.18363462e+02  1.18363462e+02
  1.18363462e+02  1.60880427e+02  5.26113768e+02  1.89213539e+03
  8.01931193e+03  4.77836629e+04]
E1 = -182.59623948270882  E_coul = 54.06377901968144
Extra cycle  E= -128.532460463027  delta_E= -2.7e-12  |g|= 2.51e-06  |ddm|= 2.51e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1254.2582389384131
E1 = -182.59623948270882  E_coul = 54.06377901968144
init E= -128.532460463027
    CPU time for initialize scf      0.25 sec, wall time      0.26 sec
  HOMO = -0.845673778531082  LUMO = 0.784979978947209
  mo_energy =
[-3.27698937e+01 -1.92742565e+00 -8.45673779e-01 -8.45673779e-01
 -8.45673779e-01  7.84979979e-01  1.07932547e+00  1.07932547e+00
  1.07932547e+00  4.38987822e+00  5.62713035e+00  5.62713035e+00
  5.62713035e+00  1.59185338e+01  2.37641480e+01  2.37641480e+01
  2.37641480e+01  5.13007874e+01  1.18363458e+02  1.18363458e+02
  1.18363458e+02  1.60880423e+02  5.26113764e+02  1.89213539e+03
  8.01931193e+03  4.77836629e+04]
E1 = -182.59624914421192  E_coul = 54.063788681184256
cycle= 1 E= -128.532460463028  delta_E= -2.84e-13  |g|= 1.32e-06  |ddm|= 9.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59624914421192  E_coul = 54.063788681184256
  HOMO = -0.845673099193393  LUMO = 0.78498016719478
  mo_energy =
[-3.27698917e+01 -1.92742491e+00 -8.45673099e-01 -8.45673099e-01
 -8.45673099e-01  7.84980167e-01  1.07932572e+00  1.07932572e+00
  1.07932572e+00  4.38987876e+00  5.62713118e+00  5.62713118e+00
  5.62713118e+00  1.59185349e+01  2.37641496e+01  2.37641496e+01
  2.37641496e+01  5.13007890e+01  1.18363460e+02  1.18363460e+02
  1.18363460e+02  1.60880425e+02  5.26113766e+02  1.89213539e+03
  8.01931193e+03  4.77836629e+04]
E1 = -182.59624434102057  E_coul = 54.063783877992655
Extra cycle  E= -128.532460463028  delta_E= -2.56e-13  |g|= 6.54e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.31 sec
exp = [7.93488041e-01 2.44137941e+04 3.66145390e+03 8.33281196e+02
 2.35651623e+02 7.65171488e+01 1.15585804e+01 2.82705012e+01
 3.05149300e-01 1.99550623e+00 4.89180092e+00 3.64444607e+00
 1.23254783e+01 5.47909206e+01 3.27902321e-01 1.13307943e+00]
grad_E = [ 4.94132015e-05 -1.43140691e-09  7.51672692e-08 -1.46291318e-06
  1.51468056e-05 -6.25835893e-05 -9.69932687e-06 -1.26098433e-05
 -1.04922859e-04 -1.02102088e-05  3.64263512e-06 -2.79956202e-05
 -1.89767539e-04  3.15832120e-05  4.37661848e-06 -1.21456740e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.792913196417       1
[INPUT] 0    0    [1    /1   ]  24413.7941412        1
[INPUT] 0    0    [1    /1   ]  3661.45388832        1
[INPUT] 0    0    [1    /1   ]  833.281420253        1
[INPUT] 0    0    [1    /1   ]  235.649796238        1
[INPUT] 0    0    [1    /1   ]  76.5186943189        1
[INPUT] 0    0    [1    /1   ]  11.6003503967        1
[INPUT] 0    0    [1    /1   ]  28.2985295022        1
[INPUT] 0    0    [1    /1   ]  0.305161413193       1
[INPUT] 0    0    [1    /1   ]  1.99758938283        1
[INPUT] 0    0    [1    /1   ]  4.93792600785        1
[INPUT] 1    0    [1    /1   ]  3.64385424868        1
[INPUT] 1    0    [1    /1   ]  12.3233979444        1
[INPUT] 1    0    [1    /1   ]  54.7909179449        1
[INPUT] 1    0    [1    /1   ]  0.327914781476       1
[INPUT] 1    0    [1    /1   ]  1.13302652934        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7929131964165165, 1.0]], [0, [24413.794141176055, 1.0]], [0, [3661.453888317782, 1.0]], [0, [833.281420252882, 1.0]], [0, [235.64979623778103, 1.0]], [0, [76.51869431889732, 1.0]], [0, [11.600350396729151, 1.0]], [0, [28.298529502155617, 1.0]], [0, [0.3051614131929248, 1.0]], [0, [1.997589382828995, 1.0]], [0, [4.9379260078497325, 1.0]], [1, [3.6438542486803267, 1.0]], [1, [12.323397944372143, 1.0]], [1, [54.79091794489168, 1.0]], [1, [0.3279147814756176, 1.0]], [1, [1.133026529344764, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7929132]
bas 1, expnt(s) = [24413.79414118]
bas 2, expnt(s) = [3661.45388832]
bas 3, expnt(s) = [833.28142025]
bas 4, expnt(s) = [235.64979624]
bas 5, expnt(s) = [76.51869432]
bas 6, expnt(s) = [11.6003504]
bas 7, expnt(s) = [28.2985295]
bas 8, expnt(s) = [0.30516141]
bas 9, expnt(s) = [1.99758938]
bas 10, expnt(s) = [4.93792601]
bas 11, expnt(s) = [3.64385425]
bas 12, expnt(s) = [12.32339794]
bas 13, expnt(s) = [54.79091794]
bas 14, expnt(s) = [0.32791478]
bas 15, expnt(s) = [1.13302653]
CPU time:       245.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.92913196e-01 2.12292308e+00 2.44137941e+04 4.93448102e+03
 3.66145389e+03 1.18920082e+03 8.33281420e+02 3.91840027e+02
 2.35649796e+02 1.51955116e+02 7.65186943e+01 6.53643110e+01
 1.16003504e+01 1.58806529e+01 2.82985295e+01 3.09983035e+01
 3.05161413e-01 1.03731877e+00 1.99758938e+00 4.24516612e+00
 4.93792601e+00 8.36899788e+00 3.64385425e+00 1.46870860e+01
 1.23233979e+01 6.73592873e+01 5.47909179e+01 4.34880679e+02
 3.27914781e-01 7.23911765e-01 1.13302653e+00 3.41023644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998549453948172
cond(S) = 1256.6574201423537
E1 = -183.57826054636146  E_coul = 55.07844959589584
init E= -128.499810950466
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77394556965457  LUMO = 0.803791819473697
  mo_energy =
[-3.25554869e+01 -1.85291137e+00 -7.73945570e-01 -7.73945570e-01
 -7.73945570e-01  8.03791819e-01  1.10491257e+00  1.10491257e+00
  1.10491257e+00  4.45206559e+00  5.71346598e+00  5.71346598e+00
  5.71346598e+00  1.61045070e+01  2.39176153e+01  2.39176153e+01
  2.39176153e+01  5.17093182e+01  1.18571751e+02  1.18571751e+02
  1.18571751e+02  1.61482668e+02  5.26798477e+02  1.89282815e+03
  8.01998548e+03  4.77842914e+04]
E1 = -182.1078627292982  E_coul = 53.5787686510256
cycle= 1 E= -128.529094078273  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462724
diis-c [-0.21411331  1.        ]
  HOMO = -0.87985271640252  LUMO = 0.776285841183845
  mo_energy =
[-3.28746855e+01 -1.96345252e+00 -8.79852716e-01 -8.79852716e-01
 -8.79852716e-01  7.76285841e-01  1.06702920e+00  1.06702920e+00
  1.06702920e+00  4.36852821e+00  5.58520273e+00  5.58520273e+00
  5.58520273e+00  1.59370644e+01  2.36830253e+01  2.36830253e+01
  2.36830253e+01  5.14573663e+01  1.18250241e+02  1.18250241e+02
  1.18250241e+02  1.61169267e+02  5.26441215e+02  1.89243428e+03
  8.01956234e+03  4.77838493e+04]
E1 = -182.84201032539298  E_coul = 54.310401895137424
cycle= 2 E= -128.531608430256  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.23156
diis-c [-0.00067857  0.33246174  0.66753826]
  HOMO = -0.845411860466814  LUMO = 0.785218607993431
  mo_energy =
[-3.27694550e+01 -1.92724201e+00 -8.45411860e-01 -8.45411860e-01
 -8.45411860e-01  7.85218608e-01  1.07941023e+00  1.07941023e+00
  1.07941023e+00  4.39551657e+00  5.62691120e+00  5.62691120e+00
  5.62691120e+00  1.59919150e+01  2.37604769e+01  2.37604769e+01
  2.37604769e+01  5.15408061e+01  1.18355506e+02  1.18355506e+02
  1.18355506e+02  1.61272294e+02  5.26554855e+02  1.89255327e+03
  8.01968382e+03  4.77839717e+04]
E1 = -182.5957666915541  E_coul = 54.06330602518494
cycle= 3 E= -128.532460666369  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000883946
diis-c [-1.47927010e-07 -2.21029759e-03 -9.86832332e-04  1.00319713e+00]
  HOMO = -0.84563907945786  LUMO = 0.785183994174483
  mo_energy =
[-3.27698406e+01 -1.92740457e+00 -8.45639079e-01 -8.45639079e-01
 -8.45639079e-01  7.85183994e-01  1.07936274e+00  1.07936274e+00
  1.07936274e+00  4.39538776e+00  5.62671806e+00  5.62671806e+00
  5.62671806e+00  1.59916773e+01  2.37601717e+01  2.37601717e+01
  2.37601717e+01  5.15404906e+01  1.18355109e+02  1.18355109e+02
  1.18355109e+02  1.61271908e+02  5.26554372e+02  1.89255268e+03
  8.01968314e+03  4.77839710e+04]
E1 = -182.59619699529702  E_coul = 54.06373630905777
cycle= 4 E= -128.532460686239  delta_E= -1.99e-08  |g|= 6.4e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132838
diis-c [-1.03260145e-09  3.17607246e-04  4.85071492e-04 -2.12874770e-01
  1.21207209e+00]
  HOMO = -0.845671743767294  LUMO = 0.785176958025469
  mo_energy =
[-3.27698938e+01 -1.92742482e+00 -8.45671744e-01 -8.45671744e-01
 -8.45671744e-01  7.85176958e-01  1.07934909e+00  1.07934909e+00
  1.07934909e+00  4.39536471e+00  5.62668208e+00  5.62668208e+00
  5.62668208e+00  1.59916374e+01  2.37601237e+01  2.37601237e+01
  2.37601237e+01  5.15404419e+01  1.18355055e+02  1.18355055e+02
  1.18355055e+02  1.61271855e+02  5.26554311e+02  1.89255261e+03
  8.01968307e+03  4.77839709e+04]
E1 = -182.5963010791131  E_coul = 54.063840392323655
cycle= 5 E= -128.532460686789  delta_E= -5.5e-10  |g|= 6.77e-06  |ddm|= 5.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5963010791131  E_coul = 54.063840392323655
  HOMO = -0.845668031164832  LUMO = 0.785178434851719
  mo_energy =
[-3.27698857e+01 -1.92742038e+00 -8.45668031e-01 -8.45668031e-01
 -8.45668031e-01  7.85178435e-01  1.07935064e+00  1.07935064e+00
  1.07935064e+00  4.39536824e+00  5.62668657e+00  5.62668657e+00
  5.62668657e+00  1.59916431e+01  2.37601306e+01  2.37601306e+01
  2.37601306e+01  5.15404492e+01  1.18355063e+02  1.18355063e+02
  1.18355063e+02  1.61271863e+02  5.26554319e+02  1.89255262e+03
  8.01968307e+03  4.77839710e+04]
E1 = -182.59628320347966  E_coul = 54.06382251668724
Extra cycle  E= -128.532460686792  delta_E= -3.01e-12  |g|= 2.5e-06  |ddm|= 2.5e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [7.92913196e-01 2.44137941e+04 3.66145389e+03 8.33281420e+02
 2.35649796e+02 7.65186943e+01 1.16003504e+01 2.82985295e+01
 3.05161413e-01 1.99758938e+00 4.93792601e+00 3.64385425e+00
 1.23233979e+01 5.47909179e+01 3.27914781e-01 1.13302653e+00]
E = -128.53246068679243
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.792913196417       1
[INPUT] 0    0    [1    /1   ]  24413.7941412        1
[INPUT] 0    0    [1    /1   ]  3661.45388832        1
[INPUT] 0    0    [1    /1   ]  833.281420253        1
[INPUT] 0    0    [1    /1   ]  235.649796238        1
[INPUT] 0    0    [1    /1   ]  76.5186943189        1
[INPUT] 0    0    [1    /1   ]  11.6003503967        1
[INPUT] 0    0    [1    /1   ]  28.2985295022        1
[INPUT] 0    0    [1    /1   ]  0.305161413193       1
[INPUT] 0    0    [1    /1   ]  1.99758938283        1
[INPUT] 0    0    [1    /1   ]  4.93792600785        1
[INPUT] 1    0    [1    /1   ]  3.64385424868        1
[INPUT] 1    0    [1    /1   ]  12.3233979444        1
[INPUT] 1    0    [1    /1   ]  54.7909179449        1
[INPUT] 1    0    [1    /1   ]  0.327914781476       1
[INPUT] 1    0    [1    /1   ]  1.13302652934        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7929131964165165, 1.0]], [0, [24413.794141176055, 1.0]], [0, [3661.453888317782, 1.0]], [0, [833.281420252882, 1.0]], [0, [235.64979623778103, 1.0]], [0, [76.51869431889732, 1.0]], [0, [11.600350396729151, 1.0]], [0, [28.298529502155617, 1.0]], [0, [0.3051614131929248, 1.0]], [0, [1.997589382828995, 1.0]], [0, [4.9379260078497325, 1.0]], [1, [3.6438542486803267, 1.0]], [1, [12.323397944372143, 1.0]], [1, [54.79091794489168, 1.0]], [1, [0.3279147814756176, 1.0]], [1, [1.133026529344764, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7929132]
bas 1, expnt(s) = [24413.79414118]
bas 2, expnt(s) = [3661.45388832]
bas 3, expnt(s) = [833.28142025]
bas 4, expnt(s) = [235.64979624]
bas 5, expnt(s) = [76.51869432]
bas 6, expnt(s) = [11.6003504]
bas 7, expnt(s) = [28.2985295]
bas 8, expnt(s) = [0.30516141]
bas 9, expnt(s) = [1.99758938]
bas 10, expnt(s) = [4.93792601]
bas 11, expnt(s) = [3.64385425]
bas 12, expnt(s) = [12.32339794]
bas 13, expnt(s) = [54.79091794]
bas 14, expnt(s) = [0.32791478]
bas 15, expnt(s) = [1.13302653]
CPU time:       246.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.92913196e-01 2.12292308e+00 2.44137941e+04 4.93448102e+03
 3.66145389e+03 1.18920082e+03 8.33281420e+02 3.91840027e+02
 2.35649796e+02 1.51955116e+02 7.65186943e+01 6.53643110e+01
 1.16003504e+01 1.58806529e+01 2.82985295e+01 3.09983035e+01
 3.05161413e-01 1.03731877e+00 1.99758938e+00 4.24516612e+00
 4.93792601e+00 8.36899788e+00 3.64385425e+00 1.46870860e+01
 1.23233979e+01 6.73592873e+01 5.47909179e+01 4.34880679e+02
 3.27914781e-01 7.23911765e-01 1.13302653e+00 3.41023644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998549453948172
cond(S) = 1256.6574201423537
E1 = -183.57826054636146  E_coul = 55.07844959589584
init E= -128.499810950466
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77394556965457  LUMO = 0.803791819473697
  mo_energy =
[-3.25554869e+01 -1.85291137e+00 -7.73945570e-01 -7.73945570e-01
 -7.73945570e-01  8.03791819e-01  1.10491257e+00  1.10491257e+00
  1.10491257e+00  4.45206559e+00  5.71346598e+00  5.71346598e+00
  5.71346598e+00  1.61045070e+01  2.39176153e+01  2.39176153e+01
  2.39176153e+01  5.17093182e+01  1.18571751e+02  1.18571751e+02
  1.18571751e+02  1.61482668e+02  5.26798477e+02  1.89282815e+03
  8.01998548e+03  4.77842914e+04]
E1 = -182.1078627292982  E_coul = 53.5787686510256
cycle= 1 E= -128.529094078273  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462724
diis-c [-0.21411331  1.        ]
  HOMO = -0.87985271640252  LUMO = 0.776285841183845
  mo_energy =
[-3.28746855e+01 -1.96345252e+00 -8.79852716e-01 -8.79852716e-01
 -8.79852716e-01  7.76285841e-01  1.06702920e+00  1.06702920e+00
  1.06702920e+00  4.36852821e+00  5.58520273e+00  5.58520273e+00
  5.58520273e+00  1.59370644e+01  2.36830253e+01  2.36830253e+01
  2.36830253e+01  5.14573663e+01  1.18250241e+02  1.18250241e+02
  1.18250241e+02  1.61169267e+02  5.26441215e+02  1.89243428e+03
  8.01956234e+03  4.77838493e+04]
E1 = -182.84201032539298  E_coul = 54.310401895137424
cycle= 2 E= -128.531608430256  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23156
diis-c [-0.00067857  0.33246174  0.66753826]
  HOMO = -0.845411860466814  LUMO = 0.785218607993431
  mo_energy =
[-3.27694550e+01 -1.92724201e+00 -8.45411860e-01 -8.45411860e-01
 -8.45411860e-01  7.85218608e-01  1.07941023e+00  1.07941023e+00
  1.07941023e+00  4.39551657e+00  5.62691120e+00  5.62691120e+00
  5.62691120e+00  1.59919150e+01  2.37604769e+01  2.37604769e+01
  2.37604769e+01  5.15408061e+01  1.18355506e+02  1.18355506e+02
  1.18355506e+02  1.61272294e+02  5.26554855e+02  1.89255327e+03
  8.01968382e+03  4.77839717e+04]
E1 = -182.5957666915541  E_coul = 54.06330602518494
cycle= 3 E= -128.532460666369  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883946
diis-c [-1.47927010e-07 -2.21029759e-03 -9.86832332e-04  1.00319713e+00]
  HOMO = -0.84563907945786  LUMO = 0.785183994174483
  mo_energy =
[-3.27698406e+01 -1.92740457e+00 -8.45639079e-01 -8.45639079e-01
 -8.45639079e-01  7.85183994e-01  1.07936274e+00  1.07936274e+00
  1.07936274e+00  4.39538776e+00  5.62671806e+00  5.62671806e+00
  5.62671806e+00  1.59916773e+01  2.37601717e+01  2.37601717e+01
  2.37601717e+01  5.15404906e+01  1.18355109e+02  1.18355109e+02
  1.18355109e+02  1.61271908e+02  5.26554372e+02  1.89255268e+03
  8.01968314e+03  4.77839710e+04]
E1 = -182.59619699529702  E_coul = 54.06373630905777
cycle= 4 E= -128.532460686239  delta_E= -1.99e-08  |g|= 6.4e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132838
diis-c [-1.03260145e-09  3.17607246e-04  4.85071492e-04 -2.12874770e-01
  1.21207209e+00]
  HOMO = -0.845671743767294  LUMO = 0.785176958025469
  mo_energy =
[-3.27698938e+01 -1.92742482e+00 -8.45671744e-01 -8.45671744e-01
 -8.45671744e-01  7.85176958e-01  1.07934909e+00  1.07934909e+00
  1.07934909e+00  4.39536471e+00  5.62668208e+00  5.62668208e+00
  5.62668208e+00  1.59916374e+01  2.37601237e+01  2.37601237e+01
  2.37601237e+01  5.15404419e+01  1.18355055e+02  1.18355055e+02
  1.18355055e+02  1.61271855e+02  5.26554311e+02  1.89255261e+03
  8.01968307e+03  4.77839709e+04]
E1 = -182.5963010791131  E_coul = 54.063840392323655
cycle= 5 E= -128.532460686789  delta_E= -5.5e-10  |g|= 6.77e-06  |ddm|= 5.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5963010791131  E_coul = 54.063840392323655
  HOMO = -0.845668031164832  LUMO = 0.785178434851719
  mo_energy =
[-3.27698857e+01 -1.92742038e+00 -8.45668031e-01 -8.45668031e-01
 -8.45668031e-01  7.85178435e-01  1.07935064e+00  1.07935064e+00
  1.07935064e+00  4.39536824e+00  5.62668657e+00  5.62668657e+00
  5.62668657e+00  1.59916431e+01  2.37601306e+01  2.37601306e+01
  2.37601306e+01  5.15404492e+01  1.18355063e+02  1.18355063e+02
  1.18355063e+02  1.61271863e+02  5.26554319e+02  1.89255262e+03
  8.01968307e+03  4.77839710e+04]
E1 = -182.59628320347966  E_coul = 54.06382251668724
Extra cycle  E= -128.532460686792  delta_E= -3.01e-12  |g|= 2.5e-06  |ddm|= 2.5e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1256.6574201423537
E1 = -182.59628320347966  E_coul = 54.06382251668724
init E= -128.532460686792
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.845669281571306  LUMO = 0.785178180117765
  mo_energy =
[-3.27698897e+01 -1.92742157e+00 -8.45669282e-01 -8.45669282e-01
 -8.45669282e-01  7.85178180e-01  1.07935021e+00  1.07935021e+00
  1.07935021e+00  4.39536735e+00  5.62668506e+00  5.62668506e+00
  5.62668506e+00  1.59916412e+01  2.37601278e+01  2.37601278e+01
  2.37601278e+01  5.15404461e+01  1.18355059e+02  1.18355059e+02
  1.18355059e+02  1.61271859e+02  5.26554314e+02  1.89255261e+03
  8.01968307e+03  4.77839709e+04]
E1 = -182.5962928486727  E_coul = 54.06383216188014
cycle= 1 E= -128.532460686793  delta_E= -1.14e-13  |g|= 1.32e-06  |ddm|= 9.55e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5962928486727  E_coul = 54.06383216188014
  HOMO = -0.845668603400249  LUMO = 0.785178368136726
  mo_energy =
[-3.27698876e+01 -1.92742084e+00 -8.45668603e-01 -8.45668603e-01
 -8.45668603e-01  7.85178368e-01  1.07935045e+00  1.07935045e+00
  1.07935045e+00  4.39536790e+00  5.62668588e+00  5.62668588e+00
  5.62668588e+00  1.59916423e+01  2.37601293e+01  2.37601293e+01
  2.37601293e+01  5.15404477e+01  1.18355061e+02  1.18355061e+02
  1.18355061e+02  1.61271861e+02  5.26554317e+02  1.89255261e+03
  8.01968307e+03  4.77839709e+04]
E1 = -182.5962880535482  E_coul = 54.06382736675569
Extra cycle  E= -128.532460686792  delta_E= 5.68e-14  |g|= 6.53e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [7.92913196e-01 2.44137941e+04 3.66145389e+03 8.33281420e+02
 2.35649796e+02 7.65186943e+01 1.16003504e+01 2.82985295e+01
 3.05161413e-01 1.99758938e+00 4.93792601e+00 3.64385425e+00
 1.23233979e+01 5.47909179e+01 3.27914781e-01 1.13302653e+00]
grad_E = [-3.52633075e-05 -1.45133585e-09  7.62167820e-08 -1.48317427e-06
  1.53482999e-05 -6.31123809e-05 -3.92398803e-06 -1.46427533e-05
  2.56832523e-05  5.20488112e-06  2.98780430e-06 -4.65881532e-05
 -1.91639018e-04  3.20825139e-05  2.93845046e-05 -7.66551777e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.794018763612       1
[INPUT] 0    0    [1    /1   ]  24413.7941413        1
[INPUT] 0    0    [1    /1   ]  3661.45388097        1
[INPUT] 0    0    [1    /1   ]  833.281551829        1
[INPUT] 0    0    [1    /1   ]  235.64870053         1
[INPUT] 0    0    [1    /1   ]  76.5201313596        1
[INPUT] 0    0    [1    /1   ]  11.6229951734        1
[INPUT] 0    0    [1    /1   ]  28.3124314655        1
[INPUT] 0    0    [1    /1   ]  0.305551014047       1
[INPUT] 0    0    [1    /1   ]  2.0007601551         1
[INPUT] 0    0    [1    /1   ]  4.96270607251        1
[INPUT] 1    0    [1    /1   ]  3.64368283087        1
[INPUT] 1    0    [1    /1   ]  12.3223418135        1
[INPUT] 1    0    [1    /1   ]  54.7909003865        1
[INPUT] 1    0    [1    /1   ]  0.327943553618       1
[INPUT] 1    0    [1    /1   ]  1.13309518183        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7940187636122209, 1.0]], [0, [24413.79414131736, 1.0]], [0, [3661.453880967477, 1.0]], [0, [833.2815518293021, 1.0]], [0, [235.64870052966822, 1.0]], [0, [76.5201313596345, 1.0]], [0, [11.622995173355552, 1.0]], [0, [28.31243146549265, 1.0]], [0, [0.3055510140465447, 1.0]], [0, [2.0007601551027054, 1.0]], [0, [4.962706072510913, 1.0]], [1, [3.643682830866899, 1.0]], [1, [12.322341813491205, 1.0]], [1, [54.790900386540144, 1.0]], [1, [0.32794355361816646, 1.0]], [1, [1.1330951818252863, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79401876]
bas 1, expnt(s) = [24413.79414132]
bas 2, expnt(s) = [3661.45388097]
bas 3, expnt(s) = [833.28155183]
bas 4, expnt(s) = [235.64870053]
bas 5, expnt(s) = [76.52013136]
bas 6, expnt(s) = [11.62299517]
bas 7, expnt(s) = [28.31243147]
bas 8, expnt(s) = [0.30555101]
bas 9, expnt(s) = [2.00076016]
bas 10, expnt(s) = [4.96270607]
bas 11, expnt(s) = [3.64368283]
bas 12, expnt(s) = [12.32234181]
bas 13, expnt(s) = [54.79090039]
bas 14, expnt(s) = [0.32794355]
bas 15, expnt(s) = [1.13309518]
CPU time:       250.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.94018764e-01 2.12514270e+00 2.44137941e+04 4.93448102e+03
 3.66145388e+03 1.18920082e+03 8.33281552e+02 3.91840074e+02
 2.35648701e+02 1.51954586e+02 7.65201314e+01 6.53652316e+01
 1.16229952e+01 1.59038975e+01 2.83124315e+01 3.10097240e+01
 3.05551014e-01 1.03831188e+00 2.00076016e+00 4.25021888e+00
 4.96270607e+00 8.40047686e+00 3.64368283e+00 1.46862224e+01
 1.23223418e+01 6.73520714e+01 5.47909004e+01 4.34880505e+02
 3.27943554e-01 7.23991163e-01 1.13309518e+00 3.41049474e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998548884714246
cond(S) = 1261.480515320167
E1 = -183.57826171152797  E_coul = 55.07845195068245
init E= -128.499809760846
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945180462897  LUMO = 0.805434559862705
  mo_energy =
[-3.25554872e+01 -1.85291090e+00 -7.73945180e-01 -7.73945180e-01
 -7.73945180e-01  8.05434560e-01  1.10502277e+00  1.10502277e+00
  1.10502277e+00  4.46221376e+00  5.71366382e+00  5.71366382e+00
  5.71366382e+00  1.61576145e+01  2.39163353e+01  2.39163353e+01
  2.39163353e+01  5.18537850e+01  1.18568135e+02  1.18568135e+02
  1.18568135e+02  1.61706721e+02  5.27047245e+02  1.89306322e+03
  8.02019449e+03  4.77844649e+04]
E1 = -182.10791817505213  E_coul = 53.57882373667282
cycle= 1 E= -128.529094438379  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462684
diis-c [-0.21407665  1.        ]
  HOMO = -0.879848040170508  LUMO = 0.777868903899192
  mo_energy =
[-3.28746768e+01 -1.96344765e+00 -8.79848040e-01 -8.79848040e-01
 -8.79848040e-01  7.77868904e-01  1.06713767e+00  1.06713767e+00
  1.06713767e+00  4.37849903e+00  5.58540746e+00  5.58540746e+00
  5.58540746e+00  1.59898725e+01  2.36817611e+01  2.36817611e+01
  2.36817611e+01  5.16017070e+01  1.18246634e+02  1.18246634e+02
  1.18246634e+02  1.61393317e+02  5.26689996e+02  1.89266936e+03
  8.01977136e+03  4.77840228e+04]
E1 = -182.84202937286963  E_coul = 54.31042075329137
cycle= 2 E= -128.531608619578  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23154
diis-c [-0.00067922  0.33245988  0.66754012]
  HOMO = -0.845408869733127  LUMO = 0.786820555163326
  mo_energy =
[-3.27694510e+01 -1.92723894e+00 -8.45408870e-01 -8.45408870e-01
 -8.45408870e-01  7.86820555e-01  1.07951918e+00  1.07951918e+00
  1.07951918e+00  4.40554521e+00  5.62711328e+00  5.62711328e+00
  5.62711328e+00  1.60448235e+01  2.37592067e+01  2.37592067e+01
  2.37592067e+01  5.16851881e+01  1.18351894e+02  1.18351894e+02
  1.18351894e+02  1.61496343e+02  5.26803630e+02  1.89278835e+03
  8.01989283e+03  4.77841452e+04]
E1 = -182.59579996689067  E_coul = 54.06333919597683
cycle= 3 E= -128.532460770914  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883587
diis-c [-1.47553324e-07 -2.21000633e-03 -9.86686149e-04  1.00319669e+00]
  HOMO = -0.845636037289068  LUMO = 0.786785856327116
  mo_energy =
[-3.27698363e+01 -1.92740149e+00 -8.45636037e-01 -8.45636037e-01
 -8.45636037e-01  7.86785856e-01  1.07947171e+00  1.07947171e+00
  1.07947171e+00  4.40541618e+00  5.62692018e+00  5.62692018e+00
  5.62692018e+00  1.60445856e+01  2.37589017e+01  2.37589017e+01
  2.37589017e+01  5.16848727e+01  1.18351497e+02  1.18351497e+02
  1.18351497e+02  1.61495957e+02  5.26803147e+02  1.89278776e+03
  8.01989215e+03  4.77841445e+04]
E1 = -182.59622997194072  E_coul = 54.06376918118162
cycle= 4 E= -128.532460790759  delta_E= -1.98e-08  |g|= 6.4e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132847
diis-c [-1.03173433e-09  3.17387087e-04  4.85547479e-04 -2.12763750e-01
  1.21196082e+00]
  HOMO = -0.845668700506177  LUMO = 0.786778802803658
  mo_energy =
[-3.27698895e+01 -1.92742174e+00 -8.45668701e-01 -8.45668701e-01
 -8.45668701e-01  7.86778803e-01  1.07945806e+00  1.07945806e+00
  1.07945806e+00  4.40539308e+00  5.62688420e+00  5.62688420e+00
  5.62688420e+00  1.60445456e+01  2.37588536e+01  2.37588536e+01
  2.37588536e+01  5.16848239e+01  1.18351443e+02  1.18351443e+02
  1.18351443e+02  1.61495904e+02  5.26803086e+02  1.89278769e+03
  8.01989208e+03  4.77841444e+04]
E1 = -182.59633412119297  E_coul = 54.06387332988433
cycle= 5 E= -128.532460791309  delta_E= -5.5e-10  |g|= 6.76e-06  |ddm|= 5.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59633412119297  E_coul = 54.06387332988433
  HOMO = -0.845664991670584  LUMO = 0.786780281463843
  mo_energy =
[-3.27698815e+01 -1.92741730e+00 -8.45664992e-01 -8.45664992e-01
 -8.45664992e-01  7.86780281e-01  1.07945960e+00  1.07945960e+00
  1.07945960e+00  4.40539661e+00  5.62688869e+00  5.62688869e+00
  5.62688869e+00  1.60445513e+01  2.37588605e+01  2.37588605e+01
  2.37588605e+01  5.16848312e+01  1.18351451e+02  1.18351451e+02
  1.18351451e+02  1.61495911e+02  5.26803094e+02  1.89278769e+03
  8.01989209e+03  4.77841444e+04]
E1 = -182.5963162656842  E_coul = 54.06385547437264
Extra cycle  E= -128.532460791312  delta_E= -2.93e-12  |g|= 2.5e-06  |ddm|= 2.49e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [7.94018764e-01 2.44137941e+04 3.66145388e+03 8.33281552e+02
 2.35648701e+02 7.65201314e+01 1.16229952e+01 2.83124315e+01
 3.05551014e-01 2.00076016e+00 4.96270607e+00 3.64368283e+00
 1.23223418e+01 5.47909004e+01 3.27943554e-01 1.13309518e+00]
E = -128.53246079131156
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.794018763612       1
[INPUT] 0    0    [1    /1   ]  24413.7941413        1
[INPUT] 0    0    [1    /1   ]  3661.45388097        1
[INPUT] 0    0    [1    /1   ]  833.281551829        1
[INPUT] 0    0    [1    /1   ]  235.64870053         1
[INPUT] 0    0    [1    /1   ]  76.5201313596        1
[INPUT] 0    0    [1    /1   ]  11.6229951734        1
[INPUT] 0    0    [1    /1   ]  28.3124314655        1
[INPUT] 0    0    [1    /1   ]  0.305551014047       1
[INPUT] 0    0    [1    /1   ]  2.0007601551         1
[INPUT] 0    0    [1    /1   ]  4.96270607251        1
[INPUT] 1    0    [1    /1   ]  3.64368283087        1
[INPUT] 1    0    [1    /1   ]  12.3223418135        1
[INPUT] 1    0    [1    /1   ]  54.7909003865        1
[INPUT] 1    0    [1    /1   ]  0.327943553618       1
[INPUT] 1    0    [1    /1   ]  1.13309518183        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7940187636122209, 1.0]], [0, [24413.79414131736, 1.0]], [0, [3661.453880967477, 1.0]], [0, [833.2815518293021, 1.0]], [0, [235.64870052966822, 1.0]], [0, [76.5201313596345, 1.0]], [0, [11.622995173355552, 1.0]], [0, [28.31243146549265, 1.0]], [0, [0.3055510140465447, 1.0]], [0, [2.0007601551027054, 1.0]], [0, [4.962706072510913, 1.0]], [1, [3.643682830866899, 1.0]], [1, [12.322341813491205, 1.0]], [1, [54.790900386540144, 1.0]], [1, [0.32794355361816646, 1.0]], [1, [1.1330951818252863, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79401876]
bas 1, expnt(s) = [24413.79414132]
bas 2, expnt(s) = [3661.45388097]
bas 3, expnt(s) = [833.28155183]
bas 4, expnt(s) = [235.64870053]
bas 5, expnt(s) = [76.52013136]
bas 6, expnt(s) = [11.62299517]
bas 7, expnt(s) = [28.31243147]
bas 8, expnt(s) = [0.30555101]
bas 9, expnt(s) = [2.00076016]
bas 10, expnt(s) = [4.96270607]
bas 11, expnt(s) = [3.64368283]
bas 12, expnt(s) = [12.32234181]
bas 13, expnt(s) = [54.79090039]
bas 14, expnt(s) = [0.32794355]
bas 15, expnt(s) = [1.13309518]
CPU time:       250.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.94018764e-01 2.12514270e+00 2.44137941e+04 4.93448102e+03
 3.66145388e+03 1.18920082e+03 8.33281552e+02 3.91840074e+02
 2.35648701e+02 1.51954586e+02 7.65201314e+01 6.53652316e+01
 1.16229952e+01 1.59038975e+01 2.83124315e+01 3.10097240e+01
 3.05551014e-01 1.03831188e+00 2.00076016e+00 4.25021888e+00
 4.96270607e+00 8.40047686e+00 3.64368283e+00 1.46862224e+01
 1.23223418e+01 6.73520714e+01 5.47909004e+01 4.34880505e+02
 3.27943554e-01 7.23991163e-01 1.13309518e+00 3.41049474e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998548884714246
cond(S) = 1261.480515320167
E1 = -183.57826171152797  E_coul = 55.07845195068245
init E= -128.499809760846
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945180462897  LUMO = 0.805434559862705
  mo_energy =
[-3.25554872e+01 -1.85291090e+00 -7.73945180e-01 -7.73945180e-01
 -7.73945180e-01  8.05434560e-01  1.10502277e+00  1.10502277e+00
  1.10502277e+00  4.46221376e+00  5.71366382e+00  5.71366382e+00
  5.71366382e+00  1.61576145e+01  2.39163353e+01  2.39163353e+01
  2.39163353e+01  5.18537850e+01  1.18568135e+02  1.18568135e+02
  1.18568135e+02  1.61706721e+02  5.27047245e+02  1.89306322e+03
  8.02019449e+03  4.77844649e+04]
E1 = -182.10791817505213  E_coul = 53.57882373667282
cycle= 1 E= -128.529094438379  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462684
diis-c [-0.21407665  1.        ]
  HOMO = -0.879848040170508  LUMO = 0.777868903899192
  mo_energy =
[-3.28746768e+01 -1.96344765e+00 -8.79848040e-01 -8.79848040e-01
 -8.79848040e-01  7.77868904e-01  1.06713767e+00  1.06713767e+00
  1.06713767e+00  4.37849903e+00  5.58540746e+00  5.58540746e+00
  5.58540746e+00  1.59898725e+01  2.36817611e+01  2.36817611e+01
  2.36817611e+01  5.16017070e+01  1.18246634e+02  1.18246634e+02
  1.18246634e+02  1.61393317e+02  5.26689996e+02  1.89266936e+03
  8.01977136e+03  4.77840228e+04]
E1 = -182.84202937286963  E_coul = 54.31042075329137
cycle= 2 E= -128.531608619578  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23154
diis-c [-0.00067922  0.33245988  0.66754012]
  HOMO = -0.845408869733127  LUMO = 0.786820555163326
  mo_energy =
[-3.27694510e+01 -1.92723894e+00 -8.45408870e-01 -8.45408870e-01
 -8.45408870e-01  7.86820555e-01  1.07951918e+00  1.07951918e+00
  1.07951918e+00  4.40554521e+00  5.62711328e+00  5.62711328e+00
  5.62711328e+00  1.60448235e+01  2.37592067e+01  2.37592067e+01
  2.37592067e+01  5.16851881e+01  1.18351894e+02  1.18351894e+02
  1.18351894e+02  1.61496343e+02  5.26803630e+02  1.89278835e+03
  8.01989283e+03  4.77841452e+04]
E1 = -182.59579996689067  E_coul = 54.06333919597683
cycle= 3 E= -128.532460770914  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883587
diis-c [-1.47553324e-07 -2.21000633e-03 -9.86686149e-04  1.00319669e+00]
  HOMO = -0.845636037289068  LUMO = 0.786785856327116
  mo_energy =
[-3.27698363e+01 -1.92740149e+00 -8.45636037e-01 -8.45636037e-01
 -8.45636037e-01  7.86785856e-01  1.07947171e+00  1.07947171e+00
  1.07947171e+00  4.40541618e+00  5.62692018e+00  5.62692018e+00
  5.62692018e+00  1.60445856e+01  2.37589017e+01  2.37589017e+01
  2.37589017e+01  5.16848727e+01  1.18351497e+02  1.18351497e+02
  1.18351497e+02  1.61495957e+02  5.26803147e+02  1.89278776e+03
  8.01989215e+03  4.77841445e+04]
E1 = -182.59622997194072  E_coul = 54.06376918118162
cycle= 4 E= -128.532460790759  delta_E= -1.98e-08  |g|= 6.4e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132847
diis-c [-1.03173433e-09  3.17387087e-04  4.85547479e-04 -2.12763750e-01
  1.21196082e+00]
  HOMO = -0.845668700506177  LUMO = 0.786778802803658
  mo_energy =
[-3.27698895e+01 -1.92742174e+00 -8.45668701e-01 -8.45668701e-01
 -8.45668701e-01  7.86778803e-01  1.07945806e+00  1.07945806e+00
  1.07945806e+00  4.40539308e+00  5.62688420e+00  5.62688420e+00
  5.62688420e+00  1.60445456e+01  2.37588536e+01  2.37588536e+01
  2.37588536e+01  5.16848239e+01  1.18351443e+02  1.18351443e+02
  1.18351443e+02  1.61495904e+02  5.26803086e+02  1.89278769e+03
  8.01989208e+03  4.77841444e+04]
E1 = -182.59633412119297  E_coul = 54.06387332988433
cycle= 5 E= -128.532460791309  delta_E= -5.5e-10  |g|= 6.76e-06  |ddm|= 5.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59633412119297  E_coul = 54.06387332988433
  HOMO = -0.845664991670584  LUMO = 0.786780281463843
  mo_energy =
[-3.27698815e+01 -1.92741730e+00 -8.45664992e-01 -8.45664992e-01
 -8.45664992e-01  7.86780281e-01  1.07945960e+00  1.07945960e+00
  1.07945960e+00  4.40539661e+00  5.62688869e+00  5.62688869e+00
  5.62688869e+00  1.60445513e+01  2.37588605e+01  2.37588605e+01
  2.37588605e+01  5.16848312e+01  1.18351451e+02  1.18351451e+02
  1.18351451e+02  1.61495911e+02  5.26803094e+02  1.89278769e+03
  8.01989209e+03  4.77841444e+04]
E1 = -182.5963162656842  E_coul = 54.06385547437264
Extra cycle  E= -128.532460791312  delta_E= -2.93e-12  |g|= 2.5e-06  |ddm|= 2.49e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1261.480515320167
E1 = -182.5963162656842  E_coul = 54.06385547437264
init E= -128.532460791312
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.84566624070029  LUMO = 0.786780026497053
  mo_energy =
[-3.27698854e+01 -1.92741850e+00 -8.45666241e-01 -8.45666241e-01
 -8.45666241e-01  7.86780026e-01  1.07945917e+00  1.07945917e+00
  1.07945917e+00  4.40539572e+00  5.62688718e+00  5.62688718e+00
  5.62688718e+00  1.60445494e+01  2.37588577e+01  2.37588577e+01
  2.37588577e+01  5.16848281e+01  1.18351447e+02  1.18351447e+02
  1.18351447e+02  1.61495907e+02  5.26803090e+02  1.89278769e+03
  8.01989208e+03  4.77841444e+04]
E1 = -182.59632590007533  E_coul = 54.06386510876352
cycle= 1 E= -128.532460791312  delta_E= -2.27e-13  |g|= 1.32e-06  |ddm|= 9.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59632590007533  E_coul = 54.06386510876352
  HOMO = -0.845665563299264  LUMO = 0.78678021471992
  mo_energy =
[-3.27698834e+01 -1.92741776e+00 -8.45665563e-01 -8.45665563e-01
 -8.45665563e-01  7.86780215e-01  1.07945942e+00  1.07945942e+00
  1.07945942e+00  4.40539627e+00  5.62688800e+00  5.62688800e+00
  5.62688800e+00  1.60445505e+01  2.37588592e+01  2.37588592e+01
  2.37588592e+01  5.16848298e+01  1.18351449e+02  1.18351449e+02
  1.18351449e+02  1.61495910e+02  5.26803092e+02  1.89278769e+03
  8.01989209e+03  4.77841444e+04]
E1 = -182.59632111039096  E_coul = 54.063860319079005
Extra cycle  E= -128.532460791312  delta_E= -1.71e-13  |g|= 6.52e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [7.94018764e-01 2.44137941e+04 3.66145388e+03 8.33281552e+02
 2.35648701e+02 7.65201314e+01 1.16229952e+01 2.83124315e+01
 3.05551014e-01 2.00076016e+00 4.96270607e+00 3.64368283e+00
 1.23223418e+01 5.47909004e+01 3.27943554e-01 1.13309518e+00]
grad_E = [-4.08776360e-05 -1.45356634e-09  7.63358504e-08 -1.48549651e-06
  1.53642930e-05 -6.28830038e-05  7.20129299e-07 -1.70335074e-05
  4.85896071e-05  4.29630253e-06  2.05835437e-06 -6.28406768e-05
 -1.92966268e-04  3.23679055e-05  1.13045747e-05 -1.62571188e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.796565078721       1
[INPUT] 0    0    [1    /1   ]  24413.7941416        1
[INPUT] 0    0    [1    /1   ]  3661.4538684         1
[INPUT] 0    0    [1    /1   ]  833.281779361        1
[INPUT] 0    0    [1    /1   ]  235.646728368        1
[INPUT] 0    0    [1    /1   ]  76.5241500641        1
[INPUT] 0    0    [1    /1   ]  11.6532488025        1
[INPUT] 0    0    [1    /1   ]  28.3298364508        1
[INPUT] 0    0    [1    /1   ]  0.306355335738       1
[INPUT] 0    0    [1    /1   ]  2.00675065331        1
[INPUT] 0    0    [1    /1   ]  4.99828896763        1
[INPUT] 1    0    [1    /1   ]  3.6434556521         1
[INPUT] 1    0    [1    /1   ]  12.3208726311        1
[INPUT] 1    0    [1    /1   ]  54.7908678879        1
[INPUT] 1    0    [1    /1   ]  0.327983695337       1
[INPUT] 1    0    [1    /1   ]  1.1331947102         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7965650787211307, 1.0]], [0, [24413.794141558727, 1.0]], [0, [3661.4538684022364, 1.0]], [0, [833.2817793608026, 1.0]], [0, [235.646728368482, 1.0]], [0, [76.5241500641354, 1.0]], [0, [11.653248802474808, 1.0]], [0, [28.329836450791642, 1.0]], [0, [0.30635533573816076, 1.0]], [0, [2.0067506533104336, 1.0]], [0, [4.99828896762775, 1.0]], [1, [3.643455652102462, 1.0]], [1, [12.320872631091534, 1.0]], [1, [54.79086788793651, 1.0]], [1, [0.32798369533711336, 1.0]], [1, [1.1331947102006088, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79656508]
bas 1, expnt(s) = [24413.79414156]
bas 2, expnt(s) = [3661.4538684]
bas 3, expnt(s) = [833.28177936]
bas 4, expnt(s) = [235.64672837]
bas 5, expnt(s) = [76.52415006]
bas 6, expnt(s) = [11.6532488]
bas 7, expnt(s) = [28.32983645]
bas 8, expnt(s) = [0.30635534]
bas 9, expnt(s) = [2.00675065]
bas 10, expnt(s) = [4.99828897]
bas 11, expnt(s) = [3.64345565]
bas 12, expnt(s) = [12.32087263]
bas 13, expnt(s) = [54.79086789]
bas 14, expnt(s) = [0.3279837]
bas 15, expnt(s) = [1.13319471]
CPU time:       254.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.96565079e-01 2.13025195e+00 2.44137941e+04 4.93448102e+03
 3.66145387e+03 1.18920082e+03 8.33281779e+02 3.91840154e+02
 2.35646728e+02 1.51953632e+02 7.65241501e+01 6.53678063e+01
 1.16532488e+01 1.59349347e+01 2.83298365e+01 3.10240202e+01
 3.06355336e-01 1.04036111e+00 2.00675065e+00 4.25975954e+00
 4.99828897e+00 8.44561042e+00 3.64345565e+00 1.46850778e+01
 1.23208726e+01 6.73420337e+01 5.47908679e+01 4.34880182e+02
 3.27983695e-01 7.24101940e-01 1.13319471e+00 3.41086920e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998548051105843
cond(S) = 1271.0566723302804
E1 = -183.5782619450589  E_coul = 55.078455467539484
init E= -128.499806477519
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944600208475  LUMO = 0.808802767336148
  mo_energy =
[-3.25554876e+01 -1.85291021e+00 -7.73944600e-01 -7.73944600e-01
 -7.73944600e-01  8.08802767e-01  1.10517764e+00  1.10517764e+00
  1.10517764e+00  4.48158810e+00  5.71395783e+00  5.71395783e+00
  5.71395783e+00  1.62425827e+01  2.39146018e+01  2.39146018e+01
  2.39146018e+01  5.20668632e+01  1.18563136e+02  1.18563136e+02
  1.18563136e+02  1.62026830e+02  5.27401049e+02  1.89339787e+03
  8.02049205e+03  4.77847119e+04]
E1 = -182.10799568951938  E_coul = 53.57890069959666
cycle= 1 E= -128.529094989923  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462623
diis-c [-0.2140196  1.       ]
  HOMO = -0.879841540392031  LUMO = 0.781115087374757
  mo_energy =
[-3.28746646e+01 -1.96344088e+00 -8.79841540e-01 -8.79841540e-01
 -8.79841540e-01  7.81115087e-01  1.06728979e+00  1.06728979e+00
  1.06728979e+00  4.39757072e+00  5.58571092e+00  5.58571092e+00
  5.58571092e+00  1.60744077e+01  2.36800495e+01  2.36800495e+01
  2.36800495e+01  5.18146176e+01  1.18241648e+02  1.18241648e+02
  1.18241648e+02  1.61713426e+02  5.27043821e+02  1.89300403e+03
  8.02006893e+03  4.77842698e+04]
E1 = -182.8420522707673  E_coul = 54.31044335300794
cycle= 2 E= -128.531608917759  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231507
diis-c [-0.00068016  0.33245664  0.66754336]
  HOMO = -0.845404895422544  LUMO = 0.790105358061755
  mo_energy =
[-3.27694455e+01 -1.92723484e+00 -8.45404895e-01 -8.45404895e-01
 -8.45404895e-01  7.90105358e-01  1.07967194e+00  1.07967194e+00
  1.07967194e+00  4.42471532e+00  5.62741295e+00  5.62741295e+00
  5.62741295e+00  1.61295035e+01  2.37574864e+01  2.37574864e+01
  2.37574864e+01  5.18981533e+01  1.18346901e+02  1.18346901e+02
  1.18346901e+02  1.61816449e+02  5.27157445e+02  1.89312301e+03
  8.02019040e+03  4.77843922e+04]
E1 = -182.59584323577997  E_coul = 54.06338229100203
cycle= 3 E= -128.532460944778  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00088332
diis-c [-1.46958427e-07 -2.20976113e-03 -9.85413361e-04  1.00319517e+00]
  HOMO = -0.845632068058885  LUMO = 0.790070458186076
  mo_energy =
[-3.27698307e+01 -1.92739744e+00 -8.45632068e-01 -8.45632068e-01
 -8.45632068e-01  7.90070458e-01  1.07962445e+00  1.07962445e+00
  1.07962445e+00  4.42458581e+00  5.62721984e+00  5.62721984e+00
  5.62721984e+00  1.61292651e+01  2.37571814e+01  2.37571814e+01
  2.37571814e+01  5.18978377e+01  1.18346504e+02  1.18346504e+02
  1.18346504e+02  1.61816063e+02  5.27156962e+02  1.89312242e+03
  8.02018972e+03  4.77843915e+04]
E1 = -182.59627302794425  E_coul = 54.06381206334485
cycle= 4 E= -128.532460964599  delta_E= -1.98e-08  |g|= 6.4e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132882
diis-c [-1.03073815e-09  3.17045685e-04  4.86143513e-04 -2.12581927e-01
  1.21177874e+00]
  HOMO = -0.845664738120167  LUMO = 0.790063367892485
  mo_energy =
[-3.27698840e+01 -1.92741771e+00 -8.45664738e-01 -8.45664738e-01
 -8.45664738e-01  7.90063368e-01  1.07961080e+00  1.07961080e+00
  1.07961080e+00  4.42456263e+00  5.62718385e+00  5.62718385e+00
  5.62718385e+00  1.61292250e+01  2.37571333e+01  2.37571333e+01
  2.37571333e+01  5.18977889e+01  1.18346450e+02  1.18346450e+02
  1.18346450e+02  1.61816009e+02  5.27156901e+02  1.89312235e+03
  8.02018964e+03  4.77843914e+04]
E1 = -182.59637730079925  E_coul = 54.063916335651555
cycle= 5 E= -128.532460965148  delta_E= -5.48e-10  |g|= 6.76e-06  |ddm|= 5.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59637730079925  E_coul = 54.063916335651555
  HOMO = -0.84566103446746  LUMO = 0.790064851054508
  mo_energy =
[-3.27698759e+01 -1.92741328e+00 -8.45661034e-01 -8.45661034e-01
 -8.45661034e-01  7.90064851e-01  1.07961234e+00  1.07961234e+00
  1.07961234e+00  4.42456616e+00  5.62718833e+00  5.62718833e+00
  5.62718833e+00  1.61292308e+01  2.37571403e+01  2.37571403e+01
  2.37571403e+01  5.18977962e+01  1.18346458e+02  1.18346458e+02
  1.18346458e+02  1.61816017e+02  5.27156909e+02  1.89312236e+03
  8.02018965e+03  4.77843914e+04]
E1 = -182.59635947583618  E_coul = 54.06389851068505
Extra cycle  E= -128.532460965151  delta_E= -3.44e-12  |g|= 2.49e-06  |ddm|= 2.49e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [7.96565079e-01 2.44137941e+04 3.66145387e+03 8.33281779e+02
 2.35646728e+02 7.65241501e+01 1.16532488e+01 2.83298365e+01
 3.06355336e-01 2.00675065e+00 4.99828897e+00 3.64345565e+00
 1.23208726e+01 5.47908679e+01 3.27983695e-01 1.13319471e+00]
E = -128.53246096515113
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.796565078721       1
[INPUT] 0    0    [1    /1   ]  24413.7941416        1
[INPUT] 0    0    [1    /1   ]  3661.4538684         1
[INPUT] 0    0    [1    /1   ]  833.281779361        1
[INPUT] 0    0    [1    /1   ]  235.646728368        1
[INPUT] 0    0    [1    /1   ]  76.5241500641        1
[INPUT] 0    0    [1    /1   ]  11.6532488025        1
[INPUT] 0    0    [1    /1   ]  28.3298364508        1
[INPUT] 0    0    [1    /1   ]  0.306355335738       1
[INPUT] 0    0    [1    /1   ]  2.00675065331        1
[INPUT] 0    0    [1    /1   ]  4.99828896763        1
[INPUT] 1    0    [1    /1   ]  3.6434556521         1
[INPUT] 1    0    [1    /1   ]  12.3208726311        1
[INPUT] 1    0    [1    /1   ]  54.7908678879        1
[INPUT] 1    0    [1    /1   ]  0.327983695337       1
[INPUT] 1    0    [1    /1   ]  1.1331947102         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7965650787211307, 1.0]], [0, [24413.794141558727, 1.0]], [0, [3661.4538684022364, 1.0]], [0, [833.2817793608026, 1.0]], [0, [235.646728368482, 1.0]], [0, [76.5241500641354, 1.0]], [0, [11.653248802474808, 1.0]], [0, [28.329836450791642, 1.0]], [0, [0.30635533573816076, 1.0]], [0, [2.0067506533104336, 1.0]], [0, [4.99828896762775, 1.0]], [1, [3.643455652102462, 1.0]], [1, [12.320872631091534, 1.0]], [1, [54.79086788793651, 1.0]], [1, [0.32798369533711336, 1.0]], [1, [1.1331947102006088, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79656508]
bas 1, expnt(s) = [24413.79414156]
bas 2, expnt(s) = [3661.4538684]
bas 3, expnt(s) = [833.28177936]
bas 4, expnt(s) = [235.64672837]
bas 5, expnt(s) = [76.52415006]
bas 6, expnt(s) = [11.6532488]
bas 7, expnt(s) = [28.32983645]
bas 8, expnt(s) = [0.30635534]
bas 9, expnt(s) = [2.00675065]
bas 10, expnt(s) = [4.99828897]
bas 11, expnt(s) = [3.64345565]
bas 12, expnt(s) = [12.32087263]
bas 13, expnt(s) = [54.79086789]
bas 14, expnt(s) = [0.3279837]
bas 15, expnt(s) = [1.13319471]
CPU time:       255.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.96565079e-01 2.13025195e+00 2.44137941e+04 4.93448102e+03
 3.66145387e+03 1.18920082e+03 8.33281779e+02 3.91840154e+02
 2.35646728e+02 1.51953632e+02 7.65241501e+01 6.53678063e+01
 1.16532488e+01 1.59349347e+01 2.83298365e+01 3.10240202e+01
 3.06355336e-01 1.04036111e+00 2.00675065e+00 4.25975954e+00
 4.99828897e+00 8.44561042e+00 3.64345565e+00 1.46850778e+01
 1.23208726e+01 6.73420337e+01 5.47908679e+01 4.34880182e+02
 3.27983695e-01 7.24101940e-01 1.13319471e+00 3.41086920e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998548051105843
cond(S) = 1271.0566723302804
E1 = -183.5782619450589  E_coul = 55.078455467539484
init E= -128.499806477519
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773944600208475  LUMO = 0.808802767336148
  mo_energy =
[-3.25554876e+01 -1.85291021e+00 -7.73944600e-01 -7.73944600e-01
 -7.73944600e-01  8.08802767e-01  1.10517764e+00  1.10517764e+00
  1.10517764e+00  4.48158810e+00  5.71395783e+00  5.71395783e+00
  5.71395783e+00  1.62425827e+01  2.39146018e+01  2.39146018e+01
  2.39146018e+01  5.20668632e+01  1.18563136e+02  1.18563136e+02
  1.18563136e+02  1.62026830e+02  5.27401049e+02  1.89339787e+03
  8.02049205e+03  4.77847119e+04]
E1 = -182.10799568951938  E_coul = 53.57890069959666
cycle= 1 E= -128.529094989923  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462623
diis-c [-0.2140196  1.       ]
  HOMO = -0.879841540392031  LUMO = 0.781115087374757
  mo_energy =
[-3.28746646e+01 -1.96344088e+00 -8.79841540e-01 -8.79841540e-01
 -8.79841540e-01  7.81115087e-01  1.06728979e+00  1.06728979e+00
  1.06728979e+00  4.39757072e+00  5.58571092e+00  5.58571092e+00
  5.58571092e+00  1.60744077e+01  2.36800495e+01  2.36800495e+01
  2.36800495e+01  5.18146176e+01  1.18241648e+02  1.18241648e+02
  1.18241648e+02  1.61713426e+02  5.27043821e+02  1.89300403e+03
  8.02006893e+03  4.77842698e+04]
E1 = -182.8420522707673  E_coul = 54.31044335300794
cycle= 2 E= -128.531608917759  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231507
diis-c [-0.00068016  0.33245664  0.66754336]
  HOMO = -0.845404895422544  LUMO = 0.790105358061755
  mo_energy =
[-3.27694455e+01 -1.92723484e+00 -8.45404895e-01 -8.45404895e-01
 -8.45404895e-01  7.90105358e-01  1.07967194e+00  1.07967194e+00
  1.07967194e+00  4.42471532e+00  5.62741295e+00  5.62741295e+00
  5.62741295e+00  1.61295035e+01  2.37574864e+01  2.37574864e+01
  2.37574864e+01  5.18981533e+01  1.18346901e+02  1.18346901e+02
  1.18346901e+02  1.61816449e+02  5.27157445e+02  1.89312301e+03
  8.02019040e+03  4.77843922e+04]
E1 = -182.59584323577997  E_coul = 54.06338229100203
cycle= 3 E= -128.532460944778  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00088332
diis-c [-1.46958427e-07 -2.20976113e-03 -9.85413361e-04  1.00319517e+00]
  HOMO = -0.845632068058885  LUMO = 0.790070458186076
  mo_energy =
[-3.27698307e+01 -1.92739744e+00 -8.45632068e-01 -8.45632068e-01
 -8.45632068e-01  7.90070458e-01  1.07962445e+00  1.07962445e+00
  1.07962445e+00  4.42458581e+00  5.62721984e+00  5.62721984e+00
  5.62721984e+00  1.61292651e+01  2.37571814e+01  2.37571814e+01
  2.37571814e+01  5.18978377e+01  1.18346504e+02  1.18346504e+02
  1.18346504e+02  1.61816063e+02  5.27156962e+02  1.89312242e+03
  8.02018972e+03  4.77843915e+04]
E1 = -182.59627302794425  E_coul = 54.06381206334485
cycle= 4 E= -128.532460964599  delta_E= -1.98e-08  |g|= 6.4e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132882
diis-c [-1.03073815e-09  3.17045685e-04  4.86143513e-04 -2.12581927e-01
  1.21177874e+00]
  HOMO = -0.845664738120167  LUMO = 0.790063367892485
  mo_energy =
[-3.27698840e+01 -1.92741771e+00 -8.45664738e-01 -8.45664738e-01
 -8.45664738e-01  7.90063368e-01  1.07961080e+00  1.07961080e+00
  1.07961080e+00  4.42456263e+00  5.62718385e+00  5.62718385e+00
  5.62718385e+00  1.61292250e+01  2.37571333e+01  2.37571333e+01
  2.37571333e+01  5.18977889e+01  1.18346450e+02  1.18346450e+02
  1.18346450e+02  1.61816009e+02  5.27156901e+02  1.89312235e+03
  8.02018964e+03  4.77843914e+04]
E1 = -182.59637730079925  E_coul = 54.063916335651555
cycle= 5 E= -128.532460965148  delta_E= -5.48e-10  |g|= 6.76e-06  |ddm|= 5.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59637730079925  E_coul = 54.063916335651555
  HOMO = -0.84566103446746  LUMO = 0.790064851054508
  mo_energy =
[-3.27698759e+01 -1.92741328e+00 -8.45661034e-01 -8.45661034e-01
 -8.45661034e-01  7.90064851e-01  1.07961234e+00  1.07961234e+00
  1.07961234e+00  4.42456616e+00  5.62718833e+00  5.62718833e+00
  5.62718833e+00  1.61292308e+01  2.37571403e+01  2.37571403e+01
  2.37571403e+01  5.18977962e+01  1.18346458e+02  1.18346458e+02
  1.18346458e+02  1.61816017e+02  5.27156909e+02  1.89312236e+03
  8.02018965e+03  4.77843914e+04]
E1 = -182.59635947583618  E_coul = 54.06389851068505
Extra cycle  E= -128.532460965151  delta_E= -3.44e-12  |g|= 2.49e-06  |ddm|= 2.49e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1271.0566723302804
E1 = -182.59635947583618  E_coul = 54.06389851068505
init E= -128.532460965151
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845662281390256  LUMO = 0.790064595452759
  mo_energy =
[-3.27698799e+01 -1.92741448e+00 -8.45662281e-01 -8.45662281e-01
 -8.45662281e-01  7.90064595e-01  1.07961191e+00  1.07961191e+00
  1.07961191e+00  4.42456527e+00  5.62718682e+00  5.62718682e+00
  5.62718682e+00  1.61292288e+01  2.37571374e+01  2.37571374e+01
  2.37571374e+01  5.18977931e+01  1.18346454e+02  1.18346454e+02
  1.18346454e+02  1.61816013e+02  5.27156905e+02  1.89312235e+03
  8.02018965e+03  4.77843914e+04]
E1 = -182.5963690941961  E_coul = 54.06390812904491
cycle= 1 E= -128.532460965151  delta_E= -5.68e-14  |g|= 1.32e-06  |ddm|= 9.53e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5963690941961  E_coul = 54.06390812904491
  HOMO = -0.845661605130289  LUMO = 0.79006478419877
  mo_energy =
[-3.27698779e+01 -1.92741374e+00 -8.45661605e-01 -8.45661605e-01
 -8.45661605e-01  7.90064784e-01  1.07961216e+00  1.07961216e+00
  1.07961216e+00  4.42456582e+00  5.62718764e+00  5.62718764e+00
  5.62718764e+00  1.61292299e+01  2.37571389e+01  2.37571389e+01
  2.37571389e+01  5.18977947e+01  1.18346456e+02  1.18346456e+02
  1.18346456e+02  1.61816015e+02  5.27156907e+02  1.89312235e+03
  8.02018965e+03  4.77843914e+04]
E1 = -182.59636431261765  E_coul = 54.06390334746609
Extra cycle  E= -128.532460965152  delta_E= -3.69e-13  |g|= 6.51e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [7.96565079e-01 2.44137941e+04 3.66145387e+03 8.33281779e+02
 2.35646728e+02 7.65241501e+01 1.16532488e+01 2.83298365e+01
 3.06355336e-01 2.00675065e+00 4.99828897e+00 3.64345565e+00
 1.23208726e+01 5.47908679e+01 3.27983695e-01 1.13319471e+00]
grad_E = [-2.43441629e-05 -1.44522940e-09  7.59052562e-08 -1.47762200e-06
  1.52790725e-05 -6.21221828e-05  6.79055838e-06 -2.08286918e-05
  5.04684437e-05 -1.76219024e-06  1.06882472e-06 -8.50028389e-05
 -1.94960287e-04  3.27715858e-05 -1.51896242e-05  6.78749611e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.799798031464       1
[INPUT] 0    0    [1    /1   ]  24413.7941419        1
[INPUT] 0    0    [1    /1   ]  3661.45385155        1
[INPUT] 0    0    [1    /1   ]  833.282087118        1
[INPUT] 0    0    [1    /1   ]  235.643986791        1
[INPUT] 0    0    [1    /1   ]  76.5310255745        1
[INPUT] 0    0    [1    /1   ]  11.6856081679        1
[INPUT] 0    0    [1    /1   ]  28.3473245385        1
[INPUT] 0    0    [1    /1   ]  0.307352220213       1
[INPUT] 0    0    [1    /1   ]  2.01388315794        1
[INPUT] 0    0    [1    /1   ]  5.03933805463        1
[INPUT] 1    0    [1    /1   ]  3.64325363737        1
[INPUT] 1    0    [1    /1   ]  12.3196067763        1
[INPUT] 1    0    [1    /1   ]  54.7907627382        1
[INPUT] 1    0    [1    /1   ]  0.328020291077       1
[INPUT] 1    0    [1    /1   ]  1.1332813128         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7997980314644934, 1.0]], [0, [24413.794141882285, 1.0]], [0, [3661.45385154798, 1.0]], [0, [833.2820871176111, 1.0]], [0, [235.64398679142076, 1.0]], [0, [76.53102557449813, 1.0]], [0, [11.685608167922505, 1.0]], [0, [28.347324538478485, 1.0]], [0, [0.3073522202126776, 1.0]], [0, [2.0138831579350915, 1.0]], [0, [5.039338054632531, 1.0]], [1, [3.6432536373703783, 1.0]], [1, [12.319606776311629, 1.0]], [1, [54.79076273815842, 1.0]], [1, [0.328020291076749, 1.0]], [1, [1.1332813127984305, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79979803]
bas 1, expnt(s) = [24413.79414188]
bas 2, expnt(s) = [3661.45385155]
bas 3, expnt(s) = [833.28208712]
bas 4, expnt(s) = [235.64398679]
bas 5, expnt(s) = [76.53102557]
bas 6, expnt(s) = [11.68560817]
bas 7, expnt(s) = [28.34732454]
bas 8, expnt(s) = [0.30735222]
bas 9, expnt(s) = [2.01388316]
bas 10, expnt(s) = [5.03933805]
bas 11, expnt(s) = [3.64325364]
bas 12, expnt(s) = [12.31960678]
bas 13, expnt(s) = [54.79076274]
bas 14, expnt(s) = [0.32802029]
bas 15, expnt(s) = [1.13328131]
CPU time:       258.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.99798031e-01 2.13673307e+00 2.44137941e+04 4.93448102e+03
 3.66145385e+03 1.18920081e+03 8.33282087e+02 3.91840263e+02
 2.35643987e+02 1.51952306e+02 7.65310256e+01 6.53722111e+01
 1.16856082e+01 1.59681099e+01 2.83473245e+01 3.10383825e+01
 3.07352220e-01 1.04289909e+00 2.01388316e+00 4.27110971e+00
 5.03933805e+00 8.49757770e+00 3.64325364e+00 1.46840600e+01
 1.23196068e+01 6.73333853e+01 5.47907627e+01 4.34879139e+02
 3.28020291e-01 7.24202933e-01 1.13328131e+00 3.41119504e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99854726984885
cond(S) = 1283.1990914516298
E1 = -183.57826059818407  E_coul = 55.07845881956647
init E= -128.499801778618
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.77394405395063  LUMO = 0.812980105065463
  mo_energy =
[-3.25554881e+01 -1.85290952e+00 -7.73944054e-01 -7.73944054e-01
 -7.73944054e-01  8.12980105e-01  1.10531743e+00  1.10531743e+00
  1.10531743e+00  4.50518737e+00  5.71421650e+00  5.71421650e+00
  5.71421650e+00  1.63420758e+01  2.39130995e+01  2.39130995e+01
  2.39130995e+01  5.23092341e+01  1.18558697e+02  1.18558697e+02
  1.18558697e+02  1.62385455e+02  5.27797832e+02  1.89377408e+03
  8.02082664e+03  4.77849896e+04]
E1 = -182.10807220273938  E_coul = 53.578976562534095
cycle= 1 E= -128.529095640205  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462553
diis-c [-0.21395528  1.        ]
  HOMO = -0.879835111571815  LUMO = 0.78514121594997
  mo_energy =
[-3.28746526e+01 -1.96343421e+00 -8.79835112e-01 -8.79835112e-01
 -8.79835112e-01  7.85141216e-01  1.06742731e+00  1.06742731e+00
  1.06742731e+00  4.42081108e+00  5.58597893e+00  5.58597893e+00
  5.58597893e+00  1.61734090e+01  2.36785674e+01  2.36785674e+01
  2.36785674e+01  5.20568047e+01  1.18237222e+02  1.18237222e+02
  1.18237222e+02  1.62072050e+02  5.27440625e+02  1.89338025e+03
  8.02040354e+03  4.77845476e+04]
E1 = -182.84207467554472  E_coul = 54.310465355986025
cycle= 2 E= -128.531609319559  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231471
diis-c [-0.00068125  0.33245345  0.66754655]
  HOMO = -0.845400977521157  LUMO = 0.794179414025748
  mo_energy =
[-3.27694403e+01 -1.92723081e+00 -8.45400978e-01 -8.45400978e-01
 -8.45400978e-01  7.94179414e-01  1.07980991e+00  1.07980991e+00
  1.07980991e+00  4.44807248e+00  5.62767727e+00  5.62767727e+00
  5.62767727e+00  1.62286694e+01  2.37559961e+01  2.37559961e+01
  2.37559961e+01  5.21404004e+01  1.18342468e+02  1.18342468e+02
  1.18342468e+02  1.62175069e+02  5.27554239e+02  1.89349923e+03
  8.02052500e+03  4.77846700e+04]
E1 = -182.59588581320187  E_coul = 54.0634245896932
cycle= 3 E= -128.532461223509  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883019
diis-c [-1.46271641e-07 -2.20951325e-03 -9.83990605e-04  1.00319350e+00]
  HOMO = -0.84562815296871  LUMO = 0.794144273558689
  mo_energy =
[-3.27698254e+01 -1.92739345e+00 -8.45628153e-01 -8.45628153e-01
 -8.45628153e-01  7.94144274e-01  1.07976241e+00  1.07976241e+00
  1.07976241e+00  4.44794239e+00  5.62748414e+00  5.62748414e+00
  5.62748414e+00  1.62284305e+01  2.37556912e+01  2.37556912e+01
  2.37556912e+01  5.21400847e+01  1.18342071e+02  1.18342071e+02
  1.18342071e+02  1.62174684e+02  5.27553757e+02  1.89349863e+03
  8.02052432e+03  4.77846692e+04]
E1 = -182.59631535282514  E_coul = 54.06385410951995
cycle= 4 E= -128.532461243305  delta_E= -1.98e-08  |g|= 6.41e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000132929
diis-c [-1.02971949e-09  3.16646581e-04  4.86851618e-04 -2.12372828e-01
  1.21156933e+00]
  HOMO = -0.845660832303537  LUMO = 0.794137138500401
  mo_energy =
[-3.27698787e+01 -1.92741375e+00 -8.45660832e-01 -8.45660832e-01
 -8.45660832e-01  7.94137139e-01  1.07974876e+00  1.07974876e+00
  1.07974876e+00  4.44791911e+00  5.62744813e+00  5.62744813e+00
  5.62744813e+00  1.62283903e+01  2.37556431e+01  2.37556431e+01
  2.37556431e+01  5.21400358e+01  1.18342017e+02  1.18342017e+02
  1.18342017e+02  1.62174630e+02  5.27553696e+02  1.89349856e+03
  8.02052425e+03  4.77846692e+04]
E1 = -182.59641977737468  E_coul = 54.063958533521316
cycle= 5 E= -128.532461243853  delta_E= -5.48e-10  |g|= 6.75e-06  |ddm|= 5.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59641977737468  E_coul = 54.063958533521316
  HOMO = -0.845657134410883  LUMO = 0.794138627385843
  mo_energy =
[-3.27698706e+01 -1.92740933e+00 -8.45657134e-01 -8.45657134e-01
 -8.45657134e-01  7.94138627e-01  1.07975030e+00  1.07975030e+00
  1.07975030e+00  4.44792265e+00  5.62745260e+00  5.62745260e+00
  5.62745260e+00  1.62283961e+01  2.37556500e+01  2.37556500e+01
  2.37556500e+01  5.21400431e+01  1.18342025e+02  1.18342025e+02
  1.18342025e+02  1.62174638e+02  5.27553703e+02  1.89349857e+03
  8.02052425e+03  4.77846692e+04]
E1 = -182.59640198683414  E_coul = 54.063940742977955
Extra cycle  E= -128.532461243856  delta_E= -2.81e-12  |g|= 2.49e-06  |ddm|= 2.48e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [7.99798031e-01 2.44137941e+04 3.66145385e+03 8.33282087e+02
 2.35643987e+02 7.65310256e+01 1.16856082e+01 2.83473245e+01
 3.07352220e-01 2.01388316e+00 5.03933805e+00 3.64325364e+00
 1.23196068e+01 5.47907627e+01 3.28020291e-01 1.13328131e+00]
E = -128.53246124385618
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.799798031464       1
[INPUT] 0    0    [1    /1   ]  24413.7941419        1
[INPUT] 0    0    [1    /1   ]  3661.45385155        1
[INPUT] 0    0    [1    /1   ]  833.282087118        1
[INPUT] 0    0    [1    /1   ]  235.643986791        1
[INPUT] 0    0    [1    /1   ]  76.5310255745        1
[INPUT] 0    0    [1    /1   ]  11.6856081679        1
[INPUT] 0    0    [1    /1   ]  28.3473245385        1
[INPUT] 0    0    [1    /1   ]  0.307352220213       1
[INPUT] 0    0    [1    /1   ]  2.01388315794        1
[INPUT] 0    0    [1    /1   ]  5.03933805463        1
[INPUT] 1    0    [1    /1   ]  3.64325363737        1
[INPUT] 1    0    [1    /1   ]  12.3196067763        1
[INPUT] 1    0    [1    /1   ]  54.7907627382        1
[INPUT] 1    0    [1    /1   ]  0.328020291077       1
[INPUT] 1    0    [1    /1   ]  1.1332813128         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.7997980314644934, 1.0]], [0, [24413.794141882285, 1.0]], [0, [3661.45385154798, 1.0]], [0, [833.2820871176111, 1.0]], [0, [235.64398679142076, 1.0]], [0, [76.53102557449813, 1.0]], [0, [11.685608167922505, 1.0]], [0, [28.347324538478485, 1.0]], [0, [0.3073522202126776, 1.0]], [0, [2.0138831579350915, 1.0]], [0, [5.039338054632531, 1.0]], [1, [3.6432536373703783, 1.0]], [1, [12.319606776311629, 1.0]], [1, [54.79076273815842, 1.0]], [1, [0.328020291076749, 1.0]], [1, [1.1332813127984305, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79979803]
bas 1, expnt(s) = [24413.79414188]
bas 2, expnt(s) = [3661.45385155]
bas 3, expnt(s) = [833.28208712]
bas 4, expnt(s) = [235.64398679]
bas 5, expnt(s) = [76.53102557]
bas 6, expnt(s) = [11.68560817]
bas 7, expnt(s) = [28.34732454]
bas 8, expnt(s) = [0.30735222]
bas 9, expnt(s) = [2.01388316]
bas 10, expnt(s) = [5.03933805]
bas 11, expnt(s) = [3.64325364]
bas 12, expnt(s) = [12.31960678]
bas 13, expnt(s) = [54.79076274]
bas 14, expnt(s) = [0.32802029]
bas 15, expnt(s) = [1.13328131]
CPU time:       259.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.99798031e-01 2.13673307e+00 2.44137941e+04 4.93448102e+03
 3.66145385e+03 1.18920081e+03 8.33282087e+02 3.91840263e+02
 2.35643987e+02 1.51952306e+02 7.65310256e+01 6.53722111e+01
 1.16856082e+01 1.59681099e+01 2.83473245e+01 3.10383825e+01
 3.07352220e-01 1.04289909e+00 2.01388316e+00 4.27110971e+00
 5.03933805e+00 8.49757770e+00 3.64325364e+00 1.46840600e+01
 1.23196068e+01 6.73333853e+01 5.47907627e+01 4.34879139e+02
 3.28020291e-01 7.24202933e-01 1.13328131e+00 3.41119504e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99854726984885
cond(S) = 1283.1990914516298
E1 = -183.57826059818407  E_coul = 55.07845881956647
init E= -128.499801778618
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77394405395063  LUMO = 0.812980105065463
  mo_energy =
[-3.25554881e+01 -1.85290952e+00 -7.73944054e-01 -7.73944054e-01
 -7.73944054e-01  8.12980105e-01  1.10531743e+00  1.10531743e+00
  1.10531743e+00  4.50518737e+00  5.71421650e+00  5.71421650e+00
  5.71421650e+00  1.63420758e+01  2.39130995e+01  2.39130995e+01
  2.39130995e+01  5.23092341e+01  1.18558697e+02  1.18558697e+02
  1.18558697e+02  1.62385455e+02  5.27797832e+02  1.89377408e+03
  8.02082664e+03  4.77849896e+04]
E1 = -182.10807220273938  E_coul = 53.578976562534095
cycle= 1 E= -128.529095640205  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462553
diis-c [-0.21395528  1.        ]
  HOMO = -0.879835111571815  LUMO = 0.78514121594997
  mo_energy =
[-3.28746526e+01 -1.96343421e+00 -8.79835112e-01 -8.79835112e-01
 -8.79835112e-01  7.85141216e-01  1.06742731e+00  1.06742731e+00
  1.06742731e+00  4.42081108e+00  5.58597893e+00  5.58597893e+00
  5.58597893e+00  1.61734090e+01  2.36785674e+01  2.36785674e+01
  2.36785674e+01  5.20568047e+01  1.18237222e+02  1.18237222e+02
  1.18237222e+02  1.62072050e+02  5.27440625e+02  1.89338025e+03
  8.02040354e+03  4.77845476e+04]
E1 = -182.84207467554472  E_coul = 54.310465355986025
cycle= 2 E= -128.531609319559  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231471
diis-c [-0.00068125  0.33245345  0.66754655]
  HOMO = -0.845400977521157  LUMO = 0.794179414025748
  mo_energy =
[-3.27694403e+01 -1.92723081e+00 -8.45400978e-01 -8.45400978e-01
 -8.45400978e-01  7.94179414e-01  1.07980991e+00  1.07980991e+00
  1.07980991e+00  4.44807248e+00  5.62767727e+00  5.62767727e+00
  5.62767727e+00  1.62286694e+01  2.37559961e+01  2.37559961e+01
  2.37559961e+01  5.21404004e+01  1.18342468e+02  1.18342468e+02
  1.18342468e+02  1.62175069e+02  5.27554239e+02  1.89349923e+03
  8.02052500e+03  4.77846700e+04]
E1 = -182.59588581320187  E_coul = 54.0634245896932
cycle= 3 E= -128.532461223509  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883019
diis-c [-1.46271641e-07 -2.20951325e-03 -9.83990605e-04  1.00319350e+00]
  HOMO = -0.84562815296871  LUMO = 0.794144273558689
  mo_energy =
[-3.27698254e+01 -1.92739345e+00 -8.45628153e-01 -8.45628153e-01
 -8.45628153e-01  7.94144274e-01  1.07976241e+00  1.07976241e+00
  1.07976241e+00  4.44794239e+00  5.62748414e+00  5.62748414e+00
  5.62748414e+00  1.62284305e+01  2.37556912e+01  2.37556912e+01
  2.37556912e+01  5.21400847e+01  1.18342071e+02  1.18342071e+02
  1.18342071e+02  1.62174684e+02  5.27553757e+02  1.89349863e+03
  8.02052432e+03  4.77846692e+04]
E1 = -182.59631535282514  E_coul = 54.06385410951995
cycle= 4 E= -128.532461243305  delta_E= -1.98e-08  |g|= 6.41e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000132929
diis-c [-1.02971949e-09  3.16646581e-04  4.86851618e-04 -2.12372828e-01
  1.21156933e+00]
  HOMO = -0.845660832303537  LUMO = 0.794137138500401
  mo_energy =
[-3.27698787e+01 -1.92741375e+00 -8.45660832e-01 -8.45660832e-01
 -8.45660832e-01  7.94137139e-01  1.07974876e+00  1.07974876e+00
  1.07974876e+00  4.44791911e+00  5.62744813e+00  5.62744813e+00
  5.62744813e+00  1.62283903e+01  2.37556431e+01  2.37556431e+01
  2.37556431e+01  5.21400358e+01  1.18342017e+02  1.18342017e+02
  1.18342017e+02  1.62174630e+02  5.27553696e+02  1.89349856e+03
  8.02052425e+03  4.77846692e+04]
E1 = -182.59641977737468  E_coul = 54.063958533521316
cycle= 5 E= -128.532461243853  delta_E= -5.48e-10  |g|= 6.75e-06  |ddm|= 5.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59641977737468  E_coul = 54.063958533521316
  HOMO = -0.845657134410883  LUMO = 0.794138627385843
  mo_energy =
[-3.27698706e+01 -1.92740933e+00 -8.45657134e-01 -8.45657134e-01
 -8.45657134e-01  7.94138627e-01  1.07975030e+00  1.07975030e+00
  1.07975030e+00  4.44792265e+00  5.62745260e+00  5.62745260e+00
  5.62745260e+00  1.62283961e+01  2.37556500e+01  2.37556500e+01
  2.37556500e+01  5.21400431e+01  1.18342025e+02  1.18342025e+02
  1.18342025e+02  1.62174638e+02  5.27553703e+02  1.89349857e+03
  8.02052425e+03  4.77846692e+04]
E1 = -182.59640198683414  E_coul = 54.063940742977955
Extra cycle  E= -128.532461243856  delta_E= -2.81e-12  |g|= 2.49e-06  |ddm|= 2.48e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1283.1990914516298
E1 = -182.59640198683414  E_coul = 54.063940742977955
init E= -128.532461243856
    CPU time for initialize scf      0.26 sec, wall time      0.28 sec
  HOMO = -0.845658378956024  LUMO = 0.794138370944751
  mo_energy =
[-3.27698746e+01 -1.92741052e+00 -8.45658379e-01 -8.45658379e-01
 -8.45658379e-01  7.94138371e-01  1.07974987e+00  1.07974987e+00
  1.07974987e+00  4.44792175e+00  5.62745110e+00  5.62745110e+00
  5.62745110e+00  1.62283941e+01  2.37556472e+01  2.37556472e+01
  2.37556472e+01  5.21400400e+01  1.18342021e+02  1.18342021e+02
  1.18342021e+02  1.62174634e+02  5.27553699e+02  1.89349857e+03
  8.02052425e+03  4.77846692e+04]
E1 = -182.59641158723647  E_coul = 54.06395034337967
cycle= 1 E= -128.532461243857  delta_E= -6.25e-13  |g|= 1.32e-06  |ddm|= 9.51e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59641158723647  E_coul = 54.06395034337967
  HOMO = -0.845657703973682  LUMO = 0.794138560369053
  mo_energy =
[-3.27698726e+01 -1.92740979e+00 -8.45657704e-01 -8.45657704e-01
 -8.45657704e-01  7.94138560e-01  1.07975011e+00  1.07975011e+00
  1.07975011e+00  4.44792231e+00  5.62745192e+00  5.62745192e+00
  5.62745192e+00  1.62283952e+01  2.37556487e+01  2.37556487e+01
  2.37556487e+01  5.21400416e+01  1.18342023e+02  1.18342023e+02
  1.18342023e+02  1.62174636e+02  5.27553701e+02  1.89349857e+03
  8.02052425e+03  4.77846692e+04]
E1 = -182.59640681473314  E_coul = 54.0639455708766
Extra cycle  E= -128.532461243857  delta_E= 2.56e-13  |g|= 6.49e-07  |ddm|= 4.64e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.34 sec
exp = [7.99798031e-01 2.44137941e+04 3.66145385e+03 8.33282087e+02
 2.35643987e+02 7.65310256e+01 1.16856082e+01 2.83473245e+01
 3.07352220e-01 2.01388316e+00 5.03933805e+00 3.64325364e+00
 1.23196068e+01 5.47907627e+01 3.28020291e-01 1.13328131e+00]
grad_E = [ 6.00640320e-06 -1.42395528e-09  7.48017878e-08 -1.45730645e-06
  1.50749200e-05 -6.08569663e-05  1.28455858e-05 -2.53495685e-05
  3.77674648e-05 -1.09370767e-05  4.33118761e-07 -1.04709445e-04
 -1.96505784e-04  3.31089691e-05 -2.88078006e-05  1.38648652e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.805080661405       1
[INPUT] 0    0    [1    /1   ]  24413.7941425        1
[INPUT] 0    0    [1    /1   ]  3661.45381985        1
[INPUT] 0    0    [1    /1   ]  833.282668866        1
[INPUT] 0    0    [1    /1   ]  235.638724192        1
[INPUT] 0    0    [1    /1   ]  76.545519989         1
[INPUT] 0    0    [1    /1   ]  11.7376368091        1
[INPUT] 0    0    [1    /1   ]  28.3744372525        1
[INPUT] 0    0    [1    /1   ]  0.308956199821       1
[INPUT] 0    0    [1    /1   ]  2.02536044548        1
[INPUT] 0    0    [1    /1   ]  5.10917203261        1
[INPUT] 1    0    [1    /1   ]  3.64322987014        1
[INPUT] 1    0    [1    /1   ]  12.3188795929        1
[INPUT] 1    0    [1    /1   ]  54.7903517386        1
[INPUT] 1    0    [1    /1   ]  0.328075557776       1
[INPUT] 1    0    [1    /1   ]  1.13343365335        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8050806614053684, 1.0]], [0, [24413.794142490624, 1.0]], [0, [3661.4538198466444, 1.0]], [0, [833.2826688664829, 1.0]], [0, [235.6387241915838, 1.0]], [0, [76.54551998899058, 1.0]], [0, [11.737636809135825, 1.0]], [0, [28.374437252487763, 1.0]], [0, [0.308956199820781, 1.0]], [0, [2.0253604454787824, 1.0]], [0, [5.109172032614064, 1.0]], [1, [3.6432298701409667, 1.0]], [1, [12.318879592939151, 1.0]], [1, [54.79035173863483, 1.0]], [1, [0.32807555777594255, 1.0]], [1, [1.1334336533475236, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80508066]
bas 1, expnt(s) = [24413.79414249]
bas 2, expnt(s) = [3661.45381985]
bas 3, expnt(s) = [833.28266887]
bas 4, expnt(s) = [235.63872419]
bas 5, expnt(s) = [76.54551999]
bas 6, expnt(s) = [11.73763681]
bas 7, expnt(s) = [28.37443725]
bas 8, expnt(s) = [0.3089562]
bas 9, expnt(s) = [2.02536045]
bas 10, expnt(s) = [5.10917203]
bas 11, expnt(s) = [3.64322987]
bas 12, expnt(s) = [12.31887959]
bas 13, expnt(s) = [54.79035174]
bas 14, expnt(s) = [0.32807556]
bas 15, expnt(s) = [1.13343365]
CPU time:       263.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.05080661e-01 2.14730913e+00 2.44137941e+04 4.93448102e+03
 3.66145382e+03 1.18920081e+03 8.33282669e+02 3.91840468e+02
 2.35638724e+02 1.51949761e+02 7.65455200e+01 6.53814966e+01
 1.17376368e+01 1.60214023e+01 2.83744373e+01 3.10606448e+01
 3.08956200e-01 1.04697837e+00 2.02536045e+00 4.28935279e+00
 5.10917203e+00 8.58574368e+00 3.64322987e+00 1.46839403e+01
 1.23188796e+01 6.73284173e+01 5.47903517e+01 4.34875061e+02
 3.28075558e-01 7.24355459e-01 1.13343365e+00 3.41176824e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998545997899686
cond(S) = 1304.1619265570012
E1 = -183.57825690421856  E_coul = 55.07846317539897
init E= -128.49979372882
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943395153032  LUMO = 0.819774367474171
  mo_energy =
[-3.25554887e+01 -1.85290855e+00 -7.73943395e-01 -7.73943395e-01
 -7.73943395e-01  8.19774367e-01  1.10553522e+00  1.10553522e+00
  1.10553522e+00  4.54378337e+00  5.71483313e+00  5.71483313e+00
  5.71483313e+00  1.65071191e+01  2.39129606e+01  2.39129606e+01
  2.39129606e+01  5.27104438e+01  1.18556212e+02  1.18556212e+02
  1.18556212e+02  1.62977162e+02  5.28455215e+02  1.89439906e+03
  8.02138272e+03  4.77854512e+04]
E1 = -182.10819163388408  E_coul = 53.57909476601948
cycle= 1 E= -128.529096867865  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462438
diis-c [-0.21384851  1.        ]
  HOMO = -0.87982525201523  LUMO = 0.791689479927288
  mo_energy =
[-3.28746337e+01 -1.96342383e+00 -8.79825252e-01 -8.79825252e-01
 -8.79825252e-01  7.91689480e-01  1.06764121e+00  1.06764121e+00
  1.06764121e+00  4.45881745e+00  5.58660458e+00  5.58660458e+00
  5.58660458e+00  1.63376373e+01  2.36784512e+01  2.36784512e+01
  2.36784512e+01  5.24577122e+01  1.18234757e+02  1.18234757e+02
  1.18234757e+02  1.62663755e+02  5.28098040e+02  1.89400526e+03
  8.02095964e+03  4.77850092e+04]
E1 = -182.84211201515936  E_coul = 54.310501840715744
cycle= 2 E= -128.531610174444  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231412
diis-c [-0.0006831   0.33244851  0.66755149]
  HOMO = -0.845394928047788  LUMO = 0.800805785321269
  mo_energy =
[-3.27694315e+01 -1.92722441e+00 -8.45394928e-01 -8.45394928e-01
 -8.45394928e-01  8.00805785e-01  1.08002472e+00  1.08002472e+00
  1.08002472e+00  4.48627098e+00  5.62829917e+00  5.62829917e+00
  5.62829917e+00  1.63931708e+01  2.37558703e+01  2.37558703e+01
  2.37558703e+01  5.25414067e+01  1.18339993e+02  1.18339993e+02
  1.18339993e+02  1.62766770e+02  5.28211640e+02  1.89412422e+03
  8.02108108e+03  4.77851316e+04]
E1 = -182.5959543767823  E_coul = 54.06349248717628
cycle= 3 E= -128.532461889606  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000882477
diis-c [-1.45202679e-07 -2.20924807e-03 -9.82326208e-04  1.00319157e+00]
  HOMO = -0.845622066870463  LUMO = 0.800770278953806
  mo_energy =
[-3.27698163e+01 -1.92738708e+00 -8.45622067e-01 -8.45622067e-01
 -8.45622067e-01  8.00770279e-01  1.07997722e+00  1.07997722e+00
  1.07997722e+00  4.48613999e+00  5.62810607e+00  5.62810607e+00
  5.62810607e+00  1.63929311e+01  2.37555655e+01  2.37555655e+01
  2.37555655e+01  5.25410908e+01  1.18339596e+02  1.18339596e+02
  1.18339596e+02  1.62766385e+02  5.28211158e+02  1.89412363e+03
  8.02108041e+03  4.77851309e+04]
E1 = -182.59638344466583  E_coul = 54.06392153530459
cycle= 4 E= -128.532461909361  delta_E= -1.98e-08  |g|= 6.41e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133017
diis-c [-1.02811318e-09  3.16021070e-04  4.88099144e-04 -2.12047026e-01
  1.21124291e+00]
  HOMO = -0.845654758803832  LUMO = 0.800763073861967
  mo_energy =
[-3.27698697e+01 -1.92740742e+00 -8.45654759e-01 -8.45654759e-01
 -8.45654759e-01  8.00763074e-01  1.07996357e+00  1.07996357e+00
  1.07996357e+00  4.48611654e+00  5.62807004e+00  5.62807004e+00
  5.62807004e+00  1.63928908e+01  2.37555174e+01  2.37555174e+01
  2.37555174e+01  5.25410419e+01  1.18339542e+02  1.18339542e+02
  1.18339542e+02  1.62766331e+02  5.28211097e+02  1.89412356e+03
  8.02108033e+03  4.77851308e+04]
E1 = -182.5964881227182  E_coul = 54.064026212810404
cycle= 5 E= -128.532461909908  delta_E= -5.47e-10  |g|= 6.74e-06  |ddm|= 5.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5964881227182  E_coul = 54.064026212810404
  HOMO = -0.845651070159245  LUMO = 0.800764572009397
  mo_energy =
[-3.27698616e+01 -1.92740300e+00 -8.45651070e-01 -8.45651070e-01
 -8.45651070e-01  8.00764572e-01  1.07996510e+00  1.07996510e+00
  1.07996510e+00  4.48612010e+00  5.62807450e+00  5.62807450e+00
  5.62807450e+00  1.63928965e+01  2.37555243e+01  2.37555243e+01
  2.37555243e+01  5.25410491e+01  1.18339550e+02  1.18339550e+02
  1.18339550e+02  1.62766339e+02  5.28211105e+02  1.89412357e+03
  8.02108034e+03  4.77851308e+04]
E1 = -182.59647038676187  E_coul = 54.06400847685134
Extra cycle  E= -128.532461909911  delta_E= -2.73e-12  |g|= 2.48e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.05080661e-01 2.44137941e+04 3.66145382e+03 8.33282669e+02
 2.35638724e+02 7.65455200e+01 1.17376368e+01 2.83744373e+01
 3.08956200e-01 2.02536045e+00 5.10917203e+00 3.64322987e+00
 1.23188796e+01 5.47903517e+01 3.28075558e-01 1.13343365e+00]
E = -128.53246190991052
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.805080661405       1
[INPUT] 0    0    [1    /1   ]  24413.7941425        1
[INPUT] 0    0    [1    /1   ]  3661.45381985        1
[INPUT] 0    0    [1    /1   ]  833.282668866        1
[INPUT] 0    0    [1    /1   ]  235.638724192        1
[INPUT] 0    0    [1    /1   ]  76.545519989         1
[INPUT] 0    0    [1    /1   ]  11.7376368091        1
[INPUT] 0    0    [1    /1   ]  28.3744372525        1
[INPUT] 0    0    [1    /1   ]  0.308956199821       1
[INPUT] 0    0    [1    /1   ]  2.02536044548        1
[INPUT] 0    0    [1    /1   ]  5.10917203261        1
[INPUT] 1    0    [1    /1   ]  3.64322987014        1
[INPUT] 1    0    [1    /1   ]  12.3188795929        1
[INPUT] 1    0    [1    /1   ]  54.7903517386        1
[INPUT] 1    0    [1    /1   ]  0.328075557776       1
[INPUT] 1    0    [1    /1   ]  1.13343365335        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8050806614053684, 1.0]], [0, [24413.794142490624, 1.0]], [0, [3661.4538198466444, 1.0]], [0, [833.2826688664829, 1.0]], [0, [235.6387241915838, 1.0]], [0, [76.54551998899058, 1.0]], [0, [11.737636809135825, 1.0]], [0, [28.374437252487763, 1.0]], [0, [0.308956199820781, 1.0]], [0, [2.0253604454787824, 1.0]], [0, [5.109172032614064, 1.0]], [1, [3.6432298701409667, 1.0]], [1, [12.318879592939151, 1.0]], [1, [54.79035173863483, 1.0]], [1, [0.32807555777594255, 1.0]], [1, [1.1334336533475236, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80508066]
bas 1, expnt(s) = [24413.79414249]
bas 2, expnt(s) = [3661.45381985]
bas 3, expnt(s) = [833.28266887]
bas 4, expnt(s) = [235.63872419]
bas 5, expnt(s) = [76.54551999]
bas 6, expnt(s) = [11.73763681]
bas 7, expnt(s) = [28.37443725]
bas 8, expnt(s) = [0.3089562]
bas 9, expnt(s) = [2.02536045]
bas 10, expnt(s) = [5.10917203]
bas 11, expnt(s) = [3.64322987]
bas 12, expnt(s) = [12.31887959]
bas 13, expnt(s) = [54.79035174]
bas 14, expnt(s) = [0.32807556]
bas 15, expnt(s) = [1.13343365]
CPU time:       264.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.05080661e-01 2.14730913e+00 2.44137941e+04 4.93448102e+03
 3.66145382e+03 1.18920081e+03 8.33282669e+02 3.91840468e+02
 2.35638724e+02 1.51949761e+02 7.65455200e+01 6.53814966e+01
 1.17376368e+01 1.60214023e+01 2.83744373e+01 3.10606448e+01
 3.08956200e-01 1.04697837e+00 2.02536045e+00 4.28935279e+00
 5.10917203e+00 8.58574368e+00 3.64322987e+00 1.46839403e+01
 1.23188796e+01 6.73284173e+01 5.47903517e+01 4.34875061e+02
 3.28075558e-01 7.24355459e-01 1.13343365e+00 3.41176824e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998545997899686
cond(S) = 1304.1619265570012
E1 = -183.57825690421856  E_coul = 55.07846317539897
init E= -128.49979372882
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943395153032  LUMO = 0.819774367474171
  mo_energy =
[-3.25554887e+01 -1.85290855e+00 -7.73943395e-01 -7.73943395e-01
 -7.73943395e-01  8.19774367e-01  1.10553522e+00  1.10553522e+00
  1.10553522e+00  4.54378337e+00  5.71483313e+00  5.71483313e+00
  5.71483313e+00  1.65071191e+01  2.39129606e+01  2.39129606e+01
  2.39129606e+01  5.27104438e+01  1.18556212e+02  1.18556212e+02
  1.18556212e+02  1.62977162e+02  5.28455215e+02  1.89439906e+03
  8.02138272e+03  4.77854512e+04]
E1 = -182.10819163388408  E_coul = 53.57909476601948
cycle= 1 E= -128.529096867865  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462438
diis-c [-0.21384851  1.        ]
  HOMO = -0.87982525201523  LUMO = 0.791689479927288
  mo_energy =
[-3.28746337e+01 -1.96342383e+00 -8.79825252e-01 -8.79825252e-01
 -8.79825252e-01  7.91689480e-01  1.06764121e+00  1.06764121e+00
  1.06764121e+00  4.45881745e+00  5.58660458e+00  5.58660458e+00
  5.58660458e+00  1.63376373e+01  2.36784512e+01  2.36784512e+01
  2.36784512e+01  5.24577122e+01  1.18234757e+02  1.18234757e+02
  1.18234757e+02  1.62663755e+02  5.28098040e+02  1.89400526e+03
  8.02095964e+03  4.77850092e+04]
E1 = -182.84211201515936  E_coul = 54.310501840715744
cycle= 2 E= -128.531610174444  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231412
diis-c [-0.0006831   0.33244851  0.66755149]
  HOMO = -0.845394928047788  LUMO = 0.800805785321269
  mo_energy =
[-3.27694315e+01 -1.92722441e+00 -8.45394928e-01 -8.45394928e-01
 -8.45394928e-01  8.00805785e-01  1.08002472e+00  1.08002472e+00
  1.08002472e+00  4.48627098e+00  5.62829917e+00  5.62829917e+00
  5.62829917e+00  1.63931708e+01  2.37558703e+01  2.37558703e+01
  2.37558703e+01  5.25414067e+01  1.18339993e+02  1.18339993e+02
  1.18339993e+02  1.62766770e+02  5.28211640e+02  1.89412422e+03
  8.02108108e+03  4.77851316e+04]
E1 = -182.5959543767823  E_coul = 54.06349248717628
cycle= 3 E= -128.532461889606  delta_E= -0.000852  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000882477
diis-c [-1.45202679e-07 -2.20924807e-03 -9.82326208e-04  1.00319157e+00]
  HOMO = -0.845622066870463  LUMO = 0.800770278953806
  mo_energy =
[-3.27698163e+01 -1.92738708e+00 -8.45622067e-01 -8.45622067e-01
 -8.45622067e-01  8.00770279e-01  1.07997722e+00  1.07997722e+00
  1.07997722e+00  4.48613999e+00  5.62810607e+00  5.62810607e+00
  5.62810607e+00  1.63929311e+01  2.37555655e+01  2.37555655e+01
  2.37555655e+01  5.25410908e+01  1.18339596e+02  1.18339596e+02
  1.18339596e+02  1.62766385e+02  5.28211158e+02  1.89412363e+03
  8.02108041e+03  4.77851309e+04]
E1 = -182.59638344466583  E_coul = 54.06392153530459
cycle= 4 E= -128.532461909361  delta_E= -1.98e-08  |g|= 6.41e-05  |ddm|= 0.000307
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133017
diis-c [-1.02811318e-09  3.16021070e-04  4.88099144e-04 -2.12047026e-01
  1.21124291e+00]
  HOMO = -0.845654758803832  LUMO = 0.800763073861967
  mo_energy =
[-3.27698697e+01 -1.92740742e+00 -8.45654759e-01 -8.45654759e-01
 -8.45654759e-01  8.00763074e-01  1.07996357e+00  1.07996357e+00
  1.07996357e+00  4.48611654e+00  5.62807004e+00  5.62807004e+00
  5.62807004e+00  1.63928908e+01  2.37555174e+01  2.37555174e+01
  2.37555174e+01  5.25410419e+01  1.18339542e+02  1.18339542e+02
  1.18339542e+02  1.62766331e+02  5.28211097e+02  1.89412356e+03
  8.02108033e+03  4.77851308e+04]
E1 = -182.5964881227182  E_coul = 54.064026212810404
cycle= 5 E= -128.532461909908  delta_E= -5.47e-10  |g|= 6.74e-06  |ddm|= 5.31e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5964881227182  E_coul = 54.064026212810404
  HOMO = -0.845651070159245  LUMO = 0.800764572009397
  mo_energy =
[-3.27698616e+01 -1.92740300e+00 -8.45651070e-01 -8.45651070e-01
 -8.45651070e-01  8.00764572e-01  1.07996510e+00  1.07996510e+00
  1.07996510e+00  4.48612010e+00  5.62807450e+00  5.62807450e+00
  5.62807450e+00  1.63928965e+01  2.37555243e+01  2.37555243e+01
  2.37555243e+01  5.25410491e+01  1.18339550e+02  1.18339550e+02
  1.18339550e+02  1.62766339e+02  5.28211105e+02  1.89412357e+03
  8.02108034e+03  4.77851308e+04]
E1 = -182.59647038676187  E_coul = 54.06400847685134
Extra cycle  E= -128.532461909911  delta_E= -2.73e-12  |g|= 2.48e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1304.1619265570012
E1 = -182.59647038676187  E_coul = 54.06400847685134
init E= -128.532461909911
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.84565231093758  LUMO = 0.800764314182135
  mo_energy =
[-3.27698656e+01 -1.92740419e+00 -8.45652311e-01 -8.45652311e-01
 -8.45652311e-01  8.00764314e-01  1.07996468e+00  1.07996468e+00
  1.07996468e+00  4.48611920e+00  5.62807300e+00  5.62807300e+00
  5.62807300e+00  1.63928946e+01  2.37555214e+01  2.37555214e+01
  2.37555214e+01  5.25410461e+01  1.18339546e+02  1.18339546e+02
  1.18339546e+02  1.62766335e+02  5.28211100e+02  1.89412356e+03
  8.02108034e+03  4.77851308e+04]
E1 = -182.59647995861687  E_coul = 54.06401804870605
cycle= 1 E= -128.532461909911  delta_E= -2.84e-13  |g|= 1.31e-06  |ddm|= 9.49e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59647995861687  E_coul = 54.06401804870605
  HOMO = -0.845651637986751  LUMO = 0.800764504714526
  mo_energy =
[-3.27698636e+01 -1.92740346e+00 -8.45651638e-01 -8.45651638e-01
 -8.45651638e-01  8.00764505e-01  1.07996492e+00  1.07996492e+00
  1.07996492e+00  4.48611975e+00  5.62807382e+00  5.62807382e+00
  5.62807382e+00  1.63928957e+01  2.37555229e+01  2.37555229e+01
  2.37555229e+01  5.25410477e+01  1.18339548e+02  1.18339548e+02
  1.18339548e+02  1.62766337e+02  5.28211102e+02  1.89412357e+03
  8.02108034e+03  4.77851308e+04]
E1 = -182.59647520054202  E_coul = 54.06401329063098
Extra cycle  E= -128.532461909911  delta_E= -2.27e-13  |g|= 6.47e-07  |ddm|= 4.63e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [8.05080661e-01 2.44137941e+04 3.66145382e+03 8.33282669e+02
 2.35638724e+02 7.65455200e+01 1.17376368e+01 2.83744373e+01
 3.08956200e-01 2.02536045e+00 5.10917203e+00 3.64322987e+00
 1.23188796e+01 5.47903517e+01 3.28075558e-01 1.13343365e+00]
grad_E = [ 5.85224759e-05 -1.37671189e-09  7.23519448e-08 -1.41234540e-06
  1.46369984e-05 -5.84812998e-05  2.09969566e-05 -3.24379532e-05
  1.05005963e-05 -2.60704222e-05  2.47054005e-07 -1.27521546e-04
 -1.96715170e-04  3.32765170e-05 -2.86879695e-05  2.14759800e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.812650039901       1
[INPUT] 0    0    [1    /1   ]  24413.7941435        1
[INPUT] 0    0    [1    /1   ]  3661.45376474        1
[INPUT] 0    0    [1    /1   ]  833.28368358         1
[INPUT] 0    0    [1    /1   ]  235.629455268        1
[INPUT] 0    0    [1    /1   ]  76.5723532844        1
[INPUT] 0    0    [1    /1   ]  11.8189066107        1
[INPUT] 0    0    [1    /1   ]  28.416234797         1
[INPUT] 0    0    [1    /1   ]  0.31120242529        1
[INPUT] 0    0    [1    /1   ]  2.04200018567        1
[INPUT] 0    0    [1    /1   ]  5.22222131528        1
[INPUT] 1    0    [1    /1   ]  3.6441483775         1
[INPUT] 1    0    [1    /1   ]  12.3212746281        1
[INPUT] 1    0    [1    /1   ]  54.7890964869        1
[INPUT] 1    0    [1    /1   ]  0.328179115101       1
[INPUT] 1    0    [1    /1   ]  1.13381703124        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8126500399008001, 1.0]], [0, [24413.794143547806, 1.0]], [0, [3661.453764738154, 1.0]], [0, [833.2836835799734, 1.0]], [0, [235.62945526772452, 1.0]], [0, [76.57235328438816, 1.0]], [0, [11.818906610749556, 1.0]], [0, [28.4162347970086, 1.0]], [0, [0.31120242528950365, 1.0]], [0, [2.0420001856654504, 1.0]], [0, [5.222221315280554, 1.0]], [1, [3.644148377504232, 1.0]], [1, [12.321274628064119, 1.0]], [1, [54.78909648692693, 1.0]], [1, [0.3281791151013478, 1.0]], [1, [1.1338170312442555, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81265004]
bas 1, expnt(s) = [24413.79414355]
bas 2, expnt(s) = [3661.45376474]
bas 3, expnt(s) = [833.28368358]
bas 4, expnt(s) = [235.62945527]
bas 5, expnt(s) = [76.57235328]
bas 6, expnt(s) = [11.81890661]
bas 7, expnt(s) = [28.4162348]
bas 8, expnt(s) = [0.31120243]
bas 9, expnt(s) = [2.04200019]
bas 10, expnt(s) = [5.22222132]
bas 11, expnt(s) = [3.64414838]
bas 12, expnt(s) = [12.32127463]
bas 13, expnt(s) = [54.78909649]
bas 14, expnt(s) = [0.32817912]
bas 15, expnt(s) = [1.13381703]
CPU time:       267.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12650040e-01 2.16243317e+00 2.44137941e+04 4.93448102e+03
 3.66145376e+03 1.18920079e+03 8.33283684e+02 3.91840826e+02
 2.35629455e+02 1.51945278e+02 7.65723533e+01 6.53986856e+01
 1.18189066e+01 1.61045280e+01 2.84162348e+01 3.10949544e+01
 3.11202425e-01 1.05268214e+00 2.04200019e+00 4.31575574e+00
 5.22222132e+00 8.72783403e+00 3.64414838e+00 1.46885680e+01
 1.23212746e+01 6.73447802e+01 5.47890965e+01 4.34862608e+02
 3.28179115e-01 7.24641274e-01 1.13381703e+00 3.41321081e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998543373573026
cond(S) = 1337.7955226243116
E1 = -183.57825059266327  E_coul = 55.07846836438781
init E= -128.499782228275
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773942787828752  LUMO = 0.829518313569427
  mo_energy =
[-3.25554891e+01 -1.85290731e+00 -7.73942788e-01 -7.73942788e-01
 -7.73942788e-01  8.29518314e-01  1.10597415e+00  1.10597415e+00
  1.10597415e+00  4.60046439e+00  5.71683415e+00  5.71683415e+00
  5.71683415e+00  1.67616115e+01  2.39197606e+01  2.39197606e+01
  2.39197606e+01  5.33385314e+01  1.18565710e+02  1.18565710e+02
  1.18565710e+02  1.63908699e+02  5.29497041e+02  1.89539250e+03
  8.02226706e+03  4.77861855e+04]
E1 = -182.10839986516925  E_coul = 53.57930058008703
cycle= 1 E= -128.529099285082  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462247
diis-c [-0.2136727  1.       ]
  HOMO = -0.879808798787433  LUMO = 0.801080589681254
  mo_energy =
[-3.28745986e+01 -1.96340585e+00 -8.79808799e-01 -8.79808799e-01
 -8.79808799e-01  8.01080590e-01  1.06806990e+00  1.06806990e+00
  1.06806990e+00  4.51461333e+00  5.58860120e+00  5.58860120e+00
  5.58860120e+00  1.65908577e+01  2.36852657e+01  2.36852657e+01
  2.36852657e+01  5.30853239e+01  1.18244291e+02  1.18244291e+02
  1.18244291e+02  1.63595292e+02  5.29139925e+02  1.89499875e+03
  8.02184402e+03  4.77857435e+04]
E1 = -182.84218297045126  E_coul = 54.31057099549142
cycle= 2 E= -128.53161197496  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231313
diis-c [-0.0006861   0.33243915  0.66756085]
  HOMO = -0.845384791142034  LUMO = 0.810309173340391
  mo_energy =
[-3.27694132e+01 -1.92721303e+00 -8.45384791e-01 -8.45384791e-01
 -8.45384791e-01  8.10309173e-01  1.08045638e+00  1.08045638e+00
  1.08045638e+00  4.54235567e+00  5.63029626e+00  5.63029626e+00
  5.63029626e+00  1.66468178e+01  2.37626768e+01  2.37626768e+01
  2.37626768e+01  5.31691743e+01  1.18349510e+02  1.18349510e+02
  1.18349510e+02  1.63698300e+02  5.29253501e+02  1.89511769e+03
  8.02196545e+03  4.77858658e+04]
E1 = -182.5960788355171  E_coul = 54.06361546646488
cycle= 3 E= -128.532463369052  delta_E= -0.000851  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000881765
diis-c [-1.43782779e-07 -2.20944940e-03 -9.80945572e-04  1.00319039e+00]
  HOMO = -0.845611821331739  LUMO = 0.810273184350794
  mo_energy =
[-3.27697976e+01 -1.92737565e+00 -8.45611821e-01 -8.45611821e-01
 -8.45611821e-01  8.10273184e-01  1.08040890e+00  1.08040890e+00
  1.08040890e+00  4.54222342e+00  5.63010324e+00  5.63010324e+00
  5.63010324e+00  1.66465769e+01  2.37623722e+01  2.37623722e+01
  2.37623722e+01  5.31688583e+01  1.18349114e+02  1.18349114e+02
  1.18349114e+02  1.63697914e+02  5.29253019e+02  1.89511710e+03
  8.02196477e+03  4.77858651e+04]
E1 = -182.59650727526568  E_coul = 54.06404388651914
cycle= 4 E= -128.532463388747  delta_E= -1.97e-08  |g|= 6.41e-05  |ddm|= 0.000306
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133177
diis-c [-1.02572676e-09  3.15223965e-04  4.90115989e-04 -2.11607421e-01
  1.21080208e+00]
  HOMO = -0.845644526205336  LUMO = 0.810265885407218
  mo_energy =
[-3.27698510e+01 -1.92739603e+00 -8.45644526e-01 -8.45644526e-01
 -8.45644526e-01  8.10265885e-01  1.08039526e+00  1.08039526e+00
  1.08039526e+00  4.54219975e+00  5.63006718e+00  5.63006718e+00
  5.63006718e+00  1.66465363e+01  2.37623240e+01  2.37623240e+01
  2.37623240e+01  5.31688092e+01  1.18349060e+02  1.18349060e+02
  1.18349060e+02  1.63697860e+02  5.29252958e+02  1.89511703e+03
  8.02196470e+03  4.77858651e+04]
E1 = -182.5966123423809  E_coul = 54.064148953088925
cycle= 5 E= -128.532463389292  delta_E= -5.45e-10  |g|= 6.72e-06  |ddm|= 5.29e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5966123423809  E_coul = 54.064148953088925
  HOMO = -0.845640851110946  LUMO = 0.810267396668118
  mo_energy =
[-3.27698430e+01 -1.92739163e+00 -8.45640851e-01 -8.45640851e-01
 -8.45640851e-01  8.10267397e-01  1.08039679e+00  1.08039679e+00
  1.08039679e+00  4.54220333e+00  5.63007162e+00  5.63007162e+00
  5.63007162e+00  1.66465421e+01  2.37623309e+01  2.37623309e+01
  2.37623309e+01  5.31688164e+01  1.18349068e+02  1.18349068e+02
  1.18349068e+02  1.63697868e+02  5.29252966e+02  1.89511704e+03
  8.02196471e+03  4.77858651e+04]
E1 = -182.59659468536563  E_coul = 54.06413129607109
Extra cycle  E= -128.532463389295  delta_E= -2.59e-12  |g|= 2.47e-06  |ddm|= 2.45e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [8.12650040e-01 2.44137941e+04 3.66145376e+03 8.33283684e+02
 2.35629455e+02 7.65723533e+01 1.18189066e+01 2.84162348e+01
 3.11202425e-01 2.04200019e+00 5.22222132e+00 3.64414838e+00
 1.23212746e+01 5.47890965e+01 3.28179115e-01 1.13381703e+00]
E = -128.53246338929455
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.812650039901       1
[INPUT] 0    0    [1    /1   ]  24413.7941435        1
[INPUT] 0    0    [1    /1   ]  3661.45376474        1
[INPUT] 0    0    [1    /1   ]  833.28368358         1
[INPUT] 0    0    [1    /1   ]  235.629455268        1
[INPUT] 0    0    [1    /1   ]  76.5723532844        1
[INPUT] 0    0    [1    /1   ]  11.8189066107        1
[INPUT] 0    0    [1    /1   ]  28.416234797         1
[INPUT] 0    0    [1    /1   ]  0.31120242529        1
[INPUT] 0    0    [1    /1   ]  2.04200018567        1
[INPUT] 0    0    [1    /1   ]  5.22222131528        1
[INPUT] 1    0    [1    /1   ]  3.6441483775         1
[INPUT] 1    0    [1    /1   ]  12.3212746281        1
[INPUT] 1    0    [1    /1   ]  54.7890964869        1
[INPUT] 1    0    [1    /1   ]  0.328179115101       1
[INPUT] 1    0    [1    /1   ]  1.13381703124        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8126500399008001, 1.0]], [0, [24413.794143547806, 1.0]], [0, [3661.453764738154, 1.0]], [0, [833.2836835799734, 1.0]], [0, [235.62945526772452, 1.0]], [0, [76.57235328438816, 1.0]], [0, [11.818906610749556, 1.0]], [0, [28.4162347970086, 1.0]], [0, [0.31120242528950365, 1.0]], [0, [2.0420001856654504, 1.0]], [0, [5.222221315280554, 1.0]], [1, [3.644148377504232, 1.0]], [1, [12.321274628064119, 1.0]], [1, [54.78909648692693, 1.0]], [1, [0.3281791151013478, 1.0]], [1, [1.1338170312442555, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81265004]
bas 1, expnt(s) = [24413.79414355]
bas 2, expnt(s) = [3661.45376474]
bas 3, expnt(s) = [833.28368358]
bas 4, expnt(s) = [235.62945527]
bas 5, expnt(s) = [76.57235328]
bas 6, expnt(s) = [11.81890661]
bas 7, expnt(s) = [28.4162348]
bas 8, expnt(s) = [0.31120243]
bas 9, expnt(s) = [2.04200019]
bas 10, expnt(s) = [5.22222132]
bas 11, expnt(s) = [3.64414838]
bas 12, expnt(s) = [12.32127463]
bas 13, expnt(s) = [54.78909649]
bas 14, expnt(s) = [0.32817912]
bas 15, expnt(s) = [1.13381703]
CPU time:       268.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12650040e-01 2.16243317e+00 2.44137941e+04 4.93448102e+03
 3.66145376e+03 1.18920079e+03 8.33283684e+02 3.91840826e+02
 2.35629455e+02 1.51945278e+02 7.65723533e+01 6.53986856e+01
 1.18189066e+01 1.61045280e+01 2.84162348e+01 3.10949544e+01
 3.11202425e-01 1.05268214e+00 2.04200019e+00 4.31575574e+00
 5.22222132e+00 8.72783403e+00 3.64414838e+00 1.46885680e+01
 1.23212746e+01 6.73447802e+01 5.47890965e+01 4.34862608e+02
 3.28179115e-01 7.24641274e-01 1.13381703e+00 3.41321081e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998543373573026
cond(S) = 1337.7955226243116
E1 = -183.57825059266327  E_coul = 55.07846836438781
init E= -128.499782228275
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773942787828752  LUMO = 0.829518313569427
  mo_energy =
[-3.25554891e+01 -1.85290731e+00 -7.73942788e-01 -7.73942788e-01
 -7.73942788e-01  8.29518314e-01  1.10597415e+00  1.10597415e+00
  1.10597415e+00  4.60046439e+00  5.71683415e+00  5.71683415e+00
  5.71683415e+00  1.67616115e+01  2.39197606e+01  2.39197606e+01
  2.39197606e+01  5.33385314e+01  1.18565710e+02  1.18565710e+02
  1.18565710e+02  1.63908699e+02  5.29497041e+02  1.89539250e+03
  8.02226706e+03  4.77861855e+04]
E1 = -182.10839986516925  E_coul = 53.57930058008703
cycle= 1 E= -128.529099285082  delta_E= -0.0293  |g|= 0.202  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.462247
diis-c [-0.2136727  1.       ]
  HOMO = -0.879808798787433  LUMO = 0.801080589681254
  mo_energy =
[-3.28745986e+01 -1.96340585e+00 -8.79808799e-01 -8.79808799e-01
 -8.79808799e-01  8.01080590e-01  1.06806990e+00  1.06806990e+00
  1.06806990e+00  4.51461333e+00  5.58860120e+00  5.58860120e+00
  5.58860120e+00  1.65908577e+01  2.36852657e+01  2.36852657e+01
  2.36852657e+01  5.30853239e+01  1.18244291e+02  1.18244291e+02
  1.18244291e+02  1.63595292e+02  5.29139925e+02  1.89499875e+03
  8.02184402e+03  4.77857435e+04]
E1 = -182.84218297045126  E_coul = 54.31057099549142
cycle= 2 E= -128.53161197496  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231313
diis-c [-0.0006861   0.33243915  0.66756085]
  HOMO = -0.845384791142034  LUMO = 0.810309173340391
  mo_energy =
[-3.27694132e+01 -1.92721303e+00 -8.45384791e-01 -8.45384791e-01
 -8.45384791e-01  8.10309173e-01  1.08045638e+00  1.08045638e+00
  1.08045638e+00  4.54235567e+00  5.63029626e+00  5.63029626e+00
  5.63029626e+00  1.66468178e+01  2.37626768e+01  2.37626768e+01
  2.37626768e+01  5.31691743e+01  1.18349510e+02  1.18349510e+02
  1.18349510e+02  1.63698300e+02  5.29253501e+02  1.89511769e+03
  8.02196545e+03  4.77858658e+04]
E1 = -182.5960788355171  E_coul = 54.06361546646488
cycle= 3 E= -128.532463369052  delta_E= -0.000851  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000881765
diis-c [-1.43782779e-07 -2.20944940e-03 -9.80945572e-04  1.00319039e+00]
  HOMO = -0.845611821331739  LUMO = 0.810273184350794
  mo_energy =
[-3.27697976e+01 -1.92737565e+00 -8.45611821e-01 -8.45611821e-01
 -8.45611821e-01  8.10273184e-01  1.08040890e+00  1.08040890e+00
  1.08040890e+00  4.54222342e+00  5.63010324e+00  5.63010324e+00
  5.63010324e+00  1.66465769e+01  2.37623722e+01  2.37623722e+01
  2.37623722e+01  5.31688583e+01  1.18349114e+02  1.18349114e+02
  1.18349114e+02  1.63697914e+02  5.29253019e+02  1.89511710e+03
  8.02196477e+03  4.77858651e+04]
E1 = -182.59650727526568  E_coul = 54.06404388651914
cycle= 4 E= -128.532463388747  delta_E= -1.97e-08  |g|= 6.41e-05  |ddm|= 0.000306
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133177
diis-c [-1.02572676e-09  3.15223965e-04  4.90115989e-04 -2.11607421e-01
  1.21080208e+00]
  HOMO = -0.845644526205336  LUMO = 0.810265885407218
  mo_energy =
[-3.27698510e+01 -1.92739603e+00 -8.45644526e-01 -8.45644526e-01
 -8.45644526e-01  8.10265885e-01  1.08039526e+00  1.08039526e+00
  1.08039526e+00  4.54219975e+00  5.63006718e+00  5.63006718e+00
  5.63006718e+00  1.66465363e+01  2.37623240e+01  2.37623240e+01
  2.37623240e+01  5.31688092e+01  1.18349060e+02  1.18349060e+02
  1.18349060e+02  1.63697860e+02  5.29252958e+02  1.89511703e+03
  8.02196470e+03  4.77858651e+04]
E1 = -182.5966123423809  E_coul = 54.064148953088925
cycle= 5 E= -128.532463389292  delta_E= -5.45e-10  |g|= 6.72e-06  |ddm|= 5.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5966123423809  E_coul = 54.064148953088925
  HOMO = -0.845640851110946  LUMO = 0.810267396668118
  mo_energy =
[-3.27698430e+01 -1.92739163e+00 -8.45640851e-01 -8.45640851e-01
 -8.45640851e-01  8.10267397e-01  1.08039679e+00  1.08039679e+00
  1.08039679e+00  4.54220333e+00  5.63007162e+00  5.63007162e+00
  5.63007162e+00  1.66465421e+01  2.37623309e+01  2.37623309e+01
  2.37623309e+01  5.31688164e+01  1.18349068e+02  1.18349068e+02
  1.18349068e+02  1.63697868e+02  5.29252966e+02  1.89511704e+03
  8.02196471e+03  4.77858651e+04]
E1 = -182.59659468536563  E_coul = 54.06413129607109
Extra cycle  E= -128.532463389295  delta_E= -2.59e-12  |g|= 2.47e-06  |ddm|= 2.45e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1337.7955226243116
E1 = -182.59659468536563  E_coul = 54.06413129607109
init E= -128.532463389295
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845642086449477  LUMO = 0.810267136863606
  mo_energy =
[-3.27698470e+01 -1.92739281e+00 -8.45642086e-01 -8.45642086e-01
 -8.45642086e-01  8.10267137e-01  1.08039636e+00  1.08039636e+00
  1.08039636e+00  4.54220242e+00  5.63007013e+00  5.63007013e+00
  5.63007013e+00  1.66465401e+01  2.37623280e+01  2.37623280e+01
  2.37623280e+01  5.31688134e+01  1.18349064e+02  1.18349064e+02
  1.18349064e+02  1.63697864e+02  5.29252961e+02  1.89511703e+03
  8.02196470e+03  4.77858651e+04]
E1 = -182.59660421562774  E_coul = 54.06414082633251
cycle= 1 E= -128.532463389295  delta_E= -6.82e-13  |g|= 1.31e-06  |ddm|= 9.45e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59660421562774  E_coul = 54.06414082633251
  HOMO = -0.845641416461356  LUMO = 0.81026732896347
  mo_energy =
[-3.27698450e+01 -1.92739208e+00 -8.45641416e-01 -8.45641416e-01
 -8.45641416e-01  8.10267329e-01  1.08039660e+00  1.08039660e+00
  1.08039660e+00  4.54220297e+00  5.63007095e+00  5.63007095e+00
  5.63007095e+00  1.66465412e+01  2.37623295e+01  2.37623295e+01
  2.37623295e+01  5.31688150e+01  1.18349066e+02  1.18349066e+02
  1.18349066e+02  1.63697866e+02  5.29252964e+02  1.89511704e+03
  8.02196470e+03  4.77858651e+04]
E1 = -182.59659947858717  E_coul = 54.0641360892919
Extra cycle  E= -128.532463389295  delta_E= -2.84e-14  |g|= 6.45e-07  |ddm|= 4.61e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [8.12650040e-01 2.44137941e+04 3.66145376e+03 8.33283684e+02
 2.35629455e+02 7.65723533e+01 1.18189066e+01 2.84162348e+01
 3.11202425e-01 2.04200019e+00 5.22222132e+00 3.64414838e+00
 1.23212746e+01 5.47890965e+01 3.28179115e-01 1.13381703e+00]
grad_E = [ 1.30377781e-04 -1.29312284e-09  6.80241255e-08 -1.33345043e-06
  1.38927474e-05 -5.48326350e-05  2.99343654e-05 -4.17784984e-05
 -2.99462707e-05 -4.62457767e-05  1.43910106e-06 -1.47809993e-04
 -1.91236188e-04  3.25608686e-05 -7.20053652e-06  2.78266146e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.822497383867       1
[INPUT] 0    0    [1    /1   ]  24413.7941453        1
[INPUT] 0    0    [1    /1   ]  3661.45367139        1
[INPUT] 0    0    [1    /1   ]  833.285407075        1
[INPUT] 0    0    [1    /1   ]  235.613597494        1
[INPUT] 0    0    [1    /1   ]  76.6197109717        1
[INPUT] 0    0    [1    /1   ]  11.9468433701        1
[INPUT] 0    0    [1    /1   ]  28.4820051697        1
[INPUT] 0    0    [1    /1   ]  0.31399640997        1
[INPUT] 0    0    [1    /1   ]  2.06458118109        1
[INPUT] 0    0    [1    /1   ]  5.40298725678        1
[INPUT] 1    0    [1    /1   ]  3.64792572397        1
[INPUT] 1    0    [1    /1   ]  12.3330800517        1
[INPUT] 1    0    [1    /1   ]  54.785762468         1
[INPUT] 1    0    [1    /1   ]  0.32841220209        1
[INPUT] 1    0    [1    /1   ]  1.13487425713        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8224973838673109, 1.0]], [0, [24413.794145338023, 1.0]], [0, [3661.4536713906905, 1.0]], [0, [833.2854070752954, 1.0]], [0, [235.61359749378107, 1.0]], [0, [76.619710971706, 1.0]], [0, [11.946843370125071, 1.0]], [0, [28.482005169653743, 1.0]], [0, [0.31399640997013967, 1.0]], [0, [2.064581181092821, 1.0]], [0, [5.4029872567789825, 1.0]], [1, [3.6479257239655487, 1.0]], [1, [12.333080051740943, 1.0]], [1, [54.785762468004464, 1.0]], [1, [0.3284122020901943, 1.0]], [1, [1.1348742571333756, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82249738]
bas 1, expnt(s) = [24413.79414534]
bas 2, expnt(s) = [3661.45367139]
bas 3, expnt(s) = [833.28540708]
bas 4, expnt(s) = [235.61359749]
bas 5, expnt(s) = [76.61971097]
bas 6, expnt(s) = [11.94684337]
bas 7, expnt(s) = [28.48200517]
bas 8, expnt(s) = [0.31399641]
bas 9, expnt(s) = [2.06458118]
bas 10, expnt(s) = [5.40298726]
bas 11, expnt(s) = [3.64792572]
bas 12, expnt(s) = [12.33308005]
bas 13, expnt(s) = [54.78576247]
bas 14, expnt(s) = [0.3284122]
bas 15, expnt(s) = [1.13487426]
CPU time:       271.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.22497384e-01 2.18205613e+00 2.44137941e+04 4.93448102e+03
 3.66145367e+03 1.18920077e+03 8.33285407e+02 3.91841433e+02
 2.35613597e+02 1.51937609e+02 7.66197110e+01 6.54290186e+01
 1.19468434e+01 1.62350975e+01 2.84820052e+01 3.11489165e+01
 3.13996410e-01 1.05976247e+00 2.06458118e+00 4.35150010e+00
 5.40298726e+00 8.95345142e+00 3.64792572e+00 1.47076022e+01
 1.23330801e+01 6.74254464e+01 5.47857625e+01 4.34829530e+02
 3.28412202e-01 7.25284671e-01 1.13487426e+00 3.41718958e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998537117020234
cond(S) = 1391.415462351228
E1 = -183.57824268270477  E_coul = 55.07847448310173
init E= -128.499768199603
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773942534617077  LUMO = 0.84221463245605
  mo_energy =
[-3.25554883e+01 -1.85290591e+00 -7.73942535e-01 -7.73942535e-01
 -7.73942535e-01  8.42214632e-01  1.10702372e+00  1.10702372e+00
  1.10702372e+00  4.67808209e+00  5.72290120e+00  5.72290120e+00
  5.72290120e+00  1.71416666e+01  2.39474028e+01  2.39474028e+01
  2.39474028e+01  5.43051326e+01  1.18612013e+02  1.18612013e+02
  1.18612013e+02  1.65361492e+02  5.31136755e+02  1.89696143e+03
  8.02366455e+03  4.77873459e+04]
E1 = -182.10881496690982  E_coul = 53.57971077878903
cycle= 1 E= -128.529104188121  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461921
diis-c [-0.21337112  1.        ]
  HOMO = -0.879777627071935  LUMO = 0.813317280515474
  mo_energy =
[-3.28745236e+01 -1.96337024e+00 -8.79777627e-01 -8.79777627e-01
 -8.79777627e-01  8.13317281e-01  1.06908978e+00  1.06908978e+00
  1.06908978e+00  4.59096882e+00  5.59461717e+00  5.59461717e+00
  5.59461717e+00  1.69689768e+01  2.37128891e+01  2.37128891e+01
  2.37128891e+01  5.40511865e+01  1.18290672e+02  1.18290672e+02
  1.18290672e+02  1.65048092e+02  5.30779750e+02  1.89656778e+03
  8.02324161e+03  4.77869040e+04]
E1 = -182.84233344092794  E_coul = 54.31071774337723
cycle= 2 E= -128.531615697551  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231137
diis-c [-0.0006909   0.33241774  0.66758226]
  HOMO = -0.845365612553312  LUMO = 0.82269263778395
  mo_energy =
[-3.27693700e+01 -1.92719005e+00 -8.45365613e-01 -8.45365613e-01
 -8.45365613e-01  8.22692638e-01  1.08148568e+00  1.08148568e+00
  1.08148568e+00  4.61912362e+00  5.63632761e+00  5.63632761e+00
  5.63632761e+00  1.70255868e+01  2.37903010e+01  2.37903010e+01
  2.37903010e+01  5.41352788e+01  1.18395858e+02  1.18395858e+02
  1.18395858e+02  1.65151086e+02  5.30893283e+02  1.89668668e+03
  8.02336299e+03  4.77870263e+04]
E1 = -182.59633400724897  E_coul = 54.063867543489714
cycle= 3 E= -128.532466463759  delta_E= -0.000851  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0008814
diis-c [-1.42241756e-07 -2.21146249e-03 -9.80263631e-04  1.00319173e+00]
  HOMO = -0.845592458008192  LUMO = 0.822656089154863
  mo_energy =
[-3.27697539e+01 -1.92735247e+00 -8.45592458e-01 -8.45592458e-01
 -8.45592458e-01  8.22656089e-01  1.08143824e+00  1.08143824e+00
  1.08143824e+00  4.61898968e+00  5.63613466e+00  5.63613466e+00
  5.63613466e+00  1.70253442e+01  2.37899968e+01  2.37899968e+01
  2.37899968e+01  5.41349624e+01  1.18395463e+02  1.18395463e+02
  1.18395463e+02  1.65150701e+02  5.30892802e+02  1.89668609e+03
  8.02336232e+03  4.77870256e+04]
E1 = -182.59676213423919  E_coul = 54.06429565085347
cycle= 4 E= -128.532466483386  delta_E= -1.96e-08  |g|= 6.42e-05  |ddm|= 0.000305
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133493
diis-c [-1.02248633e-09  3.14522355e-04  4.93169029e-04 -2.11115562e-01
  1.21030787e+00]
  HOMO = -0.845625172670301  LUMO = 0.822648683402139
  mo_energy =
[-3.27698075e+01 -1.92737288e+00 -8.45625173e-01 -8.45625173e-01
 -8.45625173e-01  8.22648683e-01  1.08142459e+00  1.08142459e+00
  1.08142459e+00  4.61896570e+00  5.63609856e+00  5.63609856e+00
  5.63609856e+00  1.70253032e+01  2.37899485e+01  2.37899485e+01
  2.37899485e+01  5.41349132e+01  1.18395408e+02  1.18395408e+02
  1.18395408e+02  1.65150647e+02  5.30892741e+02  1.89668602e+03
  8.02336224e+03  4.77870256e+04]
E1 = -182.5968677815096  E_coul = 54.064401297579046
cycle= 5 E= -128.532466483931  delta_E= -5.45e-10  |g|= 6.7e-06  |ddm|= 5.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5968677815096  E_coul = 54.064401297579046
  HOMO = -0.845621515764783  LUMO = 0.822650211609859
  mo_energy =
[-3.27697996e+01 -1.92736849e+00 -8.45621516e-01 -8.45621516e-01
 -8.45621516e-01  8.22650212e-01  1.08142612e+00  1.08142612e+00
  1.08142612e+00  4.61896931e+00  5.63610298e+00  5.63610298e+00
  5.63610298e+00  1.70253091e+01  2.37899553e+01  2.37899553e+01
  2.37899553e+01  5.41349204e+01  1.18395416e+02  1.18395416e+02
  1.18395416e+02  1.65150655e+02  5.30892748e+02  1.89668603e+03
  8.02336225e+03  4.77870256e+04]
E1 = -182.5968502305901  E_coul = 54.06438374665689
Extra cycle  E= -128.532466483933  delta_E= -2.67e-12  |g|= 2.46e-06  |ddm|= 2.43e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [8.22497384e-01 2.44137941e+04 3.66145367e+03 8.33285407e+02
 2.35613597e+02 7.66197110e+01 1.19468434e+01 2.84820052e+01
 3.13996410e-01 2.06458118e+00 5.40298726e+00 3.64792572e+00
 1.23330801e+01 5.47857625e+01 3.28412202e-01 1.13487426e+00]
E = -128.5324664839332
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.822497383867       1
[INPUT] 0    0    [1    /1   ]  24413.7941453        1
[INPUT] 0    0    [1    /1   ]  3661.45367139        1
[INPUT] 0    0    [1    /1   ]  833.285407075        1
[INPUT] 0    0    [1    /1   ]  235.613597494        1
[INPUT] 0    0    [1    /1   ]  76.6197109717        1
[INPUT] 0    0    [1    /1   ]  11.9468433701        1
[INPUT] 0    0    [1    /1   ]  28.4820051697        1
[INPUT] 0    0    [1    /1   ]  0.31399640997        1
[INPUT] 0    0    [1    /1   ]  2.06458118109        1
[INPUT] 0    0    [1    /1   ]  5.40298725678        1
[INPUT] 1    0    [1    /1   ]  3.64792572397        1
[INPUT] 1    0    [1    /1   ]  12.3330800517        1
[INPUT] 1    0    [1    /1   ]  54.785762468         1
[INPUT] 1    0    [1    /1   ]  0.32841220209        1
[INPUT] 1    0    [1    /1   ]  1.13487425713        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8224973838673109, 1.0]], [0, [24413.794145338023, 1.0]], [0, [3661.4536713906905, 1.0]], [0, [833.2854070752954, 1.0]], [0, [235.61359749378107, 1.0]], [0, [76.619710971706, 1.0]], [0, [11.946843370125071, 1.0]], [0, [28.482005169653743, 1.0]], [0, [0.31399640997013967, 1.0]], [0, [2.064581181092821, 1.0]], [0, [5.4029872567789825, 1.0]], [1, [3.6479257239655487, 1.0]], [1, [12.333080051740943, 1.0]], [1, [54.785762468004464, 1.0]], [1, [0.3284122020901943, 1.0]], [1, [1.1348742571333756, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82249738]
bas 1, expnt(s) = [24413.79414534]
bas 2, expnt(s) = [3661.45367139]
bas 3, expnt(s) = [833.28540708]
bas 4, expnt(s) = [235.61359749]
bas 5, expnt(s) = [76.61971097]
bas 6, expnt(s) = [11.94684337]
bas 7, expnt(s) = [28.48200517]
bas 8, expnt(s) = [0.31399641]
bas 9, expnt(s) = [2.06458118]
bas 10, expnt(s) = [5.40298726]
bas 11, expnt(s) = [3.64792572]
bas 12, expnt(s) = [12.33308005]
bas 13, expnt(s) = [54.78576247]
bas 14, expnt(s) = [0.3284122]
bas 15, expnt(s) = [1.13487426]
CPU time:       272.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.22497384e-01 2.18205613e+00 2.44137941e+04 4.93448102e+03
 3.66145367e+03 1.18920077e+03 8.33285407e+02 3.91841433e+02
 2.35613597e+02 1.51937609e+02 7.66197110e+01 6.54290186e+01
 1.19468434e+01 1.62350975e+01 2.84820052e+01 3.11489165e+01
 3.13996410e-01 1.05976247e+00 2.06458118e+00 4.35150010e+00
 5.40298726e+00 8.95345142e+00 3.64792572e+00 1.47076022e+01
 1.23330801e+01 6.74254464e+01 5.47857625e+01 4.34829530e+02
 3.28412202e-01 7.25284671e-01 1.13487426e+00 3.41718958e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998537117020234
cond(S) = 1391.415462351228
E1 = -183.57824268270477  E_coul = 55.07847448310173
init E= -128.499768199603
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773942534617077  LUMO = 0.84221463245605
  mo_energy =
[-3.25554883e+01 -1.85290591e+00 -7.73942535e-01 -7.73942535e-01
 -7.73942535e-01  8.42214632e-01  1.10702372e+00  1.10702372e+00
  1.10702372e+00  4.67808209e+00  5.72290120e+00  5.72290120e+00
  5.72290120e+00  1.71416666e+01  2.39474028e+01  2.39474028e+01
  2.39474028e+01  5.43051326e+01  1.18612013e+02  1.18612013e+02
  1.18612013e+02  1.65361492e+02  5.31136755e+02  1.89696143e+03
  8.02366455e+03  4.77873459e+04]
E1 = -182.10881496690982  E_coul = 53.57971077878903
cycle= 1 E= -128.529104188121  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461921
diis-c [-0.21337112  1.        ]
  HOMO = -0.879777627071935  LUMO = 0.813317280515474
  mo_energy =
[-3.28745236e+01 -1.96337024e+00 -8.79777627e-01 -8.79777627e-01
 -8.79777627e-01  8.13317281e-01  1.06908978e+00  1.06908978e+00
  1.06908978e+00  4.59096882e+00  5.59461717e+00  5.59461717e+00
  5.59461717e+00  1.69689768e+01  2.37128891e+01  2.37128891e+01
  2.37128891e+01  5.40511865e+01  1.18290672e+02  1.18290672e+02
  1.18290672e+02  1.65048092e+02  5.30779750e+02  1.89656778e+03
  8.02324161e+03  4.77869040e+04]
E1 = -182.84233344092794  E_coul = 54.31071774337723
cycle= 2 E= -128.531615697551  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0696
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231137
diis-c [-0.0006909   0.33241774  0.66758226]
  HOMO = -0.845365612553312  LUMO = 0.82269263778395
  mo_energy =
[-3.27693700e+01 -1.92719005e+00 -8.45365613e-01 -8.45365613e-01
 -8.45365613e-01  8.22692638e-01  1.08148568e+00  1.08148568e+00
  1.08148568e+00  4.61912362e+00  5.63632761e+00  5.63632761e+00
  5.63632761e+00  1.70255868e+01  2.37903010e+01  2.37903010e+01
  2.37903010e+01  5.41352788e+01  1.18395858e+02  1.18395858e+02
  1.18395858e+02  1.65151086e+02  5.30893283e+02  1.89668668e+03
  8.02336299e+03  4.77870263e+04]
E1 = -182.59633400724897  E_coul = 54.063867543489714
cycle= 3 E= -128.532466463759  delta_E= -0.000851  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.0008814
diis-c [-1.42241756e-07 -2.21146249e-03 -9.80263631e-04  1.00319173e+00]
  HOMO = -0.845592458008192  LUMO = 0.822656089154863
  mo_energy =
[-3.27697539e+01 -1.92735247e+00 -8.45592458e-01 -8.45592458e-01
 -8.45592458e-01  8.22656089e-01  1.08143824e+00  1.08143824e+00
  1.08143824e+00  4.61898968e+00  5.63613466e+00  5.63613466e+00
  5.63613466e+00  1.70253442e+01  2.37899968e+01  2.37899968e+01
  2.37899968e+01  5.41349624e+01  1.18395463e+02  1.18395463e+02
  1.18395463e+02  1.65150701e+02  5.30892802e+02  1.89668609e+03
  8.02336232e+03  4.77870256e+04]
E1 = -182.59676213423919  E_coul = 54.06429565085347
cycle= 4 E= -128.532466483386  delta_E= -1.96e-08  |g|= 6.42e-05  |ddm|= 0.000305
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133493
diis-c [-1.02248633e-09  3.14522355e-04  4.93169029e-04 -2.11115562e-01
  1.21030787e+00]
  HOMO = -0.845625172670301  LUMO = 0.822648683402139
  mo_energy =
[-3.27698075e+01 -1.92737288e+00 -8.45625173e-01 -8.45625173e-01
 -8.45625173e-01  8.22648683e-01  1.08142459e+00  1.08142459e+00
  1.08142459e+00  4.61896570e+00  5.63609856e+00  5.63609856e+00
  5.63609856e+00  1.70253032e+01  2.37899485e+01  2.37899485e+01
  2.37899485e+01  5.41349132e+01  1.18395408e+02  1.18395408e+02
  1.18395408e+02  1.65150647e+02  5.30892741e+02  1.89668602e+03
  8.02336224e+03  4.77870256e+04]
E1 = -182.5968677815096  E_coul = 54.064401297579046
cycle= 5 E= -128.532466483931  delta_E= -5.45e-10  |g|= 6.7e-06  |ddm|= 5.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5968677815096  E_coul = 54.064401297579046
  HOMO = -0.845621515764783  LUMO = 0.822650211609859
  mo_energy =
[-3.27697996e+01 -1.92736849e+00 -8.45621516e-01 -8.45621516e-01
 -8.45621516e-01  8.22650212e-01  1.08142612e+00  1.08142612e+00
  1.08142612e+00  4.61896931e+00  5.63610298e+00  5.63610298e+00
  5.63610298e+00  1.70253091e+01  2.37899553e+01  2.37899553e+01
  2.37899553e+01  5.41349204e+01  1.18395416e+02  1.18395416e+02
  1.18395416e+02  1.65150655e+02  5.30892748e+02  1.89668603e+03
  8.02336225e+03  4.77870256e+04]
E1 = -182.5968502305901  E_coul = 54.06438374665689
Extra cycle  E= -128.532466483933  delta_E= -2.67e-12  |g|= 2.46e-06  |ddm|= 2.43e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1391.415462351228
E1 = -182.5968502305901  E_coul = 54.06438374665689
init E= -128.532466483933
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.84562274379924  LUMO = 0.822649949273005
  mo_energy =
[-3.27698035e+01 -1.92736966e+00 -8.45622744e-01 -8.45622744e-01
 -8.45622744e-01  8.22649949e-01  1.08142569e+00  1.08142569e+00
  1.08142569e+00  4.61896839e+00  5.63610150e+00  5.63610150e+00
  5.63610150e+00  1.70253070e+01  2.37899525e+01  2.37899525e+01
  2.37899525e+01  5.41349173e+01  1.18395412e+02  1.18395412e+02
  1.18395412e+02  1.65150651e+02  5.30892744e+02  1.89668602e+03
  8.02336224e+03  4.77870256e+04]
E1 = -182.59685970422413  E_coul = 54.064393220290576
cycle= 1 E= -128.532466483934  delta_E= -3.41e-13  |g|= 1.3e-06  |ddm|= 9.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59685970422413  E_coul = 54.064393220290576
  HOMO = -0.845622077851489  LUMO = 0.822650143362424
  mo_energy =
[-3.27698015e+01 -1.92736894e+00 -8.45622078e-01 -8.45622078e-01
 -8.45622078e-01  8.22650143e-01  1.08142594e+00  1.08142594e+00
  1.08142594e+00  4.61896895e+00  5.63610231e+00  5.63610231e+00
  5.63610231e+00  1.70253082e+01  2.37899540e+01  2.37899540e+01
  2.37899540e+01  5.41349189e+01  1.18395414e+02  1.18395414e+02
  1.18395414e+02  1.65150653e+02  5.30892746e+02  1.89668602e+03
  8.02336225e+03  4.77870256e+04]
E1 = -182.59685499591038  E_coul = 54.06438851197659
Extra cycle  E= -128.532466483934  delta_E= -2.27e-13  |g|= 6.41e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [8.22497384e-01 2.44137941e+04 3.66145367e+03 8.33285407e+02
 2.35613597e+02 7.66197110e+01 1.19468434e+01 2.84820052e+01
 3.13996410e-01 2.06458118e+00 5.40298726e+00 3.64792572e+00
 1.23330801e+01 5.47857625e+01 3.28412202e-01 1.13487426e+00]
grad_E = [ 2.10759497e-04 -1.15924417e-09  6.11109050e-08 -1.20870840e-06
  1.27650692e-05 -4.99413674e-05  3.65560647e-05 -5.19207997e-05
 -8.15786643e-05 -6.81938452e-05  5.96444439e-06 -1.54538968e-04
 -1.69825897e-04  2.92562402e-05  3.88871908e-05  3.02410564e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.830548696023       1
[INPUT] 0    0    [1    /1   ]  24413.7941476        1
[INPUT] 0    0    [1    /1   ]  3661.4535531         1
[INPUT] 0    0    [1    /1   ]  833.287598959        1
[INPUT] 0    0    [1    /1   ]  235.593244362        1
[INPUT] 0    0    [1    /1   ]  76.6827189433        1
[INPUT] 0    0    [1    /1   ]  12.0970079795        1
[INPUT] 0    0    [1    /1   ]  28.5578683014        1
[INPUT] 0    0    [1    /1   ]  0.316039260958       1
[INPUT] 0    0    [1    /1   ]  2.08502116931        1
[INPUT] 0    0    [1    /1   ]  5.61486128807        1
[INPUT] 1    0    [1    /1   ]  3.65712828007        1
[INPUT] 1    0    [1    /1   ]  12.3627379525        1
[INPUT] 1    0    [1    /1   ]  54.7792107623        1
[INPUT] 1    0    [1    /1   ]  0.328866769192       1
[INPUT] 1    0    [1    /1   ]  1.13716577066        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8305486960233607, 1.0]], [0, [24413.794147605695, 1.0]], [0, [3661.453553098017, 1.0]], [0, [833.2875989591358, 1.0]], [0, [235.5932443617127, 1.0]], [0, [76.68271894331635, 1.0]], [0, [12.097007979490476, 1.0]], [0, [28.557868301376516, 1.0]], [0, [0.31603926095773793, 1.0]], [0, [2.0850211693142167, 1.0]], [0, [5.614861288067611, 1.0]], [1, [3.6571282800655673, 1.0]], [1, [12.36273795252431, 1.0]], [1, [54.77921076226408, 1.0]], [1, [0.32886676919228847, 1.0]], [1, [1.1371657706557565, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8305487]
bas 1, expnt(s) = [24413.79414761]
bas 2, expnt(s) = [3661.4535531]
bas 3, expnt(s) = [833.28759896]
bas 4, expnt(s) = [235.59324436]
bas 5, expnt(s) = [76.68271894]
bas 6, expnt(s) = [12.09700798]
bas 7, expnt(s) = [28.5578683]
bas 8, expnt(s) = [0.31603926]
bas 9, expnt(s) = [2.08502117]
bas 10, expnt(s) = [5.61486129]
bas 11, expnt(s) = [3.65712828]
bas 12, expnt(s) = [12.36273795]
bas 13, expnt(s) = [54.77921076]
bas 14, expnt(s) = [0.32886677]
bas 15, expnt(s) = [1.13716577]
CPU time:       276.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.30548696e-01 2.19805649e+00 2.44137941e+04 4.93448102e+03
 3.66145355e+03 1.18920074e+03 8.33287599e+02 3.91842206e+02
 2.35593244e+02 1.51927765e+02 7.66827189e+01 6.54693685e+01
 1.20970080e+01 1.63879073e+01 2.85578683e+01 3.12111208e+01
 3.16039261e-01 1.06492936e+00 2.08502117e+00 4.38377117e+00
 5.61486129e+00 9.21550837e+00 3.65712828e+00 1.47539951e+01
 1.23627380e+01 6.76281835e+01 5.47792108e+01 4.34764531e+02
 3.28866769e-01 7.26539754e-01 1.13716577e+00 3.42581665e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998524668275977
cond(S) = 1454.2123570400875
E1 = -183.57823546076924  E_coul = 55.07848030769893
init E= -128.49975515307
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943064274854  LUMO = 0.852568132087559
  mo_energy =
[-3.25554844e+01 -1.85290526e+00 -7.73943064e-01 -7.73943064e-01
 -7.73943064e-01  8.52568132e-01  1.10914434e+00  1.10914434e+00
  1.10914434e+00  4.74878608e+00  5.73647864e+00  5.73647864e+00
  5.73647864e+00  1.75466982e+01  2.40143757e+01  2.40143757e+01
  2.40143757e+01  5.53867945e+01  1.18729119e+02  1.18729119e+02
  1.18729119e+02  1.67020856e+02  5.33034253e+02  1.89878574e+03
  8.02529094e+03  4.77886967e+04]
E1 = -182.10953373986894  E_coul = 53.58042174766639
cycle= 1 E= -128.529111992203  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461477
diis-c [-0.21296087  1.        ]
  HOMO = -0.879725808486941  LUMO = 0.823298267250272
  mo_energy =
[-3.28743864e+01 -1.96330886e+00 -8.79725808e-01 -8.79725808e-01
 -8.79725808e-01  8.23298267e-01  1.07114351e+00  1.07114351e+00
  1.07114351e+00  4.66043116e+00  5.60804704e+00  5.60804704e+00
  5.60804704e+00  1.73718842e+01  2.37797679e+01  2.37797679e+01
  2.37797679e+01  5.51320245e+01  1.18407921e+02  1.18407921e+02
  1.18407921e+02  1.66707499e+02  5.32677430e+02  1.89839227e+03
  8.02486816e+03  4.77882550e+04]
E1 = -182.84260176207877  E_coul = 54.310980257327046
cycle= 2 E= -128.531621504752  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230882
diis-c [-0.00069662  0.33237491  0.66762509]
  HOMO = -0.845333857126267  LUMO = 0.832793608645184
  mo_energy =
[-3.27692859e+01 -1.92715002e+00 -8.45333857e-01 -8.45333857e-01
 -8.45333857e-01  8.32793609e-01  1.08356126e+00  1.08356126e+00
  1.08356126e+00  4.68899233e+00  5.64980401e+00  5.64980401e+00
  5.64980401e+00  1.74292071e+01  2.38572033e+01  2.38572033e+01
  2.38572033e+01  5.52163854e+01  1.18513051e+02  1.18513051e+02
  1.18513051e+02  1.66810466e+02  5.32790896e+02  1.89851111e+03
  8.02498949e+03  4.77883773e+04]
E1 = -182.59678092587322  E_coul = 54.064309732380366
cycle= 3 E= -128.532471193493  delta_E= -0.00085  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883049
diis-c [-1.41742339e-07 -2.21739548e-03 -9.79787615e-04  1.00319718e+00]
  HOMO = -0.845560620492282  LUMO = 0.8327567005799
  mo_energy =
[-3.27696697e+01 -1.92731214e+00 -8.45560620e-01 -8.45560620e-01
 -8.45560620e-01  8.32756701e-01  1.08351376e+00  1.08351376e+00
  1.08351376e+00  4.68885677e+00  5.64961084e+00  5.64961084e+00
  5.64961084e+00  1.74289624e+01  2.38568989e+01  2.38568989e+01
  2.38568989e+01  5.52160681e+01  1.18512656e+02  1.18512656e+02
  1.18512656e+02  1.66810081e+02  5.32790415e+02  1.89851052e+03
  8.02498881e+03  4.77883765e+04]
E1 = -182.5972105321443  E_coul = 54.064739319022735
cycle= 4 E= -128.532471213122  delta_E= -1.96e-08  |g|= 6.44e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134028
diis-c [-1.02025902e-09  3.14885773e-04  4.96307111e-04 -2.10948904e-01
  1.21013771e+00]
  HOMO = -0.845593342032275  LUMO = 0.832749239903885
  mo_energy =
[-3.27697235e+01 -1.92733251e+00 -8.45593342e-01 -8.45593342e-01
 -8.45593342e-01  8.32749240e-01  1.08350011e+00  1.08350011e+00
  1.08350011e+00  4.68883255e+00  5.64957469e+00  5.64957469e+00
  5.64957469e+00  1.74289212e+01  2.38568505e+01  2.38568505e+01
  2.38568505e+01  5.52160187e+01  1.18512601e+02  1.18512601e+02
  1.18512601e+02  1.66810026e+02  5.32790353e+02  1.89851045e+03
  8.02498874e+03  4.77883765e+04]
E1 = -182.59731682848923  E_coul = 54.064845614821294
cycle= 5 E= -128.532471213668  delta_E= -5.46e-10  |g|= 6.68e-06  |ddm|= 5.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59731682848923  E_coul = 54.064845614821294
  HOMO = -0.845589699021983  LUMO = 0.832750782673596
  mo_energy =
[-3.27697156e+01 -1.92732813e+00 -8.45589699e-01 -8.45589699e-01
 -8.45589699e-01  8.32750783e-01  1.08350163e+00  1.08350163e+00
  1.08350163e+00  4.68883618e+00  5.64957910e+00  5.64957910e+00
  5.64957910e+00  1.74289270e+01  2.38568573e+01  2.38568573e+01
  2.38568573e+01  5.52160259e+01  1.18512609e+02  1.18512609e+02
  1.18512609e+02  1.66810034e+02  5.32790361e+02  1.89851045e+03
  8.02498874e+03  4.77883765e+04]
E1 = -182.59729936414246  E_coul = 54.06482815047201
Extra cycle  E= -128.53247121367  delta_E= -2.53e-12  |g|= 2.45e-06  |ddm|= 2.41e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.30548696e-01 2.44137941e+04 3.66145355e+03 8.33287599e+02
 2.35593244e+02 7.66827189e+01 1.20970080e+01 2.85578683e+01
 3.16039261e-01 2.08502117e+00 5.61486129e+00 3.65712828e+00
 1.23627380e+01 5.47792108e+01 3.28866769e-01 1.13716577e+00]
E = -128.53247121367045
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.830548696023       1
[INPUT] 0    0    [1    /1   ]  24413.7941476        1
[INPUT] 0    0    [1    /1   ]  3661.4535531         1
[INPUT] 0    0    [1    /1   ]  833.287598959        1
[INPUT] 0    0    [1    /1   ]  235.593244362        1
[INPUT] 0    0    [1    /1   ]  76.6827189433        1
[INPUT] 0    0    [1    /1   ]  12.0970079795        1
[INPUT] 0    0    [1    /1   ]  28.5578683014        1
[INPUT] 0    0    [1    /1   ]  0.316039260958       1
[INPUT] 0    0    [1    /1   ]  2.08502116931        1
[INPUT] 0    0    [1    /1   ]  5.61486128807        1
[INPUT] 1    0    [1    /1   ]  3.65712828007        1
[INPUT] 1    0    [1    /1   ]  12.3627379525        1
[INPUT] 1    0    [1    /1   ]  54.7792107623        1
[INPUT] 1    0    [1    /1   ]  0.328866769192       1
[INPUT] 1    0    [1    /1   ]  1.13716577066        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8305486960233607, 1.0]], [0, [24413.794147605695, 1.0]], [0, [3661.453553098017, 1.0]], [0, [833.2875989591358, 1.0]], [0, [235.5932443617127, 1.0]], [0, [76.68271894331635, 1.0]], [0, [12.097007979490476, 1.0]], [0, [28.557868301376516, 1.0]], [0, [0.31603926095773793, 1.0]], [0, [2.0850211693142167, 1.0]], [0, [5.614861288067611, 1.0]], [1, [3.6571282800655673, 1.0]], [1, [12.36273795252431, 1.0]], [1, [54.77921076226408, 1.0]], [1, [0.32886676919228847, 1.0]], [1, [1.1371657706557565, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8305487]
bas 1, expnt(s) = [24413.79414761]
bas 2, expnt(s) = [3661.4535531]
bas 3, expnt(s) = [833.28759896]
bas 4, expnt(s) = [235.59324436]
bas 5, expnt(s) = [76.68271894]
bas 6, expnt(s) = [12.09700798]
bas 7, expnt(s) = [28.5578683]
bas 8, expnt(s) = [0.31603926]
bas 9, expnt(s) = [2.08502117]
bas 10, expnt(s) = [5.61486129]
bas 11, expnt(s) = [3.65712828]
bas 12, expnt(s) = [12.36273795]
bas 13, expnt(s) = [54.77921076]
bas 14, expnt(s) = [0.32886677]
bas 15, expnt(s) = [1.13716577]
CPU time:       277.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.30548696e-01 2.19805649e+00 2.44137941e+04 4.93448102e+03
 3.66145355e+03 1.18920074e+03 8.33287599e+02 3.91842206e+02
 2.35593244e+02 1.51927765e+02 7.66827189e+01 6.54693685e+01
 1.20970080e+01 1.63879073e+01 2.85578683e+01 3.12111208e+01
 3.16039261e-01 1.06492936e+00 2.08502117e+00 4.38377117e+00
 5.61486129e+00 9.21550837e+00 3.65712828e+00 1.47539951e+01
 1.23627380e+01 6.76281835e+01 5.47792108e+01 4.34764531e+02
 3.28866769e-01 7.26539754e-01 1.13716577e+00 3.42581665e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998524668275977
cond(S) = 1454.2123570400875
E1 = -183.57823546076924  E_coul = 55.07848030769893
init E= -128.49975515307
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943064274854  LUMO = 0.852568132087559
  mo_energy =
[-3.25554844e+01 -1.85290526e+00 -7.73943064e-01 -7.73943064e-01
 -7.73943064e-01  8.52568132e-01  1.10914434e+00  1.10914434e+00
  1.10914434e+00  4.74878608e+00  5.73647864e+00  5.73647864e+00
  5.73647864e+00  1.75466982e+01  2.40143757e+01  2.40143757e+01
  2.40143757e+01  5.53867945e+01  1.18729119e+02  1.18729119e+02
  1.18729119e+02  1.67020856e+02  5.33034253e+02  1.89878574e+03
  8.02529094e+03  4.77886967e+04]
E1 = -182.10953373986894  E_coul = 53.58042174766639
cycle= 1 E= -128.529111992203  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461477
diis-c [-0.21296087  1.        ]
  HOMO = -0.879725808486941  LUMO = 0.823298267250272
  mo_energy =
[-3.28743864e+01 -1.96330886e+00 -8.79725808e-01 -8.79725808e-01
 -8.79725808e-01  8.23298267e-01  1.07114351e+00  1.07114351e+00
  1.07114351e+00  4.66043116e+00  5.60804704e+00  5.60804704e+00
  5.60804704e+00  1.73718842e+01  2.37797679e+01  2.37797679e+01
  2.37797679e+01  5.51320245e+01  1.18407921e+02  1.18407921e+02
  1.18407921e+02  1.66707499e+02  5.32677430e+02  1.89839227e+03
  8.02486816e+03  4.77882550e+04]
E1 = -182.84260176207877  E_coul = 54.310980257327046
cycle= 2 E= -128.531621504752  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230882
diis-c [-0.00069662  0.33237491  0.66762509]
  HOMO = -0.845333857126267  LUMO = 0.832793608645184
  mo_energy =
[-3.27692859e+01 -1.92715002e+00 -8.45333857e-01 -8.45333857e-01
 -8.45333857e-01  8.32793609e-01  1.08356126e+00  1.08356126e+00
  1.08356126e+00  4.68899233e+00  5.64980401e+00  5.64980401e+00
  5.64980401e+00  1.74292071e+01  2.38572033e+01  2.38572033e+01
  2.38572033e+01  5.52163854e+01  1.18513051e+02  1.18513051e+02
  1.18513051e+02  1.66810466e+02  5.32790896e+02  1.89851111e+03
  8.02498949e+03  4.77883773e+04]
E1 = -182.59678092587322  E_coul = 54.064309732380366
cycle= 3 E= -128.532471193493  delta_E= -0.00085  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883049
diis-c [-1.41742339e-07 -2.21739548e-03 -9.79787615e-04  1.00319718e+00]
  HOMO = -0.845560620492282  LUMO = 0.8327567005799
  mo_energy =
[-3.27696697e+01 -1.92731214e+00 -8.45560620e-01 -8.45560620e-01
 -8.45560620e-01  8.32756701e-01  1.08351376e+00  1.08351376e+00
  1.08351376e+00  4.68885677e+00  5.64961084e+00  5.64961084e+00
  5.64961084e+00  1.74289624e+01  2.38568989e+01  2.38568989e+01
  2.38568989e+01  5.52160681e+01  1.18512656e+02  1.18512656e+02
  1.18512656e+02  1.66810081e+02  5.32790415e+02  1.89851052e+03
  8.02498881e+03  4.77883765e+04]
E1 = -182.5972105321443  E_coul = 54.064739319022735
cycle= 4 E= -128.532471213122  delta_E= -1.96e-08  |g|= 6.44e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134028
diis-c [-1.02025902e-09  3.14885773e-04  4.96307111e-04 -2.10948904e-01
  1.21013771e+00]
  HOMO = -0.845593342032275  LUMO = 0.832749239903885
  mo_energy =
[-3.27697235e+01 -1.92733251e+00 -8.45593342e-01 -8.45593342e-01
 -8.45593342e-01  8.32749240e-01  1.08350011e+00  1.08350011e+00
  1.08350011e+00  4.68883255e+00  5.64957469e+00  5.64957469e+00
  5.64957469e+00  1.74289212e+01  2.38568505e+01  2.38568505e+01
  2.38568505e+01  5.52160187e+01  1.18512601e+02  1.18512601e+02
  1.18512601e+02  1.66810026e+02  5.32790353e+02  1.89851045e+03
  8.02498874e+03  4.77883765e+04]
E1 = -182.59731682848923  E_coul = 54.064845614821294
cycle= 5 E= -128.532471213668  delta_E= -5.46e-10  |g|= 6.68e-06  |ddm|= 5.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59731682848923  E_coul = 54.064845614821294
  HOMO = -0.845589699021983  LUMO = 0.832750782673596
  mo_energy =
[-3.27697156e+01 -1.92732813e+00 -8.45589699e-01 -8.45589699e-01
 -8.45589699e-01  8.32750783e-01  1.08350163e+00  1.08350163e+00
  1.08350163e+00  4.68883618e+00  5.64957910e+00  5.64957910e+00
  5.64957910e+00  1.74289270e+01  2.38568573e+01  2.38568573e+01
  2.38568573e+01  5.52160259e+01  1.18512609e+02  1.18512609e+02
  1.18512609e+02  1.66810034e+02  5.32790361e+02  1.89851045e+03
  8.02498874e+03  4.77883765e+04]
E1 = -182.59729936414246  E_coul = 54.06482815047201
Extra cycle  E= -128.53247121367  delta_E= -2.53e-12  |g|= 2.45e-06  |ddm|= 2.41e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1454.2123570400875
E1 = -182.59729936414246  E_coul = 54.06482815047201
init E= -128.53247121367
    CPU time for initialize scf      0.25 sec, wall time      0.37 sec
  HOMO = -0.845590921083608  LUMO = 0.832750518204539
  mo_energy =
[-3.27697195e+01 -1.92732930e+00 -8.45590921e-01 -8.45590921e-01
 -8.45590921e-01  8.32750518e-01  1.08350121e+00  1.08350121e+00
  1.08350121e+00  4.68883525e+00  5.64957762e+00  5.64957762e+00
  5.64957762e+00  1.74289250e+01  2.38568545e+01  2.38568545e+01
  2.38568545e+01  5.52160228e+01  1.18512605e+02  1.18512605e+02
  1.18512605e+02  1.66810030e+02  5.32790357e+02  1.89851045e+03
  8.02498874e+03  4.77883765e+04]
E1 = -182.5973087902033  E_coul = 54.064837576532355
cycle= 1 E= -128.532471213671  delta_E= -4.83e-13  |g|= 1.29e-06  |ddm|= 9.36e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5973087902033  E_coul = 54.064837576532355
  HOMO = -0.845590258545117  LUMO = 0.832750713912502
  mo_energy =
[-3.27697175e+01 -1.92732858e+00 -8.45590259e-01 -8.45590259e-01
 -8.45590259e-01  8.32750714e-01  1.08350145e+00  1.08350145e+00
  1.08350145e+00  4.68883582e+00  5.64957843e+00  5.64957843e+00
  5.64957843e+00  1.74289261e+01  2.38568560e+01  2.38568560e+01
  2.38568560e+01  5.52160245e+01  1.18512607e+02  1.18512607e+02
  1.18512607e+02  1.66810032e+02  5.32790359e+02  1.89851045e+03
  8.02498874e+03  4.77883765e+04]
E1 = -182.59730410633526  E_coul = 54.06483289266416
Extra cycle  E= -128.532471213671  delta_E= -1.71e-13  |g|= 6.37e-07  |ddm|= 4.57e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.43 sec
exp = [8.30548696e-01 2.44137941e+04 3.66145355e+03 8.33287599e+02
 2.35593244e+02 7.66827189e+01 1.20970080e+01 2.85578683e+01
 3.16039261e-01 2.08502117e+00 5.61486129e+00 3.65712828e+00
 1.23627380e+01 5.47792108e+01 3.28866769e-01 1.13716577e+00]
grad_E = [ 2.59947631e-04 -9.90646121e-10  5.24231599e-08 -1.05300110e-06
  1.14067740e-05 -4.47761784e-05  3.75769919e-05 -5.96080572e-05
 -1.36251002e-04 -8.15731556e-05  1.39981570e-05 -1.26925202e-04
 -1.20219274e-04  2.11865940e-05  8.70673441e-05  2.44333605e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.830363621705       1
[INPUT] 0    0    [1    /1   ]  24413.7941489        1
[INPUT] 0    0    [1    /1   ]  3661.45348367        1
[INPUT] 0    0    [1    /1   ]  833.288898913        1
[INPUT] 0    0    [1    /1   ]  235.580846655        1
[INPUT] 0    0    [1    /1   ]  76.7251321158        1
[INPUT] 0    0    [1    /1   ]  12.1625913369        1
[INPUT] 0    0    [1    /1   ]  28.5877201513        1
[INPUT] 0    0    [1    /1   ]  0.315600896203       1
[INPUT] 0    0    [1    /1   ]  2.08825330236        1
[INPUT] 0    0    [1    /1   ]  5.70925396589        1
[INPUT] 1    0    [1    /1   ]  3.66975847499        1
[INPUT] 1    0    [1    /1   ]  12.4036599508        1
[INPUT] 1    0    [1    /1   ]  54.7716538207        1
[INPUT] 1    0    [1    /1   ]  0.329435948891       1
[INPUT] 1    0    [1    /1   ]  1.1401945431         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8303636217045476, 1.0]], [0, [24413.794148934976, 1.0]], [0, [3661.4534836734315, 1.0]], [0, [833.2888989126253, 1.0]], [0, [235.5808466546179, 1.0]], [0, [76.72513211582309, 1.0]], [0, [12.162591336890799, 1.0]], [0, [28.587720151334665, 1.0]], [0, [0.3156008962029987, 1.0]], [0, [2.0882533023570815, 1.0]], [0, [5.709253965894367, 1.0]], [1, [3.669758474986276, 1.0]], [1, [12.403659950836278, 1.0]], [1, [54.77165382070654, 1.0]], [1, [0.3294359488908767, 1.0]], [1, [1.140194543098525, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83036362]
bas 1, expnt(s) = [24413.79414893]
bas 2, expnt(s) = [3661.45348367]
bas 3, expnt(s) = [833.28889891]
bas 4, expnt(s) = [235.58084665]
bas 5, expnt(s) = [76.72513212]
bas 6, expnt(s) = [12.16259134]
bas 7, expnt(s) = [28.58772015]
bas 8, expnt(s) = [0.3156009]
bas 9, expnt(s) = [2.0882533]
bas 10, expnt(s) = [5.70925397]
bas 11, expnt(s) = [3.66975847]
bas 12, expnt(s) = [12.40365995]
bas 13, expnt(s) = [54.77165382]
bas 14, expnt(s) = [0.32943595]
bas 15, expnt(s) = [1.14019454]
CPU time:       280.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.30363622e-01 2.19768913e+00 2.44137941e+04 4.93448102e+03
 3.66145348e+03 1.18920072e+03 8.33288899e+02 3.91842665e+02
 2.35580847e+02 1.51921769e+02 7.67251321e+01 6.54965249e+01
 1.21625913e+01 1.64544970e+01 2.85877202e+01 3.12355866e+01
 3.15600896e-01 1.06382133e+00 2.08825330e+00 4.38886687e+00
 5.70925397e+00 9.33145886e+00 3.66975847e+00 1.48177153e+01
 1.24036600e+01 6.79081199e+01 5.47716538e+01 4.34689561e+02
 3.29435949e-01 7.28111899e-01 1.14019454e+00 3.43722602e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998509064668113
cond(S) = 1476.5134196400413
E1 = -183.57822732827208  E_coul = 55.078483647538185
init E= -128.499743680734
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944000798141  LUMO = 0.852218216586454
  mo_energy =
[-3.25554785e+01 -1.85290628e+00 -7.73944001e-01 -7.73944001e-01
 -7.73944001e-01  8.52218217e-01  1.11185216e+00  1.11185216e+00
  1.11185216e+00  4.75872567e+00  5.75460276e+00  5.75460276e+00
  5.75460276e+00  1.76862783e+01  2.41059844e+01  2.41059844e+01
  2.41059844e+01  5.58171381e+01  1.18892371e+02  1.18892371e+02
  1.18892371e+02  1.67711721e+02  5.33854297e+02  1.89958620e+03
  8.02600631e+03  4.77892912e+04]
E1 = -182.1103426889055  E_coul = 53.581222903427836
cycle= 1 E= -128.529119785478  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461166
diis-c [-0.21267448  1.        ]
  HOMO = -0.879668932931603  LUMO = 0.822970357414879
  mo_energy =
[-3.28742265e+01 -1.96323992e+00 -8.79668933e-01 -8.79668933e-01
 -8.79668933e-01  8.22970357e-01  1.07376023e+00  1.07376023e+00
  1.07376023e+00  4.67006265e+00  5.62595380e+00  5.62595380e+00
  5.62595380e+00  1.75106398e+01  2.38712232e+01  2.38712232e+01
  2.38712232e+01  5.55620741e+01  1.18571338e+02  1.18571338e+02
  1.18571338e+02  1.67398464e+02  5.33497658e+02  1.89919292e+03
  8.02558372e+03  4.77888497e+04]
E1 = -182.84290653742033  E_coul = 54.311279455375846
cycle= 2 E= -128.531627082044  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230677
diis-c [-0.00069953  0.33232029  0.66767971]
  HOMO = -0.845299076990561  LUMO = 0.832460664838587
  mo_energy =
[-3.27691843e+01 -1.92710485e+00 -8.45299077e-01 -8.45299077e-01
 -8.45299077e-01  8.32460665e-01  1.08620799e+00  1.08620799e+00
  1.08620799e+00  4.69872500e+00  5.66778016e+00  5.66778016e+00
  5.66778016e+00  1.75682378e+01  2.39487025e+01  2.39487025e+01
  2.39487025e+01  5.56465269e+01  1.18676408e+02  1.18676408e+02
  1.18676408e+02  1.67501389e+02  5.33611058e+02  1.89931169e+03
  8.02570498e+03  4.77889719e+04]
E1 = -182.5972844967226  E_coul = 54.06480893549793
cycle= 3 E= -128.532475561225  delta_E= -0.000848  |g|= 0.00045  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000887453
diis-c [-1.43390422e-07 -2.22627934e-03 -9.78754209e-04  1.00320503e+00]
  HOMO = -0.845526111261601  LUMO = 0.832423914142327
  mo_energy =
[-3.27695691e+01 -1.92726681e+00 -8.45526111e-01 -8.45526111e-01
 -8.45526111e-01  8.32423914e-01  1.08616022e+00  1.08616022e+00
  1.08616022e+00  4.69858897e+00  5.66758628e+00  5.66758628e+00
  5.66758628e+00  1.75679919e+01  2.39483971e+01  2.39483971e+01
  2.39483971e+01  5.56462086e+01  1.18676011e+02  1.18676011e+02
  1.18676011e+02  1.67501002e+02  5.33610575e+02  1.89931109e+03
  8.02570430e+03  4.77889711e+04]
E1 = -182.5977179790248  E_coul = 54.065242398029156
cycle= 4 E= -128.532475580996  delta_E= -1.98e-08  |g|= 6.46e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134572
diis-c [-1.02224929e-09  3.16961807e-04  4.97123027e-04 -2.11500281e-01
  1.21068620e+00]
  HOMO = -0.845558841389898  LUMO = 0.83241651800147
  mo_energy =
[-3.27696230e+01 -1.92728706e+00 -8.45558841e-01 -8.45558841e-01
 -8.45558841e-01  8.32416518e-01  1.08614654e+00  1.08614654e+00
  1.08614654e+00  4.69856474e+00  5.66755008e+00  5.66755008e+00
  5.66755008e+00  1.75679505e+01  2.39483487e+01  2.39483487e+01
  2.39483487e+01  5.56461591e+01  1.18675957e+02  1.18675957e+02
  1.18675957e+02  1.67500948e+02  5.33610514e+02  1.89931102e+03
  8.02570422e+03  4.77889711e+04]
E1 = -182.597824595117  E_coul = 54.06534901356889
cycle= 5 E= -128.532475581548  delta_E= -5.52e-10  |g|= 6.69e-06  |ddm|= 5.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.597824595117  E_coul = 54.06534901356889
  HOMO = -0.845555191857345  LUMO = 0.832418063217163
  mo_energy =
[-3.27696150e+01 -1.92728268e+00 -8.45555192e-01 -8.45555192e-01
 -8.45555192e-01  8.32418063e-01  1.08614807e+00  1.08614807e+00
  1.08614807e+00  4.69856839e+00  5.66755451e+00  5.66755451e+00
  5.66755451e+00  1.75679564e+01  2.39483555e+01  2.39483555e+01
  2.39483555e+01  5.56461663e+01  1.18675964e+02  1.18675964e+02
  1.18675964e+02  1.67500956e+02  5.33610521e+02  1.89931103e+03
  8.02570423e+03  4.77889711e+04]
E1 = -182.5978071072352  E_coul = 54.06533152568448
Extra cycle  E= -128.532475581551  delta_E= -2.61e-12  |g|= 2.45e-06  |ddm|= 2.41e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.30363622e-01 2.44137941e+04 3.66145348e+03 8.33288899e+02
 2.35580847e+02 7.67251321e+01 1.21625913e+01 2.85877202e+01
 3.15600896e-01 2.08825330e+00 5.70925397e+00 3.66975847e+00
 1.24036600e+01 5.47716538e+01 3.29435949e-01 1.14019454e+00]
E = -128.53247558155073
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:01:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.830363621705       1
[INPUT] 0    0    [1    /1   ]  24413.7941489        1
[INPUT] 0    0    [1    /1   ]  3661.45348367        1
[INPUT] 0    0    [1    /1   ]  833.288898913        1
[INPUT] 0    0    [1    /1   ]  235.580846655        1
[INPUT] 0    0    [1    /1   ]  76.7251321158        1
[INPUT] 0    0    [1    /1   ]  12.1625913369        1
[INPUT] 0    0    [1    /1   ]  28.5877201513        1
[INPUT] 0    0    [1    /1   ]  0.315600896203       1
[INPUT] 0    0    [1    /1   ]  2.08825330236        1
[INPUT] 0    0    [1    /1   ]  5.70925396589        1
[INPUT] 1    0    [1    /1   ]  3.66975847499        1
[INPUT] 1    0    [1    /1   ]  12.4036599508        1
[INPUT] 1    0    [1    /1   ]  54.7716538207        1
[INPUT] 1    0    [1    /1   ]  0.329435948891       1
[INPUT] 1    0    [1    /1   ]  1.1401945431         1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8303636217045476, 1.0]], [0, [24413.794148934976, 1.0]], [0, [3661.4534836734315, 1.0]], [0, [833.2888989126253, 1.0]], [0, [235.5808466546179, 1.0]], [0, [76.72513211582309, 1.0]], [0, [12.162591336890799, 1.0]], [0, [28.587720151334665, 1.0]], [0, [0.3156008962029987, 1.0]], [0, [2.0882533023570815, 1.0]], [0, [5.709253965894367, 1.0]], [1, [3.669758474986276, 1.0]], [1, [12.403659950836278, 1.0]], [1, [54.77165382070654, 1.0]], [1, [0.3294359488908767, 1.0]], [1, [1.140194543098525, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83036362]
bas 1, expnt(s) = [24413.79414893]
bas 2, expnt(s) = [3661.45348367]
bas 3, expnt(s) = [833.28889891]
bas 4, expnt(s) = [235.58084665]
bas 5, expnt(s) = [76.72513212]
bas 6, expnt(s) = [12.16259134]
bas 7, expnt(s) = [28.58772015]
bas 8, expnt(s) = [0.3156009]
bas 9, expnt(s) = [2.0882533]
bas 10, expnt(s) = [5.70925397]
bas 11, expnt(s) = [3.66975847]
bas 12, expnt(s) = [12.40365995]
bas 13, expnt(s) = [54.77165382]
bas 14, expnt(s) = [0.32943595]
bas 15, expnt(s) = [1.14019454]
CPU time:       281.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.30363622e-01 2.19768913e+00 2.44137941e+04 4.93448102e+03
 3.66145348e+03 1.18920072e+03 8.33288899e+02 3.91842665e+02
 2.35580847e+02 1.51921769e+02 7.67251321e+01 6.54965249e+01
 1.21625913e+01 1.64544970e+01 2.85877202e+01 3.12355866e+01
 3.15600896e-01 1.06382133e+00 2.08825330e+00 4.38886687e+00
 5.70925397e+00 9.33145886e+00 3.66975847e+00 1.48177153e+01
 1.24036600e+01 6.79081199e+01 5.47716538e+01 4.34689561e+02
 3.29435949e-01 7.28111899e-01 1.14019454e+00 3.43722602e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998509064668113
cond(S) = 1476.5134196400413
E1 = -183.57822732827208  E_coul = 55.078483647538185
init E= -128.499743680734
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944000798141  LUMO = 0.852218216586454
  mo_energy =
[-3.25554785e+01 -1.85290628e+00 -7.73944001e-01 -7.73944001e-01
 -7.73944001e-01  8.52218217e-01  1.11185216e+00  1.11185216e+00
  1.11185216e+00  4.75872567e+00  5.75460276e+00  5.75460276e+00
  5.75460276e+00  1.76862783e+01  2.41059844e+01  2.41059844e+01
  2.41059844e+01  5.58171381e+01  1.18892371e+02  1.18892371e+02
  1.18892371e+02  1.67711721e+02  5.33854297e+02  1.89958620e+03
  8.02600631e+03  4.77892912e+04]
E1 = -182.1103426889055  E_coul = 53.581222903427836
cycle= 1 E= -128.529119785478  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461166
diis-c [-0.21267448  1.        ]
  HOMO = -0.879668932931603  LUMO = 0.822970357414879
  mo_energy =
[-3.28742265e+01 -1.96323992e+00 -8.79668933e-01 -8.79668933e-01
 -8.79668933e-01  8.22970357e-01  1.07376023e+00  1.07376023e+00
  1.07376023e+00  4.67006265e+00  5.62595380e+00  5.62595380e+00
  5.62595380e+00  1.75106398e+01  2.38712232e+01  2.38712232e+01
  2.38712232e+01  5.55620741e+01  1.18571338e+02  1.18571338e+02
  1.18571338e+02  1.67398464e+02  5.33497658e+02  1.89919292e+03
  8.02558372e+03  4.77888497e+04]
E1 = -182.84290653742033  E_coul = 54.311279455375846
cycle= 2 E= -128.531627082044  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230677
diis-c [-0.00069953  0.33232029  0.66767971]
  HOMO = -0.845299076990561  LUMO = 0.832460664838587
  mo_energy =
[-3.27691843e+01 -1.92710485e+00 -8.45299077e-01 -8.45299077e-01
 -8.45299077e-01  8.32460665e-01  1.08620799e+00  1.08620799e+00
  1.08620799e+00  4.69872500e+00  5.66778016e+00  5.66778016e+00
  5.66778016e+00  1.75682378e+01  2.39487025e+01  2.39487025e+01
  2.39487025e+01  5.56465269e+01  1.18676408e+02  1.18676408e+02
  1.18676408e+02  1.67501389e+02  5.33611058e+02  1.89931169e+03
  8.02570498e+03  4.77889719e+04]
E1 = -182.5972844967226  E_coul = 54.06480893549793
cycle= 3 E= -128.532475561225  delta_E= -0.000848  |g|= 0.00045  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000887453
diis-c [-1.43390422e-07 -2.22627934e-03 -9.78754209e-04  1.00320503e+00]
  HOMO = -0.845526111261601  LUMO = 0.832423914142327
  mo_energy =
[-3.27695691e+01 -1.92726681e+00 -8.45526111e-01 -8.45526111e-01
 -8.45526111e-01  8.32423914e-01  1.08616022e+00  1.08616022e+00
  1.08616022e+00  4.69858897e+00  5.66758628e+00  5.66758628e+00
  5.66758628e+00  1.75679919e+01  2.39483971e+01  2.39483971e+01
  2.39483971e+01  5.56462086e+01  1.18676011e+02  1.18676011e+02
  1.18676011e+02  1.67501002e+02  5.33610575e+02  1.89931109e+03
  8.02570430e+03  4.77889711e+04]
E1 = -182.5977179790248  E_coul = 54.065242398029156
cycle= 4 E= -128.532475580996  delta_E= -1.98e-08  |g|= 6.46e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134572
diis-c [-1.02224929e-09  3.16961807e-04  4.97123027e-04 -2.11500281e-01
  1.21068620e+00]
  HOMO = -0.845558841389898  LUMO = 0.83241651800147
  mo_energy =
[-3.27696230e+01 -1.92728706e+00 -8.45558841e-01 -8.45558841e-01
 -8.45558841e-01  8.32416518e-01  1.08614654e+00  1.08614654e+00
  1.08614654e+00  4.69856474e+00  5.66755008e+00  5.66755008e+00
  5.66755008e+00  1.75679505e+01  2.39483487e+01  2.39483487e+01
  2.39483487e+01  5.56461591e+01  1.18675957e+02  1.18675957e+02
  1.18675957e+02  1.67500948e+02  5.33610514e+02  1.89931102e+03
  8.02570422e+03  4.77889711e+04]
E1 = -182.597824595117  E_coul = 54.06534901356889
cycle= 5 E= -128.532475581548  delta_E= -5.52e-10  |g|= 6.69e-06  |ddm|= 5.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.597824595117  E_coul = 54.06534901356889
  HOMO = -0.845555191857345  LUMO = 0.832418063217163
  mo_energy =
[-3.27696150e+01 -1.92728268e+00 -8.45555192e-01 -8.45555192e-01
 -8.45555192e-01  8.32418063e-01  1.08614807e+00  1.08614807e+00
  1.08614807e+00  4.69856839e+00  5.66755451e+00  5.66755451e+00
  5.66755451e+00  1.75679564e+01  2.39483555e+01  2.39483555e+01
  2.39483555e+01  5.56461663e+01  1.18675964e+02  1.18675964e+02
  1.18675964e+02  1.67500956e+02  5.33610521e+02  1.89931103e+03
  8.02570423e+03  4.77889711e+04]
E1 = -182.5978071072352  E_coul = 54.06533152568448
Extra cycle  E= -128.532475581551  delta_E= -2.61e-12  |g|= 2.45e-06  |ddm|= 2.41e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1476.5134196400413
E1 = -182.5978071072352  E_coul = 54.06533152568448
init E= -128.532475581551
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.845556415488234  LUMO = 0.832417798239461
  mo_energy =
[-3.27696189e+01 -1.92728385e+00 -8.45556415e-01 -8.45556415e-01
 -8.45556415e-01  8.32417798e-01  1.08614764e+00  1.08614764e+00
  1.08614764e+00  4.69856746e+00  5.66755303e+00  5.66755303e+00
  5.66755303e+00  1.75679544e+01  2.39483527e+01  2.39483527e+01
  2.39483527e+01  5.56461632e+01  1.18675960e+02  1.18675960e+02
  1.18675960e+02  1.67500952e+02  5.33610517e+02  1.89931103e+03
  8.02570423e+03  4.77889711e+04]
E1 = -182.59781654292942  E_coul = 54.06534096137817
cycle= 1 E= -128.532475581551  delta_E= -5.12e-13  |g|= 1.29e-06  |ddm|= 9.38e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59781654292942  E_coul = 54.06534096137817
  HOMO = -0.845555752295066  LUMO = 0.83241799412321
  mo_energy =
[-3.27696169e+01 -1.92728313e+00 -8.45555752e-01 -8.45555752e-01
 -8.45555752e-01  8.32417994e-01  1.08614789e+00  1.08614789e+00
  1.08614789e+00  4.69856803e+00  5.66755384e+00  5.66755384e+00
  5.66755384e+00  1.75679555e+01  2.39483541e+01  2.39483541e+01
  2.39483541e+01  5.56461648e+01  1.18675962e+02  1.18675962e+02
  1.18675962e+02  1.67500954e+02  5.33610519e+02  1.89931103e+03
  8.02570423e+03  4.77889711e+04]
E1 = -182.59781185495066  E_coul = 54.06533627339959
Extra cycle  E= -128.532475581551  delta_E= 1.71e-13  |g|= 6.38e-07  |ddm|= 4.58e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [8.30363622e-01 2.44137941e+04 3.66145348e+03 8.33288899e+02
 2.35580847e+02 7.67251321e+01 1.21625913e+01 2.85877202e+01
 3.15600896e-01 2.08825330e+00 5.70925397e+00 3.66975847e+00
 1.24036600e+01 5.47716538e+01 3.29435949e-01 1.14019454e+00]
grad_E = [ 2.44925830e-04 -8.52872781e-10  4.53037720e-08 -9.23365133e-07
  1.02354158e-05 -4.01653953e-05  3.97085015e-05 -6.64428088e-05
 -1.71656436e-04 -7.80926511e-05  1.75136294e-05 -6.95228735e-05
 -5.56798673e-05  1.03508314e-05  8.08448629e-05  1.32002759e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823337276351       1
[INPUT] 0    0    [1    /1   ]  24413.7941488        1
[INPUT] 0    0    [1    /1   ]  3661.45348841        1
[INPUT] 0    0    [1    /1   ]  833.288830695        1
[INPUT] 0    0    [1    /1   ]  235.58101451         1
[INPUT] 0    0    [1    /1   ]  76.7301036595        1
[INPUT] 0    0    [1    /1   ]  12.1120635237        1
[INPUT] 0    0    [1    /1   ]  28.5675296606        1
[INPUT] 0    0    [1    /1   ]  0.313226093874       1
[INPUT] 0    0    [1    /1   ]  2.07732927943        1
[INPUT] 0    0    [1    /1   ]  5.65765795997        1
[INPUT] 1    0    [1    /1   ]  3.68014893785        1
[INPUT] 1    0    [1    /1   ]  12.4373083082        1
[INPUT] 1    0    [1    /1   ]  54.7664169241        1
[INPUT] 1    0    [1    /1   ]  0.329882411353       1
[INPUT] 1    0    [1    /1   ]  1.14265224103        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8233372763507961, 1.0]], [0, [24413.794148841822, 1.0]], [0, [3661.453488410296, 1.0]], [0, [833.2888306953589, 1.0]], [0, [235.58101451035273, 1.0]], [0, [76.73010365947401, 1.0]], [0, [12.11206352366266, 1.0]], [0, [28.56752966056232, 1.0]], [0, [0.31322609387417033, 1.0]], [0, [2.077329279427429, 1.0]], [0, [5.657657959973152, 1.0]], [1, [3.6801489378457313, 1.0]], [1, [12.43730830817581, 1.0]], [1, [54.76641692410883, 1.0]], [1, [0.3298824113534737, 1.0]], [1, [1.1426522410278646, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82333728]
bas 1, expnt(s) = [24413.79414884]
bas 2, expnt(s) = [3661.45348841]
bas 3, expnt(s) = [833.2888307]
bas 4, expnt(s) = [235.58101451]
bas 5, expnt(s) = [76.73010366]
bas 6, expnt(s) = [12.11206352]
bas 7, expnt(s) = [28.56752966]
bas 8, expnt(s) = [0.31322609]
bas 9, expnt(s) = [2.07732928]
bas 10, expnt(s) = [5.65765796]
bas 11, expnt(s) = [3.68014894]
bas 12, expnt(s) = [12.43730831]
bas 13, expnt(s) = [54.76641692]
bas 14, expnt(s) = [0.32988241]
bas 15, expnt(s) = [1.14265224]
CPU time:       284.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23337276e-01 2.18372707e+00 2.44137941e+04 4.93448102e+03
 3.66145349e+03 1.18920073e+03 8.33288831e+02 3.91842641e+02
 2.35581015e+02 1.51921850e+02 7.67301037e+01 6.54997079e+01
 1.21120635e+01 1.64032019e+01 2.85675297e+01 3.12190397e+01
 3.13226094e-01 1.05781197e+00 2.07732928e+00 4.37163638e+00
 5.65765796e+00 9.26813904e+00 3.68014894e+00 1.48701770e+01
 1.24373083e+01 6.81384724e+01 5.47664169e+01 4.34637609e+02
 3.29882411e-01 7.29345559e-01 1.14265224e+00 3.44648972e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998496878226621
cond(S) = 1449.3422458898535
E1 = -183.57823715886622  E_coul = 55.07848526793746
init E= -128.499751890929
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77394463640908  LUMO = 0.842978162236527
  mo_energy =
[-3.25554737e+01 -1.85290833e+00 -7.73944636e-01 -7.73944636e-01
 -7.73944636e-01  8.42978162e-01  1.11400391e+00  1.11400391e+00
  1.11400391e+00  4.71423802e+00  5.76935100e+00  5.76935100e+00
  5.76935100e+00  1.75367557e+01  2.41811731e+01  2.41811731e+01
  2.41811731e+01  5.54770129e+01  1.19028033e+02  1.19028033e+02
  1.19028033e+02  1.67220209e+02  5.33333441e+02  1.89910248e+03
  8.02557744e+03  4.77889354e+04]
E1 = -182.110922226857  E_coul = 53.58179674782171
cycle= 1 E= -128.529125479035  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461123
diis-c [-0.2126344  1.       ]
  HOMO = -0.879628952871448  LUMO = 0.814074628190168
  mo_energy =
[-3.28741092e+01 -1.96319116e+00 -8.79628953e-01 -8.79628953e-01
 -8.79628953e-01  8.14074628e-01  1.07583696e+00  1.07583696e+00
  1.07583696e+00  4.62616860e+00  5.64051518e+00  5.64051518e+00
  5.64051518e+00  1.73617749e+01  2.39462745e+01  2.39462745e+01
  2.39462745e+01  5.52222757e+01  1.18707120e+02  1.18707120e+02
  1.18707120e+02  1.66907077e+02  5.32976917e+02  1.89870934e+03
  8.02515498e+03  4.77884941e+04]
E1 = -182.84313134993565  E_coul = 54.311500132119846
cycle= 2 E= -128.531631217816  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230612
diis-c [-0.00069873  0.33227877  0.66772123]
  HOMO = -0.845274448716053  LUMO = 0.823457149650048
  mo_energy =
[-3.27691074e+01 -1.92707283e+00 -8.45274449e-01 -8.45274449e-01
 -8.45274449e-01  8.23457150e-01  1.08830978e+00  1.08830978e+00
  1.08830978e+00  4.65463716e+00  5.68240156e+00  5.68240156e+00
  5.68240156e+00  1.74191494e+01  2.40237952e+01  2.40237952e+01
  2.40237952e+01  5.53066154e+01  1.18812148e+02  1.18812148e+02
  1.18812148e+02  1.67009958e+02  5.33090278e+02  1.89882806e+03
  8.02527619e+03  4.77886162e+04]
E1 = -182.59764988534812  E_coul = 54.065171044527254
cycle= 3 E= -128.532478840821  delta_E= -0.000848  |g|= 0.000451  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000891727
diis-c [-1.46134655e-07 -2.23378244e-03 -9.80439365e-04  1.00321422e+00]
  HOMO = -0.845501771490146  LUMO = 0.823420984612655
  mo_energy =
[-3.27694934e+01 -1.92723467e+00 -8.45501771e-01 -8.45501771e-01
 -8.45501771e-01  8.23420985e-01  1.08826176e+00  1.08826176e+00
  1.08826176e+00  4.65450196e+00  5.68220702e+00  5.68220702e+00
  5.68220702e+00  1.74189037e+01  2.40234889e+01  2.40234889e+01
  2.40234889e+01  5.53062965e+01  1.18811750e+02  1.18811750e+02
  1.18811750e+02  1.67009570e+02  5.33089793e+02  1.89882747e+03
  8.02527551e+03  4.77886155e+04]
E1 = -182.5980871730747  E_coul = 54.06560831231769
cycle= 4 E= -128.532478860757  delta_E= -1.99e-08  |g|= 6.47e-05  |ddm|= 0.000302
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134835
diis-c [-1.02673773e-09  3.19657982e-04  4.95851163e-04 -2.12445155e-01
  1.21162965e+00]
  HOMO = -0.845534485250735  LUMO = 0.823413732832489
  mo_energy =
[-3.27695472e+01 -1.92725478e+00 -8.45534485e-01 -8.45534485e-01
 -8.45534485e-01  8.23413733e-01  1.08824806e+00  1.08824806e+00
  1.08824806e+00  4.65447795e+00  5.68217082e+00  5.68217082e+00
  5.68217082e+00  1.74188626e+01  2.40234405e+01  2.40234405e+01
  2.40234405e+01  5.53062470e+01  1.18811696e+02  1.18811696e+02
  1.18811696e+02  1.67009516e+02  5.33089731e+02  1.89882740e+03
  8.02527544e+03  4.77886154e+04]
E1 = -182.598193656305  E_coul = 54.065714794990605
cycle= 5 E= -128.532478861314  delta_E= -5.57e-10  |g|= 6.72e-06  |ddm|= 5.24e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.598193656305  E_coul = 54.065714794990605
  HOMO = -0.845530813901075  LUMO = 0.823415269060897
  mo_energy =
[-3.27695392e+01 -1.92725037e+00 -8.45530814e-01 -8.45530814e-01
 -8.45530814e-01  8.23415269e-01  1.08824960e+00  1.08824960e+00
  1.08824960e+00  4.65448160e+00  5.68217528e+00  5.68217528e+00
  5.68217528e+00  1.74188685e+01  2.40234474e+01  2.40234474e+01
  2.40234474e+01  5.53062543e+01  1.18811704e+02  1.18811704e+02
  1.18811704e+02  1.67009524e+02  5.33089739e+02  1.89882740e+03
  8.02527544e+03  4.77886154e+04]
E1 = -182.59817605150334  E_coul = 54.065697190185944
Extra cycle  E= -128.532478861317  delta_E= -3.01e-12  |g|= 2.46e-06  |ddm|= 2.43e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.23337276e-01 2.44137941e+04 3.66145349e+03 8.33288831e+02
 2.35581015e+02 7.67301037e+01 1.21120635e+01 2.85675297e+01
 3.13226094e-01 2.07732928e+00 5.65765796e+00 3.68014894e+00
 1.24373083e+01 5.47664169e+01 3.29882411e-01 1.14265224e+00]
E = -128.5324788613174
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823337276351       1
[INPUT] 0    0    [1    /1   ]  24413.7941488        1
[INPUT] 0    0    [1    /1   ]  3661.45348841        1
[INPUT] 0    0    [1    /1   ]  833.288830695        1
[INPUT] 0    0    [1    /1   ]  235.58101451         1
[INPUT] 0    0    [1    /1   ]  76.7301036595        1
[INPUT] 0    0    [1    /1   ]  12.1120635237        1
[INPUT] 0    0    [1    /1   ]  28.5675296606        1
[INPUT] 0    0    [1    /1   ]  0.313226093874       1
[INPUT] 0    0    [1    /1   ]  2.07732927943        1
[INPUT] 0    0    [1    /1   ]  5.65765795997        1
[INPUT] 1    0    [1    /1   ]  3.68014893785        1
[INPUT] 1    0    [1    /1   ]  12.4373083082        1
[INPUT] 1    0    [1    /1   ]  54.7664169241        1
[INPUT] 1    0    [1    /1   ]  0.329882411353       1
[INPUT] 1    0    [1    /1   ]  1.14265224103        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8233372763507961, 1.0]], [0, [24413.794148841822, 1.0]], [0, [3661.453488410296, 1.0]], [0, [833.2888306953589, 1.0]], [0, [235.58101451035273, 1.0]], [0, [76.73010365947401, 1.0]], [0, [12.11206352366266, 1.0]], [0, [28.56752966056232, 1.0]], [0, [0.31322609387417033, 1.0]], [0, [2.077329279427429, 1.0]], [0, [5.657657959973152, 1.0]], [1, [3.6801489378457313, 1.0]], [1, [12.43730830817581, 1.0]], [1, [54.76641692410883, 1.0]], [1, [0.3298824113534737, 1.0]], [1, [1.1426522410278646, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82333728]
bas 1, expnt(s) = [24413.79414884]
bas 2, expnt(s) = [3661.45348841]
bas 3, expnt(s) = [833.2888307]
bas 4, expnt(s) = [235.58101451]
bas 5, expnt(s) = [76.73010366]
bas 6, expnt(s) = [12.11206352]
bas 7, expnt(s) = [28.56752966]
bas 8, expnt(s) = [0.31322609]
bas 9, expnt(s) = [2.07732928]
bas 10, expnt(s) = [5.65765796]
bas 11, expnt(s) = [3.68014894]
bas 12, expnt(s) = [12.43730831]
bas 13, expnt(s) = [54.76641692]
bas 14, expnt(s) = [0.32988241]
bas 15, expnt(s) = [1.14265224]
CPU time:       285.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23337276e-01 2.18372707e+00 2.44137941e+04 4.93448102e+03
 3.66145349e+03 1.18920073e+03 8.33288831e+02 3.91842641e+02
 2.35581015e+02 1.51921850e+02 7.67301037e+01 6.54997079e+01
 1.21120635e+01 1.64032019e+01 2.85675297e+01 3.12190397e+01
 3.13226094e-01 1.05781197e+00 2.07732928e+00 4.37163638e+00
 5.65765796e+00 9.26813904e+00 3.68014894e+00 1.48701770e+01
 1.24373083e+01 6.81384724e+01 5.47664169e+01 4.34637609e+02
 3.29882411e-01 7.29345559e-01 1.14265224e+00 3.44648972e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998496878226621
cond(S) = 1449.3422458898535
E1 = -183.57823715886622  E_coul = 55.07848526793746
init E= -128.499751890929
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77394463640908  LUMO = 0.842978162236527
  mo_energy =
[-3.25554737e+01 -1.85290833e+00 -7.73944636e-01 -7.73944636e-01
 -7.73944636e-01  8.42978162e-01  1.11400391e+00  1.11400391e+00
  1.11400391e+00  4.71423802e+00  5.76935100e+00  5.76935100e+00
  5.76935100e+00  1.75367557e+01  2.41811731e+01  2.41811731e+01
  2.41811731e+01  5.54770129e+01  1.19028033e+02  1.19028033e+02
  1.19028033e+02  1.67220209e+02  5.33333441e+02  1.89910248e+03
  8.02557744e+03  4.77889354e+04]
E1 = -182.110922226857  E_coul = 53.58179674782171
cycle= 1 E= -128.529125479035  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.461123
diis-c [-0.2126344  1.       ]
  HOMO = -0.879628952871448  LUMO = 0.814074628190168
  mo_energy =
[-3.28741092e+01 -1.96319116e+00 -8.79628953e-01 -8.79628953e-01
 -8.79628953e-01  8.14074628e-01  1.07583696e+00  1.07583696e+00
  1.07583696e+00  4.62616860e+00  5.64051518e+00  5.64051518e+00
  5.64051518e+00  1.73617749e+01  2.39462745e+01  2.39462745e+01
  2.39462745e+01  5.52222757e+01  1.18707120e+02  1.18707120e+02
  1.18707120e+02  1.66907077e+02  5.32976917e+02  1.89870934e+03
  8.02515498e+03  4.77884941e+04]
E1 = -182.84313134993565  E_coul = 54.311500132119846
cycle= 2 E= -128.531631217816  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.230612
diis-c [-0.00069873  0.33227877  0.66772123]
  HOMO = -0.845274448716053  LUMO = 0.823457149650048
  mo_energy =
[-3.27691074e+01 -1.92707283e+00 -8.45274449e-01 -8.45274449e-01
 -8.45274449e-01  8.23457150e-01  1.08830978e+00  1.08830978e+00
  1.08830978e+00  4.65463716e+00  5.68240156e+00  5.68240156e+00
  5.68240156e+00  1.74191494e+01  2.40237952e+01  2.40237952e+01
  2.40237952e+01  5.53066154e+01  1.18812148e+02  1.18812148e+02
  1.18812148e+02  1.67009958e+02  5.33090278e+02  1.89882806e+03
  8.02527619e+03  4.77886162e+04]
E1 = -182.59764988534812  E_coul = 54.065171044527254
cycle= 3 E= -128.532478840821  delta_E= -0.000848  |g|= 0.000451  |ddm|= 0.0237
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000891727
diis-c [-1.46134655e-07 -2.23378244e-03 -9.80439365e-04  1.00321422e+00]
  HOMO = -0.845501771490146  LUMO = 0.823420984612655
  mo_energy =
[-3.27694934e+01 -1.92723467e+00 -8.45501771e-01 -8.45501771e-01
 -8.45501771e-01  8.23420985e-01  1.08826176e+00  1.08826176e+00
  1.08826176e+00  4.65450196e+00  5.68220702e+00  5.68220702e+00
  5.68220702e+00  1.74189037e+01  2.40234889e+01  2.40234889e+01
  2.40234889e+01  5.53062965e+01  1.18811750e+02  1.18811750e+02
  1.18811750e+02  1.67009570e+02  5.33089793e+02  1.89882747e+03
  8.02527551e+03  4.77886155e+04]
E1 = -182.5980871730747  E_coul = 54.06560831231769
cycle= 4 E= -128.532478860757  delta_E= -1.99e-08  |g|= 6.47e-05  |ddm|= 0.000302
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000134835
diis-c [-1.02673773e-09  3.19657982e-04  4.95851163e-04 -2.12445155e-01
  1.21162965e+00]
  HOMO = -0.845534485250735  LUMO = 0.823413732832489
  mo_energy =
[-3.27695472e+01 -1.92725478e+00 -8.45534485e-01 -8.45534485e-01
 -8.45534485e-01  8.23413733e-01  1.08824806e+00  1.08824806e+00
  1.08824806e+00  4.65447795e+00  5.68217082e+00  5.68217082e+00
  5.68217082e+00  1.74188626e+01  2.40234405e+01  2.40234405e+01
  2.40234405e+01  5.53062470e+01  1.18811696e+02  1.18811696e+02
  1.18811696e+02  1.67009516e+02  5.33089731e+02  1.89882740e+03
  8.02527544e+03  4.77886154e+04]
E1 = -182.598193656305  E_coul = 54.065714794990605
cycle= 5 E= -128.532478861314  delta_E= -5.57e-10  |g|= 6.72e-06  |ddm|= 5.24e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.598193656305  E_coul = 54.065714794990605
  HOMO = -0.845530813901075  LUMO = 0.823415269060897
  mo_energy =
[-3.27695392e+01 -1.92725037e+00 -8.45530814e-01 -8.45530814e-01
 -8.45530814e-01  8.23415269e-01  1.08824960e+00  1.08824960e+00
  1.08824960e+00  4.65448160e+00  5.68217528e+00  5.68217528e+00
  5.68217528e+00  1.74188685e+01  2.40234474e+01  2.40234474e+01
  2.40234474e+01  5.53062543e+01  1.18811704e+02  1.18811704e+02
  1.18811704e+02  1.67009524e+02  5.33089739e+02  1.89882740e+03
  8.02527544e+03  4.77886154e+04]
E1 = -182.59817605150334  E_coul = 54.065697190185944
Extra cycle  E= -128.532478861317  delta_E= -3.01e-12  |g|= 2.46e-06  |ddm|= 2.43e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1449.3422458898535
E1 = -182.59817605150334  E_coul = 54.065697190185944
init E= -128.532478861317
    CPU time for initialize scf      0.27 sec, wall time      0.30 sec
  HOMO = -0.845532045536335  LUMO = 0.823415004869565
  mo_energy =
[-3.27695431e+01 -1.92725155e+00 -8.45532046e-01 -8.45532046e-01
 -8.45532046e-01  8.23415005e-01  1.08824917e+00  1.08824917e+00
  1.08824917e+00  4.65448067e+00  5.68217378e+00  5.68217378e+00
  5.68217378e+00  1.74188664e+01  2.40234445e+01  2.40234445e+01
  2.40234445e+01  5.53062512e+01  1.18811700e+02  1.18811700e+02
  1.18811700e+02  1.67009520e+02  5.33089735e+02  1.89882740e+03
  8.02527544e+03  4.77886154e+04]
E1 = -182.5981855455379  E_coul = 54.065706684220004
cycle= 1 E= -128.532478861318  delta_E= -4.83e-13  |g|= 1.3e-06  |ddm|= 9.44e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5981855455379  E_coul = 54.065706684220004
  HOMO = -0.845531378217966  LUMO = 0.823415199720907
  mo_energy =
[-3.27695411e+01 -1.92725082e+00 -8.45531378e-01 -8.45531378e-01
 -8.45531378e-01  8.23415200e-01  1.08824941e+00  1.08824941e+00
  1.08824941e+00  4.65448124e+00  5.68217460e+00  5.68217460e+00
  5.68217460e+00  1.74188675e+01  2.40234460e+01  2.40234460e+01
  2.40234460e+01  5.53062528e+01  1.18811702e+02  1.18811702e+02
  1.18811702e+02  1.67009522e+02  5.33089737e+02  1.89882740e+03
  8.02527544e+03  4.77886154e+04]
E1 = -182.59818082878743  E_coul = 54.06570196746951
Extra cycle  E= -128.532478861318  delta_E= -5.68e-14  |g|= 6.42e-07  |ddm|= 4.61e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.37 sec
exp = [8.23337276e-01 2.44137941e+04 3.66145349e+03 8.33288831e+02
 2.35581015e+02 7.67301037e+01 1.21120635e+01 2.85675297e+01
 3.13226094e-01 2.07732928e+00 5.65765796e+00 3.68014894e+00
 1.24373083e+01 5.47664169e+01 3.29882411e-01 1.14265224e+00]
grad_E = [ 1.31323945e-04 -8.41563786e-10  4.47248302e-08 -9.13585816e-07
  1.01862820e-05 -4.07232939e-05  3.20069560e-05 -6.22696367e-05
 -1.17164039e-04 -4.35399627e-05  2.08616351e-05 -1.68196588e-05
 -5.11377735e-06  1.66432379e-06  1.39812866e-05  4.52179375e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.81116570515        1
[INPUT] 0    0    [1    /1   ]  24413.7941474        1
[INPUT] 0    0    [1    /1   ]  3661.45356241        1
[INPUT] 0    0    [1    /1   ]  833.287488009        1
[INPUT] 0    0    [1    /1   ]  235.592777288        1
[INPUT] 0    0    [1    /1   ]  76.7026451356        1
[INPUT] 0    0    [1    /1   ]  11.9378035869        1
[INPUT] 0    0    [1    /1   ]  28.4889820076        1
[INPUT] 0    0    [1    /1   ]  0.309696279393       1
[INPUT] 0    0    [1    /1   ]  2.05108577489        1
[INPUT] 0    0    [1    /1   ]  5.45981582353        1
[INPUT] 1    0    [1    /1   ]  3.68730167457        1
[INPUT] 1    0    [1    /1   ]  12.4603575863        1
[INPUT] 1    0    [1    /1   ]  54.7640625804        1
[INPUT] 1    0    [1    /1   ]  0.330190603419       1
[INPUT] 1    0    [1    /1   ]  1.14436290507        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8111657051497988, 1.0]], [0, [24413.794147419965, 1.0]], [0, [3661.4535624149185, 1.0]], [0, [833.2874880087012, 1.0]], [0, [235.5927772881163, 1.0]], [0, [76.70264513556012, 1.0]], [0, [11.937803586876036, 1.0]], [0, [28.4889820076219, 1.0]], [0, [0.3096962793925956, 1.0]], [0, [2.051085774886386, 1.0]], [0, [5.4598158235274665, 1.0]], [1, [3.687301674574244, 1.0]], [1, [12.460357586282955, 1.0]], [1, [54.76406258039592, 1.0]], [1, [0.33019060341914325, 1.0]], [1, [1.1443629050721407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81116571]
bas 1, expnt(s) = [24413.79414742]
bas 2, expnt(s) = [3661.45356241]
bas 3, expnt(s) = [833.28748801]
bas 4, expnt(s) = [235.59277729]
bas 5, expnt(s) = [76.70264514]
bas 6, expnt(s) = [11.93780359]
bas 7, expnt(s) = [28.48898201]
bas 8, expnt(s) = [0.30969628]
bas 9, expnt(s) = [2.05108577]
bas 10, expnt(s) = [5.45981582]
bas 11, expnt(s) = [3.68730167]
bas 12, expnt(s) = [12.46035759]
bas 13, expnt(s) = [54.76406258]
bas 14, expnt(s) = [0.3301906]
bas 15, expnt(s) = [1.14436291]
CPU time:       289.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.11165705e-01 2.15947017e+00 2.44137941e+04 4.93448102e+03
 3.66145356e+03 1.18920074e+03 8.33287488e+02 3.91842167e+02
 2.35592777e+02 1.51927539e+02 7.67026451e+01 6.54821273e+01
 1.19378036e+01 1.62258832e+01 2.84889820e+01 3.11546389e+01
 3.09696279e-01 1.04885877e+00 2.05108577e+00 4.33014950e+00
 5.45981582e+00 9.02398820e+00 3.68730167e+00 1.49063128e+01
 1.24603576e+01 6.82963548e+01 5.47640626e+01 4.34614253e+02
 3.30190603e-01 7.30197396e-01 1.14436291e+00 3.45294060e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998488610280138
cond(S) = 1379.7841312329806
E1 = -183.57826308246368  E_coul = 55.07848492586383
init E= -128.4997781566
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945072690682  LUMO = 0.827384874214747
  mo_energy =
[-3.25554701e+01 -1.85291088e+00 -7.73945073e-01 -7.73945073e-01
 -7.73945073e-01  8.27384874e-01  1.11549486e+00  1.11549486e+00
  1.11549486e+00  4.62229906e+00  5.77956686e+00  5.77956686e+00
  5.77956686e+00  1.71020628e+01  2.42328893e+01  2.42328893e+01
  2.42328893e+01  5.43503048e+01  1.19123055e+02  1.19123055e+02
  1.19123055e+02  1.65507145e+02  5.31429201e+02  1.89729657e+03
  8.02397076e+03  4.77876016e+04]
E1 = -182.1112959490237  E_coul = 53.58216661479793
cycle= 1 E= -128.529129334226  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461321
diis-c [-0.21281719  1.        ]
  HOMO = -0.879603452624609  LUMO = 0.799072686610561
  mo_energy =
[-3.28740321e+01 -1.96316051e+00 -8.79603453e-01 -8.79603453e-01
 -8.79603453e-01  7.99072687e-01  1.07727530e+00  1.07727530e+00
  1.07727530e+00  4.53571901e+00  5.65059903e+00  5.65059903e+00
  5.65059903e+00  1.69293082e+01  2.39978936e+01  2.39978936e+01
  2.39978936e+01  5.40965674e+01  1.18802221e+02  1.18802221e+02
  1.18802221e+02  1.65194169e+02  5.31072724e+02  1.89690349e+03
  8.02354839e+03  4.77871603e+04]
E1 = -182.84328257252466  E_coul = 54.311648490056356
cycle= 2 E= -128.531634082468  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230671
diis-c [-0.00069398  0.33224847  0.66775153]
  HOMO = -0.845258307611163  LUMO = 0.808268502895674
  mo_energy =
[-3.27690550e+01 -1.92705256e+00 -8.45258308e-01 -8.45258308e-01
 -8.45258308e-01  8.08268503e-01  1.08976603e+00  1.08976603e+00
  1.08976603e+00  4.56370082e+00  5.69252816e+00  5.69252816e+00
  5.69252816e+00  1.69859319e+01  2.40754449e+01  2.40754449e+01
  2.40754449e+01  5.41805710e+01  1.18907223e+02  1.18907223e+02
  1.18907223e+02  1.65297002e+02  5.31186070e+02  1.89702220e+03
  8.02366957e+03  4.77872824e+04]
E1 = -182.59788818763522  E_coul = 54.065407021361864
cycle= 3 E= -128.532481166273  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000896115
diis-c [-1.49578005e-07 -2.23927090e-03 -9.81067977e-04  1.00322034e+00]
  HOMO = -0.845486062156398  LUMO = 0.808233164561804
  mo_energy =
[-3.27694427e+01 -1.92721454e+00 -8.45486062e-01 -8.45486062e-01
 -8.45486062e-01  8.08233165e-01  1.08971771e+00  1.08971771e+00
  1.08971771e+00  4.56356755e+00  5.69233287e+00  5.69233287e+00
  5.69233287e+00  1.69856877e+01  2.40751373e+01  2.40751373e+01
  2.40751373e+01  5.41802517e+01  1.18906823e+02  1.18906823e+02
  1.18906823e+02  1.65296613e+02  5.31185583e+02  1.89702160e+03
  8.02366889e+03  4.77872817e+04]
E1 = -182.59832977382104  E_coul = 54.06584858743101
cycle= 4 E= -128.53248118639  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134744
diis-c [-1.03222615e-09  3.22570936e-04  4.91738077e-04 -2.13586039e-01
  1.21277173e+00]
  HOMO = -0.845518728792811  LUMO = 0.808226109156361
  mo_energy =
[-3.27694963e+01 -1.92723447e+00 -8.45518729e-01 -8.45518729e-01
 -8.45518729e-01  8.08226109e-01  1.08970400e+00  1.08970400e+00
  1.08970400e+00  4.56354398e+00  5.69229672e+00  5.69229672e+00
  5.69229672e+00  1.69856470e+01  2.40750890e+01  2.40750890e+01
  2.40750890e+01  5.41802026e+01  1.18906769e+02  1.18906769e+02
  1.18906769e+02  1.65296559e+02  5.31185521e+02  1.89702153e+03
  8.02366881e+03  4.77872816e+04]
E1 = -182.59843566310033  E_coul = 54.06595447614805
cycle= 5 E= -128.532481186952  delta_E= -5.62e-10  |g|= 6.77e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59843566310033  E_coul = 54.06595447614805
  HOMO = -0.845515024917447  LUMO = 0.808227626701461
  mo_energy =
[-3.27694882e+01 -1.92723004e+00 -8.45515025e-01 -8.45515025e-01
 -8.45515025e-01  8.08227627e-01  1.08970555e+00  1.08970555e+00
  1.08970555e+00  4.56354761e+00  5.69230123e+00  5.69230123e+00
  5.69230123e+00  1.69856529e+01  2.40750960e+01  2.40750960e+01
  2.40750960e+01  5.41802099e+01  1.18906777e+02  1.18906777e+02
  1.18906777e+02  1.65296567e+02  5.31185529e+02  1.89702153e+03
  8.02366882e+03  4.77872816e+04]
E1 = -182.59841787383098  E_coul = 54.06593668687583
Extra cycle  E= -128.532481186955  delta_E= -2.87e-12  |g|= 2.49e-06  |ddm|= 2.46e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.11165705e-01 2.44137941e+04 3.66145356e+03 8.33287488e+02
 2.35592777e+02 7.67026451e+01 1.19378036e+01 2.84889820e+01
 3.09696279e-01 2.05108577e+00 5.45981582e+00 3.68730167e+00
 1.24603576e+01 5.47640626e+01 3.30190603e-01 1.14436291e+00]
E = -128.53248118695515
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.81116570515        1
[INPUT] 0    0    [1    /1   ]  24413.7941474        1
[INPUT] 0    0    [1    /1   ]  3661.45356241        1
[INPUT] 0    0    [1    /1   ]  833.287488009        1
[INPUT] 0    0    [1    /1   ]  235.592777288        1
[INPUT] 0    0    [1    /1   ]  76.7026451356        1
[INPUT] 0    0    [1    /1   ]  11.9378035869        1
[INPUT] 0    0    [1    /1   ]  28.4889820076        1
[INPUT] 0    0    [1    /1   ]  0.309696279393       1
[INPUT] 0    0    [1    /1   ]  2.05108577489        1
[INPUT] 0    0    [1    /1   ]  5.45981582353        1
[INPUT] 1    0    [1    /1   ]  3.68730167457        1
[INPUT] 1    0    [1    /1   ]  12.4603575863        1
[INPUT] 1    0    [1    /1   ]  54.7640625804        1
[INPUT] 1    0    [1    /1   ]  0.330190603419       1
[INPUT] 1    0    [1    /1   ]  1.14436290507        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8111657051497988, 1.0]], [0, [24413.794147419965, 1.0]], [0, [3661.4535624149185, 1.0]], [0, [833.2874880087012, 1.0]], [0, [235.5927772881163, 1.0]], [0, [76.70264513556012, 1.0]], [0, [11.937803586876036, 1.0]], [0, [28.4889820076219, 1.0]], [0, [0.3096962793925956, 1.0]], [0, [2.051085774886386, 1.0]], [0, [5.4598158235274665, 1.0]], [1, [3.687301674574244, 1.0]], [1, [12.460357586282955, 1.0]], [1, [54.76406258039592, 1.0]], [1, [0.33019060341914325, 1.0]], [1, [1.1443629050721407, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81116571]
bas 1, expnt(s) = [24413.79414742]
bas 2, expnt(s) = [3661.45356241]
bas 3, expnt(s) = [833.28748801]
bas 4, expnt(s) = [235.59277729]
bas 5, expnt(s) = [76.70264514]
bas 6, expnt(s) = [11.93780359]
bas 7, expnt(s) = [28.48898201]
bas 8, expnt(s) = [0.30969628]
bas 9, expnt(s) = [2.05108577]
bas 10, expnt(s) = [5.45981582]
bas 11, expnt(s) = [3.68730167]
bas 12, expnt(s) = [12.46035759]
bas 13, expnt(s) = [54.76406258]
bas 14, expnt(s) = [0.3301906]
bas 15, expnt(s) = [1.14436291]
CPU time:       290.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.11165705e-01 2.15947017e+00 2.44137941e+04 4.93448102e+03
 3.66145356e+03 1.18920074e+03 8.33287488e+02 3.91842167e+02
 2.35592777e+02 1.51927539e+02 7.67026451e+01 6.54821273e+01
 1.19378036e+01 1.62258832e+01 2.84889820e+01 3.11546389e+01
 3.09696279e-01 1.04885877e+00 2.05108577e+00 4.33014950e+00
 5.45981582e+00 9.02398820e+00 3.68730167e+00 1.49063128e+01
 1.24603576e+01 6.82963548e+01 5.47640626e+01 4.34614253e+02
 3.30190603e-01 7.30197396e-01 1.14436291e+00 3.45294060e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998488610280138
cond(S) = 1379.7841312329806
E1 = -183.57826308246368  E_coul = 55.07848492586383
init E= -128.4997781566
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945072690682  LUMO = 0.827384874214747
  mo_energy =
[-3.25554701e+01 -1.85291088e+00 -7.73945073e-01 -7.73945073e-01
 -7.73945073e-01  8.27384874e-01  1.11549486e+00  1.11549486e+00
  1.11549486e+00  4.62229906e+00  5.77956686e+00  5.77956686e+00
  5.77956686e+00  1.71020628e+01  2.42328893e+01  2.42328893e+01
  2.42328893e+01  5.43503048e+01  1.19123055e+02  1.19123055e+02
  1.19123055e+02  1.65507145e+02  5.31429201e+02  1.89729657e+03
  8.02397076e+03  4.77876016e+04]
E1 = -182.1112959490237  E_coul = 53.58216661479793
cycle= 1 E= -128.529129334226  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461321
diis-c [-0.21281719  1.        ]
  HOMO = -0.879603452624609  LUMO = 0.799072686610561
  mo_energy =
[-3.28740321e+01 -1.96316051e+00 -8.79603453e-01 -8.79603453e-01
 -8.79603453e-01  7.99072687e-01  1.07727530e+00  1.07727530e+00
  1.07727530e+00  4.53571901e+00  5.65059903e+00  5.65059903e+00
  5.65059903e+00  1.69293082e+01  2.39978936e+01  2.39978936e+01
  2.39978936e+01  5.40965674e+01  1.18802221e+02  1.18802221e+02
  1.18802221e+02  1.65194169e+02  5.31072724e+02  1.89690349e+03
  8.02354839e+03  4.77871603e+04]
E1 = -182.84328257252466  E_coul = 54.311648490056356
cycle= 2 E= -128.531634082468  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230671
diis-c [-0.00069398  0.33224847  0.66775153]
  HOMO = -0.845258307611163  LUMO = 0.808268502895674
  mo_energy =
[-3.27690550e+01 -1.92705256e+00 -8.45258308e-01 -8.45258308e-01
 -8.45258308e-01  8.08268503e-01  1.08976603e+00  1.08976603e+00
  1.08976603e+00  4.56370082e+00  5.69252816e+00  5.69252816e+00
  5.69252816e+00  1.69859319e+01  2.40754449e+01  2.40754449e+01
  2.40754449e+01  5.41805710e+01  1.18907223e+02  1.18907223e+02
  1.18907223e+02  1.65297002e+02  5.31186070e+02  1.89702220e+03
  8.02366957e+03  4.77872824e+04]
E1 = -182.59788818763522  E_coul = 54.065407021361864
cycle= 3 E= -128.532481166273  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000896115
diis-c [-1.49578005e-07 -2.23927090e-03 -9.81067977e-04  1.00322034e+00]
  HOMO = -0.845486062156398  LUMO = 0.808233164561804
  mo_energy =
[-3.27694427e+01 -1.92721454e+00 -8.45486062e-01 -8.45486062e-01
 -8.45486062e-01  8.08233165e-01  1.08971771e+00  1.08971771e+00
  1.08971771e+00  4.56356755e+00  5.69233287e+00  5.69233287e+00
  5.69233287e+00  1.69856877e+01  2.40751373e+01  2.40751373e+01
  2.40751373e+01  5.41802517e+01  1.18906823e+02  1.18906823e+02
  1.18906823e+02  1.65296613e+02  5.31185583e+02  1.89702160e+03
  8.02366889e+03  4.77872817e+04]
E1 = -182.59832977382104  E_coul = 54.06584858743101
cycle= 4 E= -128.53248118639  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134744
diis-c [-1.03222615e-09  3.22570936e-04  4.91738077e-04 -2.13586039e-01
  1.21277173e+00]
  HOMO = -0.845518728792811  LUMO = 0.808226109156361
  mo_energy =
[-3.27694963e+01 -1.92723447e+00 -8.45518729e-01 -8.45518729e-01
 -8.45518729e-01  8.08226109e-01  1.08970400e+00  1.08970400e+00
  1.08970400e+00  4.56354398e+00  5.69229672e+00  5.69229672e+00
  5.69229672e+00  1.69856470e+01  2.40750890e+01  2.40750890e+01
  2.40750890e+01  5.41802026e+01  1.18906769e+02  1.18906769e+02
  1.18906769e+02  1.65296559e+02  5.31185521e+02  1.89702153e+03
  8.02366881e+03  4.77872816e+04]
E1 = -182.59843566310033  E_coul = 54.06595447614805
cycle= 5 E= -128.532481186952  delta_E= -5.62e-10  |g|= 6.77e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59843566310033  E_coul = 54.06595447614805
  HOMO = -0.845515024917447  LUMO = 0.808227626701461
  mo_energy =
[-3.27694882e+01 -1.92723004e+00 -8.45515025e-01 -8.45515025e-01
 -8.45515025e-01  8.08227627e-01  1.08970555e+00  1.08970555e+00
  1.08970555e+00  4.56354761e+00  5.69230123e+00  5.69230123e+00
  5.69230123e+00  1.69856529e+01  2.40750960e+01  2.40750960e+01
  2.40750960e+01  5.41802099e+01  1.18906777e+02  1.18906777e+02
  1.18906777e+02  1.65296567e+02  5.31185529e+02  1.89702153e+03
  8.02366882e+03  4.77872816e+04]
E1 = -182.59841787383098  E_coul = 54.06593668687583
Extra cycle  E= -128.532481186955  delta_E= -2.87e-12  |g|= 2.49e-06  |ddm|= 2.46e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1379.7841312329806
E1 = -182.59841787383098  E_coul = 54.06593668687583
init E= -128.532481186955
    CPU time for initialize scf      0.31 sec, wall time      0.33 sec
  HOMO = -0.845516269201984  LUMO = 0.80822736447036
  mo_energy =
[-3.27694922e+01 -1.92723123e+00 -8.45516269e-01 -8.45516269e-01
 -8.45516269e-01  8.08227364e-01  1.08970512e+00  1.08970512e+00
  1.08970512e+00  4.56354668e+00  5.69229971e+00  5.69229971e+00
  5.69229971e+00  1.69856509e+01  2.40750931e+01  2.40750931e+01
  2.40750931e+01  5.41802068e+01  1.18906773e+02  1.18906773e+02
  1.18906773e+02  1.65296563e+02  5.31185524e+02  1.89702153e+03
  8.02366882e+03  4.77872816e+04]
E1 = -182.59842746164006  E_coul = 54.06594627468463
cycle= 1 E= -128.532481186955  delta_E= -2.84e-13  |g|= 1.31e-06  |ddm|= 9.53e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.59842746164006  E_coul = 54.06594627468463
  HOMO = -0.845515595227941  LUMO = 0.808227557260728
  mo_energy =
[-3.27694902e+01 -1.92723050e+00 -8.45515595e-01 -8.45515595e-01
 -8.45515595e-01  8.08227557e-01  1.08970536e+00  1.08970536e+00
  1.08970536e+00  4.56354725e+00  5.69230054e+00  5.69230054e+00
  5.69230054e+00  1.69856520e+01  2.40750946e+01  2.40750946e+01
  2.40750946e+01  5.41802084e+01  1.18906775e+02  1.18906775e+02
  1.18906775e+02  1.65296565e+02  5.31185527e+02  1.89702153e+03
  8.02366882e+03  4.77872816e+04]
E1 = -182.59842269814817  E_coul = 54.06594151119267
Extra cycle  E= -128.532481186955  delta_E= -5.68e-14  |g|= 6.48e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.42 sec
exp = [8.11165705e-01 2.44137941e+04 3.66145356e+03 8.33287488e+02
 2.35592777e+02 7.67026451e+01 1.19378036e+01 2.84889820e+01
 3.09696279e-01 2.05108577e+00 5.45981582e+00 3.68730167e+00
 1.24603576e+01 5.47640626e+01 3.30190603e-01 1.14436291e+00]
grad_E = [-2.01700371e-05 -9.38767376e-10  4.97605236e-08 -1.00719767e-06
  1.11322116e-05 -4.64580782e-05  7.61893336e-06 -4.38576815e-05
 -1.12568169e-06  1.95909154e-06  2.63498899e-05  1.62286819e-05
  2.83810637e-05 -4.13648060e-06 -7.39752866e-05  9.87075949e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.80791608761        1
[INPUT] 0    0    [1    /1   ]  24413.7941467        1
[INPUT] 0    0    [1    /1   ]  3661.45359883        1
[INPUT] 0    0    [1    /1   ]  833.286822617        1
[INPUT] 0    0    [1    /1   ]  235.598704653        1
[INPUT] 0    0    [1    /1   ]  76.6880004508        1
[INPUT] 0    0    [1    /1   ]  11.8563400262        1
[INPUT] 0    0    [1    /1   ]  28.4500846286        1
[INPUT] 0    0    [1    /1   ]  0.308893980297       1
[INPUT] 0    0    [1    /1   ]  2.04135922594        1
[INPUT] 0    0    [1    /1   ]  5.37131300527        1
[INPUT] 1    0    [1    /1   ]  3.68644614869        1
[INPUT] 1    0    [1    /1   ]  12.4576562053        1
[INPUT] 1    0    [1    /1   ]  54.7651906629        1
[INPUT] 1    0    [1    /1   ]  0.330157339431       1
[INPUT] 1    0    [1    /1   ]  1.14416455351        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8079160876102514, 1.0]], [0, [24413.794146721, 1.0]], [0, [3661.4535988316256, 1.0]], [0, [833.286822616924, 1.0]], [0, [235.5987046532902, 1.0]], [0, [76.68800045082408, 1.0]], [0, [11.856340026233976, 1.0]], [0, [28.45008462856499, 1.0]], [0, [0.3088939802969008, 1.0]], [0, [2.041359225937719, 1.0]], [0, [5.371313005271689, 1.0]], [1, [3.6864461486922795, 1.0]], [1, [12.457656205290018, 1.0]], [1, [54.76519066294451, 1.0]], [1, [0.3301573394306599, 1.0]], [1, [1.1441645535097293, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80791609]
bas 1, expnt(s) = [24413.79414672]
bas 2, expnt(s) = [3661.45359883]
bas 3, expnt(s) = [833.28682262]
bas 4, expnt(s) = [235.59870465]
bas 5, expnt(s) = [76.68800045]
bas 6, expnt(s) = [11.85634003]
bas 7, expnt(s) = [28.45008463]
bas 8, expnt(s) = [0.30889398]
bas 9, expnt(s) = [2.04135923]
bas 10, expnt(s) = [5.37131301]
bas 11, expnt(s) = [3.68644615]
bas 12, expnt(s) = [12.45765621]
bas 13, expnt(s) = [54.76519066]
bas 14, expnt(s) = [0.33015734]
bas 15, expnt(s) = [1.14416455]
CPU time:       293.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.07916088e-01 2.15297862e+00 2.44137941e+04 4.93448102e+03
 3.66145360e+03 1.18920075e+03 8.33286823e+02 3.91841933e+02
 2.35598705e+02 1.51930406e+02 7.66880005e+01 6.54727503e+01
 1.18563400e+01 1.61427681e+01 2.84500846e+01 3.11227308e+01
 3.08893980e-01 1.04682023e+00 2.04135923e+00 4.31473970e+00
 5.37131301e+00 8.91405624e+00 3.68644615e+00 1.49019897e+01
 1.24576562e+01 6.82778472e+01 5.47651907e+01 4.34625444e+02
 3.30157339e-01 7.30105446e-01 1.14416455e+00 3.45219249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998489692430715
cond(S) = 1355.921000719219
E1 = -183.57827686433717  E_coul = 55.07848435470988
init E= -128.499792509627
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945135033496  LUMO = 0.823196455342866
  mo_energy =
[-3.25554699e+01 -1.85291145e+00 -7.73945135e-01 -7.73945135e-01
 -7.73945135e-01  8.23196455e-01  1.11532972e+00  1.11532972e+00
  1.11532972e+00  4.59218205e+00  5.77837529e+00  5.77837529e+00
  5.77837529e+00  1.69248473e+01  2.42267899e+01  2.42267899e+01
  2.42267899e+01  5.38568714e+01  1.19113187e+02  1.19113187e+02
  1.19113187e+02  1.64737438e+02  5.30563627e+02  1.89647272e+03
  8.02323734e+03  4.77869927e+04]
E1 = -182.11125028767324  E_coul = 53.58212088346339
cycle= 1 E= -128.52912940421  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461448
diis-c [-0.21293452  1.        ]
  HOMO = -0.879606835351024  LUMO = 0.795047807286318
  mo_energy =
[-3.28740407e+01 -1.96316479e+00 -8.79606835e-01 -8.79606835e-01
 -8.79606835e-01  7.95047807e-01  1.07711612e+00  1.07711612e+00
  1.07711612e+00  4.50616939e+00  5.64942253e+00  5.64942253e+00
  5.64942253e+00  1.67530876e+01  2.39918045e+01  2.39918045e+01
  2.39918045e+01  5.36035784e+01  1.18792343e+02  1.18792343e+02
  1.18792343e+02  1.64424498e+02  5.30207125e+02  1.89607962e+03
  8.02281496e+03  4.77865514e+04]
E1 = -182.84326926568963  E_coul = 54.31163498387797
cycle= 2 E= -128.531634281812  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230731
diis-c [-0.00069159  0.33224978  0.66775022]
  HOMO = -0.84526012627817  LUMO = 0.804191661435255
  mo_energy =
[-3.27690596e+01 -1.92705522e+00 -8.45260126e-01 -8.45260126e-01
 -8.45260126e-01  8.04191661e-01  1.08960503e+00  1.08960503e+00
  1.08960503e+00  4.53396567e+00  5.69134708e+00  5.69134708e+00
  5.69134708e+00  1.68093766e+01  2.40693530e+01  2.40693530e+01
  2.40693530e+01  5.36874338e+01  1.18897349e+02  1.18897349e+02
  1.18897349e+02  1.64527323e+02  5.30320480e+02  1.89619833e+03
  8.02293614e+03  4.77866735e+04]
E1 = -182.59786100152786  E_coul = 54.06537955906177
cycle= 3 E= -128.532481442466  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000896814
diis-c [-1.50300212e-07 -2.23901573e-03 -9.80020985e-04  1.00321904e+00]
  HOMO = -0.845488026978308  LUMO = 0.804156502198534
  mo_energy =
[-3.27694478e+01 -1.92721734e+00 -8.45488027e-01 -8.45488027e-01
 -8.45488027e-01  8.04156502e-01  1.08955665e+00  1.08955665e+00
  1.08955665e+00  4.53383308e+00  5.69115164e+00  5.69115164e+00
  5.69115164e+00  1.68091332e+01  2.40690451e+01  2.40690451e+01
  2.40690451e+01  5.36871146e+01  1.18896949e+02  1.18896949e+02
  1.18896949e+02  1.64526933e+02  5.30319992e+02  1.89619773e+03
  8.02293546e+03  4.77866728e+04]
E1 = -182.59830341775793  E_coul = 54.065821955137864
cycle= 4 E= -128.53248146262  delta_E= -2.02e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134595
diis-c [-1.03360074e-09  3.23047143e-04  4.89961396e-04 -2.13830867e-01
  1.21301786e+00]
  HOMO = -0.845520679314811  LUMO = 0.804149489305792
  mo_energy =
[-3.27695013e+01 -1.92723725e+00 -8.45520679e-01 -8.45520679e-01
 -8.45520679e-01  8.04149489e-01  1.08954294e+00  1.08954294e+00
  1.08954294e+00  4.53380964e+00  5.69111552e+00  5.69111552e+00
  5.69111552e+00  1.68090927e+01  2.40689969e+01  2.40689969e+01
  2.40689969e+01  5.36870655e+01  1.18896895e+02  1.18896895e+02
  1.18896895e+02  1.64526879e+02  5.30319931e+02  1.89619766e+03
  8.02293538e+03  4.77866727e+04]
E1 = -182.59840904659254  E_coul = 54.0659275834097
cycle= 5 E= -128.532481463183  delta_E= -5.63e-10  |g|= 6.78e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59840904659254  E_coul = 54.0659275834097
  HOMO = -0.845516965979034  LUMO = 0.804151001437812
  mo_energy =
[-3.27694932e+01 -1.92723281e+00 -8.45516966e-01 -8.45516966e-01
 -8.45516966e-01  8.04151001e-01  1.08954450e+00  1.08954450e+00
  1.08954450e+00  4.53381326e+00  5.69112004e+00  5.69112004e+00
  5.69112004e+00  1.68090985e+01  2.40690038e+01  2.40690038e+01
  2.40690038e+01  5.36870729e+01  1.18896903e+02  1.18896903e+02
  1.18896903e+02  1.64526887e+02  5.30319938e+02  1.89619766e+03
  8.02293539e+03  4.77866727e+04]
E1 = -182.5983912037298  E_coul = 54.06590974054452
Extra cycle  E= -128.532481463185  delta_E= -2.44e-12  |g|= 2.5e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.07916088e-01 2.44137941e+04 3.66145360e+03 8.33286823e+02
 2.35598705e+02 7.66880005e+01 1.18563400e+01 2.84500846e+01
 3.08893980e-01 2.04135923e+00 5.37131301e+00 3.68644615e+00
 1.24576562e+01 5.47651907e+01 3.30157339e-01 1.14416455e+00]
E = -128.53248146318526
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.80791608761        1
[INPUT] 0    0    [1    /1   ]  24413.7941467        1
[INPUT] 0    0    [1    /1   ]  3661.45359883        1
[INPUT] 0    0    [1    /1   ]  833.286822617        1
[INPUT] 0    0    [1    /1   ]  235.598704653        1
[INPUT] 0    0    [1    /1   ]  76.6880004508        1
[INPUT] 0    0    [1    /1   ]  11.8563400262        1
[INPUT] 0    0    [1    /1   ]  28.4500846286        1
[INPUT] 0    0    [1    /1   ]  0.308893980297       1
[INPUT] 0    0    [1    /1   ]  2.04135922594        1
[INPUT] 0    0    [1    /1   ]  5.37131300527        1
[INPUT] 1    0    [1    /1   ]  3.68644614869        1
[INPUT] 1    0    [1    /1   ]  12.4576562053        1
[INPUT] 1    0    [1    /1   ]  54.7651906629        1
[INPUT] 1    0    [1    /1   ]  0.330157339431       1
[INPUT] 1    0    [1    /1   ]  1.14416455351        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8079160876102514, 1.0]], [0, [24413.794146721, 1.0]], [0, [3661.4535988316256, 1.0]], [0, [833.286822616924, 1.0]], [0, [235.5987046532902, 1.0]], [0, [76.68800045082408, 1.0]], [0, [11.856340026233976, 1.0]], [0, [28.45008462856499, 1.0]], [0, [0.3088939802969008, 1.0]], [0, [2.041359225937719, 1.0]], [0, [5.371313005271689, 1.0]], [1, [3.6864461486922795, 1.0]], [1, [12.457656205290018, 1.0]], [1, [54.76519066294451, 1.0]], [1, [0.3301573394306599, 1.0]], [1, [1.1441645535097293, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80791609]
bas 1, expnt(s) = [24413.79414672]
bas 2, expnt(s) = [3661.45359883]
bas 3, expnt(s) = [833.28682262]
bas 4, expnt(s) = [235.59870465]
bas 5, expnt(s) = [76.68800045]
bas 6, expnt(s) = [11.85634003]
bas 7, expnt(s) = [28.45008463]
bas 8, expnt(s) = [0.30889398]
bas 9, expnt(s) = [2.04135923]
bas 10, expnt(s) = [5.37131301]
bas 11, expnt(s) = [3.68644615]
bas 12, expnt(s) = [12.45765621]
bas 13, expnt(s) = [54.76519066]
bas 14, expnt(s) = [0.33015734]
bas 15, expnt(s) = [1.14416455]
CPU time:       294.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.07916088e-01 2.15297862e+00 2.44137941e+04 4.93448102e+03
 3.66145360e+03 1.18920075e+03 8.33286823e+02 3.91841933e+02
 2.35598705e+02 1.51930406e+02 7.66880005e+01 6.54727503e+01
 1.18563400e+01 1.61427681e+01 2.84500846e+01 3.11227308e+01
 3.08893980e-01 1.04682023e+00 2.04135923e+00 4.31473970e+00
 5.37131301e+00 8.91405624e+00 3.68644615e+00 1.49019897e+01
 1.24576562e+01 6.82778472e+01 5.47651907e+01 4.34625444e+02
 3.30157339e-01 7.30105446e-01 1.14416455e+00 3.45219249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998489692430715
cond(S) = 1355.921000719219
E1 = -183.57827686433717  E_coul = 55.07848435470988
init E= -128.499792509627
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945135033496  LUMO = 0.823196455342866
  mo_energy =
[-3.25554699e+01 -1.85291145e+00 -7.73945135e-01 -7.73945135e-01
 -7.73945135e-01  8.23196455e-01  1.11532972e+00  1.11532972e+00
  1.11532972e+00  4.59218205e+00  5.77837529e+00  5.77837529e+00
  5.77837529e+00  1.69248473e+01  2.42267899e+01  2.42267899e+01
  2.42267899e+01  5.38568714e+01  1.19113187e+02  1.19113187e+02
  1.19113187e+02  1.64737438e+02  5.30563627e+02  1.89647272e+03
  8.02323734e+03  4.77869927e+04]
E1 = -182.11125028767324  E_coul = 53.58212088346339
cycle= 1 E= -128.52912940421  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461448
diis-c [-0.21293452  1.        ]
  HOMO = -0.879606835351024  LUMO = 0.795047807286318
  mo_energy =
[-3.28740407e+01 -1.96316479e+00 -8.79606835e-01 -8.79606835e-01
 -8.79606835e-01  7.95047807e-01  1.07711612e+00  1.07711612e+00
  1.07711612e+00  4.50616939e+00  5.64942253e+00  5.64942253e+00
  5.64942253e+00  1.67530876e+01  2.39918045e+01  2.39918045e+01
  2.39918045e+01  5.36035784e+01  1.18792343e+02  1.18792343e+02
  1.18792343e+02  1.64424498e+02  5.30207125e+02  1.89607962e+03
  8.02281496e+03  4.77865514e+04]
E1 = -182.84326926568963  E_coul = 54.31163498387797
cycle= 2 E= -128.531634281812  delta_E= -0.0025  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.230731
diis-c [-0.00069159  0.33224978  0.66775022]
  HOMO = -0.84526012627817  LUMO = 0.804191661435255
  mo_energy =
[-3.27690596e+01 -1.92705522e+00 -8.45260126e-01 -8.45260126e-01
 -8.45260126e-01  8.04191661e-01  1.08960503e+00  1.08960503e+00
  1.08960503e+00  4.53396567e+00  5.69134708e+00  5.69134708e+00
  5.69134708e+00  1.68093766e+01  2.40693530e+01  2.40693530e+01
  2.40693530e+01  5.36874338e+01  1.18897349e+02  1.18897349e+02
  1.18897349e+02  1.64527323e+02  5.30320480e+02  1.89619833e+03
  8.02293614e+03  4.77866735e+04]
E1 = -182.59786100152786  E_coul = 54.06537955906177
cycle= 3 E= -128.532481442466  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000896814
diis-c [-1.50300212e-07 -2.23901573e-03 -9.80020985e-04  1.00321904e+00]
  HOMO = -0.845488026978308  LUMO = 0.804156502198534
  mo_energy =
[-3.27694478e+01 -1.92721734e+00 -8.45488027e-01 -8.45488027e-01
 -8.45488027e-01  8.04156502e-01  1.08955665e+00  1.08955665e+00
  1.08955665e+00  4.53383308e+00  5.69115164e+00  5.69115164e+00
  5.69115164e+00  1.68091332e+01  2.40690451e+01  2.40690451e+01
  2.40690451e+01  5.36871146e+01  1.18896949e+02  1.18896949e+02
  1.18896949e+02  1.64526933e+02  5.30319992e+02  1.89619773e+03
  8.02293546e+03  4.77866728e+04]
E1 = -182.59830341775793  E_coul = 54.065821955137864
cycle= 4 E= -128.53248146262  delta_E= -2.02e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134595
diis-c [-1.03360074e-09  3.23047143e-04  4.89961396e-04 -2.13830867e-01
  1.21301786e+00]
  HOMO = -0.845520679314811  LUMO = 0.804149489305792
  mo_energy =
[-3.27695013e+01 -1.92723725e+00 -8.45520679e-01 -8.45520679e-01
 -8.45520679e-01  8.04149489e-01  1.08954294e+00  1.08954294e+00
  1.08954294e+00  4.53380964e+00  5.69111552e+00  5.69111552e+00
  5.69111552e+00  1.68090927e+01  2.40689969e+01  2.40689969e+01
  2.40689969e+01  5.36870655e+01  1.18896895e+02  1.18896895e+02
  1.18896895e+02  1.64526879e+02  5.30319931e+02  1.89619766e+03
  8.02293538e+03  4.77866727e+04]
E1 = -182.59840904659254  E_coul = 54.0659275834097
cycle= 5 E= -128.532481463183  delta_E= -5.63e-10  |g|= 6.78e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59840904659254  E_coul = 54.0659275834097
  HOMO = -0.845516965979034  LUMO = 0.804151001437812
  mo_energy =
[-3.27694932e+01 -1.92723281e+00 -8.45516966e-01 -8.45516966e-01
 -8.45516966e-01  8.04151001e-01  1.08954450e+00  1.08954450e+00
  1.08954450e+00  4.53381326e+00  5.69112004e+00  5.69112004e+00
  5.69112004e+00  1.68090985e+01  2.40690038e+01  2.40690038e+01
  2.40690038e+01  5.36870729e+01  1.18896903e+02  1.18896903e+02
  1.18896903e+02  1.64526887e+02  5.30319938e+02  1.89619766e+03
  8.02293539e+03  4.77866727e+04]
E1 = -182.5983912037298  E_coul = 54.06590974054452
Extra cycle  E= -128.532481463185  delta_E= -2.44e-12  |g|= 2.5e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1355.921000719219
E1 = -182.5983912037298  E_coul = 54.06590974054452
init E= -128.532481463185
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.845518213923941  LUMO = 0.804150739777549
  mo_energy =
[-3.27694972e+01 -1.92723401e+00 -8.45518214e-01 -8.45518214e-01
 -8.45518214e-01  8.04150740e-01  1.08954406e+00  1.08954406e+00
  1.08954406e+00  4.53381234e+00  5.69111852e+00  5.69111852e+00
  5.69111852e+00  1.68090965e+01  2.40690009e+01  2.40690009e+01
  2.40690009e+01  5.36870697e+01  1.18896899e+02  1.18896899e+02
  1.18896899e+02  1.64526883e+02  5.30319934e+02  1.89619766e+03
  8.02293539e+03  4.77866727e+04]
E1 = -182.59840081963569  E_coul = 54.065919356449726
cycle= 1 E= -128.532481463186  delta_E= -6.82e-13  |g|= 1.32e-06  |ddm|= 9.55e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59840081963569  E_coul = 54.065919356449726
  HOMO = -0.845517537945762  LUMO = 0.804150932001168
  mo_energy =
[-3.27694952e+01 -1.92723327e+00 -8.45517538e-01 -8.45517538e-01
 -8.45517538e-01  8.04150932e-01  1.08954431e+00  1.08954431e+00
  1.08954431e+00  4.53381291e+00  5.69111935e+00  5.69111935e+00
  5.69111935e+00  1.68090976e+01  2.40690025e+01  2.40690025e+01
  2.40690025e+01  5.36870714e+01  1.18896901e+02  1.18896901e+02
  1.18896901e+02  1.64526885e+02  5.30319936e+02  1.89619766e+03
  8.02293539e+03  4.77866727e+04]
E1 = -182.59839604202844  E_coul = 54.06591457884212
Extra cycle  E= -128.532481463186  delta_E= -3.69e-13  |g|= 6.5e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [8.07916088e-01 2.44137941e+04 3.66145360e+03 8.33286823e+02
 2.35598705e+02 7.66880005e+01 1.18563400e+01 2.84500846e+01
 3.08893980e-01 2.04135923e+00 5.37131301e+00 3.68644615e+00
 1.24576562e+01 5.47651907e+01 3.30157339e-01 1.14416455e+00]
grad_E = [-3.84900578e-05 -9.96001577e-10  5.27328354e-08 -1.06288902e-06
  1.17070682e-05 -5.00332332e-05 -9.15140211e-06 -3.17330701e-05
  1.68668393e-05  9.57312165e-06  3.05611820e-05  1.02728840e-05
  2.45564032e-05 -3.42412819e-06 -5.87846967e-05  1.77945415e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.809028398711       1
[INPUT] 0    0    [1    /1   ]  24413.7941468        1
[INPUT] 0    0    [1    /1   ]  3661.45359587        1
[INPUT] 0    0    [1    /1   ]  833.286877041        1
[INPUT] 0    0    [1    /1   ]  235.598198753        1
[INPUT] 0    0    [1    /1   ]  76.6898789211        1
[INPUT] 0    0    [1    /1   ]  11.8584484911        1
[INPUT] 0    0    [1    /1   ]  28.4490659825        1
[INPUT] 0    0    [1    /1   ]  0.309277431864       1
[INPUT] 0    0    [1    /1   ]  2.04267611712        1
[INPUT] 0    0    [1    /1   ]  5.37664449219        1
[INPUT] 1    0    [1    /1   ]  3.6851713629         1
[INPUT] 1    0    [1    /1   ]  12.4536825894        1
[INPUT] 1    0    [1    /1   ]  54.765817346         1
[INPUT] 1    0    [1    /1   ]  0.330103547388       1
[INPUT] 1    0    [1    /1   ]  1.14385140513        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8090283987111778, 1.0]], [0, [24413.794146777906, 1.0]], [0, [3661.4535958711676, 1.0]], [0, [833.2868770408828, 1.0]], [0, [235.59819875328913, 1.0]], [0, [76.68987892114892, 1.0]], [0, [11.858448491143191, 1.0]], [0, [28.449065982545104, 1.0]], [0, [0.3092774318643918, 1.0]], [0, [2.042676117118388, 1.0]], [0, [5.376644492186933, 1.0]], [1, [3.685171362895249, 1.0]], [1, [12.453682589370443, 1.0]], [1, [54.76581734600839, 1.0]], [1, [0.3301035473875516, 1.0]], [1, [1.1438514051287387, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8090284]
bas 1, expnt(s) = [24413.79414678]
bas 2, expnt(s) = [3661.45359587]
bas 3, expnt(s) = [833.28687704]
bas 4, expnt(s) = [235.59819875]
bas 5, expnt(s) = [76.68987892]
bas 6, expnt(s) = [11.85844849]
bas 7, expnt(s) = [28.44906598]
bas 8, expnt(s) = [0.30927743]
bas 9, expnt(s) = [2.04267612]
bas 10, expnt(s) = [5.37664449]
bas 11, expnt(s) = [3.68517136]
bas 12, expnt(s) = [12.45368259]
bas 13, expnt(s) = [54.76581735]
bas 14, expnt(s) = [0.33010355]
bas 15, expnt(s) = [1.14385141]
CPU time:       298.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09028399e-01 2.15520134e+00 2.44137941e+04 4.93448102e+03
 3.66145360e+03 1.18920075e+03 8.33286877e+02 3.91841952e+02
 2.35598199e+02 1.51930161e+02 7.66898789e+01 6.54739532e+01
 1.18584485e+01 1.61449211e+01 2.84490660e+01 3.11218950e+01
 3.09277432e-01 1.04779470e+00 2.04267612e+00 4.31682713e+00
 5.37664449e+00 8.92069139e+00 3.68517136e+00 1.48955486e+01
 1.24536826e+01 6.82506251e+01 5.47658173e+01 4.34631661e+02
 3.30103547e-01 7.29956755e-01 1.14385141e+00 3.45101149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998491222298643
cond(S) = 1359.4301350933897
E1 = -183.57827465261707  E_coul = 55.07848429916625
init E= -128.499790353451
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945092434702  LUMO = 0.824622979229065
  mo_energy =
[-3.25554705e+01 -1.85291125e+00 -7.73945092e-01 -7.73945092e-01
 -7.73945092e-01  8.24622979e-01  1.11506476e+00  1.11506476e+00
  1.11506476e+00  4.59850328e+00  5.77653390e+00  5.77653390e+00
  5.77653390e+00  1.69422442e+01  2.42176874e+01  2.42176874e+01
  2.42176874e+01  5.38883937e+01  1.19096971e+02  1.19096971e+02
  1.19096971e+02  1.64775494e+02  5.30602821e+02  1.89650955e+03
  8.02327000e+03  4.77870198e+04]
E1 = -182.1111909231916  E_coul = 53.58206173870003
cycle= 1 E= -128.529129184492  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461453
diis-c [-0.21293848  1.        ]
  HOMO = -0.879610846413654  LUMO = 0.796423184437398
  mo_energy =
[-3.28740534e+01 -1.96316974e+00 -8.79610846e-01 -8.79610846e-01
 -8.79610846e-01  7.96423184e-01  1.07686089e+00  1.07686089e+00
  1.07686089e+00  4.51241669e+00  5.64760553e+00  5.64760553e+00
  5.64760553e+00  1.67704215e+01  2.39827192e+01  2.39827192e+01
  2.39827192e+01  5.36350785e+01  1.18776114e+02  1.18776114e+02
  1.18776114e+02  1.64462544e+02  5.30246307e+02  1.89611644e+03
  8.02284761e+03  4.77865785e+04]
E1 = -182.8432482311802  E_coul = 54.31161400057597
cycle= 2 E= -128.531634230604  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230738
diis-c [-0.00069165  0.33225435  0.66774565]
  HOMO = -0.845262477273234  LUMO = 0.805583171611506
  mo_energy =
[-3.27690680e+01 -1.92705835e+00 -8.45262477e-01 -8.45262477e-01
 -8.45262477e-01  8.05583172e-01  1.08934656e+00  1.08934656e+00
  1.08934656e+00  4.54023715e+00  5.68952238e+00  5.68952238e+00
  5.68952238e+00  1.68267320e+01  2.40602625e+01  2.40602625e+01
  2.40602625e+01  5.37189416e+01  1.18881125e+02  1.18881125e+02
  1.18881125e+02  1.64565372e+02  5.30359665e+02  1.89623515e+03
  8.02296880e+03  4.77867006e+04]
E1 = -182.5978248844489  E_coul = 54.065343401730054
cycle= 3 E= -128.532481482719  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000896294
diis-c [-1.49957674e-07 -2.23808136e-03 -9.79752200e-04  1.00321783e+00]
  HOMO = -0.84549033720361  LUMO = 0.805547934429046
  mo_energy =
[-3.27694560e+01 -1.92722047e+00 -8.45490337e-01 -8.45490337e-01
 -8.45490337e-01  8.05547934e-01  1.08929822e+00  1.08929822e+00
  1.08929822e+00  4.54010446e+00  5.68932704e+00  5.68932704e+00
  5.68932704e+00  1.68264886e+01  2.40599547e+01  2.40599547e+01
  2.40599547e+01  5.37186226e+01  1.18880725e+02  1.18880725e+02
  1.18880725e+02  1.64564983e+02  5.30359178e+02  1.89623455e+03
  8.02296812e+03  4.77866999e+04]
E1 = -182.59826681320956  E_coul = 54.06578531035242
cycle= 4 E= -128.532481502857  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134573
diis-c [-1.03325680e-09  3.22743363e-04  4.90168923e-04 -2.13734702e-01
  1.21292179e+00]
  HOMO = -0.845522993941704  LUMO = 0.805540902266879
  mo_energy =
[-3.27695096e+01 -1.92724040e+00 -8.45522994e-01 -8.45522994e-01
 -8.45522994e-01  8.05540902e-01  1.08928450e+00  1.08928450e+00
  1.08928450e+00  4.54008099e+00  5.68929092e+00  5.68929092e+00
  5.68929092e+00  1.68264480e+01  2.40599065e+01  2.40599065e+01
  2.40599065e+01  5.37185735e+01  1.18880671e+02  1.18880671e+02
  1.18880671e+02  1.64564929e+02  5.30359116e+02  1.89623448e+03
  8.02296804e+03  4.77866998e+04]
E1 = -182.59837246749706  E_coul = 54.065890964077504
cycle= 5 E= -128.53248150342  delta_E= -5.62e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59837246749706  E_coul = 54.065890964077504
  HOMO = -0.845519282672545  LUMO = 0.805542416191476
  mo_energy =
[-3.27695015e+01 -1.92723596e+00 -8.45519283e-01 -8.45519283e-01
 -8.45519283e-01  8.05542416e-01  1.08928606e+00  1.08928606e+00
  1.08928606e+00  4.54008461e+00  5.68929543e+00  5.68929543e+00
  5.68929543e+00  1.68264539e+01  2.40599134e+01  2.40599134e+01
  2.40599134e+01  5.37185808e+01  1.18880679e+02  1.18880679e+02
  1.18880679e+02  1.64564937e+02  5.30359124e+02  1.89623449e+03
  8.02296805e+03  4.77866998e+04]
E1 = -182.5983546368498  E_coul = 54.065873133427935
Extra cycle  E= -128.532481503422  delta_E= -2.3e-12  |g|= 2.5e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.09028399e-01 2.44137941e+04 3.66145360e+03 8.33286877e+02
 2.35598199e+02 7.66898789e+01 1.18584485e+01 2.84490660e+01
 3.09277432e-01 2.04267612e+00 5.37664449e+00 3.68517136e+00
 1.24536826e+01 5.47658173e+01 3.30103547e-01 1.14385141e+00]
E = -128.53248150342185
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.809028398711       1
[INPUT] 0    0    [1    /1   ]  24413.7941468        1
[INPUT] 0    0    [1    /1   ]  3661.45359587        1
[INPUT] 0    0    [1    /1   ]  833.286877041        1
[INPUT] 0    0    [1    /1   ]  235.598198753        1
[INPUT] 0    0    [1    /1   ]  76.6898789211        1
[INPUT] 0    0    [1    /1   ]  11.8584484911        1
[INPUT] 0    0    [1    /1   ]  28.4490659825        1
[INPUT] 0    0    [1    /1   ]  0.309277431864       1
[INPUT] 0    0    [1    /1   ]  2.04267611712        1
[INPUT] 0    0    [1    /1   ]  5.37664449219        1
[INPUT] 1    0    [1    /1   ]  3.6851713629         1
[INPUT] 1    0    [1    /1   ]  12.4536825894        1
[INPUT] 1    0    [1    /1   ]  54.765817346         1
[INPUT] 1    0    [1    /1   ]  0.330103547388       1
[INPUT] 1    0    [1    /1   ]  1.14385140513        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8090283987111778, 1.0]], [0, [24413.794146777906, 1.0]], [0, [3661.4535958711676, 1.0]], [0, [833.2868770408828, 1.0]], [0, [235.59819875328913, 1.0]], [0, [76.68987892114892, 1.0]], [0, [11.858448491143191, 1.0]], [0, [28.449065982545104, 1.0]], [0, [0.3092774318643918, 1.0]], [0, [2.042676117118388, 1.0]], [0, [5.376644492186933, 1.0]], [1, [3.685171362895249, 1.0]], [1, [12.453682589370443, 1.0]], [1, [54.76581734600839, 1.0]], [1, [0.3301035473875516, 1.0]], [1, [1.1438514051287387, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8090284]
bas 1, expnt(s) = [24413.79414678]
bas 2, expnt(s) = [3661.45359587]
bas 3, expnt(s) = [833.28687704]
bas 4, expnt(s) = [235.59819875]
bas 5, expnt(s) = [76.68987892]
bas 6, expnt(s) = [11.85844849]
bas 7, expnt(s) = [28.44906598]
bas 8, expnt(s) = [0.30927743]
bas 9, expnt(s) = [2.04267612]
bas 10, expnt(s) = [5.37664449]
bas 11, expnt(s) = [3.68517136]
bas 12, expnt(s) = [12.45368259]
bas 13, expnt(s) = [54.76581735]
bas 14, expnt(s) = [0.33010355]
bas 15, expnt(s) = [1.14385141]
CPU time:       299.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09028399e-01 2.15520134e+00 2.44137941e+04 4.93448102e+03
 3.66145360e+03 1.18920075e+03 8.33286877e+02 3.91841952e+02
 2.35598199e+02 1.51930161e+02 7.66898789e+01 6.54739532e+01
 1.18584485e+01 1.61449211e+01 2.84490660e+01 3.11218950e+01
 3.09277432e-01 1.04779470e+00 2.04267612e+00 4.31682713e+00
 5.37664449e+00 8.92069139e+00 3.68517136e+00 1.48955486e+01
 1.24536826e+01 6.82506251e+01 5.47658173e+01 4.34631661e+02
 3.30103547e-01 7.29956755e-01 1.14385141e+00 3.45101149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998491222298643
cond(S) = 1359.4301350933897
E1 = -183.57827465261707  E_coul = 55.07848429916625
init E= -128.499790353451
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945092434702  LUMO = 0.824622979229065
  mo_energy =
[-3.25554705e+01 -1.85291125e+00 -7.73945092e-01 -7.73945092e-01
 -7.73945092e-01  8.24622979e-01  1.11506476e+00  1.11506476e+00
  1.11506476e+00  4.59850328e+00  5.77653390e+00  5.77653390e+00
  5.77653390e+00  1.69422442e+01  2.42176874e+01  2.42176874e+01
  2.42176874e+01  5.38883937e+01  1.19096971e+02  1.19096971e+02
  1.19096971e+02  1.64775494e+02  5.30602821e+02  1.89650955e+03
  8.02327000e+03  4.77870198e+04]
E1 = -182.1111909231916  E_coul = 53.58206173870003
cycle= 1 E= -128.529129184492  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461453
diis-c [-0.21293848  1.        ]
  HOMO = -0.879610846413654  LUMO = 0.796423184437398
  mo_energy =
[-3.28740534e+01 -1.96316974e+00 -8.79610846e-01 -8.79610846e-01
 -8.79610846e-01  7.96423184e-01  1.07686089e+00  1.07686089e+00
  1.07686089e+00  4.51241669e+00  5.64760553e+00  5.64760553e+00
  5.64760553e+00  1.67704215e+01  2.39827192e+01  2.39827192e+01
  2.39827192e+01  5.36350785e+01  1.18776114e+02  1.18776114e+02
  1.18776114e+02  1.64462544e+02  5.30246307e+02  1.89611644e+03
  8.02284761e+03  4.77865785e+04]
E1 = -182.8432482311802  E_coul = 54.31161400057597
cycle= 2 E= -128.531634230604  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230738
diis-c [-0.00069165  0.33225435  0.66774565]
  HOMO = -0.845262477273234  LUMO = 0.805583171611506
  mo_energy =
[-3.27690680e+01 -1.92705835e+00 -8.45262477e-01 -8.45262477e-01
 -8.45262477e-01  8.05583172e-01  1.08934656e+00  1.08934656e+00
  1.08934656e+00  4.54023715e+00  5.68952238e+00  5.68952238e+00
  5.68952238e+00  1.68267320e+01  2.40602625e+01  2.40602625e+01
  2.40602625e+01  5.37189416e+01  1.18881125e+02  1.18881125e+02
  1.18881125e+02  1.64565372e+02  5.30359665e+02  1.89623515e+03
  8.02296880e+03  4.77867006e+04]
E1 = -182.5978248844489  E_coul = 54.065343401730054
cycle= 3 E= -128.532481482719  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000896294
diis-c [-1.49957674e-07 -2.23808136e-03 -9.79752200e-04  1.00321783e+00]
  HOMO = -0.84549033720361  LUMO = 0.805547934429046
  mo_energy =
[-3.27694560e+01 -1.92722047e+00 -8.45490337e-01 -8.45490337e-01
 -8.45490337e-01  8.05547934e-01  1.08929822e+00  1.08929822e+00
  1.08929822e+00  4.54010446e+00  5.68932704e+00  5.68932704e+00
  5.68932704e+00  1.68264886e+01  2.40599547e+01  2.40599547e+01
  2.40599547e+01  5.37186226e+01  1.18880725e+02  1.18880725e+02
  1.18880725e+02  1.64564983e+02  5.30359178e+02  1.89623455e+03
  8.02296812e+03  4.77866999e+04]
E1 = -182.59826681320956  E_coul = 54.06578531035242
cycle= 4 E= -128.532481502857  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134573
diis-c [-1.03325680e-09  3.22743363e-04  4.90168923e-04 -2.13734702e-01
  1.21292179e+00]
  HOMO = -0.845522993941704  LUMO = 0.805540902266879
  mo_energy =
[-3.27695096e+01 -1.92724040e+00 -8.45522994e-01 -8.45522994e-01
 -8.45522994e-01  8.05540902e-01  1.08928450e+00  1.08928450e+00
  1.08928450e+00  4.54008099e+00  5.68929092e+00  5.68929092e+00
  5.68929092e+00  1.68264480e+01  2.40599065e+01  2.40599065e+01
  2.40599065e+01  5.37185735e+01  1.18880671e+02  1.18880671e+02
  1.18880671e+02  1.64564929e+02  5.30359116e+02  1.89623448e+03
  8.02296804e+03  4.77866998e+04]
E1 = -182.59837246749706  E_coul = 54.065890964077504
cycle= 5 E= -128.53248150342  delta_E= -5.62e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59837246749706  E_coul = 54.065890964077504
  HOMO = -0.845519282672545  LUMO = 0.805542416191476
  mo_energy =
[-3.27695015e+01 -1.92723596e+00 -8.45519283e-01 -8.45519283e-01
 -8.45519283e-01  8.05542416e-01  1.08928606e+00  1.08928606e+00
  1.08928606e+00  4.54008461e+00  5.68929543e+00  5.68929543e+00
  5.68929543e+00  1.68264539e+01  2.40599134e+01  2.40599134e+01
  2.40599134e+01  5.37185808e+01  1.18880679e+02  1.18880679e+02
  1.18880679e+02  1.64564937e+02  5.30359124e+02  1.89623449e+03
  8.02296805e+03  4.77866998e+04]
E1 = -182.5983546368498  E_coul = 54.065873133427935
Extra cycle  E= -128.532481503422  delta_E= -2.3e-12  |g|= 2.5e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1359.4301350933897
E1 = -182.5983546368498  E_coul = 54.065873133427935
init E= -128.532481503422
    CPU time for initialize scf      0.23 sec, wall time      0.24 sec
  HOMO = -0.845520529770584  LUMO = 0.80554215429309
  mo_energy =
[-3.27695054e+01 -1.92723716e+00 -8.45520530e-01 -8.45520530e-01
 -8.45520530e-01  8.05542154e-01  1.08928563e+00  1.08928563e+00
  1.08928563e+00  4.54008369e+00  5.68929391e+00  5.68929391e+00
  5.68929391e+00  1.68264519e+01  2.40599105e+01  2.40599105e+01
  2.40599105e+01  5.37185777e+01  1.18880675e+02  1.18880675e+02
  1.18880675e+02  1.64564933e+02  5.30359120e+02  1.89623448e+03
  8.02296804e+03  4.77866998e+04]
E1 = -182.59836424683635  E_coul = 54.06588274341393
cycle= 1 E= -128.532481503422  delta_E= -5.68e-13  |g|= 1.32e-06  |ddm|= 9.55e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59836424683635  E_coul = 54.06588274341393
  HOMO = -0.845519854209127  LUMO = 0.805542346736442
  mo_energy =
[-3.27695034e+01 -1.92723642e+00 -8.45519854e-01 -8.45519854e-01
 -8.45519854e-01  8.05542347e-01  1.08928588e+00  1.08928588e+00
  1.08928588e+00  4.54008425e+00  5.68929474e+00  5.68929474e+00
  5.68929474e+00  1.68264530e+01  2.40599121e+01  2.40599121e+01
  2.40599121e+01  5.37185794e+01  1.18880677e+02  1.18880677e+02
  1.18880677e+02  1.64564935e+02  5.30359122e+02  1.89623449e+03
  8.02296805e+03  4.77866998e+04]
E1 = -182.59835947216837  E_coul = 54.06587796874572
Extra cycle  E= -128.532481503423  delta_E= -2.27e-13  |g|= 6.5e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.29 sec
exp = [8.09028399e-01 2.44137941e+04 3.66145360e+03 8.33286877e+02
 2.35598199e+02 7.66898789e+01 1.18584485e+01 2.84490660e+01
 3.09277432e-01 2.04267612e+00 5.37664449e+00 3.68517136e+00
 1.24536826e+01 5.47658173e+01 3.30103547e-01 1.14385141e+00]
grad_E = [-1.08207469e-05 -9.81694054e-10  5.19864938e-08 -1.04872579e-06
  1.15623674e-05 -4.93006613e-05 -7.68203271e-06 -3.33430681e-05
 -3.63680611e-06  1.39297702e-06  3.03033225e-05  4.70834417e-06
  1.91057981e-05 -2.43306349e-06 -2.01131170e-05  1.39658427e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.809676300364       1
[INPUT] 0    0    [1    /1   ]  24413.7941468        1
[INPUT] 0    0    [1    /1   ]  3661.4535929         1
[INPUT] 0    0    [1    /1   ]  833.286932908        1
[INPUT] 0    0    [1    /1   ]  235.597653557        1
[INPUT] 0    0    [1    /1   ]  76.6921235425        1
[INPUT] 0    0    [1    /1   ]  11.8579377653        1
[INPUT] 0    0    [1    /1   ]  28.4477219292        1
[INPUT] 0    0    [1    /1   ]  0.309486151938       1
[INPUT] 0    0    [1    /1   ]  2.04372212024        1
[INPUT] 0    0    [1    /1   ]  5.37959984949        1
[INPUT] 1    0    [1    /1   ]  3.68469755332        1
[INPUT] 1    0    [1    /1   ]  12.4522947486        1
[INPUT] 1    0    [1    /1   ]  54.7660289546        1
[INPUT] 1    0    [1    /1   ]  0.330081760038       1
[INPUT] 1    0    [1    /1   ]  1.14372444142        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8096763003639533, 1.0]], [0, [24413.79414683493, 1.0]], [0, [3661.453592895943, 1.0]], [0, [833.2869329076473, 1.0]], [0, [235.59765355692124, 1.0]], [0, [76.69212354254127, 1.0]], [0, [11.857937765344342, 1.0]], [0, [28.44772192918012, 1.0]], [0, [0.30948615193813206, 1.0]], [0, [2.04372212023982, 1.0]], [0, [5.379599849487562, 1.0]], [1, [3.6846975533155537, 1.0]], [1, [12.452294748554351, 1.0]], [1, [54.76602895464848, 1.0]], [1, [0.33008176003811435, 1.0]], [1, [1.1437244414194907, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8096763]
bas 1, expnt(s) = [24413.79414683]
bas 2, expnt(s) = [3661.4535929]
bas 3, expnt(s) = [833.28693291]
bas 4, expnt(s) = [235.59765356]
bas 5, expnt(s) = [76.69212354]
bas 6, expnt(s) = [11.85793777]
bas 7, expnt(s) = [28.44772193]
bas 8, expnt(s) = [0.30948615]
bas 9, expnt(s) = [2.04372212]
bas 10, expnt(s) = [5.37959985]
bas 11, expnt(s) = [3.68469755]
bas 12, expnt(s) = [12.45229475]
bas 13, expnt(s) = [54.76602895]
bas 14, expnt(s) = [0.33008176]
bas 15, expnt(s) = [1.14372444]
CPU time:       302.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09676300e-01 2.15649569e+00 2.44137941e+04 4.93448102e+03
 3.66145359e+03 1.18920075e+03 8.33286933e+02 3.91841972e+02
 2.35597654e+02 1.51929897e+02 7.66921235e+01 6.54753904e+01
 1.18579378e+01 1.61443996e+01 2.84477219e+01 3.11207923e+01
 3.09486152e-01 1.04832499e+00 2.04372212e+00 4.31848493e+00
 5.37959985e+00 8.92436869e+00 3.68469755e+00 1.48931547e+01
 1.24522947e+01 6.82411179e+01 5.47660290e+01 4.34633760e+02
 3.30081760e-01 7.29896533e-01 1.14372444e+00 3.45053268e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998491833786673
cond(S) = 1361.7168971054557
E1 = -183.578273893743  E_coul = 55.07848426277552
init E= -128.499789630967
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.773945090568956  LUMO = 0.825428063339588
  mo_energy =
[-3.25554707e+01 -1.85291119e+00 -7.73945091e-01 -7.73945091e-01
 -7.73945091e-01  8.25428063e-01  1.11495736e+00  1.11495736e+00
  1.11495736e+00  4.60233987e+00  5.77581244e+00  5.77581244e+00
  5.77581244e+00  1.69524987e+01  2.42143563e+01  2.42143563e+01
  2.42143563e+01  5.39039606e+01  1.19091159e+02  1.19091159e+02
  1.19091159e+02  1.64791377e+02  5.30619499e+02  1.89652581e+03
  8.02328448e+03  4.77870318e+04]
E1 = -182.11117017044964  E_coul = 53.58204107322629
cycle= 1 E= -128.529129097223  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461454
diis-c [-0.21293943  1.        ]
  HOMO = -0.879612198935584  LUMO = 0.797199344559466
  mo_energy =
[-3.28740580e+01 -1.96317151e+00 -8.79612199e-01 -8.79612199e-01
 -8.79612199e-01  7.97199345e-01  1.07675760e+00  1.07675760e+00
  1.07675760e+00  4.51620788e+00  5.64689354e+00  5.64689354e+00
  5.64689354e+00  1.67806443e+01  2.39793939e+01  2.39793939e+01
  2.39793939e+01  5.36506403e+01  1.18770297e+02  1.18770297e+02
  1.18770297e+02  1.64478425e+02  5.30262980e+02  1.89613269e+03
  8.02286208e+03  4.77865905e+04]
E1 = -182.843242224744  E_coul = 54.311608017005945
cycle= 2 E= -128.531634207738  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.230741
diis-c [-0.0006917   0.33225617  0.66774383]
  HOMO = -0.845263192349967  LUMO = 0.806368550744194
  mo_energy =
[-3.27690709e+01 -1.92705941e+00 -8.45263192e-01 -8.45263192e-01
 -8.45263192e-01  8.06368551e-01  1.08924197e+00  1.08924197e+00
  1.08924197e+00  4.54404325e+00  5.68880748e+00  5.68880748e+00
  5.68880748e+00  1.68369656e+01  2.40569355e+01  2.40569355e+01
  2.40569355e+01  5.37345054e+01  1.18875310e+02  1.18875310e+02
  1.18875310e+02  1.64581254e+02  5.30376340e+02  1.89625140e+03
  8.02298328e+03  4.77867126e+04]
E1 = -182.59781342713788  E_coul = 54.06533193322835
cycle= 3 E= -128.53248149391  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000896005
diis-c [-1.49791188e-07 -2.23763507e-03 -9.79808205e-04  1.00321744e+00]
  HOMO = -0.845491007585577  LUMO = 0.806333284270843
  mo_energy =
[-3.27694588e+01 -1.92722150e+00 -8.45491008e-01 -8.45491008e-01
 -8.45491008e-01  8.06333284e-01  1.08919365e+00  1.08919365e+00
  1.08919365e+00  4.54391052e+00  5.68861221e+00  5.68861221e+00
  5.68861221e+00  1.68367222e+01  2.40566278e+01  2.40566278e+01
  2.40566278e+01  5.37341864e+01  1.18874910e+02  1.18874910e+02
  1.18874910e+02  1.64580865e+02  5.30375853e+02  1.89625080e+03
  8.02298259e+03  4.77867119e+04]
E1 = -182.59825511243847  E_coul = 54.06577359840229
cycle= 4 E= -128.532481514036  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134559
diis-c [-1.03307007e-09  3.22620706e-04  4.90304545e-04 -2.13697864e-01
  1.21288494e+00]
  HOMO = -0.845523662926224  LUMO = 0.806326243830274
  mo_energy =
[-3.27695124e+01 -1.92724143e+00 -8.45523663e-01 -8.45523663e-01
 -8.45523663e-01  8.06326244e-01  1.08917994e+00  1.08917994e+00
  1.08917994e+00  4.54388704e+00  5.68857609e+00  5.68857609e+00
  5.68857609e+00  1.68366816e+01  2.40565796e+01  2.40565796e+01
  2.40565796e+01  5.37341373e+01  1.18874856e+02  1.18874856e+02
  1.18874856e+02  1.64580811e+02  5.30375791e+02  1.89625073e+03
  8.02298252e+03  4.77867118e+04]
E1 = -182.5983607799472  E_coul = 54.06587926534907
cycle= 5 E= -128.532481514598  delta_E= -5.62e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5983607799472  E_coul = 54.06587926534907
  HOMO = -0.845519952532165  LUMO = 0.806327758801857
  mo_energy =
[-3.27695043e+01 -1.92723700e+00 -8.45519953e-01 -8.45519953e-01
 -8.45519953e-01  8.06327759e-01  1.08918150e+00  1.08918150e+00
  1.08918150e+00  4.54389066e+00  5.68858060e+00  5.68858060e+00
  5.68858060e+00  1.68366875e+01  2.40565865e+01  2.40565865e+01
  2.40565865e+01  5.37341446e+01  1.18874864e+02  1.18874864e+02
  1.18874864e+02  1.64580819e+02  5.30375799e+02  1.89625074e+03
  8.02298253e+03  4.77867118e+04]
E1 = -182.5983429539533  E_coul = 54.06586143935264
Extra cycle  E= -128.532481514601  delta_E= -2.53e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.09676300e-01 2.44137941e+04 3.66145359e+03 8.33286933e+02
 2.35597654e+02 7.66921235e+01 1.18579378e+01 2.84477219e+01
 3.09486152e-01 2.04372212e+00 5.37959985e+00 3.68469755e+00
 1.24522947e+01 5.47660290e+01 3.30081760e-01 1.14372444e+00]
E = -128.53248151460068
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.809676300364       1
[INPUT] 0    0    [1    /1   ]  24413.7941468        1
[INPUT] 0    0    [1    /1   ]  3661.4535929         1
[INPUT] 0    0    [1    /1   ]  833.286932908        1
[INPUT] 0    0    [1    /1   ]  235.597653557        1
[INPUT] 0    0    [1    /1   ]  76.6921235425        1
[INPUT] 0    0    [1    /1   ]  11.8579377653        1
[INPUT] 0    0    [1    /1   ]  28.4477219292        1
[INPUT] 0    0    [1    /1   ]  0.309486151938       1
[INPUT] 0    0    [1    /1   ]  2.04372212024        1
[INPUT] 0    0    [1    /1   ]  5.37959984949        1
[INPUT] 1    0    [1    /1   ]  3.68469755332        1
[INPUT] 1    0    [1    /1   ]  12.4522947486        1
[INPUT] 1    0    [1    /1   ]  54.7660289546        1
[INPUT] 1    0    [1    /1   ]  0.330081760038       1
[INPUT] 1    0    [1    /1   ]  1.14372444142        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8096763003639533, 1.0]], [0, [24413.79414683493, 1.0]], [0, [3661.453592895943, 1.0]], [0, [833.2869329076473, 1.0]], [0, [235.59765355692124, 1.0]], [0, [76.69212354254127, 1.0]], [0, [11.857937765344342, 1.0]], [0, [28.44772192918012, 1.0]], [0, [0.30948615193813206, 1.0]], [0, [2.04372212023982, 1.0]], [0, [5.379599849487562, 1.0]], [1, [3.6846975533155537, 1.0]], [1, [12.452294748554351, 1.0]], [1, [54.76602895464848, 1.0]], [1, [0.33008176003811435, 1.0]], [1, [1.1437244414194907, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8096763]
bas 1, expnt(s) = [24413.79414683]
bas 2, expnt(s) = [3661.4535929]
bas 3, expnt(s) = [833.28693291]
bas 4, expnt(s) = [235.59765356]
bas 5, expnt(s) = [76.69212354]
bas 6, expnt(s) = [11.85793777]
bas 7, expnt(s) = [28.44772193]
bas 8, expnt(s) = [0.30948615]
bas 9, expnt(s) = [2.04372212]
bas 10, expnt(s) = [5.37959985]
bas 11, expnt(s) = [3.68469755]
bas 12, expnt(s) = [12.45229475]
bas 13, expnt(s) = [54.76602895]
bas 14, expnt(s) = [0.33008176]
bas 15, expnt(s) = [1.14372444]
CPU time:       303.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.09676300e-01 2.15649569e+00 2.44137941e+04 4.93448102e+03
 3.66145359e+03 1.18920075e+03 8.33286933e+02 3.91841972e+02
 2.35597654e+02 1.51929897e+02 7.66921235e+01 6.54753904e+01
 1.18579378e+01 1.61443996e+01 2.84477219e+01 3.11207923e+01
 3.09486152e-01 1.04832499e+00 2.04372212e+00 4.31848493e+00
 5.37959985e+00 8.92436869e+00 3.68469755e+00 1.48931547e+01
 1.24522947e+01 6.82411179e+01 5.47660290e+01 4.34633760e+02
 3.30081760e-01 7.29896533e-01 1.14372444e+00 3.45053268e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998491833786673
cond(S) = 1361.7168971054557
E1 = -183.578273893743  E_coul = 55.07848426277552
init E= -128.499789630967
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945090568956  LUMO = 0.825428063339588
  mo_energy =
[-3.25554707e+01 -1.85291119e+00 -7.73945091e-01 -7.73945091e-01
 -7.73945091e-01  8.25428063e-01  1.11495736e+00  1.11495736e+00
  1.11495736e+00  4.60233987e+00  5.77581244e+00  5.77581244e+00
  5.77581244e+00  1.69524987e+01  2.42143563e+01  2.42143563e+01
  2.42143563e+01  5.39039606e+01  1.19091159e+02  1.19091159e+02
  1.19091159e+02  1.64791377e+02  5.30619499e+02  1.89652581e+03
  8.02328448e+03  4.77870318e+04]
E1 = -182.11117017044964  E_coul = 53.58204107322629
cycle= 1 E= -128.529129097223  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461454
diis-c [-0.21293943  1.        ]
  HOMO = -0.879612198935584  LUMO = 0.797199344559466
  mo_energy =
[-3.28740580e+01 -1.96317151e+00 -8.79612199e-01 -8.79612199e-01
 -8.79612199e-01  7.97199345e-01  1.07675760e+00  1.07675760e+00
  1.07675760e+00  4.51620788e+00  5.64689354e+00  5.64689354e+00
  5.64689354e+00  1.67806443e+01  2.39793939e+01  2.39793939e+01
  2.39793939e+01  5.36506403e+01  1.18770297e+02  1.18770297e+02
  1.18770297e+02  1.64478425e+02  5.30262980e+02  1.89613269e+03
  8.02286208e+03  4.77865905e+04]
E1 = -182.843242224744  E_coul = 54.311608017005945
cycle= 2 E= -128.531634207738  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230741
diis-c [-0.0006917   0.33225617  0.66774383]
  HOMO = -0.845263192349967  LUMO = 0.806368550744194
  mo_energy =
[-3.27690709e+01 -1.92705941e+00 -8.45263192e-01 -8.45263192e-01
 -8.45263192e-01  8.06368551e-01  1.08924197e+00  1.08924197e+00
  1.08924197e+00  4.54404325e+00  5.68880748e+00  5.68880748e+00
  5.68880748e+00  1.68369656e+01  2.40569355e+01  2.40569355e+01
  2.40569355e+01  5.37345054e+01  1.18875310e+02  1.18875310e+02
  1.18875310e+02  1.64581254e+02  5.30376340e+02  1.89625140e+03
  8.02298328e+03  4.77867126e+04]
E1 = -182.59781342713788  E_coul = 54.06533193322835
cycle= 3 E= -128.53248149391  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000896005
diis-c [-1.49791188e-07 -2.23763507e-03 -9.79808205e-04  1.00321744e+00]
  HOMO = -0.845491007585577  LUMO = 0.806333284270843
  mo_energy =
[-3.27694588e+01 -1.92722150e+00 -8.45491008e-01 -8.45491008e-01
 -8.45491008e-01  8.06333284e-01  1.08919365e+00  1.08919365e+00
  1.08919365e+00  4.54391052e+00  5.68861221e+00  5.68861221e+00
  5.68861221e+00  1.68367222e+01  2.40566278e+01  2.40566278e+01
  2.40566278e+01  5.37341864e+01  1.18874910e+02  1.18874910e+02
  1.18874910e+02  1.64580865e+02  5.30375853e+02  1.89625080e+03
  8.02298259e+03  4.77867119e+04]
E1 = -182.59825511243847  E_coul = 54.06577359840229
cycle= 4 E= -128.532481514036  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134559
diis-c [-1.03307007e-09  3.22620706e-04  4.90304545e-04 -2.13697864e-01
  1.21288494e+00]
  HOMO = -0.845523662926224  LUMO = 0.806326243830274
  mo_energy =
[-3.27695124e+01 -1.92724143e+00 -8.45523663e-01 -8.45523663e-01
 -8.45523663e-01  8.06326244e-01  1.08917994e+00  1.08917994e+00
  1.08917994e+00  4.54388704e+00  5.68857609e+00  5.68857609e+00
  5.68857609e+00  1.68366816e+01  2.40565796e+01  2.40565796e+01
  2.40565796e+01  5.37341373e+01  1.18874856e+02  1.18874856e+02
  1.18874856e+02  1.64580811e+02  5.30375791e+02  1.89625073e+03
  8.02298252e+03  4.77867118e+04]
E1 = -182.5983607799472  E_coul = 54.06587926534907
cycle= 5 E= -128.532481514598  delta_E= -5.62e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983607799472  E_coul = 54.06587926534907
  HOMO = -0.845519952532165  LUMO = 0.806327758801857
  mo_energy =
[-3.27695043e+01 -1.92723700e+00 -8.45519953e-01 -8.45519953e-01
 -8.45519953e-01  8.06327759e-01  1.08918150e+00  1.08918150e+00
  1.08918150e+00  4.54389066e+00  5.68858060e+00  5.68858060e+00
  5.68858060e+00  1.68366875e+01  2.40565865e+01  2.40565865e+01
  2.40565865e+01  5.37341446e+01  1.18874864e+02  1.18874864e+02
  1.18874864e+02  1.64580819e+02  5.30375799e+02  1.89625074e+03
  8.02298253e+03  4.77867118e+04]
E1 = -182.5983429539533  E_coul = 54.06586143935264
Extra cycle  E= -128.532481514601  delta_E= -2.53e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1361.7168971054557
E1 = -182.5983429539533  E_coul = 54.06586143935264
init E= -128.532481514601
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.845521199307335  LUMO = 0.806327496708489
  mo_energy =
[-3.27695082e+01 -1.92723819e+00 -8.45521199e-01 -8.45521199e-01
 -8.45521199e-01  8.06327497e-01  1.08918106e+00  1.08918106e+00
  1.08918106e+00  4.54388974e+00  5.68857908e+00  5.68857908e+00
  5.68857908e+00  1.68366855e+01  2.40565837e+01  2.40565837e+01
  2.40565837e+01  5.37341415e+01  1.18874860e+02  1.18874860e+02
  1.18874860e+02  1.64580815e+02  5.30375795e+02  1.89625074e+03
  8.02298252e+03  4.77867118e+04]
E1 = -182.59835256160784  E_coul = 54.065871047006674
cycle= 1 E= -128.532481514601  delta_E= -4.83e-13  |g|= 1.32e-06  |ddm|= 9.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59835256160784  E_coul = 54.065871047006674
  HOMO = -0.845520523909913  LUMO = 0.806327689295506
  mo_energy =
[-3.27695062e+01 -1.92723746e+00 -8.45520524e-01 -8.45520524e-01
 -8.45520524e-01  8.06327689e-01  1.08918131e+00  1.08918131e+00
  1.08918131e+00  4.54389030e+00  5.68857991e+00  5.68857991e+00
  5.68857991e+00  1.68366866e+01  2.40565852e+01  2.40565852e+01
  2.40565852e+01  5.37341432e+01  1.18874862e+02  1.18874862e+02
  1.18874862e+02  1.64580817e+02  5.30375797e+02  1.89625074e+03
  8.02298252e+03  4.77867118e+04]
E1 = -182.5983477880879  E_coul = 54.06586627348653
Extra cycle  E= -128.532481514601  delta_E= -1.99e-13  |g|= 6.5e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [8.09676300e-01 2.44137941e+04 3.66145359e+03 8.33286933e+02
 2.35597654e+02 7.66921235e+01 1.18579378e+01 2.84477219e+01
 3.09486152e-01 2.04372212e+00 5.37959985e+00 3.68469755e+00
 1.24522947e+01 5.47660290e+01 3.30081760e-01 1.14372444e+00]
grad_E = [-2.91350127e-06 -9.70918912e-10  5.14270946e-08 -1.03836046e-06
  1.14649416e-05 -4.89193258e-05 -8.07411623e-06 -3.37193367e-05
 -8.37681356e-06 -2.95368027e-07  3.07414016e-05  3.65039954e-06
  1.73550780e-05 -2.09651578e-06  4.67936187e-06  4.71000759e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.810177656418       1
[INPUT] 0    0    [1    /1   ]  24413.7941469        1
[INPUT] 0    0    [1    /1   ]  3661.45358973        1
[INPUT] 0    0    [1    /1   ]  833.286992859        1
[INPUT] 0    0    [1    /1   ]  235.597055517        1
[INPUT] 0    0    [1    /1   ]  76.6947074842        1
[INPUT] 0    0    [1    /1   ]  11.8566516503        1
[INPUT] 0    0    [1    /1   ]  28.4459091034        1
[INPUT] 0    0    [1    /1   ]  0.309657065019       1
[INPUT] 0    0    [1    /1   ]  2.04441333462        1
[INPUT] 0    0    [1    /1   ]  5.38158437297        1
[INPUT] 1    0    [1    /1   ]  3.68446833773        1
[INPUT] 1    0    [1    /1   ]  12.4517213191        1
[INPUT] 1    0    [1    /1   ]  54.766110394         1
[INPUT] 1    0    [1    /1   ]  0.330068838413       1
[INPUT] 1    0    [1    /1   ]  1.14365078612        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8101776564178428, 1.0]], [0, [24413.794146895456, 1.0]], [0, [3661.4535897340625, 1.0]], [0, [833.2869928591032, 1.0]], [0, [235.5970555168357, 1.0]], [0, [76.69470748416734, 1.0]], [0, [11.85665165033433, 1.0]], [0, [28.4459091033734, 1.0]], [0, [0.30965706501940915, 1.0]], [0, [2.0444133346187034, 1.0]], [0, [5.381584372973368, 1.0]], [1, [3.6844683377311966, 1.0]], [1, [12.4517213191174, 1.0]], [1, [54.76611039396025, 1.0]], [1, [0.3300688384134017, 1.0]], [1, [1.14365078612156, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81017766]
bas 1, expnt(s) = [24413.7941469]
bas 2, expnt(s) = [3661.45358973]
bas 3, expnt(s) = [833.28699286]
bas 4, expnt(s) = [235.59705552]
bas 5, expnt(s) = [76.69470748]
bas 6, expnt(s) = [11.85665165]
bas 7, expnt(s) = [28.4459091]
bas 8, expnt(s) = [0.30965707]
bas 9, expnt(s) = [2.04441333]
bas 10, expnt(s) = [5.38158437]
bas 11, expnt(s) = [3.68446834]
bas 12, expnt(s) = [12.45172132]
bas 13, expnt(s) = [54.76611039]
bas 14, expnt(s) = [0.33006884]
bas 15, expnt(s) = [1.14365079]
CPU time:       307.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.10177656e-01 2.15749710e+00 2.44137941e+04 4.93448102e+03
 3.66145359e+03 1.18920075e+03 8.33286993e+02 3.91841993e+02
 2.35597056e+02 1.51929608e+02 7.66947075e+01 6.54770449e+01
 1.18566517e+01 1.61430863e+01 2.84459091e+01 3.11193049e+01
 3.09657065e-01 1.04875916e+00 2.04441333e+00 4.31958031e+00
 5.38158437e+00 8.92683771e+00 3.68446834e+00 1.48919966e+01
 1.24517213e+01 6.82371898e+01 5.47661104e+01 4.34634568e+02
 3.30068838e-01 7.29860816e-01 1.14365079e+00 3.45025492e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99849218483957
cond(S) = 1363.4529513305476
E1 = -183.57827266119372  E_coul = 55.07848409152996
init E= -128.499788569664
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945114725515  LUMO = 0.826064636818246
  mo_energy =
[-3.25554707e+01 -1.85291119e+00 -7.73945115e-01 -7.73945115e-01
 -7.73945115e-01  8.26064637e-01  1.11489414e+00  1.11489414e+00
  1.11489414e+00  4.60520106e+00  5.77541945e+00  5.77541945e+00
  5.77541945e+00  1.69594995e+01  2.42127987e+01  2.42127987e+01
  2.42127987e+01  5.39127108e+01  1.19088586e+02  1.19088586e+02
  1.19088586e+02  1.64797907e+02  5.30626727e+02  1.89653348e+03
  8.02329139e+03  4.77870376e+04]
E1 = -182.11116045780213  E_coul = 53.582031401592765
cycle= 1 E= -128.529129056209  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461453
diis-c [-0.21293909  1.        ]
  HOMO = -0.87961278569225  LUMO = 0.797813746958091
  mo_energy =
[-3.28740602e+01 -1.96317235e+00 -8.79612786e-01 -8.79612786e-01
 -8.79612786e-01  7.97813747e-01  1.07669688e+00  1.07669688e+00
  1.07669688e+00  4.51903791e+00  5.64650552e+00  5.64650552e+00
  5.64650552e+00  1.67876272e+01  2.39778385e+01  2.39778385e+01
  2.39778385e+01  5.36593914e+01  1.18767722e+02  1.18767722e+02
  1.18767722e+02  1.64484955e+02  5.30270206e+02  1.89614037e+03
  8.02286899e+03  4.77865962e+04]
E1 = -182.84324049665196  E_coul = 54.31160629422779
cycle= 2 E= -128.531634202424  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230742
diis-c [-0.00069173  0.3322571   0.6677429 ]
  HOMO = -0.845263430504152  LUMO = 0.80699006120665
  mo_energy =
[-3.27690723e+01 -1.92705986e+00 -8.45263431e-01 -8.45263431e-01
 -8.45263431e-01  8.06990061e-01  1.08918048e+00  1.08918048e+00
  1.08918048e+00  4.54688356e+00  5.68841801e+00  5.68841801e+00
  5.68841801e+00  1.68439547e+01  2.40553795e+01  2.40553795e+01
  2.40553795e+01  5.37432563e+01  1.18872736e+02  1.18872736e+02
  1.18872736e+02  1.64587784e+02  5.30383566e+02  1.89625908e+03
  8.02299018e+03  4.77867184e+04]
E1 = -182.59780894350178  E_coul = 54.065327437256535
cycle= 3 E= -128.532481506245  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000895814
diis-c [-1.49672624e-07 -2.23734037e-03 -9.79817604e-04  1.00321716e+00]
  HOMO = -0.845491208471263  LUMO = 0.806954775772032
  mo_energy =
[-3.27694601e+01 -1.92722192e+00 -8.45491208e-01 -8.45491208e-01
 -8.45491208e-01  8.06954776e-01  1.08913218e+00  1.08913218e+00
  1.08913218e+00  4.54675080e+00  5.68822279e+00  5.68822279e+00
  5.68822279e+00  1.68437113e+01  2.40550719e+01  2.40550719e+01
  2.40550719e+01  5.37429373e+01  1.18872336e+02  1.18872336e+02
  1.18872336e+02  1.64587395e+02  5.30383079e+02  1.89625848e+03
  8.02298950e+03  4.77867176e+04]
E1 = -182.59825048216763  E_coul = 54.065768955805105
cycle= 4 E= -128.532481526363  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013455
diis-c [-1.03291991e-09  3.22541395e-04  4.90393855e-04 -2.13673503e-01
  1.21286057e+00]
  HOMO = -0.845523861757777  LUMO = 0.806947729746509
  mo_energy =
[-3.27695137e+01 -1.92724186e+00 -8.45523862e-01 -8.45523862e-01
 -8.45523862e-01  8.06947730e-01  1.08911847e+00  1.08911847e+00
  1.08911847e+00  4.54672732e+00  5.68818667e+00  5.68818667e+00
  5.68818667e+00  1.68436707e+01  2.40550237e+01  2.40550237e+01
  2.40550237e+01  5.37428883e+01  1.18872282e+02  1.18872282e+02
  1.18872282e+02  1.64587341e+02  5.30383018e+02  1.89625841e+03
  8.02298942e+03  4.77867176e+04]
E1 = -182.59835615998895  E_coul = 54.065874633064816
cycle= 5 E= -128.532481526924  delta_E= -5.62e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59835615998895  E_coul = 54.065874633064816
  HOMO = -0.845520151985223  LUMO = 0.806949245525541
  mo_energy =
[-3.27695056e+01 -1.92723742e+00 -8.45520152e-01 -8.45520152e-01
 -8.45520152e-01  8.06949246e-01  1.08912003e+00  1.08912003e+00
  1.08912003e+00  4.54673094e+00  5.68819118e+00  5.68819118e+00
  5.68819118e+00  1.68436766e+01  2.40550306e+01  2.40550306e+01
  2.40550306e+01  5.37428956e+01  1.18872290e+02  1.18872290e+02
  1.18872290e+02  1.64587349e+02  5.30383026e+02  1.89625842e+03
  8.02298943e+03  4.77867176e+04]
E1 = -182.59833833703917  E_coul = 54.065856810112045
Extra cycle  E= -128.532481526927  delta_E= -2.98e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.10177656e-01 2.44137941e+04 3.66145359e+03 8.33286993e+02
 2.35597056e+02 7.66947075e+01 1.18566517e+01 2.84459091e+01
 3.09657065e-01 2.04441333e+00 5.38158437e+00 3.68446834e+00
 1.24517213e+01 5.47661104e+01 3.30068838e-01 1.14365079e+00]
E = -128.5324815269271
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.810177656418       1
[INPUT] 0    0    [1    /1   ]  24413.7941469        1
[INPUT] 0    0    [1    /1   ]  3661.45358973        1
[INPUT] 0    0    [1    /1   ]  833.286992859        1
[INPUT] 0    0    [1    /1   ]  235.597055517        1
[INPUT] 0    0    [1    /1   ]  76.6947074842        1
[INPUT] 0    0    [1    /1   ]  11.8566516503        1
[INPUT] 0    0    [1    /1   ]  28.4459091034        1
[INPUT] 0    0    [1    /1   ]  0.309657065019       1
[INPUT] 0    0    [1    /1   ]  2.04441333462        1
[INPUT] 0    0    [1    /1   ]  5.38158437297        1
[INPUT] 1    0    [1    /1   ]  3.68446833773        1
[INPUT] 1    0    [1    /1   ]  12.4517213191        1
[INPUT] 1    0    [1    /1   ]  54.766110394         1
[INPUT] 1    0    [1    /1   ]  0.330068838413       1
[INPUT] 1    0    [1    /1   ]  1.14365078612        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8101776564178428, 1.0]], [0, [24413.794146895456, 1.0]], [0, [3661.4535897340625, 1.0]], [0, [833.2869928591032, 1.0]], [0, [235.5970555168357, 1.0]], [0, [76.69470748416734, 1.0]], [0, [11.85665165033433, 1.0]], [0, [28.4459091033734, 1.0]], [0, [0.30965706501940915, 1.0]], [0, [2.0444133346187034, 1.0]], [0, [5.381584372973368, 1.0]], [1, [3.6844683377311966, 1.0]], [1, [12.4517213191174, 1.0]], [1, [54.76611039396025, 1.0]], [1, [0.3300688384134017, 1.0]], [1, [1.14365078612156, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81017766]
bas 1, expnt(s) = [24413.7941469]
bas 2, expnt(s) = [3661.45358973]
bas 3, expnt(s) = [833.28699286]
bas 4, expnt(s) = [235.59705552]
bas 5, expnt(s) = [76.69470748]
bas 6, expnt(s) = [11.85665165]
bas 7, expnt(s) = [28.4459091]
bas 8, expnt(s) = [0.30965707]
bas 9, expnt(s) = [2.04441333]
bas 10, expnt(s) = [5.38158437]
bas 11, expnt(s) = [3.68446834]
bas 12, expnt(s) = [12.45172132]
bas 13, expnt(s) = [54.76611039]
bas 14, expnt(s) = [0.33006884]
bas 15, expnt(s) = [1.14365079]
CPU time:       308.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.10177656e-01 2.15749710e+00 2.44137941e+04 4.93448102e+03
 3.66145359e+03 1.18920075e+03 8.33286993e+02 3.91841993e+02
 2.35597056e+02 1.51929608e+02 7.66947075e+01 6.54770449e+01
 1.18566517e+01 1.61430863e+01 2.84459091e+01 3.11193049e+01
 3.09657065e-01 1.04875916e+00 2.04441333e+00 4.31958031e+00
 5.38158437e+00 8.92683771e+00 3.68446834e+00 1.48919966e+01
 1.24517213e+01 6.82371898e+01 5.47661104e+01 4.34634568e+02
 3.30068838e-01 7.29860816e-01 1.14365079e+00 3.45025492e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99849218483957
cond(S) = 1363.4529513305476
E1 = -183.57827266119372  E_coul = 55.07848409152996
init E= -128.499788569664
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945114725515  LUMO = 0.826064636818246
  mo_energy =
[-3.25554707e+01 -1.85291119e+00 -7.73945115e-01 -7.73945115e-01
 -7.73945115e-01  8.26064637e-01  1.11489414e+00  1.11489414e+00
  1.11489414e+00  4.60520106e+00  5.77541945e+00  5.77541945e+00
  5.77541945e+00  1.69594995e+01  2.42127987e+01  2.42127987e+01
  2.42127987e+01  5.39127108e+01  1.19088586e+02  1.19088586e+02
  1.19088586e+02  1.64797907e+02  5.30626727e+02  1.89653348e+03
  8.02329139e+03  4.77870376e+04]
E1 = -182.11116045780213  E_coul = 53.582031401592765
cycle= 1 E= -128.529129056209  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461453
diis-c [-0.21293909  1.        ]
  HOMO = -0.87961278569225  LUMO = 0.797813746958091
  mo_energy =
[-3.28740602e+01 -1.96317235e+00 -8.79612786e-01 -8.79612786e-01
 -8.79612786e-01  7.97813747e-01  1.07669688e+00  1.07669688e+00
  1.07669688e+00  4.51903791e+00  5.64650552e+00  5.64650552e+00
  5.64650552e+00  1.67876272e+01  2.39778385e+01  2.39778385e+01
  2.39778385e+01  5.36593914e+01  1.18767722e+02  1.18767722e+02
  1.18767722e+02  1.64484955e+02  5.30270206e+02  1.89614037e+03
  8.02286899e+03  4.77865962e+04]
E1 = -182.84324049665196  E_coul = 54.31160629422779
cycle= 2 E= -128.531634202424  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230742
diis-c [-0.00069173  0.3322571   0.6677429 ]
  HOMO = -0.845263430504152  LUMO = 0.80699006120665
  mo_energy =
[-3.27690723e+01 -1.92705986e+00 -8.45263431e-01 -8.45263431e-01
 -8.45263431e-01  8.06990061e-01  1.08918048e+00  1.08918048e+00
  1.08918048e+00  4.54688356e+00  5.68841801e+00  5.68841801e+00
  5.68841801e+00  1.68439547e+01  2.40553795e+01  2.40553795e+01
  2.40553795e+01  5.37432563e+01  1.18872736e+02  1.18872736e+02
  1.18872736e+02  1.64587784e+02  5.30383566e+02  1.89625908e+03
  8.02299018e+03  4.77867184e+04]
E1 = -182.59780894350178  E_coul = 54.065327437256535
cycle= 3 E= -128.532481506245  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000895814
diis-c [-1.49672624e-07 -2.23734037e-03 -9.79817604e-04  1.00321716e+00]
  HOMO = -0.845491208471263  LUMO = 0.806954775772032
  mo_energy =
[-3.27694601e+01 -1.92722192e+00 -8.45491208e-01 -8.45491208e-01
 -8.45491208e-01  8.06954776e-01  1.08913218e+00  1.08913218e+00
  1.08913218e+00  4.54675080e+00  5.68822279e+00  5.68822279e+00
  5.68822279e+00  1.68437113e+01  2.40550719e+01  2.40550719e+01
  2.40550719e+01  5.37429373e+01  1.18872336e+02  1.18872336e+02
  1.18872336e+02  1.64587395e+02  5.30383079e+02  1.89625848e+03
  8.02298950e+03  4.77867176e+04]
E1 = -182.59825048216763  E_coul = 54.065768955805105
cycle= 4 E= -128.532481526363  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013455
diis-c [-1.03291991e-09  3.22541395e-04  4.90393855e-04 -2.13673503e-01
  1.21286057e+00]
  HOMO = -0.845523861757777  LUMO = 0.806947729746509
  mo_energy =
[-3.27695137e+01 -1.92724186e+00 -8.45523862e-01 -8.45523862e-01
 -8.45523862e-01  8.06947730e-01  1.08911847e+00  1.08911847e+00
  1.08911847e+00  4.54672732e+00  5.68818667e+00  5.68818667e+00
  5.68818667e+00  1.68436707e+01  2.40550237e+01  2.40550237e+01
  2.40550237e+01  5.37428883e+01  1.18872282e+02  1.18872282e+02
  1.18872282e+02  1.64587341e+02  5.30383018e+02  1.89625841e+03
  8.02298942e+03  4.77867176e+04]
E1 = -182.59835615998895  E_coul = 54.065874633064816
cycle= 5 E= -128.532481526924  delta_E= -5.62e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59835615998895  E_coul = 54.065874633064816
  HOMO = -0.845520151985223  LUMO = 0.806949245525541
  mo_energy =
[-3.27695056e+01 -1.92723742e+00 -8.45520152e-01 -8.45520152e-01
 -8.45520152e-01  8.06949246e-01  1.08912003e+00  1.08912003e+00
  1.08912003e+00  4.54673094e+00  5.68819118e+00  5.68819118e+00
  5.68819118e+00  1.68436766e+01  2.40550306e+01  2.40550306e+01
  2.40550306e+01  5.37428956e+01  1.18872290e+02  1.18872290e+02
  1.18872290e+02  1.64587349e+02  5.30383026e+02  1.89625842e+03
  8.02298943e+03  4.77867176e+04]
E1 = -182.59833833703917  E_coul = 54.065856810112045
Extra cycle  E= -128.532481526927  delta_E= -2.98e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1363.4529513305476
E1 = -182.59833833703917  E_coul = 54.065856810112045
init E= -128.532481526927
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845521398549586  LUMO = 0.806948983267509
  mo_energy =
[-3.27695095e+01 -1.92723862e+00 -8.45521399e-01 -8.45521399e-01
 -8.45521399e-01  8.06948983e-01  1.08911960e+00  1.08911960e+00
  1.08911960e+00  4.54673002e+00  5.68818967e+00  5.68818967e+00
  5.68818967e+00  1.68436746e+01  2.40550277e+01  2.40550277e+01
  2.40550277e+01  5.37428925e+01  1.18872286e+02  1.18872286e+02
  1.18872286e+02  1.64587345e+02  5.30383021e+02  1.89625842e+03
  8.02298943e+03  4.77867176e+04]
E1 = -182.59834794312408  E_coul = 54.06586641619626
cycle= 1 E= -128.532481526928  delta_E= -7.11e-13  |g|= 1.32e-06  |ddm|= 9.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59834794312408  E_coul = 54.06586641619626
  HOMO = -0.845520723262669  LUMO = 0.806949175969674
  mo_energy =
[-3.27695075e+01 -1.92723788e+00 -8.45520723e-01 -8.45520723e-01
 -8.45520723e-01  8.06949176e-01  1.08911984e+00  1.08911984e+00
  1.08911984e+00  4.54673058e+00  5.68819049e+00  5.68819049e+00
  5.68819049e+00  1.68436757e+01  2.40550292e+01  2.40550292e+01
  2.40550292e+01  5.37428941e+01  1.18872288e+02  1.18872288e+02
  1.18872288e+02  1.64587347e+02  5.30383023e+02  1.89625842e+03
  8.02298943e+03  4.77867176e+04]
E1 = -182.59834317038337  E_coul = 54.06586164345602
Extra cycle  E= -128.532481526927  delta_E= 4.55e-13  |g|= 6.5e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [8.10177656e-01 2.44137941e+04 3.66145359e+03 8.33286993e+02
 2.35597056e+02 7.66947075e+01 1.18566517e+01 2.84459091e+01
 3.09657065e-01 2.04441333e+00 5.38158437e+00 3.68446834e+00
 1.24517213e+01 5.47661104e+01 3.30068838e-01 1.14365079e+00]
grad_E = [ 4.20130598e-06 -9.58079158e-10  5.07601607e-08 -1.02596890e-06
  1.13475494e-05 -4.84481221e-05 -8.31576223e-06 -3.42618631e-05
 -1.20881357e-05 -2.04200213e-06  3.11068508e-05  4.38966478e-06
  1.68029550e-05 -1.96861314e-06  2.75513926e-05 -8.68961921e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.810987044793       1
[INPUT] 0    0    [1    /1   ]  24413.794147         1
[INPUT] 0    0    [1    /1   ]  3661.45358346        1
[INPUT] 0    0    [1    /1   ]  833.28711182         1
[INPUT] 0    0    [1    /1   ]  235.595871152        1
[INPUT] 0    0    [1    /1   ]  76.6996819684        1
[INPUT] 0    0    [1    /1   ]  11.8549672872        1
[INPUT] 0    0    [1    /1   ]  28.4435092322        1
[INPUT] 0    0    [1    /1   ]  0.30992327341        1
[INPUT] 0    0    [1    /1   ]  2.04564014337        1
[INPUT] 0    0    [1    /1   ]  5.38583618607        1
[INPUT] 1    0    [1    /1   ]  3.68421291001        1
[INPUT] 1    0    [1    /1   ]  12.4512034373        1
[INPUT] 1    0    [1    /1   ]  54.7661621631        1
[INPUT] 1    0    [1    /1   ]  0.330050166733       1
[INPUT] 1    0    [1    /1   ]  1.14355122983        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.810987044793061, 1.0]], [0, [24413.794147015436, 1.0]], [0, [3661.4535834634885, 1.0]], [0, [833.2871118204273, 1.0]], [0, [235.59587115178843, 1.0]], [0, [76.69968196842416, 1.0]], [0, [11.854967287150208, 1.0]], [0, [28.443509232176215, 1.0]], [0, [0.30992327341040654, 1.0]], [0, [2.0456401433682156, 1.0]], [0, [5.385836186066109, 1.0]], [1, [3.68421291000951, 1.0]], [1, [12.451203437329713, 1.0]], [1, [54.76616216307943, 1.0]], [1, [0.3300501667328071, 1.0]], [1, [1.1435512298260024, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81098704]
bas 1, expnt(s) = [24413.79414702]
bas 2, expnt(s) = [3661.45358346]
bas 3, expnt(s) = [833.28711182]
bas 4, expnt(s) = [235.59587115]
bas 5, expnt(s) = [76.69968197]
bas 6, expnt(s) = [11.85496729]
bas 7, expnt(s) = [28.44350923]
bas 8, expnt(s) = [0.30992327]
bas 9, expnt(s) = [2.04564014]
bas 10, expnt(s) = [5.38583619]
bas 11, expnt(s) = [3.68421291]
bas 12, expnt(s) = [12.45120344]
bas 13, expnt(s) = [54.76616216]
bas 14, expnt(s) = [0.33005017]
bas 15, expnt(s) = [1.14355123]
CPU time:       311.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.10987045e-01 2.15911344e+00 2.44137941e+04 4.93448102e+03
 3.66145358e+03 1.18920075e+03 8.33287112e+02 3.91842035e+02
 2.35595871e+02 1.51929035e+02 7.66996820e+01 6.54802301e+01
 1.18549673e+01 1.61413663e+01 2.84435092e+01 3.11173358e+01
 3.09923273e-01 1.04943530e+00 2.04564014e+00 4.32152423e+00
 5.38583619e+00 8.93212679e+00 3.68421291e+00 1.48907061e+01
 1.24512034e+01 6.82336422e+01 5.47661622e+01 4.34635082e+02
 3.30050167e-01 7.29809207e-01 1.14355123e+00 3.44987949e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998492668745165
cond(S) = 1366.4982172780258
E1 = -183.57827069377413  E_coul = 55.07848368234579
init E= -128.499787011428
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945180333033  LUMO = 0.827081581275139
  mo_energy =
[-3.25554708e+01 -1.85291121e+00 -7.73945180e-01 -7.73945180e-01
 -7.73945180e-01  8.27081581e-01  1.11480495e+00  1.11480495e+00
  1.11480495e+00  4.60998289e+00  5.77491582e+00  5.77491582e+00
  5.77491582e+00  1.69724909e+01  2.42111176e+01  2.42111176e+01
  2.42111176e+01  5.39314567e+01  1.19085985e+02  1.19085985e+02
  1.19085985e+02  1.64815948e+02  5.30647939e+02  1.89655547e+03
  8.02331114e+03  4.77870540e+04]
E1 = -182.1111464489221  E_coul = 53.58201744303475
cycle= 1 E= -128.529129005887  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461451
diis-c [-0.21293747  1.        ]
  HOMO = -0.879613660958681  LUMO = 0.798794944250019
  mo_energy =
[-3.28740634e+01 -1.96317360e+00 -8.79613661e-01 -8.79613661e-01
 -8.79613661e-01  7.98794944e-01  1.07661114e+00  1.07661114e+00
  1.07661114e+00  4.52376418e+00  5.64600755e+00  5.64600755e+00
  5.64600755e+00  1.68005794e+01  2.39761584e+01  2.39761584e+01
  2.39761584e+01  5.36781347e+01  1.18765117e+02  1.18765117e+02
  1.18765117e+02  1.64502996e+02  5.30291416e+02  1.89616234e+03
  8.02288874e+03  4.77866127e+04]
E1 = -182.84323848508484  E_coul = 54.311604278472366
cycle= 2 E= -128.531634206612  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230742
diis-c [-0.00069182  0.33225846  0.66774154]
  HOMO = -0.84526378205893  LUMO = 0.80798274240607
  mo_energy =
[-3.27690741e+01 -1.92706052e+00 -8.45263782e-01 -8.45263782e-01
 -8.45263782e-01  8.07982742e-01  1.08909370e+00  1.08909370e+00
  1.08909370e+00  4.55162815e+00  5.68791849e+00  5.68791849e+00
  5.68791849e+00  1.68569202e+01  2.40536993e+01  2.40536993e+01
  2.40536993e+01  5.37620007e+01  1.18870132e+02  1.18870132e+02
  1.18870132e+02  1.64605825e+02  5.30404778e+02  1.89628106e+03
  8.02300994e+03  4.77867348e+04]
E1 = -182.59780295631003  E_coul = 54.06532141984206
cycle= 3 E= -128.532481536468  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000895506
diis-c [-1.49491653e-07 -2.23692570e-03 -9.79973097e-04  1.00321690e+00]
  HOMO = -0.84549149304439  LUMO = 0.807947431375394
  mo_energy =
[-3.27694618e+01 -1.92722253e+00 -8.45491493e-01 -8.45491493e-01
 -8.45491493e-01  8.07947431e-01  1.08904545e+00  1.08904545e+00
  1.08904545e+00  4.55149537e+00  5.68772336e+00  5.68772336e+00
  5.68772336e+00  1.68566769e+01  2.40533918e+01  2.40533918e+01
  2.40533918e+01  5.37616818e+01  1.18869733e+02  1.18869733e+02
  1.18869733e+02  1.64605437e+02  5.30404291e+02  1.89628046e+03
  8.02300925e+03  4.77867341e+04]
E1 = -182.59824425678627  E_coul = 54.06576270021485
cycle= 4 E= -128.532481556571  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134537
diis-c [-1.03269037e-09  3.22423842e-04  4.90563188e-04 -2.13637714e-01
  1.21282473e+00]
  HOMO = -0.845524142454239  LUMO = 0.807940377058574
  mo_energy =
[-3.27695153e+01 -1.92724247e+00 -8.45524142e-01 -8.45524142e-01
 -8.45524142e-01  8.07940377e-01  1.08903174e+00  1.08903174e+00
  1.08903174e+00  4.55147187e+00  5.68768724e+00  5.68768724e+00
  5.68768724e+00  1.68566364e+01  2.40533436e+01  2.40533436e+01
  2.40533436e+01  5.37616328e+01  1.18869679e+02  1.18869679e+02
  1.18869679e+02  1.64605382e+02  5.30404229e+02  1.89628039e+03
  8.02300917e+03  4.77867340e+04]
E1 = -182.59834995402247  E_coul = 54.065868396889876
cycle= 5 E= -128.532481557133  delta_E= -5.61e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59834995402247  E_coul = 54.065868396889876
  HOMO = -0.845520433651504  LUMO = 0.807941894142641
  mo_energy =
[-3.27695072e+01 -1.92723803e+00 -8.45520434e-01 -8.45520434e-01
 -8.45520434e-01  8.07941894e-01  1.08903330e+00  1.08903330e+00
  1.08903330e+00  4.55147549e+00  5.68769175e+00  5.68769175e+00
  5.68769175e+00  1.68566422e+01  2.40533506e+01  2.40533506e+01
  2.40533506e+01  5.37616401e+01  1.18869687e+02  1.18869687e+02
  1.18869687e+02  1.64605390e+02  5.30404237e+02  1.89628040e+03
  8.02300918e+03  4.77867340e+04]
E1 = -182.59833213559972  E_coul = 54.06585057846488
Extra cycle  E= -128.532481557135  delta_E= -2.25e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.10987045e-01 2.44137941e+04 3.66145358e+03 8.33287112e+02
 2.35595871e+02 7.66996820e+01 1.18549673e+01 2.84435092e+01
 3.09923273e-01 2.04564014e+00 5.38583619e+00 3.68421291e+00
 1.24512034e+01 5.47661622e+01 3.30050167e-01 1.14355123e+00]
E = -128.53248155713484
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.810987044793       1
[INPUT] 0    0    [1    /1   ]  24413.794147         1
[INPUT] 0    0    [1    /1   ]  3661.45358346        1
[INPUT] 0    0    [1    /1   ]  833.28711182         1
[INPUT] 0    0    [1    /1   ]  235.595871152        1
[INPUT] 0    0    [1    /1   ]  76.6996819684        1
[INPUT] 0    0    [1    /1   ]  11.8549672872        1
[INPUT] 0    0    [1    /1   ]  28.4435092322        1
[INPUT] 0    0    [1    /1   ]  0.30992327341        1
[INPUT] 0    0    [1    /1   ]  2.04564014337        1
[INPUT] 0    0    [1    /1   ]  5.38583618607        1
[INPUT] 1    0    [1    /1   ]  3.68421291001        1
[INPUT] 1    0    [1    /1   ]  12.4512034373        1
[INPUT] 1    0    [1    /1   ]  54.7661621631        1
[INPUT] 1    0    [1    /1   ]  0.330050166733       1
[INPUT] 1    0    [1    /1   ]  1.14355122983        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.810987044793061, 1.0]], [0, [24413.794147015436, 1.0]], [0, [3661.4535834634885, 1.0]], [0, [833.2871118204273, 1.0]], [0, [235.59587115178843, 1.0]], [0, [76.69968196842416, 1.0]], [0, [11.854967287150208, 1.0]], [0, [28.443509232176215, 1.0]], [0, [0.30992327341040654, 1.0]], [0, [2.0456401433682156, 1.0]], [0, [5.385836186066109, 1.0]], [1, [3.68421291000951, 1.0]], [1, [12.451203437329713, 1.0]], [1, [54.76616216307943, 1.0]], [1, [0.3300501667328071, 1.0]], [1, [1.1435512298260024, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81098704]
bas 1, expnt(s) = [24413.79414702]
bas 2, expnt(s) = [3661.45358346]
bas 3, expnt(s) = [833.28711182]
bas 4, expnt(s) = [235.59587115]
bas 5, expnt(s) = [76.69968197]
bas 6, expnt(s) = [11.85496729]
bas 7, expnt(s) = [28.44350923]
bas 8, expnt(s) = [0.30992327]
bas 9, expnt(s) = [2.04564014]
bas 10, expnt(s) = [5.38583619]
bas 11, expnt(s) = [3.68421291]
bas 12, expnt(s) = [12.45120344]
bas 13, expnt(s) = [54.76616216]
bas 14, expnt(s) = [0.33005017]
bas 15, expnt(s) = [1.14355123]
CPU time:       312.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.10987045e-01 2.15911344e+00 2.44137941e+04 4.93448102e+03
 3.66145358e+03 1.18920075e+03 8.33287112e+02 3.91842035e+02
 2.35595871e+02 1.51929035e+02 7.66996820e+01 6.54802301e+01
 1.18549673e+01 1.61413663e+01 2.84435092e+01 3.11173358e+01
 3.09923273e-01 1.04943530e+00 2.04564014e+00 4.32152423e+00
 5.38583619e+00 8.93212679e+00 3.68421291e+00 1.48907061e+01
 1.24512034e+01 6.82336422e+01 5.47661622e+01 4.34635082e+02
 3.30050167e-01 7.29809207e-01 1.14355123e+00 3.44987949e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998492668745165
cond(S) = 1366.4982172780258
E1 = -183.57827069377413  E_coul = 55.07848368234579
init E= -128.499787011428
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945180333033  LUMO = 0.827081581275139
  mo_energy =
[-3.25554708e+01 -1.85291121e+00 -7.73945180e-01 -7.73945180e-01
 -7.73945180e-01  8.27081581e-01  1.11480495e+00  1.11480495e+00
  1.11480495e+00  4.60998289e+00  5.77491582e+00  5.77491582e+00
  5.77491582e+00  1.69724909e+01  2.42111176e+01  2.42111176e+01
  2.42111176e+01  5.39314567e+01  1.19085985e+02  1.19085985e+02
  1.19085985e+02  1.64815948e+02  5.30647939e+02  1.89655547e+03
  8.02331114e+03  4.77870540e+04]
E1 = -182.1111464489221  E_coul = 53.58201744303475
cycle= 1 E= -128.529129005887  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461451
diis-c [-0.21293747  1.        ]
  HOMO = -0.879613660958681  LUMO = 0.798794944250019
  mo_energy =
[-3.28740634e+01 -1.96317360e+00 -8.79613661e-01 -8.79613661e-01
 -8.79613661e-01  7.98794944e-01  1.07661114e+00  1.07661114e+00
  1.07661114e+00  4.52376418e+00  5.64600755e+00  5.64600755e+00
  5.64600755e+00  1.68005794e+01  2.39761584e+01  2.39761584e+01
  2.39761584e+01  5.36781347e+01  1.18765117e+02  1.18765117e+02
  1.18765117e+02  1.64502996e+02  5.30291416e+02  1.89616234e+03
  8.02288874e+03  4.77866127e+04]
E1 = -182.84323848508484  E_coul = 54.311604278472366
cycle= 2 E= -128.531634206612  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230742
diis-c [-0.00069182  0.33225846  0.66774154]
  HOMO = -0.84526378205893  LUMO = 0.80798274240607
  mo_energy =
[-3.27690741e+01 -1.92706052e+00 -8.45263782e-01 -8.45263782e-01
 -8.45263782e-01  8.07982742e-01  1.08909370e+00  1.08909370e+00
  1.08909370e+00  4.55162815e+00  5.68791849e+00  5.68791849e+00
  5.68791849e+00  1.68569202e+01  2.40536993e+01  2.40536993e+01
  2.40536993e+01  5.37620007e+01  1.18870132e+02  1.18870132e+02
  1.18870132e+02  1.64605825e+02  5.30404778e+02  1.89628106e+03
  8.02300994e+03  4.77867348e+04]
E1 = -182.59780295631003  E_coul = 54.06532141984206
cycle= 3 E= -128.532481536468  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000895506
diis-c [-1.49491653e-07 -2.23692570e-03 -9.79973097e-04  1.00321690e+00]
  HOMO = -0.84549149304439  LUMO = 0.807947431375394
  mo_energy =
[-3.27694618e+01 -1.92722253e+00 -8.45491493e-01 -8.45491493e-01
 -8.45491493e-01  8.07947431e-01  1.08904545e+00  1.08904545e+00
  1.08904545e+00  4.55149537e+00  5.68772336e+00  5.68772336e+00
  5.68772336e+00  1.68566769e+01  2.40533918e+01  2.40533918e+01
  2.40533918e+01  5.37616818e+01  1.18869733e+02  1.18869733e+02
  1.18869733e+02  1.64605437e+02  5.30404291e+02  1.89628046e+03
  8.02300925e+03  4.77867341e+04]
E1 = -182.59824425678627  E_coul = 54.06576270021485
cycle= 4 E= -128.532481556571  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134537
diis-c [-1.03269037e-09  3.22423842e-04  4.90563188e-04 -2.13637714e-01
  1.21282473e+00]
  HOMO = -0.845524142454239  LUMO = 0.807940377058574
  mo_energy =
[-3.27695153e+01 -1.92724247e+00 -8.45524142e-01 -8.45524142e-01
 -8.45524142e-01  8.07940377e-01  1.08903174e+00  1.08903174e+00
  1.08903174e+00  4.55147187e+00  5.68768724e+00  5.68768724e+00
  5.68768724e+00  1.68566364e+01  2.40533436e+01  2.40533436e+01
  2.40533436e+01  5.37616328e+01  1.18869679e+02  1.18869679e+02
  1.18869679e+02  1.64605382e+02  5.30404229e+02  1.89628039e+03
  8.02300917e+03  4.77867340e+04]
E1 = -182.59834995402247  E_coul = 54.065868396889876
cycle= 5 E= -128.532481557133  delta_E= -5.61e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59834995402247  E_coul = 54.065868396889876
  HOMO = -0.845520433651504  LUMO = 0.807941894142641
  mo_energy =
[-3.27695072e+01 -1.92723803e+00 -8.45520434e-01 -8.45520434e-01
 -8.45520434e-01  8.07941894e-01  1.08903330e+00  1.08903330e+00
  1.08903330e+00  4.55147549e+00  5.68769175e+00  5.68769175e+00
  5.68769175e+00  1.68566422e+01  2.40533506e+01  2.40533506e+01
  2.40533506e+01  5.37616401e+01  1.18869687e+02  1.18869687e+02
  1.18869687e+02  1.64605390e+02  5.30404237e+02  1.89628040e+03
  8.02300918e+03  4.77867340e+04]
E1 = -182.59833213559972  E_coul = 54.06585057846488
Extra cycle  E= -128.532481557135  delta_E= -2.25e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1366.4982172780258
E1 = -182.59833213559972  E_coul = 54.06585057846488
init E= -128.532481557135
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845521679903657  LUMO = 0.807941631608998
  mo_energy =
[-3.27695112e+01 -1.92723922e+00 -8.45521680e-01 -8.45521680e-01
 -8.45521680e-01  8.07941632e-01  1.08903287e+00  1.08903287e+00
  1.08903287e+00  4.55147457e+00  5.68769023e+00  5.68769023e+00
  5.68769023e+00  1.68566402e+01  2.40533477e+01  2.40533477e+01
  2.40533477e+01  5.37616370e+01  1.18869683e+02  1.18869683e+02
  1.18869683e+02  1.64605386e+02  5.30404233e+02  1.89628039e+03
  8.02300918e+03  4.77867340e+04]
E1 = -182.59834173931026  E_coul = 54.065860182174845
cycle= 1 E= -128.532481557135  delta_E= -5.68e-13  |g|= 1.32e-06  |ddm|= 9.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59834173931026  E_coul = 54.065860182174845
  HOMO = -0.845521004784236  LUMO = 0.807941824499772
  mo_energy =
[-3.27695092e+01 -1.92723849e+00 -8.45521005e-01 -8.45521005e-01
 -8.45521005e-01  8.07941824e-01  1.08903311e+00  1.08903311e+00
  1.08903311e+00  4.55147513e+00  5.68769106e+00  5.68769106e+00
  5.68769106e+00  1.68566413e+01  2.40533492e+01  2.40533492e+01
  2.40533492e+01  5.37616386e+01  1.18869685e+02  1.18869685e+02
  1.18869685e+02  1.64605388e+02  5.30404235e+02  1.89628040e+03
  8.02300918e+03  4.77867340e+04]
E1 = -182.59833696774263  E_coul = 54.065855410606865
Extra cycle  E= -128.532481557136  delta_E= -3.41e-13  |g|= 6.49e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [8.10987045e-01 2.44137941e+04 3.66145358e+03 8.33287112e+02
 2.35595871e+02 7.66996820e+01 1.18549673e+01 2.84435092e+01
 3.09923273e-01 2.04564014e+00 5.38583619e+00 3.68421291e+00
 1.24512034e+01 5.47661622e+01 3.30050167e-01 1.14355123e+00]
grad_E = [ 1.38057446e-05 -9.36229373e-10  4.96268999e-08 -1.00504899e-06
  1.11534869e-05 -4.77128413e-05 -9.09497882e-06 -3.49323288e-05
 -1.72073190e-05 -4.14213429e-06  3.19251811e-05  7.12166229e-06
  1.65100548e-05 -1.86838595e-06  6.36001823e-05 -3.48734966e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.81210886408        1
[INPUT] 0    0    [1    /1   ]  24413.7941472        1
[INPUT] 0    0    [1    /1   ]  3661.45357355        1
[INPUT] 0    0    [1    /1   ]  833.287300713        1
[INPUT] 0    0    [1    /1   ]  235.593974312        1
[INPUT] 0    0    [1    /1   ]  76.7077015918        1
[INPUT] 0    0    [1    /1   ]  11.8521387463        1
[INPUT] 0    0    [1    /1   ]  28.4401284233        1
[INPUT] 0    0    [1    /1   ]  0.310297116342       1
[INPUT] 0    0    [1    /1   ]  2.04727611192        1
[INPUT] 0    0    [1    /1   ]  5.3913798141         1
[INPUT] 1    0    [1    /1   ]  3.68394930035        1
[INPUT] 1    0    [1    /1   ]  12.4508139429        1
[INPUT] 1    0    [1    /1   ]  54.7661711349        1
[INPUT] 1    0    [1    /1   ]  0.330025775052       1
[INPUT] 1    0    [1    /1   ]  1.14342758196        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.812108864080253, 1.0]], [0, [24413.794147204924, 1.0]], [0, [3661.4535735519344, 1.0]], [0, [833.287300712578, 1.0]], [0, [235.59397431170314, 1.0]], [0, [76.70770159180123, 1.0]], [0, [11.85213874631852, 1.0]], [0, [28.440128423252293, 1.0]], [0, [0.31029711634154583, 1.0]], [0, [2.0472761119184963, 1.0]], [0, [5.391379814104131, 1.0]], [1, [3.683949300350182, 1.0]], [1, [12.450813942927937, 1.0]], [1, [54.76617113492636, 1.0]], [1, [0.33002577505159075, 1.0]], [1, [1.1434275819555861, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81210886]
bas 1, expnt(s) = [24413.7941472]
bas 2, expnt(s) = [3661.45357355]
bas 3, expnt(s) = [833.28730071]
bas 4, expnt(s) = [235.59397431]
bas 5, expnt(s) = [76.70770159]
bas 6, expnt(s) = [11.85213875]
bas 7, expnt(s) = [28.44012842]
bas 8, expnt(s) = [0.31029712]
bas 9, expnt(s) = [2.04727611]
bas 10, expnt(s) = [5.39137981]
bas 11, expnt(s) = [3.6839493]
bas 12, expnt(s) = [12.45081394]
bas 13, expnt(s) = [54.76617113]
bas 14, expnt(s) = [0.33002578]
bas 15, expnt(s) = [1.14342758]
CPU time:       316.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12108864e-01 2.16135305e+00 2.44137941e+04 4.93448102e+03
 3.66145357e+03 1.18920075e+03 8.33287301e+02 3.91842101e+02
 2.35593974e+02 1.51928118e+02 7.67077016e+01 6.54853649e+01
 1.18521387e+01 1.61384778e+01 2.84401284e+01 3.11145618e+01
 3.10297116e-01 1.05038456e+00 2.04727611e+00 4.32411603e+00
 5.39137981e+00 8.93902127e+00 3.68394930e+00 1.48893743e+01
 1.24508139e+01 6.82309741e+01 5.47661711e+01 4.34635171e+02
 3.30025775e-01 7.29741789e-01 1.14342758e+00 3.44941321e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998493277454024
cond(S) = 1370.6456874902406
E1 = -183.57826744757506  E_coul = 55.07848295773385
init E= -128.499784489841
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945296741568  LUMO = 0.828497437136218
  mo_energy =
[-3.25554709e+01 -1.85291128e+00 -7.73945297e-01 -7.73945297e-01
 -7.73945297e-01  8.28497437e-01  1.11469046e+00  1.11469046e+00
  1.11469046e+00  4.61653522e+00  5.77431741e+00  5.77431741e+00
  5.77431741e+00  1.69897646e+01  2.42094481e+01  2.42094481e+01
  2.42094481e+01  5.39552291e+01  1.19083622e+02  1.19083622e+02
  1.19083622e+02  1.64838303e+02  5.30676332e+02  1.89658585e+03
  8.02333858e+03  4.77870769e+04]
E1 = -182.11112852864076  E_coul = 53.58199955979669
cycle= 1 E= -128.529128968844  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461449
diis-c [-0.21293521  1.        ]
  HOMO = -0.879614793459837  LUMO = 0.8001613642978
  mo_energy =
[-3.28740673e+01 -1.96317524e+00 -8.79614793e-01 -8.79614793e-01
 -8.79614793e-01  8.00161364e-01  1.07650101e+00  1.07650101e+00
  1.07650101e+00  4.53024211e+00  5.64541521e+00  5.64541521e+00
  5.64541521e+00  1.68178036e+01  2.39744883e+01  2.39744883e+01
  2.39744883e+01  5.37019059e+01  1.18762751e+02  1.18762751e+02
  1.18762751e+02  1.64525351e+02  5.30319805e+02  1.89619273e+03
  8.02291617e+03  4.77866355e+04]
E1 = -182.8432364395877  E_coul = 54.311602196893126
cycle= 2 E= -128.531634242695  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230743
diis-c [-0.00069194  0.33226015  0.66773985]
  HOMO = -0.845264217382041  LUMO = 0.809365063717764
  mo_energy =
[-3.27690763e+01 -1.92706137e+00 -8.45264217e-01 -8.45264217e-01
 -8.45264217e-01  8.09365064e-01  1.08898229e+00  1.08898229e+00
  1.08898229e+00  4.55813065e+00  5.68732460e+00  5.68732460e+00
  5.68732460e+00  1.68741614e+01  2.40520298e+01  2.40520298e+01
  2.40520298e+01  5.37857725e+01  1.18867767e+02  1.18867767e+02
  1.18867767e+02  1.64628181e+02  5.30433168e+02  1.89631145e+03
  8.02303737e+03  4.77867576e+04]
E1 = -182.59779574914631  E_coul = 54.06531414253988
cycle= 3 E= -128.532481606606  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000895104
diis-c [-1.49244961e-07 -2.23638340e-03 -9.80144402e-04  1.00321653e+00]
  HOMO = -0.845491835711585  LUMO = 0.809329718617894
  mo_energy =
[-3.27694638e+01 -1.92722330e+00 -8.45491836e-01 -8.45491836e-01
 -8.45491836e-01  8.09329719e-01  1.08893409e+00  1.08893409e+00
  1.08893409e+00  4.55799782e+00  5.68712958e+00  5.68712958e+00
  5.68712958e+00  1.68739182e+01  2.40517224e+01  2.40517224e+01
  2.40517224e+01  5.37854538e+01  1.18867368e+02  1.18867368e+02
  1.18867368e+02  1.64627792e+02  5.30432682e+02  1.89631085e+03
  8.02303669e+03  4.77867569e+04]
E1 = -182.59823675266065  E_coul = 54.06575512597105
cycle= 4 E= -128.53248162669  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134519
diis-c [-1.03235782e-09  3.22267843e-04  4.90780002e-04 -2.13588556e-01
  1.21277551e+00]
  HOMO = -0.84552447911293  LUMO = 0.809322653203555
  mo_energy =
[-3.27695174e+01 -1.92724324e+00 -8.45524479e-01 -8.45524479e-01
 -8.45524479e-01  8.09322653e-01  1.08892039e+00  1.08892039e+00
  1.08892039e+00  4.55797431e+00  5.68709347e+00  5.68709347e+00
  5.68709347e+00  1.68738776e+01  2.40516742e+01  2.40516742e+01
  2.40516742e+01  5.37854048e+01  1.18867314e+02  1.18867314e+02
  1.18867314e+02  1.64627738e+02  5.30432620e+02  1.89631078e+03
  8.02303661e+03  4.77867568e+04]
E1 = -182.5983424766442  E_coul = 54.06586084939395
cycle= 5 E= -128.53248162725  delta_E= -5.61e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983424766442  E_coul = 54.06586084939395
  HOMO = -0.845520771638473  LUMO = 0.809324172084414
  mo_energy =
[-3.27695093e+01 -1.92723881e+00 -8.45520772e-01 -8.45520772e-01
 -8.45520772e-01  8.09324172e-01  1.08892194e+00  1.08892194e+00
  1.08892194e+00  4.55797793e+00  5.68709798e+00  5.68709798e+00
  5.68709798e+00  1.68738834e+01  2.40516811e+01  2.40516811e+01
  2.40516811e+01  5.37854121e+01  1.18867322e+02  1.18867322e+02
  1.18867322e+02  1.64627746e+02  5.30432628e+02  1.89631079e+03
  8.02303662e+03  4.77867568e+04]
E1 = -182.5983246641605  E_coul = 54.06584303690745
Extra cycle  E= -128.532481627253  delta_E= -2.79e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.12108864e-01 2.44137941e+04 3.66145357e+03 8.33287301e+02
 2.35593974e+02 7.67077016e+01 1.18521387e+01 2.84401284e+01
 3.10297116e-01 2.04727611e+00 5.39137981e+00 3.68394930e+00
 1.24508139e+01 5.47661711e+01 3.30025775e-01 1.14342758e+00]
E = -128.53248162725305
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.81210886408        1
[INPUT] 0    0    [1    /1   ]  24413.7941472        1
[INPUT] 0    0    [1    /1   ]  3661.45357355        1
[INPUT] 0    0    [1    /1   ]  833.287300713        1
[INPUT] 0    0    [1    /1   ]  235.593974312        1
[INPUT] 0    0    [1    /1   ]  76.7077015918        1
[INPUT] 0    0    [1    /1   ]  11.8521387463        1
[INPUT] 0    0    [1    /1   ]  28.4401284233        1
[INPUT] 0    0    [1    /1   ]  0.310297116342       1
[INPUT] 0    0    [1    /1   ]  2.04727611192        1
[INPUT] 0    0    [1    /1   ]  5.3913798141         1
[INPUT] 1    0    [1    /1   ]  3.68394930035        1
[INPUT] 1    0    [1    /1   ]  12.4508139429        1
[INPUT] 1    0    [1    /1   ]  54.7661711349        1
[INPUT] 1    0    [1    /1   ]  0.330025775052       1
[INPUT] 1    0    [1    /1   ]  1.14342758196        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.812108864080253, 1.0]], [0, [24413.794147204924, 1.0]], [0, [3661.4535735519344, 1.0]], [0, [833.287300712578, 1.0]], [0, [235.59397431170314, 1.0]], [0, [76.70770159180123, 1.0]], [0, [11.85213874631852, 1.0]], [0, [28.440128423252293, 1.0]], [0, [0.31029711634154583, 1.0]], [0, [2.0472761119184963, 1.0]], [0, [5.391379814104131, 1.0]], [1, [3.683949300350182, 1.0]], [1, [12.450813942927937, 1.0]], [1, [54.76617113492636, 1.0]], [1, [0.33002577505159075, 1.0]], [1, [1.1434275819555861, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81210886]
bas 1, expnt(s) = [24413.7941472]
bas 2, expnt(s) = [3661.45357355]
bas 3, expnt(s) = [833.28730071]
bas 4, expnt(s) = [235.59397431]
bas 5, expnt(s) = [76.70770159]
bas 6, expnt(s) = [11.85213875]
bas 7, expnt(s) = [28.44012842]
bas 8, expnt(s) = [0.31029712]
bas 9, expnt(s) = [2.04727611]
bas 10, expnt(s) = [5.39137981]
bas 11, expnt(s) = [3.6839493]
bas 12, expnt(s) = [12.45081394]
bas 13, expnt(s) = [54.76617113]
bas 14, expnt(s) = [0.33002578]
bas 15, expnt(s) = [1.14342758]
CPU time:       317.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12108864e-01 2.16135305e+00 2.44137941e+04 4.93448102e+03
 3.66145357e+03 1.18920075e+03 8.33287301e+02 3.91842101e+02
 2.35593974e+02 1.51928118e+02 7.67077016e+01 6.54853649e+01
 1.18521387e+01 1.61384778e+01 2.84401284e+01 3.11145618e+01
 3.10297116e-01 1.05038456e+00 2.04727611e+00 4.32411603e+00
 5.39137981e+00 8.93902127e+00 3.68394930e+00 1.48893743e+01
 1.24508139e+01 6.82309741e+01 5.47661711e+01 4.34635171e+02
 3.30025775e-01 7.29741789e-01 1.14342758e+00 3.44941321e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998493277454024
cond(S) = 1370.6456874902406
E1 = -183.57826744757506  E_coul = 55.07848295773385
init E= -128.499784489841
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945296741568  LUMO = 0.828497437136218
  mo_energy =
[-3.25554709e+01 -1.85291128e+00 -7.73945297e-01 -7.73945297e-01
 -7.73945297e-01  8.28497437e-01  1.11469046e+00  1.11469046e+00
  1.11469046e+00  4.61653522e+00  5.77431741e+00  5.77431741e+00
  5.77431741e+00  1.69897646e+01  2.42094481e+01  2.42094481e+01
  2.42094481e+01  5.39552291e+01  1.19083622e+02  1.19083622e+02
  1.19083622e+02  1.64838303e+02  5.30676332e+02  1.89658585e+03
  8.02333858e+03  4.77870769e+04]
E1 = -182.11112852864076  E_coul = 53.58199955979669
cycle= 1 E= -128.529128968844  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461449
diis-c [-0.21293521  1.        ]
  HOMO = -0.879614793459837  LUMO = 0.8001613642978
  mo_energy =
[-3.28740673e+01 -1.96317524e+00 -8.79614793e-01 -8.79614793e-01
 -8.79614793e-01  8.00161364e-01  1.07650101e+00  1.07650101e+00
  1.07650101e+00  4.53024211e+00  5.64541521e+00  5.64541521e+00
  5.64541521e+00  1.68178036e+01  2.39744883e+01  2.39744883e+01
  2.39744883e+01  5.37019059e+01  1.18762751e+02  1.18762751e+02
  1.18762751e+02  1.64525351e+02  5.30319805e+02  1.89619273e+03
  8.02291617e+03  4.77866355e+04]
E1 = -182.8432364395877  E_coul = 54.311602196893126
cycle= 2 E= -128.531634242695  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230743
diis-c [-0.00069194  0.33226015  0.66773985]
  HOMO = -0.845264217382041  LUMO = 0.809365063717764
  mo_energy =
[-3.27690763e+01 -1.92706137e+00 -8.45264217e-01 -8.45264217e-01
 -8.45264217e-01  8.09365064e-01  1.08898229e+00  1.08898229e+00
  1.08898229e+00  4.55813065e+00  5.68732460e+00  5.68732460e+00
  5.68732460e+00  1.68741614e+01  2.40520298e+01  2.40520298e+01
  2.40520298e+01  5.37857725e+01  1.18867767e+02  1.18867767e+02
  1.18867767e+02  1.64628181e+02  5.30433168e+02  1.89631145e+03
  8.02303737e+03  4.77867576e+04]
E1 = -182.59779574914631  E_coul = 54.06531414253988
cycle= 3 E= -128.532481606606  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000895104
diis-c [-1.49244961e-07 -2.23638340e-03 -9.80144402e-04  1.00321653e+00]
  HOMO = -0.845491835711585  LUMO = 0.809329718617894
  mo_energy =
[-3.27694638e+01 -1.92722330e+00 -8.45491836e-01 -8.45491836e-01
 -8.45491836e-01  8.09329719e-01  1.08893409e+00  1.08893409e+00
  1.08893409e+00  4.55799782e+00  5.68712958e+00  5.68712958e+00
  5.68712958e+00  1.68739182e+01  2.40517224e+01  2.40517224e+01
  2.40517224e+01  5.37854538e+01  1.18867368e+02  1.18867368e+02
  1.18867368e+02  1.64627792e+02  5.30432682e+02  1.89631085e+03
  8.02303669e+03  4.77867569e+04]
E1 = -182.59823675266065  E_coul = 54.06575512597105
cycle= 4 E= -128.53248162669  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134519
diis-c [-1.03235782e-09  3.22267843e-04  4.90780002e-04 -2.13588556e-01
  1.21277551e+00]
  HOMO = -0.84552447911293  LUMO = 0.809322653203555
  mo_energy =
[-3.27695174e+01 -1.92724324e+00 -8.45524479e-01 -8.45524479e-01
 -8.45524479e-01  8.09322653e-01  1.08892039e+00  1.08892039e+00
  1.08892039e+00  4.55797431e+00  5.68709347e+00  5.68709347e+00
  5.68709347e+00  1.68738776e+01  2.40516742e+01  2.40516742e+01
  2.40516742e+01  5.37854048e+01  1.18867314e+02  1.18867314e+02
  1.18867314e+02  1.64627738e+02  5.30432620e+02  1.89631078e+03
  8.02303661e+03  4.77867568e+04]
E1 = -182.5983424766442  E_coul = 54.06586084939395
cycle= 5 E= -128.53248162725  delta_E= -5.61e-10  |g|= 6.77e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983424766442  E_coul = 54.06586084939395
  HOMO = -0.845520771638473  LUMO = 0.809324172084414
  mo_energy =
[-3.27695093e+01 -1.92723881e+00 -8.45520772e-01 -8.45520772e-01
 -8.45520772e-01  8.09324172e-01  1.08892194e+00  1.08892194e+00
  1.08892194e+00  4.55797793e+00  5.68709798e+00  5.68709798e+00
  5.68709798e+00  1.68738834e+01  2.40516811e+01  2.40516811e+01
  2.40516811e+01  5.37854121e+01  1.18867322e+02  1.18867322e+02
  1.18867322e+02  1.64627746e+02  5.30432628e+02  1.89631079e+03
  8.02303662e+03  4.77867568e+04]
E1 = -182.5983246641605  E_coul = 54.06584303690745
Extra cycle  E= -128.532481627253  delta_E= -2.79e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1370.6456874902406
E1 = -182.5983246641605  E_coul = 54.06584303690745
init E= -128.532481627253
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845522017482346  LUMO = 0.809323909161341
  mo_energy =
[-3.27695132e+01 -1.92724000e+00 -8.45522017e-01 -8.45522017e-01
 -8.45522017e-01  8.09323909e-01  1.08892151e+00  1.08892151e+00
  1.08892151e+00  4.55797701e+00  5.68709646e+00  5.68709646e+00
  5.68709646e+00  1.68738814e+01  2.40516783e+01  2.40516783e+01
  2.40516783e+01  5.37854090e+01  1.18867318e+02  1.18867318e+02
  1.18867318e+02  1.64627742e+02  5.30432623e+02  1.89631078e+03
  8.02303661e+03  4.77867568e+04]
E1 = -182.5983342647251  E_coul = 54.06585263747163
cycle= 1 E= -128.532481627253  delta_E= -4.26e-13  |g|= 1.32e-06  |ddm|= 9.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5983342647251  E_coul = 54.06585263747163
  HOMO = -0.845521342585143  LUMO = 0.809324102315569
  mo_energy =
[-3.27695112e+01 -1.92723926e+00 -8.45521343e-01 -8.45521343e-01
 -8.45521343e-01  8.09324102e-01  1.08892176e+00  1.08892176e+00
  1.08892176e+00  4.55797757e+00  5.68709729e+00  5.68709729e+00
  5.68709729e+00  1.68738825e+01  2.40516798e+01  2.40516798e+01
  2.40516798e+01  5.37854106e+01  1.18867320e+02  1.18867320e+02
  1.18867320e+02  1.64627744e+02  5.30432626e+02  1.89631079e+03
  8.02303662e+03  4.77867568e+04]
E1 = -182.59832949471044  E_coul = 54.06584786745669
Extra cycle  E= -128.532481627254  delta_E= -2.84e-13  |g|= 6.49e-07  |ddm|= 4.66e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [8.12108864e-01 2.44137941e+04 3.66145357e+03 8.33287301e+02
 2.35593974e+02 7.67077016e+01 1.18521387e+01 2.84401284e+01
 3.10297116e-01 2.04727611e+00 5.39137981e+00 3.68394930e+00
 1.24508139e+01 5.47661711e+01 3.30025775e-01 1.14342758e+00]
grad_E = [ 2.75040439e-05 -9.02171688e-10  4.78611911e-08 -9.72491799e-07
  1.08527679e-05 -4.65811054e-05 -1.01660482e-05 -3.59817495e-05
 -2.41518967e-05 -7.24390595e-06  3.30653643e-05  1.22365412e-05
  1.65939067e-05 -1.81549990e-06  1.13420190e-04 -7.54382855e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.813968241445       1
[INPUT] 0    0    [1    /1   ]  24413.7941476        1
[INPUT] 0    0    [1    /1   ]  3661.45355464        1
[INPUT] 0    0    [1    /1   ]  833.287662247        1
[INPUT] 0    0    [1    /1   ]  235.590330571        1
[INPUT] 0    0    [1    /1   ]  76.7228841484        1
[INPUT] 0    0    [1    /1   ]  11.8486686028        1
[INPUT] 0    0    [1    /1   ]  28.4364256051        1
[INPUT] 0    0    [1    /1   ]  0.310907316167       1
[INPUT] 0    0    [1    /1   ]  2.0501065112         1
[INPUT] 0    0    [1    /1   ]  5.40149747413        1
[INPUT] 1    0    [1    /1   ]  3.68358146215        1
[INPUT] 1    0    [1    /1   ]  12.450392396         1
[INPUT] 1    0    [1    /1   ]  54.7661140959        1
[INPUT] 1    0    [1    /1   ]  0.329986307565       1
[INPUT] 1    0    [1    /1   ]  1.14323526009        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8139682414447738, 1.0]], [0, [24413.79414756625, 1.0]], [0, [3661.4535546370507, 1.0]], [0, [833.2876622471638, 1.0]], [0, [235.59033057082996, 1.0]], [0, [76.7228841484116, 1.0]], [0, [11.848668602755962, 1.0]], [0, [28.436425605086452, 1.0]], [0, [0.31090731616683237, 1.0]], [0, [2.0501065112047856, 1.0]], [0, [5.4014974741328965, 1.0]], [1, [3.6835814621537977, 1.0]], [1, [12.4503923959578, 1.0]], [1, [54.76611409585894, 1.0]], [1, [0.3299863075646307, 1.0]], [1, [1.1432352600933042, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81396824]
bas 1, expnt(s) = [24413.79414757]
bas 2, expnt(s) = [3661.45355464]
bas 3, expnt(s) = [833.28766225]
bas 4, expnt(s) = [235.59033057]
bas 5, expnt(s) = [76.72288415]
bas 6, expnt(s) = [11.8486686]
bas 7, expnt(s) = [28.43642561]
bas 8, expnt(s) = [0.31090732]
bas 9, expnt(s) = [2.05010651]
bas 10, expnt(s) = [5.40149747]
bas 11, expnt(s) = [3.68358146]
bas 12, expnt(s) = [12.4503924]
bas 13, expnt(s) = [54.7661141]
bas 14, expnt(s) = [0.32998631]
bas 15, expnt(s) = [1.14323526]
CPU time:       320.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.13968241e-01 2.16506341e+00 2.44137941e+04 4.93448102e+03
 3.66145355e+03 1.18920074e+03 8.33287662e+02 3.91842229e+02
 2.35590331e+02 1.51926356e+02 7.67228841e+01 6.54950857e+01
 1.18486686e+01 1.61349338e+01 2.84364256e+01 3.11115235e+01
 3.10907316e-01 1.05193337e+00 2.05010651e+00 4.32859888e+00
 5.40149747e+00 8.95159979e+00 3.68358146e+00 1.48875160e+01
 1.24503924e+01 6.82280865e+01 5.47661141e+01 4.34634605e+02
 3.29986308e-01 7.29632704e-01 1.14323526e+00 3.44868800e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998494235493347
cond(S) = 1377.6378177180297
E1 = -183.57826197803456  E_coul = 55.07848165393417
init E= -128.4997803241
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945506989677  LUMO = 0.830836335897614
  mo_energy =
[-3.25554710e+01 -1.85291141e+00 -7.73945507e-01 -7.73945507e-01
 -7.73945507e-01  8.30836336e-01  1.11450767e+00  1.11450767e+00
  1.11450767e+00  4.62757093e+00  5.77340603e+00  5.77340603e+00
  5.77340603e+00  1.70202062e+01  2.42071627e+01  2.42071627e+01
  2.42071627e+01  5.40010135e+01  1.19080538e+02  1.19080538e+02
  1.19080538e+02  1.64888940e+02  5.30742978e+02  1.89665652e+03
  8.02340239e+03  4.77871300e+04]
E1 = -182.11109810290932  E_coul = 53.58196912876665
cycle= 1 E= -128.529128974143  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461444
diis-c [-0.21293072  1.        ]
  HOMO = -0.879616779760701  LUMO = 0.802418177467598
  mo_energy =
[-3.28740739e+01 -1.96317806e+00 -8.79616780e-01 -8.79616780e-01
 -8.79616780e-01  8.02418177e-01  1.07632503e+00  1.07632503e+00
  1.07632503e+00  4.54114890e+00  5.64451226e+00  5.64451226e+00
  5.64451226e+00  1.68481509e+01  2.39722003e+01  2.39722003e+01
  2.39722003e+01  5.37476806e+01  1.18759660e+02  1.18759660e+02
  1.18759660e+02  1.64575986e+02  5.30386446e+02  1.89626339e+03
  8.02297997e+03  4.77866887e+04]
E1 = -182.84323258182192  E_coul = 54.31159821089693
cycle= 2 E= -128.531634370925  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230744
diis-c [-0.00069217  0.33226293  0.66773707]
  HOMO = -0.845265036752526  LUMO = 0.811648280892763
  mo_energy =
[-3.27690798e+01 -1.92706285e+00 -8.45265037e-01 -8.45265037e-01
 -8.45265037e-01  8.11648281e-01  1.08880432e+00  1.08880432e+00
  1.08880432e+00  4.56907998e+00  5.68641959e+00  5.68641959e+00
  5.68641959e+00  1.69045410e+01  2.40497433e+01  2.40497433e+01
  2.40497433e+01  5.38315511e+01  1.18864680e+02  1.18864680e+02
  1.18864680e+02  1.64678817e+02  5.30499812e+02  1.89638211e+03
  8.02310117e+03  4.77868108e+04]
E1 = -182.59778325498505  E_coul = 54.06530146304488
cycle= 3 E= -128.53248179194  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000894451
diis-c [-1.48839260e-07 -2.23552207e-03 -9.80446778e-04  1.00321597e+00]
  HOMO = -0.845492501403141  LUMO = 0.81161288026877
  mo_energy =
[-3.27694671e+01 -1.92722466e+00 -8.45492501e-01 -8.45492501e-01
 -8.45492501e-01  8.11612880e-01  1.08875621e+00  1.08875621e+00
  1.08875621e+00  4.56894707e+00  5.68622477e+00  5.68622477e+00
  5.68622477e+00  1.69042978e+01  2.40494361e+01  2.40494361e+01
  2.40494361e+01  5.38312326e+01  1.18864281e+02  1.18864281e+02
  1.18864281e+02  1.64678428e+02  5.30499325e+02  1.89638151e+03
  8.02310049e+03  4.77868101e+04]
E1 = -182.59822377854422  E_coul = 54.06574196655387
cycle= 4 E= -128.53248181199  delta_E= -2.01e-08  |g|= 6.45e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134491
diis-c [-1.03179543e-09  3.22010114e-04  4.91144532e-04 -2.13505696e-01
  1.21269254e+00]
  HOMO = -0.845525134654156  LUMO = 0.811605796657431
  mo_energy =
[-3.27695207e+01 -1.92724460e+00 -8.45525135e-01 -8.45525135e-01
 -8.45525135e-01  8.11605797e-01  1.08874252e+00  1.08874252e+00
  1.08874252e+00  4.56892353e+00  5.68618868e+00  5.68618868e+00
  5.68618868e+00  1.69042572e+01  2.40493879e+01  2.40493879e+01
  2.40493879e+01  5.38311836e+01  1.18864227e+02  1.18864227e+02
  1.18864227e+02  1.64678374e+02  5.30499264e+02  1.89638144e+03
  8.02310041e+03  4.77868100e+04]
E1 = -182.59832954914145  E_coul = 54.06584773659156
cycle= 5 E= -128.53248181255  delta_E= -5.6e-10  |g|= 6.77e-06  |ddm|= 5.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59832954914145  E_coul = 54.06584773659156
  HOMO = -0.845521429437544  LUMO = 0.811607318501679
  mo_energy =
[-3.27695126e+01 -1.92724017e+00 -8.45521429e-01 -8.45521429e-01
 -8.45521429e-01  8.11607319e-01  1.08874407e+00  1.08874407e+00
  1.08874407e+00  4.56892716e+00  5.68619318e+00  5.68619318e+00
  5.68619318e+00  1.69042631e+01  2.40493949e+01  2.40493949e+01
  2.40493949e+01  5.38311909e+01  1.18864235e+02  1.18864235e+02
  1.18864235e+02  1.64678382e+02  5.30499272e+02  1.89638145e+03
  8.02310042e+03  4.77868100e+04]
E1 = -182.59831174665436  E_coul = 54.06582993410183
Extra cycle  E= -128.532481812553  delta_E= -2.64e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.13968241e-01 2.44137941e+04 3.66145355e+03 8.33287662e+02
 2.35590331e+02 7.67228841e+01 1.18486686e+01 2.84364256e+01
 3.10907316e-01 2.05010651e+00 5.40149747e+00 3.68358146e+00
 1.24503924e+01 5.47661141e+01 3.29986308e-01 1.14323526e+00]
E = -128.53248181255253
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.813968241445       1
[INPUT] 0    0    [1    /1   ]  24413.7941476        1
[INPUT] 0    0    [1    /1   ]  3661.45355464        1
[INPUT] 0    0    [1    /1   ]  833.287662247        1
[INPUT] 0    0    [1    /1   ]  235.590330571        1
[INPUT] 0    0    [1    /1   ]  76.7228841484        1
[INPUT] 0    0    [1    /1   ]  11.8486686028        1
[INPUT] 0    0    [1    /1   ]  28.4364256051        1
[INPUT] 0    0    [1    /1   ]  0.310907316167       1
[INPUT] 0    0    [1    /1   ]  2.0501065112         1
[INPUT] 0    0    [1    /1   ]  5.40149747413        1
[INPUT] 1    0    [1    /1   ]  3.68358146215        1
[INPUT] 1    0    [1    /1   ]  12.450392396         1
[INPUT] 1    0    [1    /1   ]  54.7661140959        1
[INPUT] 1    0    [1    /1   ]  0.329986307565       1
[INPUT] 1    0    [1    /1   ]  1.14323526009        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8139682414447738, 1.0]], [0, [24413.79414756625, 1.0]], [0, [3661.4535546370507, 1.0]], [0, [833.2876622471638, 1.0]], [0, [235.59033057082996, 1.0]], [0, [76.7228841484116, 1.0]], [0, [11.848668602755962, 1.0]], [0, [28.436425605086452, 1.0]], [0, [0.31090731616683237, 1.0]], [0, [2.0501065112047856, 1.0]], [0, [5.4014974741328965, 1.0]], [1, [3.6835814621537977, 1.0]], [1, [12.4503923959578, 1.0]], [1, [54.76611409585894, 1.0]], [1, [0.3299863075646307, 1.0]], [1, [1.1432352600933042, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81396824]
bas 1, expnt(s) = [24413.79414757]
bas 2, expnt(s) = [3661.45355464]
bas 3, expnt(s) = [833.28766225]
bas 4, expnt(s) = [235.59033057]
bas 5, expnt(s) = [76.72288415]
bas 6, expnt(s) = [11.8486686]
bas 7, expnt(s) = [28.43642561]
bas 8, expnt(s) = [0.31090732]
bas 9, expnt(s) = [2.05010651]
bas 10, expnt(s) = [5.40149747]
bas 11, expnt(s) = [3.68358146]
bas 12, expnt(s) = [12.4503924]
bas 13, expnt(s) = [54.7661141]
bas 14, expnt(s) = [0.32998631]
bas 15, expnt(s) = [1.14323526]
CPU time:       321.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.13968241e-01 2.16506341e+00 2.44137941e+04 4.93448102e+03
 3.66145355e+03 1.18920074e+03 8.33287662e+02 3.91842229e+02
 2.35590331e+02 1.51926356e+02 7.67228841e+01 6.54950857e+01
 1.18486686e+01 1.61349338e+01 2.84364256e+01 3.11115235e+01
 3.10907316e-01 1.05193337e+00 2.05010651e+00 4.32859888e+00
 5.40149747e+00 8.95159979e+00 3.68358146e+00 1.48875160e+01
 1.24503924e+01 6.82280865e+01 5.47661141e+01 4.34634605e+02
 3.29986308e-01 7.29632704e-01 1.14323526e+00 3.44868800e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998494235493347
cond(S) = 1377.6378177180297
E1 = -183.57826197803456  E_coul = 55.07848165393417
init E= -128.4997803241
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773945506989677  LUMO = 0.830836335897614
  mo_energy =
[-3.25554710e+01 -1.85291141e+00 -7.73945507e-01 -7.73945507e-01
 -7.73945507e-01  8.30836336e-01  1.11450767e+00  1.11450767e+00
  1.11450767e+00  4.62757093e+00  5.77340603e+00  5.77340603e+00
  5.77340603e+00  1.70202062e+01  2.42071627e+01  2.42071627e+01
  2.42071627e+01  5.40010135e+01  1.19080538e+02  1.19080538e+02
  1.19080538e+02  1.64888940e+02  5.30742978e+02  1.89665652e+03
  8.02340239e+03  4.77871300e+04]
E1 = -182.11109810290932  E_coul = 53.58196912876665
cycle= 1 E= -128.529128974143  delta_E= -0.0293  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461444
diis-c [-0.21293072  1.        ]
  HOMO = -0.879616779760701  LUMO = 0.802418177467598
  mo_energy =
[-3.28740739e+01 -1.96317806e+00 -8.79616780e-01 -8.79616780e-01
 -8.79616780e-01  8.02418177e-01  1.07632503e+00  1.07632503e+00
  1.07632503e+00  4.54114890e+00  5.64451226e+00  5.64451226e+00
  5.64451226e+00  1.68481509e+01  2.39722003e+01  2.39722003e+01
  2.39722003e+01  5.37476806e+01  1.18759660e+02  1.18759660e+02
  1.18759660e+02  1.64575986e+02  5.30386446e+02  1.89626339e+03
  8.02297997e+03  4.77866887e+04]
E1 = -182.84323258182192  E_coul = 54.31159821089693
cycle= 2 E= -128.531634370925  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230744
diis-c [-0.00069217  0.33226293  0.66773707]
  HOMO = -0.845265036752526  LUMO = 0.811648280892763
  mo_energy =
[-3.27690798e+01 -1.92706285e+00 -8.45265037e-01 -8.45265037e-01
 -8.45265037e-01  8.11648281e-01  1.08880432e+00  1.08880432e+00
  1.08880432e+00  4.56907998e+00  5.68641959e+00  5.68641959e+00
  5.68641959e+00  1.69045410e+01  2.40497433e+01  2.40497433e+01
  2.40497433e+01  5.38315511e+01  1.18864680e+02  1.18864680e+02
  1.18864680e+02  1.64678817e+02  5.30499812e+02  1.89638211e+03
  8.02310117e+03  4.77868108e+04]
E1 = -182.59778325498505  E_coul = 54.06530146304488
cycle= 3 E= -128.53248179194  delta_E= -0.000847  |g|= 0.000452  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000894451
diis-c [-1.48839260e-07 -2.23552207e-03 -9.80446778e-04  1.00321597e+00]
  HOMO = -0.845492501403141  LUMO = 0.81161288026877
  mo_energy =
[-3.27694671e+01 -1.92722466e+00 -8.45492501e-01 -8.45492501e-01
 -8.45492501e-01  8.11612880e-01  1.08875621e+00  1.08875621e+00
  1.08875621e+00  4.56894707e+00  5.68622477e+00  5.68622477e+00
  5.68622477e+00  1.69042978e+01  2.40494361e+01  2.40494361e+01
  2.40494361e+01  5.38312326e+01  1.18864281e+02  1.18864281e+02
  1.18864281e+02  1.64678428e+02  5.30499325e+02  1.89638151e+03
  8.02310049e+03  4.77868101e+04]
E1 = -182.59822377854422  E_coul = 54.06574196655387
cycle= 4 E= -128.53248181199  delta_E= -2.01e-08  |g|= 6.45e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134491
diis-c [-1.03179543e-09  3.22010114e-04  4.91144532e-04 -2.13505696e-01
  1.21269254e+00]
  HOMO = -0.845525134654156  LUMO = 0.811605796657431
  mo_energy =
[-3.27695207e+01 -1.92724460e+00 -8.45525135e-01 -8.45525135e-01
 -8.45525135e-01  8.11605797e-01  1.08874252e+00  1.08874252e+00
  1.08874252e+00  4.56892353e+00  5.68618868e+00  5.68618868e+00
  5.68618868e+00  1.69042572e+01  2.40493879e+01  2.40493879e+01
  2.40493879e+01  5.38311836e+01  1.18864227e+02  1.18864227e+02
  1.18864227e+02  1.64678374e+02  5.30499264e+02  1.89638144e+03
  8.02310041e+03  4.77868100e+04]
E1 = -182.59832954914145  E_coul = 54.06584773659156
cycle= 5 E= -128.53248181255  delta_E= -5.6e-10  |g|= 6.77e-06  |ddm|= 5.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59832954914145  E_coul = 54.06584773659156
  HOMO = -0.845521429437544  LUMO = 0.811607318501679
  mo_energy =
[-3.27695126e+01 -1.92724017e+00 -8.45521429e-01 -8.45521429e-01
 -8.45521429e-01  8.11607319e-01  1.08874407e+00  1.08874407e+00
  1.08874407e+00  4.56892716e+00  5.68619318e+00  5.68619318e+00
  5.68619318e+00  1.69042631e+01  2.40493949e+01  2.40493949e+01
  2.40493949e+01  5.38311909e+01  1.18864235e+02  1.18864235e+02
  1.18864235e+02  1.64678382e+02  5.30499272e+02  1.89638145e+03
  8.02310042e+03  4.77868100e+04]
E1 = -182.59831174665436  E_coul = 54.06582993410183
Extra cycle  E= -128.532481812553  delta_E= -2.64e-12  |g|= 2.49e-06  |ddm|= 2.47e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1377.6378177180297
E1 = -182.59831174665436  E_coul = 54.06582993410183
init E= -128.532481812553
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845522674596072  LUMO = 0.811607054934427
  mo_energy =
[-3.27695166e+01 -1.92724136e+00 -8.45522675e-01 -8.45522675e-01
 -8.45522675e-01  8.11607055e-01  1.08874364e+00  1.08874364e+00
  1.08874364e+00  4.56892623e+00  5.68619166e+00  5.68619166e+00
  5.68619166e+00  1.69042611e+01  2.40493920e+01  2.40493920e+01
  2.40493920e+01  5.38311878e+01  1.18864231e+02  1.18864231e+02
  1.18864231e+02  1.64678378e+02  5.30499267e+02  1.89638144e+03
  8.02310042e+03  4.77868100e+04]
E1 = -182.59832134189497  E_coul = 54.065839529341716
cycle= 1 E= -128.532481812553  delta_E= -7.39e-13  |g|= 1.32e-06  |ddm|= 9.53e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59832134189497  E_coul = 54.065839529341716
  HOMO = -0.845522000075228  LUMO = 0.81160724852357
  mo_energy =
[-3.27695145e+01 -1.92724063e+00 -8.45522000e-01 -8.45522000e-01
 -8.45522000e-01  8.11607249e-01  1.08874389e+00  1.08874389e+00
  1.08874389e+00  4.56892680e+00  5.68619249e+00  5.68619249e+00
  5.68619249e+00  1.69042622e+01  2.40493935e+01  2.40493935e+01
  2.40493935e+01  5.38311894e+01  1.18864233e+02  1.18864233e+02
  1.18864233e+02  1.64678380e+02  5.30499269e+02  1.89638144e+03
  8.02310042e+03  4.77868100e+04]
E1 = -182.5983165745044  E_coul = 54.06583476195084
Extra cycle  E= -128.532481812554  delta_E= -2.84e-13  |g|= 6.49e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.13968241e-01 2.44137941e+04 3.66145355e+03 8.33287662e+02
 2.35590331e+02 7.67228841e+01 1.18486686e+01 2.84364256e+01
 3.10907316e-01 2.05010651e+00 5.40149747e+00 3.68358146e+00
 1.24503924e+01 5.47661141e+01 3.29986308e-01 1.14323526e+00]
grad_E = [ 4.85394878e-05 -8.43365425e-10  4.48162537e-08 -9.16604443e-07
  1.03444649e-05 -4.47340533e-05 -1.21164431e-05 -3.75332885e-05
 -3.47700477e-05 -1.18385709e-05  3.50237595e-05  2.16851381e-05
  1.70015527e-05 -1.78450618e-06  1.91604147e-04 -1.43986189e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.816951907405       1
[INPUT] 0    0    [1    /1   ]  24413.7941482        1
[INPUT] 0    0    [1    /1   ]  3661.45351891        1
[INPUT] 0    0    [1    /1   ]  833.288348207        1
[INPUT] 0    0    [1    /1   ]  235.583368057        1
[INPUT] 0    0    [1    /1   ]  76.7516700999        1
[INPUT] 0    0    [1    /1   ]  11.8448476787        1
[INPUT] 0    0    [1    /1   ]  28.4341863727        1
[INPUT] 0    0    [1    /1   ]  0.311881884836       1
[INPUT] 0    0    [1    /1   ]  2.05471008159        1
[INPUT] 0    0    [1    /1   ]  5.41790975188        1
[INPUT] 1    0    [1    /1   ]  3.68305704365        1
[INPUT] 1    0    [1    /1   ]  12.449904012         1
[INPUT] 1    0    [1    /1   ]  54.7659182486        1
[INPUT] 1    0    [1    /1   ]  0.32992475157        1
[INPUT] 1    0    [1    /1   ]  1.14294206998        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8169519074051173, 1.0]], [0, [24413.794148247973, 1.0]], [0, [3661.453518911803, 1.0]], [0, [833.2883482065024, 1.0]], [0, [235.5833680569877, 1.0]], [0, [76.75167009989548, 1.0]], [0, [11.844847678707511, 1.0]], [0, [28.43418637269435, 1.0]], [0, [0.31188188483598184, 1.0]], [0, [2.054710081592269, 1.0]], [0, [5.417909751881955, 1.0]], [1, [3.6830570436542005, 1.0]], [1, [12.449904011987785, 1.0]], [1, [54.76591824864331, 1.0]], [1, [0.32992475156990764, 1.0]], [1, [1.1429420699777533, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81695191]
bas 1, expnt(s) = [24413.79414825]
bas 2, expnt(s) = [3661.45351891]
bas 3, expnt(s) = [833.28834821]
bas 4, expnt(s) = [235.58336806]
bas 5, expnt(s) = [76.7516701]
bas 6, expnt(s) = [11.84484768]
bas 7, expnt(s) = [28.43418637]
bas 8, expnt(s) = [0.31188188]
bas 9, expnt(s) = [2.05471008]
bas 10, expnt(s) = [5.41790975]
bas 11, expnt(s) = [3.68305704]
bas 12, expnt(s) = [12.44990401]
bas 13, expnt(s) = [54.76591825]
bas 14, expnt(s) = [0.32992475]
bas 15, expnt(s) = [1.14294207]
CPU time:       324.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.16951907e-01 2.17101284e+00 2.44137941e+04 4.93448102e+03
 3.66145352e+03 1.18920073e+03 8.33288348e+02 3.91842471e+02
 2.35583368e+02 1.51922988e+02 7.67516701e+01 6.55135148e+01
 1.18448477e+01 1.61310313e+01 2.84341864e+01 3.11096861e+01
 3.11881885e-01 1.05440544e+00 2.05471008e+00 4.33588683e+00
 5.41790975e+00 8.97199141e+00 3.68305704e+00 1.48848667e+01
 1.24499040e+01 6.82247411e+01 5.47659182e+01 4.34632662e+02
 3.29924752e-01 7.29462575e-01 1.14294207e+00 3.44758249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998495696730313
cond(S) = 1388.674082708375
E1 = -183.57825265145465  E_coul = 55.07847947934259
init E= -128.499773172112
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945854280381  LUMO = 0.834589670844519
  mo_energy =
[-3.25554714e+01 -1.85291160e+00 -7.73945854e-01 -7.73945854e-01
 -7.73945854e-01  8.34589671e-01  1.11422475e+00  1.11422475e+00
  1.11422475e+00  4.64536940e+00  5.77203310e+00  5.77203310e+00
  5.77203310e+00  1.70699680e+01  2.42039423e+01  2.42039423e+01
  2.42039423e+01  5.40801056e+01  1.19076259e+02  1.19076259e+02
  1.19076259e+02  1.64988035e+02  5.30880638e+02  1.89680323e+03
  8.02353509e+03  4.77872406e+04]
E1 = -182.1110500108037  E_coul = 53.58192084580713
cycle= 1 E= -128.529129164997  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461436
diis-c [-0.21292282  1.        ]
  HOMO = -0.87961996545093  LUMO = 0.806039702237471
  mo_energy =
[-3.28740843e+01 -1.96318255e+00 -8.79619965e-01 -8.79619965e-01
 -8.79619965e-01  8.06039702e-01  1.07605253e+00  1.07605253e+00
  1.07605253e+00  4.55873806e+00  5.64315137e+00  5.64315137e+00
  5.64315137e+00  1.68977542e+01  2.39689745e+01  2.39689745e+01
  2.39689745e+01  5.38267480e+01  1.18755371e+02  1.18755371e+02
  1.18755371e+02  1.64675073e+02  5.30524097e+02  1.89641009e+03
  8.02311266e+03  4.77867992e+04]
E1 = -182.8432263682346  E_coul = 54.31159161201826
cycle= 2 E= -128.531634756216  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230745
diis-c [-0.00069255  0.33226717  0.66773283]
  HOMO = -0.845266378762447  LUMO = 0.81531220119112
  mo_energy =
[-3.27690854e+01 -1.92706525e+00 -8.45266379e-01 -8.45266379e-01
 -8.45266379e-01  8.15312201e-01  1.08852878e+00  1.08852878e+00
  1.08852878e+00  4.58673819e+00  5.68505586e+00  5.68505586e+00
  5.68505586e+00  1.69541985e+01  2.40465203e+01  2.40465203e+01
  2.40465203e+01  5.39106276e+01  1.18860396e+02  1.18860396e+02
  1.18860396e+02  1.64777907e+02  5.30637468e+02  1.89652882e+03
  8.02323387e+03  4.77869213e+04]
E1 = -182.5977634053173  E_coul = 54.06528113798172
cycle= 3 E= -128.532482267336  delta_E= -0.000848  |g|= 0.000451  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000893455
diis-c [-1.48190549e-07 -2.23416089e-03 -9.80710612e-04  1.00321487e+00]
  HOMO = -0.845493605935714  LUMO = 0.815276708798672
  mo_energy =
[-3.27694723e+01 -1.92722687e+00 -8.45493606e-01 -8.45493606e-01
 -8.45493606e-01  8.15276709e-01  1.08848081e+00  1.08848081e+00
  1.08848081e+00  4.58660516e+00  5.68486134e+00  5.68486134e+00
  5.68486134e+00  1.69539554e+01  2.40462135e+01  2.40462135e+01
  2.40462135e+01  5.39103095e+01  1.18859997e+02  1.18859997e+02
  1.18859997e+02  1.64777519e+02  5.30636982e+02  1.89652822e+03
  8.02323318e+03  4.77869206e+04]
E1 = -182.59820322340943  E_coul = 54.06572093607666
cycle= 4 E= -128.532482287333  delta_E= -2e-08  |g|= 6.45e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134446
diis-c [-1.03085113e-09  3.21596793e-04  4.91685470e-04 -2.13368994e-01
  1.21255571e+00]
  HOMO = -0.84552622256926  LUMO = 0.815269596024604
  mo_energy =
[-3.27695259e+01 -1.92724681e+00 -8.45526223e-01 -8.45526223e-01
 -8.45526223e-01  8.15269596e-01  1.08846713e+00  1.08846713e+00
  1.08846713e+00  4.58658157e+00  5.68482526e+00  5.68482526e+00
  5.68482526e+00  1.69539148e+01  2.40461653e+01  2.40461653e+01
  2.40461653e+01  5.39102604e+01  1.18859943e+02  1.18859943e+02
  1.18859943e+02  1.64777465e+02  5.30636920e+02  1.89652815e+03
  8.02323311e+03  4.77869205e+04]
E1 = -182.59830906921545  E_coul = 54.06582678132404
cycle= 5 E= -128.532482287891  delta_E= -5.59e-10  |g|= 6.76e-06  |ddm|= 5.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59830906921545  E_coul = 54.06582678132404
  HOMO = -0.845522521062771  LUMO = 0.81527112258713
  mo_energy =
[-3.27695178e+01 -1.92724238e+00 -8.45522521e-01 -8.45522521e-01
 -8.45522521e-01  8.15271123e-01  1.08846869e+00  1.08846869e+00
  1.08846869e+00  4.58658520e+00  5.68482976e+00  5.68482976e+00
  5.68482976e+00  1.69539207e+01  2.40461722e+01  2.40461722e+01
  2.40461722e+01  5.39102678e+01  1.18859951e+02  1.18859951e+02
  1.18859951e+02  1.64777473e+02  5.30636928e+02  1.89652816e+03
  8.02323312e+03  4.77869206e+04]
E1 = -182.59829128309636  E_coul = 54.065808995202396
Extra cycle  E= -128.532482287894  delta_E= -2.56e-12  |g|= 2.49e-06  |ddm|= 2.46e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.16951907e-01 2.44137941e+04 3.66145352e+03 8.33288348e+02
 2.35583368e+02 7.67516701e+01 1.18448477e+01 2.84341864e+01
 3.11881885e-01 2.05471008e+00 5.41790975e+00 3.68305704e+00
 1.24499040e+01 5.47659182e+01 3.29924752e-01 1.14294207e+00]
E = -128.53248228789397
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.816951907405       1
[INPUT] 0    0    [1    /1   ]  24413.7941482        1
[INPUT] 0    0    [1    /1   ]  3661.45351891        1
[INPUT] 0    0    [1    /1   ]  833.288348207        1
[INPUT] 0    0    [1    /1   ]  235.583368057        1
[INPUT] 0    0    [1    /1   ]  76.7516700999        1
[INPUT] 0    0    [1    /1   ]  11.8448476787        1
[INPUT] 0    0    [1    /1   ]  28.4341863727        1
[INPUT] 0    0    [1    /1   ]  0.311881884836       1
[INPUT] 0    0    [1    /1   ]  2.05471008159        1
[INPUT] 0    0    [1    /1   ]  5.41790975188        1
[INPUT] 1    0    [1    /1   ]  3.68305704365        1
[INPUT] 1    0    [1    /1   ]  12.449904012         1
[INPUT] 1    0    [1    /1   ]  54.7659182486        1
[INPUT] 1    0    [1    /1   ]  0.32992475157        1
[INPUT] 1    0    [1    /1   ]  1.14294206998        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8169519074051173, 1.0]], [0, [24413.794148247973, 1.0]], [0, [3661.453518911803, 1.0]], [0, [833.2883482065024, 1.0]], [0, [235.5833680569877, 1.0]], [0, [76.75167009989548, 1.0]], [0, [11.844847678707511, 1.0]], [0, [28.43418637269435, 1.0]], [0, [0.31188188483598184, 1.0]], [0, [2.054710081592269, 1.0]], [0, [5.417909751881955, 1.0]], [1, [3.6830570436542005, 1.0]], [1, [12.449904011987785, 1.0]], [1, [54.76591824864331, 1.0]], [1, [0.32992475156990764, 1.0]], [1, [1.1429420699777533, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81695191]
bas 1, expnt(s) = [24413.79414825]
bas 2, expnt(s) = [3661.45351891]
bas 3, expnt(s) = [833.28834821]
bas 4, expnt(s) = [235.58336806]
bas 5, expnt(s) = [76.7516701]
bas 6, expnt(s) = [11.84484768]
bas 7, expnt(s) = [28.43418637]
bas 8, expnt(s) = [0.31188188]
bas 9, expnt(s) = [2.05471008]
bas 10, expnt(s) = [5.41790975]
bas 11, expnt(s) = [3.68305704]
bas 12, expnt(s) = [12.44990401]
bas 13, expnt(s) = [54.76591825]
bas 14, expnt(s) = [0.32992475]
bas 15, expnt(s) = [1.14294207]
CPU time:       326.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.16951907e-01 2.17101284e+00 2.44137941e+04 4.93448102e+03
 3.66145352e+03 1.18920073e+03 8.33288348e+02 3.91842471e+02
 2.35583368e+02 1.51922988e+02 7.67516701e+01 6.55135148e+01
 1.18448477e+01 1.61310313e+01 2.84341864e+01 3.11096861e+01
 3.11881885e-01 1.05440544e+00 2.05471008e+00 4.33588683e+00
 5.41790975e+00 8.97199141e+00 3.68305704e+00 1.48848667e+01
 1.24499040e+01 6.82247411e+01 5.47659182e+01 4.34632662e+02
 3.29924752e-01 7.29462575e-01 1.14294207e+00 3.44758249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998495696730313
cond(S) = 1388.674082708375
E1 = -183.57825265145465  E_coul = 55.07847947934259
init E= -128.499773172112
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945854280381  LUMO = 0.834589670844519
  mo_energy =
[-3.25554714e+01 -1.85291160e+00 -7.73945854e-01 -7.73945854e-01
 -7.73945854e-01  8.34589671e-01  1.11422475e+00  1.11422475e+00
  1.11422475e+00  4.64536940e+00  5.77203310e+00  5.77203310e+00
  5.77203310e+00  1.70699680e+01  2.42039423e+01  2.42039423e+01
  2.42039423e+01  5.40801056e+01  1.19076259e+02  1.19076259e+02
  1.19076259e+02  1.64988035e+02  5.30880638e+02  1.89680323e+03
  8.02353509e+03  4.77872406e+04]
E1 = -182.1110500108037  E_coul = 53.58192084580713
cycle= 1 E= -128.529129164997  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461436
diis-c [-0.21292282  1.        ]
  HOMO = -0.87961996545093  LUMO = 0.806039702237471
  mo_energy =
[-3.28740843e+01 -1.96318255e+00 -8.79619965e-01 -8.79619965e-01
 -8.79619965e-01  8.06039702e-01  1.07605253e+00  1.07605253e+00
  1.07605253e+00  4.55873806e+00  5.64315137e+00  5.64315137e+00
  5.64315137e+00  1.68977542e+01  2.39689745e+01  2.39689745e+01
  2.39689745e+01  5.38267480e+01  1.18755371e+02  1.18755371e+02
  1.18755371e+02  1.64675073e+02  5.30524097e+02  1.89641009e+03
  8.02311266e+03  4.77867992e+04]
E1 = -182.8432263682346  E_coul = 54.31159161201826
cycle= 2 E= -128.531634756216  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230745
diis-c [-0.00069255  0.33226717  0.66773283]
  HOMO = -0.845266378762447  LUMO = 0.81531220119112
  mo_energy =
[-3.27690854e+01 -1.92706525e+00 -8.45266379e-01 -8.45266379e-01
 -8.45266379e-01  8.15312201e-01  1.08852878e+00  1.08852878e+00
  1.08852878e+00  4.58673819e+00  5.68505586e+00  5.68505586e+00
  5.68505586e+00  1.69541985e+01  2.40465203e+01  2.40465203e+01
  2.40465203e+01  5.39106276e+01  1.18860396e+02  1.18860396e+02
  1.18860396e+02  1.64777907e+02  5.30637468e+02  1.89652882e+03
  8.02323387e+03  4.77869213e+04]
E1 = -182.5977634053173  E_coul = 54.06528113798172
cycle= 3 E= -128.532482267336  delta_E= -0.000848  |g|= 0.000451  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000893455
diis-c [-1.48190549e-07 -2.23416089e-03 -9.80710612e-04  1.00321487e+00]
  HOMO = -0.845493605935714  LUMO = 0.815276708798672
  mo_energy =
[-3.27694723e+01 -1.92722687e+00 -8.45493606e-01 -8.45493606e-01
 -8.45493606e-01  8.15276709e-01  1.08848081e+00  1.08848081e+00
  1.08848081e+00  4.58660516e+00  5.68486134e+00  5.68486134e+00
  5.68486134e+00  1.69539554e+01  2.40462135e+01  2.40462135e+01
  2.40462135e+01  5.39103095e+01  1.18859997e+02  1.18859997e+02
  1.18859997e+02  1.64777519e+02  5.30636982e+02  1.89652822e+03
  8.02323318e+03  4.77869206e+04]
E1 = -182.59820322340943  E_coul = 54.06572093607666
cycle= 4 E= -128.532482287333  delta_E= -2e-08  |g|= 6.45e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134446
diis-c [-1.03085113e-09  3.21596793e-04  4.91685470e-04 -2.13368994e-01
  1.21255571e+00]
  HOMO = -0.84552622256926  LUMO = 0.815269596024604
  mo_energy =
[-3.27695259e+01 -1.92724681e+00 -8.45526223e-01 -8.45526223e-01
 -8.45526223e-01  8.15269596e-01  1.08846713e+00  1.08846713e+00
  1.08846713e+00  4.58658157e+00  5.68482526e+00  5.68482526e+00
  5.68482526e+00  1.69539148e+01  2.40461653e+01  2.40461653e+01
  2.40461653e+01  5.39102604e+01  1.18859943e+02  1.18859943e+02
  1.18859943e+02  1.64777465e+02  5.30636920e+02  1.89652815e+03
  8.02323311e+03  4.77869205e+04]
E1 = -182.59830906921545  E_coul = 54.06582678132404
cycle= 5 E= -128.532482287891  delta_E= -5.59e-10  |g|= 6.76e-06  |ddm|= 5.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59830906921545  E_coul = 54.06582678132404
  HOMO = -0.845522521062771  LUMO = 0.81527112258713
  mo_energy =
[-3.27695178e+01 -1.92724238e+00 -8.45522521e-01 -8.45522521e-01
 -8.45522521e-01  8.15271123e-01  1.08846869e+00  1.08846869e+00
  1.08846869e+00  4.58658520e+00  5.68482976e+00  5.68482976e+00
  5.68482976e+00  1.69539207e+01  2.40461722e+01  2.40461722e+01
  2.40461722e+01  5.39102678e+01  1.18859951e+02  1.18859951e+02
  1.18859951e+02  1.64777473e+02  5.30636928e+02  1.89652816e+03
  8.02323312e+03  4.77869206e+04]
E1 = -182.59829128309636  E_coul = 54.065808995202396
Extra cycle  E= -128.532482287894  delta_E= -2.56e-12  |g|= 2.49e-06  |ddm|= 2.46e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1388.674082708375
E1 = -182.59829128309636  E_coul = 54.065808995202396
init E= -128.532482287894
    CPU time for initialize scf      0.23 sec, wall time      0.22 sec
  HOMO = -0.845523765100812  LUMO = 0.815270857992042
  mo_energy =
[-3.27695218e+01 -1.92724357e+00 -8.45523765e-01 -8.45523765e-01
 -8.45523765e-01  8.15270858e-01  1.08846825e+00  1.08846825e+00
  1.08846825e+00  4.58658428e+00  5.68482825e+00  5.68482825e+00
  5.68482825e+00  1.69539187e+01  2.40461693e+01  2.40461693e+01
  2.40461693e+01  5.39102646e+01  1.18859947e+02  1.18859947e+02
  1.18859947e+02  1.64777469e+02  5.30636924e+02  1.89652815e+03
  8.02323311e+03  4.77869205e+04]
E1 = -182.59830086959357  E_coul = 54.065818581698956
cycle= 1 E= -128.532482287895  delta_E= -6.54e-13  |g|= 1.31e-06  |ddm|= 9.52e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59830086959357  E_coul = 54.065818581698956
  HOMO = -0.845523091198498  LUMO = 0.815271052274637
  mo_energy =
[-3.27695197e+01 -1.92724284e+00 -8.45523091e-01 -8.45523091e-01
 -8.45523091e-01  8.15271052e-01  1.08846850e+00  1.08846850e+00
  1.08846850e+00  4.58658484e+00  5.68482907e+00  5.68482907e+00
  5.68482907e+00  1.69539198e+01  2.40461708e+01  2.40461708e+01
  2.40461708e+01  5.39102663e+01  1.18859949e+02  1.18859949e+02
  1.18859949e+02  1.64777471e+02  5.30636926e+02  1.89652816e+03
  8.02323311e+03  4.77869205e+04]
E1 = -182.59829610651164  E_coul = 54.06581381861687
Extra cycle  E= -128.532482287895  delta_E= -1.42e-13  |g|= 6.48e-07  |ddm|= 4.65e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [8.16951907e-01 2.44137941e+04 3.66145352e+03 8.33288348e+02
 2.35583368e+02 7.67516701e+01 1.18448477e+01 2.84341864e+01
 3.11881885e-01 2.05471008e+00 5.41790975e+00 3.68305704e+00
 1.24499040e+01 5.47659182e+01 3.29924752e-01 1.14294207e+00]
grad_E = [ 8.14309026e-05 -7.41588694e-10  3.95539134e-08 -8.20449210e-07
  9.48394661e-06 -4.17095803e-05 -1.51361326e-05 -3.99484455e-05
 -5.09560214e-05 -1.90925826e-05  3.80176559e-05  3.74422377e-05
  1.78563014e-05 -1.78234512e-06  3.11032556e-04 -2.53269567e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.821883543953       1
[INPUT] 0    0    [1    /1   ]  24413.7941496        1
[INPUT] 0    0    [1    /1   ]  3661.45344672        1
[INPUT] 0    0    [1    /1   ]  833.289740597        1
[INPUT] 0    0    [1    /1   ]  235.569143396        1
[INPUT] 0    0    [1    /1   ]  76.8098070541        1
[INPUT] 0    0    [1    /1   ]  11.8443256105        1
[INPUT] 0    0    [1    /1   ]  28.4409219986        1
[INPUT] 0    0    [1    /1   ]  0.31346686753        1
[INPUT] 0    0    [1    /1   ]  2.06264089236        1
[INPUT] 0    0    [1    /1   ]  5.44652874972        1
[INPUT] 1    0    [1    /1   ]  3.68224964226        1
[INPUT] 1    0    [1    /1   ]  12.4491791253        1
[INPUT] 1    0    [1    /1   ]  54.7653895403        1
[INPUT] 1    0    [1    /1   ]  0.329826781007       1
[INPUT] 1    0    [1    /1   ]  1.14248170269        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8218835439534677, 1.0]], [0, [24413.794149624093, 1.0]], [0, [3661.4534467182357, 1.0]], [0, [833.2897405968058, 1.0]], [0, [235.56914339622654, 1.0]], [0, [76.80980705406586, 1.0]], [0, [11.844325610467717, 1.0]], [0, [28.44092199863486, 1.0]], [0, [0.3134668675300193, 1.0]], [0, [2.062640892360856, 1.0]], [0, [5.446528749724094, 1.0]], [1, [3.682249642256468, 1.0]], [1, [12.449179125259073, 1.0]], [1, [54.76538954031716, 1.0]], [1, [0.3298267810073966, 1.0]], [1, [1.1424817026927139, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82188354]
bas 1, expnt(s) = [24413.79414962]
bas 2, expnt(s) = [3661.45344672]
bas 3, expnt(s) = [833.2897406]
bas 4, expnt(s) = [235.5691434]
bas 5, expnt(s) = [76.80980705]
bas 6, expnt(s) = [11.84432561]
bas 7, expnt(s) = [28.440922]
bas 8, expnt(s) = [0.31346687]
bas 9, expnt(s) = [2.06264089]
bas 10, expnt(s) = [5.44652875]
bas 11, expnt(s) = [3.68224964]
bas 12, expnt(s) = [12.44917913]
bas 13, expnt(s) = [54.76538954]
bas 14, expnt(s) = [0.32982678]
bas 15, expnt(s) = [1.1424817]
CPU time:       329.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.21883544e-01 2.18083465e+00 2.44137941e+04 4.93448102e+03
 3.66145345e+03 1.18920072e+03 8.33289741e+02 3.91842962e+02
 2.35569143e+02 1.51916108e+02 7.68098071e+01 6.55507296e+01
 1.18443256e+01 1.61304981e+01 2.84409220e+01 3.11152130e+01
 3.13466868e-01 1.05842175e+00 2.06264089e+00 4.34843259e+00
 5.44652875e+00 9.00751252e+00 3.68224964e+00 1.48807880e+01
 1.24491791e+01 6.82197757e+01 5.47653895e+01 4.34627417e+02
 3.29826781e-01 7.29191819e-01 1.14248170e+00 3.44584675e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497971830238
cond(S) = 1406.616995526057
E1 = -183.57823673712414  E_coul = 55.07847594159739
init E= -128.499760795527
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77394641367672  LUMO = 0.840777564438617
  mo_energy =
[-3.25554723e+01 -1.85291186e+00 -7.73946414e-01 -7.73946414e-01
 -7.73946414e-01  8.40777564e-01  1.11377646e+00  1.11377646e+00
  1.11377646e+00  4.67522722e+00  5.76988220e+00  5.76988220e+00
  5.76988220e+00  1.71566395e+01  2.41989732e+01  2.41989732e+01
  2.41989732e+01  5.42318308e+01  1.19069377e+02  1.19069377e+02
  1.19069377e+02  1.65208205e+02  5.31197885e+02  1.89714106e+03
  8.02384088e+03  4.77874954e+04]
E1 = -182.11097270562124  E_coul = 53.58184276913073
cycle= 1 E= -128.529129936491  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461418
diis-c [-0.21290701  1.        ]
  HOMO = -0.879625159776209  LUMO = 0.812009424403827
  mo_energy =
[-3.28741012e+01 -1.96318984e+00 -8.79625160e-01 -8.79625160e-01
 -8.79625160e-01  8.12009424e-01  1.07562065e+00  1.07562065e+00
  1.07562065e+00  4.58823703e+00  5.64101885e+00  5.64101885e+00
  5.64101885e+00  1.69841318e+01  2.39639964e+01  2.39639964e+01
  2.39639964e+01  5.39784020e+01  1.18748473e+02  1.18748473e+02
  1.18748473e+02  1.64895220e+02  5.30841330e+02  1.89674791e+03
  8.02341844e+03  4.77870540e+04]
E1 = -182.84321605565975  E_coul = 54.31158021655069
cycle= 2 E= -128.531635839109  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230744
diis-c [-0.00069325  0.33227376  0.66772624]
  HOMO = -0.845268619326917  LUMO = 0.821352071198493
  mo_energy =
[-3.27690947e+01 -1.92706916e+00 -8.45268619e-01 -8.45268619e-01
 -8.45268619e-01  8.21352071e-01  1.08809213e+00  1.08809213e+00
  1.08809213e+00  4.61635547e+00  5.68291907e+00  5.68291907e+00
  5.68291907e+00  1.70406763e+01  2.40415467e+01  2.40415467e+01
  2.40415467e+01  5.40623068e+01  1.18853506e+02  1.18853506e+02
  1.18853506e+02  1.64998063e+02  5.30954708e+02  1.89686665e+03
  8.02353966e+03  4.77871762e+04]
E1 = -182.59773120338932  E_coul = 54.065247708657076
cycle= 3 E= -128.532483494732  delta_E= -0.000848  |g|= 0.00045  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000891912
diis-c [-1.47125889e-07 -2.23193582e-03 -9.80689420e-04  1.00321263e+00]
  HOMO = -0.845495474554052  LUMO = 0.821316420454185
  mo_energy =
[-3.27694809e+01 -1.92723049e+00 -8.45495475e-01 -8.45495475e-01
 -8.45495475e-01  8.21316420e-01  1.08804438e+00  1.08804438e+00
  1.08804438e+00  4.61622220e+00  5.68272501e+00  5.68272501e+00
  5.68272501e+00  1.70404334e+01  2.40412405e+01  2.40412405e+01
  2.40412405e+01  5.40619892e+01  1.18853108e+02  1.18853108e+02
  1.18853108e+02  1.64997675e+02  5.30954223e+02  1.89686605e+03
  8.02353898e+03  4.77871754e+04]
E1 = -182.59816997174713  E_coul = 54.06568645710361
cycle= 4 E= -128.532483514644  delta_E= -1.99e-08  |g|= 6.45e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134373
diis-c [-1.02922360e-09  3.20914064e-04  4.92509073e-04 -2.13136109e-01
  1.21232269e+00]
  HOMO = -0.845528063626456  LUMO = 0.821309259369152
  mo_energy =
[-3.27695345e+01 -1.92725044e+00 -8.45528064e-01 -8.45528064e-01
 -8.45528064e-01  8.21309259e-01  1.08803073e+00  1.08803073e+00
  1.08803073e+00  4.61619854e+00  5.68268896e+00  5.68268896e+00
  5.68268896e+00  1.70403928e+01  2.40411923e+01  2.40411923e+01
  2.40411923e+01  5.40619401e+01  1.18853054e+02  1.18853054e+02
  1.18853054e+02  1.64997621e+02  5.30954161e+02  1.89686598e+03
  8.02353890e+03  4.77871754e+04]
E1 = -182.59827594387272  E_coul = 54.06579242867336
cycle= 5 E= -128.532483515199  delta_E= -5.56e-10  |g|= 6.75e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59827594387272  E_coul = 54.06579242867336
  HOMO = -0.845524368467556  LUMO = 0.821310793654641
  mo_energy =
[-3.27695264e+01 -1.92724602e+00 -8.45524368e-01 -8.45524368e-01
 -8.45524368e-01  8.21310794e-01  1.08803228e+00  1.08803228e+00
  1.08803228e+00  4.61620217e+00  5.68269345e+00  5.68269345e+00
  5.68269345e+00  1.70403986e+01  2.40411992e+01  2.40411992e+01
  2.40411992e+01  5.40619474e+01  1.18853062e+02  1.18853062e+02
  1.18853062e+02  1.64997629e+02  5.30954169e+02  1.89686599e+03
  8.02353891e+03  4.77871754e+04]
E1 = -182.59825818599506  E_coul = 54.065774670792656
Extra cycle  E= -128.532483515202  delta_E= -3.04e-12  |g|= 2.48e-06  |ddm|= 2.45e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.21883544e-01 2.44137941e+04 3.66145345e+03 8.33289741e+02
 2.35569143e+02 7.68098071e+01 1.18443256e+01 2.84409220e+01
 3.13466868e-01 2.06264089e+00 5.44652875e+00 3.68224964e+00
 1.24491791e+01 5.47653895e+01 3.29826781e-01 1.14248170e+00]
E = -128.53248351520241
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.821883543953       1
[INPUT] 0    0    [1    /1   ]  24413.7941496        1
[INPUT] 0    0    [1    /1   ]  3661.45344672        1
[INPUT] 0    0    [1    /1   ]  833.289740597        1
[INPUT] 0    0    [1    /1   ]  235.569143396        1
[INPUT] 0    0    [1    /1   ]  76.8098070541        1
[INPUT] 0    0    [1    /1   ]  11.8443256105        1
[INPUT] 0    0    [1    /1   ]  28.4409219986        1
[INPUT] 0    0    [1    /1   ]  0.31346686753        1
[INPUT] 0    0    [1    /1   ]  2.06264089236        1
[INPUT] 0    0    [1    /1   ]  5.44652874972        1
[INPUT] 1    0    [1    /1   ]  3.68224964226        1
[INPUT] 1    0    [1    /1   ]  12.4491791253        1
[INPUT] 1    0    [1    /1   ]  54.7653895403        1
[INPUT] 1    0    [1    /1   ]  0.329826781007       1
[INPUT] 1    0    [1    /1   ]  1.14248170269        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8218835439534677, 1.0]], [0, [24413.794149624093, 1.0]], [0, [3661.4534467182357, 1.0]], [0, [833.2897405968058, 1.0]], [0, [235.56914339622654, 1.0]], [0, [76.80980705406586, 1.0]], [0, [11.844325610467717, 1.0]], [0, [28.44092199863486, 1.0]], [0, [0.3134668675300193, 1.0]], [0, [2.062640892360856, 1.0]], [0, [5.446528749724094, 1.0]], [1, [3.682249642256468, 1.0]], [1, [12.449179125259073, 1.0]], [1, [54.76538954031716, 1.0]], [1, [0.3298267810073966, 1.0]], [1, [1.1424817026927139, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82188354]
bas 1, expnt(s) = [24413.79414962]
bas 2, expnt(s) = [3661.45344672]
bas 3, expnt(s) = [833.2897406]
bas 4, expnt(s) = [235.5691434]
bas 5, expnt(s) = [76.80980705]
bas 6, expnt(s) = [11.84432561]
bas 7, expnt(s) = [28.440922]
bas 8, expnt(s) = [0.31346687]
bas 9, expnt(s) = [2.06264089]
bas 10, expnt(s) = [5.44652875]
bas 11, expnt(s) = [3.68224964]
bas 12, expnt(s) = [12.44917913]
bas 13, expnt(s) = [54.76538954]
bas 14, expnt(s) = [0.32982678]
bas 15, expnt(s) = [1.1424817]
CPU time:       330.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.21883544e-01 2.18083465e+00 2.44137941e+04 4.93448102e+03
 3.66145345e+03 1.18920072e+03 8.33289741e+02 3.91842962e+02
 2.35569143e+02 1.51916108e+02 7.68098071e+01 6.55507296e+01
 1.18443256e+01 1.61304981e+01 2.84409220e+01 3.11152130e+01
 3.13466868e-01 1.05842175e+00 2.06264089e+00 4.34843259e+00
 5.44652875e+00 9.00751252e+00 3.68224964e+00 1.48807880e+01
 1.24491791e+01 6.82197757e+01 5.47653895e+01 4.34627417e+02
 3.29826781e-01 7.29191819e-01 1.14248170e+00 3.44584675e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497971830238
cond(S) = 1406.616995526057
E1 = -183.57823673712414  E_coul = 55.07847594159739
init E= -128.499760795527
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77394641367672  LUMO = 0.840777564438617
  mo_energy =
[-3.25554723e+01 -1.85291186e+00 -7.73946414e-01 -7.73946414e-01
 -7.73946414e-01  8.40777564e-01  1.11377646e+00  1.11377646e+00
  1.11377646e+00  4.67522722e+00  5.76988220e+00  5.76988220e+00
  5.76988220e+00  1.71566395e+01  2.41989732e+01  2.41989732e+01
  2.41989732e+01  5.42318308e+01  1.19069377e+02  1.19069377e+02
  1.19069377e+02  1.65208205e+02  5.31197885e+02  1.89714106e+03
  8.02384088e+03  4.77874954e+04]
E1 = -182.11097270562124  E_coul = 53.58184276913073
cycle= 1 E= -128.529129936491  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461418
diis-c [-0.21290701  1.        ]
  HOMO = -0.879625159776209  LUMO = 0.812009424403827
  mo_energy =
[-3.28741012e+01 -1.96318984e+00 -8.79625160e-01 -8.79625160e-01
 -8.79625160e-01  8.12009424e-01  1.07562065e+00  1.07562065e+00
  1.07562065e+00  4.58823703e+00  5.64101885e+00  5.64101885e+00
  5.64101885e+00  1.69841318e+01  2.39639964e+01  2.39639964e+01
  2.39639964e+01  5.39784020e+01  1.18748473e+02  1.18748473e+02
  1.18748473e+02  1.64895220e+02  5.30841330e+02  1.89674791e+03
  8.02341844e+03  4.77870540e+04]
E1 = -182.84321605565975  E_coul = 54.31158021655069
cycle= 2 E= -128.531635839109  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230744
diis-c [-0.00069325  0.33227376  0.66772624]
  HOMO = -0.845268619326917  LUMO = 0.821352071198493
  mo_energy =
[-3.27690947e+01 -1.92706916e+00 -8.45268619e-01 -8.45268619e-01
 -8.45268619e-01  8.21352071e-01  1.08809213e+00  1.08809213e+00
  1.08809213e+00  4.61635547e+00  5.68291907e+00  5.68291907e+00
  5.68291907e+00  1.70406763e+01  2.40415467e+01  2.40415467e+01
  2.40415467e+01  5.40623068e+01  1.18853506e+02  1.18853506e+02
  1.18853506e+02  1.64998063e+02  5.30954708e+02  1.89686665e+03
  8.02353966e+03  4.77871762e+04]
E1 = -182.59773120338932  E_coul = 54.065247708657076
cycle= 3 E= -128.532483494732  delta_E= -0.000848  |g|= 0.00045  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000891912
diis-c [-1.47125889e-07 -2.23193582e-03 -9.80689420e-04  1.00321263e+00]
  HOMO = -0.845495474554052  LUMO = 0.821316420454185
  mo_energy =
[-3.27694809e+01 -1.92723049e+00 -8.45495475e-01 -8.45495475e-01
 -8.45495475e-01  8.21316420e-01  1.08804438e+00  1.08804438e+00
  1.08804438e+00  4.61622220e+00  5.68272501e+00  5.68272501e+00
  5.68272501e+00  1.70404334e+01  2.40412405e+01  2.40412405e+01
  2.40412405e+01  5.40619892e+01  1.18853108e+02  1.18853108e+02
  1.18853108e+02  1.64997675e+02  5.30954223e+02  1.89686605e+03
  8.02353898e+03  4.77871754e+04]
E1 = -182.59816997174713  E_coul = 54.06568645710361
cycle= 4 E= -128.532483514644  delta_E= -1.99e-08  |g|= 6.45e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134373
diis-c [-1.02922360e-09  3.20914064e-04  4.92509073e-04 -2.13136109e-01
  1.21232269e+00]
  HOMO = -0.845528063626456  LUMO = 0.821309259369152
  mo_energy =
[-3.27695345e+01 -1.92725044e+00 -8.45528064e-01 -8.45528064e-01
 -8.45528064e-01  8.21309259e-01  1.08803073e+00  1.08803073e+00
  1.08803073e+00  4.61619854e+00  5.68268896e+00  5.68268896e+00
  5.68268896e+00  1.70403928e+01  2.40411923e+01  2.40411923e+01
  2.40411923e+01  5.40619401e+01  1.18853054e+02  1.18853054e+02
  1.18853054e+02  1.64997621e+02  5.30954161e+02  1.89686598e+03
  8.02353890e+03  4.77871754e+04]
E1 = -182.59827594387272  E_coul = 54.06579242867336
cycle= 5 E= -128.532483515199  delta_E= -5.56e-10  |g|= 6.75e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59827594387272  E_coul = 54.06579242867336
  HOMO = -0.845524368467556  LUMO = 0.821310793654641
  mo_energy =
[-3.27695264e+01 -1.92724602e+00 -8.45524368e-01 -8.45524368e-01
 -8.45524368e-01  8.21310794e-01  1.08803228e+00  1.08803228e+00
  1.08803228e+00  4.61620217e+00  5.68269345e+00  5.68269345e+00
  5.68269345e+00  1.70403986e+01  2.40411992e+01  2.40411992e+01
  2.40411992e+01  5.40619474e+01  1.18853062e+02  1.18853062e+02
  1.18853062e+02  1.64997629e+02  5.30954169e+02  1.89686599e+03
  8.02353891e+03  4.77871754e+04]
E1 = -182.59825818599506  E_coul = 54.065774670792656
Extra cycle  E= -128.532483515202  delta_E= -3.04e-12  |g|= 2.48e-06  |ddm|= 2.45e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1406.616995526057
E1 = -182.59825818599506  E_coul = 54.065774670792656
init E= -128.532483515202
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845525610573659  LUMO = 0.821310527384913
  mo_energy =
[-3.27695304e+01 -1.92724721e+00 -8.45525611e-01 -8.45525611e-01
 -8.45525611e-01  8.21310527e-01  1.08803184e+00  1.08803184e+00
  1.08803184e+00  4.61620124e+00  5.68269194e+00  5.68269194e+00
  5.68269194e+00  1.70403966e+01  2.40411963e+01  2.40411963e+01
  2.40411963e+01  5.40619443e+01  1.18853058e+02  1.18853058e+02
  1.18853058e+02  1.64997625e+02  5.30954165e+02  1.89686598e+03
  8.02353890e+03  4.77871754e+04]
E1 = -182.59826775739197  E_coul = 54.065784242189046
cycle= 1 E= -128.532483515203  delta_E= -5.12e-13  |g|= 1.31e-06  |ddm|= 9.51e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59826775739197  E_coul = 54.065784242189046
  HOMO = -0.845524937740452  LUMO = 0.821310722799624
  mo_energy =
[-3.27695283e+01 -1.92724647e+00 -8.45524938e-01 -8.45524938e-01
 -8.45524938e-01  8.21310723e-01  1.08803209e+00  1.08803209e+00
  1.08803209e+00  4.61620181e+00  5.68269276e+00  5.68269276e+00
  5.68269276e+00  1.70403977e+01  2.40411978e+01  2.40411978e+01
  2.40411978e+01  5.40619460e+01  1.18853060e+02  1.18853060e+02
  1.18853060e+02  1.64997627e+02  5.30954167e+02  1.89686598e+03
  8.02353891e+03  4.77871754e+04]
E1 = -182.5982630017563  E_coul = 54.065779486553524
Extra cycle  E= -128.532483515203  delta_E= 1.42e-13  |g|= 6.47e-07  |ddm|= 4.64e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.28 sec
exp = [8.21883544e-01 2.44137941e+04 3.66145345e+03 8.33289741e+02
 2.35569143e+02 7.68098071e+01 1.18443256e+01 2.84409220e+01
 3.13466868e-01 2.06264089e+00 5.44652875e+00 3.68224964e+00
 1.24491791e+01 5.47653895e+01 3.29826781e-01 1.14248170e+00]
grad_E = [ 1.32366663e-04 -5.59167251e-10  3.01429876e-08 -6.49615354e-07
  7.99340375e-06 -3.67622116e-05 -2.00150646e-05 -4.34241729e-05
 -7.57463451e-05 -3.02102931e-05  4.26684544e-05  6.30525969e-05
  1.92265507e-05 -1.79790677e-06  4.94747006e-04 -4.26289712e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.829806939194       1
[INPUT] 0    0    [1    /1   ]  24413.7941525        1
[INPUT] 0    0    [1    /1   ]  3661.45329775        1
[INPUT] 0    0    [1    /1   ]  833.292627615        1
[INPUT] 0    0    [1    /1   ]  235.539431343        1
[INPUT] 0    0    [1    /1   ]  76.9302572967        1
[INPUT] 0    0    [1    /1   ]  11.8556682933        1
[INPUT] 0    0    [1    /1   ]  28.4761730731        1
[INPUT] 0    0    [1    /1   ]  0.315966108871       1
[INPUT] 0    0    [1    /1   ]  2.07592758856        1
[INPUT] 0    0    [1    /1   ]  5.49363409418        1
[INPUT] 1    0    [1    /1   ]  3.68102656421        1
[INPUT] 1    0    [1    /1   ]  12.4480087286        1
[INPUT] 1    0    [1    /1   ]  54.7640745447        1
[INPUT] 1    0    [1    /1   ]  0.329678027952       1
[INPUT] 1    0    [1    /1   ]  1.14178720107        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8298069391943842, 1.0]], [0, [24413.794152460316, 1.0]], [0, [3661.453297754788, 1.0]], [0, [833.292627614692, 1.0]], [0, [235.5394313425861, 1.0]], [0, [76.9302572967182, 1.0]], [0, [11.855668293348085, 1.0]], [0, [28.47617307314139, 1.0]], [0, [0.3159661088714432, 1.0]], [0, [2.0759275885562576, 1.0]], [0, [5.493634094182405, 1.0]], [1, [3.6810265642050854, 1.0]], [1, [12.448008728561543, 1.0]], [1, [54.764074544709835, 1.0]], [1, [0.3296780279522425, 1.0]], [1, [1.141787201071061, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82980694]
bas 1, expnt(s) = [24413.79415246]
bas 2, expnt(s) = [3661.45329775]
bas 3, expnt(s) = [833.29262761]
bas 4, expnt(s) = [235.53943134]
bas 5, expnt(s) = [76.9302573]
bas 6, expnt(s) = [11.85566829]
bas 7, expnt(s) = [28.47617307]
bas 8, expnt(s) = [0.31596611]
bas 9, expnt(s) = [2.07592759]
bas 10, expnt(s) = [5.49363409]
bas 11, expnt(s) = [3.68102656]
bas 12, expnt(s) = [12.44800873]
bas 13, expnt(s) = [54.76407454]
bas 14, expnt(s) = [0.32967803]
bas 15, expnt(s) = [1.1417872]
CPU time:       333.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.29806939e-01 2.19658403e+00 2.44137942e+04 4.93448102e+03
 3.66145330e+03 1.18920068e+03 8.33292628e+02 3.91843980e+02
 2.35539431e+02 1.51901737e+02 7.69302573e+01 6.56278101e+01
 1.18556683e+01 1.61420822e+01 2.84761731e+01 3.11441328e+01
 3.15966109e-01 1.06474449e+00 2.07592759e+00 4.36942385e+00
 5.49363409e+00 9.06587698e+00 3.68102656e+00 1.48746098e+01
 1.24480087e+01 6.82117588e+01 5.47640745e+01 4.34614372e+02
 3.29678028e-01 7.28780758e-01 1.14178720e+00 3.44322859e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998501329420517
cond(S) = 1434.0441905839455
E1 = -183.57820951890776  E_coul = 55.07847051986811
init E= -128.49973899904
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77394725794538  LUMO = 0.850692600604798
  mo_energy =
[-3.25554744e+01 -1.85291211e+00 -7.73947258e-01 -7.73947258e-01
 -7.73947258e-01  8.50692601e-01  1.11309723e+00  1.11309723e+00
  1.11309723e+00  4.72387879e+00  5.76663111e+00  5.76663111e+00
  5.76663111e+00  1.73024972e+01  2.41913811e+01  2.41913811e+01
  2.41913811e+01  5.45142778e+01  1.19057942e+02  1.19057942e+02
  1.19057942e+02  1.65680771e+02  5.31907953e+02  1.89790009e+03
  8.02452882e+03  4.77880688e+04]
E1 = -182.1108572079289  E_coul = 53.581724875942314
cycle= 1 E= -128.529132331987  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461386
diis-c [-0.21287665  1.        ]
  HOMO = -0.879633003334899  LUMO = 0.821573803026493
  mo_energy =
[-3.28741274e+01 -1.96320087e+00 -8.79633003e-01 -8.79633003e-01
 -8.79633003e-01  8.21573803e-01  1.07496632e+00  1.07496632e+00
  1.07496632e+00  4.63629387e+00  5.63779556e+00  5.63779556e+00
  5.63779556e+00  1.71294679e+01  2.39563912e+01  2.39563912e+01
  2.39563912e+01  5.42606735e+01  1.18737015e+02  1.18737015e+02
  1.18737015e+02  1.65367723e+02  5.31551374e+02  1.89750692e+03
  8.02410636e+03  4.77876274e+04]
E1 = -182.84320129601622  E_coul = 54.31156259262354
cycle= 2 E= -128.531638703393  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230739
diis-c [-0.00069445  0.33228316  0.66771684]
  HOMO = -0.845272003175372  LUMO = 0.831029154911587
  mo_energy =
[-3.27691091e+01 -1.92707508e+00 -8.45272003e-01 -8.45272003e-01
 -8.45272003e-01  8.31029155e-01  1.08743056e+00  1.08743056e+00
  1.08743056e+00  4.66460828e+00  5.67968930e+00  5.67968930e+00
  5.67968930e+00  1.71861901e+01  2.40339483e+01  2.40339483e+01
  2.40339483e+01  5.43446394e+01  1.18842060e+02  1.18842060e+02
  1.18842060e+02  1.65470588e+02  5.31664764e+02  1.89762567e+03
  8.02422759e+03  4.77877496e+04]
E1 = -182.59768340589213  E_coul = 54.06519682924943
cycle= 3 E= -128.532486576643  delta_E= -0.000848  |g|= 0.00045  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000889703
diis-c [-1.45437742e-07 -2.22835981e-03 -9.79338496e-04  1.00320770e+00]
  HOMO = -0.845498315325948  LUMO = 0.83099323228025
  mo_energy =
[-3.27694945e+01 -1.92723600e+00 -8.45498315e-01 -8.45498315e-01
 -8.45498315e-01  8.30993232e-01  1.08738315e+00  1.08738315e+00
  1.08738315e+00  4.66447455e+00  5.67949591e+00  5.67949591e+00
  5.67949591e+00  1.71859473e+01  2.40336429e+01  2.40336429e+01
  2.40336429e+01  5.43443223e+01  1.18841663e+02  1.18841663e+02
  1.18841663e+02  1.65470201e+02  5.31664279e+02  1.89762507e+03
  8.02422691e+03  4.77877489e+04]
E1 = -182.59812080591018  E_coul = 54.065634209490945
cycle= 4 E= -128.532486596419  delta_E= -1.98e-08  |g|= 6.44e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134257
diis-c [-1.02645733e-09  3.19824154e-04  4.93599774e-04 -2.12749573e-01
  1.21193615e+00]
  HOMO = -0.845530859403902  LUMO = 0.830985993466544
  mo_energy =
[-3.27695481e+01 -1.92725596e+00 -8.45530859e-01 -8.45530859e-01
 -8.45530859e-01  8.30985993e-01  1.08736954e+00  1.08736954e+00
  1.08736954e+00  4.66445076e+00  5.67945990e+00  5.67945990e+00
  5.67945990e+00  1.71859066e+01  2.40335947e+01  2.40335947e+01
  2.40335947e+01  5.43442733e+01  1.18841608e+02  1.18841608e+02
  1.18841608e+02  1.65470147e+02  5.31664218e+02  1.89762500e+03
  8.02422683e+03  4.77877488e+04]
E1 = -182.59822697933816  E_coul = 54.06574038236612
cycle= 5 E= -128.532486596972  delta_E= -5.53e-10  |g|= 6.74e-06  |ddm|= 5.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59822697933816  E_coul = 54.06574038236612
  HOMO = -0.845527174805172  LUMO = 0.830987539974489
  mo_energy =
[-3.27695400e+01 -1.92725155e+00 -8.45527175e-01 -8.45527175e-01
 -8.45527175e-01  8.30987540e-01  1.08737108e+00  1.08737108e+00
  1.08737108e+00  4.66445441e+00  5.67946438e+00  5.67946438e+00
  5.67946438e+00  1.71859125e+01  2.40336016e+01  2.40336016e+01
  2.40336016e+01  5.43442806e+01  1.18841616e+02  1.18841616e+02
  1.18841616e+02  1.65470155e+02  5.31664225e+02  1.89762501e+03
  8.02422684e+03  4.77877488e+04]
E1 = -182.5982092690028  E_coul = 54.06572267202768
Extra cycle  E= -128.532486596975  delta_E= -3.1e-12  |g|= 2.48e-06  |ddm|= 2.44e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.29806939e-01 2.44137942e+04 3.66145330e+03 8.33292628e+02
 2.35539431e+02 7.69302573e+01 1.18556683e+01 2.84761731e+01
 3.15966109e-01 2.07592759e+00 5.49363409e+00 3.68102656e+00
 1.24480087e+01 5.47640745e+01 3.29678028e-01 1.14178720e+00]
E = -128.53248659697513
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.829806939194       1
[INPUT] 0    0    [1    /1   ]  24413.7941525        1
[INPUT] 0    0    [1    /1   ]  3661.45329775        1
[INPUT] 0    0    [1    /1   ]  833.292627615        1
[INPUT] 0    0    [1    /1   ]  235.539431343        1
[INPUT] 0    0    [1    /1   ]  76.9302572967        1
[INPUT] 0    0    [1    /1   ]  11.8556682933        1
[INPUT] 0    0    [1    /1   ]  28.4761730731        1
[INPUT] 0    0    [1    /1   ]  0.315966108871       1
[INPUT] 0    0    [1    /1   ]  2.07592758856        1
[INPUT] 0    0    [1    /1   ]  5.49363409418        1
[INPUT] 1    0    [1    /1   ]  3.68102656421        1
[INPUT] 1    0    [1    /1   ]  12.4480087286        1
[INPUT] 1    0    [1    /1   ]  54.7640745447        1
[INPUT] 1    0    [1    /1   ]  0.329678027952       1
[INPUT] 1    0    [1    /1   ]  1.14178720107        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8298069391943842, 1.0]], [0, [24413.794152460316, 1.0]], [0, [3661.453297754788, 1.0]], [0, [833.292627614692, 1.0]], [0, [235.5394313425861, 1.0]], [0, [76.9302572967182, 1.0]], [0, [11.855668293348085, 1.0]], [0, [28.47617307314139, 1.0]], [0, [0.3159661088714432, 1.0]], [0, [2.0759275885562576, 1.0]], [0, [5.493634094182405, 1.0]], [1, [3.6810265642050854, 1.0]], [1, [12.448008728561543, 1.0]], [1, [54.764074544709835, 1.0]], [1, [0.3296780279522425, 1.0]], [1, [1.141787201071061, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82980694]
bas 1, expnt(s) = [24413.79415246]
bas 2, expnt(s) = [3661.45329775]
bas 3, expnt(s) = [833.29262761]
bas 4, expnt(s) = [235.53943134]
bas 5, expnt(s) = [76.9302573]
bas 6, expnt(s) = [11.85566829]
bas 7, expnt(s) = [28.47617307]
bas 8, expnt(s) = [0.31596611]
bas 9, expnt(s) = [2.07592759]
bas 10, expnt(s) = [5.49363409]
bas 11, expnt(s) = [3.68102656]
bas 12, expnt(s) = [12.44800873]
bas 13, expnt(s) = [54.76407454]
bas 14, expnt(s) = [0.32967803]
bas 15, expnt(s) = [1.1417872]
CPU time:       334.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.29806939e-01 2.19658403e+00 2.44137942e+04 4.93448102e+03
 3.66145330e+03 1.18920068e+03 8.33292628e+02 3.91843980e+02
 2.35539431e+02 1.51901737e+02 7.69302573e+01 6.56278101e+01
 1.18556683e+01 1.61420822e+01 2.84761731e+01 3.11441328e+01
 3.15966109e-01 1.06474449e+00 2.07592759e+00 4.36942385e+00
 5.49363409e+00 9.06587698e+00 3.68102656e+00 1.48746098e+01
 1.24480087e+01 6.82117588e+01 5.47640745e+01 4.34614372e+02
 3.29678028e-01 7.28780758e-01 1.14178720e+00 3.44322859e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998501329420517
cond(S) = 1434.0441905839455
E1 = -183.57820951890776  E_coul = 55.07847051986811
init E= -128.49973899904
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77394725794538  LUMO = 0.850692600604798
  mo_energy =
[-3.25554744e+01 -1.85291211e+00 -7.73947258e-01 -7.73947258e-01
 -7.73947258e-01  8.50692601e-01  1.11309723e+00  1.11309723e+00
  1.11309723e+00  4.72387879e+00  5.76663111e+00  5.76663111e+00
  5.76663111e+00  1.73024972e+01  2.41913811e+01  2.41913811e+01
  2.41913811e+01  5.45142778e+01  1.19057942e+02  1.19057942e+02
  1.19057942e+02  1.65680771e+02  5.31907953e+02  1.89790009e+03
  8.02452882e+03  4.77880688e+04]
E1 = -182.1108572079289  E_coul = 53.581724875942314
cycle= 1 E= -128.529132331987  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461386
diis-c [-0.21287665  1.        ]
  HOMO = -0.879633003334899  LUMO = 0.821573803026493
  mo_energy =
[-3.28741274e+01 -1.96320087e+00 -8.79633003e-01 -8.79633003e-01
 -8.79633003e-01  8.21573803e-01  1.07496632e+00  1.07496632e+00
  1.07496632e+00  4.63629387e+00  5.63779556e+00  5.63779556e+00
  5.63779556e+00  1.71294679e+01  2.39563912e+01  2.39563912e+01
  2.39563912e+01  5.42606735e+01  1.18737015e+02  1.18737015e+02
  1.18737015e+02  1.65367723e+02  5.31551374e+02  1.89750692e+03
  8.02410636e+03  4.77876274e+04]
E1 = -182.84320129601622  E_coul = 54.31156259262354
cycle= 2 E= -128.531638703393  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230739
diis-c [-0.00069445  0.33228316  0.66771684]
  HOMO = -0.845272003175372  LUMO = 0.831029154911587
  mo_energy =
[-3.27691091e+01 -1.92707508e+00 -8.45272003e-01 -8.45272003e-01
 -8.45272003e-01  8.31029155e-01  1.08743056e+00  1.08743056e+00
  1.08743056e+00  4.66460828e+00  5.67968930e+00  5.67968930e+00
  5.67968930e+00  1.71861901e+01  2.40339483e+01  2.40339483e+01
  2.40339483e+01  5.43446394e+01  1.18842060e+02  1.18842060e+02
  1.18842060e+02  1.65470588e+02  5.31664764e+02  1.89762567e+03
  8.02422759e+03  4.77877496e+04]
E1 = -182.59768340589213  E_coul = 54.06519682924943
cycle= 3 E= -128.532486576643  delta_E= -0.000848  |g|= 0.00045  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000889703
diis-c [-1.45437742e-07 -2.22835981e-03 -9.79338496e-04  1.00320770e+00]
  HOMO = -0.845498315325948  LUMO = 0.83099323228025
  mo_energy =
[-3.27694945e+01 -1.92723600e+00 -8.45498315e-01 -8.45498315e-01
 -8.45498315e-01  8.30993232e-01  1.08738315e+00  1.08738315e+00
  1.08738315e+00  4.66447455e+00  5.67949591e+00  5.67949591e+00
  5.67949591e+00  1.71859473e+01  2.40336429e+01  2.40336429e+01
  2.40336429e+01  5.43443223e+01  1.18841663e+02  1.18841663e+02
  1.18841663e+02  1.65470201e+02  5.31664279e+02  1.89762507e+03
  8.02422691e+03  4.77877489e+04]
E1 = -182.59812080591018  E_coul = 54.065634209490945
cycle= 4 E= -128.532486596419  delta_E= -1.98e-08  |g|= 6.44e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134257
diis-c [-1.02645733e-09  3.19824154e-04  4.93599774e-04 -2.12749573e-01
  1.21193615e+00]
  HOMO = -0.845530859403902  LUMO = 0.830985993466544
  mo_energy =
[-3.27695481e+01 -1.92725596e+00 -8.45530859e-01 -8.45530859e-01
 -8.45530859e-01  8.30985993e-01  1.08736954e+00  1.08736954e+00
  1.08736954e+00  4.66445076e+00  5.67945990e+00  5.67945990e+00
  5.67945990e+00  1.71859066e+01  2.40335947e+01  2.40335947e+01
  2.40335947e+01  5.43442733e+01  1.18841608e+02  1.18841608e+02
  1.18841608e+02  1.65470147e+02  5.31664218e+02  1.89762500e+03
  8.02422683e+03  4.77877488e+04]
E1 = -182.59822697933816  E_coul = 54.06574038236612
cycle= 5 E= -128.532486596972  delta_E= -5.53e-10  |g|= 6.74e-06  |ddm|= 5.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59822697933816  E_coul = 54.06574038236612
  HOMO = -0.845527174805172  LUMO = 0.830987539974489
  mo_energy =
[-3.27695400e+01 -1.92725155e+00 -8.45527175e-01 -8.45527175e-01
 -8.45527175e-01  8.30987540e-01  1.08737108e+00  1.08737108e+00
  1.08737108e+00  4.66445441e+00  5.67946438e+00  5.67946438e+00
  5.67946438e+00  1.71859125e+01  2.40336016e+01  2.40336016e+01
  2.40336016e+01  5.43442806e+01  1.18841616e+02  1.18841616e+02
  1.18841616e+02  1.65470155e+02  5.31664225e+02  1.89762501e+03
  8.02422684e+03  4.77877488e+04]
E1 = -182.5982092690028  E_coul = 54.06572267202768
Extra cycle  E= -128.532486596975  delta_E= -3.1e-12  |g|= 2.48e-06  |ddm|= 2.44e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1434.0441905839455
E1 = -182.5982092690028  E_coul = 54.06572267202768
init E= -128.532486596975
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845528413659405  LUMO = 0.830987271064044
  mo_energy =
[-3.27695440e+01 -1.92725274e+00 -8.45528414e-01 -8.45528414e-01
 -8.45528414e-01  8.30987271e-01  1.08737065e+00  1.08737065e+00
  1.08737065e+00  4.66445347e+00  5.67946287e+00  5.67946287e+00
  5.67946287e+00  1.71859105e+01  2.40335987e+01  2.40335987e+01
  2.40335987e+01  5.43442775e+01  1.18841612e+02  1.18841612e+02
  1.18841612e+02  1.65470151e+02  5.31664221e+02  1.89762501e+03
  8.02422684e+03  4.77877488e+04]
E1 = -182.59821881494472  E_coul = 54.06573221796946
cycle= 1 E= -128.532486596975  delta_E= -1.14e-13  |g|= 1.31e-06  |ddm|= 9.49e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59821881494472  E_coul = 54.06573221796946
  HOMO = -0.845527742629232  LUMO = 0.830987468266067
  mo_energy =
[-3.27695420e+01 -1.92725201e+00 -8.45527743e-01 -8.45527743e-01
 -8.45527743e-01  8.30987468e-01  1.08737090e+00  1.08737090e+00
  1.08737090e+00  4.66445404e+00  5.67946369e+00  5.67946369e+00
  5.67946369e+00  1.71859116e+01  2.40336003e+01  2.40336003e+01
  2.40336003e+01  5.43442791e+01  1.18841614e+02  1.18841614e+02
  1.18841614e+02  1.65470153e+02  5.31664223e+02  1.89762501e+03
  8.02422684e+03  4.77877488e+04]
E1 = -182.5982140718707  E_coul = 54.065727474895255
Extra cycle  E= -128.532486596975  delta_E= -1.99e-13  |g|= 6.46e-07  |ddm|= 4.63e-07
    CPU time for scf_cycle      0.27 sec, wall time      0.27 sec
exp = [8.29806939e-01 2.44137942e+04 3.66145330e+03 8.33292628e+02
 2.35539431e+02 7.69302573e+01 1.18556683e+01 2.84761731e+01
 3.15966109e-01 2.07592759e+00 5.49363409e+00 3.68102656e+00
 1.24480087e+01 5.47640745e+01 3.29678028e-01 1.14178720e+00]
grad_E = [ 2.09254875e-04 -2.26459813e-10  1.30318597e-08 -3.41297891e-07
  5.39113565e-06 -2.87831423e-05 -2.74383311e-05 -4.80153301e-05
 -1.12662673e-04 -4.69613985e-05  4.93753731e-05  1.02090663e-04
  2.11731862e-05 -1.82319344e-06  7.65464311e-04 -6.86063897e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.841653544199       1
[INPUT] 0    0    [1    /1   ]  24413.7941583        1
[INPUT] 0    0    [1    /1   ]  3661.45299097        1
[INPUT] 0    0    [1    /1   ]  833.298601947        1
[INPUT] 0    0    [1    /1   ]  235.477483667        1
[INPUT] 0    0    [1    /1   ]  77.1800566684        1
[INPUT] 0    0    [1    /1   ]  11.8995455378        1
[INPUT] 0    0    [1    /1   ]  28.5874793215        1
[INPUT] 0    0    [1    /1   ]  0.319597844463       1
[INPUT] 0    0    [1    /1   ]  2.09689485066        1
[INPUT] 0    0    [1    /1   ]  5.56387374026        1
[INPUT] 1    0    [1    /1   ]  3.67927063097        1
[INPUT] 1    0    [1    /1   ]  12.4460039889        1
[INPUT] 1    0    [1    /1   ]  54.7609910835        1
[INPUT] 1    0    [1    /1   ]  0.329471198745       1
[INPUT] 1    0    [1    /1   ]  1.14082303359        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8416535441993546, 1.0]], [0, [24413.79415829486, 1.0]], [0, [3661.4529909743846, 1.0]], [0, [833.298601946768, 1.0]], [0, [235.47748366690175, 1.0]], [0, [77.18005666836802, 1.0]], [0, [11.899545537755191, 1.0]], [0, [28.587479321506812, 1.0]], [0, [0.31959784446278316, 1.0]], [0, [2.09689485065633, 1.0]], [0, [5.563873740264266, 1.0]], [1, [3.6792706309700023, 1.0]], [1, [12.446003988940271, 1.0]], [1, [54.76099108348395, 1.0]], [1, [0.3294711987447966, 1.0]], [1, [1.1408230335925014, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84165354]
bas 1, expnt(s) = [24413.79415829]
bas 2, expnt(s) = [3661.45299097]
bas 3, expnt(s) = [833.29860195]
bas 4, expnt(s) = [235.47748367]
bas 5, expnt(s) = [77.18005667]
bas 6, expnt(s) = [11.89954554]
bas 7, expnt(s) = [28.58747932]
bas 8, expnt(s) = [0.31959784]
bas 9, expnt(s) = [2.09689485]
bas 10, expnt(s) = [5.56387374]
bas 11, expnt(s) = [3.67927063]
bas 12, expnt(s) = [12.44600399]
bas 13, expnt(s) = [54.76099108]
bas 14, expnt(s) = [0.3294712]
bas 15, expnt(s) = [1.14082303]
CPU time:       338.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.41653544e-01 2.22006169e+00 2.44137942e+04 4.93448102e+03
 3.66145299e+03 1.18920060e+03 8.33298602e+02 3.91846087e+02
 2.35477484e+02 1.51871773e+02 7.71800567e+01 6.57875698e+01
 1.18995455e+01 1.61868673e+01 2.85874793e+01 3.12353892e+01
 3.19597844e-01 1.07391005e+00 2.09689485e+00 4.40248124e+00
 5.56387374e+00 9.15267358e+00 3.67927063e+00 1.48657409e+01
 1.24460040e+01 6.81980273e+01 5.47609911e+01 4.34583784e+02
 3.29471199e-01 7.28209286e-01 1.14082303e+00 3.43959449e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99850581688418
cond(S) = 1470.3106328417427
E1 = -183.5781643834516  E_coul = 55.07846311924734
init E= -128.499701264204
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773948392226204  LUMO = 0.8654433783854
  mo_energy =
[-3.25554793e+01 -1.85291211e+00 -7.73948392e-01 -7.73948392e-01
 -7.73948392e-01  8.65443378e-01  1.11215327e+00  1.11215327e+00
  1.11215327e+00  4.79785338e+00  5.76208250e+00  5.76208250e+00
  5.76208250e+00  1.75320990e+01  2.41802797e+01  2.41802797e+01
  2.41802797e+01  5.50161084e+01  1.19038767e+02  1.19038767e+02
  1.19038767e+02  1.66655692e+02  5.33440513e+02  1.89954902e+03
  8.02602575e+03  4.77893170e+04]
E1 = -182.11070205277093  E_coul = 53.5815632957594
cycle= 1 E= -128.529138757012  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.461328
diis-c [-0.21282379  1.        ]
  HOMO = -0.879643731348411  LUMO = 0.835800735396523
  mo_energy =
[-3.28741648e+01 -1.96321602e+00 -8.79643731e-01 -8.79643731e-01
 -8.79643731e-01  8.35800735e-01  1.07405711e+00  1.07405711e+00
  1.07405711e+00  4.70934807e+00  5.63328676e+00  5.63328676e+00
  5.63328676e+00  1.73582005e+01  2.39452743e+01  2.39452743e+01
  2.39452743e+01  5.47621088e+01  1.18717810e+02  1.18717810e+02
  1.18717810e+02  1.66342485e+02  5.33083892e+02  1.89915584e+03
  8.02560326e+03  4.77888756e+04]
E1 = -182.84318330937896  E_coul = 54.31153754200077
cycle= 2 E= -128.531645767378  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230726
diis-c [-0.00069637  0.33229455  0.66770545]
  HOMO = -0.845276602860548  LUMO = 0.845424381408502
  mo_energy =
[-3.27691304e+01 -1.92708317e+00 -8.45276603e-01 -8.45276603e-01
 -8.45276603e-01  8.45424381e-01  1.08651127e+00  1.08651127e+00
  1.08651127e+00  4.73796558e+00  5.67517106e+00  5.67517106e+00
  5.67517106e+00  1.74152184e+01  2.40228399e+01  2.40228399e+01
  2.40228399e+01  5.48462102e+01  1.18822871e+02  1.18822871e+02
  1.18822871e+02  1.66445401e+02  5.33197301e+02  1.89927461e+03
  8.02572451e+03  4.77889978e+04]
E1 = -182.59761994076646  E_coul = 54.065126002905146
cycle= 3 E= -128.532493937861  delta_E= -0.000848  |g|= 0.000448  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000887058
diis-c [-1.42982178e-07 -2.22294327e-03 -9.74065482e-04  1.00319701e+00]
  HOMO = -0.845502235841841  LUMO = 0.845388010650517
  mo_energy =
[-3.27695148e+01 -1.92724362e+00 -8.45502236e-01 -8.45502236e-01
 -8.45502236e-01  8.45388011e-01  1.08646429e+00  1.08646429e+00
  1.08646429e+00  4.73783101e+00  5.67497851e+00  5.67497851e+00
  5.67497851e+00  1.74149756e+01  2.40225354e+01  2.40225354e+01
  2.40225354e+01  5.48458938e+01  1.18822475e+02  1.18822475e+02
  1.18822475e+02  1.66445015e+02  5.33196817e+02  1.89927401e+03
  8.02572383e+03  4.77889970e+04]
E1 = -182.59805605908142  E_coul = 54.065562101630455
cycle= 4 E= -128.532493957451  delta_E= -1.96e-08  |g|= 6.42e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134082
diis-c [-1.02210636e-09  3.18223681e-04  4.94630532e-04 -2.12156057e-01
  1.21134320e+00]
  HOMO = -0.845534711837255  LUMO = 0.845380655519749
  mo_energy =
[-3.27695684e+01 -1.92726359e+00 -8.45534712e-01 -8.45534712e-01
 -8.45534712e-01  8.45380656e-01  1.08645074e+00  1.08645074e+00
  1.08645074e+00  4.73780704e+00  5.67494257e+00  5.67494257e+00
  5.67494257e+00  1.74149348e+01  2.40224873e+01  2.40224873e+01
  2.40224873e+01  5.48458447e+01  1.18822421e+02  1.18822421e+02
  1.18822421e+02  1.66444961e+02  5.33196756e+02  1.89927394e+03
  8.02572375e+03  4.77889970e+04]
E1 = -182.5981625247594  E_coul = 54.06566856676078
cycle= 5 E= -128.532493957999  delta_E= -5.48e-10  |g|= 6.71e-06  |ddm|= 5.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5981625247594  E_coul = 54.06566856676078
  HOMO = -0.845531043385272  LUMO = 0.845382219973894
  mo_energy =
[-3.27695604e+01 -1.92725920e+00 -8.45531043e-01 -8.45531043e-01
 -8.45531043e-01  8.45382220e-01  1.08645228e+00  1.08645228e+00
  1.08645228e+00  4.73781070e+00  5.67494702e+00  5.67494702e+00
  5.67494702e+00  1.74149406e+01  2.40224941e+01  2.40224941e+01
  2.40224941e+01  5.48458520e+01  1.18822428e+02  1.18822428e+02
  1.18822428e+02  1.66444969e+02  5.33196764e+02  1.89927395e+03
  8.02572376e+03  4.77889970e+04]
E1 = -182.5981448884019  E_coul = 54.06565093040081
Extra cycle  E= -128.532493958001  delta_E= -2.47e-12  |g|= 2.47e-06  |ddm|= 2.42e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [8.41653544e-01 2.44137942e+04 3.66145299e+03 8.33298602e+02
 2.35477484e+02 7.71800567e+01 1.18995455e+01 2.85874793e+01
 3.19597844e-01 2.09689485e+00 5.56387374e+00 3.67927063e+00
 1.24460040e+01 5.47609911e+01 3.29471199e-01 1.14082303e+00]
E = -128.53249395800108
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:02:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.841653544199       1
[INPUT] 0    0    [1    /1   ]  24413.7941583        1
[INPUT] 0    0    [1    /1   ]  3661.45299097        1
[INPUT] 0    0    [1    /1   ]  833.298601947        1
[INPUT] 0    0    [1    /1   ]  235.477483667        1
[INPUT] 0    0    [1    /1   ]  77.1800566684        1
[INPUT] 0    0    [1    /1   ]  11.8995455378        1
[INPUT] 0    0    [1    /1   ]  28.5874793215        1
[INPUT] 0    0    [1    /1   ]  0.319597844463       1
[INPUT] 0    0    [1    /1   ]  2.09689485066        1
[INPUT] 0    0    [1    /1   ]  5.56387374026        1
[INPUT] 1    0    [1    /1   ]  3.67927063097        1
[INPUT] 1    0    [1    /1   ]  12.4460039889        1
[INPUT] 1    0    [1    /1   ]  54.7609910835        1
[INPUT] 1    0    [1    /1   ]  0.329471198745       1
[INPUT] 1    0    [1    /1   ]  1.14082303359        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8416535441993546, 1.0]], [0, [24413.79415829486, 1.0]], [0, [3661.4529909743846, 1.0]], [0, [833.298601946768, 1.0]], [0, [235.47748366690175, 1.0]], [0, [77.18005666836802, 1.0]], [0, [11.899545537755191, 1.0]], [0, [28.587479321506812, 1.0]], [0, [0.31959784446278316, 1.0]], [0, [2.09689485065633, 1.0]], [0, [5.563873740264266, 1.0]], [1, [3.6792706309700023, 1.0]], [1, [12.446003988940271, 1.0]], [1, [54.76099108348395, 1.0]], [1, [0.3294711987447966, 1.0]], [1, [1.1408230335925014, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84165354]
bas 1, expnt(s) = [24413.79415829]
bas 2, expnt(s) = [3661.45299097]
bas 3, expnt(s) = [833.29860195]
bas 4, expnt(s) = [235.47748367]
bas 5, expnt(s) = [77.18005667]
bas 6, expnt(s) = [11.89954554]
bas 7, expnt(s) = [28.58747932]
bas 8, expnt(s) = [0.31959784]
bas 9, expnt(s) = [2.09689485]
bas 10, expnt(s) = [5.56387374]
bas 11, expnt(s) = [3.67927063]
bas 12, expnt(s) = [12.44600399]
bas 13, expnt(s) = [54.76099108]
bas 14, expnt(s) = [0.3294712]
bas 15, expnt(s) = [1.14082303]
CPU time:       339.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.41653544e-01 2.22006169e+00 2.44137942e+04 4.93448102e+03
 3.66145299e+03 1.18920060e+03 8.33298602e+02 3.91846087e+02
 2.35477484e+02 1.51871773e+02 7.71800567e+01 6.57875698e+01
 1.18995455e+01 1.61868673e+01 2.85874793e+01 3.12353892e+01
 3.19597844e-01 1.07391005e+00 2.09689485e+00 4.40248124e+00
 5.56387374e+00 9.15267358e+00 3.67927063e+00 1.48657409e+01
 1.24460040e+01 6.81980273e+01 5.47609911e+01 4.34583784e+02
 3.29471199e-01 7.28209286e-01 1.14082303e+00 3.43959449e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99850581688418
cond(S) = 1470.3106328417427
E1 = -183.5781643834516  E_coul = 55.07846311924734
init E= -128.499701264204
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948392226204  LUMO = 0.8654433783854
  mo_energy =
[-3.25554793e+01 -1.85291211e+00 -7.73948392e-01 -7.73948392e-01
 -7.73948392e-01  8.65443378e-01  1.11215327e+00  1.11215327e+00
  1.11215327e+00  4.79785338e+00  5.76208250e+00  5.76208250e+00
  5.76208250e+00  1.75320990e+01  2.41802797e+01  2.41802797e+01
  2.41802797e+01  5.50161084e+01  1.19038767e+02  1.19038767e+02
  1.19038767e+02  1.66655692e+02  5.33440513e+02  1.89954902e+03
  8.02602575e+03  4.77893170e+04]
E1 = -182.11070205277093  E_coul = 53.5815632957594
cycle= 1 E= -128.529138757012  delta_E= -0.0294  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461328
diis-c [-0.21282379  1.        ]
  HOMO = -0.879643731348411  LUMO = 0.835800735396523
  mo_energy =
[-3.28741648e+01 -1.96321602e+00 -8.79643731e-01 -8.79643731e-01
 -8.79643731e-01  8.35800735e-01  1.07405711e+00  1.07405711e+00
  1.07405711e+00  4.70934807e+00  5.63328676e+00  5.63328676e+00
  5.63328676e+00  1.73582005e+01  2.39452743e+01  2.39452743e+01
  2.39452743e+01  5.47621088e+01  1.18717810e+02  1.18717810e+02
  1.18717810e+02  1.66342485e+02  5.33083892e+02  1.89915584e+03
  8.02560326e+03  4.77888756e+04]
E1 = -182.84318330937896  E_coul = 54.31153754200077
cycle= 2 E= -128.531645767378  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230726
diis-c [-0.00069637  0.33229455  0.66770545]
  HOMO = -0.845276602860548  LUMO = 0.845424381408502
  mo_energy =
[-3.27691304e+01 -1.92708317e+00 -8.45276603e-01 -8.45276603e-01
 -8.45276603e-01  8.45424381e-01  1.08651127e+00  1.08651127e+00
  1.08651127e+00  4.73796558e+00  5.67517106e+00  5.67517106e+00
  5.67517106e+00  1.74152184e+01  2.40228399e+01  2.40228399e+01
  2.40228399e+01  5.48462102e+01  1.18822871e+02  1.18822871e+02
  1.18822871e+02  1.66445401e+02  5.33197301e+02  1.89927461e+03
  8.02572451e+03  4.77889978e+04]
E1 = -182.59761994076646  E_coul = 54.065126002905146
cycle= 3 E= -128.532493937861  delta_E= -0.000848  |g|= 0.000448  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000887058
diis-c [-1.42982178e-07 -2.22294327e-03 -9.74065482e-04  1.00319701e+00]
  HOMO = -0.845502235841841  LUMO = 0.845388010650517
  mo_energy =
[-3.27695148e+01 -1.92724362e+00 -8.45502236e-01 -8.45502236e-01
 -8.45502236e-01  8.45388011e-01  1.08646429e+00  1.08646429e+00
  1.08646429e+00  4.73783101e+00  5.67497851e+00  5.67497851e+00
  5.67497851e+00  1.74149756e+01  2.40225354e+01  2.40225354e+01
  2.40225354e+01  5.48458938e+01  1.18822475e+02  1.18822475e+02
  1.18822475e+02  1.66445015e+02  5.33196817e+02  1.89927401e+03
  8.02572383e+03  4.77889970e+04]
E1 = -182.59805605908142  E_coul = 54.065562101630455
cycle= 4 E= -128.532493957451  delta_E= -1.96e-08  |g|= 6.42e-05  |ddm|= 0.000304
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134082
diis-c [-1.02210636e-09  3.18223681e-04  4.94630532e-04 -2.12156057e-01
  1.21134320e+00]
  HOMO = -0.845534711837255  LUMO = 0.845380655519749
  mo_energy =
[-3.27695684e+01 -1.92726359e+00 -8.45534712e-01 -8.45534712e-01
 -8.45534712e-01  8.45380656e-01  1.08645074e+00  1.08645074e+00
  1.08645074e+00  4.73780704e+00  5.67494257e+00  5.67494257e+00
  5.67494257e+00  1.74149348e+01  2.40224873e+01  2.40224873e+01
  2.40224873e+01  5.48458447e+01  1.18822421e+02  1.18822421e+02
  1.18822421e+02  1.66444961e+02  5.33196756e+02  1.89927394e+03
  8.02572375e+03  4.77889970e+04]
E1 = -182.5981625247594  E_coul = 54.06566856676078
cycle= 5 E= -128.532493957999  delta_E= -5.48e-10  |g|= 6.71e-06  |ddm|= 5.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5981625247594  E_coul = 54.06566856676078
  HOMO = -0.845531043385272  LUMO = 0.845382219973894
  mo_energy =
[-3.27695604e+01 -1.92725920e+00 -8.45531043e-01 -8.45531043e-01
 -8.45531043e-01  8.45382220e-01  1.08645228e+00  1.08645228e+00
  1.08645228e+00  4.73781070e+00  5.67494702e+00  5.67494702e+00
  5.67494702e+00  1.74149406e+01  2.40224941e+01  2.40224941e+01
  2.40224941e+01  5.48458520e+01  1.18822428e+02  1.18822428e+02
  1.18822428e+02  1.66444969e+02  5.33196764e+02  1.89927395e+03
  8.02572376e+03  4.77889970e+04]
E1 = -182.5981448884019  E_coul = 54.06565093040081
Extra cycle  E= -128.532493958001  delta_E= -2.47e-12  |g|= 2.47e-06  |ddm|= 2.42e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1470.3106328417427
E1 = -182.5981448884019  E_coul = 54.06565093040081
init E= -128.532493958001
    CPU time for initialize scf      0.22 sec, wall time      0.22 sec
  HOMO = -0.845532277175162  LUMO = 0.845381947202929
  mo_energy =
[-3.27695643e+01 -1.92726038e+00 -8.45532277e-01 -8.45532277e-01
 -8.45532277e-01  8.45381947e-01  1.08645185e+00  1.08645185e+00
  1.08645185e+00  4.73780975e+00  5.67494552e+00  5.67494552e+00
  5.67494552e+00  1.74149386e+01  2.40224913e+01  2.40224913e+01
  2.40224913e+01  5.48458489e+01  1.18822424e+02  1.18822424e+02
  1.18822424e+02  1.66444965e+02  5.33196759e+02  1.89927394e+03
  8.02572376e+03  4.77889970e+04]
E1 = -182.59815439472797  E_coul = 54.065660436726425
cycle= 1 E= -128.532493958002  delta_E= -4.55e-13  |g|= 1.3e-06  |ddm|= 9.45e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59815439472797  E_coul = 54.065660436726425
  HOMO = -0.845531608952063  LUMO = 0.845382147019823
  mo_energy =
[-3.27695623e+01 -1.92725965e+00 -8.45531609e-01 -8.45531609e-01
 -8.45531609e-01  8.45382147e-01  1.08645209e+00  1.08645209e+00
  1.08645209e+00  4.73781033e+00  5.67494634e+00  5.67494634e+00
  5.67494634e+00  1.74149397e+01  2.40224928e+01  2.40224928e+01
  2.40224928e+01  5.48458505e+01  1.18822427e+02  1.18822427e+02
  1.18822427e+02  1.66444967e+02  5.33196762e+02  1.89927395e+03
  8.02572376e+03  4.77889970e+04]
E1 = -182.5981496712217  E_coul = 54.065655713219776
Extra cycle  E= -128.532493958002  delta_E= -3.98e-13  |g|= 6.43e-07  |ddm|= 4.61e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.27 sec
exp = [8.41653544e-01 2.44137942e+04 3.66145299e+03 8.33298602e+02
 2.35477484e+02 7.71800567e+01 1.18995455e+01 2.85874793e+01
 3.19597844e-01 2.09689485e+00 5.56387374e+00 3.67927063e+00
 1.24460040e+01 5.47609911e+01 3.29471199e-01 1.14082303e+00]
grad_E = [ 3.18004268e-04  3.76753992e-10 -1.78544094e-08  2.10789442e-07
  9.34904693e-07 -1.66181891e-05 -3.81539051e-05 -5.25617353e-05
 -1.66992393e-04 -7.03256777e-05  5.81130569e-05  1.55478799e-04
  2.33512718e-05 -1.81463341e-06  1.12715895e-03 -1.03799543e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.855797783447       1
[INPUT] 0    0    [1    /1   ]  24413.7941695        1
[INPUT] 0    0    [1    /1   ]  3661.45240367        1
[INPUT] 0    0    [1    /1   ]  833.310097545        1
[INPUT] 0    0    [1    /1   ]  235.357299386        1
[INPUT] 0    0    [1    /1   ]  77.6642521147        1
[INPUT] 0    0    [1    /1   ]  12.0085797787        1
[INPUT] 0    0    [1    /1   ]  28.8618601702        1
[INPUT] 0    0    [1    /1   ]  0.323754785544       1
[INPUT] 0    0    [1    /1   ]  2.12368108671        1
[INPUT] 0    0    [1    /1   ]  5.63647683763        1
[INPUT] 1    0    [1    /1   ]  3.67716468196        1
[INPUT] 1    0    [1    /1   ]  12.4427973354        1
[INPUT] 1    0    [1    /1   ]  54.7544990512        1
[INPUT] 1    0    [1    /1   ]  0.329243639324       1
[INPUT] 1    0    [1    /1   ]  1.13975628212        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8557977834468727, 1.0]], [0, [24413.79416945211, 1.0]], [0, [3661.452403670847, 1.0]], [0, [833.3100975447244, 1.0]], [0, [235.35729938589196, 1.0]], [0, [77.66425211474836, 1.0]], [0, [12.008579778736097, 1.0]], [0, [28.86186017015976, 1.0]], [0, [0.323754785543727, 1.0]], [0, [2.1236810867103726, 1.0]], [0, [5.6364768376328955, 1.0]], [1, [3.677164681956698, 1.0]], [1, [12.44279733538385, 1.0]], [1, [54.75449905123109, 1.0]], [1, [0.3292436393235065, 1.0]], [1, [1.1397562821224452, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.85579778]
bas 1, expnt(s) = [24413.79416945]
bas 2, expnt(s) = [3661.45240367]
bas 3, expnt(s) = [833.31009754]
bas 4, expnt(s) = [235.35729939]
bas 5, expnt(s) = [77.66425211]
bas 6, expnt(s) = [12.00857978]
bas 7, expnt(s) = [28.86186017]
bas 8, expnt(s) = [0.32375479]
bas 9, expnt(s) = [2.12368109]
bas 10, expnt(s) = [5.63647684]
bas 11, expnt(s) = [3.67716468]
bas 12, expnt(s) = [12.44279734]
bas 13, expnt(s) = [54.75449905]
bas 14, expnt(s) = [0.32924364]
bas 15, expnt(s) = [1.13975628]
CPU time:       343.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.55797783e-01 2.24798491e+00 2.44137942e+04 4.93448103e+03
 3.66145240e+03 1.18920046e+03 8.33310098e+02 3.91850141e+02
 2.35357299e+02 1.51813635e+02 7.76642521e+01 6.60968705e+01
 1.20085798e+01 1.62979792e+01 2.88618602e+01 3.14599670e+01
 3.23754786e-01 1.08436920e+00 2.12368109e+00 4.44459301e+00
 5.63647684e+00 9.24210332e+00 3.67716468e+00 1.48551056e+01
 1.24427973e+01 6.81760644e+01 5.47544991e+01 4.34519384e+02
 3.29243639e-01 7.27580640e-01 1.13975628e+00 3.43557462e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998510528907376
cond(S) = 1496.9903349178294
E1 = -183.57809555995422  E_coul = 55.07845576762463
init E= -128.49963979233
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773949522158471  LUMO = 0.88287800126737
  mo_energy =
[-3.25554889e+01 -1.85291158e+00 -7.73949522e-01 -7.73949522e-01
 -7.73949522e-01  8.82878001e-01  1.11111265e+00  1.11111265e+00
  1.11111265e+00  4.88751292e+00  5.75695814e+00  5.75695814e+00
  5.75695814e+00  1.78174119e+01  2.41665055e+01  2.41665055e+01
  2.41665055e+01  5.57579880e+01  1.19009230e+02  1.19009230e+02
  1.19009230e+02  1.68405362e+02  5.36370117e+02  1.90274058e+03
  8.02893058e+03  4.77917405e+04]
E1 = -182.1105387733783  E_coul = 53.58138519615607
cycle= 1 E= -128.529153577222  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461261
diis-c [-0.21276175  1.        ]
  HOMO = -0.879655649298961  LUMO = 0.852612293467983
  mo_energy =
[-3.28742097e+01 -1.96323258e+00 -8.79655649e-01 -8.79655649e-01
 -8.79655649e-01  8.52612293e-01  1.07305478e+00  1.07305478e+00
  1.07305478e+00  4.79787827e+00  5.62820943e+00  5.62820943e+00
  5.62820943e+00  1.76423603e+01  2.39314895e+01  2.39314895e+01
  2.39314895e+01  5.55032439e+01  1.18688242e+02  1.18688242e+02
  1.18688242e+02  1.68091809e+02  5.36013427e+02  1.90234739e+03
  8.02850807e+03  4.77912991e+04]
E1 = -182.84316656229305  E_coul = 54.311505288765495
cycle= 2 E= -128.531661273528  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230704
diis-c [-0.00069867  0.33230231  0.66769769]
  HOMO = -0.845281781859325  LUMO = 0.862435951476926
  mo_energy =
[-3.27691573e+01 -1.92709190e+00 -8.45281782e-01 -8.45281782e-01
 -8.45281782e-01  8.62435951e-01  1.08549775e+00  1.08549775e+00
  1.08549775e+00  4.82686740e+00  5.67008222e+00  5.67008222e+00
  5.67008222e+00  1.76997705e+01  2.40090624e+01  2.40090624e+01
  2.40090624e+01  5.55875986e+01  1.18793321e+02  1.18793321e+02
  1.18793321e+02  1.68194833e+02  5.36126863e+02  1.90246617e+03
  8.02862934e+03  4.77914213e+04]
E1 = -182.5975522597093  E_coul = 54.06504249441827
cycle= 3 E= -128.532509765291  delta_E= -0.000848  |g|= 0.000448  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000885658
diis-c [-1.40254083e-07 -2.21614866e-03 -9.59048602e-04  1.00317520e+00]
  HOMO = -0.845506961053196  LUMO = 0.862398932914326
  mo_energy =
[-3.27695415e+01 -1.92725216e+00 -8.45506961e-01 -8.45506961e-01
 -8.45506961e-01  8.62398933e-01  1.08545114e+00  1.08545114e+00
  1.08545114e+00  4.82673150e+00  5.66989024e+00  5.66989024e+00
  5.66989024e+00  1.76995269e+01  2.40087583e+01  2.40087583e+01
  2.40087583e+01  5.55872819e+01  1.18792924e+02  1.18792924e+02
  1.18792924e+02  1.68194447e+02  5.36126380e+02  1.90246558e+03
  8.02862866e+03  4.77914205e+04]
E1 = -182.59798879159766  E_coul = 54.06547900689162
cycle= 4 E= -128.532509784706  delta_E= -1.94e-08  |g|= 6.41e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133889
diis-c [-1.01710945e-09  3.16462788e-04  4.94292639e-04 -2.11468480e-01
  1.21065772e+00]
  HOMO = -0.845539362722489  LUMO = 0.862391437348928
  mo_energy =
[-3.27695950e+01 -1.92727216e+00 -8.45539363e-01 -8.45539363e-01
 -8.45539363e-01  8.62391437e-01  1.08543766e+00  1.08543766e+00
  1.08543766e+00  4.82670729e+00  5.66985436e+00  5.66985436e+00
  5.66985436e+00  1.76994860e+01  2.40087102e+01  2.40087102e+01
  2.40087102e+01  5.55872327e+01  1.18792870e+02  1.18792870e+02
  1.18792870e+02  1.68194393e+02  5.36126319e+02  1.90246551e+03
  8.02862858e+03  4.77914205e+04]
E1 = -182.59809558873653  E_coul = 54.06558580348957
cycle= 5 E= -128.532509785247  delta_E= -5.41e-10  |g|= 6.69e-06  |ddm|= 5.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59809558873653  E_coul = 54.06558580348957
  HOMO = -0.845535712023535  LUMO = 0.862393023344439
  mo_energy =
[-3.27695871e+01 -1.92726778e+00 -8.45535712e-01 -8.45535712e-01
 -8.45535712e-01  8.62393023e-01  1.08543918e+00  1.08543918e+00
  1.08543918e+00  4.82671097e+00  5.66985880e+00  5.66985880e+00
  5.66985880e+00  1.76994918e+01  2.40087170e+01  2.40087170e+01
  2.40087170e+01  5.55872400e+01  1.18792878e+02  1.18792878e+02
  1.18792878e+02  1.68194401e+02  5.36126326e+02  1.90246552e+03
  8.02862859e+03  4.77914205e+04]
E1 = -182.59807803676424  E_coul = 54.06556825151418
Extra cycle  E= -128.53250978525  delta_E= -3.1e-12  |g|= 2.46e-06  |ddm|= 2.4e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.55797783e-01 2.44137942e+04 3.66145240e+03 8.33310098e+02
 2.35357299e+02 7.76642521e+01 1.20085798e+01 2.88618602e+01
 3.23754786e-01 2.12368109e+00 5.63647684e+00 3.67716468e+00
 1.24427973e+01 5.47544991e+01 3.29243639e-01 1.13975628e+00]
E = -128.53250978525006
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.855797783447       1
[INPUT] 0    0    [1    /1   ]  24413.7941695        1
[INPUT] 0    0    [1    /1   ]  3661.45240367        1
[INPUT] 0    0    [1    /1   ]  833.310097545        1
[INPUT] 0    0    [1    /1   ]  235.357299386        1
[INPUT] 0    0    [1    /1   ]  77.6642521147        1
[INPUT] 0    0    [1    /1   ]  12.0085797787        1
[INPUT] 0    0    [1    /1   ]  28.8618601702        1
[INPUT] 0    0    [1    /1   ]  0.323754785544       1
[INPUT] 0    0    [1    /1   ]  2.12368108671        1
[INPUT] 0    0    [1    /1   ]  5.63647683763        1
[INPUT] 1    0    [1    /1   ]  3.67716468196        1
[INPUT] 1    0    [1    /1   ]  12.4427973354        1
[INPUT] 1    0    [1    /1   ]  54.7544990512        1
[INPUT] 1    0    [1    /1   ]  0.329243639324       1
[INPUT] 1    0    [1    /1   ]  1.13975628212        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8557977834468727, 1.0]], [0, [24413.79416945211, 1.0]], [0, [3661.452403670847, 1.0]], [0, [833.3100975447244, 1.0]], [0, [235.35729938589196, 1.0]], [0, [77.66425211474836, 1.0]], [0, [12.008579778736097, 1.0]], [0, [28.86186017015976, 1.0]], [0, [0.323754785543727, 1.0]], [0, [2.1236810867103726, 1.0]], [0, [5.6364768376328955, 1.0]], [1, [3.677164681956698, 1.0]], [1, [12.44279733538385, 1.0]], [1, [54.75449905123109, 1.0]], [1, [0.3292436393235065, 1.0]], [1, [1.1397562821224452, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.85579778]
bas 1, expnt(s) = [24413.79416945]
bas 2, expnt(s) = [3661.45240367]
bas 3, expnt(s) = [833.31009754]
bas 4, expnt(s) = [235.35729939]
bas 5, expnt(s) = [77.66425211]
bas 6, expnt(s) = [12.00857978]
bas 7, expnt(s) = [28.86186017]
bas 8, expnt(s) = [0.32375479]
bas 9, expnt(s) = [2.12368109]
bas 10, expnt(s) = [5.63647684]
bas 11, expnt(s) = [3.67716468]
bas 12, expnt(s) = [12.44279734]
bas 13, expnt(s) = [54.75449905]
bas 14, expnt(s) = [0.32924364]
bas 15, expnt(s) = [1.13975628]
CPU time:       344.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.55797783e-01 2.24798491e+00 2.44137942e+04 4.93448103e+03
 3.66145240e+03 1.18920046e+03 8.33310098e+02 3.91850141e+02
 2.35357299e+02 1.51813635e+02 7.76642521e+01 6.60968705e+01
 1.20085798e+01 1.62979792e+01 2.88618602e+01 3.14599670e+01
 3.23754786e-01 1.08436920e+00 2.12368109e+00 4.44459301e+00
 5.63647684e+00 9.24210332e+00 3.67716468e+00 1.48551056e+01
 1.24427973e+01 6.81760644e+01 5.47544991e+01 4.34519384e+02
 3.29243639e-01 7.27580640e-01 1.13975628e+00 3.43557462e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998510528907376
cond(S) = 1496.9903349178294
E1 = -183.57809555995422  E_coul = 55.07845576762463
init E= -128.49963979233
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773949522158471  LUMO = 0.88287800126737
  mo_energy =
[-3.25554889e+01 -1.85291158e+00 -7.73949522e-01 -7.73949522e-01
 -7.73949522e-01  8.82878001e-01  1.11111265e+00  1.11111265e+00
  1.11111265e+00  4.88751292e+00  5.75695814e+00  5.75695814e+00
  5.75695814e+00  1.78174119e+01  2.41665055e+01  2.41665055e+01
  2.41665055e+01  5.57579880e+01  1.19009230e+02  1.19009230e+02
  1.19009230e+02  1.68405362e+02  5.36370117e+02  1.90274058e+03
  8.02893058e+03  4.77917405e+04]
E1 = -182.1105387733783  E_coul = 53.58138519615607
cycle= 1 E= -128.529153577222  delta_E= -0.0295  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.461261
diis-c [-0.21276175  1.        ]
  HOMO = -0.879655649298961  LUMO = 0.852612293467983
  mo_energy =
[-3.28742097e+01 -1.96323258e+00 -8.79655649e-01 -8.79655649e-01
 -8.79655649e-01  8.52612293e-01  1.07305478e+00  1.07305478e+00
  1.07305478e+00  4.79787827e+00  5.62820943e+00  5.62820943e+00
  5.62820943e+00  1.76423603e+01  2.39314895e+01  2.39314895e+01
  2.39314895e+01  5.55032439e+01  1.18688242e+02  1.18688242e+02
  1.18688242e+02  1.68091809e+02  5.36013427e+02  1.90234739e+03
  8.02850807e+03  4.77912991e+04]
E1 = -182.84316656229305  E_coul = 54.311505288765495
cycle= 2 E= -128.531661273528  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230704
diis-c [-0.00069867  0.33230231  0.66769769]
  HOMO = -0.845281781859325  LUMO = 0.862435951476926
  mo_energy =
[-3.27691573e+01 -1.92709190e+00 -8.45281782e-01 -8.45281782e-01
 -8.45281782e-01  8.62435951e-01  1.08549775e+00  1.08549775e+00
  1.08549775e+00  4.82686740e+00  5.67008222e+00  5.67008222e+00
  5.67008222e+00  1.76997705e+01  2.40090624e+01  2.40090624e+01
  2.40090624e+01  5.55875986e+01  1.18793321e+02  1.18793321e+02
  1.18793321e+02  1.68194833e+02  5.36126863e+02  1.90246617e+03
  8.02862934e+03  4.77914213e+04]
E1 = -182.5975522597093  E_coul = 54.06504249441827
cycle= 3 E= -128.532509765291  delta_E= -0.000848  |g|= 0.000448  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000885658
diis-c [-1.40254083e-07 -2.21614866e-03 -9.59048602e-04  1.00317520e+00]
  HOMO = -0.845506961053196  LUMO = 0.862398932914326
  mo_energy =
[-3.27695415e+01 -1.92725216e+00 -8.45506961e-01 -8.45506961e-01
 -8.45506961e-01  8.62398933e-01  1.08545114e+00  1.08545114e+00
  1.08545114e+00  4.82673150e+00  5.66989024e+00  5.66989024e+00
  5.66989024e+00  1.76995269e+01  2.40087583e+01  2.40087583e+01
  2.40087583e+01  5.55872819e+01  1.18792924e+02  1.18792924e+02
  1.18792924e+02  1.68194447e+02  5.36126380e+02  1.90246558e+03
  8.02862866e+03  4.77914205e+04]
E1 = -182.59798879159766  E_coul = 54.06547900689162
cycle= 4 E= -128.532509784706  delta_E= -1.94e-08  |g|= 6.41e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133889
diis-c [-1.01710945e-09  3.16462788e-04  4.94292639e-04 -2.11468480e-01
  1.21065772e+00]
  HOMO = -0.845539362722489  LUMO = 0.862391437348928
  mo_energy =
[-3.27695950e+01 -1.92727216e+00 -8.45539363e-01 -8.45539363e-01
 -8.45539363e-01  8.62391437e-01  1.08543766e+00  1.08543766e+00
  1.08543766e+00  4.82670729e+00  5.66985436e+00  5.66985436e+00
  5.66985436e+00  1.76994860e+01  2.40087102e+01  2.40087102e+01
  2.40087102e+01  5.55872327e+01  1.18792870e+02  1.18792870e+02
  1.18792870e+02  1.68194393e+02  5.36126319e+02  1.90246551e+03
  8.02862858e+03  4.77914205e+04]
E1 = -182.59809558873653  E_coul = 54.06558580348957
cycle= 5 E= -128.532509785247  delta_E= -5.41e-10  |g|= 6.69e-06  |ddm|= 5.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59809558873653  E_coul = 54.06558580348957
  HOMO = -0.845535712023535  LUMO = 0.862393023344439
  mo_energy =
[-3.27695871e+01 -1.92726778e+00 -8.45535712e-01 -8.45535712e-01
 -8.45535712e-01  8.62393023e-01  1.08543918e+00  1.08543918e+00
  1.08543918e+00  4.82671097e+00  5.66985880e+00  5.66985880e+00
  5.66985880e+00  1.76994918e+01  2.40087170e+01  2.40087170e+01
  2.40087170e+01  5.55872400e+01  1.18792878e+02  1.18792878e+02
  1.18792878e+02  1.68194401e+02  5.36126326e+02  1.90246552e+03
  8.02862859e+03  4.77914205e+04]
E1 = -182.59807803676424  E_coul = 54.06556825151418
Extra cycle  E= -128.53250978525  delta_E= -3.1e-12  |g|= 2.46e-06  |ddm|= 2.4e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1496.9903349178294
E1 = -182.59807803676424  E_coul = 54.06556825151418
init E= -128.53250978525
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845536940011249  LUMO = 0.862392745972562
  mo_energy =
[-3.27695910e+01 -1.92726896e+00 -8.45536940e-01 -8.45536940e-01
 -8.45536940e-01  8.62392746e-01  1.08543875e+00  1.08543875e+00
  1.08543875e+00  4.82671001e+00  5.66985730e+00  5.66985730e+00
  5.66985730e+00  1.76994898e+01  2.40087142e+01  2.40087142e+01
  2.40087142e+01  5.55872369e+01  1.18792874e+02  1.18792874e+02
  1.18792874e+02  1.68194397e+02  5.36126322e+02  1.90246551e+03
  8.02862859e+03  4.77914205e+04]
E1 = -182.5980874981314  E_coul = 54.065577712881016
cycle= 1 E= -128.53250978525  delta_E= -3.41e-13  |g|= 1.3e-06  |ddm|= 9.41e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5980874981314  E_coul = 54.065577712881016
  HOMO = -0.84553627497124  LUMO = 0.862392948904801
  mo_energy =
[-3.27695890e+01 -1.92726824e+00 -8.45536275e-01 -8.45536275e-01
 -8.45536275e-01  8.62392949e-01  1.08543900e+00  1.08543900e+00
  1.08543900e+00  4.82671059e+00  5.66985812e+00  5.66985812e+00
  5.66985812e+00  1.76994909e+01  2.40087157e+01  2.40087157e+01
  2.40087157e+01  5.55872385e+01  1.18792876e+02  1.18792876e+02
  1.18792876e+02  1.68194399e+02  5.36126324e+02  1.90246551e+03
  8.02862859e+03  4.77914205e+04]
E1 = -182.59808279685302  E_coul = 54.0655730116026
Extra cycle  E= -128.53250978525  delta_E= -2.84e-14  |g|= 6.4e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.55797783e-01 2.44137942e+04 3.66145240e+03 8.33310098e+02
 2.35357299e+02 7.76642521e+01 1.20085798e+01 2.88618602e+01
 3.23754786e-01 2.12368109e+00 5.63647684e+00 3.67716468e+00
 1.24427973e+01 5.47544991e+01 3.29243639e-01 1.13975628e+00]
grad_E = [ 4.56983132e-04  1.39794914e-09 -6.98154109e-08  1.13288273e-06
 -6.09145483e-06 -2.47623383e-07 -5.05075236e-05 -5.43956969e-05
 -2.55455010e-04 -9.95076094e-05  6.61998868e-05  2.11170923e-04
  2.45372273e-05 -1.68924987e-06  1.50171139e-03 -1.40407327e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.864445817566       1
[INPUT] 0    0    [1    /1   ]  24413.7941878        1
[INPUT] 0    0    [1    /1   ]  3661.45143437        1
[INPUT] 0    0    [1    /1   ]  833.329168652        1
[INPUT] 0    0    [1    /1   ]  235.156229606        1
[INPUT] 0    0    [1    /1   ]  78.4747086107        1
[INPUT] 0    0    [1    /1   ]  12.223397739         1
[INPUT] 0    0    [1    /1   ]  29.4094440764        1
[INPUT] 0    0    [1    /1   ]  0.326001932856       1
[INPUT] 0    0    [1    /1   ]  2.14423071271        1
[INPUT] 0    0    [1    /1   ]  5.64817394984        1
[INPUT] 1    0    [1    /1   ]  3.67547314824        1
[INPUT] 1    0    [1    /1   ]  12.4383190905        1
[INPUT] 1    0    [1    /1   ]  54.7429060468        1
[INPUT] 1    0    [1    /1   ]  0.329113599706       1
[INPUT] 1    0    [1    /1   ]  1.13912181663        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8644458175663507, 1.0]], [0, [24413.794187845688, 1.0]], [0, [3661.451434365961, 1.0]], [0, [833.3291686522141, 1.0]], [0, [235.15622960649566, 1.0]], [0, [78.47470861065857, 1.0]], [0, [12.22339773897891, 1.0]], [0, [29.409444076396376, 1.0]], [0, [0.32600193285550816, 1.0]], [0, [2.1442307127057476, 1.0]], [0, [5.648173949844568, 1.0]], [1, [3.675473148237729, 1.0]], [1, [12.438319090536403, 1.0]], [1, [54.74290604679726, 1.0]], [1, [0.3291135997061969, 1.0]], [1, [1.1391218166339538, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.86444582]
bas 1, expnt(s) = [24413.79418785]
bas 2, expnt(s) = [3661.45143437]
bas 3, expnt(s) = [833.32916865]
bas 4, expnt(s) = [235.15622961]
bas 5, expnt(s) = [78.47470861]
bas 6, expnt(s) = [12.22339774]
bas 7, expnt(s) = [29.40944408]
bas 8, expnt(s) = [0.32600193]
bas 9, expnt(s) = [2.14423071]
bas 10, expnt(s) = [5.64817395]
bas 11, expnt(s) = [3.67547315]
bas 12, expnt(s) = [12.43831909]
bas 13, expnt(s) = [54.74290605]
bas 14, expnt(s) = [0.3291136]
bas 15, expnt(s) = [1.13912182]
CPU time:       347.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.64445818e-01 2.26500079e+00 2.44137942e+04 4.93448103e+03
 3.66145143e+03 1.18920023e+03 8.33329169e+02 3.91856867e+02
 2.35156230e+02 1.51716352e+02 7.84747086e+01 6.66135085e+01
 1.22233977e+01 1.65161562e+01 2.94094441e+01 3.19065712e+01
 3.26001933e-01 1.09000918e+00 2.14423071e+00 4.47680995e+00
 5.64817395e+00 9.25648436e+00 3.67547315e+00 1.48465642e+01
 1.24383191e+01 6.81453945e+01 5.47429060e+01 4.34404388e+02
 3.29113600e-01 7.27221447e-01 1.13912182e+00 3.43318420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998513291278393
cond(S) = 1467.721620667972
E1 = -183.5780047193656  E_coul = 55.07845479768717
init E= -128.499549921678
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773949808354587  LUMO = 0.893195620299491
  mo_energy =
[-3.25555041e+01 -1.85291073e+00 -7.73949808e-01 -7.73949808e-01
 -7.73949808e-01  8.93195620e-01  1.11050964e+00  1.11050964e+00
  1.11050964e+00  4.94536259e+00  5.75366966e+00  5.75366966e+00
  5.75366966e+00  1.80169688e+01  2.41543961e+01  2.41543961e+01
  2.41543961e+01  5.65807717e+01  1.18970404e+02  1.18970404e+02
  1.18970404e+02  1.71031330e+02  5.41117448e+02  1.90799479e+03
  8.03372876e+03  4.77957465e+04]
E1 = -182.11043929272233  E_coul = 53.58125776053228
cycle= 1 E= -128.52918153219  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46125
diis-c [-0.21275127  1.        ]
  HOMO = -0.879664983767299  LUMO = 0.86254732344068
  mo_energy =
[-3.28742490e+01 -1.96324353e+00 -8.79664984e-01 -8.79664984e-01
 -8.79664984e-01  8.62547323e-01  1.07247237e+00  1.07247237e+00
  1.07247237e+00  4.85495366e+00  5.62495454e+00  5.62495454e+00
  5.62495454e+00  1.78409043e+01  2.39193881e+01  2.39193881e+01
  2.39193881e+01  5.63248544e+01  1.18649401e+02  1.18649401e+02
  1.18649401e+02  1.70717137e+02  5.40760649e+02  1.90760161e+03
  8.03330624e+03  4.77953051e+04]
E1 = -182.84315369962184  E_coul = 54.3114640522983
cycle= 2 E= -128.531689647324  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230693
diis-c [-0.00069998  0.33229458  0.66770542]
  HOMO = -0.845286553393104  LUMO = 0.87249331748398
  mo_energy =
[-3.27691837e+01 -1.92709765e+00 -8.45286553e-01 -8.45286553e-01
 -8.45286553e-01  8.72493317e-01  1.08490891e+00  1.08490891e+00
  1.08490891e+00  4.88419696e+00  5.66681842e+00  5.66681842e+00
  5.66681842e+00  1.78986595e+01  2.39969613e+01  2.39969613e+01
  2.39969613e+01  5.64096057e+01  1.18754490e+02  1.18754490e+02
  1.18754490e+02  1.70820356e+02  5.40874121e+02  1.90772040e+03
  8.03342752e+03  4.77954273e+04]
E1 = -182.59750097482018  E_coul = 54.06496263271497
cycle= 3 E= -128.532538342105  delta_E= -0.000849  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000889477
diis-c [-1.39060335e-07 -2.21063163e-03 -9.25813651e-04  1.00313645e+00]
  HOMO = -0.84551240067112  LUMO = 0.872455591453434
  mo_energy =
[-3.27695700e+01 -1.92725870e+00 -8.45512401e-01 -8.45512401e-01
 -8.45512401e-01  8.72455591e-01  1.08486214e+00  1.08486214e+00
  1.08486214e+00  4.88405930e+00  5.66662569e+00  5.66662569e+00
  5.66662569e+00  1.78984138e+01  2.39966556e+01  2.39966556e+01
  2.39966556e+01  5.64092862e+01  1.18754092e+02  1.18754092e+02
  1.18754092e+02  1.70819967e+02  5.40873635e+02  1.90771980e+03
  8.03342683e+03  4.77954265e+04]
E1 = -182.59794266547158  E_coul = 54.06540430390817
cycle= 4 E= -128.532538361563  delta_E= -1.95e-08  |g|= 6.41e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133887
diis-c [-1.01598064e-09  3.15865823e-04  4.90222579e-04 -2.11215494e-01
  1.21040941e+00]
  HOMO = -0.845544800582915  LUMO = 0.872447999008444
  mo_energy =
[-3.27696237e+01 -1.92727873e+00 -8.45544801e-01 -8.45544801e-01
 -8.45544801e-01  8.72447999e-01  1.08484867e+00  1.08484867e+00
  1.08484867e+00  4.88403488e+00  5.66658981e+00  5.66658981e+00
  5.66658981e+00  1.78983727e+01  2.39966074e+01  2.39966074e+01
  2.39966074e+01  5.64092369e+01  1.18754038e+02  1.18754038e+02
  1.18754038e+02  1.70819913e+02  5.40873573e+02  1.90771973e+03
  8.03342676e+03  4.77954265e+04]
E1 = -182.59804968922006  E_coul = 54.06551132711784
cycle= 5 E= -128.532538362102  delta_E= -5.39e-10  |g|= 6.68e-06  |ddm|= 5.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59804968922006  E_coul = 54.06551132711784
  HOMO = -0.845541152747651  LUMO = 0.872449601056806
  mo_energy =
[-3.27696157e+01 -1.92727436e+00 -8.45541153e-01 -8.45541153e-01
 -8.45541153e-01  8.72449601e-01  1.08485020e+00  1.08485020e+00
  1.08485020e+00  4.88403858e+00  5.66659423e+00  5.66659423e+00
  5.66659423e+00  1.78983785e+01  2.39966142e+01  2.39966142e+01
  2.39966142e+01  5.64092442e+01  1.18754046e+02  1.18754046e+02
  1.18754046e+02  1.70819921e+02  5.40873581e+02  1.90771974e+03
  8.03342677e+03  4.77954265e+04]
E1 = -182.5980321611234  E_coul = 54.06549379901832
Extra cycle  E= -128.532538362105  delta_E= -2.84e-12  |g|= 2.45e-06  |ddm|= 2.4e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.64445818e-01 2.44137942e+04 3.66145143e+03 8.33329169e+02
 2.35156230e+02 7.84747086e+01 1.22233977e+01 2.94094441e+01
 3.26001933e-01 2.14423071e+00 5.64817395e+00 3.67547315e+00
 1.24383191e+01 5.47429060e+01 3.29113600e-01 1.13912182e+00]
E = -128.53253836210507
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.864445817566       1
[INPUT] 0    0    [1    /1   ]  24413.7941878        1
[INPUT] 0    0    [1    /1   ]  3661.45143437        1
[INPUT] 0    0    [1    /1   ]  833.329168652        1
[INPUT] 0    0    [1    /1   ]  235.156229606        1
[INPUT] 0    0    [1    /1   ]  78.4747086107        1
[INPUT] 0    0    [1    /1   ]  12.223397739         1
[INPUT] 0    0    [1    /1   ]  29.4094440764        1
[INPUT] 0    0    [1    /1   ]  0.326001932856       1
[INPUT] 0    0    [1    /1   ]  2.14423071271        1
[INPUT] 0    0    [1    /1   ]  5.64817394984        1
[INPUT] 1    0    [1    /1   ]  3.67547314824        1
[INPUT] 1    0    [1    /1   ]  12.4383190905        1
[INPUT] 1    0    [1    /1   ]  54.7429060468        1
[INPUT] 1    0    [1    /1   ]  0.329113599706       1
[INPUT] 1    0    [1    /1   ]  1.13912181663        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8644458175663507, 1.0]], [0, [24413.794187845688, 1.0]], [0, [3661.451434365961, 1.0]], [0, [833.3291686522141, 1.0]], [0, [235.15622960649566, 1.0]], [0, [78.47470861065857, 1.0]], [0, [12.22339773897891, 1.0]], [0, [29.409444076396376, 1.0]], [0, [0.32600193285550816, 1.0]], [0, [2.1442307127057476, 1.0]], [0, [5.648173949844568, 1.0]], [1, [3.675473148237729, 1.0]], [1, [12.438319090536403, 1.0]], [1, [54.74290604679726, 1.0]], [1, [0.3291135997061969, 1.0]], [1, [1.1391218166339538, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.86444582]
bas 1, expnt(s) = [24413.79418785]
bas 2, expnt(s) = [3661.45143437]
bas 3, expnt(s) = [833.32916865]
bas 4, expnt(s) = [235.15622961]
bas 5, expnt(s) = [78.47470861]
bas 6, expnt(s) = [12.22339774]
bas 7, expnt(s) = [29.40944408]
bas 8, expnt(s) = [0.32600193]
bas 9, expnt(s) = [2.14423071]
bas 10, expnt(s) = [5.64817395]
bas 11, expnt(s) = [3.67547315]
bas 12, expnt(s) = [12.43831909]
bas 13, expnt(s) = [54.74290605]
bas 14, expnt(s) = [0.3291136]
bas 15, expnt(s) = [1.13912182]
CPU time:       349.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.64445818e-01 2.26500079e+00 2.44137942e+04 4.93448103e+03
 3.66145143e+03 1.18920023e+03 8.33329169e+02 3.91856867e+02
 2.35156230e+02 1.51716352e+02 7.84747086e+01 6.66135085e+01
 1.22233977e+01 1.65161562e+01 2.94094441e+01 3.19065712e+01
 3.26001933e-01 1.09000918e+00 2.14423071e+00 4.47680995e+00
 5.64817395e+00 9.25648436e+00 3.67547315e+00 1.48465642e+01
 1.24383191e+01 6.81453945e+01 5.47429060e+01 4.34404388e+02
 3.29113600e-01 7.27221447e-01 1.13912182e+00 3.43318420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998513291278393
cond(S) = 1467.721620667972
E1 = -183.5780047193656  E_coul = 55.07845479768717
init E= -128.499549921678
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773949808354587  LUMO = 0.893195620299491
  mo_energy =
[-3.25555041e+01 -1.85291073e+00 -7.73949808e-01 -7.73949808e-01
 -7.73949808e-01  8.93195620e-01  1.11050964e+00  1.11050964e+00
  1.11050964e+00  4.94536259e+00  5.75366966e+00  5.75366966e+00
  5.75366966e+00  1.80169688e+01  2.41543961e+01  2.41543961e+01
  2.41543961e+01  5.65807717e+01  1.18970404e+02  1.18970404e+02
  1.18970404e+02  1.71031330e+02  5.41117448e+02  1.90799479e+03
  8.03372876e+03  4.77957465e+04]
E1 = -182.11043929272233  E_coul = 53.58125776053228
cycle= 1 E= -128.52918153219  delta_E= -0.0296  |g|= 0.201  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46125
diis-c [-0.21275127  1.        ]
  HOMO = -0.879664983767299  LUMO = 0.86254732344068
  mo_energy =
[-3.28742490e+01 -1.96324353e+00 -8.79664984e-01 -8.79664984e-01
 -8.79664984e-01  8.62547323e-01  1.07247237e+00  1.07247237e+00
  1.07247237e+00  4.85495366e+00  5.62495454e+00  5.62495454e+00
  5.62495454e+00  1.78409043e+01  2.39193881e+01  2.39193881e+01
  2.39193881e+01  5.63248544e+01  1.18649401e+02  1.18649401e+02
  1.18649401e+02  1.70717137e+02  5.40760649e+02  1.90760161e+03
  8.03330624e+03  4.77953051e+04]
E1 = -182.84315369962184  E_coul = 54.3114640522983
cycle= 2 E= -128.531689647324  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230693
diis-c [-0.00069998  0.33229458  0.66770542]
  HOMO = -0.845286553393104  LUMO = 0.87249331748398
  mo_energy =
[-3.27691837e+01 -1.92709765e+00 -8.45286553e-01 -8.45286553e-01
 -8.45286553e-01  8.72493317e-01  1.08490891e+00  1.08490891e+00
  1.08490891e+00  4.88419696e+00  5.66681842e+00  5.66681842e+00
  5.66681842e+00  1.78986595e+01  2.39969613e+01  2.39969613e+01
  2.39969613e+01  5.64096057e+01  1.18754490e+02  1.18754490e+02
  1.18754490e+02  1.70820356e+02  5.40874121e+02  1.90772040e+03
  8.03342752e+03  4.77954273e+04]
E1 = -182.59750097482018  E_coul = 54.06496263271497
cycle= 3 E= -128.532538342105  delta_E= -0.000849  |g|= 0.000449  |ddm|= 0.0237
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000889477
diis-c [-1.39060335e-07 -2.21063163e-03 -9.25813651e-04  1.00313645e+00]
  HOMO = -0.84551240067112  LUMO = 0.872455591453434
  mo_energy =
[-3.27695700e+01 -1.92725870e+00 -8.45512401e-01 -8.45512401e-01
 -8.45512401e-01  8.72455591e-01  1.08486214e+00  1.08486214e+00
  1.08486214e+00  4.88405930e+00  5.66662569e+00  5.66662569e+00
  5.66662569e+00  1.78984138e+01  2.39966556e+01  2.39966556e+01
  2.39966556e+01  5.64092862e+01  1.18754092e+02  1.18754092e+02
  1.18754092e+02  1.70819967e+02  5.40873635e+02  1.90771980e+03
  8.03342683e+03  4.77954265e+04]
E1 = -182.59794266547158  E_coul = 54.06540430390817
cycle= 4 E= -128.532538361563  delta_E= -1.95e-08  |g|= 6.41e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133887
diis-c [-1.01598064e-09  3.15865823e-04  4.90222579e-04 -2.11215494e-01
  1.21040941e+00]
  HOMO = -0.845544800582915  LUMO = 0.872447999008444
  mo_energy =
[-3.27696237e+01 -1.92727873e+00 -8.45544801e-01 -8.45544801e-01
 -8.45544801e-01  8.72447999e-01  1.08484867e+00  1.08484867e+00
  1.08484867e+00  4.88403488e+00  5.66658981e+00  5.66658981e+00
  5.66658981e+00  1.78983727e+01  2.39966074e+01  2.39966074e+01
  2.39966074e+01  5.64092369e+01  1.18754038e+02  1.18754038e+02
  1.18754038e+02  1.70819913e+02  5.40873573e+02  1.90771973e+03
  8.03342676e+03  4.77954265e+04]
E1 = -182.59804968922006  E_coul = 54.06551132711784
cycle= 5 E= -128.532538362102  delta_E= -5.39e-10  |g|= 6.68e-06  |ddm|= 5.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59804968922006  E_coul = 54.06551132711784
  HOMO = -0.845541152747651  LUMO = 0.872449601056806
  mo_energy =
[-3.27696157e+01 -1.92727436e+00 -8.45541153e-01 -8.45541153e-01
 -8.45541153e-01  8.72449601e-01  1.08485020e+00  1.08485020e+00
  1.08485020e+00  4.88403858e+00  5.66659423e+00  5.66659423e+00
  5.66659423e+00  1.78983785e+01  2.39966142e+01  2.39966142e+01
  2.39966142e+01  5.64092442e+01  1.18754046e+02  1.18754046e+02
  1.18754046e+02  1.70819921e+02  5.40873581e+02  1.90771974e+03
  8.03342677e+03  4.77954265e+04]
E1 = -182.5980321611234  E_coul = 54.06549379901832
Extra cycle  E= -128.532538362105  delta_E= -2.84e-12  |g|= 2.45e-06  |ddm|= 2.4e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1467.721620667972
E1 = -182.5980321611234  E_coul = 54.06549379901832
init E= -128.532538362105
    CPU time for initialize scf      0.26 sec, wall time      0.27 sec
  HOMO = -0.845542378995935  LUMO = 0.872449320429328
  mo_energy =
[-3.27696196e+01 -1.92727553e+00 -8.45542379e-01 -8.45542379e-01
 -8.45542379e-01  8.72449320e-01  1.08484977e+00  1.08484977e+00
  1.08484977e+00  4.88403762e+00  5.66659274e+00  5.66659274e+00
  5.66659274e+00  1.78983765e+01  2.39966114e+01  2.39966114e+01
  2.39966114e+01  5.64092411e+01  1.18754042e+02  1.18754042e+02
  1.18754042e+02  1.70819917e+02  5.40873576e+02  1.90771973e+03
  8.03342676e+03  4.77954265e+04]
E1 = -182.5980416110561  E_coul = 54.06550324895058
cycle= 1 E= -128.532538362106  delta_E= -4.55e-13  |g|= 1.3e-06  |ddm|= 9.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5980416110561  E_coul = 54.06550324895058
  HOMO = -0.845541714751075  LUMO = 0.872449525580398
  mo_energy =
[-3.27696176e+01 -1.92727481e+00 -8.45541715e-01 -8.45541715e-01
 -8.45541715e-01  8.72449526e-01  1.08485001e+00  1.08485001e+00
  1.08485001e+00  4.88403821e+00  5.66659356e+00  5.66659356e+00
  5.66659356e+00  1.78983776e+01  2.39966129e+01  2.39966129e+01
  2.39966129e+01  5.64092427e+01  1.18754044e+02  1.18754044e+02
  1.18754044e+02  1.70819919e+02  5.40873579e+02  1.90771974e+03
  8.03342676e+03  4.77954265e+04]
E1 = -182.59803691544062  E_coul = 54.06549855333494
Extra cycle  E= -128.532538362106  delta_E= -1.42e-13  |g|= 6.39e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.36 sec
exp = [8.64445818e-01 2.44137942e+04 3.66145143e+03 8.33329169e+02
 2.35156230e+02 7.84747086e+01 1.22233977e+01 2.94094441e+01
 3.26001933e-01 2.14423071e+00 5.64817395e+00 3.67547315e+00
 1.24383191e+01 5.47429060e+01 3.29113600e-01 1.13912182e+00]
grad_E = [ 6.01148011e-04  2.87499056e-09 -1.44319290e-07  2.44651585e-06
 -1.53810705e-05  1.73842566e-05 -5.19266733e-05 -5.30127957e-05
 -4.08007027e-04 -1.30168713e-04  6.24452120e-05  2.33662446e-04
  2.21780241e-05 -1.30671268e-06  1.67022906e-03 -1.55778172e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.85628466849        1
[INPUT] 0    0    [1    /1   ]  24413.7942109        1
[INPUT] 0    0    [1    /1   ]  3661.45021796        1
[INPUT] 0    0    [1    /1   ]  833.353185863        1
[INPUT] 0    0    [1    /1   ]  234.90180478         1
[INPUT] 0    0    [1    /1   ]  79.4906587898        1
[INPUT] 0    0    [1    /1   ]  12.59745547          1
[INPUT] 0    0    [1    /1   ]  30.2547144852        1
[INPUT] 0    0    [1    /1   ]  0.322962882219       1
[INPUT] 0    0    [1    /1   ]  2.14488486246        1
[INPUT] 0    0    [1    /1   ]  5.60377179475        1
[INPUT] 1    0    [1    /1   ]  3.67520280805        1
[INPUT] 1    0    [1    /1   ]  12.4327087358        1
[INPUT] 1    0    [1    /1   ]  54.727109636         1
[INPUT] 1    0    [1    /1   ]  0.329231174453       1
[INPUT] 1    0    [1    /1   ]  1.13961011579        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8562846684900309, 1.0]], [0, [24413.79421090734, 1.0]], [0, [3661.450217962799, 1.0]], [0, [833.3531858632535, 1.0]], [0, [234.90180478007935, 1.0]], [0, [79.49065878982104, 1.0]], [0, [12.59745546998157, 1.0]], [0, [30.254714485199354, 1.0]], [0, [0.32296288221894626, 1.0]], [0, [2.144884862458632, 1.0]], [0, [5.6037717947491315, 1.0]], [1, [3.6752028080521217, 1.0]], [1, [12.4327087357519, 1.0]], [1, [54.72710963604021, 1.0]], [1, [0.3292311744529407, 1.0]], [1, [1.1396101157863217, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.85628467]
bas 1, expnt(s) = [24413.79421091]
bas 2, expnt(s) = [3661.45021796]
bas 3, expnt(s) = [833.35318586]
bas 4, expnt(s) = [234.90180478]
bas 5, expnt(s) = [79.49065879]
bas 6, expnt(s) = [12.59745547]
bas 7, expnt(s) = [30.25471449]
bas 8, expnt(s) = [0.32296288]
bas 9, expnt(s) = [2.14488486]
bas 10, expnt(s) = [5.60377179]
bas 11, expnt(s) = [3.67520281]
bas 12, expnt(s) = [12.43270874]
bas 13, expnt(s) = [54.72710964]
bas 14, expnt(s) = [0.32923117]
bas 15, expnt(s) = [1.13961012]
CPU time:       353.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.56284668e-01 2.24894405e+00 2.44137942e+04 4.93448103e+03
 3.66145022e+03 1.18919993e+03 8.33353186e+02 3.91865337e+02
 2.34901805e+02 1.51593224e+02 7.94906588e+01 6.72592618e+01
 1.25974555e+01 1.68937922e+01 3.02547145e+01 3.25919104e+01
 3.22962882e-01 1.08237931e+00 2.14488486e+00 4.47783423e+00
 5.60377179e+00 9.20185435e+00 3.67520281e+00 1.48451992e+01
 1.24327087e+01 6.81069751e+01 5.47271096e+01 4.34247706e+02
 3.29231174e-01 7.27546208e-01 1.13961012e+00 3.43502389e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998511629934015
cond(S) = 1370.2620319413882
E1 = -183.57791101853758  E_coul = 55.07846826785042
init E= -128.499442750687
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773948207081733  LUMO = 0.883014103814402
  mo_energy =
[-3.25555197e+01 -1.85291013e+00 -7.73948207e-01 -7.73948207e-01
 -7.73948207e-01  8.83014104e-01  1.11102692e+00  1.11102692e+00
  1.11102692e+00  4.91425518e+00  5.75533478e+00  5.75533478e+00
  5.75533478e+00  1.80431476e+01  2.41498268e+01  2.41498268e+01
  2.41498268e+01  5.74819410e+01  1.18929197e+02  1.18929197e+02
  1.18929197e+02  1.74584941e+02  5.47593303e+02  1.91516421e+03
  8.04028414e+03  4.78012212e+04]
E1 = -182.11049388480026  E_coul = 53.58127730062781
cycle= 1 E= -128.529216584172  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461304
diis-c [-0.21280094  1.        ]
  HOMO = -0.879665711245447  LUMO = 0.852675542145905
  mo_energy =
[-3.28742578e+01 -1.96323999e+00 -8.79665711e-01 -8.79665711e-01
 -8.79665711e-01  8.52675542e-01  1.07296693e+00  1.07296693e+00
  1.07296693e+00  4.82391051e+00  5.62661256e+00  5.62661256e+00
  5.62661256e+00  1.78661605e+01  2.39148639e+01  2.39148639e+01
  2.39148639e+01  5.72242687e+01  1.18608213e+02  1.18608213e+02
  1.18608213e+02  1.74269832e+02  5.47236378e+02  1.91477108e+03
  8.03986164e+03  4.78007797e+04]
E1 = -182.84316148294585  E_coul = 54.31143698964367
cycle= 2 E= -128.531724493302  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230691
diis-c [-0.00070019  0.33226673  0.66773327]
  HOMO = -0.845288155612108  LUMO = 0.862520924174672
  mo_energy =
[-3.27691939e+01 -1.92709560e+00 -8.45288156e-01 -8.45288156e-01
 -8.45288156e-01  8.62520924e-01  1.08540955e+00  1.08540955e+00
  1.08540955e+00  4.85313170e+00  5.66847666e+00  5.66847666e+00
  5.66847666e+00  1.79242294e+01  2.39924234e+01  2.39924234e+01
  2.39924234e+01  5.73096102e+01  1.18713297e+02  1.18713297e+02
  1.18713297e+02  1.74373326e+02  5.47349883e+02  1.91488986e+03
  8.03998291e+03  4.78009020e+04]
E1 = -182.59750820860035  E_coul = 54.06493509965516
cycle= 3 E= -128.532573108945  delta_E= -0.000849  |g|= 0.000454  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000899596
diis-c [-1.41001496e-07 -2.20908928e-03 -8.79091925e-04  1.00308818e+00]
  HOMO = -0.845516059294096  LUMO = 0.862482933514438
  mo_energy =
[-3.27695851e+01 -1.92725854e+00 -8.45516059e-01 -8.45516059e-01
 -8.45516059e-01  8.62482934e-01  1.08536186e+00  1.08536186e+00
  1.08536186e+00  4.85299248e+00  5.66828149e+00  5.66828149e+00
  5.66828149e+00  1.79239800e+01  2.39921139e+01  2.39921139e+01
  2.39921139e+01  5.73092852e+01  1.18712894e+02  1.18712894e+02
  1.18712894e+02  1.74372930e+02  5.47349391e+02  1.91488926e+03
  8.03998222e+03  4.78009012e+04]
E1 = -182.5979597321929  E_coul = 54.0653866034281
cycle= 4 E= -128.532573128765  delta_E= -1.98e-08  |g|= 6.43e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134265
diis-c [-1.02098816e-09  3.17438980e-04  4.82637710e-04 -2.11833773e-01
  1.21103370e+00]
  HOMO = -0.845548585665891  LUMO = 0.862475387579575
  mo_energy =
[-3.27696388e+01 -1.92727861e+00 -8.45548586e-01 -8.45548586e-01
 -8.45548586e-01  8.62475388e-01  1.08534833e+00  1.08534833e+00
  1.08534833e+00  4.85296801e+00  5.66824549e+00  5.66824549e+00
  5.66824549e+00  1.79239387e+01  2.39920657e+01  2.39920657e+01
  2.39920657e+01  5.73092357e+01  1.18712840e+02  1.18712840e+02
  1.18712840e+02  1.74372876e+02  5.47349330e+02  1.91488919e+03
  8.03998215e+03  4.78009011e+04]
E1 = -182.59806673076338  E_coul = 54.06549360145384
cycle= 5 E= -128.53257312931  delta_E= -5.45e-10  |g|= 6.71e-06  |ddm|= 5.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59806673076338  E_coul = 54.06549360145384
  HOMO = -0.845544917849462  LUMO = 0.8624769835251
  mo_energy =
[-3.27696308e+01 -1.92727422e+00 -8.45544918e-01 -8.45544918e-01
 -8.45544918e-01  8.62476984e-01  1.08534986e+00  1.08534986e+00
  1.08534986e+00  4.85297173e+00  5.66824994e+00  5.66824994e+00
  5.66824994e+00  1.79239446e+01  2.39920725e+01  2.39920725e+01
  2.39920725e+01  5.73092430e+01  1.18712848e+02  1.18712848e+02
  1.18712848e+02  1.74372884e+02  5.47349337e+02  1.91488920e+03
  8.03998216e+03  4.78009011e+04]
E1 = -182.59804912748763  E_coul = 54.0654759981751
Extra cycle  E= -128.532573129313  delta_E= -3.01e-12  |g|= 2.46e-06  |ddm|= 2.42e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [8.56284668e-01 2.44137942e+04 3.66145022e+03 8.33353186e+02
 2.34901805e+02 7.94906588e+01 1.25974555e+01 3.02547145e+01
 3.22962882e-01 2.14488486e+00 5.60377179e+00 3.67520281e+00
 1.24327087e+01 5.47271096e+01 3.29231174e-01 1.13961012e+00]
E = -128.53257312931254
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.85628466849        1
[INPUT] 0    0    [1    /1   ]  24413.7942109        1
[INPUT] 0    0    [1    /1   ]  3661.45021796        1
[INPUT] 0    0    [1    /1   ]  833.353185863        1
[INPUT] 0    0    [1    /1   ]  234.90180478         1
[INPUT] 0    0    [1    /1   ]  79.4906587898        1
[INPUT] 0    0    [1    /1   ]  12.59745547          1
[INPUT] 0    0    [1    /1   ]  30.2547144852        1
[INPUT] 0    0    [1    /1   ]  0.322962882219       1
[INPUT] 0    0    [1    /1   ]  2.14488486246        1
[INPUT] 0    0    [1    /1   ]  5.60377179475        1
[INPUT] 1    0    [1    /1   ]  3.67520280805        1
[INPUT] 1    0    [1    /1   ]  12.4327087358        1
[INPUT] 1    0    [1    /1   ]  54.727109636         1
[INPUT] 1    0    [1    /1   ]  0.329231174453       1
[INPUT] 1    0    [1    /1   ]  1.13961011579        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8562846684900309, 1.0]], [0, [24413.79421090734, 1.0]], [0, [3661.450217962799, 1.0]], [0, [833.3531858632535, 1.0]], [0, [234.90180478007935, 1.0]], [0, [79.49065878982104, 1.0]], [0, [12.59745546998157, 1.0]], [0, [30.254714485199354, 1.0]], [0, [0.32296288221894626, 1.0]], [0, [2.144884862458632, 1.0]], [0, [5.6037717947491315, 1.0]], [1, [3.6752028080521217, 1.0]], [1, [12.4327087357519, 1.0]], [1, [54.72710963604021, 1.0]], [1, [0.3292311744529407, 1.0]], [1, [1.1396101157863217, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.85628467]
bas 1, expnt(s) = [24413.79421091]
bas 2, expnt(s) = [3661.45021796]
bas 3, expnt(s) = [833.35318586]
bas 4, expnt(s) = [234.90180478]
bas 5, expnt(s) = [79.49065879]
bas 6, expnt(s) = [12.59745547]
bas 7, expnt(s) = [30.25471449]
bas 8, expnt(s) = [0.32296288]
bas 9, expnt(s) = [2.14488486]
bas 10, expnt(s) = [5.60377179]
bas 11, expnt(s) = [3.67520281]
bas 12, expnt(s) = [12.43270874]
bas 13, expnt(s) = [54.72710964]
bas 14, expnt(s) = [0.32923117]
bas 15, expnt(s) = [1.13961012]
CPU time:       354.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.56284668e-01 2.24894405e+00 2.44137942e+04 4.93448103e+03
 3.66145022e+03 1.18919993e+03 8.33353186e+02 3.91865337e+02
 2.34901805e+02 1.51593224e+02 7.94906588e+01 6.72592618e+01
 1.25974555e+01 1.68937922e+01 3.02547145e+01 3.25919104e+01
 3.22962882e-01 1.08237931e+00 2.14488486e+00 4.47783423e+00
 5.60377179e+00 9.20185435e+00 3.67520281e+00 1.48451992e+01
 1.24327087e+01 6.81069751e+01 5.47271096e+01 4.34247706e+02
 3.29231174e-01 7.27546208e-01 1.13961012e+00 3.43502389e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998511629934015
cond(S) = 1370.2620319413882
E1 = -183.57791101853758  E_coul = 55.07846826785042
init E= -128.499442750687
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773948207081733  LUMO = 0.883014103814402
  mo_energy =
[-3.25555197e+01 -1.85291013e+00 -7.73948207e-01 -7.73948207e-01
 -7.73948207e-01  8.83014104e-01  1.11102692e+00  1.11102692e+00
  1.11102692e+00  4.91425518e+00  5.75533478e+00  5.75533478e+00
  5.75533478e+00  1.80431476e+01  2.41498268e+01  2.41498268e+01
  2.41498268e+01  5.74819410e+01  1.18929197e+02  1.18929197e+02
  1.18929197e+02  1.74584941e+02  5.47593303e+02  1.91516421e+03
  8.04028414e+03  4.78012212e+04]
E1 = -182.11049388480026  E_coul = 53.58127730062781
cycle= 1 E= -128.529216584172  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461304
diis-c [-0.21280094  1.        ]
  HOMO = -0.879665711245447  LUMO = 0.852675542145905
  mo_energy =
[-3.28742578e+01 -1.96323999e+00 -8.79665711e-01 -8.79665711e-01
 -8.79665711e-01  8.52675542e-01  1.07296693e+00  1.07296693e+00
  1.07296693e+00  4.82391051e+00  5.62661256e+00  5.62661256e+00
  5.62661256e+00  1.78661605e+01  2.39148639e+01  2.39148639e+01
  2.39148639e+01  5.72242687e+01  1.18608213e+02  1.18608213e+02
  1.18608213e+02  1.74269832e+02  5.47236378e+02  1.91477108e+03
  8.03986164e+03  4.78007797e+04]
E1 = -182.84316148294585  E_coul = 54.31143698964367
cycle= 2 E= -128.531724493302  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0697
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230691
diis-c [-0.00070019  0.33226673  0.66773327]
  HOMO = -0.845288155612108  LUMO = 0.862520924174672
  mo_energy =
[-3.27691939e+01 -1.92709560e+00 -8.45288156e-01 -8.45288156e-01
 -8.45288156e-01  8.62520924e-01  1.08540955e+00  1.08540955e+00
  1.08540955e+00  4.85313170e+00  5.66847666e+00  5.66847666e+00
  5.66847666e+00  1.79242294e+01  2.39924234e+01  2.39924234e+01
  2.39924234e+01  5.73096102e+01  1.18713297e+02  1.18713297e+02
  1.18713297e+02  1.74373326e+02  5.47349883e+02  1.91488986e+03
  8.03998291e+03  4.78009020e+04]
E1 = -182.59750820860035  E_coul = 54.06493509965516
cycle= 3 E= -128.532573108945  delta_E= -0.000849  |g|= 0.000454  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000899596
diis-c [-1.41001496e-07 -2.20908928e-03 -8.79091925e-04  1.00308818e+00]
  HOMO = -0.845516059294096  LUMO = 0.862482933514438
  mo_energy =
[-3.27695851e+01 -1.92725854e+00 -8.45516059e-01 -8.45516059e-01
 -8.45516059e-01  8.62482934e-01  1.08536186e+00  1.08536186e+00
  1.08536186e+00  4.85299248e+00  5.66828149e+00  5.66828149e+00
  5.66828149e+00  1.79239800e+01  2.39921139e+01  2.39921139e+01
  2.39921139e+01  5.73092852e+01  1.18712894e+02  1.18712894e+02
  1.18712894e+02  1.74372930e+02  5.47349391e+02  1.91488926e+03
  8.03998222e+03  4.78009012e+04]
E1 = -182.5979597321929  E_coul = 54.0653866034281
cycle= 4 E= -128.532573128765  delta_E= -1.98e-08  |g|= 6.43e-05  |ddm|= 0.000303
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134265
diis-c [-1.02098816e-09  3.17438980e-04  4.82637710e-04 -2.11833773e-01
  1.21103370e+00]
  HOMO = -0.845548585665891  LUMO = 0.862475387579575
  mo_energy =
[-3.27696388e+01 -1.92727861e+00 -8.45548586e-01 -8.45548586e-01
 -8.45548586e-01  8.62475388e-01  1.08534833e+00  1.08534833e+00
  1.08534833e+00  4.85296801e+00  5.66824549e+00  5.66824549e+00
  5.66824549e+00  1.79239387e+01  2.39920657e+01  2.39920657e+01
  2.39920657e+01  5.73092357e+01  1.18712840e+02  1.18712840e+02
  1.18712840e+02  1.74372876e+02  5.47349330e+02  1.91488919e+03
  8.03998215e+03  4.78009011e+04]
E1 = -182.59806673076338  E_coul = 54.06549360145384
cycle= 5 E= -128.53257312931  delta_E= -5.45e-10  |g|= 6.71e-06  |ddm|= 5.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59806673076338  E_coul = 54.06549360145384
  HOMO = -0.845544917849462  LUMO = 0.8624769835251
  mo_energy =
[-3.27696308e+01 -1.92727422e+00 -8.45544918e-01 -8.45544918e-01
 -8.45544918e-01  8.62476984e-01  1.08534986e+00  1.08534986e+00
  1.08534986e+00  4.85297173e+00  5.66824994e+00  5.66824994e+00
  5.66824994e+00  1.79239446e+01  2.39920725e+01  2.39920725e+01
  2.39920725e+01  5.73092430e+01  1.18712848e+02  1.18712848e+02
  1.18712848e+02  1.74372884e+02  5.47349337e+02  1.91488920e+03
  8.03998216e+03  4.78009011e+04]
E1 = -182.59804912748763  E_coul = 54.0654759981751
Extra cycle  E= -128.532573129313  delta_E= -3.01e-12  |g|= 2.46e-06  |ddm|= 2.42e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1370.2620319413882
E1 = -182.59804912748763  E_coul = 54.0654759981751
init E= -128.532573129313
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.845546149122298  LUMO = 0.862476704741585
  mo_energy =
[-3.27696347e+01 -1.92727540e+00 -8.45546149e-01 -8.45546149e-01
 -8.45546149e-01  8.62476705e-01  1.08534943e+00  1.08534943e+00
  1.08534943e+00  4.85297077e+00  5.66824844e+00  5.66824844e+00
  5.66824844e+00  1.79239425e+01  2.39920697e+01  2.39920697e+01
  2.39920697e+01  5.73092398e+01  1.18712844e+02  1.18712844e+02
  1.18712844e+02  1.74372880e+02  5.47349333e+02  1.91488919e+03
  8.03998215e+03  4.78009011e+04]
E1 = -182.59805861986268  E_coul = 54.0654854905499
cycle= 1 E= -128.532573129313  delta_E= -2.56e-13  |g|= 1.3e-06  |ddm|= 9.44e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59805861986268  E_coul = 54.0654854905499
  HOMO = -0.845545481852665  LUMO = 0.862476908748198
  mo_energy =
[-3.27696327e+01 -1.92727467e+00 -8.45545482e-01 -8.45545482e-01
 -8.45545482e-01  8.62476909e-01  1.08534968e+00  1.08534968e+00
  1.08534968e+00  4.85297135e+00  5.66824926e+00  5.66824926e+00
  5.66824926e+00  1.79239437e+01  2.39920712e+01  2.39920712e+01
  2.39920712e+01  5.73092415e+01  1.18712846e+02  1.18712846e+02
  1.18712846e+02  1.74372882e+02  5.47349335e+02  1.91488920e+03
  8.03998215e+03  4.78009011e+04]
E1 = -182.59805390324746  E_coul = 54.06548077393431
Extra cycle  E= -128.532573129313  delta_E= -3.69e-13  |g|= 6.42e-07  |ddm|= 4.61e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [8.56284668e-01 2.44137942e+04 3.66145022e+03 8.33353186e+02
 2.34901805e+02 7.94906588e+01 1.25974555e+01 3.02547145e+01
 3.22962882e-01 2.14488486e+00 5.60377179e+00 3.67520281e+00
 1.24327087e+01 5.47271096e+01 3.29231174e-01 1.13961012e+00]
grad_E = [ 5.78204053e-04  4.40316613e-09 -2.20540069e-07  3.77587747e-06
 -2.38414433e-05  2.92802109e-05 -7.38590276e-06 -5.64914894e-05
 -4.61034083e-04 -1.34295855e-04  2.13844704e-05  1.75703907e-04
  1.26123586e-05 -3.83472354e-07  1.32266602e-03 -1.19529183e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843041524962       1
[INPUT] 0    0    [1    /1   ]  24413.7942252        1
[INPUT] 0    0    [1    /1   ]  3661.44946443        1
[INPUT] 0    0    [1    /1   ]  833.367977187        1
[INPUT] 0    0    [1    /1   ]  234.74746243         1
[INPUT] 0    0    [1    /1   ]  80.0690316205        1
[INPUT] 0    0    [1    /1   ]  13.0671329994        1
[INPUT] 0    0    [1    /1   ]  30.986923087         1
[INPUT] 0    0    [1    /1   ]  0.317628383109       1
[INPUT] 0    0    [1    /1   ]  2.15415802884        1
[INPUT] 0    0    [1    /1   ]  5.79806093374        1
[INPUT] 1    0    [1    /1   ]  3.67595578539        1
[INPUT] 1    0    [1    /1   ]  12.4268361474        1
[INPUT] 1    0    [1    /1   ]  54.7160597695        1
[INPUT] 1    0    [1    /1   ]  0.329496720315       1
[INPUT] 1    0    [1    /1   ]  1.14083883768        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8430415249620264, 1.0]], [0, [24413.794225200083, 1.0]], [0, [3661.4494644322276, 1.0]], [0, [833.3679771866664, 1.0]], [0, [234.7474624298276, 1.0]], [0, [80.06903162051253, 1.0]], [0, [13.06713299937828, 1.0]], [0, [30.986923087009217, 1.0]], [0, [0.3176283831092126, 1.0]], [0, [2.1541580288354023, 1.0]], [0, [5.798060933737783, 1.0]], [1, [3.675955785389341, 1.0]], [1, [12.426836147408673, 1.0]], [1, [54.71605976948296, 1.0]], [1, [0.32949672031493477, 1.0]], [1, [1.1408388376832825, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84304152]
bas 1, expnt(s) = [24413.7942252]
bas 2, expnt(s) = [3661.44946443]
bas 3, expnt(s) = [833.36797719]
bas 4, expnt(s) = [234.74746243]
bas 5, expnt(s) = [80.06903162]
bas 6, expnt(s) = [13.067133]
bas 7, expnt(s) = [30.98692309]
bas 8, expnt(s) = [0.31762838]
bas 9, expnt(s) = [2.15415803]
bas 10, expnt(s) = [5.79806093]
bas 11, expnt(s) = [3.67595579]
bas 12, expnt(s) = [12.42683615]
bas 13, expnt(s) = [54.71605977]
bas 14, expnt(s) = [0.32949672]
bas 15, expnt(s) = [1.14083884]
CPU time:       357.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43041525e-01 2.22280697e+00 2.44137942e+04 4.93448103e+03
 3.66144946e+03 1.18919975e+03 8.33367977e+02 3.91870554e+02
 2.34747462e+02 1.51518515e+02 8.00690316e+01 6.76259620e+01
 1.30671330e+01 1.73640192e+01 3.09869231e+01 3.31817178e+01
 3.17628383e-01 1.06894289e+00 2.15415803e+00 4.49234596e+00
 5.79806093e+00 9.44011110e+00 3.67595579e+00 1.48490012e+01
 1.24268361e+01 6.80667646e+01 5.47160598e+01 4.34138110e+02
 3.29496720e-01 7.28279797e-01 1.14083884e+00 3.43965405e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998506393852143
cond(S) = 1343.2701297247718
E1 = -183.57795252356902  E_coul = 55.07849022781161
init E= -128.499462295757
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773945612472351  LUMO = 0.866897352356078
  mo_energy =
[-3.25555263e+01 -1.85290840e+00 -7.73945612e-01 -7.73945612e-01
 -7.73945612e-01  8.66897352e-01  1.11223747e+00  1.11223747e+00
  1.11223747e+00  4.89019270e+00  5.76027000e+00  5.76027000e+00
  5.76027000e+00  1.83830964e+01  2.41509060e+01  2.41509060e+01
  2.41509060e+01  5.92393797e+01  1.18899736e+02  1.18899736e+02
  1.18899736e+02  1.78843027e+02  5.53935121e+02  1.92182676e+03
  8.04632980e+03  4.78062621e+04]
E1 = -182.11063979144777  E_coul = 53.58140498067342
cycle= 1 E= -128.529234810774  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461133
diis-c [-0.2126433  1.       ]
  HOMO = -0.879658831726531  LUMO = 0.837017282088453
  mo_energy =
[-3.28742353e+01 -1.96322777e+00 -8.79658832e-01 -8.79658832e-01
 -8.79658832e-01  8.37017282e-01  1.07413295e+00  1.07413295e+00
  1.07413295e+00  4.79914757e+00  5.63151176e+00  5.63151176e+00
  5.63151176e+00  1.82031747e+01  2.39160061e+01  2.39160061e+01
  2.39160061e+01  5.89794377e+01  1.18578795e+02  1.18578795e+02
  1.18578795e+02  1.78527219e+02  5.53578174e+02  1.92143370e+03
  8.04590734e+03  4.78058207e+04]
E1 = -182.84319402560007  E_coul = 54.31145190237114
cycle= 2 E= -128.531742123229  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230602
diis-c [-0.00070528  0.3322543   0.6677457 ]
  HOMO = -0.845286040336367  LUMO = 0.846714344557443
  mo_energy =
[-3.27691843e+01 -1.92708941e+00 -8.45286040e-01 -8.45286040e-01
 -8.45286040e-01  8.46714345e-01  1.08658967e+00  1.08658967e+00
  1.08658967e+00  4.82859804e+00  5.67338229e+00  5.67338229e+00
  5.67338229e+00  1.82622346e+01  2.39935426e+01  2.39935426e+01
  2.39935426e+01  5.90655375e+01  1.18683862e+02  1.18683862e+02
  1.18683862e+02  1.78630918e+02  5.53691678e+02  1.92155246e+03
  8.04602860e+03  4.78059429e+04]
E1 = -182.59757950258106  E_coul = 54.06498901335266
cycle= 3 E= -128.532590489228  delta_E= -0.000848  |g|= 0.000454  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000902797
diis-c [-1.42544679e-07 -2.20932760e-03 -8.66932789e-04  1.00307626e+00]
  HOMO = -0.8455143967329  LUMO = 0.846676877704982
  mo_energy =
[-3.27695762e+01 -1.92725264e+00 -8.45514397e-01 -8.45514397e-01
 -8.45514397e-01  8.46676878e-01  1.08654173e+00  1.08654173e+00
  1.08654173e+00  4.82845798e+00  5.67318642e+00  5.67318642e+00
  5.67318642e+00  1.82619819e+01  2.39932326e+01  2.39932326e+01
  2.39932326e+01  5.90652096e+01  1.18683458e+02  1.18683458e+02
  1.18683458e+02  1.78630521e+02  5.53691186e+02  1.92155186e+03
  8.04602791e+03  4.78059421e+04]
E1 = -182.59803350775002  E_coul = 54.06544299865695
cycle= 4 E= -128.532590509093  delta_E= -1.99e-08  |g|= 6.44e-05  |ddm|= 0.000295
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134713
diis-c [-1.01982791e-09  3.18484809e-04  4.82616114e-04 -2.12203736e-01
  1.21140264e+00]
  HOMO = -0.845546962137879  LUMO = 0.846669452013196
  mo_energy =
[-3.27696300e+01 -1.92727268e+00 -8.45546962e-01 -8.45546962e-01
 -8.45546962e-01  8.46669452e-01  1.08652816e+00  1.08652816e+00
  1.08652816e+00  4.82843342e+00  5.67315037e+00  5.67315037e+00
  5.67315037e+00  1.82619403e+01  2.39931843e+01  2.39931843e+01
  2.39931843e+01  5.90651600e+01  1.18683404e+02  1.18683404e+02
  1.18683404e+02  1.78630466e+02  5.53691124e+02  1.92155179e+03
  8.04602784e+03  4.78059420e+04]
E1 = -182.59814063339005  E_coul = 54.06555012374827
cycle= 5 E= -128.532590509642  delta_E= -5.49e-10  |g|= 6.7e-06  |ddm|= 5.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59814063339005  E_coul = 54.06555012374827
  HOMO = -0.84554329828529  LUMO = 0.846671027064181
  mo_energy =
[-3.27696220e+01 -1.92726829e+00 -8.45543298e-01 -8.45543298e-01
 -8.45543298e-01  8.46671027e-01  1.08652970e+00  1.08652970e+00
  1.08652970e+00  4.82843716e+00  5.67315482e+00  5.67315482e+00
  5.67315482e+00  1.82619463e+01  2.39931911e+01  2.39931911e+01
  2.39931911e+01  5.90651673e+01  1.18683411e+02  1.18683411e+02
  1.18683411e+02  1.78630474e+02  5.53691132e+02  1.92155180e+03
  8.04602784e+03  4.78059421e+04]
E1 = -182.59812305165318  E_coul = 54.06553254200858
Extra cycle  E= -128.532590509645  delta_E= -2.81e-12  |g|= 2.46e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.43041525e-01 2.44137942e+04 3.66144946e+03 8.33367977e+02
 2.34747462e+02 8.00690316e+01 1.30671330e+01 3.09869231e+01
 3.17628383e-01 2.15415803e+00 5.79806093e+00 3.67595579e+00
 1.24268361e+01 5.47160598e+01 3.29496720e-01 1.14083884e+00]
E = -128.5325905096446
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843041524962       1
[INPUT] 0    0    [1    /1   ]  24413.7942252        1
[INPUT] 0    0    [1    /1   ]  3661.44946443        1
[INPUT] 0    0    [1    /1   ]  833.367977187        1
[INPUT] 0    0    [1    /1   ]  234.74746243         1
[INPUT] 0    0    [1    /1   ]  80.0690316205        1
[INPUT] 0    0    [1    /1   ]  13.0671329994        1
[INPUT] 0    0    [1    /1   ]  30.986923087         1
[INPUT] 0    0    [1    /1   ]  0.317628383109       1
[INPUT] 0    0    [1    /1   ]  2.15415802884        1
[INPUT] 0    0    [1    /1   ]  5.79806093374        1
[INPUT] 1    0    [1    /1   ]  3.67595578539        1
[INPUT] 1    0    [1    /1   ]  12.4268361474        1
[INPUT] 1    0    [1    /1   ]  54.7160597695        1
[INPUT] 1    0    [1    /1   ]  0.329496720315       1
[INPUT] 1    0    [1    /1   ]  1.14083883768        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8430415249620264, 1.0]], [0, [24413.794225200083, 1.0]], [0, [3661.4494644322276, 1.0]], [0, [833.3679771866664, 1.0]], [0, [234.7474624298276, 1.0]], [0, [80.06903162051253, 1.0]], [0, [13.06713299937828, 1.0]], [0, [30.986923087009217, 1.0]], [0, [0.3176283831092126, 1.0]], [0, [2.1541580288354023, 1.0]], [0, [5.798060933737783, 1.0]], [1, [3.675955785389341, 1.0]], [1, [12.426836147408673, 1.0]], [1, [54.71605976948296, 1.0]], [1, [0.32949672031493477, 1.0]], [1, [1.1408388376832825, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84304152]
bas 1, expnt(s) = [24413.7942252]
bas 2, expnt(s) = [3661.44946443]
bas 3, expnt(s) = [833.36797719]
bas 4, expnt(s) = [234.74746243]
bas 5, expnt(s) = [80.06903162]
bas 6, expnt(s) = [13.067133]
bas 7, expnt(s) = [30.98692309]
bas 8, expnt(s) = [0.31762838]
bas 9, expnt(s) = [2.15415803]
bas 10, expnt(s) = [5.79806093]
bas 11, expnt(s) = [3.67595579]
bas 12, expnt(s) = [12.42683615]
bas 13, expnt(s) = [54.71605977]
bas 14, expnt(s) = [0.32949672]
bas 15, expnt(s) = [1.14083884]
CPU time:       359.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43041525e-01 2.22280697e+00 2.44137942e+04 4.93448103e+03
 3.66144946e+03 1.18919975e+03 8.33367977e+02 3.91870554e+02
 2.34747462e+02 1.51518515e+02 8.00690316e+01 6.76259620e+01
 1.30671330e+01 1.73640192e+01 3.09869231e+01 3.31817178e+01
 3.17628383e-01 1.06894289e+00 2.15415803e+00 4.49234596e+00
 5.79806093e+00 9.44011110e+00 3.67595579e+00 1.48490012e+01
 1.24268361e+01 6.80667646e+01 5.47160598e+01 4.34138110e+02
 3.29496720e-01 7.28279797e-01 1.14083884e+00 3.43965405e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998506393852143
cond(S) = 1343.2701297247718
E1 = -183.57795252356902  E_coul = 55.07849022781161
init E= -128.499462295757
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773945612472351  LUMO = 0.866897352356078
  mo_energy =
[-3.25555263e+01 -1.85290840e+00 -7.73945612e-01 -7.73945612e-01
 -7.73945612e-01  8.66897352e-01  1.11223747e+00  1.11223747e+00
  1.11223747e+00  4.89019270e+00  5.76027000e+00  5.76027000e+00
  5.76027000e+00  1.83830964e+01  2.41509060e+01  2.41509060e+01
  2.41509060e+01  5.92393797e+01  1.18899736e+02  1.18899736e+02
  1.18899736e+02  1.78843027e+02  5.53935121e+02  1.92182676e+03
  8.04632980e+03  4.78062621e+04]
E1 = -182.11063979144777  E_coul = 53.58140498067342
cycle= 1 E= -128.529234810774  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461133
diis-c [-0.2126433  1.       ]
  HOMO = -0.879658831726531  LUMO = 0.837017282088453
  mo_energy =
[-3.28742353e+01 -1.96322777e+00 -8.79658832e-01 -8.79658832e-01
 -8.79658832e-01  8.37017282e-01  1.07413295e+00  1.07413295e+00
  1.07413295e+00  4.79914757e+00  5.63151176e+00  5.63151176e+00
  5.63151176e+00  1.82031747e+01  2.39160061e+01  2.39160061e+01
  2.39160061e+01  5.89794377e+01  1.18578795e+02  1.18578795e+02
  1.18578795e+02  1.78527219e+02  5.53578174e+02  1.92143370e+03
  8.04590734e+03  4.78058207e+04]
E1 = -182.84319402560007  E_coul = 54.31145190237114
cycle= 2 E= -128.531742123229  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230602
diis-c [-0.00070528  0.3322543   0.6677457 ]
  HOMO = -0.845286040336367  LUMO = 0.846714344557443
  mo_energy =
[-3.27691843e+01 -1.92708941e+00 -8.45286040e-01 -8.45286040e-01
 -8.45286040e-01  8.46714345e-01  1.08658967e+00  1.08658967e+00
  1.08658967e+00  4.82859804e+00  5.67338229e+00  5.67338229e+00
  5.67338229e+00  1.82622346e+01  2.39935426e+01  2.39935426e+01
  2.39935426e+01  5.90655375e+01  1.18683862e+02  1.18683862e+02
  1.18683862e+02  1.78630918e+02  5.53691678e+02  1.92155246e+03
  8.04602860e+03  4.78059429e+04]
E1 = -182.59757950258106  E_coul = 54.06498901335266
cycle= 3 E= -128.532590489228  delta_E= -0.000848  |g|= 0.000454  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000902797
diis-c [-1.42544679e-07 -2.20932760e-03 -8.66932789e-04  1.00307626e+00]
  HOMO = -0.8455143967329  LUMO = 0.846676877704982
  mo_energy =
[-3.27695762e+01 -1.92725264e+00 -8.45514397e-01 -8.45514397e-01
 -8.45514397e-01  8.46676878e-01  1.08654173e+00  1.08654173e+00
  1.08654173e+00  4.82845798e+00  5.67318642e+00  5.67318642e+00
  5.67318642e+00  1.82619819e+01  2.39932326e+01  2.39932326e+01
  2.39932326e+01  5.90652096e+01  1.18683458e+02  1.18683458e+02
  1.18683458e+02  1.78630521e+02  5.53691186e+02  1.92155186e+03
  8.04602791e+03  4.78059421e+04]
E1 = -182.59803350775002  E_coul = 54.06544299865695
cycle= 4 E= -128.532590509093  delta_E= -1.99e-08  |g|= 6.44e-05  |ddm|= 0.000295
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134713
diis-c [-1.01982791e-09  3.18484809e-04  4.82616114e-04 -2.12203736e-01
  1.21140264e+00]
  HOMO = -0.845546962137879  LUMO = 0.846669452013196
  mo_energy =
[-3.27696300e+01 -1.92727268e+00 -8.45546962e-01 -8.45546962e-01
 -8.45546962e-01  8.46669452e-01  1.08652816e+00  1.08652816e+00
  1.08652816e+00  4.82843342e+00  5.67315037e+00  5.67315037e+00
  5.67315037e+00  1.82619403e+01  2.39931843e+01  2.39931843e+01
  2.39931843e+01  5.90651600e+01  1.18683404e+02  1.18683404e+02
  1.18683404e+02  1.78630466e+02  5.53691124e+02  1.92155179e+03
  8.04602784e+03  4.78059420e+04]
E1 = -182.59814063339005  E_coul = 54.06555012374827
cycle= 5 E= -128.532590509642  delta_E= -5.49e-10  |g|= 6.7e-06  |ddm|= 5.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59814063339005  E_coul = 54.06555012374827
  HOMO = -0.84554329828529  LUMO = 0.846671027064181
  mo_energy =
[-3.27696220e+01 -1.92726829e+00 -8.45543298e-01 -8.45543298e-01
 -8.45543298e-01  8.46671027e-01  1.08652970e+00  1.08652970e+00
  1.08652970e+00  4.82843716e+00  5.67315482e+00  5.67315482e+00
  5.67315482e+00  1.82619463e+01  2.39931911e+01  2.39931911e+01
  2.39931911e+01  5.90651673e+01  1.18683411e+02  1.18683411e+02
  1.18683411e+02  1.78630474e+02  5.53691132e+02  1.92155180e+03
  8.04602784e+03  4.78059421e+04]
E1 = -182.59812305165318  E_coul = 54.06553254200858
Extra cycle  E= -128.532590509645  delta_E= -2.81e-12  |g|= 2.46e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1343.2701297247718
E1 = -182.59812305165318  E_coul = 54.06553254200858
init E= -128.532590509645
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845544528248985  LUMO = 0.846670753275852
  mo_energy =
[-3.27696259e+01 -1.92726946e+00 -8.45544528e-01 -8.45544528e-01
 -8.45544528e-01  8.46670753e-01  1.08652927e+00  1.08652927e+00
  1.08652927e+00  4.82843619e+00  5.67315332e+00  5.67315332e+00
  5.67315332e+00  1.82619442e+01  2.39931883e+01  2.39931883e+01
  2.39931883e+01  5.90651641e+01  1.18683408e+02  1.18683408e+02
  1.18683408e+02  1.78630470e+02  5.53691127e+02  1.92155179e+03
  8.04602784e+03  4.78059420e+04]
E1 = -182.59813253064243  E_coul = 54.06554202099748
cycle= 1 E= -128.532590509645  delta_E= -3.41e-13  |g|= 1.3e-06  |ddm|= 9.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59813253064243  E_coul = 54.06554202099748
  HOMO = -0.845543861966506  LUMO = 0.846670954038118
  mo_energy =
[-3.27696239e+01 -1.92726874e+00 -8.45543862e-01 -8.45543862e-01
 -8.45543862e-01  8.46670954e-01  1.08652951e+00  1.08652951e+00
  1.08652951e+00  4.82843678e+00  5.67315414e+00  5.67315414e+00
  5.67315414e+00  1.82619453e+01  2.39931898e+01  2.39931898e+01
  2.39931898e+01  5.90651658e+01  1.18683410e+02  1.18683410e+02
  1.18683410e+02  1.78630472e+02  5.53691130e+02  1.92155179e+03
  8.04602784e+03  4.78059420e+04]
E1 = -182.59812782048843  E_coul = 54.065537310843304
Extra cycle  E= -128.532590509645  delta_E= -1.99e-13  |g|= 6.41e-07  |ddm|= 4.61e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [8.43041525e-01 2.44137942e+04 3.66144946e+03 8.33367977e+02
 2.34747462e+02 8.00690316e+01 1.30671330e+01 3.09869231e+01
 3.17628383e-01 2.15415803e+00 5.79806093e+00 3.67595579e+00
 1.24268361e+01 5.47160598e+01 3.29496720e-01 1.14083884e+00]
grad_E = [ 4.86300554e-06  4.84758019e-09 -2.42019719e-07  4.10430796e-06
 -2.45630433e-05  1.97947874e-05 -4.17478465e-07 -3.30389586e-05
  2.28590954e-05  1.24750799e-05  9.80291613e-06  6.43662120e-05
 -3.59796871e-06  1.21006955e-06  5.17172846e-04 -4.59785657e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.837947467394       1
[INPUT] 0    0    [1    /1   ]  24413.7942263        1
[INPUT] 0    0    [1    /1   ]  3661.44940309        1
[INPUT] 0    0    [1    /1   ]  833.36922533         1
[INPUT] 0    0    [1    /1   ]  234.734065514        1
[INPUT] 0    0    [1    /1   ]  80.103030775         1
[INPUT] 0    0    [1    /1   ]  13.2246181437        1
[INPUT] 0    0    [1    /1   ]  31.2200776204        1
[INPUT] 0    0    [1    /1   ]  0.316000364983       1
[INPUT] 0    0    [1    /1   ]  2.14900408841        1
[INPUT] 0    0    [1    /1   ]  5.82308213161        1
[INPUT] 1    0    [1    /1   ]  3.6785218417         1
[INPUT] 1    0    [1    /1   ]  12.4312554353        1
[INPUT] 1    0    [1    /1   ]  54.7130559727        1
[INPUT] 1    0    [1    /1   ]  0.329728705294       1
[INPUT] 1    0    [1    /1   ]  1.14197202899        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8379474673938329, 1.0]], [0, [24413.794226349088, 1.0]], [0, [3661.4494030915257, 1.0]], [0, [833.3692253302046, 1.0]], [0, [234.73406551356524, 1.0]], [0, [80.10303077500133, 1.0]], [0, [13.224618143674979, 1.0]], [0, [31.220077620447558, 1.0]], [0, [0.3160003649827032, 1.0]], [0, [2.149004088411048, 1.0]], [0, [5.82308213160889, 1.0]], [1, [3.6785218417042027, 1.0]], [1, [12.431255435307575, 1.0]], [1, [54.71305597271, 1.0]], [1, [0.3297287052938244, 1.0]], [1, [1.14197202898585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83794747]
bas 1, expnt(s) = [24413.79422635]
bas 2, expnt(s) = [3661.44940309]
bas 3, expnt(s) = [833.36922533]
bas 4, expnt(s) = [234.73406551]
bas 5, expnt(s) = [80.10303078]
bas 6, expnt(s) = [13.22461814]
bas 7, expnt(s) = [31.22007762]
bas 8, expnt(s) = [0.31600036]
bas 9, expnt(s) = [2.14900409]
bas 10, expnt(s) = [5.82308213]
bas 11, expnt(s) = [3.67852184]
bas 12, expnt(s) = [12.43125544]
bas 13, expnt(s) = [54.71305597]
bas 14, expnt(s) = [0.32972871]
bas 15, expnt(s) = [1.14197203]
CPU time:       362.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.37947467e-01 2.21272590e+00 2.44137942e+04 4.93448103e+03
 3.66144940e+03 1.18919973e+03 8.33369225e+02 3.91870994e+02
 2.34734066e+02 1.51512029e+02 8.01030308e+01 6.76474975e+01
 1.32246181e+01 1.75207374e+01 3.12200776e+01 3.33687938e+01
 3.16000365e-01 1.06483106e+00 2.14900409e+00 4.48428241e+00
 5.82308213e+00 9.47064834e+00 3.67852184e+00 1.48619593e+01
 1.24312554e+01 6.80970237e+01 5.47130560e+01 4.34108319e+02
 3.29728705e-01 7.28920793e-01 1.14197203e+00 3.44392532e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998500606752337
cond(S) = 1326.9243195699378
E1 = -183.5779954958864  E_coul = 55.07849681375733
init E= -128.499498682129
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773944623551945  LUMO = 0.861011000792585
  mo_energy =
[-3.25555283e+01 -1.85290725e+00 -7.73944624e-01 -7.73944624e-01
 -7.73944624e-01  8.61011001e-01  1.11331167e+00  1.11331167e+00
  1.11331167e+00  4.86897852e+00  5.76586612e+00  5.76586612e+00
  5.76586612e+00  1.84176486e+01  2.41675709e+01  2.41675709e+01
  2.41675709e+01  5.96570343e+01  1.18920018e+02  1.18920018e+02
  1.18920018e+02  1.79941842e+02  5.55467606e+02  1.92338356e+03
  8.04773604e+03  4.78074334e+04]
E1 = -182.11087129828465  E_coul = 53.581630855765816
cycle= 1 E= -128.529240442519  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461042
diis-c [-0.21255952  1.        ]
  HOMO = -0.879643080221696  LUMO = 0.831330657700917
  mo_energy =
[-3.28741922e+01 -1.96320708e+00 -8.79643080e-01 -8.79643080e-01
 -8.79643080e-01  8.31330658e-01  1.07516872e+00  1.07516872e+00
  1.07516872e+00  4.77800358e+00  5.63705628e+00  5.63705628e+00
  5.63705628e+00  1.82371590e+01  2.39326788e+01  2.39326788e+01
  2.39326788e+01  5.93964864e+01  1.18599125e+02  1.18599125e+02
  1.18599125e+02  1.79625880e+02  5.55110698e+02  1.92299055e+03
  8.04731363e+03  4.78069921e+04]
E1 = -182.84325004051155  E_coul = 54.311503069349534
cycle= 2 E= -128.531746971162  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230533
diis-c [-0.00070619  0.33222952  0.66777048]
  HOMO = -0.845277704465111  LUMO = 0.840962874366905
  mo_energy =
[-3.27691602e+01 -1.92707695e+00 -8.45277704e-01 -8.45277704e-01
 -8.45277704e-01  8.40962874e-01  1.08763697e+00  1.08763697e+00
  1.08763697e+00  4.80742990e+00  5.67894071e+00  5.67894071e+00
  5.67894071e+00  1.82964092e+01  2.40102098e+01  2.40102098e+01
  2.40102098e+01  5.94827859e+01  1.18704172e+02  1.18704172e+02
  1.18704172e+02  1.79729621e+02  5.55224184e+02  1.92310929e+03
  8.04743487e+03  4.78071142e+04]
E1 = -182.5976942680049  E_coul = 54.06509932108507
cycle= 3 E= -128.53259494692  delta_E= -0.000848  |g|= 0.000456  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000907784
diis-c [-1.43599755e-07 -2.21221661e-03 -8.50700648e-04  1.00306292e+00]
  HOMO = -0.84550706132291  LUMO = 0.84092531684979
  mo_energy =
[-3.27695542e+01 -1.92724110e+00 -8.45507061e-01 -8.45507061e-01
 -8.45507061e-01  8.40925317e-01  1.08758851e+00  1.08758851e+00
  1.08758851e+00  4.80728915e+00  5.67874353e+00  5.67874353e+00
  5.67874353e+00  1.82961546e+01  2.40098980e+01  2.40098980e+01
  2.40098980e+01  5.94824556e+01  1.18703766e+02  1.18703766e+02
  1.18703766e+02  1.79729222e+02  5.55223690e+02  1.92310868e+03
  8.04743417e+03  4.78071135e+04]
E1 = -182.59815286597845  E_coul = 54.06555789902856
cycle= 4 E= -128.53259496695  delta_E= -2e-08  |g|= 6.45e-05  |ddm|= 0.000295
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134974
diis-c [-1.02041594e-09  3.19292109e-04  4.80131342e-04 -2.12323612e-01
  1.21152419e+00]
  HOMO = -0.845539687566933  LUMO = 0.840917925224128
  mo_energy =
[-3.27696081e+01 -1.92726116e+00 -8.45539688e-01 -8.45539688e-01
 -8.45539688e-01  8.40917925e-01  1.08757489e+00  1.08757489e+00
  1.08757489e+00  4.80726458e+00  5.67870741e+00  5.67870741e+00
  5.67870741e+00  1.82961129e+01  2.40098496e+01  2.40098496e+01
  2.40098496e+01  5.94824058e+01  1.18703712e+02  1.18703712e+02
  1.18703712e+02  1.79729167e+02  5.55223628e+02  1.92310861e+03
  8.04743410e+03  4.78071134e+04]
E1 = -182.5982600458572  E_coul = 54.0656650783554
cycle= 5 E= -128.532594967502  delta_E= -5.52e-10  |g|= 6.7e-06  |ddm|= 5.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5982600458572  E_coul = 54.0656650783554
  HOMO = -0.845536021770047  LUMO = 0.840919493107347
  mo_energy =
[-3.27696001e+01 -1.92725677e+00 -8.45536022e-01 -8.45536022e-01
 -8.45536022e-01  8.40919493e-01  1.08757643e+00  1.08757643e+00
  1.08757643e+00  4.80726832e+00  5.67871186e+00  5.67871186e+00
  5.67871186e+00  1.82961189e+01  2.40098564e+01  2.40098564e+01
  2.40098564e+01  5.94824131e+01  1.18703719e+02  1.18703719e+02
  1.18703719e+02  1.79729175e+02  5.55223636e+02  1.92310862e+03
  8.04743411e+03  4.78071134e+04]
E1 = -182.5982424638511  E_coul = 54.06564749634682
Extra cycle  E= -128.532594967504  delta_E= -2.5e-12  |g|= 2.46e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.37947467e-01 2.44137942e+04 3.66144940e+03 8.33369225e+02
 2.34734066e+02 8.01030308e+01 1.32246181e+01 3.12200776e+01
 3.16000365e-01 2.14900409e+00 5.82308213e+00 3.67852184e+00
 1.24312554e+01 5.47130560e+01 3.29728705e-01 1.14197203e+00]
E = -128.53259496750428
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.837947467394       1
[INPUT] 0    0    [1    /1   ]  24413.7942263        1
[INPUT] 0    0    [1    /1   ]  3661.44940309        1
[INPUT] 0    0    [1    /1   ]  833.36922533         1
[INPUT] 0    0    [1    /1   ]  234.734065514        1
[INPUT] 0    0    [1    /1   ]  80.103030775         1
[INPUT] 0    0    [1    /1   ]  13.2246181437        1
[INPUT] 0    0    [1    /1   ]  31.2200776204        1
[INPUT] 0    0    [1    /1   ]  0.316000364983       1
[INPUT] 0    0    [1    /1   ]  2.14900408841        1
[INPUT] 0    0    [1    /1   ]  5.82308213161        1
[INPUT] 1    0    [1    /1   ]  3.6785218417         1
[INPUT] 1    0    [1    /1   ]  12.4312554353        1
[INPUT] 1    0    [1    /1   ]  54.7130559727        1
[INPUT] 1    0    [1    /1   ]  0.329728705294       1
[INPUT] 1    0    [1    /1   ]  1.14197202899        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8379474673938329, 1.0]], [0, [24413.794226349088, 1.0]], [0, [3661.4494030915257, 1.0]], [0, [833.3692253302046, 1.0]], [0, [234.73406551356524, 1.0]], [0, [80.10303077500133, 1.0]], [0, [13.224618143674979, 1.0]], [0, [31.220077620447558, 1.0]], [0, [0.3160003649827032, 1.0]], [0, [2.149004088411048, 1.0]], [0, [5.82308213160889, 1.0]], [1, [3.6785218417042027, 1.0]], [1, [12.431255435307575, 1.0]], [1, [54.71305597271, 1.0]], [1, [0.3297287052938244, 1.0]], [1, [1.14197202898585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83794747]
bas 1, expnt(s) = [24413.79422635]
bas 2, expnt(s) = [3661.44940309]
bas 3, expnt(s) = [833.36922533]
bas 4, expnt(s) = [234.73406551]
bas 5, expnt(s) = [80.10303078]
bas 6, expnt(s) = [13.22461814]
bas 7, expnt(s) = [31.22007762]
bas 8, expnt(s) = [0.31600036]
bas 9, expnt(s) = [2.14900409]
bas 10, expnt(s) = [5.82308213]
bas 11, expnt(s) = [3.67852184]
bas 12, expnt(s) = [12.43125544]
bas 13, expnt(s) = [54.71305597]
bas 14, expnt(s) = [0.32972871]
bas 15, expnt(s) = [1.14197203]
CPU time:       363.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.37947467e-01 2.21272590e+00 2.44137942e+04 4.93448103e+03
 3.66144940e+03 1.18919973e+03 8.33369225e+02 3.91870994e+02
 2.34734066e+02 1.51512029e+02 8.01030308e+01 6.76474975e+01
 1.32246181e+01 1.75207374e+01 3.12200776e+01 3.33687938e+01
 3.16000365e-01 1.06483106e+00 2.14900409e+00 4.48428241e+00
 5.82308213e+00 9.47064834e+00 3.67852184e+00 1.48619593e+01
 1.24312554e+01 6.80970237e+01 5.47130560e+01 4.34108319e+02
 3.29728705e-01 7.28920793e-01 1.14197203e+00 3.44392532e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998500606752337
cond(S) = 1326.9243195699378
E1 = -183.5779954958864  E_coul = 55.07849681375733
init E= -128.499498682129
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773944623551945  LUMO = 0.861011000792585
  mo_energy =
[-3.25555283e+01 -1.85290725e+00 -7.73944624e-01 -7.73944624e-01
 -7.73944624e-01  8.61011001e-01  1.11331167e+00  1.11331167e+00
  1.11331167e+00  4.86897852e+00  5.76586612e+00  5.76586612e+00
  5.76586612e+00  1.84176486e+01  2.41675709e+01  2.41675709e+01
  2.41675709e+01  5.96570343e+01  1.18920018e+02  1.18920018e+02
  1.18920018e+02  1.79941842e+02  5.55467606e+02  1.92338356e+03
  8.04773604e+03  4.78074334e+04]
E1 = -182.11087129828465  E_coul = 53.581630855765816
cycle= 1 E= -128.529240442519  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.461042
diis-c [-0.21255952  1.        ]
  HOMO = -0.879643080221696  LUMO = 0.831330657700917
  mo_energy =
[-3.28741922e+01 -1.96320708e+00 -8.79643080e-01 -8.79643080e-01
 -8.79643080e-01  8.31330658e-01  1.07516872e+00  1.07516872e+00
  1.07516872e+00  4.77800358e+00  5.63705628e+00  5.63705628e+00
  5.63705628e+00  1.82371590e+01  2.39326788e+01  2.39326788e+01
  2.39326788e+01  5.93964864e+01  1.18599125e+02  1.18599125e+02
  1.18599125e+02  1.79625880e+02  5.55110698e+02  1.92299055e+03
  8.04731363e+03  4.78069921e+04]
E1 = -182.84325004051155  E_coul = 54.311503069349534
cycle= 2 E= -128.531746971162  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230533
diis-c [-0.00070619  0.33222952  0.66777048]
  HOMO = -0.845277704465111  LUMO = 0.840962874366905
  mo_energy =
[-3.27691602e+01 -1.92707695e+00 -8.45277704e-01 -8.45277704e-01
 -8.45277704e-01  8.40962874e-01  1.08763697e+00  1.08763697e+00
  1.08763697e+00  4.80742990e+00  5.67894071e+00  5.67894071e+00
  5.67894071e+00  1.82964092e+01  2.40102098e+01  2.40102098e+01
  2.40102098e+01  5.94827859e+01  1.18704172e+02  1.18704172e+02
  1.18704172e+02  1.79729621e+02  5.55224184e+02  1.92310929e+03
  8.04743487e+03  4.78071142e+04]
E1 = -182.5976942680049  E_coul = 54.06509932108507
cycle= 3 E= -128.53259494692  delta_E= -0.000848  |g|= 0.000456  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000907784
diis-c [-1.43599755e-07 -2.21221661e-03 -8.50700648e-04  1.00306292e+00]
  HOMO = -0.84550706132291  LUMO = 0.84092531684979
  mo_energy =
[-3.27695542e+01 -1.92724110e+00 -8.45507061e-01 -8.45507061e-01
 -8.45507061e-01  8.40925317e-01  1.08758851e+00  1.08758851e+00
  1.08758851e+00  4.80728915e+00  5.67874353e+00  5.67874353e+00
  5.67874353e+00  1.82961546e+01  2.40098980e+01  2.40098980e+01
  2.40098980e+01  5.94824556e+01  1.18703766e+02  1.18703766e+02
  1.18703766e+02  1.79729222e+02  5.55223690e+02  1.92310868e+03
  8.04743417e+03  4.78071135e+04]
E1 = -182.59815286597845  E_coul = 54.06555789902856
cycle= 4 E= -128.53259496695  delta_E= -2e-08  |g|= 6.45e-05  |ddm|= 0.000295
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134974
diis-c [-1.02041594e-09  3.19292109e-04  4.80131342e-04 -2.12323612e-01
  1.21152419e+00]
  HOMO = -0.845539687566933  LUMO = 0.840917925224128
  mo_energy =
[-3.27696081e+01 -1.92726116e+00 -8.45539688e-01 -8.45539688e-01
 -8.45539688e-01  8.40917925e-01  1.08757489e+00  1.08757489e+00
  1.08757489e+00  4.80726458e+00  5.67870741e+00  5.67870741e+00
  5.67870741e+00  1.82961129e+01  2.40098496e+01  2.40098496e+01
  2.40098496e+01  5.94824058e+01  1.18703712e+02  1.18703712e+02
  1.18703712e+02  1.79729167e+02  5.55223628e+02  1.92310861e+03
  8.04743410e+03  4.78071134e+04]
E1 = -182.5982600458572  E_coul = 54.0656650783554
cycle= 5 E= -128.532594967502  delta_E= -5.52e-10  |g|= 6.7e-06  |ddm|= 5.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5982600458572  E_coul = 54.0656650783554
  HOMO = -0.845536021770047  LUMO = 0.840919493107347
  mo_energy =
[-3.27696001e+01 -1.92725677e+00 -8.45536022e-01 -8.45536022e-01
 -8.45536022e-01  8.40919493e-01  1.08757643e+00  1.08757643e+00
  1.08757643e+00  4.80726832e+00  5.67871186e+00  5.67871186e+00
  5.67871186e+00  1.82961189e+01  2.40098564e+01  2.40098564e+01
  2.40098564e+01  5.94824131e+01  1.18703719e+02  1.18703719e+02
  1.18703719e+02  1.79729175e+02  5.55223636e+02  1.92310862e+03
  8.04743411e+03  4.78071134e+04]
E1 = -182.5982424638511  E_coul = 54.06564749634682
Extra cycle  E= -128.532594967504  delta_E= -2.5e-12  |g|= 2.46e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1326.9243195699378
E1 = -182.5982424638511  E_coul = 54.06564749634682
init E= -128.532594967504
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845537251767436  LUMO = 0.840919221387654
  mo_energy =
[-3.27696040e+01 -1.92725795e+00 -8.45537252e-01 -8.45537252e-01
 -8.45537252e-01  8.40919221e-01  1.08757600e+00  1.08757600e+00
  1.08757600e+00  4.80726735e+00  5.67871036e+00  5.67871036e+00
  5.67871036e+00  1.82961168e+01  2.40098536e+01  2.40098536e+01
  2.40098536e+01  5.94824100e+01  1.18703715e+02  1.18703715e+02
  1.18703715e+02  1.79729171e+02  5.55223631e+02  1.92310862e+03
  8.04743410e+03  4.78071134e+04]
E1 = -182.59825194308158  E_coul = 54.06565697557671
cycle= 1 E= -128.532594967505  delta_E= -5.97e-13  |g|= 1.3e-06  |ddm|= 9.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59825194308158  E_coul = 54.06565697557671
  HOMO = -0.845536585485105  LUMO = 0.840919420900919
  mo_energy =
[-3.27696020e+01 -1.92725722e+00 -8.45536585e-01 -8.45536585e-01
 -8.45536585e-01  8.40919421e-01  1.08757624e+00  1.08757624e+00
  1.08757624e+00  4.80726794e+00  5.67871118e+00  5.67871118e+00
  5.67871118e+00  1.82961179e+01  2.40098551e+01  2.40098551e+01
  2.40098551e+01  5.94824116e+01  1.18703717e+02  1.18703717e+02
  1.18703717e+02  1.79729173e+02  5.55223633e+02  1.92310862e+03
  8.04743410e+03  4.78071134e+04]
E1 = -182.59824723306156  E_coul = 54.06565226555672
Extra cycle  E= -128.532594967505  delta_E= 2.84e-14  |g|= 6.41e-07  |ddm|= 4.62e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [8.37947467e-01 2.44137942e+04 3.66144940e+03 8.33369225e+02
 2.34734066e+02 8.01030308e+01 1.32246181e+01 3.12200776e+01
 3.16000365e-01 2.14900409e+00 5.82308213e+00 3.67852184e+00
 1.24312554e+01 5.47130560e+01 3.29728705e-01 1.14197203e+00]
grad_E = [-6.39948547e-05  4.55877107e-09 -2.27222762e-07  3.80611303e-06
 -2.16387154e-05  7.43306160e-06  8.68220725e-06 -1.65615504e-05
  7.87487429e-05  1.49978923e-05 -7.36868804e-06  2.09007793e-05
 -1.18271540e-06  2.86044584e-07  1.41389399e-04 -1.31279466e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.844955418192       1
[INPUT] 0    0    [1    /1   ]  24413.7942261        1
[INPUT] 0    0    [1    /1   ]  3661.44941525        1
[INPUT] 0    0    [1    /1   ]  833.368897446        1
[INPUT] 0    0    [1    /1   ]  234.739897754        1
[INPUT] 0    0    [1    /1   ]  80.0420723689        1
[INPUT] 0    0    [1    /1   ]  13.4665092931        1
[INPUT] 0    0    [1    /1   ]  31.4158149057        1
[INPUT] 0    0    [1    /1   ]  0.317335667578       1
[INPUT] 0    0    [1    /1   ]  2.17368775709        1
[INPUT] 0    0    [1    /1   ]  6.04958345299        1
[INPUT] 1    0    [1    /1   ]  3.68001701744        1
[INPUT] 1    0    [1    /1   ]  12.4335160994        1
[INPUT] 1    0    [1    /1   ]  54.7112170761        1
[INPUT] 1    0    [1    /1   ]  0.329862641634       1
[INPUT] 1    0    [1    /1   ]  1.14265733998        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8449554181917768, 1.0]], [0, [24413.794226125396, 1.0]], [0, [3661.4494152483, 1.0]], [0, [833.3688974461554, 1.0]], [0, [234.73989775422638, 1.0]], [0, [80.04207236889926, 1.0]], [0, [13.466509293086572, 1.0]], [0, [31.415814905685234, 1.0]], [0, [0.31733566757825704, 1.0]], [0, [2.173687757094083, 1.0]], [0, [6.0495834529891885, 1.0]], [1, [3.6800170174400972, 1.0]], [1, [12.433516099405175, 1.0]], [1, [54.7112170760592, 1.0]], [1, [0.32986264163385387, 1.0]], [1, [1.1426573399800768, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84495542]
bas 1, expnt(s) = [24413.79422613]
bas 2, expnt(s) = [3661.44941525]
bas 3, expnt(s) = [833.36889745]
bas 4, expnt(s) = [234.73989775]
bas 5, expnt(s) = [80.04207237]
bas 6, expnt(s) = [13.46650929]
bas 7, expnt(s) = [31.41581491]
bas 8, expnt(s) = [0.31733567]
bas 9, expnt(s) = [2.17368776]
bas 10, expnt(s) = [6.04958345]
bas 11, expnt(s) = [3.68001702]
bas 12, expnt(s) = [12.4335161]
bas 13, expnt(s) = [54.71121708]
bas 14, expnt(s) = [0.32986264]
bas 15, expnt(s) = [1.14265734]
CPU time:       367.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.44955418e-01 2.22659060e+00 2.44137942e+04 4.93448103e+03
 3.66144942e+03 1.18919973e+03 8.33368897e+02 3.91870878e+02
 2.34739898e+02 1.51514853e+02 8.00420724e+01 6.76088841e+01
 1.34665093e+01 1.77605455e+01 3.14158149e+01 3.35255778e+01
 3.17335668e-01 1.06820398e+00 2.17368776e+00 4.52285738e+00
 6.04958345e+00 9.74561226e+00 3.68001702e+00 1.48695106e+01
 1.24335161e+01 6.81125036e+01 5.47112171e+01 4.34090081e+02
 3.29862642e-01 7.29290923e-01 1.14265734e+00 3.44650894e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998496628493113
cond(S) = 1388.0003581215444
E1 = -183.5780960521963  E_coul = 55.0785062647885
init E= -128.499589787408
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943551233367  LUMO = 0.86949762937667
  mo_energy =
[-3.25555279e+01 -1.85290555e+00 -7.73943551e-01 -7.73943551e-01
 -7.73943551e-01  8.69497629e-01  1.11394205e+00  1.11394205e+00
  1.11394205e+00  4.94094283e+00  5.76919630e+00  5.76919630e+00
  5.76919630e+00  1.88841112e+01  2.41770347e+01  2.41770347e+01
  2.41770347e+01  6.10153303e+01  1.18930776e+02  1.18930776e+02
  1.18930776e+02  1.82132912e+02  5.57904048e+02  1.92567995e+03
  8.04978034e+03  4.78091309e+04]
E1 = -182.1110213260778  E_coul = 53.58177966037934
cycle= 1 E= -128.529241665698  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46071
diis-c [-0.21225361  1.        ]
  HOMO = -0.879632522628349  LUMO = 0.839467834257731
  mo_energy =
[-3.28741614e+01 -1.96319504e+00 -8.79632523e-01 -8.79632523e-01
 -8.79632523e-01  8.39467834e-01  1.07577811e+00  1.07577811e+00
  1.07577811e+00  4.84857647e+00  5.64035740e+00  5.64035740e+00
  5.64035740e+00  1.87012044e+01  2.39421475e+01  2.39421475e+01
  2.39421475e+01  6.07536836e+01  1.18609919e+02  1.18609919e+02
  1.18609919e+02  1.81816844e+02  5.57547214e+02  1.92528699e+03
  8.04935797e+03  4.78086896e+04]
E1 = -182.84327743882832  E_coul = 54.311529836205835
cycle= 2 E= -128.531747602622  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230368
diis-c [-0.00071173  0.33222007  0.66777993]
  HOMO = -0.845272756623384  LUMO = 0.849210808371692
  mo_energy =
[-3.27691442e+01 -1.92707085e+00 -8.45272757e-01 -8.45272757e-01
 -8.45272757e-01  8.49210808e-01  1.08825287e+00  1.08825287e+00
  1.08825287e+00  4.87845757e+00  5.68224859e+00  5.68224859e+00
  5.68224859e+00  1.87612686e+01  2.40196719e+01  2.40196719e+01
  2.40196719e+01  6.08403452e+01  1.18714950e+02  1.18714950e+02
  1.18714950e+02  1.81920611e+02  5.57660674e+02  1.92540571e+03
  8.04947919e+03  4.78088117e+04]
E1 = -182.59776794412295  E_coul = 54.06517264306187
cycle= 3 E= -128.532595301061  delta_E= -0.000848  |g|= 0.000455  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000908021
diis-c [-1.42194215e-07 -2.21330589e-03 -8.45487351e-04  1.00305879e+00]
  HOMO = -0.845502084019075  LUMO = 0.849172797579847
  mo_energy =
[-3.27695379e+01 -1.92723502e+00 -8.45502084e-01 -8.45502084e-01
 -8.45502084e-01  8.49172798e-01  1.08820444e+00  1.08820444e+00
  1.08820444e+00  4.87831495e+00  5.68205132e+00  5.68205132e+00
  5.68205132e+00  1.87610117e+01  2.40193602e+01  2.40193602e+01
  2.40193602e+01  6.08400140e+01  1.18714545e+02  1.18714545e+02
  1.18714545e+02  1.81920212e+02  5.57660180e+02  1.92540511e+03
  8.04947850e+03  4.78088110e+04]
E1 = -182.59822715643642  E_coul = 54.06563183543912
cycle= 4 E= -128.532595320997  delta_E= -1.99e-08  |g|= 6.45e-05  |ddm|= 0.000291
    CPU time for cycle= 4      0.02 sec, wall time      0.07 sec
diis-norm(errvec)=0.000135263
diis-c [-1.01651017e-09  3.18675585e-04  4.82822312e-04 -2.11766885e-01
  1.21096539e+00]
  HOMO = -0.845534704576749  LUMO = 0.849165329163922
  mo_energy =
[-3.27695919e+01 -1.92725511e+00 -8.45534705e-01 -8.45534705e-01
 -8.45534705e-01  8.49165329e-01  1.08819084e+00  1.08819084e+00
  1.08819084e+00  4.87829009e+00  5.68201517e+00  5.68201517e+00
  5.68201517e+00  1.87609696e+01  2.40193117e+01  2.40193117e+01
  2.40193117e+01  6.08399640e+01  1.18714490e+02  1.18714490e+02
  1.18714490e+02  1.81920157e+02  5.57660118e+02  1.92540504e+03
  8.04947843e+03  4.78088109e+04]
E1 = -182.59833486362155  E_coul = 54.065739542073935
cycle= 5 E= -128.532595321548  delta_E= -5.5e-10  |g|= 6.67e-06  |ddm|= 5.06e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59833486362155  E_coul = 54.065739542073935
  HOMO = -0.845531062719426  LUMO = 0.849166906456369
  mo_energy =
[-3.27695840e+01 -1.92725074e+00 -8.45531063e-01 -8.45531063e-01
 -8.45531063e-01  8.49166906e-01  1.08819236e+00  1.08819236e+00
  1.08819236e+00  4.87829385e+00  5.68201960e+00  5.68201960e+00
  5.68201960e+00  1.87609756e+01  2.40193185e+01  2.40193185e+01
  2.40193185e+01  6.08399713e+01  1.18714498e+02  1.18714498e+02
  1.18714498e+02  1.81920165e+02  5.57660126e+02  1.92540505e+03
  8.04947843e+03  4.78088109e+04]
E1 = -182.59831741386265  E_coul = 54.06572209231238
Extra cycle  E= -128.53259532155  delta_E= -2.67e-12  |g|= 2.44e-06  |ddm|= 2.36e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.17 sec
exp = [8.44955418e-01 2.44137942e+04 3.66144942e+03 8.33368897e+02
 2.34739898e+02 8.00420724e+01 1.34665093e+01 3.14158149e+01
 3.17335668e-01 2.17368776e+00 6.04958345e+00 3.68001702e+00
 1.24335161e+01 5.47112171e+01 3.29862642e-01 1.14265734e+00]
E = -128.53259532155028
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.844955418192       1
[INPUT] 0    0    [1    /1   ]  24413.7942261        1
[INPUT] 0    0    [1    /1   ]  3661.44941525        1
[INPUT] 0    0    [1    /1   ]  833.368897446        1
[INPUT] 0    0    [1    /1   ]  234.739897754        1
[INPUT] 0    0    [1    /1   ]  80.0420723689        1
[INPUT] 0    0    [1    /1   ]  13.4665092931        1
[INPUT] 0    0    [1    /1   ]  31.4158149057        1
[INPUT] 0    0    [1    /1   ]  0.317335667578       1
[INPUT] 0    0    [1    /1   ]  2.17368775709        1
[INPUT] 0    0    [1    /1   ]  6.04958345299        1
[INPUT] 1    0    [1    /1   ]  3.68001701744        1
[INPUT] 1    0    [1    /1   ]  12.4335160994        1
[INPUT] 1    0    [1    /1   ]  54.7112170761        1
[INPUT] 1    0    [1    /1   ]  0.329862641634       1
[INPUT] 1    0    [1    /1   ]  1.14265733998        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8449554181917768, 1.0]], [0, [24413.794226125396, 1.0]], [0, [3661.4494152483, 1.0]], [0, [833.3688974461554, 1.0]], [0, [234.73989775422638, 1.0]], [0, [80.04207236889926, 1.0]], [0, [13.466509293086572, 1.0]], [0, [31.415814905685234, 1.0]], [0, [0.31733566757825704, 1.0]], [0, [2.173687757094083, 1.0]], [0, [6.0495834529891885, 1.0]], [1, [3.6800170174400972, 1.0]], [1, [12.433516099405175, 1.0]], [1, [54.7112170760592, 1.0]], [1, [0.32986264163385387, 1.0]], [1, [1.1426573399800768, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84495542]
bas 1, expnt(s) = [24413.79422613]
bas 2, expnt(s) = [3661.44941525]
bas 3, expnt(s) = [833.36889745]
bas 4, expnt(s) = [234.73989775]
bas 5, expnt(s) = [80.04207237]
bas 6, expnt(s) = [13.46650929]
bas 7, expnt(s) = [31.41581491]
bas 8, expnt(s) = [0.31733567]
bas 9, expnt(s) = [2.17368776]
bas 10, expnt(s) = [6.04958345]
bas 11, expnt(s) = [3.68001702]
bas 12, expnt(s) = [12.4335161]
bas 13, expnt(s) = [54.71121708]
bas 14, expnt(s) = [0.32986264]
bas 15, expnt(s) = [1.14265734]
CPU time:       368.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.44955418e-01 2.22659060e+00 2.44137942e+04 4.93448103e+03
 3.66144942e+03 1.18919973e+03 8.33368897e+02 3.91870878e+02
 2.34739898e+02 1.51514853e+02 8.00420724e+01 6.76088841e+01
 1.34665093e+01 1.77605455e+01 3.14158149e+01 3.35255778e+01
 3.17335668e-01 1.06820398e+00 2.17368776e+00 4.52285738e+00
 6.04958345e+00 9.74561226e+00 3.68001702e+00 1.48695106e+01
 1.24335161e+01 6.81125036e+01 5.47112171e+01 4.34090081e+02
 3.29862642e-01 7.29290923e-01 1.14265734e+00 3.44650894e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998496628493113
cond(S) = 1388.0003581215444
E1 = -183.5780960521963  E_coul = 55.0785062647885
init E= -128.499589787408
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943551233367  LUMO = 0.86949762937667
  mo_energy =
[-3.25555279e+01 -1.85290555e+00 -7.73943551e-01 -7.73943551e-01
 -7.73943551e-01  8.69497629e-01  1.11394205e+00  1.11394205e+00
  1.11394205e+00  4.94094283e+00  5.76919630e+00  5.76919630e+00
  5.76919630e+00  1.88841112e+01  2.41770347e+01  2.41770347e+01
  2.41770347e+01  6.10153303e+01  1.18930776e+02  1.18930776e+02
  1.18930776e+02  1.82132912e+02  5.57904048e+02  1.92567995e+03
  8.04978034e+03  4.78091309e+04]
E1 = -182.1110213260778  E_coul = 53.58177966037934
cycle= 1 E= -128.529241665698  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.46071
diis-c [-0.21225361  1.        ]
  HOMO = -0.879632522628349  LUMO = 0.839467834257731
  mo_energy =
[-3.28741614e+01 -1.96319504e+00 -8.79632523e-01 -8.79632523e-01
 -8.79632523e-01  8.39467834e-01  1.07577811e+00  1.07577811e+00
  1.07577811e+00  4.84857647e+00  5.64035740e+00  5.64035740e+00
  5.64035740e+00  1.87012044e+01  2.39421475e+01  2.39421475e+01
  2.39421475e+01  6.07536836e+01  1.18609919e+02  1.18609919e+02
  1.18609919e+02  1.81816844e+02  5.57547214e+02  1.92528699e+03
  8.04935797e+03  4.78086896e+04]
E1 = -182.84327743882832  E_coul = 54.311529836205835
cycle= 2 E= -128.531747602622  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230368
diis-c [-0.00071173  0.33222007  0.66777993]
  HOMO = -0.845272756623384  LUMO = 0.849210808371692
  mo_energy =
[-3.27691442e+01 -1.92707085e+00 -8.45272757e-01 -8.45272757e-01
 -8.45272757e-01  8.49210808e-01  1.08825287e+00  1.08825287e+00
  1.08825287e+00  4.87845757e+00  5.68224859e+00  5.68224859e+00
  5.68224859e+00  1.87612686e+01  2.40196719e+01  2.40196719e+01
  2.40196719e+01  6.08403452e+01  1.18714950e+02  1.18714950e+02
  1.18714950e+02  1.81920611e+02  5.57660674e+02  1.92540571e+03
  8.04947919e+03  4.78088117e+04]
E1 = -182.59776794412295  E_coul = 54.06517264306187
cycle= 3 E= -128.532595301061  delta_E= -0.000848  |g|= 0.000455  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000908021
diis-c [-1.42194215e-07 -2.21330589e-03 -8.45487351e-04  1.00305879e+00]
  HOMO = -0.845502084019075  LUMO = 0.849172797579847
  mo_energy =
[-3.27695379e+01 -1.92723502e+00 -8.45502084e-01 -8.45502084e-01
 -8.45502084e-01  8.49172798e-01  1.08820444e+00  1.08820444e+00
  1.08820444e+00  4.87831495e+00  5.68205132e+00  5.68205132e+00
  5.68205132e+00  1.87610117e+01  2.40193602e+01  2.40193602e+01
  2.40193602e+01  6.08400140e+01  1.18714545e+02  1.18714545e+02
  1.18714545e+02  1.81920212e+02  5.57660180e+02  1.92540511e+03
  8.04947850e+03  4.78088110e+04]
E1 = -182.59822715643642  E_coul = 54.06563183543912
cycle= 4 E= -128.532595320997  delta_E= -1.99e-08  |g|= 6.45e-05  |ddm|= 0.000291
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135263
diis-c [-1.01651017e-09  3.18675585e-04  4.82822312e-04 -2.11766885e-01
  1.21096539e+00]
  HOMO = -0.845534704576749  LUMO = 0.849165329163922
  mo_energy =
[-3.27695919e+01 -1.92725511e+00 -8.45534705e-01 -8.45534705e-01
 -8.45534705e-01  8.49165329e-01  1.08819084e+00  1.08819084e+00
  1.08819084e+00  4.87829009e+00  5.68201517e+00  5.68201517e+00
  5.68201517e+00  1.87609696e+01  2.40193117e+01  2.40193117e+01
  2.40193117e+01  6.08399640e+01  1.18714490e+02  1.18714490e+02
  1.18714490e+02  1.81920157e+02  5.57660118e+02  1.92540504e+03
  8.04947843e+03  4.78088109e+04]
E1 = -182.59833486362155  E_coul = 54.065739542073935
cycle= 5 E= -128.532595321548  delta_E= -5.5e-10  |g|= 6.67e-06  |ddm|= 5.06e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59833486362155  E_coul = 54.065739542073935
  HOMO = -0.845531062719426  LUMO = 0.849166906456369
  mo_energy =
[-3.27695840e+01 -1.92725074e+00 -8.45531063e-01 -8.45531063e-01
 -8.45531063e-01  8.49166906e-01  1.08819236e+00  1.08819236e+00
  1.08819236e+00  4.87829385e+00  5.68201960e+00  5.68201960e+00
  5.68201960e+00  1.87609756e+01  2.40193185e+01  2.40193185e+01
  2.40193185e+01  6.08399713e+01  1.18714498e+02  1.18714498e+02
  1.18714498e+02  1.81920165e+02  5.57660126e+02  1.92540505e+03
  8.04947843e+03  4.78088109e+04]
E1 = -182.59831741386265  E_coul = 54.06572209231238
Extra cycle  E= -128.53259532155  delta_E= -2.67e-12  |g|= 2.44e-06  |ddm|= 2.36e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1388.0003581215444
E1 = -182.59831741386265  E_coul = 54.06572209231238
init E= -128.53259532155
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845532283704182  LUMO = 0.849166633923362
  mo_energy =
[-3.27695879e+01 -1.92725190e+00 -8.45532284e-01 -8.45532284e-01
 -8.45532284e-01  8.49166634e-01  1.08819194e+00  1.08819194e+00
  1.08819194e+00  4.87829288e+00  5.68201811e+00  5.68201811e+00
  5.68201811e+00  1.87609735e+01  2.40193157e+01  2.40193157e+01
  2.40193157e+01  6.08399681e+01  1.18714494e+02  1.18714494e+02
  1.18714494e+02  1.81920161e+02  5.57660121e+02  1.92540504e+03
  8.04947843e+03  4.78088109e+04]
E1 = -182.59832682252284  E_coul = 54.065731500971935
cycle= 1 E= -128.532595321551  delta_E= -6.25e-13  |g|= 1.29e-06  |ddm|= 9.36e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59832682252284  E_coul = 54.065731500971935
  HOMO = -0.845531622457805  LUMO = 0.849166834326912
  mo_energy =
[-3.27695859e+01 -1.92725118e+00 -8.45531622e-01 -8.45531622e-01
 -8.45531622e-01  8.49166834e-01  1.08819218e+00  1.08819218e+00
  1.08819218e+00  4.87829347e+00  5.68201892e+00  5.68201892e+00
  5.68201892e+00  1.87609746e+01  2.40193172e+01  2.40193172e+01
  2.40193172e+01  6.08399698e+01  1.18714496e+02  1.18714496e+02
  1.18714496e+02  1.81920163e+02  5.57660123e+02  1.92540504e+03
  8.04947843e+03  4.78088109e+04]
E1 = -182.59832214777865  E_coul = 54.065726826227845
Extra cycle  E= -128.532595321551  delta_E= 1.14e-13  |g|= 6.36e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.44955418e-01 2.44137942e+04 3.66144942e+03 8.33368897e+02
 2.34739898e+02 8.00420724e+01 1.34665093e+01 3.14158149e+01
 3.17335668e-01 2.17368776e+00 6.04958345e+00 3.68001702e+00
 1.24335161e+01 5.47112171e+01 3.29862642e-01 1.14265734e+00]
grad_E = [-2.12979902e-04  4.07625173e-09 -2.02664393e-07  3.32852889e-06
 -1.72926059e-05 -1.00602612e-05 -3.67451760e-05  1.77069750e-05
  1.78963645e-04  7.20829727e-05  3.21286775e-05 -8.91932250e-06
 -8.16377680e-07 -1.42007391e-07 -1.42809538e-04  9.49672431e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.84411146735        1
[INPUT] 0    0    [1    /1   ]  24413.7942249        1
[INPUT] 0    0    [1    /1   ]  3661.44947927        1
[INPUT] 0    0    [1    /1   ]  833.367709605        1
[INPUT] 0    0    [1    /1   ]  234.750928689        1
[INPUT] 0    0    [1    /1   ]  80.0091704293        1
[INPUT] 0    0    [1    /1   ]  13.392086445         1
[INPUT] 0    0    [1    /1   ]  31.3614606809        1
[INPUT] 0    0    [1    /1   ]  0.317604141588       1
[INPUT] 0    0    [1    /1   ]  2.16294425856        1
[INPUT] 0    0    [1    /1   ]  5.93333024832        1
[INPUT] 1    0    [1    /1   ]  3.68013930336        1
[INPUT] 1    0    [1    /1   ]  12.4347036231        1
[INPUT] 1    0    [1    /1   ]  54.7120097254        1
[INPUT] 1    0    [1    /1   ]  0.329855905676       1
[INPUT] 1    0    [1    /1   ]  1.14260832036        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8441114673502466, 1.0]], [0, [24413.794224898782, 1.0]], [0, [3661.449479269488, 1.0]], [0, [833.3677096054528, 1.0]], [0, [234.75092868915178, 1.0]], [0, [80.00917042932082, 1.0]], [0, [13.39208644502023, 1.0]], [0, [31.361460680907967, 1.0]], [0, [0.31760414158789485, 1.0]], [0, [2.1629442585608056, 1.0]], [0, [5.9333302483170645, 1.0]], [1, [3.680139303358199, 1.0]], [1, [12.434703623118734, 1.0]], [1, [54.71200972543707, 1.0]], [1, [0.32985590567622836, 1.0]], [1, [1.1426083203641453, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84411147]
bas 1, expnt(s) = [24413.7942249]
bas 2, expnt(s) = [3661.44947927]
bas 3, expnt(s) = [833.36770961]
bas 4, expnt(s) = [234.75092869]
bas 5, expnt(s) = [80.00917043]
bas 6, expnt(s) = [13.39208645]
bas 7, expnt(s) = [31.36146068]
bas 8, expnt(s) = [0.31760414]
bas 9, expnt(s) = [2.16294426]
bas 10, expnt(s) = [5.93333025]
bas 11, expnt(s) = [3.6801393]
bas 12, expnt(s) = [12.43470362]
bas 13, expnt(s) = [54.71200973]
bas 14, expnt(s) = [0.32985591]
bas 15, expnt(s) = [1.14260832]
CPU time:       372.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.44111467e-01 2.22492243e+00 2.44137942e+04 4.93448103e+03
 3.66144948e+03 1.18919975e+03 8.33367710e+02 3.91870459e+02
 2.34750929e+02 1.51520193e+02 8.00091704e+01 6.75880396e+01
 1.33920864e+01 1.76868791e+01 3.13614607e+01 3.34820650e+01
 3.17604142e-01 1.06888170e+00 2.16294426e+00 4.50608126e+00
 5.93333025e+00 9.60481304e+00 3.68013930e+00 1.48701283e+01
 1.24347036e+01 6.81206355e+01 5.47120097e+01 4.34097943e+02
 3.29855906e-01 7.29272308e-01 1.14260832e+00 3.44632413e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998496850022942
cond(S) = 1357.8117920368354
E1 = -183.5780517135843  E_coul = 55.078500617279985
init E= -128.499551096304
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943942792382  LUMO = 0.868736358048078
  mo_energy =
[-3.25555294e+01 -1.85290593e+00 -7.73943943e-01 -7.73943943e-01
 -7.73943943e-01  8.68736358e-01  1.11390504e+00  1.11390504e+00
  1.11390504e+00  4.91819529e+00  5.76909907e+00  5.76909907e+00
  5.76909907e+00  1.86806888e+01  2.41784433e+01  2.41784433e+01
  2.41784433e+01  6.04495806e+01  1.18935944e+02  1.18935944e+02
  1.18935944e+02  1.81251857e+02  5.56875469e+02  1.92467826e+03
  8.04888385e+03  4.78083856e+04]
E1 = -182.11103525184564  E_coul = 53.58179257539922
cycle= 1 E= -128.529242676446  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460821
diis-c [-0.2123558  1.       ]
  HOMO = -0.879631185466307  LUMO = 0.838768758716141
  mo_energy =
[-3.28741615e+01 -1.96319302e+00 -8.79631185e-01 -8.79631185e-01
 -8.79631185e-01  8.38768759e-01  1.07574135e+00  1.07574135e+00
  1.07574135e+00  4.82641692e+00  5.64026183e+00  5.64026183e+00
  5.64026183e+00  1.84988944e+01  2.39435527e+01  2.39435527e+01
  2.39435527e+01  6.01883732e+01  1.18615084e+02  1.18615084e+02
  1.18615084e+02  1.80935840e+02  5.56518622e+02  1.92428530e+03
  8.04846148e+03  4.78079443e+04]
E1 = -182.84327498919134  E_coul = 54.31152640501927
cycle= 2 E= -128.531748584172  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23041
diis-c [-0.00070922  0.33221165  0.66778835]
  HOMO = -0.845271873651494  LUMO = 0.84849153812609
  mo_energy =
[-3.27691448e+01 -1.92706926e+00 -8.45271874e-01 -8.45271874e-01
 -8.45271874e-01  8.48491538e-01  1.08821526e+00  1.08821526e+00
  1.08821526e+00  4.85610464e+00  5.68215297e+00  5.68215297e+00
  5.68215297e+00  1.85585827e+01  2.40210790e+01  2.40210790e+01
  2.40210790e+01  6.02748886e+01  1.18720115e+02  1.18720115e+02
  1.18720115e+02  1.81039593e+02  5.56632085e+02  1.92440402e+03
  8.04858270e+03  4.78080664e+04]
E1 = -182.59776479281942  E_coul = 54.06516853609554
cycle= 3 E= -128.532596256724  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000910885
diis-c [-1.42737973e-07 -2.21423373e-03 -8.35726408e-04  1.00304996e+00]
  HOMO = -0.845501969109313  LUMO = 0.848453285202149
  mo_energy =
[-3.27695402e+01 -1.92723420e+00 -8.45501969e-01 -8.45501969e-01
 -8.45501969e-01  8.48453285e-01  1.08816645e+00  1.08816645e+00
  1.08816645e+00  4.85596199e+00  5.68195484e+00  5.68195484e+00
  5.68195484e+00  1.85583256e+01  2.40207659e+01  2.40207659e+01
  2.40207659e+01  6.02745563e+01  1.18719707e+02  1.18719707e+02
  1.18719707e+02  1.81039192e+02  5.56631589e+02  1.92440341e+03
  8.04858201e+03  4.78080657e+04]
E1 = -182.5982266098019  E_coul = 54.06563033298117
cycle= 4 E= -128.532596276821  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135236
diis-c [-1.01913393e-09  3.18933310e-04  4.79757745e-04 -2.11863602e-01
  1.21106491e+00]
  HOMO = -0.845534646095288  LUMO = 0.848445803859397
  mo_energy =
[-3.27695942e+01 -1.92725433e+00 -8.45534646e-01 -8.45534646e-01
 -8.45534646e-01  8.48445804e-01  1.08815282e+00  1.08815282e+00
  1.08815282e+00  4.85593718e+00  5.68191864e+00  5.68191864e+00
  5.68191864e+00  1.85582836e+01  2.40207174e+01  2.40207174e+01
  2.40207174e+01  6.02745064e+01  1.18719653e+02  1.18719653e+02
  1.18719653e+02  1.81039137e+02  5.56631527e+02  1.92440334e+03
  8.04858193e+03  4.78080656e+04]
E1 = -182.59833417764457  E_coul = 54.06573790027205
cycle= 5 E= -128.532596277373  delta_E= -5.52e-10  |g|= 6.69e-06  |ddm|= 5.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59833417764457  E_coul = 54.06573790027205
  HOMO = -0.845530993268867  LUMO = 0.848447382335764
  mo_energy =
[-3.27695863e+01 -1.92724995e+00 -8.45530993e-01 -8.45530993e-01
 -8.45530993e-01  8.48447382e-01  1.08815435e+00  1.08815435e+00
  1.08815435e+00  4.85594094e+00  5.68192308e+00  5.68192308e+00
  5.68192308e+00  1.85582896e+01  2.40207242e+01  2.40207242e+01
  2.40207242e+01  6.02745137e+01  1.18719660e+02  1.18719660e+02
  1.18719660e+02  1.81039144e+02  5.56631535e+02  1.92440335e+03
  8.04858194e+03  4.78080656e+04]
E1 = -182.59831668191146  E_coul = 54.06572040453609
Extra cycle  E= -128.532596277375  delta_E= -2.84e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.44111467e-01 2.44137942e+04 3.66144948e+03 8.33367710e+02
 2.34750929e+02 8.00091704e+01 1.33920864e+01 3.13614607e+01
 3.17604142e-01 2.16294426e+00 5.93333025e+00 3.68013930e+00
 1.24347036e+01 5.47120097e+01 3.29855906e-01 1.14260832e+00]
E = -128.53259627737538
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.84411146735        1
[INPUT] 0    0    [1    /1   ]  24413.7942249        1
[INPUT] 0    0    [1    /1   ]  3661.44947927        1
[INPUT] 0    0    [1    /1   ]  833.367709605        1
[INPUT] 0    0    [1    /1   ]  234.750928689        1
[INPUT] 0    0    [1    /1   ]  80.0091704293        1
[INPUT] 0    0    [1    /1   ]  13.392086445         1
[INPUT] 0    0    [1    /1   ]  31.3614606809        1
[INPUT] 0    0    [1    /1   ]  0.317604141588       1
[INPUT] 0    0    [1    /1   ]  2.16294425856        1
[INPUT] 0    0    [1    /1   ]  5.93333024832        1
[INPUT] 1    0    [1    /1   ]  3.68013930336        1
[INPUT] 1    0    [1    /1   ]  12.4347036231        1
[INPUT] 1    0    [1    /1   ]  54.7120097254        1
[INPUT] 1    0    [1    /1   ]  0.329855905676       1
[INPUT] 1    0    [1    /1   ]  1.14260832036        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8441114673502466, 1.0]], [0, [24413.794224898782, 1.0]], [0, [3661.449479269488, 1.0]], [0, [833.3677096054528, 1.0]], [0, [234.75092868915178, 1.0]], [0, [80.00917042932082, 1.0]], [0, [13.39208644502023, 1.0]], [0, [31.361460680907967, 1.0]], [0, [0.31760414158789485, 1.0]], [0, [2.1629442585608056, 1.0]], [0, [5.9333302483170645, 1.0]], [1, [3.680139303358199, 1.0]], [1, [12.434703623118734, 1.0]], [1, [54.71200972543707, 1.0]], [1, [0.32985590567622836, 1.0]], [1, [1.1426083203641453, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84411147]
bas 1, expnt(s) = [24413.7942249]
bas 2, expnt(s) = [3661.44947927]
bas 3, expnt(s) = [833.36770961]
bas 4, expnt(s) = [234.75092869]
bas 5, expnt(s) = [80.00917043]
bas 6, expnt(s) = [13.39208645]
bas 7, expnt(s) = [31.36146068]
bas 8, expnt(s) = [0.31760414]
bas 9, expnt(s) = [2.16294426]
bas 10, expnt(s) = [5.93333025]
bas 11, expnt(s) = [3.6801393]
bas 12, expnt(s) = [12.43470362]
bas 13, expnt(s) = [54.71200973]
bas 14, expnt(s) = [0.32985591]
bas 15, expnt(s) = [1.14260832]
CPU time:       373.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.44111467e-01 2.22492243e+00 2.44137942e+04 4.93448103e+03
 3.66144948e+03 1.18919975e+03 8.33367710e+02 3.91870459e+02
 2.34750929e+02 1.51520193e+02 8.00091704e+01 6.75880396e+01
 1.33920864e+01 1.76868791e+01 3.13614607e+01 3.34820650e+01
 3.17604142e-01 1.06888170e+00 2.16294426e+00 4.50608126e+00
 5.93333025e+00 9.60481304e+00 3.68013930e+00 1.48701283e+01
 1.24347036e+01 6.81206355e+01 5.47120097e+01 4.34097943e+02
 3.29855906e-01 7.29272308e-01 1.14260832e+00 3.44632413e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998496850022942
cond(S) = 1357.8117920368354
E1 = -183.5780517135843  E_coul = 55.078500617279985
init E= -128.499551096304
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943942792382  LUMO = 0.868736358048078
  mo_energy =
[-3.25555294e+01 -1.85290593e+00 -7.73943943e-01 -7.73943943e-01
 -7.73943943e-01  8.68736358e-01  1.11390504e+00  1.11390504e+00
  1.11390504e+00  4.91819529e+00  5.76909907e+00  5.76909907e+00
  5.76909907e+00  1.86806888e+01  2.41784433e+01  2.41784433e+01
  2.41784433e+01  6.04495806e+01  1.18935944e+02  1.18935944e+02
  1.18935944e+02  1.81251857e+02  5.56875469e+02  1.92467826e+03
  8.04888385e+03  4.78083856e+04]
E1 = -182.11103525184564  E_coul = 53.58179257539922
cycle= 1 E= -128.529242676446  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460821
diis-c [-0.2123558  1.       ]
  HOMO = -0.879631185466307  LUMO = 0.838768758716141
  mo_energy =
[-3.28741615e+01 -1.96319302e+00 -8.79631185e-01 -8.79631185e-01
 -8.79631185e-01  8.38768759e-01  1.07574135e+00  1.07574135e+00
  1.07574135e+00  4.82641692e+00  5.64026183e+00  5.64026183e+00
  5.64026183e+00  1.84988944e+01  2.39435527e+01  2.39435527e+01
  2.39435527e+01  6.01883732e+01  1.18615084e+02  1.18615084e+02
  1.18615084e+02  1.80935840e+02  5.56518622e+02  1.92428530e+03
  8.04846148e+03  4.78079443e+04]
E1 = -182.84327498919134  E_coul = 54.31152640501927
cycle= 2 E= -128.531748584172  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.23041
diis-c [-0.00070922  0.33221165  0.66778835]
  HOMO = -0.845271873651494  LUMO = 0.84849153812609
  mo_energy =
[-3.27691448e+01 -1.92706926e+00 -8.45271874e-01 -8.45271874e-01
 -8.45271874e-01  8.48491538e-01  1.08821526e+00  1.08821526e+00
  1.08821526e+00  4.85610464e+00  5.68215297e+00  5.68215297e+00
  5.68215297e+00  1.85585827e+01  2.40210790e+01  2.40210790e+01
  2.40210790e+01  6.02748886e+01  1.18720115e+02  1.18720115e+02
  1.18720115e+02  1.81039593e+02  5.56632085e+02  1.92440402e+03
  8.04858270e+03  4.78080664e+04]
E1 = -182.59776479281942  E_coul = 54.06516853609554
cycle= 3 E= -128.532596256724  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000910885
diis-c [-1.42737973e-07 -2.21423373e-03 -8.35726408e-04  1.00304996e+00]
  HOMO = -0.845501969109313  LUMO = 0.848453285202149
  mo_energy =
[-3.27695402e+01 -1.92723420e+00 -8.45501969e-01 -8.45501969e-01
 -8.45501969e-01  8.48453285e-01  1.08816645e+00  1.08816645e+00
  1.08816645e+00  4.85596199e+00  5.68195484e+00  5.68195484e+00
  5.68195484e+00  1.85583256e+01  2.40207659e+01  2.40207659e+01
  2.40207659e+01  6.02745563e+01  1.18719707e+02  1.18719707e+02
  1.18719707e+02  1.81039192e+02  5.56631589e+02  1.92440341e+03
  8.04858201e+03  4.78080657e+04]
E1 = -182.5982266098019  E_coul = 54.06563033298117
cycle= 4 E= -128.532596276821  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135236
diis-c [-1.01913393e-09  3.18933310e-04  4.79757745e-04 -2.11863602e-01
  1.21106491e+00]
  HOMO = -0.845534646095288  LUMO = 0.848445803859397
  mo_energy =
[-3.27695942e+01 -1.92725433e+00 -8.45534646e-01 -8.45534646e-01
 -8.45534646e-01  8.48445804e-01  1.08815282e+00  1.08815282e+00
  1.08815282e+00  4.85593718e+00  5.68191864e+00  5.68191864e+00
  5.68191864e+00  1.85582836e+01  2.40207174e+01  2.40207174e+01
  2.40207174e+01  6.02745064e+01  1.18719653e+02  1.18719653e+02
  1.18719653e+02  1.81039137e+02  5.56631527e+02  1.92440334e+03
  8.04858193e+03  4.78080656e+04]
E1 = -182.59833417764457  E_coul = 54.06573790027205
cycle= 5 E= -128.532596277373  delta_E= -5.52e-10  |g|= 6.69e-06  |ddm|= 5.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59833417764457  E_coul = 54.06573790027205
  HOMO = -0.845530993268867  LUMO = 0.848447382335764
  mo_energy =
[-3.27695863e+01 -1.92724995e+00 -8.45530993e-01 -8.45530993e-01
 -8.45530993e-01  8.48447382e-01  1.08815435e+00  1.08815435e+00
  1.08815435e+00  4.85594094e+00  5.68192308e+00  5.68192308e+00
  5.68192308e+00  1.85582896e+01  2.40207242e+01  2.40207242e+01
  2.40207242e+01  6.02745137e+01  1.18719660e+02  1.18719660e+02
  1.18719660e+02  1.81039144e+02  5.56631535e+02  1.92440335e+03
  8.04858194e+03  4.78080656e+04]
E1 = -182.59831668191146  E_coul = 54.06572040453609
Extra cycle  E= -128.532596277375  delta_E= -2.84e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1357.8117920368354
E1 = -182.59831668191146  E_coul = 54.06572040453609
init E= -128.532596277375
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.845532217312585  LUMO = 0.848447109662839
  mo_energy =
[-3.27695902e+01 -1.92725112e+00 -8.45532217e-01 -8.45532217e-01
 -8.45532217e-01  8.48447110e-01  1.08815392e+00  1.08815392e+00
  1.08815392e+00  4.85593996e+00  5.68192159e+00  5.68192159e+00
  5.68192159e+00  1.85582875e+01  2.40207214e+01  2.40207214e+01
  2.40207214e+01  6.02745105e+01  1.18719656e+02  1.18719656e+02
  1.18719656e+02  1.81039141e+02  5.56631531e+02  1.92440334e+03
  8.04858194e+03  4.78080656e+04]
E1 = -182.5983261168826  E_coul = 54.065729839506815
cycle= 1 E= -128.532596277376  delta_E= -3.98e-13  |g|= 1.29e-06  |ddm|= 9.38e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5983261168826  E_coul = 54.065729839506815
  HOMO = -0.845531554185463  LUMO = 0.848447310207022
  mo_energy =
[-3.27695882e+01 -1.92725040e+00 -8.45531554e-01 -8.45531554e-01
 -8.45531554e-01  8.48447310e-01  1.08815417e+00  1.08815417e+00
  1.08815417e+00  4.85594055e+00  5.68192240e+00  5.68192240e+00
  5.68192240e+00  1.85582887e+01  2.40207229e+01  2.40207229e+01
  2.40207229e+01  6.02745122e+01  1.18719658e+02  1.18719658e+02
  1.18719658e+02  1.81039143e+02  5.56631533e+02  1.92440335e+03
  8.04858194e+03  4.78080656e+04]
E1 = -182.59832142926695  E_coul = 54.06572515189103
Extra cycle  E= -128.532596277376  delta_E= -1.42e-13  |g|= 6.38e-07  |ddm|= 4.6e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [8.44111467e-01 2.44137942e+04 3.66144948e+03 8.33367710e+02
 2.34750929e+02 8.00091704e+01 1.33920864e+01 3.13614607e+01
 3.17604142e-01 2.16294426e+00 5.93333025e+00 3.68013930e+00
 1.24347036e+01 5.47120097e+01 3.29855906e-01 1.14260832e+00]
grad_E = [ 3.53436511e-05  4.10074638e-09 -2.04007709e-07  3.36274042e-06
 -1.78315613e-05 -6.01426259e-06  8.11770155e-07  1.78842019e-06
 -2.95247402e-05 -9.87147606e-06 -4.48940308e-06  1.92359412e-07
  2.18064085e-06 -4.83122247e-07 -4.04612609e-05  2.21276795e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843856720234       1
[INPUT] 0    0    [1    /1   ]  24413.7942255        1
[INPUT] 0    0    [1    /1   ]  3661.44944634        1
[INPUT] 0    0    [1    /1   ]  833.368340907        1
[INPUT] 0    0    [1    /1   ]  234.744566085        1
[INPUT] 0    0    [1    /1   ]  80.0341469405        1
[INPUT] 0    0    [1    /1   ]  13.4041752946        1
[INPUT] 0    0    [1    /1   ]  31.3682856065        1
[INPUT] 0    0    [1    /1   ]  0.317469279974       1
[INPUT] 0    0    [1    /1   ]  2.1637136144         1
[INPUT] 0    0    [1    /1   ]  5.9547025523         1
[INPUT] 1    0    [1    /1   ]  3.67958798799        1
[INPUT] 1    0    [1    /1   ]  12.4332279671        1
[INPUT] 1    0    [1    /1   ]  54.7119057557        1
[INPUT] 1    0    [1    /1   ]  0.329823516153       1
[INPUT] 1    0    [1    /1   ]  1.14243708053        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8438567202344687, 1.0]], [0, [24413.794225526814, 1.0]], [0, [3661.449446342068, 1.0]], [0, [833.3683409068415, 1.0]], [0, [234.7445660846894, 1.0]], [0, [80.03414694048979, 1.0]], [0, [13.404175294571813, 1.0]], [0, [31.36828560652919, 1.0]], [0, [0.31746927997448837, 1.0]], [0, [2.163713614401605, 1.0]], [0, [5.954702552296424, 1.0]], [1, [3.679587987989846, 1.0]], [1, [12.433227967123665, 1.0]], [1, [54.711905755663395, 1.0]], [1, [0.32982351615265876, 1.0]], [1, [1.1424370805349398, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84385672]
bas 1, expnt(s) = [24413.79422553]
bas 2, expnt(s) = [3661.44944634]
bas 3, expnt(s) = [833.36834091]
bas 4, expnt(s) = [234.74456608]
bas 5, expnt(s) = [80.03414694]
bas 6, expnt(s) = [13.40417529]
bas 7, expnt(s) = [31.36828561]
bas 8, expnt(s) = [0.31746928]
bas 9, expnt(s) = [2.16371361]
bas 10, expnt(s) = [5.95470255]
bas 11, expnt(s) = [3.67958799]
bas 12, expnt(s) = [12.43322797]
bas 13, expnt(s) = [54.71190576]
bas 14, expnt(s) = [0.32982352]
bas 15, expnt(s) = [1.14243708]
CPU time:       376.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43856720e-01 2.22441881e+00 2.44137942e+04 4.93448103e+03
 3.66144945e+03 1.18919974e+03 8.33368341e+02 3.91870682e+02
 2.34744566e+02 1.51517112e+02 8.00341469e+01 6.76038632e+01
 1.34041753e+01 1.76988520e+01 3.13682856e+01 3.34875297e+01
 3.17469280e-01 1.06854128e+00 2.16371361e+00 4.50728332e+00
 5.95470255e+00 9.63074932e+00 3.67958799e+00 1.48673438e+01
 1.24332280e+01 6.81105306e+01 5.47119058e+01 4.34096911e+02
 3.29823516e-01 7.29182797e-01 1.14243708e+00 3.44567852e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497773113812
cond(S) = 1362.1550403284748
E1 = -183.57804898079814  E_coul = 55.078500794712134
init E= -128.499548186086
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943991167489  LUMO = 0.868451359908867
  mo_energy =
[-3.25555295e+01 -1.85290593e+00 -7.73943991e-01 -7.73943991e-01
 -7.73943991e-01  8.68451360e-01  1.11375116e+00  1.11375116e+00
  1.11375116e+00  4.91971449e+00  5.76816698e+00  5.76816698e+00
  5.76816698e+00  1.87119161e+01  2.41746140e+01  2.41746140e+01
  2.41746140e+01  6.05430084e+01  1.18929004e+02  1.18929004e+02
  1.18929004e+02  1.81407945e+02  5.57084422e+02  1.92489475e+03
  8.04907965e+03  4.78085487e+04]
E1 = -182.1109947540956  E_coul = 53.58175222839324
cycle= 1 E= -128.529242525702  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460813
diis-c [-0.21234828  1.        ]
  HOMO = -0.87963408332241  LUMO = 0.838487532237559
  mo_energy =
[-3.28741696e+01 -1.96319643e+00 -8.79634083e-01 -8.79634083e-01
 -8.79634083e-01  8.38487532e-01  1.07559319e+00  1.07559319e+00
  1.07559319e+00  4.82785738e+00  5.63933947e+00  5.63933947e+00
  5.63933947e+00  1.85299227e+01  2.39397267e+01  2.39397267e+01
  2.39397267e+01  6.02817164e+01  1.18608137e+02  1.18608137e+02
  1.18608137e+02  1.81091906e+02  5.56727566e+02  1.92450178e+03
  8.04865727e+03  4.78081074e+04]
E1 = -182.8432678320196  E_coul = 54.31151925307576
cycle= 2 E= -128.531748578944  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230412
diis-c [-0.00070963  0.33221645  0.66778355]
  HOMO = -0.845273342546142  LUMO = 0.848209273940686
  mo_energy =
[-3.27691494e+01 -1.92707115e+00 -8.45273343e-01 -8.45273343e-01
 -8.45273343e-01  8.48209274e-01  1.08806552e+00  1.08806552e+00
  1.08806552e+00  4.85757151e+00  5.68122786e+00  5.68122786e+00
  5.68122786e+00  1.85896789e+01  2.40172526e+01  2.40172526e+01
  2.40172526e+01  6.03682608e+01  1.18713171e+02  1.18713171e+02
  1.18713171e+02  1.81195666e+02  5.56841033e+02  1.92462051e+03
  8.04877849e+03  4.78082296e+04]
E1 = -182.5977472195111  E_coul = 54.065150895967406
cycle= 3 E= -128.532596323544  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00090986
diis-c [-1.42613395e-07 -2.21350763e-03 -8.38837938e-04  1.00305235e+00]
  HOMO = -0.845503190392891  LUMO = 0.848171125394381
  mo_energy =
[-3.27695443e+01 -1.92723584e+00 -8.45503190e-01 -8.45503190e-01
 -8.45503190e-01  8.48171125e-01  1.08801685e+00  1.08801685e+00
  1.08801685e+00  4.85742901e+00  5.68103004e+00  5.68103004e+00
  5.68103004e+00  1.85894221e+01  2.40169399e+01  2.40169399e+01
  2.40169399e+01  6.03679289e+01  1.18712764e+02  1.18712764e+02
  1.18712764e+02  1.81195266e+02  5.56840537e+02  1.92461990e+03
  8.04877780e+03  4.78082288e+04]
E1 = -182.59820803740115  E_coul = 54.06561169380144
cycle= 4 E= -128.5325963436  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135225
diis-c [-1.01856068e-09  3.18795440e-04  4.80523743e-04 -2.11854043e-01
  1.21105472e+00]
  HOMO = -0.845535854799165  LUMO = 0.848163650212253
  mo_energy =
[-3.27695983e+01 -1.92725597e+00 -8.45535855e-01 -8.45535855e-01
 -8.45535855e-01  8.48163650e-01  1.08800322e+00  1.08800322e+00
  1.08800322e+00  4.85740420e+00  5.68099386e+00  5.68099386e+00
  5.68099386e+00  1.85893801e+01  2.40168914e+01  2.40168914e+01
  2.40168914e+01  6.03678790e+01  1.18712709e+02  1.18712709e+02
  1.18712709e+02  1.81195211e+02  5.56840476e+02  1.92461983e+03
  8.04877773e+03  4.78082288e+04]
E1 = -182.5983156154476  E_coul = 54.06571927129645
cycle= 5 E= -128.532596344151  delta_E= -5.51e-10  |g|= 6.68e-06  |ddm|= 5.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983156154476  E_coul = 54.06571927129645
  HOMO = -0.84553220418756  LUMO = 0.848165227624044
  mo_energy =
[-3.27695903e+01 -1.92725159e+00 -8.45532204e-01 -8.45532204e-01
 -8.45532204e-01  8.48165228e-01  1.08800475e+00  1.08800475e+00
  1.08800475e+00  4.85740796e+00  5.68099829e+00  5.68099829e+00
  5.68099829e+00  1.85893861e+01  2.40168982e+01  2.40168982e+01
  2.40168982e+01  6.03678863e+01  1.18712717e+02  1.18712717e+02
  1.18712717e+02  1.81195219e+02  5.56840483e+02  1.92461984e+03
  8.04877773e+03  4.78082288e+04]
E1 = -182.59829812783778  E_coul = 54.06570178368378
Extra cycle  E= -128.532596344154  delta_E= -2.84e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [8.43856720e-01 2.44137942e+04 3.66144945e+03 8.33368341e+02
 2.34744566e+02 8.00341469e+01 1.34041753e+01 3.13682856e+01
 3.17469280e-01 2.16371361e+00 5.95470255e+00 3.67958799e+00
 1.24332280e+01 5.47119058e+01 3.29823516e-01 1.14243708e+00]
E = -128.532596344154
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843856720234       1
[INPUT] 0    0    [1    /1   ]  24413.7942255        1
[INPUT] 0    0    [1    /1   ]  3661.44944634        1
[INPUT] 0    0    [1    /1   ]  833.368340907        1
[INPUT] 0    0    [1    /1   ]  234.744566085        1
[INPUT] 0    0    [1    /1   ]  80.0341469405        1
[INPUT] 0    0    [1    /1   ]  13.4041752946        1
[INPUT] 0    0    [1    /1   ]  31.3682856065        1
[INPUT] 0    0    [1    /1   ]  0.317469279974       1
[INPUT] 0    0    [1    /1   ]  2.1637136144         1
[INPUT] 0    0    [1    /1   ]  5.9547025523         1
[INPUT] 1    0    [1    /1   ]  3.67958798799        1
[INPUT] 1    0    [1    /1   ]  12.4332279671        1
[INPUT] 1    0    [1    /1   ]  54.7119057557        1
[INPUT] 1    0    [1    /1   ]  0.329823516153       1
[INPUT] 1    0    [1    /1   ]  1.14243708053        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8438567202344687, 1.0]], [0, [24413.794225526814, 1.0]], [0, [3661.449446342068, 1.0]], [0, [833.3683409068415, 1.0]], [0, [234.7445660846894, 1.0]], [0, [80.03414694048979, 1.0]], [0, [13.404175294571813, 1.0]], [0, [31.36828560652919, 1.0]], [0, [0.31746927997448837, 1.0]], [0, [2.163713614401605, 1.0]], [0, [5.954702552296424, 1.0]], [1, [3.679587987989846, 1.0]], [1, [12.433227967123665, 1.0]], [1, [54.711905755663395, 1.0]], [1, [0.32982351615265876, 1.0]], [1, [1.1424370805349398, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84385672]
bas 1, expnt(s) = [24413.79422553]
bas 2, expnt(s) = [3661.44944634]
bas 3, expnt(s) = [833.36834091]
bas 4, expnt(s) = [234.74456608]
bas 5, expnt(s) = [80.03414694]
bas 6, expnt(s) = [13.40417529]
bas 7, expnt(s) = [31.36828561]
bas 8, expnt(s) = [0.31746928]
bas 9, expnt(s) = [2.16371361]
bas 10, expnt(s) = [5.95470255]
bas 11, expnt(s) = [3.67958799]
bas 12, expnt(s) = [12.43322797]
bas 13, expnt(s) = [54.71190576]
bas 14, expnt(s) = [0.32982352]
bas 15, expnt(s) = [1.14243708]
CPU time:       378.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43856720e-01 2.22441881e+00 2.44137942e+04 4.93448103e+03
 3.66144945e+03 1.18919974e+03 8.33368341e+02 3.91870682e+02
 2.34744566e+02 1.51517112e+02 8.00341469e+01 6.76038632e+01
 1.34041753e+01 1.76988520e+01 3.13682856e+01 3.34875297e+01
 3.17469280e-01 1.06854128e+00 2.16371361e+00 4.50728332e+00
 5.95470255e+00 9.63074932e+00 3.67958799e+00 1.48673438e+01
 1.24332280e+01 6.81105306e+01 5.47119058e+01 4.34096911e+02
 3.29823516e-01 7.29182797e-01 1.14243708e+00 3.44567852e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497773113812
cond(S) = 1362.1550403284748
E1 = -183.57804898079814  E_coul = 55.078500794712134
init E= -128.499548186086
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943991167489  LUMO = 0.868451359908867
  mo_energy =
[-3.25555295e+01 -1.85290593e+00 -7.73943991e-01 -7.73943991e-01
 -7.73943991e-01  8.68451360e-01  1.11375116e+00  1.11375116e+00
  1.11375116e+00  4.91971449e+00  5.76816698e+00  5.76816698e+00
  5.76816698e+00  1.87119161e+01  2.41746140e+01  2.41746140e+01
  2.41746140e+01  6.05430084e+01  1.18929004e+02  1.18929004e+02
  1.18929004e+02  1.81407945e+02  5.57084422e+02  1.92489475e+03
  8.04907965e+03  4.78085487e+04]
E1 = -182.1109947540956  E_coul = 53.58175222839324
cycle= 1 E= -128.529242525702  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460813
diis-c [-0.21234828  1.        ]
  HOMO = -0.87963408332241  LUMO = 0.838487532237559
  mo_energy =
[-3.28741696e+01 -1.96319643e+00 -8.79634083e-01 -8.79634083e-01
 -8.79634083e-01  8.38487532e-01  1.07559319e+00  1.07559319e+00
  1.07559319e+00  4.82785738e+00  5.63933947e+00  5.63933947e+00
  5.63933947e+00  1.85299227e+01  2.39397267e+01  2.39397267e+01
  2.39397267e+01  6.02817164e+01  1.18608137e+02  1.18608137e+02
  1.18608137e+02  1.81091906e+02  5.56727566e+02  1.92450178e+03
  8.04865727e+03  4.78081074e+04]
E1 = -182.8432678320196  E_coul = 54.31151925307576
cycle= 2 E= -128.531748578944  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230412
diis-c [-0.00070963  0.33221645  0.66778355]
  HOMO = -0.845273342546142  LUMO = 0.848209273940686
  mo_energy =
[-3.27691494e+01 -1.92707115e+00 -8.45273343e-01 -8.45273343e-01
 -8.45273343e-01  8.48209274e-01  1.08806552e+00  1.08806552e+00
  1.08806552e+00  4.85757151e+00  5.68122786e+00  5.68122786e+00
  5.68122786e+00  1.85896789e+01  2.40172526e+01  2.40172526e+01
  2.40172526e+01  6.03682608e+01  1.18713171e+02  1.18713171e+02
  1.18713171e+02  1.81195666e+02  5.56841033e+02  1.92462051e+03
  8.04877849e+03  4.78082296e+04]
E1 = -182.5977472195111  E_coul = 54.065150895967406
cycle= 3 E= -128.532596323544  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00090986
diis-c [-1.42613395e-07 -2.21350763e-03 -8.38837938e-04  1.00305235e+00]
  HOMO = -0.845503190392891  LUMO = 0.848171125394381
  mo_energy =
[-3.27695443e+01 -1.92723584e+00 -8.45503190e-01 -8.45503190e-01
 -8.45503190e-01  8.48171125e-01  1.08801685e+00  1.08801685e+00
  1.08801685e+00  4.85742901e+00  5.68103004e+00  5.68103004e+00
  5.68103004e+00  1.85894221e+01  2.40169399e+01  2.40169399e+01
  2.40169399e+01  6.03679289e+01  1.18712764e+02  1.18712764e+02
  1.18712764e+02  1.81195266e+02  5.56840537e+02  1.92461990e+03
  8.04877780e+03  4.78082288e+04]
E1 = -182.59820803740115  E_coul = 54.06561169380144
cycle= 4 E= -128.5325963436  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135225
diis-c [-1.01856068e-09  3.18795440e-04  4.80523743e-04 -2.11854043e-01
  1.21105472e+00]
  HOMO = -0.845535854799165  LUMO = 0.848163650212253
  mo_energy =
[-3.27695983e+01 -1.92725597e+00 -8.45535855e-01 -8.45535855e-01
 -8.45535855e-01  8.48163650e-01  1.08800322e+00  1.08800322e+00
  1.08800322e+00  4.85740420e+00  5.68099386e+00  5.68099386e+00
  5.68099386e+00  1.85893801e+01  2.40168914e+01  2.40168914e+01
  2.40168914e+01  6.03678790e+01  1.18712709e+02  1.18712709e+02
  1.18712709e+02  1.81195211e+02  5.56840476e+02  1.92461983e+03
  8.04877773e+03  4.78082288e+04]
E1 = -182.5983156154476  E_coul = 54.06571927129645
cycle= 5 E= -128.532596344151  delta_E= -5.51e-10  |g|= 6.68e-06  |ddm|= 5.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983156154476  E_coul = 54.06571927129645
  HOMO = -0.84553220418756  LUMO = 0.848165227624044
  mo_energy =
[-3.27695903e+01 -1.92725159e+00 -8.45532204e-01 -8.45532204e-01
 -8.45532204e-01  8.48165228e-01  1.08800475e+00  1.08800475e+00
  1.08800475e+00  4.85740796e+00  5.68099829e+00  5.68099829e+00
  5.68099829e+00  1.85893861e+01  2.40168982e+01  2.40168982e+01
  2.40168982e+01  6.03678863e+01  1.18712717e+02  1.18712717e+02
  1.18712717e+02  1.81195219e+02  5.56840483e+02  1.92461984e+03
  8.04877773e+03  4.78082288e+04]
E1 = -182.59829812783778  E_coul = 54.06570178368378
Extra cycle  E= -128.532596344154  delta_E= -2.84e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1362.1550403284748
E1 = -182.59829812783778  E_coul = 54.06570178368378
init E= -128.532596344154
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.845533427696487  LUMO = 0.848164955123468
  mo_energy =
[-3.27695942e+01 -1.92725276e+00 -8.45533428e-01 -8.45533428e-01
 -8.45533428e-01  8.48164955e-01  1.08800433e+00  1.08800433e+00
  1.08800433e+00  4.85740698e+00  5.68099680e+00  5.68099680e+00
  5.68099680e+00  1.85893840e+01  2.40168954e+01  2.40168954e+01
  2.40168954e+01  6.03678831e+01  1.18712713e+02  1.18712713e+02
  1.18712713e+02  1.81195215e+02  5.56840479e+02  1.92461983e+03
  8.04877773e+03  4.78082288e+04]
E1 = -182.59830755822327  E_coul = 54.0657112140688
cycle= 1 E= -128.532596344154  delta_E= -4.55e-13  |g|= 1.29e-06  |ddm|= 9.38e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59830755822327  E_coul = 54.0657112140688
  HOMO = -0.845532764895642  LUMO = 0.848165155543563
  mo_energy =
[-3.27695922e+01 -1.92725204e+00 -8.45532765e-01 -8.45532765e-01
 -8.45532765e-01  8.48165156e-01  1.08800457e+00  1.08800457e+00
  1.08800457e+00  4.85740757e+00  5.68099762e+00  5.68099762e+00
  5.68099762e+00  1.85893851e+01  2.40168969e+01  2.40168969e+01
  2.40168969e+01  6.03678848e+01  1.18712715e+02  1.18712715e+02
  1.18712715e+02  1.81195217e+02  5.56840481e+02  1.92461983e+03
  8.04877773e+03  4.78082288e+04]
E1 = -182.59830287282077  E_coul = 54.06570652866606
Extra cycle  E= -128.532596344155  delta_E= -2.56e-13  |g|= 6.38e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [8.43856720e-01 2.44137942e+04 3.66144945e+03 8.33368341e+02
 2.34744566e+02 8.00341469e+01 1.34041753e+01 3.13682856e+01
 3.17469280e-01 2.16371361e+00 5.95470255e+00 3.67958799e+00
 1.24332280e+01 5.47119058e+01 3.29823516e-01 1.14243708e+00]
grad_E = [-7.47446613e-06  4.16977773e-09 -2.07486010e-07  3.42724646e-06
 -1.83441524e-05 -4.41960931e-06 -1.36353384e-06  2.26811630e-07
  1.03972353e-05  2.85655437e-06 -6.93974581e-08  9.36280555e-07
  5.86445450e-07 -1.54527490e-07 -9.14072716e-06  1.63518853e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843926785124       1
[INPUT] 0    0    [1    /1   ]  24413.7942256        1
[INPUT] 0    0    [1    /1   ]  3661.4494409         1
[INPUT] 0    0    [1    /1   ]  833.368444503        1
[INPUT] 0    0    [1    /1   ]  234.743556724        1
[INPUT] 0    0    [1    /1   ]  80.0369190986        1
[INPUT] 0    0    [1    /1   ]  13.4160726853        1
[INPUT] 0    0    [1    /1   ]  31.3779206164        1
[INPUT] 0    0    [1    /1   ]  0.31747217111        1
[INPUT] 0    0    [1    /1   ]  2.16393136883        1
[INPUT] 0    0    [1    /1   ]  5.96416654549        1
[INPUT] 1    0    [1    /1   ]  3.67947983568        1
[INPUT] 1    0    [1    /1   ]  12.4328953679        1
[INPUT] 1    0    [1    /1   ]  54.7118326058        1
[INPUT] 1    0    [1    /1   ]  0.329819124803       1
[INPUT] 1    0    [1    /1   ]  1.14241054599        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8439267851243184, 1.0]], [0, [24413.794225630194, 1.0]], [0, [3661.449440903604, 1.0]], [0, [833.3684445027914, 1.0]], [0, [234.74355672443428, 1.0]], [0, [80.03691909860281, 1.0]], [0, [13.416072685303153, 1.0]], [0, [31.377920616386717, 1.0]], [0, [0.31747217110956394, 1.0]], [0, [2.163931368832054, 1.0]], [0, [5.964166545491134, 1.0]], [1, [3.679479835677556, 1.0]], [1, [12.432895367914703, 1.0]], [1, [54.71183260577447, 1.0]], [1, [0.32981912480288184, 1.0]], [1, [1.1424105459941363, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84392679]
bas 1, expnt(s) = [24413.79422563]
bas 2, expnt(s) = [3661.4494409]
bas 3, expnt(s) = [833.3684445]
bas 4, expnt(s) = [234.74355672]
bas 5, expnt(s) = [80.0369191]
bas 6, expnt(s) = [13.41607269]
bas 7, expnt(s) = [31.37792062]
bas 8, expnt(s) = [0.31747217]
bas 9, expnt(s) = [2.16393137]
bas 10, expnt(s) = [5.96416655]
bas 11, expnt(s) = [3.67947984]
bas 12, expnt(s) = [12.43289537]
bas 13, expnt(s) = [54.71183261]
bas 14, expnt(s) = [0.32981912]
bas 15, expnt(s) = [1.14241055]
CPU time:       381.74
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43926785e-01 2.22455733e+00 2.44137942e+04 4.93448103e+03
 3.66144944e+03 1.18919974e+03 8.33368445e+02 3.91870718e+02
 2.34743557e+02 1.51516624e+02 8.00369191e+01 6.76056194e+01
 1.34160727e+01 1.77106327e+01 3.13779206e+01 3.34952439e+01
 3.17472171e-01 1.06854858e+00 2.16393137e+00 4.50762352e+00
 5.96416655e+00 9.64222688e+00 3.67947984e+00 1.48667975e+01
 1.24328954e+01 6.81082531e+01 5.47118326e+01 4.34096186e+02
 3.29819125e-01 7.29170661e-01 1.14241055e+00 3.44557849e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497900186155
cond(S) = 1363.9867252278061
E1 = -183.57804900506628  E_coul = 55.07850078570228
init E= -128.499548219364
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943986668528  LUMO = 0.868557823314569
  mo_energy =
[-3.25555296e+01 -1.85290586e+00 -7.73943987e-01 -7.73943987e-01
 -7.73943987e-01  8.68557823e-01  1.11372922e+00  1.11372922e+00
  1.11372922e+00  4.92112590e+00  5.76801131e+00  5.76801131e+00
  5.76801131e+00  1.87282601e+01  2.41738479e+01  2.41738479e+01
  2.41738479e+01  6.05992569e+01  1.18927449e+02  1.18927449e+02
  1.18927449e+02  1.81507781e+02  5.57206148e+02  1.92501439e+03
  8.04918699e+03  4.78086380e+04]
E1 = -182.11098859113392  E_coul = 53.58174608603809
cycle= 1 E= -128.529242505096  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460801
diis-c [-0.21233787  1.        ]
  HOMO = -0.879634523860201  LUMO = 0.838588560358625
  mo_energy =
[-3.28741710e+01 -1.96319682e+00 -8.79634524e-01 -8.79634524e-01
 -8.79634524e-01  8.38588560e-01  1.07557201e+00  1.07557201e+00
  1.07557201e+00  4.82922893e+00  5.63918580e+00  5.63918580e+00
  5.63918580e+00  1.85461656e+01  2.39389618e+01  2.39389618e+01
  2.39389618e+01  6.03379105e+01  1.18606580e+02  1.18606580e+02
  1.18606580e+02  1.81191731e+02  5.56849292e+02  1.92462142e+03
  8.04876461e+03  4.78081967e+04]
E1 = -182.84326529666427  E_coul = 54.311516720695195
cycle= 2 E= -128.531748575969  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230407
diis-c [-0.00070984  0.33221677  0.66778323]
  HOMO = -0.845273620528274  LUMO = 0.848311993116595
  mo_energy =
[-3.27691503e+01 -1.92707136e+00 -8.45273621e-01 -8.45273621e-01
 -8.45273621e-01  8.48311993e-01  1.08804408e+00  1.08804408e+00
  1.08804408e+00  4.85895619e+00  5.68107356e+00  5.68107356e+00
  5.68107356e+00  1.86059560e+01  2.40164874e+01  2.40164874e+01
  2.40164874e+01  6.04244731e+01  1.18711614e+02  1.18711614e+02
  1.18711614e+02  1.81295495e+02  5.56962759e+02  1.92474015e+03
  8.04888583e+03  4.78083188e+04]
E1 = -182.59774324470507  E_coul = 54.06514691557623
cycle= 3 E= -128.532596329129  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000909846
diis-c [-1.42581483e-07 -2.21347318e-03 -8.38663907e-04  1.00305214e+00]
  HOMO = -0.84550346956261  LUMO = 0.848273836446514
  mo_energy =
[-3.27695452e+01 -1.92723605e+00 -8.45503470e-01 -8.45503470e-01
 -8.45503470e-01  8.48273836e-01  1.08799540e+00  1.08799540e+00
  1.08799540e+00  4.85881364e+00  5.68087574e+00  5.68087574e+00
  5.68087574e+00  1.86056991e+01  2.40161747e+01  2.40161747e+01
  2.40161747e+01  6.04241412e+01  1.18711208e+02  1.18711208e+02
  1.18711208e+02  1.81295094e+02  5.56962264e+02  1.92473954e+03
  8.04888514e+03  4.78083181e+04]
E1 = -182.59820401593433  E_coul = 54.0656076667484
cycle= 4 E= -128.532596349186  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135244
diis-c [-1.01849663e-09  3.18752045e-04  4.80638370e-04 -2.11837097e-01
  1.21103771e+00]
  HOMO = -0.845536137511148  LUMO = 0.848266358931329
  mo_energy =
[-3.27695992e+01 -1.92725618e+00 -8.45536138e-01 -8.45536138e-01
 -8.45536138e-01  8.48266359e-01  1.08798178e+00  1.08798178e+00
  1.08798178e+00  4.85878882e+00  5.68083955e+00  5.68083955e+00
  5.68083955e+00  1.86056571e+01  2.40161262e+01  2.40161262e+01
  2.40161262e+01  6.04240912e+01  1.18711153e+02  1.18711153e+02
  1.18711153e+02  1.81295039e+02  5.56962202e+02  1.92473947e+03
  8.04888506e+03  4.78083180e+04]
E1 = -182.5983116143897  E_coul = 54.065715264651985
cycle= 5 E= -128.532596349738  delta_E= -5.52e-10  |g|= 6.68e-06  |ddm|= 5.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983116143897  E_coul = 54.065715264651985
  HOMO = -0.845532487756914  LUMO = 0.848267936405853
  mo_energy =
[-3.27695913e+01 -1.92725180e+00 -8.45532488e-01 -8.45532488e-01
 -8.45532488e-01  8.48267936e-01  1.08798331e+00  1.08798331e+00
  1.08798331e+00  4.85879258e+00  5.68084399e+00  5.68084399e+00
  5.68084399e+00  1.86056631e+01  2.40161330e+01  2.40161330e+01
  2.40161330e+01  6.04240985e+01  1.18711161e+02  1.18711161e+02
  1.18711161e+02  1.81295047e+02  5.56962209e+02  1.92473948e+03
  8.04888507e+03  4.78083180e+04]
E1 = -182.59829413213046  E_coul = 54.06569778239
Extra cycle  E= -128.53259634974  delta_E= -2.73e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [8.43926785e-01 2.44137942e+04 3.66144944e+03 8.33368445e+02
 2.34743557e+02 8.00369191e+01 1.34160727e+01 3.13779206e+01
 3.17472171e-01 2.16393137e+00 5.96416655e+00 3.67947984e+00
 1.24328954e+01 5.47118326e+01 3.29819125e-01 1.14241055e+00]
E = -128.53259634974046
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843926785124       1
[INPUT] 0    0    [1    /1   ]  24413.7942256        1
[INPUT] 0    0    [1    /1   ]  3661.4494409         1
[INPUT] 0    0    [1    /1   ]  833.368444503        1
[INPUT] 0    0    [1    /1   ]  234.743556724        1
[INPUT] 0    0    [1    /1   ]  80.0369190986        1
[INPUT] 0    0    [1    /1   ]  13.4160726853        1
[INPUT] 0    0    [1    /1   ]  31.3779206164        1
[INPUT] 0    0    [1    /1   ]  0.31747217111        1
[INPUT] 0    0    [1    /1   ]  2.16393136883        1
[INPUT] 0    0    [1    /1   ]  5.96416654549        1
[INPUT] 1    0    [1    /1   ]  3.67947983568        1
[INPUT] 1    0    [1    /1   ]  12.4328953679        1
[INPUT] 1    0    [1    /1   ]  54.7118326058        1
[INPUT] 1    0    [1    /1   ]  0.329819124803       1
[INPUT] 1    0    [1    /1   ]  1.14241054599        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8439267851243184, 1.0]], [0, [24413.794225630194, 1.0]], [0, [3661.449440903604, 1.0]], [0, [833.3684445027914, 1.0]], [0, [234.74355672443428, 1.0]], [0, [80.03691909860281, 1.0]], [0, [13.416072685303153, 1.0]], [0, [31.377920616386717, 1.0]], [0, [0.31747217110956394, 1.0]], [0, [2.163931368832054, 1.0]], [0, [5.964166545491134, 1.0]], [1, [3.679479835677556, 1.0]], [1, [12.432895367914703, 1.0]], [1, [54.71183260577447, 1.0]], [1, [0.32981912480288184, 1.0]], [1, [1.1424105459941363, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84392679]
bas 1, expnt(s) = [24413.79422563]
bas 2, expnt(s) = [3661.4494409]
bas 3, expnt(s) = [833.3684445]
bas 4, expnt(s) = [234.74355672]
bas 5, expnt(s) = [80.0369191]
bas 6, expnt(s) = [13.41607269]
bas 7, expnt(s) = [31.37792062]
bas 8, expnt(s) = [0.31747217]
bas 9, expnt(s) = [2.16393137]
bas 10, expnt(s) = [5.96416655]
bas 11, expnt(s) = [3.67947984]
bas 12, expnt(s) = [12.43289537]
bas 13, expnt(s) = [54.71183261]
bas 14, expnt(s) = [0.32981912]
bas 15, expnt(s) = [1.14241055]
CPU time:       382.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43926785e-01 2.22455733e+00 2.44137942e+04 4.93448103e+03
 3.66144944e+03 1.18919974e+03 8.33368445e+02 3.91870718e+02
 2.34743557e+02 1.51516624e+02 8.00369191e+01 6.76056194e+01
 1.34160727e+01 1.77106327e+01 3.13779206e+01 3.34952439e+01
 3.17472171e-01 1.06854858e+00 2.16393137e+00 4.50762352e+00
 5.96416655e+00 9.64222688e+00 3.67947984e+00 1.48667975e+01
 1.24328954e+01 6.81082531e+01 5.47118326e+01 4.34096186e+02
 3.29819125e-01 7.29170661e-01 1.14241055e+00 3.44557849e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497900186155
cond(S) = 1363.9867252278061
E1 = -183.57804900506628  E_coul = 55.07850078570228
init E= -128.499548219364
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773943986668528  LUMO = 0.868557823314569
  mo_energy =
[-3.25555296e+01 -1.85290586e+00 -7.73943987e-01 -7.73943987e-01
 -7.73943987e-01  8.68557823e-01  1.11372922e+00  1.11372922e+00
  1.11372922e+00  4.92112590e+00  5.76801131e+00  5.76801131e+00
  5.76801131e+00  1.87282601e+01  2.41738479e+01  2.41738479e+01
  2.41738479e+01  6.05992569e+01  1.18927449e+02  1.18927449e+02
  1.18927449e+02  1.81507781e+02  5.57206148e+02  1.92501439e+03
  8.04918699e+03  4.78086380e+04]
E1 = -182.11098859113392  E_coul = 53.58174608603809
cycle= 1 E= -128.529242505096  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460801
diis-c [-0.21233787  1.        ]
  HOMO = -0.879634523860201  LUMO = 0.838588560358625
  mo_energy =
[-3.28741710e+01 -1.96319682e+00 -8.79634524e-01 -8.79634524e-01
 -8.79634524e-01  8.38588560e-01  1.07557201e+00  1.07557201e+00
  1.07557201e+00  4.82922893e+00  5.63918580e+00  5.63918580e+00
  5.63918580e+00  1.85461656e+01  2.39389618e+01  2.39389618e+01
  2.39389618e+01  6.03379105e+01  1.18606580e+02  1.18606580e+02
  1.18606580e+02  1.81191731e+02  5.56849292e+02  1.92462142e+03
  8.04876461e+03  4.78081967e+04]
E1 = -182.84326529666427  E_coul = 54.311516720695195
cycle= 2 E= -128.531748575969  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230407
diis-c [-0.00070984  0.33221677  0.66778323]
  HOMO = -0.845273620528274  LUMO = 0.848311993116595
  mo_energy =
[-3.27691503e+01 -1.92707136e+00 -8.45273621e-01 -8.45273621e-01
 -8.45273621e-01  8.48311993e-01  1.08804408e+00  1.08804408e+00
  1.08804408e+00  4.85895619e+00  5.68107356e+00  5.68107356e+00
  5.68107356e+00  1.86059560e+01  2.40164874e+01  2.40164874e+01
  2.40164874e+01  6.04244731e+01  1.18711614e+02  1.18711614e+02
  1.18711614e+02  1.81295495e+02  5.56962759e+02  1.92474015e+03
  8.04888583e+03  4.78083188e+04]
E1 = -182.59774324470507  E_coul = 54.06514691557623
cycle= 3 E= -128.532596329129  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000909846
diis-c [-1.42581483e-07 -2.21347318e-03 -8.38663907e-04  1.00305214e+00]
  HOMO = -0.84550346956261  LUMO = 0.848273836446514
  mo_energy =
[-3.27695452e+01 -1.92723605e+00 -8.45503470e-01 -8.45503470e-01
 -8.45503470e-01  8.48273836e-01  1.08799540e+00  1.08799540e+00
  1.08799540e+00  4.85881364e+00  5.68087574e+00  5.68087574e+00
  5.68087574e+00  1.86056991e+01  2.40161747e+01  2.40161747e+01
  2.40161747e+01  6.04241412e+01  1.18711208e+02  1.18711208e+02
  1.18711208e+02  1.81295094e+02  5.56962264e+02  1.92473954e+03
  8.04888514e+03  4.78083181e+04]
E1 = -182.59820401593433  E_coul = 54.0656076667484
cycle= 4 E= -128.532596349186  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135244
diis-c [-1.01849663e-09  3.18752045e-04  4.80638370e-04 -2.11837097e-01
  1.21103771e+00]
  HOMO = -0.845536137511148  LUMO = 0.848266358931329
  mo_energy =
[-3.27695992e+01 -1.92725618e+00 -8.45536138e-01 -8.45536138e-01
 -8.45536138e-01  8.48266359e-01  1.08798178e+00  1.08798178e+00
  1.08798178e+00  4.85878882e+00  5.68083955e+00  5.68083955e+00
  5.68083955e+00  1.86056571e+01  2.40161262e+01  2.40161262e+01
  2.40161262e+01  6.04240912e+01  1.18711153e+02  1.18711153e+02
  1.18711153e+02  1.81295039e+02  5.56962202e+02  1.92473947e+03
  8.04888506e+03  4.78083180e+04]
E1 = -182.5983116143897  E_coul = 54.065715264651985
cycle= 5 E= -128.532596349738  delta_E= -5.52e-10  |g|= 6.68e-06  |ddm|= 5.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5983116143897  E_coul = 54.065715264651985
  HOMO = -0.845532487756914  LUMO = 0.848267936405853
  mo_energy =
[-3.27695913e+01 -1.92725180e+00 -8.45532488e-01 -8.45532488e-01
 -8.45532488e-01  8.48267936e-01  1.08798331e+00  1.08798331e+00
  1.08798331e+00  4.85879258e+00  5.68084399e+00  5.68084399e+00
  5.68084399e+00  1.86056631e+01  2.40161330e+01  2.40161330e+01
  2.40161330e+01  6.04240985e+01  1.18711161e+02  1.18711161e+02
  1.18711161e+02  1.81295047e+02  5.56962209e+02  1.92473948e+03
  8.04888507e+03  4.78083180e+04]
E1 = -182.59829413213046  E_coul = 54.06569778239
Extra cycle  E= -128.53259634974  delta_E= -2.73e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1363.9867252278061
E1 = -182.59829413213046  E_coul = 54.06569778239
init E= -128.53259634974
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.845533710898975  LUMO = 0.848267663973836
  mo_energy =
[-3.27695952e+01 -1.92725297e+00 -8.45533711e-01 -8.45533711e-01
 -8.45533711e-01  8.48267664e-01  1.08798288e+00  1.08798288e+00
  1.08798288e+00  4.85879160e+00  5.68084250e+00  5.68084250e+00
  5.68084250e+00  1.86056609e+01  2.40161302e+01  2.40161302e+01
  2.40161302e+01  6.04240954e+01  1.18711157e+02  1.18711157e+02
  1.18711157e+02  1.81295043e+02  5.56962205e+02  1.92473947e+03
  8.04888507e+03  4.78083180e+04]
E1 = -182.5983035598238  E_coul = 54.0657072100831
cycle= 1 E= -128.532596349741  delta_E= -2.27e-13  |g|= 1.29e-06  |ddm|= 9.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5983035598238  E_coul = 54.0657072100831
  HOMO = -0.845533048289491  LUMO = 0.848267864376521
  mo_energy =
[-3.27695932e+01 -1.92725225e+00 -8.45533048e-01 -8.45533048e-01
 -8.45533048e-01  8.48267864e-01  1.08798312e+00  1.08798312e+00
  1.08798312e+00  4.85879219e+00  5.68084331e+00  5.68084331e+00
  5.68084331e+00  1.86056621e+01  2.40161317e+01  2.40161317e+01
  2.40161317e+01  6.04240970e+01  1.18711159e+02  1.18711159e+02
  1.18711159e+02  1.81295045e+02  5.56962207e+02  1.92473948e+03
  8.04888507e+03  4.78083180e+04]
E1 = -182.59829887577476  E_coul = 54.06570252603403
Extra cycle  E= -128.532596349741  delta_E= -5.68e-14  |g|= 6.37e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [8.43926785e-01 2.44137942e+04 3.66144944e+03 8.33368445e+02
 2.34743557e+02 8.00369191e+01 1.34160727e+01 3.13779206e+01
 3.17472171e-01 2.16393137e+00 5.96416655e+00 3.67947984e+00
 1.24328954e+01 5.47118326e+01 3.29819125e-01 1.14241055e+00]
grad_E = [-4.70286608e-06  4.16921133e-09 -2.07451929e-07  3.42621206e-06
 -1.83281865e-05 -4.46764306e-06 -9.35218707e-07  6.28778614e-08
  5.26501442e-06  1.68971409e-06  1.22298174e-07  2.94468469e-07
  2.04992725e-07 -7.99235786e-08 -4.82921796e-06  1.25662453e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843988628634       1
[INPUT] 0    0    [1    /1   ]  24413.7942257        1
[INPUT] 0    0    [1    /1   ]  3661.44943707        1
[INPUT] 0    0    [1    /1   ]  833.368519138        1
[INPUT] 0    0    [1    /1   ]  234.742788768        1
[INPUT] 0    0    [1    /1   ]  80.0394217906        1
[INPUT] 0    0    [1    /1   ]  13.4231013346        1
[INPUT] 0    0    [1    /1   ]  31.3838878217        1
[INPUT] 0    0    [1    /1   ]  0.317486260073       1
[INPUT] 0    0    [1    /1   ]  2.16401600577        1
[INPUT] 0    0    [1    /1   ]  5.96893117846        1
[INPUT] 1    0    [1    /1   ]  3.67939988739        1
[INPUT] 1    0    [1    /1   ]  12.4326584977        1
[INPUT] 1    0    [1    /1   ]  54.7117863509        1
[INPUT] 1    0    [1    /1   ]  0.329815848209       1
[INPUT] 1    0    [1    /1   ]  1.14239000099        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8439886286337009, 1.0]], [0, [24413.794225702706, 1.0]], [0, [3661.4494370702905, 1.0]], [0, [833.3685191376046, 1.0]], [0, [234.74278876808955, 1.0]], [0, [80.03942179059939, 1.0]], [0, [13.42310133460991, 1.0]], [0, [31.38388782173956, 1.0]], [0, [0.31748626007276254, 1.0]], [0, [2.1640160057688664, 1.0]], [0, [5.968931178461324, 1.0]], [1, [3.6793998873912845, 1.0]], [1, [12.432658497667036, 1.0]], [1, [54.711786350854865, 1.0]], [1, [0.32981584820904386, 1.0]], [1, [1.1423900009921806, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84398863]
bas 1, expnt(s) = [24413.7942257]
bas 2, expnt(s) = [3661.44943707]
bas 3, expnt(s) = [833.36851914]
bas 4, expnt(s) = [234.74278877]
bas 5, expnt(s) = [80.03942179]
bas 6, expnt(s) = [13.42310133]
bas 7, expnt(s) = [31.38388782]
bas 8, expnt(s) = [0.31748626]
bas 9, expnt(s) = [2.16401601]
bas 10, expnt(s) = [5.96893118]
bas 11, expnt(s) = [3.67939989]
bas 12, expnt(s) = [12.4326585]
bas 13, expnt(s) = [54.71178635]
bas 14, expnt(s) = [0.32981585]
bas 15, expnt(s) = [1.14239]
CPU time:       386.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43988629e-01 2.22467959e+00 2.44137942e+04 4.93448103e+03
 3.66144944e+03 1.18919974e+03 8.33368519e+02 3.91870745e+02
 2.34742789e+02 1.51516252e+02 8.00394218e+01 6.76072049e+01
 1.34231013e+01 1.77175912e+01 3.13838878e+01 3.35000212e+01
 3.17486260e-01 1.06858414e+00 2.16401601e+00 4.50775575e+00
 5.96893118e+00 9.64800351e+00 3.67939989e+00 1.48663937e+01
 1.24326585e+01 6.81066311e+01 5.47117864e+01 4.34095727e+02
 3.29815848e-01 7.29161606e-01 1.14239000e+00 3.44550103e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497995701237
cond(S) = 1364.8590685444483
E1 = -183.57804805733116  E_coul = 55.07850073113026
init E= -128.499547326201
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943986593005  LUMO = 0.868653233401751
  mo_energy =
[-3.25555297e+01 -1.85290581e+00 -7.73943987e-01 -7.73943987e-01
 -7.73943987e-01  8.68653233e-01  1.11371260e+00  1.11371260e+00
  1.11371260e+00  4.92195301e+00  5.76789342e+00  5.76789342e+00
  5.76789342e+00  1.87368925e+01  2.41732877e+01  2.41732877e+01
  2.41732877e+01  6.06300157e+01  1.18926336e+02  1.18926336e+02
  1.18926336e+02  1.81564680e+02  5.57277804e+02  1.92508574e+03
  8.04925116e+03  4.78086914e+04]
E1 = -182.11098484899068  E_coul = 53.58174235938639
cycle= 1 E= -128.529242489604  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460795
diis-c [-0.21233234  1.        ]
  HOMO = -0.87963477493984  LUMO = 0.838679935574336
  mo_energy =
[-3.28741719e+01 -1.96319704e+00 -8.79634775e-01 -8.79634775e-01
 -8.79634775e-01  8.38679936e-01  1.07555599e+00  1.07555599e+00
  1.07555599e+00  4.83003516e+00  5.63906951e+00  5.63906951e+00
  5.63906951e+00  1.85547445e+01  2.39384027e+01  2.39384027e+01
  2.39384027e+01  6.03686385e+01  1.18605467e+02  1.18605467e+02
  1.18605467e+02  1.81248624e+02  5.56920948e+02  1.92469276e+03
  8.04882878e+03  4.78082501e+04]
E1 = -182.84326384789983  E_coul = 54.31151527582823
cycle= 2 E= -128.531748572072  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230404
diis-c [-0.00070995  0.33221689  0.66778311]
  HOMO = -0.845273764887503  LUMO = 0.848404629508715
  mo_energy =
[-3.27691510e+01 -1.92707146e+00 -8.45273765e-01 -8.45273765e-01
 -8.45273765e-01  8.48404630e-01  1.08802785e+00  1.08802785e+00
  1.08802785e+00  4.85976931e+00  5.68095678e+00  5.68095678e+00
  5.68095678e+00  1.86145531e+01  2.40159279e+01  2.40159279e+01
  2.40159279e+01  6.04552114e+01  1.18710502e+02  1.18710502e+02
  1.18710502e+02  1.81352389e+02  5.57034415e+02  1.92481149e+03
  8.04895001e+03  4.78083723e+04]
E1 = -182.59774083695484  E_coul = 54.06514450628869
cycle= 3 E= -128.532596330666  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000909862
diis-c [-1.42559897e-07 -2.21343338e-03 -8.38403056e-04  1.00305184e+00]
  HOMO = -0.84550362092128  LUMO = 0.84836646404847
  mo_energy =
[-3.27695458e+01 -1.92723616e+00 -8.45503621e-01 -8.45503621e-01
 -8.45503621e-01  8.48366464e-01  1.08797917e+00  1.08797917e+00
  1.08797917e+00  4.85962673e+00  5.68075896e+00  5.68075896e+00
  5.68075896e+00  1.86142962e+01  2.40156152e+01  2.40156152e+01
  2.40156152e+01  6.04548795e+01  1.18710095e+02  1.18710095e+02
  1.18710095e+02  1.81351989e+02  5.57033919e+02  1.92481089e+03
  8.04894931e+03  4.78083715e+04]
E1 = -182.59820160718454  E_coul = 54.06560525645951
cycle= 4 E= -128.532596350725  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135255
diis-c [-1.01846439e-09  3.18725046e-04  4.80677836e-04 -2.11826141e-01
  1.21102674e+00]
  HOMO = -0.845536291340965  LUMO = 0.848358984671428
  mo_energy =
[-3.27695998e+01 -1.92725629e+00 -8.45536291e-01 -8.45536291e-01
 -8.45536291e-01  8.48358985e-01  1.08796554e+00  1.08796554e+00
  1.08796554e+00  4.85960190e+00  5.68072277e+00  5.68072277e+00
  5.68072277e+00  1.86142541e+01  2.40155667e+01  2.40155667e+01
  2.40155667e+01  6.04548295e+01  1.18710040e+02  1.18710040e+02
  1.18710040e+02  1.81351934e+02  5.57033857e+02  1.92481082e+03
  8.04894924e+03  4.78083714e+04]
E1 = -182.59830921709886  E_coul = 54.06571286582187
cycle= 5 E= -128.532596351277  delta_E= -5.52e-10  |g|= 6.68e-06  |ddm|= 5.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59830921709886  E_coul = 54.06571286582187
  HOMO = -0.845532642055196  LUMO = 0.848360562236047
  mo_energy =
[-3.27695919e+01 -1.92725191e+00 -8.45532642e-01 -8.45532642e-01
 -8.45532642e-01  8.48360562e-01  1.08796707e+00  1.08796707e+00
  1.08796707e+00  4.85960566e+00  5.68072720e+00  5.68072720e+00
  5.68072720e+00  1.86142601e+01  2.40155736e+01  2.40155736e+01
  2.40155736e+01  6.04548368e+01  1.18710048e+02  1.18710048e+02
  1.18710048e+02  1.81351942e+02  5.57033865e+02  1.92481082e+03
  8.04894924e+03  4.78083714e+04]
E1 = -182.59829173790854  E_coul = 54.065695386628924
Extra cycle  E= -128.53259635128  delta_E= -2.61e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.43988629e-01 2.44137942e+04 3.66144944e+03 8.33368519e+02
 2.34742789e+02 8.00394218e+01 1.34231013e+01 3.13838878e+01
 3.17486260e-01 2.16401601e+00 5.96893118e+00 3.67939989e+00
 1.24326585e+01 5.47117864e+01 3.29815848e-01 1.14239000e+00]
E = -128.5325963512796
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843988628634       1
[INPUT] 0    0    [1    /1   ]  24413.7942257        1
[INPUT] 0    0    [1    /1   ]  3661.44943707        1
[INPUT] 0    0    [1    /1   ]  833.368519138        1
[INPUT] 0    0    [1    /1   ]  234.742788768        1
[INPUT] 0    0    [1    /1   ]  80.0394217906        1
[INPUT] 0    0    [1    /1   ]  13.4231013346        1
[INPUT] 0    0    [1    /1   ]  31.3838878217        1
[INPUT] 0    0    [1    /1   ]  0.317486260073       1
[INPUT] 0    0    [1    /1   ]  2.16401600577        1
[INPUT] 0    0    [1    /1   ]  5.96893117846        1
[INPUT] 1    0    [1    /1   ]  3.67939988739        1
[INPUT] 1    0    [1    /1   ]  12.4326584977        1
[INPUT] 1    0    [1    /1   ]  54.7117863509        1
[INPUT] 1    0    [1    /1   ]  0.329815848209       1
[INPUT] 1    0    [1    /1   ]  1.14239000099        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8439886286337009, 1.0]], [0, [24413.794225702706, 1.0]], [0, [3661.4494370702905, 1.0]], [0, [833.3685191376046, 1.0]], [0, [234.74278876808955, 1.0]], [0, [80.03942179059939, 1.0]], [0, [13.42310133460991, 1.0]], [0, [31.38388782173956, 1.0]], [0, [0.31748626007276254, 1.0]], [0, [2.1640160057688664, 1.0]], [0, [5.968931178461324, 1.0]], [1, [3.6793998873912845, 1.0]], [1, [12.432658497667036, 1.0]], [1, [54.711786350854865, 1.0]], [1, [0.32981584820904386, 1.0]], [1, [1.1423900009921806, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84398863]
bas 1, expnt(s) = [24413.7942257]
bas 2, expnt(s) = [3661.44943707]
bas 3, expnt(s) = [833.36851914]
bas 4, expnt(s) = [234.74278877]
bas 5, expnt(s) = [80.03942179]
bas 6, expnt(s) = [13.42310133]
bas 7, expnt(s) = [31.38388782]
bas 8, expnt(s) = [0.31748626]
bas 9, expnt(s) = [2.16401601]
bas 10, expnt(s) = [5.96893118]
bas 11, expnt(s) = [3.67939989]
bas 12, expnt(s) = [12.4326585]
bas 13, expnt(s) = [54.71178635]
bas 14, expnt(s) = [0.32981585]
bas 15, expnt(s) = [1.14239]
CPU time:       387.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43988629e-01 2.22467959e+00 2.44137942e+04 4.93448103e+03
 3.66144944e+03 1.18919974e+03 8.33368519e+02 3.91870745e+02
 2.34742789e+02 1.51516252e+02 8.00394218e+01 6.76072049e+01
 1.34231013e+01 1.77175912e+01 3.13838878e+01 3.35000212e+01
 3.17486260e-01 1.06858414e+00 2.16401601e+00 4.50775575e+00
 5.96893118e+00 9.64800351e+00 3.67939989e+00 1.48663937e+01
 1.24326585e+01 6.81066311e+01 5.47117864e+01 4.34095727e+02
 3.29815848e-01 7.29161606e-01 1.14239000e+00 3.44550103e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497995701237
cond(S) = 1364.8590685444483
E1 = -183.57804805733116  E_coul = 55.07850073113026
init E= -128.499547326201
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773943986593005  LUMO = 0.868653233401751
  mo_energy =
[-3.25555297e+01 -1.85290581e+00 -7.73943987e-01 -7.73943987e-01
 -7.73943987e-01  8.68653233e-01  1.11371260e+00  1.11371260e+00
  1.11371260e+00  4.92195301e+00  5.76789342e+00  5.76789342e+00
  5.76789342e+00  1.87368925e+01  2.41732877e+01  2.41732877e+01
  2.41732877e+01  6.06300157e+01  1.18926336e+02  1.18926336e+02
  1.18926336e+02  1.81564680e+02  5.57277804e+02  1.92508574e+03
  8.04925116e+03  4.78086914e+04]
E1 = -182.11098484899068  E_coul = 53.58174235938639
cycle= 1 E= -128.529242489604  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460795
diis-c [-0.21233234  1.        ]
  HOMO = -0.87963477493984  LUMO = 0.838679935574336
  mo_energy =
[-3.28741719e+01 -1.96319704e+00 -8.79634775e-01 -8.79634775e-01
 -8.79634775e-01  8.38679936e-01  1.07555599e+00  1.07555599e+00
  1.07555599e+00  4.83003516e+00  5.63906951e+00  5.63906951e+00
  5.63906951e+00  1.85547445e+01  2.39384027e+01  2.39384027e+01
  2.39384027e+01  6.03686385e+01  1.18605467e+02  1.18605467e+02
  1.18605467e+02  1.81248624e+02  5.56920948e+02  1.92469276e+03
  8.04882878e+03  4.78082501e+04]
E1 = -182.84326384789983  E_coul = 54.31151527582823
cycle= 2 E= -128.531748572072  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230404
diis-c [-0.00070995  0.33221689  0.66778311]
  HOMO = -0.845273764887503  LUMO = 0.848404629508715
  mo_energy =
[-3.27691510e+01 -1.92707146e+00 -8.45273765e-01 -8.45273765e-01
 -8.45273765e-01  8.48404630e-01  1.08802785e+00  1.08802785e+00
  1.08802785e+00  4.85976931e+00  5.68095678e+00  5.68095678e+00
  5.68095678e+00  1.86145531e+01  2.40159279e+01  2.40159279e+01
  2.40159279e+01  6.04552114e+01  1.18710502e+02  1.18710502e+02
  1.18710502e+02  1.81352389e+02  5.57034415e+02  1.92481149e+03
  8.04895001e+03  4.78083723e+04]
E1 = -182.59774083695484  E_coul = 54.06514450628869
cycle= 3 E= -128.532596330666  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000909862
diis-c [-1.42559897e-07 -2.21343338e-03 -8.38403056e-04  1.00305184e+00]
  HOMO = -0.84550362092128  LUMO = 0.84836646404847
  mo_energy =
[-3.27695458e+01 -1.92723616e+00 -8.45503621e-01 -8.45503621e-01
 -8.45503621e-01  8.48366464e-01  1.08797917e+00  1.08797917e+00
  1.08797917e+00  4.85962673e+00  5.68075896e+00  5.68075896e+00
  5.68075896e+00  1.86142962e+01  2.40156152e+01  2.40156152e+01
  2.40156152e+01  6.04548795e+01  1.18710095e+02  1.18710095e+02
  1.18710095e+02  1.81351989e+02  5.57033919e+02  1.92481089e+03
  8.04894931e+03  4.78083715e+04]
E1 = -182.59820160718454  E_coul = 54.06560525645951
cycle= 4 E= -128.532596350725  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135255
diis-c [-1.01846439e-09  3.18725046e-04  4.80677836e-04 -2.11826141e-01
  1.21102674e+00]
  HOMO = -0.845536291340965  LUMO = 0.848358984671428
  mo_energy =
[-3.27695998e+01 -1.92725629e+00 -8.45536291e-01 -8.45536291e-01
 -8.45536291e-01  8.48358985e-01  1.08796554e+00  1.08796554e+00
  1.08796554e+00  4.85960190e+00  5.68072277e+00  5.68072277e+00
  5.68072277e+00  1.86142541e+01  2.40155667e+01  2.40155667e+01
  2.40155667e+01  6.04548295e+01  1.18710040e+02  1.18710040e+02
  1.18710040e+02  1.81351934e+02  5.57033857e+02  1.92481082e+03
  8.04894924e+03  4.78083714e+04]
E1 = -182.59830921709886  E_coul = 54.06571286582187
cycle= 5 E= -128.532596351277  delta_E= -5.52e-10  |g|= 6.68e-06  |ddm|= 5.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59830921709886  E_coul = 54.06571286582187
  HOMO = -0.845532642055196  LUMO = 0.848360562236047
  mo_energy =
[-3.27695919e+01 -1.92725191e+00 -8.45532642e-01 -8.45532642e-01
 -8.45532642e-01  8.48360562e-01  1.08796707e+00  1.08796707e+00
  1.08796707e+00  4.85960566e+00  5.68072720e+00  5.68072720e+00
  5.68072720e+00  1.86142601e+01  2.40155736e+01  2.40155736e+01
  2.40155736e+01  6.04548368e+01  1.18710048e+02  1.18710048e+02
  1.18710048e+02  1.81351942e+02  5.57033865e+02  1.92481082e+03
  8.04894924e+03  4.78083714e+04]
E1 = -182.59829173790854  E_coul = 54.065695386628924
Extra cycle  E= -128.53259635128  delta_E= -2.61e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1364.8590685444483
E1 = -182.59829173790854  E_coul = 54.065695386628924
init E= -128.53259635128
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.845533864985696  LUMO = 0.84836028983595
  mo_energy =
[-3.27695958e+01 -1.92725308e+00 -8.45533865e-01 -8.45533865e-01
 -8.45533865e-01  8.48360290e-01  1.08796665e+00  1.08796665e+00
  1.08796665e+00  4.85960468e+00  5.68072571e+00  5.68072571e+00
  5.68072571e+00  1.86142580e+01  2.40155707e+01  2.40155707e+01
  2.40155707e+01  6.04548336e+01  1.18710044e+02  1.18710044e+02
  1.18710044e+02  1.81351938e+02  5.57033861e+02  1.92481082e+03
  8.04894924e+03  4.78083714e+04]
E1 = -182.59830116408205  E_coul = 54.065704812802075
cycle= 1 E= -128.53259635128  delta_E= -3.69e-13  |g|= 1.29e-06  |ddm|= 9.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59830116408205  E_coul = 54.065704812802075
  HOMO = -0.845533202484116  LUMO = 0.848360490234953
  mo_energy =
[-3.27695938e+01 -1.92725236e+00 -8.45533202e-01 -8.45533202e-01
 -8.45533202e-01  8.48360490e-01  1.08796689e+00  1.08796689e+00
  1.08796689e+00  4.85960527e+00  5.68072652e+00  5.68072652e+00
  5.68072652e+00  1.86142591e+01  2.40155722e+01  2.40155722e+01
  2.40155722e+01  6.04548353e+01  1.18710046e+02  1.18710046e+02
  1.18710046e+02  1.81351940e+02  5.57033863e+02  1.92481082e+03
  8.04894924e+03  4.78083714e+04]
E1 = -182.59829648080057  E_coul = 54.06570012952051
Extra cycle  E= -128.53259635128  delta_E= -8.53e-14  |g|= 6.37e-07  |ddm|= 4.59e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [8.43988629e-01 2.44137942e+04 3.66144944e+03 8.33368519e+02
 2.34742789e+02 8.00394218e+01 1.34231013e+01 3.13838878e+01
 3.17486260e-01 2.16401601e+00 5.96893118e+00 3.67939989e+00
 1.24326585e+01 5.47117864e+01 3.29815848e-01 1.14239000e+00]
grad_E = [-2.69508496e-07  4.17217602e-09 -2.07599274e-07  3.42881976e-06
 -1.83478518e-05 -4.36656997e-06 -1.83098723e-08 -3.91765855e-07
  1.96522714e-07  4.26786722e-08 -2.99398812e-07 -3.08005923e-08
 -5.44088785e-08 -2.73852960e-08  1.83130986e-07 -1.26627022e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]

basis = "11s5p"

exps = np.zeros((16, 2))
exps[1:, 0] = basis_sets["10s5p"][:]
exps[0, 0] = 0.5
# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:03:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.843988628634       1
[INPUT] 0    0    [1    /1   ]  24413.7942257        1
[INPUT] 0    0    [1    /1   ]  3661.44943707        1
[INPUT] 0    0    [1    /1   ]  833.368519138        1
[INPUT] 0    0    [1    /1   ]  234.742788768        1
[INPUT] 0    0    [1    /1   ]  80.0394217906        1
[INPUT] 0    0    [1    /1   ]  13.4231013346        1
[INPUT] 0    0    [1    /1   ]  31.3838878217        1
[INPUT] 0    0    [1    /1   ]  0.317486260073       1
[INPUT] 0    0    [1    /1   ]  2.16401600577        1
[INPUT] 0    0    [1    /1   ]  5.96893117846        1
[INPUT] 1    0    [1    /1   ]  3.67939988739        1
[INPUT] 1    0    [1    /1   ]  12.4326584977        1
[INPUT] 1    0    [1    /1   ]  54.7117863509        1
[INPUT] 1    0    [1    /1   ]  0.329815848209       1
[INPUT] 1    0    [1    /1   ]  1.14239000099        1

nuclear repulsion = 0
number of shells = 16
number of NR pGTOs = 26
number of NR cGTOs = 26
basis = {'Ne': [[0, [0.8439886286337009, 1.0]], [0, [24413.794225702706, 1.0]], [0, [3661.4494370702905, 1.0]], [0, [833.3685191376046, 1.0]], [0, [234.74278876808955, 1.0]], [0, [80.03942179059939, 1.0]], [0, [13.42310133460991, 1.0]], [0, [31.38388782173956, 1.0]], [0, [0.31748626007276254, 1.0]], [0, [2.1640160057688664, 1.0]], [0, [5.968931178461324, 1.0]], [1, [3.6793998873912845, 1.0]], [1, [12.432658497667036, 1.0]], [1, [54.711786350854865, 1.0]], [1, [0.32981584820904386, 1.0]], [1, [1.1423900009921806, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.84398863]
bas 1, expnt(s) = [24413.7942257]
bas 2, expnt(s) = [3661.44943707]
bas 3, expnt(s) = [833.36851914]
bas 4, expnt(s) = [234.74278877]
bas 5, expnt(s) = [80.03942179]
bas 6, expnt(s) = [13.42310133]
bas 7, expnt(s) = [31.38388782]
bas 8, expnt(s) = [0.31748626]
bas 9, expnt(s) = [2.16401601]
bas 10, expnt(s) = [5.96893118]
bas 11, expnt(s) = [3.67939989]
bas 12, expnt(s) = [12.4326585]
bas 13, expnt(s) = [54.71178635]
bas 14, expnt(s) = [0.32981585]
bas 15, expnt(s) = [1.14239]
CPU time:       391.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.43988629e-01 2.22467959e+00 2.44137942e+04 4.93448103e+03
 3.66144944e+03 1.18919974e+03 8.33368519e+02 3.91870745e+02
 2.34742789e+02 1.51516252e+02 8.00394218e+01 6.76072049e+01
 1.34231013e+01 1.77175912e+01 3.13838878e+01 3.35000212e+01
 3.17486260e-01 1.06858414e+00 2.16401601e+00 4.50775575e+00
 5.96893118e+00 9.64800351e+00 3.67939989e+00 1.48663937e+01
 1.24326585e+01 6.81066311e+01 5.47117864e+01 4.34095727e+02
 3.29815848e-01 7.29161606e-01 1.14239000e+00 3.44550103e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998497995701237
cond(S) = 1364.8590685444483
E1 = -183.57804805733116  E_coul = 55.07850073113026
init E= -128.499547326201
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773943986593005  LUMO = 0.868653233401751
  mo_energy =
[-3.25555297e+01 -1.85290581e+00 -7.73943987e-01 -7.73943987e-01
 -7.73943987e-01  8.68653233e-01  1.11371260e+00  1.11371260e+00
  1.11371260e+00  4.92195301e+00  5.76789342e+00  5.76789342e+00
  5.76789342e+00  1.87368925e+01  2.41732877e+01  2.41732877e+01
  2.41732877e+01  6.06300157e+01  1.18926336e+02  1.18926336e+02
  1.18926336e+02  1.81564680e+02  5.57277804e+02  1.92508574e+03
  8.04925116e+03  4.78086914e+04]
E1 = -182.11098484899068  E_coul = 53.58174235938639
cycle= 1 E= -128.529242489604  delta_E= -0.0297  |g|= 0.201  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.460795
diis-c [-0.21233234  1.        ]
  HOMO = -0.87963477493984  LUMO = 0.838679935574336
  mo_energy =
[-3.28741719e+01 -1.96319704e+00 -8.79634775e-01 -8.79634775e-01
 -8.79634775e-01  8.38679936e-01  1.07555599e+00  1.07555599e+00
  1.07555599e+00  4.83003516e+00  5.63906951e+00  5.63906951e+00
  5.63906951e+00  1.85547445e+01  2.39384027e+01  2.39384027e+01
  2.39384027e+01  6.03686385e+01  1.18605467e+02  1.18605467e+02
  1.18605467e+02  1.81248624e+02  5.56920948e+02  1.92469276e+03
  8.04882878e+03  4.78082501e+04]
E1 = -182.84326384789983  E_coul = 54.31151527582823
cycle= 2 E= -128.531748572072  delta_E= -0.00251  |g|=  0.1  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.230404
diis-c [-0.00070995  0.33221689  0.66778311]
  HOMO = -0.845273764887503  LUMO = 0.848404629508715
  mo_energy =
[-3.27691510e+01 -1.92707146e+00 -8.45273765e-01 -8.45273765e-01
 -8.45273765e-01  8.48404630e-01  1.08802785e+00  1.08802785e+00
  1.08802785e+00  4.85976931e+00  5.68095678e+00  5.68095678e+00
  5.68095678e+00  1.86145531e+01  2.40159279e+01  2.40159279e+01
  2.40159279e+01  6.04552114e+01  1.18710502e+02  1.18710502e+02
  1.18710502e+02  1.81352389e+02  5.57034415e+02  1.92481149e+03
  8.04895001e+03  4.78083723e+04]
E1 = -182.59774083695484  E_coul = 54.06514450628869
cycle= 3 E= -128.532596330666  delta_E= -0.000848  |g|= 0.000457  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000909862
diis-c [-1.42559897e-07 -2.21343338e-03 -8.38403056e-04  1.00305184e+00]
  HOMO = -0.84550362092128  LUMO = 0.84836646404847
  mo_energy =
[-3.27695458e+01 -1.92723616e+00 -8.45503621e-01 -8.45503621e-01
 -8.45503621e-01  8.48366464e-01  1.08797917e+00  1.08797917e+00
  1.08797917e+00  4.85962673e+00  5.68075896e+00  5.68075896e+00
  5.68075896e+00  1.86142962e+01  2.40156152e+01  2.40156152e+01
  2.40156152e+01  6.04548795e+01  1.18710095e+02  1.18710095e+02
  1.18710095e+02  1.81351989e+02  5.57033919e+02  1.92481089e+03
  8.04894931e+03  4.78083715e+04]
E1 = -182.59820160718454  E_coul = 54.06560525645951
cycle= 4 E= -128.532596350725  delta_E= -2.01e-08  |g|= 6.46e-05  |ddm|= 0.000294
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135255
diis-c [-1.01846439e-09  3.18725046e-04  4.80677836e-04 -2.11826141e-01
  1.21102674e+00]
  HOMO = -0.845536291340965  LUMO = 0.848358984671428
  mo_energy =
[-3.27695998e+01 -1.92725629e+00 -8.45536291e-01 -8.45536291e-01
 -8.45536291e-01  8.48358985e-01  1.08796554e+00  1.08796554e+00
  1.08796554e+00  4.85960190e+00  5.68072277e+00  5.68072277e+00
  5.68072277e+00  1.86142541e+01  2.40155667e+01  2.40155667e+01
  2.40155667e+01  6.04548295e+01  1.18710040e+02  1.18710040e+02
  1.18710040e+02  1.81351934e+02  5.57033857e+02  1.92481082e+03
  8.04894924e+03  4.78083714e+04]
E1 = -182.59830921709886  E_coul = 54.06571286582187
cycle= 5 E= -128.532596351277  delta_E= -5.52e-10  |g|= 6.68e-06  |ddm|= 5.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59830921709886  E_coul = 54.06571286582187
  HOMO = -0.845532642055196  LUMO = 0.848360562236047
  mo_energy =
[-3.27695919e+01 -1.92725191e+00 -8.45532642e-01 -8.45532642e-01
 -8.45532642e-01  8.48360562e-01  1.08796707e+00  1.08796707e+00
  1.08796707e+00  4.85960566e+00  5.68072720e+00  5.68072720e+00
  5.68072720e+00  1.86142601e+01  2.40155736e+01  2.40155736e+01
  2.40155736e+01  6.04548368e+01  1.18710048e+02  1.18710048e+02
  1.18710048e+02  1.81351942e+02  5.57033865e+02  1.92481082e+03
  8.04894924e+03  4.78083714e+04]
E1 = -182.59829173790854  E_coul = 54.065695386628924
Extra cycle  E= -128.53259635128  delta_E= -2.61e-12  |g|= 2.45e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [8.43988629e-01 2.44137942e+04 3.66144944e+03 8.33368519e+02
 2.34742789e+02 8.00394218e+01 1.34231013e+01 3.13838878e+01
 3.17486260e-01 2.16401601e+00 5.96893118e+00 3.67939989e+00
 1.24326585e+01 5.47117864e+01 3.29815848e-01 1.14239000e+00]
E = -128.5325963512796
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -128.5325963512796
       x: [ 8.440e-01  2.441e+04 ...  3.298e-01  1.142e+00]
     nit: 99
     jac: [-2.695e-07  4.172e-09 ...  1.831e-07 -1.266e-07]
    nfev: 102
    njev: 99
E = -128.5325963512796
exponents = [
S                         P                         
8.4398862863370094e-01    3.6793998873912845e+00
2.4413794225702706e+04    1.2432658497667036e+01
3.6614494370702905e+03    5.4711786350854865e+01
8.3336851913760461e+02    3.2981584820904386e-01
2.3474278876808955e+02    1.1423900009921806e+00
8.0039421790599391e+01    
1.3423101334609910e+01    
3.1383887821739560e+01    
3.1748626007276254e-01    
2.1640160057688664e+00    
5.9689311784613244e+00    
E = -128.5325963512796
exp = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
