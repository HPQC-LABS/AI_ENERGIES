#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.5                  1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157159        1
[INPUT] 0    0    [1    /1   ]  833.319261642        1
[INPUT] 0    0    [1    /1   ]  235.442497605        1
[INPUT] 0    0    [1    /1   ]  76.138925686         1
[INPUT] 0    0    [1    /1   ]  9.99179086579        1
[INPUT] 0    0    [1    /1   ]  26.9186513219        1
[INPUT] 0    0    [1    /1   ]  0.379853594604       1
[INPUT] 0    0    [1    /1   ]  1.10977232002        1
[INPUT] 0    0    [1    /1   ]  2.85995276365        1
[INPUT] 1    0    [1    /1   ]  7.1138216687         1
[INPUT] 1    0    [1    /1   ]  23.1710125063        1
[INPUT] 1    0    [1    /1   ]  99.7863721101        1
[INPUT] 1    0    [1    /1   ]  0.2663986627         1
[INPUT] 1    0    [1    /1   ]  2.44209552332        1
[INPUT] 1    0    [1    /1   ]  0.834486593732       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5, 1.0]], [0, [24413.794186547566, 1.0]], [0, [3661.4515715933576, 1.0]], [0, [833.3192616415741, 1.0]], [0, [235.44249760504746, 1.0]], [0, [76.13892568597512, 1.0]], [0, [9.991790865785616, 1.0]], [0, [26.918651321937844, 1.0]], [0, [0.3798535946043467, 1.0]], [0, [1.109772320020386, 1.0]], [0, [2.859952763645397, 1.0]], [1, [7.113821668699218, 1.0]], [1, [23.171012506273396, 1.0]], [1, [99.7863721100639, 1.0]], [1, [0.2663986626998784, 1.0]], [1, [2.442095523318457, 1.0]], [1, [0.8344865937319704, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157159]
bas 3, expnt(s) = [833.31926164]
bas 4, expnt(s) = [235.44249761]
bas 5, expnt(s) = [76.13892569]
bas 6, expnt(s) = [9.99179087]
bas 7, expnt(s) = [26.91865132]
bas 8, expnt(s) = [0.37985359]
bas 9, expnt(s) = [1.10977232]
bas 10, expnt(s) = [2.85995276]
bas 11, expnt(s) = [7.11382167]
bas 12, expnt(s) = [23.17101251]
bas 13, expnt(s) = [99.78637211]
bas 14, expnt(s) = [0.26639866]
bas 15, expnt(s) = [2.44209552]
bas 16, expnt(s) = [0.83448659]
CPU time:         1.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00000000e-01 1.50225109e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319262e+02 3.91853373e+02
 2.35442498e+02 1.51854850e+02 7.61389257e+01 6.51208533e+01
 9.99179087e+00 1.41986654e+01 2.69186513e+01 2.98576070e+01
 3.79853595e-01 1.22243902e+00 1.10977232e+00 2.73174678e+00
 2.85995276e+00 5.55628059e+00 7.11382167e+00 3.38932418e+01
 2.31710125e+01 1.48308368e+02 9.97863721e+01 9.20075432e+02
 2.66398663e-01 5.58340901e-01 2.44209552e+00 8.90610276e+00
 8.34486594e-01 2.32679755e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99958708832008
cond(S) = 3349.043695368123
E1 = -183.5897084206108  E_coul = 55.08024643728484
init E= -128.509461983326
    CPU time for initialize scf      0.13 sec, wall time      0.13 sec
  HOMO = -0.77539727430793  LUMO = 0.687095166818566
  mo_energy =
[-3.25550554e+01 -1.85259491e+00 -7.75397274e-01 -7.75397274e-01
 -7.75397274e-01  6.87095167e-01  8.25075437e-01  8.25075437e-01
  8.25075437e-01  2.99000630e+00  3.95945407e+00  3.95945407e+00
  3.95945407e+00  9.49628549e+00  1.43628118e+01  1.43628118e+01
  1.43628118e+01  3.66035265e+01  5.30110528e+01  5.30110528e+01
  5.30110528e+01  1.39960637e+02  2.40838408e+02  2.40838408e+02
  2.40838408e+02  5.02883285e+02  1.86954976e+03  7.99902795e+03
  4.77668620e+04]
E1 = -182.08820031118435  E_coul = 53.550345366503144
cycle= 1 E= -128.537854944681  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.165
    CPU time for cycle= 1      0.26 sec, wall time      0.26 sec
diis-norm(errvec)=0.520473
diis-c [-0.27089233  1.        ]
  HOMO = -0.884085513456284  LUMO = 0.664638107530014
  mo_energy =
[-3.28777897e+01 -1.96635770e+00 -8.84085513e-01 -8.84085513e-01
 -8.84085513e-01  6.64638108e-01  7.98369558e-01  7.98369558e-01
  7.98369558e-01  2.93579492e+00  3.86214089e+00  3.86214089e+00
  3.86214089e+00  9.36742881e+00  1.41723733e+01  1.41723733e+01
  1.41723733e+01  3.63594319e+01  5.27305002e+01  5.27305002e+01
  5.27305002e+01  1.39643879e+02  2.40492559e+02  2.40492559e+02
  2.40492559e+02  5.02522319e+02  1.86915271e+03  7.99860188e+03
  4.77664171e+04]
E1 = -182.8485740718242  E_coul = 54.30813733698168
cycle= 2 E= -128.540436734843  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0666
    CPU time for cycle= 2      0.09 sec, wall time      0.09 sec
diis-norm(errvec)=0.264252
diis-c [-6.43985912e-04  3.35976394e-01  6.64023606e-01]
  HOMO = -0.848503927110638  LUMO = 0.671843808654132
  mo_energy =
[-3.27698161e+01 -1.92888337e+00 -8.48503927e-01 -8.48503927e-01
 -8.48503927e-01  6.71843809e-01  8.07098639e-01  8.07098639e-01
  8.07098639e-01  2.95327463e+00  3.89373038e+00  3.89373038e+00
  3.89373038e+00  9.40964957e+00  1.42354889e+01  1.42354889e+01
  1.42354889e+01  3.64411976e+01  5.28244074e+01  5.28244074e+01
  5.28244074e+01  1.39749599e+02  2.40606099e+02  2.40606099e+02
  2.40606099e+02  5.02638987e+02  1.86927465e+03  7.99872626e+03
  4.77665424e+04]
E1 = -182.59042438520694  E_coul = 54.04907065060649
cycle= 3 E= -128.5413537346  delta_E= -0.000917  |g|= 0.0005  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113726
diis-c [-1.61166244e-07 -2.26314226e-03 -4.24955462e-04  1.00268810e+00]
  HOMO = -0.848758062150189  LUMO = 0.671802527626101
  mo_energy =
[-3.27702783e+01 -1.92907837e+00 -8.48758062e-01 -8.48758062e-01
 -8.48758062e-01  6.71802528e-01  8.07060294e-01  8.07060294e-01
  8.07060294e-01  2.95317764e+00  3.89355498e+00  3.89355498e+00
  3.89355498e+00  9.40943312e+00  1.42351841e+01  1.42351841e+01
  1.42351841e+01  3.64408427e+01  5.28239999e+01  5.28239999e+01
  5.28239999e+01  1.39749135e+02  2.40605565e+02  2.40605565e+02
  2.40605565e+02  5.02638397e+02  1.86927393e+03  7.99872544e+03
  4.77665415e+04]
E1 = -182.59090469668473  E_coul = 54.04955093820775
cycle= 4 E= -128.541353758477  delta_E= -2.39e-08  |g|= 7.61e-05  |ddm|= 0.000957
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176887
diis-c [-9.89734050e-10  2.24992056e-04  4.58866907e-04 -1.77446141e-01
  1.17676228e+00]
  HOMO = -0.848799084520007  LUMO = 0.671792320741725
  mo_energy =
[-3.27703484e+01 -1.92911016e+00 -8.48799085e-01 -8.48799085e-01
 -8.48799085e-01  6.71792321e-01  8.07047475e-01  8.07047475e-01
  8.07047475e-01  2.95315614e+00  3.89351669e+00  3.89351669e+00
  3.89351669e+00  9.40939020e+00  1.42351272e+01  1.42351272e+01
  1.42351272e+01  3.64407808e+01  5.28239336e+01  5.28239336e+01
  5.28239336e+01  1.39749065e+02  2.40605491e+02  2.40605491e+02
  2.40605491e+02  5.02638319e+02  1.86927384e+03  7.99872535e+03
  4.77665414e+04]
E1 = -182.59103264014144  E_coul = 54.049678881030665
cycle= 5 E= -128.541353759111  delta_E= -6.34e-10  |g|= 5.4e-06  |ddm|= 0.000183
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59103264014144  E_coul = 54.049678881030665
  HOMO = -0.848796291387813  LUMO = 0.671793251940588
  mo_energy =
[-3.27703420e+01 -1.92910661e+00 -8.48796291e-01 -8.48796291e-01
 -8.48796291e-01  6.71793252e-01  8.07048278e-01  8.07048278e-01
  8.07048278e-01  2.95315795e+00  3.89351936e+00  3.89351936e+00
  3.89351936e+00  9.40939382e+00  1.42351319e+01  1.42351319e+01
  1.42351319e+01  3.64407865e+01  5.28239397e+01  5.28239397e+01
  5.28239397e+01  1.39749071e+02  2.40605497e+02  2.40605497e+02
  2.40605497e+02  5.02638325e+02  1.86927385e+03  7.99872536e+03
  4.77665414e+04]
E1 = -182.5910175425271  E_coul = 54.04966378341429
Extra cycle  E= -128.541353759113  delta_E= -2.07e-12  |g|= 2.11e-06  |ddm|= 3.11e-06
    CPU time for scf_cycle      0.53 sec, wall time      0.53 sec
exp = [5.00000000e-01 2.44137942e+04 3.66145157e+03 8.33319262e+02
 2.35442498e+02 7.61389257e+01 9.99179087e+00 2.69186513e+01
 3.79853595e-01 1.10977232e+00 2.85995276e+00 7.11382167e+00
 2.31710125e+01 9.97863721e+01 2.66398663e-01 2.44209552e+00
 8.34486594e-01]
E = -128.54135375911284
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.5                  1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157159        1
[INPUT] 0    0    [1    /1   ]  833.319261642        1
[INPUT] 0    0    [1    /1   ]  235.442497605        1
[INPUT] 0    0    [1    /1   ]  76.138925686         1
[INPUT] 0    0    [1    /1   ]  9.99179086579        1
[INPUT] 0    0    [1    /1   ]  26.9186513219        1
[INPUT] 0    0    [1    /1   ]  0.379853594604       1
[INPUT] 0    0    [1    /1   ]  1.10977232002        1
[INPUT] 0    0    [1    /1   ]  2.85995276365        1
[INPUT] 1    0    [1    /1   ]  7.1138216687         1
[INPUT] 1    0    [1    /1   ]  23.1710125063        1
[INPUT] 1    0    [1    /1   ]  99.7863721101        1
[INPUT] 1    0    [1    /1   ]  0.2663986627         1
[INPUT] 1    0    [1    /1   ]  2.44209552332        1
[INPUT] 1    0    [1    /1   ]  0.834486593732       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5, 1.0]], [0, [24413.794186547566, 1.0]], [0, [3661.4515715933576, 1.0]], [0, [833.3192616415741, 1.0]], [0, [235.44249760504746, 1.0]], [0, [76.13892568597512, 1.0]], [0, [9.991790865785616, 1.0]], [0, [26.918651321937844, 1.0]], [0, [0.3798535946043467, 1.0]], [0, [1.109772320020386, 1.0]], [0, [2.859952763645397, 1.0]], [1, [7.113821668699218, 1.0]], [1, [23.171012506273396, 1.0]], [1, [99.7863721100639, 1.0]], [1, [0.2663986626998784, 1.0]], [1, [2.442095523318457, 1.0]], [1, [0.8344865937319704, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157159]
bas 3, expnt(s) = [833.31926164]
bas 4, expnt(s) = [235.44249761]
bas 5, expnt(s) = [76.13892569]
bas 6, expnt(s) = [9.99179087]
bas 7, expnt(s) = [26.91865132]
bas 8, expnt(s) = [0.37985359]
bas 9, expnt(s) = [1.10977232]
bas 10, expnt(s) = [2.85995276]
bas 11, expnt(s) = [7.11382167]
bas 12, expnt(s) = [23.17101251]
bas 13, expnt(s) = [99.78637211]
bas 14, expnt(s) = [0.26639866]
bas 15, expnt(s) = [2.44209552]
bas 16, expnt(s) = [0.83448659]
CPU time:         2.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00000000e-01 1.50225109e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319262e+02 3.91853373e+02
 2.35442498e+02 1.51854850e+02 7.61389257e+01 6.51208533e+01
 9.99179087e+00 1.41986654e+01 2.69186513e+01 2.98576070e+01
 3.79853595e-01 1.22243902e+00 1.10977232e+00 2.73174678e+00
 2.85995276e+00 5.55628059e+00 7.11382167e+00 3.38932418e+01
 2.31710125e+01 1.48308368e+02 9.97863721e+01 9.20075432e+02
 2.66398663e-01 5.58340901e-01 2.44209552e+00 8.90610276e+00
 8.34486594e-01 2.32679755e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99958708832008
cond(S) = 3349.043695368123
E1 = -183.5897084206108  E_coul = 55.08024643728484
init E= -128.509461983326
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77539727430793  LUMO = 0.687095166818566
  mo_energy =
[-3.25550554e+01 -1.85259491e+00 -7.75397274e-01 -7.75397274e-01
 -7.75397274e-01  6.87095167e-01  8.25075437e-01  8.25075437e-01
  8.25075437e-01  2.99000630e+00  3.95945407e+00  3.95945407e+00
  3.95945407e+00  9.49628549e+00  1.43628118e+01  1.43628118e+01
  1.43628118e+01  3.66035265e+01  5.30110528e+01  5.30110528e+01
  5.30110528e+01  1.39960637e+02  2.40838408e+02  2.40838408e+02
  2.40838408e+02  5.02883285e+02  1.86954976e+03  7.99902795e+03
  4.77668620e+04]
E1 = -182.08820031118435  E_coul = 53.550345366503144
cycle= 1 E= -128.537854944681  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520473
diis-c [-0.27089233  1.        ]
  HOMO = -0.884085513456284  LUMO = 0.664638107530014
  mo_energy =
[-3.28777897e+01 -1.96635770e+00 -8.84085513e-01 -8.84085513e-01
 -8.84085513e-01  6.64638108e-01  7.98369558e-01  7.98369558e-01
  7.98369558e-01  2.93579492e+00  3.86214089e+00  3.86214089e+00
  3.86214089e+00  9.36742881e+00  1.41723733e+01  1.41723733e+01
  1.41723733e+01  3.63594319e+01  5.27305002e+01  5.27305002e+01
  5.27305002e+01  1.39643879e+02  2.40492559e+02  2.40492559e+02
  2.40492559e+02  5.02522319e+02  1.86915271e+03  7.99860188e+03
  4.77664171e+04]
E1 = -182.8485740718242  E_coul = 54.30813733698168
cycle= 2 E= -128.540436734843  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0666
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264252
diis-c [-6.43985912e-04  3.35976394e-01  6.64023606e-01]
  HOMO = -0.848503927110638  LUMO = 0.671843808654132
  mo_energy =
[-3.27698161e+01 -1.92888337e+00 -8.48503927e-01 -8.48503927e-01
 -8.48503927e-01  6.71843809e-01  8.07098639e-01  8.07098639e-01
  8.07098639e-01  2.95327463e+00  3.89373038e+00  3.89373038e+00
  3.89373038e+00  9.40964957e+00  1.42354889e+01  1.42354889e+01
  1.42354889e+01  3.64411976e+01  5.28244074e+01  5.28244074e+01
  5.28244074e+01  1.39749599e+02  2.40606099e+02  2.40606099e+02
  2.40606099e+02  5.02638987e+02  1.86927465e+03  7.99872626e+03
  4.77665424e+04]
E1 = -182.59042438520694  E_coul = 54.04907065060649
cycle= 3 E= -128.5413537346  delta_E= -0.000917  |g|= 0.0005  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113726
diis-c [-1.61166244e-07 -2.26314226e-03 -4.24955462e-04  1.00268810e+00]
  HOMO = -0.848758062150189  LUMO = 0.671802527626101
  mo_energy =
[-3.27702783e+01 -1.92907837e+00 -8.48758062e-01 -8.48758062e-01
 -8.48758062e-01  6.71802528e-01  8.07060294e-01  8.07060294e-01
  8.07060294e-01  2.95317764e+00  3.89355498e+00  3.89355498e+00
  3.89355498e+00  9.40943312e+00  1.42351841e+01  1.42351841e+01
  1.42351841e+01  3.64408427e+01  5.28239999e+01  5.28239999e+01
  5.28239999e+01  1.39749135e+02  2.40605565e+02  2.40605565e+02
  2.40605565e+02  5.02638397e+02  1.86927393e+03  7.99872544e+03
  4.77665415e+04]
E1 = -182.59090469668473  E_coul = 54.04955093820775
cycle= 4 E= -128.541353758477  delta_E= -2.39e-08  |g|= 7.61e-05  |ddm|= 0.000957
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176887
diis-c [-9.89734050e-10  2.24992056e-04  4.58866907e-04 -1.77446141e-01
  1.17676228e+00]
  HOMO = -0.848799084520007  LUMO = 0.671792320741725
  mo_energy =
[-3.27703484e+01 -1.92911016e+00 -8.48799085e-01 -8.48799085e-01
 -8.48799085e-01  6.71792321e-01  8.07047475e-01  8.07047475e-01
  8.07047475e-01  2.95315614e+00  3.89351669e+00  3.89351669e+00
  3.89351669e+00  9.40939020e+00  1.42351272e+01  1.42351272e+01
  1.42351272e+01  3.64407808e+01  5.28239336e+01  5.28239336e+01
  5.28239336e+01  1.39749065e+02  2.40605491e+02  2.40605491e+02
  2.40605491e+02  5.02638319e+02  1.86927384e+03  7.99872535e+03
  4.77665414e+04]
E1 = -182.59103264014144  E_coul = 54.049678881030665
cycle= 5 E= -128.541353759111  delta_E= -6.34e-10  |g|= 5.4e-06  |ddm|= 0.000183
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59103264014144  E_coul = 54.049678881030665
  HOMO = -0.848796291387813  LUMO = 0.671793251940588
  mo_energy =
[-3.27703420e+01 -1.92910661e+00 -8.48796291e-01 -8.48796291e-01
 -8.48796291e-01  6.71793252e-01  8.07048278e-01  8.07048278e-01
  8.07048278e-01  2.95315795e+00  3.89351936e+00  3.89351936e+00
  3.89351936e+00  9.40939382e+00  1.42351319e+01  1.42351319e+01
  1.42351319e+01  3.64407865e+01  5.28239397e+01  5.28239397e+01
  5.28239397e+01  1.39749071e+02  2.40605497e+02  2.40605497e+02
  2.40605497e+02  5.02638325e+02  1.86927385e+03  7.99872536e+03
  4.77665414e+04]
E1 = -182.5910175425271  E_coul = 54.04966378341429
Extra cycle  E= -128.541353759113  delta_E= -2.07e-12  |g|= 2.11e-06  |ddm|= 3.11e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3349.043695368123
E1 = -182.5910175425271  E_coul = 54.04966378341429
init E= -128.541353759113
    CPU time for initialize scf      0.58 sec, wall time      0.59 sec
  HOMO = -0.848797365670043  LUMO = 0.671793094327247
  mo_energy =
[-3.27703453e+01 -1.92910761e+00 -8.48797366e-01 -8.48797366e-01
 -8.48797366e-01  6.71793094e-01  8.07048028e-01  8.07048028e-01
  8.07048028e-01  2.95315750e+00  3.89351843e+00  3.89351843e+00
  3.89351843e+00  9.40939260e+00  1.42351300e+01  1.42351300e+01
  1.42351300e+01  3.64407840e+01  5.28239368e+01  5.28239368e+01
  5.28239368e+01  1.39749068e+02  2.40605494e+02  2.40605494e+02
  2.40605494e+02  5.02638321e+02  1.86927385e+03  7.99872535e+03
  4.77665414e+04]
E1 = -182.59102579206888  E_coul = 54.04967203295571
cycle= 1 E= -128.541353759113  delta_E= -3.41e-13  |g|= 1.13e-06  |ddm|= 7.45e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59102579206888  E_coul = 54.04967203295571
  HOMO = -0.848796785960392  LUMO = 0.671793223860952
  mo_energy =
[-3.27703435e+01 -1.92910697e+00 -8.48796786e-01 -8.48796786e-01
 -8.48796786e-01  6.71793224e-01  8.07048173e-01  8.07048173e-01
  8.07048173e-01  2.95315780e+00  3.89351895e+00  3.89351895e+00
  3.89351895e+00  9.40939331e+00  1.42351310e+01  1.42351310e+01
  1.42351310e+01  3.64407853e+01  5.28239383e+01  5.28239383e+01
  5.28239383e+01  1.39749070e+02  2.40605496e+02  2.40605496e+02
  2.40605496e+02  5.02638323e+02  1.86927385e+03  7.99872535e+03
  4.77665414e+04]
E1 = -182.5910216318148  E_coul = 54.04966787270149
Extra cycle  E= -128.541353759113  delta_E= -1.42e-13  |g|= 5.65e-07  |ddm|= 4.37e-07
    CPU time for scf_cycle      1.36 sec, wall time      1.38 sec
exp = [5.00000000e-01 2.44137942e+04 3.66145157e+03 8.33319262e+02
 2.35442498e+02 7.61389257e+01 9.99179087e+00 2.69186513e+01
 3.79853595e-01 1.10977232e+00 2.85995276e+00 7.11382167e+00
 2.31710125e+01 9.97863721e+01 2.66398663e-01 2.44209552e+00
 8.34486594e-01]
grad_E = [-9.03071149e-05 -1.10608977e-10  6.82326498e-09 -1.93798986e-07
  2.84335061e-06 -1.67010865e-05 -2.81733497e-04  9.68197418e-05
  1.46884221e-03 -4.54275305e-04  2.35546388e-04  2.01404164e-06
 -1.25097973e-07  3.05142985e-08 -4.07095908e-05 -1.26242875e-05
  3.36486792e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.500090307115       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157159        1
[INPUT] 0    0    [1    /1   ]  833.319261835        1
[INPUT] 0    0    [1    /1   ]  235.442494762        1
[INPUT] 0    0    [1    /1   ]  76.1389423871        1
[INPUT] 0    0    [1    /1   ]  9.99207259928        1
[INPUT] 0    0    [1    /1   ]  26.9185545022        1
[INPUT] 0    0    [1    /1   ]  0.378384752398       1
[INPUT] 0    0    [1    /1   ]  1.11022659533        1
[INPUT] 0    0    [1    /1   ]  2.85971721726        1
[INPUT] 1    0    [1    /1   ]  7.11381965466        1
[INPUT] 1    0    [1    /1   ]  23.1710126314        1
[INPUT] 1    0    [1    /1   ]  99.7863720795        1
[INPUT] 1    0    [1    /1   ]  0.266439372291       1
[INPUT] 1    0    [1    /1   ]  2.44210814761        1
[INPUT] 1    0    [1    /1   ]  0.834452945053       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5000903071149156, 1.0]], [0, [24413.794186547675, 1.0]], [0, [3661.451571586534, 1.0]], [0, [833.3192618353731, 1.0]], [0, [235.44249476169685, 1.0]], [0, [76.13894238706165, 1.0]], [0, [9.992072599282817, 1.0]], [0, [26.918554502196, 1.0]], [0, [0.37838475239799846, 1.0]], [0, [1.1102265953258847, 1.0]], [0, [2.859717217257485, 1.0]], [1, [7.113819654657579, 1.0]], [1, [23.17101263137137, 1.0]], [1, [99.7863720795496, 1.0]], [1, [0.266439372290695, 1.0]], [1, [2.4421081476059356, 1.0]], [1, [0.8344529450527497, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50009031]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157159]
bas 3, expnt(s) = [833.31926184]
bas 4, expnt(s) = [235.44249476]
bas 5, expnt(s) = [76.13894239]
bas 6, expnt(s) = [9.9920726]
bas 7, expnt(s) = [26.9185545]
bas 8, expnt(s) = [0.37838475]
bas 9, expnt(s) = [1.1102266]
bas 10, expnt(s) = [2.85971722]
bas 11, expnt(s) = [7.11381965]
bas 12, expnt(s) = [23.17101263]
bas 13, expnt(s) = [99.78637208]
bas 14, expnt(s) = [0.26643937]
bas 15, expnt(s) = [2.44210815]
bas 16, expnt(s) = [0.83445295]
CPU time:         7.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00090307e-01 1.50245458e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319262e+02 3.91853373e+02
 2.35442495e+02 1.51854848e+02 7.61389424e+01 6.51208640e+01
 9.99207260e+00 1.41989657e+01 2.69185545e+01 2.98575264e+01
 3.78384752e-01 1.21889205e+00 1.11022660e+00 2.73258540e+00
 2.85971722e+00 5.55593737e+00 7.11381965e+00 3.38932298e+01
 2.31710126e+01 1.48308369e+02 9.97863721e+01 9.20075432e+02
 2.66439372e-01 5.58447556e-01 2.44210815e+00 8.90616031e+00
 8.34452945e-01 2.32668027e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999587632579397
cond(S) = 3257.2617197845766
E1 = -183.5897121607081  E_coul = 55.080246909378026
init E= -128.50946525133
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775397289434407  LUMO = 0.68555634121431
  mo_energy =
[-3.25550552e+01 -1.85259623e+00 -7.75397289e-01 -7.75397289e-01
 -7.75397289e-01  6.85556341e-01  8.25174723e-01  8.25174723e-01
  8.25174723e-01  2.98611125e+00  3.95952943e+00  3.95952943e+00
  3.95952943e+00  9.49140793e+00  1.43628603e+01  1.43628603e+01
  1.43628603e+01  3.65990282e+01  5.30110913e+01  5.30110913e+01
  5.30110913e+01  1.39956976e+02  2.40838434e+02  2.40838434e+02
  2.40838434e+02  5.02880103e+02  1.86954694e+03  7.99902547e+03
  4.77668599e+04]
E1 = -182.08824201640311  E_coul = 53.55038450219081
cycle= 1 E= -128.537857514212  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520488
diis-c [-0.27090763  1.        ]
  HOMO = -0.884082641692396  LUMO = 0.663147099071153
  mo_energy =
[-3.28777843e+01 -1.96635339e+00 -8.84082642e-01 -8.84082642e-01
 -8.84082642e-01  6.63147099e-01  7.98468327e-01  7.98468327e-01
  7.98468327e-01  2.93192347e+00  3.86222189e+00  3.86222189e+00
  3.86222189e+00  9.36255092e+00  1.41724266e+01  1.41724266e+01
  1.41724266e+01  3.63549333e+01  5.27305436e+01  5.27305436e+01
  5.27305436e+01  1.39640222e+02  2.40492590e+02  2.40492590e+02
  2.40492590e+02  5.02519141e+02  1.86914989e+03  7.99859941e+03
  4.77664150e+04]
E1 = -182.8486038255482  E_coul = 54.30816453318255
cycle= 2 E= -128.540439292366  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264258
diis-c [-6.43984929e-04  3.35974903e-01  6.64025097e-01]
  HOMO = -0.848501532038921  LUMO = 0.670338292288468
  mo_energy =
[-3.27698121e+01 -1.92887966e+00 -8.48501532e-01 -8.48501532e-01
 -8.48501532e-01  6.70338292e-01  8.07197946e-01  8.07197946e-01
  8.07197946e-01  2.94939629e+00  3.89381048e+00  3.89381048e+00
  3.89381048e+00  9.40477262e+00  1.42355412e+01  1.42355412e+01
  1.42355412e+01  3.64366997e+01  5.28244496e+01  5.28244496e+01
  5.28244496e+01  1.39745941e+02  2.40606129e+02  2.40606129e+02
  2.40606129e+02  5.02635808e+02  1.86927183e+03  7.99872379e+03
  4.77665403e+04]
E1 = -182.59046496942852  E_coul = 54.04910872401891
cycle= 3 E= -128.54135624541  delta_E= -0.000917  |g|= 0.0005  |ddm|= 0.0245
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00113649
diis-c [-1.62069481e-07 -2.26325173e-03 -4.30076988e-04  1.00269333e+00]
  HOMO = -0.84875532577405  LUMO = 0.670297306932382
  mo_energy =
[-3.27702736e+01 -1.92907410e+00 -8.48755326e-01 -8.48755326e-01
 -8.48755326e-01  6.70297307e-01  8.07159733e-01  8.07159733e-01
  8.07159733e-01  2.94929966e+00  3.89363547e+00  3.89363547e+00
  3.89363547e+00  9.40455665e+00  1.42352370e+01  1.42352370e+01
  1.42352370e+01  3.64363453e+01  5.28240427e+01  5.28240427e+01
  5.28240427e+01  1.39745478e+02  2.40605596e+02  2.40605596e+02
  2.40605596e+02  5.02635218e+02  1.86927111e+03  7.99872297e+03
  4.77665395e+04]
E1 = -182.59094455890815  E_coul = 54.049588289631174
cycle= 4 E= -128.541356269277  delta_E= -2.39e-08  |g|= 7.61e-05  |ddm|= 0.000936
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000176942
diis-c [-9.94955131e-10  2.25997742e-04  4.59504105e-04 -1.77992226e-01
  1.17730672e+00]
  HOMO = -0.848796330095414  LUMO = 0.670287149910524
  mo_energy =
[-3.27703437e+01 -1.92910580e+00 -8.48796330e-01 -8.48796330e-01
 -8.48796330e-01  6.70287150e-01  8.07146923e-01  8.07146923e-01
  8.07146923e-01  2.94927821e+00  3.89359721e+00  3.89359721e+00
  3.89359721e+00  9.40451379e+00  1.42351801e+01  1.42351801e+01
  1.42351801e+01  3.64362835e+01  5.28239765e+01  5.28239765e+01
  5.28239765e+01  1.39745407e+02  2.40605521e+02  2.40605521e+02
  2.40605521e+02  5.02635140e+02  1.86927102e+03  7.99872288e+03
  4.77665394e+04]
E1 = -182.5910725197609  E_coul = 54.04971624984857
cycle= 5 E= -128.541356269912  delta_E= -6.35e-10  |g|= 5.42e-06  |ddm|= 0.000179
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5910725197609  E_coul = 54.04971624984857
  HOMO = -0.848793518448967  LUMO = 0.67028808515554
  mo_energy =
[-3.27703372e+01 -1.92910224e+00 -8.48793518e-01 -8.48793518e-01
 -8.48793518e-01  6.70288085e-01  8.07147732e-01  8.07147732e-01
  8.07147732e-01  2.94928003e+00  3.89359990e+00  3.89359990e+00
  3.89359990e+00  9.40451742e+00  1.42351848e+01  1.42351848e+01
  1.42351848e+01  3.64362892e+01  5.28239826e+01  5.28239826e+01
  5.28239826e+01  1.39745414e+02  2.40605528e+02  2.40605528e+02
  2.40605528e+02  5.02635146e+02  1.86927103e+03  7.99872288e+03
  4.77665394e+04]
E1 = -182.5910573460769  E_coul = 54.04970107616285
Extra cycle  E= -128.541356269914  delta_E= -1.71e-12  |g|= 2.12e-06  |ddm|= 3.01e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [5.00090307e-01 2.44137942e+04 3.66145157e+03 8.33319262e+02
 2.35442495e+02 7.61389424e+01 9.99207260e+00 2.69185545e+01
 3.78384752e-01 1.11022660e+00 2.85971722e+00 7.11381965e+00
 2.31710126e+01 9.97863721e+01 2.66439372e-01 2.44210815e+00
 8.34452945e-01]
E = -128.54135626991405
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.500090307115       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157159        1
[INPUT] 0    0    [1    /1   ]  833.319261835        1
[INPUT] 0    0    [1    /1   ]  235.442494762        1
[INPUT] 0    0    [1    /1   ]  76.1389423871        1
[INPUT] 0    0    [1    /1   ]  9.99207259928        1
[INPUT] 0    0    [1    /1   ]  26.9185545022        1
[INPUT] 0    0    [1    /1   ]  0.378384752398       1
[INPUT] 0    0    [1    /1   ]  1.11022659533        1
[INPUT] 0    0    [1    /1   ]  2.85971721726        1
[INPUT] 1    0    [1    /1   ]  7.11381965466        1
[INPUT] 1    0    [1    /1   ]  23.1710126314        1
[INPUT] 1    0    [1    /1   ]  99.7863720795        1
[INPUT] 1    0    [1    /1   ]  0.266439372291       1
[INPUT] 1    0    [1    /1   ]  2.44210814761        1
[INPUT] 1    0    [1    /1   ]  0.834452945053       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5000903071149156, 1.0]], [0, [24413.794186547675, 1.0]], [0, [3661.451571586534, 1.0]], [0, [833.3192618353731, 1.0]], [0, [235.44249476169685, 1.0]], [0, [76.13894238706165, 1.0]], [0, [9.992072599282817, 1.0]], [0, [26.918554502196, 1.0]], [0, [0.37838475239799846, 1.0]], [0, [1.1102265953258847, 1.0]], [0, [2.859717217257485, 1.0]], [1, [7.113819654657579, 1.0]], [1, [23.17101263137137, 1.0]], [1, [99.7863720795496, 1.0]], [1, [0.266439372290695, 1.0]], [1, [2.4421081476059356, 1.0]], [1, [0.8344529450527497, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50009031]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157159]
bas 3, expnt(s) = [833.31926184]
bas 4, expnt(s) = [235.44249476]
bas 5, expnt(s) = [76.13894239]
bas 6, expnt(s) = [9.9920726]
bas 7, expnt(s) = [26.9185545]
bas 8, expnt(s) = [0.37838475]
bas 9, expnt(s) = [1.1102266]
bas 10, expnt(s) = [2.85971722]
bas 11, expnt(s) = [7.11381965]
bas 12, expnt(s) = [23.17101263]
bas 13, expnt(s) = [99.78637208]
bas 14, expnt(s) = [0.26643937]
bas 15, expnt(s) = [2.44210815]
bas 16, expnt(s) = [0.83445295]
CPU time:         7.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00090307e-01 1.50245458e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319262e+02 3.91853373e+02
 2.35442495e+02 1.51854848e+02 7.61389424e+01 6.51208640e+01
 9.99207260e+00 1.41989657e+01 2.69185545e+01 2.98575264e+01
 3.78384752e-01 1.21889205e+00 1.11022660e+00 2.73258540e+00
 2.85971722e+00 5.55593737e+00 7.11381965e+00 3.38932298e+01
 2.31710126e+01 1.48308369e+02 9.97863721e+01 9.20075432e+02
 2.66439372e-01 5.58447556e-01 2.44210815e+00 8.90616031e+00
 8.34452945e-01 2.32668027e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999587632579397
cond(S) = 3257.2617197845766
E1 = -183.5897121607081  E_coul = 55.080246909378026
init E= -128.50946525133
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775397289434407  LUMO = 0.68555634121431
  mo_energy =
[-3.25550552e+01 -1.85259623e+00 -7.75397289e-01 -7.75397289e-01
 -7.75397289e-01  6.85556341e-01  8.25174723e-01  8.25174723e-01
  8.25174723e-01  2.98611125e+00  3.95952943e+00  3.95952943e+00
  3.95952943e+00  9.49140793e+00  1.43628603e+01  1.43628603e+01
  1.43628603e+01  3.65990282e+01  5.30110913e+01  5.30110913e+01
  5.30110913e+01  1.39956976e+02  2.40838434e+02  2.40838434e+02
  2.40838434e+02  5.02880103e+02  1.86954694e+03  7.99902547e+03
  4.77668599e+04]
E1 = -182.08824201640311  E_coul = 53.55038450219081
cycle= 1 E= -128.537857514212  delta_E= -0.0284  |g|= 0.204  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520488
diis-c [-0.27090763  1.        ]
  HOMO = -0.884082641692396  LUMO = 0.663147099071153
  mo_energy =
[-3.28777843e+01 -1.96635339e+00 -8.84082642e-01 -8.84082642e-01
 -8.84082642e-01  6.63147099e-01  7.98468327e-01  7.98468327e-01
  7.98468327e-01  2.93192347e+00  3.86222189e+00  3.86222189e+00
  3.86222189e+00  9.36255092e+00  1.41724266e+01  1.41724266e+01
  1.41724266e+01  3.63549333e+01  5.27305436e+01  5.27305436e+01
  5.27305436e+01  1.39640222e+02  2.40492590e+02  2.40492590e+02
  2.40492590e+02  5.02519141e+02  1.86914989e+03  7.99859941e+03
  4.77664150e+04]
E1 = -182.8486038255482  E_coul = 54.30816453318255
cycle= 2 E= -128.540439292366  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0663
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264258
diis-c [-6.43984929e-04  3.35974903e-01  6.64025097e-01]
  HOMO = -0.848501532038921  LUMO = 0.670338292288468
  mo_energy =
[-3.27698121e+01 -1.92887966e+00 -8.48501532e-01 -8.48501532e-01
 -8.48501532e-01  6.70338292e-01  8.07197946e-01  8.07197946e-01
  8.07197946e-01  2.94939629e+00  3.89381048e+00  3.89381048e+00
  3.89381048e+00  9.40477262e+00  1.42355412e+01  1.42355412e+01
  1.42355412e+01  3.64366997e+01  5.28244496e+01  5.28244496e+01
  5.28244496e+01  1.39745941e+02  2.40606129e+02  2.40606129e+02
  2.40606129e+02  5.02635808e+02  1.86927183e+03  7.99872379e+03
  4.77665403e+04]
E1 = -182.59046496942852  E_coul = 54.04910872401891
cycle= 3 E= -128.54135624541  delta_E= -0.000917  |g|= 0.0005  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113649
diis-c [-1.62069481e-07 -2.26325173e-03 -4.30076988e-04  1.00269333e+00]
  HOMO = -0.84875532577405  LUMO = 0.670297306932382
  mo_energy =
[-3.27702736e+01 -1.92907410e+00 -8.48755326e-01 -8.48755326e-01
 -8.48755326e-01  6.70297307e-01  8.07159733e-01  8.07159733e-01
  8.07159733e-01  2.94929966e+00  3.89363547e+00  3.89363547e+00
  3.89363547e+00  9.40455665e+00  1.42352370e+01  1.42352370e+01
  1.42352370e+01  3.64363453e+01  5.28240427e+01  5.28240427e+01
  5.28240427e+01  1.39745478e+02  2.40605596e+02  2.40605596e+02
  2.40605596e+02  5.02635218e+02  1.86927111e+03  7.99872297e+03
  4.77665395e+04]
E1 = -182.59094455890815  E_coul = 54.049588289631174
cycle= 4 E= -128.541356269277  delta_E= -2.39e-08  |g|= 7.61e-05  |ddm|= 0.000936
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176942
diis-c [-9.94955131e-10  2.25997742e-04  4.59504105e-04 -1.77992226e-01
  1.17730672e+00]
  HOMO = -0.848796330095414  LUMO = 0.670287149910524
  mo_energy =
[-3.27703437e+01 -1.92910580e+00 -8.48796330e-01 -8.48796330e-01
 -8.48796330e-01  6.70287150e-01  8.07146923e-01  8.07146923e-01
  8.07146923e-01  2.94927821e+00  3.89359721e+00  3.89359721e+00
  3.89359721e+00  9.40451379e+00  1.42351801e+01  1.42351801e+01
  1.42351801e+01  3.64362835e+01  5.28239765e+01  5.28239765e+01
  5.28239765e+01  1.39745407e+02  2.40605521e+02  2.40605521e+02
  2.40605521e+02  5.02635140e+02  1.86927102e+03  7.99872288e+03
  4.77665394e+04]
E1 = -182.5910725197609  E_coul = 54.04971624984857
cycle= 5 E= -128.541356269912  delta_E= -6.35e-10  |g|= 5.42e-06  |ddm|= 0.000179
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5910725197609  E_coul = 54.04971624984857
  HOMO = -0.848793518448967  LUMO = 0.67028808515554
  mo_energy =
[-3.27703372e+01 -1.92910224e+00 -8.48793518e-01 -8.48793518e-01
 -8.48793518e-01  6.70288085e-01  8.07147732e-01  8.07147732e-01
  8.07147732e-01  2.94928003e+00  3.89359990e+00  3.89359990e+00
  3.89359990e+00  9.40451742e+00  1.42351848e+01  1.42351848e+01
  1.42351848e+01  3.64362892e+01  5.28239826e+01  5.28239826e+01
  5.28239826e+01  1.39745414e+02  2.40605528e+02  2.40605528e+02
  2.40605528e+02  5.02635146e+02  1.86927103e+03  7.99872288e+03
  4.77665394e+04]
E1 = -182.5910573460769  E_coul = 54.04970107616285
Extra cycle  E= -128.541356269914  delta_E= -1.71e-12  |g|= 2.12e-06  |ddm|= 3.01e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3257.2617197845766
E1 = -182.5910573460769  E_coul = 54.04970107616285
init E= -128.541356269914
    CPU time for initialize scf      0.33 sec, wall time      0.33 sec
  HOMO = -0.848794597860436  LUMO = 0.670287927122052
  mo_energy =
[-3.27703406e+01 -1.92910324e+00 -8.48794598e-01 -8.48794598e-01
 -8.48794598e-01  6.70287927e-01  8.07147481e-01  8.07147481e-01
  8.07147481e-01  2.94927957e+00  3.89359896e+00  3.89359896e+00
  3.89359896e+00  9.40451620e+00  1.42351829e+01  1.42351829e+01
  1.42351829e+01  3.64362867e+01  5.28239797e+01  5.28239797e+01
  5.28239797e+01  1.39745410e+02  2.40605524e+02  2.40605524e+02
  2.40605524e+02  5.02635143e+02  1.86927102e+03  7.99872288e+03
  4.77665394e+04]
E1 = -182.59106563964914  E_coul = 54.049709369734614
cycle= 1 E= -128.541356269915  delta_E= -4.83e-13  |g|= 1.14e-06  |ddm|= 7.49e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59106563964914  E_coul = 54.049709369734614
  HOMO = -0.848794015010426  LUMO = 0.670288057071721
  mo_energy =
[-3.27703388e+01 -1.92910260e+00 -8.48794015e-01 -8.48794015e-01
 -8.48794015e-01  6.70288057e-01  8.07147627e-01  8.07147627e-01
  8.07147627e-01  2.94927987e+00  3.89359949e+00  3.89359949e+00
  3.89359949e+00  9.40451691e+00  1.42351839e+01  1.42351839e+01
  1.42351839e+01  3.64362881e+01  5.28239812e+01  5.28239812e+01
  5.28239812e+01  1.39745412e+02  2.40605526e+02  2.40605526e+02
  2.40605526e+02  5.02635145e+02  1.86927103e+03  7.99872288e+03
  4.77665394e+04]
E1 = -182.59106145752278  E_coul = 54.04970518760798
Extra cycle  E= -128.541356269915  delta_E= -2.84e-13  |g|= 5.68e-07  |ddm|= 4.34e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [5.00090307e-01 2.44137942e+04 3.66145157e+03 8.33319262e+02
 2.35442495e+02 7.61389424e+01 9.99207260e+00 2.69185545e+01
 3.78384752e-01 1.11022660e+00 2.85971722e+00 7.11381965e+00
 2.31710126e+01 9.97863721e+01 2.66439372e-01 2.44210815e+00
 8.34452945e-01]
grad_E = [-1.03321931e-04 -1.07418399e-10  6.65565859e-09 -1.90435148e-07
  2.80315351e-06 -1.63914136e-05 -2.78598724e-04  9.53741764e-05
  1.46219070e-03 -4.67711212e-04  2.36692550e-04 -3.73620620e-06
  3.64172887e-07  1.44542095e-08  1.92023603e-04  2.24591944e-05
 -9.25560450e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.500658633415       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157155        1
[INPUT] 0    0    [1    /1   ]  833.319262899        1
[INPUT] 0    0    [1    /1   ]  235.442479118        1
[INPUT] 0    0    [1    /1   ]  76.1390339084        1
[INPUT] 0    0    [1    /1   ]  9.99362693469        1
[INPUT] 0    0    [1    /1   ]  26.918022185         1
[INPUT] 0    0    [1    /1   ]  0.370232629369       1
[INPUT] 0    0    [1    /1   ]  1.1128253036         1
[INPUT] 0    0    [1    /1   ]  2.85839886293        1
[INPUT] 1    0    [1    /1   ]  7.1138371823         1
[INPUT] 1    0    [1    /1   ]  23.1710108821        1
[INPUT] 1    0    [1    /1   ]  99.7863719898        1
[INPUT] 1    0    [1    /1   ]  0.265502567648       1
[INPUT] 1    0    [1    /1   ]  2.44200308125        1
[INPUT] 1    0    [1    /1   ]  0.834896455513       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5006586334151609, 1.0]], [0, [24413.794186548275, 1.0]], [0, [3661.4515715493485, 1.0]], [0, [833.3192628985328, 1.0]], [0, [235.44247911761286, 1.0]], [0, [76.13903390842832, 1.0]], [0, [9.993626934693882, 1.0]], [0, [26.918022185046855, 1.0]], [0, [0.3702326293692778, 1.0]], [0, [1.1128253035991251, 1.0]], [0, [2.8583988629264976, 1.0]], [1, [7.1138371822968285, 1.0]], [1, [23.171010882147442, 1.0]], [1, [99.78637198980377, 1.0]], [1, [0.26550256764848623, 1.0]], [1, [2.4420030812506517, 1.0]], [1, [0.8348964555129555, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50065863]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157155]
bas 3, expnt(s) = [833.3192629]
bas 4, expnt(s) = [235.44247912]
bas 5, expnt(s) = [76.13903391]
bas 6, expnt(s) = [9.99362693]
bas 7, expnt(s) = [26.91802219]
bas 8, expnt(s) = [0.37023263]
bas 9, expnt(s) = [1.1128253]
bas 10, expnt(s) = [2.85839886]
bas 11, expnt(s) = [7.11383718]
bas 12, expnt(s) = [23.17101088]
bas 13, expnt(s) = [99.78637199]
bas 14, expnt(s) = [0.26550257]
bas 15, expnt(s) = [2.44200308]
bas 16, expnt(s) = [0.83489646]
CPU time:        10.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00658633e-01 1.50373499e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319263e+02 3.91853374e+02
 2.35442479e+02 1.51854841e+02 7.61390339e+01 6.51209227e+01
 9.99362693e+00 1.42006222e+01 2.69180222e+01 2.98570836e+01
 3.70232629e-01 1.19914318e+00 1.11282530e+00 2.73738113e+00
 2.85839886e+00 5.55401626e+00 7.11383718e+00 3.38933342e+01
 2.31710109e+01 1.48308355e+02 9.97863720e+01 9.20075431e+02
 2.65502568e-01 5.55994249e-01 2.44200308e+00 8.90568135e+00
 8.34896456e-01 2.32822616e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999592279820817
cond(S) = 2810.377424409141
E1 = -183.58967067776823  E_coul = 55.08023017353352
init E= -128.509440504235
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775399412451306  LUMO = 0.67693650297071
  mo_energy =
[-3.25550542e+01 -1.85260679e+00 -7.75399412e-01 -7.75399412e-01
 -7.75399412e-01  6.76936503e-01  8.22778720e-01  8.22778720e-01
  8.22778720e-01  2.96454796e+00  3.95705553e+00  3.95705553e+00
  3.95705553e+00  9.46474563e+00  1.43610428e+01  1.43610428e+01
  1.43610428e+01  3.65746361e+01  5.30097363e+01  5.30097363e+01
  5.30097363e+01  1.39937178e+02  2.40837524e+02  2.40837524e+02
  2.40837524e+02  5.02862900e+02  1.86953167e+03  7.99901208e+03
  4.77668489e+04]
E1 = -182.08624471235478  E_coul = 53.54838211862139
cycle= 1 E= -128.537862593733  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520755
diis-c [-0.27118613  1.        ]
  HOMO = -0.884252227012398  LUMO = 0.654686907260735
  mo_energy =
[-3.28780959e+01 -1.96654207e+00 -8.84252227e-01 -8.84252227e-01
 -8.84252227e-01  6.54686907e-01  7.96054757e-01  7.96054757e-01
  7.96054757e-01  2.91035057e+00  3.85955054e+00  3.85955054e+00
  3.85955054e+00  9.33566728e+00  1.41703562e+01  1.41703562e+01
  1.41703562e+01  3.63302348e+01  5.27288926e+01  5.27288926e+01
  5.27288926e+01  1.39620106e+02  2.40491370e+02  2.40491370e+02
  2.40491370e+02  5.02501620e+02  1.86913430e+03  7.99858569e+03
  4.77664036e+04]
E1 = -182.84748773494957  E_coul = 54.3070395242508
cycle= 2 E= -128.540448210699  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264498
diis-c [-6.44884778e-04  3.36063165e-01  6.63936835e-01]
  HOMO = -0.848633665010907  LUMO = 0.66180709440005
  mo_energy =
[-3.27700167e+01 -1.92902861e+00 -8.48633665e-01 -8.48633665e-01
 -8.48633665e-01  6.61807094e-01  8.04776534e-01  8.04776534e-01
  8.04776534e-01  2.92780747e+00  3.89118014e+00  3.89118014e+00
  3.89118014e+00  9.37794386e+00  1.42335391e+01  1.42335391e+01
  1.42335391e+01  3.64120944e+01  5.28228936e+01  5.28228936e+01
  5.28228936e+01  1.39725933e+02  2.40605020e+02  2.40605020e+02
  2.40605020e+02  5.02618400e+02  1.86925636e+03  7.99871019e+03
  4.77665290e+04]
E1 = -182.58887656909158  E_coul = 54.047508806436674
cycle= 3 E= -128.541367762655  delta_E= -0.00092  |g|= 0.000515  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011566
diis-c [-1.65302314e-07 -2.29674752e-03 -4.21971436e-04  1.00271872e+00]
  HOMO = -0.848895723809585  LUMO = 0.661762255861984
  mo_energy =
[-3.27704899e+01 -1.92923253e+00 -8.48895724e-01 -8.48895724e-01
 -8.48895724e-01  6.61762256e-01  8.04735001e-01  8.04735001e-01
  8.04735001e-01  2.92770482e+00  3.89099660e+00  3.89099660e+00
  3.89099660e+00  9.37771822e+00  1.42332238e+01  1.42332238e+01
  1.42332238e+01  3.64117287e+01  5.28224751e+01  5.28224751e+01
  5.28224751e+01  1.39725457e+02  2.40604475e+02  2.40604475e+02
  2.40604475e+02  5.02617799e+02  1.86925563e+03  7.99870936e+03
  4.77665282e+04]
E1 = -182.58936046133198  E_coul = 54.04799267331713
cycle= 4 E= -128.541367788015  delta_E= -2.54e-08  |g|= 7.79e-05  |ddm|= 0.000866
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179028
diis-c [-9.63962501e-10  2.19211503e-04  4.55686206e-04 -1.74515520e-01
  1.17384062e+00]
  HOMO = -0.848937940832544  LUMO = 0.661751507805541
  mo_energy =
[-3.27705616e+01 -1.92926582e+00 -8.48937941e-01 -8.48937941e-01
 -8.48937941e-01  6.61751508e-01  8.04721707e-01  8.04721707e-01
  8.04721707e-01  2.92768236e+00  3.89095704e+00  3.89095704e+00
  3.89095704e+00  9.37767381e+00  1.42331653e+01  1.42331653e+01
  1.42331653e+01  3.64116652e+01  5.28224072e+01  5.28224072e+01
  5.28224072e+01  1.39725386e+02  2.40604400e+02  2.40604400e+02
  2.40604400e+02  5.02617720e+02  1.86925554e+03  7.99870927e+03
  4.77665281e+04]
E1 = -182.58948882242254  E_coul = 54.04812103375241
cycle= 5 E= -128.54136778867  delta_E= -6.55e-10  |g|= 5.27e-06  |ddm|= 0.000163
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58948882242254  E_coul = 54.04812103375241
  HOMO = -0.848935229384957  LUMO = 0.661752406044842
  mo_energy =
[-3.27705553e+01 -1.92926236e+00 -8.48935229e-01 -8.48935229e-01
 -8.48935229e-01  6.61752406e-01  8.04722485e-01  8.04722485e-01
  8.04722485e-01  2.92768413e+00  3.89095963e+00  3.89095963e+00
  3.89095963e+00  9.37767732e+00  1.42331698e+01  1.42331698e+01
  1.42331698e+01  3.64116707e+01  5.28224131e+01  5.28224131e+01
  5.28224131e+01  1.39725392e+02  2.40604406e+02  2.40604406e+02
  2.40604406e+02  5.02617726e+02  1.86925555e+03  7.99870927e+03
  4.77665281e+04]
E1 = -182.58947405634024  E_coul = 54.048106267668366
Extra cycle  E= -128.541367788672  delta_E= -1.73e-12  |g|= 2.06e-06  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [5.00658633e-01 2.44137942e+04 3.66145157e+03 8.33319263e+02
 2.35442479e+02 7.61390339e+01 9.99362693e+00 2.69180222e+01
 3.70232629e-01 1.11282530e+00 2.85839886e+00 7.11383718e+00
 2.31710109e+01 9.97863720e+01 2.65502568e-01 2.44200308e+00
 8.34896456e-01]
E = -128.54136778867186
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.500658633415       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157155        1
[INPUT] 0    0    [1    /1   ]  833.319262899        1
[INPUT] 0    0    [1    /1   ]  235.442479118        1
[INPUT] 0    0    [1    /1   ]  76.1390339084        1
[INPUT] 0    0    [1    /1   ]  9.99362693469        1
[INPUT] 0    0    [1    /1   ]  26.918022185         1
[INPUT] 0    0    [1    /1   ]  0.370232629369       1
[INPUT] 0    0    [1    /1   ]  1.1128253036         1
[INPUT] 0    0    [1    /1   ]  2.85839886293        1
[INPUT] 1    0    [1    /1   ]  7.1138371823         1
[INPUT] 1    0    [1    /1   ]  23.1710108821        1
[INPUT] 1    0    [1    /1   ]  99.7863719898        1
[INPUT] 1    0    [1    /1   ]  0.265502567648       1
[INPUT] 1    0    [1    /1   ]  2.44200308125        1
[INPUT] 1    0    [1    /1   ]  0.834896455513       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5006586334151609, 1.0]], [0, [24413.794186548275, 1.0]], [0, [3661.4515715493485, 1.0]], [0, [833.3192628985328, 1.0]], [0, [235.44247911761286, 1.0]], [0, [76.13903390842832, 1.0]], [0, [9.993626934693882, 1.0]], [0, [26.918022185046855, 1.0]], [0, [0.3702326293692778, 1.0]], [0, [1.1128253035991251, 1.0]], [0, [2.8583988629264976, 1.0]], [1, [7.1138371822968285, 1.0]], [1, [23.171010882147442, 1.0]], [1, [99.78637198980377, 1.0]], [1, [0.26550256764848623, 1.0]], [1, [2.4420030812506517, 1.0]], [1, [0.8348964555129555, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50065863]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157155]
bas 3, expnt(s) = [833.3192629]
bas 4, expnt(s) = [235.44247912]
bas 5, expnt(s) = [76.13903391]
bas 6, expnt(s) = [9.99362693]
bas 7, expnt(s) = [26.91802219]
bas 8, expnt(s) = [0.37023263]
bas 9, expnt(s) = [1.1128253]
bas 10, expnt(s) = [2.85839886]
bas 11, expnt(s) = [7.11383718]
bas 12, expnt(s) = [23.17101088]
bas 13, expnt(s) = [99.78637199]
bas 14, expnt(s) = [0.26550257]
bas 15, expnt(s) = [2.44200308]
bas 16, expnt(s) = [0.83489646]
CPU time:        10.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.00658633e-01 1.50373499e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319263e+02 3.91853374e+02
 2.35442479e+02 1.51854841e+02 7.61390339e+01 6.51209227e+01
 9.99362693e+00 1.42006222e+01 2.69180222e+01 2.98570836e+01
 3.70232629e-01 1.19914318e+00 1.11282530e+00 2.73738113e+00
 2.85839886e+00 5.55401626e+00 7.11383718e+00 3.38933342e+01
 2.31710109e+01 1.48308355e+02 9.97863720e+01 9.20075431e+02
 2.65502568e-01 5.55994249e-01 2.44200308e+00 8.90568135e+00
 8.34896456e-01 2.32822616e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999592279820817
cond(S) = 2810.377424409141
E1 = -183.58967067776823  E_coul = 55.08023017353352
init E= -128.509440504235
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775399412451306  LUMO = 0.67693650297071
  mo_energy =
[-3.25550542e+01 -1.85260679e+00 -7.75399412e-01 -7.75399412e-01
 -7.75399412e-01  6.76936503e-01  8.22778720e-01  8.22778720e-01
  8.22778720e-01  2.96454796e+00  3.95705553e+00  3.95705553e+00
  3.95705553e+00  9.46474563e+00  1.43610428e+01  1.43610428e+01
  1.43610428e+01  3.65746361e+01  5.30097363e+01  5.30097363e+01
  5.30097363e+01  1.39937178e+02  2.40837524e+02  2.40837524e+02
  2.40837524e+02  5.02862900e+02  1.86953167e+03  7.99901208e+03
  4.77668489e+04]
E1 = -182.08624471235478  E_coul = 53.54838211862139
cycle= 1 E= -128.537862593733  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520755
diis-c [-0.27118613  1.        ]
  HOMO = -0.884252227012398  LUMO = 0.654686907260735
  mo_energy =
[-3.28780959e+01 -1.96654207e+00 -8.84252227e-01 -8.84252227e-01
 -8.84252227e-01  6.54686907e-01  7.96054757e-01  7.96054757e-01
  7.96054757e-01  2.91035057e+00  3.85955054e+00  3.85955054e+00
  3.85955054e+00  9.33566728e+00  1.41703562e+01  1.41703562e+01
  1.41703562e+01  3.63302348e+01  5.27288926e+01  5.27288926e+01
  5.27288926e+01  1.39620106e+02  2.40491370e+02  2.40491370e+02
  2.40491370e+02  5.02501620e+02  1.86913430e+03  7.99858569e+03
  4.77664036e+04]
E1 = -182.84748773494957  E_coul = 54.3070395242508
cycle= 2 E= -128.540448210699  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264498
diis-c [-6.44884778e-04  3.36063165e-01  6.63936835e-01]
  HOMO = -0.848633665010907  LUMO = 0.66180709440005
  mo_energy =
[-3.27700167e+01 -1.92902861e+00 -8.48633665e-01 -8.48633665e-01
 -8.48633665e-01  6.61807094e-01  8.04776534e-01  8.04776534e-01
  8.04776534e-01  2.92780747e+00  3.89118014e+00  3.89118014e+00
  3.89118014e+00  9.37794386e+00  1.42335391e+01  1.42335391e+01
  1.42335391e+01  3.64120944e+01  5.28228936e+01  5.28228936e+01
  5.28228936e+01  1.39725933e+02  2.40605020e+02  2.40605020e+02
  2.40605020e+02  5.02618400e+02  1.86925636e+03  7.99871019e+03
  4.77665290e+04]
E1 = -182.58887656909158  E_coul = 54.047508806436674
cycle= 3 E= -128.541367762655  delta_E= -0.00092  |g|= 0.000515  |ddm|= 0.0238
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011566
diis-c [-1.65302314e-07 -2.29674752e-03 -4.21971436e-04  1.00271872e+00]
  HOMO = -0.848895723809585  LUMO = 0.661762255861984
  mo_energy =
[-3.27704899e+01 -1.92923253e+00 -8.48895724e-01 -8.48895724e-01
 -8.48895724e-01  6.61762256e-01  8.04735001e-01  8.04735001e-01
  8.04735001e-01  2.92770482e+00  3.89099660e+00  3.89099660e+00
  3.89099660e+00  9.37771822e+00  1.42332238e+01  1.42332238e+01
  1.42332238e+01  3.64117287e+01  5.28224751e+01  5.28224751e+01
  5.28224751e+01  1.39725457e+02  2.40604475e+02  2.40604475e+02
  2.40604475e+02  5.02617799e+02  1.86925563e+03  7.99870936e+03
  4.77665282e+04]
E1 = -182.58936046133198  E_coul = 54.04799267331713
cycle= 4 E= -128.541367788015  delta_E= -2.54e-08  |g|= 7.79e-05  |ddm|= 0.000866
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179028
diis-c [-9.63962501e-10  2.19211503e-04  4.55686206e-04 -1.74515520e-01
  1.17384062e+00]
  HOMO = -0.848937940832544  LUMO = 0.661751507805541
  mo_energy =
[-3.27705616e+01 -1.92926582e+00 -8.48937941e-01 -8.48937941e-01
 -8.48937941e-01  6.61751508e-01  8.04721707e-01  8.04721707e-01
  8.04721707e-01  2.92768236e+00  3.89095704e+00  3.89095704e+00
  3.89095704e+00  9.37767381e+00  1.42331653e+01  1.42331653e+01
  1.42331653e+01  3.64116652e+01  5.28224072e+01  5.28224072e+01
  5.28224072e+01  1.39725386e+02  2.40604400e+02  2.40604400e+02
  2.40604400e+02  5.02617720e+02  1.86925554e+03  7.99870927e+03
  4.77665281e+04]
E1 = -182.58948882242254  E_coul = 54.04812103375241
cycle= 5 E= -128.54136778867  delta_E= -6.55e-10  |g|= 5.27e-06  |ddm|= 0.000163
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58948882242254  E_coul = 54.04812103375241
  HOMO = -0.848935229384957  LUMO = 0.661752406044842
  mo_energy =
[-3.27705553e+01 -1.92926236e+00 -8.48935229e-01 -8.48935229e-01
 -8.48935229e-01  6.61752406e-01  8.04722485e-01  8.04722485e-01
  8.04722485e-01  2.92768413e+00  3.89095963e+00  3.89095963e+00
  3.89095963e+00  9.37767732e+00  1.42331698e+01  1.42331698e+01
  1.42331698e+01  3.64116707e+01  5.28224131e+01  5.28224131e+01
  5.28224131e+01  1.39725392e+02  2.40604406e+02  2.40604406e+02
  2.40604406e+02  5.02617726e+02  1.86925555e+03  7.99870927e+03
  4.77665281e+04]
E1 = -182.58947405634024  E_coul = 54.048106267668366
Extra cycle  E= -128.541367788672  delta_E= -1.73e-12  |g|= 2.06e-06  |ddm|= 2.9e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2810.377424409141
E1 = -182.58947405634024  E_coul = 54.048106267668366
init E= -128.541367788672
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.848936281433493  LUMO = 0.661752254237316
  mo_energy =
[-3.27705586e+01 -1.92926334e+00 -8.48936281e-01 -8.48936281e-01
 -8.48936281e-01  6.61752254e-01  8.04722240e-01  8.04722240e-01
  8.04722240e-01  2.92768368e+00  3.89095872e+00  3.89095872e+00
  3.89095872e+00  9.37767614e+00  1.42331680e+01  1.42331680e+01
  1.42331680e+01  3.64116683e+01  5.28224103e+01  5.28224103e+01
  5.28224103e+01  1.39725389e+02  2.40604402e+02  2.40604402e+02
  2.40604402e+02  5.02617722e+02  1.86925554e+03  7.99870927e+03
  4.77665281e+04]
E1 = -182.58948211969835  E_coul = 54.048114331025864
cycle= 1 E= -128.541367788672  delta_E= -6.25e-13  |g|= 1.11e-06  |ddm|= 7.32e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58948211969835  E_coul = 54.048114331025864
  HOMO = -0.848935714968825  LUMO = 0.661752379444888
  mo_energy =
[-3.27705569e+01 -1.92926271e+00 -8.48935715e-01 -8.48935715e-01
 -8.48935715e-01  6.61752379e-01  8.04722382e-01  8.04722382e-01
  8.04722382e-01  2.92768397e+00  3.89095923e+00  3.89095923e+00
  3.89095923e+00  9.37767682e+00  1.42331690e+01  1.42331690e+01
  1.42331690e+01  3.64116696e+01  5.28224118e+01  5.28224118e+01
  5.28224118e+01  1.39725390e+02  2.40604404e+02  2.40604404e+02
  2.40604404e+02  5.02617724e+02  1.86925554e+03  7.99870927e+03
  4.77665281e+04]
E1 = -182.5894780499941  E_coul = 54.04811026132179
Extra cycle  E= -128.541367788672  delta_E= 1.71e-13  |g|= 5.52e-07  |ddm|= 4.06e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [5.00658633e-01 2.44137942e+04 3.66145157e+03 8.33319263e+02
 2.35442479e+02 7.61390339e+01 9.99362693e+00 2.69180222e+01
 3.70232629e-01 1.11282530e+00 2.85839886e+00 7.11383718e+00
 2.31710109e+01 9.97863720e+01 2.65502568e-01 2.44200308e+00
 8.34896456e-01]
grad_E = [-1.69728281e-04 -8.99895220e-11  5.74021140e-09 -1.72062478e-07
  2.58378250e-06 -1.47040851e-05 -2.61891214e-04  8.75467175e-05
  1.43084120e-03 -5.35945982e-04  2.41376447e-04  9.30678477e-05
 -7.71897856e-06  2.78172106e-07 -4.33962117e-03 -5.89379985e-04
  2.24428485e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.508361722632       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157106        1
[INPUT] 0    0    [1    /1   ]  833.319276791        1
[INPUT] 0    0    [1    /1   ]  235.442274508        1
[INPUT] 0    0    [1    /1   ]  76.1402294749        1
[INPUT] 0    0    [1    /1   ]  10.0139739363        1
[INPUT] 0    0    [1    /1   ]  26.9110613433        1
[INPUT] 0    0    [1    /1   ]  0.2633191482         1
[INPUT] 0    0    [1    /1   ]  1.14719246596        1
[INPUT] 0    0    [1    /1   ]  2.84107184075        1
[INPUT] 1    0    [1    /1   ]  7.11384268765        1
[INPUT] 1    0    [1    /1   ]  23.1710066249        1
[INPUT] 1    0    [1    /1   ]  99.7863702016        1
[INPUT] 1    0    [1    /1   ]  0.263905871659       1
[INPUT] 1    0    [1    /1   ]  2.4420498139         1
[INPUT] 1    0    [1    /1   ]  0.835232166035       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.508361722631859, 1.0]], [0, [24413.794186556097, 1.0]], [0, [3661.4515710644, 1.0]], [0, [833.3192767912814, 1.0]], [0, [235.44227450805255, 1.0]], [0, [76.14022947490908, 1.0]], [0, [10.013973936313104, 1.0]], [0, [26.911061343283357, 1.0]], [0, [0.26331914819987545, 1.0]], [0, [1.147192465959641, 1.0]], [0, [2.8410718407455136, 1.0]], [1, [7.113842687652623, 1.0]], [1, [23.171006624924168, 1.0]], [1, [99.78637020164533, 1.0]], [1, [0.26390587165889956, 1.0]], [1, [2.4420498139018485, 1.0]], [1, [0.8352321660345373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50836172]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157106]
bas 3, expnt(s) = [833.31927679]
bas 4, expnt(s) = [235.44227451]
bas 5, expnt(s) = [76.14022947]
bas 6, expnt(s) = [10.01397394]
bas 7, expnt(s) = [26.91106134]
bas 8, expnt(s) = [0.26331915]
bas 9, expnt(s) = [1.14719247]
bas 10, expnt(s) = [2.84107184]
bas 11, expnt(s) = [7.11384269]
bas 12, expnt(s) = [23.17100662]
bas 13, expnt(s) = [99.7863702]
bas 14, expnt(s) = [0.26390587]
bas 15, expnt(s) = [2.44204981]
bas 16, expnt(s) = [0.83523217]
CPU time:        12.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.08361723e-01 1.52105408e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319277e+02 3.91853378e+02
 2.35442275e+02 1.51854742e+02 7.61402295e+01 6.51216897e+01
 1.00139739e+01 1.42223010e+01 2.69110613e+01 2.98512928e+01
 2.63319148e-01 9.28703015e-01 1.14719247e+00 2.80054296e+00
 2.84107184e+00 5.52874661e+00 7.11384269e+00 3.38933670e+01
 2.31710066e+01 1.48308321e+02 9.97863702e+01 9.20075410e+02
 2.63905872e-01 5.51817804e-01 2.44204981e+00 8.90589439e+00
 8.35232166e-01 2.32939644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99962602721585
cond(S) = 872.2778696793239
E1 = -183.58958219432276  E_coul = 55.0802178380432
init E= -128.50936435628
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406963501477  LUMO = 0.543034807475426
  mo_energy =
[-3.25550209e+01 -1.85269508e+00 -7.75406964e-01 -7.75406964e-01
 -7.75406964e-01  5.43034807e-01  8.18552443e-01  8.18552443e-01
  8.18552443e-01  2.65099992e+00  3.95187829e+00  3.95187829e+00
  3.95187829e+00  9.10626945e+00  1.43570663e+01  1.43570663e+01
  1.43570663e+01  3.62580840e+01  5.30068467e+01  5.30068467e+01
  5.30068467e+01  1.39682469e+02  2.40835597e+02  2.40835597e+02
  2.40835597e+02  5.02642100e+02  1.86933582e+03  7.99884029e+03
  4.77667068e+04]
E1 = -182.08093452784271  E_coul = 53.54296963241314
cycle= 1 E= -128.53796489543  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.52168
diis-c [-0.27215032  1.        ]
  HOMO = -0.88473046885315  LUMO = 0.524495207509885
  mo_energy =
[-3.28789538e+01 -1.96702353e+00 -8.84730469e-01 -8.84730469e-01
 -8.84730469e-01  5.24495208e-01  7.91728311e-01  7.91728311e-01
  7.91728311e-01  2.59773656e+00  3.85391465e+00  3.85391465e+00
  3.85391465e+00  8.97607702e+00  1.41656823e+01  1.41656823e+01
  1.41656823e+01  3.60124870e+01  5.27251599e+01  5.27251599e+01
  5.27251599e+01  1.39364429e+02  2.40488572e+02  2.40488572e+02
  2.40488572e+02  5.02279890e+02  1.86893754e+03  7.99841295e+03
  4.77662606e+04]
E1 = -182.8448533228257  E_coul = 54.30428909288948
cycle= 2 E= -128.540564229936  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.265293
diis-c [-6.49098434e-04  3.36337349e-01  6.63662651e-01]
  HOMO = -0.848997584764221  LUMO = 0.530392138216157
  mo_energy =
[-3.27705503e+01 -1.92939416e+00 -8.48997585e-01 -8.48997585e-01
 -8.48997585e-01  5.30392138e-01  8.00446199e-01  8.00446199e-01
  8.00446199e-01  2.61485330e+00  3.88565502e+00  3.88565502e+00
  3.88565502e+00  9.01869961e+00  1.42290675e+01  1.42290675e+01
  1.42290675e+01  3.60947374e+01  5.28194488e+01  5.28194488e+01
  5.28194488e+01  1.39470608e+02  2.40602559e+02  2.40602559e+02
  2.40602559e+02  5.02397021e+02  1.86905995e+03  7.99853781e+03
  4.77663864e+04]
E1 = -182.5849859930995  E_coul = 54.04349474669093
cycle= 3 E= -128.541491246409  delta_E= -0.000927  |g|= 0.000551  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119574
diis-c [-2.37360219e-07 -2.47229410e-03 -7.41370743e-04  1.00321366e+00]
  HOMO = -0.849275557805614  LUMO = 0.530348144531611
  mo_energy =
[-3.27710389e+01 -1.92960900e+00 -8.49275558e-01 -8.49275558e-01
 -8.49275558e-01  5.30348145e-01  8.00397338e-01  8.00397338e-01
  8.00397338e-01  2.61474321e+00  3.88545660e+00  3.88545660e+00
  3.88545660e+00  9.01845898e+00  1.42287342e+01  1.42287342e+01
  1.42287342e+01  3.60943553e+01  5.28190146e+01  5.28190146e+01
  5.28190146e+01  1.39470117e+02  2.40601998e+02  2.40601998e+02
  2.40601998e+02  5.02396402e+02  1.86905919e+03  7.99853696e+03
  4.77663855e+04]
E1 = -182.5854448017701  E_coul = 54.04395352367002
cycle= 4 E= -128.5414912781  delta_E= -3.17e-08  |g|= 8.44e-05  |ddm|= 0.000451
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188746
diis-c [-1.06725871e-09  2.34231006e-04  4.66791081e-04 -1.83561733e-01
  1.18286071e+00]
  HOMO = -0.849321658748874  LUMO = 0.530337856850623
  mo_energy =
[-3.27711150e+01 -1.92964494e+00 -8.49321659e-01 -8.49321659e-01
 -8.49321659e-01  5.30337857e-01  8.00382482e-01  8.00382482e-01
  8.00382482e-01  2.61471883e+00  3.88541332e+00  3.88541332e+00
  3.88541332e+00  9.01841059e+00  1.42286710e+01  1.42286710e+01
  1.42286710e+01  3.60942873e+01  5.28189423e+01  5.28189423e+01
  5.28189423e+01  1.39470041e+02  2.40601918e+02  2.40601918e+02
  2.40601918e+02  5.02396318e+02  1.86905910e+03  7.99853686e+03
  4.77663854e+04]
E1 = -182.58557330249994  E_coul = 54.044082023579485
cycle= 5 E= -128.54149127892  delta_E= -8.2e-10  |g|= 5.85e-06  |ddm|= 8.03e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58557330249994  E_coul = 54.044082023579485
  HOMO = -0.849318564711389  LUMO = 0.530338729973832
  mo_energy =
[-3.27711079e+01 -1.92964107e+00 -8.49318565e-01 -8.49318565e-01
 -8.49318565e-01  5.30338730e-01  8.00383382e-01  8.00383382e-01
  8.00383382e-01  2.61472081e+00  3.88541629e+00  3.88541629e+00
  3.88541629e+00  9.01841458e+00  1.42286761e+01  1.42286761e+01
  1.42286761e+01  3.60942935e+01  5.28189489e+01  5.28189489e+01
  5.28189489e+01  1.39470048e+02  2.40601924e+02  2.40601924e+02
  2.40601924e+02  5.02396325e+02  1.86905911e+03  7.99853686e+03
  4.77663854e+04]
E1 = -182.58555700250818  E_coul = 54.044065723585035
Extra cycle  E= -128.541491278923  delta_E= -2.7e-12  |g|= 2.28e-06  |ddm|= 2.01e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [5.08361723e-01 2.44137942e+04 3.66145157e+03 8.33319277e+02
 2.35442275e+02 7.61402295e+01 1.00139739e+01 2.69110613e+01
 2.63319148e-01 1.14719247e+00 2.84107184e+00 7.11384269e+00
 2.31710066e+01 9.97863702e+01 2.63905872e-01 2.44204981e+00
 8.35232166e-01]
E = -128.54149127892316
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.508361722632       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157106        1
[INPUT] 0    0    [1    /1   ]  833.319276791        1
[INPUT] 0    0    [1    /1   ]  235.442274508        1
[INPUT] 0    0    [1    /1   ]  76.1402294749        1
[INPUT] 0    0    [1    /1   ]  10.0139739363        1
[INPUT] 0    0    [1    /1   ]  26.9110613433        1
[INPUT] 0    0    [1    /1   ]  0.2633191482         1
[INPUT] 0    0    [1    /1   ]  1.14719246596        1
[INPUT] 0    0    [1    /1   ]  2.84107184075        1
[INPUT] 1    0    [1    /1   ]  7.11384268765        1
[INPUT] 1    0    [1    /1   ]  23.1710066249        1
[INPUT] 1    0    [1    /1   ]  99.7863702016        1
[INPUT] 1    0    [1    /1   ]  0.263905871659       1
[INPUT] 1    0    [1    /1   ]  2.4420498139         1
[INPUT] 1    0    [1    /1   ]  0.835232166035       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.508361722631859, 1.0]], [0, [24413.794186556097, 1.0]], [0, [3661.4515710644, 1.0]], [0, [833.3192767912814, 1.0]], [0, [235.44227450805255, 1.0]], [0, [76.14022947490908, 1.0]], [0, [10.013973936313104, 1.0]], [0, [26.911061343283357, 1.0]], [0, [0.26331914819987545, 1.0]], [0, [1.147192465959641, 1.0]], [0, [2.8410718407455136, 1.0]], [1, [7.113842687652623, 1.0]], [1, [23.171006624924168, 1.0]], [1, [99.78637020164533, 1.0]], [1, [0.26390587165889956, 1.0]], [1, [2.4420498139018485, 1.0]], [1, [0.8352321660345373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50836172]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157106]
bas 3, expnt(s) = [833.31927679]
bas 4, expnt(s) = [235.44227451]
bas 5, expnt(s) = [76.14022947]
bas 6, expnt(s) = [10.01397394]
bas 7, expnt(s) = [26.91106134]
bas 8, expnt(s) = [0.26331915]
bas 9, expnt(s) = [1.14719247]
bas 10, expnt(s) = [2.84107184]
bas 11, expnt(s) = [7.11384269]
bas 12, expnt(s) = [23.17100662]
bas 13, expnt(s) = [99.7863702]
bas 14, expnt(s) = [0.26390587]
bas 15, expnt(s) = [2.44204981]
bas 16, expnt(s) = [0.83523217]
CPU time:        13.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.08361723e-01 1.52105408e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319277e+02 3.91853378e+02
 2.35442275e+02 1.51854742e+02 7.61402295e+01 6.51216897e+01
 1.00139739e+01 1.42223010e+01 2.69110613e+01 2.98512928e+01
 2.63319148e-01 9.28703015e-01 1.14719247e+00 2.80054296e+00
 2.84107184e+00 5.52874661e+00 7.11384269e+00 3.38933670e+01
 2.31710066e+01 1.48308321e+02 9.97863702e+01 9.20075410e+02
 2.63905872e-01 5.51817804e-01 2.44204981e+00 8.90589439e+00
 8.35232166e-01 2.32939644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99962602721585
cond(S) = 872.2778696793239
E1 = -183.58958219432276  E_coul = 55.0802178380432
init E= -128.50936435628
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406963501477  LUMO = 0.543034807475426
  mo_energy =
[-3.25550209e+01 -1.85269508e+00 -7.75406964e-01 -7.75406964e-01
 -7.75406964e-01  5.43034807e-01  8.18552443e-01  8.18552443e-01
  8.18552443e-01  2.65099992e+00  3.95187829e+00  3.95187829e+00
  3.95187829e+00  9.10626945e+00  1.43570663e+01  1.43570663e+01
  1.43570663e+01  3.62580840e+01  5.30068467e+01  5.30068467e+01
  5.30068467e+01  1.39682469e+02  2.40835597e+02  2.40835597e+02
  2.40835597e+02  5.02642100e+02  1.86933582e+03  7.99884029e+03
  4.77667068e+04]
E1 = -182.08093452784271  E_coul = 53.54296963241314
cycle= 1 E= -128.53796489543  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.52168
diis-c [-0.27215032  1.        ]
  HOMO = -0.88473046885315  LUMO = 0.524495207509885
  mo_energy =
[-3.28789538e+01 -1.96702353e+00 -8.84730469e-01 -8.84730469e-01
 -8.84730469e-01  5.24495208e-01  7.91728311e-01  7.91728311e-01
  7.91728311e-01  2.59773656e+00  3.85391465e+00  3.85391465e+00
  3.85391465e+00  8.97607702e+00  1.41656823e+01  1.41656823e+01
  1.41656823e+01  3.60124870e+01  5.27251599e+01  5.27251599e+01
  5.27251599e+01  1.39364429e+02  2.40488572e+02  2.40488572e+02
  2.40488572e+02  5.02279890e+02  1.86893754e+03  7.99841295e+03
  4.77662606e+04]
E1 = -182.8448533228257  E_coul = 54.30428909288948
cycle= 2 E= -128.540564229936  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.265293
diis-c [-6.49098434e-04  3.36337349e-01  6.63662651e-01]
  HOMO = -0.848997584764221  LUMO = 0.530392138216157
  mo_energy =
[-3.27705503e+01 -1.92939416e+00 -8.48997585e-01 -8.48997585e-01
 -8.48997585e-01  5.30392138e-01  8.00446199e-01  8.00446199e-01
  8.00446199e-01  2.61485330e+00  3.88565502e+00  3.88565502e+00
  3.88565502e+00  9.01869961e+00  1.42290675e+01  1.42290675e+01
  1.42290675e+01  3.60947374e+01  5.28194488e+01  5.28194488e+01
  5.28194488e+01  1.39470608e+02  2.40602559e+02  2.40602559e+02
  2.40602559e+02  5.02397021e+02  1.86905995e+03  7.99853781e+03
  4.77663864e+04]
E1 = -182.5849859930995  E_coul = 54.04349474669093
cycle= 3 E= -128.541491246409  delta_E= -0.000927  |g|= 0.000551  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119574
diis-c [-2.37360219e-07 -2.47229410e-03 -7.41370743e-04  1.00321366e+00]
  HOMO = -0.849275557805614  LUMO = 0.530348144531611
  mo_energy =
[-3.27710389e+01 -1.92960900e+00 -8.49275558e-01 -8.49275558e-01
 -8.49275558e-01  5.30348145e-01  8.00397338e-01  8.00397338e-01
  8.00397338e-01  2.61474321e+00  3.88545660e+00  3.88545660e+00
  3.88545660e+00  9.01845898e+00  1.42287342e+01  1.42287342e+01
  1.42287342e+01  3.60943553e+01  5.28190146e+01  5.28190146e+01
  5.28190146e+01  1.39470117e+02  2.40601998e+02  2.40601998e+02
  2.40601998e+02  5.02396402e+02  1.86905919e+03  7.99853696e+03
  4.77663855e+04]
E1 = -182.5854448017701  E_coul = 54.04395352367002
cycle= 4 E= -128.5414912781  delta_E= -3.17e-08  |g|= 8.44e-05  |ddm|= 0.000451
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188746
diis-c [-1.06725871e-09  2.34231006e-04  4.66791081e-04 -1.83561733e-01
  1.18286071e+00]
  HOMO = -0.849321658748874  LUMO = 0.530337856850623
  mo_energy =
[-3.27711150e+01 -1.92964494e+00 -8.49321659e-01 -8.49321659e-01
 -8.49321659e-01  5.30337857e-01  8.00382482e-01  8.00382482e-01
  8.00382482e-01  2.61471883e+00  3.88541332e+00  3.88541332e+00
  3.88541332e+00  9.01841059e+00  1.42286710e+01  1.42286710e+01
  1.42286710e+01  3.60942873e+01  5.28189423e+01  5.28189423e+01
  5.28189423e+01  1.39470041e+02  2.40601918e+02  2.40601918e+02
  2.40601918e+02  5.02396318e+02  1.86905910e+03  7.99853686e+03
  4.77663854e+04]
E1 = -182.58557330249994  E_coul = 54.044082023579485
cycle= 5 E= -128.54149127892  delta_E= -8.2e-10  |g|= 5.85e-06  |ddm|= 8.03e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58557330249994  E_coul = 54.044082023579485
  HOMO = -0.849318564711389  LUMO = 0.530338729973832
  mo_energy =
[-3.27711079e+01 -1.92964107e+00 -8.49318565e-01 -8.49318565e-01
 -8.49318565e-01  5.30338730e-01  8.00383382e-01  8.00383382e-01
  8.00383382e-01  2.61472081e+00  3.88541629e+00  3.88541629e+00
  3.88541629e+00  9.01841458e+00  1.42286761e+01  1.42286761e+01
  1.42286761e+01  3.60942935e+01  5.28189489e+01  5.28189489e+01
  5.28189489e+01  1.39470048e+02  2.40601924e+02  2.40601924e+02
  2.40601924e+02  5.02396325e+02  1.86905911e+03  7.99853686e+03
  4.77663854e+04]
E1 = -182.58555700250818  E_coul = 54.044065723585035
Extra cycle  E= -128.541491278923  delta_E= -2.7e-12  |g|= 2.28e-06  |ddm|= 2.01e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 872.2778696793239
E1 = -182.58555700250818  E_coul = 54.044065723585035
init E= -128.541491278923
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.849319720614263  LUMO = 0.530338597239444
  mo_energy =
[-3.27711115e+01 -1.92964214e+00 -8.49319721e-01 -8.49319721e-01
 -8.49319721e-01  5.30338597e-01  8.00383117e-01  8.00383117e-01
  8.00383117e-01  2.61472034e+00  3.88541529e+00  3.88541529e+00
  3.88541529e+00  9.01841327e+00  1.42286741e+01  1.42286741e+01
  1.42286741e+01  3.60942908e+01  5.28189458e+01  5.28189458e+01
  5.28189458e+01  1.39470044e+02  2.40601921e+02  2.40601921e+02
  2.40601921e+02  5.02396321e+02  1.86905910e+03  7.99853686e+03
  4.77663854e+04]
E1 = -182.58556599509086  E_coul = 54.044074716167565
cycle= 1 E= -128.541491278923  delta_E= -1.42e-13  |g|= 1.23e-06  |ddm|= 8.12e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58556599509086  E_coul = 54.044074716167565
  HOMO = -0.849319087751034  LUMO = 0.530338713393356
  mo_energy =
[-3.27711096e+01 -1.92964145e+00 -8.49319088e-01 -8.49319088e-01
 -8.49319088e-01  5.30338713e-01  8.00383275e-01  8.00383275e-01
  8.00383275e-01  2.61472066e+00  3.88541586e+00  3.88541586e+00
  3.88541586e+00  9.01841404e+00  1.42286752e+01  1.42286752e+01
  1.42286752e+01  3.60942923e+01  5.28189475e+01  5.28189475e+01
  5.28189475e+01  1.39470046e+02  2.40601923e+02  2.40601923e+02
  2.40601923e+02  5.02396323e+02  1.86905911e+03  7.99853686e+03
  4.77663854e+04]
E1 = -182.58556145972057  E_coul = 54.04407018079713
Extra cycle  E= -128.541491278923  delta_E= -1.42e-13  |g|= 6.16e-07  |ddm|= 3.92e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [5.08361723e-01 2.44137942e+04 3.66145157e+03 8.33319277e+02
 2.35442275e+02 7.61402295e+01 1.00139739e+01 2.69110613e+01
 2.63319148e-01 1.14719247e+00 2.84107184e+00 7.11384269e+00
 2.31710066e+01 9.97863702e+01 2.63905872e-01 2.44204981e+00
 8.35232166e-01]
grad_E = [ 7.08148874e-04  1.46605225e-10 -6.68227512e-09  7.75368706e-08
 -3.98896441e-07  8.40058203e-06 -1.67829530e-05 -2.12129603e-05
 -2.93419157e-04 -1.97706951e-03  3.86197406e-04  2.14938854e-04
 -1.76810655e-05  6.00951421e-07 -1.07945937e-02 -1.38638221e-03
  5.47596866e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.509380601694       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157095        1
[INPUT] 0    0    [1    /1   ]  833.319280251        1
[INPUT] 0    0    [1    /1   ]  235.442222823        1
[INPUT] 0    0    [1    /1   ]  76.1405254902        1
[INPUT] 0    0    [1    /1   ]  10.0191666619        1
[INPUT] 0    0    [1    /1   ]  26.9093108438        1
[INPUT] 0    0    [1    /1   ]  0.236576049915       1
[INPUT] 0    0    [1    /1   ]  1.15795556781        1
[INPUT] 0    0    [1    /1   ]  2.83627049337        1
[INPUT] 1    0    [1    /1   ]  7.11381934846        1
[INPUT] 1    0    [1    /1   ]  23.1710073073        1
[INPUT] 1    0    [1    /1   ]  99.7863696656        1
[INPUT] 1    0    [1    /1   ]  0.265515196523       1
[INPUT] 1    0    [1    /1   ]  2.44225034624        1
[INPUT] 1    0    [1    /1   ]  0.834386220599       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5093806016936573, 1.0]], [0, [24413.794186557945, 1.0]], [0, [3661.4515709475368, 1.0]], [0, [833.3192802510875, 1.0]], [0, [235.44222282254287, 1.0]], [0, [76.1405254902391, 1.0]], [0, [10.019166661869066, 1.0]], [0, [26.909310843835634, 1.0]], [0, [0.23657604991513217, 1.0]], [0, [1.1579555678123445, 1.0]], [0, [2.836270493368312, 1.0]], [1, [7.11381934845769, 1.0]], [1, [23.17100730732507, 1.0]], [1, [99.78636966560863, 1.0]], [1, [0.265515196522696, 1.0]], [1, [2.442250346235504, 1.0]], [1, [0.8343862205992214, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5093806]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157095]
bas 3, expnt(s) = [833.31928025]
bas 4, expnt(s) = [235.44222282]
bas 5, expnt(s) = [76.14052549]
bas 6, expnt(s) = [10.01916666]
bas 7, expnt(s) = [26.90931084]
bas 8, expnt(s) = [0.23657605]
bas 9, expnt(s) = [1.15795557]
bas 10, expnt(s) = [2.83627049]
bas 11, expnt(s) = [7.11381935]
bas 12, expnt(s) = [23.17100731]
bas 13, expnt(s) = [99.78636967]
bas 14, expnt(s) = [0.2655152]
bas 15, expnt(s) = [2.44225035]
bas 16, expnt(s) = [0.83438622]
CPU time:        15.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.09380602e-01 1.52333993e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319280e+02 3.91853380e+02
 2.35442223e+02 1.51854717e+02 7.61405255e+01 6.51218795e+01
 1.00191667e+01 1.42278319e+01 2.69093108e+01 2.98498364e+01
 2.36576050e-01 8.57024241e-01 1.15795557e+00 2.82022622e+00
 2.83627049e+00 5.52173753e+00 7.11381935e+00 3.38932280e+01
 2.31710073e+01 1.48308327e+02 9.97863697e+01 9.20075404e+02
 2.65515197e-01 5.56027307e-01 2.44225035e+00 8.90680855e+00
 8.34386221e-01 2.32644772e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99962830993784
cond(S) = 748.0442405189497
E1 = -183.58965421774607  E_coul = 55.08027363044522
init E= -128.509380587301
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775405631422655  LUMO = 0.502272068467705
  mo_energy =
[-3.25550066e+01 -1.85269374e+00 -7.75405631e-01 -7.75405631e-01
 -7.75405631e-01  5.02272068e-01  8.22658563e-01  8.22658563e-01
  8.22658563e-01  2.56210280e+00  3.95591670e+00  3.95591670e+00
  3.95591670e+00  9.01599300e+00  1.43599591e+01  1.43599591e+01
  1.43599591e+01  3.61832748e+01  5.30090044e+01  5.30090044e+01
  5.30090044e+01  1.39623462e+02  2.40837049e+02  2.40837049e+02
  2.40837049e+02  5.02591210e+02  1.86929073e+03  7.99880074e+03
  4.77666740e+04]
E1 = -182.08381527660114  E_coul = 53.545825147997824
cycle= 1 E= -128.537990128603  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521181
diis-c [-0.27162948  1.        ]
  HOMO = -0.884495611221417  LUMO = 0.485058961688197
  mo_energy =
[-3.28785134e+01 -1.96674680e+00 -8.84495611e-01 -8.84495611e-01
 -8.84495611e-01  4.85058962e-01  7.95836289e-01  7.95836289e-01
  7.95836289e-01  2.50921450e+00  3.85825775e+00  3.85825775e+00
  3.85825775e+00  8.88582667e+00  1.41689283e+01  1.41689283e+01
  1.41689283e+01  3.59379458e+01  5.27277204e+01  5.27277204e+01
  5.27277204e+01  1.39305827e+02  2.40490456e+02  2.40490456e+02
  2.40490456e+02  5.02229429e+02  1.86889289e+03  7.99837385e+03
  4.77662283e+04]
E1 = -182.84661092832485  E_coul = 54.30602575359062
cycle= 2 E= -128.540585174734  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264922
diis-c [-6.48641798e-04  3.36237212e-01  6.63762788e-01]
  HOMO = -0.848810504466649  LUMO = 0.490558822270233
  mo_energy =
[-3.27702486e+01 -1.92917031e+00 -8.48810504e-01 -8.48810504e-01
 -8.48810504e-01  4.90558822e-01  8.04571417e-01  8.04571417e-01
  8.04571417e-01  2.52624072e+00  3.88994135e+00  3.88994135e+00
  3.88994135e+00  8.92847714e+00  1.42322233e+01  1.42322233e+01
  1.42322233e+01  3.60201253e+01  5.28218865e+01  5.28218865e+01
  5.28218865e+01  1.39411879e+02  2.40604298e+02  2.40604298e+02
  2.40604298e+02  5.02346414e+02  1.86901515e+03  7.99849856e+03
  4.77663540e+04]
E1 = -182.58740704188324  E_coul = 54.045898326878145
cycle= 3 E= -128.541508715005  delta_E= -0.000924  |g|= 0.000526  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.00116162
diis-c [-2.58563613e-07 -2.46370954e-03 -9.02897133e-04  1.00336661e+00]
  HOMO = -0.849074393245553  LUMO = 0.490523248662702
  mo_energy =
[-3.27707145e+01 -1.92936731e+00 -8.49074393e-01 -8.49074393e-01
 -8.49074393e-01  4.90523249e-01  8.04527596e-01  8.04527596e-01
  8.04527596e-01  2.52614191e+00  3.88975784e+00  3.88975784e+00
  3.88975784e+00  8.92825392e+00  1.42319098e+01  1.42319098e+01
  1.42319098e+01  3.60197644e+01  5.28214745e+01  5.28214745e+01
  5.28214745e+01  1.39411410e+02  2.40603760e+02  2.40603760e+02
  2.40603760e+02  5.02345818e+02  1.86901442e+03  7.99849773e+03
  4.77663531e+04]
E1 = -182.58784360984941  E_coul = 54.046334864809985
cycle= 4 E= -128.541508745039  delta_E= -3e-08  |g|= 8.23e-05  |ddm|= 0.000386
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187077
diis-c [-1.14327899e-09  2.48664301e-04  4.79133869e-04 -1.91786699e-01
  1.19105890e+00]
  HOMO = -0.849118896826721  LUMO = 0.49051442434502
  mo_energy =
[-3.27707881e+01 -1.92940054e+00 -8.49118897e-01 -8.49118897e-01
 -8.49118897e-01  4.90514424e-01  8.04513316e-01  8.04513316e-01
  8.04513316e-01  2.52611917e+00  3.88971640e+00  3.88971640e+00
  3.88971640e+00  8.92820779e+00  1.42318490e+01  1.42318490e+01
  1.42318490e+01  3.60196990e+01  5.28214047e+01  5.28214047e+01
  5.28214047e+01  1.39411337e+02  2.40603682e+02  2.40603682e+02
  2.40603682e+02  5.02345736e+02  1.86901433e+03  7.99849763e+03
  4.77663530e+04]
E1 = -182.58797022007954  E_coul = 54.04646147421722
cycle= 5 E= -128.541508745862  delta_E= -8.23e-10  |g|= 6.21e-06  |ddm|= 6.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58797022007954  E_coul = 54.04646147421722
  HOMO = -0.849115571089605  LUMO = 0.490515300616241
  mo_energy =
[-3.27707805e+01 -1.92939642e+00 -8.49115571e-01 -8.49115571e-01
 -8.49115571e-01  4.90515301e-01  8.04514289e-01  8.04514289e-01
  8.04514289e-01  2.52612129e+00  3.88971958e+00  3.88971958e+00
  3.88971958e+00  8.92821207e+00  1.42318545e+01  1.42318545e+01
  1.42318545e+01  3.60197056e+01  5.28214118e+01  5.28214118e+01
  5.28214118e+01  1.39411344e+02  2.40603689e+02  2.40603689e+02
  2.40603689e+02  5.02345743e+02  1.86901433e+03  7.99849764e+03
  4.77663530e+04]
E1 = -182.5879529864488  E_coul = 54.04644424058363
Extra cycle  E= -128.541508745865  delta_E= -2.84e-12  |g|= 2.42e-06  |ddm|= 2.27e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [5.09380602e-01 2.44137942e+04 3.66145157e+03 8.33319280e+02
 2.35442223e+02 7.61405255e+01 1.00191667e+01 2.69093108e+01
 2.36576050e-01 1.15795557e+00 2.83627049e+00 7.11381935e+00
 2.31710073e+01 9.97863697e+01 2.65515197e-01 2.44225035e+00
 8.34386221e-01]
E = -128.54150874586517
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.509380601694       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157095        1
[INPUT] 0    0    [1    /1   ]  833.319280251        1
[INPUT] 0    0    [1    /1   ]  235.442222823        1
[INPUT] 0    0    [1    /1   ]  76.1405254902        1
[INPUT] 0    0    [1    /1   ]  10.0191666619        1
[INPUT] 0    0    [1    /1   ]  26.9093108438        1
[INPUT] 0    0    [1    /1   ]  0.236576049915       1
[INPUT] 0    0    [1    /1   ]  1.15795556781        1
[INPUT] 0    0    [1    /1   ]  2.83627049337        1
[INPUT] 1    0    [1    /1   ]  7.11381934846        1
[INPUT] 1    0    [1    /1   ]  23.1710073073        1
[INPUT] 1    0    [1    /1   ]  99.7863696656        1
[INPUT] 1    0    [1    /1   ]  0.265515196523       1
[INPUT] 1    0    [1    /1   ]  2.44225034624        1
[INPUT] 1    0    [1    /1   ]  0.834386220599       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5093806016936573, 1.0]], [0, [24413.794186557945, 1.0]], [0, [3661.4515709475368, 1.0]], [0, [833.3192802510875, 1.0]], [0, [235.44222282254287, 1.0]], [0, [76.1405254902391, 1.0]], [0, [10.019166661869066, 1.0]], [0, [26.909310843835634, 1.0]], [0, [0.23657604991513217, 1.0]], [0, [1.1579555678123445, 1.0]], [0, [2.836270493368312, 1.0]], [1, [7.11381934845769, 1.0]], [1, [23.17100730732507, 1.0]], [1, [99.78636966560863, 1.0]], [1, [0.265515196522696, 1.0]], [1, [2.442250346235504, 1.0]], [1, [0.8343862205992214, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5093806]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157095]
bas 3, expnt(s) = [833.31928025]
bas 4, expnt(s) = [235.44222282]
bas 5, expnt(s) = [76.14052549]
bas 6, expnt(s) = [10.01916666]
bas 7, expnt(s) = [26.90931084]
bas 8, expnt(s) = [0.23657605]
bas 9, expnt(s) = [1.15795557]
bas 10, expnt(s) = [2.83627049]
bas 11, expnt(s) = [7.11381935]
bas 12, expnt(s) = [23.17100731]
bas 13, expnt(s) = [99.78636967]
bas 14, expnt(s) = [0.2655152]
bas 15, expnt(s) = [2.44225035]
bas 16, expnt(s) = [0.83438622]
CPU time:        15.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.09380602e-01 1.52333993e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319280e+02 3.91853380e+02
 2.35442223e+02 1.51854717e+02 7.61405255e+01 6.51218795e+01
 1.00191667e+01 1.42278319e+01 2.69093108e+01 2.98498364e+01
 2.36576050e-01 8.57024241e-01 1.15795557e+00 2.82022622e+00
 2.83627049e+00 5.52173753e+00 7.11381935e+00 3.38932280e+01
 2.31710073e+01 1.48308327e+02 9.97863697e+01 9.20075404e+02
 2.65515197e-01 5.56027307e-01 2.44225035e+00 8.90680855e+00
 8.34386221e-01 2.32644772e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99962830993784
cond(S) = 748.0442405189497
E1 = -183.58965421774607  E_coul = 55.08027363044522
init E= -128.509380587301
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775405631422655  LUMO = 0.502272068467705
  mo_energy =
[-3.25550066e+01 -1.85269374e+00 -7.75405631e-01 -7.75405631e-01
 -7.75405631e-01  5.02272068e-01  8.22658563e-01  8.22658563e-01
  8.22658563e-01  2.56210280e+00  3.95591670e+00  3.95591670e+00
  3.95591670e+00  9.01599300e+00  1.43599591e+01  1.43599591e+01
  1.43599591e+01  3.61832748e+01  5.30090044e+01  5.30090044e+01
  5.30090044e+01  1.39623462e+02  2.40837049e+02  2.40837049e+02
  2.40837049e+02  5.02591210e+02  1.86929073e+03  7.99880074e+03
  4.77666740e+04]
E1 = -182.08381527660114  E_coul = 53.545825147997824
cycle= 1 E= -128.537990128603  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521181
diis-c [-0.27162948  1.        ]
  HOMO = -0.884495611221417  LUMO = 0.485058961688197
  mo_energy =
[-3.28785134e+01 -1.96674680e+00 -8.84495611e-01 -8.84495611e-01
 -8.84495611e-01  4.85058962e-01  7.95836289e-01  7.95836289e-01
  7.95836289e-01  2.50921450e+00  3.85825775e+00  3.85825775e+00
  3.85825775e+00  8.88582667e+00  1.41689283e+01  1.41689283e+01
  1.41689283e+01  3.59379458e+01  5.27277204e+01  5.27277204e+01
  5.27277204e+01  1.39305827e+02  2.40490456e+02  2.40490456e+02
  2.40490456e+02  5.02229429e+02  1.86889289e+03  7.99837385e+03
  4.77662283e+04]
E1 = -182.84661092832485  E_coul = 54.30602575359062
cycle= 2 E= -128.540585174734  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264922
diis-c [-6.48641798e-04  3.36237212e-01  6.63762788e-01]
  HOMO = -0.848810504466649  LUMO = 0.490558822270233
  mo_energy =
[-3.27702486e+01 -1.92917031e+00 -8.48810504e-01 -8.48810504e-01
 -8.48810504e-01  4.90558822e-01  8.04571417e-01  8.04571417e-01
  8.04571417e-01  2.52624072e+00  3.88994135e+00  3.88994135e+00
  3.88994135e+00  8.92847714e+00  1.42322233e+01  1.42322233e+01
  1.42322233e+01  3.60201253e+01  5.28218865e+01  5.28218865e+01
  5.28218865e+01  1.39411879e+02  2.40604298e+02  2.40604298e+02
  2.40604298e+02  5.02346414e+02  1.86901515e+03  7.99849856e+03
  4.77663540e+04]
E1 = -182.58740704188324  E_coul = 54.045898326878145
cycle= 3 E= -128.541508715005  delta_E= -0.000924  |g|= 0.000526  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116162
diis-c [-2.58563613e-07 -2.46370954e-03 -9.02897133e-04  1.00336661e+00]
  HOMO = -0.849074393245553  LUMO = 0.490523248662702
  mo_energy =
[-3.27707145e+01 -1.92936731e+00 -8.49074393e-01 -8.49074393e-01
 -8.49074393e-01  4.90523249e-01  8.04527596e-01  8.04527596e-01
  8.04527596e-01  2.52614191e+00  3.88975784e+00  3.88975784e+00
  3.88975784e+00  8.92825392e+00  1.42319098e+01  1.42319098e+01
  1.42319098e+01  3.60197644e+01  5.28214745e+01  5.28214745e+01
  5.28214745e+01  1.39411410e+02  2.40603760e+02  2.40603760e+02
  2.40603760e+02  5.02345818e+02  1.86901442e+03  7.99849773e+03
  4.77663531e+04]
E1 = -182.58784360984941  E_coul = 54.046334864809985
cycle= 4 E= -128.541508745039  delta_E= -3e-08  |g|= 8.23e-05  |ddm|= 0.000386
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187077
diis-c [-1.14327899e-09  2.48664301e-04  4.79133869e-04 -1.91786699e-01
  1.19105890e+00]
  HOMO = -0.849118896826721  LUMO = 0.49051442434502
  mo_energy =
[-3.27707881e+01 -1.92940054e+00 -8.49118897e-01 -8.49118897e-01
 -8.49118897e-01  4.90514424e-01  8.04513316e-01  8.04513316e-01
  8.04513316e-01  2.52611917e+00  3.88971640e+00  3.88971640e+00
  3.88971640e+00  8.92820779e+00  1.42318490e+01  1.42318490e+01
  1.42318490e+01  3.60196990e+01  5.28214047e+01  5.28214047e+01
  5.28214047e+01  1.39411337e+02  2.40603682e+02  2.40603682e+02
  2.40603682e+02  5.02345736e+02  1.86901433e+03  7.99849763e+03
  4.77663530e+04]
E1 = -182.58797022007954  E_coul = 54.04646147421722
cycle= 5 E= -128.541508745862  delta_E= -8.23e-10  |g|= 6.21e-06  |ddm|= 6.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58797022007954  E_coul = 54.04646147421722
  HOMO = -0.849115571089605  LUMO = 0.490515300616241
  mo_energy =
[-3.27707805e+01 -1.92939642e+00 -8.49115571e-01 -8.49115571e-01
 -8.49115571e-01  4.90515301e-01  8.04514289e-01  8.04514289e-01
  8.04514289e-01  2.52612129e+00  3.88971958e+00  3.88971958e+00
  3.88971958e+00  8.92821207e+00  1.42318545e+01  1.42318545e+01
  1.42318545e+01  3.60197056e+01  5.28214118e+01  5.28214118e+01
  5.28214118e+01  1.39411344e+02  2.40603689e+02  2.40603689e+02
  2.40603689e+02  5.02345743e+02  1.86901433e+03  7.99849764e+03
  4.77663530e+04]
E1 = -182.5879529864488  E_coul = 54.04644424058363
Extra cycle  E= -128.541508745865  delta_E= -2.84e-12  |g|= 2.42e-06  |ddm|= 2.27e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 748.0442405189497
E1 = -182.5879529864488  E_coul = 54.04644424058363
init E= -128.541508745865
    CPU time for initialize scf      0.34 sec, wall time      0.34 sec
  HOMO = -0.849116789612038  LUMO = 0.490515170724979
  mo_energy =
[-3.27707843e+01 -1.92939756e+00 -8.49116790e-01 -8.49116790e-01
 -8.49116790e-01  4.90515171e-01  8.04514010e-01  8.04514010e-01
  8.04514010e-01  2.52612079e+00  3.88971852e+00  3.88971852e+00
  3.88971852e+00  8.92821068e+00  1.42318523e+01  1.42318523e+01
  1.42318523e+01  3.60197027e+01  5.28214085e+01  5.28214085e+01
  5.28214085e+01  1.39411340e+02  2.40603685e+02  2.40603685e+02
  2.40603685e+02  5.02345739e+02  1.86901433e+03  7.99849763e+03
  4.77663530e+04]
E1 = -182.58796251920734  E_coul = 54.04645377334173
cycle= 1 E= -128.541508745866  delta_E= -4.26e-13  |g|= 1.3e-06  |ddm|= 8.62e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58796251920734  E_coul = 54.04645377334173
  HOMO = -0.849116118207582  LUMO = 0.49051528562579
  mo_energy =
[-3.27707823e+01 -1.92939682e+00 -8.49116118e-01 -8.49116118e-01
 -8.49116118e-01  4.90515286e-01  8.04514178e-01  8.04514178e-01
  8.04514178e-01  2.52612113e+00  3.88971913e+00  3.88971913e+00
  3.88971913e+00  8.92821150e+00  1.42318535e+01  1.42318535e+01
  1.42318535e+01  3.60197043e+01  5.28214103e+01  5.28214103e+01
  5.28214103e+01  1.39411342e+02  2.40603687e+02  2.40603687e+02
  2.40603687e+02  5.02345741e+02  1.86901433e+03  7.99849763e+03
  4.77663530e+04]
E1 = -182.5879577197494  E_coul = 54.046448973883706
Extra cycle  E= -128.541508745866  delta_E= -8.53e-14  |g|= 6.52e-07  |ddm|= 4.17e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.41 sec
exp = [5.09380602e-01 2.44137942e+04 3.66145157e+03 8.33319280e+02
 2.35442223e+02 7.61405255e+01 1.00191667e+01 2.69093108e+01
 2.36576050e-01 1.15795557e+00 2.83627049e+00 7.11381935e+00
 2.31710073e+01 9.97863697e+01 2.65515197e-01 2.44225035e+00
 8.34386221e-01]
grad_E = [ 1.74698134e-03  2.06749681e-10 -9.83805976e-09  1.41014629e-07
 -1.15658780e-06  1.42868522e-05  4.62326591e-05 -4.88677408e-05
 -1.30336359e-03 -2.43523853e-03  4.28960895e-04  4.09614208e-05
 -3.17723994e-06  1.27118154e-07 -2.50896485e-03 -2.88268218e-04
  1.24088473e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.506089552511       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157104        1
[INPUT] 0    0    [1    /1   ]  833.319277789        1
[INPUT] 0    0    [1    /1   ]  235.442257955        1
[INPUT] 0    0    [1    /1   ]  76.1403109131        1
[INPUT] 0    0    [1    /1   ]  10.0157566915        1
[INPUT] 0    0    [1    /1   ]  26.9105179674        1
[INPUT] 0    0    [1    /1   ]  0.255707500014       1
[INPUT] 0    0    [1    /1   ]  1.15530619698        1
[INPUT] 0    0    [1    /1   ]  2.838591572          1
[INPUT] 1    0    [1    /1   ]  7.11380536942        1
[INPUT] 1    0    [1    /1   ]  23.1710087536        1
[INPUT] 1    0    [1    /1   ]  99.7863699071        1
[INPUT] 1    0    [1    /1   ]  0.267305852171       1
[INPUT] 1    0    [1    /1   ]  2.44236601486        1
[INPUT] 1    0    [1    /1   ]  0.833639719215       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5060895525105114, 1.0]], [0, [24413.794186556403, 1.0]], [0, [3661.451571039556, 1.0]], [0, [833.3192777886077, 1.0]], [0, [235.44225795504457, 1.0]], [0, [76.14031091306971, 1.0]], [0, [10.015756691470036, 1.0]], [0, [26.910517967395663, 1.0]], [0, [0.2557075000143302, 1.0]], [0, [1.1553061969839284, 1.0]], [0, [2.838591572001749, 1.0]], [1, [7.11380536941847, 1.0]], [1, [23.171008753567538, 1.0]], [1, [99.78636990714955, 1.0]], [1, [0.26730585217131186, 1.0]], [1, [2.4423660148582527, 1.0]], [1, [0.8336397192153799, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50608955]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157104]
bas 3, expnt(s) = [833.31927779]
bas 4, expnt(s) = [235.44225796]
bas 5, expnt(s) = [76.14031091]
bas 6, expnt(s) = [10.01575669]
bas 7, expnt(s) = [26.91051797]
bas 8, expnt(s) = [0.2557075]
bas 9, expnt(s) = [1.1553062]
bas 10, expnt(s) = [2.83859157]
bas 11, expnt(s) = [7.11380537]
bas 12, expnt(s) = [23.17100875]
bas 13, expnt(s) = [99.78636991]
bas 14, expnt(s) = [0.26730585]
bas 15, expnt(s) = [2.44236601]
bas 16, expnt(s) = [0.83363972]
CPU time:        18.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.06089553e-01 1.51595236e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319278e+02 3.91853379e+02
 2.35442258e+02 1.51854734e+02 7.61403109e+01 6.51217419e+01
 1.00157567e+01 1.42242000e+01 2.69105180e+01 2.98508407e+01
 2.55707500e-01 9.08495173e-01 1.15530620e+00 2.81538538e+00
 2.83859157e+00 5.52512625e+00 7.11380537e+00 3.38931447e+01
 2.31710088e+01 1.48308338e+02 9.97863699e+01 9.20075407e+02
 2.67305852e-01 5.60718618e-01 2.44236601e+00 8.90733585e+00
 8.33639719e-01 2.32384625e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999623864077051
cond(S) = 825.9681921555137
E1 = -183.5897967096585  E_coul = 55.08027290948311
init E= -128.509523800175
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401402611275  LUMO = 0.530893391467744
  mo_energy =
[-3.25550227e+01 -1.85269177e+00 -7.75401403e-01 -7.75401403e-01
 -7.75401403e-01  5.30893391e-01  8.27261723e-01  8.27261723e-01
  8.27261723e-01  2.62398395e+00  3.96086124e+00  3.96086124e+00
  3.96086124e+00  9.08400830e+00  1.43635716e+01  1.43635716e+01
  1.43635716e+01  3.62434682e+01  5.30116660e+01  5.30116660e+01
  5.30116660e+01  1.39672253e+02  2.40838828e+02  2.40838828e+02
  2.40838828e+02  5.02633588e+02  1.86932832e+03  7.99883371e+03
  4.77667013e+04]
E1 = -182.08736880959054  E_coul = 53.549357780930706
cycle= 1 E= -128.53801102866  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521058
diis-c [-0.27150155  1.        ]
  HOMO = -0.884195997451639  LUMO = 0.512990566140486
  mo_energy =
[-3.28779742e+01 -1.96641918e+00 -8.84195997e-01 -8.84195997e-01
 -8.84195997e-01  5.12990566e-01  8.00467228e-01  8.00467228e-01
  8.00467228e-01  2.57114704e+00  3.86355040e+00  3.86355040e+00
  3.86355040e+00  8.95430662e+00  1.41729973e+01  1.41729973e+01
  1.41729973e+01  3.59987215e+01  5.27309119e+01  5.27309119e+01
  5.27309119e+01  1.39355184e+02  2.40492778e+02  2.40492778e+02
  2.40492778e+02  5.02272365e+02  1.86893104e+03  7.99840738e+03
  4.77662562e+04]
E1 = -182.8485307512356  E_coul = 54.30793196034083
cycle= 2 E= -128.540598790895  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.26466
diis-c [-6.46658877e-04  3.36069334e-01  6.63930666e-01]
  HOMO = -0.848580197422466  LUMO = 0.518744007686145
  mo_energy =
[-3.27699063e+01 -1.92891623e+00 -8.48580197e-01 -8.48580197e-01
 -8.48580197e-01  5.18744008e-01  8.09219091e-01  8.09219091e-01
  8.09219091e-01  2.58819148e+00  3.89515778e+00  3.89515778e+00
  3.89515778e+00  8.99683046e+00  1.42361660e+01  1.42361660e+01
  1.42361660e+01  3.60807212e+01  5.28249027e+01  5.28249027e+01
  5.28249027e+01  1.39461037e+02  2.40606415e+02  2.40606415e+02
  2.40606415e+02  5.02389140e+02  1.86905308e+03  7.99853187e+03
  4.77663816e+04]
E1 = -182.59020043022412  E_coul = 54.04868291667098
cycle= 3 E= -128.541517513553  delta_E= -0.000919  |g|= 0.000499  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112873
diis-c [-2.50075001e-07 -2.39267358e-03 -8.86142378e-04  1.00327882e+00]
  HOMO = -0.84882906292774  LUMO = 0.51871411094585
  mo_energy =
[-3.27703508e+01 -1.92909522e+00 -8.48829063e-01 -8.48829063e-01
 -8.48829063e-01  5.18714111e-01  8.09181722e-01  8.09181722e-01
  8.09181722e-01  2.58810422e+00  3.89498985e+00  3.89498985e+00
  3.89498985e+00  8.99662508e+00  1.42358729e+01  1.42358729e+01
  1.42358729e+01  3.60803813e+01  5.28245119e+01  5.28245119e+01
  5.28245119e+01  1.39460590e+02  2.40605898e+02  2.40605898e+02
  2.40605898e+02  5.02388565e+02  1.86905237e+03  7.99853105e+03
  4.77663807e+04]
E1 = -182.59063328737705  E_coul = 54.04911574684697
cycle= 4 E= -128.54151754053  delta_E= -2.7e-08  |g|= 7.93e-05  |ddm|= 0.000383
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184311
diis-c [-1.20664219e-09  2.62809806e-04  4.89345488e-04 -1.99178889e-01
  1.19842673e+00]
  HOMO = -0.848871250188719  LUMO = 0.518706137622329
  mo_energy =
[-3.27704214e+01 -1.92912520e+00 -8.48871250e-01 -8.48871250e-01
 -8.48871250e-01  5.18706138e-01  8.09168426e-01  8.09168426e-01
  8.09168426e-01  2.58808355e+00  3.89495092e+00  3.89495092e+00
  3.89495092e+00  8.99658204e+00  1.42358153e+01  1.42358153e+01
  1.42358153e+01  3.60803191e+01  5.28244452e+01  5.28244452e+01
  5.28244452e+01  1.39460519e+02  2.40605823e+02  2.40605823e+02
  2.40605823e+02  5.02388485e+02  1.86905228e+03  7.99853096e+03
  4.77663806e+04]
E1 = -182.59076000714734  E_coul = 54.04924246583087
cycle= 5 E= -128.541517541316  delta_E= -7.86e-10  |g|= 6.48e-06  |ddm|= 7.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59076000714734  E_coul = 54.04924246583087
  HOMO = -0.848867731886894  LUMO = 0.518707087368131
  mo_energy =
[-3.27704135e+01 -1.92912088e+00 -8.48867732e-01 -8.48867732e-01
 -8.48867732e-01  5.18707087e-01  8.09169456e-01  8.09169456e-01
  8.09169456e-01  2.58808579e+00  3.89495428e+00  3.89495428e+00
  3.89495428e+00  8.99658654e+00  1.42358210e+01  1.42358210e+01
  1.42358210e+01  3.60803261e+01  5.28244527e+01  5.28244527e+01
  5.28244527e+01  1.39460527e+02  2.40605830e+02  2.40605830e+02
  2.40605830e+02  5.02388493e+02  1.86905229e+03  7.99853097e+03
  4.77663806e+04]
E1 = -182.59074195999577  E_coul = 54.049224418676104
Extra cycle  E= -128.54151754132  delta_E= -3.18e-12  |g|= 2.53e-06  |ddm|= 2.33e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [5.06089553e-01 2.44137942e+04 3.66145157e+03 8.33319278e+02
 2.35442258e+02 7.61403109e+01 1.00157567e+01 2.69105180e+01
 2.55707500e-01 1.15530620e+00 2.83859157e+00 7.11380537e+00
 2.31710088e+01 9.97863699e+01 2.67305852e-01 2.44236601e+00
 8.33639719e-01]
E = -128.54151754131965
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.506089552511       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157104        1
[INPUT] 0    0    [1    /1   ]  833.319277789        1
[INPUT] 0    0    [1    /1   ]  235.442257955        1
[INPUT] 0    0    [1    /1   ]  76.1403109131        1
[INPUT] 0    0    [1    /1   ]  10.0157566915        1
[INPUT] 0    0    [1    /1   ]  26.9105179674        1
[INPUT] 0    0    [1    /1   ]  0.255707500014       1
[INPUT] 0    0    [1    /1   ]  1.15530619698        1
[INPUT] 0    0    [1    /1   ]  2.838591572          1
[INPUT] 1    0    [1    /1   ]  7.11380536942        1
[INPUT] 1    0    [1    /1   ]  23.1710087536        1
[INPUT] 1    0    [1    /1   ]  99.7863699071        1
[INPUT] 1    0    [1    /1   ]  0.267305852171       1
[INPUT] 1    0    [1    /1   ]  2.44236601486        1
[INPUT] 1    0    [1    /1   ]  0.833639719215       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5060895525105114, 1.0]], [0, [24413.794186556403, 1.0]], [0, [3661.451571039556, 1.0]], [0, [833.3192777886077, 1.0]], [0, [235.44225795504457, 1.0]], [0, [76.14031091306971, 1.0]], [0, [10.015756691470036, 1.0]], [0, [26.910517967395663, 1.0]], [0, [0.2557075000143302, 1.0]], [0, [1.1553061969839284, 1.0]], [0, [2.838591572001749, 1.0]], [1, [7.11380536941847, 1.0]], [1, [23.171008753567538, 1.0]], [1, [99.78636990714955, 1.0]], [1, [0.26730585217131186, 1.0]], [1, [2.4423660148582527, 1.0]], [1, [0.8336397192153799, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50608955]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157104]
bas 3, expnt(s) = [833.31927779]
bas 4, expnt(s) = [235.44225796]
bas 5, expnt(s) = [76.14031091]
bas 6, expnt(s) = [10.01575669]
bas 7, expnt(s) = [26.91051797]
bas 8, expnt(s) = [0.2557075]
bas 9, expnt(s) = [1.1553062]
bas 10, expnt(s) = [2.83859157]
bas 11, expnt(s) = [7.11380537]
bas 12, expnt(s) = [23.17100875]
bas 13, expnt(s) = [99.78636991]
bas 14, expnt(s) = [0.26730585]
bas 15, expnt(s) = [2.44236601]
bas 16, expnt(s) = [0.83363972]
CPU time:        18.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.06089553e-01 1.51595236e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319278e+02 3.91853379e+02
 2.35442258e+02 1.51854734e+02 7.61403109e+01 6.51217419e+01
 1.00157567e+01 1.42242000e+01 2.69105180e+01 2.98508407e+01
 2.55707500e-01 9.08495173e-01 1.15530620e+00 2.81538538e+00
 2.83859157e+00 5.52512625e+00 7.11380537e+00 3.38931447e+01
 2.31710088e+01 1.48308338e+02 9.97863699e+01 9.20075407e+02
 2.67305852e-01 5.60718618e-01 2.44236601e+00 8.90733585e+00
 8.33639719e-01 2.32384625e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999623864077051
cond(S) = 825.9681921555137
E1 = -183.5897967096585  E_coul = 55.08027290948311
init E= -128.509523800175
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401402611275  LUMO = 0.530893391467744
  mo_energy =
[-3.25550227e+01 -1.85269177e+00 -7.75401403e-01 -7.75401403e-01
 -7.75401403e-01  5.30893391e-01  8.27261723e-01  8.27261723e-01
  8.27261723e-01  2.62398395e+00  3.96086124e+00  3.96086124e+00
  3.96086124e+00  9.08400830e+00  1.43635716e+01  1.43635716e+01
  1.43635716e+01  3.62434682e+01  5.30116660e+01  5.30116660e+01
  5.30116660e+01  1.39672253e+02  2.40838828e+02  2.40838828e+02
  2.40838828e+02  5.02633588e+02  1.86932832e+03  7.99883371e+03
  4.77667013e+04]
E1 = -182.08736880959054  E_coul = 53.549357780930706
cycle= 1 E= -128.53801102866  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521058
diis-c [-0.27150155  1.        ]
  HOMO = -0.884195997451639  LUMO = 0.512990566140486
  mo_energy =
[-3.28779742e+01 -1.96641918e+00 -8.84195997e-01 -8.84195997e-01
 -8.84195997e-01  5.12990566e-01  8.00467228e-01  8.00467228e-01
  8.00467228e-01  2.57114704e+00  3.86355040e+00  3.86355040e+00
  3.86355040e+00  8.95430662e+00  1.41729973e+01  1.41729973e+01
  1.41729973e+01  3.59987215e+01  5.27309119e+01  5.27309119e+01
  5.27309119e+01  1.39355184e+02  2.40492778e+02  2.40492778e+02
  2.40492778e+02  5.02272365e+02  1.86893104e+03  7.99840738e+03
  4.77662562e+04]
E1 = -182.8485307512356  E_coul = 54.30793196034083
cycle= 2 E= -128.540598790895  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26466
diis-c [-6.46658877e-04  3.36069334e-01  6.63930666e-01]
  HOMO = -0.848580197422466  LUMO = 0.518744007686145
  mo_energy =
[-3.27699063e+01 -1.92891623e+00 -8.48580197e-01 -8.48580197e-01
 -8.48580197e-01  5.18744008e-01  8.09219091e-01  8.09219091e-01
  8.09219091e-01  2.58819148e+00  3.89515778e+00  3.89515778e+00
  3.89515778e+00  8.99683046e+00  1.42361660e+01  1.42361660e+01
  1.42361660e+01  3.60807212e+01  5.28249027e+01  5.28249027e+01
  5.28249027e+01  1.39461037e+02  2.40606415e+02  2.40606415e+02
  2.40606415e+02  5.02389140e+02  1.86905308e+03  7.99853187e+03
  4.77663816e+04]
E1 = -182.59020043022412  E_coul = 54.04868291667098
cycle= 3 E= -128.541517513553  delta_E= -0.000919  |g|= 0.000499  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112873
diis-c [-2.50075001e-07 -2.39267358e-03 -8.86142378e-04  1.00327882e+00]
  HOMO = -0.84882906292774  LUMO = 0.51871411094585
  mo_energy =
[-3.27703508e+01 -1.92909522e+00 -8.48829063e-01 -8.48829063e-01
 -8.48829063e-01  5.18714111e-01  8.09181722e-01  8.09181722e-01
  8.09181722e-01  2.58810422e+00  3.89498985e+00  3.89498985e+00
  3.89498985e+00  8.99662508e+00  1.42358729e+01  1.42358729e+01
  1.42358729e+01  3.60803813e+01  5.28245119e+01  5.28245119e+01
  5.28245119e+01  1.39460590e+02  2.40605898e+02  2.40605898e+02
  2.40605898e+02  5.02388565e+02  1.86905237e+03  7.99853105e+03
  4.77663807e+04]
E1 = -182.59063328737705  E_coul = 54.04911574684697
cycle= 4 E= -128.54151754053  delta_E= -2.7e-08  |g|= 7.93e-05  |ddm|= 0.000383
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184311
diis-c [-1.20664219e-09  2.62809806e-04  4.89345488e-04 -1.99178889e-01
  1.19842673e+00]
  HOMO = -0.848871250188719  LUMO = 0.518706137622329
  mo_energy =
[-3.27704214e+01 -1.92912520e+00 -8.48871250e-01 -8.48871250e-01
 -8.48871250e-01  5.18706138e-01  8.09168426e-01  8.09168426e-01
  8.09168426e-01  2.58808355e+00  3.89495092e+00  3.89495092e+00
  3.89495092e+00  8.99658204e+00  1.42358153e+01  1.42358153e+01
  1.42358153e+01  3.60803191e+01  5.28244452e+01  5.28244452e+01
  5.28244452e+01  1.39460519e+02  2.40605823e+02  2.40605823e+02
  2.40605823e+02  5.02388485e+02  1.86905228e+03  7.99853096e+03
  4.77663806e+04]
E1 = -182.59076000714734  E_coul = 54.04924246583087
cycle= 5 E= -128.541517541316  delta_E= -7.86e-10  |g|= 6.48e-06  |ddm|= 7.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59076000714734  E_coul = 54.04924246583087
  HOMO = -0.848867731886894  LUMO = 0.518707087368131
  mo_energy =
[-3.27704135e+01 -1.92912088e+00 -8.48867732e-01 -8.48867732e-01
 -8.48867732e-01  5.18707087e-01  8.09169456e-01  8.09169456e-01
  8.09169456e-01  2.58808579e+00  3.89495428e+00  3.89495428e+00
  3.89495428e+00  8.99658654e+00  1.42358210e+01  1.42358210e+01
  1.42358210e+01  3.60803261e+01  5.28244527e+01  5.28244527e+01
  5.28244527e+01  1.39460527e+02  2.40605830e+02  2.40605830e+02
  2.40605830e+02  5.02388493e+02  1.86905229e+03  7.99853097e+03
  4.77663806e+04]
E1 = -182.59074195999577  E_coul = 54.049224418676104
Extra cycle  E= -128.54151754132  delta_E= -3.18e-12  |g|= 2.53e-06  |ddm|= 2.33e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 825.9681921555137
E1 = -182.59074195999577  E_coul = 54.049224418676104
init E= -128.54151754132
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848869004685456  LUMO = 0.518706942194229
  mo_energy =
[-3.27704175e+01 -1.92912209e+00 -8.48869005e-01 -8.48869005e-01
 -8.48869005e-01  5.18706942e-01  8.09169163e-01  8.09169163e-01
  8.09169163e-01  2.58808526e+00  3.89495317e+00  3.89495317e+00
  3.89495317e+00  8.99658509e+00  1.42358187e+01  1.42358187e+01
  1.42358187e+01  3.60803231e+01  5.28244492e+01  5.28244492e+01
  5.28244492e+01  1.39460523e+02  2.40605826e+02  2.40605826e+02
  2.40605826e+02  5.02388488e+02  1.86905228e+03  7.99853096e+03
  4.77663806e+04]
E1 = -182.59075193787945  E_coul = 54.049234396559235
cycle= 1 E= -128.54151754132  delta_E= -5.68e-13  |g|= 1.36e-06  |ddm|= 9.01e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59075193787945  E_coul = 54.049234396559235
  HOMO = -0.848868301495987  LUMO = 0.518707067438779
  mo_energy =
[-3.27704154e+01 -1.92912132e+00 -8.48868301e-01 -8.48868301e-01
 -8.48868301e-01  5.18707067e-01  8.09169339e-01  8.09169339e-01
  8.09169339e-01  2.58808562e+00  3.89495380e+00  3.89495380e+00
  3.89495380e+00  8.99658594e+00  1.42358200e+01  1.42358200e+01
  1.42358200e+01  3.60803247e+01  5.28244511e+01  5.28244511e+01
  5.28244511e+01  1.39460525e+02  2.40605828e+02  2.40605828e+02
  2.40605828e+02  5.02388491e+02  1.86905228e+03  7.99853097e+03
  4.77663806e+04]
E1 = -182.5907469195266  E_coul = 54.04922937820685
Extra cycle  E= -128.54151754132  delta_E= 4.83e-13  |g|= 6.82e-07  |ddm|= 4.33e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.41 sec
exp = [5.06089553e-01 2.44137942e+04 3.66145157e+03 8.33319278e+02
 2.35442258e+02 7.61403109e+01 1.00157567e+01 2.69105180e+01
 2.55707500e-01 1.15530620e+00 2.83859157e+00 7.11380537e+00
 2.31710088e+01 9.97863699e+01 2.67305852e-01 2.44236601e+00
 8.33639719e-01]
grad_E = [ 7.40326187e-04  1.59503347e-10 -7.35730337e-09  9.10709464e-08
 -5.56407934e-07  9.53952548e-06 -1.64345115e-05 -2.51713120e-05
 -3.07926424e-04 -1.87332947e-03  3.38640980e-04 -1.32036796e-04
  1.12304147e-05 -3.41567725e-07  5.75193594e-03  8.17287716e-04
 -3.01001847e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.505529955761       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157101        1
[INPUT] 0    0    [1    /1   ]  833.31927879         1
[INPUT] 0    0    [1    /1   ]  235.442242209        1
[INPUT] 0    0    [1    /1   ]  76.1403949062        1
[INPUT] 0    0    [1    /1   ]  10.017406863         1
[INPUT] 0    0    [1    /1   ]  26.9099911104        1
[INPUT] 0    0    [1    /1   ]  0.247704610433       1
[INPUT] 0    0    [1    /1   ]  1.16055732886        1
[INPUT] 0    0    [1    /1   ]  2.83674010042        1
[INPUT] 1    0    [1    /1   ]  7.11382695633        1
[INPUT] 1    0    [1    /1   ]  23.171006379         1
[INPUT] 1    0    [1    /1   ]  99.7863697986        1
[INPUT] 1    0    [1    /1   ]  0.266781372463       1
[INPUT] 1    0    [1    /1   ]  2.44226179429        1
[INPUT] 1    0    [1    /1   ]  0.833930291446       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5055299557613853, 1.0]], [0, [24413.79418655683, 1.0]], [0, [3661.4515710098767, 1.0]], [0, [833.319278790366, 1.0]], [0, [235.44224220946657, 1.0]], [0, [76.14039490623782, 1.0]], [0, [10.017406862972534, 1.0]], [0, [26.909991110377394, 1.0]], [0, [0.24770461043345168, 1.0]], [0, [1.1605573288619557, 1.0]], [0, [2.836740100423326, 1.0]], [1, [7.113826956334381, 1.0]], [1, [23.17100637895559, 1.0]], [1, [99.78636979864197, 1.0]], [1, [0.26678137246264255, 1.0]], [1, [2.4422617942865394, 1.0]], [1, [0.8339302914462449, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50552996]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157101]
bas 3, expnt(s) = [833.31927879]
bas 4, expnt(s) = [235.44224221]
bas 5, expnt(s) = [76.14039491]
bas 6, expnt(s) = [10.01740686]
bas 7, expnt(s) = [26.90999111]
bas 8, expnt(s) = [0.24770461]
bas 9, expnt(s) = [1.16055733]
bas 10, expnt(s) = [2.8367401]
bas 11, expnt(s) = [7.11382696]
bas 12, expnt(s) = [23.17100638]
bas 13, expnt(s) = [99.7863698]
bas 14, expnt(s) = [0.26678137]
bas 15, expnt(s) = [2.44226179]
bas 16, expnt(s) = [0.83393029]
CPU time:        21.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.05529956e-01 1.51469501e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319279e+02 3.91853379e+02
 2.35442242e+02 1.51854726e+02 7.61403949e+01 6.51217958e+01
 1.00174069e+01 1.42259576e+01 2.69099911e+01 2.98504024e+01
 2.47704610e-01 8.87085727e-01 1.16055733e+00 2.82497737e+00
 2.83674010e+00 5.52242320e+00 7.11382696e+00 3.38932733e+01
 2.31710064e+01 1.48308319e+02 9.97863698e+01 9.20075406e+02
 2.66781372e-01 5.59343725e-01 2.44226179e+00 8.90686074e+00
 8.33930291e-01 2.32485879e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999626434885066
cond(S) = 786.5775538215581
E1 = -183.58978314285773  E_coul = 55.08026836288677
init E= -128.509514779971
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775402726597988  LUMO = 0.518488920693461
  mo_energy =
[-3.25550217e+01 -1.85269731e+00 -7.75402727e-01 -7.75402727e-01
 -7.75402727e-01  5.18488921e-01  8.25939536e-01  8.25939536e-01
  8.25939536e-01  2.59697340e+00  3.95955799e+00  3.95955799e+00
  3.95955799e+00  9.05899358e+00  1.43625926e+01  1.43625926e+01
  1.43625926e+01  3.62245723e+01  5.30109155e+01  5.30109155e+01
  5.30109155e+01  1.39657973e+02  2.40838322e+02  2.40838322e+02
  2.40838322e+02  5.02621405e+02  1.86931755e+03  7.99882427e+03
  4.77666935e+04]
E1 = -182.0863185758828  E_coul = 53.54829988514404
cycle= 1 E= -128.538018690739  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521065
diis-c [-0.27150858  1.        ]
  HOMO = -0.884285129525357  LUMO = 0.500906546311812
  mo_energy =
[-3.28781387e+01 -1.96652276e+00 -8.84285130e-01 -8.84285130e-01
 -8.84285130e-01  5.00906546e-01  7.99134282e-01  7.99134282e-01
  7.99134282e-01  2.54412141e+00  3.86214032e+00  3.86214032e+00
  3.86214032e+00  8.92908716e+00  1.41718851e+01  1.41718851e+01
  1.41718851e+01  3.59796473e+01  5.27300048e+01  5.27300048e+01
  5.27300048e+01  1.39340734e+02  2.40492108e+02  2.40492108e+02
  2.40492108e+02  5.02260014e+02  1.86892010e+03  7.99839777e+03
  4.77662482e+04]
E1 = -182.84793854953293  E_coul = 54.30733017325952
cycle= 2 E= -128.540608376273  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264728
diis-c [-6.47254586e-04  3.36123855e-01  6.63876145e-01]
  HOMO = -0.848650234045607  LUMO = 0.506546587016023
  mo_energy =
[-3.27700169e+01 -1.92899966e+00 -8.48650234e-01 -8.48650234e-01
 -8.48650234e-01  5.06546587e-01  8.07881639e-01  8.07881639e-01
  8.07881639e-01  2.56115884e+00  3.89376919e+00  3.89376919e+00
  3.89376919e+00  8.97166894e+00  1.42350882e+01  1.42350882e+01
  1.42350882e+01  3.60617001e+01  5.28240436e+01  5.28240436e+01
  5.28240436e+01  1.39446642e+02  2.40605802e+02  2.40605802e+02
  2.40605802e+02  5.02376847e+02  1.86904220e+03  7.99852232e+03
  4.77663736e+04]
E1 = -182.58935474356775  E_coul = 54.04782626625431
cycle= 3 E= -128.541528477313  delta_E= -0.00092  |g|= 0.000506  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113746
diis-c [-2.52872730e-07 -2.41642976e-03 -9.01138561e-04  1.00331757e+00]
  HOMO = -0.848903672115626  LUMO = 0.506515077740519
  mo_energy =
[-3.27704677e+01 -1.92918425e+00 -8.48903672e-01 -8.48903672e-01
 -8.48903672e-01  5.06515078e-01  8.07842324e-01  8.07842324e-01
  8.07842324e-01  2.56106807e+00  3.89359647e+00  3.89359647e+00
  3.89359647e+00  8.97145795e+00  1.42347890e+01  1.42347890e+01
  1.42347890e+01  3.60613539e+01  5.28236465e+01  5.28236465e+01
  5.28236465e+01  1.39446188e+02  2.40605278e+02  2.40605278e+02
  2.40605278e+02  5.02376266e+02  1.86904148e+03  7.99852150e+03
  4.77663728e+04]
E1 = -182.58978808289154  E_coul = 54.048259577809965
cycle= 4 E= -128.541528505082  delta_E= -2.78e-08  |g|= 8e-05  |ddm|= 0.000377
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184813
diis-c [-1.18626787e-09  2.58444874e-04  4.85723089e-04 -1.96820786e-01
  1.19607662e+00]
  HOMO = -0.8489465137584  LUMO = 0.506506886629318
  mo_energy =
[-3.27705390e+01 -1.92921520e+00 -8.48946514e-01 -8.48946514e-01
 -8.48946514e-01  5.06506887e-01  8.07828743e-01  8.07828743e-01
  8.07828743e-01  2.56104680e+00  3.89355681e+00  3.89355681e+00
  3.89355681e+00  8.97141400e+00  1.42347305e+01  1.42347305e+01
  1.42347305e+01  3.60612909e+01  5.28235790e+01  5.28235790e+01
  5.28235790e+01  1.39446117e+02  2.40605203e+02  2.40605203e+02
  2.40605203e+02  5.02376185e+02  1.86904139e+03  7.99852140e+03
  4.77663727e+04]
E1 = -182.58991448870518  E_coul = 54.04838598282978
cycle= 5 E= -128.541528505875  delta_E= -7.94e-10  |g|= 6.4e-06  |ddm|= 6.87e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58991448870518  E_coul = 54.04838598282978
  HOMO = -0.848943054217182  LUMO = 0.506507809049611
  mo_energy =
[-3.27705312e+01 -1.92921094e+00 -8.48943054e-01 -8.48943054e-01
 -8.48943054e-01  5.06507809e-01  8.07829756e-01  8.07829756e-01
  8.07829756e-01  2.56104900e+00  3.89356011e+00  3.89356011e+00
  3.89356011e+00  8.97141844e+00  1.42347362e+01  1.42347362e+01
  1.42347362e+01  3.60612977e+01  5.28235863e+01  5.28235863e+01
  5.28235863e+01  1.39446124e+02  2.40605210e+02  2.40605210e+02
  2.40605210e+02  5.02376193e+02  1.86904140e+03  7.99852141e+03
  4.77663727e+04]
E1 = -182.58989670541595  E_coul = 54.04836819953777
Extra cycle  E= -128.541528505878  delta_E= -2.79e-12  |g|= 2.49e-06  |ddm|= 2.29e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [5.05529956e-01 2.44137942e+04 3.66145157e+03 8.33319279e+02
 2.35442242e+02 7.61403949e+01 1.00174069e+01 2.69099911e+01
 2.47704610e-01 1.16055733e+00 2.83674010e+00 7.11382696e+00
 2.31710064e+01 9.97863698e+01 2.66781372e-01 2.44226179e+00
 8.33930291e-01]
E = -128.54152850587818
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.505529955761       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157101        1
[INPUT] 0    0    [1    /1   ]  833.31927879         1
[INPUT] 0    0    [1    /1   ]  235.442242209        1
[INPUT] 0    0    [1    /1   ]  76.1403949062        1
[INPUT] 0    0    [1    /1   ]  10.017406863         1
[INPUT] 0    0    [1    /1   ]  26.9099911104        1
[INPUT] 0    0    [1    /1   ]  0.247704610433       1
[INPUT] 0    0    [1    /1   ]  1.16055732886        1
[INPUT] 0    0    [1    /1   ]  2.83674010042        1
[INPUT] 1    0    [1    /1   ]  7.11382695633        1
[INPUT] 1    0    [1    /1   ]  23.171006379         1
[INPUT] 1    0    [1    /1   ]  99.7863697986        1
[INPUT] 1    0    [1    /1   ]  0.266781372463       1
[INPUT] 1    0    [1    /1   ]  2.44226179429        1
[INPUT] 1    0    [1    /1   ]  0.833930291446       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5055299557613853, 1.0]], [0, [24413.79418655683, 1.0]], [0, [3661.4515710098767, 1.0]], [0, [833.319278790366, 1.0]], [0, [235.44224220946657, 1.0]], [0, [76.14039490623782, 1.0]], [0, [10.017406862972534, 1.0]], [0, [26.909991110377394, 1.0]], [0, [0.24770461043345168, 1.0]], [0, [1.1605573288619557, 1.0]], [0, [2.836740100423326, 1.0]], [1, [7.113826956334381, 1.0]], [1, [23.17100637895559, 1.0]], [1, [99.78636979864197, 1.0]], [1, [0.26678137246264255, 1.0]], [1, [2.4422617942865394, 1.0]], [1, [0.8339302914462449, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50552996]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157101]
bas 3, expnt(s) = [833.31927879]
bas 4, expnt(s) = [235.44224221]
bas 5, expnt(s) = [76.14039491]
bas 6, expnt(s) = [10.01740686]
bas 7, expnt(s) = [26.90999111]
bas 8, expnt(s) = [0.24770461]
bas 9, expnt(s) = [1.16055733]
bas 10, expnt(s) = [2.8367401]
bas 11, expnt(s) = [7.11382696]
bas 12, expnt(s) = [23.17100638]
bas 13, expnt(s) = [99.7863698]
bas 14, expnt(s) = [0.26678137]
bas 15, expnt(s) = [2.44226179]
bas 16, expnt(s) = [0.83393029]
CPU time:        22.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.05529956e-01 1.51469501e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319279e+02 3.91853379e+02
 2.35442242e+02 1.51854726e+02 7.61403949e+01 6.51217958e+01
 1.00174069e+01 1.42259576e+01 2.69099911e+01 2.98504024e+01
 2.47704610e-01 8.87085727e-01 1.16055733e+00 2.82497737e+00
 2.83674010e+00 5.52242320e+00 7.11382696e+00 3.38932733e+01
 2.31710064e+01 1.48308319e+02 9.97863698e+01 9.20075406e+02
 2.66781372e-01 5.59343725e-01 2.44226179e+00 8.90686074e+00
 8.33930291e-01 2.32485879e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999626434885066
cond(S) = 786.5775538215581
E1 = -183.58978314285773  E_coul = 55.08026836288677
init E= -128.509514779971
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402726597988  LUMO = 0.518488920693461
  mo_energy =
[-3.25550217e+01 -1.85269731e+00 -7.75402727e-01 -7.75402727e-01
 -7.75402727e-01  5.18488921e-01  8.25939536e-01  8.25939536e-01
  8.25939536e-01  2.59697340e+00  3.95955799e+00  3.95955799e+00
  3.95955799e+00  9.05899358e+00  1.43625926e+01  1.43625926e+01
  1.43625926e+01  3.62245723e+01  5.30109155e+01  5.30109155e+01
  5.30109155e+01  1.39657973e+02  2.40838322e+02  2.40838322e+02
  2.40838322e+02  5.02621405e+02  1.86931755e+03  7.99882427e+03
  4.77666935e+04]
E1 = -182.0863185758828  E_coul = 53.54829988514404
cycle= 1 E= -128.538018690739  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521065
diis-c [-0.27150858  1.        ]
  HOMO = -0.884285129525357  LUMO = 0.500906546311812
  mo_energy =
[-3.28781387e+01 -1.96652276e+00 -8.84285130e-01 -8.84285130e-01
 -8.84285130e-01  5.00906546e-01  7.99134282e-01  7.99134282e-01
  7.99134282e-01  2.54412141e+00  3.86214032e+00  3.86214032e+00
  3.86214032e+00  8.92908716e+00  1.41718851e+01  1.41718851e+01
  1.41718851e+01  3.59796473e+01  5.27300048e+01  5.27300048e+01
  5.27300048e+01  1.39340734e+02  2.40492108e+02  2.40492108e+02
  2.40492108e+02  5.02260014e+02  1.86892010e+03  7.99839777e+03
  4.77662482e+04]
E1 = -182.84793854953293  E_coul = 54.30733017325952
cycle= 2 E= -128.540608376273  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264728
diis-c [-6.47254586e-04  3.36123855e-01  6.63876145e-01]
  HOMO = -0.848650234045607  LUMO = 0.506546587016023
  mo_energy =
[-3.27700169e+01 -1.92899966e+00 -8.48650234e-01 -8.48650234e-01
 -8.48650234e-01  5.06546587e-01  8.07881639e-01  8.07881639e-01
  8.07881639e-01  2.56115884e+00  3.89376919e+00  3.89376919e+00
  3.89376919e+00  8.97166894e+00  1.42350882e+01  1.42350882e+01
  1.42350882e+01  3.60617001e+01  5.28240436e+01  5.28240436e+01
  5.28240436e+01  1.39446642e+02  2.40605802e+02  2.40605802e+02
  2.40605802e+02  5.02376847e+02  1.86904220e+03  7.99852232e+03
  4.77663736e+04]
E1 = -182.58935474356775  E_coul = 54.04782626625431
cycle= 3 E= -128.541528477313  delta_E= -0.00092  |g|= 0.000506  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113746
diis-c [-2.52872730e-07 -2.41642976e-03 -9.01138561e-04  1.00331757e+00]
  HOMO = -0.848903672115626  LUMO = 0.506515077740519
  mo_energy =
[-3.27704677e+01 -1.92918425e+00 -8.48903672e-01 -8.48903672e-01
 -8.48903672e-01  5.06515078e-01  8.07842324e-01  8.07842324e-01
  8.07842324e-01  2.56106807e+00  3.89359647e+00  3.89359647e+00
  3.89359647e+00  8.97145795e+00  1.42347890e+01  1.42347890e+01
  1.42347890e+01  3.60613539e+01  5.28236465e+01  5.28236465e+01
  5.28236465e+01  1.39446188e+02  2.40605278e+02  2.40605278e+02
  2.40605278e+02  5.02376266e+02  1.86904148e+03  7.99852150e+03
  4.77663728e+04]
E1 = -182.58978808289154  E_coul = 54.048259577809965
cycle= 4 E= -128.541528505082  delta_E= -2.78e-08  |g|= 8e-05  |ddm|= 0.000377
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184813
diis-c [-1.18626787e-09  2.58444874e-04  4.85723089e-04 -1.96820786e-01
  1.19607662e+00]
  HOMO = -0.8489465137584  LUMO = 0.506506886629318
  mo_energy =
[-3.27705390e+01 -1.92921520e+00 -8.48946514e-01 -8.48946514e-01
 -8.48946514e-01  5.06506887e-01  8.07828743e-01  8.07828743e-01
  8.07828743e-01  2.56104680e+00  3.89355681e+00  3.89355681e+00
  3.89355681e+00  8.97141400e+00  1.42347305e+01  1.42347305e+01
  1.42347305e+01  3.60612909e+01  5.28235790e+01  5.28235790e+01
  5.28235790e+01  1.39446117e+02  2.40605203e+02  2.40605203e+02
  2.40605203e+02  5.02376185e+02  1.86904139e+03  7.99852140e+03
  4.77663727e+04]
E1 = -182.58991448870518  E_coul = 54.04838598282978
cycle= 5 E= -128.541528505875  delta_E= -7.94e-10  |g|= 6.4e-06  |ddm|= 6.87e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58991448870518  E_coul = 54.04838598282978
  HOMO = -0.848943054217182  LUMO = 0.506507809049611
  mo_energy =
[-3.27705312e+01 -1.92921094e+00 -8.48943054e-01 -8.48943054e-01
 -8.48943054e-01  5.06507809e-01  8.07829756e-01  8.07829756e-01
  8.07829756e-01  2.56104900e+00  3.89356011e+00  3.89356011e+00
  3.89356011e+00  8.97141844e+00  1.42347362e+01  1.42347362e+01
  1.42347362e+01  3.60612977e+01  5.28235863e+01  5.28235863e+01
  5.28235863e+01  1.39446124e+02  2.40605210e+02  2.40605210e+02
  2.40605210e+02  5.02376193e+02  1.86904140e+03  7.99852141e+03
  4.77663727e+04]
E1 = -182.58989670541595  E_coul = 54.04836819953777
Extra cycle  E= -128.541528505878  delta_E= -2.79e-12  |g|= 2.49e-06  |ddm|= 2.29e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 786.5775538215581
E1 = -182.58989670541595  E_coul = 54.04836819953777
init E= -128.541528505878
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.848944309352966  LUMO = 0.506507669862569
  mo_energy =
[-3.27705351e+01 -1.92921212e+00 -8.48944309e-01 -8.48944309e-01
 -8.48944309e-01  5.06507670e-01  8.07829467e-01  8.07829467e-01
  8.07829467e-01  2.56104848e+00  3.89355903e+00  3.89355903e+00
  3.89355903e+00  8.97141701e+00  1.42347339e+01  1.42347339e+01
  1.42347339e+01  3.60612948e+01  5.28235829e+01  5.28235829e+01
  5.28235829e+01  1.39446120e+02  2.40605206e+02  2.40605206e+02
  2.40605206e+02  5.02376189e+02  1.86904140e+03  7.99852141e+03
  4.77663727e+04]
E1 = -182.5899065402375  E_coul = 54.04837803435881
cycle= 1 E= -128.541528505879  delta_E= -5.12e-13  |g|= 1.35e-06  |ddm|= 8.88e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5899065402375  E_coul = 54.04837803435881
  HOMO = -0.848943616381761  LUMO = 0.506507791083838
  mo_energy =
[-3.27705330e+01 -1.92921136e+00 -8.48943616e-01 -8.48943616e-01
 -8.48943616e-01  5.06507791e-01  8.07829641e-01  8.07829641e-01
  8.07829641e-01  2.56104883e+00  3.89355965e+00  3.89355965e+00
  3.89355965e+00  8.97141785e+00  1.42347351e+01  1.42347351e+01
  1.42347351e+01  3.60612964e+01  5.28235847e+01  5.28235847e+01
  5.28235847e+01  1.39446123e+02  2.40605208e+02  2.40605208e+02
  2.40605208e+02  5.02376191e+02  1.86904140e+03  7.99852141e+03
  4.77663727e+04]
E1 = -182.58990159234335  E_coul = 54.048373086464416
Extra cycle  E= -128.541528505879  delta_E= -2.56e-13  |g|= 6.72e-07  |ddm|= 4.28e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [5.05529956e-01 2.44137942e+04 3.66145157e+03 8.33319279e+02
 2.35442242e+02 7.61403949e+01 1.00174069e+01 2.69099911e+01
 2.47704610e-01 1.16055733e+00 2.83674010e+00 7.11382696e+00
 2.31710064e+01 9.97863698e+01 2.66781372e-01 2.44226179e+00
 8.33930291e-01]
grad_E = [ 9.10240172e-04  1.75096864e-10 -8.17464431e-09  1.07491453e-07
 -7.50490325e-07  1.10077697e-05 -6.20560258e-06 -3.14182858e-05
 -4.69739097e-04 -1.89800541e-03  3.23651993e-04 -7.23539851e-05
  6.19190510e-06 -1.77004641e-07  3.17617231e-03  4.45048368e-04
 -1.63772667e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.498742231241       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157088        1
[INPUT] 0    0    [1    /1   ]  833.319283611        1
[INPUT] 0    0    [1    /1   ]  235.442163186        1
[INPUT] 0    0    [1    /1   ]  76.1407920536        1
[INPUT] 0    0    [1    /1   ]  10.0259692824        1
[INPUT] 0    0    [1    /1   ]  26.9073706804        1
[INPUT] 0    0    [1    /1   ]  0.208425361003       1
[INPUT] 0    0    [1    /1   ]  1.19463629397        1
[INPUT] 0    0    [1    /1   ]  2.82595731152        1
[INPUT] 1    0    [1    /1   ]  7.11392874331        1
[INPUT] 1    0    [1    /1   ]  23.1709943751        1
[INPUT] 1    0    [1    /1   ]  99.7863691405        1
[INPUT] 1    0    [1    /1   ]  0.265392366245       1
[INPUT] 1    0    [1    /1   ]  2.44183814115        1
[INPUT] 1    0    [1    /1   ]  0.834753038753       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.4987422312407592, 1.0]], [0, [24413.794186558436, 1.0]], [0, [3661.45157088435, 1.0]], [0, [833.3192836110213, 1.0]], [0, [235.44216318643643, 1.0]], [0, [76.14079205360562, 1.0]], [0, [10.025969282367983, 1.0]], [0, [26.907370680394777, 1.0]], [0, [0.20842536100306688, 1.0]], [0, [1.1946362939668347, 1.0]], [0, [2.8259573115247147, 1.0]], [1, [7.113928743308111, 1.0]], [1, [23.170994375106407, 1.0]], [1, [99.78636914053041, 1.0]], [1, [0.2653923662446016, 1.0]], [1, [2.4418381411531476, 1.0]], [1, [0.8347530387529827, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49874223]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157088]
bas 3, expnt(s) = [833.31928361]
bas 4, expnt(s) = [235.44216319]
bas 5, expnt(s) = [76.14079205]
bas 6, expnt(s) = [10.02596928]
bas 7, expnt(s) = [26.90737068]
bas 8, expnt(s) = [0.20842536]
bas 9, expnt(s) = [1.19463629]
bas 10, expnt(s) = [2.82595731]
bas 11, expnt(s) = [7.11392874]
bas 12, expnt(s) = [23.17099438]
bas 13, expnt(s) = [99.78636914]
bas 14, expnt(s) = [0.26539237]
bas 15, expnt(s) = [2.44183814]
bas 16, expnt(s) = [0.83475304]
CPU time:        24.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.98742231e-01 1.49941597e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319284e+02 3.91853381e+02
 2.35442163e+02 1.51854688e+02 7.61407921e+01 6.51220505e+01
 1.00259693e+01 1.42350764e+01 2.69073707e+01 2.98482223e+01
 2.08425361e-01 7.79341757e-01 1.19463629e+00 2.88696689e+00
 2.82595731e+00 5.50667217e+00 7.11392874e+00 3.38938795e+01
 2.31709944e+01 1.48308223e+02 9.97863691e+01 9.20075398e+02
 2.65392366e-01 5.55705795e-01 2.44183814e+00 8.90492947e+00
 8.34753039e-01 2.32772625e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999628064694893
cond(S) = 644.1137222184916
E1 = -183.58973795342558  E_coul = 55.08022565871128
init E= -128.509512294714
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775405121664944  LUMO = 0.452533841638997
  mo_energy =
[-3.25550310e+01 -1.85272177e+00 -7.75405122e-01 -7.75405122e-01
 -7.75405122e-01  4.52533842e-01  8.22446763e-01  8.22446763e-01
  8.22446763e-01  2.45471863e+00  3.95615837e+00  3.95615837e+00
  3.95615837e+00  8.94045611e+00  1.43598242e+01  1.43598242e+01
  1.43598242e+01  3.61445599e+01  5.30087099e+01  5.30087099e+01
  5.30087099e+01  1.39600884e+02  2.40836819e+02  2.40836819e+02
  2.40836819e+02  5.02573477e+02  1.86927532e+03  7.99878728e+03
  4.77666629e+04]
E1 = -182.08383626181006  E_coul = 53.54578402286528
cycle= 1 E= -128.538052238945  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520508
diis-c [-0.27092904  1.        ]
  HOMO = -0.8844919886244  LUMO = 0.436828622807045
  mo_energy =
[-3.28785326e+01 -1.96678857e+00 -8.84491989e-01 -8.84491989e-01
 -8.84491989e-01  4.36828623e-01  7.95620544e-01  7.95620544e-01
  7.95620544e-01  2.40186170e+00  3.85847747e+00  3.85847747e+00
  3.85847747e+00  8.80964939e+00  1.41688095e+01  1.41688095e+01
  1.41688095e+01  3.58991438e+01  5.27274377e+01  5.27274377e+01
  5.27274377e+01  1.39283230e+02  2.40490227e+02  2.40490227e+02
  2.40490227e+02  5.02211693e+02  1.86887747e+03  7.99836038e+03
  4.77662172e+04]
E1 = -182.84642750735452  E_coul = 54.3057820202536
cycle= 2 E= -128.540645487101  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264638
diis-c [-6.49137345e-04  3.36283415e-01  6.63716585e-01]
  HOMO = -0.848818595851417  LUMO = 0.441839478725379
  mo_energy =
[-3.27703048e+01 -1.92922508e+00 -8.48818596e-01 -8.48818596e-01
 -8.48818596e-01  4.41839479e-01  8.04353381e-01  8.04353381e-01
  8.04353381e-01  2.41886350e+00  3.89015212e+00  3.89015212e+00
  3.89015212e+00  8.85250096e+00  1.42320818e+01  1.42320818e+01
  1.42320818e+01  3.59813364e+01  5.28215717e+01  5.28215717e+01
  5.28215717e+01  1.39389253e+02  2.40604031e+02  2.40604031e+02
  2.40604031e+02  5.02328640e+02  1.86899969e+03  7.99848505e+03
  4.77663428e+04]
E1 = -182.5872506763574  E_coul = 54.04568198232314
cycle= 3 E= -128.541568694034  delta_E= -0.000923  |g|= 0.000525  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115554
diis-c [-2.67785356e-07 -2.50626319e-03 -1.02515781e-03  1.00353142e+00]
  HOMO = -0.849084128866764  LUMO = 0.441805628517812
  mo_energy =
[-3.27707707e+01 -1.92942549e+00 -8.49084129e-01 -8.49084129e-01
 -8.49084129e-01  4.41805629e-01  8.04308799e-01  8.04308799e-01
  8.04308799e-01  2.41876310e+00  3.88996641e+00  3.88996641e+00
  3.88996641e+00  8.85227419e+00  1.42317667e+01  1.42317667e+01
  1.42317667e+01  3.59809742e+01  5.28211588e+01  5.28211588e+01
  5.28211588e+01  1.39388785e+02  2.40603494e+02  2.40603494e+02
  2.40603494e+02  5.02328045e+02  1.86899896e+03  7.99848421e+03
  4.77663419e+04]
E1 = -182.5876807940564  E_coul = 54.0461120701851
cycle= 4 E= -128.541568723871  delta_E= -2.98e-08  |g|= 8.14e-05  |ddm|= 0.000327
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184487
diis-c [-1.11245639e-09  2.45470575e-04  4.73174153e-04 -1.89809276e-01
  1.18909063e+00]
  HOMO = -0.849128452898017  LUMO = 0.441797354792594
  mo_energy =
[-3.27708434e+01 -1.92945897e+00 -8.49128453e-01 -8.49128453e-01
 -8.49128453e-01  4.41797355e-01  8.04294504e-01  8.04294504e-01
  8.04294504e-01  2.41874024e+00  3.88992502e+00  3.88992502e+00
  3.88992502e+00  8.85222789e+00  1.42317063e+01  1.42317063e+01
  1.42317063e+01  3.59809092e+01  5.28210897e+01  5.28210897e+01
  5.28210897e+01  1.39388712e+02  2.40603417e+02  2.40603417e+02
  2.40603417e+02  5.02327964e+02  1.86899887e+03  7.99848412e+03
  4.77663418e+04]
E1 = -182.58780458471603  E_coul = 54.04623586003958
cycle= 5 E= -128.541568724676  delta_E= -8.05e-10  |g|= 6.1e-06  |ddm|= 5.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58780458471603  E_coul = 54.04623586003958
  HOMO = -0.849125191045538  LUMO = 0.441798146082177
  mo_energy =
[-3.27708359e+01 -1.92945491e+00 -8.49125191e-01 -8.49125191e-01
 -8.49125191e-01  4.41798146e-01  8.04295456e-01  8.04295456e-01
  8.04295456e-01  2.41874233e+00  3.88992815e+00  3.88992815e+00
  3.88992815e+00  8.85223212e+00  1.42317117e+01  1.42317117e+01
  1.42317117e+01  3.59809157e+01  5.28210966e+01  5.28210966e+01
  5.28210966e+01  1.39388719e+02  2.40603424e+02  2.40603424e+02
  2.40603424e+02  5.02327972e+02  1.86899888e+03  7.99848413e+03
  4.77663418e+04]
E1 = -182.58778763766898  E_coul = 54.0462189129899
Extra cycle  E= -128.541568724679  delta_E= -2.64e-12  |g|= 2.37e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [4.98742231e-01 2.44137942e+04 3.66145157e+03 8.33319284e+02
 2.35442163e+02 7.61407921e+01 1.00259693e+01 2.69073707e+01
 2.08425361e-01 1.19463629e+00 2.82595731e+00 7.11392874e+00
 2.31709944e+01 9.97863691e+01 2.65392366e-01 2.44183814e+00
 8.34753039e-01]
E = -128.54156872467908
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.498742231241       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157088        1
[INPUT] 0    0    [1    /1   ]  833.319283611        1
[INPUT] 0    0    [1    /1   ]  235.442163186        1
[INPUT] 0    0    [1    /1   ]  76.1407920536        1
[INPUT] 0    0    [1    /1   ]  10.0259692824        1
[INPUT] 0    0    [1    /1   ]  26.9073706804        1
[INPUT] 0    0    [1    /1   ]  0.208425361003       1
[INPUT] 0    0    [1    /1   ]  1.19463629397        1
[INPUT] 0    0    [1    /1   ]  2.82595731152        1
[INPUT] 1    0    [1    /1   ]  7.11392874331        1
[INPUT] 1    0    [1    /1   ]  23.1709943751        1
[INPUT] 1    0    [1    /1   ]  99.7863691405        1
[INPUT] 1    0    [1    /1   ]  0.265392366245       1
[INPUT] 1    0    [1    /1   ]  2.44183814115        1
[INPUT] 1    0    [1    /1   ]  0.834753038753       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.4987422312407592, 1.0]], [0, [24413.794186558436, 1.0]], [0, [3661.45157088435, 1.0]], [0, [833.3192836110213, 1.0]], [0, [235.44216318643643, 1.0]], [0, [76.14079205360562, 1.0]], [0, [10.025969282367983, 1.0]], [0, [26.907370680394777, 1.0]], [0, [0.20842536100306688, 1.0]], [0, [1.1946362939668347, 1.0]], [0, [2.8259573115247147, 1.0]], [1, [7.113928743308111, 1.0]], [1, [23.170994375106407, 1.0]], [1, [99.78636914053041, 1.0]], [1, [0.2653923662446016, 1.0]], [1, [2.4418381411531476, 1.0]], [1, [0.8347530387529827, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49874223]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157088]
bas 3, expnt(s) = [833.31928361]
bas 4, expnt(s) = [235.44216319]
bas 5, expnt(s) = [76.14079205]
bas 6, expnt(s) = [10.02596928]
bas 7, expnt(s) = [26.90737068]
bas 8, expnt(s) = [0.20842536]
bas 9, expnt(s) = [1.19463629]
bas 10, expnt(s) = [2.82595731]
bas 11, expnt(s) = [7.11392874]
bas 12, expnt(s) = [23.17099438]
bas 13, expnt(s) = [99.78636914]
bas 14, expnt(s) = [0.26539237]
bas 15, expnt(s) = [2.44183814]
bas 16, expnt(s) = [0.83475304]
CPU time:        24.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.98742231e-01 1.49941597e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319284e+02 3.91853381e+02
 2.35442163e+02 1.51854688e+02 7.61407921e+01 6.51220505e+01
 1.00259693e+01 1.42350764e+01 2.69073707e+01 2.98482223e+01
 2.08425361e-01 7.79341757e-01 1.19463629e+00 2.88696689e+00
 2.82595731e+00 5.50667217e+00 7.11392874e+00 3.38938795e+01
 2.31709944e+01 1.48308223e+02 9.97863691e+01 9.20075398e+02
 2.65392366e-01 5.55705795e-01 2.44183814e+00 8.90492947e+00
 8.34753039e-01 2.32772625e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999628064694893
cond(S) = 644.1137222184916
E1 = -183.58973795342558  E_coul = 55.08022565871128
init E= -128.509512294714
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775405121664944  LUMO = 0.452533841638997
  mo_energy =
[-3.25550310e+01 -1.85272177e+00 -7.75405122e-01 -7.75405122e-01
 -7.75405122e-01  4.52533842e-01  8.22446763e-01  8.22446763e-01
  8.22446763e-01  2.45471863e+00  3.95615837e+00  3.95615837e+00
  3.95615837e+00  8.94045611e+00  1.43598242e+01  1.43598242e+01
  1.43598242e+01  3.61445599e+01  5.30087099e+01  5.30087099e+01
  5.30087099e+01  1.39600884e+02  2.40836819e+02  2.40836819e+02
  2.40836819e+02  5.02573477e+02  1.86927532e+03  7.99878728e+03
  4.77666629e+04]
E1 = -182.08383626181006  E_coul = 53.54578402286528
cycle= 1 E= -128.538052238945  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520508
diis-c [-0.27092904  1.        ]
  HOMO = -0.8844919886244  LUMO = 0.436828622807045
  mo_energy =
[-3.28785326e+01 -1.96678857e+00 -8.84491989e-01 -8.84491989e-01
 -8.84491989e-01  4.36828623e-01  7.95620544e-01  7.95620544e-01
  7.95620544e-01  2.40186170e+00  3.85847747e+00  3.85847747e+00
  3.85847747e+00  8.80964939e+00  1.41688095e+01  1.41688095e+01
  1.41688095e+01  3.58991438e+01  5.27274377e+01  5.27274377e+01
  5.27274377e+01  1.39283230e+02  2.40490227e+02  2.40490227e+02
  2.40490227e+02  5.02211693e+02  1.86887747e+03  7.99836038e+03
  4.77662172e+04]
E1 = -182.84642750735452  E_coul = 54.3057820202536
cycle= 2 E= -128.540645487101  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264638
diis-c [-6.49137345e-04  3.36283415e-01  6.63716585e-01]
  HOMO = -0.848818595851417  LUMO = 0.441839478725379
  mo_energy =
[-3.27703048e+01 -1.92922508e+00 -8.48818596e-01 -8.48818596e-01
 -8.48818596e-01  4.41839479e-01  8.04353381e-01  8.04353381e-01
  8.04353381e-01  2.41886350e+00  3.89015212e+00  3.89015212e+00
  3.89015212e+00  8.85250096e+00  1.42320818e+01  1.42320818e+01
  1.42320818e+01  3.59813364e+01  5.28215717e+01  5.28215717e+01
  5.28215717e+01  1.39389253e+02  2.40604031e+02  2.40604031e+02
  2.40604031e+02  5.02328640e+02  1.86899969e+03  7.99848505e+03
  4.77663428e+04]
E1 = -182.5872506763574  E_coul = 54.04568198232314
cycle= 3 E= -128.541568694034  delta_E= -0.000923  |g|= 0.000525  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115554
diis-c [-2.67785356e-07 -2.50626319e-03 -1.02515781e-03  1.00353142e+00]
  HOMO = -0.849084128866764  LUMO = 0.441805628517812
  mo_energy =
[-3.27707707e+01 -1.92942549e+00 -8.49084129e-01 -8.49084129e-01
 -8.49084129e-01  4.41805629e-01  8.04308799e-01  8.04308799e-01
  8.04308799e-01  2.41876310e+00  3.88996641e+00  3.88996641e+00
  3.88996641e+00  8.85227419e+00  1.42317667e+01  1.42317667e+01
  1.42317667e+01  3.59809742e+01  5.28211588e+01  5.28211588e+01
  5.28211588e+01  1.39388785e+02  2.40603494e+02  2.40603494e+02
  2.40603494e+02  5.02328045e+02  1.86899896e+03  7.99848421e+03
  4.77663419e+04]
E1 = -182.5876807940564  E_coul = 54.0461120701851
cycle= 4 E= -128.541568723871  delta_E= -2.98e-08  |g|= 8.14e-05  |ddm|= 0.000327
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184487
diis-c [-1.11245639e-09  2.45470575e-04  4.73174153e-04 -1.89809276e-01
  1.18909063e+00]
  HOMO = -0.849128452898017  LUMO = 0.441797354792594
  mo_energy =
[-3.27708434e+01 -1.92945897e+00 -8.49128453e-01 -8.49128453e-01
 -8.49128453e-01  4.41797355e-01  8.04294504e-01  8.04294504e-01
  8.04294504e-01  2.41874024e+00  3.88992502e+00  3.88992502e+00
  3.88992502e+00  8.85222789e+00  1.42317063e+01  1.42317063e+01
  1.42317063e+01  3.59809092e+01  5.28210897e+01  5.28210897e+01
  5.28210897e+01  1.39388712e+02  2.40603417e+02  2.40603417e+02
  2.40603417e+02  5.02327964e+02  1.86899887e+03  7.99848412e+03
  4.77663418e+04]
E1 = -182.58780458471603  E_coul = 54.04623586003958
cycle= 5 E= -128.541568724676  delta_E= -8.05e-10  |g|= 6.1e-06  |ddm|= 5.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58780458471603  E_coul = 54.04623586003958
  HOMO = -0.849125191045538  LUMO = 0.441798146082177
  mo_energy =
[-3.27708359e+01 -1.92945491e+00 -8.49125191e-01 -8.49125191e-01
 -8.49125191e-01  4.41798146e-01  8.04295456e-01  8.04295456e-01
  8.04295456e-01  2.41874233e+00  3.88992815e+00  3.88992815e+00
  3.88992815e+00  8.85223212e+00  1.42317117e+01  1.42317117e+01
  1.42317117e+01  3.59809157e+01  5.28210966e+01  5.28210966e+01
  5.28210966e+01  1.39388719e+02  2.40603424e+02  2.40603424e+02
  2.40603424e+02  5.02327972e+02  1.86899888e+03  7.99848413e+03
  4.77663418e+04]
E1 = -182.58778763766898  E_coul = 54.0462189129899
Extra cycle  E= -128.541568724679  delta_E= -2.64e-12  |g|= 2.37e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 644.1137222184916
E1 = -182.58778763766898  E_coul = 54.0462189129899
init E= -128.541568724679
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.849126390218306  LUMO = 0.441798030478254
  mo_energy =
[-3.27708397e+01 -1.92945604e+00 -8.49126390e-01 -8.49126390e-01
 -8.49126390e-01  4.41798030e-01  8.04295180e-01  8.04295180e-01
  8.04295180e-01  2.41874185e+00  3.88992711e+00  3.88992711e+00
  3.88992711e+00  8.85223074e+00  1.42317095e+01  1.42317095e+01
  1.42317095e+01  3.59809129e+01  5.28210934e+01  5.28210934e+01
  5.28210934e+01  1.39388715e+02  2.40603420e+02  2.40603420e+02
  2.40603420e+02  5.02327967e+02  1.86899887e+03  7.99848412e+03
  4.77663418e+04]
E1 = -182.5877969995885  E_coul = 54.0462282749093
cycle= 1 E= -128.541568724679  delta_E= -1.14e-13  |g|= 1.28e-06  |ddm|= 8.46e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5877969995885  E_coul = 54.0462282749093
  HOMO = -0.849125731016571  LUMO = 0.44179813353758
  mo_energy =
[-3.27708377e+01 -1.92945531e+00 -8.49125731e-01 -8.49125731e-01
 -8.49125731e-01  4.41798134e-01  8.04295345e-01  8.04295345e-01
  8.04295345e-01  2.41874218e+00  3.88992770e+00  3.88992770e+00
  3.88992770e+00  8.85223155e+00  1.42317107e+01  1.42317107e+01
  1.42317107e+01  3.59809145e+01  5.28210951e+01  5.28210951e+01
  5.28210951e+01  1.39388717e+02  2.40603422e+02  2.40603422e+02
  2.40603422e+02  5.02327970e+02  1.86899887e+03  7.99848412e+03
  4.77663418e+04]
E1 = -182.58779228328493  E_coul = 54.04622355860535
Extra cycle  E= -128.54156872468  delta_E= -3.69e-13  |g|= 6.4e-07  |ddm|= 4.11e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [4.98742231e-01 2.44137942e+04 3.66145157e+03 8.33319284e+02
 2.35442163e+02 7.61407921e+01 1.00259693e+01 2.69073707e+01
 2.08425361e-01 1.19463629e+00 2.82595731e+00 7.11392874e+00
 2.31709944e+01 9.97863691e+01 2.65392366e-01 2.44183814e+00
 8.34753039e-01]
grad_E = [ 1.42436416e-03  2.41908500e-10 -1.16702453e-08  1.77689984e-07
 -1.56982338e-06  1.70257807e-05  8.51879307e-06 -5.36373421e-05
 -1.03190752e-03 -1.55347695e-03  1.39607861e-04  9.86101294e-05
 -8.27869462e-06  2.97215481e-07 -3.92728474e-03 -6.06849234e-04
  2.20387908e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.491183780288       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157087        1
[INPUT] 0    0    [1    /1   ]  833.319285251        1
[INPUT] 0    0    [1    /1   ]  235.442131712        1
[INPUT] 0    0    [1    /1   ]  76.1409176221        1
[INPUT] 0    0    [1    /1   ]  10.0298041104        1
[INPUT] 0    0    [1    /1   ]  26.9063523531        1
[INPUT] 0    0    [1    /1   ]  0.19360757697        1
[INPUT] 0    0    [1    /1   ]  1.21789228583        1
[INPUT] 0    0    [1    /1   ]  2.81984692723        1
[INPUT] 1    0    [1    /1   ]  7.11398434704        1
[INPUT] 1    0    [1    /1   ]  23.1709874921        1
[INPUT] 1    0    [1    /1   ]  99.7863687875        1
[INPUT] 1    0    [1    /1   ]  0.265188117135       1
[INPUT] 1    0    [1    /1   ]  2.44163392621        1
[INPUT] 1    0    [1    /1   ]  0.834880540304       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.4911837802884155, 1.0]], [0, [24413.794186558353, 1.0]], [0, [3661.451570866031, 1.0]], [0, [833.3192852505558, 1.0]], [0, [235.44213171159026, 1.0]], [0, [76.14091762212765, 1.0]], [0, [10.029804110416316, 1.0]], [0, [26.90635235314823, 1.0]], [0, [0.1936075769698122, 1.0]], [0, [1.2178922858348329, 1.0]], [0, [2.8198469272316338, 1.0]], [1, [7.113984347044358, 1.0]], [1, [23.17098749214347, 1.0]], [1, [99.78636878754605, 1.0]], [1, [0.26518811713484675, 1.0]], [1, [2.4416339262133544, 1.0]], [1, [0.8348805403040576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49118378]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157087]
bas 3, expnt(s) = [833.31928525]
bas 4, expnt(s) = [235.44213171]
bas 5, expnt(s) = [76.14091762]
bas 6, expnt(s) = [10.02980411]
bas 7, expnt(s) = [26.90635235]
bas 8, expnt(s) = [0.19360758]
bas 9, expnt(s) = [1.21789229]
bas 10, expnt(s) = [2.81984693]
bas 11, expnt(s) = [7.11398435]
bas 12, expnt(s) = [23.17098749]
bas 13, expnt(s) = [99.78636879]
bas 14, expnt(s) = [0.26518812]
bas 15, expnt(s) = [2.44163393]
bas 16, expnt(s) = [0.83488054]
CPU time:        27.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.91183780e-01 1.48234071e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319285e+02 3.91853381e+02
 2.35442132e+02 1.51854673e+02 7.61409176e+01 6.51221311e+01
 1.00298041e+01 1.42391598e+01 2.69063524e+01 2.98473751e+01
 1.93607577e-01 7.37406203e-01 1.21789229e+00 2.92901559e+00
 2.81984693e+00 5.49773971e+00 7.11398435e+00 3.38942106e+01
 2.31709875e+01 1.48308168e+02 9.97863688e+01 9.20075394e+02
 2.65188117e-01 5.55171249e-01 2.44163393e+00 8.90399856e+00
 8.34880540e-01 2.32817068e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99962639231625
cond(S) = 604.6284206917665
E1 = -183.58969052151372  E_coul = 55.08014822825373
init E= -128.50954229326
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775408298575133  LUMO = 0.424579477018773
  mo_energy =
[-3.25550578e+01 -1.85273251e+00 -7.75408299e-01 -7.75408299e-01
 -7.75408299e-01  4.24579477e-01  8.21930665e-01  8.21930665e-01
  8.21930665e-01  2.39340326e+00  3.95560021e+00  3.95560021e+00
  3.95560021e+00  8.90223452e+00  1.43590695e+01  1.43590695e+01
  1.43590695e+01  3.61304730e+01  5.30080191e+01  5.30080191e+01
  5.30080191e+01  1.39595713e+02  2.40836329e+02  2.40836329e+02
  2.40836329e+02  5.02570335e+02  1.86927277e+03  7.99878509e+03
  4.77666611e+04]
E1 = -182.08353142499251  E_coul = 53.54545774284188
cycle= 1 E= -128.538073682151  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520077
diis-c [-0.27047985  1.        ]
  HOMO = -0.884515235709697  LUMO = 0.409741678895828
  mo_energy =
[-3.28785969e+01 -1.96682794e+00 -8.84515236e-01 -8.84515236e-01
 -8.84515236e-01  4.09741679e-01  7.95109462e-01  7.95109462e-01
  7.95109462e-01  2.34052959e+00  3.85788282e+00  3.85788282e+00
  3.85788282e+00  8.77098617e+00  1.41680332e+01  1.41680332e+01
  1.41680332e+01  3.58849805e+01  5.27267172e+01  5.27267172e+01
  5.27267172e+01  1.39278009e+02  2.40489692e+02  2.40489692e+02
  2.40489692e+02  5.02208504e+02  1.86887486e+03  7.99835812e+03
  4.77662153e+04]
E1 = -182.84606437519287  E_coul = 54.30539825949565
cycle= 2 E= -128.540666115697  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264455
diis-c [-6.49439471e-04  3.36312799e-01  6.63687201e-01]
  HOMO = -0.848846182685729  LUMO = 0.414471497457011
  mo_energy =
[-3.27703820e+01 -1.92926872e+00 -8.48846183e-01 -8.48846183e-01
 -8.48846183e-01  4.14471497e-01  8.03838111e-01  8.03838111e-01
  8.03838111e-01  2.35752539e+00  3.88955414e+00  3.88955414e+00
  3.88955414e+00  8.81397222e+00  1.42312983e+01  1.42312983e+01
  1.42312983e+01  3.59671868e+01  5.28208402e+01  5.28208402e+01
  5.28208402e+01  1.39384022e+02  2.40603482e+02  2.40603482e+02
  2.40603482e+02  5.02325438e+02  1.86899706e+03  7.99848277e+03
  4.77663409e+04]
E1 = -182.58686564498697  E_coul = 54.045276309188374
cycle= 3 E= -128.541589335799  delta_E= -0.000923  |g|= 0.000526  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115639
diis-c [-2.73743214e-07 -2.53593174e-03 -1.08813466e-03  1.00362407e+00]
  HOMO = -0.84911373849434  LUMO = 0.414438651633828
  mo_energy =
[-3.27708495e+01 -1.92947189e+00 -8.49113738e-01 -8.49113738e-01
 -8.49113738e-01  4.14438652e-01  8.03792934e-01  8.03792934e-01
  8.03792934e-01  2.35742359e+00  3.88936612e+00  3.88936612e+00
  3.88936612e+00  8.81374211e+00  1.42309810e+01  1.42309810e+01
  1.42309810e+01  3.59668225e+01  5.28204252e+01  5.28204252e+01
  5.28204252e+01  1.39383552e+02  2.40602944e+02  2.40602944e+02
  2.40602944e+02  5.02324842e+02  1.86899633e+03  7.99848194e+03
  4.77663400e+04]
E1 = -182.58729584208987  E_coul = 54.04570647652803
cycle= 4 E= -128.541589365562  delta_E= -2.98e-08  |g|= 8.1e-05  |ddm|= 0.000298
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183483
diis-c [-1.09911179e-09  2.44843882e-04  4.69535824e-04 -1.89032648e-01
  1.18831827e+00]
  HOMO = -0.849158016812019  LUMO = 0.414430725066696
  mo_energy =
[-3.27709217e+01 -1.92950550e+00 -8.49158017e-01 -8.49158017e-01
 -8.49158017e-01  4.14430725e-01  8.03778638e-01  8.03778638e-01
  8.03778638e-01  2.35740070e+00  3.88932471e+00  3.88932471e+00
  3.88932471e+00  8.81369566e+00  1.42309208e+01  1.42309208e+01
  1.42309208e+01  3.59667577e+01  5.28203564e+01  5.28203564e+01
  5.28203564e+01  1.39383480e+02  2.40602867e+02  2.40602867e+02
  2.40602867e+02  5.02324762e+02  1.86899625e+03  7.99848185e+03
  4.77663399e+04]
E1 = -182.58741851531755  E_coul = 54.045829148960735
cycle= 5 E= -128.541589366357  delta_E= -7.95e-10  |g|= 6.06e-06  |ddm|= 5.36e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58741851531755  E_coul = 54.045829148960735
  HOMO = -0.849154766489611  LUMO = 0.41443147344459
  mo_energy =
[-3.27709143e+01 -1.92950146e+00 -8.49154766e-01 -8.49154766e-01
 -8.49154766e-01  4.14431473e-01  8.03779585e-01  8.03779585e-01
  8.03779585e-01  2.35740278e+00  3.88932782e+00  3.88932782e+00
  3.88932782e+00  8.81369988e+00  1.42309261e+01  1.42309261e+01
  1.42309261e+01  3.59667642e+01  5.28203633e+01  5.28203633e+01
  5.28203633e+01  1.39383487e+02  2.40602874e+02  2.40602874e+02
  2.40602874e+02  5.02324769e+02  1.86899625e+03  7.99848185e+03
  4.77663399e+04]
E1 = -182.58740167302088  E_coul = 54.04581230666171
Extra cycle  E= -128.541589366359  delta_E= -2.36e-12  |g|= 2.36e-06  |ddm|= 2.07e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [4.91183780e-01 2.44137942e+04 3.66145157e+03 8.33319285e+02
 2.35442132e+02 7.61409176e+01 1.00298041e+01 2.69063524e+01
 1.93607577e-01 1.21789229e+00 2.81984693e+00 7.11398435e+00
 2.31709875e+01 9.97863688e+01 2.65188117e-01 2.44163393e+00
 8.34880540e-01]
E = -128.54158936635918
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.491183780288       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157087        1
[INPUT] 0    0    [1    /1   ]  833.319285251        1
[INPUT] 0    0    [1    /1   ]  235.442131712        1
[INPUT] 0    0    [1    /1   ]  76.1409176221        1
[INPUT] 0    0    [1    /1   ]  10.0298041104        1
[INPUT] 0    0    [1    /1   ]  26.9063523531        1
[INPUT] 0    0    [1    /1   ]  0.19360757697        1
[INPUT] 0    0    [1    /1   ]  1.21789228583        1
[INPUT] 0    0    [1    /1   ]  2.81984692723        1
[INPUT] 1    0    [1    /1   ]  7.11398434704        1
[INPUT] 1    0    [1    /1   ]  23.1709874921        1
[INPUT] 1    0    [1    /1   ]  99.7863687875        1
[INPUT] 1    0    [1    /1   ]  0.265188117135       1
[INPUT] 1    0    [1    /1   ]  2.44163392621        1
[INPUT] 1    0    [1    /1   ]  0.834880540304       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.4911837802884155, 1.0]], [0, [24413.794186558353, 1.0]], [0, [3661.451570866031, 1.0]], [0, [833.3192852505558, 1.0]], [0, [235.44213171159026, 1.0]], [0, [76.14091762212765, 1.0]], [0, [10.029804110416316, 1.0]], [0, [26.90635235314823, 1.0]], [0, [0.1936075769698122, 1.0]], [0, [1.2178922858348329, 1.0]], [0, [2.8198469272316338, 1.0]], [1, [7.113984347044358, 1.0]], [1, [23.17098749214347, 1.0]], [1, [99.78636878754605, 1.0]], [1, [0.26518811713484675, 1.0]], [1, [2.4416339262133544, 1.0]], [1, [0.8348805403040576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49118378]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157087]
bas 3, expnt(s) = [833.31928525]
bas 4, expnt(s) = [235.44213171]
bas 5, expnt(s) = [76.14091762]
bas 6, expnt(s) = [10.02980411]
bas 7, expnt(s) = [26.90635235]
bas 8, expnt(s) = [0.19360758]
bas 9, expnt(s) = [1.21789229]
bas 10, expnt(s) = [2.81984693]
bas 11, expnt(s) = [7.11398435]
bas 12, expnt(s) = [23.17098749]
bas 13, expnt(s) = [99.78636879]
bas 14, expnt(s) = [0.26518812]
bas 15, expnt(s) = [2.44163393]
bas 16, expnt(s) = [0.83488054]
CPU time:        28.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.91183780e-01 1.48234071e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319285e+02 3.91853381e+02
 2.35442132e+02 1.51854673e+02 7.61409176e+01 6.51221311e+01
 1.00298041e+01 1.42391598e+01 2.69063524e+01 2.98473751e+01
 1.93607577e-01 7.37406203e-01 1.21789229e+00 2.92901559e+00
 2.81984693e+00 5.49773971e+00 7.11398435e+00 3.38942106e+01
 2.31709875e+01 1.48308168e+02 9.97863688e+01 9.20075394e+02
 2.65188117e-01 5.55171249e-01 2.44163393e+00 8.90399856e+00
 8.34880540e-01 2.32817068e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99962639231625
cond(S) = 604.6284206917665
E1 = -183.58969052151372  E_coul = 55.08014822825373
init E= -128.50954229326
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775408298575133  LUMO = 0.424579477018773
  mo_energy =
[-3.25550578e+01 -1.85273251e+00 -7.75408299e-01 -7.75408299e-01
 -7.75408299e-01  4.24579477e-01  8.21930665e-01  8.21930665e-01
  8.21930665e-01  2.39340326e+00  3.95560021e+00  3.95560021e+00
  3.95560021e+00  8.90223452e+00  1.43590695e+01  1.43590695e+01
  1.43590695e+01  3.61304730e+01  5.30080191e+01  5.30080191e+01
  5.30080191e+01  1.39595713e+02  2.40836329e+02  2.40836329e+02
  2.40836329e+02  5.02570335e+02  1.86927277e+03  7.99878509e+03
  4.77666611e+04]
E1 = -182.08353142499251  E_coul = 53.54545774284188
cycle= 1 E= -128.538073682151  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520077
diis-c [-0.27047985  1.        ]
  HOMO = -0.884515235709697  LUMO = 0.409741678895828
  mo_energy =
[-3.28785969e+01 -1.96682794e+00 -8.84515236e-01 -8.84515236e-01
 -8.84515236e-01  4.09741679e-01  7.95109462e-01  7.95109462e-01
  7.95109462e-01  2.34052959e+00  3.85788282e+00  3.85788282e+00
  3.85788282e+00  8.77098617e+00  1.41680332e+01  1.41680332e+01
  1.41680332e+01  3.58849805e+01  5.27267172e+01  5.27267172e+01
  5.27267172e+01  1.39278009e+02  2.40489692e+02  2.40489692e+02
  2.40489692e+02  5.02208504e+02  1.86887486e+03  7.99835812e+03
  4.77662153e+04]
E1 = -182.84606437519287  E_coul = 54.30539825949565
cycle= 2 E= -128.540666115697  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264455
diis-c [-6.49439471e-04  3.36312799e-01  6.63687201e-01]
  HOMO = -0.848846182685729  LUMO = 0.414471497457011
  mo_energy =
[-3.27703820e+01 -1.92926872e+00 -8.48846183e-01 -8.48846183e-01
 -8.48846183e-01  4.14471497e-01  8.03838111e-01  8.03838111e-01
  8.03838111e-01  2.35752539e+00  3.88955414e+00  3.88955414e+00
  3.88955414e+00  8.81397222e+00  1.42312983e+01  1.42312983e+01
  1.42312983e+01  3.59671868e+01  5.28208402e+01  5.28208402e+01
  5.28208402e+01  1.39384022e+02  2.40603482e+02  2.40603482e+02
  2.40603482e+02  5.02325438e+02  1.86899706e+03  7.99848277e+03
  4.77663409e+04]
E1 = -182.58686564498697  E_coul = 54.045276309188374
cycle= 3 E= -128.541589335799  delta_E= -0.000923  |g|= 0.000526  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115639
diis-c [-2.73743214e-07 -2.53593174e-03 -1.08813466e-03  1.00362407e+00]
  HOMO = -0.84911373849434  LUMO = 0.414438651633828
  mo_energy =
[-3.27708495e+01 -1.92947189e+00 -8.49113738e-01 -8.49113738e-01
 -8.49113738e-01  4.14438652e-01  8.03792934e-01  8.03792934e-01
  8.03792934e-01  2.35742359e+00  3.88936612e+00  3.88936612e+00
  3.88936612e+00  8.81374211e+00  1.42309810e+01  1.42309810e+01
  1.42309810e+01  3.59668225e+01  5.28204252e+01  5.28204252e+01
  5.28204252e+01  1.39383552e+02  2.40602944e+02  2.40602944e+02
  2.40602944e+02  5.02324842e+02  1.86899633e+03  7.99848194e+03
  4.77663400e+04]
E1 = -182.58729584208987  E_coul = 54.04570647652803
cycle= 4 E= -128.541589365562  delta_E= -2.98e-08  |g|= 8.1e-05  |ddm|= 0.000298
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183483
diis-c [-1.09911179e-09  2.44843882e-04  4.69535824e-04 -1.89032648e-01
  1.18831827e+00]
  HOMO = -0.849158016812019  LUMO = 0.414430725066696
  mo_energy =
[-3.27709217e+01 -1.92950550e+00 -8.49158017e-01 -8.49158017e-01
 -8.49158017e-01  4.14430725e-01  8.03778638e-01  8.03778638e-01
  8.03778638e-01  2.35740070e+00  3.88932471e+00  3.88932471e+00
  3.88932471e+00  8.81369566e+00  1.42309208e+01  1.42309208e+01
  1.42309208e+01  3.59667577e+01  5.28203564e+01  5.28203564e+01
  5.28203564e+01  1.39383480e+02  2.40602867e+02  2.40602867e+02
  2.40602867e+02  5.02324762e+02  1.86899625e+03  7.99848185e+03
  4.77663399e+04]
E1 = -182.58741851531755  E_coul = 54.045829148960735
cycle= 5 E= -128.541589366357  delta_E= -7.95e-10  |g|= 6.06e-06  |ddm|= 5.36e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58741851531755  E_coul = 54.045829148960735
  HOMO = -0.849154766489611  LUMO = 0.41443147344459
  mo_energy =
[-3.27709143e+01 -1.92950146e+00 -8.49154766e-01 -8.49154766e-01
 -8.49154766e-01  4.14431473e-01  8.03779585e-01  8.03779585e-01
  8.03779585e-01  2.35740278e+00  3.88932782e+00  3.88932782e+00
  3.88932782e+00  8.81369988e+00  1.42309261e+01  1.42309261e+01
  1.42309261e+01  3.59667642e+01  5.28203633e+01  5.28203633e+01
  5.28203633e+01  1.39383487e+02  2.40602874e+02  2.40602874e+02
  2.40602874e+02  5.02324769e+02  1.86899625e+03  7.99848185e+03
  4.77663399e+04]
E1 = -182.58740167302088  E_coul = 54.04581230666171
Extra cycle  E= -128.541589366359  delta_E= -2.36e-12  |g|= 2.36e-06  |ddm|= 2.07e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 604.6284206917665
E1 = -182.58740167302088  E_coul = 54.04581230666171
init E= -128.541589366359
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.849155958186211  LUMO = 0.4144313655263
  mo_energy =
[-3.27709181e+01 -1.92950258e+00 -8.49155958e-01 -8.49155958e-01
 -8.49155958e-01  4.14431366e-01  8.03779311e-01  8.03779311e-01
  8.03779311e-01  2.35740230e+00  3.88932679e+00  3.88932679e+00
  3.88932679e+00  8.81369851e+00  1.42309240e+01  1.42309240e+01
  1.42309240e+01  3.59667614e+01  5.28203601e+01  5.28203601e+01
  5.28203601e+01  1.39383483e+02  2.40602870e+02  2.40602870e+02
  2.40602870e+02  5.02324765e+02  1.86899625e+03  7.99848185e+03
  4.77663399e+04]
E1 = -182.58741097686644  E_coul = 54.045821610506614
cycle= 1 E= -128.54158936636  delta_E= -6.54e-13  |g|= 1.27e-06  |ddm|= 8.41e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58741097686644  E_coul = 54.045821610506614
  HOMO = -0.849155303080713  LUMO = 0.414431462319324
  mo_energy =
[-3.27709161e+01 -1.92950186e+00 -8.49155303e-01 -8.49155303e-01
 -8.49155303e-01  4.14431462e-01  8.03779475e-01  8.03779475e-01
  8.03779475e-01  2.35740263e+00  3.88932738e+00  3.88932738e+00
  3.88932738e+00  8.81369932e+00  1.42309251e+01  1.42309251e+01
  1.42309251e+01  3.59667629e+01  5.28203618e+01  5.28203618e+01
  5.28203618e+01  1.39383485e+02  2.40602872e+02  2.40602872e+02
  2.40602872e+02  5.02324767e+02  1.86899625e+03  7.99848185e+03
  4.77663399e+04]
E1 = -182.5874062884782  E_coul = 54.04581692211828
Extra cycle  E= -128.54158936636  delta_E= -8.53e-14  |g|= 6.37e-07  |ddm|= 4.1e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [4.91183780e-01 2.44137942e+04 3.66145157e+03 8.33319285e+02
 2.35442132e+02 7.61409176e+01 1.00298041e+01 2.69063524e+01
 1.93607577e-01 1.21789229e+00 2.81984693e+00 7.11398435e+00
 2.31709875e+01 9.97863688e+01 2.65188117e-01 2.44163393e+00
 8.34880540e-01]
grad_E = [ 4.72011975e-04  2.53242102e-10 -1.22520400e-08  1.89359510e-07
 -1.68893470e-06  1.76152337e-05 -3.47968014e-05 -5.01192420e-05
 -6.25107009e-04 -7.16766607e-04 -7.15133404e-05  1.31331582e-04
 -1.10709023e-05  3.89397108e-07 -5.17400157e-03 -8.02455383e-04
  2.89741722e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.487759263365       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.4515709         1
[INPUT] 0    0    [1    /1   ]  833.319284906        1
[INPUT] 0    0    [1    /1   ]  235.442132761        1
[INPUT] 0    0    [1    /1   ]  76.1408806583        1
[INPUT] 0    0    [1    /1   ]  10.03019919          1
[INPUT] 0    0    [1    /1   ]  26.9063990955        1
[INPUT] 0    0    [1    /1   ]  0.194313795532       1
[INPUT] 0    0    [1    /1   ]  1.22555842666        1
[INPUT] 0    0    [1    /1   ]  2.81856173701        1
[INPUT] 1    0    [1    /1   ]  7.1139751909         1
[INPUT] 1    0    [1    /1   ]  23.1709876374        1
[INPUT] 1    0    [1    /1   ]  99.7863686367        1
[INPUT] 1    0    [1    /1   ]  0.265855841372       1
[INPUT] 1    0    [1    /1   ]  2.44172067658        1
[INPUT] 1    0    [1    /1   ]  0.834379044221       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.4877592633646781, 1.0]], [0, [24413.79418655761, 1.0]], [0, [3661.4515708991626, 1.0]], [0, [833.3192849063199, 1.0]], [0, [235.4421327610183, 1.0]], [0, [76.14088065829617, 1.0]], [0, [10.030199190015333, 1.0]], [0, [26.906399095491086, 1.0]], [0, [0.19431379553249986, 1.0]], [0, [1.2255584266586248, 1.0]], [0, [2.818561737013031, 1.0]], [1, [7.1139751908987225, 1.0]], [1, [23.170987637432024, 1.0]], [1, [99.78636863674346, 1.0]], [1, [0.26585584137201124, 1.0]], [1, [2.4417206765755894, 1.0]], [1, [0.8343790442210521, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.48775926]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.4515709]
bas 3, expnt(s) = [833.31928491]
bas 4, expnt(s) = [235.44213276]
bas 5, expnt(s) = [76.14088066]
bas 6, expnt(s) = [10.03019919]
bas 7, expnt(s) = [26.9063991]
bas 8, expnt(s) = [0.1943138]
bas 9, expnt(s) = [1.22555843]
bas 10, expnt(s) = [2.81856174]
bas 11, expnt(s) = [7.11397519]
bas 12, expnt(s) = [23.17098764]
bas 13, expnt(s) = [99.78636864]
bas 14, expnt(s) = [0.26585584]
bas 15, expnt(s) = [2.44172068]
bas 16, expnt(s) = [0.83437904]
CPU time:        30.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.87759263e-01 1.47458282e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319285e+02 3.91853381e+02
 2.35442133e+02 1.51854673e+02 7.61408807e+01 6.51221074e+01
 1.00301992e+01 1.42395804e+01 2.69063991e+01 2.98474140e+01
 1.94313796e-01 7.39422651e-01 1.22555843e+00 2.94283247e+00
 2.81856174e+00 5.49586034e+00 7.11397519e+00 3.38941561e+01
 2.31709876e+01 1.48308169e+02 9.97863686e+01 9.20075392e+02
 2.65855841e-01 5.56919150e-01 2.44172068e+00 8.90439401e+00
 8.34379044e-01 2.32642270e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999625856726762
cond(S) = 603.7242253902115
E1 = -183.58967768887155  E_coul = 55.08010515699961
init E= -128.509572531872
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.77541054916203  LUMO = 0.424866666247045
  mo_energy =
[-3.25550754e+01 -1.85273173e+00 -7.75410549e-01 -7.75410549e-01
 -7.75410549e-01  4.24866666e-01  8.23575426e-01  8.23575426e-01
  8.23575426e-01  2.39325957e+00  3.95690285e+00  3.95690285e+00
  3.95690285e+00  8.91211836e+00  1.43597195e+01  1.43597195e+01
  1.43597195e+01  3.61470148e+01  5.30084474e+01  5.30084474e+01
  5.30084474e+01  1.39611927e+02  2.40836602e+02  2.40836602e+02
  2.40836602e+02  5.02585057e+02  1.86928594e+03  7.99879666e+03
  4.77666707e+04]
E1 = -182.08478476736155  E_coul = 53.546699405778305
cycle= 1 E= -128.538085361583  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519975
diis-c [-0.27037405  1.        ]
  HOMO = -0.88441062663553  LUMO = 0.410084598705667
  mo_energy =
[-3.28784162e+01 -1.96670365e+00 -8.84410627e-01 -8.84410627e-01
 -8.84410627e-01  4.10084599e-01  7.96772168e-01  7.96772168e-01
  7.96772168e-01  2.34042667e+00  3.85931902e+00  3.85931902e+00
  3.85931902e+00  8.78088761e+00  1.41688502e+01  1.41688502e+01
  1.41688502e+01  3.59017149e+01  5.27273371e+01  5.27273371e+01
  5.27273371e+01  1.39294420e+02  2.40490154e+02  2.40490154e+02
  2.40490154e+02  5.02223420e+02  1.86888822e+03  7.99836988e+03
  4.77662251e+04]
E1 = -182.84669612445424  E_coul = 54.30602116226664
cycle= 2 E= -128.540674962188  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264337
diis-c [-6.48784139e-04  3.36257318e-01  6.63742682e-01]
  HOMO = -0.848768327911183  LUMO = 0.414808662874909
  mo_energy =
[-3.27702778e+01 -1.92917295e+00 -8.48768328e-01 -8.48768328e-01
 -8.48768328e-01  4.14808663e-01  8.05505432e-01  8.05505432e-01
  8.05505432e-01  2.35742212e+00  3.89095868e+00  3.89095868e+00
  3.89095868e+00  8.82387629e+00  1.42320672e+01  1.42320672e+01
  1.42320672e+01  3.59838616e+01  5.28213926e+01  5.28213926e+01
  5.28213926e+01  1.39400358e+02  2.40603864e+02  2.40603864e+02
  2.40603864e+02  5.02340272e+02  1.86901034e+03  7.99849444e+03
  4.77663506e+04]
E1 = -182.58783470855343  E_coul = 54.0462383614939
cycle= 3 E= -128.54159634706  delta_E= -0.000921  |g|= 0.000514  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114281
diis-c [-2.75551555e-07 -2.51858049e-03 -1.11526147e-03  1.00363384e+00]
  HOMO = -0.84902975625889  LUMO = 0.414778557682444
  mo_energy =
[-3.27707356e+01 -1.92936826e+00 -8.49029756e-01 -8.49029756e-01
 -8.49029756e-01  4.14778558e-01  8.05463006e-01  8.05463006e-01
  8.05463006e-01  2.35732550e+00  3.89077710e+00  3.89077710e+00
  3.89077710e+00  8.82365347e+00  1.42317587e+01  1.42317587e+01
  1.42317587e+01  3.59835064e+01  5.28209869e+01  5.28209869e+01
  5.28209869e+01  1.39399897e+02  2.40603335e+02  2.40603335e+02
  2.40603335e+02  5.02339686e+02  1.86900962e+03  7.99849362e+03
  4.77663497e+04]
E1 = -182.5882618918934  E_coul = 54.04666551636157
cycle= 4 E= -128.541596375532  delta_E= -2.85e-08  |g|= 7.97e-05  |ddm|= 0.000283
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182561
diis-c [-1.13497455e-09  2.52357324e-04  4.74735145e-04 -1.92793482e-01
  1.19206639e+00]
  HOMO = -0.84907306699754  LUMO = 0.41477110333663
  mo_energy =
[-3.27708064e+01 -1.92940037e+00 -8.49073067e-01 -8.49073067e-01
 -8.49073067e-01  4.14771103e-01  8.05449130e-01  8.05449130e-01
  8.05449130e-01  2.35730357e+00  3.89073675e+00  3.89073675e+00
  3.89073675e+00  8.82360834e+00  1.42316998e+01  1.42316998e+01
  1.42316998e+01  3.59834431e+01  5.28209195e+01  5.28209195e+01
  5.28209195e+01  1.39399826e+02  2.40603260e+02  2.40603260e+02
  2.40603260e+02  5.02339607e+02  1.86900953e+03  7.99849353e+03
  4.77663496e+04]
E1 = -182.58838438560625  E_coul = 54.04678800929225
cycle= 5 E= -128.541596376314  delta_E= -7.82e-10  |g|= 6.23e-06  |ddm|= 5.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58838438560625  E_coul = 54.04678800929225
  HOMO = -0.849069707015303  LUMO = 0.414771872536055
  mo_energy =
[-3.27707988e+01 -1.92939622e+00 -8.49069707e-01 -8.49069707e-01
 -8.49069707e-01  4.14771873e-01  8.05450110e-01  8.05450110e-01
  8.05450110e-01  2.35730573e+00  3.89073997e+00  3.89073997e+00
  3.89073997e+00  8.82361269e+00  1.42317053e+01  1.42317053e+01
  1.42317053e+01  3.59834497e+01  5.28209266e+01  5.28209266e+01
  5.28209266e+01  1.39399834e+02  2.40603268e+02  2.40603268e+02
  2.40603268e+02  5.02339615e+02  1.86900954e+03  7.99849354e+03
  4.77663496e+04]
E1 = -182.58836714698185  E_coul = 54.0467707706649
Extra cycle  E= -128.541596376317  delta_E= -2.96e-12  |g|= 2.42e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [4.87759263e-01 2.44137942e+04 3.66145157e+03 8.33319285e+02
 2.35442133e+02 7.61408807e+01 1.00301992e+01 2.69063991e+01
 1.94313796e-01 1.22555843e+00 2.81856174e+00 7.11397519e+00
 2.31709876e+01 9.97863686e+01 2.65855841e-01 2.44172068e+00
 8.34379044e-01]
E = -128.54159637631696
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.487759263365       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.4515709         1
[INPUT] 0    0    [1    /1   ]  833.319284906        1
[INPUT] 0    0    [1    /1   ]  235.442132761        1
[INPUT] 0    0    [1    /1   ]  76.1408806583        1
[INPUT] 0    0    [1    /1   ]  10.03019919          1
[INPUT] 0    0    [1    /1   ]  26.9063990955        1
[INPUT] 0    0    [1    /1   ]  0.194313795532       1
[INPUT] 0    0    [1    /1   ]  1.22555842666        1
[INPUT] 0    0    [1    /1   ]  2.81856173701        1
[INPUT] 1    0    [1    /1   ]  7.1139751909         1
[INPUT] 1    0    [1    /1   ]  23.1709876374        1
[INPUT] 1    0    [1    /1   ]  99.7863686367        1
[INPUT] 1    0    [1    /1   ]  0.265855841372       1
[INPUT] 1    0    [1    /1   ]  2.44172067658        1
[INPUT] 1    0    [1    /1   ]  0.834379044221       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.4877592633646781, 1.0]], [0, [24413.79418655761, 1.0]], [0, [3661.4515708991626, 1.0]], [0, [833.3192849063199, 1.0]], [0, [235.4421327610183, 1.0]], [0, [76.14088065829617, 1.0]], [0, [10.030199190015333, 1.0]], [0, [26.906399095491086, 1.0]], [0, [0.19431379553249986, 1.0]], [0, [1.2255584266586248, 1.0]], [0, [2.818561737013031, 1.0]], [1, [7.1139751908987225, 1.0]], [1, [23.170987637432024, 1.0]], [1, [99.78636863674346, 1.0]], [1, [0.26585584137201124, 1.0]], [1, [2.4417206765755894, 1.0]], [1, [0.8343790442210521, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.48775926]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.4515709]
bas 3, expnt(s) = [833.31928491]
bas 4, expnt(s) = [235.44213276]
bas 5, expnt(s) = [76.14088066]
bas 6, expnt(s) = [10.03019919]
bas 7, expnt(s) = [26.9063991]
bas 8, expnt(s) = [0.1943138]
bas 9, expnt(s) = [1.22555843]
bas 10, expnt(s) = [2.81856174]
bas 11, expnt(s) = [7.11397519]
bas 12, expnt(s) = [23.17098764]
bas 13, expnt(s) = [99.78636864]
bas 14, expnt(s) = [0.26585584]
bas 15, expnt(s) = [2.44172068]
bas 16, expnt(s) = [0.83437904]
CPU time:        31.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.87759263e-01 1.47458282e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319285e+02 3.91853381e+02
 2.35442133e+02 1.51854673e+02 7.61408807e+01 6.51221074e+01
 1.00301992e+01 1.42395804e+01 2.69063991e+01 2.98474140e+01
 1.94313796e-01 7.39422651e-01 1.22555843e+00 2.94283247e+00
 2.81856174e+00 5.49586034e+00 7.11397519e+00 3.38941561e+01
 2.31709876e+01 1.48308169e+02 9.97863686e+01 9.20075392e+02
 2.65855841e-01 5.56919150e-01 2.44172068e+00 8.90439401e+00
 8.34379044e-01 2.32642270e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999625856726762
cond(S) = 603.7242253902115
E1 = -183.58967768887155  E_coul = 55.08010515699961
init E= -128.509572531872
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77541054916203  LUMO = 0.424866666247045
  mo_energy =
[-3.25550754e+01 -1.85273173e+00 -7.75410549e-01 -7.75410549e-01
 -7.75410549e-01  4.24866666e-01  8.23575426e-01  8.23575426e-01
  8.23575426e-01  2.39325957e+00  3.95690285e+00  3.95690285e+00
  3.95690285e+00  8.91211836e+00  1.43597195e+01  1.43597195e+01
  1.43597195e+01  3.61470148e+01  5.30084474e+01  5.30084474e+01
  5.30084474e+01  1.39611927e+02  2.40836602e+02  2.40836602e+02
  2.40836602e+02  5.02585057e+02  1.86928594e+03  7.99879666e+03
  4.77666707e+04]
E1 = -182.08478476736155  E_coul = 53.546699405778305
cycle= 1 E= -128.538085361583  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519975
diis-c [-0.27037405  1.        ]
  HOMO = -0.88441062663553  LUMO = 0.410084598705667
  mo_energy =
[-3.28784162e+01 -1.96670365e+00 -8.84410627e-01 -8.84410627e-01
 -8.84410627e-01  4.10084599e-01  7.96772168e-01  7.96772168e-01
  7.96772168e-01  2.34042667e+00  3.85931902e+00  3.85931902e+00
  3.85931902e+00  8.78088761e+00  1.41688502e+01  1.41688502e+01
  1.41688502e+01  3.59017149e+01  5.27273371e+01  5.27273371e+01
  5.27273371e+01  1.39294420e+02  2.40490154e+02  2.40490154e+02
  2.40490154e+02  5.02223420e+02  1.86888822e+03  7.99836988e+03
  4.77662251e+04]
E1 = -182.84669612445424  E_coul = 54.30602116226664
cycle= 2 E= -128.540674962188  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0645
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264337
diis-c [-6.48784139e-04  3.36257318e-01  6.63742682e-01]
  HOMO = -0.848768327911183  LUMO = 0.414808662874909
  mo_energy =
[-3.27702778e+01 -1.92917295e+00 -8.48768328e-01 -8.48768328e-01
 -8.48768328e-01  4.14808663e-01  8.05505432e-01  8.05505432e-01
  8.05505432e-01  2.35742212e+00  3.89095868e+00  3.89095868e+00
  3.89095868e+00  8.82387629e+00  1.42320672e+01  1.42320672e+01
  1.42320672e+01  3.59838616e+01  5.28213926e+01  5.28213926e+01
  5.28213926e+01  1.39400358e+02  2.40603864e+02  2.40603864e+02
  2.40603864e+02  5.02340272e+02  1.86901034e+03  7.99849444e+03
  4.77663506e+04]
E1 = -182.58783470855343  E_coul = 54.0462383614939
cycle= 3 E= -128.54159634706  delta_E= -0.000921  |g|= 0.000514  |ddm|= 0.0221
    CPU time for cycle= 3      0.03 sec, wall time      0.03 sec
diis-norm(errvec)=0.00114281
diis-c [-2.75551555e-07 -2.51858049e-03 -1.11526147e-03  1.00363384e+00]
  HOMO = -0.84902975625889  LUMO = 0.414778557682444
  mo_energy =
[-3.27707356e+01 -1.92936826e+00 -8.49029756e-01 -8.49029756e-01
 -8.49029756e-01  4.14778558e-01  8.05463006e-01  8.05463006e-01
  8.05463006e-01  2.35732550e+00  3.89077710e+00  3.89077710e+00
  3.89077710e+00  8.82365347e+00  1.42317587e+01  1.42317587e+01
  1.42317587e+01  3.59835064e+01  5.28209869e+01  5.28209869e+01
  5.28209869e+01  1.39399897e+02  2.40603335e+02  2.40603335e+02
  2.40603335e+02  5.02339686e+02  1.86900962e+03  7.99849362e+03
  4.77663497e+04]
E1 = -182.5882618918934  E_coul = 54.04666551636157
cycle= 4 E= -128.541596375532  delta_E= -2.85e-08  |g|= 7.97e-05  |ddm|= 0.000283
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000182561
diis-c [-1.13497455e-09  2.52357324e-04  4.74735145e-04 -1.92793482e-01
  1.19206639e+00]
  HOMO = -0.84907306699754  LUMO = 0.41477110333663
  mo_energy =
[-3.27708064e+01 -1.92940037e+00 -8.49073067e-01 -8.49073067e-01
 -8.49073067e-01  4.14771103e-01  8.05449130e-01  8.05449130e-01
  8.05449130e-01  2.35730357e+00  3.89073675e+00  3.89073675e+00
  3.89073675e+00  8.82360834e+00  1.42316998e+01  1.42316998e+01
  1.42316998e+01  3.59834431e+01  5.28209195e+01  5.28209195e+01
  5.28209195e+01  1.39399826e+02  2.40603260e+02  2.40603260e+02
  2.40603260e+02  5.02339607e+02  1.86900953e+03  7.99849353e+03
  4.77663496e+04]
E1 = -182.58838438560625  E_coul = 54.04678800929225
cycle= 5 E= -128.541596376314  delta_E= -7.82e-10  |g|= 6.23e-06  |ddm|= 5.18e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58838438560625  E_coul = 54.04678800929225
  HOMO = -0.849069707015303  LUMO = 0.414771872536055
  mo_energy =
[-3.27707988e+01 -1.92939622e+00 -8.49069707e-01 -8.49069707e-01
 -8.49069707e-01  4.14771873e-01  8.05450110e-01  8.05450110e-01
  8.05450110e-01  2.35730573e+00  3.89073997e+00  3.89073997e+00
  3.89073997e+00  8.82361269e+00  1.42317053e+01  1.42317053e+01
  1.42317053e+01  3.59834497e+01  5.28209266e+01  5.28209266e+01
  5.28209266e+01  1.39399834e+02  2.40603268e+02  2.40603268e+02
  2.40603268e+02  5.02339615e+02  1.86900954e+03  7.99849354e+03
  4.77663496e+04]
E1 = -182.58836714698185  E_coul = 54.0467707706649
Extra cycle  E= -128.541596376317  delta_E= -2.96e-12  |g|= 2.42e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 603.7242253902115
E1 = -182.58836714698185  E_coul = 54.0467707706649
init E= -128.541596376317
    CPU time for initialize scf      0.40 sec, wall time      0.42 sec
  HOMO = -0.849070924952453  LUMO = 0.414771762082516
  mo_energy =
[-3.27708027e+01 -1.92939736e+00 -8.49070925e-01 -8.49070925e-01
 -8.49070925e-01  4.14771762e-01  8.05449830e-01  8.05449830e-01
  8.05449830e-01  2.35730523e+00  3.89073892e+00  3.89073892e+00
  3.89073892e+00  8.82361129e+00  1.42317032e+01  1.42317032e+01
  1.42317032e+01  3.59834469e+01  5.28209233e+01  5.28209233e+01
  5.28209233e+01  1.39399830e+02  2.40603264e+02  2.40603264e+02
  2.40603264e+02  5.02339610e+02  1.86900953e+03  7.99849353e+03
  4.77663496e+04]
E1 = -182.5883766804354  E_coul = 54.046780304117874
cycle= 1 E= -128.541596376318  delta_E= -5.68e-13  |g|= 1.3e-06  |ddm|= 8.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5883766804354  E_coul = 54.046780304117874
  HOMO = -0.849070253441523  LUMO = 0.414771861059456
  mo_energy =
[-3.27708007e+01 -1.92939662e+00 -8.49070253e-01 -8.49070253e-01
 -8.49070253e-01  4.14771861e-01  8.05449998e-01  8.05449998e-01
  8.05449998e-01  2.35730557e+00  3.89073952e+00  3.89073952e+00
  3.89073952e+00  8.82361212e+00  1.42317044e+01  1.42317044e+01
  1.42317044e+01  3.59834484e+01  5.28209251e+01  5.28209251e+01
  5.28209251e+01  1.39399832e+02  2.40603266e+02  2.40603266e+02
  2.40603266e+02  5.02339612e+02  1.86900953e+03  7.99849353e+03
  4.77663496e+04]
E1 = -182.58837187971253  E_coul = 54.04677550339495
Extra cycle  E= -128.541596376318  delta_E= -5.68e-14  |g|= 6.52e-07  |ddm|= 4.19e-07
    CPU time for scf_cycle      0.49 sec, wall time      0.51 sec
exp = [4.87759263e-01 2.44137942e+04 3.66145157e+03 8.33319285e+02
 2.35442133e+02 7.61408807e+01 1.00301992e+01 2.69063991e+01
 1.94313796e-01 1.22555843e+00 2.81856174e+00 7.11397519e+00
 2.31709876e+01 9.97863686e+01 2.65855841e-01 2.44172068e+00
 8.34379044e-01]
grad_E = [-4.62758700e-04  2.42141657e-10 -1.16631480e-08  1.77529831e-07
 -1.53861960e-06  1.63069469e-05 -7.03959536e-05 -4.11622634e-05
 -1.30096230e-04 -2.08545235e-04 -1.67907525e-04  4.67229444e-05
 -3.92331399e-06  1.55225439e-07 -1.64931260e-03 -2.81800477e-04
  9.95428508e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.488450069188       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157092        1
[INPUT] 0    0    [1    /1   ]  833.319284398        1
[INPUT] 0    0    [1    /1   ]  235.442139292        1
[INPUT] 0    0    [1    /1   ]  76.1408363402        1
[INPUT] 0    0    [1    /1   ]  10.0297814174        1
[INPUT] 0    0    [1    /1   ]  26.9066061175        1
[INPUT] 0    0    [1    /1   ]  0.196892854279       1
[INPUT] 0    0    [1    /1   ]  1.22427884077        1
[INPUT] 0    0    [1    /1   ]  2.81929868894        1
[INPUT] 1    0    [1    /1   ]  7.11395509           1
[INPUT] 1    0    [1    /1   ]  23.1709894828        1
[INPUT] 1    0    [1    /1   ]  99.7863686008        1
[INPUT] 1    0    [1    /1   ]  0.266137731088       1
[INPUT] 1    0    [1    /1   ]  2.4418253166         1
[INPUT] 1    0    [1    /1   ]  0.834079526385       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.48845006918773287, 1.0]], [0, [24413.7941865572, 1.0]], [0, [3661.451570921697, 1.0]], [0, [833.3192843979468, 1.0]], [0, [235.44213929198426, 1.0]], [0, [76.14083634018911, 1.0]], [0, [10.029781417442058, 1.0]], [0, [26.90660611745635, 1.0]], [0, [0.19689285427946127, 1.0]], [0, [1.2242788407698002, 1.0]], [0, [2.819298688942269, 1.0]], [1, [7.113955090004149, 1.0]], [1, [23.17098948280444, 1.0]], [1, [99.78636860084518, 1.0]], [1, [0.26613773108824734, 1.0]], [1, [2.4418253165999544, 1.0]], [1, [0.8340795263849601, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.48845007]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157092]
bas 3, expnt(s) = [833.3192844]
bas 4, expnt(s) = [235.44213929]
bas 5, expnt(s) = [76.14083634]
bas 6, expnt(s) = [10.02978142]
bas 7, expnt(s) = [26.90660612]
bas 8, expnt(s) = [0.19689285]
bas 9, expnt(s) = [1.22427884]
bas 10, expnt(s) = [2.81929869]
bas 11, expnt(s) = [7.11395509]
bas 12, expnt(s) = [23.17098948]
bas 13, expnt(s) = [99.7863686]
bas 14, expnt(s) = [0.26613773]
bas 15, expnt(s) = [2.44182532]
bas 16, expnt(s) = [0.83407953]
CPU time:        34.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.88450069e-01 1.47614886e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319284e+02 3.91853381e+02
 2.35442139e+02 1.51854676e+02 7.61408363e+01 6.51220789e+01
 1.00297814e+01 1.42391356e+01 2.69066061e+01 2.98475862e+01
 1.96892854e-01 7.46771079e-01 1.22427884e+00 2.94052775e+00
 2.81929869e+00 5.49693803e+00 7.11395509e+00 3.38940364e+01
 2.31709895e+01 1.48308184e+02 9.97863686e+01 9.20075392e+02
 2.66137731e-01 5.57657381e-01 2.44182532e+00 8.90487101e+00
 8.34079526e-01 2.32537885e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999626044001321
cond(S) = 609.5771668292131
E1 = -183.58970169199966  E_coul = 55.08011276721881
init E= -128.509588924781
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775409900532407  LUMO = 0.429633279423992
  mo_energy =
[-3.25550748e+01 -1.85273080e+00 -7.75409901e-01 -7.75409901e-01
 -7.75409901e-01  4.29633279e-01  8.24241330e-01  8.24241330e-01
  8.24241330e-01  2.40454249e+00  3.95726640e+00  3.95726640e+00
  3.95726640e+00  8.92403669e+00  1.43598575e+01  1.43598575e+01
  1.43598575e+01  3.61577114e+01  5.30085488e+01  5.30085488e+01
  5.30085488e+01  1.39621016e+02  2.40836670e+02  2.40836670e+02
  2.40836670e+02  5.02593081e+02  1.86929308e+03  7.99880293e+03
  4.77666759e+04]
E1 = -182.08538309010675  E_coul = 53.54729523038903
cycle= 1 E= -128.538087859718  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519998
diis-c [-0.27039742  1.        ]
  HOMO = -0.884360794216492  LUMO = 0.414724308156012
  mo_energy =
[-3.28783248e+01 -1.96664654e+00 -8.84360794e-01 -8.84360794e-01
 -8.84360794e-01  4.14724308e-01  7.97448162e-01  7.97448162e-01
  7.97448162e-01  2.35171215e+00  3.85974766e+00  3.85974766e+00
  3.85974766e+00  8.79289232e+00  1.41690607e+01  1.41690607e+01
  1.41690607e+01  3.59125046e+01  5.27275241e+01  5.27275241e+01
  5.27275241e+01  1.39303604e+02  2.40490310e+02  2.40490310e+02
  2.40490310e+02  5.02231537e+02  1.86889545e+03  7.99837624e+03
  4.77662304e+04]
E1 = -182.8470624872039  E_coul = 54.3063859869244
cycle= 2 E= -128.54067650028  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264317
diis-c [-6.48487431e-04  3.36230794e-01  6.63769206e-01]
  HOMO = -0.848728092190689  LUMO = 0.419494602745357
  mo_energy =
[-3.27702141e+01 -1.92912619e+00 -8.48728092e-01 -8.48728092e-01
 -8.48728092e-01  4.19494603e-01  8.06182976e-01  8.06182976e-01
  8.06182976e-01  2.36871458e+00  3.89137508e+00  3.89137508e+00
  3.89137508e+00  8.83585931e+00  1.42322605e+01  1.42322605e+01
  1.42322605e+01  3.59946253e+01  5.28215550e+01  5.28215550e+01
  5.28215550e+01  1.39409513e+02  2.40603992e+02  2.40603992e+02
  2.40603992e+02  5.02348359e+02  1.86901754e+03  7.99850077e+03
  4.77663558e+04]
E1 = -182.58833976542238  E_coul = 54.04674261182982
cycle= 3 E= -128.541597153593  delta_E= -0.000921  |g|= 0.000509  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113641
diis-c [-2.74972196e-07 -2.50526462e-03 -1.11572189e-03  1.00362099e+00]
  HOMO = -0.848986495739678  LUMO = 0.419465447484728
  mo_energy =
[-3.27706676e+01 -1.92931776e+00 -8.48986496e-01 -8.48986496e-01
 -8.48986496e-01  4.19465447e-01  8.06141795e-01  8.06141795e-01
  8.06141795e-01  2.36862029e+00  3.89119670e+00  3.89119670e+00
  3.89119670e+00  8.83564021e+00  1.42319562e+01  1.42319562e+01
  1.42319562e+01  3.59942743e+01  5.28211537e+01  5.28211537e+01
  5.28211537e+01  1.39409057e+02  2.40603467e+02  2.40603467e+02
  2.40603467e+02  5.02347777e+02  1.86901682e+03  7.99849996e+03
  4.77663549e+04]
E1 = -182.58876508202576  E_coul = 54.04716790045196
cycle= 4 E= -128.541597181574  delta_E= -2.8e-08  |g|= 7.92e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182247
diis-c [-1.14911641e-09  2.54995364e-04  4.77354457e-04 -1.94276684e-01
  1.19354433e+00]
  HOMO = -0.849029411019235  LUMO = 0.419458120087343
  mo_energy =
[-3.27707379e+01 -1.92934926e+00 -8.49029411e-01 -8.49029411e-01
 -8.49029411e-01  4.19458120e-01  8.06128089e-01  8.06128089e-01
  8.06128089e-01  2.36859874e+00  3.89115679e+00  3.89115679e+00
  3.89115679e+00  8.83559563e+00  1.42318978e+01  1.42318978e+01
  1.42318978e+01  3.59942116e+01  5.28210868e+01  5.28210868e+01
  5.28210868e+01  1.39408986e+02  2.40603393e+02  2.40603393e+02
  2.40603393e+02  5.02347699e+02  1.86901674e+03  7.99849986e+03
  4.77663548e+04]
E1 = -182.58888759858945  E_coul = 54.04729041623667
cycle= 5 E= -128.541597182353  delta_E= -7.79e-10  |g|= 6.28e-06  |ddm|= 5.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58888759858945  E_coul = 54.04729041623667
  HOMO = -0.849026015135827  LUMO = 0.419458902562596
  mo_energy =
[-3.27707303e+01 -1.92934507e+00 -8.49026015e-01 -8.49026015e-01
 -8.49026015e-01  4.19458903e-01  8.06129079e-01  8.06129079e-01
  8.06129079e-01  2.36860092e+00  3.89116004e+00  3.89116004e+00
  3.89116004e+00  8.83560003e+00  1.42319034e+01  1.42319034e+01
  1.42319034e+01  3.59942183e+01  5.28210940e+01  5.28210940e+01
  5.28210940e+01  1.39408994e+02  2.40603400e+02  2.40603400e+02
  2.40603400e+02  5.02347706e+02  1.86901674e+03  7.99849987e+03
  4.77663548e+04]
E1 = -182.58887020594082  E_coul = 54.047273023585355
Extra cycle  E= -128.541597182355  delta_E= -2.7e-12  |g|= 2.44e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.14 sec
exp = [4.88450069e-01 2.44137942e+04 3.66145157e+03 8.33319284e+02
 2.35442139e+02 7.61408363e+01 1.00297814e+01 2.69066061e+01
 1.96892854e-01 1.22427884e+00 2.81929869e+00 7.11395509e+00
 2.31709895e+01 9.97863686e+01 2.66137731e-01 2.44182532e+00
 8.34079526e-01]
E = -128.54159718235547
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.488450069188       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157092        1
[INPUT] 0    0    [1    /1   ]  833.319284398        1
[INPUT] 0    0    [1    /1   ]  235.442139292        1
[INPUT] 0    0    [1    /1   ]  76.1408363402        1
[INPUT] 0    0    [1    /1   ]  10.0297814174        1
[INPUT] 0    0    [1    /1   ]  26.9066061175        1
[INPUT] 0    0    [1    /1   ]  0.196892854279       1
[INPUT] 0    0    [1    /1   ]  1.22427884077        1
[INPUT] 0    0    [1    /1   ]  2.81929868894        1
[INPUT] 1    0    [1    /1   ]  7.11395509           1
[INPUT] 1    0    [1    /1   ]  23.1709894828        1
[INPUT] 1    0    [1    /1   ]  99.7863686008        1
[INPUT] 1    0    [1    /1   ]  0.266137731088       1
[INPUT] 1    0    [1    /1   ]  2.4418253166         1
[INPUT] 1    0    [1    /1   ]  0.834079526385       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.48845006918773287, 1.0]], [0, [24413.7941865572, 1.0]], [0, [3661.451570921697, 1.0]], [0, [833.3192843979468, 1.0]], [0, [235.44213929198426, 1.0]], [0, [76.14083634018911, 1.0]], [0, [10.029781417442058, 1.0]], [0, [26.90660611745635, 1.0]], [0, [0.19689285427946127, 1.0]], [0, [1.2242788407698002, 1.0]], [0, [2.819298688942269, 1.0]], [1, [7.113955090004149, 1.0]], [1, [23.17098948280444, 1.0]], [1, [99.78636860084518, 1.0]], [1, [0.26613773108824734, 1.0]], [1, [2.4418253165999544, 1.0]], [1, [0.8340795263849601, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.48845007]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157092]
bas 3, expnt(s) = [833.3192844]
bas 4, expnt(s) = [235.44213929]
bas 5, expnt(s) = [76.14083634]
bas 6, expnt(s) = [10.02978142]
bas 7, expnt(s) = [26.90660612]
bas 8, expnt(s) = [0.19689285]
bas 9, expnt(s) = [1.22427884]
bas 10, expnt(s) = [2.81929869]
bas 11, expnt(s) = [7.11395509]
bas 12, expnt(s) = [23.17098948]
bas 13, expnt(s) = [99.7863686]
bas 14, expnt(s) = [0.26613773]
bas 15, expnt(s) = [2.44182532]
bas 16, expnt(s) = [0.83407953]
CPU time:        34.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.88450069e-01 1.47614886e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319284e+02 3.91853381e+02
 2.35442139e+02 1.51854676e+02 7.61408363e+01 6.51220789e+01
 1.00297814e+01 1.42391356e+01 2.69066061e+01 2.98475862e+01
 1.96892854e-01 7.46771079e-01 1.22427884e+00 2.94052775e+00
 2.81929869e+00 5.49693803e+00 7.11395509e+00 3.38940364e+01
 2.31709895e+01 1.48308184e+02 9.97863686e+01 9.20075392e+02
 2.66137731e-01 5.57657381e-01 2.44182532e+00 8.90487101e+00
 8.34079526e-01 2.32537885e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999626044001321
cond(S) = 609.5771668292131
E1 = -183.58970169199966  E_coul = 55.08011276721881
init E= -128.509588924781
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775409900532407  LUMO = 0.429633279423992
  mo_energy =
[-3.25550748e+01 -1.85273080e+00 -7.75409901e-01 -7.75409901e-01
 -7.75409901e-01  4.29633279e-01  8.24241330e-01  8.24241330e-01
  8.24241330e-01  2.40454249e+00  3.95726640e+00  3.95726640e+00
  3.95726640e+00  8.92403669e+00  1.43598575e+01  1.43598575e+01
  1.43598575e+01  3.61577114e+01  5.30085488e+01  5.30085488e+01
  5.30085488e+01  1.39621016e+02  2.40836670e+02  2.40836670e+02
  2.40836670e+02  5.02593081e+02  1.86929308e+03  7.99880293e+03
  4.77666759e+04]
E1 = -182.08538309010675  E_coul = 53.54729523038903
cycle= 1 E= -128.538087859718  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519998
diis-c [-0.27039742  1.        ]
  HOMO = -0.884360794216492  LUMO = 0.414724308156012
  mo_energy =
[-3.28783248e+01 -1.96664654e+00 -8.84360794e-01 -8.84360794e-01
 -8.84360794e-01  4.14724308e-01  7.97448162e-01  7.97448162e-01
  7.97448162e-01  2.35171215e+00  3.85974766e+00  3.85974766e+00
  3.85974766e+00  8.79289232e+00  1.41690607e+01  1.41690607e+01
  1.41690607e+01  3.59125046e+01  5.27275241e+01  5.27275241e+01
  5.27275241e+01  1.39303604e+02  2.40490310e+02  2.40490310e+02
  2.40490310e+02  5.02231537e+02  1.86889545e+03  7.99837624e+03
  4.77662304e+04]
E1 = -182.8470624872039  E_coul = 54.3063859869244
cycle= 2 E= -128.54067650028  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.264317
diis-c [-6.48487431e-04  3.36230794e-01  6.63769206e-01]
  HOMO = -0.848728092190689  LUMO = 0.419494602745357
  mo_energy =
[-3.27702141e+01 -1.92912619e+00 -8.48728092e-01 -8.48728092e-01
 -8.48728092e-01  4.19494603e-01  8.06182976e-01  8.06182976e-01
  8.06182976e-01  2.36871458e+00  3.89137508e+00  3.89137508e+00
  3.89137508e+00  8.83585931e+00  1.42322605e+01  1.42322605e+01
  1.42322605e+01  3.59946253e+01  5.28215550e+01  5.28215550e+01
  5.28215550e+01  1.39409513e+02  2.40603992e+02  2.40603992e+02
  2.40603992e+02  5.02348359e+02  1.86901754e+03  7.99850077e+03
  4.77663558e+04]
E1 = -182.58833976542238  E_coul = 54.04674261182982
cycle= 3 E= -128.541597153593  delta_E= -0.000921  |g|= 0.000509  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113641
diis-c [-2.74972196e-07 -2.50526462e-03 -1.11572189e-03  1.00362099e+00]
  HOMO = -0.848986495739678  LUMO = 0.419465447484728
  mo_energy =
[-3.27706676e+01 -1.92931776e+00 -8.48986496e-01 -8.48986496e-01
 -8.48986496e-01  4.19465447e-01  8.06141795e-01  8.06141795e-01
  8.06141795e-01  2.36862029e+00  3.89119670e+00  3.89119670e+00
  3.89119670e+00  8.83564021e+00  1.42319562e+01  1.42319562e+01
  1.42319562e+01  3.59942743e+01  5.28211537e+01  5.28211537e+01
  5.28211537e+01  1.39409057e+02  2.40603467e+02  2.40603467e+02
  2.40603467e+02  5.02347777e+02  1.86901682e+03  7.99849996e+03
  4.77663549e+04]
E1 = -182.58876508202576  E_coul = 54.04716790045196
cycle= 4 E= -128.541597181574  delta_E= -2.8e-08  |g|= 7.92e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182247
diis-c [-1.14911641e-09  2.54995364e-04  4.77354457e-04 -1.94276684e-01
  1.19354433e+00]
  HOMO = -0.849029411019235  LUMO = 0.419458120087343
  mo_energy =
[-3.27707379e+01 -1.92934926e+00 -8.49029411e-01 -8.49029411e-01
 -8.49029411e-01  4.19458120e-01  8.06128089e-01  8.06128089e-01
  8.06128089e-01  2.36859874e+00  3.89115679e+00  3.89115679e+00
  3.89115679e+00  8.83559563e+00  1.42318978e+01  1.42318978e+01
  1.42318978e+01  3.59942116e+01  5.28210868e+01  5.28210868e+01
  5.28210868e+01  1.39408986e+02  2.40603393e+02  2.40603393e+02
  2.40603393e+02  5.02347699e+02  1.86901674e+03  7.99849986e+03
  4.77663548e+04]
E1 = -182.58888759858945  E_coul = 54.04729041623667
cycle= 5 E= -128.541597182353  delta_E= -7.79e-10  |g|= 6.28e-06  |ddm|= 5.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58888759858945  E_coul = 54.04729041623667
  HOMO = -0.849026015135827  LUMO = 0.419458902562596
  mo_energy =
[-3.27707303e+01 -1.92934507e+00 -8.49026015e-01 -8.49026015e-01
 -8.49026015e-01  4.19458903e-01  8.06129079e-01  8.06129079e-01
  8.06129079e-01  2.36860092e+00  3.89116004e+00  3.89116004e+00
  3.89116004e+00  8.83560003e+00  1.42319034e+01  1.42319034e+01
  1.42319034e+01  3.59942183e+01  5.28210940e+01  5.28210940e+01
  5.28210940e+01  1.39408994e+02  2.40603400e+02  2.40603400e+02
  2.40603400e+02  5.02347706e+02  1.86901674e+03  7.99849987e+03
  4.77663548e+04]
E1 = -182.58887020594082  E_coul = 54.047273023585355
Extra cycle  E= -128.541597182355  delta_E= -2.7e-12  |g|= 2.44e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 609.5771668292131
E1 = -182.58887020594082  E_coul = 54.047273023585355
init E= -128.541597182355
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.849027243443213  LUMO = 0.41945878973426
  mo_energy =
[-3.27707341e+01 -1.92934623e+00 -8.49027243e-01 -8.49027243e-01
 -8.49027243e-01  4.19458790e-01  8.06128797e-01  8.06128797e-01
  8.06128797e-01  2.36860042e+00  3.89115898e+00  3.89115898e+00
  3.89115898e+00  8.83559861e+00  1.42319012e+01  1.42319012e+01
  1.42319012e+01  3.59942155e+01  5.28210907e+01  5.28210907e+01
  5.28210907e+01  1.39408990e+02  2.40603396e+02  2.40603396e+02
  2.40603396e+02  5.02347702e+02  1.86901674e+03  7.99849987e+03
  4.77663548e+04]
E1 = -182.58887982528432  E_coul = 54.04728264292851
cycle= 1 E= -128.541597182356  delta_E= -3.41e-13  |g|= 1.32e-06  |ddm|= 8.69e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58887982528432  E_coul = 54.04728264292851
  HOMO = -0.849026565811149  LUMO = 0.419458890509303
  mo_energy =
[-3.27707321e+01 -1.92934549e+00 -8.49026566e-01 -8.49026566e-01
 -8.49026566e-01  4.19458891e-01  8.06128967e-01  8.06128967e-01
  8.06128967e-01  2.36860076e+00  3.89115959e+00  3.89115959e+00
  3.89115959e+00  8.83559945e+00  1.42319024e+01  1.42319024e+01
  1.42319024e+01  3.59942170e+01  5.28210925e+01  5.28210925e+01
  5.28210925e+01  1.39408992e+02  2.40603398e+02  2.40603398e+02
  2.40603398e+02  5.02347704e+02  1.86901674e+03  7.99849987e+03
  4.77663548e+04]
E1 = -182.58887498250655  E_coul = 54.04727780015036
Extra cycle  E= -128.541597182356  delta_E= -3.69e-13  |g|= 6.58e-07  |ddm|= 4.22e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [4.88450069e-01 2.44137942e+04 3.66145157e+03 8.33319284e+02
 2.35442139e+02 7.61408363e+01 1.00297814e+01 2.69066061e+01
 1.96892854e-01 1.22427884e+00 2.81929869e+00 7.11395509e+00
 2.31709895e+01 9.97863686e+01 2.66137731e-01 2.44182532e+00
 8.34079526e-01]
grad_E = [-4.61913562e-04  2.37620047e-10 -1.14268670e-08  1.72779137e-07
 -1.48333415e-06  1.58971274e-05 -7.22635657e-05 -3.95832007e-05
 -8.39990199e-05 -2.34126891e-04 -1.58317187e-04  1.04666402e-06
 -2.35631370e-08  2.70921891e-08  5.31191546e-05 -6.72981892e-06
  3.53304951e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.489074775669       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157095        1
[INPUT] 0    0    [1    /1   ]  833.319284012        1
[INPUT] 0    0    [1    /1   ]  235.442143003        1
[INPUT] 0    0    [1    /1   ]  76.1408011528        1
[INPUT] 0    0    [1    /1   ]  10.0298090568        1
[INPUT] 0    0    [1    /1   ]  26.9067138375        1
[INPUT] 0    0    [1    /1   ]  0.197665609448       1
[INPUT] 0    0    [1    /1   ]  1.22473909243        1
[INPUT] 0    0    [1    /1   ]  2.81962678131        1
[INPUT] 1    0    [1    /1   ]  7.11394676552        1
[INPUT] 1    0    [1    /1   ]  23.1709900982        1
[INPUT] 1    0    [1    /1   ]  99.7863685406        1
[INPUT] 1    0    [1    /1   ]  0.266206487322       1
[INPUT] 1    0    [1    /1   ]  2.44187352375        1
[INPUT] 1    0    [1    /1   ]  0.833902961857       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.48907477566914287, 1.0]], [0, [24413.794186556723, 1.0]], [0, [3661.451570945172, 1.0]], [0, [833.3192840124406, 1.0]], [0, [235.44214300300038, 1.0]], [0, [76.14080115275267, 1.0]], [0, [10.029809056774614, 1.0]], [0, [26.906713837505023, 1.0]], [0, [0.1976656094479941, 1.0]], [0, [1.224739092427898, 1.0]], [0, [2.819626781310728, 1.0]], [1, [7.113946765521917, 1.0]], [1, [23.170990098188657, 1.0]], [1, [99.78636854061473, 1.0]], [1, [0.2662064873218538, 1.0]], [1, [2.4418735237462714, 1.0]], [1, [0.8339029618572243, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.48907478]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157095]
bas 3, expnt(s) = [833.31928401]
bas 4, expnt(s) = [235.442143]
bas 5, expnt(s) = [76.14080115]
bas 6, expnt(s) = [10.02980906]
bas 7, expnt(s) = [26.90671384]
bas 8, expnt(s) = [0.19766561]
bas 9, expnt(s) = [1.22473909]
bas 10, expnt(s) = [2.81962678]
bas 11, expnt(s) = [7.11394677]
bas 12, expnt(s) = [23.1709901]
bas 13, expnt(s) = [99.78636854]
bas 14, expnt(s) = [0.26620649]
bas 15, expnt(s) = [2.44187352]
bas 16, expnt(s) = [0.83390296]
CPU time:        37.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.89074776e-01 1.47756458e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319284e+02 3.91853381e+02
 2.35442143e+02 1.51854678e+02 7.61408012e+01 6.51220564e+01
 1.00298091e+01 1.42391650e+01 2.69067138e+01 2.98476758e+01
 1.97665609e-01 7.48968170e-01 1.22473909e+00 2.94135680e+00
 2.81962678e+00 5.49741780e+00 7.11394677e+00 3.38939868e+01
 2.31709901e+01 1.48308189e+02 9.97863685e+01 9.20075391e+02
 2.66206487e-01 5.57837475e-01 2.44187352e+00 8.90509076e+00
 8.33902962e-01 2.32476355e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999626221873154
cond(S) = 612.0615273685509
E1 = -183.589708681487  E_coul = 55.080114041338824
init E= -128.509594640148
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775409765789128  LUMO = 0.431225554503106
  mo_energy =
[-3.25550750e+01 -1.85273064e+00 -7.75409766e-01 -7.75409766e-01
 -7.75409766e-01  4.31225555e-01  8.24369636e-01  8.24369636e-01
  8.24369636e-01  2.40953682e+00  3.95710457e+00  3.95710457e+00
  3.95710457e+00  8.93200645e+00  1.43595798e+01  1.43595798e+01
  1.43595798e+01  3.61669876e+01  5.30083205e+01  5.30083205e+01
  5.30083205e+01  1.39629763e+02  2.40836513e+02  2.40836513e+02
  2.40836513e+02  5.02600999e+02  1.86930016e+03  7.99880915e+03
  4.77666810e+04]
E1 = -182.085572298019  E_coul = 53.5474834693567
cycle= 1 E= -128.538088828662  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519999
diis-c [-0.27039879  1.        ]
  HOMO = -0.884344887884445  LUMO = 0.416270656278012
  mo_energy =
[-3.28782966e+01 -1.96662845e+00 -8.84344888e-01 -8.84344888e-01
 -8.84344888e-01  4.16270656e-01  7.97583504e-01  7.97583504e-01
  7.97583504e-01  2.35667616e+00  3.85960916e+00  3.85960916e+00
  3.85960916e+00  8.80086944e+00  1.41688050e+01  1.41688050e+01
  1.41688050e+01  3.59218116e+01  5.27273226e+01  5.27273226e+01
  5.27273226e+01  1.39312381e+02  2.40490181e+02  2.40490181e+02
  2.40490181e+02  5.02239484e+02  1.86890256e+03  7.99838249e+03
  4.77662355e+04]
E1 = -182.84718401903243  E_coul = 54.30650683405687
cycle= 2 E= -128.540677184976  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264308
diis-c [-6.48405446e-04  3.36222849e-01  6.63777151e-01]
  HOMO = -0.848714945473243  LUMO = 0.421057679917904
  mo_energy =
[-3.27701941e+01 -1.92911106e+00 -8.48714945e-01 -8.48714945e-01
 -8.48714945e-01  4.21057680e-01  8.06317801e-01  8.06317801e-01
  8.06317801e-01  2.37369118e+00  3.89123223e+00  3.89123223e+00
  3.89123223e+00  8.84383659e+00  1.42320001e+01  1.42320001e+01
  1.42320001e+01  3.60039242e+01  5.28213464e+01  5.28213464e+01
  5.28213464e+01  1.39418281e+02  2.40603854e+02  2.40603854e+02
  2.40603854e+02  5.02356297e+02  1.86902464e+03  7.99850702e+03
  4.77663610e+04]
E1 = -182.58850448537055  E_coul = 54.04690686985013
cycle= 3 E= -128.54159761552  delta_E= -0.00092  |g|= 0.000507  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113412
diis-c [-2.74797998e-07 -2.50062058e-03 -1.11611695e-03  1.00361674e+00]
  HOMO = -0.848972275842775  LUMO = 0.421028867811366
  mo_energy =
[-3.27706460e+01 -1.92930132e+00 -8.48972276e-01 -8.48972276e-01
 -8.48972276e-01  4.21028868e-01  8.06277073e-01  8.06277073e-01
  8.06277073e-01  2.37359767e+00  3.89105499e+00  3.89105499e+00
  3.89105499e+00  8.84361876e+00  1.42316972e+01  1.42316972e+01
  1.42316972e+01  3.60035748e+01  5.28209466e+01  5.28209466e+01
  5.28209466e+01  1.39417827e+02  2.40603331e+02  2.40603331e+02
  2.40603331e+02  5.02355717e+02  1.86902392e+03  7.99850620e+03
  4.77663601e+04]
E1 = -182.588929147654  E_coul = 54.047331504324006
cycle= 4 E= -128.54159764333  delta_E= -2.78e-08  |g|= 7.9e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182126
diis-c [-1.15391832e-09  2.55885628e-04  4.78222689e-04 -1.94790788e-01
  1.19405668e+00]
  HOMO = -0.849015049220913  LUMO = 0.421021585700623
  mo_energy =
[-3.27707162e+01 -1.92933260e+00 -8.49015049e-01 -8.49015049e-01
 -8.49015049e-01  4.21021586e-01  8.06263428e-01  8.06263428e-01
  8.06263428e-01  2.37357624e+00  3.89101524e+00  3.89101524e+00
  3.89101524e+00  8.84357437e+00  1.42316390e+01  1.42316390e+01
  1.42316390e+01  3.60035123e+01  5.28208799e+01  5.28208799e+01
  5.28208799e+01  1.39417756e+02  2.40603257e+02  2.40603257e+02
  2.40603257e+02  5.02355638e+02  1.86902384e+03  7.99850611e+03
  4.77663600e+04]
E1 = -182.58905166390434  E_coul = 54.04745401979628
cycle= 5 E= -128.541597644108  delta_E= -7.78e-10  |g|= 6.3e-06  |ddm|= 5.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.58905166390434  E_coul = 54.04745401979628
  HOMO = -0.849011641521932  LUMO = 0.421022372665519
  mo_energy =
[-3.27707085e+01 -1.92932840e+00 -8.49011642e-01 -8.49011642e-01
 -8.49011642e-01  4.21022373e-01  8.06264422e-01  8.06264422e-01
  8.06264422e-01  2.37357842e+00  3.89101850e+00  3.89101850e+00
  3.89101850e+00  8.84357879e+00  1.42316446e+01  1.42316446e+01
  1.42316446e+01  3.60035190e+01  5.28208871e+01  5.28208871e+01
  5.28208871e+01  1.39417764e+02  2.40603264e+02  2.40603264e+02
  2.40603264e+02  5.02355645e+02  1.86902384e+03  7.99850611e+03
  4.77663600e+04]
E1 = -182.58903421920226  E_coul = 54.04743657509168
Extra cycle  E= -128.541597644111  delta_E= -2.53e-12  |g|= 2.44e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [4.89074776e-01 2.44137942e+04 3.66145157e+03 8.33319284e+02
 2.35442143e+02 7.61408012e+01 1.00298091e+01 2.69067138e+01
 1.97665609e-01 1.22473909e+00 2.81962678e+00 7.11394677e+00
 2.31709901e+01 9.97863685e+01 2.66206487e-01 2.44187352e+00
 8.33902962e-01]
E = -128.5415976441106
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.489074775669       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157095        1
[INPUT] 0    0    [1    /1   ]  833.319284012        1
[INPUT] 0    0    [1    /1   ]  235.442143003        1
[INPUT] 0    0    [1    /1   ]  76.1408011528        1
[INPUT] 0    0    [1    /1   ]  10.0298090568        1
[INPUT] 0    0    [1    /1   ]  26.9067138375        1
[INPUT] 0    0    [1    /1   ]  0.197665609448       1
[INPUT] 0    0    [1    /1   ]  1.22473909243        1
[INPUT] 0    0    [1    /1   ]  2.81962678131        1
[INPUT] 1    0    [1    /1   ]  7.11394676552        1
[INPUT] 1    0    [1    /1   ]  23.1709900982        1
[INPUT] 1    0    [1    /1   ]  99.7863685406        1
[INPUT] 1    0    [1    /1   ]  0.266206487322       1
[INPUT] 1    0    [1    /1   ]  2.44187352375        1
[INPUT] 1    0    [1    /1   ]  0.833902961857       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.48907477566914287, 1.0]], [0, [24413.794186556723, 1.0]], [0, [3661.451570945172, 1.0]], [0, [833.3192840124406, 1.0]], [0, [235.44214300300038, 1.0]], [0, [76.14080115275267, 1.0]], [0, [10.029809056774614, 1.0]], [0, [26.906713837505023, 1.0]], [0, [0.1976656094479941, 1.0]], [0, [1.224739092427898, 1.0]], [0, [2.819626781310728, 1.0]], [1, [7.113946765521917, 1.0]], [1, [23.170990098188657, 1.0]], [1, [99.78636854061473, 1.0]], [1, [0.2662064873218538, 1.0]], [1, [2.4418735237462714, 1.0]], [1, [0.8339029618572243, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.48907478]
bas 1, expnt(s) = [24413.79418656]
bas 2, expnt(s) = [3661.45157095]
bas 3, expnt(s) = [833.31928401]
bas 4, expnt(s) = [235.442143]
bas 5, expnt(s) = [76.14080115]
bas 6, expnt(s) = [10.02980906]
bas 7, expnt(s) = [26.90671384]
bas 8, expnt(s) = [0.19766561]
bas 9, expnt(s) = [1.22473909]
bas 10, expnt(s) = [2.81962678]
bas 11, expnt(s) = [7.11394677]
bas 12, expnt(s) = [23.1709901]
bas 13, expnt(s) = [99.78636854]
bas 14, expnt(s) = [0.26620649]
bas 15, expnt(s) = [2.44187352]
bas 16, expnt(s) = [0.83390296]
CPU time:        37.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.89074776e-01 1.47756458e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319284e+02 3.91853381e+02
 2.35442143e+02 1.51854678e+02 7.61408012e+01 6.51220564e+01
 1.00298091e+01 1.42391650e+01 2.69067138e+01 2.98476758e+01
 1.97665609e-01 7.48968170e-01 1.22473909e+00 2.94135680e+00
 2.81962678e+00 5.49741780e+00 7.11394677e+00 3.38939868e+01
 2.31709901e+01 1.48308189e+02 9.97863685e+01 9.20075391e+02
 2.66206487e-01 5.57837475e-01 2.44187352e+00 8.90509076e+00
 8.33902962e-01 2.32476355e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999626221873154
cond(S) = 612.0615273685509
E1 = -183.589708681487  E_coul = 55.080114041338824
init E= -128.509594640148
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775409765789128  LUMO = 0.431225554503106
  mo_energy =
[-3.25550750e+01 -1.85273064e+00 -7.75409766e-01 -7.75409766e-01
 -7.75409766e-01  4.31225555e-01  8.24369636e-01  8.24369636e-01
  8.24369636e-01  2.40953682e+00  3.95710457e+00  3.95710457e+00
  3.95710457e+00  8.93200645e+00  1.43595798e+01  1.43595798e+01
  1.43595798e+01  3.61669876e+01  5.30083205e+01  5.30083205e+01
  5.30083205e+01  1.39629763e+02  2.40836513e+02  2.40836513e+02
  2.40836513e+02  5.02600999e+02  1.86930016e+03  7.99880915e+03
  4.77666810e+04]
E1 = -182.085572298019  E_coul = 53.5474834693567
cycle= 1 E= -128.538088828662  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519999
diis-c [-0.27039879  1.        ]
  HOMO = -0.884344887884445  LUMO = 0.416270656278012
  mo_energy =
[-3.28782966e+01 -1.96662845e+00 -8.84344888e-01 -8.84344888e-01
 -8.84344888e-01  4.16270656e-01  7.97583504e-01  7.97583504e-01
  7.97583504e-01  2.35667616e+00  3.85960916e+00  3.85960916e+00
  3.85960916e+00  8.80086944e+00  1.41688050e+01  1.41688050e+01
  1.41688050e+01  3.59218116e+01  5.27273226e+01  5.27273226e+01
  5.27273226e+01  1.39312381e+02  2.40490181e+02  2.40490181e+02
  2.40490181e+02  5.02239484e+02  1.86890256e+03  7.99838249e+03
  4.77662355e+04]
E1 = -182.84718401903243  E_coul = 54.30650683405687
cycle= 2 E= -128.540677184976  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264308
diis-c [-6.48405446e-04  3.36222849e-01  6.63777151e-01]
  HOMO = -0.848714945473243  LUMO = 0.421057679917904
  mo_energy =
[-3.27701941e+01 -1.92911106e+00 -8.48714945e-01 -8.48714945e-01
 -8.48714945e-01  4.21057680e-01  8.06317801e-01  8.06317801e-01
  8.06317801e-01  2.37369118e+00  3.89123223e+00  3.89123223e+00
  3.89123223e+00  8.84383659e+00  1.42320001e+01  1.42320001e+01
  1.42320001e+01  3.60039242e+01  5.28213464e+01  5.28213464e+01
  5.28213464e+01  1.39418281e+02  2.40603854e+02  2.40603854e+02
  2.40603854e+02  5.02356297e+02  1.86902464e+03  7.99850702e+03
  4.77663610e+04]
E1 = -182.58850448537055  E_coul = 54.04690686985013
cycle= 3 E= -128.54159761552  delta_E= -0.00092  |g|= 0.000507  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113412
diis-c [-2.74797998e-07 -2.50062058e-03 -1.11611695e-03  1.00361674e+00]
  HOMO = -0.848972275842775  LUMO = 0.421028867811366
  mo_energy =
[-3.27706460e+01 -1.92930132e+00 -8.48972276e-01 -8.48972276e-01
 -8.48972276e-01  4.21028868e-01  8.06277073e-01  8.06277073e-01
  8.06277073e-01  2.37359767e+00  3.89105499e+00  3.89105499e+00
  3.89105499e+00  8.84361876e+00  1.42316972e+01  1.42316972e+01
  1.42316972e+01  3.60035748e+01  5.28209466e+01  5.28209466e+01
  5.28209466e+01  1.39417827e+02  2.40603331e+02  2.40603331e+02
  2.40603331e+02  5.02355717e+02  1.86902392e+03  7.99850620e+03
  4.77663601e+04]
E1 = -182.588929147654  E_coul = 54.047331504324006
cycle= 4 E= -128.54159764333  delta_E= -2.78e-08  |g|= 7.9e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000182126
diis-c [-1.15391832e-09  2.55885628e-04  4.78222689e-04 -1.94790788e-01
  1.19405668e+00]
  HOMO = -0.849015049220913  LUMO = 0.421021585700623
  mo_energy =
[-3.27707162e+01 -1.92933260e+00 -8.49015049e-01 -8.49015049e-01
 -8.49015049e-01  4.21021586e-01  8.06263428e-01  8.06263428e-01
  8.06263428e-01  2.37357624e+00  3.89101524e+00  3.89101524e+00
  3.89101524e+00  8.84357437e+00  1.42316390e+01  1.42316390e+01
  1.42316390e+01  3.60035123e+01  5.28208799e+01  5.28208799e+01
  5.28208799e+01  1.39417756e+02  2.40603257e+02  2.40603257e+02
  2.40603257e+02  5.02355638e+02  1.86902384e+03  7.99850611e+03
  4.77663600e+04]
E1 = -182.58905166390434  E_coul = 54.04745401979628
cycle= 5 E= -128.541597644108  delta_E= -7.78e-10  |g|= 6.3e-06  |ddm|= 5.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58905166390434  E_coul = 54.04745401979628
  HOMO = -0.849011641521932  LUMO = 0.421022372665519
  mo_energy =
[-3.27707085e+01 -1.92932840e+00 -8.49011642e-01 -8.49011642e-01
 -8.49011642e-01  4.21022373e-01  8.06264422e-01  8.06264422e-01
  8.06264422e-01  2.37357842e+00  3.89101850e+00  3.89101850e+00
  3.89101850e+00  8.84357879e+00  1.42316446e+01  1.42316446e+01
  1.42316446e+01  3.60035190e+01  5.28208871e+01  5.28208871e+01
  5.28208871e+01  1.39417764e+02  2.40603264e+02  2.40603264e+02
  2.40603264e+02  5.02355645e+02  1.86902384e+03  7.99850611e+03
  4.77663600e+04]
E1 = -182.58903421920226  E_coul = 54.04743657509168
Extra cycle  E= -128.541597644111  delta_E= -2.53e-12  |g|= 2.44e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 612.0615273685509
E1 = -182.58903421920226  E_coul = 54.04743657509168
init E= -128.541597644111
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.849012873342494  LUMO = 0.421022258982914
  mo_energy =
[-3.27707124e+01 -1.92932956e+00 -8.49012873e-01 -8.49012873e-01
 -8.49012873e-01  4.21022259e-01  8.06264139e-01  8.06264139e-01
  8.06264139e-01  2.37357792e+00  3.89101744e+00  3.89101744e+00
  3.89101744e+00  8.84357737e+00  1.42316424e+01  1.42316424e+01
  1.42316424e+01  3.60035161e+01  5.28208838e+01  5.28208838e+01
  5.28208838e+01  1.39417760e+02  2.40603260e+02  2.40603260e+02
  2.40603260e+02  5.02355641e+02  1.86902384e+03  7.99850611e+03
  4.77663600e+04]
E1 = -182.5890438673516  E_coul = 54.047446223240485
cycle= 1 E= -128.541597644111  delta_E= -5.12e-13  |g|= 1.32e-06  |ddm|= 8.71e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5890438673516  E_coul = 54.047446223240485
  HOMO = -0.849012193657542  LUMO = 0.421022360386554
  mo_energy =
[-3.27707103e+01 -1.92932881e+00 -8.49012194e-01 -8.49012194e-01
 -8.49012194e-01  4.21022360e-01  8.06264309e-01  8.06264309e-01
  8.06264309e-01  2.37357826e+00  3.89101805e+00  3.89101805e+00
  3.89101805e+00  8.84357820e+00  1.42316436e+01  1.42316436e+01
  1.42316436e+01  3.60035177e+01  5.28208856e+01  5.28208856e+01
  5.28208856e+01  1.39417762e+02  2.40603262e+02  2.40603262e+02
  2.40603262e+02  5.02355643e+02  1.86902384e+03  7.99850611e+03
  4.77663600e+04]
E1 = -182.58903901044732  E_coul = 54.04744136633576
Extra cycle  E= -128.541597644112  delta_E= -4.55e-13  |g|= 6.6e-07  |ddm|= 4.23e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [4.89074776e-01 2.44137942e+04 3.66145157e+03 8.33319284e+02
 2.35442143e+02 7.61408012e+01 1.00298091e+01 2.69067138e+01
 1.97665609e-01 1.22473909e+00 2.81962678e+00 7.11394677e+00
 2.31709901e+01 9.97863685e+01 2.66206487e-01 2.44187352e+00
 8.33902962e-01]
grad_E = [-4.58784833e-04  2.35889797e-10 -1.13362612e-08  1.70963690e-07
 -1.46205021e-06  1.57357161e-05 -7.40950613e-05 -3.88320074e-05
 -7.62355239e-05 -2.36824462e-04 -1.56985269e-04 -1.90898524e-05
  1.71406983e-06 -3.01223200e-08  6.65437413e-04  1.11079236e-04
 -3.45110208e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.493010074532       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157109        1
[INPUT] 0    0    [1    /1   ]  833.319281634        1
[INPUT] 0    0    [1    /1   ]  235.442165208        1
[INPUT] 0    0    [1    /1   ]  76.1405831903        1
[INPUT] 0    0    [1    /1   ]  10.030176103         1
[INPUT] 0    0    [1    /1   ]  26.9073504662        1
[INPUT] 0    0    [1    /1   ]  0.201753863299       1
[INPUT] 0    0    [1    /1   ]  1.22835408012        1
[INPUT] 0    0    [1    /1   ]  2.82153160323        1
[INPUT] 1    0    [1    /1   ]  7.11392828955        1
[INPUT] 1    0    [1    /1   ]  23.1709908532        1
[INPUT] 1    0    [1    /1   ]  99.7863682373        1
[INPUT] 1    0    [1    /1   ]  0.266327339307       1
[INPUT] 1    0    [1    /1   ]  2.44200224576        1
[INPUT] 1    0    [1    /1   ]  0.833181710454       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.49301007453184953, 1.0]], [0, [24413.794186553685, 1.0]], [0, [3661.451571093562, 1.0]], [0, [833.319281633967, 1.0]], [0, [235.44216520783735, 1.0]], [0, [76.14058319028368, 1.0]], [0, [10.030176102977242, 1.0]], [0, [26.90735046619733, 1.0]], [0, [0.20175386329871384, 1.0]], [0, [1.228354080119166, 1.0]], [0, [2.8215316032329296, 1.0]], [1, [7.113928289548197, 1.0]], [1, [23.170990853210316, 1.0]], [1, [99.78636823733981, 1.0]], [1, [0.2663273393069556, 1.0]], [1, [2.4420022457576893, 1.0]], [1, [0.8331817104535583, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49301007]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157109]
bas 3, expnt(s) = [833.31928163]
bas 4, expnt(s) = [235.44216521]
bas 5, expnt(s) = [76.14058319]
bas 6, expnt(s) = [10.0301761]
bas 7, expnt(s) = [26.90735047]
bas 8, expnt(s) = [0.20175386]
bas 9, expnt(s) = [1.22835408]
bas 10, expnt(s) = [2.8215316]
bas 11, expnt(s) = [7.11392829]
bas 12, expnt(s) = [23.17099085]
bas 13, expnt(s) = [99.78636824]
bas 14, expnt(s) = [0.26632734]
bas 15, expnt(s) = [2.44200225]
bas 16, expnt(s) = [0.83318171]
CPU time:        40.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.93010075e-01 1.48647247e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319282e+02 3.91853380e+02
 2.35442165e+02 1.51854689e+02 7.61405832e+01 6.51219165e+01
 1.00301761e+01 1.42395558e+01 2.69073505e+01 2.98482055e+01
 2.01753863e-01 7.60556389e-01 1.22835408e+00 2.94786577e+00
 2.82153160e+00 5.50020294e+00 7.11392829e+00 3.38938768e+01
 2.31709909e+01 1.48308195e+02 9.97863682e+01 9.20075388e+02
 2.66327339e-01 5.58154050e-01 2.44200225e+00 8.90567755e+00
 8.33181710e-01 2.32225043e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999627347407515
cond(S) = 626.5352725391784
E1 = -183.5897304492014  E_coul = 55.08011554011241
init E= -128.509614909089
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775409523383852  LUMO = 0.439889805727281
  mo_energy =
[-3.25550763e+01 -1.85273074e+00 -7.75409523e-01 -7.75409523e-01
 -7.75409523e-01  4.39889806e-01  8.24460248e-01  8.24460248e-01
  8.24460248e-01  2.43830499e+00  3.95579898e+00  3.95579898e+00
  3.95579898e+00  8.98051087e+00  1.43577421e+01  1.43577421e+01
  1.43577421e+01  3.62248448e+01  5.30067864e+01  5.30067864e+01
  5.30067864e+01  1.39684764e+02  2.40835458e+02  2.40835458e+02
  2.40835458e+02  5.02650880e+02  1.86934478e+03  7.99884836e+03
  4.77667135e+04]
E1 = -182.0860683883621  E_coul = 53.54797605958567
cycle= 1 E= -128.538092328776  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.520036
diis-c [-0.27043766  1.        ]
  HOMO = -0.88430274961075  LUMO = 0.424659573006676
  mo_energy =
[-3.28782249e+01 -1.96658101e+00 -8.84302750e-01 -8.84302750e-01
 -8.84302750e-01  4.24659573e-01  7.97704354e-01  7.97704354e-01
  7.97704354e-01  2.38520726e+00  3.85837436e+00  3.85837436e+00
  3.85837436e+00  8.84933621e+00  1.41670220e+01  1.41670220e+01
  1.41670220e+01  3.59797646e+01  5.27258564e+01  5.27258564e+01
  5.27258564e+01  1.39367469e+02  2.40489195e+02  2.40489195e+02
  2.40489195e+02  5.02289439e+02  1.86894725e+03  7.99842178e+03
  4.77662681e+04]
E1 = -182.84752625781485  E_coul = 54.306846221593545
cycle= 2 E= -128.540680036221  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264302
diis-c [-6.48207846e-04  3.36201422e-01  6.63798578e-01]
  HOMO = -0.848678795525531  LUMO = 0.429540914027022
  mo_energy =
[-3.27701410e+01 -1.92907003e+00 -8.48678796e-01 -8.48678796e-01
 -8.48678796e-01  4.29540914e-01  8.06434315e-01  8.06434315e-01
  8.06434315e-01  2.40230769e+00  3.88998453e+00  3.88998453e+00
  3.88998453e+00  8.89232421e+00  1.42302077e+01  1.42302077e+01
  1.42302077e+01  3.60618527e+01  5.28198647e+01  5.28198647e+01
  5.28198647e+01  1.39473346e+02  2.40602849e+02  2.40602849e+02
  2.40602849e+02  5.02406231e+02  1.86906931e+03  7.99854628e+03
  4.77663935e+04]
E1 = -182.58895594910612  E_coul = 54.047356029393484
cycle= 3 E= -128.541599919713  delta_E= -0.00092  |g|= 0.000502  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112758
diis-c [-2.73118989e-07 -2.48384319e-03 -1.10833178e-03  1.00359217e+00]
  HOMO = -0.848932971869608  LUMO = 0.429512913342342
  mo_energy =
[-3.27705886e+01 -1.92925644e+00 -8.48932972e-01 -8.48932972e-01
 -8.48932972e-01  4.29512913e-01  8.06394964e-01  8.06394964e-01
  8.06394964e-01  2.40221620e+00  3.88981068e+00  3.88981068e+00
  3.88981068e+00  8.89210999e+00  1.42299090e+01  1.42299090e+01
  1.42299090e+01  3.60615076e+01  5.28194693e+01  5.28194693e+01
  5.28194693e+01  1.39472896e+02  2.40602330e+02  2.40602330e+02
  2.40602330e+02  5.02405655e+02  1.86906860e+03  7.99854547e+03
  4.77663926e+04]
E1 = -182.58937927813233  E_coul = 54.04777933111419
cycle= 4 E= -128.541599947018  delta_E= -2.73e-08  |g|= 7.86e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181782
diis-c [-1.16814707e-09  2.58372497e-04  4.80568290e-04 -1.96277542e-01
  1.19553860e+00]
  HOMO = -0.848975331574015  LUMO = 0.429505709440322
  mo_energy =
[-3.27706582e+01 -1.92928710e+00 -8.48975332e-01 -8.48975332e-01
 -8.48975332e-01  4.29505709e-01  8.06381509e-01  8.06381509e-01
  8.06381509e-01  2.40219507e+00  3.88977141e+00  3.88977141e+00
  3.88977141e+00  8.89206613e+00  1.42298514e+01  1.42298514e+01
  1.42298514e+01  3.60614456e+01  5.28194032e+01  5.28194032e+01
  5.28194032e+01  1.39472826e+02  2.40602256e+02  2.40602256e+02
  2.40602256e+02  5.02405577e+02  1.86906851e+03  7.99854538e+03
  4.77663925e+04]
E1 = -182.58950188600903  E_coul = 54.0479019382163
cycle= 5 E= -128.541599947793  delta_E= -7.75e-10  |g|= 6.35e-06  |ddm|= 5.23e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58950188600903  E_coul = 54.0479019382163
  HOMO = -0.848971891186519  LUMO = 0.429506515646809
  mo_energy =
[-3.27706505e+01 -1.92928287e+00 -8.48971891e-01 -8.48971891e-01
 -8.48971891e-01  4.29506516e-01  8.06382512e-01  8.06382512e-01
  8.06382512e-01  2.40219728e+00  3.88977470e+00  3.88977470e+00
  3.88977470e+00  8.89207059e+00  1.42298570e+01  1.42298570e+01
  1.42298570e+01  3.60614524e+01  5.28194104e+01  5.28194104e+01
  5.28194104e+01  1.39472834e+02  2.40602263e+02  2.40602263e+02
  2.40602263e+02  5.02405584e+02  1.86906852e+03  7.99854539e+03
  4.77663925e+04]
E1 = -182.58948428935207  E_coul = 54.04788434155655
Extra cycle  E= -128.541599947796  delta_E= -2.79e-12  |g|= 2.46e-06  |ddm|= 2.16e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [4.93010075e-01 2.44137942e+04 3.66145157e+03 8.33319282e+02
 2.35442165e+02 7.61405832e+01 1.00301761e+01 2.69073505e+01
 2.01753863e-01 1.22835408e+00 2.82153160e+00 7.11392829e+00
 2.31709909e+01 9.97863682e+01 2.66327339e-01 2.44200225e+00
 8.33181710e-01]
E = -128.54159994779553
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.493010074532       1
[INPUT] 0    0    [1    /1   ]  24413.7941866        1
[INPUT] 0    0    [1    /1   ]  3661.45157109        1
[INPUT] 0    0    [1    /1   ]  833.319281634        1
[INPUT] 0    0    [1    /1   ]  235.442165208        1
[INPUT] 0    0    [1    /1   ]  76.1405831903        1
[INPUT] 0    0    [1    /1   ]  10.030176103         1
[INPUT] 0    0    [1    /1   ]  26.9073504662        1
[INPUT] 0    0    [1    /1   ]  0.201753863299       1
[INPUT] 0    0    [1    /1   ]  1.22835408012        1
[INPUT] 0    0    [1    /1   ]  2.82153160323        1
[INPUT] 1    0    [1    /1   ]  7.11392828955        1
[INPUT] 1    0    [1    /1   ]  23.1709908532        1
[INPUT] 1    0    [1    /1   ]  99.7863682373        1
[INPUT] 1    0    [1    /1   ]  0.266327339307       1
[INPUT] 1    0    [1    /1   ]  2.44200224576        1
[INPUT] 1    0    [1    /1   ]  0.833181710454       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.49301007453184953, 1.0]], [0, [24413.794186553685, 1.0]], [0, [3661.451571093562, 1.0]], [0, [833.319281633967, 1.0]], [0, [235.44216520783735, 1.0]], [0, [76.14058319028368, 1.0]], [0, [10.030176102977242, 1.0]], [0, [26.90735046619733, 1.0]], [0, [0.20175386329871384, 1.0]], [0, [1.228354080119166, 1.0]], [0, [2.8215316032329296, 1.0]], [1, [7.113928289548197, 1.0]], [1, [23.170990853210316, 1.0]], [1, [99.78636823733981, 1.0]], [1, [0.2663273393069556, 1.0]], [1, [2.4420022457576893, 1.0]], [1, [0.8331817104535583, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.49301007]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157109]
bas 3, expnt(s) = [833.31928163]
bas 4, expnt(s) = [235.44216521]
bas 5, expnt(s) = [76.14058319]
bas 6, expnt(s) = [10.0301761]
bas 7, expnt(s) = [26.90735047]
bas 8, expnt(s) = [0.20175386]
bas 9, expnt(s) = [1.22835408]
bas 10, expnt(s) = [2.8215316]
bas 11, expnt(s) = [7.11392829]
bas 12, expnt(s) = [23.17099085]
bas 13, expnt(s) = [99.78636824]
bas 14, expnt(s) = [0.26632734]
bas 15, expnt(s) = [2.44200225]
bas 16, expnt(s) = [0.83318171]
CPU time:        40.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 4.93010075e-01 1.48647247e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319282e+02 3.91853380e+02
 2.35442165e+02 1.51854689e+02 7.61405832e+01 6.51219165e+01
 1.00301761e+01 1.42395558e+01 2.69073505e+01 2.98482055e+01
 2.01753863e-01 7.60556389e-01 1.22835408e+00 2.94786577e+00
 2.82153160e+00 5.50020294e+00 7.11392829e+00 3.38938768e+01
 2.31709909e+01 1.48308195e+02 9.97863682e+01 9.20075388e+02
 2.66327339e-01 5.58154050e-01 2.44200225e+00 8.90567755e+00
 8.33181710e-01 2.32225043e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999627347407515
cond(S) = 626.5352725391784
E1 = -183.5897304492014  E_coul = 55.08011554011241
init E= -128.509614909089
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775409523383852  LUMO = 0.439889805727281
  mo_energy =
[-3.25550763e+01 -1.85273074e+00 -7.75409523e-01 -7.75409523e-01
 -7.75409523e-01  4.39889806e-01  8.24460248e-01  8.24460248e-01
  8.24460248e-01  2.43830499e+00  3.95579898e+00  3.95579898e+00
  3.95579898e+00  8.98051087e+00  1.43577421e+01  1.43577421e+01
  1.43577421e+01  3.62248448e+01  5.30067864e+01  5.30067864e+01
  5.30067864e+01  1.39684764e+02  2.40835458e+02  2.40835458e+02
  2.40835458e+02  5.02650880e+02  1.86934478e+03  7.99884836e+03
  4.77667135e+04]
E1 = -182.0860683883621  E_coul = 53.54797605958567
cycle= 1 E= -128.538092328776  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520036
diis-c [-0.27043766  1.        ]
  HOMO = -0.88430274961075  LUMO = 0.424659573006676
  mo_energy =
[-3.28782249e+01 -1.96658101e+00 -8.84302750e-01 -8.84302750e-01
 -8.84302750e-01  4.24659573e-01  7.97704354e-01  7.97704354e-01
  7.97704354e-01  2.38520726e+00  3.85837436e+00  3.85837436e+00
  3.85837436e+00  8.84933621e+00  1.41670220e+01  1.41670220e+01
  1.41670220e+01  3.59797646e+01  5.27258564e+01  5.27258564e+01
  5.27258564e+01  1.39367469e+02  2.40489195e+02  2.40489195e+02
  2.40489195e+02  5.02289439e+02  1.86894725e+03  7.99842178e+03
  4.77662681e+04]
E1 = -182.84752625781485  E_coul = 54.306846221593545
cycle= 2 E= -128.540680036221  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0643
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264302
diis-c [-6.48207846e-04  3.36201422e-01  6.63798578e-01]
  HOMO = -0.848678795525531  LUMO = 0.429540914027022
  mo_energy =
[-3.27701410e+01 -1.92907003e+00 -8.48678796e-01 -8.48678796e-01
 -8.48678796e-01  4.29540914e-01  8.06434315e-01  8.06434315e-01
  8.06434315e-01  2.40230769e+00  3.88998453e+00  3.88998453e+00
  3.88998453e+00  8.89232421e+00  1.42302077e+01  1.42302077e+01
  1.42302077e+01  3.60618527e+01  5.28198647e+01  5.28198647e+01
  5.28198647e+01  1.39473346e+02  2.40602849e+02  2.40602849e+02
  2.40602849e+02  5.02406231e+02  1.86906931e+03  7.99854628e+03
  4.77663935e+04]
E1 = -182.58895594910612  E_coul = 54.047356029393484
cycle= 3 E= -128.541599919713  delta_E= -0.00092  |g|= 0.000502  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112758
diis-c [-2.73118989e-07 -2.48384319e-03 -1.10833178e-03  1.00359217e+00]
  HOMO = -0.848932971869608  LUMO = 0.429512913342342
  mo_energy =
[-3.27705886e+01 -1.92925644e+00 -8.48932972e-01 -8.48932972e-01
 -8.48932972e-01  4.29512913e-01  8.06394964e-01  8.06394964e-01
  8.06394964e-01  2.40221620e+00  3.88981068e+00  3.88981068e+00
  3.88981068e+00  8.89210999e+00  1.42299090e+01  1.42299090e+01
  1.42299090e+01  3.60615076e+01  5.28194693e+01  5.28194693e+01
  5.28194693e+01  1.39472896e+02  2.40602330e+02  2.40602330e+02
  2.40602330e+02  5.02405655e+02  1.86906860e+03  7.99854547e+03
  4.77663926e+04]
E1 = -182.58937927813233  E_coul = 54.04777933111419
cycle= 4 E= -128.541599947018  delta_E= -2.73e-08  |g|= 7.86e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181782
diis-c [-1.16814707e-09  2.58372497e-04  4.80568290e-04 -1.96277542e-01
  1.19553860e+00]
  HOMO = -0.848975331574015  LUMO = 0.429505709440322
  mo_energy =
[-3.27706582e+01 -1.92928710e+00 -8.48975332e-01 -8.48975332e-01
 -8.48975332e-01  4.29505709e-01  8.06381509e-01  8.06381509e-01
  8.06381509e-01  2.40219507e+00  3.88977141e+00  3.88977141e+00
  3.88977141e+00  8.89206613e+00  1.42298514e+01  1.42298514e+01
  1.42298514e+01  3.60614456e+01  5.28194032e+01  5.28194032e+01
  5.28194032e+01  1.39472826e+02  2.40602256e+02  2.40602256e+02
  2.40602256e+02  5.02405577e+02  1.86906851e+03  7.99854538e+03
  4.77663925e+04]
E1 = -182.58950188600903  E_coul = 54.0479019382163
cycle= 5 E= -128.541599947793  delta_E= -7.75e-10  |g|= 6.35e-06  |ddm|= 5.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58950188600903  E_coul = 54.0479019382163
  HOMO = -0.848971891186519  LUMO = 0.429506515646809
  mo_energy =
[-3.27706505e+01 -1.92928287e+00 -8.48971891e-01 -8.48971891e-01
 -8.48971891e-01  4.29506516e-01  8.06382512e-01  8.06382512e-01
  8.06382512e-01  2.40219728e+00  3.88977470e+00  3.88977470e+00
  3.88977470e+00  8.89207059e+00  1.42298570e+01  1.42298570e+01
  1.42298570e+01  3.60614524e+01  5.28194104e+01  5.28194104e+01
  5.28194104e+01  1.39472834e+02  2.40602263e+02  2.40602263e+02
  2.40602263e+02  5.02405584e+02  1.86906852e+03  7.99854539e+03
  4.77663925e+04]
E1 = -182.58948428935207  E_coul = 54.04788434155655
Extra cycle  E= -128.541599947796  delta_E= -2.79e-12  |g|= 2.46e-06  |ddm|= 2.16e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 626.5352725391784
E1 = -182.58948428935207  E_coul = 54.04788434155655
init E= -128.541599947796
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848973133317411  LUMO = 0.429506398203465
  mo_energy =
[-3.27706544e+01 -1.92928404e+00 -8.48973133e-01 -8.48973133e-01
 -8.48973133e-01  4.29506398e-01  8.06382226e-01  8.06382226e-01
  8.06382226e-01  2.40219677e+00  3.88977362e+00  3.88977362e+00
  3.88977362e+00  8.89206916e+00  1.42298548e+01  1.42298548e+01
  1.42298548e+01  3.60614495e+01  5.28194071e+01  5.28194071e+01
  5.28194071e+01  1.39472830e+02  2.40602259e+02  2.40602259e+02
  2.40602259e+02  5.02405580e+02  1.86906851e+03  7.99854538e+03
  4.77663925e+04]
E1 = -182.5894940207836  E_coul = 54.047894072987766
cycle= 1 E= -128.541599947796  delta_E= -3.13e-13  |g|= 1.33e-06  |ddm|= 8.78e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5894940207836  E_coul = 54.047894072987766
  HOMO = -0.848972447699247  LUMO = 0.429506502382777
  mo_energy =
[-3.27706523e+01 -1.92928329e+00 -8.48972448e-01 -8.48972448e-01
 -8.48972448e-01  4.29506502e-01  8.06382398e-01  8.06382398e-01
  8.06382398e-01  2.40219712e+00  3.88977424e+00  3.88977424e+00
  3.88977424e+00  8.89207000e+00  1.42298560e+01  1.42298560e+01
  1.42298560e+01  3.60614511e+01  5.28194089e+01  5.28194089e+01
  5.28194089e+01  1.39472832e+02  2.40602261e+02  2.40602261e+02
  2.40602261e+02  5.02405582e+02  1.86906852e+03  7.99854538e+03
  4.77663925e+04]
E1 = -182.58948912287295  E_coul = 54.047889175076946
Extra cycle  E= -128.541599947796  delta_E= -1.42e-13  |g|= 6.65e-07  |ddm|= 4.26e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.41 sec
exp = [4.93010075e-01 2.44137942e+04 3.66145157e+03 8.33319282e+02
 2.35442165e+02 7.61405832e+01 1.00301761e+01 2.69073505e+01
 2.01753863e-01 1.22835408e+00 2.82153160e+00 7.11392829e+00
 2.31709909e+01 9.97863682e+01 2.66327339e-01 2.44200225e+00
 8.33181710e-01]
grad_E = [-4.42429326e-04  2.26209423e-10 -1.08291048e-08  1.60809594e-07
 -1.34281509e-06  1.48274504e-05 -8.56176885e-05 -3.44610197e-05
 -4.09290688e-05 -2.42108576e-04 -1.52416727e-04 -8.75564201e-05
  7.61869671e-06 -2.24161728e-07  2.50254258e-03  5.09509353e-04
 -1.57661566e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.501401084654       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157141        1
[INPUT] 0    0    [1    /1   ]  833.319276676        1
[INPUT] 0    0    [1    /1   ]  235.442209885        1
[INPUT] 0    0    [1    /1   ]  76.1401268286        1
[INPUT] 0    0    [1    /1   ]  10.0314044571        1
[INPUT] 0    0    [1    /1   ]  26.9086116729        1
[INPUT] 0    0    [1    /1   ]  0.208735791159       1
[INPUT] 0    0    [1    /1   ]  1.23764689734        1
[INPUT] 0    0    [1    /1   ]  2.82523851451        1
[INPUT] 1    0    [1    /1   ]  7.11393991449        1
[INPUT] 1    0    [1    /1   ]  23.170987769         1
[INPUT] 1    0    [1    /1   ]  99.7863676822        1
[INPUT] 1    0    [1    /1   ]  0.266347176276       1
[INPUT] 1    0    [1    /1   ]  2.44201210828        1
[INPUT] 1    0    [1    /1   ]  0.832174084614       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5014010846539838, 1.0]], [0, [24413.794186547133, 1.0]], [0, [3661.4515714111853, 1.0]], [0, [833.3192766756796, 1.0]], [0, [235.4422098854386, 1.0]], [0, [76.14012682855976, 1.0]], [0, [10.03140445706302, 1.0]], [0, [26.90861167286232, 1.0]], [0, [0.20873579115867727, 1.0]], [0, [1.237646897337911, 1.0]], [0, [2.825238514513679, 1.0]], [1, [7.113939914488718, 1.0]], [1, [23.170987769033438, 1.0]], [1, [99.78636768215996, 1.0]], [1, [0.26634717627565846, 1.0]], [1, [2.4420121082821047, 1.0]], [1, [0.8321740846140757, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50140108]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157141]
bas 3, expnt(s) = [833.31927668]
bas 4, expnt(s) = [235.44220989]
bas 5, expnt(s) = [76.14012683]
bas 6, expnt(s) = [10.03140446]
bas 7, expnt(s) = [26.90861167]
bas 8, expnt(s) = [0.20873579]
bas 9, expnt(s) = [1.2376469]
bas 10, expnt(s) = [2.82523851]
bas 11, expnt(s) = [7.11393991]
bas 12, expnt(s) = [23.17098777]
bas 13, expnt(s) = [99.78636768]
bas 14, expnt(s) = [0.26634718]
bas 15, expnt(s) = [2.44201211]
bas 16, expnt(s) = [0.83217408]
CPU time:        43.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.01401085e-01 1.50540716e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319277e+02 3.91853378e+02
 2.35442210e+02 1.51854711e+02 7.61401268e+01 6.51216238e+01
 1.00314045e+01 1.42408637e+01 2.69086117e+01 2.98492548e+01
 2.08735791e-01 7.80212162e-01 1.23764690e+00 2.96457603e+00
 2.82523851e+00 5.50562165e+00 7.11393991e+00 3.38939460e+01
 2.31709878e+01 1.48308170e+02 9.97863677e+01 9.20075381e+02
 2.66347176e-01 5.58206017e-01 2.44201211e+00 8.90572251e+00
 8.32174085e-01 2.31874039e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629273261625
cond(S) = 655.3000321257126
E1 = -183.58975308674601  E_coul = 55.08011195160909
init E= -128.509641135137
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.775409561764652  LUMO = 0.455365670967575
  mo_energy =
[-3.25550795e+01 -1.85273190e+00 -7.75409562e-01 -7.75409562e-01
 -7.75409562e-01  4.55365671e-01  8.24184262e-01  8.24184262e-01
  8.24184262e-01  2.49361423e+00  3.95331303e+00  3.95331303e+00
  3.95331303e+00  9.08005515e+00  1.43542573e+01  1.43542573e+01
  1.43542573e+01  3.63469299e+01  5.30037849e+01  5.30037849e+01
  5.30037849e+01  1.39801906e+02  2.40833384e+02  2.40833384e+02
  2.40833384e+02  5.02757336e+02  1.86944004e+03  7.99893211e+03
  4.77667828e+04]
E1 = -182.08649839318443  E_coul = 53.54840090792709
cycle= 1 E= -128.538097485257  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.520101
diis-c [-0.27050458  1.        ]
  HOMO = -0.884265373056975  LUMO = 0.439614832677476
  mo_energy =
[-3.28781674e+01 -1.96654003e+00 -8.84265373e-01 -8.84265373e-01
 -8.84265373e-01  4.39614833e-01  7.97471629e-01  7.97471629e-01
  7.97471629e-01  2.43996818e+00  3.85596612e+00  3.85596612e+00
  3.85596612e+00  8.94870263e+00  1.41635810e+01  1.41635810e+01
  1.41635810e+01  3.61019612e+01  5.27229110e+01  5.27229110e+01
  5.27229110e+01  1.39484700e+02  2.40487174e+02  2.40487174e+02
  2.40487174e+02  5.02395959e+02  1.86904257e+03  7.99850558e+03
  4.77663374e+04]
E1 = -182.84785206975243  E_coul = 54.30716731901992
cycle= 2 E= -128.540684750733  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264309
diis-c [-6.48117597e-04  3.36179908e-01  6.63820092e-01]
  HOMO = -0.848644934191856  LUMO = 0.444669503230397
  mo_energy =
[-3.27700957e+01 -1.92903277e+00 -8.48644934e-01 -8.48644934e-01
 -8.48644934e-01  4.44669503e-01  8.06193429e-01  8.06193429e-01
  8.06193429e-01  2.45725563e+00  3.88756203e+00  3.88756203e+00
  3.88756203e+00  8.99175931e+00  1.42267622e+01  1.42267622e+01
  1.42267622e+01  3.61840210e+01  5.28169100e+01  5.28169100e+01
  5.28169100e+01  1.39590555e+02  2.40600816e+02  2.40600816e+02
  2.40600816e+02  5.02512735e+02  1.86916462e+03  7.99863007e+03
  4.77664628e+04]
E1 = -182.5893707377799  E_coul = 54.04776653276744
cycle= 3 E= -128.541604205012  delta_E= -0.000919  |g|= 0.000497  |ddm|= 0.022
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0011218
diis-c [-2.69553286e-07 -2.46240984e-03 -1.08446874e-03  1.00354688e+00]
  HOMO = -0.848896047478117  LUMO = 0.444641977194084
  mo_energy =
[-3.27705394e+01 -1.92921546e+00 -8.48896047e-01 -8.48896047e-01
 -8.48896047e-01  4.44641977e-01  8.06155490e-01  8.06155490e-01
  8.06155490e-01  2.45716556e+00  3.88739154e+00  3.88739154e+00
  3.88739154e+00  8.99154827e+00  1.42264674e+01  1.42264674e+01
  1.42264674e+01  3.61836798e+01  5.28165186e+01  5.28165186e+01
  5.28165186e+01  1.39590109e+02  2.40600300e+02  2.40600300e+02
  2.40600300e+02  5.02512163e+02  1.86916391e+03  7.99862926e+03
  4.77664620e+04]
E1 = -182.58979415116485  E_coul = 54.04818991933839
cycle= 4 E= -128.541604231826  delta_E= -2.68e-08  |g|= 7.81e-05  |ddm|= 0.000286
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000181485
diis-c [-1.18224651e-09  2.60637788e-04  4.82409922e-04 -1.97695612e-01
  1.19695256e+00]
  HOMO = -0.84893800460866  LUMO = 0.444634759390025
  mo_energy =
[-3.27706087e+01 -1.92924552e+00 -8.48938005e-01 -8.48938005e-01
 -8.48938005e-01  4.44634759e-01  8.06142232e-01  8.06142232e-01
  8.06142232e-01  2.45714462e+00  3.88735273e+00  3.88735273e+00
  3.88735273e+00  8.99150488e+00  1.42264104e+01  1.42264104e+01
  1.42264104e+01  3.61836184e+01  5.28164529e+01  5.28164529e+01
  5.28164529e+01  1.39590039e+02  2.40600227e+02  2.40600227e+02
  2.40600227e+02  5.02512085e+02  1.86916382e+03  7.99862917e+03
  4.77664619e+04]
E1 = -182.58991703218865  E_coul = 54.048312799590626
cycle= 5 E= -128.541604232598  delta_E= -7.72e-10  |g|= 6.4e-06  |ddm|= 5.34e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58991703218865  E_coul = 54.048312799590626
  HOMO = -0.848934535747153  LUMO = 0.444635595468868
  mo_energy =
[-3.27706009e+01 -1.92924126e+00 -8.48934536e-01 -8.48934536e-01
 -8.48934536e-01  4.44635595e-01  8.06143242e-01  8.06143242e-01
  8.06143242e-01  2.45714687e+00  3.88735604e+00  3.88735604e+00
  3.88735604e+00  8.99150938e+00  1.42264161e+01  1.42264161e+01
  1.42264161e+01  3.61836252e+01  5.28164602e+01  5.28164602e+01
  5.28164602e+01  1.39590047e+02  2.40600234e+02  2.40600234e+02
  2.40600234e+02  5.02512092e+02  1.86916383e+03  7.99862917e+03
  4.77664619e+04]
E1 = -182.5898992927801  E_coul = 54.048295060179065
Extra cycle  E= -128.541604232601  delta_E= -3.01e-12  |g|= 2.48e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.16 sec, wall time      0.17 sec
exp = [5.01401085e-01 2.44137942e+04 3.66145157e+03 8.33319277e+02
 2.35442210e+02 7.61401268e+01 1.00314045e+01 2.69086117e+01
 2.08735791e-01 1.23764690e+00 2.82523851e+00 7.11393991e+00
 2.31709878e+01 9.97863677e+01 2.66347176e-01 2.44201211e+00
 8.32174085e-01]
E = -128.54160423260103
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.501401084654       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157141        1
[INPUT] 0    0    [1    /1   ]  833.319276676        1
[INPUT] 0    0    [1    /1   ]  235.442209885        1
[INPUT] 0    0    [1    /1   ]  76.1401268286        1
[INPUT] 0    0    [1    /1   ]  10.0314044571        1
[INPUT] 0    0    [1    /1   ]  26.9086116729        1
[INPUT] 0    0    [1    /1   ]  0.208735791159       1
[INPUT] 0    0    [1    /1   ]  1.23764689734        1
[INPUT] 0    0    [1    /1   ]  2.82523851451        1
[INPUT] 1    0    [1    /1   ]  7.11393991449        1
[INPUT] 1    0    [1    /1   ]  23.170987769         1
[INPUT] 1    0    [1    /1   ]  99.7863676822        1
[INPUT] 1    0    [1    /1   ]  0.266347176276       1
[INPUT] 1    0    [1    /1   ]  2.44201210828        1
[INPUT] 1    0    [1    /1   ]  0.832174084614       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5014010846539838, 1.0]], [0, [24413.794186547133, 1.0]], [0, [3661.4515714111853, 1.0]], [0, [833.3192766756796, 1.0]], [0, [235.4422098854386, 1.0]], [0, [76.14012682855976, 1.0]], [0, [10.03140445706302, 1.0]], [0, [26.90861167286232, 1.0]], [0, [0.20873579115867727, 1.0]], [0, [1.237646897337911, 1.0]], [0, [2.825238514513679, 1.0]], [1, [7.113939914488718, 1.0]], [1, [23.170987769033438, 1.0]], [1, [99.78636768215996, 1.0]], [1, [0.26634717627565846, 1.0]], [1, [2.4420121082821047, 1.0]], [1, [0.8321740846140757, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.50140108]
bas 1, expnt(s) = [24413.79418655]
bas 2, expnt(s) = [3661.45157141]
bas 3, expnt(s) = [833.31927668]
bas 4, expnt(s) = [235.44220989]
bas 5, expnt(s) = [76.14012683]
bas 6, expnt(s) = [10.03140446]
bas 7, expnt(s) = [26.90861167]
bas 8, expnt(s) = [0.20873579]
bas 9, expnt(s) = [1.2376469]
bas 10, expnt(s) = [2.82523851]
bas 11, expnt(s) = [7.11393991]
bas 12, expnt(s) = [23.17098777]
bas 13, expnt(s) = [99.78636768]
bas 14, expnt(s) = [0.26634718]
bas 15, expnt(s) = [2.44201211]
bas 16, expnt(s) = [0.83217408]
CPU time:        44.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.01401085e-01 1.50540716e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319277e+02 3.91853378e+02
 2.35442210e+02 1.51854711e+02 7.61401268e+01 6.51216238e+01
 1.00314045e+01 1.42408637e+01 2.69086117e+01 2.98492548e+01
 2.08735791e-01 7.80212162e-01 1.23764690e+00 2.96457603e+00
 2.82523851e+00 5.50562165e+00 7.11393991e+00 3.38939460e+01
 2.31709878e+01 1.48308170e+02 9.97863677e+01 9.20075381e+02
 2.66347176e-01 5.58206017e-01 2.44201211e+00 8.90572251e+00
 8.32174085e-01 2.31874039e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629273261625
cond(S) = 655.3000321257126
E1 = -183.58975308674601  E_coul = 55.08011195160909
init E= -128.509641135137
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775409561764652  LUMO = 0.455365670967575
  mo_energy =
[-3.25550795e+01 -1.85273190e+00 -7.75409562e-01 -7.75409562e-01
 -7.75409562e-01  4.55365671e-01  8.24184262e-01  8.24184262e-01
  8.24184262e-01  2.49361423e+00  3.95331303e+00  3.95331303e+00
  3.95331303e+00  9.08005515e+00  1.43542573e+01  1.43542573e+01
  1.43542573e+01  3.63469299e+01  5.30037849e+01  5.30037849e+01
  5.30037849e+01  1.39801906e+02  2.40833384e+02  2.40833384e+02
  2.40833384e+02  5.02757336e+02  1.86944004e+03  7.99893211e+03
  4.77667828e+04]
E1 = -182.08649839318443  E_coul = 53.54840090792709
cycle= 1 E= -128.538097485257  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520101
diis-c [-0.27050458  1.        ]
  HOMO = -0.884265373056975  LUMO = 0.439614832677476
  mo_energy =
[-3.28781674e+01 -1.96654003e+00 -8.84265373e-01 -8.84265373e-01
 -8.84265373e-01  4.39614833e-01  7.97471629e-01  7.97471629e-01
  7.97471629e-01  2.43996818e+00  3.85596612e+00  3.85596612e+00
  3.85596612e+00  8.94870263e+00  1.41635810e+01  1.41635810e+01
  1.41635810e+01  3.61019612e+01  5.27229110e+01  5.27229110e+01
  5.27229110e+01  1.39484700e+02  2.40487174e+02  2.40487174e+02
  2.40487174e+02  5.02395959e+02  1.86904257e+03  7.99850558e+03
  4.77663374e+04]
E1 = -182.84785206975243  E_coul = 54.30716731901992
cycle= 2 E= -128.540684750733  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264309
diis-c [-6.48117597e-04  3.36179908e-01  6.63820092e-01]
  HOMO = -0.848644934191856  LUMO = 0.444669503230397
  mo_energy =
[-3.27700957e+01 -1.92903277e+00 -8.48644934e-01 -8.48644934e-01
 -8.48644934e-01  4.44669503e-01  8.06193429e-01  8.06193429e-01
  8.06193429e-01  2.45725563e+00  3.88756203e+00  3.88756203e+00
  3.88756203e+00  8.99175931e+00  1.42267622e+01  1.42267622e+01
  1.42267622e+01  3.61840210e+01  5.28169100e+01  5.28169100e+01
  5.28169100e+01  1.39590555e+02  2.40600816e+02  2.40600816e+02
  2.40600816e+02  5.02512735e+02  1.86916462e+03  7.99863007e+03
  4.77664628e+04]
E1 = -182.5893707377799  E_coul = 54.04776653276744
cycle= 3 E= -128.541604205012  delta_E= -0.000919  |g|= 0.000497  |ddm|= 0.022
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011218
diis-c [-2.69553286e-07 -2.46240984e-03 -1.08446874e-03  1.00354688e+00]
  HOMO = -0.848896047478117  LUMO = 0.444641977194084
  mo_energy =
[-3.27705394e+01 -1.92921546e+00 -8.48896047e-01 -8.48896047e-01
 -8.48896047e-01  4.44641977e-01  8.06155490e-01  8.06155490e-01
  8.06155490e-01  2.45716556e+00  3.88739154e+00  3.88739154e+00
  3.88739154e+00  8.99154827e+00  1.42264674e+01  1.42264674e+01
  1.42264674e+01  3.61836798e+01  5.28165186e+01  5.28165186e+01
  5.28165186e+01  1.39590109e+02  2.40600300e+02  2.40600300e+02
  2.40600300e+02  5.02512163e+02  1.86916391e+03  7.99862926e+03
  4.77664620e+04]
E1 = -182.58979415116485  E_coul = 54.04818991933839
cycle= 4 E= -128.541604231826  delta_E= -2.68e-08  |g|= 7.81e-05  |ddm|= 0.000286
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000181485
diis-c [-1.18224651e-09  2.60637788e-04  4.82409922e-04 -1.97695612e-01
  1.19695256e+00]
  HOMO = -0.84893800460866  LUMO = 0.444634759390025
  mo_energy =
[-3.27706087e+01 -1.92924552e+00 -8.48938005e-01 -8.48938005e-01
 -8.48938005e-01  4.44634759e-01  8.06142232e-01  8.06142232e-01
  8.06142232e-01  2.45714462e+00  3.88735273e+00  3.88735273e+00
  3.88735273e+00  8.99150488e+00  1.42264104e+01  1.42264104e+01
  1.42264104e+01  3.61836184e+01  5.28164529e+01  5.28164529e+01
  5.28164529e+01  1.39590039e+02  2.40600227e+02  2.40600227e+02
  2.40600227e+02  5.02512085e+02  1.86916382e+03  7.99862917e+03
  4.77664619e+04]
E1 = -182.58991703218865  E_coul = 54.048312799590626
cycle= 5 E= -128.541604232598  delta_E= -7.72e-10  |g|= 6.4e-06  |ddm|= 5.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58991703218865  E_coul = 54.048312799590626
  HOMO = -0.848934535747153  LUMO = 0.444635595468868
  mo_energy =
[-3.27706009e+01 -1.92924126e+00 -8.48934536e-01 -8.48934536e-01
 -8.48934536e-01  4.44635595e-01  8.06143242e-01  8.06143242e-01
  8.06143242e-01  2.45714687e+00  3.88735604e+00  3.88735604e+00
  3.88735604e+00  8.99150938e+00  1.42264161e+01  1.42264161e+01
  1.42264161e+01  3.61836252e+01  5.28164602e+01  5.28164602e+01
  5.28164602e+01  1.39590047e+02  2.40600234e+02  2.40600234e+02
  2.40600234e+02  5.02512092e+02  1.86916383e+03  7.99862917e+03
  4.77664619e+04]
E1 = -182.5898992927801  E_coul = 54.048295060179065
Extra cycle  E= -128.541604232601  delta_E= -3.01e-12  |g|= 2.48e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 655.3000321257126
E1 = -182.5898992927801  E_coul = 54.048295060179065
init E= -128.541604232601
    CPU time for initialize scf      0.38 sec, wall time      0.39 sec
  HOMO = -0.848935787628943  LUMO = 0.44463547209677
  mo_energy =
[-3.27706048e+01 -1.92924244e+00 -8.48935788e-01 -8.48935788e-01
 -8.48935788e-01  4.44635472e-01  8.06142954e-01  8.06142954e-01
  8.06142954e-01  2.45714635e+00  3.88735496e+00  3.88735496e+00
  3.88735496e+00  8.99150793e+00  1.42264138e+01  1.42264138e+01
  1.42264138e+01  3.61836223e+01  5.28164569e+01  5.28164569e+01
  5.28164569e+01  1.39590043e+02  2.40600230e+02  2.40600230e+02
  2.40600230e+02  5.02512088e+02  1.86916382e+03  7.99862917e+03
  4.77664619e+04]
E1 = -182.58990910132854  E_coul = 54.04830486872742
cycle= 1 E= -128.541604232601  delta_E= -8.53e-14  |g|= 1.34e-06  |ddm|= 8.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58990910132854  E_coul = 54.04830486872742
  HOMO = -0.848935096519845  LUMO = 0.444635580667993
  mo_energy =
[-3.27706027e+01 -1.92924168e+00 -8.48935097e-01 -8.48935097e-01
 -8.48935097e-01  4.44635581e-01  8.06143127e-01  8.06143127e-01
  8.06143127e-01  2.45714670e+00  3.88735558e+00  3.88735558e+00
  3.88735558e+00  8.99150878e+00  1.42264151e+01  1.42264151e+01
  1.42264151e+01  3.61836239e+01  5.28164587e+01  5.28164587e+01
  5.28164587e+01  1.39590045e+02  2.40600232e+02  2.40600232e+02
  2.40600232e+02  5.02512090e+02  1.86916383e+03  7.99862917e+03
  4.77664619e+04]
E1 = -182.58990416536028  E_coul = 54.04829993275948
Extra cycle  E= -128.541604232601  delta_E= 3.13e-13  |g|= 6.7e-07  |ddm|= 4.28e-07
    CPU time for scf_cycle      0.45 sec, wall time      0.47 sec
exp = [5.01401085e-01 2.44137942e+04 3.66145157e+03 8.33319277e+02
 2.35442210e+02 7.61401268e+01 1.00314045e+01 2.69086117e+01
 2.08735791e-01 1.23764690e+00 2.82523851e+00 7.11393991e+00
 2.31709878e+01 9.97863677e+01 2.66347176e-01 2.44201211e+00
 8.32174085e-01]
grad_E = [-4.19712581e-04  2.08560028e-10 -9.90392009e-09  1.42308266e-07
 -1.12525446e-06  1.31629729e-05 -1.09589279e-04 -2.61213284e-05
  8.88228945e-06 -2.28180505e-04 -1.50636601e-04 -1.64350371e-04
  1.41464894e-05 -4.36983834e-07  4.40288044e-03  9.65021889e-04
 -2.95036208e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.522389989998       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.4515722         1
[INPUT] 0    0    [1    /1   ]  833.319264536        1
[INPUT] 0    0    [1    /1   ]  235.442317008        1
[INPUT] 0    0    [1    /1   ]  76.13900688          1
[INPUT] 0    0    [1    /1   ]  10.0350934414        1
[INPUT] 0    0    [1    /1   ]  26.9116028476        1
[INPUT] 0    0    [1    /1   ]  0.223627791834       1
[INPUT] 0    0    [1    /1   ]  1.26257795216        1
[INPUT] 0    0    [1    /1   ]  2.83402949365        1
[INPUT] 1    0    [1    /1   ]  7.11404675495        1
[INPUT] 1    0    [1    /1   ]  23.1709732493        1
[INPUT] 1    0    [1    /1   ]  99.7863664409        1
[INPUT] 1    0    [1    /1   ]  0.26618453274        1
[INPUT] 1    0    [1    /1   ]  2.44160248916        1
[INPUT] 1    0    [1    /1   ]  0.830551830369       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5223899899975789, 1.0]], [0, [24413.794186530795, 1.0]], [0, [3661.451572200433, 1.0]], [0, [833.3192645361445, 1.0]], [0, [235.44231700777564, 1.0]], [0, [76.13900687999275, 1.0]], [0, [10.035093441431982, 1.0]], [0, [26.911602847559003, 1.0]], [0, [0.22362779183390274, 1.0]], [0, [1.2625779521648386, 1.0]], [0, [2.834029493654146, 1.0]], [1, [7.114046754949338, 1.0]], [1, [23.170973249251812, 1.0]], [1, [99.78636644085046, 1.0]], [1, [0.2661845327396884, 1.0]], [1, [2.441602489164176, 1.0]], [1, [0.8305518303687994, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.52238999]
bas 1, expnt(s) = [24413.79418653]
bas 2, expnt(s) = [3661.4515722]
bas 3, expnt(s) = [833.31926454]
bas 4, expnt(s) = [235.44231701]
bas 5, expnt(s) = [76.13900688]
bas 6, expnt(s) = [10.03509344]
bas 7, expnt(s) = [26.91160285]
bas 8, expnt(s) = [0.22362779]
bas 9, expnt(s) = [1.26257795]
bas 10, expnt(s) = [2.83402949]
bas 11, expnt(s) = [7.11404675]
bas 12, expnt(s) = [23.17097325]
bas 13, expnt(s) = [99.78636644]
bas 14, expnt(s) = [0.26618453]
bas 15, expnt(s) = [2.44160249]
bas 16, expnt(s) = [0.83055183]
CPU time:        47.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.22389990e-01 1.55242690e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319265e+02 3.91853374e+02
 2.35442317e+02 1.51854762e+02 7.61390069e+01 6.51209054e+01
 1.00350934e+01 1.42447913e+01 2.69116028e+01 2.98517433e+01
 2.23627792e-01 8.21597967e-01 1.26257795e+00 3.00925281e+00
 2.83402949e+00 5.51846508e+00 7.11404675e+00 3.38945823e+01
 2.31709732e+01 1.48308054e+02 9.97863664e+01 9.20075367e+02
 2.66184533e-01 5.57779968e-01 2.44160249e+00 8.90385526e+00
 8.30551830e-01 2.31309152e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963314917574
cond(S) = 728.0575286792489
E1 = -183.58978323749443  E_coul = 55.08009826547246
init E= -128.509684972022
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775410219143203  LUMO = 0.489793857359759
  mo_energy =
[-3.25550872e+01 -1.85273499e+00 -7.75410219e-01 -7.75410219e-01
 -7.75410219e-01  4.89793857e-01  8.23216923e-01  8.23216923e-01
  8.23216923e-01  2.62230792e+00  3.94832913e+00  3.94832913e+00
  3.94832913e+00  9.32075125e+00  1.43469431e+01  1.43469431e+01
  1.43469431e+01  3.66476171e+01  5.29972503e+01  5.29972503e+01
  5.29972503e+01  1.40092354e+02  2.40828840e+02  2.40828840e+02
  2.40828840e+02  5.03021686e+02  1.86967668e+03  7.99914014e+03
  4.77669550e+04]
E1 = -182.08683844866079  E_coul = 53.548730897314705
cycle= 1 E= -128.538107551346  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520195
diis-c [-0.27060234  1.        ]
  HOMO = -0.884233875128764  LUMO = 0.47284691295242
  mo_energy =
[-3.28781337e+01 -1.96650796e+00 -8.84233875e-01 -8.84233875e-01
 -8.84233875e-01  4.72846913e-01  7.96574765e-01  7.96574765e-01
  7.96574765e-01  2.56727245e+00  3.85108262e+00  3.85108262e+00
  3.85108262e+00  9.18884092e+00  1.41562950e+01  1.41562950e+01
  1.41562950e+01  3.64028122e+01  5.27164135e+01  5.27164135e+01
  5.27164135e+01  1.39775256e+02  2.40482656e+02  2.40482656e+02
  2.40482656e+02  5.02660360e+02  1.86927924e+03  7.99871364e+03
  4.77665096e+04]
E1 = -182.84816885390356  E_coul = 54.307474142138815
cycle= 2 E= -128.540694711765  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0639
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264323
diis-c [-6.48319317e-04  3.36151485e-01  6.63848515e-01]
  HOMO = -0.848612523136722  LUMO = 0.478292867490928
  mo_energy =
[-3.27700628e+01 -1.92899961e+00 -8.48612523e-01 -8.48612523e-01
 -8.48612523e-01  4.78292867e-01  8.05280719e-01  8.05280719e-01
  8.05280719e-01  2.58502188e+00  3.88265933e+00  3.88265933e+00
  3.88265933e+00  9.23209606e+00  1.42194802e+01  1.42194802e+01
  1.42194802e+01  3.64848292e+01  5.28104149e+01  5.28104149e+01
  5.28104149e+01  1.39881087e+02  2.40596297e+02  2.40596297e+02
  2.40596297e+02  5.02777129e+02  1.86940128e+03  7.99883812e+03
  4.77666350e+04]
E1 = -182.58974471469097  E_coul = 54.04813079889075
cycle= 3 E= -128.5416139158  delta_E= -0.000919  |g|= 0.000493  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00111839
diis-c [-2.60701967e-07 -2.42812393e-03 -1.01474678e-03  1.00344287e+00]
  HOMO = -0.848860754208747  LUMO = 0.478264933857784
  mo_energy =
[-3.27705041e+01 -1.92917885e+00 -8.48860754e-01 -8.48860754e-01
 -8.48860754e-01  4.78264934e-01  8.05244309e-01  8.05244309e-01
  8.05244309e-01  2.58493169e+00  3.88249215e+00  3.88249215e+00
  3.88249215e+00  9.23188714e+00  1.42191887e+01  1.42191887e+01
  1.42191887e+01  3.64844910e+01  5.28100262e+01  5.28100262e+01
  5.28100262e+01  1.39880643e+02  2.40595784e+02  2.40595784e+02
  2.40595784e+02  5.02776558e+02  1.86940057e+03  7.99883732e+03
  4.77666342e+04]
E1 = -182.5901725857022  E_coul = 54.04855864360733
cycle= 4 E= -128.541613942095  delta_E= -2.63e-08  |g|= 7.78e-05  |ddm|= 0.000299
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181339
diis-c [-1.19578991e-09  2.62373636e-04  4.82902447e-04 -1.98902618e-01
  1.19815734e+00]
  HOMO = -0.848902317660875  LUMO = 0.478257462008179
  mo_energy =
[-3.27705731e+01 -1.92920834e+00 -8.48902318e-01 -8.48902318e-01
 -8.48902318e-01  4.78257462e-01  8.05231279e-01  8.05231279e-01
  8.05231279e-01  2.58491065e+00  3.88245381e+00  3.88245381e+00
  3.88245381e+00  9.23184406e+00  1.42191321e+01  1.42191321e+01
  1.42191321e+01  3.64844300e+01  5.28099610e+01  5.28099610e+01
  5.28099610e+01  1.39880573e+02  2.40595711e+02  2.40595711e+02
  2.40595711e+02  5.02776481e+02  1.86940049e+03  7.99883722e+03
  4.77666341e+04]
E1 = -182.590296320595  E_coul = 54.048682377733165
cycle= 5 E= -128.541613942862  delta_E= -7.67e-10  |g|= 6.43e-06  |ddm|= 5.6e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.590296320595  E_coul = 54.048682377733165
  HOMO = -0.848898830342197  LUMO = 0.478258357544574
  mo_energy =
[-3.27705652e+01 -1.92920405e+00 -8.48898830e-01 -8.48898830e-01
 -8.48898830e-01  4.78258358e-01  8.05232291e-01  8.05232291e-01
  8.05232291e-01  2.58491295e+00  3.88245714e+00  3.88245714e+00
  3.88245714e+00  9.23184859e+00  1.42191378e+01  1.42191378e+01
  1.42191378e+01  3.64844369e+01  5.28099683e+01  5.28099683e+01
  5.28099683e+01  1.39880581e+02  2.40595718e+02  2.40595718e+02
  2.40595718e+02  5.02776488e+02  1.86940049e+03  7.99883723e+03
  4.77666341e+04]
E1 = -182.5902784705121  E_coul = 54.04866452764763
Extra cycle  E= -128.541613942864  delta_E= -2.61e-12  |g|= 2.5e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [5.22389990e-01 2.44137942e+04 3.66145157e+03 8.33319265e+02
 2.35442317e+02 7.61390069e+01 1.00350934e+01 2.69116028e+01
 2.23627792e-01 1.26257795e+00 2.83402949e+00 7.11404675e+00
 2.31709732e+01 9.97863664e+01 2.66184533e-01 2.44160249e+00
 8.30551830e-01]
E = -128.54161394286444
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.522389989998       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.4515722         1
[INPUT] 0    0    [1    /1   ]  833.319264536        1
[INPUT] 0    0    [1    /1   ]  235.442317008        1
[INPUT] 0    0    [1    /1   ]  76.13900688          1
[INPUT] 0    0    [1    /1   ]  10.0350934414        1
[INPUT] 0    0    [1    /1   ]  26.9116028476        1
[INPUT] 0    0    [1    /1   ]  0.223627791834       1
[INPUT] 0    0    [1    /1   ]  1.26257795216        1
[INPUT] 0    0    [1    /1   ]  2.83402949365        1
[INPUT] 1    0    [1    /1   ]  7.11404675495        1
[INPUT] 1    0    [1    /1   ]  23.1709732493        1
[INPUT] 1    0    [1    /1   ]  99.7863664409        1
[INPUT] 1    0    [1    /1   ]  0.26618453274        1
[INPUT] 1    0    [1    /1   ]  2.44160248916        1
[INPUT] 1    0    [1    /1   ]  0.830551830369       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.5223899899975789, 1.0]], [0, [24413.794186530795, 1.0]], [0, [3661.451572200433, 1.0]], [0, [833.3192645361445, 1.0]], [0, [235.44231700777564, 1.0]], [0, [76.13900687999275, 1.0]], [0, [10.035093441431982, 1.0]], [0, [26.911602847559003, 1.0]], [0, [0.22362779183390274, 1.0]], [0, [1.2625779521648386, 1.0]], [0, [2.834029493654146, 1.0]], [1, [7.114046754949338, 1.0]], [1, [23.170973249251812, 1.0]], [1, [99.78636644085046, 1.0]], [1, [0.2661845327396884, 1.0]], [1, [2.441602489164176, 1.0]], [1, [0.8305518303687994, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.52238999]
bas 1, expnt(s) = [24413.79418653]
bas 2, expnt(s) = [3661.4515722]
bas 3, expnt(s) = [833.31926454]
bas 4, expnt(s) = [235.44231701]
bas 5, expnt(s) = [76.13900688]
bas 6, expnt(s) = [10.03509344]
bas 7, expnt(s) = [26.91160285]
bas 8, expnt(s) = [0.22362779]
bas 9, expnt(s) = [1.26257795]
bas 10, expnt(s) = [2.83402949]
bas 11, expnt(s) = [7.11404675]
bas 12, expnt(s) = [23.17097325]
bas 13, expnt(s) = [99.78636644]
bas 14, expnt(s) = [0.26618453]
bas 15, expnt(s) = [2.44160249]
bas 16, expnt(s) = [0.83055183]
CPU time:        47.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.22389990e-01 1.55242690e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319265e+02 3.91853374e+02
 2.35442317e+02 1.51854762e+02 7.61390069e+01 6.51209054e+01
 1.00350934e+01 1.42447913e+01 2.69116028e+01 2.98517433e+01
 2.23627792e-01 8.21597967e-01 1.26257795e+00 3.00925281e+00
 2.83402949e+00 5.51846508e+00 7.11404675e+00 3.38945823e+01
 2.31709732e+01 1.48308054e+02 9.97863664e+01 9.20075367e+02
 2.66184533e-01 5.57779968e-01 2.44160249e+00 8.90385526e+00
 8.30551830e-01 2.31309152e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963314917574
cond(S) = 728.0575286792489
E1 = -183.58978323749443  E_coul = 55.08009826547246
init E= -128.509684972022
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775410219143203  LUMO = 0.489793857359759
  mo_energy =
[-3.25550872e+01 -1.85273499e+00 -7.75410219e-01 -7.75410219e-01
 -7.75410219e-01  4.89793857e-01  8.23216923e-01  8.23216923e-01
  8.23216923e-01  2.62230792e+00  3.94832913e+00  3.94832913e+00
  3.94832913e+00  9.32075125e+00  1.43469431e+01  1.43469431e+01
  1.43469431e+01  3.66476171e+01  5.29972503e+01  5.29972503e+01
  5.29972503e+01  1.40092354e+02  2.40828840e+02  2.40828840e+02
  2.40828840e+02  5.03021686e+02  1.86967668e+03  7.99914014e+03
  4.77669550e+04]
E1 = -182.08683844866079  E_coul = 53.548730897314705
cycle= 1 E= -128.538107551346  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520195
diis-c [-0.27060234  1.        ]
  HOMO = -0.884233875128764  LUMO = 0.47284691295242
  mo_energy =
[-3.28781337e+01 -1.96650796e+00 -8.84233875e-01 -8.84233875e-01
 -8.84233875e-01  4.72846913e-01  7.96574765e-01  7.96574765e-01
  7.96574765e-01  2.56727245e+00  3.85108262e+00  3.85108262e+00
  3.85108262e+00  9.18884092e+00  1.41562950e+01  1.41562950e+01
  1.41562950e+01  3.64028122e+01  5.27164135e+01  5.27164135e+01
  5.27164135e+01  1.39775256e+02  2.40482656e+02  2.40482656e+02
  2.40482656e+02  5.02660360e+02  1.86927924e+03  7.99871364e+03
  4.77665096e+04]
E1 = -182.84816885390356  E_coul = 54.307474142138815
cycle= 2 E= -128.540694711765  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0639
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264323
diis-c [-6.48319317e-04  3.36151485e-01  6.63848515e-01]
  HOMO = -0.848612523136722  LUMO = 0.478292867490928
  mo_energy =
[-3.27700628e+01 -1.92899961e+00 -8.48612523e-01 -8.48612523e-01
 -8.48612523e-01  4.78292867e-01  8.05280719e-01  8.05280719e-01
  8.05280719e-01  2.58502188e+00  3.88265933e+00  3.88265933e+00
  3.88265933e+00  9.23209606e+00  1.42194802e+01  1.42194802e+01
  1.42194802e+01  3.64848292e+01  5.28104149e+01  5.28104149e+01
  5.28104149e+01  1.39881087e+02  2.40596297e+02  2.40596297e+02
  2.40596297e+02  5.02777129e+02  1.86940128e+03  7.99883812e+03
  4.77666350e+04]
E1 = -182.58974471469097  E_coul = 54.04813079889075
cycle= 3 E= -128.5416139158  delta_E= -0.000919  |g|= 0.000493  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00111839
diis-c [-2.60701967e-07 -2.42812393e-03 -1.01474678e-03  1.00344287e+00]
  HOMO = -0.848860754208747  LUMO = 0.478264933857784
  mo_energy =
[-3.27705041e+01 -1.92917885e+00 -8.48860754e-01 -8.48860754e-01
 -8.48860754e-01  4.78264934e-01  8.05244309e-01  8.05244309e-01
  8.05244309e-01  2.58493169e+00  3.88249215e+00  3.88249215e+00
  3.88249215e+00  9.23188714e+00  1.42191887e+01  1.42191887e+01
  1.42191887e+01  3.64844910e+01  5.28100262e+01  5.28100262e+01
  5.28100262e+01  1.39880643e+02  2.40595784e+02  2.40595784e+02
  2.40595784e+02  5.02776558e+02  1.86940057e+03  7.99883732e+03
  4.77666342e+04]
E1 = -182.5901725857022  E_coul = 54.04855864360733
cycle= 4 E= -128.541613942095  delta_E= -2.63e-08  |g|= 7.78e-05  |ddm|= 0.000299
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000181339
diis-c [-1.19578991e-09  2.62373636e-04  4.82902447e-04 -1.98902618e-01
  1.19815734e+00]
  HOMO = -0.848902317660875  LUMO = 0.478257462008179
  mo_energy =
[-3.27705731e+01 -1.92920834e+00 -8.48902318e-01 -8.48902318e-01
 -8.48902318e-01  4.78257462e-01  8.05231279e-01  8.05231279e-01
  8.05231279e-01  2.58491065e+00  3.88245381e+00  3.88245381e+00
  3.88245381e+00  9.23184406e+00  1.42191321e+01  1.42191321e+01
  1.42191321e+01  3.64844300e+01  5.28099610e+01  5.28099610e+01
  5.28099610e+01  1.39880573e+02  2.40595711e+02  2.40595711e+02
  2.40595711e+02  5.02776481e+02  1.86940049e+03  7.99883722e+03
  4.77666341e+04]
E1 = -182.590296320595  E_coul = 54.048682377733165
cycle= 5 E= -128.541613942862  delta_E= -7.67e-10  |g|= 6.43e-06  |ddm|= 5.6e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.590296320595  E_coul = 54.048682377733165
  HOMO = -0.848898830342197  LUMO = 0.478258357544574
  mo_energy =
[-3.27705652e+01 -1.92920405e+00 -8.48898830e-01 -8.48898830e-01
 -8.48898830e-01  4.78258358e-01  8.05232291e-01  8.05232291e-01
  8.05232291e-01  2.58491295e+00  3.88245714e+00  3.88245714e+00
  3.88245714e+00  9.23184859e+00  1.42191378e+01  1.42191378e+01
  1.42191378e+01  3.64844369e+01  5.28099683e+01  5.28099683e+01
  5.28099683e+01  1.39880581e+02  2.40595718e+02  2.40595718e+02
  2.40595718e+02  5.02776488e+02  1.86940049e+03  7.99883723e+03
  4.77666341e+04]
E1 = -182.5902784705121  E_coul = 54.04866452764763
Extra cycle  E= -128.541613942864  delta_E= -2.61e-12  |g|= 2.5e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 728.0575286792489
E1 = -182.5902784705121  E_coul = 54.04866452764763
init E= -128.541613942864
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.848900089886964  LUMO = 0.478258222385868
  mo_energy =
[-3.27705692e+01 -1.92920524e+00 -8.48900090e-01 -8.48900090e-01
 -8.48900090e-01  4.78258222e-01  8.05232002e-01  8.05232002e-01
  8.05232002e-01  2.58491241e+00  3.88245605e+00  3.88245605e+00
  3.88245605e+00  9.23184712e+00  1.42191356e+01  1.42191356e+01
  1.42191356e+01  3.64844339e+01  5.28099649e+01  5.28099649e+01
  5.28099649e+01  1.39880577e+02  2.40595714e+02  2.40595714e+02
  2.40595714e+02  5.02776484e+02  1.86940049e+03  7.99883723e+03
  4.77666341e+04]
E1 = -182.59028833736883  E_coul = 54.04867439450398
cycle= 1 E= -128.541613942865  delta_E= -3.98e-13  |g|= 1.35e-06  |ddm|= 8.88e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59028833736883  E_coul = 54.04867439450398
  HOMO = -0.848899394631056  LUMO = 0.478258339777288
  mo_energy =
[-3.27705671e+01 -1.92920448e+00 -8.48899395e-01 -8.48899395e-01
 -8.48899395e-01  4.78258340e-01  8.05232176e-01  8.05232176e-01
  8.05232176e-01  2.58491277e+00  3.88245667e+00  3.88245667e+00
  3.88245667e+00  9.23184798e+00  1.42191368e+01  1.42191368e+01
  1.42191368e+01  3.64844355e+01  5.28099667e+01  5.28099667e+01
  5.28099667e+01  1.39880579e+02  2.40595716e+02  2.40595716e+02
  2.40595716e+02  5.02776486e+02  1.86940049e+03  7.99883723e+03
  4.77666341e+04]
E1 = -182.59028337270442  E_coul = 54.048669429839535
Extra cycle  E= -128.541613942865  delta_E= -5.68e-14  |g|= 6.74e-07  |ddm|= 4.27e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [5.22389990e-01 2.44137942e+04 3.66145157e+03 8.33319265e+02
 2.35442317e+02 7.61390069e+01 1.00350934e+01 2.69116028e+01
 2.23627792e-01 1.26257795e+00 2.83402949e+00 7.11404675e+00
 2.31709732e+01 9.97863664e+01 2.66184533e-01 2.44160249e+00
 8.30551830e-01]
grad_E = [-4.09129239e-04  1.70212430e-10 -7.89309283e-09  1.02152505e-07
 -6.53395532e-07  9.55733698e-06 -1.65068604e-04 -7.68412998e-06
  1.32473453e-04 -1.63747749e-04 -1.53824864e-04 -2.51983975e-04
  2.12403166e-05 -6.63044623e-07  6.50599046e-03  1.52037438e-03
 -4.62098477e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.560514698571       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157361        1
[INPUT] 0    0    [1    /1   ]  833.319243276        1
[INPUT] 0    0    [1    /1   ]  235.442499253        1
[INPUT] 0    0    [1    /1   ]  76.1370394204        1
[INPUT] 0    0    [1    /1   ]  10.0431887886        1
[INPUT] 0    0    [1    /1   ]  26.9166093424        1
[INPUT] 0    0    [1    /1   ]  0.244346262296       1
[INPUT] 0    0    [1    /1   ]  1.31100850386        1
[INPUT] 0    0    [1    /1   ]  2.84884230716        1
[INPUT] 1    0    [1    /1   ]  7.11433046427        1
[INPUT] 1    0    [1    /1   ]  23.1709396729        1
[INPUT] 1    0    [1    /1   ]  99.7863642646        1
[INPUT] 1    0    [1    /1   ]  0.265776759534       1
[INPUT] 1    0    [1    /1   ]  2.44028565488        1
[INPUT] 1    0    [1    /1   ]  0.8288580049         1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.560514698570661, 1.0]], [0, [24413.794186501465, 1.0]], [0, [3661.451573610121, 1.0]], [0, [833.3192432756455, 1.0]], [0, [235.44249925290669, 1.0]], [0, [76.13703942044219, 1.0]], [0, [10.043188788563006, 1.0]], [0, [26.916609342379914, 1.0]], [0, [0.24434626229569206, 1.0]], [0, [1.3110085038574106, 1.0]], [0, [2.848842307164247, 1.0]], [1, [7.114330464274759, 1.0]], [1, [23.17093967289948, 1.0]], [1, [99.7863642646021, 1.0]], [1, [0.2657767595342069, 1.0]], [1, [2.4402856548774996, 1.0]], [1, [0.8288580049001125, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5605147]
bas 1, expnt(s) = [24413.7941865]
bas 2, expnt(s) = [3661.45157361]
bas 3, expnt(s) = [833.31924328]
bas 4, expnt(s) = [235.44249925]
bas 5, expnt(s) = [76.13703942]
bas 6, expnt(s) = [10.04318879]
bas 7, expnt(s) = [26.91660934]
bas 8, expnt(s) = [0.24434626]
bas 9, expnt(s) = [1.3110085]
bas 10, expnt(s) = [2.84884231]
bas 11, expnt(s) = [7.11433046]
bas 12, expnt(s) = [23.17093967]
bas 13, expnt(s) = [99.78636426]
bas 14, expnt(s) = [0.26577676]
bas 15, expnt(s) = [2.44028565]
bas 16, expnt(s) = [0.828858]
CPU time:        50.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.60514699e-01 1.63664798e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319243e+02 3.91853367e+02
 2.35442499e+02 1.51854851e+02 7.61370394e+01 6.51196433e+01
 1.00431888e+01 1.42534089e+01 2.69166093e+01 2.98559083e+01
 2.44346262e-01 8.78050105e-01 1.31100850e+00 3.09541695e+00
 2.84884231e+00 5.54008377e+00 7.11433046e+00 3.38962720e+01
 2.31709397e+01 1.48307786e+02 9.97863643e+01 9.20075342e+02
 2.65776760e-01 5.56712080e-01 2.44028565e+00 8.89785299e+00
 8.28858005e-01 2.30719639e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999638690413507
cond(S) = 863.4971758962082
E1 = -183.5898215320201  E_coul = 55.080081559912394
init E= -128.509739972108
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.77541151130173  LUMO = 0.542212997385747
  mo_energy =
[-3.25550973e+01 -1.85273880e+00 -7.75411511e-01 -7.75411511e-01
 -7.75411511e-01  5.42212997e-01  8.21572895e-01  8.21572895e-01
  8.21572895e-01  2.83204446e+00  3.94171549e+00  3.94171549e+00
  3.94171549e+00  9.73375155e+00  1.43363028e+01  1.43363028e+01
  1.43363028e+01  3.71774319e+01  5.29872743e+01  5.29872743e+01
  5.29872743e+01  1.40609337e+02  2.40821840e+02  2.40821840e+02
  2.40821840e+02  5.03493304e+02  1.87009906e+03  7.99951151e+03
  4.77672623e+04]
E1 = -182.0867601141514  E_coul = 53.54863698268602
cycle= 1 E= -128.538123131465  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.520168
diis-c [-0.27057473  1.        ]
  HOMO = -0.884236577721972  LUMO = 0.523385555563639
  mo_energy =
[-3.28781726e+01 -1.96651644e+00 -8.84236578e-01 -8.84236578e-01
 -8.84236578e-01  5.23385556e-01  7.95003823e-01  7.95003823e-01
  7.95003823e-01  2.77455616e+00  3.84454967e+00  3.84454967e+00
  3.84454967e+00  9.60068673e+00  1.41456336e+01  1.41456336e+01
  1.41456336e+01  3.69327867e+01  5.27064079e+01  5.27064079e+01
  5.27064079e+01  1.40292325e+02  2.40475610e+02  2.40475610e+02
  2.40475610e+02  5.03131968e+02  1.86970157e+03  7.99908495e+03
  4.77668169e+04]
E1 = -182.8482429869648  E_coul = 54.30753204534689
cycle= 2 E= -128.540710941618  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0634
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264278
diis-c [-6.49277359e-04  3.36122966e-01  6.63877034e-01]
  HOMO = -0.848605901473071  LUMO = 0.529438964710869
  mo_energy =
[-3.27700784e+01 -1.92899790e+00 -8.48605901e-01 -8.48605901e-01
 -8.48605901e-01  5.29438965e-01  8.03689936e-01  8.03689936e-01
  8.03689936e-01  2.79310920e+00  3.87610878e+00  3.87610878e+00
  3.87610878e+00  9.64433735e+00  1.42088360e+01  1.42088360e+01
  1.42088360e+01  3.70147589e+01  5.28004339e+01  5.28004339e+01
  5.28004339e+01  1.40398137e+02  2.40589276e+02  2.40589276e+02
  2.40589276e+02  5.03248750e+02  1.86982364e+03  7.99920946e+03
  4.77669423e+04]
E1 = -182.58976850597915  E_coul = 54.04813807544421
cycle= 3 E= -128.541630430535  delta_E= -0.000919  |g|= 0.000495  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00112456
diis-c [-2.46879352e-07 -2.39252458e-03 -8.90824216e-04  1.00328335e+00]
  HOMO = -0.848854095078014  LUMO = 0.529408630091627
  mo_energy =
[-3.27705231e+01 -1.92917728e+00 -8.48854095e-01 -8.48854095e-01
 -8.48854095e-01  5.29408630e-01  8.03654049e-01  8.03654049e-01
  8.03654049e-01  2.79301490e+00  3.87594202e+00  3.87594202e+00
  3.87594202e+00  9.64412592e+00  1.42085435e+01  1.42085435e+01
  1.42085435e+01  3.70144188e+01  5.28000428e+01  5.28000428e+01
  5.28000428e+01  1.40397689e+02  2.40588759e+02  2.40588759e+02
  2.40588759e+02  5.03248176e+02  1.86982293e+03  7.99920865e+03
  4.77669415e+04]
E1 = -182.59020844887647  E_coul = 54.048577992248
cycle= 4 E= -128.541630456628  delta_E= -2.61e-08  |g|= 7.79e-05  |ddm|= 0.000319
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000181797
diis-c [-1.19429674e-09  2.60991741e-04  4.79622138e-04 -1.98340321e-01
  1.19759971e+00]
  HOMO = -0.848895604443341  LUMO = 0.529400504548549
  mo_energy =
[-3.27705924e+01 -1.92920675e+00 -8.48895604e-01 -8.48895604e-01
 -8.48895604e-01  5.29400505e-01  8.03641133e-01  8.03641133e-01
  8.03641133e-01  2.79299306e+00  3.87590379e+00  3.87590379e+00
  3.87590379e+00  9.64408247e+00  1.42084869e+01  1.42084869e+01
  1.42084869e+01  3.70143576e+01  5.27999772e+01  5.27999772e+01
  5.27999772e+01  1.40397620e+02  2.40588685e+02  2.40588685e+02
  2.40588685e+02  5.03248098e+02  1.86982284e+03  7.99920856e+03
  4.77669414e+04]
E1 = -182.59033383093043  E_coul = 54.04870337354216
cycle= 5 E= -128.541630457388  delta_E= -7.6e-10  |g|= 6.4e-06  |ddm|= 5.96e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59033383093043  E_coul = 54.04870337354216
  HOMO = -0.848892146047957  LUMO = 0.529401480676503
  mo_energy =
[-3.27705846e+01 -1.92920249e+00 -8.48892146e-01 -8.48892146e-01
 -8.48892146e-01  5.29401481e-01  8.03642134e-01  8.03642134e-01
  8.03642134e-01  2.79299542e+00  3.87590708e+00  3.87590708e+00
  3.87590708e+00  9.64408699e+00  1.42084925e+01  1.42084925e+01
  1.42084925e+01  3.70143644e+01  5.27999845e+01  5.27999845e+01
  5.27999845e+01  1.40397627e+02  2.40588692e+02  2.40588692e+02
  2.40588692e+02  5.03248105e+02  1.86982285e+03  7.99920857e+03
  4.77669414e+04]
E1 = -182.59031609403922  E_coul = 54.04868563664748
Extra cycle  E= -128.541630457392  delta_E= -3.5e-12  |g|= 2.48e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.16 sec
exp = [5.60514699e-01 2.44137942e+04 3.66145157e+03 8.33319243e+02
 2.35442499e+02 7.61370394e+01 1.00431888e+01 2.69166093e+01
 2.44346262e-01 1.31100850e+00 2.84884231e+00 7.11433046e+00
 2.31709397e+01 9.97863643e+01 2.65776760e-01 2.44028565e+00
 8.28858005e-01]
E = -128.54163045739176
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.560514698571       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157361        1
[INPUT] 0    0    [1    /1   ]  833.319243276        1
[INPUT] 0    0    [1    /1   ]  235.442499253        1
[INPUT] 0    0    [1    /1   ]  76.1370394204        1
[INPUT] 0    0    [1    /1   ]  10.0431887886        1
[INPUT] 0    0    [1    /1   ]  26.9166093424        1
[INPUT] 0    0    [1    /1   ]  0.244346262296       1
[INPUT] 0    0    [1    /1   ]  1.31100850386        1
[INPUT] 0    0    [1    /1   ]  2.84884230716        1
[INPUT] 1    0    [1    /1   ]  7.11433046427        1
[INPUT] 1    0    [1    /1   ]  23.1709396729        1
[INPUT] 1    0    [1    /1   ]  99.7863642646        1
[INPUT] 1    0    [1    /1   ]  0.265776759534       1
[INPUT] 1    0    [1    /1   ]  2.44028565488        1
[INPUT] 1    0    [1    /1   ]  0.8288580049         1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.560514698570661, 1.0]], [0, [24413.794186501465, 1.0]], [0, [3661.451573610121, 1.0]], [0, [833.3192432756455, 1.0]], [0, [235.44249925290669, 1.0]], [0, [76.13703942044219, 1.0]], [0, [10.043188788563006, 1.0]], [0, [26.916609342379914, 1.0]], [0, [0.24434626229569206, 1.0]], [0, [1.3110085038574106, 1.0]], [0, [2.848842307164247, 1.0]], [1, [7.114330464274759, 1.0]], [1, [23.17093967289948, 1.0]], [1, [99.7863642646021, 1.0]], [1, [0.2657767595342069, 1.0]], [1, [2.4402856548774996, 1.0]], [1, [0.8288580049001125, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.5605147]
bas 1, expnt(s) = [24413.7941865]
bas 2, expnt(s) = [3661.45157361]
bas 3, expnt(s) = [833.31924328]
bas 4, expnt(s) = [235.44249925]
bas 5, expnt(s) = [76.13703942]
bas 6, expnt(s) = [10.04318879]
bas 7, expnt(s) = [26.91660934]
bas 8, expnt(s) = [0.24434626]
bas 9, expnt(s) = [1.3110085]
bas 10, expnt(s) = [2.84884231]
bas 11, expnt(s) = [7.11433046]
bas 12, expnt(s) = [23.17093967]
bas 13, expnt(s) = [99.78636426]
bas 14, expnt(s) = [0.26577676]
bas 15, expnt(s) = [2.44028565]
bas 16, expnt(s) = [0.828858]
CPU time:        50.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.60514699e-01 1.63664798e+00 2.44137942e+04 4.93448103e+03
 3.66145157e+03 1.18920026e+03 8.33319243e+02 3.91853367e+02
 2.35442499e+02 1.51854851e+02 7.61370394e+01 6.51196433e+01
 1.00431888e+01 1.42534089e+01 2.69166093e+01 2.98559083e+01
 2.44346262e-01 8.78050105e-01 1.31100850e+00 3.09541695e+00
 2.84884231e+00 5.54008377e+00 7.11433046e+00 3.38962720e+01
 2.31709397e+01 1.48307786e+02 9.97863643e+01 9.20075342e+02
 2.65776760e-01 5.56712080e-01 2.44028565e+00 8.89785299e+00
 8.28858005e-01 2.30719639e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999638690413507
cond(S) = 863.4971758962082
E1 = -183.5898215320201  E_coul = 55.080081559912394
init E= -128.509739972108
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77541151130173  LUMO = 0.542212997385747
  mo_energy =
[-3.25550973e+01 -1.85273880e+00 -7.75411511e-01 -7.75411511e-01
 -7.75411511e-01  5.42212997e-01  8.21572895e-01  8.21572895e-01
  8.21572895e-01  2.83204446e+00  3.94171549e+00  3.94171549e+00
  3.94171549e+00  9.73375155e+00  1.43363028e+01  1.43363028e+01
  1.43363028e+01  3.71774319e+01  5.29872743e+01  5.29872743e+01
  5.29872743e+01  1.40609337e+02  2.40821840e+02  2.40821840e+02
  2.40821840e+02  5.03493304e+02  1.87009906e+03  7.99951151e+03
  4.77672623e+04]
E1 = -182.0867601141514  E_coul = 53.54863698268602
cycle= 1 E= -128.538123131465  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520168
diis-c [-0.27057473  1.        ]
  HOMO = -0.884236577721972  LUMO = 0.523385555563639
  mo_energy =
[-3.28781726e+01 -1.96651644e+00 -8.84236578e-01 -8.84236578e-01
 -8.84236578e-01  5.23385556e-01  7.95003823e-01  7.95003823e-01
  7.95003823e-01  2.77455616e+00  3.84454967e+00  3.84454967e+00
  3.84454967e+00  9.60068673e+00  1.41456336e+01  1.41456336e+01
  1.41456336e+01  3.69327867e+01  5.27064079e+01  5.27064079e+01
  5.27064079e+01  1.40292325e+02  2.40475610e+02  2.40475610e+02
  2.40475610e+02  5.03131968e+02  1.86970157e+03  7.99908495e+03
  4.77668169e+04]
E1 = -182.8482429869648  E_coul = 54.30753204534689
cycle= 2 E= -128.540710941618  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0634
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264278
diis-c [-6.49277359e-04  3.36122966e-01  6.63877034e-01]
  HOMO = -0.848605901473071  LUMO = 0.529438964710869
  mo_energy =
[-3.27700784e+01 -1.92899790e+00 -8.48605901e-01 -8.48605901e-01
 -8.48605901e-01  5.29438965e-01  8.03689936e-01  8.03689936e-01
  8.03689936e-01  2.79310920e+00  3.87610878e+00  3.87610878e+00
  3.87610878e+00  9.64433735e+00  1.42088360e+01  1.42088360e+01
  1.42088360e+01  3.70147589e+01  5.28004339e+01  5.28004339e+01
  5.28004339e+01  1.40398137e+02  2.40589276e+02  2.40589276e+02
  2.40589276e+02  5.03248750e+02  1.86982364e+03  7.99920946e+03
  4.77669423e+04]
E1 = -182.58976850597915  E_coul = 54.04813807544421
cycle= 3 E= -128.541630430535  delta_E= -0.000919  |g|= 0.000495  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00112456
diis-c [-2.46879352e-07 -2.39252458e-03 -8.90824216e-04  1.00328335e+00]
  HOMO = -0.848854095078014  LUMO = 0.529408630091627
  mo_energy =
[-3.27705231e+01 -1.92917728e+00 -8.48854095e-01 -8.48854095e-01
 -8.48854095e-01  5.29408630e-01  8.03654049e-01  8.03654049e-01
  8.03654049e-01  2.79301490e+00  3.87594202e+00  3.87594202e+00
  3.87594202e+00  9.64412592e+00  1.42085435e+01  1.42085435e+01
  1.42085435e+01  3.70144188e+01  5.28000428e+01  5.28000428e+01
  5.28000428e+01  1.40397689e+02  2.40588759e+02  2.40588759e+02
  2.40588759e+02  5.03248176e+02  1.86982293e+03  7.99920865e+03
  4.77669415e+04]
E1 = -182.59020844887647  E_coul = 54.048577992248
cycle= 4 E= -128.541630456628  delta_E= -2.61e-08  |g|= 7.79e-05  |ddm|= 0.000319
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000181797
diis-c [-1.19429674e-09  2.60991741e-04  4.79622138e-04 -1.98340321e-01
  1.19759971e+00]
  HOMO = -0.848895604443341  LUMO = 0.529400504548549
  mo_energy =
[-3.27705924e+01 -1.92920675e+00 -8.48895604e-01 -8.48895604e-01
 -8.48895604e-01  5.29400505e-01  8.03641133e-01  8.03641133e-01
  8.03641133e-01  2.79299306e+00  3.87590379e+00  3.87590379e+00
  3.87590379e+00  9.64408247e+00  1.42084869e+01  1.42084869e+01
  1.42084869e+01  3.70143576e+01  5.27999772e+01  5.27999772e+01
  5.27999772e+01  1.40397620e+02  2.40588685e+02  2.40588685e+02
  2.40588685e+02  5.03248098e+02  1.86982284e+03  7.99920856e+03
  4.77669414e+04]
E1 = -182.59033383093043  E_coul = 54.04870337354216
cycle= 5 E= -128.541630457388  delta_E= -7.6e-10  |g|= 6.4e-06  |ddm|= 5.96e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59033383093043  E_coul = 54.04870337354216
  HOMO = -0.848892146047957  LUMO = 0.529401480676503
  mo_energy =
[-3.27705846e+01 -1.92920249e+00 -8.48892146e-01 -8.48892146e-01
 -8.48892146e-01  5.29401481e-01  8.03642134e-01  8.03642134e-01
  8.03642134e-01  2.79299542e+00  3.87590708e+00  3.87590708e+00
  3.87590708e+00  9.64408699e+00  1.42084925e+01  1.42084925e+01
  1.42084925e+01  3.70143644e+01  5.27999845e+01  5.27999845e+01
  5.27999845e+01  1.40397627e+02  2.40588692e+02  2.40588692e+02
  2.40588692e+02  5.03248105e+02  1.86982285e+03  7.99920857e+03
  4.77669414e+04]
E1 = -182.59031609403922  E_coul = 54.04868563664748
Extra cycle  E= -128.541630457392  delta_E= -3.5e-12  |g|= 2.48e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 863.4971758962082
E1 = -182.59031609403922  E_coul = 54.04868563664748
init E= -128.541630457392
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.848893398045988  LUMO = 0.529401329876738
  mo_energy =
[-3.27705885e+01 -1.92920367e+00 -8.48893398e-01 -8.48893398e-01
 -8.48893398e-01  5.29401330e-01  8.03641848e-01  8.03641848e-01
  8.03641848e-01  2.79299486e+00  3.87590600e+00  3.87590600e+00
  3.87590600e+00  9.64408552e+00  1.42084903e+01  1.42084903e+01
  1.42084903e+01  3.70143615e+01  5.27999811e+01  5.27999811e+01
  5.27999811e+01  1.40397624e+02  2.40588688e+02  2.40588688e+02
  2.40588688e+02  5.03248101e+02  1.86982284e+03  7.99920856e+03
  4.77669414e+04]
E1 = -182.5903258979527  E_coul = 54.04869544056097
cycle= 1 E= -128.541630457392  delta_E= 2.84e-14  |g|= 1.34e-06  |ddm|= 8.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5903258979527  E_coul = 54.04869544056097
  HOMO = -0.848892707283053  LUMO = 0.529401459252877
  mo_energy =
[-3.27705865e+01 -1.92920292e+00 -8.48892707e-01 -8.48892707e-01
 -8.48892707e-01  5.29401459e-01  8.03642020e-01  8.03642020e-01
  8.03642020e-01  2.79299524e+00  3.87590662e+00  3.87590662e+00
  3.87590662e+00  9.64408638e+00  1.42084915e+01  1.42084915e+01
  1.42084915e+01  3.70143631e+01  5.27999830e+01  5.27999830e+01
  5.27999830e+01  1.40397626e+02  2.40588690e+02  2.40588690e+02
  2.40588690e+02  5.03248103e+02  1.86982284e+03  7.99920857e+03
  4.77669414e+04]
E1 = -182.59032096535805  E_coul = 54.04869050796614
Extra cycle  E= -128.541630457392  delta_E= -1.71e-13  |g|= 6.7e-07  |ddm|= 4.21e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [5.60514699e-01 2.44137942e+04 3.66145157e+03 8.33319243e+02
 2.35442499e+02 7.61370394e+01 1.00431888e+01 2.69166093e+01
 2.44346262e-01 1.31100850e+00 2.84884231e+00 7.11433046e+00
 2.31709397e+01 9.97863643e+01 2.65776760e-01 2.44028565e+00
 8.28858005e-01]
grad_E = [-3.84411502e-04  1.17519022e-10 -5.12990153e-09  4.71439338e-08
 -1.06991030e-08  4.69686023e-06 -2.46099991e-04  1.76660401e-05
  3.03346129e-04 -6.57064787e-05 -1.58324104e-04 -2.78578931e-04
  2.23275107e-05 -6.82770514e-07  7.39209515e-03  1.79486937e-03
 -5.53313279e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.621710669899       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157584        1
[INPUT] 0    0    [1    /1   ]  833.31921061         1
[INPUT] 0    0    [1    /1   ]  235.442767512        1
[INPUT] 0    0    [1    /1   ]  76.1340028689        1
[INPUT] 0    0    [1    /1   ]  10.059177278         1
[INPUT] 0    0    [1    /1   ]  26.9237983285        1
[INPUT] 0    0    [1    /1   ]  0.2645792626         1
[INPUT] 0    0    [1    /1   ]  1.39629462232        1
[INPUT] 0    0    [1    /1   ]  2.8701945947         1
[INPUT] 1    0    [1    /1   ]  7.11485514376        1
[INPUT] 1    0    [1    /1   ]  23.1708818844        1
[INPUT] 1    0    [1    /1   ]  99.7863605233        1
[INPUT] 1    0    [1    /1   ]  0.265141390541       1
[INPUT] 1    0    [1    /1   ]  2.4375357567         1
[INPUT] 1    0    [1    /1   ]  0.827661346616       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.6217106698985064, 1.0]], [0, [24413.794186454837, 1.0]], [0, [3661.451575836212, 1.0]], [0, [833.3192106101587, 1.0]], [0, [235.44276751243908, 1.0]], [0, [76.13400286888276, 1.0]], [0, [10.05917727797546, 1.0]], [0, [26.923798328524274, 1.0]], [0, [0.26457926259976483, 1.0]], [0, [1.3962946223223842, 1.0]], [0, [2.8701945946988614, 1.0]], [1, [7.11485514375885, 1.0]], [1, [23.17088188435385, 1.0]], [1, [99.78636052328416, 1.0]], [1, [0.2651413905414257, 1.0]], [1, [2.4375357566950653, 1.0]], [1, [0.8276613466159993, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.62171067]
bas 1, expnt(s) = [24413.79418645]
bas 2, expnt(s) = [3661.45157584]
bas 3, expnt(s) = [833.31921061]
bas 4, expnt(s) = [235.44276751]
bas 5, expnt(s) = [76.13400287]
bas 6, expnt(s) = [10.05917728]
bas 7, expnt(s) = [26.92379833]
bas 8, expnt(s) = [0.26457926]
bas 9, expnt(s) = [1.39629462]
bas 10, expnt(s) = [2.87019459]
bas 11, expnt(s) = [7.11485514]
bas 12, expnt(s) = [23.17088188]
bas 13, expnt(s) = [99.78636052]
bas 14, expnt(s) = [0.26514139]
bas 15, expnt(s) = [2.43753576]
bas 16, expnt(s) = [0.82766135]
CPU time:        53.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 6.21710670e-01 1.76891215e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319211e+02 3.91853355e+02
 2.35442768e+02 1.51854980e+02 7.61340029e+01 6.51176955e+01
 1.00591773e+01 1.42704238e+01 2.69237983e+01 2.98618886e+01
 2.64579263e-01 9.32034258e-01 1.39629462e+00 3.24524749e+00
 2.87019459e+00 5.57119720e+00 7.11485514e+00 3.38993968e+01
 2.31708819e+01 1.48307323e+02 9.97863605e+01 9.20075299e+02
 2.65141391e-01 5.55048974e-01 2.43753576e+00 8.88532129e+00
 8.27661347e-01 2.30303339e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99964554816332
cond(S) = 1086.7238867645822
E1 = -183.58990361842856  E_coul = 55.08010011947115
init E= -128.509803498957
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775411540520663  LUMO = 0.605751092771823
  mo_energy =
[-3.25550997e+01 -1.85274086e+00 -7.75411541e-01 -7.75411541e-01
 -7.75411541e-01  6.05751093e-01  8.19492870e-01  8.19492870e-01
  8.19492870e-01  3.12133166e+00  3.93469129e+00  3.93469129e+00
  3.93469129e+00  1.03485282e+01  1.43230919e+01  1.43230919e+01
  1.43230919e+01  3.79974233e+01  5.29740606e+01  5.29740606e+01
  5.29740606e+01  1.41421612e+02  2.40812457e+02  2.40812457e+02
  2.40812457e+02  5.04236855e+02  1.87076547e+03  8.00009756e+03
  4.77677474e+04]
E1 = -182.08598022950204  E_coul = 53.54783535799271
cycle= 1 E= -128.538144871509  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.144
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519888
diis-c [-0.27028383  1.        ]
  HOMO = -0.88430055018725  LUMO = 0.584508046131827
  mo_energy =
[-3.28783207e+01 -1.96659058e+00 -8.84300550e-01 -8.84300550e-01
 -8.84300550e-01  5.84508046e-01  7.92965805e-01  7.92965805e-01
  7.92965805e-01  3.06009412e+00  3.83754962e+00  3.83754962e+00
  3.83754962e+00  1.02134090e+01  1.41323196e+01  1.41323196e+01
  1.41323196e+01  3.77528455e+01  5.26930524e+01  5.26930524e+01
  5.26930524e+01  1.41104624e+02  2.40466067e+02  2.40466067e+02
  2.40466067e+02  5.03875410e+02  1.87036782e+03  7.99967083e+03
  4.77673018e+04]
E1 = -182.84787205655022  E_coul = 54.30713743203912
cycle= 2 E= -128.540734624511  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0631
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264115
diis-c [-6.51817301e-04  3.36101420e-01  6.63898580e-01]
  HOMO = -0.848648998072702  LUMO = 0.591330700079094
  mo_energy =
[-3.27701679e+01 -1.92904945e+00 -8.48648998e-01 -8.48648998e-01
 -8.48648998e-01  5.91330700e-01  8.01633470e-01  8.01633470e-01
  8.01633470e-01  3.07986331e+00  3.86909824e+00  3.86909824e+00
  3.86909824e+00  1.02577476e+01  1.41955553e+01  1.41955553e+01
  1.41955553e+01  3.78347919e+01  5.27871346e+01  5.27871346e+01
  5.27871346e+01  1.41210432e+02  2.40579794e+02  2.40579794e+02
  2.40579794e+02  5.03992237e+02  1.87048995e+03  7.99979540e+03
  4.77674273e+04]
E1 = -182.58917030154794  E_coul = 54.04751504045012
cycle= 3 E= -128.541655261098  delta_E= -0.000921  |g|= 0.000508  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114863
diis-c [-2.33963469e-07 -2.37681769e-03 -7.30915949e-04  1.00310773e+00]
  HOMO = -0.848902879988425  LUMO = 0.591294558190231
  mo_energy =
[-3.27706255e+01 -1.92923551e+00 -8.48902880e-01 -8.48902880e-01
 -8.48902880e-01  5.91294558e-01  8.01595775e-01  8.01595775e-01
  8.01595775e-01  3.07975806e+00  3.86892609e+00  3.86892609e+00
  3.86892609e+00  1.02575253e+01  1.41952536e+01  1.41952536e+01
  1.41952536e+01  3.78344410e+01  5.27867318e+01  5.27867318e+01
  5.27867318e+01  1.41209972e+02  2.40579263e+02  2.40579263e+02
  2.40579263e+02  5.03991649e+02  1.87048922e+03  7.99979457e+03
  4.77674264e+04]
E1 = -182.58963033885342  E_coul = 54.0479750508414
cycle= 4 E= -128.541655288012  delta_E= -2.69e-08  |g|= 7.92e-05  |ddm|= 0.00035
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183973
diis-c [-1.17216147e-09  2.54936174e-04  4.72327414e-04 -1.95078023e-01
  1.19435076e+00]
  HOMO = -0.848945157369393  LUMO = 0.591285183765957
  mo_energy =
[-3.27706965e+01 -1.92926608e+00 -8.48945157e-01 -8.48945157e-01
 -8.48945157e-01  5.91285184e-01  8.01582646e-01  8.01582646e-01
  8.01582646e-01  3.07973422e+00  3.86888709e+00  3.86888709e+00
  3.86888709e+00  1.02574801e+01  1.41951958e+01  1.41951958e+01
  1.41951958e+01  3.78343783e+01  5.27866647e+01  5.27866647e+01
  5.27866647e+01  1.41209901e+02  2.40579188e+02  2.40579188e+02
  2.40579188e+02  5.03991569e+02  1.87048913e+03  7.99979448e+03
  4.77674263e+04]
E1 = -182.5897582170878  E_coul = 54.04810292831272
cycle= 5 E= -128.541655288775  delta_E= -7.63e-10  |g|= 6.27e-06  |ddm|= 6.37e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5897582170878  E_coul = 54.04810292831272
  HOMO = -0.848941796630384  LUMO = 0.591286247143169
  mo_energy =
[-3.27706889e+01 -1.92926191e+00 -8.48941797e-01 -8.48941797e-01
 -8.48941797e-01  5.91286247e-01  8.01583619e-01  8.01583619e-01
  8.01583619e-01  3.07973665e+00  3.86889029e+00  3.86889029e+00
  3.86889029e+00  1.02574846e+01  1.41952013e+01  1.41952013e+01
  1.41952013e+01  3.78343849e+01  5.27866719e+01  5.27866719e+01
  5.27866719e+01  1.41209908e+02  2.40579195e+02  2.40579195e+02
  2.40579195e+02  5.03991576e+02  1.87048914e+03  7.99979449e+03
  4.77674263e+04]
E1 = -182.5897409597764  E_coul = 54.04808567099828
Extra cycle  E= -128.541655288778  delta_E= -3.04e-12  |g|= 2.42e-06  |ddm|= 2.09e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [6.21710670e-01 2.44137942e+04 3.66145158e+03 8.33319211e+02
 2.35442768e+02 7.61340029e+01 1.00591773e+01 2.69237983e+01
 2.64579263e-01 1.39629462e+00 2.87019459e+00 7.11485514e+00
 2.31708819e+01 9.97863605e+01 2.65141391e-01 2.43753576e+00
 8.27661347e-01]
E = -128.54165528877812
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.621710669899       1
[INPUT] 0    0    [1    /1   ]  24413.7941865        1
[INPUT] 0    0    [1    /1   ]  3661.45157584        1
[INPUT] 0    0    [1    /1   ]  833.31921061         1
[INPUT] 0    0    [1    /1   ]  235.442767512        1
[INPUT] 0    0    [1    /1   ]  76.1340028689        1
[INPUT] 0    0    [1    /1   ]  10.059177278         1
[INPUT] 0    0    [1    /1   ]  26.9237983285        1
[INPUT] 0    0    [1    /1   ]  0.2645792626         1
[INPUT] 0    0    [1    /1   ]  1.39629462232        1
[INPUT] 0    0    [1    /1   ]  2.8701945947         1
[INPUT] 1    0    [1    /1   ]  7.11485514376        1
[INPUT] 1    0    [1    /1   ]  23.1708818844        1
[INPUT] 1    0    [1    /1   ]  99.7863605233        1
[INPUT] 1    0    [1    /1   ]  0.265141390541       1
[INPUT] 1    0    [1    /1   ]  2.4375357567         1
[INPUT] 1    0    [1    /1   ]  0.827661346616       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.6217106698985064, 1.0]], [0, [24413.794186454837, 1.0]], [0, [3661.451575836212, 1.0]], [0, [833.3192106101587, 1.0]], [0, [235.44276751243908, 1.0]], [0, [76.13400286888276, 1.0]], [0, [10.05917727797546, 1.0]], [0, [26.923798328524274, 1.0]], [0, [0.26457926259976483, 1.0]], [0, [1.3962946223223842, 1.0]], [0, [2.8701945946988614, 1.0]], [1, [7.11485514375885, 1.0]], [1, [23.17088188435385, 1.0]], [1, [99.78636052328416, 1.0]], [1, [0.2651413905414257, 1.0]], [1, [2.4375357566950653, 1.0]], [1, [0.8276613466159993, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.62171067]
bas 1, expnt(s) = [24413.79418645]
bas 2, expnt(s) = [3661.45157584]
bas 3, expnt(s) = [833.31921061]
bas 4, expnt(s) = [235.44276751]
bas 5, expnt(s) = [76.13400287]
bas 6, expnt(s) = [10.05917728]
bas 7, expnt(s) = [26.92379833]
bas 8, expnt(s) = [0.26457926]
bas 9, expnt(s) = [1.39629462]
bas 10, expnt(s) = [2.87019459]
bas 11, expnt(s) = [7.11485514]
bas 12, expnt(s) = [23.17088188]
bas 13, expnt(s) = [99.78636052]
bas 14, expnt(s) = [0.26514139]
bas 15, expnt(s) = [2.43753576]
bas 16, expnt(s) = [0.82766135]
CPU time:        54.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 6.21710670e-01 1.76891215e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319211e+02 3.91853355e+02
 2.35442768e+02 1.51854980e+02 7.61340029e+01 6.51176955e+01
 1.00591773e+01 1.42704238e+01 2.69237983e+01 2.98618886e+01
 2.64579263e-01 9.32034258e-01 1.39629462e+00 3.24524749e+00
 2.87019459e+00 5.57119720e+00 7.11485514e+00 3.38993968e+01
 2.31708819e+01 1.48307323e+02 9.97863605e+01 9.20075299e+02
 2.65141391e-01 5.55048974e-01 2.43753576e+00 8.88532129e+00
 8.27661347e-01 2.30303339e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99964554816332
cond(S) = 1086.7238867645822
E1 = -183.58990361842856  E_coul = 55.08010011947115
init E= -128.509803498957
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775411540520663  LUMO = 0.605751092771823
  mo_energy =
[-3.25550997e+01 -1.85274086e+00 -7.75411541e-01 -7.75411541e-01
 -7.75411541e-01  6.05751093e-01  8.19492870e-01  8.19492870e-01
  8.19492870e-01  3.12133166e+00  3.93469129e+00  3.93469129e+00
  3.93469129e+00  1.03485282e+01  1.43230919e+01  1.43230919e+01
  1.43230919e+01  3.79974233e+01  5.29740606e+01  5.29740606e+01
  5.29740606e+01  1.41421612e+02  2.40812457e+02  2.40812457e+02
  2.40812457e+02  5.04236855e+02  1.87076547e+03  8.00009756e+03
  4.77677474e+04]
E1 = -182.08598022950204  E_coul = 53.54783535799271
cycle= 1 E= -128.538144871509  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.144
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519888
diis-c [-0.27028383  1.        ]
  HOMO = -0.88430055018725  LUMO = 0.584508046131827
  mo_energy =
[-3.28783207e+01 -1.96659058e+00 -8.84300550e-01 -8.84300550e-01
 -8.84300550e-01  5.84508046e-01  7.92965805e-01  7.92965805e-01
  7.92965805e-01  3.06009412e+00  3.83754962e+00  3.83754962e+00
  3.83754962e+00  1.02134090e+01  1.41323196e+01  1.41323196e+01
  1.41323196e+01  3.77528455e+01  5.26930524e+01  5.26930524e+01
  5.26930524e+01  1.41104624e+02  2.40466067e+02  2.40466067e+02
  2.40466067e+02  5.03875410e+02  1.87036782e+03  7.99967083e+03
  4.77673018e+04]
E1 = -182.84787205655022  E_coul = 54.30713743203912
cycle= 2 E= -128.540734624511  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0631
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264115
diis-c [-6.51817301e-04  3.36101420e-01  6.63898580e-01]
  HOMO = -0.848648998072702  LUMO = 0.591330700079094
  mo_energy =
[-3.27701679e+01 -1.92904945e+00 -8.48648998e-01 -8.48648998e-01
 -8.48648998e-01  5.91330700e-01  8.01633470e-01  8.01633470e-01
  8.01633470e-01  3.07986331e+00  3.86909824e+00  3.86909824e+00
  3.86909824e+00  1.02577476e+01  1.41955553e+01  1.41955553e+01
  1.41955553e+01  3.78347919e+01  5.27871346e+01  5.27871346e+01
  5.27871346e+01  1.41210432e+02  2.40579794e+02  2.40579794e+02
  2.40579794e+02  5.03992237e+02  1.87048995e+03  7.99979540e+03
  4.77674273e+04]
E1 = -182.58917030154794  E_coul = 54.04751504045012
cycle= 3 E= -128.541655261098  delta_E= -0.000921  |g|= 0.000508  |ddm|= 0.0217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00114863
diis-c [-2.33963469e-07 -2.37681769e-03 -7.30915949e-04  1.00310773e+00]
  HOMO = -0.848902879988425  LUMO = 0.591294558190231
  mo_energy =
[-3.27706255e+01 -1.92923551e+00 -8.48902880e-01 -8.48902880e-01
 -8.48902880e-01  5.91294558e-01  8.01595775e-01  8.01595775e-01
  8.01595775e-01  3.07975806e+00  3.86892609e+00  3.86892609e+00
  3.86892609e+00  1.02575253e+01  1.41952536e+01  1.41952536e+01
  1.41952536e+01  3.78344410e+01  5.27867318e+01  5.27867318e+01
  5.27867318e+01  1.41209972e+02  2.40579263e+02  2.40579263e+02
  2.40579263e+02  5.03991649e+02  1.87048922e+03  7.99979457e+03
  4.77674264e+04]
E1 = -182.58963033885342  E_coul = 54.0479750508414
cycle= 4 E= -128.541655288012  delta_E= -2.69e-08  |g|= 7.92e-05  |ddm|= 0.00035
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000183973
diis-c [-1.17216147e-09  2.54936174e-04  4.72327414e-04 -1.95078023e-01
  1.19435076e+00]
  HOMO = -0.848945157369393  LUMO = 0.591285183765957
  mo_energy =
[-3.27706965e+01 -1.92926608e+00 -8.48945157e-01 -8.48945157e-01
 -8.48945157e-01  5.91285184e-01  8.01582646e-01  8.01582646e-01
  8.01582646e-01  3.07973422e+00  3.86888709e+00  3.86888709e+00
  3.86888709e+00  1.02574801e+01  1.41951958e+01  1.41951958e+01
  1.41951958e+01  3.78343783e+01  5.27866647e+01  5.27866647e+01
  5.27866647e+01  1.41209901e+02  2.40579188e+02  2.40579188e+02
  2.40579188e+02  5.03991569e+02  1.87048913e+03  7.99979448e+03
  4.77674263e+04]
E1 = -182.5897582170878  E_coul = 54.04810292831272
cycle= 5 E= -128.541655288775  delta_E= -7.63e-10  |g|= 6.27e-06  |ddm|= 6.37e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5897582170878  E_coul = 54.04810292831272
  HOMO = -0.848941796630384  LUMO = 0.591286247143169
  mo_energy =
[-3.27706889e+01 -1.92926191e+00 -8.48941797e-01 -8.48941797e-01
 -8.48941797e-01  5.91286247e-01  8.01583619e-01  8.01583619e-01
  8.01583619e-01  3.07973665e+00  3.86889029e+00  3.86889029e+00
  3.86889029e+00  1.02574846e+01  1.41952013e+01  1.41952013e+01
  1.41952013e+01  3.78343849e+01  5.27866719e+01  5.27866719e+01
  5.27866719e+01  1.41209908e+02  2.40579195e+02  2.40579195e+02
  2.40579195e+02  5.03991576e+02  1.87048914e+03  7.99979449e+03
  4.77674263e+04]
E1 = -182.5897409597764  E_coul = 54.04808567099828
Extra cycle  E= -128.541655288778  delta_E= -3.04e-12  |g|= 2.42e-06  |ddm|= 2.09e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1086.7238867645822
E1 = -182.5897409597764  E_coul = 54.04808567099828
init E= -128.541655288778
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.848943015918453  LUMO = 0.591286081310753
  mo_energy =
[-3.27706927e+01 -1.92926305e+00 -8.48943016e-01 -8.48943016e-01
 -8.48943016e-01  5.91286081e-01  8.01583341e-01  8.01583341e-01
  8.01583341e-01  3.07973606e+00  3.86888923e+00  3.86888923e+00
  3.86888923e+00  1.02574831e+01  1.41951991e+01  1.41951991e+01
  1.41951991e+01  3.78343821e+01  5.27866686e+01  5.27866686e+01
  5.27866686e+01  1.41209905e+02  2.40579191e+02  2.40579191e+02
  2.40579191e+02  5.03991572e+02  1.87048914e+03  7.99979448e+03
  4.77674263e+04]
E1 = -182.58975051060787  E_coul = 54.04809522182919
cycle= 1 E= -128.541655288779  delta_E= -5.68e-13  |g|= 1.31e-06  |ddm|= 8.62e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58975051060787  E_coul = 54.04809522182919
  HOMO = -0.848942343163407  LUMO = 0.591286223313817
  mo_energy =
[-3.27706907e+01 -1.92926232e+00 -8.48942343e-01 -8.48942343e-01
 -8.48942343e-01  5.91286223e-01  8.01583508e-01  8.01583508e-01
  8.01583508e-01  3.07973645e+00  3.86888984e+00  3.86888984e+00
  3.86888984e+00  1.02574840e+01  1.41952003e+01  1.41952003e+01
  1.41952003e+01  3.78343836e+01  5.27866703e+01  5.27866703e+01
  5.27866703e+01  1.41209907e+02  2.40579193e+02  2.40579193e+02
  2.40579193e+02  5.03991574e+02  1.87048914e+03  7.99979449e+03
  4.77674263e+04]
E1 = -182.5897457064584  E_coul = 54.04809041767955
Extra cycle  E= -128.541655288779  delta_E= -1.42e-13  |g|= 6.53e-07  |ddm|= 4.07e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [6.21710670e-01 2.44137942e+04 3.66145158e+03 8.33319211e+02
 2.35442768e+02 7.61340029e+01 1.00591773e+01 2.69237983e+01
 2.64579263e-01 1.39629462e+00 2.87019459e+00 7.11485514e+00
 2.31708819e+01 9.97863605e+01 2.65141391e-01 2.43753576e+00
 8.27661347e-01]
grad_E = [-1.26968714e-05  7.24608391e-11 -2.77145239e-09  6.57341403e-10
  5.16281128e-07  9.10055091e-07 -3.21869844e-04  3.79286568e-05
  7.96626097e-06 -8.56422924e-05 -1.32514103e-04 -1.72661508e-04
  1.08395517e-05 -2.76187443e-07  5.95288033e-03  1.41630802e-03
 -4.72726168e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.69418081428        1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.45157851        1
[INPUT] 0    0    [1    /1   ]  833.319170937        1
[INPUT] 0    0    [1    /1   ]  235.443098919        1
[INPUT] 0    0    [1    /1   ]  76.1303204856        1
[INPUT] 0    0    [1    /1   ]  10.0771925773        1
[INPUT] 0    0    [1    /1   ]  26.9327440421        1
[INPUT] 0    0    [1    /1   ]  0.29587597082        1
[INPUT] 0    0    [1    /1   ]  1.49444648346        1
[INPUT] 0    0    [1    /1   ]  2.89703106678        1
[INPUT] 1    0    [1    /1   ]  7.11541408262        1
[INPUT] 1    0    [1    /1   ]  23.1708259157        1
[INPUT] 1    0    [1    /1   ]  99.7863556881        1
[INPUT] 1    0    [1    /1   ]  0.264421735302       1
[INPUT] 1    0    [1    /1   ]  2.43395622943        1
[INPUT] 1    0    [1    /1   ]  0.827693752261       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.6941808142795931, 1.0]], [0, [24413.794186398947, 1.0]], [0, [3661.451578511392, 1.0]], [0, [833.3191709367908, 1.0]], [0, [235.44309891890128, 1.0]], [0, [76.13032048563345, 1.0]], [0, [10.07719257729787, 1.0]], [0, [26.93274404213071, 1.0]], [0, [0.29587597081955985, 1.0]], [0, [1.4944464834625741, 1.0]], [0, [2.897031066784975, 1.0]], [1, [7.115414082624664, 1.0]], [1, [23.170825915747887, 1.0]], [1, [99.78635568809004, 1.0]], [1, [0.26442173530233565, 1.0]], [1, [2.433956229428311, 1.0]], [1, [0.8276937522607098, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.69418081]
bas 1, expnt(s) = [24413.7941864]
bas 2, expnt(s) = [3661.45157851]
bas 3, expnt(s) = [833.31917094]
bas 4, expnt(s) = [235.44309892]
bas 5, expnt(s) = [76.13032049]
bas 6, expnt(s) = [10.07719258]
bas 7, expnt(s) = [26.93274404]
bas 8, expnt(s) = [0.29587597]
bas 9, expnt(s) = [1.49444648]
bas 10, expnt(s) = [2.89703107]
bas 11, expnt(s) = [7.11541408]
bas 12, expnt(s) = [23.17082592]
bas 13, expnt(s) = [99.78635569]
bas 14, expnt(s) = [0.26442174]
bas 15, expnt(s) = [2.43395623]
bas 16, expnt(s) = [0.82769375]
CPU time:        57.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 6.94180814e-01 1.92140749e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319171e+02 3.91853341e+02
 2.35443099e+02 1.51855141e+02 7.61303205e+01 6.51153333e+01
 1.00771926e+01 1.42895875e+01 2.69327440e+01 2.98693297e+01
 2.95875971e-01 1.01355494e+00 1.49444648e+00 3.41487884e+00
 2.89703107e+00 5.61021995e+00 7.11541408e+00 3.39027257e+01
 2.31708259e+01 1.48306876e+02 9.97863557e+01 9.20075243e+02
 2.64421735e-01 5.53166449e-01 2.43395623e+00 8.86901414e+00
 8.27693752e-01 2.30314610e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999648524589642
cond(S) = 1467.0018312179568
E1 = -183.58993296026986  E_coul = 55.08009646680934
init E= -128.509836493461
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775412708911014  LUMO = 0.696260386396123
  mo_energy =
[-3.25551096e+01 -1.85273628e+00 -7.75412709e-01 -7.75412709e-01
 -7.75412709e-01  6.96260386e-01  8.17593523e-01  8.17593523e-01
  8.17593523e-01  3.48739491e+00  3.93001730e+00  3.93001730e+00
  3.93001730e+00  1.10920579e+01  1.43117922e+01  1.43117922e+01
  1.43117922e+01  3.89889135e+01  5.29617029e+01  5.29617029e+01
  5.29617029e+01  1.42407380e+02  2.40803511e+02  2.40803511e+02
  2.40803511e+02  5.05140072e+02  1.87157522e+03  8.00080972e+03
  4.77683369e+04]
E1 = -182.08493476712735  E_coul = 53.546779045262156
cycle= 1 E= -128.538155721865  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.519415
diis-c [-0.269792  1.      ]
  HOMO = -0.884382351638131  LUMO = 0.671763423462581
  mo_energy =
[-3.28785022e+01 -1.96669978e+00 -8.84382352e-01 -8.84382352e-01
 -8.84382352e-01  6.71763423e-01  7.91076161e-01  7.91076161e-01
  7.91076161e-01  3.42196475e+00  3.83283482e+00  3.83283482e+00
  3.83283482e+00  1.09546294e+01  1.41209111e+01  1.41209111e+01
  1.41209111e+01  3.87443940e+01  5.26805282e+01  5.26805282e+01
  5.26805282e+01  1.42090417e+02  2.40456940e+02  2.40456940e+02
  2.40456940e+02  5.04778507e+02  1.87117739e+03  8.00038279e+03
  4.77678911e+04]
E1 = -182.8472550771407  E_coul = 54.30650804287653
cycle= 2 E= -128.540747034264  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263865
diis-c [-6.55018887e-04  3.36088205e-01  6.63911795e-01]
  HOMO = -0.848709617669225  LUMO = 0.679615348866849
  mo_energy =
[-3.27702889e+01 -1.92913525e+00 -8.48709618e-01 -8.48709618e-01
 -8.48709618e-01  6.79615349e-01  7.99732705e-01  7.99732705e-01
  7.99732705e-01  3.44308977e+00  3.86438179e+00  3.86438179e+00
  3.86438179e+00  1.09997330e+01  1.41841764e+01  1.41841764e+01
  1.41841764e+01  3.88263097e+01  5.27746671e+01  5.27746671e+01
  5.27746671e+01  1.42196212e+02  2.40570730e+02  2.40570730e+02
  2.40570730e+02  5.04895379e+02  1.87129958e+03  8.00050744e+03
  4.77680166e+04]
E1 = -182.58826799511948  E_coul = 54.04659897484868
cycle= 3 E= -128.541669020271  delta_E= -0.000922  |g|= 0.000522  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011768
diis-c [-2.07753823e-07 -2.35221639e-03 -5.12960578e-04  1.00286518e+00]
  HOMO = -0.848971617577697  LUMO = 0.679569643614874
  mo_energy =
[-3.27707644e+01 -1.92933312e+00 -8.48971618e-01 -8.48971618e-01
 -8.48971618e-01  6.79569644e-01  7.99692301e-01  7.99692301e-01
  7.99692301e-01  3.44296966e+00  3.86420095e+00  3.86420095e+00
  3.86420095e+00  1.09994954e+01  1.41838615e+01  1.41838615e+01
  1.41838615e+01  3.88259434e+01  5.27742478e+01  5.27742478e+01
  5.27742478e+01  1.42195735e+02  2.40570182e+02  2.40570182e+02
  2.40570182e+02  5.04894772e+02  1.87129883e+03  8.00050659e+03
  4.77680158e+04]
E1 = -182.588756511554  E_coul = 54.04708746417886
cycle= 4 E= -128.541669047375  delta_E= -2.71e-08  |g|= 7.98e-05  |ddm|= 0.000379
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000184573
diis-c [-1.08656080e-09  2.38986848e-04  4.58943162e-04 -1.86146606e-01
  1.18544868e+00]
  HOMO = -0.849014497422527  LUMO = 0.679558416074676
  mo_energy =
[-3.27708369e+01 -1.92936539e+00 -8.49014497e-01 -8.49014497e-01
 -8.49014497e-01  6.79558416e-01  7.99678995e-01  7.99678995e-01
  7.99678995e-01  3.44294343e+00  3.86416116e+00  3.86416116e+00
  3.86416116e+00  1.09994483e+01  1.41838025e+01  1.41838025e+01
  1.41838025e+01  3.88258792e+01  5.27741792e+01  5.27741792e+01
  5.27741792e+01  1.42195662e+02  2.40570105e+02  2.40570105e+02
  2.40570105e+02  5.04894691e+02  1.87129874e+03  8.00050650e+03
  4.77680157e+04]
E1 = -182.58888682952565  E_coul = 54.047217781423576
cycle= 5 E= -128.541669048102  delta_E= -7.27e-10  |g|= 5.87e-06  |ddm|= 6.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58888682952565  E_coul = 54.047217781423576
  HOMO = -0.849011410446661  LUMO = 0.679559534801591
  mo_energy =
[-3.27708299e+01 -1.92936151e+00 -8.49011410e-01 -8.49011410e-01
 -8.49011410e-01  6.79559535e-01  7.99679887e-01  7.99679887e-01
  7.99679887e-01  3.44294580e+00  3.86416410e+00  3.86416410e+00
  3.86416410e+00  1.09994525e+01  1.41838075e+01  1.41838075e+01
  1.41838075e+01  3.88258854e+01  5.27741858e+01  5.27741858e+01
  5.27741858e+01  1.42195669e+02  2.40570112e+02  2.40570112e+02
  2.40570112e+02  5.04894698e+02  1.87129875e+03  8.00050650e+03
  4.77680157e+04]
E1 = -182.58887078870382  E_coul = 54.04720174059963
Extra cycle  E= -128.541669048104  delta_E= -2.1e-12  |g|= 2.25e-06  |ddm|= 1.9e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [6.94180814e-01 2.44137942e+04 3.66145158e+03 8.33319171e+02
 2.35443099e+02 7.61303205e+01 1.00771926e+01 2.69327440e+01
 2.95875971e-01 1.49444648e+00 2.89703107e+00 7.11541408e+00
 2.31708259e+01 9.97863557e+01 2.64421735e-01 2.43395623e+00
 8.27693752e-01]
E = -128.54166904810418
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:51:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.69418081428        1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.45157851        1
[INPUT] 0    0    [1    /1   ]  833.319170937        1
[INPUT] 0    0    [1    /1   ]  235.443098919        1
[INPUT] 0    0    [1    /1   ]  76.1303204856        1
[INPUT] 0    0    [1    /1   ]  10.0771925773        1
[INPUT] 0    0    [1    /1   ]  26.9327440421        1
[INPUT] 0    0    [1    /1   ]  0.29587597082        1
[INPUT] 0    0    [1    /1   ]  1.49444648346        1
[INPUT] 0    0    [1    /1   ]  2.89703106678        1
[INPUT] 1    0    [1    /1   ]  7.11541408262        1
[INPUT] 1    0    [1    /1   ]  23.1708259157        1
[INPUT] 1    0    [1    /1   ]  99.7863556881        1
[INPUT] 1    0    [1    /1   ]  0.264421735302       1
[INPUT] 1    0    [1    /1   ]  2.43395622943        1
[INPUT] 1    0    [1    /1   ]  0.827693752261       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.6941808142795931, 1.0]], [0, [24413.794186398947, 1.0]], [0, [3661.451578511392, 1.0]], [0, [833.3191709367908, 1.0]], [0, [235.44309891890128, 1.0]], [0, [76.13032048563345, 1.0]], [0, [10.07719257729787, 1.0]], [0, [26.93274404213071, 1.0]], [0, [0.29587597081955985, 1.0]], [0, [1.4944464834625741, 1.0]], [0, [2.897031066784975, 1.0]], [1, [7.115414082624664, 1.0]], [1, [23.170825915747887, 1.0]], [1, [99.78635568809004, 1.0]], [1, [0.26442173530233565, 1.0]], [1, [2.433956229428311, 1.0]], [1, [0.8276937522607098, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.69418081]
bas 1, expnt(s) = [24413.7941864]
bas 2, expnt(s) = [3661.45157851]
bas 3, expnt(s) = [833.31917094]
bas 4, expnt(s) = [235.44309892]
bas 5, expnt(s) = [76.13032049]
bas 6, expnt(s) = [10.07719258]
bas 7, expnt(s) = [26.93274404]
bas 8, expnt(s) = [0.29587597]
bas 9, expnt(s) = [1.49444648]
bas 10, expnt(s) = [2.89703107]
bas 11, expnt(s) = [7.11541408]
bas 12, expnt(s) = [23.17082592]
bas 13, expnt(s) = [99.78635569]
bas 14, expnt(s) = [0.26442174]
bas 15, expnt(s) = [2.43395623]
bas 16, expnt(s) = [0.82769375]
CPU time:        57.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 6.94180814e-01 1.92140749e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319171e+02 3.91853341e+02
 2.35443099e+02 1.51855141e+02 7.61303205e+01 6.51153333e+01
 1.00771926e+01 1.42895875e+01 2.69327440e+01 2.98693297e+01
 2.95875971e-01 1.01355494e+00 1.49444648e+00 3.41487884e+00
 2.89703107e+00 5.61021995e+00 7.11541408e+00 3.39027257e+01
 2.31708259e+01 1.48306876e+02 9.97863557e+01 9.20075243e+02
 2.64421735e-01 5.53166449e-01 2.43395623e+00 8.86901414e+00
 8.27693752e-01 2.30314610e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999648524589642
cond(S) = 1467.0018312179568
E1 = -183.58993296026986  E_coul = 55.08009646680934
init E= -128.509836493461
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775412708911014  LUMO = 0.696260386396123
  mo_energy =
[-3.25551096e+01 -1.85273628e+00 -7.75412709e-01 -7.75412709e-01
 -7.75412709e-01  6.96260386e-01  8.17593523e-01  8.17593523e-01
  8.17593523e-01  3.48739491e+00  3.93001730e+00  3.93001730e+00
  3.93001730e+00  1.10920579e+01  1.43117922e+01  1.43117922e+01
  1.43117922e+01  3.89889135e+01  5.29617029e+01  5.29617029e+01
  5.29617029e+01  1.42407380e+02  2.40803511e+02  2.40803511e+02
  2.40803511e+02  5.05140072e+02  1.87157522e+03  8.00080972e+03
  4.77683369e+04]
E1 = -182.08493476712735  E_coul = 53.546779045262156
cycle= 1 E= -128.538155721865  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519415
diis-c [-0.269792  1.      ]
  HOMO = -0.884382351638131  LUMO = 0.671763423462581
  mo_energy =
[-3.28785022e+01 -1.96669978e+00 -8.84382352e-01 -8.84382352e-01
 -8.84382352e-01  6.71763423e-01  7.91076161e-01  7.91076161e-01
  7.91076161e-01  3.42196475e+00  3.83283482e+00  3.83283482e+00
  3.83283482e+00  1.09546294e+01  1.41209111e+01  1.41209111e+01
  1.41209111e+01  3.87443940e+01  5.26805282e+01  5.26805282e+01
  5.26805282e+01  1.42090417e+02  2.40456940e+02  2.40456940e+02
  2.40456940e+02  5.04778507e+02  1.87117739e+03  8.00038279e+03
  4.77678911e+04]
E1 = -182.8472550771407  E_coul = 54.30650804287653
cycle= 2 E= -128.540747034264  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263865
diis-c [-6.55018887e-04  3.36088205e-01  6.63911795e-01]
  HOMO = -0.848709617669225  LUMO = 0.679615348866849
  mo_energy =
[-3.27702889e+01 -1.92913525e+00 -8.48709618e-01 -8.48709618e-01
 -8.48709618e-01  6.79615349e-01  7.99732705e-01  7.99732705e-01
  7.99732705e-01  3.44308977e+00  3.86438179e+00  3.86438179e+00
  3.86438179e+00  1.09997330e+01  1.41841764e+01  1.41841764e+01
  1.41841764e+01  3.88263097e+01  5.27746671e+01  5.27746671e+01
  5.27746671e+01  1.42196212e+02  2.40570730e+02  2.40570730e+02
  2.40570730e+02  5.04895379e+02  1.87129958e+03  8.00050744e+03
  4.77680166e+04]
E1 = -182.58826799511948  E_coul = 54.04659897484868
cycle= 3 E= -128.541669020271  delta_E= -0.000922  |g|= 0.000522  |ddm|= 0.0217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0011768
diis-c [-2.07753823e-07 -2.35221639e-03 -5.12960578e-04  1.00286518e+00]
  HOMO = -0.848971617577697  LUMO = 0.679569643614874
  mo_energy =
[-3.27707644e+01 -1.92933312e+00 -8.48971618e-01 -8.48971618e-01
 -8.48971618e-01  6.79569644e-01  7.99692301e-01  7.99692301e-01
  7.99692301e-01  3.44296966e+00  3.86420095e+00  3.86420095e+00
  3.86420095e+00  1.09994954e+01  1.41838615e+01  1.41838615e+01
  1.41838615e+01  3.88259434e+01  5.27742478e+01  5.27742478e+01
  5.27742478e+01  1.42195735e+02  2.40570182e+02  2.40570182e+02
  2.40570182e+02  5.04894772e+02  1.87129883e+03  8.00050659e+03
  4.77680158e+04]
E1 = -182.588756511554  E_coul = 54.04708746417886
cycle= 4 E= -128.541669047375  delta_E= -2.71e-08  |g|= 7.98e-05  |ddm|= 0.000379
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000184573
diis-c [-1.08656080e-09  2.38986848e-04  4.58943162e-04 -1.86146606e-01
  1.18544868e+00]
  HOMO = -0.849014497422527  LUMO = 0.679558416074676
  mo_energy =
[-3.27708369e+01 -1.92936539e+00 -8.49014497e-01 -8.49014497e-01
 -8.49014497e-01  6.79558416e-01  7.99678995e-01  7.99678995e-01
  7.99678995e-01  3.44294343e+00  3.86416116e+00  3.86416116e+00
  3.86416116e+00  1.09994483e+01  1.41838025e+01  1.41838025e+01
  1.41838025e+01  3.88258792e+01  5.27741792e+01  5.27741792e+01
  5.27741792e+01  1.42195662e+02  2.40570105e+02  2.40570105e+02
  2.40570105e+02  5.04894691e+02  1.87129874e+03  8.00050650e+03
  4.77680157e+04]
E1 = -182.58888682952565  E_coul = 54.047217781423576
cycle= 5 E= -128.541669048102  delta_E= -7.27e-10  |g|= 5.87e-06  |ddm|= 6.73e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58888682952565  E_coul = 54.047217781423576
  HOMO = -0.849011410446661  LUMO = 0.679559534801591
  mo_energy =
[-3.27708299e+01 -1.92936151e+00 -8.49011410e-01 -8.49011410e-01
 -8.49011410e-01  6.79559535e-01  7.99679887e-01  7.99679887e-01
  7.99679887e-01  3.44294580e+00  3.86416410e+00  3.86416410e+00
  3.86416410e+00  1.09994525e+01  1.41838075e+01  1.41838075e+01
  1.41838075e+01  3.88258854e+01  5.27741858e+01  5.27741858e+01
  5.27741858e+01  1.42195669e+02  2.40570112e+02  2.40570112e+02
  2.40570112e+02  5.04894698e+02  1.87129875e+03  8.00050650e+03
  4.77680157e+04]
E1 = -182.58887078870382  E_coul = 54.04720174059963
Extra cycle  E= -128.541669048104  delta_E= -2.1e-12  |g|= 2.25e-06  |ddm|= 1.9e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1467.0018312179568
E1 = -182.58887078870382  E_coul = 54.04720174059963
init E= -128.541669048104
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.84901254711091  LUMO = 0.679559356097692
  mo_energy =
[-3.27708334e+01 -1.92936257e+00 -8.49012547e-01 -8.49012547e-01
 -8.49012547e-01  6.79559356e-01  7.99679628e-01  7.99679628e-01
  7.99679628e-01  3.44294521e+00  3.86416312e+00  3.86416312e+00
  3.86416312e+00  1.09994511e+01  1.41838055e+01  1.41838055e+01
  1.41838055e+01  3.88258827e+01  5.27741827e+01  5.27741827e+01
  5.27741827e+01  1.42195666e+02  2.40570108e+02  2.40570108e+02
  2.40570108e+02  5.04894694e+02  1.87129874e+03  8.00050650e+03
  4.77680157e+04]
E1 = -182.58887965647253  E_coul = 54.04721060836778
cycle= 1 E= -128.541669048105  delta_E= -5.68e-13  |g|= 1.22e-06  |ddm|= 8.02e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
E1 = -182.58887965647253  E_coul = 54.04721060836778
  HOMO = -0.849011923030849  LUMO = 0.679559507807898
  mo_energy =
[-3.27708316e+01 -1.92936188e+00 -8.49011923e-01 -8.49011923e-01
 -8.49011923e-01  6.79559508e-01  7.99679783e-01  7.99679783e-01
  7.99679783e-01  3.44294560e+00  3.86416368e+00  3.86416368e+00
  3.86416368e+00  1.09994519e+01  1.41838066e+01  1.41838066e+01
  1.41838066e+01  3.88258842e+01  5.27741844e+01  5.27741844e+01
  5.27741844e+01  1.42195668e+02  2.40570110e+02  2.40570110e+02
  2.40570110e+02  5.04894696e+02  1.87129875e+03  8.00050650e+03
  4.77680157e+04]
E1 = -182.5888751937764  E_coul = 54.04720614567149
Extra cycle  E= -128.541669048105  delta_E= -1.71e-13  |g|= 6.06e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [6.94180814e-01 2.44137942e+04 3.66145158e+03 8.33319171e+02
 2.35443099e+02 7.61303205e+01 1.00771926e+01 2.69327440e+01
 2.95875971e-01 1.49444648e+00 2.89703107e+00 7.11541408e+00
 2.31708259e+01 9.97863557e+01 2.64421735e-01 2.43395623e+00
 8.27693752e-01]
grad_E = [-3.10593137e-04  1.53503756e-11  2.17705732e-10 -5.82260039e-08
  1.18161041e-06 -3.78138810e-06 -4.03272775e-04  6.14451975e-05
  1.04144621e-03  4.36607273e-05 -1.15043134e-04  7.78277387e-05
 -1.34490281e-05  5.57044999e-07  1.43200014e-03  2.46280125e-04
 -1.67747961e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.755966187821       1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.4515808         1
[INPUT] 0    0    [1    /1   ]  833.319139447        1
[INPUT] 0    0    [1    /1   ]  235.443330012        1
[INPUT] 0    0    [1    /1   ]  76.1273576957        1
[INPUT] 0    0    [1    /1   ]  10.1008879419        1
[INPUT] 0    0    [1    /1   ]  26.9385175095        1
[INPUT] 0    0    [1    /1   ]  0.290371226941       1
[INPUT] 0    0    [1    /1   ]  1.60546682742        1
[INPUT] 0    0    [1    /1   ]  2.91351331554        1
[INPUT] 1    0    [1    /1   ]  7.11580826928        1
[INPUT] 1    0    [1    /1   ]  23.1707912246        1
[INPUT] 1    0    [1    /1   ]  99.7863498779        1
[INPUT] 1    0    [1    /1   ]  0.264124453922       1
[INPUT] 1    0    [1    /1   ]  2.43060776763        1
[INPUT] 1    0    [1    /1   ]  0.828746063993       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7559661878214632, 1.0]], [0, [24413.79418635032, 1.0]], [0, [3661.451580798929, 1.0]], [0, [833.31913944728, 1.0]], [0, [235.44333001237348, 1.0]], [0, [76.12735769573007, 1.0]], [0, [10.100887941914962, 1.0]], [0, [26.938517509502528, 1.0]], [0, [0.29037122694106776, 1.0]], [0, [1.605466827423127, 1.0]], [0, [2.9135133155428483, 1.0]], [1, [7.115808269279198, 1.0]], [1, [23.170791224614202, 1.0]], [1, [99.78634987792346, 1.0]], [1, [0.26412445392233835, 1.0]], [1, [2.4306077676268387, 1.0]], [1, [0.8287460639934383, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.75596619]
bas 1, expnt(s) = [24413.79418635]
bas 2, expnt(s) = [3661.4515808]
bas 3, expnt(s) = [833.31913945]
bas 4, expnt(s) = [235.44333001]
bas 5, expnt(s) = [76.1273577]
bas 6, expnt(s) = [10.10088794]
bas 7, expnt(s) = [26.93851751]
bas 8, expnt(s) = [0.29037123]
bas 9, expnt(s) = [1.60546683]
bas 10, expnt(s) = [2.91351332]
bas 11, expnt(s) = [7.11580827]
bas 12, expnt(s) = [23.17079122]
bas 13, expnt(s) = [99.78634988]
bas 14, expnt(s) = [0.26412445]
bas 15, expnt(s) = [2.43060777]
bas 16, expnt(s) = [0.82874606]
CPU time:        61.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.55966188e-01 2.04829169e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319139e+02 3.91853330e+02
 2.35443330e+02 1.51855252e+02 7.61273577e+01 6.51134327e+01
 1.01008879e+01 1.43147804e+01 2.69385175e+01 2.98741318e+01
 2.90371227e-01 9.99378976e-01 1.60546683e+00 3.60342947e+00
 2.91351332e+00 5.63414189e+00 7.11580827e+00 3.39050735e+01
 2.31707912e+01 1.48306598e+02 9.97863499e+01 9.20075176e+02
 2.64124454e-01 5.52389173e-01 2.43060777e+00 8.85376508e+00
 8.28746064e-01 2.30680690e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999644151484969
cond(S) = 1757.6169297687334
E1 = -183.5899681713439  E_coul = 55.08023469256631
init E= -128.509733478778
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775404916342921  LUMO = 0.716272937721846
  mo_energy =
[-3.25550718e+01 -1.85271725e+00 -7.75404916e-01 -7.75404916e-01
 -7.75404916e-01  7.16272938e-01  8.17156469e-01  8.17156469e-01
  8.17156469e-01  3.69177184e+00  3.92966139e+00  3.92966139e+00
  3.92966139e+00  1.16386883e+01  1.43060602e+01  1.43060602e+01
  1.43060602e+01  3.97942085e+01  5.29539424e+01  5.29539424e+01
  5.29539424e+01  1.43235870e+02  2.40797683e+02  2.40797683e+02
  2.40797683e+02  5.05905027e+02  1.87226208e+03  8.00141406e+03
  4.77688372e+04]
E1 = -182.08290302432974  E_coul = 53.54477353344341
cycle= 1 E= -128.538129490886  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519261
diis-c [-0.26963189  1.        ]
  HOMO = -0.884567536251437  LUMO = 0.690537664665644
  mo_energy =
[-3.28787913e+01 -1.96684965e+00 -8.84567536e-01 -8.84567536e-01
 -8.84567536e-01  6.90537665e-01  7.90527215e-01  7.90527215e-01
  7.90527215e-01  3.62272380e+00  3.83233711e+00  3.83233711e+00
  3.83233711e+00  1.14987165e+01  1.41149254e+01  1.41149254e+01
  1.41149254e+01  3.95493664e+01  5.26724523e+01  5.26724523e+01
  5.26724523e+01  1.42918732e+02  2.40450801e+02  2.40450801e+02
  2.40450801e+02  5.05543184e+02  1.87186394e+03  8.00098680e+03
  4.77683910e+04]
E1 = -182.84585336320725  E_coul = 54.30512837917617
cycle= 2 E= -128.540724984031  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263803
diis-c [-6.60134733e-04  3.36095334e-01  6.63904666e-01]
  HOMO = -0.848867120187458  LUMO = 0.69875610314785
  mo_energy =
[-3.27704849e+01 -1.92925521e+00 -8.48867120e-01 -8.48867120e-01
 -8.48867120e-01  6.98756103e-01  7.99191666e-01  7.99191666e-01
  7.99191666e-01  3.64499533e+00  3.86389870e+00  3.86389870e+00
  3.86389870e+00  1.15446357e+01  1.41782297e+01  1.41782297e+01
  1.41782297e+01  3.96313458e+01  5.27666735e+01  5.27666735e+01
  5.27666735e+01  1.43024566e+02  2.40564689e+02  2.40564689e+02
  2.40564689e+02  5.05660139e+02  1.87198622e+03  8.00111155e+03
  4.77685167e+04]
E1 = -182.58639201754255  E_coul = 54.04474276109595
cycle= 3 E= -128.541649256447  delta_E= -0.000924  |g|= 0.000566  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.00123833
diis-c [-2.29613403e-07 -2.43993144e-03 -4.67195642e-04  1.00290713e+00]
  HOMO = -0.849147797206586  LUMO = 0.69869997894592
  mo_energy =
[-3.27709891e+01 -1.92947014e+00 -8.49147797e-01 -8.49147797e-01
 -8.49147797e-01  6.98699979e-01  7.99143686e-01  7.99143686e-01
  7.99143686e-01  3.64485372e+00  3.86370007e+00  3.86370007e+00
  3.86370007e+00  1.15443724e+01  1.41778895e+01  1.41778895e+01
  1.41778895e+01  3.96309527e+01  5.27662269e+01  5.27662269e+01
  5.27662269e+01  1.43024060e+02  2.40564111e+02  2.40564111e+02
  2.40564111e+02  5.05659503e+02  1.87198545e+03  8.00111067e+03
  4.77685158e+04]
E1 = -182.5868981997018  E_coul = 54.045248910767604
cycle= 4 E= -128.541649288934  delta_E= -3.25e-08  |g|= 8.56e-05  |ddm|= 0.000467
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000193806
diis-c [-1.12300165e-09  2.39993185e-04  4.59334000e-04 -1.86081929e-01
  1.18538260e+00]
  HOMO = -0.849193997068836  LUMO = 0.698686942740506
  mo_energy =
[-3.27710663e+01 -1.92950539e+00 -8.49193997e-01 -8.49193997e-01
 -8.49193997e-01  6.98686943e-01  7.99129138e-01  7.99129138e-01
  7.99129138e-01  3.64482358e+00  3.86365706e+00  3.86365706e+00
  3.86365706e+00  1.15443208e+01  1.41778261e+01  1.41778261e+01
  1.41778261e+01  3.96308840e+01  5.27661537e+01  5.27661537e+01
  5.27661537e+01  1.43023983e+02  2.40564029e+02  2.40564029e+02
  2.40564029e+02  5.05659417e+02  1.87198536e+03  8.00111057e+03
  4.77685157e+04]
E1 = -182.58703214049228  E_coul = 54.04538285072508
cycle= 5 E= -128.541649289767  delta_E= -8.33e-10  |g|= 6e-06  |ddm|= 7.74e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58703214049228  E_coul = 54.04538285072508
  HOMO = -0.849190859003045  LUMO = 0.698688146270888
  mo_energy =
[-3.27710592e+01 -1.92950144e+00 -8.49190859e-01 -8.49190859e-01
 -8.49190859e-01  6.98688146e-01  7.99130058e-01  7.99130058e-01
  7.99130058e-01  3.64482611e+00  3.86366005e+00  3.86366005e+00
  3.86366005e+00  1.15443251e+01  1.41778313e+01  1.41778313e+01
  1.41778313e+01  3.96308902e+01  5.27661604e+01  5.27661604e+01
  5.27661604e+01  1.43023990e+02  2.40564036e+02  2.40564036e+02
  2.40564036e+02  5.05659423e+02  1.87198536e+03  8.00111058e+03
  4.77685157e+04]
E1 = -182.587016172577  E_coul = 54.04536688280737
Extra cycle  E= -128.54164928977  delta_E= -2.42e-12  |g|= 2.25e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.55966188e-01 2.44137942e+04 3.66145158e+03 8.33319139e+02
 2.35443330e+02 7.61273577e+01 1.01008879e+01 2.69385175e+01
 2.90371227e-01 1.60546683e+00 2.91351332e+00 7.11580827e+00
 2.31707912e+01 9.97863499e+01 2.64124454e-01 2.43060777e+00
 8.28746064e-01]
E = -128.54164928976962
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.713749930826       1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.45157924        1
[INPUT] 0    0    [1    /1   ]  833.319160963        1
[INPUT] 0    0    [1    /1   ]  235.443172113        1
[INPUT] 0    0    [1    /1   ]  76.1293820891        1
[INPUT] 0    0    [1    /1   ]  10.0846975469        1
[INPUT] 0    0    [1    /1   ]  26.9345726571        1
[INPUT] 0    0    [1    /1   ]  0.294132467975       1
[INPUT] 0    0    [1    /1   ]  1.52960966085        1
[INPUT] 0    0    [1    /1   ]  2.90225144547        1
[INPUT] 1    0    [1    /1   ]  7.11553893231        1
[INPUT] 1    0    [1    /1   ]  23.1708149281        1
[INPUT] 1    0    [1    /1   ]  99.7863538479        1
[INPUT] 1    0    [1    /1   ]  0.264327578164       1
[INPUT] 1    0    [1    /1   ]  2.43289568005        1
[INPUT] 1    0    [1    /1   ]  0.828027048149       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7137499308257944, 1.0]], [0, [24413.794186383544, 1.0]], [0, [3661.4515792359175, 1.0]], [0, [833.3191609632021, 1.0]], [0, [235.44317211252027, 1.0]], [0, [76.12938208909074, 1.0]], [0, [10.084697546924417, 1.0]], [0, [26.93457265705036, 1.0]], [0, [0.2941324679751172, 1.0]], [0, [1.5296096608526264, 1.0]], [0, [2.9022514454667956, 1.0]], [1, [7.1155389323122415, 1.0]], [1, [23.170814928117654, 1.0]], [1, [99.78635384785147, 1.0]], [1, [0.2643275781638627, 1.0]], [1, [2.4328956800541275, 1.0]], [1, [0.8280270481487203, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.71374993]
bas 1, expnt(s) = [24413.79418638]
bas 2, expnt(s) = [3661.45157924]
bas 3, expnt(s) = [833.31916096]
bas 4, expnt(s) = [235.44317211]
bas 5, expnt(s) = [76.12938209]
bas 6, expnt(s) = [10.08469755]
bas 7, expnt(s) = [26.93457266]
bas 8, expnt(s) = [0.29413247]
bas 9, expnt(s) = [1.52960966]
bas 10, expnt(s) = [2.90225145]
bas 11, expnt(s) = [7.11553893]
bas 12, expnt(s) = [23.17081493]
bas 13, expnt(s) = [99.78635385]
bas 14, expnt(s) = [0.26432758]
bas 15, expnt(s) = [2.43289568]
bas 16, expnt(s) = [0.82802705]
CPU time:        61.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.13749931e-01 1.96188968e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319161e+02 3.91853338e+02
 2.35443172e+02 1.51855176e+02 7.61293821e+01 6.51147313e+01
 1.00846975e+01 1.42975684e+01 2.69345727e+01 2.98708507e+01
 2.94132468e-01 1.00907222e+00 1.52960966e+00 3.47496542e+00
 2.90225145e+00 5.61780036e+00 7.11553893e+00 3.39034693e+01
 2.31708149e+01 1.48306788e+02 9.97863538e+01 9.20075222e+02
 2.64327578e-01 5.52920241e-01 2.43289568e+00 8.86418378e+00
 8.28027048e-01 2.30430545e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99964948380979
cond(S) = 1547.7157836023757
E1 = -183.58998021903906  E_coul = 55.080140143168634
init E= -128.50984007587
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775410205264365  LUMO = 0.702941922785938
  mo_energy =
[-3.25550986e+01 -1.85273623e+00 -7.75410205e-01 -7.75410205e-01
 -7.75410205e-01  7.02941923e-01  8.17457029e-01  8.17457029e-01
  8.17457029e-01  3.55271887e+00  3.92990568e+00  3.92990568e+00
  3.92990568e+00  1.12663807e+01  1.43099757e+01  1.43099757e+01
  1.43099757e+01  3.92444886e+01  5.29592446e+01  5.29592446e+01
  5.29592446e+01  1.42669597e+02  2.40801664e+02  2.40801664e+02
  2.40801664e+02  5.05382018e+02  1.87179243e+03  8.00100083e+03
  4.77684951e+04]
E1 = -182.08431239887983  E_coul = 53.54615235039106
cycle= 1 E= -128.538160048489  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.519364
diis-c [-0.26973902  1.        ]
  HOMO = -0.884439392445334  LUMO = 0.678044516375492
  mo_energy =
[-3.28785965e+01 -1.96675142e+00 -8.84439392e-01 -8.84439392e-01
 -8.84439392e-01  6.78044516e-01  7.90905372e-01  7.90905372e-01
  7.90905372e-01  3.48613199e+00  3.83267854e+00  3.83267854e+00
  3.83267854e+00  1.11281413e+01  1.41190162e+01  1.41190162e+01
  1.41190162e+01  3.89998720e+01  5.26779692e+01  5.26779692e+01
  5.26779692e+01  1.42352578e+02  2.40454991e+02  2.40454991e+02
  2.40454991e+02  5.05020363e+02  1.87139450e+03  8.00057379e+03
  4.77680492e+04]
E1 = -182.84684683172895  E_coul = 54.306094110550646
cycle= 2 E= -128.540752721178  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263844
diis-c [-6.56568147e-04  3.36089874e-01  6.63910126e-01]
  HOMO = -0.848757051938023  LUMO = 0.686015794779158
  mo_energy =
[-3.27703520e+01 -1.92917663e+00 -8.48757052e-01 -8.48757052e-01
 -8.48757052e-01  6.86015795e-01  7.99564619e-01  7.99564619e-01
  7.99564619e-01  3.50762489e+00  3.86423092e+00  3.86423092e+00
  3.86423092e+00  1.11735068e+01  1.41822951e+01  1.41822951e+01
  1.41822951e+01  3.90818079e+01  5.27721358e+01  5.27721358e+01
  5.27721358e+01  1.42458387e+02  2.40568815e+02  2.40568815e+02
  2.40568815e+02  5.05137262e+02  1.87151672e+03  8.00069847e+03
  4.77681748e+04]
E1 = -182.58771076057948  E_coul = 54.04603531647529
cycle= 3 E= -128.541675444104  delta_E= -0.000923  |g|= 0.000535  |ddm|= 0.0217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119512
diis-c [-2.13841746e-07 -2.37673263e-03 -4.95594793e-04  1.00287233e+00]
  HOMO = -0.849024482271367  LUMO = 0.685967021029776
  mo_energy =
[-3.27708360e+01 -1.92937951e+00 -8.49024482e-01 -8.49024482e-01
 -8.49024482e-01  6.85967021e-01  7.99522010e-01  7.99522010e-01
  7.99522010e-01  3.50749845e+00  3.86404489e+00  3.86404489e+00
  3.86404489e+00  1.11732616e+01  1.41819728e+01  1.41819728e+01
  1.41819728e+01  3.90814337e+01  5.27717084e+01  5.27717084e+01
  5.27717084e+01  1.42457901e+02  2.40568257e+02  2.40568257e+02
  2.40568257e+02  5.05136647e+02  1.87151596e+03  8.00069761e+03
  4.77681739e+04]
E1 = -182.58820479467616  E_coul = 54.0465293219871
cycle= 4 E= -128.541675472689  delta_E= -2.86e-08  |g|= 8.15e-05  |ddm|= 0.000402
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187292
diis-c [-1.09453413e-09  2.38903428e-04  4.58765794e-04 -1.85987949e-01
  1.18529028e+00]
  HOMO = -0.849068328580107  LUMO = 0.685955252993509
  mo_energy =
[-3.27709099e+01 -1.92941267e+00 -8.49068329e-01 -8.49068329e-01
 -8.49068329e-01  6.85955253e-01  7.99508342e-01  7.99508342e-01
  7.99508342e-01  3.50747107e+00  3.86400416e+00  3.86400416e+00
  3.86400416e+00  1.11732132e+01  1.41819125e+01  1.41819125e+01
  1.41819125e+01  3.90813682e+01  5.27716385e+01  5.27716385e+01
  5.27716385e+01  1.42457827e+02  2.40568179e+02  2.40568179e+02
  2.40568179e+02  5.05136565e+02  1.87151587e+03  8.00069751e+03
  4.77681738e+04]
E1 = -182.5883362162745  E_coul = 54.04666074282921
cycle= 5 E= -128.541675473445  delta_E= -7.56e-10  |g|= 5.9e-06  |ddm|= 6.98e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5883362162745  E_coul = 54.04666074282921
  HOMO = -0.84906523228081  LUMO = 0.685956395770416
  mo_energy =
[-3.27709029e+01 -1.92940877e+00 -8.49065232e-01 -8.49065232e-01
 -8.49065232e-01  6.85956396e-01  7.99509240e-01  7.99509240e-01
  7.99509240e-01  3.50747348e+00  3.86400711e+00  3.86400711e+00
  3.86400711e+00  1.11732174e+01  1.41819176e+01  1.41819176e+01
  1.41819176e+01  3.90813743e+01  5.27716450e+01  5.27716450e+01
  5.27716450e+01  1.42457834e+02  2.40568186e+02  2.40568186e+02
  2.40568186e+02  5.05136571e+02  1.87151588e+03  8.00069752e+03
  4.77681738e+04]
E1 = -182.58832021404714  E_coul = 54.04664474059918
Extra cycle  E= -128.541675473448  delta_E= -2.67e-12  |g|= 2.25e-06  |ddm|= 1.95e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [7.13749931e-01 2.44137942e+04 3.66145158e+03 8.33319161e+02
 2.35443172e+02 7.61293821e+01 1.00846975e+01 2.69345727e+01
 2.94132468e-01 1.52960966e+00 2.90225145e+00 7.11553893e+00
 2.31708149e+01 9.97863538e+01 2.64327578e-01 2.43289568e+00
 8.28027048e-01]
E = -128.54167547344798
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.713749930826       1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.45157924        1
[INPUT] 0    0    [1    /1   ]  833.319160963        1
[INPUT] 0    0    [1    /1   ]  235.443172113        1
[INPUT] 0    0    [1    /1   ]  76.1293820891        1
[INPUT] 0    0    [1    /1   ]  10.0846975469        1
[INPUT] 0    0    [1    /1   ]  26.9345726571        1
[INPUT] 0    0    [1    /1   ]  0.294132467975       1
[INPUT] 0    0    [1    /1   ]  1.52960966085        1
[INPUT] 0    0    [1    /1   ]  2.90225144547        1
[INPUT] 1    0    [1    /1   ]  7.11553893231        1
[INPUT] 1    0    [1    /1   ]  23.1708149281        1
[INPUT] 1    0    [1    /1   ]  99.7863538479        1
[INPUT] 1    0    [1    /1   ]  0.264327578164       1
[INPUT] 1    0    [1    /1   ]  2.43289568005        1
[INPUT] 1    0    [1    /1   ]  0.828027048149       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7137499308257944, 1.0]], [0, [24413.794186383544, 1.0]], [0, [3661.4515792359175, 1.0]], [0, [833.3191609632021, 1.0]], [0, [235.44317211252027, 1.0]], [0, [76.12938208909074, 1.0]], [0, [10.084697546924417, 1.0]], [0, [26.93457265705036, 1.0]], [0, [0.2941324679751172, 1.0]], [0, [1.5296096608526264, 1.0]], [0, [2.9022514454667956, 1.0]], [1, [7.1155389323122415, 1.0]], [1, [23.170814928117654, 1.0]], [1, [99.78635384785147, 1.0]], [1, [0.2643275781638627, 1.0]], [1, [2.4328956800541275, 1.0]], [1, [0.8280270481487203, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.71374993]
bas 1, expnt(s) = [24413.79418638]
bas 2, expnt(s) = [3661.45157924]
bas 3, expnt(s) = [833.31916096]
bas 4, expnt(s) = [235.44317211]
bas 5, expnt(s) = [76.12938209]
bas 6, expnt(s) = [10.08469755]
bas 7, expnt(s) = [26.93457266]
bas 8, expnt(s) = [0.29413247]
bas 9, expnt(s) = [1.52960966]
bas 10, expnt(s) = [2.90225145]
bas 11, expnt(s) = [7.11553893]
bas 12, expnt(s) = [23.17081493]
bas 13, expnt(s) = [99.78635385]
bas 14, expnt(s) = [0.26432758]
bas 15, expnt(s) = [2.43289568]
bas 16, expnt(s) = [0.82802705]
CPU time:        61.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.13749931e-01 1.96188968e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319161e+02 3.91853338e+02
 2.35443172e+02 1.51855176e+02 7.61293821e+01 6.51147313e+01
 1.00846975e+01 1.42975684e+01 2.69345727e+01 2.98708507e+01
 2.94132468e-01 1.00907222e+00 1.52960966e+00 3.47496542e+00
 2.90225145e+00 5.61780036e+00 7.11553893e+00 3.39034693e+01
 2.31708149e+01 1.48306788e+02 9.97863538e+01 9.20075222e+02
 2.64327578e-01 5.52920241e-01 2.43289568e+00 8.86418378e+00
 8.28027048e-01 2.30430545e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99964948380979
cond(S) = 1547.7157836023757
E1 = -183.58998021903906  E_coul = 55.080140143168634
init E= -128.50984007587
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775410205264365  LUMO = 0.702941922785938
  mo_energy =
[-3.25550986e+01 -1.85273623e+00 -7.75410205e-01 -7.75410205e-01
 -7.75410205e-01  7.02941923e-01  8.17457029e-01  8.17457029e-01
  8.17457029e-01  3.55271887e+00  3.92990568e+00  3.92990568e+00
  3.92990568e+00  1.12663807e+01  1.43099757e+01  1.43099757e+01
  1.43099757e+01  3.92444886e+01  5.29592446e+01  5.29592446e+01
  5.29592446e+01  1.42669597e+02  2.40801664e+02  2.40801664e+02
  2.40801664e+02  5.05382018e+02  1.87179243e+03  8.00100083e+03
  4.77684951e+04]
E1 = -182.08431239887983  E_coul = 53.54615235039106
cycle= 1 E= -128.538160048489  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.145
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519364
diis-c [-0.26973902  1.        ]
  HOMO = -0.884439392445334  LUMO = 0.678044516375492
  mo_energy =
[-3.28785965e+01 -1.96675142e+00 -8.84439392e-01 -8.84439392e-01
 -8.84439392e-01  6.78044516e-01  7.90905372e-01  7.90905372e-01
  7.90905372e-01  3.48613199e+00  3.83267854e+00  3.83267854e+00
  3.83267854e+00  1.11281413e+01  1.41190162e+01  1.41190162e+01
  1.41190162e+01  3.89998720e+01  5.26779692e+01  5.26779692e+01
  5.26779692e+01  1.42352578e+02  2.40454991e+02  2.40454991e+02
  2.40454991e+02  5.05020363e+02  1.87139450e+03  8.00057379e+03
  4.77680492e+04]
E1 = -182.84684683172895  E_coul = 54.306094110550646
cycle= 2 E= -128.540752721178  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263844
diis-c [-6.56568147e-04  3.36089874e-01  6.63910126e-01]
  HOMO = -0.848757051938023  LUMO = 0.686015794779158
  mo_energy =
[-3.27703520e+01 -1.92917663e+00 -8.48757052e-01 -8.48757052e-01
 -8.48757052e-01  6.86015795e-01  7.99564619e-01  7.99564619e-01
  7.99564619e-01  3.50762489e+00  3.86423092e+00  3.86423092e+00
  3.86423092e+00  1.11735068e+01  1.41822951e+01  1.41822951e+01
  1.41822951e+01  3.90818079e+01  5.27721358e+01  5.27721358e+01
  5.27721358e+01  1.42458387e+02  2.40568815e+02  2.40568815e+02
  2.40568815e+02  5.05137262e+02  1.87151672e+03  8.00069847e+03
  4.77681748e+04]
E1 = -182.58771076057948  E_coul = 54.04603531647529
cycle= 3 E= -128.541675444104  delta_E= -0.000923  |g|= 0.000535  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119512
diis-c [-2.13841746e-07 -2.37673263e-03 -4.95594793e-04  1.00287233e+00]
  HOMO = -0.849024482271367  LUMO = 0.685967021029776
  mo_energy =
[-3.27708360e+01 -1.92937951e+00 -8.49024482e-01 -8.49024482e-01
 -8.49024482e-01  6.85967021e-01  7.99522010e-01  7.99522010e-01
  7.99522010e-01  3.50749845e+00  3.86404489e+00  3.86404489e+00
  3.86404489e+00  1.11732616e+01  1.41819728e+01  1.41819728e+01
  1.41819728e+01  3.90814337e+01  5.27717084e+01  5.27717084e+01
  5.27717084e+01  1.42457901e+02  2.40568257e+02  2.40568257e+02
  2.40568257e+02  5.05136647e+02  1.87151596e+03  8.00069761e+03
  4.77681739e+04]
E1 = -182.58820479467616  E_coul = 54.0465293219871
cycle= 4 E= -128.541675472689  delta_E= -2.86e-08  |g|= 8.15e-05  |ddm|= 0.000402
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187292
diis-c [-1.09453413e-09  2.38903428e-04  4.58765794e-04 -1.85987949e-01
  1.18529028e+00]
  HOMO = -0.849068328580107  LUMO = 0.685955252993509
  mo_energy =
[-3.27709099e+01 -1.92941267e+00 -8.49068329e-01 -8.49068329e-01
 -8.49068329e-01  6.85955253e-01  7.99508342e-01  7.99508342e-01
  7.99508342e-01  3.50747107e+00  3.86400416e+00  3.86400416e+00
  3.86400416e+00  1.11732132e+01  1.41819125e+01  1.41819125e+01
  1.41819125e+01  3.90813682e+01  5.27716385e+01  5.27716385e+01
  5.27716385e+01  1.42457827e+02  2.40568179e+02  2.40568179e+02
  2.40568179e+02  5.05136565e+02  1.87151587e+03  8.00069751e+03
  4.77681738e+04]
E1 = -182.5883362162745  E_coul = 54.04666074282921
cycle= 5 E= -128.541675473445  delta_E= -7.56e-10  |g|= 5.9e-06  |ddm|= 6.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5883362162745  E_coul = 54.04666074282921
  HOMO = -0.84906523228081  LUMO = 0.685956395770416
  mo_energy =
[-3.27709029e+01 -1.92940877e+00 -8.49065232e-01 -8.49065232e-01
 -8.49065232e-01  6.85956396e-01  7.99509240e-01  7.99509240e-01
  7.99509240e-01  3.50747348e+00  3.86400711e+00  3.86400711e+00
  3.86400711e+00  1.11732174e+01  1.41819176e+01  1.41819176e+01
  1.41819176e+01  3.90813743e+01  5.27716450e+01  5.27716450e+01
  5.27716450e+01  1.42457834e+02  2.40568186e+02  2.40568186e+02
  2.40568186e+02  5.05136571e+02  1.87151588e+03  8.00069752e+03
  4.77681738e+04]
E1 = -182.58832021404714  E_coul = 54.04664474059918
Extra cycle  E= -128.541675473448  delta_E= -2.67e-12  |g|= 2.25e-06  |ddm|= 1.95e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1547.7157836023757
E1 = -182.58832021404714  E_coul = 54.04664474059918
init E= -128.541675473448
    CPU time for initialize scf      0.37 sec, wall time      0.38 sec
  HOMO = -0.849066365806293  LUMO = 0.685956215942449
  mo_energy =
[-3.27709064e+01 -1.92940983e+00 -8.49066366e-01 -8.49066366e-01
 -8.49066366e-01  6.85956216e-01  7.99508982e-01  7.99508982e-01
  7.99508982e-01  3.50747288e+00  3.86400613e+00  3.86400613e+00
  3.86400613e+00  1.11732160e+01  1.41819156e+01  1.41819156e+01
  1.41819156e+01  3.90813717e+01  5.27716420e+01  5.27716420e+01
  5.27716420e+01  1.42457831e+02  2.40568182e+02  2.40568182e+02
  2.40568182e+02  5.05136567e+02  1.87151587e+03  8.00069752e+03
  4.77681738e+04]
E1 = -182.58832908081493  E_coul = 54.046653607366814
cycle= 1 E= -128.541675473448  delta_E= -1.42e-13  |g|= 1.21e-06  |ddm|= 8.04e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58832908081493  E_coul = 54.046653607366814
  HOMO = -0.849065741714251  LUMO = 0.68595637011221
  mo_energy =
[-3.27709046e+01 -1.92940914e+00 -8.49065742e-01 -8.49065742e-01
 -8.49065742e-01  6.85956370e-01  7.99509137e-01  7.99509137e-01
  7.99509137e-01  3.50747328e+00  3.86400669e+00  3.86400669e+00
  3.86400669e+00  1.11732168e+01  1.41819167e+01  1.41819167e+01
  1.41819167e+01  3.90813731e+01  5.27716436e+01  5.27716436e+01
  5.27716436e+01  1.42457833e+02  2.40568184e+02  2.40568184e+02
  2.40568184e+02  5.05136569e+02  1.87151588e+03  8.00069752e+03
  4.77681738e+04]
E1 = -182.58832462051865  E_coul = 54.04664914707061
Extra cycle  E= -128.541675473448  delta_E= 8.53e-14  |g|= 6.06e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.44 sec, wall time      0.45 sec
exp = [7.13749931e-01 2.44137942e+04 3.66145158e+03 8.33319161e+02
 2.35443172e+02 7.61293821e+01 1.00846975e+01 2.69345727e+01
 2.94132468e-01 1.52960966e+00 2.90225145e+00 7.11553893e+00
 2.31708149e+01 9.97863538e+01 2.64327578e-01 2.43289568e+00
 8.28027048e-01]
grad_E = [ 2.34164411e-04  2.90449613e-11 -5.08059714e-10 -4.33540647e-08
  9.88615456e-07 -2.11221815e-06 -3.87834733e-04  5.29965401e-05
 -7.37468586e-05 -8.67655979e-05 -8.22964121e-05  1.67927817e-04
 -2.19793645e-05  8.47962118e-07  1.12011445e-04 -1.84074551e-04
 -6.18769045e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.72451209655        1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.45157967        1
[INPUT] 0    0    [1    /1   ]  833.319154789        1
[INPUT] 0    0    [1    /1   ]  235.443219425        1
[INPUT] 0    0    [1    /1   ]  76.1288018139        1
[INPUT] 0    0    [1    /1   ]  10.0889161837        1
[INPUT] 0    0    [1    /1   ]  26.9357806494        1
[INPUT] 0    0    [1    /1   ]  0.296150940826       1
[INPUT] 0    0    [1    /1   ]  1.54992410602        1
[INPUT] 0    0    [1    /1   ]  2.90571281117        1
[INPUT] 1    0    [1    /1   ]  7.11543042959        1
[INPUT] 1    0    [1    /1   ]  23.1708312306        1
[INPUT] 1    0    [1    /1   ]  99.7863519501        1
[INPUT] 1    0    [1    /1   ]  0.264433779014       1
[INPUT] 1    0    [1    /1   ]  2.43258121297        1
[INPUT] 1    0    [1    /1   ]  0.82846806601        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7245120965498311, 1.0]], [0, [24413.794186374267, 1.0]], [0, [3661.4515796745522, 1.0]], [0, [833.3191547885049, 1.0]], [0, [235.4432194250558, 1.0]], [0, [76.12880181391833, 1.0]], [0, [10.088916183746786, 1.0]], [0, [26.935780649369722, 1.0]], [0, [0.29615094082637994, 1.0]], [0, [1.5499241060192412, 1.0]], [0, [2.9057128111660013, 1.0]], [1, [7.1154304295900985, 1.0]], [1, [23.17083123058133, 1.0]], [1, [99.78635195012392, 1.0]], [1, [0.2644337790142974, 1.0]], [1, [2.4325812129696187, 1.0]], [1, [0.8284680660100902, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7245121]
bas 1, expnt(s) = [24413.79418637]
bas 2, expnt(s) = [3661.45157967]
bas 3, expnt(s) = [833.31915479]
bas 4, expnt(s) = [235.44321943]
bas 5, expnt(s) = [76.12880181]
bas 6, expnt(s) = [10.08891618]
bas 7, expnt(s) = [26.93578065]
bas 8, expnt(s) = [0.29615094]
bas 9, expnt(s) = [1.54992411]
bas 10, expnt(s) = [2.90571281]
bas 11, expnt(s) = [7.11543043]
bas 12, expnt(s) = [23.17083123]
bas 13, expnt(s) = [99.78635195]
bas 14, expnt(s) = [0.26443378]
bas 15, expnt(s) = [2.43258121]
bas 16, expnt(s) = [0.82846807]
CPU time:        64.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.24512097e-01 1.98403466e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319155e+02 3.91853335e+02
 2.35443219e+02 1.51855199e+02 7.61288018e+01 6.51143591e+01
 1.00889162e+01 1.43020539e+01 2.69357806e+01 2.98718555e+01
 2.96150941e-01 1.01426132e+00 1.54992411e+00 3.50952103e+00
 2.90571281e+00 5.62282465e+00 7.11543043e+00 3.39028231e+01
 2.31708312e+01 1.48306918e+02 9.97863520e+01 9.20075200e+02
 2.64433779e-01 5.53197943e-01 2.43258121e+00 8.86275161e+00
 8.28468066e-01 2.30583968e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999648590978659
cond(S) = 1611.0717382553632
E1 = -183.58998904597715  E_coul = 55.08014975485022
init E= -128.509839291127
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775409401991291  LUMO = 0.712112077674476
  mo_energy =
[-3.25550975e+01 -1.85273502e+00 -7.75409402e-01 -7.75409402e-01
 -7.75409402e-01  7.12112078e-01  8.17890769e-01  8.17890769e-01
  8.17890769e-01  3.60084894e+00  3.93125403e+00  3.93125403e+00
  3.93125403e+00  1.13786532e+01  1.43109779e+01  1.43109779e+01
  1.43109779e+01  3.94041539e+01  5.29595137e+01  5.29595137e+01
  5.29595137e+01  1.42832325e+02  2.40801699e+02  2.40801699e+02
  2.40801699e+02  5.05531965e+02  1.87192702e+03  8.00111923e+03
  4.77685931e+04]
E1 = -182.0842854412137  E_coul = 53.54612412786974
cycle= 1 E= -128.538161313344  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519287
diis-c [-0.26965866  1.        ]
  HOMO = -0.884442322816378  LUMO = 0.686852571472053
  mo_energy =
[-3.28786005e+01 -1.96675326e+00 -8.84442323e-01 -8.84442323e-01
 -8.84442323e-01  6.86852571e-01  7.91316218e-01  7.91316218e-01
  7.91316218e-01  3.53361064e+00  3.83401447e+00  3.83401447e+00
  3.83401447e+00  1.12399970e+01  1.41200215e+01  1.41200215e+01
  1.41200215e+01  3.91595413e+01  5.26782351e+01  5.26782351e+01
  5.26782351e+01  1.42515330e+02  2.40455022e+02  2.40455022e+02
  2.40455022e+02  5.05170313e+02  1.87152908e+03  8.00069219e+03
  4.77681472e+04]
E1 = -182.8467834002904  E_coul = 54.30602949038157
cycle= 2 E= -128.540753909909  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263793
diis-c [-6.57241373e-04  3.36079180e-01  6.63920820e-01]
  HOMO = -0.848761379725696  LUMO = 0.69493742204891
  mo_energy =
[-3.27703584e+01 -1.92917995e+00 -8.48761380e-01 -8.48761380e-01
 -8.48761380e-01  6.94937422e-01  7.99980784e-01  7.99980784e-01
  7.99980784e-01  3.55531378e+00  3.86556796e+00  3.86556796e+00
  3.86556796e+00  1.12854995e+01  1.41832953e+01  1.41832953e+01
  1.41832953e+01  3.92414705e+01  5.27723989e+01  5.27723989e+01
  5.27723989e+01  1.42621126e+02  2.40568843e+02  2.40568843e+02
  2.40568843e+02  5.05287207e+02  1.87165130e+03  8.00081686e+03
  4.77682728e+04]
E1 = -182.58764313868332  E_coul = 54.045966540696774
cycle= 3 E= -128.541676597987  delta_E= -0.000923  |g|= 0.000538  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120077
diis-c [-2.13368081e-07 -2.38020273e-03 -4.77566777e-04  1.00285777e+00]
  HOMO = -0.849030347143108  LUMO = 0.694887274731868
  mo_energy =
[-3.27708452e+01 -1.92938452e+00 -8.49030347e-01 -8.49030347e-01
 -8.49030347e-01  6.94887275e-01  7.99937551e-01  7.99937551e-01
  7.99937551e-01  3.55518484e+00  3.86538036e+00  3.86538036e+00
  3.86538036e+00  1.12852516e+01  1.41829708e+01  1.41829708e+01
  1.41829708e+01  3.92410938e+01  5.27719689e+01  5.27719689e+01
  5.27719689e+01  1.42620638e+02  2.40568283e+02  2.40568283e+02
  2.40568283e+02  5.05286589e+02  1.87165054e+03  8.00081600e+03
  4.77682719e+04]
E1 = -182.58814057845515  E_coul = 54.046463951601545
cycle= 4 E= -128.541676626854  delta_E= -2.89e-08  |g|= 8.18e-05  |ddm|= 0.000408
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187844
diis-c [-1.09010588e-09  2.37968173e-04  4.57924523e-04 -1.85380543e-01
  1.18468465e+00]
  HOMO = -0.849074388397212  LUMO = 0.69487526095978
  mo_energy =
[-3.27709195e+01 -1.92941793e+00 -8.49074388e-01 -8.49074388e-01
 -8.49074388e-01  6.94875261e-01  7.99923806e-01  7.99923806e-01
  7.99923806e-01  3.55515704e+00  3.86533941e+00  3.86533941e+00
  3.86533941e+00  1.12852028e+01  1.41829102e+01  1.41829102e+01
  1.41829102e+01  3.92410280e+01  5.27718987e+01  5.27718987e+01
  5.27718987e+01  1.42620564e+02  2.40568204e+02  2.40568204e+02
  2.40568204e+02  5.05286506e+02  1.87165045e+03  8.00081591e+03
  4.77682718e+04]
E1 = -182.58827238749925  E_coul = 54.046595759886884
cycle= 5 E= -128.541676627612  delta_E= -7.59e-10  |g|= 5.88e-06  |ddm|= 7.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58827238749925  E_coul = 54.046595759886884
  HOMO = -0.849071308252529  LUMO = 0.694876414132552
  mo_energy =
[-3.27709125e+01 -1.92941405e+00 -8.49071308e-01 -8.49071308e-01
 -8.49071308e-01  6.94876414e-01  7.99924701e-01  7.99924701e-01
  7.99924701e-01  3.55515946e+00  3.86534235e+00  3.86534235e+00
  3.86534235e+00  1.12852070e+01  1.41829153e+01  1.41829153e+01
  1.41829153e+01  3.92410341e+01  5.27719052e+01  5.27719052e+01
  5.27719052e+01  1.42620570e+02  2.40568211e+02  2.40568211e+02
  2.40568211e+02  5.05286513e+02  1.87165046e+03  8.00081591e+03
  4.77682718e+04]
E1 = -182.58825648058385  E_coul = 54.046579852968726
Extra cycle  E= -128.541676627615  delta_E= -2.76e-12  |g|= 2.24e-06  |ddm|= 1.96e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.24512097e-01 2.44137942e+04 3.66145158e+03 8.33319155e+02
 2.35443219e+02 7.61288018e+01 1.00889162e+01 2.69357806e+01
 2.96150941e-01 1.54992411e+00 2.90571281e+00 7.11543043e+00
 2.31708312e+01 9.97863520e+01 2.64433779e-01 2.43258121e+00
 8.28468066e-01]
E = -128.54167662761512
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.72451209655        1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.45157967        1
[INPUT] 0    0    [1    /1   ]  833.319154789        1
[INPUT] 0    0    [1    /1   ]  235.443219425        1
[INPUT] 0    0    [1    /1   ]  76.1288018139        1
[INPUT] 0    0    [1    /1   ]  10.0889161837        1
[INPUT] 0    0    [1    /1   ]  26.9357806494        1
[INPUT] 0    0    [1    /1   ]  0.296150940826       1
[INPUT] 0    0    [1    /1   ]  1.54992410602        1
[INPUT] 0    0    [1    /1   ]  2.90571281117        1
[INPUT] 1    0    [1    /1   ]  7.11543042959        1
[INPUT] 1    0    [1    /1   ]  23.1708312306        1
[INPUT] 1    0    [1    /1   ]  99.7863519501        1
[INPUT] 1    0    [1    /1   ]  0.264433779014       1
[INPUT] 1    0    [1    /1   ]  2.43258121297        1
[INPUT] 1    0    [1    /1   ]  0.82846806601        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7245120965498311, 1.0]], [0, [24413.794186374267, 1.0]], [0, [3661.4515796745522, 1.0]], [0, [833.3191547885049, 1.0]], [0, [235.4432194250558, 1.0]], [0, [76.12880181391833, 1.0]], [0, [10.088916183746786, 1.0]], [0, [26.935780649369722, 1.0]], [0, [0.29615094082637994, 1.0]], [0, [1.5499241060192412, 1.0]], [0, [2.9057128111660013, 1.0]], [1, [7.1154304295900985, 1.0]], [1, [23.17083123058133, 1.0]], [1, [99.78635195012392, 1.0]], [1, [0.2644337790142974, 1.0]], [1, [2.4325812129696187, 1.0]], [1, [0.8284680660100902, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7245121]
bas 1, expnt(s) = [24413.79418637]
bas 2, expnt(s) = [3661.45157967]
bas 3, expnt(s) = [833.31915479]
bas 4, expnt(s) = [235.44321943]
bas 5, expnt(s) = [76.12880181]
bas 6, expnt(s) = [10.08891618]
bas 7, expnt(s) = [26.93578065]
bas 8, expnt(s) = [0.29615094]
bas 9, expnt(s) = [1.54992411]
bas 10, expnt(s) = [2.90571281]
bas 11, expnt(s) = [7.11543043]
bas 12, expnt(s) = [23.17083123]
bas 13, expnt(s) = [99.78635195]
bas 14, expnt(s) = [0.26443378]
bas 15, expnt(s) = [2.43258121]
bas 16, expnt(s) = [0.82846807]
CPU time:        65.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.24512097e-01 1.98403466e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319155e+02 3.91853335e+02
 2.35443219e+02 1.51855199e+02 7.61288018e+01 6.51143591e+01
 1.00889162e+01 1.43020539e+01 2.69357806e+01 2.98718555e+01
 2.96150941e-01 1.01426132e+00 1.54992411e+00 3.50952103e+00
 2.90571281e+00 5.62282465e+00 7.11543043e+00 3.39028231e+01
 2.31708312e+01 1.48306918e+02 9.97863520e+01 9.20075200e+02
 2.64433779e-01 5.53197943e-01 2.43258121e+00 8.86275161e+00
 8.28468066e-01 2.30583968e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999648590978659
cond(S) = 1611.0717382553632
E1 = -183.58998904597715  E_coul = 55.08014975485022
init E= -128.509839291127
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775409401991291  LUMO = 0.712112077674476
  mo_energy =
[-3.25550975e+01 -1.85273502e+00 -7.75409402e-01 -7.75409402e-01
 -7.75409402e-01  7.12112078e-01  8.17890769e-01  8.17890769e-01
  8.17890769e-01  3.60084894e+00  3.93125403e+00  3.93125403e+00
  3.93125403e+00  1.13786532e+01  1.43109779e+01  1.43109779e+01
  1.43109779e+01  3.94041539e+01  5.29595137e+01  5.29595137e+01
  5.29595137e+01  1.42832325e+02  2.40801699e+02  2.40801699e+02
  2.40801699e+02  5.05531965e+02  1.87192702e+03  8.00111923e+03
  4.77685931e+04]
E1 = -182.0842854412137  E_coul = 53.54612412786974
cycle= 1 E= -128.538161313344  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519287
diis-c [-0.26965866  1.        ]
  HOMO = -0.884442322816378  LUMO = 0.686852571472053
  mo_energy =
[-3.28786005e+01 -1.96675326e+00 -8.84442323e-01 -8.84442323e-01
 -8.84442323e-01  6.86852571e-01  7.91316218e-01  7.91316218e-01
  7.91316218e-01  3.53361064e+00  3.83401447e+00  3.83401447e+00
  3.83401447e+00  1.12399970e+01  1.41200215e+01  1.41200215e+01
  1.41200215e+01  3.91595413e+01  5.26782351e+01  5.26782351e+01
  5.26782351e+01  1.42515330e+02  2.40455022e+02  2.40455022e+02
  2.40455022e+02  5.05170313e+02  1.87152908e+03  8.00069219e+03
  4.77681472e+04]
E1 = -182.8467834002904  E_coul = 54.30602949038157
cycle= 2 E= -128.540753909909  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263793
diis-c [-6.57241373e-04  3.36079180e-01  6.63920820e-01]
  HOMO = -0.848761379725696  LUMO = 0.69493742204891
  mo_energy =
[-3.27703584e+01 -1.92917995e+00 -8.48761380e-01 -8.48761380e-01
 -8.48761380e-01  6.94937422e-01  7.99980784e-01  7.99980784e-01
  7.99980784e-01  3.55531378e+00  3.86556796e+00  3.86556796e+00
  3.86556796e+00  1.12854995e+01  1.41832953e+01  1.41832953e+01
  1.41832953e+01  3.92414705e+01  5.27723989e+01  5.27723989e+01
  5.27723989e+01  1.42621126e+02  2.40568843e+02  2.40568843e+02
  2.40568843e+02  5.05287207e+02  1.87165130e+03  8.00081686e+03
  4.77682728e+04]
E1 = -182.58764313868332  E_coul = 54.045966540696774
cycle= 3 E= -128.541676597987  delta_E= -0.000923  |g|= 0.000538  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120077
diis-c [-2.13368081e-07 -2.38020273e-03 -4.77566777e-04  1.00285777e+00]
  HOMO = -0.849030347143108  LUMO = 0.694887274731868
  mo_energy =
[-3.27708452e+01 -1.92938452e+00 -8.49030347e-01 -8.49030347e-01
 -8.49030347e-01  6.94887275e-01  7.99937551e-01  7.99937551e-01
  7.99937551e-01  3.55518484e+00  3.86538036e+00  3.86538036e+00
  3.86538036e+00  1.12852516e+01  1.41829708e+01  1.41829708e+01
  1.41829708e+01  3.92410938e+01  5.27719689e+01  5.27719689e+01
  5.27719689e+01  1.42620638e+02  2.40568283e+02  2.40568283e+02
  2.40568283e+02  5.05286589e+02  1.87165054e+03  8.00081600e+03
  4.77682719e+04]
E1 = -182.58814057845515  E_coul = 54.046463951601545
cycle= 4 E= -128.541676626854  delta_E= -2.89e-08  |g|= 8.18e-05  |ddm|= 0.000408
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187844
diis-c [-1.09010588e-09  2.37968173e-04  4.57924523e-04 -1.85380543e-01
  1.18468465e+00]
  HOMO = -0.849074388397212  LUMO = 0.69487526095978
  mo_energy =
[-3.27709195e+01 -1.92941793e+00 -8.49074388e-01 -8.49074388e-01
 -8.49074388e-01  6.94875261e-01  7.99923806e-01  7.99923806e-01
  7.99923806e-01  3.55515704e+00  3.86533941e+00  3.86533941e+00
  3.86533941e+00  1.12852028e+01  1.41829102e+01  1.41829102e+01
  1.41829102e+01  3.92410280e+01  5.27718987e+01  5.27718987e+01
  5.27718987e+01  1.42620564e+02  2.40568204e+02  2.40568204e+02
  2.40568204e+02  5.05286506e+02  1.87165045e+03  8.00081591e+03
  4.77682718e+04]
E1 = -182.58827238749925  E_coul = 54.046595759886884
cycle= 5 E= -128.541676627612  delta_E= -7.59e-10  |g|= 5.88e-06  |ddm|= 7.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.58827238749925  E_coul = 54.046595759886884
  HOMO = -0.849071308252529  LUMO = 0.694876414132552
  mo_energy =
[-3.27709125e+01 -1.92941405e+00 -8.49071308e-01 -8.49071308e-01
 -8.49071308e-01  6.94876414e-01  7.99924701e-01  7.99924701e-01
  7.99924701e-01  3.55515946e+00  3.86534235e+00  3.86534235e+00
  3.86534235e+00  1.12852070e+01  1.41829153e+01  1.41829153e+01
  1.41829153e+01  3.92410341e+01  5.27719052e+01  5.27719052e+01
  5.27719052e+01  1.42620570e+02  2.40568211e+02  2.40568211e+02
  2.40568211e+02  5.05286513e+02  1.87165046e+03  8.00081591e+03
  4.77682718e+04]
E1 = -182.58825648058385  E_coul = 54.046579852968726
Extra cycle  E= -128.541676627615  delta_E= -2.76e-12  |g|= 2.24e-06  |ddm|= 1.96e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1611.0717382553632
E1 = -182.58825648058385  E_coul = 54.046579852968726
init E= -128.541676627615
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.849072435111541  LUMO = 0.694876232915874
  mo_energy =
[-3.27709160e+01 -1.92941510e+00 -8.49072435e-01 -8.49072435e-01
 -8.49072435e-01  6.94876233e-01  7.99924445e-01  7.99924445e-01
  7.99924445e-01  3.55515886e+00  3.86534138e+00  3.86534138e+00
  3.86534138e+00  1.12852056e+01  1.41829133e+01  1.41829133e+01
  1.41829133e+01  3.92410315e+01  5.27719022e+01  5.27719022e+01
  5.27719022e+01  1.42620567e+02  2.40568207e+02  2.40568207e+02
  2.40568207e+02  5.05286509e+02  1.87165045e+03  8.00081591e+03
  4.77682718e+04]
E1 = -182.58826529819248  E_coul = 54.04658867057712
cycle= 1 E= -128.541676627615  delta_E= -2.27e-13  |g|= 1.21e-06  |ddm|= 8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58826529819248  E_coul = 54.04658867057712
  HOMO = -0.849071814498966  LUMO = 0.694876388453502
  mo_energy =
[-3.27709141e+01 -1.92941441e+00 -8.49071814e-01 -8.49071814e-01
 -8.49071814e-01  6.94876388e-01  7.99924599e-01  7.99924599e-01
  7.99924599e-01  3.55515926e+00  3.86534194e+00  3.86534194e+00
  3.86534194e+00  1.12852064e+01  1.41829144e+01  1.41829144e+01
  1.41829144e+01  3.92410329e+01  5.27719038e+01  5.27719038e+01
  5.27719038e+01  1.42620569e+02  2.40568209e+02  2.40568209e+02
  2.40568209e+02  5.05286511e+02  1.87165045e+03  8.00081591e+03
  4.77682718e+04]
E1 = -182.5882608631195  E_coul = 54.04658423550411
Extra cycle  E= -128.541676627615  delta_E= -5.68e-14  |g|= 6.02e-07  |ddm|= 3.74e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [7.24512097e-01 2.44137942e+04 3.66145158e+03 8.33319155e+02
 2.35443219e+02 7.61288018e+01 1.00889162e+01 2.69357806e+01
 2.96150941e-01 1.54992411e+00 2.90571281e+00 7.11543043e+00
 2.31708312e+01 9.97863520e+01 2.64433779e-01 2.43258121e+00
 8.28468066e-01]
grad_E = [ 3.08634381e-04  3.14153892e-11 -6.34735354e-10 -4.06166155e-08
  9.48801829e-07 -1.72236357e-06 -3.88633262e-04  5.13316741e-05
 -2.18569251e-04 -9.34748081e-05 -7.60598978e-05  2.09517880e-04
 -2.56083648e-05  9.67213012e-07 -3.97125615e-04 -4.02185105e-04
 -9.34617550e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.739138629336       1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.45158036        1
[INPUT] 0    0    [1    /1   ]  833.319145384        1
[INPUT] 0    0    [1    /1   ]  235.443288399        1
[INPUT] 0    0    [1    /1   ]  76.1279102823        1
[INPUT] 0    0    [1    /1   ]  10.0966106606        1
[INPUT] 0    0    [1    /1   ]  26.9374751696        1
[INPUT] 0    0    [1    /1   ]  0.298757404783       1
[INPUT] 0    0    [1    /1   ]  1.58517583981        1
[INPUT] 0    0    [1    /1   ]  2.91041063196        1
[INPUT] 1    0    [1    /1   ]  7.11483910487        1
[INPUT] 1    0    [1    /1   ]  23.1709087688        1
[INPUT] 1    0    [1    /1   ]  99.7863469562        1
[INPUT] 1    0    [1    /1   ]  0.264861667221       1
[INPUT] 1    0    [1    /1   ]  2.43282771756        1
[INPUT] 1    0    [1    /1   ]  0.829685531604       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7391386293362356, 1.0]], [0, [24413.794186359704, 1.0]], [0, [3661.4515803591917, 1.0]], [0, [833.3191453843382, 1.0]], [0, [235.44328839884676, 1.0]], [0, [76.12791028225472, 1.0]], [0, [10.096610660634264, 1.0]], [0, [26.937475169629703, 1.0]], [0, [0.2987574047830805, 1.0]], [0, [1.5851758398063303, 1.0]], [0, [2.9104106319564984, 1.0]], [1, [7.114839104866696, 1.0]], [1, [23.170908768788728, 1.0]], [1, [99.78634695617262, 1.0]], [1, [0.2648616672210268, 1.0]], [1, [2.4328277175590896, 1.0]], [1, [0.8296855316039177, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.73913863]
bas 1, expnt(s) = [24413.79418636]
bas 2, expnt(s) = [3661.45158036]
bas 3, expnt(s) = [833.31914538]
bas 4, expnt(s) = [235.4432884]
bas 5, expnt(s) = [76.12791028]
bas 6, expnt(s) = [10.09661066]
bas 7, expnt(s) = [26.93747517]
bas 8, expnt(s) = [0.2987574]
bas 9, expnt(s) = [1.58517584]
bas 10, expnt(s) = [2.91041063]
bas 11, expnt(s) = [7.1148391]
bas 12, expnt(s) = [23.17090877]
bas 13, expnt(s) = [99.78634696]
bas 14, expnt(s) = [0.26486167]
bas 15, expnt(s) = [2.43282772]
bas 16, expnt(s) = [0.82968553]
CPU time:        68.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.39138629e-01 2.01399992e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319145e+02 3.91853332e+02
 2.35443288e+02 1.51855232e+02 7.61279103e+01 6.51137872e+01
 1.00966107e+01 1.43102339e+01 2.69374752e+01 2.98732649e+01
 2.98757405e-01 1.02094896e+00 1.58517584e+00 3.56921827e+00
 2.91041063e+00 5.62964132e+00 7.11483910e+00 3.38993013e+01
 2.31709088e+01 1.48307538e+02 9.97863470e+01 9.20075142e+02
 2.64861667e-01 5.54317102e-01 2.43282772e+00 8.86387426e+00
 8.29685532e-01 2.31007611e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999645803445178
cond(S) = 1709.9098681053083
E1 = -183.5900005786846  E_coul = 55.08016198149987
init E= -128.509838597185
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775407946990084  LUMO = 0.724779222316733
  mo_energy =
[-3.25550977e+01 -1.85273297e+00 -7.75407947e-01 -7.75407947e-01
 -7.75407947e-01  7.24779222e-01  8.19441844e-01  8.19441844e-01
  8.19441844e-01  3.67144364e+00  3.93612148e+00  3.93612148e+00
  3.93612148e+00  1.15510305e+01  1.43168961e+01  1.43168961e+01
  1.43168961e+01  3.96551343e+01  5.29635761e+01  5.29635761e+01
  5.29635761e+01  1.43090647e+02  2.40804132e+02  2.40804132e+02
  2.40804132e+02  5.05770533e+02  1.87214125e+03  8.00130773e+03
  4.77687491e+04]
E1 = -182.0845461878692  E_coul = 53.5463810631369
cycle= 1 E= -128.538165124732  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519154
diis-c [-0.26952066  1.        ]
  HOMO = -0.884421656779387  LUMO = 0.699022253581584
  mo_energy =
[-3.28785598e+01 -1.96672833e+00 -8.84421657e-01 -8.84421657e-01
 -8.84421657e-01  6.99022254e-01  7.92810635e-01  7.92810635e-01
  7.92810635e-01  3.60322671e+00  3.83885709e+00  3.83885709e+00
  3.83885709e+00  1.14117246e+01  1.41259869e+01  1.41259869e+01
  1.41259869e+01  3.94105604e+01  5.26823433e+01  5.26823433e+01
  5.26823433e+01  1.42773737e+02  2.40457498e+02  2.40457498e+02
  2.40457498e+02  5.05408938e+02  1.87174336e+03  8.00088072e+03
  4.77683033e+04]
E1 = -182.84681883546907  E_coul = 54.30606198196151
cycle= 2 E= -128.540756853508  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263693
diis-c [-6.58214029e-04  3.36049804e-01  6.63950196e-01]
  HOMO = -0.848750337898192  LUMO = 0.707264574136792
  mo_energy =
[-3.27703420e+01 -1.92916540e+00 -8.48750338e-01 -8.48750338e-01
 -8.48750338e-01  7.07264574e-01  8.01491626e-01  8.01491626e-01
  8.01491626e-01  3.62524729e+00  3.87041540e+00  3.87041540e+00
  3.87041540e+00  1.14574416e+01  1.41892388e+01  1.41892388e+01
  1.41892388e+01  3.94924674e+01  5.27764828e+01  5.27764828e+01
  5.27764828e+01  1.42879493e+02  2.40571294e+02  2.40571294e+02
  2.40571294e+02  5.05525801e+02  1.87186555e+03  8.00100537e+03
  4.77684288e+04]
E1 = -182.58775224879895  E_coul = 54.04607321758481
cycle= 3 E= -128.541679031214  delta_E= -0.000922  |g|= 0.000541  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120689
diis-c [-2.12872932e-07 -2.38360919e-03 -4.57029474e-04  1.00284064e+00]
  HOMO = -0.849020736947306  LUMO = 0.707212892712883
  mo_energy =
[-3.27708316e+01 -1.92937149e+00 -8.49020737e-01 -8.49020737e-01
 -8.49020737e-01  7.07212893e-01  8.01447750e-01  8.01447750e-01
  8.01447750e-01  3.62511531e+00  3.87022623e+00  3.87022623e+00
  3.87022623e+00  1.14571908e+01  1.41889122e+01  1.41889122e+01
  1.41889122e+01  3.94920882e+01  5.27760502e+01  5.27760502e+01
  5.27760502e+01  1.42879002e+02  2.40570730e+02  2.40570730e+02
  2.40570730e+02  5.05525180e+02  1.87186479e+03  8.00100451e+03
  4.77684279e+04]
E1 = -182.5882540515994  E_coul = 54.0465749912822
cycle= 4 E= -128.541679060317  delta_E= -2.91e-08  |g|= 8.21e-05  |ddm|= 0.000415
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188397
diis-c [-1.08652087e-09  2.37512295e-04  4.57097920e-04 -1.84921728e-01
  1.18422712e+00]
  HOMO = -0.84906492243346  LUMO = 0.707200612035537
  mo_energy =
[-3.27709061e+01 -1.92940507e+00 -8.49064922e-01 -8.49064922e-01
 -8.49064922e-01  7.07200612e-01  8.01433934e-01  8.01433934e-01
  8.01433934e-01  3.62508703e+00  3.87018512e+00  3.87018512e+00
  3.87018512e+00  1.14571416e+01  1.41888514e+01  1.41888514e+01
  1.41888514e+01  3.94920222e+01  5.27759798e+01  5.27759798e+01
  5.27759798e+01  1.42878927e+02  2.40570651e+02  2.40570651e+02
  2.40570651e+02  5.05525097e+02  1.87186470e+03  8.00100441e+03
  4.77684278e+04]
E1 = -182.5883863148376  E_coul = 54.046707253760935
cycle= 5 E= -128.541679061077  delta_E= -7.59e-10  |g|= 5.86e-06  |ddm|= 7.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5883863148376  E_coul = 54.046707253760935
  HOMO = -0.849061852430927  LUMO = 0.707201783590035
  mo_energy =
[-3.27708991e+01 -1.92940120e+00 -8.49061852e-01 -8.49061852e-01
 -8.49061852e-01  7.07201784e-01  8.01434829e-01  8.01434829e-01
  8.01434829e-01  3.62508948e+00  3.87018805e+00  3.87018805e+00
  3.87018805e+00  1.14571458e+01  1.41888564e+01  1.41888564e+01
  1.41888564e+01  3.94920283e+01  5.27759863e+01  5.27759863e+01
  5.27759863e+01  1.42878934e+02  2.40570658e+02  2.40570658e+02
  2.40570658e+02  5.05525104e+02  1.87186470e+03  8.00100442e+03
  4.77684278e+04]
E1 = -182.5883704947792  E_coul = 54.04669143369993
Extra cycle  E= -128.541679061079  delta_E= -2.61e-12  |g|= 2.22e-06  |ddm|= 1.96e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.39138629e-01 2.44137942e+04 3.66145158e+03 8.33319145e+02
 2.35443288e+02 7.61279103e+01 1.00966107e+01 2.69374752e+01
 2.98757405e-01 1.58517584e+00 2.91041063e+00 7.11483910e+00
 2.31709088e+01 9.97863470e+01 2.64861667e-01 2.43282772e+00
 8.29685532e-01]
E = -128.5416790610793
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.739138629336       1
[INPUT] 0    0    [1    /1   ]  24413.7941864        1
[INPUT] 0    0    [1    /1   ]  3661.45158036        1
[INPUT] 0    0    [1    /1   ]  833.319145384        1
[INPUT] 0    0    [1    /1   ]  235.443288399        1
[INPUT] 0    0    [1    /1   ]  76.1279102823        1
[INPUT] 0    0    [1    /1   ]  10.0966106606        1
[INPUT] 0    0    [1    /1   ]  26.9374751696        1
[INPUT] 0    0    [1    /1   ]  0.298757404783       1
[INPUT] 0    0    [1    /1   ]  1.58517583981        1
[INPUT] 0    0    [1    /1   ]  2.91041063196        1
[INPUT] 1    0    [1    /1   ]  7.11483910487        1
[INPUT] 1    0    [1    /1   ]  23.1709087688        1
[INPUT] 1    0    [1    /1   ]  99.7863469562        1
[INPUT] 1    0    [1    /1   ]  0.264861667221       1
[INPUT] 1    0    [1    /1   ]  2.43282771756        1
[INPUT] 1    0    [1    /1   ]  0.829685531604       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7391386293362356, 1.0]], [0, [24413.794186359704, 1.0]], [0, [3661.4515803591917, 1.0]], [0, [833.3191453843382, 1.0]], [0, [235.44328839884676, 1.0]], [0, [76.12791028225472, 1.0]], [0, [10.096610660634264, 1.0]], [0, [26.937475169629703, 1.0]], [0, [0.2987574047830805, 1.0]], [0, [1.5851758398063303, 1.0]], [0, [2.9104106319564984, 1.0]], [1, [7.114839104866696, 1.0]], [1, [23.170908768788728, 1.0]], [1, [99.78634695617262, 1.0]], [1, [0.2648616672210268, 1.0]], [1, [2.4328277175590896, 1.0]], [1, [0.8296855316039177, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.73913863]
bas 1, expnt(s) = [24413.79418636]
bas 2, expnt(s) = [3661.45158036]
bas 3, expnt(s) = [833.31914538]
bas 4, expnt(s) = [235.4432884]
bas 5, expnt(s) = [76.12791028]
bas 6, expnt(s) = [10.09661066]
bas 7, expnt(s) = [26.93747517]
bas 8, expnt(s) = [0.2987574]
bas 9, expnt(s) = [1.58517584]
bas 10, expnt(s) = [2.91041063]
bas 11, expnt(s) = [7.1148391]
bas 12, expnt(s) = [23.17090877]
bas 13, expnt(s) = [99.78634696]
bas 14, expnt(s) = [0.26486167]
bas 15, expnt(s) = [2.43282772]
bas 16, expnt(s) = [0.82968553]
CPU time:        69.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.39138629e-01 2.01399992e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319145e+02 3.91853332e+02
 2.35443288e+02 1.51855232e+02 7.61279103e+01 6.51137872e+01
 1.00966107e+01 1.43102339e+01 2.69374752e+01 2.98732649e+01
 2.98757405e-01 1.02094896e+00 1.58517584e+00 3.56921827e+00
 2.91041063e+00 5.62964132e+00 7.11483910e+00 3.38993013e+01
 2.31709088e+01 1.48307538e+02 9.97863470e+01 9.20075142e+02
 2.64861667e-01 5.54317102e-01 2.43282772e+00 8.86387426e+00
 8.29685532e-01 2.31007611e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999645803445178
cond(S) = 1709.9098681053083
E1 = -183.5900005786846  E_coul = 55.08016198149987
init E= -128.509838597185
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775407946990084  LUMO = 0.724779222316733
  mo_energy =
[-3.25550977e+01 -1.85273297e+00 -7.75407947e-01 -7.75407947e-01
 -7.75407947e-01  7.24779222e-01  8.19441844e-01  8.19441844e-01
  8.19441844e-01  3.67144364e+00  3.93612148e+00  3.93612148e+00
  3.93612148e+00  1.15510305e+01  1.43168961e+01  1.43168961e+01
  1.43168961e+01  3.96551343e+01  5.29635761e+01  5.29635761e+01
  5.29635761e+01  1.43090647e+02  2.40804132e+02  2.40804132e+02
  2.40804132e+02  5.05770533e+02  1.87214125e+03  8.00130773e+03
  4.77687491e+04]
E1 = -182.0845461878692  E_coul = 53.5463810631369
cycle= 1 E= -128.538165124732  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519154
diis-c [-0.26952066  1.        ]
  HOMO = -0.884421656779387  LUMO = 0.699022253581584
  mo_energy =
[-3.28785598e+01 -1.96672833e+00 -8.84421657e-01 -8.84421657e-01
 -8.84421657e-01  6.99022254e-01  7.92810635e-01  7.92810635e-01
  7.92810635e-01  3.60322671e+00  3.83885709e+00  3.83885709e+00
  3.83885709e+00  1.14117246e+01  1.41259869e+01  1.41259869e+01
  1.41259869e+01  3.94105604e+01  5.26823433e+01  5.26823433e+01
  5.26823433e+01  1.42773737e+02  2.40457498e+02  2.40457498e+02
  2.40457498e+02  5.05408938e+02  1.87174336e+03  8.00088072e+03
  4.77683033e+04]
E1 = -182.84681883546907  E_coul = 54.30606198196151
cycle= 2 E= -128.540756853508  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263693
diis-c [-6.58214029e-04  3.36049804e-01  6.63950196e-01]
  HOMO = -0.848750337898192  LUMO = 0.707264574136792
  mo_energy =
[-3.27703420e+01 -1.92916540e+00 -8.48750338e-01 -8.48750338e-01
 -8.48750338e-01  7.07264574e-01  8.01491626e-01  8.01491626e-01
  8.01491626e-01  3.62524729e+00  3.87041540e+00  3.87041540e+00
  3.87041540e+00  1.14574416e+01  1.41892388e+01  1.41892388e+01
  1.41892388e+01  3.94924674e+01  5.27764828e+01  5.27764828e+01
  5.27764828e+01  1.42879493e+02  2.40571294e+02  2.40571294e+02
  2.40571294e+02  5.05525801e+02  1.87186555e+03  8.00100537e+03
  4.77684288e+04]
E1 = -182.58775224879895  E_coul = 54.04607321758481
cycle= 3 E= -128.541679031214  delta_E= -0.000922  |g|= 0.000541  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120689
diis-c [-2.12872932e-07 -2.38360919e-03 -4.57029474e-04  1.00284064e+00]
  HOMO = -0.849020736947306  LUMO = 0.707212892712883
  mo_energy =
[-3.27708316e+01 -1.92937149e+00 -8.49020737e-01 -8.49020737e-01
 -8.49020737e-01  7.07212893e-01  8.01447750e-01  8.01447750e-01
  8.01447750e-01  3.62511531e+00  3.87022623e+00  3.87022623e+00
  3.87022623e+00  1.14571908e+01  1.41889122e+01  1.41889122e+01
  1.41889122e+01  3.94920882e+01  5.27760502e+01  5.27760502e+01
  5.27760502e+01  1.42879002e+02  2.40570730e+02  2.40570730e+02
  2.40570730e+02  5.05525180e+02  1.87186479e+03  8.00100451e+03
  4.77684279e+04]
E1 = -182.5882540515994  E_coul = 54.0465749912822
cycle= 4 E= -128.541679060317  delta_E= -2.91e-08  |g|= 8.21e-05  |ddm|= 0.000415
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188397
diis-c [-1.08652087e-09  2.37512295e-04  4.57097920e-04 -1.84921728e-01
  1.18422712e+00]
  HOMO = -0.84906492243346  LUMO = 0.707200612035537
  mo_energy =
[-3.27709061e+01 -1.92940507e+00 -8.49064922e-01 -8.49064922e-01
 -8.49064922e-01  7.07200612e-01  8.01433934e-01  8.01433934e-01
  8.01433934e-01  3.62508703e+00  3.87018512e+00  3.87018512e+00
  3.87018512e+00  1.14571416e+01  1.41888514e+01  1.41888514e+01
  1.41888514e+01  3.94920222e+01  5.27759798e+01  5.27759798e+01
  5.27759798e+01  1.42878927e+02  2.40570651e+02  2.40570651e+02
  2.40570651e+02  5.05525097e+02  1.87186470e+03  8.00100441e+03
  4.77684278e+04]
E1 = -182.5883863148376  E_coul = 54.046707253760935
cycle= 5 E= -128.541679061077  delta_E= -7.59e-10  |g|= 5.86e-06  |ddm|= 7.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5883863148376  E_coul = 54.046707253760935
  HOMO = -0.849061852430927  LUMO = 0.707201783590035
  mo_energy =
[-3.27708991e+01 -1.92940120e+00 -8.49061852e-01 -8.49061852e-01
 -8.49061852e-01  7.07201784e-01  8.01434829e-01  8.01434829e-01
  8.01434829e-01  3.62508948e+00  3.87018805e+00  3.87018805e+00
  3.87018805e+00  1.14571458e+01  1.41888564e+01  1.41888564e+01
  1.41888564e+01  3.94920283e+01  5.27759863e+01  5.27759863e+01
  5.27759863e+01  1.42878934e+02  2.40570658e+02  2.40570658e+02
  2.40570658e+02  5.05525104e+02  1.87186470e+03  8.00100442e+03
  4.77684278e+04]
E1 = -182.5883704947792  E_coul = 54.04669143369993
Extra cycle  E= -128.541679061079  delta_E= -2.61e-12  |g|= 2.22e-06  |ddm|= 1.96e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1709.9098681053083
E1 = -182.5883704947792  E_coul = 54.04669143369993
init E= -128.541679061079
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.849062973044343  LUMO = 0.707201599887922
  mo_energy =
[-3.27709027e+01 -1.92940224e+00 -8.49062973e-01 -8.49062973e-01
 -8.49062973e-01  7.07201600e-01  8.01434574e-01  8.01434574e-01
  8.01434574e-01  3.62508887e+00  3.87018709e+00  3.87018709e+00
  3.87018709e+00  1.14571444e+01  1.41888544e+01  1.41888544e+01
  1.41888544e+01  3.94920257e+01  5.27759833e+01  5.27759833e+01
  5.27759833e+01  1.42878931e+02  2.40570654e+02  2.40570654e+02
  2.40570654e+02  5.05525100e+02  1.87186470e+03  8.00100441e+03
  4.77684278e+04]
E1 = -182.58837926959936  E_coul = 54.046700208519546
cycle= 1 E= -128.54167906108  delta_E= -5.12e-13  |g|= 1.2e-06  |ddm|= 7.98e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58837926959936  E_coul = 54.046700208519546
  HOMO = -0.849062355448887  LUMO = 0.707201757736026
  mo_energy =
[-3.27709008e+01 -1.92940156e+00 -8.49062355e-01 -8.49062355e-01
 -8.49062355e-01  7.07201758e-01  8.01434728e-01  8.01434728e-01
  8.01434728e-01  3.62508927e+00  3.87018764e+00  3.87018764e+00
  3.87018764e+00  1.14571452e+01  1.41888555e+01  1.41888555e+01
  1.41888555e+01  3.94920271e+01  5.27759849e+01  5.27759849e+01
  5.27759849e+01  1.42878932e+02  2.40570656e+02  2.40570656e+02
  2.40570656e+02  5.05525102e+02  1.87186470e+03  8.00100441e+03
  4.77684278e+04]
E1 = -182.58837485709196  E_coul = 54.04669579601234
Extra cycle  E= -128.54167906108  delta_E= 1.71e-13  |g|= 5.99e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [7.39138629e-01 2.44137942e+04 3.66145158e+03 8.33319145e+02
 2.35443288e+02 7.61279103e+01 1.00966107e+01 2.69374752e+01
 2.98757405e-01 1.58517584e+00 2.91041063e+00 7.11483910e+00
 2.31709088e+01 9.97863470e+01 2.64861667e-01 2.43282772e+00
 8.29685532e-01]
grad_E = [ 3.49396301e-04  4.11972701e-11 -1.15047067e-09 -2.99478118e-08
  8.12086038e-07 -5.67594519e-07 -3.88601659e-04  4.68055583e-05
 -3.33916949e-04 -7.97073772e-05 -7.32497661e-05  2.50017347e-04
 -2.82315292e-05  1.03853638e-06 -8.04307764e-04 -6.77466813e-04
  5.93797782e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.754870631884       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158126        1
[INPUT] 0    0    [1    /1   ]  833.31913341         1
[INPUT] 0    0    [1    /1   ]  235.443370663        1
[INPUT] 0    0    [1    /1   ]  76.1267611293        1
[INPUT] 0    0    [1    /1   ]  10.108725835         1
[INPUT] 0    0    [1    /1   ]  26.9393674659        1
[INPUT] 0    0    [1    /1   ]  0.300981222859       1
[INPUT] 0    0    [1    /1   ]  1.63749899709        1
[INPUT] 0    0    [1    /1   ]  2.91542608433        1
[INPUT] 1    0    [1    /1   ]  7.11332468659        1
[INPUT] 1    0    [1    /1   ]  23.1710999349        1
[INPUT] 1    0    [1    /1   ]  99.7863369227        1
[INPUT] 1    0    [1    /1   ]  0.26567588496        1
[INPUT] 1    0    [1    /1   ]  2.43455438259        1
[INPUT] 1    0    [1    /1   ]  0.831899106463       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7548706318837822, 1.0]], [0, [24413.79418634038, 1.0]], [0, [3661.4515812608706, 1.0]], [0, [833.3191334097376, 1.0]], [0, [235.4433706633397, 1.0]], [0, [76.12676112928472, 1.0]], [0, [10.108725835001746, 1.0]], [0, [26.939367465852566, 1.0]], [0, [0.30098122285856715, 1.0]], [0, [1.6374989970885827, 1.0]], [0, [2.9154260843282715, 1.0]], [1, [7.113324686592909, 1.0]], [1, [23.171099934861296, 1.0]], [1, [99.78633692266997, 1.0]], [1, [0.265675884960301, 1.0]], [1, [2.434554382586158, 1.0]], [1, [0.8318991064631389, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.75487063]
bas 1, expnt(s) = [24413.79418634]
bas 2, expnt(s) = [3661.45158126]
bas 3, expnt(s) = [833.31913341]
bas 4, expnt(s) = [235.44337066]
bas 5, expnt(s) = [76.12676113]
bas 6, expnt(s) = [10.10872584]
bas 7, expnt(s) = [26.93936747]
bas 8, expnt(s) = [0.30098122]
bas 9, expnt(s) = [1.637499]
bas 10, expnt(s) = [2.91542608]
bas 11, expnt(s) = [7.11332469]
bas 12, expnt(s) = [23.17109993]
bas 13, expnt(s) = [99.78633692]
bas 14, expnt(s) = [0.26567588]
bas 15, expnt(s) = [2.43455438]
bas 16, expnt(s) = [0.83189911]
CPU time:        72.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.54870632e-01 2.04606498e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319133e+02 3.91853328e+02
 2.35443371e+02 1.51855272e+02 7.61267611e+01 6.51130500e+01
 1.01087258e+01 1.43231103e+01 2.69393675e+01 2.98748388e+01
 3.00981223e-01 1.02664330e+00 1.63749900e+00 3.65721764e+00
 2.91542608e+00 5.63691584e+00 7.11332469e+00 3.38902820e+01
 2.31710999e+01 1.48309068e+02 9.97863369e+01 9.20075027e+02
 2.65675885e-01 5.56447970e-01 2.43455438e+00 8.87173872e+00
 8.31899106e-01 2.31778269e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640659657135
cond(S) = 1843.8677986234125
E1 = -183.59001325840654  E_coul = 55.080175588720074
init E= -128.509837669686
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775405780199074  LUMO = 0.738127580326888
  mo_energy =
[-3.25551000e+01 -1.85273005e+00 -7.75405780e-01 -7.75405780e-01
 -7.75405780e-01  7.38127580e-01  8.22347196e-01  8.22347196e-01
  8.22347196e-01  3.75567778e+00  3.94583764e+00  3.94583764e+00
  3.94583764e+00  1.17718218e+01  1.43307904e+01  1.43307904e+01
  1.43307904e+01  3.99876393e+01  5.29741792e+01  5.29741792e+01
  5.29741792e+01  1.43437636e+02  2.40810757e+02  2.40810757e+02
  2.40810757e+02  5.06092006e+02  1.87243012e+03  8.00156193e+03
  4.77689596e+04]
E1 = -182.08518062881464  E_coul = 53.54700855111541
cycle= 1 E= -128.538172077699  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518987
diis-c [-0.26934733  1.        ]
  HOMO = -0.884370411419709  LUMO = 0.711836666591121
  mo_energy =
[-3.28784609e+01 -1.96666828e+00 -8.84370411e-01 -8.84370411e-01
 -8.84370411e-01  7.11836667e-01  7.95620001e-01  7.95620001e-01
  7.95620001e-01  3.68622505e+00  3.84851898e+00  3.84851898e+00
  3.84851898e+00  1.16316397e+01  1.41399810e+01  1.41399810e+01
  1.41399810e+01  3.97431370e+01  5.26930582e+01  5.26930582e+01
  5.26930582e+01  1.43120883e+02  2.40464227e+02  2.40464227e+02
  2.40464227e+02  5.05730532e+02  1.87203233e+03  8.00113503e+03
  4.77685138e+04]
E1 = -182.8469995706228  E_coul = 54.30623762183965
cycle= 2 E= -128.540761948783  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263554
diis-c [-6.59447670e-04  3.36001756e-01  6.63998244e-01]
  HOMO = -0.848718818149661  LUMO = 0.720250017638488
  mo_energy =
[-3.27702949e+01 -1.92912671e+00 -8.48718818e-01 -8.48718818e-01
 -8.48718818e-01  7.20250018e-01  8.04331274e-01  8.04331274e-01
  8.04331274e-01  3.70864828e+00  3.88009224e+00  3.88009224e+00
  3.88009224e+00  1.16776475e+01  1.42031921e+01  1.42031921e+01
  1.42031921e+01  3.98250076e+01  5.27871460e+01  5.27871460e+01
  5.27871460e+01  1.43226568e+02  2.40577968e+02  2.40577968e+02
  2.40577968e+02  5.05847334e+02  1.87215447e+03  8.00125962e+03
  4.77686393e+04]
E1 = -182.58810920773882  E_coul = 54.04642618690845
cycle= 3 E= -128.54168302083  delta_E= -0.000921  |g|= 0.000543  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00121113
diis-c [-2.12931765e-07 -2.38601174e-03 -4.43003060e-04  1.00282901e+00]
  HOMO = -0.848989837315261  LUMO = 0.72019722322968
  mo_energy =
[-3.27707859e+01 -1.92933328e+00 -8.48989837e-01 -8.48989837e-01
 -8.48989837e-01  7.20197223e-01  8.04287006e-01  8.04287006e-01
  8.04287006e-01  3.70851352e+00  3.87990221e+00  3.87990221e+00
  3.87990221e+00  1.16773943e+01  1.42028645e+01  1.42028645e+01
  1.42028645e+01  3.98246271e+01  5.27867122e+01  5.27867122e+01
  5.27867122e+01  1.43226075e+02  2.40577404e+02  2.40577404e+02
  2.40577404e+02  5.05846711e+02  1.87215370e+03  8.00125875e+03
  4.77686384e+04]
E1 = -182.58861497920572  E_coul = 54.04693192920826
cycle= 4 E= -128.541683049997  delta_E= -2.92e-08  |g|= 8.21e-05  |ddm|= 0.000418
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188765
diis-c [-1.08784524e-09  2.38423838e-04  4.56829610e-04 -1.85091530e-01
  1.18439628e+00]
  HOMO = -0.849034022266418  LUMO = 0.720184760307248
  mo_energy =
[-3.27708605e+01 -1.92936681e+00 -8.49034022e-01 -8.49034022e-01
 -8.49034022e-01  7.20184760e-01  8.04273159e-01  8.04273159e-01
  8.04273159e-01  3.70848482e+00  3.87986108e+00  3.87986108e+00
  3.87986108e+00  1.16773449e+01  1.42028037e+01  1.42028037e+01
  1.42028037e+01  3.98245610e+01  5.27866416e+01  5.27866416e+01
  5.27866416e+01  1.43226001e+02  2.40577325e+02  2.40577325e+02
  2.40577325e+02  5.05846628e+02  1.87215361e+03  8.00125866e+03
  4.77686383e+04]
E1 = -182.58874764162425  E_coul = 54.04706459086801
cycle= 5 E= -128.541683050756  delta_E= -7.59e-10  |g|= 5.88e-06  |ddm|= 7.14e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58874764162425  E_coul = 54.04706459086801
  HOMO = -0.849030940354158  LUMO = 0.720185959772416
  mo_energy =
[-3.27708535e+01 -1.92936293e+00 -8.49030940e-01 -8.49030940e-01
 -8.49030940e-01  7.20185960e-01  8.04274062e-01  8.04274062e-01
  8.04274062e-01  3.70848731e+00  3.87986403e+00  3.87986403e+00
  3.87986403e+00  1.16773491e+01  1.42028087e+01  1.42028087e+01
  1.42028087e+01  3.98245671e+01  5.27866482e+01  5.27866482e+01
  5.27866482e+01  1.43226007e+02  2.40577331e+02  2.40577331e+02
  2.40577331e+02  5.05846635e+02  1.87215362e+03  8.00125866e+03
  4.77686383e+04]
E1 = -182.58873183017175  E_coul = 54.0470487794132
Extra cycle  E= -128.541683050759  delta_E= -2.3e-12  |g|= 2.22e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.54870632e-01 2.44137942e+04 3.66145158e+03 8.33319133e+02
 2.35443371e+02 7.61267611e+01 1.01087258e+01 2.69393675e+01
 3.00981223e-01 1.63749900e+00 2.91542608e+00 7.11332469e+00
 2.31710999e+01 9.97863369e+01 2.65675885e-01 2.43455438e+00
 8.31899106e-01]
E = -128.54168305075854
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.754870631884       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158126        1
[INPUT] 0    0    [1    /1   ]  833.31913341         1
[INPUT] 0    0    [1    /1   ]  235.443370663        1
[INPUT] 0    0    [1    /1   ]  76.1267611293        1
[INPUT] 0    0    [1    /1   ]  10.108725835         1
[INPUT] 0    0    [1    /1   ]  26.9393674659        1
[INPUT] 0    0    [1    /1   ]  0.300981222859       1
[INPUT] 0    0    [1    /1   ]  1.63749899709        1
[INPUT] 0    0    [1    /1   ]  2.91542608433        1
[INPUT] 1    0    [1    /1   ]  7.11332468659        1
[INPUT] 1    0    [1    /1   ]  23.1710999349        1
[INPUT] 1    0    [1    /1   ]  99.7863369227        1
[INPUT] 1    0    [1    /1   ]  0.26567588496        1
[INPUT] 1    0    [1    /1   ]  2.43455438259        1
[INPUT] 1    0    [1    /1   ]  0.831899106463       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7548706318837822, 1.0]], [0, [24413.79418634038, 1.0]], [0, [3661.4515812608706, 1.0]], [0, [833.3191334097376, 1.0]], [0, [235.4433706633397, 1.0]], [0, [76.12676112928472, 1.0]], [0, [10.108725835001746, 1.0]], [0, [26.939367465852566, 1.0]], [0, [0.30098122285856715, 1.0]], [0, [1.6374989970885827, 1.0]], [0, [2.9154260843282715, 1.0]], [1, [7.113324686592909, 1.0]], [1, [23.171099934861296, 1.0]], [1, [99.78633692266997, 1.0]], [1, [0.265675884960301, 1.0]], [1, [2.434554382586158, 1.0]], [1, [0.8318991064631389, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.75487063]
bas 1, expnt(s) = [24413.79418634]
bas 2, expnt(s) = [3661.45158126]
bas 3, expnt(s) = [833.31913341]
bas 4, expnt(s) = [235.44337066]
bas 5, expnt(s) = [76.12676113]
bas 6, expnt(s) = [10.10872584]
bas 7, expnt(s) = [26.93936747]
bas 8, expnt(s) = [0.30098122]
bas 9, expnt(s) = [1.637499]
bas 10, expnt(s) = [2.91542608]
bas 11, expnt(s) = [7.11332469]
bas 12, expnt(s) = [23.17109993]
bas 13, expnt(s) = [99.78633692]
bas 14, expnt(s) = [0.26567588]
bas 15, expnt(s) = [2.43455438]
bas 16, expnt(s) = [0.83189911]
CPU time:        72.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.54870632e-01 2.04606498e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319133e+02 3.91853328e+02
 2.35443371e+02 1.51855272e+02 7.61267611e+01 6.51130500e+01
 1.01087258e+01 1.43231103e+01 2.69393675e+01 2.98748388e+01
 3.00981223e-01 1.02664330e+00 1.63749900e+00 3.65721764e+00
 2.91542608e+00 5.63691584e+00 7.11332469e+00 3.38902820e+01
 2.31710999e+01 1.48309068e+02 9.97863369e+01 9.20075027e+02
 2.65675885e-01 5.56447970e-01 2.43455438e+00 8.87173872e+00
 8.31899106e-01 2.31778269e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640659657135
cond(S) = 1843.8677986234125
E1 = -183.59001325840654  E_coul = 55.080175588720074
init E= -128.509837669686
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775405780199074  LUMO = 0.738127580326888
  mo_energy =
[-3.25551000e+01 -1.85273005e+00 -7.75405780e-01 -7.75405780e-01
 -7.75405780e-01  7.38127580e-01  8.22347196e-01  8.22347196e-01
  8.22347196e-01  3.75567778e+00  3.94583764e+00  3.94583764e+00
  3.94583764e+00  1.17718218e+01  1.43307904e+01  1.43307904e+01
  1.43307904e+01  3.99876393e+01  5.29741792e+01  5.29741792e+01
  5.29741792e+01  1.43437636e+02  2.40810757e+02  2.40810757e+02
  2.40810757e+02  5.06092006e+02  1.87243012e+03  8.00156193e+03
  4.77689596e+04]
E1 = -182.08518062881464  E_coul = 53.54700855111541
cycle= 1 E= -128.538172077699  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.146
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518987
diis-c [-0.26934733  1.        ]
  HOMO = -0.884370411419709  LUMO = 0.711836666591121
  mo_energy =
[-3.28784609e+01 -1.96666828e+00 -8.84370411e-01 -8.84370411e-01
 -8.84370411e-01  7.11836667e-01  7.95620001e-01  7.95620001e-01
  7.95620001e-01  3.68622505e+00  3.84851898e+00  3.84851898e+00
  3.84851898e+00  1.16316397e+01  1.41399810e+01  1.41399810e+01
  1.41399810e+01  3.97431370e+01  5.26930582e+01  5.26930582e+01
  5.26930582e+01  1.43120883e+02  2.40464227e+02  2.40464227e+02
  2.40464227e+02  5.05730532e+02  1.87203233e+03  8.00113503e+03
  4.77685138e+04]
E1 = -182.8469995706228  E_coul = 54.30623762183965
cycle= 2 E= -128.540761948783  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.263554
diis-c [-6.59447670e-04  3.36001756e-01  6.63998244e-01]
  HOMO = -0.848718818149661  LUMO = 0.720250017638488
  mo_energy =
[-3.27702949e+01 -1.92912671e+00 -8.48718818e-01 -8.48718818e-01
 -8.48718818e-01  7.20250018e-01  8.04331274e-01  8.04331274e-01
  8.04331274e-01  3.70864828e+00  3.88009224e+00  3.88009224e+00
  3.88009224e+00  1.16776475e+01  1.42031921e+01  1.42031921e+01
  1.42031921e+01  3.98250076e+01  5.27871460e+01  5.27871460e+01
  5.27871460e+01  1.43226568e+02  2.40577968e+02  2.40577968e+02
  2.40577968e+02  5.05847334e+02  1.87215447e+03  8.00125962e+03
  4.77686393e+04]
E1 = -182.58810920773882  E_coul = 54.04642618690845
cycle= 3 E= -128.54168302083  delta_E= -0.000921  |g|= 0.000543  |ddm|= 0.0217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00121113
diis-c [-2.12931765e-07 -2.38601174e-03 -4.43003060e-04  1.00282901e+00]
  HOMO = -0.848989837315261  LUMO = 0.72019722322968
  mo_energy =
[-3.27707859e+01 -1.92933328e+00 -8.48989837e-01 -8.48989837e-01
 -8.48989837e-01  7.20197223e-01  8.04287006e-01  8.04287006e-01
  8.04287006e-01  3.70851352e+00  3.87990221e+00  3.87990221e+00
  3.87990221e+00  1.16773943e+01  1.42028645e+01  1.42028645e+01
  1.42028645e+01  3.98246271e+01  5.27867122e+01  5.27867122e+01
  5.27867122e+01  1.43226075e+02  2.40577404e+02  2.40577404e+02
  2.40577404e+02  5.05846711e+02  1.87215370e+03  8.00125875e+03
  4.77686384e+04]
E1 = -182.58861497920572  E_coul = 54.04693192920826
cycle= 4 E= -128.541683049997  delta_E= -2.92e-08  |g|= 8.21e-05  |ddm|= 0.000418
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188765
diis-c [-1.08784524e-09  2.38423838e-04  4.56829610e-04 -1.85091530e-01
  1.18439628e+00]
  HOMO = -0.849034022266418  LUMO = 0.720184760307248
  mo_energy =
[-3.27708605e+01 -1.92936681e+00 -8.49034022e-01 -8.49034022e-01
 -8.49034022e-01  7.20184760e-01  8.04273159e-01  8.04273159e-01
  8.04273159e-01  3.70848482e+00  3.87986108e+00  3.87986108e+00
  3.87986108e+00  1.16773449e+01  1.42028037e+01  1.42028037e+01
  1.42028037e+01  3.98245610e+01  5.27866416e+01  5.27866416e+01
  5.27866416e+01  1.43226001e+02  2.40577325e+02  2.40577325e+02
  2.40577325e+02  5.05846628e+02  1.87215361e+03  8.00125866e+03
  4.77686383e+04]
E1 = -182.58874764162425  E_coul = 54.04706459086801
cycle= 5 E= -128.541683050756  delta_E= -7.59e-10  |g|= 5.88e-06  |ddm|= 7.14e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58874764162425  E_coul = 54.04706459086801
  HOMO = -0.849030940354158  LUMO = 0.720185959772416
  mo_energy =
[-3.27708535e+01 -1.92936293e+00 -8.49030940e-01 -8.49030940e-01
 -8.49030940e-01  7.20185960e-01  8.04274062e-01  8.04274062e-01
  8.04274062e-01  3.70848731e+00  3.87986403e+00  3.87986403e+00
  3.87986403e+00  1.16773491e+01  1.42028087e+01  1.42028087e+01
  1.42028087e+01  3.98245671e+01  5.27866482e+01  5.27866482e+01
  5.27866482e+01  1.43226007e+02  2.40577331e+02  2.40577331e+02
  2.40577331e+02  5.05846635e+02  1.87215362e+03  8.00125866e+03
  4.77686383e+04]
E1 = -182.58873183017175  E_coul = 54.0470487794132
Extra cycle  E= -128.541683050759  delta_E= -2.3e-12  |g|= 2.22e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1843.8677986234125
E1 = -182.58873183017175  E_coul = 54.0470487794132
init E= -128.541683050759
    CPU time for initialize scf      0.38 sec, wall time      0.38 sec
  HOMO = -0.849032059885094  LUMO = 0.720185772293499
  mo_energy =
[-3.27708570e+01 -1.92936397e+00 -8.49032060e-01 -8.49032060e-01
 -8.49032060e-01  7.20185772e-01  8.04273806e-01  8.04273806e-01
  8.04273806e-01  3.70848670e+00  3.87986306e+00  3.87986306e+00
  3.87986306e+00  1.16773477e+01  1.42028068e+01  1.42028068e+01
  1.42028068e+01  3.98245645e+01  5.27866452e+01  5.27866452e+01
  5.27866452e+01  1.43226004e+02  2.40577328e+02  2.40577328e+02
  2.40577328e+02  5.05846631e+02  1.87215362e+03  8.00125866e+03
  4.77686383e+04]
E1 = -182.5887406074854  E_coul = 54.047057556726266
cycle= 1 E= -128.541683050759  delta_E= -5.97e-13  |g|= 1.2e-06  |ddm|= 8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5887406074854  E_coul = 54.047057556726266
  HOMO = -0.849031442075825  LUMO = 0.720185933506086
  mo_energy =
[-3.27708551e+01 -1.92936329e+00 -8.49031442e-01 -8.49031442e-01
 -8.49031442e-01  7.20185934e-01  8.04273961e-01  8.04273961e-01
  8.04273961e-01  3.70848710e+00  3.87986361e+00  3.87986361e+00
  3.87986361e+00  1.16773485e+01  1.42028079e+01  1.42028079e+01
  1.42028079e+01  3.98245659e+01  5.27866468e+01  5.27866468e+01
  5.27866468e+01  1.43226006e+02  2.40577330e+02  2.40577330e+02
  2.40577330e+02  5.05846633e+02  1.87215362e+03  8.00125866e+03
  4.77686383e+04]
E1 = -182.58873619541336  E_coul = 54.04705314465435
Extra cycle  E= -128.541683050759  delta_E= 1.14e-13  |g|= 5.99e-07  |ddm|= 3.73e-07
    CPU time for scf_cycle      0.46 sec, wall time      0.47 sec
exp = [7.54870632e-01 2.44137942e+04 3.66145158e+03 8.33319133e+02
 2.35443371e+02 7.61267611e+01 1.01087258e+01 2.69393675e+01
 3.00981223e-01 1.63749900e+00 2.91542608e+00 7.11332469e+00
 2.31710999e+01 9.97863369e+01 2.65675885e-01 2.43455438e+00
 8.31899106e-01]
grad_E = [ 3.29211605e-04  6.56198317e-11 -2.43379106e-09 -3.75132646e-09
  4.89505688e-07  2.01063796e-06 -3.83821470e-04  3.68171210e-05
 -3.98061639e-04 -4.13751783e-05 -7.58796007e-05  2.43453398e-04
 -2.48118976e-05  8.79439425e-07 -8.30604423e-04 -8.44597032e-04
  1.16374451e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.768302642477       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158222        1
[INPUT] 0    0    [1    /1   ]  833.319121046        1
[INPUT] 0    0    [1    /1   ]  235.443451062        1
[INPUT] 0    0    [1    /1   ]  76.1255614175        1
[INPUT] 0    0    [1    /1   ]  10.1233606802        1
[INPUT] 0    0    [1    /1   ]  26.9410895254        1
[INPUT] 0    0    [1    /1   ]  0.303004131582       1
[INPUT] 0    0    [1    /1   ]  1.69743734282        1
[INPUT] 0    0    [1    /1   ]  2.91988925409        1
[INPUT] 1    0    [1    /1   ]  7.11099342269        1
[INPUT] 1    0    [1    /1   ]  23.1713872833        1
[INPUT] 1    0    [1    /1   ]  99.786323074         1
[INPUT] 1    0    [1    /1   ]  0.266512584047       1
[INPUT] 1    0    [1    /1   ]  2.43795524444        1
[INPUT] 1    0    [1    /1   ]  0.834365519328       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7683026424773365, 1.0]], [0, [24413.79418631978, 1.0]], [0, [3661.4515822166045, 1.0]], [0, [833.3191210459704, 1.0]], [0, [235.4434510620794, 1.0]], [0, [76.12556141747524, 1.0]], [0, [10.123360680154242, 1.0]], [0, [26.94108952540446, 1.0]], [0, [0.3030041315822034, 1.0]], [0, [1.6974373428249914, 1.0]], [0, [2.919889254088351, 1.0]], [1, [7.110993422693662, 1.0]], [1, [23.17138728334056, 1.0]], [1, [99.7863230740342, 1.0]], [1, [0.2665125840467771, 1.0]], [1, [2.4379552444437897, 1.0]], [1, [0.834365519328142, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76830264]
bas 1, expnt(s) = [24413.79418632]
bas 2, expnt(s) = [3661.45158222]
bas 3, expnt(s) = [833.31912105]
bas 4, expnt(s) = [235.44345106]
bas 5, expnt(s) = [76.12556142]
bas 6, expnt(s) = [10.12336068]
bas 7, expnt(s) = [26.94108953]
bas 8, expnt(s) = [0.30300413]
bas 9, expnt(s) = [1.69743734]
bas 10, expnt(s) = [2.91988925]
bas 11, expnt(s) = [7.11099342]
bas 12, expnt(s) = [23.17138728]
bas 13, expnt(s) = [99.78632307]
bas 14, expnt(s) = [0.26651258]
bas 15, expnt(s) = [2.43795524]
bas 16, expnt(s) = [0.83436552]
CPU time:        75.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.68302642e-01 2.07331013e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319121e+02 3.91853323e+02
 2.35443451e+02 1.51855311e+02 7.61255614e+01 6.51122804e+01
 1.01233607e+01 1.43386597e+01 2.69410895e+01 2.98762710e+01
 3.03004132e-01 1.03181405e+00 1.69743734e+00 3.75716561e+00
 2.91988925e+00 5.64338668e+00 7.11099342e+00 3.38763989e+01
 2.31713873e+01 1.48311367e+02 9.97863231e+01 9.20074867e+02
 2.66512584e-01 5.58639374e-01 2.43795524e+00 8.88723273e+00
 8.34365519e-01 2.32637557e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963513690029
cond(S) = 2004.2999259803394
E1 = -183.590018511843  E_coul = 55.080182515617715
init E= -128.509835996225
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403871518075  LUMO = 0.75057074945702
  mo_energy =
[-3.25551054e+01 -1.85272690e+00 -7.75403872e-01 -7.75403872e-01
 -7.75403872e-01  7.50570749e-01  8.25378302e-01  8.25378302e-01
  8.25378302e-01  3.83883861e+00  3.95724323e+00  3.95724323e+00
  3.95724323e+00  1.20004825e+01  1.43493972e+01  1.43493972e+01
  1.43493972e+01  4.03416966e+01  5.29890431e+01  5.29890431e+01
  5.29890431e+01  1.43811755e+02  2.40820126e+02  2.40820126e+02
  2.40820126e+02  5.06439638e+02  1.87274270e+03  8.00183704e+03
  4.77691873e+04]
E1 = -182.08591218632634  E_coul = 53.547732430871044
cycle= 1 E= -128.538179755455  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51884
diis-c [-0.26919541  1.        ]
  HOMO = -0.884310535103672  LUMO = 0.723784252426257
  mo_energy =
[-3.28783484e+01 -1.96659964e+00 -8.84310535e-01 -8.84310535e-01
 -8.84310535e-01  7.23784252e-01  7.98554741e-01  7.98554741e-01
  7.98554741e-01  3.76812951e+00  3.85983831e+00  3.85983831e+00
  3.85983831e+00  1.18593519e+01  1.41586947e+01  1.41586947e+01
  1.41586947e+01  4.00972613e+01  5.27080550e+01  5.27080550e+01
  5.27080550e+01  1.43495177e+02  2.40473716e+02  2.40473716e+02
  2.40473716e+02  5.06078301e+02  1.87234503e+03  8.00141025e+03
  4.77687417e+04]
E1 = -182.8472503318761  E_coul = 54.30648278873167
cycle= 2 E= -128.540767543144  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263431
diis-c [-6.60729539e-04  3.35957570e-01  6.64042430e-01]
  HOMO = -0.848680046058286  LUMO = 0.732358933727571
  mo_energy =
[-3.27702390e+01 -1.92908095e+00 -8.48680046e-01 -8.48680046e-01
 -8.48680046e-01  7.32358934e-01  8.07298572e-01  8.07298572e-01
  8.07298572e-01  3.79096406e+00  3.89143877e+00  3.89143877e+00
  3.89143877e+00  1.19056764e+01  1.42218652e+01  1.42218652e+01
  1.42218652e+01  4.01790998e+01  5.28020851e+01  5.28020851e+01
  5.28020851e+01  1.43600785e+02  2.40587398e+02  2.40587398e+02
  2.40587398e+02  5.06195037e+02  1.87246710e+03  8.00153477e+03
  4.77688671e+04]
E1 = -182.58856364445995  E_coul = 54.04687624524404
cycle= 3 E= -128.541687399216  delta_E= -0.00092  |g|= 0.000541  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00121053
diis-c [-2.12289523e-07 -2.38333882e-03 -4.37972851e-04  1.00282131e+00]
  HOMO = -0.848950253268968  LUMO = 0.732305850954838
  mo_energy =
[-3.27707289e+01 -1.92928650e+00 -8.48950253e-01 -8.48950253e-01
 -8.48950253e-01  7.32305851e-01  8.07254508e-01  8.07254508e-01
  8.07254508e-01  3.79082771e+00  3.89124925e+00  3.89124925e+00
  3.89124925e+00  1.19054225e+01  1.42215387e+01  1.42215387e+01
  1.42215387e+01  4.01787202e+01  5.28016524e+01  5.28016524e+01
  5.28016524e+01  1.43600294e+02  2.40586834e+02  2.40586834e+02
  2.40586834e+02  5.06194415e+02  1.87246634e+03  8.00153391e+03
  4.77688662e+04]
E1 = -182.58907155295628  E_coul = 54.0473841248742
cycle= 4 E= -128.541687428082  delta_E= -2.89e-08  |g|= 8.18e-05  |ddm|= 0.000416
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018855
diis-c [-1.09063667e-09  2.39992355e-04  4.57005757e-04 -1.85648882e-01
  1.18495188e+00]
  HOMO = -0.848994199195227  LUMO = 0.732293346842632
  mo_energy =
[-3.27708032e+01 -1.92931972e+00 -8.48994199e-01 -8.48994199e-01
 -8.48994199e-01  7.32293347e-01  8.07240722e-01  8.07240722e-01
  8.07240722e-01  3.79079880e+00  3.89120832e+00  3.89120832e+00
  3.89120832e+00  1.19053730e+01  1.42214781e+01  1.42214781e+01
  1.42214781e+01  4.01786544e+01  5.28015822e+01  5.28015822e+01
  5.28015822e+01  1.43600220e+02  2.40586755e+02  2.40586755e+02
  2.40586755e+02  5.06194332e+02  1.87246625e+03  8.00153382e+03
  4.77688661e+04]
E1 = -182.5892043909048  E_coul = 54.0475169620709
cycle= 5 E= -128.541687428834  delta_E= -7.52e-10  |g|= 5.91e-06  |ddm|= 7.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5892043909048  E_coul = 54.0475169620709
  HOMO = -0.848991093523898  LUMO = 0.732294575866409
  mo_energy =
[-3.27707961e+01 -1.92931582e+00 -8.48991094e-01 -8.48991094e-01
 -8.48991094e-01  7.32294576e-01  8.07241636e-01  8.07241636e-01
  8.07241636e-01  3.79080135e+00  3.89121129e+00  3.89121129e+00
  3.89121129e+00  1.19053773e+01  1.42214833e+01  1.42214833e+01
  1.42214833e+01  4.01786605e+01  5.28015888e+01  5.28015888e+01
  5.28015888e+01  1.43600227e+02  2.40586762e+02  2.40586762e+02
  2.40586762e+02  5.06194339e+02  1.87246625e+03  8.00153382e+03
  4.77688661e+04]
E1 = -182.58918852630154  E_coul = 54.047501097464846
Extra cycle  E= -128.541687428837  delta_E= -2.81e-12  |g|= 2.23e-06  |ddm|= 2.01e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.68302642e-01 2.44137942e+04 3.66145158e+03 8.33319121e+02
 2.35443451e+02 7.61255614e+01 1.01233607e+01 2.69410895e+01
 3.03004132e-01 1.69743734e+00 2.91988925e+00 7.11099342e+00
 2.31713873e+01 9.97863231e+01 2.66512584e-01 2.43795524e+00
 8.34365519e-01]
E = -128.5416874288367
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.768302642477       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158222        1
[INPUT] 0    0    [1    /1   ]  833.319121046        1
[INPUT] 0    0    [1    /1   ]  235.443451062        1
[INPUT] 0    0    [1    /1   ]  76.1255614175        1
[INPUT] 0    0    [1    /1   ]  10.1233606802        1
[INPUT] 0    0    [1    /1   ]  26.9410895254        1
[INPUT] 0    0    [1    /1   ]  0.303004131582       1
[INPUT] 0    0    [1    /1   ]  1.69743734282        1
[INPUT] 0    0    [1    /1   ]  2.91988925409        1
[INPUT] 1    0    [1    /1   ]  7.11099342269        1
[INPUT] 1    0    [1    /1   ]  23.1713872833        1
[INPUT] 1    0    [1    /1   ]  99.786323074         1
[INPUT] 1    0    [1    /1   ]  0.266512584047       1
[INPUT] 1    0    [1    /1   ]  2.43795524444        1
[INPUT] 1    0    [1    /1   ]  0.834365519328       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7683026424773365, 1.0]], [0, [24413.79418631978, 1.0]], [0, [3661.4515822166045, 1.0]], [0, [833.3191210459704, 1.0]], [0, [235.4434510620794, 1.0]], [0, [76.12556141747524, 1.0]], [0, [10.123360680154242, 1.0]], [0, [26.94108952540446, 1.0]], [0, [0.3030041315822034, 1.0]], [0, [1.6974373428249914, 1.0]], [0, [2.919889254088351, 1.0]], [1, [7.110993422693662, 1.0]], [1, [23.17138728334056, 1.0]], [1, [99.7863230740342, 1.0]], [1, [0.2665125840467771, 1.0]], [1, [2.4379552444437897, 1.0]], [1, [0.834365519328142, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76830264]
bas 1, expnt(s) = [24413.79418632]
bas 2, expnt(s) = [3661.45158222]
bas 3, expnt(s) = [833.31912105]
bas 4, expnt(s) = [235.44345106]
bas 5, expnt(s) = [76.12556142]
bas 6, expnt(s) = [10.12336068]
bas 7, expnt(s) = [26.94108953]
bas 8, expnt(s) = [0.30300413]
bas 9, expnt(s) = [1.69743734]
bas 10, expnt(s) = [2.91988925]
bas 11, expnt(s) = [7.11099342]
bas 12, expnt(s) = [23.17138728]
bas 13, expnt(s) = [99.78632307]
bas 14, expnt(s) = [0.26651258]
bas 15, expnt(s) = [2.43795524]
bas 16, expnt(s) = [0.83436552]
CPU time:        76.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.68302642e-01 2.07331013e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319121e+02 3.91853323e+02
 2.35443451e+02 1.51855311e+02 7.61255614e+01 6.51122804e+01
 1.01233607e+01 1.43386597e+01 2.69410895e+01 2.98762710e+01
 3.03004132e-01 1.03181405e+00 1.69743734e+00 3.75716561e+00
 2.91988925e+00 5.64338668e+00 7.11099342e+00 3.38763989e+01
 2.31713873e+01 1.48311367e+02 9.97863231e+01 9.20074867e+02
 2.66512584e-01 5.58639374e-01 2.43795524e+00 8.88723273e+00
 8.34365519e-01 2.32637557e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963513690029
cond(S) = 2004.2999259803394
E1 = -183.590018511843  E_coul = 55.080182515617715
init E= -128.509835996225
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403871518075  LUMO = 0.75057074945702
  mo_energy =
[-3.25551054e+01 -1.85272690e+00 -7.75403872e-01 -7.75403872e-01
 -7.75403872e-01  7.50570749e-01  8.25378302e-01  8.25378302e-01
  8.25378302e-01  3.83883861e+00  3.95724323e+00  3.95724323e+00
  3.95724323e+00  1.20004825e+01  1.43493972e+01  1.43493972e+01
  1.43493972e+01  4.03416966e+01  5.29890431e+01  5.29890431e+01
  5.29890431e+01  1.43811755e+02  2.40820126e+02  2.40820126e+02
  2.40820126e+02  5.06439638e+02  1.87274270e+03  8.00183704e+03
  4.77691873e+04]
E1 = -182.08591218632634  E_coul = 53.547732430871044
cycle= 1 E= -128.538179755455  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51884
diis-c [-0.26919541  1.        ]
  HOMO = -0.884310535103672  LUMO = 0.723784252426257
  mo_energy =
[-3.28783484e+01 -1.96659964e+00 -8.84310535e-01 -8.84310535e-01
 -8.84310535e-01  7.23784252e-01  7.98554741e-01  7.98554741e-01
  7.98554741e-01  3.76812951e+00  3.85983831e+00  3.85983831e+00
  3.85983831e+00  1.18593519e+01  1.41586947e+01  1.41586947e+01
  1.41586947e+01  4.00972613e+01  5.27080550e+01  5.27080550e+01
  5.27080550e+01  1.43495177e+02  2.40473716e+02  2.40473716e+02
  2.40473716e+02  5.06078301e+02  1.87234503e+03  8.00141025e+03
  4.77687417e+04]
E1 = -182.8472503318761  E_coul = 54.30648278873167
cycle= 2 E= -128.540767543144  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263431
diis-c [-6.60729539e-04  3.35957570e-01  6.64042430e-01]
  HOMO = -0.848680046058286  LUMO = 0.732358933727571
  mo_energy =
[-3.27702390e+01 -1.92908095e+00 -8.48680046e-01 -8.48680046e-01
 -8.48680046e-01  7.32358934e-01  8.07298572e-01  8.07298572e-01
  8.07298572e-01  3.79096406e+00  3.89143877e+00  3.89143877e+00
  3.89143877e+00  1.19056764e+01  1.42218652e+01  1.42218652e+01
  1.42218652e+01  4.01790998e+01  5.28020851e+01  5.28020851e+01
  5.28020851e+01  1.43600785e+02  2.40587398e+02  2.40587398e+02
  2.40587398e+02  5.06195037e+02  1.87246710e+03  8.00153477e+03
  4.77688671e+04]
E1 = -182.58856364445995  E_coul = 54.04687624524404
cycle= 3 E= -128.541687399216  delta_E= -0.00092  |g|= 0.000541  |ddm|= 0.0217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00121053
diis-c [-2.12289523e-07 -2.38333882e-03 -4.37972851e-04  1.00282131e+00]
  HOMO = -0.848950253268968  LUMO = 0.732305850954838
  mo_energy =
[-3.27707289e+01 -1.92928650e+00 -8.48950253e-01 -8.48950253e-01
 -8.48950253e-01  7.32305851e-01  8.07254508e-01  8.07254508e-01
  8.07254508e-01  3.79082771e+00  3.89124925e+00  3.89124925e+00
  3.89124925e+00  1.19054225e+01  1.42215387e+01  1.42215387e+01
  1.42215387e+01  4.01787202e+01  5.28016524e+01  5.28016524e+01
  5.28016524e+01  1.43600294e+02  2.40586834e+02  2.40586834e+02
  2.40586834e+02  5.06194415e+02  1.87246634e+03  8.00153391e+03
  4.77688662e+04]
E1 = -182.58907155295628  E_coul = 54.0473841248742
cycle= 4 E= -128.541687428082  delta_E= -2.89e-08  |g|= 8.18e-05  |ddm|= 0.000416
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018855
diis-c [-1.09063667e-09  2.39992355e-04  4.57005757e-04 -1.85648882e-01
  1.18495188e+00]
  HOMO = -0.848994199195227  LUMO = 0.732293346842632
  mo_energy =
[-3.27708032e+01 -1.92931972e+00 -8.48994199e-01 -8.48994199e-01
 -8.48994199e-01  7.32293347e-01  8.07240722e-01  8.07240722e-01
  8.07240722e-01  3.79079880e+00  3.89120832e+00  3.89120832e+00
  3.89120832e+00  1.19053730e+01  1.42214781e+01  1.42214781e+01
  1.42214781e+01  4.01786544e+01  5.28015822e+01  5.28015822e+01
  5.28015822e+01  1.43600220e+02  2.40586755e+02  2.40586755e+02
  2.40586755e+02  5.06194332e+02  1.87246625e+03  8.00153382e+03
  4.77688661e+04]
E1 = -182.5892043909048  E_coul = 54.0475169620709
cycle= 5 E= -128.541687428834  delta_E= -7.52e-10  |g|= 5.91e-06  |ddm|= 7.1e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5892043909048  E_coul = 54.0475169620709
  HOMO = -0.848991093523898  LUMO = 0.732294575866409
  mo_energy =
[-3.27707961e+01 -1.92931582e+00 -8.48991094e-01 -8.48991094e-01
 -8.48991094e-01  7.32294576e-01  8.07241636e-01  8.07241636e-01
  8.07241636e-01  3.79080135e+00  3.89121129e+00  3.89121129e+00
  3.89121129e+00  1.19053773e+01  1.42214833e+01  1.42214833e+01
  1.42214833e+01  4.01786605e+01  5.28015888e+01  5.28015888e+01
  5.28015888e+01  1.43600227e+02  2.40586762e+02  2.40586762e+02
  2.40586762e+02  5.06194339e+02  1.87246625e+03  8.00153382e+03
  4.77688661e+04]
E1 = -182.58918852630154  E_coul = 54.047501097464846
Extra cycle  E= -128.541687428837  delta_E= -2.81e-12  |g|= 2.23e-06  |ddm|= 2.01e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2004.2999259803394
E1 = -182.58918852630154  E_coul = 54.047501097464846
init E= -128.541687428837
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.84899221622316  LUMO = 0.732294383740972
  mo_energy =
[-3.27707997e+01 -1.92931686e+00 -8.48992216e-01 -8.48992216e-01
 -8.48992216e-01  7.32294384e-01  8.07241379e-01  8.07241379e-01
  8.07241379e-01  3.79080072e+00  3.89121032e+00  3.89121032e+00
  3.89121032e+00  1.19053759e+01  1.42214813e+01  1.42214813e+01
  1.42214813e+01  4.01786579e+01  5.28015858e+01  5.28015858e+01
  5.28015858e+01  1.43600223e+02  2.40586758e+02  2.40586758e+02
  2.40586758e+02  5.06194335e+02  1.87246625e+03  8.00153382e+03
  4.77688661e+04]
E1 = -182.58919733767124  E_coul = 54.04750990883421
cycle= 1 E= -128.541687428837  delta_E= -3.41e-13  |g|= 1.21e-06  |ddm|= 8.04e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
E1 = -182.58919733767124  E_coul = 54.04750990883421
  HOMO = -0.848991595961418  LUMO = 0.732294548651154
  mo_energy =
[-3.27707978e+01 -1.92931617e+00 -8.48991596e-01 -8.48991596e-01
 -8.48991596e-01  7.32294549e-01  8.07241534e-01  8.07241534e-01
  8.07241534e-01  3.79080113e+00  3.89121088e+00  3.89121088e+00
  3.89121088e+00  1.19053767e+01  1.42214824e+01  1.42214824e+01
  1.42214824e+01  4.01786593e+01  5.28015874e+01  5.28015874e+01
  5.28015874e+01  1.43600225e+02  2.40586760e+02  2.40586760e+02
  2.40586760e+02  5.06194337e+02  1.87246625e+03  8.00153382e+03
  4.77688661e+04]
E1 = -182.58919290985278  E_coul = 54.04750548101604
Extra cycle  E= -128.541687428837  delta_E= 2.84e-13  |g|= 6.01e-07  |ddm|= 3.75e-07
    CPU time for scf_cycle      0.44 sec, wall time      0.43 sec
exp = [7.68302642e-01 2.44137942e+04 3.66145158e+03 8.33319121e+02
 2.35443451e+02 7.61255614e+01 1.01233607e+01 2.69410895e+01
 3.03004132e-01 1.69743734e+00 2.91988925e+00 7.11099342e+00
 2.31713873e+01 9.97863231e+01 2.66512584e-01 2.43795524e+00
 8.34365519e-01]
grad_E = [ 1.95681007e-04  1.01109350e-10 -4.29632493e-09  3.41216130e-08
  2.93882382e-08  5.61689197e-06 -3.75109328e-04  2.30024012e-05
 -2.66093151e-04  1.55708282e-05 -8.17392304e-05  1.48892014e-04
 -1.17886069e-05  3.74250332e-07 -4.72363702e-04 -6.92709014e-04
  1.22110924e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783073922605       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158321        1
[INPUT] 0    0    [1    /1   ]  833.31910809         1
[INPUT] 0    0    [1    /1   ]  235.443537475        1
[INPUT] 0    0    [1    /1   ]  76.1243066486        1
[INPUT] 0    0    [1    /1   ]  10.1381792368        1
[INPUT] 0    0    [1    /1   ]  26.9429720563        1
[INPUT] 0    0    [1    /1   ]  0.306139938181       1
[INPUT] 0    0    [1    /1   ]  1.75686337445        1
[INPUT] 0    0    [1    /1   ]  2.92507060534        1
[INPUT] 1    0    [1    /1   ]  7.10870263366        1
[INPUT] 1    0    [1    /1   ]  23.1716630643        1
[INPUT] 1    0    [1    /1   ]  99.7863096959        1
[INPUT] 1    0    [1    /1   ]  0.266883422747       1
[INPUT] 1    0    [1    /1   ]  2.44160426092        1
[INPUT] 1    0    [1    /1   ]  0.835882502995       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.783073922604655, 1.0]], [0, [24413.79418629848, 1.0]], [0, [3661.451583207071, 1.0]], [0, [833.3191080896848, 1.0]], [0, [235.44353747466252, 1.0]], [0, [76.12430664861843, 1.0]], [0, [10.138179236843552, 1.0]], [0, [26.942972056342903, 1.0]], [0, [0.3061399381814858, 1.0]], [0, [1.7568633744529307, 1.0]], [0, [2.9250706053375484, 1.0]], [1, [7.108702633656093, 1.0]], [1, [23.171663064347435, 1.0]], [1, [99.78630969589719, 1.0]], [1, [0.2668834227470271, 1.0]], [1, [2.441604260918683, 1.0]], [1, [0.8358825029950308, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78307392]
bas 1, expnt(s) = [24413.7941863]
bas 2, expnt(s) = [3661.45158321]
bas 3, expnt(s) = [833.31910809]
bas 4, expnt(s) = [235.44353747]
bas 5, expnt(s) = [76.12430665]
bas 6, expnt(s) = [10.13817924]
bas 7, expnt(s) = [26.94297206]
bas 8, expnt(s) = [0.30613994]
bas 9, expnt(s) = [1.75686337]
bas 10, expnt(s) = [2.92507061]
bas 11, expnt(s) = [7.10870263]
bas 12, expnt(s) = [23.17166306]
bas 13, expnt(s) = [99.7863097]
bas 14, expnt(s) = [0.26688342]
bas 15, expnt(s) = [2.44160426]
bas 16, expnt(s) = [0.8358825]
CPU time:        79.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83073923e-01 2.10313473e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319108e+02 3.91853319e+02
 2.35443537e+02 1.51855353e+02 7.61243066e+01 6.51114755e+01
 1.01381792e+01 1.43543985e+01 2.69429721e+01 2.98778367e+01
 3.06139938e-01 1.03981246e+00 1.75686337e+00 3.85539177e+00
 2.92507061e+00 5.65089567e+00 7.10870263e+00 3.38627580e+01
 2.31716631e+01 1.48313573e+02 9.97863097e+01 9.20074713e+02
 2.66883423e-01 5.59611191e-01 2.44160426e+00 8.90386333e+00
 8.35882503e-01 2.33166383e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999632100863781
cond(S) = 2208.3658159058787
E1 = -183.59001859975226  E_coul = 55.08018623874587
init E= -128.509832361006
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775402680526115  LUMO = 0.765668391591474
  mo_energy =
[-3.25551109e+01 -1.85272376e+00 -7.75402681e-01 -7.75402681e-01
 -7.75402681e-01  7.65668392e-01  8.26835591e-01  8.26835591e-01
  8.26835591e-01  3.92828699e+00  3.96461375e+00  3.96461375e+00
  3.96461375e+00  1.22367212e+01  1.43637510e+01  1.43637510e+01
  1.43637510e+01  4.07060367e+01  5.30007214e+01  5.30007214e+01
  5.30007214e+01  1.44197437e+02  2.40827385e+02  2.40827385e+02
  2.40827385e+02  5.06798261e+02  1.87306521e+03  8.00212091e+03
  4.77694224e+04]
E1 = -182.08625999479077  E_coul = 53.548075789251435
cycle= 1 E= -128.538184205539  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51874
diis-c [-0.26909099  1.        ]
  HOMO = -0.884281627321325  LUMO = 0.738298919539318
  mo_energy =
[-3.28782969e+01 -1.96656712e+00 -8.84281627e-01 -8.84281627e-01
 -8.84281627e-01  7.38298920e-01  7.99963479e-01  7.99963479e-01
  7.99963479e-01  3.85629341e+00  3.86711685e+00  3.86711685e+00
  3.86711685e+00  1.20946159e+01  1.41730927e+01  1.41730927e+01
  1.41730927e+01  4.04616127e+01  5.27198042e+01  5.27198042e+01
  5.27198042e+01  1.43880976e+02  2.40481031e+02  2.40481031e+02
  2.40481031e+02  5.06437001e+02  1.87266760e+03  8.00169417e+03
  4.77689767e+04]
E1 = -182.84738530620086  E_coul = 54.30661432833286
cycle= 2 E= -128.540770977868  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263362
diis-c [-6.62145150e-04  3.35940782e-01  6.64059218e-01]
  HOMO = -0.848660583000438  LUMO = 0.747063633419196
  mo_energy =
[-3.27702133e+01 -1.92905859e+00 -8.48660583e-01 -8.48660583e-01
 -8.48660583e-01  7.47063633e-01  8.08725210e-01  8.08725210e-01
  8.08725210e-01  3.87954892e+00  3.89874775e+00  3.89874775e+00
  3.89874775e+00  1.21412674e+01  1.42362478e+01  1.42362478e+01
  1.42362478e+01  4.05434442e+01  5.28138057e+01  5.28138057e+01
  5.28138057e+01  1.43986538e+02  2.40594685e+02  2.40594685e+02
  2.40594685e+02  5.06553702e+02  1.87278964e+03  8.00181867e+03
  4.77691022e+04]
E1 = -182.58879854142526  E_coul = 54.047108264714495
cycle= 3 E= -128.541690276711  delta_E= -0.000919  |g|= 0.000539  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120751
diis-c [-2.09982262e-07 -2.37604926e-03 -4.31290063e-04  1.00280734e+00]
  HOMO = -0.848929518162676  LUMO = 0.747010323268379
  mo_energy =
[-3.27707012e+01 -1.92926284e+00 -8.48929518e-01 -8.48929518e-01
 -8.48929518e-01  7.47010323e-01  8.08681680e-01  8.08681680e-01
  8.08681680e-01  3.87941130e+00  3.89855924e+00  3.89855924e+00
  3.89855924e+00  1.21410132e+01  1.42359229e+01  1.42359229e+01
  1.42359229e+01  4.05430661e+01  5.28133749e+01  5.28133749e+01
  5.28133749e+01  1.43986049e+02  2.40594124e+02  2.40594124e+02
  2.40594124e+02  5.06553083e+02  1.87278888e+03  8.00181781e+03
  4.77691013e+04]
E1 = -182.5893075669765  E_coul = 54.04761726186144
cycle= 4 E= -128.541690305115  delta_E= -2.84e-08  |g|= 8.13e-05  |ddm|= 0.000415
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188029
diis-c [-1.08979090e-09  2.40615011e-04  4.57138161e-04 -1.85850656e-01
  1.18515290e+00]
  HOMO = -0.848973154456572  LUMO = 0.746997762142643
  mo_energy =
[-3.27707751e+01 -1.92929574e+00 -8.48973154e-01 -8.48973154e-01
 -8.48973154e-01  7.46997762e-01  8.08668006e-01  8.08668006e-01
  8.08668006e-01  3.87938222e+00  3.89851859e+00  3.89851859e+00
  3.89851859e+00  1.21409639e+01  1.42358628e+01  1.42358628e+01
  1.42358628e+01  4.05430007e+01  5.28133050e+01  5.28133050e+01
  5.28133050e+01  1.43985975e+02  2.40594045e+02  2.40594045e+02
  2.40594045e+02  5.06553000e+02  1.87278879e+03  8.00181771e+03
  4.77691012e+04]
E1 = -182.58944053514168  E_coul = 54.04775022928474
cycle= 5 E= -128.541690305857  delta_E= -7.42e-10  |g|= 5.93e-06  |ddm|= 7.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.58944053514168  E_coul = 54.04775022928474
  HOMO = -0.848970037407518  LUMO = 0.746999018272417
  mo_energy =
[-3.27707681e+01 -1.92929183e+00 -8.48970037e-01 -8.48970037e-01
 -8.48970037e-01  7.46999018e-01  8.08668926e-01  8.08668926e-01
  8.08668926e-01  3.87938482e+00  3.89852157e+00  3.89852157e+00
  3.89852157e+00  1.21409682e+01  1.42358679e+01  1.42358679e+01
  1.42358679e+01  4.05430069e+01  5.28133116e+01  5.28133116e+01
  5.28133116e+01  1.43985982e+02  2.40594052e+02  2.40594052e+02
  2.40594052e+02  5.06553007e+02  1.87278880e+03  8.00181772e+03
  4.77691012e+04]
E1 = -182.5894246500236  E_coul = 54.047734344164795
Extra cycle  E= -128.541690305859  delta_E= -1.88e-12  |g|= 2.24e-06  |ddm|= 2.03e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.15 sec
exp = [7.83073923e-01 2.44137942e+04 3.66145158e+03 8.33319108e+02
 2.35443537e+02 7.61243066e+01 1.01381792e+01 2.69429721e+01
 3.06139938e-01 1.75686337e+00 2.92507061e+00 7.10870263e+00
 2.31716631e+01 9.97863097e+01 2.66883423e-01 2.44160426e+00
 8.35882503e-01]
E = -128.54169030585882
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783073922605       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158321        1
[INPUT] 0    0    [1    /1   ]  833.31910809         1
[INPUT] 0    0    [1    /1   ]  235.443537475        1
[INPUT] 0    0    [1    /1   ]  76.1243066486        1
[INPUT] 0    0    [1    /1   ]  10.1381792368        1
[INPUT] 0    0    [1    /1   ]  26.9429720563        1
[INPUT] 0    0    [1    /1   ]  0.306139938181       1
[INPUT] 0    0    [1    /1   ]  1.75686337445        1
[INPUT] 0    0    [1    /1   ]  2.92507060534        1
[INPUT] 1    0    [1    /1   ]  7.10870263366        1
[INPUT] 1    0    [1    /1   ]  23.1716630643        1
[INPUT] 1    0    [1    /1   ]  99.7863096959        1
[INPUT] 1    0    [1    /1   ]  0.266883422747       1
[INPUT] 1    0    [1    /1   ]  2.44160426092        1
[INPUT] 1    0    [1    /1   ]  0.835882502995       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.783073922604655, 1.0]], [0, [24413.79418629848, 1.0]], [0, [3661.451583207071, 1.0]], [0, [833.3191080896848, 1.0]], [0, [235.44353747466252, 1.0]], [0, [76.12430664861843, 1.0]], [0, [10.138179236843552, 1.0]], [0, [26.942972056342903, 1.0]], [0, [0.3061399381814858, 1.0]], [0, [1.7568633744529307, 1.0]], [0, [2.9250706053375484, 1.0]], [1, [7.108702633656093, 1.0]], [1, [23.171663064347435, 1.0]], [1, [99.78630969589719, 1.0]], [1, [0.2668834227470271, 1.0]], [1, [2.441604260918683, 1.0]], [1, [0.8358825029950308, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78307392]
bas 1, expnt(s) = [24413.7941863]
bas 2, expnt(s) = [3661.45158321]
bas 3, expnt(s) = [833.31910809]
bas 4, expnt(s) = [235.44353747]
bas 5, expnt(s) = [76.12430665]
bas 6, expnt(s) = [10.13817924]
bas 7, expnt(s) = [26.94297206]
bas 8, expnt(s) = [0.30613994]
bas 9, expnt(s) = [1.75686337]
bas 10, expnt(s) = [2.92507061]
bas 11, expnt(s) = [7.10870263]
bas 12, expnt(s) = [23.17166306]
bas 13, expnt(s) = [99.7863097]
bas 14, expnt(s) = [0.26688342]
bas 15, expnt(s) = [2.44160426]
bas 16, expnt(s) = [0.8358825]
CPU time:        80.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83073923e-01 2.10313473e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319108e+02 3.91853319e+02
 2.35443537e+02 1.51855353e+02 7.61243066e+01 6.51114755e+01
 1.01381792e+01 1.43543985e+01 2.69429721e+01 2.98778367e+01
 3.06139938e-01 1.03981246e+00 1.75686337e+00 3.85539177e+00
 2.92507061e+00 5.65089567e+00 7.10870263e+00 3.38627580e+01
 2.31716631e+01 1.48313573e+02 9.97863097e+01 9.20074713e+02
 2.66883423e-01 5.59611191e-01 2.44160426e+00 8.90386333e+00
 8.35882503e-01 2.33166383e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999632100863781
cond(S) = 2208.3658159058787
E1 = -183.59001859975226  E_coul = 55.08018623874587
init E= -128.509832361006
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402680526115  LUMO = 0.765668391591474
  mo_energy =
[-3.25551109e+01 -1.85272376e+00 -7.75402681e-01 -7.75402681e-01
 -7.75402681e-01  7.65668392e-01  8.26835591e-01  8.26835591e-01
  8.26835591e-01  3.92828699e+00  3.96461375e+00  3.96461375e+00
  3.96461375e+00  1.22367212e+01  1.43637510e+01  1.43637510e+01
  1.43637510e+01  4.07060367e+01  5.30007214e+01  5.30007214e+01
  5.30007214e+01  1.44197437e+02  2.40827385e+02  2.40827385e+02
  2.40827385e+02  5.06798261e+02  1.87306521e+03  8.00212091e+03
  4.77694224e+04]
E1 = -182.08625999479077  E_coul = 53.548075789251435
cycle= 1 E= -128.538184205539  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.51874
diis-c [-0.26909099  1.        ]
  HOMO = -0.884281627321325  LUMO = 0.738298919539318
  mo_energy =
[-3.28782969e+01 -1.96656712e+00 -8.84281627e-01 -8.84281627e-01
 -8.84281627e-01  7.38298920e-01  7.99963479e-01  7.99963479e-01
  7.99963479e-01  3.85629341e+00  3.86711685e+00  3.86711685e+00
  3.86711685e+00  1.20946159e+01  1.41730927e+01  1.41730927e+01
  1.41730927e+01  4.04616127e+01  5.27198042e+01  5.27198042e+01
  5.27198042e+01  1.43880976e+02  2.40481031e+02  2.40481031e+02
  2.40481031e+02  5.06437001e+02  1.87266760e+03  8.00169417e+03
  4.77689767e+04]
E1 = -182.84738530620086  E_coul = 54.30661432833286
cycle= 2 E= -128.540770977868  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263362
diis-c [-6.62145150e-04  3.35940782e-01  6.64059218e-01]
  HOMO = -0.848660583000438  LUMO = 0.747063633419196
  mo_energy =
[-3.27702133e+01 -1.92905859e+00 -8.48660583e-01 -8.48660583e-01
 -8.48660583e-01  7.47063633e-01  8.08725210e-01  8.08725210e-01
  8.08725210e-01  3.87954892e+00  3.89874775e+00  3.89874775e+00
  3.89874775e+00  1.21412674e+01  1.42362478e+01  1.42362478e+01
  1.42362478e+01  4.05434442e+01  5.28138057e+01  5.28138057e+01
  5.28138057e+01  1.43986538e+02  2.40594685e+02  2.40594685e+02
  2.40594685e+02  5.06553702e+02  1.87278964e+03  8.00181867e+03
  4.77691022e+04]
E1 = -182.58879854142526  E_coul = 54.047108264714495
cycle= 3 E= -128.541690276711  delta_E= -0.000919  |g|= 0.000539  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120751
diis-c [-2.09982262e-07 -2.37604926e-03 -4.31290063e-04  1.00280734e+00]
  HOMO = -0.848929518162676  LUMO = 0.747010323268379
  mo_energy =
[-3.27707012e+01 -1.92926284e+00 -8.48929518e-01 -8.48929518e-01
 -8.48929518e-01  7.47010323e-01  8.08681680e-01  8.08681680e-01
  8.08681680e-01  3.87941130e+00  3.89855924e+00  3.89855924e+00
  3.89855924e+00  1.21410132e+01  1.42359229e+01  1.42359229e+01
  1.42359229e+01  4.05430661e+01  5.28133749e+01  5.28133749e+01
  5.28133749e+01  1.43986049e+02  2.40594124e+02  2.40594124e+02
  2.40594124e+02  5.06553083e+02  1.87278888e+03  8.00181781e+03
  4.77691013e+04]
E1 = -182.5893075669765  E_coul = 54.04761726186144
cycle= 4 E= -128.541690305115  delta_E= -2.84e-08  |g|= 8.13e-05  |ddm|= 0.000415
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188029
diis-c [-1.08979090e-09  2.40615011e-04  4.57138161e-04 -1.85850656e-01
  1.18515290e+00]
  HOMO = -0.848973154456572  LUMO = 0.746997762142643
  mo_energy =
[-3.27707751e+01 -1.92929574e+00 -8.48973154e-01 -8.48973154e-01
 -8.48973154e-01  7.46997762e-01  8.08668006e-01  8.08668006e-01
  8.08668006e-01  3.87938222e+00  3.89851859e+00  3.89851859e+00
  3.89851859e+00  1.21409639e+01  1.42358628e+01  1.42358628e+01
  1.42358628e+01  4.05430007e+01  5.28133050e+01  5.28133050e+01
  5.28133050e+01  1.43985975e+02  2.40594045e+02  2.40594045e+02
  2.40594045e+02  5.06553000e+02  1.87278879e+03  8.00181771e+03
  4.77691012e+04]
E1 = -182.58944053514168  E_coul = 54.04775022928474
cycle= 5 E= -128.541690305857  delta_E= -7.42e-10  |g|= 5.93e-06  |ddm|= 7.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58944053514168  E_coul = 54.04775022928474
  HOMO = -0.848970037407518  LUMO = 0.746999018272417
  mo_energy =
[-3.27707681e+01 -1.92929183e+00 -8.48970037e-01 -8.48970037e-01
 -8.48970037e-01  7.46999018e-01  8.08668926e-01  8.08668926e-01
  8.08668926e-01  3.87938482e+00  3.89852157e+00  3.89852157e+00
  3.89852157e+00  1.21409682e+01  1.42358679e+01  1.42358679e+01
  1.42358679e+01  4.05430069e+01  5.28133116e+01  5.28133116e+01
  5.28133116e+01  1.43985982e+02  2.40594052e+02  2.40594052e+02
  2.40594052e+02  5.06553007e+02  1.87278880e+03  8.00181772e+03
  4.77691012e+04]
E1 = -182.5894246500236  E_coul = 54.047734344164795
Extra cycle  E= -128.541690305859  delta_E= -1.88e-12  |g|= 2.24e-06  |ddm|= 2.03e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2208.3658159058787
E1 = -182.5894246500236  E_coul = 54.047734344164795
init E= -128.541690305859
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.848971161194577  LUMO = 0.746998820932138
  mo_energy =
[-3.27707716e+01 -1.92929287e+00 -8.48971161e-01 -8.48971161e-01
 -8.48971161e-01  7.46998821e-01  8.08668668e-01  8.08668668e-01
  8.08668668e-01  3.87938418e+00  3.89852060e+00  3.89852060e+00
  3.89852060e+00  1.21409668e+01  1.42358659e+01  1.42358659e+01
  1.42358659e+01  4.05430042e+01  5.28133086e+01  5.28133086e+01
  5.28133086e+01  1.43985978e+02  2.40594049e+02  2.40594049e+02
  2.40594049e+02  5.06553003e+02  1.87278880e+03  8.00181772e+03
  4.77691012e+04]
E1 = -182.5894334743927  E_coul = 54.047743168533096
cycle= 1 E= -128.54169030586  delta_E= -7.96e-13  |g|= 1.21e-06  |ddm|= 8.06e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5894334743927  E_coul = 54.047743168533096
  HOMO = -0.848970539981428  LUMO = 0.746998989621645
  mo_energy =
[-3.27707698e+01 -1.92929219e+00 -8.48970540e-01 -8.48970540e-01
 -8.48970540e-01  7.46998990e-01  8.08668824e-01  8.08668824e-01
  8.08668824e-01  3.87938460e+00  3.89852116e+00  3.89852116e+00
  3.89852116e+00  1.21409676e+01  1.42358670e+01  1.42358670e+01
  1.42358670e+01  4.05430057e+01  5.28133102e+01  5.28133102e+01
  5.28133102e+01  1.43985980e+02  2.40594050e+02  2.40594050e+02
  2.40594050e+02  5.06553005e+02  1.87278880e+03  8.00181772e+03
  4.77691012e+04]
E1 = -182.58942904056428  E_coul = 54.047738734704765
Extra cycle  E= -128.54169030586  delta_E= 1.14e-13  |g|= 6.02e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [7.83073923e-01 2.44137942e+04 3.66145158e+03 8.33319108e+02
 2.35443537e+02 7.61243066e+01 1.01381792e+01 2.69429721e+01
 3.06139938e-01 1.75686337e+00 2.92507061e+00 7.10870263e+00
 2.31716631e+01 9.97863097e+01 2.66883423e-01 2.44160426e+00
 8.35882503e-01]
grad_E = [ 7.98198325e-05  1.36588306e-10 -6.15949446e-09  7.20229765e-08
 -4.33134534e-07  9.27163269e-06 -3.62876372e-04  8.54157332e-06
 -1.02055561e-04  5.20263616e-05 -8.05417805e-05  9.34699179e-07
  6.02674553e-06 -2.87769966e-07 -1.13604527e-04 -2.71049462e-04
  7.73111742e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.797915386657       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158406        1
[INPUT] 0    0    [1    /1   ]  833.319096665        1
[INPUT] 0    0    [1    /1   ]  235.44361767         1
[INPUT] 0    0    [1    /1   ]  76.123207535         1
[INPUT] 0    0    [1    /1   ]  10.1498912207        1
[INPUT] 0    0    [1    /1   ]  26.9448033792        1
[INPUT] 0    0    [1    /1   ]  0.309879623227       1
[INPUT] 0    0    [1    /1   ]  1.8034869355         1
[INPUT] 0    0    [1    /1   ]  2.93039580094        1
[INPUT] 1    0    [1    /1   ]  7.10725694416        1
[INPUT] 1    0    [1    /1   ]  23.1718310212        1
[INPUT] 1    0    [1    /1   ]  99.7863009441        1
[INPUT] 1    0    [1    /1   ]  0.266863306166       1
[INPUT] 1    0    [1    /1   ]  2.44393242141        1
[INPUT] 1    0    [1    /1   ]  0.836341709604       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7979153866573787, 1.0]], [0, [24413.794186280244, 1.0]], [0, [3661.451584059465, 1.0]], [0, [833.3190966648509, 1.0]], [0, [235.44361766975723, 1.0]], [0, [76.12320753502654, 1.0]], [0, [10.149891220727945, 1.0]], [0, [26.944803379207418, 1.0]], [0, [0.30987962322661305, 1.0]], [0, [1.8034869354968555, 1.0]], [0, [2.9303958009389834, 1.0]], [1, [7.107256944159105, 1.0]], [1, [23.171831021179642, 1.0]], [1, [99.78630094412651, 1.0]], [1, [0.2668633061661869, 1.0]], [1, [2.4439324214114797, 1.0]], [1, [0.8363417096036546, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79791539]
bas 1, expnt(s) = [24413.79418628]
bas 2, expnt(s) = [3661.45158406]
bas 3, expnt(s) = [833.31909666]
bas 4, expnt(s) = [235.44361767]
bas 5, expnt(s) = [76.12320754]
bas 6, expnt(s) = [10.14989122]
bas 7, expnt(s) = [26.94480338]
bas 8, expnt(s) = [0.30987962]
bas 9, expnt(s) = [1.80348694]
bas 10, expnt(s) = [2.9303958]
bas 11, expnt(s) = [7.10725694]
bas 12, expnt(s) = [23.17183102]
bas 13, expnt(s) = [99.78630094]
bas 14, expnt(s) = [0.26686331]
bas 15, expnt(s) = [2.44393242]
bas 16, expnt(s) = [0.83634171]
CPU time:        83.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.97915387e-01 2.13295972e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319097e+02 3.91853315e+02
 2.35443618e+02 1.51855392e+02 7.61232075e+01 6.51107704e+01
 1.01498912e+01 1.43668337e+01 2.69448034e+01 2.98793598e+01
 3.09879623e-01 1.04932444e+00 1.80348694e+00 3.93187565e+00
 2.93039580e+00 5.65860966e+00 7.10725694e+00 3.38541499e+01
 2.31718310e+01 1.48314917e+02 9.97863009e+01 9.20074612e+02
 2.66863306e-01 5.59558465e-01 2.44393242e+00 8.91447730e+00
 8.36341710e-01 2.33326511e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999631352468796
cond(S) = 2417.6281029984166
E1 = -183.59002018456917  E_coul = 55.08019150544464
init E= -128.509828679125
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775401903362015  LUMO = 0.781370246481818
  mo_energy =
[-3.25551137e+01 -1.85272131e+00 -7.75401903e-01 -7.75401903e-01
 -7.75401903e-01  7.81370246e-01  8.26903344e-01  8.26903344e-01
  8.26903344e-01  3.96705310e+00  3.96705310e+00  3.96705310e+00
  4.01056781e+00  1.24407172e+01  1.43702507e+01  1.43702507e+01
  1.43702507e+01  4.10154729e+01  5.30059734e+01  5.30059734e+01
  5.30059734e+01  1.44524062e+02  2.40830504e+02  2.40830504e+02
  2.40830504e+02  5.07101876e+02  1.87333825e+03  8.00236123e+03
  4.77696213e+04]
E1 = -182.0862590157797  E_coul = 53.548073692221315
cycle= 1 E= -128.538185323558  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518675
diis-c [-0.26902396  1.        ]
  HOMO = -0.884281233859929  LUMO = 0.753410736701676
  mo_energy =
[-3.28782989e+01 -1.96656793e+00 -8.84281234e-01 -8.84281234e-01
 -8.84281234e-01  7.53410737e-01  8.00025075e-01  8.00025075e-01
  8.00025075e-01  3.86949501e+00  3.86949501e+00  3.86949501e+00
  3.93747779e+00  1.22978049e+01  1.41795851e+01  1.41795851e+01
  1.41795851e+01  4.07710212e+01  5.27250649e+01  5.27250649e+01
  5.27250649e+01  1.44207654e+02  2.40484149e+02  2.40484149e+02
  2.40484149e+02  5.06740633e+02  1.87294065e+03  8.00193450e+03
  4.77691757e+04]
E1 = -182.84739666905543  E_coul = 54.30662461447388
cycle= 2 E= -128.540772054582  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.263335
diis-c [-6.63441492e-04  3.35943584e-01  6.64056416e-01]
  HOMO = -0.848659742174491  LUMO = 0.762366602629742
  mo_energy =
[-3.27702142e+01 -1.92905875e+00 -8.48659742e-01 -8.48659742e-01
 -8.48659742e-01  7.62366603e-01  8.08790239e-01  8.08790239e-01
  8.08790239e-01  3.90114650e+00  3.90114650e+00  3.90114650e+00
  3.96109225e+00  1.23447274e+01  1.42427439e+01  1.42427439e+01
  1.42427439e+01  4.08528626e+01  5.28190646e+01  5.28190646e+01
  5.28190646e+01  1.44313199e+02  2.40597804e+02  2.40597804e+02
  2.40597804e+02  5.06857329e+02  1.87306268e+03  8.00205899e+03
  4.77693011e+04]
E1 = -182.58881260101762  E_coul = 54.04712122693896
cycle= 3 E= -128.541691374079  delta_E= -0.000919  |g|= 0.000537  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120524
diis-c [-2.06932772e-07 -2.36859669e-03 -4.20177273e-04  1.00278877e+00]
  HOMO = -0.84892789313202  LUMO = 0.762312731127921
  mo_energy =
[-3.27707010e+01 -1.92926239e+00 -8.48927893e-01 -8.48927893e-01
 -8.48927893e-01  7.62312731e-01  8.08747125e-01  8.08747125e-01
  8.08747125e-01  3.90095863e+00  3.90095863e+00  3.90095863e+00
  3.96095324e+00  1.23444727e+01  1.42424201e+01  1.42424201e+01
  1.42424201e+01  4.08524854e+01  5.28186349e+01  5.28186349e+01
  5.28186349e+01  1.44312711e+02  2.40597244e+02  2.40597244e+02
  2.40597244e+02  5.06856712e+02  1.87306193e+03  8.00205814e+03
  4.77693002e+04]
E1 = -182.58932261189008  E_coul = 54.047631209760205
cycle= 4 E= -128.54169140213  delta_E= -2.81e-08  |g|= 8.09e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018759
diis-c [-1.08517247e-09  2.40028959e-04  4.57011716e-04 -1.85511058e-01
  1.18481402e+00]
  HOMO = -0.848971317140743  LUMO = 0.762300039693237
  mo_energy =
[-3.27707747e+01 -1.92929513e+00 -8.48971317e-01 -8.48971317e-01
 -8.48971317e-01  7.62300040e-01  8.08733543e-01  8.08733543e-01
  8.08733543e-01  3.90091815e+00  3.90091815e+00  3.90091815e+00
  3.96092395e+00  1.23444233e+01  1.42423602e+01  1.42423602e+01
  1.42423602e+01  4.08524202e+01  5.28185653e+01  5.28185653e+01
  5.28185653e+01  1.44312637e+02  2.40597166e+02  2.40597166e+02
  2.40597166e+02  5.06856629e+02  1.87306184e+03  8.00205804e+03
  4.77693001e+04]
E1 = -182.58945574359205  E_coul = 54.04776434073074
cycle= 5 E= -128.541691402861  delta_E= -7.31e-10  |g|= 5.91e-06  |ddm|= 7.08e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58945574359205  E_coul = 54.04776434073074
  HOMO = -0.848968207131769  LUMO = 0.762301315809896
  mo_energy =
[-3.27707677e+01 -1.92929123e+00 -8.48968207e-01 -8.48968207e-01
 -8.48968207e-01  7.62301316e-01  8.08734461e-01  8.08734461e-01
  8.08734461e-01  3.90092113e+00  3.90092113e+00  3.90092113e+00
  3.96092657e+00  1.23444277e+01  1.42423653e+01  1.42423653e+01
  1.42423653e+01  4.08524263e+01  5.28185719e+01  5.28185719e+01
  5.28185719e+01  1.44312644e+02  2.40597172e+02  2.40597172e+02
  2.40597172e+02  5.06856636e+02  1.87306184e+03  8.00205805e+03
  4.77693001e+04]
E1 = -182.58943990317897  E_coul = 54.04774850031523
Extra cycle  E= -128.541691402864  delta_E= -2.42e-12  |g|= 2.23e-06  |ddm|= 2.04e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.14 sec
exp = [7.97915387e-01 2.44137942e+04 3.66145158e+03 8.33319097e+02
 2.35443618e+02 7.61232075e+01 1.01498912e+01 2.69448034e+01
 3.09879623e-01 1.80348694e+00 2.93039580e+00 7.10725694e+00
 2.31718310e+01 9.97863009e+01 2.66863306e-01 2.44393242e+00
 8.36341710e-01]
E = -128.54169140286373
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.797915386657       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158406        1
[INPUT] 0    0    [1    /1   ]  833.319096665        1
[INPUT] 0    0    [1    /1   ]  235.44361767         1
[INPUT] 0    0    [1    /1   ]  76.123207535         1
[INPUT] 0    0    [1    /1   ]  10.1498912207        1
[INPUT] 0    0    [1    /1   ]  26.9448033792        1
[INPUT] 0    0    [1    /1   ]  0.309879623227       1
[INPUT] 0    0    [1    /1   ]  1.8034869355         1
[INPUT] 0    0    [1    /1   ]  2.93039580094        1
[INPUT] 1    0    [1    /1   ]  7.10725694416        1
[INPUT] 1    0    [1    /1   ]  23.1718310212        1
[INPUT] 1    0    [1    /1   ]  99.7863009441        1
[INPUT] 1    0    [1    /1   ]  0.266863306166       1
[INPUT] 1    0    [1    /1   ]  2.44393242141        1
[INPUT] 1    0    [1    /1   ]  0.836341709604       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7979153866573787, 1.0]], [0, [24413.794186280244, 1.0]], [0, [3661.451584059465, 1.0]], [0, [833.3190966648509, 1.0]], [0, [235.44361766975723, 1.0]], [0, [76.12320753502654, 1.0]], [0, [10.149891220727945, 1.0]], [0, [26.944803379207418, 1.0]], [0, [0.30987962322661305, 1.0]], [0, [1.8034869354968555, 1.0]], [0, [2.9303958009389834, 1.0]], [1, [7.107256944159105, 1.0]], [1, [23.171831021179642, 1.0]], [1, [99.78630094412651, 1.0]], [1, [0.2668633061661869, 1.0]], [1, [2.4439324214114797, 1.0]], [1, [0.8363417096036546, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79791539]
bas 1, expnt(s) = [24413.79418628]
bas 2, expnt(s) = [3661.45158406]
bas 3, expnt(s) = [833.31909666]
bas 4, expnt(s) = [235.44361767]
bas 5, expnt(s) = [76.12320754]
bas 6, expnt(s) = [10.14989122]
bas 7, expnt(s) = [26.94480338]
bas 8, expnt(s) = [0.30987962]
bas 9, expnt(s) = [1.80348694]
bas 10, expnt(s) = [2.9303958]
bas 11, expnt(s) = [7.10725694]
bas 12, expnt(s) = [23.17183102]
bas 13, expnt(s) = [99.78630094]
bas 14, expnt(s) = [0.26686331]
bas 15, expnt(s) = [2.44393242]
bas 16, expnt(s) = [0.83634171]
CPU time:        84.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.97915387e-01 2.13295972e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319097e+02 3.91853315e+02
 2.35443618e+02 1.51855392e+02 7.61232075e+01 6.51107704e+01
 1.01498912e+01 1.43668337e+01 2.69448034e+01 2.98793598e+01
 3.09879623e-01 1.04932444e+00 1.80348694e+00 3.93187565e+00
 2.93039580e+00 5.65860966e+00 7.10725694e+00 3.38541499e+01
 2.31718310e+01 1.48314917e+02 9.97863009e+01 9.20074612e+02
 2.66863306e-01 5.59558465e-01 2.44393242e+00 8.91447730e+00
 8.36341710e-01 2.33326511e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999631352468796
cond(S) = 2417.6281029984166
E1 = -183.59002018456917  E_coul = 55.08019150544464
init E= -128.509828679125
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401903362015  LUMO = 0.781370246481818
  mo_energy =
[-3.25551137e+01 -1.85272131e+00 -7.75401903e-01 -7.75401903e-01
 -7.75401903e-01  7.81370246e-01  8.26903344e-01  8.26903344e-01
  8.26903344e-01  3.96705310e+00  3.96705310e+00  3.96705310e+00
  4.01056781e+00  1.24407172e+01  1.43702507e+01  1.43702507e+01
  1.43702507e+01  4.10154729e+01  5.30059734e+01  5.30059734e+01
  5.30059734e+01  1.44524062e+02  2.40830504e+02  2.40830504e+02
  2.40830504e+02  5.07101876e+02  1.87333825e+03  8.00236123e+03
  4.77696213e+04]
E1 = -182.0862590157797  E_coul = 53.548073692221315
cycle= 1 E= -128.538185323558  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518675
diis-c [-0.26902396  1.        ]
  HOMO = -0.884281233859929  LUMO = 0.753410736701676
  mo_energy =
[-3.28782989e+01 -1.96656793e+00 -8.84281234e-01 -8.84281234e-01
 -8.84281234e-01  7.53410737e-01  8.00025075e-01  8.00025075e-01
  8.00025075e-01  3.86949501e+00  3.86949501e+00  3.86949501e+00
  3.93747779e+00  1.22978049e+01  1.41795851e+01  1.41795851e+01
  1.41795851e+01  4.07710212e+01  5.27250649e+01  5.27250649e+01
  5.27250649e+01  1.44207654e+02  2.40484149e+02  2.40484149e+02
  2.40484149e+02  5.06740633e+02  1.87294065e+03  8.00193450e+03
  4.77691757e+04]
E1 = -182.84739666905543  E_coul = 54.30662461447388
cycle= 2 E= -128.540772054582  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263335
diis-c [-6.63441492e-04  3.35943584e-01  6.64056416e-01]
  HOMO = -0.848659742174491  LUMO = 0.762366602629742
  mo_energy =
[-3.27702142e+01 -1.92905875e+00 -8.48659742e-01 -8.48659742e-01
 -8.48659742e-01  7.62366603e-01  8.08790239e-01  8.08790239e-01
  8.08790239e-01  3.90114650e+00  3.90114650e+00  3.90114650e+00
  3.96109225e+00  1.23447274e+01  1.42427439e+01  1.42427439e+01
  1.42427439e+01  4.08528626e+01  5.28190646e+01  5.28190646e+01
  5.28190646e+01  1.44313199e+02  2.40597804e+02  2.40597804e+02
  2.40597804e+02  5.06857329e+02  1.87306268e+03  8.00205899e+03
  4.77693011e+04]
E1 = -182.58881260101762  E_coul = 54.04712122693896
cycle= 3 E= -128.541691374079  delta_E= -0.000919  |g|= 0.000537  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120524
diis-c [-2.06932772e-07 -2.36859669e-03 -4.20177273e-04  1.00278877e+00]
  HOMO = -0.84892789313202  LUMO = 0.762312731127921
  mo_energy =
[-3.27707010e+01 -1.92926239e+00 -8.48927893e-01 -8.48927893e-01
 -8.48927893e-01  7.62312731e-01  8.08747125e-01  8.08747125e-01
  8.08747125e-01  3.90095863e+00  3.90095863e+00  3.90095863e+00
  3.96095324e+00  1.23444727e+01  1.42424201e+01  1.42424201e+01
  1.42424201e+01  4.08524854e+01  5.28186349e+01  5.28186349e+01
  5.28186349e+01  1.44312711e+02  2.40597244e+02  2.40597244e+02
  2.40597244e+02  5.06856712e+02  1.87306193e+03  8.00205814e+03
  4.77693002e+04]
E1 = -182.58932261189008  E_coul = 54.047631209760205
cycle= 4 E= -128.54169140213  delta_E= -2.81e-08  |g|= 8.09e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018759
diis-c [-1.08517247e-09  2.40028959e-04  4.57011716e-04 -1.85511058e-01
  1.18481402e+00]
  HOMO = -0.848971317140743  LUMO = 0.762300039693237
  mo_energy =
[-3.27707747e+01 -1.92929513e+00 -8.48971317e-01 -8.48971317e-01
 -8.48971317e-01  7.62300040e-01  8.08733543e-01  8.08733543e-01
  8.08733543e-01  3.90091815e+00  3.90091815e+00  3.90091815e+00
  3.96092395e+00  1.23444233e+01  1.42423602e+01  1.42423602e+01
  1.42423602e+01  4.08524202e+01  5.28185653e+01  5.28185653e+01
  5.28185653e+01  1.44312637e+02  2.40597166e+02  2.40597166e+02
  2.40597166e+02  5.06856629e+02  1.87306184e+03  8.00205804e+03
  4.77693001e+04]
E1 = -182.58945574359205  E_coul = 54.04776434073074
cycle= 5 E= -128.541691402861  delta_E= -7.31e-10  |g|= 5.91e-06  |ddm|= 7.08e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58945574359205  E_coul = 54.04776434073074
  HOMO = -0.848968207131769  LUMO = 0.762301315809896
  mo_energy =
[-3.27707677e+01 -1.92929123e+00 -8.48968207e-01 -8.48968207e-01
 -8.48968207e-01  7.62301316e-01  8.08734461e-01  8.08734461e-01
  8.08734461e-01  3.90092113e+00  3.90092113e+00  3.90092113e+00
  3.96092657e+00  1.23444277e+01  1.42423653e+01  1.42423653e+01
  1.42423653e+01  4.08524263e+01  5.28185719e+01  5.28185719e+01
  5.28185719e+01  1.44312644e+02  2.40597172e+02  2.40597172e+02
  2.40597172e+02  5.06856636e+02  1.87306184e+03  8.00205805e+03
  4.77693001e+04]
E1 = -182.58943990317897  E_coul = 54.04774850031523
Extra cycle  E= -128.541691402864  delta_E= -2.42e-12  |g|= 2.23e-06  |ddm|= 2.04e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2417.6281029984166
E1 = -182.58943990317897  E_coul = 54.04774850031523
init E= -128.541691402864
    CPU time for initialize scf      0.34 sec, wall time      0.34 sec
  HOMO = -0.848969327686618  LUMO = 0.76230111407664
  mo_energy =
[-3.27707712e+01 -1.92929227e+00 -8.48969328e-01 -8.48969328e-01
 -8.48969328e-01  7.62301114e-01  8.08734203e-01  8.08734203e-01
  8.08734203e-01  3.90092016e+00  3.90092016e+00  3.90092016e+00
  3.96092592e+00  1.23444262e+01  1.42423633e+01  1.42423633e+01
  1.42423633e+01  4.08524237e+01  5.28185689e+01  5.28185689e+01
  5.28185689e+01  1.44312640e+02  2.40597169e+02  2.40597169e+02
  2.40597169e+02  5.06856632e+02  1.87306184e+03  8.00205804e+03
  4.77693001e+04]
E1 = -182.58944870306465  E_coul = 54.0477573002003
cycle= 1 E= -128.541691402864  delta_E= -5.97e-13  |g|= 1.21e-06  |ddm|= 8.04e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58944870306465  E_coul = 54.0477573002003
  HOMO = -0.848968708191235  LUMO = 0.762301285830965
  mo_energy =
[-3.27707693e+01 -1.92929158e+00 -8.48968708e-01 -8.48968708e-01
 -8.48968708e-01  7.62301286e-01  8.08734359e-01  8.08734359e-01
  8.08734359e-01  3.90092072e+00  3.90092072e+00  3.90092072e+00
  3.96092635e+00  1.23444271e+01  1.42423644e+01  1.42423644e+01
  1.42423644e+01  4.08524251e+01  5.28185705e+01  5.28185705e+01
  5.28185705e+01  1.44312642e+02  2.40597171e+02  2.40597171e+02
  2.40597171e+02  5.06856634e+02  1.87306184e+03  8.00205804e+03
  4.77693001e+04]
E1 = -182.5894442815277  E_coul = 54.047752878663466
Extra cycle  E= -128.541691402864  delta_E= 8.53e-14  |g|= 6e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [7.97915387e-01 2.44137942e+04 3.66145158e+03 8.33319097e+02
 2.35443618e+02 7.61232075e+01 1.01498912e+01 2.69448034e+01
 3.09879623e-01 1.80348694e+00 2.93039580e+00 7.10725694e+00
 2.31718310e+01 9.97863009e+01 2.66863306e-01 2.44393242e+00
 8.36341710e-01]
grad_E = [ 6.25582721e-05  1.62578569e-10 -7.52670355e-09  9.98840081e-08
 -7.77455496e-07  1.20478933e-05 -3.49937903e-04 -3.09374437e-06
 -3.37453262e-05  5.72715779e-05 -7.37087379e-05 -1.14490757e-04
  1.92486362e-05 -7.69361199e-07  2.45744818e-05  1.09193888e-04
  2.88363081e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.802055841417       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158433        1
[INPUT] 0    0    [1    /1   ]  833.319093083        1
[INPUT] 0    0    [1    /1   ]  235.443642324        1
[INPUT] 0    0    [1    /1   ]  76.1228580549        1
[INPUT] 0    0    [1    /1   ]  10.154174374         1
[INPUT] 0    0    [1    /1   ]  26.945329183         1
[INPUT] 0    0    [1    /1   ]  0.310950073544       1
[INPUT] 0    0    [1    /1   ]  1.81812854973        1
[INPUT] 0    0    [1    /1   ]  2.93204179773        1
[INPUT] 1    0    [1    /1   ]  7.10688365293        1
[INPUT] 1    0    [1    /1   ]  23.1718669359        1
[INPUT] 1    0    [1    /1   ]  99.7862988998        1
[INPUT] 1    0    [1    /1   ]  0.266759165168       1
[INPUT] 1    0    [1    /1   ]  2.44464214981        1
[INPUT] 1    0    [1    /1   ]  0.836247797197       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8020558414165365, 1.0]], [0, [24413.794186274437, 1.0]], [0, [3661.451584330032, 1.0]], [0, [833.3190930826805, 1.0]], [0, [235.44364232416495, 1.0]], [0, [76.1228580549225, 1.0]], [0, [10.154174374001638, 1.0]], [0, [26.945329183043725, 1.0]], [0, [0.3109500735436317, 1.0]], [0, [1.818128549730365, 1.0]], [0, [2.9320417977254176, 1.0]], [1, [7.106883652926985, 1.0]], [1, [23.171866935864344, 1.0]], [1, [99.78629889978409, 1.0]], [1, [0.26675916516803827, 1.0]], [1, [2.4446421498081015, 1.0]], [1, [0.8362477971965487, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80205584]
bas 1, expnt(s) = [24413.79418627]
bas 2, expnt(s) = [3661.45158433]
bas 3, expnt(s) = [833.31909308]
bas 4, expnt(s) = [235.44364232]
bas 5, expnt(s) = [76.12285805]
bas 6, expnt(s) = [10.15417437]
bas 7, expnt(s) = [26.94532918]
bas 8, expnt(s) = [0.31095007]
bas 9, expnt(s) = [1.81812855]
bas 10, expnt(s) = [2.9320418]
bas 11, expnt(s) = [7.10688365]
bas 12, expnt(s) = [23.17186694]
bas 13, expnt(s) = [99.7862989]
bas 14, expnt(s) = [0.26675917]
bas 15, expnt(s) = [2.44464215]
bas 16, expnt(s) = [0.8362478]
CPU time:        87.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.02055841e-01 2.14125544e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319093e+02 3.91853314e+02
 2.35443642e+02 1.51855403e+02 7.61228581e+01 6.51105462e+01
 1.01541744e+01 1.43713805e+01 2.69453292e+01 2.98797971e+01
 3.10950074e-01 1.05204186e+00 1.81812855e+00 3.95579215e+00
 2.93204180e+00 5.66099332e+00 7.10688365e+00 3.38519273e+01
 2.31718669e+01 1.48315205e+02 9.97862989e+01 9.20074588e+02
 2.66759165e-01 5.59285525e-01 2.44464215e+00 8.91771342e+00
 8.36247797e-01 2.33293762e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999631746912126
cond(S) = 2486.1241917760326
E1 = -183.59001670987914  E_coul = 55.08019068494173
init E= -128.509826024937
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401920666002  LUMO = 0.785904882944461
  mo_energy =
[-3.25551151e+01 -1.85272079e+00 -7.75401921e-01 -7.75401921e-01
 -7.75401921e-01  7.85904883e-01  8.26582171e-01  8.26582171e-01
  8.26582171e-01  3.96683061e+00  3.96683061e+00  3.96683061e+00
  4.03474226e+00  1.25020915e+01  1.43711276e+01  1.43711276e+01
  1.43711276e+01  4.11107234e+01  5.30067760e+01  5.30067760e+01
  5.30067760e+01  1.44626091e+02  2.40830938e+02  2.40830938e+02
  2.40830938e+02  5.07197109e+02  1.87342396e+03  8.00243669e+03
  4.77696838e+04]
E1 = -182.08618411311008  E_coul = 53.547998752583446
cycle= 1 E= -128.538185360527  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518671
diis-c [-0.26901935  1.        ]
  HOMO = -0.884287033426622  LUMO = 0.757772705455883
  mo_energy =
[-3.28783120e+01 -1.96657517e+00 -8.84287033e-01 -8.84287033e-01
 -8.84287033e-01  7.57772705e-01  7.99713256e-01  7.99713256e-01
  7.99713256e-01  3.86925535e+00  3.86925535e+00  3.86925535e+00
  3.96132031e+00  1.23589210e+01  1.41804476e+01  1.41804476e+01
  1.41804476e+01  4.08662482e+01  5.27258576e+01  5.27258576e+01
  5.27258576e+01  1.44309687e+02  2.40484571e+02  2.40484571e+02
  2.40484571e+02  5.06835859e+02  1.87302635e+03  8.00200994e+03
  4.77692382e+04]
E1 = -182.84737994412467  E_coul = 54.30660765394797
cycle= 2 E= -128.540772290177  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263341
diis-c [-6.63867806e-04  3.35950748e-01  6.64049252e-01]
  HOMO = -0.848663052099065  LUMO = 0.766784806599011
  mo_energy =
[-3.27702209e+01 -1.92906325e+00 -8.48663052e-01 -8.48663052e-01
 -8.48663052e-01  7.66784807e-01  8.08476121e-01  8.08476121e-01
  8.08476121e-01  3.90091303e+00  3.90091303e+00  3.90091303e+00
  3.98504370e+00  1.24059307e+01  1.42436127e+01  1.42436127e+01
  1.42436127e+01  4.09480992e+01  5.28198626e+01  5.28198626e+01
  5.28198626e+01  1.44415233e+02  2.40598233e+02  2.40598233e+02
  2.40598233e+02  5.06952560e+02  1.87314839e+03  8.00213445e+03
  4.77693636e+04]
E1 = -182.58877699912517  E_coul = 54.047085254291105
cycle= 3 E= -128.541691744834  delta_E= -0.000919  |g|= 0.000536  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120359
diis-c [-2.05813749e-07 -2.36539805e-03 -4.18714081e-04  1.00278411e+00]
  HOMO = -0.848930760301035  LUMO = 0.766730876617839
  mo_energy =
[-3.27707071e+01 -1.92926651e+00 -8.48930760e-01 -8.48930760e-01
 -8.48930760e-01  7.66730877e-01  8.08433243e-01  8.08433243e-01
  8.08433243e-01  3.90072558e+00  3.90072558e+00  3.90072558e+00
  3.98490444e+00  1.24056761e+01  1.42432894e+01  1.42432894e+01
  1.42432894e+01  4.09477225e+01  5.28194336e+01  5.28194336e+01
  5.28194336e+01  1.44414746e+02  2.40597673e+02  2.40597673e+02
  2.40597673e+02  5.06951943e+02  1.87314764e+03  8.00213359e+03
  4.77693627e+04]
E1 = -182.58928676004078  E_coul = 54.04759498731416
cycle= 4 E= -128.541691772727  delta_E= -2.79e-08  |g|= 8.08e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187352
diis-c [-1.08356365e-09  2.39758144e-04  4.57044413e-04 -1.85395919e-01
  1.18469912e+00]
  HOMO = -0.848974092242809  LUMO = 0.766718159585549
  mo_energy =
[-3.27707806e+01 -1.92929918e+00 -8.48974092e-01 -8.48974092e-01
 -8.48974092e-01  7.66718160e-01  8.08419705e-01  8.08419705e-01
  8.08419705e-01  3.90068518e+00  3.90068518e+00  3.90068518e+00
  3.98487511e+00  1.24056268e+01  1.42432296e+01  1.42432296e+01
  1.42432296e+01  4.09476574e+01  5.28193641e+01  5.28193641e+01
  5.28193641e+01  1.44414672e+02  2.40597595e+02  2.40597595e+02
  2.40597595e+02  5.06951861e+02  1.87314755e+03  8.00213349e+03
  4.77693626e+04]
E1 = -182.58941989096792  E_coul = 54.047728117513856
cycle= 5 E= -128.541691773454  delta_E= -7.27e-10  |g|= 5.91e-06  |ddm|= 7.08e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58941989096792  E_coul = 54.047728117513856
  HOMO = -0.848970985114684  LUMO = 0.766719440822973
  mo_energy =
[-3.27707736e+01 -1.92929528e+00 -8.48970985e-01 -8.48970985e-01
 -8.48970985e-01  7.66719441e-01  8.08420621e-01  8.08420621e-01
  8.08420621e-01  3.90068816e+00  3.90068816e+00  3.90068816e+00
  3.98487774e+00  1.24056311e+01  1.42432347e+01  1.42432347e+01
  1.42432347e+01  4.09476635e+01  5.28193707e+01  5.28193707e+01
  5.28193707e+01  1.44414679e+02  2.40597602e+02  2.40597602e+02
  2.40597602e+02  5.06951868e+02  1.87314755e+03  8.00213350e+03
  4.77693626e+04]
E1 = -182.58940406248942  E_coul = 54.047712289032766
Extra cycle  E= -128.541691773457  delta_E= -2.59e-12  |g|= 2.23e-06  |ddm|= 2.04e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.02055841e-01 2.44137942e+04 3.66145158e+03 8.33319093e+02
 2.35443642e+02 7.61228581e+01 1.01541744e+01 2.69453292e+01
 3.10950074e-01 1.81812855e+00 2.93204180e+00 7.10688365e+00
 2.31718669e+01 9.97862989e+01 2.66759165e-01 2.44464215e+00
 8.36247797e-01]
E = -128.54169177345665
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.802055841417       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158433        1
[INPUT] 0    0    [1    /1   ]  833.319093083        1
[INPUT] 0    0    [1    /1   ]  235.443642324        1
[INPUT] 0    0    [1    /1   ]  76.1228580549        1
[INPUT] 0    0    [1    /1   ]  10.154174374         1
[INPUT] 0    0    [1    /1   ]  26.945329183         1
[INPUT] 0    0    [1    /1   ]  0.310950073544       1
[INPUT] 0    0    [1    /1   ]  1.81812854973        1
[INPUT] 0    0    [1    /1   ]  2.93204179773        1
[INPUT] 1    0    [1    /1   ]  7.10688365293        1
[INPUT] 1    0    [1    /1   ]  23.1718669359        1
[INPUT] 1    0    [1    /1   ]  99.7862988998        1
[INPUT] 1    0    [1    /1   ]  0.266759165168       1
[INPUT] 1    0    [1    /1   ]  2.44464214981        1
[INPUT] 1    0    [1    /1   ]  0.836247797197       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8020558414165365, 1.0]], [0, [24413.794186274437, 1.0]], [0, [3661.451584330032, 1.0]], [0, [833.3190930826805, 1.0]], [0, [235.44364232416495, 1.0]], [0, [76.1228580549225, 1.0]], [0, [10.154174374001638, 1.0]], [0, [26.945329183043725, 1.0]], [0, [0.3109500735436317, 1.0]], [0, [1.818128549730365, 1.0]], [0, [2.9320417977254176, 1.0]], [1, [7.106883652926985, 1.0]], [1, [23.171866935864344, 1.0]], [1, [99.78629889978409, 1.0]], [1, [0.26675916516803827, 1.0]], [1, [2.4446421498081015, 1.0]], [1, [0.8362477971965487, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80205584]
bas 1, expnt(s) = [24413.79418627]
bas 2, expnt(s) = [3661.45158433]
bas 3, expnt(s) = [833.31909308]
bas 4, expnt(s) = [235.44364232]
bas 5, expnt(s) = [76.12285805]
bas 6, expnt(s) = [10.15417437]
bas 7, expnt(s) = [26.94532918]
bas 8, expnt(s) = [0.31095007]
bas 9, expnt(s) = [1.81812855]
bas 10, expnt(s) = [2.9320418]
bas 11, expnt(s) = [7.10688365]
bas 12, expnt(s) = [23.17186694]
bas 13, expnt(s) = [99.7862989]
bas 14, expnt(s) = [0.26675917]
bas 15, expnt(s) = [2.44464215]
bas 16, expnt(s) = [0.8362478]
CPU time:        87.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.02055841e-01 2.14125544e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319093e+02 3.91853314e+02
 2.35443642e+02 1.51855403e+02 7.61228581e+01 6.51105462e+01
 1.01541744e+01 1.43713805e+01 2.69453292e+01 2.98797971e+01
 3.10950074e-01 1.05204186e+00 1.81812855e+00 3.95579215e+00
 2.93204180e+00 5.66099332e+00 7.10688365e+00 3.38519273e+01
 2.31718669e+01 1.48315205e+02 9.97862989e+01 9.20074588e+02
 2.66759165e-01 5.59285525e-01 2.44464215e+00 8.91771342e+00
 8.36247797e-01 2.33293762e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999631746912126
cond(S) = 2486.1241917760326
E1 = -183.59001670987914  E_coul = 55.08019068494173
init E= -128.509826024937
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401920666002  LUMO = 0.785904882944461
  mo_energy =
[-3.25551151e+01 -1.85272079e+00 -7.75401921e-01 -7.75401921e-01
 -7.75401921e-01  7.85904883e-01  8.26582171e-01  8.26582171e-01
  8.26582171e-01  3.96683061e+00  3.96683061e+00  3.96683061e+00
  4.03474226e+00  1.25020915e+01  1.43711276e+01  1.43711276e+01
  1.43711276e+01  4.11107234e+01  5.30067760e+01  5.30067760e+01
  5.30067760e+01  1.44626091e+02  2.40830938e+02  2.40830938e+02
  2.40830938e+02  5.07197109e+02  1.87342396e+03  8.00243669e+03
  4.77696838e+04]
E1 = -182.08618411311008  E_coul = 53.547998752583446
cycle= 1 E= -128.538185360527  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518671
diis-c [-0.26901935  1.        ]
  HOMO = -0.884287033426622  LUMO = 0.757772705455883
  mo_energy =
[-3.28783120e+01 -1.96657517e+00 -8.84287033e-01 -8.84287033e-01
 -8.84287033e-01  7.57772705e-01  7.99713256e-01  7.99713256e-01
  7.99713256e-01  3.86925535e+00  3.86925535e+00  3.86925535e+00
  3.96132031e+00  1.23589210e+01  1.41804476e+01  1.41804476e+01
  1.41804476e+01  4.08662482e+01  5.27258576e+01  5.27258576e+01
  5.27258576e+01  1.44309687e+02  2.40484571e+02  2.40484571e+02
  2.40484571e+02  5.06835859e+02  1.87302635e+03  8.00200994e+03
  4.77692382e+04]
E1 = -182.84737994412467  E_coul = 54.30660765394797
cycle= 2 E= -128.540772290177  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263341
diis-c [-6.63867806e-04  3.35950748e-01  6.64049252e-01]
  HOMO = -0.848663052099065  LUMO = 0.766784806599011
  mo_energy =
[-3.27702209e+01 -1.92906325e+00 -8.48663052e-01 -8.48663052e-01
 -8.48663052e-01  7.66784807e-01  8.08476121e-01  8.08476121e-01
  8.08476121e-01  3.90091303e+00  3.90091303e+00  3.90091303e+00
  3.98504370e+00  1.24059307e+01  1.42436127e+01  1.42436127e+01
  1.42436127e+01  4.09480992e+01  5.28198626e+01  5.28198626e+01
  5.28198626e+01  1.44415233e+02  2.40598233e+02  2.40598233e+02
  2.40598233e+02  5.06952560e+02  1.87314839e+03  8.00213445e+03
  4.77693636e+04]
E1 = -182.58877699912517  E_coul = 54.047085254291105
cycle= 3 E= -128.541691744834  delta_E= -0.000919  |g|= 0.000536  |ddm|= 0.0217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120359
diis-c [-2.05813749e-07 -2.36539805e-03 -4.18714081e-04  1.00278411e+00]
  HOMO = -0.848930760301035  LUMO = 0.766730876617839
  mo_energy =
[-3.27707071e+01 -1.92926651e+00 -8.48930760e-01 -8.48930760e-01
 -8.48930760e-01  7.66730877e-01  8.08433243e-01  8.08433243e-01
  8.08433243e-01  3.90072558e+00  3.90072558e+00  3.90072558e+00
  3.98490444e+00  1.24056761e+01  1.42432894e+01  1.42432894e+01
  1.42432894e+01  4.09477225e+01  5.28194336e+01  5.28194336e+01
  5.28194336e+01  1.44414746e+02  2.40597673e+02  2.40597673e+02
  2.40597673e+02  5.06951943e+02  1.87314764e+03  8.00213359e+03
  4.77693627e+04]
E1 = -182.58928676004078  E_coul = 54.04759498731416
cycle= 4 E= -128.541691772727  delta_E= -2.79e-08  |g|= 8.08e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187352
diis-c [-1.08356365e-09  2.39758144e-04  4.57044413e-04 -1.85395919e-01
  1.18469912e+00]
  HOMO = -0.848974092242809  LUMO = 0.766718159585549
  mo_energy =
[-3.27707806e+01 -1.92929918e+00 -8.48974092e-01 -8.48974092e-01
 -8.48974092e-01  7.66718160e-01  8.08419705e-01  8.08419705e-01
  8.08419705e-01  3.90068518e+00  3.90068518e+00  3.90068518e+00
  3.98487511e+00  1.24056268e+01  1.42432296e+01  1.42432296e+01
  1.42432296e+01  4.09476574e+01  5.28193641e+01  5.28193641e+01
  5.28193641e+01  1.44414672e+02  2.40597595e+02  2.40597595e+02
  2.40597595e+02  5.06951861e+02  1.87314755e+03  8.00213349e+03
  4.77693626e+04]
E1 = -182.58941989096792  E_coul = 54.047728117513856
cycle= 5 E= -128.541691773454  delta_E= -7.27e-10  |g|= 5.91e-06  |ddm|= 7.08e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58941989096792  E_coul = 54.047728117513856
  HOMO = -0.848970985114684  LUMO = 0.766719440822973
  mo_energy =
[-3.27707736e+01 -1.92929528e+00 -8.48970985e-01 -8.48970985e-01
 -8.48970985e-01  7.66719441e-01  8.08420621e-01  8.08420621e-01
  8.08420621e-01  3.90068816e+00  3.90068816e+00  3.90068816e+00
  3.98487774e+00  1.24056311e+01  1.42432347e+01  1.42432347e+01
  1.42432347e+01  4.09476635e+01  5.28193707e+01  5.28193707e+01
  5.28193707e+01  1.44414679e+02  2.40597602e+02  2.40597602e+02
  2.40597602e+02  5.06951868e+02  1.87314755e+03  8.00213350e+03
  4.77693626e+04]
E1 = -182.58940406248942  E_coul = 54.047712289032766
Extra cycle  E= -128.541691773457  delta_E= -2.59e-12  |g|= 2.23e-06  |ddm|= 2.04e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2486.1241917760326
E1 = -182.58940406248942  E_coul = 54.047712289032766
init E= -128.541691773457
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.848972104834889  LUMO = 0.766719237725186
  mo_energy =
[-3.27707771e+01 -1.92929632e+00 -8.48972105e-01 -8.48972105e-01
 -8.48972105e-01  7.66719238e-01  8.08420364e-01  8.08420364e-01
  8.08420364e-01  3.90068719e+00  3.90068719e+00  3.90068719e+00
  3.98487708e+00  1.24056297e+01  1.42432327e+01  1.42432327e+01
  1.42432327e+01  4.09476609e+01  5.28193677e+01  5.28193677e+01
  5.28193677e+01  1.44414676e+02  2.40597598e+02  2.40597598e+02
  2.40597598e+02  5.06951864e+02  1.87314755e+03  8.00213350e+03
  4.77693626e+04]
E1 = -182.5894128551992  E_coul = 54.047721081742324
cycle= 1 E= -128.541691773457  delta_E= -2.27e-13  |g|= 1.2e-06  |ddm|= 8.03e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5894128551992  E_coul = 54.047721081742324
  HOMO = -0.848971485843883  LUMO = 0.766719410356157
  mo_energy =
[-3.27707752e+01 -1.92929564e+00 -8.48971486e-01 -8.48971486e-01
 -8.48971486e-01  7.66719410e-01  8.08420520e-01  8.08420520e-01
  8.08420520e-01  3.90068775e+00  3.90068775e+00  3.90068775e+00
  3.98487752e+00  1.24056305e+01  1.42432338e+01  1.42432338e+01
  1.42432338e+01  4.09476624e+01  5.28193693e+01  5.28193693e+01
  5.28193693e+01  1.44414677e+02  2.40597600e+02  2.40597600e+02
  2.40597600e+02  5.06951866e+02  1.87314755e+03  8.00213350e+03
  4.77693626e+04]
E1 = -182.5894084370932  E_coul = 54.04771666363595
Extra cycle  E= -128.541691773457  delta_E= -3.69e-13  |g|= 6e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [8.02055841e-01 2.44137942e+04 3.66145158e+03 8.33319093e+02
 2.35443642e+02 7.61228581e+01 1.01541744e+01 2.69453292e+01
 3.10950074e-01 1.81812855e+00 2.93204180e+00 7.10688365e+00
 2.31718669e+01 9.97862989e+01 2.66759165e-01 2.44464215e+00
 8.36247797e-01]
grad_E = [ 4.71807875e-05  1.74292318e-10 -8.14232613e-09  1.12384295e-07
 -9.30234635e-07  1.32611140e-05 -3.43522057e-04 -8.18763457e-06
  7.38375713e-06  6.00541885e-05 -7.22407613e-05 -1.59602058e-04
  2.40763530e-05 -9.40467516e-07  9.96169015e-05  2.81855699e-04
  1.84334164e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.806400327336       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158467        1
[INPUT] 0    0    [1    /1   ]  833.319088677        1
[INPUT] 0    0    [1    /1   ]  235.443672045        1
[INPUT] 0    0    [1    /1   ]  76.1224196174        1
[INPUT] 0    0    [1    /1   ]  10.160480023         1
[INPUT] 0    0    [1    /1   ]  26.9458990341        1
[INPUT] 0    0    [1    /1   ]  0.311958272929       1
[INPUT] 0    0    [1    /1   ]  1.83566839848        1
[INPUT] 0    0    [1    /1   ]  2.93406629437        1
[INPUT] 1    0    [1    /1   ]  7.10668452254        1
[INPUT] 1    0    [1    /1   ]  23.1718663754        1
[INPUT] 1    0    [1    /1   ]  99.786298205         1
[INPUT] 1    0    [1    /1   ]  0.266523944878       1
[INPUT] 1    0    [1    /1   ]  2.4452036111         1
[INPUT] 1    0    [1    /1   ]  0.835815914506       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8064003273355831, 1.0]], [0, [24413.794186267176, 1.0]], [0, [3661.4515846673307, 1.0]], [0, [833.3190886771141, 1.0]], [0, [235.44367204544778, 1.0]], [0, [76.12241961739052, 1.0]], [0, [10.16048002296543, 1.0]], [0, [26.94589903409479, 1.0]], [0, [0.3119582729293602, 1.0]], [0, [1.8356683984754918, 1.0]], [0, [2.934066294371372, 1.0]], [1, [7.1066845225364235, 1.0]], [1, [23.17186637539548, 1.0]], [1, [99.78629820502921, 1.0]], [1, [0.26652394487751657, 1.0]], [1, [2.445203611104848, 1.0]], [1, [0.8358159145061753, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80640033]
bas 1, expnt(s) = [24413.79418627]
bas 2, expnt(s) = [3661.45158467]
bas 3, expnt(s) = [833.31908868]
bas 4, expnt(s) = [235.44367205]
bas 5, expnt(s) = [76.12241962]
bas 6, expnt(s) = [10.16048002]
bas 7, expnt(s) = [26.94589903]
bas 8, expnt(s) = [0.31195827]
bas 9, expnt(s) = [1.8356684]
bas 10, expnt(s) = [2.93406629]
bas 11, expnt(s) = [7.10668452]
bas 12, expnt(s) = [23.17186638]
bas 13, expnt(s) = [99.78629821]
bas 14, expnt(s) = [0.26652394]
bas 15, expnt(s) = [2.44520361]
bas 16, expnt(s) = [0.83581591]
CPU time:        91.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.06400327e-01 2.14994844e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319089e+02 3.91853312e+02
 2.35443672e+02 1.51855418e+02 7.61224196e+01 6.51102649e+01
 1.01604800e+01 1.43780733e+01 2.69458990e+01 2.98802711e+01
 3.11958273e-01 1.05459912e+00 1.83566840e+00 3.98437951e+00
 2.93406629e+00 5.66392464e+00 7.10668452e+00 3.38507417e+01
 2.31718664e+01 1.48315200e+02 9.97862982e+01 9.20074580e+02
 2.66523945e-01 5.58669142e-01 2.44520361e+00 8.92027366e+00
 8.35815915e-01 2.33143165e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963299059488
cond(S) = 2566.8423043067214
E1 = -183.5900079771604  E_coul = 55.080187752764324
init E= -128.509820224396
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775402217594898  LUMO = 0.79055835883001
  mo_energy =
[-3.25551170e+01 -1.85272049e+00 -7.75402218e-01 -7.75402218e-01
 -7.75402218e-01  7.90558359e-01  8.25797263e-01  8.25797263e-01
  8.25797263e-01  3.96516601e+00  3.96516601e+00  3.96516601e+00
  4.06120065e+00  1.25721361e+01  1.43701181e+01  1.43701181e+01
  1.43701181e+01  4.12230894e+01  5.30061557e+01  5.30061557e+01
  5.30061557e+01  1.44748997e+02  2.40830449e+02  2.40830449e+02
  2.40830449e+02  5.07312508e+02  1.87352794e+03  8.00252826e+03
  4.77697596e+04]
E1 = -182.0860008722547  E_coul = 53.54781561465653
cycle= 1 E= -128.538185257598  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518687
diis-c [-0.2690361  1.       ]
  HOMO = -0.884301646371481  LUMO = 0.762241416867664
  mo_energy =
[-3.28783433e+01 -1.96659230e+00 -8.84301646e-01 -8.84301646e-01
 -8.84301646e-01  7.62241417e-01  7.98952665e-01  7.98952665e-01
  7.98952665e-01  3.86757856e+00  3.86757856e+00  3.86757856e+00
  3.98739250e+00  1.24286453e+01  1.41794066e+01  1.41794066e+01
  1.41794066e+01  4.09785651e+01  5.27252085e+01  5.27252085e+01
  5.27252085e+01  1.44432582e+02  2.40484052e+02  2.40484052e+02
  2.40484052e+02  5.06951233e+02  1.87313030e+03  8.00210148e+03
  4.77693140e+04]
E1 = -182.84732913182103  E_coul = 54.30655644385911
cycle= 2 E= -128.540772687962  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263368
diis-c [-0.00066442  0.33596599  0.66403401]
  HOMO = -0.848671952787761  LUMO = 0.771313799104982
  mo_energy =
[-3.27702374e+01 -1.92907414e+00 -8.48671953e-01 -8.48671953e-01
 -8.48671953e-01  7.71313799e-01  8.07708572e-01  8.07708572e-01
  8.07708572e-01  3.89924115e+00  3.89924115e+00  3.89924115e+00
  4.01124274e+00  1.24757636e+01  1.42425848e+01  1.42425848e+01
  1.42425848e+01  4.10604359e+01  5.28192271e+01  5.28192271e+01
  5.28192271e+01  1.44538137e+02  2.40597729e+02  2.40597729e+02
  2.40597729e+02  5.07067948e+02  1.87325236e+03  8.00222600e+03
  4.77694394e+04]
E1 = -182.58867914386533  E_coul = 54.04698668674572
cycle= 3 E= -128.54169245712  delta_E= -0.00092  |g|= 0.000534  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120105
diis-c [-2.04585623e-07 -2.36150087e-03 -4.19476093e-04  1.00278098e+00]
  HOMO = -0.848939062583681  LUMO = 0.771259870487262
  mo_energy =
[-3.27707224e+01 -1.92927688e+00 -8.48939063e-01 -8.48939063e-01
 -8.48939063e-01  7.71259870e-01  8.07666028e-01  8.07666028e-01
  8.07666028e-01  3.89905431e+00  3.89905431e+00  3.89905431e+00
  4.01110329e+00  1.24755092e+01  1.42422624e+01  1.42422624e+01
  1.42422624e+01  4.10600601e+01  5.28187991e+01  5.28187991e+01
  5.28187991e+01  1.44537650e+02  2.40597170e+02  2.40597170e+02
  2.40597170e+02  5.07067332e+02  1.87325161e+03  8.00222515e+03
  4.77694385e+04]
E1 = -182.589188012798  E_coul = 54.047495527978754
cycle= 4 E= -128.541692484819  delta_E= -2.77e-08  |g|= 8.06e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187049
diis-c [-1.08227435e-09  2.39407676e-04  4.57238843e-04 -1.85284057e-01
  1.18458741e+00]
  HOMO = -0.848982288923287  LUMO = 0.771247129682777
  mo_energy =
[-3.27707958e+01 -1.92930947e+00 -8.48982289e-01 -8.48982289e-01
 -8.48982289e-01  7.71247130e-01  8.07652546e-01  8.07652546e-01
  8.07652546e-01  3.89901401e+00  3.89901401e+00  3.89901401e+00
  4.01107391e+00  1.24754599e+01  1.42422027e+01  1.42422027e+01
  1.42422027e+01  4.10599951e+01  5.28187298e+01  5.28187298e+01
  5.28187298e+01  1.44537577e+02  2.40597092e+02  2.40597092e+02
  2.40597092e+02  5.07067250e+02  1.87325152e+03  8.00222505e+03
  4.77694384e+04]
E1 = -182.58932111256408  E_coul = 54.04762862702145
cycle= 5 E= -128.541692485543  delta_E= -7.23e-10  |g|= 5.9e-06  |ddm|= 7.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58932111256408  E_coul = 54.04762862702145
  HOMO = -0.848979184483272  LUMO = 0.771248416235897
  mo_energy =
[-3.27707888e+01 -1.92930557e+00 -8.48979184e-01 -8.48979184e-01
 -8.48979184e-01  7.71248416e-01  8.07653460e-01  8.07653460e-01
  8.07653460e-01  3.89901698e+00  3.89901698e+00  3.89901698e+00
  4.01107655e+00  1.24754643e+01  1.42422078e+01  1.42422078e+01
  1.42422078e+01  4.10600012e+01  5.28187363e+01  5.28187363e+01
  5.28187363e+01  1.44537584e+02  2.40597099e+02  2.40597099e+02
  2.40597099e+02  5.07067257e+02  1.87325153e+03  8.00222506e+03
  4.77694384e+04]
E1 = -182.58930529206253  E_coul = 54.04761280651711
Extra cycle  E= -128.541692485545  delta_E= -2.79e-12  |g|= 2.23e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.06400327e-01 2.44137942e+04 3.66145158e+03 8.33319089e+02
 2.35443672e+02 7.61224196e+01 1.01604800e+01 2.69458990e+01
 3.11958273e-01 1.83566840e+00 2.93406629e+00 7.10668452e+00
 2.31718664e+01 9.97862982e+01 2.66523945e-01 2.44520361e+00
 8.35815915e-01]
E = -128.5416924855454
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.806400327336       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158467        1
[INPUT] 0    0    [1    /1   ]  833.319088677        1
[INPUT] 0    0    [1    /1   ]  235.443672045        1
[INPUT] 0    0    [1    /1   ]  76.1224196174        1
[INPUT] 0    0    [1    /1   ]  10.160480023         1
[INPUT] 0    0    [1    /1   ]  26.9458990341        1
[INPUT] 0    0    [1    /1   ]  0.311958272929       1
[INPUT] 0    0    [1    /1   ]  1.83566839848        1
[INPUT] 0    0    [1    /1   ]  2.93406629437        1
[INPUT] 1    0    [1    /1   ]  7.10668452254        1
[INPUT] 1    0    [1    /1   ]  23.1718663754        1
[INPUT] 1    0    [1    /1   ]  99.786298205         1
[INPUT] 1    0    [1    /1   ]  0.266523944878       1
[INPUT] 1    0    [1    /1   ]  2.4452036111         1
[INPUT] 1    0    [1    /1   ]  0.835815914506       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8064003273355831, 1.0]], [0, [24413.794186267176, 1.0]], [0, [3661.4515846673307, 1.0]], [0, [833.3190886771141, 1.0]], [0, [235.44367204544778, 1.0]], [0, [76.12241961739052, 1.0]], [0, [10.16048002296543, 1.0]], [0, [26.94589903409479, 1.0]], [0, [0.3119582729293602, 1.0]], [0, [1.8356683984754918, 1.0]], [0, [2.934066294371372, 1.0]], [1, [7.1066845225364235, 1.0]], [1, [23.17186637539548, 1.0]], [1, [99.78629820502921, 1.0]], [1, [0.26652394487751657, 1.0]], [1, [2.445203611104848, 1.0]], [1, [0.8358159145061753, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.80640033]
bas 1, expnt(s) = [24413.79418627]
bas 2, expnt(s) = [3661.45158467]
bas 3, expnt(s) = [833.31908868]
bas 4, expnt(s) = [235.44367205]
bas 5, expnt(s) = [76.12241962]
bas 6, expnt(s) = [10.16048002]
bas 7, expnt(s) = [26.94589903]
bas 8, expnt(s) = [0.31195827]
bas 9, expnt(s) = [1.8356684]
bas 10, expnt(s) = [2.93406629]
bas 11, expnt(s) = [7.10668452]
bas 12, expnt(s) = [23.17186638]
bas 13, expnt(s) = [99.78629821]
bas 14, expnt(s) = [0.26652394]
bas 15, expnt(s) = [2.44520361]
bas 16, expnt(s) = [0.83581591]
CPU time:        91.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.06400327e-01 2.14994844e+00 2.44137942e+04 4.93448103e+03
 3.66145158e+03 1.18920026e+03 8.33319089e+02 3.91853312e+02
 2.35443672e+02 1.51855418e+02 7.61224196e+01 6.51102649e+01
 1.01604800e+01 1.43780733e+01 2.69458990e+01 2.98802711e+01
 3.11958273e-01 1.05459912e+00 1.83566840e+00 3.98437951e+00
 2.93406629e+00 5.66392464e+00 7.10668452e+00 3.38507417e+01
 2.31718664e+01 1.48315200e+02 9.97862982e+01 9.20074580e+02
 2.66523945e-01 5.58669142e-01 2.44520361e+00 8.92027366e+00
 8.35815915e-01 2.33143165e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963299059488
cond(S) = 2566.8423043067214
E1 = -183.5900079771604  E_coul = 55.080187752764324
init E= -128.509820224396
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402217594898  LUMO = 0.79055835883001
  mo_energy =
[-3.25551170e+01 -1.85272049e+00 -7.75402218e-01 -7.75402218e-01
 -7.75402218e-01  7.90558359e-01  8.25797263e-01  8.25797263e-01
  8.25797263e-01  3.96516601e+00  3.96516601e+00  3.96516601e+00
  4.06120065e+00  1.25721361e+01  1.43701181e+01  1.43701181e+01
  1.43701181e+01  4.12230894e+01  5.30061557e+01  5.30061557e+01
  5.30061557e+01  1.44748997e+02  2.40830449e+02  2.40830449e+02
  2.40830449e+02  5.07312508e+02  1.87352794e+03  8.00252826e+03
  4.77697596e+04]
E1 = -182.0860008722547  E_coul = 53.54781561465653
cycle= 1 E= -128.538185257598  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518687
diis-c [-0.2690361  1.       ]
  HOMO = -0.884301646371481  LUMO = 0.762241416867664
  mo_energy =
[-3.28783433e+01 -1.96659230e+00 -8.84301646e-01 -8.84301646e-01
 -8.84301646e-01  7.62241417e-01  7.98952665e-01  7.98952665e-01
  7.98952665e-01  3.86757856e+00  3.86757856e+00  3.86757856e+00
  3.98739250e+00  1.24286453e+01  1.41794066e+01  1.41794066e+01
  1.41794066e+01  4.09785651e+01  5.27252085e+01  5.27252085e+01
  5.27252085e+01  1.44432582e+02  2.40484052e+02  2.40484052e+02
  2.40484052e+02  5.06951233e+02  1.87313030e+03  8.00210148e+03
  4.77693140e+04]
E1 = -182.84732913182103  E_coul = 54.30655644385911
cycle= 2 E= -128.540772687962  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263368
diis-c [-0.00066442  0.33596599  0.66403401]
  HOMO = -0.848671952787761  LUMO = 0.771313799104982
  mo_energy =
[-3.27702374e+01 -1.92907414e+00 -8.48671953e-01 -8.48671953e-01
 -8.48671953e-01  7.71313799e-01  8.07708572e-01  8.07708572e-01
  8.07708572e-01  3.89924115e+00  3.89924115e+00  3.89924115e+00
  4.01124274e+00  1.24757636e+01  1.42425848e+01  1.42425848e+01
  1.42425848e+01  4.10604359e+01  5.28192271e+01  5.28192271e+01
  5.28192271e+01  1.44538137e+02  2.40597729e+02  2.40597729e+02
  2.40597729e+02  5.07067948e+02  1.87325236e+03  8.00222600e+03
  4.77694394e+04]
E1 = -182.58867914386533  E_coul = 54.04698668674572
cycle= 3 E= -128.54169245712  delta_E= -0.00092  |g|= 0.000534  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120105
diis-c [-2.04585623e-07 -2.36150087e-03 -4.19476093e-04  1.00278098e+00]
  HOMO = -0.848939062583681  LUMO = 0.771259870487262
  mo_energy =
[-3.27707224e+01 -1.92927688e+00 -8.48939063e-01 -8.48939063e-01
 -8.48939063e-01  7.71259870e-01  8.07666028e-01  8.07666028e-01
  8.07666028e-01  3.89905431e+00  3.89905431e+00  3.89905431e+00
  4.01110329e+00  1.24755092e+01  1.42422624e+01  1.42422624e+01
  1.42422624e+01  4.10600601e+01  5.28187991e+01  5.28187991e+01
  5.28187991e+01  1.44537650e+02  2.40597170e+02  2.40597170e+02
  2.40597170e+02  5.07067332e+02  1.87325161e+03  8.00222515e+03
  4.77694385e+04]
E1 = -182.589188012798  E_coul = 54.047495527978754
cycle= 4 E= -128.541692484819  delta_E= -2.77e-08  |g|= 8.06e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187049
diis-c [-1.08227435e-09  2.39407676e-04  4.57238843e-04 -1.85284057e-01
  1.18458741e+00]
  HOMO = -0.848982288923287  LUMO = 0.771247129682777
  mo_energy =
[-3.27707958e+01 -1.92930947e+00 -8.48982289e-01 -8.48982289e-01
 -8.48982289e-01  7.71247130e-01  8.07652546e-01  8.07652546e-01
  8.07652546e-01  3.89901401e+00  3.89901401e+00  3.89901401e+00
  4.01107391e+00  1.24754599e+01  1.42422027e+01  1.42422027e+01
  1.42422027e+01  4.10599951e+01  5.28187298e+01  5.28187298e+01
  5.28187298e+01  1.44537577e+02  2.40597092e+02  2.40597092e+02
  2.40597092e+02  5.07067250e+02  1.87325152e+03  8.00222505e+03
  4.77694384e+04]
E1 = -182.58932111256408  E_coul = 54.04762862702145
cycle= 5 E= -128.541692485543  delta_E= -7.23e-10  |g|= 5.9e-06  |ddm|= 7.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58932111256408  E_coul = 54.04762862702145
  HOMO = -0.848979184483272  LUMO = 0.771248416235897
  mo_energy =
[-3.27707888e+01 -1.92930557e+00 -8.48979184e-01 -8.48979184e-01
 -8.48979184e-01  7.71248416e-01  8.07653460e-01  8.07653460e-01
  8.07653460e-01  3.89901698e+00  3.89901698e+00  3.89901698e+00
  4.01107655e+00  1.24754643e+01  1.42422078e+01  1.42422078e+01
  1.42422078e+01  4.10600012e+01  5.28187363e+01  5.28187363e+01
  5.28187363e+01  1.44537584e+02  2.40597099e+02  2.40597099e+02
  2.40597099e+02  5.07067257e+02  1.87325153e+03  8.00222506e+03
  4.77694384e+04]
E1 = -182.58930529206253  E_coul = 54.04761280651711
Extra cycle  E= -128.541692485545  delta_E= -2.79e-12  |g|= 2.23e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2566.8423043067214
E1 = -182.58930529206253  E_coul = 54.04761280651711
init E= -128.541692485545
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848980303658884  LUMO = 0.771248211590636
  mo_energy =
[-3.27707923e+01 -1.92930661e+00 -8.48980304e-01 -8.48980304e-01
 -8.48980304e-01  7.71248212e-01  8.07653203e-01  8.07653203e-01
  8.07653203e-01  3.89901601e+00  3.89901601e+00  3.89901601e+00
  4.01107589e+00  1.24754628e+01  1.42422059e+01  1.42422059e+01
  1.42422059e+01  4.10599986e+01  5.28187333e+01  5.28187333e+01
  5.28187333e+01  1.44537580e+02  2.40597095e+02  2.40597095e+02
  2.40597095e+02  5.07067253e+02  1.87325152e+03  8.00222505e+03
  4.77694384e+04]
E1 = -182.5893140796934  E_coul = 54.04762159414787
cycle= 1 E= -128.541692485546  delta_E= -1.14e-13  |g|= 1.2e-06  |ddm|= 8.03e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5893140796934  E_coul = 54.04762159414787
  HOMO = -0.848979685020907  LUMO = 0.771248385190681
  mo_energy =
[-3.27707905e+01 -1.92930593e+00 -8.48979685e-01 -8.48979685e-01
 -8.48979685e-01  7.71248385e-01  8.07653359e-01  8.07653359e-01
  8.07653359e-01  3.89901657e+00  3.89901657e+00  3.89901657e+00
  4.01107632e+00  1.24754637e+01  1.42422069e+01  1.42422069e+01
  1.42422069e+01  4.10600000e+01  5.28187349e+01  5.28187349e+01
  5.28187349e+01  1.44537582e+02  2.40597097e+02  2.40597097e+02
  2.40597097e+02  5.07067255e+02  1.87325153e+03  8.00222505e+03
  4.77694384e+04]
E1 = -182.58930966380464  E_coul = 54.04761717825889
Extra cycle  E= -128.541692485546  delta_E= -2.27e-13  |g|= 6e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.41 sec
exp = [8.06400327e-01 2.44137942e+04 3.66145158e+03 8.33319089e+02
 2.35443672e+02 7.61224196e+01 1.01604800e+01 2.69458990e+01
 3.11958273e-01 1.83566840e+00 2.93406629e+00 7.10668452e+00
 2.31718664e+01 9.97862982e+01 2.66523945e-01 2.44520361e+00
 8.35815915e-01]
grad_E = [ 3.14725380e-05  1.95095526e-10 -9.23509283e-09  1.34516701e-07
 -1.19882934e-06  1.53738322e-05 -3.31003908e-04 -1.71342098e-05
  3.98288540e-05  6.28314977e-05 -7.12488691e-05 -2.10601136e-04
  2.91256133e-05 -1.11359468e-06  2.00760902e-04  5.05629255e-04
 -3.79968019e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.812520541028       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158521        1
[INPUT] 0    0    [1    /1   ]  833.319081571        1
[INPUT] 0    0    [1    /1   ]  235.443720165        1
[INPUT] 0    0    [1    /1   ]  76.121700346         1
[INPUT] 0    0    [1    /1   ]  10.1719436466        1
[INPUT] 0    0    [1    /1   ]  26.946744138         1
[INPUT] 0    0    [1    /1   ]  0.313456623894       1
[INPUT] 0    0    [1    /1   ]  1.86171082562        1
[INPUT] 0    0    [1    /1   ]  2.93750548601        1
[INPUT] 1    0    [1    /1   ]  7.10692952613        1
[INPUT] 1    0    [1    /1   ]  23.1717759285        1
[INPUT] 1    0    [1    /1   ]  99.7863007118        1
[INPUT] 1    0    [1    /1   ]  0.266067767518       1
[INPUT] 1    0    [1    /1   ]  2.4452446337         1
[INPUT] 1    0    [1    /1   ]  0.834777687802       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8125205410275628, 1.0]], [0, [24413.79418625542, 1.0]], [0, [3661.4515852127197, 1.0]], [0, [833.3190815711703, 1.0]], [0, [235.44372016476171, 1.0]], [0, [76.12170034595802, 1.0]], [0, [10.17194364663746, 1.0]], [0, [26.94674413800199, 1.0]], [0, [0.31345662389394396, 1.0]], [0, [1.8617108256152175, 1.0]], [0, [2.937505486009969, 1.0]], [1, [7.106929526134767, 1.0]], [1, [23.171775928530028, 1.0]], [1, [99.78630071183358, 1.0]], [1, [0.26606776751820016, 1.0]], [1, [2.445244633695319, 1.0]], [1, [0.8347776878016913, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81252054]
bas 1, expnt(s) = [24413.79418626]
bas 2, expnt(s) = [3661.45158521]
bas 3, expnt(s) = [833.31908157]
bas 4, expnt(s) = [235.44372016]
bas 5, expnt(s) = [76.12170035]
bas 6, expnt(s) = [10.17194365]
bas 7, expnt(s) = [26.94674414]
bas 8, expnt(s) = [0.31345662]
bas 9, expnt(s) = [1.86171083]
bas 10, expnt(s) = [2.93750549]
bas 11, expnt(s) = [7.10692953]
bas 12, expnt(s) = [23.17177593]
bas 13, expnt(s) = [99.78630071]
bas 14, expnt(s) = [0.26606777]
bas 15, expnt(s) = [2.44524463]
bas 16, expnt(s) = [0.83477769]
CPU time:        94.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12520541e-01 2.16217472e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319082e+02 3.91853310e+02
 2.35443720e+02 1.51855441e+02 7.61217003e+01 6.51098035e+01
 1.01719436e+01 1.43902382e+01 2.69467441e+01 2.98809739e+01
 3.13456624e-01 1.05839581e+00 1.86171083e+00 4.02669924e+00
 2.93750549e+00 5.66890317e+00 7.10692953e+00 3.38522004e+01
 2.31717759e+01 1.48314476e+02 9.97863007e+01 9.20074609e+02
 2.66067768e-01 5.57474138e-01 2.44524463e+00 8.92046073e+00
 8.34777688e-01 2.32781216e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963560480615
cond(S) = 2691.210896980143
E1 = -183.58998835642635  E_coul = 55.08018097191352
init E= -128.509807384513
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775402995460935  LUMO = 0.797360419919859
  mo_energy =
[-3.25551201e+01 -1.85272053e+00 -7.75402995e-01 -7.75402995e-01
 -7.75402995e-01  7.97360420e-01  8.24222042e-01  8.24222042e-01
  8.24222042e-01  3.96082022e+00  3.96082022e+00  3.96082022e+00
  4.09975574e+00  1.26755921e+01  1.43652118e+01  1.43652118e+01
  1.43652118e+01  4.13935250e+01  5.30025112e+01  5.30025112e+01
  5.30025112e+01  1.44939228e+02  2.40827992e+02  2.40827992e+02
  2.40827992e+02  5.07492176e+02  1.87369003e+03  8.00267103e+03
  4.77698778e+04]
E1 = -182.08565235883404  E_coul = 53.54746715950759
cycle= 1 E= -128.538185199326  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.518728
diis-c [-0.26907891  1.        ]
  HOMO = -0.884329458955829  LUMO = 0.768770982241544
  mo_energy =
[-3.28784023e+01 -1.96662526e+00 -8.84329459e-01 -8.84329459e-01
 -8.84329459e-01  7.68770982e-01  7.97428270e-01  7.97428270e-01
  7.97428270e-01  3.86323652e+00  3.86323652e+00  3.86323652e+00
  4.02537783e+00  1.25316108e+01  1.41744433e+01  1.41744433e+01
  1.41744433e+01  4.11489052e+01  5.27215050e+01  5.27215050e+01
  5.27215050e+01  1.44622782e+02  2.40481537e+02  2.40481537e+02
  2.40481537e+02  5.07130854e+02  1.87329234e+03  8.00224419e+03
  4.77694321e+04]
E1 = -182.8472300513575  E_coul = 54.306456456511356
cycle= 2 E= -128.540773594846  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263423
diis-c [-0.00066533  0.33599399  0.66400601]
  HOMO = -0.848688961503145  LUMO = 0.777931966544291
  mo_energy =
[-3.27702684e+01 -1.92909533e+00 -8.48688962e-01 -8.48688962e-01
 -8.48688962e-01  7.77931967e-01  8.06168940e-01  8.06168940e-01
  8.06168940e-01  3.89489940e+00  3.89489940e+00  3.89489940e+00
  4.04941544e+00  1.25788959e+01  1.42376452e+01  1.42376452e+01
  1.42376452e+01  4.12308142e+01  5.28155505e+01  5.28155505e+01
  5.28155505e+01  1.44728356e+02  2.40595244e+02  2.40595244e+02
  2.40595244e+02  5.07247596e+02  1.87341443e+03  8.00236875e+03
  4.77695576e+04]
E1 = -182.58848863338014  E_coul = 54.04679467380801
cycle= 3 E= -128.541693959572  delta_E= -0.00092  |g|= 0.000532  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119687
diis-c [-2.02543414e-07 -2.35551532e-03 -4.21708238e-04  1.00277722e+00]
  HOMO = -0.848955190853876  LUMO = 0.777877986645629
  mo_energy =
[-3.27707519e+01 -1.92929737e+00 -8.48955191e-01 -8.48955191e-01
 -8.48955191e-01  7.77877987e-01  8.06126898e-01  8.06126898e-01
  8.06126898e-01  3.89471347e+00  3.89471347e+00  3.89471347e+00
  4.04927569e+00  1.25786418e+01  1.42373240e+01  1.42373240e+01
  1.42373240e+01  4.12304396e+01  5.28151239e+01  5.28151239e+01
  5.28151239e+01  1.44727871e+02  2.40594687e+02  2.40594687e+02
  2.40594687e+02  5.07246982e+02  1.87341368e+03  8.00236789e+03
  4.77695567e+04]
E1 = -182.58899567896646  E_coul = 54.04730169198415
cycle= 4 E= -128.541693986982  delta_E= -2.74e-08  |g|= 8.03e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186552
diis-c [-1.07913139e-09  2.38505730e-04  4.57562955e-04 -1.84951066e-01
  1.18425500e+00]
  HOMO = -0.848998270934254  LUMO = 0.777865194446833
  mo_energy =
[-3.27708251e+01 -1.92932987e+00 -8.48998271e-01 -8.48998271e-01
 -8.48998271e-01  7.77865194e-01  8.06113499e-01  8.06113499e-01
  8.06113499e-01  3.89467331e+00  3.89467331e+00  3.89467331e+00
  4.04924623e+00  1.25785925e+01  1.42372645e+01  1.42372645e+01
  1.42372645e+01  4.12303748e+01  5.28150548e+01  5.28150548e+01
  5.28150548e+01  1.44727798e+02  2.40594609e+02  2.40594609e+02
  2.40594609e+02  5.07246900e+02  1.87341359e+03  8.00236780e+03
  4.77695566e+04]
E1 = -182.58912868773794  E_coul = 54.04743470003941
cycle= 5 E= -128.541693987699  delta_E= -7.16e-10  |g|= 5.88e-06  |ddm|= 7.06e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58912868773794  E_coul = 54.04743470003941
  HOMO = -0.848995176491258  LUMO = 0.777866486312202
  mo_energy =
[-3.27708181e+01 -1.92932598e+00 -8.48995176e-01 -8.48995176e-01
 -8.48995176e-01  7.77866486e-01  8.06114408e-01  8.06114408e-01
  8.06114408e-01  3.89467627e+00  3.89467627e+00  3.89467627e+00
  4.04924888e+00  1.25785969e+01  1.42372696e+01  1.42372696e+01
  1.42372696e+01  4.12303809e+01  5.28150613e+01  5.28150613e+01
  5.28150613e+01  1.44727805e+02  2.40594616e+02  2.40594616e+02
  2.40594616e+02  5.07246907e+02  1.87341359e+03  8.00236781e+03
  4.77695566e+04]
E1 = -182.58911289996746  E_coul = 54.04741891226645
Extra cycle  E= -128.541693987701  delta_E= -2.5e-12  |g|= 2.22e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.12520541e-01 2.44137942e+04 3.66145159e+03 8.33319082e+02
 2.35443720e+02 7.61217003e+01 1.01719436e+01 2.69467441e+01
 3.13456624e-01 1.86171083e+00 2.93750549e+00 7.10692953e+00
 2.31717759e+01 9.97863007e+01 2.66067768e-01 2.44524463e+00
 8.34777688e-01]
E = -128.54169398770102
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.812520541028       1
[INPUT] 0    0    [1    /1   ]  24413.7941863        1
[INPUT] 0    0    [1    /1   ]  3661.45158521        1
[INPUT] 0    0    [1    /1   ]  833.319081571        1
[INPUT] 0    0    [1    /1   ]  235.443720165        1
[INPUT] 0    0    [1    /1   ]  76.121700346         1
[INPUT] 0    0    [1    /1   ]  10.1719436466        1
[INPUT] 0    0    [1    /1   ]  26.946744138         1
[INPUT] 0    0    [1    /1   ]  0.313456623894       1
[INPUT] 0    0    [1    /1   ]  1.86171082562        1
[INPUT] 0    0    [1    /1   ]  2.93750548601        1
[INPUT] 1    0    [1    /1   ]  7.10692952613        1
[INPUT] 1    0    [1    /1   ]  23.1717759285        1
[INPUT] 1    0    [1    /1   ]  99.7863007118        1
[INPUT] 1    0    [1    /1   ]  0.266067767518       1
[INPUT] 1    0    [1    /1   ]  2.4452446337         1
[INPUT] 1    0    [1    /1   ]  0.834777687802       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8125205410275628, 1.0]], [0, [24413.79418625542, 1.0]], [0, [3661.4515852127197, 1.0]], [0, [833.3190815711703, 1.0]], [0, [235.44372016476171, 1.0]], [0, [76.12170034595802, 1.0]], [0, [10.17194364663746, 1.0]], [0, [26.94674413800199, 1.0]], [0, [0.31345662389394396, 1.0]], [0, [1.8617108256152175, 1.0]], [0, [2.937505486009969, 1.0]], [1, [7.106929526134767, 1.0]], [1, [23.171775928530028, 1.0]], [1, [99.78630071183358, 1.0]], [1, [0.26606776751820016, 1.0]], [1, [2.445244633695319, 1.0]], [1, [0.8347776878016913, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81252054]
bas 1, expnt(s) = [24413.79418626]
bas 2, expnt(s) = [3661.45158521]
bas 3, expnt(s) = [833.31908157]
bas 4, expnt(s) = [235.44372016]
bas 5, expnt(s) = [76.12170035]
bas 6, expnt(s) = [10.17194365]
bas 7, expnt(s) = [26.94674414]
bas 8, expnt(s) = [0.31345662]
bas 9, expnt(s) = [1.86171083]
bas 10, expnt(s) = [2.93750549]
bas 11, expnt(s) = [7.10692953]
bas 12, expnt(s) = [23.17177593]
bas 13, expnt(s) = [99.78630071]
bas 14, expnt(s) = [0.26606777]
bas 15, expnt(s) = [2.44524463]
bas 16, expnt(s) = [0.83477769]
CPU time:        95.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12520541e-01 2.16217472e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319082e+02 3.91853310e+02
 2.35443720e+02 1.51855441e+02 7.61217003e+01 6.51098035e+01
 1.01719436e+01 1.43902382e+01 2.69467441e+01 2.98809739e+01
 3.13456624e-01 1.05839581e+00 1.86171083e+00 4.02669924e+00
 2.93750549e+00 5.66890317e+00 7.10692953e+00 3.38522004e+01
 2.31717759e+01 1.48314476e+02 9.97863007e+01 9.20074609e+02
 2.66067768e-01 5.57474138e-01 2.44524463e+00 8.92046073e+00
 8.34777688e-01 2.32781216e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963560480615
cond(S) = 2691.210896980143
E1 = -183.58998835642635  E_coul = 55.08018097191352
init E= -128.509807384513
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402995460935  LUMO = 0.797360419919859
  mo_energy =
[-3.25551201e+01 -1.85272053e+00 -7.75402995e-01 -7.75402995e-01
 -7.75402995e-01  7.97360420e-01  8.24222042e-01  8.24222042e-01
  8.24222042e-01  3.96082022e+00  3.96082022e+00  3.96082022e+00
  4.09975574e+00  1.26755921e+01  1.43652118e+01  1.43652118e+01
  1.43652118e+01  4.13935250e+01  5.30025112e+01  5.30025112e+01
  5.30025112e+01  1.44939228e+02  2.40827992e+02  2.40827992e+02
  2.40827992e+02  5.07492176e+02  1.87369003e+03  8.00267103e+03
  4.77698778e+04]
E1 = -182.08565235883404  E_coul = 53.54746715950759
cycle= 1 E= -128.538185199326  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518728
diis-c [-0.26907891  1.        ]
  HOMO = -0.884329458955829  LUMO = 0.768770982241544
  mo_energy =
[-3.28784023e+01 -1.96662526e+00 -8.84329459e-01 -8.84329459e-01
 -8.84329459e-01  7.68770982e-01  7.97428270e-01  7.97428270e-01
  7.97428270e-01  3.86323652e+00  3.86323652e+00  3.86323652e+00
  4.02537783e+00  1.25316108e+01  1.41744433e+01  1.41744433e+01
  1.41744433e+01  4.11489052e+01  5.27215050e+01  5.27215050e+01
  5.27215050e+01  1.44622782e+02  2.40481537e+02  2.40481537e+02
  2.40481537e+02  5.07130854e+02  1.87329234e+03  8.00224419e+03
  4.77694321e+04]
E1 = -182.8472300513575  E_coul = 54.306456456511356
cycle= 2 E= -128.540773594846  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263423
diis-c [-0.00066533  0.33599399  0.66400601]
  HOMO = -0.848688961503145  LUMO = 0.777931966544291
  mo_energy =
[-3.27702684e+01 -1.92909533e+00 -8.48688962e-01 -8.48688962e-01
 -8.48688962e-01  7.77931967e-01  8.06168940e-01  8.06168940e-01
  8.06168940e-01  3.89489940e+00  3.89489940e+00  3.89489940e+00
  4.04941544e+00  1.25788959e+01  1.42376452e+01  1.42376452e+01
  1.42376452e+01  4.12308142e+01  5.28155505e+01  5.28155505e+01
  5.28155505e+01  1.44728356e+02  2.40595244e+02  2.40595244e+02
  2.40595244e+02  5.07247596e+02  1.87341443e+03  8.00236875e+03
  4.77695576e+04]
E1 = -182.58848863338014  E_coul = 54.04679467380801
cycle= 3 E= -128.541693959572  delta_E= -0.00092  |g|= 0.000532  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119687
diis-c [-2.02543414e-07 -2.35551532e-03 -4.21708238e-04  1.00277722e+00]
  HOMO = -0.848955190853876  LUMO = 0.777877986645629
  mo_energy =
[-3.27707519e+01 -1.92929737e+00 -8.48955191e-01 -8.48955191e-01
 -8.48955191e-01  7.77877987e-01  8.06126898e-01  8.06126898e-01
  8.06126898e-01  3.89471347e+00  3.89471347e+00  3.89471347e+00
  4.04927569e+00  1.25786418e+01  1.42373240e+01  1.42373240e+01
  1.42373240e+01  4.12304396e+01  5.28151239e+01  5.28151239e+01
  5.28151239e+01  1.44727871e+02  2.40594687e+02  2.40594687e+02
  2.40594687e+02  5.07246982e+02  1.87341368e+03  8.00236789e+03
  4.77695567e+04]
E1 = -182.58899567896646  E_coul = 54.04730169198415
cycle= 4 E= -128.541693986982  delta_E= -2.74e-08  |g|= 8.03e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186552
diis-c [-1.07913139e-09  2.38505730e-04  4.57562955e-04 -1.84951066e-01
  1.18425500e+00]
  HOMO = -0.848998270934254  LUMO = 0.777865194446833
  mo_energy =
[-3.27708251e+01 -1.92932987e+00 -8.48998271e-01 -8.48998271e-01
 -8.48998271e-01  7.77865194e-01  8.06113499e-01  8.06113499e-01
  8.06113499e-01  3.89467331e+00  3.89467331e+00  3.89467331e+00
  4.04924623e+00  1.25785925e+01  1.42372645e+01  1.42372645e+01
  1.42372645e+01  4.12303748e+01  5.28150548e+01  5.28150548e+01
  5.28150548e+01  1.44727798e+02  2.40594609e+02  2.40594609e+02
  2.40594609e+02  5.07246900e+02  1.87341359e+03  8.00236780e+03
  4.77695566e+04]
E1 = -182.58912868773794  E_coul = 54.04743470003941
cycle= 5 E= -128.541693987699  delta_E= -7.16e-10  |g|= 5.88e-06  |ddm|= 7.06e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58912868773794  E_coul = 54.04743470003941
  HOMO = -0.848995176491258  LUMO = 0.777866486312202
  mo_energy =
[-3.27708181e+01 -1.92932598e+00 -8.48995176e-01 -8.48995176e-01
 -8.48995176e-01  7.77866486e-01  8.06114408e-01  8.06114408e-01
  8.06114408e-01  3.89467627e+00  3.89467627e+00  3.89467627e+00
  4.04924888e+00  1.25785969e+01  1.42372696e+01  1.42372696e+01
  1.42372696e+01  4.12303809e+01  5.28150613e+01  5.28150613e+01
  5.28150613e+01  1.44727805e+02  2.40594616e+02  2.40594616e+02
  2.40594616e+02  5.07246907e+02  1.87341359e+03  8.00236781e+03
  4.77695566e+04]
E1 = -182.58911289996746  E_coul = 54.04741891226645
Extra cycle  E= -128.541693987701  delta_E= -2.5e-12  |g|= 2.22e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2691.210896980143
E1 = -182.58911289996746  E_coul = 54.04741891226645
init E= -128.541693987701
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.848996293477355  LUMO = 0.777866279663361
  mo_energy =
[-3.27708216e+01 -1.92932702e+00 -8.48996293e-01 -8.48996293e-01
 -8.48996293e-01  7.77866280e-01  8.06114153e-01  8.06114153e-01
  8.06114153e-01  3.89467530e+00  3.89467530e+00  3.89467530e+00
  4.04924821e+00  1.25785954e+01  1.42372676e+01  1.42372676e+01
  1.42372676e+01  4.12303783e+01  5.28150583e+01  5.28150583e+01
  5.28150583e+01  1.44727801e+02  2.40594612e+02  2.40594612e+02
  2.40594612e+02  5.07246903e+02  1.87341359e+03  8.00236780e+03
  4.77695566e+04]
E1 = -182.5891216677408  E_coul = 54.04742768003936
cycle= 1 E= -128.541693987701  delta_E= -4.26e-13  |g|= 1.2e-06  |ddm|= 8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5891216677408  E_coul = 54.04742768003936
  HOMO = -0.848995676241773  LUMO = 0.777866454434484
  mo_energy =
[-3.27708198e+01 -1.92932634e+00 -8.48995676e-01 -8.48995676e-01
 -8.48995676e-01  7.77866454e-01  8.06114307e-01  8.06114307e-01
  8.06114307e-01  3.89467586e+00  3.89467586e+00  3.89467586e+00
  4.04924865e+00  1.25785963e+01  1.42372687e+01  1.42372687e+01
  1.42372687e+01  4.12303797e+01  5.28150599e+01  5.28150599e+01
  5.28150599e+01  1.44727803e+02  2.40594614e+02  2.40594614e+02
  2.40594614e+02  5.07246905e+02  1.87341359e+03  8.00236780e+03
  4.77695566e+04]
E1 = -182.5891172611892  E_coul = 54.047423273487674
Extra cycle  E= -128.541693987702  delta_E= -5.68e-14  |g|= 5.98e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [8.12520541e-01 2.44137942e+04 3.66145159e+03 8.33319082e+02
 2.35443720e+02 7.61217003e+01 1.01719436e+01 2.69467441e+01
 3.13456624e-01 1.86171083e+00 2.93750549e+00 7.10692953e+00
 2.31717759e+01 9.97863007e+01 2.66067768e-01 2.44524463e+00
 8.34777688e-01]
grad_E = [ 1.30346385e-06  2.36723560e-10 -1.14211992e-08  1.78750735e-07
 -1.73407414e-06  1.95702052e-05 -3.04692175e-04 -3.49996645e-05
  1.07960646e-04  6.62742700e-05 -7.08322309e-05 -2.57257301e-04
  3.29458710e-05 -1.23248775e-06  2.87268507e-04  7.65575664e-04
 -9.15711109e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.821078638392       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158613        1
[INPUT] 0    0    [1    /1   ]  833.319069752        1
[INPUT] 0    0    [1    /1   ]  235.443799581        1
[INPUT] 0    0    [1    /1   ]  76.1204843019        1
[INPUT] 0    0    [1    /1   ]  10.1932113354        1
[INPUT] 0    0    [1    /1   ]  26.9480040827        1
[INPUT] 0    0    [1    /1   ]  0.315099736948       1
[INPUT] 0    0    [1    /1   ]  1.90295197064        1
[INPUT] 0    0    [1    /1   ]  2.94325617245        1
[INPUT] 1    0    [1    /1   ]  7.10807643707        1
[INPUT] 1    0    [1    /1   ]  23.1715072628        1
[INPUT] 1    0    [1    /1   ]  99.786309648         1
[INPUT] 1    0    [1    /1   ]  0.265381120336       1
[INPUT] 1    0    [1    /1   ]  2.4440958373         1
[INPUT] 1    0    [1    /1   ]  0.832944785053       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8210786383921508, 1.0]], [0, [24413.79418623569, 1.0]], [0, [3661.4515861265236, 1.0]], [0, [833.3190697520656, 1.0]], [0, [235.44379958117665, 1.0]], [0, [76.12048430189239, 1.0]], [0, [10.193211335398729, 1.0]], [0, [26.948004082706547, 1.0]], [0, [0.3150997369484967, 1.0]], [0, [1.9029519706448366, 1.0]], [0, [2.943256172445695, 1.0]], [1, [7.10807643706506, 1.0]], [1, [23.171507262813744, 1.0]], [1, [99.78630964796737, 1.0]], [1, [0.26538112033603867, 1.0]], [1, [2.444095837299005, 1.0]], [1, [0.832944785052815, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82107864]
bas 1, expnt(s) = [24413.79418624]
bas 2, expnt(s) = [3661.45158613]
bas 3, expnt(s) = [833.31906975]
bas 4, expnt(s) = [235.44379958]
bas 5, expnt(s) = [76.1204843]
bas 6, expnt(s) = [10.19321134]
bas 7, expnt(s) = [26.94800408]
bas 8, expnt(s) = [0.31509974]
bas 9, expnt(s) = [1.90295197]
bas 10, expnt(s) = [2.94325617]
bas 11, expnt(s) = [7.10807644]
bas 12, expnt(s) = [23.17150726]
bas 13, expnt(s) = [99.78630965]
bas 14, expnt(s) = [0.26538112]
bas 15, expnt(s) = [2.44409584]
bas 16, expnt(s) = [0.83294479]
CPU time:        98.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.21078638e-01 2.17923261e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319070e+02 3.91853305e+02
 2.35443800e+02 1.51855480e+02 7.61204843e+01 6.51090234e+01
 1.01932113e+01 1.44127979e+01 2.69480041e+01 2.98820218e+01
 3.15099737e-01 1.06255411e+00 1.90295197e+00 4.09341611e+00
 2.94325617e+00 5.67722455e+00 7.10807644e+00 3.38590294e+01
 2.31715073e+01 1.48312327e+02 9.97863096e+01 9.20074712e+02
 2.65381120e-01 5.55676361e-01 2.44409584e+00 8.91522240e+00
 8.32944785e-01 2.32142501e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639769391875
cond(S) = 2896.097846742997
E1 = -183.5899534853177  E_coul = 55.08017298417557
init E= -128.509780501142
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775404153411726  LUMO = 0.80623816210858
  mo_energy =
[-3.25551234e+01 -1.85272092e+00 -7.75404153e-01 -7.75404153e-01
 -7.75404153e-01  8.06238162e-01  8.21777611e-01  8.21777611e-01
  8.21777611e-01  3.95288844e+00  3.95288844e+00  3.95288844e+00
  4.15519469e+00  1.28320929e+01  1.43543266e+01  1.43543266e+01
  1.43543266e+01  4.16613733e+01  5.29941972e+01  5.29941972e+01
  5.29941972e+01  1.45245057e+02  2.40822527e+02  2.40822527e+02
  2.40822527e+02  5.07782851e+02  1.87395259e+03  8.00290237e+03
  4.77700694e+04]
E1 = -182.08512382831066  E_coul = 53.54693813895249
cycle= 1 E= -128.538185689358  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518813
diis-c [-0.2691674  1.       ]
  HOMO = -0.884372236618683  LUMO = 0.777275226392064
  mo_energy =
[-3.28784914e+01 -1.96667462e+00 -8.84372237e-01 -8.84372237e-01
 -8.84372237e-01  7.77275226e-01  7.95064856e-01  7.95064856e-01
  7.95064856e-01  3.85534287e+00  3.85534287e+00  3.85534287e+00
  4.07995253e+00  1.26873323e+01  1.41634744e+01  1.41634744e+01
  1.41634744e+01  4.14165830e+01  5.27130957e+01  5.27130957e+01
  5.27130957e+01  1.44928561e+02  2.40475988e+02  2.40475988e+02
  2.40475988e+02  5.07421456e+02  1.87355482e+03  8.00247545e+03
  4.77696236e+04]
E1 = -182.84707152882228  E_coul = 54.306295957721936
cycle= 2 E= -128.5407755711  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0629
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263516
diis-c [-0.00066685  0.33603491  0.66396509]
  HOMO = -0.848715703052398  LUMO = 0.786557029948489
  mo_energy =
[-3.27703157e+01 -1.92912723e+00 -8.48715703e-01 -8.48715703e-01
 -8.48715703e-01  7.86557030e-01  8.03780328e-01  8.03780328e-01
  8.03780328e-01  3.88699511e+00  3.88699511e+00  3.88699511e+00
  4.10427424e+00  1.27348821e+01  1.42267104e+01  1.42267104e+01
  1.42267104e+01  4.14985573e+01  5.28071828e+01  5.28071828e+01
  5.28071828e+01  1.45034164e+02  2.40589739e+02  2.40589739e+02
  2.40589739e+02  5.07538238e+02  1.87367695e+03  8.00260005e+03
  4.77697491e+04]
E1 = -182.58819145041173  E_coul = 54.04649462645239
cycle= 3 E= -128.541696823959  delta_E= -0.000921  |g|= 0.00053  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119144
diis-c [-2.00401158e-07 -2.34922448e-03 -4.28646606e-04  1.00277787e+00]
  HOMO = -0.848980943997512  LUMO = 0.786502851303058
  mo_energy =
[-3.27707973e+01 -1.92932844e+00 -8.48980944e-01 -8.48980944e-01
 -8.48980944e-01  7.86502851e-01  8.03738873e-01  8.03738873e-01
  8.03738873e-01  3.88681028e+00  3.88681028e+00  3.88681028e+00
  4.10413376e+00  1.27346280e+01  1.42263907e+01  1.42263907e+01
  1.42263907e+01  4.14981842e+01  5.28067579e+01  5.28067579e+01
  5.28067579e+01  1.45033681e+02  2.40589184e+02  2.40589184e+02
  2.40589184e+02  5.07537626e+02  1.87367620e+03  8.00259920e+03
  4.77697482e+04]
E1 = -182.58869525016206  E_coul = 54.04699839909118
cycle= 4 E= -128.541696851071  delta_E= -2.71e-08  |g|= 8e-05  |ddm|= 0.000419
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186054
diis-c [-1.07716320e-09  2.37374928e-04  4.58532516e-04 -1.84568430e-01
  1.18387252e+00]
  HOMO = -0.849023896594351  LUMO = 0.786489958703923
  mo_energy =
[-3.27708703e+01 -1.92936088e+00 -8.49023897e-01 -8.49023897e-01
 -8.49023897e-01  7.86489959e-01  8.03725566e-01  8.03725566e-01
  8.03725566e-01  3.88677025e+00  3.88677025e+00  3.88677025e+00
  4.10410410e+00  1.27345787e+01  1.42263314e+01  1.42263314e+01
  1.42263314e+01  4.14981195e+01  5.28066890e+01  5.28066890e+01
  5.28066890e+01  1.45033608e+02  2.40589107e+02  2.40589107e+02
  2.40589107e+02  5.07537544e+02  1.87367611e+03  8.00259910e+03
  4.77697481e+04]
E1 = -182.58882816514026  E_coul = 54.04713131335964
cycle= 5 E= -128.541696851781  delta_E= -7.1e-10  |g|= 5.87e-06  |ddm|= 7.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58882816514026  E_coul = 54.04713131335964
  HOMO = -0.849020812429163  LUMO = 0.786491259340536
  mo_energy =
[-3.27708633e+01 -1.92935701e+00 -8.49020812e-01 -8.49020812e-01
 -8.49020812e-01  7.86491259e-01  8.03726468e-01  8.03726468e-01
  8.03726468e-01  3.88677320e+00  3.88677320e+00  3.88677320e+00
  4.10410676e+00  1.27345830e+01  1.42263364e+01  1.42263364e+01
  1.42263364e+01  4.14981256e+01  5.28066955e+01  5.28066955e+01
  5.28066955e+01  1.45033615e+02  2.40589113e+02  2.40589113e+02
  2.40589113e+02  5.07537551e+02  1.87367612e+03  8.00259911e+03
  4.77697481e+04]
E1 = -182.58881241219441  E_coul = 54.04711556041122
Extra cycle  E= -128.541696851783  delta_E= -2.59e-12  |g|= 2.22e-06  |ddm|= 2.06e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.21078638e-01 2.44137942e+04 3.66145159e+03 8.33319070e+02
 2.35443800e+02 7.61204843e+01 1.01932113e+01 2.69480041e+01
 3.15099737e-01 1.90295197e+00 2.94325617e+00 7.10807644e+00
 2.31715073e+01 9.97863096e+01 2.65381120e-01 2.44409584e+00
 8.32944785e-01]
E = -128.5416968517832
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.821078638392       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158613        1
[INPUT] 0    0    [1    /1   ]  833.319069752        1
[INPUT] 0    0    [1    /1   ]  235.443799581        1
[INPUT] 0    0    [1    /1   ]  76.1204843019        1
[INPUT] 0    0    [1    /1   ]  10.1932113354        1
[INPUT] 0    0    [1    /1   ]  26.9480040827        1
[INPUT] 0    0    [1    /1   ]  0.315099736948       1
[INPUT] 0    0    [1    /1   ]  1.90295197064        1
[INPUT] 0    0    [1    /1   ]  2.94325617245        1
[INPUT] 1    0    [1    /1   ]  7.10807643707        1
[INPUT] 1    0    [1    /1   ]  23.1715072628        1
[INPUT] 1    0    [1    /1   ]  99.786309648         1
[INPUT] 1    0    [1    /1   ]  0.265381120336       1
[INPUT] 1    0    [1    /1   ]  2.4440958373         1
[INPUT] 1    0    [1    /1   ]  0.832944785053       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8210786383921508, 1.0]], [0, [24413.79418623569, 1.0]], [0, [3661.4515861265236, 1.0]], [0, [833.3190697520656, 1.0]], [0, [235.44379958117665, 1.0]], [0, [76.12048430189239, 1.0]], [0, [10.193211335398729, 1.0]], [0, [26.948004082706547, 1.0]], [0, [0.3150997369484967, 1.0]], [0, [1.9029519706448366, 1.0]], [0, [2.943256172445695, 1.0]], [1, [7.10807643706506, 1.0]], [1, [23.171507262813744, 1.0]], [1, [99.78630964796737, 1.0]], [1, [0.26538112033603867, 1.0]], [1, [2.444095837299005, 1.0]], [1, [0.832944785052815, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82107864]
bas 1, expnt(s) = [24413.79418624]
bas 2, expnt(s) = [3661.45158613]
bas 3, expnt(s) = [833.31906975]
bas 4, expnt(s) = [235.44379958]
bas 5, expnt(s) = [76.1204843]
bas 6, expnt(s) = [10.19321134]
bas 7, expnt(s) = [26.94800408]
bas 8, expnt(s) = [0.31509974]
bas 9, expnt(s) = [1.90295197]
bas 10, expnt(s) = [2.94325617]
bas 11, expnt(s) = [7.10807644]
bas 12, expnt(s) = [23.17150726]
bas 13, expnt(s) = [99.78630965]
bas 14, expnt(s) = [0.26538112]
bas 15, expnt(s) = [2.44409584]
bas 16, expnt(s) = [0.83294479]
CPU time:        99.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.21078638e-01 2.17923261e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319070e+02 3.91853305e+02
 2.35443800e+02 1.51855480e+02 7.61204843e+01 6.51090234e+01
 1.01932113e+01 1.44127979e+01 2.69480041e+01 2.98820218e+01
 3.15099737e-01 1.06255411e+00 1.90295197e+00 4.09341611e+00
 2.94325617e+00 5.67722455e+00 7.10807644e+00 3.38590294e+01
 2.31715073e+01 1.48312327e+02 9.97863096e+01 9.20074712e+02
 2.65381120e-01 5.55676361e-01 2.44409584e+00 8.91522240e+00
 8.32944785e-01 2.32142501e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639769391875
cond(S) = 2896.097846742997
E1 = -183.5899534853177  E_coul = 55.08017298417557
init E= -128.509780501142
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775404153411726  LUMO = 0.80623816210858
  mo_energy =
[-3.25551234e+01 -1.85272092e+00 -7.75404153e-01 -7.75404153e-01
 -7.75404153e-01  8.06238162e-01  8.21777611e-01  8.21777611e-01
  8.21777611e-01  3.95288844e+00  3.95288844e+00  3.95288844e+00
  4.15519469e+00  1.28320929e+01  1.43543266e+01  1.43543266e+01
  1.43543266e+01  4.16613733e+01  5.29941972e+01  5.29941972e+01
  5.29941972e+01  1.45245057e+02  2.40822527e+02  2.40822527e+02
  2.40822527e+02  5.07782851e+02  1.87395259e+03  8.00290237e+03
  4.77700694e+04]
E1 = -182.08512382831066  E_coul = 53.54693813895249
cycle= 1 E= -128.538185689358  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518813
diis-c [-0.2691674  1.       ]
  HOMO = -0.884372236618683  LUMO = 0.777275226392064
  mo_energy =
[-3.28784914e+01 -1.96667462e+00 -8.84372237e-01 -8.84372237e-01
 -8.84372237e-01  7.77275226e-01  7.95064856e-01  7.95064856e-01
  7.95064856e-01  3.85534287e+00  3.85534287e+00  3.85534287e+00
  4.07995253e+00  1.26873323e+01  1.41634744e+01  1.41634744e+01
  1.41634744e+01  4.14165830e+01  5.27130957e+01  5.27130957e+01
  5.27130957e+01  1.44928561e+02  2.40475988e+02  2.40475988e+02
  2.40475988e+02  5.07421456e+02  1.87355482e+03  8.00247545e+03
  4.77696236e+04]
E1 = -182.84707152882228  E_coul = 54.306295957721936
cycle= 2 E= -128.5407755711  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0629
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263516
diis-c [-0.00066685  0.33603491  0.66396509]
  HOMO = -0.848715703052398  LUMO = 0.786557029948489
  mo_energy =
[-3.27703157e+01 -1.92912723e+00 -8.48715703e-01 -8.48715703e-01
 -8.48715703e-01  7.86557030e-01  8.03780328e-01  8.03780328e-01
  8.03780328e-01  3.88699511e+00  3.88699511e+00  3.88699511e+00
  4.10427424e+00  1.27348821e+01  1.42267104e+01  1.42267104e+01
  1.42267104e+01  4.14985573e+01  5.28071828e+01  5.28071828e+01
  5.28071828e+01  1.45034164e+02  2.40589739e+02  2.40589739e+02
  2.40589739e+02  5.07538238e+02  1.87367695e+03  8.00260005e+03
  4.77697491e+04]
E1 = -182.58819145041173  E_coul = 54.04649462645239
cycle= 3 E= -128.541696823959  delta_E= -0.000921  |g|= 0.00053  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119144
diis-c [-2.00401158e-07 -2.34922448e-03 -4.28646606e-04  1.00277787e+00]
  HOMO = -0.848980943997512  LUMO = 0.786502851303058
  mo_energy =
[-3.27707973e+01 -1.92932844e+00 -8.48980944e-01 -8.48980944e-01
 -8.48980944e-01  7.86502851e-01  8.03738873e-01  8.03738873e-01
  8.03738873e-01  3.88681028e+00  3.88681028e+00  3.88681028e+00
  4.10413376e+00  1.27346280e+01  1.42263907e+01  1.42263907e+01
  1.42263907e+01  4.14981842e+01  5.28067579e+01  5.28067579e+01
  5.28067579e+01  1.45033681e+02  2.40589184e+02  2.40589184e+02
  2.40589184e+02  5.07537626e+02  1.87367620e+03  8.00259920e+03
  4.77697482e+04]
E1 = -182.58869525016206  E_coul = 54.04699839909118
cycle= 4 E= -128.541696851071  delta_E= -2.71e-08  |g|= 8e-05  |ddm|= 0.000419
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186054
diis-c [-1.07716320e-09  2.37374928e-04  4.58532516e-04 -1.84568430e-01
  1.18387252e+00]
  HOMO = -0.849023896594351  LUMO = 0.786489958703923
  mo_energy =
[-3.27708703e+01 -1.92936088e+00 -8.49023897e-01 -8.49023897e-01
 -8.49023897e-01  7.86489959e-01  8.03725566e-01  8.03725566e-01
  8.03725566e-01  3.88677025e+00  3.88677025e+00  3.88677025e+00
  4.10410410e+00  1.27345787e+01  1.42263314e+01  1.42263314e+01
  1.42263314e+01  4.14981195e+01  5.28066890e+01  5.28066890e+01
  5.28066890e+01  1.45033608e+02  2.40589107e+02  2.40589107e+02
  2.40589107e+02  5.07537544e+02  1.87367611e+03  8.00259910e+03
  4.77697481e+04]
E1 = -182.58882816514026  E_coul = 54.04713131335964
cycle= 5 E= -128.541696851781  delta_E= -7.1e-10  |g|= 5.87e-06  |ddm|= 7.07e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58882816514026  E_coul = 54.04713131335964
  HOMO = -0.849020812429163  LUMO = 0.786491259340536
  mo_energy =
[-3.27708633e+01 -1.92935701e+00 -8.49020812e-01 -8.49020812e-01
 -8.49020812e-01  7.86491259e-01  8.03726468e-01  8.03726468e-01
  8.03726468e-01  3.88677320e+00  3.88677320e+00  3.88677320e+00
  4.10410676e+00  1.27345830e+01  1.42263364e+01  1.42263364e+01
  1.42263364e+01  4.14981256e+01  5.28066955e+01  5.28066955e+01
  5.28066955e+01  1.45033615e+02  2.40589113e+02  2.40589113e+02
  2.40589113e+02  5.07537551e+02  1.87367612e+03  8.00259911e+03
  4.77697481e+04]
E1 = -182.58881241219441  E_coul = 54.04711556041122
Extra cycle  E= -128.541696851783  delta_E= -2.59e-12  |g|= 2.22e-06  |ddm|= 2.06e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2896.097846742997
E1 = -182.58881241219441  E_coul = 54.04711556041122
init E= -128.541696851783
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.849021927056551  LUMO = 0.786491049940777
  mo_energy =
[-3.27708668e+01 -1.92935804e+00 -8.49021927e-01 -8.49021927e-01
 -8.49021927e-01  7.86491050e-01  8.03726214e-01  8.03726214e-01
  8.03726214e-01  3.88677223e+00  3.88677223e+00  3.88677223e+00
  4.10410609e+00  1.27345816e+01  1.42263344e+01  1.42263344e+01
  1.42263344e+01  4.14981230e+01  5.28066925e+01  5.28066925e+01
  5.28066925e+01  1.45033612e+02  2.40589110e+02  2.40589110e+02
  2.40589110e+02  5.07537547e+02  1.87367611e+03  8.00259910e+03
  4.77697481e+04]
E1 = -182.58882115998108  E_coul = 54.04712430819756
cycle= 1 E= -128.541696851784  delta_E= -3.13e-13  |g|= 1.2e-06  |ddm|= 7.98e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58882115998108  E_coul = 54.04712430819756
  HOMO = -0.849021311219607  LUMO = 0.786491226447216
  mo_energy =
[-3.27708650e+01 -1.92935737e+00 -8.49021311e-01 -8.49021311e-01
 -8.49021311e-01  7.86491226e-01  8.03726368e-01  8.03726368e-01
  8.03726368e-01  3.88677279e+00  3.88677279e+00  3.88677279e+00
  4.10410653e+00  1.27345824e+01  1.42263355e+01  1.42263355e+01
  1.42263355e+01  4.14981244e+01  5.28066941e+01  5.28066941e+01
  5.28066941e+01  1.45033613e+02  2.40589112e+02  2.40589112e+02
  2.40589112e+02  5.07537549e+02  1.87367612e+03  8.00259911e+03
  4.77697481e+04]
E1 = -182.58881676276224  E_coul = 54.04711991097855
Extra cycle  E= -128.541696851784  delta_E= -1.71e-13  |g|= 5.97e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [8.21078638e-01 2.44137942e+04 3.66145159e+03 8.33319070e+02
 2.35443800e+02 7.61204843e+01 1.01932113e+01 2.69480041e+01
 3.15099737e-01 1.90295197e+00 2.94325617e+00 7.10807644e+00
 2.31715073e+01 9.97863096e+01 2.65381120e-01 2.44409584e+00
 8.32944785e-01]
grad_E = [-6.01500661e-06  3.19260982e-10 -1.57542820e-08  2.66382933e-07
 -2.79182179e-06  2.78426303e-05 -2.50861638e-04 -7.02539480e-05
  9.97547511e-05  6.51834614e-05 -7.12539929e-05 -2.69199561e-04
  3.18910770e-05 -1.16267661e-06  3.72140925e-04  9.72348865e-04
 -1.50379155e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.830407190271       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158734        1
[INPUT] 0    0    [1    /1   ]  833.319054065        1
[INPUT] 0    0    [1    /1   ]  235.44390619         1
[INPUT] 0    0    [1    /1   ]  76.1188482805        1
[INPUT] 0    0    [1    /1   ]  10.2235546152        1
[INPUT] 0    0    [1    /1   ]  26.949580551         1
[INPUT] 0    0    [1    /1   ]  0.317261236301       1
[INPUT] 0    0    [1    /1   ]  1.95294715552        1
[INPUT] 0    0    [1    /1   ]  2.95114079842        1
[INPUT] 1    0    [1    /1   ]  7.11052608559        1
[INPUT] 1    0    [1    /1   ]  23.1710051834        1
[INPUT] 1    0    [1    /1   ]  99.786327443         1
[INPUT] 1    0    [1    /1   ]  0.264689837122       1
[INPUT] 1    0    [1    /1   ]  2.44093815676        1
[INPUT] 1    0    [1    /1   ]  0.830699287338       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8304071902707002, 1.0]], [0, [24413.794186209536, 1.0]], [0, [3661.45158733749, 1.0]], [0, [833.319054065471, 1.0]], [0, [235.44390619012225, 1.0]], [0, [76.11884828054815, 1.0]], [0, [10.223554615197184, 1.0]], [0, [26.949580550985704, 1.0]], [0, [0.31726123630145403, 1.0]], [0, [1.9529471555222073, 1.0]], [0, [2.951140798423694, 1.0]], [1, [7.110526085594723, 1.0]], [1, [23.17100518336304, 1.0]], [1, [99.78632744298805, 1.0]], [1, [0.26468983712229405, 1.0]], [1, [2.4409381567597954, 1.0]], [1, [0.8306992873376934, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83040719]
bas 1, expnt(s) = [24413.79418621]
bas 2, expnt(s) = [3661.45158734]
bas 3, expnt(s) = [833.31905407]
bas 4, expnt(s) = [235.44390619]
bas 5, expnt(s) = [76.11884828]
bas 6, expnt(s) = [10.22355462]
bas 7, expnt(s) = [26.94958055]
bas 8, expnt(s) = [0.31726124]
bas 9, expnt(s) = [1.95294716]
bas 10, expnt(s) = [2.9511408]
bas 11, expnt(s) = [7.11052609]
bas 12, expnt(s) = [23.17100518]
bas 13, expnt(s) = [99.78632744]
bas 14, expnt(s) = [0.26468984]
bas 15, expnt(s) = [2.44093816]
bas 16, expnt(s) = [0.83069929]
CPU time:       102.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.30407190e-01 2.19777561e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319054e+02 3.91853300e+02
 2.35443906e+02 1.51855531e+02 7.61188483e+01 6.51079739e+01
 1.02235546e+01 1.44449640e+01 2.69495806e+01 2.98833328e+01
 3.17261236e-01 1.06801606e+00 1.95294716e+00 4.17381209e+00
 2.95114080e+00 5.68862718e+00 7.11052609e+00 3.38736160e+01
 2.31710052e+01 1.48308310e+02 9.97863274e+01 9.20074917e+02
 2.64689837e-01 5.53867619e-01 2.44093816e+00 8.90082706e+00
 8.30699287e-01 2.31360487e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999644316589858
cond(S) = 3171.331920779538
E1 = -183.5899018404069  E_coul = 55.08016267856996
init E= -128.509739161837
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775405696181505  LUMO = 0.816952757262858
  mo_energy =
[-3.25551267e+01 -1.85272184e+00 -7.75405696e-01 -7.75405696e-01
 -7.75405696e-01  8.16952757e-01  8.19211598e-01  8.19211598e-01
  8.19211598e-01  3.94272489e+00  3.94272489e+00  3.94272489e+00
  4.22054503e+00  1.30196672e+01  1.43377468e+01  1.43377468e+01
  1.43377468e+01  4.19927543e+01  5.29813053e+01  5.29813053e+01
  5.29813053e+01  1.45631897e+02  2.40814195e+02  2.40814195e+02
  2.40814195e+02  5.08152872e+02  1.87428725e+03  8.00319732e+03
  4.77703137e+04]
E1 = -182.08465549779183  E_coul = 53.54646796804005
cycle= 1 E= -128.538187529752  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51891
diis-c [-0.26926764  1.        ]
  HOMO = -0.884409696132175  LUMO = 0.787548879321805
  mo_energy =
[-3.28785713e+01 -1.96672010e+00 -8.84409696e-01 -8.84409696e-01
 -8.84409696e-01  7.87548879e-01  7.92590085e-01  7.92590085e-01
  7.92590085e-01  3.84527466e+00  3.84527466e+00  3.84527466e+00
  4.14429815e+00  1.28739730e+01  1.41468251e+01  1.41468251e+01
  1.41468251e+01  4.17477544e+01  5.27001082e+01  5.27001082e+01
  5.27001082e+01  1.45315364e+02  2.40467584e+02  2.40467584e+02
  2.40467584e+02  5.07791421e+02  1.87388941e+03  8.00277033e+03
  4.77698678e+04]
E1 = -182.8469434140291  E_coul = 54.30616463913028
cycle= 2 E= -128.540778774899  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0631
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263613
diis-c [-0.00066877  0.33607383  0.66392617]
  HOMO = -0.848738397819093  LUMO = 0.796972298424548
  mo_energy =
[-3.27703579e+01 -1.92915665e+00 -8.48738398e-01 -8.48738398e-01
 -8.48738398e-01  7.96972298e-01  8.01276526e-01  8.01276526e-01
  8.01276526e-01  3.87689748e+00  3.87689748e+00  3.87689748e+00
  4.16895098e+00  1.29218404e+01  1.42100907e+01  1.42100907e+01
  1.42100907e+01  4.18298066e+01  5.27942357e+01  5.27942357e+01
  5.27942357e+01  1.45420990e+02  2.40581375e+02  2.40581375e+02
  2.40581375e+02  5.07908236e+02  1.87401158e+03  8.00289497e+03
  4.77699934e+04]
E1 = -182.58793571412426  E_coul = 54.046234880788994
cycle= 3 E= -128.541700833335  delta_E= -0.000922  |g|= 0.000527  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118531
diis-c [-1.97471220e-07 -2.34264198e-03 -4.36636854e-04  1.00277928e+00]
  HOMO = -0.849002675211637  LUMO = 0.796917608901714
  mo_energy =
[-3.27708376e+01 -1.92935727e+00 -8.49002675e-01 -8.49002675e-01
 -8.49002675e-01  7.96917609e-01  8.01235586e-01  8.01235586e-01
  8.01235586e-01  3.87671371e+00  3.87671371e+00  3.87671371e+00
  4.16880942e+00  1.29215861e+01  1.42097724e+01  1.42097724e+01
  1.42097724e+01  4.18294348e+01  5.27938125e+01  5.27938125e+01
  5.27938125e+01  1.45420509e+02  2.40580822e+02  2.40580822e+02
  2.40580822e+02  5.07907627e+02  1.87401083e+03  8.00289412e+03
  4.77699925e+04]
E1 = -182.5884354647948  E_coul = 54.04673460467742
cycle= 4 E= -128.541700860117  delta_E= -2.68e-08  |g|= 7.97e-05  |ddm|= 0.000422
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185426
diis-c [-1.07071865e-09  2.35234460e-04  4.59558330e-04 -1.83674240e-01
  1.18297945e+00]
  HOMO = -0.849045508019349  LUMO = 0.796904549748714
  mo_energy =
[-3.27709104e+01 -1.92938972e+00 -8.49045508e-01 -8.49045508e-01
 -8.49045508e-01  7.96904550e-01  8.01222364e-01  8.01222364e-01
  8.01222364e-01  3.87667380e+00  3.87667380e+00  3.87667380e+00
  4.16877948e+00  1.29215366e+01  1.42097132e+01  1.42097132e+01
  1.42097132e+01  4.18293702e+01  5.27937437e+01  5.27937437e+01
  5.27937437e+01  1.45420436e+02  2.40580745e+02  2.40580745e+02
  2.40580745e+02  5.07907545e+02  1.87401074e+03  8.00289402e+03
  4.77699924e+04]
E1 = -182.58856819104435  E_coul = 54.04686733022631
cycle= 5 E= -128.541700860818  delta_E= -7.01e-10  |g|= 5.82e-06  |ddm|= 7.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58856819104435  E_coul = 54.04686733022631
  HOMO = -0.849042451962482  LUMO = 0.796905854681369
  mo_energy =
[-3.27709035e+01 -1.92938588e+00 -8.49042452e-01 -8.49042452e-01
 -8.49042452e-01  7.96905855e-01  8.01223255e-01  8.01223255e-01
  8.01223255e-01  3.87667672e+00  3.87667672e+00  3.87667672e+00
  4.16878215e+00  1.29215409e+01  1.42097182e+01  1.42097182e+01
  1.42097182e+01  4.18293762e+01  5.27937502e+01  5.27937502e+01
  5.27937502e+01  1.45420443e+02  2.40580752e+02  2.40580752e+02
  2.40580752e+02  5.07907552e+02  1.87401075e+03  8.00289403e+03
  4.77699924e+04]
E1 = -182.58855254387024  E_coul = 54.046851683049354
Extra cycle  E= -128.541700860821  delta_E= -2.84e-12  |g|= 2.2e-06  |ddm|= 2.07e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.30407190e-01 2.44137942e+04 3.66145159e+03 8.33319054e+02
 2.35443906e+02 7.61188483e+01 1.02235546e+01 2.69495806e+01
 3.17261236e-01 1.95294716e+00 2.95114080e+00 7.11052609e+00
 2.31710052e+01 9.97863274e+01 2.64689837e-01 2.44093816e+00
 8.30699287e-01]
E = -128.54170086082087
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.830407190271       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158734        1
[INPUT] 0    0    [1    /1   ]  833.319054065        1
[INPUT] 0    0    [1    /1   ]  235.44390619         1
[INPUT] 0    0    [1    /1   ]  76.1188482805        1
[INPUT] 0    0    [1    /1   ]  10.2235546152        1
[INPUT] 0    0    [1    /1   ]  26.949580551         1
[INPUT] 0    0    [1    /1   ]  0.317261236301       1
[INPUT] 0    0    [1    /1   ]  1.95294715552        1
[INPUT] 0    0    [1    /1   ]  2.95114079842        1
[INPUT] 1    0    [1    /1   ]  7.11052608559        1
[INPUT] 1    0    [1    /1   ]  23.1710051834        1
[INPUT] 1    0    [1    /1   ]  99.786327443         1
[INPUT] 1    0    [1    /1   ]  0.264689837122       1
[INPUT] 1    0    [1    /1   ]  2.44093815676        1
[INPUT] 1    0    [1    /1   ]  0.830699287338       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8304071902707002, 1.0]], [0, [24413.794186209536, 1.0]], [0, [3661.45158733749, 1.0]], [0, [833.319054065471, 1.0]], [0, [235.44390619012225, 1.0]], [0, [76.11884828054815, 1.0]], [0, [10.223554615197184, 1.0]], [0, [26.949580550985704, 1.0]], [0, [0.31726123630145403, 1.0]], [0, [1.9529471555222073, 1.0]], [0, [2.951140798423694, 1.0]], [1, [7.110526085594723, 1.0]], [1, [23.17100518336304, 1.0]], [1, [99.78632744298805, 1.0]], [1, [0.26468983712229405, 1.0]], [1, [2.4409381567597954, 1.0]], [1, [0.8306992873376934, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83040719]
bas 1, expnt(s) = [24413.79418621]
bas 2, expnt(s) = [3661.45158734]
bas 3, expnt(s) = [833.31905407]
bas 4, expnt(s) = [235.44390619]
bas 5, expnt(s) = [76.11884828]
bas 6, expnt(s) = [10.22355462]
bas 7, expnt(s) = [26.94958055]
bas 8, expnt(s) = [0.31726124]
bas 9, expnt(s) = [1.95294716]
bas 10, expnt(s) = [2.9511408]
bas 11, expnt(s) = [7.11052609]
bas 12, expnt(s) = [23.17100518]
bas 13, expnt(s) = [99.78632744]
bas 14, expnt(s) = [0.26468984]
bas 15, expnt(s) = [2.44093816]
bas 16, expnt(s) = [0.83069929]
CPU time:       103.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.30407190e-01 2.19777561e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319054e+02 3.91853300e+02
 2.35443906e+02 1.51855531e+02 7.61188483e+01 6.51079739e+01
 1.02235546e+01 1.44449640e+01 2.69495806e+01 2.98833328e+01
 3.17261236e-01 1.06801606e+00 1.95294716e+00 4.17381209e+00
 2.95114080e+00 5.68862718e+00 7.11052609e+00 3.38736160e+01
 2.31710052e+01 1.48308310e+02 9.97863274e+01 9.20074917e+02
 2.64689837e-01 5.53867619e-01 2.44093816e+00 8.90082706e+00
 8.30699287e-01 2.31360487e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999644316589858
cond(S) = 3171.331920779538
E1 = -183.5899018404069  E_coul = 55.08016267856996
init E= -128.509739161837
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775405696181505  LUMO = 0.816952757262858
  mo_energy =
[-3.25551267e+01 -1.85272184e+00 -7.75405696e-01 -7.75405696e-01
 -7.75405696e-01  8.16952757e-01  8.19211598e-01  8.19211598e-01
  8.19211598e-01  3.94272489e+00  3.94272489e+00  3.94272489e+00
  4.22054503e+00  1.30196672e+01  1.43377468e+01  1.43377468e+01
  1.43377468e+01  4.19927543e+01  5.29813053e+01  5.29813053e+01
  5.29813053e+01  1.45631897e+02  2.40814195e+02  2.40814195e+02
  2.40814195e+02  5.08152872e+02  1.87428725e+03  8.00319732e+03
  4.77703137e+04]
E1 = -182.08465549779183  E_coul = 53.54646796804005
cycle= 1 E= -128.538187529752  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.51891
diis-c [-0.26926764  1.        ]
  HOMO = -0.884409696132175  LUMO = 0.787548879321805
  mo_energy =
[-3.28785713e+01 -1.96672010e+00 -8.84409696e-01 -8.84409696e-01
 -8.84409696e-01  7.87548879e-01  7.92590085e-01  7.92590085e-01
  7.92590085e-01  3.84527466e+00  3.84527466e+00  3.84527466e+00
  4.14429815e+00  1.28739730e+01  1.41468251e+01  1.41468251e+01
  1.41468251e+01  4.17477544e+01  5.27001082e+01  5.27001082e+01
  5.27001082e+01  1.45315364e+02  2.40467584e+02  2.40467584e+02
  2.40467584e+02  5.07791421e+02  1.87388941e+03  8.00277033e+03
  4.77698678e+04]
E1 = -182.8469434140291  E_coul = 54.30616463913028
cycle= 2 E= -128.540778774899  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0631
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263613
diis-c [-0.00066877  0.33607383  0.66392617]
  HOMO = -0.848738397819093  LUMO = 0.796972298424548
  mo_energy =
[-3.27703579e+01 -1.92915665e+00 -8.48738398e-01 -8.48738398e-01
 -8.48738398e-01  7.96972298e-01  8.01276526e-01  8.01276526e-01
  8.01276526e-01  3.87689748e+00  3.87689748e+00  3.87689748e+00
  4.16895098e+00  1.29218404e+01  1.42100907e+01  1.42100907e+01
  1.42100907e+01  4.18298066e+01  5.27942357e+01  5.27942357e+01
  5.27942357e+01  1.45420990e+02  2.40581375e+02  2.40581375e+02
  2.40581375e+02  5.07908236e+02  1.87401158e+03  8.00289497e+03
  4.77699934e+04]
E1 = -182.58793571412426  E_coul = 54.046234880788994
cycle= 3 E= -128.541700833335  delta_E= -0.000922  |g|= 0.000527  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118531
diis-c [-1.97471220e-07 -2.34264198e-03 -4.36636854e-04  1.00277928e+00]
  HOMO = -0.849002675211637  LUMO = 0.796917608901714
  mo_energy =
[-3.27708376e+01 -1.92935727e+00 -8.49002675e-01 -8.49002675e-01
 -8.49002675e-01  7.96917609e-01  8.01235586e-01  8.01235586e-01
  8.01235586e-01  3.87671371e+00  3.87671371e+00  3.87671371e+00
  4.16880942e+00  1.29215861e+01  1.42097724e+01  1.42097724e+01
  1.42097724e+01  4.18294348e+01  5.27938125e+01  5.27938125e+01
  5.27938125e+01  1.45420509e+02  2.40580822e+02  2.40580822e+02
  2.40580822e+02  5.07907627e+02  1.87401083e+03  8.00289412e+03
  4.77699925e+04]
E1 = -182.5884354647948  E_coul = 54.04673460467742
cycle= 4 E= -128.541700860117  delta_E= -2.68e-08  |g|= 7.97e-05  |ddm|= 0.000422
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185426
diis-c [-1.07071865e-09  2.35234460e-04  4.59558330e-04 -1.83674240e-01
  1.18297945e+00]
  HOMO = -0.849045508019349  LUMO = 0.796904549748714
  mo_energy =
[-3.27709104e+01 -1.92938972e+00 -8.49045508e-01 -8.49045508e-01
 -8.49045508e-01  7.96904550e-01  8.01222364e-01  8.01222364e-01
  8.01222364e-01  3.87667380e+00  3.87667380e+00  3.87667380e+00
  4.16877948e+00  1.29215366e+01  1.42097132e+01  1.42097132e+01
  1.42097132e+01  4.18293702e+01  5.27937437e+01  5.27937437e+01
  5.27937437e+01  1.45420436e+02  2.40580745e+02  2.40580745e+02
  2.40580745e+02  5.07907545e+02  1.87401074e+03  8.00289402e+03
  4.77699924e+04]
E1 = -182.58856819104435  E_coul = 54.04686733022631
cycle= 5 E= -128.541700860818  delta_E= -7.01e-10  |g|= 5.82e-06  |ddm|= 7.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58856819104435  E_coul = 54.04686733022631
  HOMO = -0.849042451962482  LUMO = 0.796905854681369
  mo_energy =
[-3.27709035e+01 -1.92938588e+00 -8.49042452e-01 -8.49042452e-01
 -8.49042452e-01  7.96905855e-01  8.01223255e-01  8.01223255e-01
  8.01223255e-01  3.87667672e+00  3.87667672e+00  3.87667672e+00
  4.16878215e+00  1.29215409e+01  1.42097182e+01  1.42097182e+01
  1.42097182e+01  4.18293762e+01  5.27937502e+01  5.27937502e+01
  5.27937502e+01  1.45420443e+02  2.40580752e+02  2.40580752e+02
  2.40580752e+02  5.07907552e+02  1.87401075e+03  8.00289403e+03
  4.77699924e+04]
E1 = -182.58855254387024  E_coul = 54.046851683049354
Extra cycle  E= -128.541700860821  delta_E= -2.84e-12  |g|= 2.2e-06  |ddm|= 2.07e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3171.331920779538
E1 = -182.58855254387024  E_coul = 54.046851683049354
init E= -128.541700860821
    CPU time for initialize scf      0.36 sec, wall time      0.37 sec
  HOMO = -0.849043559436031  LUMO = 0.796905642968924
  mo_energy =
[-3.27709070e+01 -1.92938691e+00 -8.49043559e-01 -8.49043559e-01
 -8.49043559e-01  7.96905643e-01  8.01223003e-01  8.01223003e-01
  8.01223003e-01  3.87667576e+00  3.87667576e+00  3.87667576e+00
  4.16878147e+00  1.29215395e+01  1.42097163e+01  1.42097163e+01
  1.42097163e+01  4.18293737e+01  5.27937472e+01  5.27937472e+01
  5.27937472e+01  1.45420440e+02  2.40580748e+02  2.40580748e+02
  2.40580748e+02  5.07907548e+02  1.87401075e+03  8.00289403e+03
  4.77699924e+04]
E1 = -182.58856123024387  E_coul = 54.04686036942277
cycle= 1 E= -128.541700860821  delta_E= -2.27e-13  |g|= 1.19e-06  |ddm|= 7.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58856123024387  E_coul = 54.04686036942277
  HOMO = -0.849042947950572  LUMO = 0.796905820765226
  mo_energy =
[-3.27709052e+01 -1.92938624e+00 -8.49042948e-01 -8.49042948e-01
 -8.49042948e-01  7.96905821e-01  8.01223155e-01  8.01223155e-01
  8.01223155e-01  3.87667631e+00  3.87667631e+00  3.87667631e+00
  4.16878191e+00  1.29215403e+01  1.42097173e+01  1.42097173e+01
  1.42097173e+01  4.18293751e+01  5.27937488e+01  5.27937488e+01
  5.27937488e+01  1.45420442e+02  2.40580750e+02  2.40580750e+02
  2.40580750e+02  5.07907550e+02  1.87401075e+03  8.00289403e+03
  4.77699924e+04]
E1 = -182.58855686309494  E_coul = 54.04685600227414
Extra cycle  E= -128.541700860821  delta_E= 2.84e-13  |g|= 5.93e-07  |ddm|= 3.75e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [8.30407190e-01 2.44137942e+04 3.66145159e+03 8.33319054e+02
 2.35443906e+02 7.61188483e+01 1.02235546e+01 2.69495806e+01
 3.17261236e-01 1.95294716e+00 2.95114080e+00 7.11052609e+00
 2.31710052e+01 9.97863274e+01 2.64689837e-01 2.44093816e+00
 8.30699287e-01]
grad_E = [-6.18016071e-05  4.39618834e-10 -2.20694113e-08  3.94128287e-07
 -4.33008267e-06  3.98535804e-05 -1.73105068e-04 -1.21014648e-04
  2.08113693e-04  6.63503823e-05 -7.43501269e-05 -1.79867678e-04
  1.91569834e-05 -6.66403072e-07  2.70095914e-04  8.45550766e-04
 -1.64880003e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.837408725298       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158842        1
[INPUT] 0    0    [1    /1   ]  833.319040095        1
[INPUT] 0    0    [1    /1   ]  235.444000739        1
[INPUT] 0    0    [1    /1   ]  76.1173812774        1
[INPUT] 0    0    [1    /1   ]  10.2514899595        1
[INPUT] 0    0    [1    /1   ]  26.9509287936        1
[INPUT] 0    0    [1    /1   ]  0.317582629676       1
[INPUT] 0    0    [1    /1   ]  1.99752900774        1
[INPUT] 0    0    [1    /1   ]  2.95772104217        1
[INPUT] 1    0    [1    /1   ]  7.11277389706        1
[INPUT] 1    0    [1    /1   ]  23.1705469605        1
[INPUT] 1    0    [1    /1   ]  99.7863437384        1
[INPUT] 1    0    [1    /1   ]  0.264636340413       1
[INPUT] 1    0    [1    /1   ]  2.43769953188        1
[INPUT] 1    0    [1    /1   ]  0.829839385348       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8374087252981615, 1.0]], [0, [24413.794186186144, 1.0]], [0, [3661.451588419711, 1.0]], [0, [833.3190400953258, 1.0]], [0, [235.44400073870048, 1.0]], [0, [76.11738127742562, 1.0]], [0, [10.251489959531757, 1.0]], [0, [26.950928793579973, 1.0]], [0, [0.3175826296760673, 1.0]], [0, [1.9975290077441894, 1.0]], [0, [2.9577210421744846, 1.0]], [1, [7.112773897058187, 1.0]], [1, [23.170546960462485, 1.0]], [1, [99.78634373839198, 1.0]], [1, [0.2646363404128215, 1.0]], [1, [2.4376995318835157, 1.0]], [1, [0.8298393853484286, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83740873]
bas 1, expnt(s) = [24413.79418619]
bas 2, expnt(s) = [3661.45158842]
bas 3, expnt(s) = [833.3190401]
bas 4, expnt(s) = [235.44400074]
bas 5, expnt(s) = [76.11738128]
bas 6, expnt(s) = [10.25148996]
bas 7, expnt(s) = [26.95092879]
bas 8, expnt(s) = [0.31758263]
bas 9, expnt(s) = [1.99752901]
bas 10, expnt(s) = [2.95772104]
bas 11, expnt(s) = [7.1127739]
bas 12, expnt(s) = [23.17054696]
bas 13, expnt(s) = [99.78634374]
bas 14, expnt(s) = [0.26463634]
bas 15, expnt(s) = [2.43769953]
bas 16, expnt(s) = [0.82983939]
CPU time:       106.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.37408725e-01 2.21165884e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319040e+02 3.91853295e+02
 2.35444001e+02 1.51855577e+02 7.61173813e+01 6.51070328e+01
 1.02514900e+01 1.44745565e+01 2.69509288e+01 2.98844541e+01
 3.17582630e-01 1.06882740e+00 1.99752901e+00 4.24506990e+00
 2.95772104e+00 5.69813760e+00 7.11277390e+00 3.38870019e+01
 2.31705470e+01 1.48304644e+02 9.97863437e+01 9.20075105e+02
 2.64636340e-01 5.53727695e-01 2.43769953e+00 8.88606754e+00
 8.29839385e-01 2.31061159e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999645407854535
cond(S) = 3436.9480859225937
E1 = -183.5898692399291  E_coul = 55.08017106238337
init E= -128.509698177546
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.77540547702856  LUMO = 0.818825787430183
  mo_energy =
[-3.25551249e+01 -1.85272159e+00 -7.75405477e-01 -7.75405477e-01
 -7.75405477e-01  8.18825787e-01  8.18825787e-01  8.18825787e-01
  8.22675609e-01  3.93845977e+00  3.93845977e+00  3.93845977e+00
  4.26890683e+00  1.31731456e+01  1.43278431e+01  1.43278431e+01
  1.43278431e+01  4.22747846e+01  5.29735328e+01  5.29735328e+01
  5.29735328e+01  1.45966513e+02  2.40809264e+02  2.40809264e+02
  2.40809264e+02  5.08474320e+02  1.87457823e+03  8.00345384e+03
  4.77705261e+04]
E1 = -182.08461566700308  E_coul = 53.54642528973985
cycle= 1 E= -128.538190377263  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.51898
diis-c [-0.2693398  1.       ]
  HOMO = -0.884414374487262  LUMO = 0.792222928688319
  mo_energy =
[-3.28785778e+01 -1.96672244e+00 -8.84414374e-01 -8.84414374e-01
 -8.84414374e-01  7.92222929e-01  7.92222929e-01  7.92222929e-01
  7.93001180e-01  3.84109797e+00  3.84109797e+00  3.84109797e+00
  4.19184106e+00  1.30266673e+01  1.41369215e+01  1.41369215e+01
  1.41369215e+01  4.20296333e+01  5.26923114e+01  5.26923114e+01
  5.26923114e+01  1.45650000e+02  2.40462654e+02  2.40462654e+02
  2.40462654e+02  5.08112879e+02  1.87418039e+03  8.00302683e+03
  4.77700803e+04]
E1 = -182.84691281279285  E_coul = 54.3061310309803
cycle= 2 E= -128.540781781813  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263653
diis-c [-0.00067047  0.33607583  0.66392417]
  HOMO = -0.848742763256933  LUMO = 0.800901471827037
  mo_energy =
[-3.27703634e+01 -1.92915862e+00 -8.48742763e-01 -8.48742763e-01
 -8.48742763e-01  8.00901472e-01  8.00901472e-01  8.00901472e-01
  8.02509637e-01  3.87269066e+00  3.87269066e+00  3.87269066e+00
  4.21676209e+00  1.30747982e+01  1.42001854e+01  1.42001854e+01
  1.42001854e+01  4.21117336e+01  5.27864438e+01  5.27864438e+01
  5.27864438e+01  1.45755617e+02  2.40576446e+02  2.40576446e+02
  2.40576446e+02  5.08229691e+02  1.87430256e+03  8.00315148e+03
  4.77702058e+04]
E1 = -182.58789675510735  E_coul = 54.04619288928698
cycle= 3 E= -128.54170386582  delta_E= -0.000922  |g|= 0.000528  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118547
diis-c [-1.98307855e-07 -2.34653263e-03 -4.45684187e-04  1.00279222e+00]
  HOMO = -0.849007513943685  LUMO = 0.800860284161654
  mo_energy =
[-3.27708435e+01 -1.92935957e+00 -8.49007514e-01 -8.49007514e-01
 -8.49007514e-01  8.00860284e-01  8.00860284e-01  8.00860284e-01
  8.02454136e-01  3.87250652e+00  3.87250652e+00  3.87250652e+00
  4.21661866e+00  1.30745422e+01  1.41998666e+01  1.41998666e+01
  1.41998666e+01  4.21113611e+01  5.27860202e+01  5.27860202e+01
  5.27860202e+01  1.45755136e+02  2.40575893e+02  2.40575893e+02
  2.40575893e+02  5.08229081e+02  1.87430181e+03  8.00315063e+03
  4.77702049e+04]
E1 = -182.58839429256824  E_coul = 54.04669039978511
cycle= 4 E= -128.541703892783  delta_E= -2.7e-08  |g|= 8e-05  |ddm|= 0.000432
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185872
diis-c [-1.07613561e-09  2.35308282e-04  4.61495980e-04 -1.83731133e-01
  1.18303433e+00]
  HOMO = -0.84905051175439  LUMO = 0.800847011862857
  mo_energy =
[-3.27709166e+01 -1.92939216e+00 -8.49050512e-01 -8.49050512e-01
 -8.49050512e-01  8.00847012e-01  8.00847012e-01  8.00847012e-01
  8.02440900e-01  3.87246647e+00  3.87246647e+00  3.87246647e+00
  4.21658831e+00  1.30744923e+01  1.41998072e+01  1.41998072e+01
  1.41998072e+01  4.21112963e+01  5.27859512e+01  5.27859512e+01
  5.27859512e+01  1.45755063e+02  2.40575816e+02  2.40575816e+02
  2.40575816e+02  5.08228999e+02  1.87430172e+03  8.00315053e+03
  4.77702048e+04]
E1 = -182.58852719611303  E_coul = 54.0468233026251
cycle= 5 E= -128.541703893488  delta_E= -7.05e-10  |g|= 5.83e-06  |ddm|= 7.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58852719611303  E_coul = 54.0468233026251
  HOMO = -0.849047448309523  LUMO = 0.800847904977506
  mo_energy =
[-3.27709096e+01 -1.92938831e+00 -8.49047448e-01 -8.49047448e-01
 -8.49047448e-01  8.00847905e-01  8.00847905e-01  8.00847905e-01
  8.02442219e-01  3.87246939e+00  3.87246939e+00  3.87246939e+00
  4.21659101e+00  1.30744967e+01  1.41998123e+01  1.41998123e+01
  1.41998123e+01  4.21113024e+01  5.27859577e+01  5.27859577e+01
  5.27859577e+01  1.45755069e+02  2.40575822e+02  2.40575822e+02
  2.40575822e+02  5.08229006e+02  1.87430173e+03  8.00315054e+03
  4.77702048e+04]
E1 = -182.58851154278864  E_coul = 54.04680764929811
Extra cycle  E= -128.541703893491  delta_E= -2.61e-12  |g|= 2.2e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.37408725e-01 2.44137942e+04 3.66145159e+03 8.33319040e+02
 2.35444001e+02 7.61173813e+01 1.02514900e+01 2.69509288e+01
 3.17582630e-01 1.99752901e+00 2.95772104e+00 7.11277390e+00
 2.31705470e+01 9.97863437e+01 2.64636340e-01 2.43769953e+00
 8.29839385e-01]
E = -128.54170389349053
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.837408725298       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158842        1
[INPUT] 0    0    [1    /1   ]  833.319040095        1
[INPUT] 0    0    [1    /1   ]  235.444000739        1
[INPUT] 0    0    [1    /1   ]  76.1173812774        1
[INPUT] 0    0    [1    /1   ]  10.2514899595        1
[INPUT] 0    0    [1    /1   ]  26.9509287936        1
[INPUT] 0    0    [1    /1   ]  0.317582629676       1
[INPUT] 0    0    [1    /1   ]  1.99752900774        1
[INPUT] 0    0    [1    /1   ]  2.95772104217        1
[INPUT] 1    0    [1    /1   ]  7.11277389706        1
[INPUT] 1    0    [1    /1   ]  23.1705469605        1
[INPUT] 1    0    [1    /1   ]  99.7863437384        1
[INPUT] 1    0    [1    /1   ]  0.264636340413       1
[INPUT] 1    0    [1    /1   ]  2.43769953188        1
[INPUT] 1    0    [1    /1   ]  0.829839385348       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8374087252981615, 1.0]], [0, [24413.794186186144, 1.0]], [0, [3661.451588419711, 1.0]], [0, [833.3190400953258, 1.0]], [0, [235.44400073870048, 1.0]], [0, [76.11738127742562, 1.0]], [0, [10.251489959531757, 1.0]], [0, [26.950928793579973, 1.0]], [0, [0.3175826296760673, 1.0]], [0, [1.9975290077441894, 1.0]], [0, [2.9577210421744846, 1.0]], [1, [7.112773897058187, 1.0]], [1, [23.170546960462485, 1.0]], [1, [99.78634373839198, 1.0]], [1, [0.2646363404128215, 1.0]], [1, [2.4376995318835157, 1.0]], [1, [0.8298393853484286, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83740873]
bas 1, expnt(s) = [24413.79418619]
bas 2, expnt(s) = [3661.45158842]
bas 3, expnt(s) = [833.3190401]
bas 4, expnt(s) = [235.44400074]
bas 5, expnt(s) = [76.11738128]
bas 6, expnt(s) = [10.25148996]
bas 7, expnt(s) = [26.95092879]
bas 8, expnt(s) = [0.31758263]
bas 9, expnt(s) = [1.99752901]
bas 10, expnt(s) = [2.95772104]
bas 11, expnt(s) = [7.1127739]
bas 12, expnt(s) = [23.17054696]
bas 13, expnt(s) = [99.78634374]
bas 14, expnt(s) = [0.26463634]
bas 15, expnt(s) = [2.43769953]
bas 16, expnt(s) = [0.82983939]
CPU time:       106.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.37408725e-01 2.21165884e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319040e+02 3.91853295e+02
 2.35444001e+02 1.51855577e+02 7.61173813e+01 6.51070328e+01
 1.02514900e+01 1.44745565e+01 2.69509288e+01 2.98844541e+01
 3.17582630e-01 1.06882740e+00 1.99752901e+00 4.24506990e+00
 2.95772104e+00 5.69813760e+00 7.11277390e+00 3.38870019e+01
 2.31705470e+01 1.48304644e+02 9.97863437e+01 9.20075105e+02
 2.64636340e-01 5.53727695e-01 2.43769953e+00 8.88606754e+00
 8.29839385e-01 2.31061159e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999645407854535
cond(S) = 3436.9480859225937
E1 = -183.5898692399291  E_coul = 55.08017106238337
init E= -128.509698177546
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77540547702856  LUMO = 0.818825787430183
  mo_energy =
[-3.25551249e+01 -1.85272159e+00 -7.75405477e-01 -7.75405477e-01
 -7.75405477e-01  8.18825787e-01  8.18825787e-01  8.18825787e-01
  8.22675609e-01  3.93845977e+00  3.93845977e+00  3.93845977e+00
  4.26890683e+00  1.31731456e+01  1.43278431e+01  1.43278431e+01
  1.43278431e+01  4.22747846e+01  5.29735328e+01  5.29735328e+01
  5.29735328e+01  1.45966513e+02  2.40809264e+02  2.40809264e+02
  2.40809264e+02  5.08474320e+02  1.87457823e+03  8.00345384e+03
  4.77705261e+04]
E1 = -182.08461566700308  E_coul = 53.54642528973985
cycle= 1 E= -128.538190377263  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.51898
diis-c [-0.2693398  1.       ]
  HOMO = -0.884414374487262  LUMO = 0.792222928688319
  mo_energy =
[-3.28785778e+01 -1.96672244e+00 -8.84414374e-01 -8.84414374e-01
 -8.84414374e-01  7.92222929e-01  7.92222929e-01  7.92222929e-01
  7.93001180e-01  3.84109797e+00  3.84109797e+00  3.84109797e+00
  4.19184106e+00  1.30266673e+01  1.41369215e+01  1.41369215e+01
  1.41369215e+01  4.20296333e+01  5.26923114e+01  5.26923114e+01
  5.26923114e+01  1.45650000e+02  2.40462654e+02  2.40462654e+02
  2.40462654e+02  5.08112879e+02  1.87418039e+03  8.00302683e+03
  4.77700803e+04]
E1 = -182.84691281279285  E_coul = 54.3061310309803
cycle= 2 E= -128.540781781813  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263653
diis-c [-0.00067047  0.33607583  0.66392417]
  HOMO = -0.848742763256933  LUMO = 0.800901471827037
  mo_energy =
[-3.27703634e+01 -1.92915862e+00 -8.48742763e-01 -8.48742763e-01
 -8.48742763e-01  8.00901472e-01  8.00901472e-01  8.00901472e-01
  8.02509637e-01  3.87269066e+00  3.87269066e+00  3.87269066e+00
  4.21676209e+00  1.30747982e+01  1.42001854e+01  1.42001854e+01
  1.42001854e+01  4.21117336e+01  5.27864438e+01  5.27864438e+01
  5.27864438e+01  1.45755617e+02  2.40576446e+02  2.40576446e+02
  2.40576446e+02  5.08229691e+02  1.87430256e+03  8.00315148e+03
  4.77702058e+04]
E1 = -182.58789675510735  E_coul = 54.04619288928698
cycle= 3 E= -128.54170386582  delta_E= -0.000922  |g|= 0.000528  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118547
diis-c [-1.98307855e-07 -2.34653263e-03 -4.45684187e-04  1.00279222e+00]
  HOMO = -0.849007513943685  LUMO = 0.800860284161654
  mo_energy =
[-3.27708435e+01 -1.92935957e+00 -8.49007514e-01 -8.49007514e-01
 -8.49007514e-01  8.00860284e-01  8.00860284e-01  8.00860284e-01
  8.02454136e-01  3.87250652e+00  3.87250652e+00  3.87250652e+00
  4.21661866e+00  1.30745422e+01  1.41998666e+01  1.41998666e+01
  1.41998666e+01  4.21113611e+01  5.27860202e+01  5.27860202e+01
  5.27860202e+01  1.45755136e+02  2.40575893e+02  2.40575893e+02
  2.40575893e+02  5.08229081e+02  1.87430181e+03  8.00315063e+03
  4.77702049e+04]
E1 = -182.58839429256824  E_coul = 54.04669039978511
cycle= 4 E= -128.541703892783  delta_E= -2.7e-08  |g|= 8e-05  |ddm|= 0.000432
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185872
diis-c [-1.07613561e-09  2.35308282e-04  4.61495980e-04 -1.83731133e-01
  1.18303433e+00]
  HOMO = -0.84905051175439  LUMO = 0.800847011862857
  mo_energy =
[-3.27709166e+01 -1.92939216e+00 -8.49050512e-01 -8.49050512e-01
 -8.49050512e-01  8.00847012e-01  8.00847012e-01  8.00847012e-01
  8.02440900e-01  3.87246647e+00  3.87246647e+00  3.87246647e+00
  4.21658831e+00  1.30744923e+01  1.41998072e+01  1.41998072e+01
  1.41998072e+01  4.21112963e+01  5.27859512e+01  5.27859512e+01
  5.27859512e+01  1.45755063e+02  2.40575816e+02  2.40575816e+02
  2.40575816e+02  5.08228999e+02  1.87430172e+03  8.00315053e+03
  4.77702048e+04]
E1 = -182.58852719611303  E_coul = 54.0468233026251
cycle= 5 E= -128.541703893488  delta_E= -7.05e-10  |g|= 5.83e-06  |ddm|= 7.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58852719611303  E_coul = 54.0468233026251
  HOMO = -0.849047448309523  LUMO = 0.800847904977506
  mo_energy =
[-3.27709096e+01 -1.92938831e+00 -8.49047448e-01 -8.49047448e-01
 -8.49047448e-01  8.00847905e-01  8.00847905e-01  8.00847905e-01
  8.02442219e-01  3.87246939e+00  3.87246939e+00  3.87246939e+00
  4.21659101e+00  1.30744967e+01  1.41998123e+01  1.41998123e+01
  1.41998123e+01  4.21113024e+01  5.27859577e+01  5.27859577e+01
  5.27859577e+01  1.45755069e+02  2.40575822e+02  2.40575822e+02
  2.40575822e+02  5.08229006e+02  1.87430173e+03  8.00315054e+03
  4.77702048e+04]
E1 = -182.58851154278864  E_coul = 54.04680764929811
Extra cycle  E= -128.541703893491  delta_E= -2.61e-12  |g|= 2.2e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3436.9480859225937
E1 = -182.58851154278864  E_coul = 54.04680764929811
init E= -128.541703893491
    CPU time for initialize scf      0.34 sec, wall time      0.34 sec
  HOMO = -0.849048555945865  LUMO = 0.800847653246308
  mo_energy =
[-3.27709131e+01 -1.92938934e+00 -8.49048556e-01 -8.49048556e-01
 -8.49048556e-01  8.00847653e-01  8.00847653e-01  8.00847653e-01
  8.02442006e-01  3.87246844e+00  3.87246844e+00  3.87246844e+00
  4.21659033e+00  1.30744952e+01  1.41998103e+01  1.41998103e+01
  1.41998103e+01  4.21112998e+01  5.27859547e+01  5.27859547e+01
  5.27859547e+01  1.45755066e+02  2.40575819e+02  2.40575819e+02
  2.40575819e+02  5.08229002e+02  1.87430173e+03  8.00315053e+03
  4.77702048e+04]
E1 = -182.5885202382494  E_coul = 54.046816344758625
cycle= 1 E= -128.541703893491  delta_E= -2.27e-13  |g|= 1.19e-06  |ddm|= 7.94e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5885202382494  E_coul = 54.046816344758625
  HOMO = -0.849047943772605  LUMO = 0.800847805579395
  mo_energy =
[-3.27709113e+01 -1.92938866e+00 -8.49047944e-01 -8.49047944e-01
 -8.49047944e-01  8.00847806e-01  8.00847806e-01  8.00847806e-01
  8.02442185e-01  3.87246899e+00  3.87246899e+00  3.87246899e+00
  4.21659077e+00  1.30744961e+01  1.41998114e+01  1.41998114e+01
  1.41998114e+01  4.21113012e+01  5.27859563e+01  5.27859563e+01
  5.27859563e+01  1.45755068e+02  2.40575821e+02  2.40575821e+02
  2.40575821e+02  5.08229004e+02  1.87430173e+03  8.00315054e+03
  4.77702048e+04]
E1 = -182.58851586725305  E_coul = 54.046811973762395
Extra cycle  E= -128.541703893491  delta_E= 1.14e-13  |g|= 5.94e-07  |ddm|= 3.77e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [8.37408725e-01 2.44137942e+04 3.66145159e+03 8.33319040e+02
 2.35444001e+02 7.61173813e+01 1.02514900e+01 2.69509288e+01
 3.17582630e-01 1.99752901e+00 2.95772104e+00 7.11277390e+00
 2.31705470e+01 9.97863437e+01 2.64636340e-01 2.43769953e+00
 8.29839385e-01]
grad_E = [ 2.28527888e-05  5.51543931e-10 -2.79396629e-08  5.12917498e-07
 -5.75857830e-06  5.10084711e-05 -9.96816855e-05 -1.67993644e-04
 -7.24572800e-05  5.33820519e-05 -7.68922836e-05 -2.42518974e-05
  8.50174369e-07  1.02675715e-08  1.49197496e-04  3.59461187e-04
 -1.09382979e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.836264713336       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158862        1
[INPUT] 0    0    [1    /1   ]  833.319037305        1
[INPUT] 0    0    [1    /1   ]  235.444023732        1
[INPUT] 0    0    [1    /1   ]  76.1170687003        1
[INPUT] 0    0    [1    /1   ]  10.2582472429        1
[INPUT] 0    0    [1    /1   ]  26.9512340048        1
[INPUT] 0    0    [1    /1   ]  0.31848075017        1
[INPUT] 0    0    [1    /1   ]  1.99908241296        1
[INPUT] 0    0    [1    /1   ]  2.95931018829        1
[INPUT] 1    0    [1    /1   ]  7.113860649          1
[INPUT] 1    0    [1    /1   ]  23.1703517275        1
[INPUT] 1    0    [1    /1   ]  99.7863514237        1
[INPUT] 1    0    [1    /1   ]  0.264978486562       1
[INPUT] 1    0    [1    /1   ]  2.4358848783         1
[INPUT] 1    0    [1    /1   ]  0.830278469089       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8362647133355686, 1.0]], [0, [24413.79418618189, 1.0]], [0, [3661.4515886192803, 1.0]], [0, [833.3190373046391, 1.0]], [0, [235.44402373197804, 1.0]], [0, [76.11706870026612, 1.0]], [0, [10.258247242866913, 1.0]], [0, [26.951234004839183, 1.0]], [0, [0.3184807501696493, 1.0]], [0, [1.9990824129552793, 1.0]], [0, [2.95931018829129, 1.0]], [1, [7.1138606490037954, 1.0]], [1, [23.170351727462695, 1.0]], [1, [99.78635142366537, 1.0]], [1, [0.26497848656235634, 1.0]], [1, [2.4358848783042206, 1.0]], [1, [0.8302784690886713, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83626471]
bas 1, expnt(s) = [24413.79418618]
bas 2, expnt(s) = [3661.45158862]
bas 3, expnt(s) = [833.3190373]
bas 4, expnt(s) = [235.44402373]
bas 5, expnt(s) = [76.1170687]
bas 6, expnt(s) = [10.25824724]
bas 7, expnt(s) = [26.951234]
bas 8, expnt(s) = [0.31848075]
bas 9, expnt(s) = [1.99908241]
bas 10, expnt(s) = [2.95931019]
bas 11, expnt(s) = [7.11386065]
bas 12, expnt(s) = [23.17035173]
bas 13, expnt(s) = [99.78635142]
bas 14, expnt(s) = [0.26497849]
bas 15, expnt(s) = [2.43588488]
bas 16, expnt(s) = [0.83027847]
CPU time:       109.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.36264713e-01 2.20939239e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319037e+02 3.91853294e+02
 2.35444024e+02 1.51855588e+02 7.61170687e+01 6.51068323e+01
 1.02582472e+01 1.44817117e+01 2.69512340e+01 2.98847079e+01
 3.18480750e-01 1.07109358e+00 1.99908241e+00 4.24754558e+00
 2.95931019e+00 5.70043360e+00 7.11386065e+00 3.38934740e+01
 2.31703517e+01 1.48303082e+02 9.97863514e+01 9.20075194e+02
 2.64978487e-01 5.54622727e-01 2.43588488e+00 8.87779969e+00
 8.30278469e-01 2.31213992e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999643958898812
cond(S) = 3435.103207241357
E1 = -183.5898505353439  E_coul = 55.08016422220965
init E= -128.509686313134
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775405667166985  LUMO = 0.819919155590302
  mo_energy =
[-3.25551264e+01 -1.85272229e+00 -7.75405667e-01 -7.75405667e-01
 -7.75405667e-01  8.19919156e-01  8.19919156e-01  8.19919156e-01
  8.24180165e-01  3.93982476e+00  3.93982476e+00  3.93982476e+00
  4.27138802e+00  1.31803440e+01  1.43266611e+01  1.43266611e+01
  1.43266611e+01  4.22975047e+01  5.29725490e+01  5.29725490e+01
  5.29725490e+01  1.46002097e+02  2.40808787e+02  2.40808787e+02
  2.40808787e+02  5.08510927e+02  1.87461179e+03  8.00348351e+03
  4.77705507e+04]
E1 = -182.08500852231805  E_coul = 53.54681556821912
cycle= 1 E= -128.538192954099  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518937
diis-c [-0.26929574  1.        ]
  HOMO = -0.884380493357358  LUMO = 0.793290183196869
  mo_energy =
[-3.28785166e+01 -1.96669008e+00 -8.84380493e-01 -8.84380493e-01
 -8.84380493e-01  7.93290183e-01  7.93290183e-01  7.93290183e-01
  7.94479669e-01  3.84251513e+00  3.84251513e+00  3.84251513e+00
  4.19433981e+00  1.30338613e+01  1.41358072e+01  1.41358072e+01
  1.41358072e+01  4.20523771e+01  5.26913829e+01  5.26913829e+01
  5.26913829e+01  1.45685643e+02  2.40462246e+02  2.40462246e+02
  2.40462246e+02  5.08149554e+02  1.87421401e+03  8.00305657e+03
  4.77701049e+04]
E1 = -182.84706895928213  E_coul = 54.306285631075426
cycle= 2 E= -128.540783328207  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263606
diis-c [-0.00067051  0.3360543   0.6639457 ]
  HOMO = -0.848719138304822  LUMO = 0.801976880695089
  mo_energy =
[-3.27703307e+01 -1.92913745e+00 -8.48719138e-01 -8.48719138e-01
 -8.48719138e-01  8.01976881e-01  8.01976881e-01  8.01976881e-01
  8.03995528e-01  3.87409053e+00  3.87409053e+00  3.87409053e+00
  4.21925695e+00  1.30819949e+01  1.41990476e+01  1.41990476e+01
  1.41990476e+01  4.21344659e+01  5.27854907e+01  5.27854907e+01
  5.27854907e+01  1.45791232e+02  2.40576008e+02  2.40576008e+02
  2.40576008e+02  5.08266335e+02  1.87433615e+03  8.00318117e+03
  4.77702304e+04]
E1 = -182.58814840786383  E_coul = 54.04644360207335
cycle= 3 E= -128.54170480579  delta_E= -0.000921  |g|= 0.000528  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118458
diis-c [-1.96523713e-07 -2.34480648e-03 -4.42560841e-04  1.00278737e+00]
  HOMO = -0.848983750466534  LUMO = 0.801935563343642
  mo_energy =
[-3.27708109e+01 -1.92933873e+00 -8.48983750e-01 -8.48983750e-01
 -8.48983750e-01  8.01935563e-01  8.01935563e-01  8.01935563e-01
  8.03939710e-01  3.87390635e+00  3.87390635e+00  3.87390635e+00
  4.21911345e+00  1.30817389e+01  1.41987289e+01  1.41987289e+01
  1.41987289e+01  4.21340934e+01  5.27850670e+01  5.27850670e+01
  5.27850670e+01  1.45790751e+02  2.40575455e+02  2.40575455e+02
  2.40575455e+02  5.08265724e+02  1.87433541e+03  8.00318033e+03
  4.77702295e+04]
E1 = -182.58864595607588  E_coul = 54.04694112346967
cycle= 4 E= -128.541704832606  delta_E= -2.68e-08  |g|= 7.98e-05  |ddm|= 0.000427
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185438
diis-c [-1.06470969e-09  2.33589800e-04  4.60725499e-04 -1.82779630e-01
  1.18208531e+00]
  HOMO = -0.8490266725231  LUMO = 0.801922289967604
  mo_energy =
[-3.27708839e+01 -1.92937138e+00 -8.49026673e-01 -8.49026673e-01
 -8.49026673e-01  8.01922290e-01  8.01922290e-01  8.01922290e-01
  8.03926426e-01  3.87386635e+00  3.87386635e+00  3.87386635e+00
  4.21908311e+00  1.30816891e+01  1.41986696e+01  1.41986696e+01
  1.41986696e+01  4.21340286e+01  5.27849981e+01  5.27849981e+01
  5.27849981e+01  1.45790678e+02  2.40575378e+02  2.40575378e+02
  2.40575378e+02  5.08265643e+02  1.87433532e+03  8.00318023e+03
  4.77702294e+04]
E1 = -182.58877860213227  E_coul = 54.04707376882793
cycle= 5 E= -128.541704833304  delta_E= -6.98e-10  |g|= 5.78e-06  |ddm|= 7.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58877860213227  E_coul = 54.04707376882793
  HOMO = -0.849023645163053  LUMO = 0.801923173300249
  mo_energy =
[-3.27708770e+01 -1.92936757e+00 -8.49023645e-01 -8.49023645e-01
 -8.49023645e-01  8.01923173e-01  8.01923173e-01  8.01923173e-01
  8.03927733e-01  3.87386924e+00  3.87386924e+00  3.87386924e+00
  4.21908577e+00  1.30816933e+01  1.41986746e+01  1.41986746e+01
  1.41986746e+01  4.21340346e+01  5.27850045e+01  5.27850045e+01
  5.27850045e+01  1.45790685e+02  2.40575384e+02  2.40575384e+02
  2.40575384e+02  5.08265649e+02  1.87433532e+03  8.00318024e+03
  4.77702295e+04]
E1 = -182.58876308974143  E_coul = 54.04705825643466
Extra cycle  E= -128.541704833307  delta_E= -2.44e-12  |g|= 2.18e-06  |ddm|= 2.1e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.36264713e-01 2.44137942e+04 3.66145159e+03 8.33319037e+02
 2.35444024e+02 7.61170687e+01 1.02582472e+01 2.69512340e+01
 3.18480750e-01 1.99908241e+00 2.95931019e+00 7.11386065e+00
 2.31703517e+01 9.97863514e+01 2.64978487e-01 2.43588488e+00
 8.30278469e-01]
E = -128.54170483330677
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.836264713336       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158862        1
[INPUT] 0    0    [1    /1   ]  833.319037305        1
[INPUT] 0    0    [1    /1   ]  235.444023732        1
[INPUT] 0    0    [1    /1   ]  76.1170687003        1
[INPUT] 0    0    [1    /1   ]  10.2582472429        1
[INPUT] 0    0    [1    /1   ]  26.9512340048        1
[INPUT] 0    0    [1    /1   ]  0.31848075017        1
[INPUT] 0    0    [1    /1   ]  1.99908241296        1
[INPUT] 0    0    [1    /1   ]  2.95931018829        1
[INPUT] 1    0    [1    /1   ]  7.113860649          1
[INPUT] 1    0    [1    /1   ]  23.1703517275        1
[INPUT] 1    0    [1    /1   ]  99.7863514237        1
[INPUT] 1    0    [1    /1   ]  0.264978486562       1
[INPUT] 1    0    [1    /1   ]  2.4358848783         1
[INPUT] 1    0    [1    /1   ]  0.830278469089       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8362647133355686, 1.0]], [0, [24413.79418618189, 1.0]], [0, [3661.4515886192803, 1.0]], [0, [833.3190373046391, 1.0]], [0, [235.44402373197804, 1.0]], [0, [76.11706870026612, 1.0]], [0, [10.258247242866913, 1.0]], [0, [26.951234004839183, 1.0]], [0, [0.3184807501696493, 1.0]], [0, [1.9990824129552793, 1.0]], [0, [2.95931018829129, 1.0]], [1, [7.1138606490037954, 1.0]], [1, [23.170351727462695, 1.0]], [1, [99.78635142366537, 1.0]], [1, [0.26497848656235634, 1.0]], [1, [2.4358848783042206, 1.0]], [1, [0.8302784690886713, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83626471]
bas 1, expnt(s) = [24413.79418618]
bas 2, expnt(s) = [3661.45158862]
bas 3, expnt(s) = [833.3190373]
bas 4, expnt(s) = [235.44402373]
bas 5, expnt(s) = [76.1170687]
bas 6, expnt(s) = [10.25824724]
bas 7, expnt(s) = [26.951234]
bas 8, expnt(s) = [0.31848075]
bas 9, expnt(s) = [1.99908241]
bas 10, expnt(s) = [2.95931019]
bas 11, expnt(s) = [7.11386065]
bas 12, expnt(s) = [23.17035173]
bas 13, expnt(s) = [99.78635142]
bas 14, expnt(s) = [0.26497849]
bas 15, expnt(s) = [2.43588488]
bas 16, expnt(s) = [0.83027847]
CPU time:       110.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.36264713e-01 2.20939239e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319037e+02 3.91853294e+02
 2.35444024e+02 1.51855588e+02 7.61170687e+01 6.51068323e+01
 1.02582472e+01 1.44817117e+01 2.69512340e+01 2.98847079e+01
 3.18480750e-01 1.07109358e+00 1.99908241e+00 4.24754558e+00
 2.95931019e+00 5.70043360e+00 7.11386065e+00 3.38934740e+01
 2.31703517e+01 1.48303082e+02 9.97863514e+01 9.20075194e+02
 2.64978487e-01 5.54622727e-01 2.43588488e+00 8.87779969e+00
 8.30278469e-01 2.31213992e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999643958898812
cond(S) = 3435.103207241357
E1 = -183.5898505353439  E_coul = 55.08016422220965
init E= -128.509686313134
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775405667166985  LUMO = 0.819919155590302
  mo_energy =
[-3.25551264e+01 -1.85272229e+00 -7.75405667e-01 -7.75405667e-01
 -7.75405667e-01  8.19919156e-01  8.19919156e-01  8.19919156e-01
  8.24180165e-01  3.93982476e+00  3.93982476e+00  3.93982476e+00
  4.27138802e+00  1.31803440e+01  1.43266611e+01  1.43266611e+01
  1.43266611e+01  4.22975047e+01  5.29725490e+01  5.29725490e+01
  5.29725490e+01  1.46002097e+02  2.40808787e+02  2.40808787e+02
  2.40808787e+02  5.08510927e+02  1.87461179e+03  8.00348351e+03
  4.77705507e+04]
E1 = -182.08500852231805  E_coul = 53.54681556821912
cycle= 1 E= -128.538192954099  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518937
diis-c [-0.26929574  1.        ]
  HOMO = -0.884380493357358  LUMO = 0.793290183196869
  mo_energy =
[-3.28785166e+01 -1.96669008e+00 -8.84380493e-01 -8.84380493e-01
 -8.84380493e-01  7.93290183e-01  7.93290183e-01  7.93290183e-01
  7.94479669e-01  3.84251513e+00  3.84251513e+00  3.84251513e+00
  4.19433981e+00  1.30338613e+01  1.41358072e+01  1.41358072e+01
  1.41358072e+01  4.20523771e+01  5.26913829e+01  5.26913829e+01
  5.26913829e+01  1.45685643e+02  2.40462246e+02  2.40462246e+02
  2.40462246e+02  5.08149554e+02  1.87421401e+03  8.00305657e+03
  4.77701049e+04]
E1 = -182.84706895928213  E_coul = 54.306285631075426
cycle= 2 E= -128.540783328207  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263606
diis-c [-0.00067051  0.3360543   0.6639457 ]
  HOMO = -0.848719138304822  LUMO = 0.801976880695089
  mo_energy =
[-3.27703307e+01 -1.92913745e+00 -8.48719138e-01 -8.48719138e-01
 -8.48719138e-01  8.01976881e-01  8.01976881e-01  8.01976881e-01
  8.03995528e-01  3.87409053e+00  3.87409053e+00  3.87409053e+00
  4.21925695e+00  1.30819949e+01  1.41990476e+01  1.41990476e+01
  1.41990476e+01  4.21344659e+01  5.27854907e+01  5.27854907e+01
  5.27854907e+01  1.45791232e+02  2.40576008e+02  2.40576008e+02
  2.40576008e+02  5.08266335e+02  1.87433615e+03  8.00318117e+03
  4.77702304e+04]
E1 = -182.58814840786383  E_coul = 54.04644360207335
cycle= 3 E= -128.54170480579  delta_E= -0.000921  |g|= 0.000528  |ddm|= 0.0219
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00118458
diis-c [-1.96523713e-07 -2.34480648e-03 -4.42560841e-04  1.00278737e+00]
  HOMO = -0.848983750466534  LUMO = 0.801935563343642
  mo_energy =
[-3.27708109e+01 -1.92933873e+00 -8.48983750e-01 -8.48983750e-01
 -8.48983750e-01  8.01935563e-01  8.01935563e-01  8.01935563e-01
  8.03939710e-01  3.87390635e+00  3.87390635e+00  3.87390635e+00
  4.21911345e+00  1.30817389e+01  1.41987289e+01  1.41987289e+01
  1.41987289e+01  4.21340934e+01  5.27850670e+01  5.27850670e+01
  5.27850670e+01  1.45790751e+02  2.40575455e+02  2.40575455e+02
  2.40575455e+02  5.08265724e+02  1.87433541e+03  8.00318033e+03
  4.77702295e+04]
E1 = -182.58864595607588  E_coul = 54.04694112346967
cycle= 4 E= -128.541704832606  delta_E= -2.68e-08  |g|= 7.98e-05  |ddm|= 0.000427
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185438
diis-c [-1.06470969e-09  2.33589800e-04  4.60725499e-04 -1.82779630e-01
  1.18208531e+00]
  HOMO = -0.8490266725231  LUMO = 0.801922289967604
  mo_energy =
[-3.27708839e+01 -1.92937138e+00 -8.49026673e-01 -8.49026673e-01
 -8.49026673e-01  8.01922290e-01  8.01922290e-01  8.01922290e-01
  8.03926426e-01  3.87386635e+00  3.87386635e+00  3.87386635e+00
  4.21908311e+00  1.30816891e+01  1.41986696e+01  1.41986696e+01
  1.41986696e+01  4.21340286e+01  5.27849981e+01  5.27849981e+01
  5.27849981e+01  1.45790678e+02  2.40575378e+02  2.40575378e+02
  2.40575378e+02  5.08265643e+02  1.87433532e+03  8.00318023e+03
  4.77702294e+04]
E1 = -182.58877860213227  E_coul = 54.04707376882793
cycle= 5 E= -128.541704833304  delta_E= -6.98e-10  |g|= 5.78e-06  |ddm|= 7.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58877860213227  E_coul = 54.04707376882793
  HOMO = -0.849023645163053  LUMO = 0.801923173300249
  mo_energy =
[-3.27708770e+01 -1.92936757e+00 -8.49023645e-01 -8.49023645e-01
 -8.49023645e-01  8.01923173e-01  8.01923173e-01  8.01923173e-01
  8.03927733e-01  3.87386924e+00  3.87386924e+00  3.87386924e+00
  4.21908577e+00  1.30816933e+01  1.41986746e+01  1.41986746e+01
  1.41986746e+01  4.21340346e+01  5.27850045e+01  5.27850045e+01
  5.27850045e+01  1.45790685e+02  2.40575384e+02  2.40575384e+02
  2.40575384e+02  5.08265649e+02  1.87433532e+03  8.00318024e+03
  4.77702295e+04]
E1 = -182.58876308974143  E_coul = 54.04705825643466
Extra cycle  E= -128.541704833307  delta_E= -2.44e-12  |g|= 2.18e-06  |ddm|= 2.1e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3435.103207241357
E1 = -182.58876308974143  E_coul = 54.04705825643466
init E= -128.541704833307
    CPU time for initialize scf      0.38 sec, wall time      0.38 sec
  HOMO = -0.849024743317328  LUMO = 0.801922923295318
  mo_energy =
[-3.27708805e+01 -1.92936859e+00 -8.49024743e-01 -8.49024743e-01
 -8.49024743e-01  8.01922923e-01  8.01922923e-01  8.01922923e-01
  8.03927521e-01  3.87386829e+00  3.87386829e+00  3.87386829e+00
  4.21908509e+00  1.30816919e+01  1.41986726e+01  1.41986726e+01
  1.41986726e+01  4.21340321e+01  5.27850016e+01  5.27850016e+01
  5.27850016e+01  1.45790682e+02  2.40575381e+02  2.40575381e+02
  2.40575381e+02  5.08265646e+02  1.87433532e+03  8.00318023e+03
  4.77702294e+04]
E1 = -182.5887717006841  E_coul = 54.04706686737686
cycle= 1 E= -128.541704833307  delta_E= -4.83e-13  |g|= 1.18e-06  |ddm|= 7.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5887717006841  E_coul = 54.04706686737686
  HOMO = -0.849024137187996  LUMO = 0.801923074301342
  mo_energy =
[-3.27708786e+01 -1.92936792e+00 -8.49024137e-01 -8.49024137e-01
 -8.49024137e-01  8.01923074e-01  8.01923074e-01  8.01923074e-01
  8.03927699e-01  3.87386884e+00  3.87386884e+00  3.87386884e+00
  4.21908554e+00  1.30816927e+01  1.41986737e+01  1.41986737e+01
  1.41986737e+01  4.21340334e+01  5.27850031e+01  5.27850031e+01
  5.27850031e+01  1.45790683e+02  2.40575383e+02  2.40575383e+02
  2.40575383e+02  5.08265648e+02  1.87433532e+03  8.00318023e+03
  4.77702294e+04]
E1 = -182.58876737200958  E_coul = 54.04706253870221
Extra cycle  E= -128.541704833307  delta_E= -1.42e-13  |g|= 5.88e-07  |ddm|= 3.74e-07
    CPU time for scf_cycle      0.45 sec, wall time      0.45 sec
exp = [8.36264713e-01 2.44137942e+04 3.66145159e+03 8.33319037e+02
 2.35444024e+02 7.61170687e+01 1.02582472e+01 2.69512340e+01
 3.18480750e-01 1.99908241e+00 2.95931019e+00 7.11386065e+00
 2.31703517e+01 9.97863514e+01 2.64978487e-01 2.43588488e+00
 8.30278469e-01]
grad_E = [-1.54473784e-04  5.79925005e-10 -2.94261314e-08  5.43029282e-07
 -6.11884652e-06  5.38145143e-05 -8.31229569e-05 -1.79478909e-04
  3.48535805e-04  7.03372864e-05 -8.10545622e-05  1.06986490e-04
 -1.29527617e-05  5.02331023e-07 -1.75966888e-04 -1.65234602e-04
 -2.20827424e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.838998009007       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.4515888         1
[INPUT] 0    0    [1    /1   ]  833.319034754        1
[INPUT] 0    0    [1    /1   ]  235.444043875        1
[INPUT] 0    0    [1    /1   ]  76.1168217942        1
[INPUT] 0    0    [1    /1   ]  10.2602942585        1
[INPUT] 0    0    [1    /1   ]  26.9517423928        1
[INPUT] 0    0    [1    /1   ]  0.318001606894       1
[INPUT] 0    0    [1    /1   ]  2.00746763211        1
[INPUT] 0    0    [1    /1   ]  2.96012912263        1
[INPUT] 1    0    [1    /1   ]  7.11338599362        1
[INPUT] 1    0    [1    /1   ]  23.170414173         1
[INPUT] 1    0    [1    /1   ]  99.786348553         1
[INPUT] 1    0    [1    /1   ]  0.265403172176       1
[INPUT] 1    0    [1    /1   ]  2.43642564682        1
[INPUT] 1    0    [1    /1   ]  0.831317433564       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8389980090072909, 1.0]], [0, [24413.7941861781, 1.0]], [0, [3661.4515887988073, 1.0]], [0, [833.3190347538953, 1.0]], [0, [235.4440438749035, 1.0]], [0, [76.11682179424604, 1.0]], [0, [10.260294258465496, 1.0]], [0, [26.95174239282489, 1.0]], [0, [0.3180016068943304, 1.0]], [0, [2.0074676321089218, 1.0]], [0, [2.9601291226316357, 1.0]], [1, [7.113385993618774, 1.0]], [1, [23.1704141729734, 1.0]], [1, [99.78634855304543, 1.0]], [1, [0.26540317217630427, 1.0]], [1, [2.436425646818663, 1.0]], [1, [0.8313174335644453, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83899801]
bas 1, expnt(s) = [24413.79418618]
bas 2, expnt(s) = [3661.4515888]
bas 3, expnt(s) = [833.31903475]
bas 4, expnt(s) = [235.44404387]
bas 5, expnt(s) = [76.11682179]
bas 6, expnt(s) = [10.26029426]
bas 7, expnt(s) = [26.95174239]
bas 8, expnt(s) = [0.31800161]
bas 9, expnt(s) = [2.00746763]
bas 10, expnt(s) = [2.96012912]
bas 11, expnt(s) = [7.11338599]
bas 12, expnt(s) = [23.17041417]
bas 13, expnt(s) = [99.78634855]
bas 14, expnt(s) = [0.26540317]
bas 15, expnt(s) = [2.43642565]
bas 16, expnt(s) = [0.83131743]
CPU time:       113.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.38998009e-01 2.21480616e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319035e+02 3.91853293e+02
 2.35444044e+02 1.51855598e+02 7.61168218e+01 6.51066739e+01
 1.02602943e+01 1.44838789e+01 2.69517424e+01 2.98851307e+01
 3.18001607e-01 1.06988478e+00 2.00746763e+00 4.26090094e+00
 2.96012912e+00 5.70161668e+00 7.11338599e+00 3.38906471e+01
 2.31704142e+01 1.48303581e+02 9.97863486e+01 9.20075161e+02
 2.65403172e-01 5.55734079e-01 2.43642565e+00 8.88026336e+00
 8.31317434e-01 2.31575709e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999641257143871
cond(S) = 3498.4938921385346
E1 = -183.58986854632585  E_coul = 55.080182885744634
init E= -128.509685660581
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.775403923120565  LUMO = 0.821400861542009
  mo_energy =
[-3.25551228e+01 -1.85272079e+00 -7.75403923e-01 -7.75403923e-01
 -7.75403923e-01  8.21400862e-01  8.21400862e-01  8.21400862e-01
  8.24696646e-01  3.94439053e+00  3.94439053e+00  3.94439053e+00
  4.28136562e+00  1.32108982e+01  1.43328137e+01  1.43328137e+01
  1.43328137e+01  4.23472740e+01  5.29773803e+01  5.29773803e+01
  5.29773803e+01  1.46056307e+02  2.40811909e+02  2.40811909e+02
  2.40811909e+02  5.08561844e+02  1.87465767e+03  8.00352392e+03
  4.77705842e+04]
E1 = -182.08527447206387  E_coul = 53.54707985394872
cycle= 1 E= -128.538194618115  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518906
diis-c [-0.26926383  1.        ]
  HOMO = -0.884360908442143  LUMO = 0.794720307258692
  mo_energy =
[-3.28784700e+01 -1.96666305e+00 -8.84360908e-01 -8.84360908e-01
 -8.84360908e-01  7.94720307e-01  7.94720307e-01  7.94720307e-01
  7.94960496e-01  3.84705895e+00  3.84705895e+00  3.84705895e+00
  4.20415520e+00  1.30643012e+01  1.41420005e+01  1.41420005e+01
  1.41420005e+01  4.21021688e+01  5.26962609e+01  5.26962609e+01
  5.26962609e+01  1.45739902e+02  2.40465414e+02  2.40465414e+02
  2.40465414e+02  5.08200518e+02  1.87425994e+03  8.00309702e+03
  4.77701384e+04]
E1 = -182.84712061627764  E_coul = 54.306336388774135
cycle= 2 E= -128.540784227504  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263563
diis-c [-0.00067075  0.3360303   0.6639697 ]
  HOMO = -0.848708988126073  LUMO = 0.803422055245272
  mo_energy =
[-3.27703076e+01 -1.92912059e+00 -8.48708988e-01 -8.48708988e-01
 -8.48708988e-01  8.03422055e-01  8.03422055e-01  8.03422055e-01
  8.04486700e-01  3.87863926e+00  3.87863926e+00  3.87863926e+00
  4.22912335e+00  1.31124696e+01  1.42052213e+01  1.42052213e+01
  1.42052213e+01  4.21842426e+01  5.27903452e+01  5.27903452e+01
  5.27903452e+01  1.45845466e+02  2.40579151e+02  2.40579151e+02
  2.40579151e+02  5.08317273e+02  1.87438206e+03  8.00322161e+03
  4.77702639e+04]
E1 = -182.5882761764916  E_coul = 54.04657096606613
cycle= 3 E= -128.541705210425  delta_E= -0.000921  |g|= 0.000531  |ddm|= 0.0219
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00118908
diis-c [-1.98876996e-07 -2.35157664e-03 -4.41225251e-04  1.00279280e+00]
  HOMO = -0.848974616934637  LUMO = 0.803380233275937
  mo_energy =
[-3.27707894e+01 -1.92932246e+00 -8.48974617e-01 -8.48974617e-01
 -8.48974617e-01  8.03380233e-01  8.03380233e-01  8.03380233e-01
  8.04430463e-01  3.87845407e+00  3.87845407e+00  3.87845407e+00
  4.22897876e+00  1.31122122e+01  1.42049013e+01  1.42049013e+01
  1.42049013e+01  4.21838687e+01  5.27899201e+01  5.27899201e+01
  5.27899201e+01  1.45844983e+02  2.40578597e+02  2.40578597e+02
  2.40578597e+02  5.08316661e+02  1.87438131e+03  8.00322076e+03
  4.77702630e+04]
E1 = -182.58877527350168  E_coul = 54.04707003590726
cycle= 4 E= -128.541705237594  delta_E= -2.72e-08  |g|= 8.02e-05  |ddm|= 0.000435
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186247
diis-c [-1.07435036e-09  2.35330562e-04  4.61641236e-04 -1.83520890e-01
  1.18282392e+00]
  HOMO = -0.849017734106199  LUMO = 0.80336687248255
  mo_energy =
[-3.27708626e+01 -1.92935518e+00 -8.49017734e-01 -8.49017734e-01
 -8.49017734e-01  8.03366872e-01  8.03366872e-01  8.03366872e-01
  8.04417128e-01  3.87841388e+00  3.87841388e+00  3.87841388e+00
  4.22894825e+00  1.31121621e+01  1.42048417e+01  1.42048417e+01
  1.42048417e+01  4.21838037e+01  5.27898509e+01  5.27898509e+01
  5.27898509e+01  1.45844910e+02  2.40578519e+02  2.40578519e+02
  2.40578519e+02  5.08316580e+02  1.87438122e+03  8.00322066e+03
  4.77702629e+04]
E1 = -182.58890828914772  E_coul = 54.04720305084618
cycle= 5 E= -128.541705238302  delta_E= -7.07e-10  |g|= 5.82e-06  |ddm|= 7.25e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58890828914772  E_coul = 54.04720305084618
  HOMO = -0.849014676984155  LUMO = 0.803367767427856
  mo_energy =
[-3.27708557e+01 -1.92935134e+00 -8.49014677e-01 -8.49014677e-01
 -8.49014677e-01  8.03367767e-01  8.03367767e-01  8.03367767e-01
  8.04418450e-01  3.87841681e+00  3.87841681e+00  3.87841681e+00
  4.22895095e+00  1.31121665e+01  1.42048468e+01  1.42048468e+01
  1.42048468e+01  4.21838097e+01  5.27898574e+01  5.27898574e+01
  5.27898574e+01  1.45844917e+02  2.40578526e+02  2.40578526e+02
  2.40578526e+02  5.08316586e+02  1.87438123e+03  8.00322067e+03
  4.77702629e+04]
E1 = -182.5888926881755  E_coul = 54.04718744987152
Extra cycle  E= -128.541705238304  delta_E= -2.42e-12  |g|= 2.2e-06  |ddm|= 2.15e-06
    CPU time for scf_cycle      0.18 sec, wall time      0.18 sec
exp = [8.38998009e-01 2.44137942e+04 3.66145159e+03 8.33319035e+02
 2.35444044e+02 7.61168218e+01 1.02602943e+01 2.69517424e+01
 3.18001607e-01 2.00746763e+00 2.96012912e+00 7.11338599e+00
 2.31704142e+01 9.97863486e+01 2.65403172e-01 2.43642565e+00
 8.31317434e-01]
E = -128.54170523830396
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.838998009007       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.4515888         1
[INPUT] 0    0    [1    /1   ]  833.319034754        1
[INPUT] 0    0    [1    /1   ]  235.444043875        1
[INPUT] 0    0    [1    /1   ]  76.1168217942        1
[INPUT] 0    0    [1    /1   ]  10.2602942585        1
[INPUT] 0    0    [1    /1   ]  26.9517423928        1
[INPUT] 0    0    [1    /1   ]  0.318001606894       1
[INPUT] 0    0    [1    /1   ]  2.00746763211        1
[INPUT] 0    0    [1    /1   ]  2.96012912263        1
[INPUT] 1    0    [1    /1   ]  7.11338599362        1
[INPUT] 1    0    [1    /1   ]  23.170414173         1
[INPUT] 1    0    [1    /1   ]  99.786348553         1
[INPUT] 1    0    [1    /1   ]  0.265403172176       1
[INPUT] 1    0    [1    /1   ]  2.43642564682        1
[INPUT] 1    0    [1    /1   ]  0.831317433564       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8389980090072909, 1.0]], [0, [24413.7941861781, 1.0]], [0, [3661.4515887988073, 1.0]], [0, [833.3190347538953, 1.0]], [0, [235.4440438749035, 1.0]], [0, [76.11682179424604, 1.0]], [0, [10.260294258465496, 1.0]], [0, [26.95174239282489, 1.0]], [0, [0.3180016068943304, 1.0]], [0, [2.0074676321089218, 1.0]], [0, [2.9601291226316357, 1.0]], [1, [7.113385993618774, 1.0]], [1, [23.1704141729734, 1.0]], [1, [99.78634855304543, 1.0]], [1, [0.26540317217630427, 1.0]], [1, [2.436425646818663, 1.0]], [1, [0.8313174335644453, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83899801]
bas 1, expnt(s) = [24413.79418618]
bas 2, expnt(s) = [3661.4515888]
bas 3, expnt(s) = [833.31903475]
bas 4, expnt(s) = [235.44404387]
bas 5, expnt(s) = [76.11682179]
bas 6, expnt(s) = [10.26029426]
bas 7, expnt(s) = [26.95174239]
bas 8, expnt(s) = [0.31800161]
bas 9, expnt(s) = [2.00746763]
bas 10, expnt(s) = [2.96012912]
bas 11, expnt(s) = [7.11338599]
bas 12, expnt(s) = [23.17041417]
bas 13, expnt(s) = [99.78634855]
bas 14, expnt(s) = [0.26540317]
bas 15, expnt(s) = [2.43642565]
bas 16, expnt(s) = [0.83131743]
CPU time:       114.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.38998009e-01 2.21480616e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319035e+02 3.91853293e+02
 2.35444044e+02 1.51855598e+02 7.61168218e+01 6.51066739e+01
 1.02602943e+01 1.44838789e+01 2.69517424e+01 2.98851307e+01
 3.18001607e-01 1.06988478e+00 2.00746763e+00 4.26090094e+00
 2.96012912e+00 5.70161668e+00 7.11338599e+00 3.38906471e+01
 2.31704142e+01 1.48303581e+02 9.97863486e+01 9.20075161e+02
 2.65403172e-01 5.55734079e-01 2.43642565e+00 8.88026336e+00
 8.31317434e-01 2.31575709e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999641257143871
cond(S) = 3498.4938921385346
E1 = -183.58986854632585  E_coul = 55.080182885744634
init E= -128.509685660581
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403923120565  LUMO = 0.821400861542009
  mo_energy =
[-3.25551228e+01 -1.85272079e+00 -7.75403923e-01 -7.75403923e-01
 -7.75403923e-01  8.21400862e-01  8.21400862e-01  8.21400862e-01
  8.24696646e-01  3.94439053e+00  3.94439053e+00  3.94439053e+00
  4.28136562e+00  1.32108982e+01  1.43328137e+01  1.43328137e+01
  1.43328137e+01  4.23472740e+01  5.29773803e+01  5.29773803e+01
  5.29773803e+01  1.46056307e+02  2.40811909e+02  2.40811909e+02
  2.40811909e+02  5.08561844e+02  1.87465767e+03  8.00352392e+03
  4.77705842e+04]
E1 = -182.08527447206387  E_coul = 53.54707985394872
cycle= 1 E= -128.538194618115  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518906
diis-c [-0.26926383  1.        ]
  HOMO = -0.884360908442143  LUMO = 0.794720307258692
  mo_energy =
[-3.28784700e+01 -1.96666305e+00 -8.84360908e-01 -8.84360908e-01
 -8.84360908e-01  7.94720307e-01  7.94720307e-01  7.94720307e-01
  7.94960496e-01  3.84705895e+00  3.84705895e+00  3.84705895e+00
  4.20415520e+00  1.30643012e+01  1.41420005e+01  1.41420005e+01
  1.41420005e+01  4.21021688e+01  5.26962609e+01  5.26962609e+01
  5.26962609e+01  1.45739902e+02  2.40465414e+02  2.40465414e+02
  2.40465414e+02  5.08200518e+02  1.87425994e+03  8.00309702e+03
  4.77701384e+04]
E1 = -182.84712061627764  E_coul = 54.306336388774135
cycle= 2 E= -128.540784227504  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263563
diis-c [-0.00067075  0.3360303   0.6639697 ]
  HOMO = -0.848708988126073  LUMO = 0.803422055245272
  mo_energy =
[-3.27703076e+01 -1.92912059e+00 -8.48708988e-01 -8.48708988e-01
 -8.48708988e-01  8.03422055e-01  8.03422055e-01  8.03422055e-01
  8.04486700e-01  3.87863926e+00  3.87863926e+00  3.87863926e+00
  4.22912335e+00  1.31124696e+01  1.42052213e+01  1.42052213e+01
  1.42052213e+01  4.21842426e+01  5.27903452e+01  5.27903452e+01
  5.27903452e+01  1.45845466e+02  2.40579151e+02  2.40579151e+02
  2.40579151e+02  5.08317273e+02  1.87438206e+03  8.00322161e+03
  4.77702639e+04]
E1 = -182.5882761764916  E_coul = 54.04657096606613
cycle= 3 E= -128.541705210425  delta_E= -0.000921  |g|= 0.000531  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118908
diis-c [-1.98876996e-07 -2.35157664e-03 -4.41225251e-04  1.00279280e+00]
  HOMO = -0.848974616934637  LUMO = 0.803380233275937
  mo_energy =
[-3.27707894e+01 -1.92932246e+00 -8.48974617e-01 -8.48974617e-01
 -8.48974617e-01  8.03380233e-01  8.03380233e-01  8.03380233e-01
  8.04430463e-01  3.87845407e+00  3.87845407e+00  3.87845407e+00
  4.22897876e+00  1.31122122e+01  1.42049013e+01  1.42049013e+01
  1.42049013e+01  4.21838687e+01  5.27899201e+01  5.27899201e+01
  5.27899201e+01  1.45844983e+02  2.40578597e+02  2.40578597e+02
  2.40578597e+02  5.08316661e+02  1.87438131e+03  8.00322076e+03
  4.77702630e+04]
E1 = -182.58877527350168  E_coul = 54.04707003590726
cycle= 4 E= -128.541705237594  delta_E= -2.72e-08  |g|= 8.02e-05  |ddm|= 0.000435
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186247
diis-c [-1.07435036e-09  2.35330562e-04  4.61641236e-04 -1.83520890e-01
  1.18282392e+00]
  HOMO = -0.849017734106199  LUMO = 0.80336687248255
  mo_energy =
[-3.27708626e+01 -1.92935518e+00 -8.49017734e-01 -8.49017734e-01
 -8.49017734e-01  8.03366872e-01  8.03366872e-01  8.03366872e-01
  8.04417128e-01  3.87841388e+00  3.87841388e+00  3.87841388e+00
  4.22894825e+00  1.31121621e+01  1.42048417e+01  1.42048417e+01
  1.42048417e+01  4.21838037e+01  5.27898509e+01  5.27898509e+01
  5.27898509e+01  1.45844910e+02  2.40578519e+02  2.40578519e+02
  2.40578519e+02  5.08316580e+02  1.87438122e+03  8.00322066e+03
  4.77702629e+04]
E1 = -182.58890828914772  E_coul = 54.04720305084618
cycle= 5 E= -128.541705238302  delta_E= -7.07e-10  |g|= 5.82e-06  |ddm|= 7.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58890828914772  E_coul = 54.04720305084618
  HOMO = -0.849014676984155  LUMO = 0.803367767427856
  mo_energy =
[-3.27708557e+01 -1.92935134e+00 -8.49014677e-01 -8.49014677e-01
 -8.49014677e-01  8.03367767e-01  8.03367767e-01  8.03367767e-01
  8.04418450e-01  3.87841681e+00  3.87841681e+00  3.87841681e+00
  4.22895095e+00  1.31121665e+01  1.42048468e+01  1.42048468e+01
  1.42048468e+01  4.21838097e+01  5.27898574e+01  5.27898574e+01
  5.27898574e+01  1.45844917e+02  2.40578526e+02  2.40578526e+02
  2.40578526e+02  5.08316586e+02  1.87438123e+03  8.00322067e+03
  4.77702629e+04]
E1 = -182.5888926881755  E_coul = 54.04718744987152
Extra cycle  E= -128.541705238304  delta_E= -2.42e-12  |g|= 2.2e-06  |ddm|= 2.15e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3498.4938921385346
E1 = -182.5888926881755  E_coul = 54.04718744987152
init E= -128.541705238304
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.849015780850552  LUMO = 0.80336751582351
  mo_energy =
[-3.27708592e+01 -1.92935237e+00 -8.49015781e-01 -8.49015781e-01
 -8.49015781e-01  8.03367516e-01  8.03367516e-01  8.03367516e-01
  8.04418237e-01  3.87841585e+00  3.87841585e+00  3.87841585e+00
  4.22895026e+00  1.31121650e+01  1.42048448e+01  1.42048448e+01
  1.42048448e+01  4.21838071e+01  5.27898544e+01  5.27898544e+01
  5.27898544e+01  1.45844913e+02  2.40578522e+02  2.40578522e+02
  2.40578522e+02  5.08316582e+02  1.87438122e+03  8.00322066e+03
  4.77702629e+04]
E1 = -182.5889013562101  E_coul = 54.04719611790577
cycle= 1 E= -128.541705238304  delta_E= -3.69e-13  |g|= 1.19e-06  |ddm|= 7.93e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5889013562101  E_coul = 54.04719611790577
  HOMO = -0.849015170627646  LUMO = 0.803367668173683
  mo_energy =
[-3.27708574e+01 -1.92935169e+00 -8.49015171e-01 -8.49015171e-01
 -8.49015171e-01  8.03367668e-01  8.03367668e-01  8.03367668e-01
  8.04418416e-01  3.87841640e+00  3.87841640e+00  3.87841640e+00
  4.22895071e+00  1.31121659e+01  1.42048459e+01  1.42048459e+01
  1.42048459e+01  4.21838085e+01  5.27898560e+01  5.27898560e+01
  5.27898560e+01  1.45844915e+02  2.40578524e+02  2.40578524e+02
  2.40578524e+02  5.08316584e+02  1.87438123e+03  8.00322066e+03
  4.77702629e+04]
E1 = -182.58889700008461  E_coul = 54.04719176178008
Extra cycle  E= -128.541705238305  delta_E= -1.99e-13  |g|= 5.92e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [8.38998009e-01 2.44137942e+04 3.66145159e+03 8.33319035e+02
 2.35444044e+02 7.61168218e+01 1.02602943e+01 2.69517424e+01
 3.18001607e-01 2.00746763e+00 2.96012912e+00 7.11338599e+00
 2.31704142e+01 9.97863486e+01 2.65403172e-01 2.43642565e+00
 8.31317434e-01]
grad_E = [ 6.10257844e-06  5.84416607e-10 -2.96637737e-08  5.47891494e-07
 -6.18137002e-06  5.43546623e-05 -7.71688009e-05 -1.82251998e-04
 -3.99398512e-05  5.28689193e-05 -7.88165953e-05  1.20271438e-04
 -1.32359646e-05  4.97531448e-07 -1.24853560e-04 -2.97281019e-04
  9.60212266e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.83599102092        1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158861        1
[INPUT] 0    0    [1    /1   ]  833.319036999        1
[INPUT] 0    0    [1    /1   ]  235.444031269        1
[INPUT] 0    0    [1    /1   ]  76.1170463001        1
[INPUT] 0    0    [1    /1   ]  10.2562187302        1
[INPUT] 0    0    [1    /1   ]  26.9515755492        1
[INPUT] 0    0    [1    /1   ]  0.317294316574       1
[INPUT] 0    0    [1    /1   ]  1.99671367504        1
[INPUT] 0    0    [1    /1   ]  2.95881409479        1
[INPUT] 1    0    [1    /1   ]  7.11300641632        1
[INPUT] 1    0    [1    /1   ]  23.170480765         1
[INPUT] 1    0    [1    /1   ]  99.7863464477        1
[INPUT] 1    0    [1    /1   ]  0.26556052674        1
[INPUT] 1    0    [1    /1   ]  2.43706013873        1
[INPUT] 1    0    [1    /1   ]  0.831788232809       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.83599102092012, 1.0]], [0, [24413.79418618213, 1.0]], [0, [3661.4515886141658, 1.0]], [0, [833.3190369991311, 1.0]], [0, [235.44403126904828, 1.0]], [0, [76.11704630008794, 1.0]], [0, [10.256218730161654, 1.0]], [0, [26.951575549197567, 1.0]], [0, [0.31729431657363977, 1.0]], [0, [1.9967136750413443, 1.0]], [0, [2.9588140947905024, 1.0]], [1, [7.113006416324234, 1.0]], [1, [23.170480765011224, 1.0]], [1, [99.78634644768854, 1.0]], [1, [0.2655605267396597, 1.0]], [1, [2.437060138727767, 1.0]], [1, [0.8317882328090873, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83599102]
bas 1, expnt(s) = [24413.79418618]
bas 2, expnt(s) = [3661.45158861]
bas 3, expnt(s) = [833.319037]
bas 4, expnt(s) = [235.44403127]
bas 5, expnt(s) = [76.1170463]
bas 6, expnt(s) = [10.25621873]
bas 7, expnt(s) = [26.95157555]
bas 8, expnt(s) = [0.31729432]
bas 9, expnt(s) = [1.99671368]
bas 10, expnt(s) = [2.95881409]
bas 11, expnt(s) = [7.11300642]
bas 12, expnt(s) = [23.17048077]
bas 13, expnt(s) = [99.78634645]
bas 14, expnt(s) = [0.26556053]
bas 15, expnt(s) = [2.43706014]
bas 16, expnt(s) = [0.83178823]
CPU time:       117.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.35991021e-01 2.20885005e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319037e+02 3.91853294e+02
 2.35444031e+02 1.51855592e+02 7.61170463e+01 6.51068179e+01
 1.02562187e+01 1.44795638e+01 2.69515755e+01 2.98849919e+01
 3.17294317e-01 1.06809958e+00 1.99671368e+00 4.24377029e+00
 2.95881409e+00 5.69971688e+00 7.11300642e+00 3.38883866e+01
 2.31704808e+01 1.48304114e+02 9.97863464e+01 9.20075136e+02
 2.65560527e-01 5.56145970e-01 2.43706014e+00 8.88315419e+00
 8.31788233e-01 2.31739656e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640354236568
cond(S) = 3413.3543848994677
E1 = -183.58987440783557  E_coul = 55.08018288466904
init E= -128.509691523167
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.77540375573556  LUMO = 0.821515017472452
  mo_energy =
[-3.25551229e+01 -1.85272092e+00 -7.75403756e-01 -7.75403756e-01
 -7.75403756e-01  8.21515017e-01  8.21973524e-01  8.21973524e-01
  8.21973524e-01  3.94655002e+00  3.94655002e+00  3.94655002e+00
  4.26433365e+00  1.31670583e+01  1.43363735e+01  1.43363735e+01
  1.43363735e+01  4.22766061e+01  5.29803670e+01  5.29803670e+01
  5.29803670e+01  1.45978563e+02  2.40813891e+02  2.40813891e+02
  2.40813891e+02  5.08488789e+02  1.87459182e+03  8.00346592e+03
  4.77705362e+04]
E1 = -182.08539875255778  E_coul = 53.5472033137521
cycle= 1 E= -128.538195438806  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51889
diis-c [-0.26924662  1.        ]
  HOMO = -0.884350905245722  LUMO = 0.791903736981834
  mo_energy =
[-3.28784498e+01 -1.96665151e+00 -8.84350905e-01 -8.84350905e-01
 -8.84350905e-01  7.91903737e-01  7.95273930e-01  7.95273930e-01
  7.95273930e-01  3.84920106e+00  3.84920106e+00  3.84920106e+00
  4.18735648e+00  1.30206523e+01  1.41455782e+01  1.41455782e+01
  1.41455782e+01  4.20315369e+01  5.26992711e+01  5.26992711e+01
  5.26992711e+01  1.45662168e+02  2.40467416e+02  2.40467416e+02
  2.40467416e+02  5.08127479e+02  1.87419411e+03  8.00303904e+03
  4.77700904e+04]
E1 = -182.84716236255778  E_coul = 54.30637766182894
cycle= 2 E= -128.540784700729  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263545
diis-c [-0.00067034  0.33602227  0.66397773]
  HOMO = -0.848702591685096  LUMO = 0.801390021504897
  mo_energy =
[-3.27702970e+01 -1.92911302e+00 -8.48702592e-01 -8.48702592e-01
 -8.48702592e-01  8.01390022e-01  8.03981930e-01  8.03981930e-01
  8.03981930e-01  3.88078689e+00  3.88078689e+00  3.88078689e+00
  4.21224810e+00  1.30687560e+01  1.42087921e+01  1.42087921e+01
  1.42087921e+01  4.21135974e+01  5.27933456e+01  5.27933456e+01
  5.27933456e+01  1.45767726e+02  2.40581144e+02  2.40581144e+02
  2.40581144e+02  5.08244226e+02  1.87431622e+03  8.00316362e+03
  4.77702159e+04]
E1 = -182.5883513355105  E_coul = 54.04664585634497
cycle= 3 E= -128.541705479166  delta_E= -0.000921  |g|= 0.000531  |ddm|= 0.0219
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00118959
diis-c [-1.99485258e-07 -2.35248950e-03 -4.41862348e-04  1.00279435e+00]
  HOMO = -0.848968233702299  LUMO = 0.801334029370759
  mo_energy =
[-3.27707787e+01 -1.92931482e+00 -8.48968234e-01 -8.48968234e-01
 -8.48968234e-01  8.01334029e-01  8.03940064e-01  8.03940064e-01
  8.03940064e-01  3.88060165e+00  3.88060165e+00  3.88060165e+00
  4.21210395e+00  1.30684989e+01  1.42084721e+01  1.42084721e+01
  1.42084721e+01  4.21132235e+01  5.27929205e+01  5.27929205e+01
  5.27929205e+01  1.45767244e+02  2.40580589e+02  2.40580589e+02
  2.40580589e+02  5.08243614e+02  1.87431547e+03  8.00316277e+03
  4.77702150e+04]
E1 = -182.58885080561927  E_coul = 54.04714529925551
cycle= 4 E= -128.541705506364  delta_E= -2.72e-08  |g|= 8.02e-05  |ddm|= 0.000433
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186291
diis-c [-1.07573155e-09  2.35839771e-04  4.61540748e-04 -1.83749213e-01
  1.18305183e+00]
  HOMO = -0.849011350407121  LUMO = 0.801320753383128
  mo_energy =
[-3.27708520e+01 -1.92934751e+00 -8.49011350e-01 -8.49011350e-01
 -8.49011350e-01  8.01320753e-01  8.03926693e-01  8.03926693e-01
  8.03926693e-01  3.88056147e+00  3.88056147e+00  3.88056147e+00
  4.21207352e+00  1.30684489e+01  1.42084126e+01  1.42084126e+01
  1.42084126e+01  4.21131585e+01  5.27928513e+01  5.27928513e+01
  5.27928513e+01  1.45767170e+02  2.40580511e+02  2.40580511e+02
  2.40580511e+02  5.08243532e+02  1.87431538e+03  8.00316267e+03
  4.77702149e+04]
E1 = -182.58898379648605  E_coul = 54.04727828941385
cycle= 5 E= -128.541705507072  delta_E= -7.08e-10  |g|= 5.83e-06  |ddm|= 7.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58898379648605  E_coul = 54.04727828941385
  HOMO = -0.849008286956811  LUMO = 0.801322072861544
  mo_energy =
[-3.27708451e+01 -1.92934366e+00 -8.49008287e-01 -8.49008287e-01
 -8.49008287e-01  8.01322073e-01  8.03927591e-01  8.03927591e-01
  8.03927591e-01  3.88056440e+00  3.88056440e+00  3.88056440e+00
  4.21207622e+00  1.30684533e+01  1.42084176e+01  1.42084176e+01
  1.42084176e+01  4.21131645e+01  5.27928578e+01  5.27928578e+01
  5.27928578e+01  1.45767177e+02  2.40580518e+02  2.40580518e+02
  2.40580518e+02  5.08243538e+02  1.87431538e+03  8.00316268e+03
  4.77702149e+04]
E1 = -182.58896816925554  E_coul = 54.04726266218072
Extra cycle  E= -128.541705507075  delta_E= -2.61e-12  |g|= 2.2e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.16 sec, wall time      0.16 sec
exp = [8.35991021e-01 2.44137942e+04 3.66145159e+03 8.33319037e+02
 2.35444031e+02 7.61170463e+01 1.02562187e+01 2.69515755e+01
 3.17294317e-01 1.99671368e+00 2.95881409e+00 7.11300642e+00
 2.31704808e+01 9.97863464e+01 2.65560527e-01 2.43706014e+00
 8.31788233e-01]
E = -128.54170550707482
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:52:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.83599102092        1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158861        1
[INPUT] 0    0    [1    /1   ]  833.319036999        1
[INPUT] 0    0    [1    /1   ]  235.444031269        1
[INPUT] 0    0    [1    /1   ]  76.1170463001        1
[INPUT] 0    0    [1    /1   ]  10.2562187302        1
[INPUT] 0    0    [1    /1   ]  26.9515755492        1
[INPUT] 0    0    [1    /1   ]  0.317294316574       1
[INPUT] 0    0    [1    /1   ]  1.99671367504        1
[INPUT] 0    0    [1    /1   ]  2.95881409479        1
[INPUT] 1    0    [1    /1   ]  7.11300641632        1
[INPUT] 1    0    [1    /1   ]  23.170480765         1
[INPUT] 1    0    [1    /1   ]  99.7863464477        1
[INPUT] 1    0    [1    /1   ]  0.26556052674        1
[INPUT] 1    0    [1    /1   ]  2.43706013873        1
[INPUT] 1    0    [1    /1   ]  0.831788232809       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.83599102092012, 1.0]], [0, [24413.79418618213, 1.0]], [0, [3661.4515886141658, 1.0]], [0, [833.3190369991311, 1.0]], [0, [235.44403126904828, 1.0]], [0, [76.11704630008794, 1.0]], [0, [10.256218730161654, 1.0]], [0, [26.951575549197567, 1.0]], [0, [0.31729431657363977, 1.0]], [0, [1.9967136750413443, 1.0]], [0, [2.9588140947905024, 1.0]], [1, [7.113006416324234, 1.0]], [1, [23.170480765011224, 1.0]], [1, [99.78634644768854, 1.0]], [1, [0.2655605267396597, 1.0]], [1, [2.437060138727767, 1.0]], [1, [0.8317882328090873, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83599102]
bas 1, expnt(s) = [24413.79418618]
bas 2, expnt(s) = [3661.45158861]
bas 3, expnt(s) = [833.319037]
bas 4, expnt(s) = [235.44403127]
bas 5, expnt(s) = [76.1170463]
bas 6, expnt(s) = [10.25621873]
bas 7, expnt(s) = [26.95157555]
bas 8, expnt(s) = [0.31729432]
bas 9, expnt(s) = [1.99671368]
bas 10, expnt(s) = [2.95881409]
bas 11, expnt(s) = [7.11300642]
bas 12, expnt(s) = [23.17048077]
bas 13, expnt(s) = [99.78634645]
bas 14, expnt(s) = [0.26556053]
bas 15, expnt(s) = [2.43706014]
bas 16, expnt(s) = [0.83178823]
CPU time:       118.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.35991021e-01 2.20885005e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319037e+02 3.91853294e+02
 2.35444031e+02 1.51855592e+02 7.61170463e+01 6.51068179e+01
 1.02562187e+01 1.44795638e+01 2.69515755e+01 2.98849919e+01
 3.17294317e-01 1.06809958e+00 1.99671368e+00 4.24377029e+00
 2.95881409e+00 5.69971688e+00 7.11300642e+00 3.38883866e+01
 2.31704808e+01 1.48304114e+02 9.97863464e+01 9.20075136e+02
 2.65560527e-01 5.56145970e-01 2.43706014e+00 8.88315419e+00
 8.31788233e-01 2.31739656e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640354236568
cond(S) = 3413.3543848994677
E1 = -183.58987440783557  E_coul = 55.08018288466904
init E= -128.509691523167
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77540375573556  LUMO = 0.821515017472452
  mo_energy =
[-3.25551229e+01 -1.85272092e+00 -7.75403756e-01 -7.75403756e-01
 -7.75403756e-01  8.21515017e-01  8.21973524e-01  8.21973524e-01
  8.21973524e-01  3.94655002e+00  3.94655002e+00  3.94655002e+00
  4.26433365e+00  1.31670583e+01  1.43363735e+01  1.43363735e+01
  1.43363735e+01  4.22766061e+01  5.29803670e+01  5.29803670e+01
  5.29803670e+01  1.45978563e+02  2.40813891e+02  2.40813891e+02
  2.40813891e+02  5.08488789e+02  1.87459182e+03  8.00346592e+03
  4.77705362e+04]
E1 = -182.08539875255778  E_coul = 53.5472033137521
cycle= 1 E= -128.538195438806  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51889
diis-c [-0.26924662  1.        ]
  HOMO = -0.884350905245722  LUMO = 0.791903736981834
  mo_energy =
[-3.28784498e+01 -1.96665151e+00 -8.84350905e-01 -8.84350905e-01
 -8.84350905e-01  7.91903737e-01  7.95273930e-01  7.95273930e-01
  7.95273930e-01  3.84920106e+00  3.84920106e+00  3.84920106e+00
  4.18735648e+00  1.30206523e+01  1.41455782e+01  1.41455782e+01
  1.41455782e+01  4.20315369e+01  5.26992711e+01  5.26992711e+01
  5.26992711e+01  1.45662168e+02  2.40467416e+02  2.40467416e+02
  2.40467416e+02  5.08127479e+02  1.87419411e+03  8.00303904e+03
  4.77700904e+04]
E1 = -182.84716236255778  E_coul = 54.30637766182894
cycle= 2 E= -128.540784700729  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0632
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263545
diis-c [-0.00067034  0.33602227  0.66397773]
  HOMO = -0.848702591685096  LUMO = 0.801390021504897
  mo_energy =
[-3.27702970e+01 -1.92911302e+00 -8.48702592e-01 -8.48702592e-01
 -8.48702592e-01  8.01390022e-01  8.03981930e-01  8.03981930e-01
  8.03981930e-01  3.88078689e+00  3.88078689e+00  3.88078689e+00
  4.21224810e+00  1.30687560e+01  1.42087921e+01  1.42087921e+01
  1.42087921e+01  4.21135974e+01  5.27933456e+01  5.27933456e+01
  5.27933456e+01  1.45767726e+02  2.40581144e+02  2.40581144e+02
  2.40581144e+02  5.08244226e+02  1.87431622e+03  8.00316362e+03
  4.77702159e+04]
E1 = -182.5883513355105  E_coul = 54.04664585634497
cycle= 3 E= -128.541705479166  delta_E= -0.000921  |g|= 0.000531  |ddm|= 0.0219
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00118959
diis-c [-1.99485258e-07 -2.35248950e-03 -4.41862348e-04  1.00279435e+00]
  HOMO = -0.848968233702299  LUMO = 0.801334029370759
  mo_energy =
[-3.27707787e+01 -1.92931482e+00 -8.48968234e-01 -8.48968234e-01
 -8.48968234e-01  8.01334029e-01  8.03940064e-01  8.03940064e-01
  8.03940064e-01  3.88060165e+00  3.88060165e+00  3.88060165e+00
  4.21210395e+00  1.30684989e+01  1.42084721e+01  1.42084721e+01
  1.42084721e+01  4.21132235e+01  5.27929205e+01  5.27929205e+01
  5.27929205e+01  1.45767244e+02  2.40580589e+02  2.40580589e+02
  2.40580589e+02  5.08243614e+02  1.87431547e+03  8.00316277e+03
  4.77702150e+04]
E1 = -182.58885080561927  E_coul = 54.04714529925551
cycle= 4 E= -128.541705506364  delta_E= -2.72e-08  |g|= 8.02e-05  |ddm|= 0.000433
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186291
diis-c [-1.07573155e-09  2.35839771e-04  4.61540748e-04 -1.83749213e-01
  1.18305183e+00]
  HOMO = -0.849011350407121  LUMO = 0.801320753383128
  mo_energy =
[-3.27708520e+01 -1.92934751e+00 -8.49011350e-01 -8.49011350e-01
 -8.49011350e-01  8.01320753e-01  8.03926693e-01  8.03926693e-01
  8.03926693e-01  3.88056147e+00  3.88056147e+00  3.88056147e+00
  4.21207352e+00  1.30684489e+01  1.42084126e+01  1.42084126e+01
  1.42084126e+01  4.21131585e+01  5.27928513e+01  5.27928513e+01
  5.27928513e+01  1.45767170e+02  2.40580511e+02  2.40580511e+02
  2.40580511e+02  5.08243532e+02  1.87431538e+03  8.00316267e+03
  4.77702149e+04]
E1 = -182.58898379648605  E_coul = 54.04727828941385
cycle= 5 E= -128.541705507072  delta_E= -7.08e-10  |g|= 5.83e-06  |ddm|= 7.23e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58898379648605  E_coul = 54.04727828941385
  HOMO = -0.849008286956811  LUMO = 0.801322072861544
  mo_energy =
[-3.27708451e+01 -1.92934366e+00 -8.49008287e-01 -8.49008287e-01
 -8.49008287e-01  8.01322073e-01  8.03927591e-01  8.03927591e-01
  8.03927591e-01  3.88056440e+00  3.88056440e+00  3.88056440e+00
  4.21207622e+00  1.30684533e+01  1.42084176e+01  1.42084176e+01
  1.42084176e+01  4.21131645e+01  5.27928578e+01  5.27928578e+01
  5.27928578e+01  1.45767177e+02  2.40580518e+02  2.40580518e+02
  2.40580518e+02  5.08243538e+02  1.87431538e+03  8.00316268e+03
  4.77702149e+04]
E1 = -182.58896816925554  E_coul = 54.04726266218072
Extra cycle  E= -128.541705507075  delta_E= -2.61e-12  |g|= 2.2e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.16 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3413.3543848994677
E1 = -182.58896816925554  E_coul = 54.04726266218072
init E= -128.541705507075
    CPU time for initialize scf      0.37 sec, wall time      0.37 sec
  HOMO = -0.849009392621136  LUMO = 0.801321860416072
  mo_energy =
[-3.27708486e+01 -1.92934469e+00 -8.49009393e-01 -8.49009393e-01
 -8.49009393e-01  8.01321860e-01  8.03927339e-01  8.03927339e-01
  8.03927339e-01  3.88056345e+00  3.88056345e+00  3.88056345e+00
  4.21207554e+00  1.30684518e+01  1.42084156e+01  1.42084156e+01
  1.42084156e+01  4.21131620e+01  5.27928548e+01  5.27928548e+01
  5.27928548e+01  1.45767174e+02  2.40580514e+02  2.40580514e+02
  2.40580514e+02  5.08243535e+02  1.87431538e+03  8.00316267e+03
  4.77702149e+04]
E1 = -182.5889768519137  E_coul = 54.04727134483878
cycle= 1 E= -128.541705507075  delta_E= -1.14e-13  |g|= 1.19e-06  |ddm|= 7.94e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5889768519137  E_coul = 54.04727134483878
  HOMO = -0.849008781364997  LUMO = 0.80132203950457
  mo_energy =
[-3.27708467e+01 -1.92934402e+00 -8.49008781e-01 -8.49008781e-01
 -8.49008781e-01  8.01322040e-01  8.03927491e-01  8.03927491e-01
  8.03927491e-01  3.88056400e+00  3.88056400e+00  3.88056400e+00
  4.21207598e+00  1.30684526e+01  1.42084167e+01  1.42084167e+01
  1.42084167e+01  4.21131634e+01  5.27928564e+01  5.27928564e+01
  5.27928564e+01  1.45767175e+02  2.40580516e+02  2.40580516e+02
  2.40580516e+02  5.08243537e+02  1.87431538e+03  8.00316268e+03
  4.77702149e+04]
E1 = -182.58897248856886  E_coul = 54.04726698149352
Extra cycle  E= -128.541705507075  delta_E= -3.98e-13  |g|= 5.93e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.44 sec, wall time      0.45 sec
exp = [8.35991021e-01 2.44137942e+04 3.66145159e+03 8.33319037e+02
 2.35444031e+02 7.61170463e+01 1.02562187e+01 2.69515755e+01
 3.17294317e-01 1.99671368e+00 2.95881409e+00 7.11300642e+00
 2.31704808e+01 9.97863464e+01 2.65560527e-01 2.43706014e+00
 8.31788233e-01]
grad_E = [-1.39197744e-05  5.70079777e-10 -2.89118858e-08  5.32680330e-07
 -5.99877322e-06  5.29405474e-05 -8.55775761e-05 -1.76477426e-04
 -1.39339945e-05  5.65599847e-05 -7.99435659e-05  1.04476627e-04
 -1.10192294e-05  4.11270316e-07 -7.47007641e-05 -2.76862458e-04
  1.24726010e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.828910076962       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158825        1
[INPUT] 0    0    [1    /1   ]  833.319040201        1
[INPUT] 0    0    [1    /1   ]  235.444033269        1
[INPUT] 0    0    [1    /1   ]  76.1173676929        1
[INPUT] 0    0    [1    /1   ]  10.2452783336        1
[INPUT] 0    0    [1    /1   ]  26.9521783084        1
[INPUT] 0    0    [1    /1   ]  0.31628658273        1
[INPUT] 0    0    [1    /1   ]  1.9603301206         1
[INPUT] 0    0    [1    /1   ]  2.95664906872        1
[INPUT] 1    0    [1    /1   ]  7.11166426176        1
[INPUT] 1    0    [1    /1   ]  23.1706872893        1
[INPUT] 1    0    [1    /1   ]  99.7863399975        1
[INPUT] 1    0    [1    /1   ]  0.266127156365       1
[INPUT] 1    0    [1    /1   ]  2.43951478031        1
[INPUT] 1    0    [1    /1   ]  0.833578247895       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8289100769618294, 1.0]], [0, [24413.79418619044, 1.0]], [0, [3661.4515882521864, 1.0]], [0, [833.3190402006401, 1.0]], [0, [235.44403326918507, 1.0]], [0, [76.1173676929388, 1.0]], [0, [10.24527833363943, 1.0]], [0, [26.95217830841427, 1.0]], [0, [0.31628658272953764, 1.0]], [0, [1.9603301206044463, 1.0]], [0, [2.956649068721676, 1.0]], [1, [7.111664261760998, 1.0]], [1, [23.170687289347246, 1.0]], [1, [99.78633999753735, 1.0]], [1, [0.2661271563645154, 1.0]], [1, [2.439514780310253, 1.0]], [1, [0.8335782478951501, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82891008]
bas 1, expnt(s) = [24413.79418619]
bas 2, expnt(s) = [3661.45158825]
bas 3, expnt(s) = [833.3190402]
bas 4, expnt(s) = [235.44403327]
bas 5, expnt(s) = [76.11736769]
bas 6, expnt(s) = [10.24527833]
bas 7, expnt(s) = [26.95217831]
bas 8, expnt(s) = [0.31628658]
bas 9, expnt(s) = [1.96033012]
bas 10, expnt(s) = [2.95664907]
bas 11, expnt(s) = [7.11166426]
bas 12, expnt(s) = [23.17068729]
bas 13, expnt(s) = [99.78634]
bas 14, expnt(s) = [0.26612716]
bas 15, expnt(s) = [2.43951478]
bas 16, expnt(s) = [0.83357825]
CPU time:       121.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.28910077e-01 2.19480322e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319040e+02 3.91853295e+02
 2.35444033e+02 1.51855593e+02 7.61173677e+01 6.51070241e+01
 1.02452783e+01 1.44679782e+01 2.69521783e+01 2.98854932e+01
 3.16286583e-01 1.06555434e+00 1.96033012e+00 4.18564059e+00
 2.95664907e+00 5.69658864e+00 7.11166426e+00 3.38803938e+01
 2.31706873e+01 1.48305766e+02 9.97863400e+01 9.20075062e+02
 2.66127156e-01 5.57629684e-01 2.43951478e+00 8.89433965e+00
 8.33578248e-01 2.32363206e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999636623727298
cond(S) = 3164.5718415347746
E1 = -183.58989660336658  E_coul = 55.080187237251266
init E= -128.509709366115
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775402710009514  LUMO = 0.814886109666098
  mo_energy =
[-3.25551227e+01 -1.85272121e+00 -7.75402710e-01 -7.75402710e-01
 -7.75402710e-01  8.14886110e-01  8.24065744e-01  8.24065744e-01
  8.24065744e-01  3.95466289e+00  3.95466289e+00  3.95466289e+00
  4.21973862e+00  1.30405792e+01  1.43500000e+01  1.43500000e+01
  1.43500000e+01  4.20702169e+01  5.29920277e+01  5.29920277e+01
  5.29920277e+01  1.45754601e+02  2.40821649e+02  2.40821649e+02
  2.40821649e+02  5.08279873e+02  1.87440376e+03  8.00330034e+03
  4.77703991e+04]
E1 = -182.08586921346895  E_coul = 53.54767054419621
cycle= 1 E= -128.538198669273  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518788
diis-c [-0.2691415  1.       ]
  HOMO = -0.884312883991152  LUMO = 0.785567203570241
  mo_energy =
[-3.28783712e+01 -1.96661050e+00 -8.84312884e-01 -8.84312884e-01
 -8.84312884e-01  7.85567204e-01  7.97295716e-01  7.97295716e-01
  7.97295716e-01  3.85724580e+00  3.85724580e+00  3.85724580e+00
  4.14346539e+00  1.28947854e+01  1.41592698e+01  1.41592698e+01
  1.41592698e+01  4.18252695e+01  5.27110210e+01  5.27110210e+01
  5.27110210e+01  1.45438253e+02  2.40475253e+02  2.40475253e+02
  2.40475253e+02  5.07918631e+02  1.87400612e+03  8.00287355e+03
  4.77699534e+04]
E1 = -182.8473240361659  E_coul = 54.30653743021791
cycle= 2 E= -128.540786605948  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0631
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263457
diis-c [-0.00066907  0.33599255  0.66400745]
  HOMO = -0.84867812642205  LUMO = 0.794959951903732
  mo_energy =
[-3.27702541e+01 -1.92908678e+00 -8.48678126e-01 -8.48678126e-01
 -8.48678126e-01  7.94959952e-01  8.06026720e-01  8.06026720e-01
  8.06026720e-01  3.88885318e+00  3.88885318e+00  3.88885318e+00
  4.16812568e+00  1.29426813e+01  1.42224586e+01  1.42224586e+01
  1.42224586e+01  4.19072846e+01  5.28050586e+01  5.28050586e+01
  5.28050586e+01  1.45543787e+02  2.40588942e+02  2.40588942e+02
  2.40588942e+02  5.08035344e+02  1.87412819e+03  8.00299808e+03
  4.77700789e+04]
E1 = -182.58863539174448  E_coul = 54.046928760795154
cycle= 3 E= -128.541706630949  delta_E= -0.00092  |g|= 0.000531  |ddm|= 0.0219
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119143
diis-c [-2.00180220e-07 -2.35382324e-03 -4.37318353e-04  1.00279114e+00]
  HOMO = -0.848943893648173  LUMO = 0.794904449209169
  mo_energy =
[-3.27707363e+01 -1.92928866e+00 -8.48943894e-01 -8.48943894e-01
 -8.48943894e-01  7.94904449e-01  8.05984658e-01  8.05984658e-01
  8.05984658e-01  3.88866765e+00  3.88866765e+00  3.88866765e+00
  4.16798266e+00  1.29424249e+01  1.42221382e+01  1.42221382e+01
  1.42221382e+01  4.19069105e+01  5.28046331e+01  5.28046331e+01
  5.28046331e+01  1.45543304e+02  2.40588387e+02  2.40588387e+02
  2.40588387e+02  5.08034731e+02  1.87412744e+03  8.00299723e+03
  4.77700780e+04]
E1 = -182.58913685872207  E_coul = 54.04743020052463
cycle= 4 E= -128.541706658197  delta_E= -2.72e-08  |g|= 8.02e-05  |ddm|= 0.000426
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186301
diis-c [-1.07521853e-09  2.36737404e-04  4.60764956e-04 -1.84054877e-01
  1.18335737e+00]
  HOMO = -0.848986981863175  LUMO = 0.794891309761591
  mo_energy =
[-3.27708095e+01 -1.92932129e+00 -8.48986982e-01 -8.48986982e-01
 -8.48986982e-01  7.94891310e-01  8.05971260e-01  8.05971260e-01
  8.05971260e-01  3.88862749e+00  3.88862749e+00  3.88862749e+00
  4.16795250e+00  1.29423751e+01  1.42220788e+01  1.42220788e+01
  1.42220788e+01  4.19068455e+01  5.28045639e+01  5.28045639e+01
  5.28045639e+01  1.45543231e+02  2.40588310e+02  2.40588310e+02
  2.40588310e+02  5.08034649e+02  1.87412735e+03  8.00299714e+03
  4.77700779e+04]
E1 = -182.58926977056936  E_coul = 54.047563111662
cycle= 5 E= -128.541706658907  delta_E= -7.1e-10  |g|= 5.84e-06  |ddm|= 7.15e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58926977056936  E_coul = 54.047563111662
  HOMO = -0.848983913074584  LUMO = 0.794892621051436
  mo_energy =
[-3.27708026e+01 -1.92931743e+00 -8.48983913e-01 -8.48983913e-01
 -8.48983913e-01  7.94892621e-01  8.05972162e-01  8.05972162e-01
  8.05972162e-01  3.88863042e+00  3.88863042e+00  3.88863042e+00
  4.16795518e+00  1.29423794e+01  1.42220838e+01  1.42220838e+01
  1.42220838e+01  4.19068516e+01  5.28045704e+01  5.28045704e+01
  5.28045704e+01  1.45543237e+02  2.40588316e+02  2.40588316e+02
  2.40588316e+02  5.08034656e+02  1.87412736e+03  8.00299714e+03
  4.77700779e+04]
E1 = -182.58925412329407  E_coul = 54.0475474643844
Extra cycle  E= -128.54170665891  delta_E= -2.33e-12  |g|= 2.2e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.28910077e-01 2.44137942e+04 3.66145159e+03 8.33319040e+02
 2.35444033e+02 7.61173677e+01 1.02452783e+01 2.69521783e+01
 3.16286583e-01 1.96033012e+00 2.95664907e+00 7.11166426e+00
 2.31706873e+01 9.97863400e+01 2.66127156e-01 2.43951478e+00
 8.33578248e-01]
E = -128.54170665890967
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.828910076962       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158825        1
[INPUT] 0    0    [1    /1   ]  833.319040201        1
[INPUT] 0    0    [1    /1   ]  235.444033269        1
[INPUT] 0    0    [1    /1   ]  76.1173676929        1
[INPUT] 0    0    [1    /1   ]  10.2452783336        1
[INPUT] 0    0    [1    /1   ]  26.9521783084        1
[INPUT] 0    0    [1    /1   ]  0.31628658273        1
[INPUT] 0    0    [1    /1   ]  1.9603301206         1
[INPUT] 0    0    [1    /1   ]  2.95664906872        1
[INPUT] 1    0    [1    /1   ]  7.11166426176        1
[INPUT] 1    0    [1    /1   ]  23.1706872893        1
[INPUT] 1    0    [1    /1   ]  99.7863399975        1
[INPUT] 1    0    [1    /1   ]  0.266127156365       1
[INPUT] 1    0    [1    /1   ]  2.43951478031        1
[INPUT] 1    0    [1    /1   ]  0.833578247895       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8289100769618294, 1.0]], [0, [24413.79418619044, 1.0]], [0, [3661.4515882521864, 1.0]], [0, [833.3190402006401, 1.0]], [0, [235.44403326918507, 1.0]], [0, [76.1173676929388, 1.0]], [0, [10.24527833363943, 1.0]], [0, [26.95217830841427, 1.0]], [0, [0.31628658272953764, 1.0]], [0, [1.9603301206044463, 1.0]], [0, [2.956649068721676, 1.0]], [1, [7.111664261760998, 1.0]], [1, [23.170687289347246, 1.0]], [1, [99.78633999753735, 1.0]], [1, [0.2661271563645154, 1.0]], [1, [2.439514780310253, 1.0]], [1, [0.8335782478951501, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82891008]
bas 1, expnt(s) = [24413.79418619]
bas 2, expnt(s) = [3661.45158825]
bas 3, expnt(s) = [833.3190402]
bas 4, expnt(s) = [235.44403327]
bas 5, expnt(s) = [76.11736769]
bas 6, expnt(s) = [10.24527833]
bas 7, expnt(s) = [26.95217831]
bas 8, expnt(s) = [0.31628658]
bas 9, expnt(s) = [1.96033012]
bas 10, expnt(s) = [2.95664907]
bas 11, expnt(s) = [7.11166426]
bas 12, expnt(s) = [23.17068729]
bas 13, expnt(s) = [99.78634]
bas 14, expnt(s) = [0.26612716]
bas 15, expnt(s) = [2.43951478]
bas 16, expnt(s) = [0.83357825]
CPU time:       122.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.28910077e-01 2.19480322e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319040e+02 3.91853295e+02
 2.35444033e+02 1.51855593e+02 7.61173677e+01 6.51070241e+01
 1.02452783e+01 1.44679782e+01 2.69521783e+01 2.98854932e+01
 3.16286583e-01 1.06555434e+00 1.96033012e+00 4.18564059e+00
 2.95664907e+00 5.69658864e+00 7.11166426e+00 3.38803938e+01
 2.31706873e+01 1.48305766e+02 9.97863400e+01 9.20075062e+02
 2.66127156e-01 5.57629684e-01 2.43951478e+00 8.89433965e+00
 8.33578248e-01 2.32363206e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999636623727298
cond(S) = 3164.5718415347746
E1 = -183.58989660336658  E_coul = 55.080187237251266
init E= -128.509709366115
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402710009514  LUMO = 0.814886109666098
  mo_energy =
[-3.25551227e+01 -1.85272121e+00 -7.75402710e-01 -7.75402710e-01
 -7.75402710e-01  8.14886110e-01  8.24065744e-01  8.24065744e-01
  8.24065744e-01  3.95466289e+00  3.95466289e+00  3.95466289e+00
  4.21973862e+00  1.30405792e+01  1.43500000e+01  1.43500000e+01
  1.43500000e+01  4.20702169e+01  5.29920277e+01  5.29920277e+01
  5.29920277e+01  1.45754601e+02  2.40821649e+02  2.40821649e+02
  2.40821649e+02  5.08279873e+02  1.87440376e+03  8.00330034e+03
  4.77703991e+04]
E1 = -182.08586921346895  E_coul = 53.54767054419621
cycle= 1 E= -128.538198669273  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518788
diis-c [-0.2691415  1.       ]
  HOMO = -0.884312883991152  LUMO = 0.785567203570241
  mo_energy =
[-3.28783712e+01 -1.96661050e+00 -8.84312884e-01 -8.84312884e-01
 -8.84312884e-01  7.85567204e-01  7.97295716e-01  7.97295716e-01
  7.97295716e-01  3.85724580e+00  3.85724580e+00  3.85724580e+00
  4.14346539e+00  1.28947854e+01  1.41592698e+01  1.41592698e+01
  1.41592698e+01  4.18252695e+01  5.27110210e+01  5.27110210e+01
  5.27110210e+01  1.45438253e+02  2.40475253e+02  2.40475253e+02
  2.40475253e+02  5.07918631e+02  1.87400612e+03  8.00287355e+03
  4.77699534e+04]
E1 = -182.8473240361659  E_coul = 54.30653743021791
cycle= 2 E= -128.540786605948  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0631
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263457
diis-c [-0.00066907  0.33599255  0.66400745]
  HOMO = -0.84867812642205  LUMO = 0.794959951903732
  mo_energy =
[-3.27702541e+01 -1.92908678e+00 -8.48678126e-01 -8.48678126e-01
 -8.48678126e-01  7.94959952e-01  8.06026720e-01  8.06026720e-01
  8.06026720e-01  3.88885318e+00  3.88885318e+00  3.88885318e+00
  4.16812568e+00  1.29426813e+01  1.42224586e+01  1.42224586e+01
  1.42224586e+01  4.19072846e+01  5.28050586e+01  5.28050586e+01
  5.28050586e+01  1.45543787e+02  2.40588942e+02  2.40588942e+02
  2.40588942e+02  5.08035344e+02  1.87412819e+03  8.00299808e+03
  4.77700789e+04]
E1 = -182.58863539174448  E_coul = 54.046928760795154
cycle= 3 E= -128.541706630949  delta_E= -0.00092  |g|= 0.000531  |ddm|= 0.0219
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119143
diis-c [-2.00180220e-07 -2.35382324e-03 -4.37318353e-04  1.00279114e+00]
  HOMO = -0.848943893648173  LUMO = 0.794904449209169
  mo_energy =
[-3.27707363e+01 -1.92928866e+00 -8.48943894e-01 -8.48943894e-01
 -8.48943894e-01  7.94904449e-01  8.05984658e-01  8.05984658e-01
  8.05984658e-01  3.88866765e+00  3.88866765e+00  3.88866765e+00
  4.16798266e+00  1.29424249e+01  1.42221382e+01  1.42221382e+01
  1.42221382e+01  4.19069105e+01  5.28046331e+01  5.28046331e+01
  5.28046331e+01  1.45543304e+02  2.40588387e+02  2.40588387e+02
  2.40588387e+02  5.08034731e+02  1.87412744e+03  8.00299723e+03
  4.77700780e+04]
E1 = -182.58913685872207  E_coul = 54.04743020052463
cycle= 4 E= -128.541706658197  delta_E= -2.72e-08  |g|= 8.02e-05  |ddm|= 0.000426
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186301
diis-c [-1.07521853e-09  2.36737404e-04  4.60764956e-04 -1.84054877e-01
  1.18335737e+00]
  HOMO = -0.848986981863175  LUMO = 0.794891309761591
  mo_energy =
[-3.27708095e+01 -1.92932129e+00 -8.48986982e-01 -8.48986982e-01
 -8.48986982e-01  7.94891310e-01  8.05971260e-01  8.05971260e-01
  8.05971260e-01  3.88862749e+00  3.88862749e+00  3.88862749e+00
  4.16795250e+00  1.29423751e+01  1.42220788e+01  1.42220788e+01
  1.42220788e+01  4.19068455e+01  5.28045639e+01  5.28045639e+01
  5.28045639e+01  1.45543231e+02  2.40588310e+02  2.40588310e+02
  2.40588310e+02  5.08034649e+02  1.87412735e+03  8.00299714e+03
  4.77700779e+04]
E1 = -182.58926977056936  E_coul = 54.047563111662
cycle= 5 E= -128.541706658907  delta_E= -7.1e-10  |g|= 5.84e-06  |ddm|= 7.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58926977056936  E_coul = 54.047563111662
  HOMO = -0.848983913074584  LUMO = 0.794892621051436
  mo_energy =
[-3.27708026e+01 -1.92931743e+00 -8.48983913e-01 -8.48983913e-01
 -8.48983913e-01  7.94892621e-01  8.05972162e-01  8.05972162e-01
  8.05972162e-01  3.88863042e+00  3.88863042e+00  3.88863042e+00
  4.16795518e+00  1.29423794e+01  1.42220838e+01  1.42220838e+01
  1.42220838e+01  4.19068516e+01  5.28045704e+01  5.28045704e+01
  5.28045704e+01  1.45543237e+02  2.40588316e+02  2.40588316e+02
  2.40588316e+02  5.08034656e+02  1.87412736e+03  8.00299714e+03
  4.77700779e+04]
E1 = -182.58925412329407  E_coul = 54.0475474643844
Extra cycle  E= -128.54170665891  delta_E= -2.33e-12  |g|= 2.2e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 3164.5718415347746
E1 = -182.58925412329407  E_coul = 54.0475474643844
init E= -128.54170665891
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.848985020126555  LUMO = 0.794892410670908
  mo_energy =
[-3.27708061e+01 -1.92931846e+00 -8.48985020e-01 -8.48985020e-01
 -8.48985020e-01  7.94892411e-01  8.05971908e-01  8.05971908e-01
  8.05971908e-01  3.88862947e+00  3.88862947e+00  3.88862947e+00
  4.16795451e+00  1.29423780e+01  1.42220818e+01  1.42220818e+01
  1.42220818e+01  4.19068490e+01  5.28045674e+01  5.28045674e+01
  5.28045674e+01  1.45543234e+02  2.40588313e+02  2.40588313e+02
  2.40588313e+02  5.08034652e+02  1.87412736e+03  8.00299714e+03
  4.77700779e+04]
E1 = -182.58926281582401  E_coul = 54.04755615691402
cycle= 1 E= -128.54170665891  delta_E= -3.13e-13  |g|= 1.19e-06  |ddm|= 7.95e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.58926281582401  E_coul = 54.04755615691402
  HOMO = -0.848984408193801  LUMO = 0.794892588303996
  mo_energy =
[-3.27708042e+01 -1.92931778e+00 -8.48984408e-01 -8.48984408e-01
 -8.48984408e-01  7.94892588e-01  8.05972062e-01  8.05972062e-01
  8.05972062e-01  3.88863001e+00  3.88863001e+00  3.88863001e+00
  4.16795495e+00  1.29423788e+01  1.42220829e+01  1.42220829e+01
  1.42220829e+01  4.19068504e+01  5.28045690e+01  5.28045690e+01
  5.28045690e+01  1.45543236e+02  2.40588314e+02  2.40588314e+02
  2.40588314e+02  5.08034654e+02  1.87412736e+03  8.00299714e+03
  4.77700779e+04]
E1 = -182.58925844787245  E_coul = 54.047551788962025
Extra cycle  E= -128.54170665891  delta_E= -4.26e-13  |g|= 5.93e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [8.28910077e-01 2.44137942e+04 3.66145159e+03 8.33319040e+02
 2.35444033e+02 7.61173677e+01 1.02452783e+01 2.69521783e+01
 3.16286583e-01 1.96033012e+00 2.95664907e+00 7.11166426e+00
 2.31706873e+01 9.97863400e+01 2.66127156e-01 2.43951478e+00
 8.33578248e-01]
grad_E = [-5.08702663e-05  5.26105774e-10 -2.66086092e-08  4.86254302e-07
 -5.44978257e-06  4.88191689e-05 -1.05995169e-04 -1.60659000e-04
  1.07803158e-04  5.97436013e-05 -8.38796229e-05  4.63250713e-05
 -2.85083988e-06  9.48813533e-08 -1.68535567e-06 -2.07949991e-04
  2.77485839e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.813140627421       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158782        1
[INPUT] 0    0    [1    /1   ]  833.319043267        1
[INPUT] 0    0    [1    /1   ]  235.444054316        1
[INPUT] 0    0    [1    /1   ]  76.1176192481        1
[INPUT] 0    0    [1    /1   ]  10.2355760034        1
[INPUT] 0    0    [1    /1   ]  26.9532391819        1
[INPUT] 0    0    [1    /1   ]  0.312902947038       1
[INPUT] 0    0    [1    /1   ]  1.89915269382        1
[INPUT] 0    0    [1    /1   ]  2.95387843794        1
[INPUT] 1    0    [1    /1   ]  7.11077291227        1
[INPUT] 1    0    [1    /1   ]  23.1707763145        1
[INPUT] 1    0    [1    /1   ]  99.7863395821        1
[INPUT] 1    0    [1    /1   ]  0.266684750414       1
[INPUT] 1    0    [1    /1   ]  2.44211457764        1
[INPUT] 1    0    [1    /1   ]  0.835321486017       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8131406274211473, 1.0]], [0, [24413.794186200546, 1.0]], [0, [3661.4515878214934, 1.0]], [0, [833.3190432668032, 1.0]], [0, [235.44405431627783, 1.0]], [0, [76.11761924813142, 1.0]], [0, [10.235576003355208, 1.0]], [0, [26.953239181869126, 1.0]], [0, [0.3129029470376239, 1.0]], [0, [1.8991526938237435, 1.0]], [0, [2.9538784379442897, 1.0]], [1, [7.11077291226801, 1.0]], [1, [23.170776314491125, 1.0]], [1, [99.78633958211083, 1.0]], [1, [0.2666847504135233, 1.0]], [1, [2.4421145776370476, 1.0]], [1, [0.8353214860165217, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81314063]
bas 1, expnt(s) = [24413.7941862]
bas 2, expnt(s) = [3661.45158782]
bas 3, expnt(s) = [833.31904327]
bas 4, expnt(s) = [235.44405432]
bas 5, expnt(s) = [76.11761925]
bas 6, expnt(s) = [10.235576]
bas 7, expnt(s) = [26.95323918]
bas 8, expnt(s) = [0.31290295]
bas 9, expnt(s) = [1.89915269]
bas 10, expnt(s) = [2.95387844]
bas 11, expnt(s) = [7.11077291]
bas 12, expnt(s) = [23.17077631]
bas 13, expnt(s) = [99.78633958]
bas 14, expnt(s) = [0.26668475]
bas 15, expnt(s) = [2.44211458]
bas 16, expnt(s) = [0.83532149]
CPU time:       125.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.13140627e-01 2.16341218e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319043e+02 3.91853296e+02
 2.35444054e+02 1.51855603e+02 7.61176192e+01 6.51071855e+01
 1.02355760e+01 1.44577010e+01 2.69532392e+01 2.98863755e+01
 3.12902947e-01 1.05699337e+00 1.89915269e+00 4.08728515e+00
 2.95387844e+00 5.69258453e+00 7.11077291e+00 3.38750858e+01
 2.31707763e+01 1.48306479e+02 9.97863396e+01 9.20075057e+02
 2.66684750e-01 5.59090510e-01 2.44211458e+00 8.90618962e+00
 8.35321486e-01 2.32970782e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999633228687738
cond(S) = 2771.440881537797
E1 = -183.5899062218122  E_coul = 55.08018801564295
init E= -128.509718206169
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401901336337  LUMO = 0.79879707167617
  mo_energy =
[-3.25551223e+01 -1.85272325e+00 -7.75401901e-01 -7.75401901e-01
 -7.75401901e-01  7.98797072e-01  8.26119809e-01  8.26119809e-01
  8.26119809e-01  3.96269668e+00  3.96269668e+00  3.96269668e+00
  4.12886859e+00  1.28066898e+01  1.43641922e+01  1.43641922e+01
  1.43641922e+01  4.17164277e+01  5.30051980e+01  5.30051980e+01
  5.30051980e+01  1.45389940e+02  2.40830677e+02  2.40830677e+02
  2.40830677e+02  5.07945129e+02  1.87410340e+03  8.00303609e+03
  4.77701803e+04]
E1 = -182.08631320029463  E_coul = 53.548110758931166
cycle= 1 E= -128.538202441363  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518718
diis-c [-0.26906828  1.        ]
  HOMO = -0.884277748604685  LUMO = 0.770116569192722
  mo_energy =
[-3.28782951e+01 -1.96657215e+00 -8.84277749e-01 -8.84277749e-01
 -8.84277749e-01  7.70116569e-01  7.99280076e-01  7.99280076e-01
  7.99280076e-01  3.86520866e+00  3.86520866e+00  3.86520866e+00
  4.05386473e+00  1.26618723e+01  1.41735189e+01  1.41735189e+01
  1.41735189e+01  4.14715793e+01  5.27242762e+01  5.27242762e+01
  5.27242762e+01  1.45073607e+02  2.40484359e+02  2.40484359e+02
  2.40484359e+02  5.07583945e+02  1.87370584e+03  8.00260938e+03
  4.77697347e+04]
E1 = -182.84747293109157  E_coul = 54.30668381000677
cycle= 2 E= -128.540789121085  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0629
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263389
diis-c [-0.00066717  0.33596693  0.66403307]
  HOMO = -0.848656075397116  LUMO = 0.779304554372808
  mo_energy =
[-3.27702126e+01 -1.92906282e+00 -8.48656075e-01 -8.48656075e-01
 -8.48656075e-01  7.79304554e-01  8.08033709e-01  8.08033709e-01
  8.08033709e-01  3.89683845e+00  3.89683845e+00  3.89683845e+00
  4.07810824e+00  1.27094379e+01  1.42366853e+01  1.42366853e+01
  1.42366853e+01  4.15535580e+01  5.28182781e+01  5.28182781e+01
  5.28182781e+01  1.45179129e+02  2.40598013e+02  2.40598013e+02
  2.40598013e+02  5.07700628e+02  1.87382787e+03  8.00273388e+03
  4.77698602e+04]
E1 = -182.5889016992864  E_coul = 54.047193272943574
cycle= 3 E= -128.541708426343  delta_E= -0.000919  |g|= 0.000531  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119274
diis-c [-2.02577605e-07 -2.35771275e-03 -4.43255463e-04  1.00280097e+00]
  HOMO = -0.848921945765629  LUMO = 0.779250182089206
  mo_energy =
[-3.27706949e+01 -1.92926454e+00 -8.48921946e-01 -8.48921946e-01
 -8.48921946e-01  7.79250182e-01  8.07991428e-01  8.07991428e-01
  8.07991428e-01  3.89665272e+00  3.89665272e+00  3.89665272e+00
  4.07796747e+00  1.27091830e+01  1.42363648e+01  1.42363648e+01
  1.42363648e+01  4.15531840e+01  5.28178526e+01  5.28178526e+01
  5.28178526e+01  1.45178645e+02  2.40597457e+02  2.40597457e+02
  2.40597457e+02  5.07700015e+02  1.87382712e+03  8.00273303e+03
  4.77698593e+04]
E1 = -182.58940369831487  E_coul = 54.04769524456719
cycle= 4 E= -128.541708453748  delta_E= -2.74e-08  |g|= 8.03e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186432
diis-c [-1.07999061e-09  2.38608364e-04  4.60613579e-04 -1.84900079e-01
  1.18420086e+00]
  HOMO = -0.848965061062688  LUMO = 0.779237305014073
  mo_energy =
[-3.27707681e+01 -1.92929709e+00 -8.48965061e-01 -8.48965061e-01
 -8.48965061e-01  7.79237305e-01  8.07977978e-01  8.07977978e-01
  8.07977978e-01  3.89661253e+00  3.89661253e+00  3.89661253e+00
  4.07793775e+00  1.27091334e+01  1.42363054e+01  1.42363054e+01
  1.42363054e+01  4.15531191e+01  5.28177834e+01  5.28177834e+01
  5.28177834e+01  1.45178572e+02  2.40597380e+02  2.40597380e+02
  2.40597380e+02  5.07699934e+02  1.87382703e+03  8.00273293e+03
  4.77698592e+04]
E1 = -182.589536391818  E_coul = 54.04782793735391
cycle= 5 E= -128.541708454464  delta_E= -7.16e-10  |g|= 5.87e-06  |ddm|= 7.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.589536391818  E_coul = 54.04782793735391
  HOMO = -0.84896197235464  LUMO = 0.779238600427615
  mo_energy =
[-3.27707611e+01 -1.92929321e+00 -8.48961972e-01 -8.48961972e-01
 -8.48961972e-01  7.79238600e-01  8.07978888e-01  8.07978888e-01
  8.07978888e-01  3.89661549e+00  3.89661549e+00  3.89661549e+00
  4.07794041e+00  1.27091378e+01  1.42363104e+01  1.42363104e+01
  1.42363104e+01  4.15531252e+01  5.28177900e+01  5.28177900e+01
  5.28177900e+01  1.45178579e+02  2.40597387e+02  2.40597387e+02
  2.40597387e+02  5.07699940e+02  1.87382704e+03  8.00273294e+03
  4.77698592e+04]
E1 = -182.5895206576744  E_coul = 54.04781220320759
Extra cycle  E= -128.541708454467  delta_E= -2.7e-12  |g|= 2.21e-06  |ddm|= 2.08e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.15 sec
exp = [8.13140627e-01 2.44137942e+04 3.66145159e+03 8.33319043e+02
 2.35444054e+02 7.61176192e+01 1.02355760e+01 2.69532392e+01
 3.12902947e-01 1.89915269e+00 2.95387844e+00 7.11077291e+00
 2.31707763e+01 9.97863396e+01 2.66684750e-01 2.44211458e+00
 8.35321486e-01]
E = -128.5417084544668
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.813140627421       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158782        1
[INPUT] 0    0    [1    /1   ]  833.319043267        1
[INPUT] 0    0    [1    /1   ]  235.444054316        1
[INPUT] 0    0    [1    /1   ]  76.1176192481        1
[INPUT] 0    0    [1    /1   ]  10.2355760034        1
[INPUT] 0    0    [1    /1   ]  26.9532391819        1
[INPUT] 0    0    [1    /1   ]  0.312902947038       1
[INPUT] 0    0    [1    /1   ]  1.89915269382        1
[INPUT] 0    0    [1    /1   ]  2.95387843794        1
[INPUT] 1    0    [1    /1   ]  7.11077291227        1
[INPUT] 1    0    [1    /1   ]  23.1707763145        1
[INPUT] 1    0    [1    /1   ]  99.7863395821        1
[INPUT] 1    0    [1    /1   ]  0.266684750414       1
[INPUT] 1    0    [1    /1   ]  2.44211457764        1
[INPUT] 1    0    [1    /1   ]  0.835321486017       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8131406274211473, 1.0]], [0, [24413.794186200546, 1.0]], [0, [3661.4515878214934, 1.0]], [0, [833.3190432668032, 1.0]], [0, [235.44405431627783, 1.0]], [0, [76.11761924813142, 1.0]], [0, [10.235576003355208, 1.0]], [0, [26.953239181869126, 1.0]], [0, [0.3129029470376239, 1.0]], [0, [1.8991526938237435, 1.0]], [0, [2.9538784379442897, 1.0]], [1, [7.11077291226801, 1.0]], [1, [23.170776314491125, 1.0]], [1, [99.78633958211083, 1.0]], [1, [0.2666847504135233, 1.0]], [1, [2.4421145776370476, 1.0]], [1, [0.8353214860165217, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81314063]
bas 1, expnt(s) = [24413.7941862]
bas 2, expnt(s) = [3661.45158782]
bas 3, expnt(s) = [833.31904327]
bas 4, expnt(s) = [235.44405432]
bas 5, expnt(s) = [76.11761925]
bas 6, expnt(s) = [10.235576]
bas 7, expnt(s) = [26.95323918]
bas 8, expnt(s) = [0.31290295]
bas 9, expnt(s) = [1.89915269]
bas 10, expnt(s) = [2.95387844]
bas 11, expnt(s) = [7.11077291]
bas 12, expnt(s) = [23.17077631]
bas 13, expnt(s) = [99.78633958]
bas 14, expnt(s) = [0.26668475]
bas 15, expnt(s) = [2.44211458]
bas 16, expnt(s) = [0.83532149]
CPU time:       126.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.13140627e-01 2.16341218e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319043e+02 3.91853296e+02
 2.35444054e+02 1.51855603e+02 7.61176192e+01 6.51071855e+01
 1.02355760e+01 1.44577010e+01 2.69532392e+01 2.98863755e+01
 3.12902947e-01 1.05699337e+00 1.89915269e+00 4.08728515e+00
 2.95387844e+00 5.69258453e+00 7.11077291e+00 3.38750858e+01
 2.31707763e+01 1.48306479e+02 9.97863396e+01 9.20075057e+02
 2.66684750e-01 5.59090510e-01 2.44211458e+00 8.90618962e+00
 8.35321486e-01 2.32970782e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999633228687738
cond(S) = 2771.440881537797
E1 = -183.5899062218122  E_coul = 55.08018801564295
init E= -128.509718206169
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401901336337  LUMO = 0.79879707167617
  mo_energy =
[-3.25551223e+01 -1.85272325e+00 -7.75401901e-01 -7.75401901e-01
 -7.75401901e-01  7.98797072e-01  8.26119809e-01  8.26119809e-01
  8.26119809e-01  3.96269668e+00  3.96269668e+00  3.96269668e+00
  4.12886859e+00  1.28066898e+01  1.43641922e+01  1.43641922e+01
  1.43641922e+01  4.17164277e+01  5.30051980e+01  5.30051980e+01
  5.30051980e+01  1.45389940e+02  2.40830677e+02  2.40830677e+02
  2.40830677e+02  5.07945129e+02  1.87410340e+03  8.00303609e+03
  4.77701803e+04]
E1 = -182.08631320029463  E_coul = 53.548110758931166
cycle= 1 E= -128.538202441363  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518718
diis-c [-0.26906828  1.        ]
  HOMO = -0.884277748604685  LUMO = 0.770116569192722
  mo_energy =
[-3.28782951e+01 -1.96657215e+00 -8.84277749e-01 -8.84277749e-01
 -8.84277749e-01  7.70116569e-01  7.99280076e-01  7.99280076e-01
  7.99280076e-01  3.86520866e+00  3.86520866e+00  3.86520866e+00
  4.05386473e+00  1.26618723e+01  1.41735189e+01  1.41735189e+01
  1.41735189e+01  4.14715793e+01  5.27242762e+01  5.27242762e+01
  5.27242762e+01  1.45073607e+02  2.40484359e+02  2.40484359e+02
  2.40484359e+02  5.07583945e+02  1.87370584e+03  8.00260938e+03
  4.77697347e+04]
E1 = -182.84747293109157  E_coul = 54.30668381000677
cycle= 2 E= -128.540789121085  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0629
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263389
diis-c [-0.00066717  0.33596693  0.66403307]
  HOMO = -0.848656075397116  LUMO = 0.779304554372808
  mo_energy =
[-3.27702126e+01 -1.92906282e+00 -8.48656075e-01 -8.48656075e-01
 -8.48656075e-01  7.79304554e-01  8.08033709e-01  8.08033709e-01
  8.08033709e-01  3.89683845e+00  3.89683845e+00  3.89683845e+00
  4.07810824e+00  1.27094379e+01  1.42366853e+01  1.42366853e+01
  1.42366853e+01  4.15535580e+01  5.28182781e+01  5.28182781e+01
  5.28182781e+01  1.45179129e+02  2.40598013e+02  2.40598013e+02
  2.40598013e+02  5.07700628e+02  1.87382787e+03  8.00273388e+03
  4.77698602e+04]
E1 = -182.5889016992864  E_coul = 54.047193272943574
cycle= 3 E= -128.541708426343  delta_E= -0.000919  |g|= 0.000531  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119274
diis-c [-2.02577605e-07 -2.35771275e-03 -4.43255463e-04  1.00280097e+00]
  HOMO = -0.848921945765629  LUMO = 0.779250182089206
  mo_energy =
[-3.27706949e+01 -1.92926454e+00 -8.48921946e-01 -8.48921946e-01
 -8.48921946e-01  7.79250182e-01  8.07991428e-01  8.07991428e-01
  8.07991428e-01  3.89665272e+00  3.89665272e+00  3.89665272e+00
  4.07796747e+00  1.27091830e+01  1.42363648e+01  1.42363648e+01
  1.42363648e+01  4.15531840e+01  5.28178526e+01  5.28178526e+01
  5.28178526e+01  1.45178645e+02  2.40597457e+02  2.40597457e+02
  2.40597457e+02  5.07700015e+02  1.87382712e+03  8.00273303e+03
  4.77698593e+04]
E1 = -182.58940369831487  E_coul = 54.04769524456719
cycle= 4 E= -128.541708453748  delta_E= -2.74e-08  |g|= 8.03e-05  |ddm|= 0.000417
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186432
diis-c [-1.07999061e-09  2.38608364e-04  4.60613579e-04 -1.84900079e-01
  1.18420086e+00]
  HOMO = -0.848965061062688  LUMO = 0.779237305014073
  mo_energy =
[-3.27707681e+01 -1.92929709e+00 -8.48965061e-01 -8.48965061e-01
 -8.48965061e-01  7.79237305e-01  8.07977978e-01  8.07977978e-01
  8.07977978e-01  3.89661253e+00  3.89661253e+00  3.89661253e+00
  4.07793775e+00  1.27091334e+01  1.42363054e+01  1.42363054e+01
  1.42363054e+01  4.15531191e+01  5.28177834e+01  5.28177834e+01
  5.28177834e+01  1.45178572e+02  2.40597380e+02  2.40597380e+02
  2.40597380e+02  5.07699934e+02  1.87382703e+03  8.00273293e+03
  4.77698592e+04]
E1 = -182.589536391818  E_coul = 54.04782793735391
cycle= 5 E= -128.541708454464  delta_E= -7.16e-10  |g|= 5.87e-06  |ddm|= 7.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.589536391818  E_coul = 54.04782793735391
  HOMO = -0.84896197235464  LUMO = 0.779238600427615
  mo_energy =
[-3.27707611e+01 -1.92929321e+00 -8.48961972e-01 -8.48961972e-01
 -8.48961972e-01  7.79238600e-01  8.07978888e-01  8.07978888e-01
  8.07978888e-01  3.89661549e+00  3.89661549e+00  3.89661549e+00
  4.07794041e+00  1.27091378e+01  1.42363104e+01  1.42363104e+01
  1.42363104e+01  4.15531252e+01  5.28177900e+01  5.28177900e+01
  5.28177900e+01  1.45178579e+02  2.40597387e+02  2.40597387e+02
  2.40597387e+02  5.07699940e+02  1.87382704e+03  8.00273294e+03
  4.77698592e+04]
E1 = -182.5895206576744  E_coul = 54.04781220320759
Extra cycle  E= -128.541708454467  delta_E= -2.7e-12  |g|= 2.21e-06  |ddm|= 2.08e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2771.440881537797
E1 = -182.5895206576744  E_coul = 54.04781220320759
init E= -128.541708454467
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.848963085413532  LUMO = 0.779238394054986
  mo_energy =
[-3.27707646e+01 -1.92929425e+00 -8.48963085e-01 -8.48963085e-01
 -8.48963085e-01  7.79238394e-01  8.07978633e-01  8.07978633e-01
  8.07978633e-01  3.89661452e+00  3.89661452e+00  3.89661452e+00
  4.07793974e+00  1.27091363e+01  1.42363085e+01  1.42363085e+01
  1.42363085e+01  4.15531226e+01  5.28177870e+01  5.28177870e+01
  5.28177870e+01  1.45178575e+02  2.40597383e+02  2.40597383e+02
  2.40597383e+02  5.07699936e+02  1.87382703e+03  8.00273293e+03
  4.77698592e+04]
E1 = -182.58952939788534  E_coul = 54.04782094341826
cycle= 1 E= -128.541708454467  delta_E= -2.84e-13  |g|= 1.2e-06  |ddm|= 7.99e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58952939788534  E_coul = 54.04782094341826
  HOMO = -0.848962470122346  LUMO = 0.779238568922044
  mo_energy =
[-3.27707628e+01 -1.92929357e+00 -8.48962470e-01 -8.48962470e-01
 -8.48962470e-01  7.79238569e-01  8.07978788e-01  8.07978788e-01
  8.07978788e-01  3.89661508e+00  3.89661508e+00  3.89661508e+00
  4.07794018e+00  1.27091372e+01  1.42363096e+01  1.42363096e+01
  1.42363096e+01  4.15531240e+01  5.28177886e+01  5.28177886e+01
  5.28177886e+01  1.45178577e+02  2.40597385e+02  2.40597385e+02
  2.40597385e+02  5.07699938e+02  1.87382704e+03  8.00273293e+03
  4.77698592e+04]
E1 = -182.58952500633518  E_coul = 54.04781655186833
Extra cycle  E= -128.541708454467  delta_E= 2.27e-13  |g|= 5.96e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [8.13140627e-01 2.44137942e+04 3.66145159e+03 8.33319043e+02
 2.35444054e+02 7.61176192e+01 1.02355760e+01 2.69532392e+01
 3.12902947e-01 1.89915269e+00 2.95387844e+00 7.11077291e+00
 2.31707763e+01 9.97863396e+01 2.66684750e-01 2.44211458e+00
 8.35321486e-01]
grad_E = [-8.51793711e-05  4.96662416e-10 -2.50679062e-08  4.55341354e-07
 -5.09106301e-06  4.62900666e-05 -1.08114424e-04 -1.52896360e-04
  1.64651791e-04  6.13280391e-05 -9.65170663e-05 -1.32595467e-05
  5.00147600e-06 -2.00435847e-07  1.70342741e-04 -1.14426671e-04
  3.49729903e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.780077115096       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158735        1
[INPUT] 0    0    [1    /1   ]  833.319042377        1
[INPUT] 0    0    [1    /1   ]  235.444176825        1
[INPUT] 0    0    [1    /1   ]  76.1173671977        1
[INPUT] 0    0    [1    /1   ]  10.2239877178        1
[INPUT] 0    0    [1    /1   ]  26.9572901194        1
[INPUT] 0    0    [1    /1   ]  0.306585273232       1
[INPUT] 0    0    [1    /1   ]  1.76017797062        1
[INPUT] 0    0    [1    /1   ]  2.95191204353        1
[INPUT] 1    0    [1    /1   ]  7.11023295147        1
[INPUT] 1    0    [1    /1   ]  23.1706873528        1
[INPUT] 1    0    [1    /1   ]  99.786350079         1
[INPUT] 1    0    [1    /1   ]  0.267435182331       1
[INPUT] 1    0    [1    /1   ]  2.44638066001        1
[INPUT] 1    0    [1    /1   ]  0.837875824178       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7800771150956428, 1.0]], [0, [24413.794186213112, 1.0]], [0, [3661.4515873452447, 1.0]], [0, [833.3190423767992, 1.0]], [0, [235.4441768248565, 1.0]], [0, [76.11736719766417, 1.0]], [0, [10.223987717847125, 1.0]], [0, [26.957290119372768, 1.0]], [0, [0.3065852732315748, 1.0]], [0, [1.760177970618901, 1.0]], [0, [2.951912043533486, 1.0]], [1, [7.1102329514729075, 1.0]], [1, [23.170687352824388, 1.0]], [1, [99.78635007899734, 1.0]], [1, [0.2674351823305807, 1.0]], [1, [2.4463806600131877, 1.0]], [1, [0.8378758241782251, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78007712]
bas 1, expnt(s) = [24413.79418621]
bas 2, expnt(s) = [3661.45158735]
bas 3, expnt(s) = [833.31904238]
bas 4, expnt(s) = [235.44417682]
bas 5, expnt(s) = [76.1173672]
bas 6, expnt(s) = [10.22398772]
bas 7, expnt(s) = [26.95729012]
bas 8, expnt(s) = [0.30658527]
bas 9, expnt(s) = [1.76017797]
bas 10, expnt(s) = [2.95191204]
bas 11, expnt(s) = [7.11023295]
bas 12, expnt(s) = [23.17068735]
bas 13, expnt(s) = [99.78635008]
bas 14, expnt(s) = [0.26743518]
bas 15, expnt(s) = [2.44638066]
bas 16, expnt(s) = [0.83787582]
CPU time:       129.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.80077115e-01 2.09709535e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319042e+02 3.91853296e+02
 2.35444177e+02 1.51855662e+02 7.61173672e+01 6.51070238e+01
 1.02239877e+01 1.44454230e+01 2.69572901e+01 2.98897442e+01
 3.06585273e-01 1.04094670e+00 1.76017797e+00 3.86084583e+00
 2.95191204e+00 5.68974213e+00 7.11023295e+00 3.38718705e+01
 2.31706874e+01 1.48305767e+02 9.97863501e+01 9.20075178e+02
 2.67435182e-01 5.61057753e-01 2.44638066e+00 8.92564143e+00
 8.37875824e-01 2.33861627e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999628033028415
cond(S) = 2131.0959413356436
E1 = -183.58991712608085  E_coul = 55.08020044639281
init E= -128.509716679688
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775399896756071  LUMO = 0.766265238146621
  mo_energy =
[-3.25551165e+01 -1.85272855e+00 -7.75399897e-01 -7.75399897e-01
 -7.75399897e-01  7.66265238e-01  8.28950047e-01  8.28950047e-01
  8.28950047e-01  3.93198021e+00  3.97446407e+00  3.97446407e+00
  3.97446407e+00  1.22917365e+01  1.43866212e+01  1.43866212e+01
  1.43866212e+01  4.09601387e+01  5.30278682e+01  5.30278682e+01
  5.30278682e+01  1.44635327e+02  2.40846635e+02  2.40846635e+02
  2.40846635e+02  5.07260597e+02  1.87349067e+03  8.00249734e+03
  4.77697344e+04]
E1 = -182.08688918992698  E_coul = 53.54868077935115
cycle= 1 E= -128.538208410576  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518616
diis-c [-0.26896235  1.        ]
  HOMO = -0.884234392099203  LUMO = 0.738903039920506
  mo_energy =
[-3.28781845e+01 -1.96652879e+00 -8.84234392e-01 -8.84234392e-01
 -8.84234392e-01  7.38903040e-01  8.02008305e-01  8.02008305e-01
  8.02008305e-01  3.85983946e+00  3.87685564e+00  3.87685564e+00
  3.87685564e+00  1.21490559e+01  1.41960080e+01  1.41960080e+01
  1.41960080e+01  4.07153814e+01  5.27470608e+01  5.27470608e+01
  5.27470608e+01  1.44318958e+02  2.40500435e+02  2.40500435e+02
  2.40500435e+02  5.06899484e+02  1.87309322e+03  8.00207076e+03
  4.77692890e+04]
E1 = -182.8476611071013  E_coul = 54.30686766165488
cycle= 2 E= -128.540793445446  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2633
diis-c [-6.63455940e-04  3.35939279e-01  6.64060721e-01]
  HOMO = -0.848630404624478  LUMO = 0.747666721019937
  mo_energy =
[-3.27701477e+01 -1.92903891e+00 -8.48630405e-01 -8.48630405e-01
 -8.48630405e-01  7.47666721e-01  8.10793852e-01  8.10793852e-01
  8.10793852e-01  3.88314241e+00  3.90852297e+00  3.90852297e+00
  3.90852297e+00  1.21958981e+01  1.42591488e+01  1.42591488e+01
  1.42591488e+01  4.07973269e+01  5.28410147e+01  5.28410147e+01
  5.28410147e+01  1.44424485e+02  2.40614040e+02  2.40614040e+02
  2.40614040e+02  5.07016133e+02  1.87321521e+03  8.00219520e+03
  4.77694143e+04]
E1 = -182.58923509351996  E_coul = 54.04752324463986
cycle= 3 E= -128.54171184888  delta_E= -0.000918  |g|= 0.000533  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119465
diis-c [-2.06570238e-07 -2.36594088e-03 -4.57760116e-04  1.00282370e+00]
  HOMO = -0.84889690570325  LUMO = 0.747614312670097
  mo_energy =
[-3.27706304e+01 -1.92924093e+00 -8.48896906e-01 -8.48896906e-01
 -8.48896906e-01  7.47614313e-01  8.10750976e-01  8.10750976e-01
  8.10750976e-01  3.88300625e+00  3.90833649e+00  3.90833649e+00
  3.90833649e+00  1.21956460e+01  1.42588276e+01  1.42588276e+01
  1.42588276e+01  4.07969525e+01  5.28405886e+01  5.28405886e+01
  5.28405886e+01  1.44424002e+02  2.40613485e+02  2.40613485e+02
  2.40613485e+02  5.07015521e+02  1.87321446e+03  8.00219435e+03
  4.77694134e+04]
E1 = -182.58973634611556  E_coul = 54.048024469383435
cycle= 4 E= -128.541711876732  delta_E= -2.79e-08  |g|= 8.07e-05  |ddm|= 0.000408
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186756
diis-c [-1.08651647e-09  2.41202387e-04  4.61020378e-04 -1.86065425e-01
  1.18536320e+00]
  HOMO = -0.848940194705374  LUMO = 0.747601889602209
  mo_energy =
[-3.27707037e+01 -1.92927352e+00 -8.48940195e-01 -8.48940195e-01
 -8.48940195e-01  7.47601890e-01  8.10737387e-01  8.10737387e-01
  8.10737387e-01  3.88297738e+00  3.90829613e+00  3.90829613e+00
  3.90829613e+00  1.21955969e+01  1.42587680e+01  1.42587680e+01
  1.42587680e+01  4.07968876e+01  5.28405194e+01  5.28405194e+01
  5.28405194e+01  1.44423928e+02  2.40613407e+02  2.40613407e+02
  2.40613407e+02  5.07015439e+02  1.87321437e+03  8.00219426e+03
  4.77694133e+04]
E1 = -182.58986855831657  E_coul = 54.04815668085346
cycle= 5 E= -128.541711877463  delta_E= -7.31e-10  |g|= 5.91e-06  |ddm|= 6.96e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58986855831657  E_coul = 54.04815668085346
  HOMO = -0.848937084604897  LUMO = 0.747603143060933
  mo_energy =
[-3.27706967e+01 -1.92926962e+00 -8.48937085e-01 -8.48937085e-01
 -8.48937085e-01  7.47603143e-01  8.10738308e-01  8.10738308e-01
  8.10738308e-01  3.88297998e+00  3.90829911e+00  3.90829911e+00
  3.90829911e+00  1.21956012e+01  1.42587731e+01  1.42587731e+01
  1.42587731e+01  4.07968937e+01  5.28405259e+01  5.28405259e+01
  5.28405259e+01  1.44423935e+02  2.40613413e+02  2.40613413e+02
  2.40613413e+02  5.07015445e+02  1.87321438e+03  8.00219426e+03
  4.77694133e+04]
E1 = -182.58985272072533  E_coul = 54.04814084325914
Extra cycle  E= -128.541711877466  delta_E= -3.07e-12  |g|= 2.23e-06  |ddm|= 2.03e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [7.80077115e-01 2.44137942e+04 3.66145159e+03 8.33319042e+02
 2.35444177e+02 7.61173672e+01 1.02239877e+01 2.69572901e+01
 3.06585273e-01 1.76017797e+00 2.95191204e+00 7.11023295e+00
 2.31706874e+01 9.97863501e+01 2.67435182e-01 2.44638066e+00
 8.37875824e-01]
E = -128.54171187746618
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.780077115096       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158735        1
[INPUT] 0    0    [1    /1   ]  833.319042377        1
[INPUT] 0    0    [1    /1   ]  235.444176825        1
[INPUT] 0    0    [1    /1   ]  76.1173671977        1
[INPUT] 0    0    [1    /1   ]  10.2239877178        1
[INPUT] 0    0    [1    /1   ]  26.9572901194        1
[INPUT] 0    0    [1    /1   ]  0.306585273232       1
[INPUT] 0    0    [1    /1   ]  1.76017797062        1
[INPUT] 0    0    [1    /1   ]  2.95191204353        1
[INPUT] 1    0    [1    /1   ]  7.11023295147        1
[INPUT] 1    0    [1    /1   ]  23.1706873528        1
[INPUT] 1    0    [1    /1   ]  99.786350079         1
[INPUT] 1    0    [1    /1   ]  0.267435182331       1
[INPUT] 1    0    [1    /1   ]  2.44638066001        1
[INPUT] 1    0    [1    /1   ]  0.837875824178       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7800771150956428, 1.0]], [0, [24413.794186213112, 1.0]], [0, [3661.4515873452447, 1.0]], [0, [833.3190423767992, 1.0]], [0, [235.4441768248565, 1.0]], [0, [76.11736719766417, 1.0]], [0, [10.223987717847125, 1.0]], [0, [26.957290119372768, 1.0]], [0, [0.3065852732315748, 1.0]], [0, [1.760177970618901, 1.0]], [0, [2.951912043533486, 1.0]], [1, [7.1102329514729075, 1.0]], [1, [23.170687352824388, 1.0]], [1, [99.78635007899734, 1.0]], [1, [0.2674351823305807, 1.0]], [1, [2.4463806600131877, 1.0]], [1, [0.8378758241782251, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78007712]
bas 1, expnt(s) = [24413.79418621]
bas 2, expnt(s) = [3661.45158735]
bas 3, expnt(s) = [833.31904238]
bas 4, expnt(s) = [235.44417682]
bas 5, expnt(s) = [76.1173672]
bas 6, expnt(s) = [10.22398772]
bas 7, expnt(s) = [26.95729012]
bas 8, expnt(s) = [0.30658527]
bas 9, expnt(s) = [1.76017797]
bas 10, expnt(s) = [2.95191204]
bas 11, expnt(s) = [7.11023295]
bas 12, expnt(s) = [23.17068735]
bas 13, expnt(s) = [99.78635008]
bas 14, expnt(s) = [0.26743518]
bas 15, expnt(s) = [2.44638066]
bas 16, expnt(s) = [0.83787582]
CPU time:       130.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.80077115e-01 2.09709535e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319042e+02 3.91853296e+02
 2.35444177e+02 1.51855662e+02 7.61173672e+01 6.51070238e+01
 1.02239877e+01 1.44454230e+01 2.69572901e+01 2.98897442e+01
 3.06585273e-01 1.04094670e+00 1.76017797e+00 3.86084583e+00
 2.95191204e+00 5.68974213e+00 7.11023295e+00 3.38718705e+01
 2.31706874e+01 1.48305767e+02 9.97863501e+01 9.20075178e+02
 2.67435182e-01 5.61057753e-01 2.44638066e+00 8.92564143e+00
 8.37875824e-01 2.33861627e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999628033028415
cond(S) = 2131.0959413356436
E1 = -183.58991712608085  E_coul = 55.08020044639281
init E= -128.509716679688
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775399896756071  LUMO = 0.766265238146621
  mo_energy =
[-3.25551165e+01 -1.85272855e+00 -7.75399897e-01 -7.75399897e-01
 -7.75399897e-01  7.66265238e-01  8.28950047e-01  8.28950047e-01
  8.28950047e-01  3.93198021e+00  3.97446407e+00  3.97446407e+00
  3.97446407e+00  1.22917365e+01  1.43866212e+01  1.43866212e+01
  1.43866212e+01  4.09601387e+01  5.30278682e+01  5.30278682e+01
  5.30278682e+01  1.44635327e+02  2.40846635e+02  2.40846635e+02
  2.40846635e+02  5.07260597e+02  1.87349067e+03  8.00249734e+03
  4.77697344e+04]
E1 = -182.08688918992698  E_coul = 53.54868077935115
cycle= 1 E= -128.538208410576  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518616
diis-c [-0.26896235  1.        ]
  HOMO = -0.884234392099203  LUMO = 0.738903039920506
  mo_energy =
[-3.28781845e+01 -1.96652879e+00 -8.84234392e-01 -8.84234392e-01
 -8.84234392e-01  7.38903040e-01  8.02008305e-01  8.02008305e-01
  8.02008305e-01  3.85983946e+00  3.87685564e+00  3.87685564e+00
  3.87685564e+00  1.21490559e+01  1.41960080e+01  1.41960080e+01
  1.41960080e+01  4.07153814e+01  5.27470608e+01  5.27470608e+01
  5.27470608e+01  1.44318958e+02  2.40500435e+02  2.40500435e+02
  2.40500435e+02  5.06899484e+02  1.87309322e+03  8.00207076e+03
  4.77692890e+04]
E1 = -182.8476611071013  E_coul = 54.30686766165488
cycle= 2 E= -128.540793445446  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2633
diis-c [-6.63455940e-04  3.35939279e-01  6.64060721e-01]
  HOMO = -0.848630404624478  LUMO = 0.747666721019937
  mo_energy =
[-3.27701477e+01 -1.92903891e+00 -8.48630405e-01 -8.48630405e-01
 -8.48630405e-01  7.47666721e-01  8.10793852e-01  8.10793852e-01
  8.10793852e-01  3.88314241e+00  3.90852297e+00  3.90852297e+00
  3.90852297e+00  1.21958981e+01  1.42591488e+01  1.42591488e+01
  1.42591488e+01  4.07973269e+01  5.28410147e+01  5.28410147e+01
  5.28410147e+01  1.44424485e+02  2.40614040e+02  2.40614040e+02
  2.40614040e+02  5.07016133e+02  1.87321521e+03  8.00219520e+03
  4.77694143e+04]
E1 = -182.58923509351996  E_coul = 54.04752324463986
cycle= 3 E= -128.54171184888  delta_E= -0.000918  |g|= 0.000533  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119465
diis-c [-2.06570238e-07 -2.36594088e-03 -4.57760116e-04  1.00282370e+00]
  HOMO = -0.84889690570325  LUMO = 0.747614312670097
  mo_energy =
[-3.27706304e+01 -1.92924093e+00 -8.48896906e-01 -8.48896906e-01
 -8.48896906e-01  7.47614313e-01  8.10750976e-01  8.10750976e-01
  8.10750976e-01  3.88300625e+00  3.90833649e+00  3.90833649e+00
  3.90833649e+00  1.21956460e+01  1.42588276e+01  1.42588276e+01
  1.42588276e+01  4.07969525e+01  5.28405886e+01  5.28405886e+01
  5.28405886e+01  1.44424002e+02  2.40613485e+02  2.40613485e+02
  2.40613485e+02  5.07015521e+02  1.87321446e+03  8.00219435e+03
  4.77694134e+04]
E1 = -182.58973634611556  E_coul = 54.048024469383435
cycle= 4 E= -128.541711876732  delta_E= -2.79e-08  |g|= 8.07e-05  |ddm|= 0.000408
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186756
diis-c [-1.08651647e-09  2.41202387e-04  4.61020378e-04 -1.86065425e-01
  1.18536320e+00]
  HOMO = -0.848940194705374  LUMO = 0.747601889602209
  mo_energy =
[-3.27707037e+01 -1.92927352e+00 -8.48940195e-01 -8.48940195e-01
 -8.48940195e-01  7.47601890e-01  8.10737387e-01  8.10737387e-01
  8.10737387e-01  3.88297738e+00  3.90829613e+00  3.90829613e+00
  3.90829613e+00  1.21955969e+01  1.42587680e+01  1.42587680e+01
  1.42587680e+01  4.07968876e+01  5.28405194e+01  5.28405194e+01
  5.28405194e+01  1.44423928e+02  2.40613407e+02  2.40613407e+02
  2.40613407e+02  5.07015439e+02  1.87321437e+03  8.00219426e+03
  4.77694133e+04]
E1 = -182.58986855831657  E_coul = 54.04815668085346
cycle= 5 E= -128.541711877463  delta_E= -7.31e-10  |g|= 5.91e-06  |ddm|= 6.96e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58986855831657  E_coul = 54.04815668085346
  HOMO = -0.848937084604897  LUMO = 0.747603143060933
  mo_energy =
[-3.27706967e+01 -1.92926962e+00 -8.48937085e-01 -8.48937085e-01
 -8.48937085e-01  7.47603143e-01  8.10738308e-01  8.10738308e-01
  8.10738308e-01  3.88297998e+00  3.90829911e+00  3.90829911e+00
  3.90829911e+00  1.21956012e+01  1.42587731e+01  1.42587731e+01
  1.42587731e+01  4.07968937e+01  5.28405259e+01  5.28405259e+01
  5.28405259e+01  1.44423935e+02  2.40613413e+02  2.40613413e+02
  2.40613413e+02  5.07015445e+02  1.87321438e+03  8.00219426e+03
  4.77694133e+04]
E1 = -182.58985272072533  E_coul = 54.04814084325914
Extra cycle  E= -128.541711877466  delta_E= -3.07e-12  |g|= 2.23e-06  |ddm|= 2.03e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2131.0959413356436
E1 = -182.58985272072533  E_coul = 54.04814084325914
init E= -128.541711877466
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.84893820494576  LUMO = 0.74760294616196
  mo_energy =
[-3.27707002e+01 -1.92927066e+00 -8.48938205e-01 -8.48938205e-01
 -8.48938205e-01  7.47602946e-01  8.10738049e-01  8.10738049e-01
  8.10738049e-01  3.88297934e+00  3.90829814e+00  3.90829814e+00
  3.90829814e+00  1.21955998e+01  1.42587711e+01  1.42587711e+01
  1.42587711e+01  4.07968911e+01  5.28405229e+01  5.28405229e+01
  5.28405229e+01  1.44423932e+02  2.40613410e+02  2.40613410e+02
  2.40613410e+02  5.07015441e+02  1.87321437e+03  8.00219426e+03
  4.77694133e+04]
E1 = -182.58986151685426  E_coul = 54.04814963938802
cycle= 1 E= -128.541711877466  delta_E= -5.68e-14  |g|= 1.21e-06  |ddm|= 8.03e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58986151685426  E_coul = 54.04814963938802
  HOMO = -0.848937585736816  LUMO = 0.747603114328643
  mo_energy =
[-3.27706984e+01 -1.92926997e+00 -8.48937586e-01 -8.48937586e-01
 -8.48937586e-01  7.47603114e-01  8.10738206e-01  8.10738206e-01
  8.10738206e-01  3.88297976e+00  3.90829870e+00  3.90829870e+00
  3.90829870e+00  1.21956006e+01  1.42587722e+01  1.42587722e+01
  1.42587722e+01  4.07968925e+01  5.28405245e+01  5.28405245e+01
  5.28405245e+01  1.44423933e+02  2.40613412e+02  2.40613412e+02
  2.40613412e+02  5.07015443e+02  1.87321437e+03  8.00219426e+03
  4.77694133e+04]
E1 = -182.5898570975381  E_coul = 54.04814522007208
Extra cycle  E= -128.541711877466  delta_E= 2.27e-13  |g|= 6e-07  |ddm|= 3.76e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [7.80077115e-01 2.44137942e+04 3.66145159e+03 8.33319042e+02
 2.35444177e+02 7.61173672e+01 1.02239877e+01 2.69572901e+01
 3.06585273e-01 1.76017797e+00 2.95191204e+00 7.11023295e+00
 2.31706874e+01 9.97863501e+01 2.67435182e-01 2.44638066e+00
 8.37875824e-01]
grad_E = [ 4.72608870e-05  4.76114627e-10 -2.40051736e-08  4.34577156e-07
 -4.88487211e-06  4.55322303e-05 -6.14453625e-05 -1.59439313e-04
  3.97515491e-05  5.44092899e-06 -1.23330742e-04 -1.05036899e-04
  1.62631441e-05 -6.07809198e-07  3.25225786e-04  5.72260124e-05
  4.17977040e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.770925101636       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158794        1
[INPUT] 0    0    [1    /1   ]  833.31903181         1
[INPUT] 0    0    [1    /1   ]  235.444295769        1
[INPUT] 0    0    [1    /1   ]  76.1161894396        1
[INPUT] 0    0    [1    /1   ]  10.2397876782        1
[INPUT] 0    0    [1    /1   ]  26.9599329152        1
[INPUT] 0    0    [1    /1   ]  0.305020112556       1
[INPUT] 0    0    [1    /1   ]  1.73659068633        1
[INPUT] 0    0    [1    /1   ]  2.95591441662        1
[INPUT] 1    0    [1    /1   ]  7.11164731172        1
[INPUT] 1    0    [1    /1   ]  23.1703119179        1
[INPUT] 1    0    [1    /1   ]  99.7863664741        1
[INPUT] 1    0    [1    /1   ]  0.267206081716       1
[INPUT] 1    0    [1    /1   ]  2.44612501102        1
[INPUT] 1    0    [1    /1   ]  0.837294032211       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7709251016361138, 1.0]], [0, [24413.794186201125, 1.0]], [0, [3661.4515879424703, 1.0]], [0, [833.3190318095857, 1.0]], [0, [235.4442957689855, 1.0]], [0, [76.11618943960502, 1.0]], [0, [10.239787678188048, 1.0]], [0, [26.95993291517804, 1.0]], [0, [0.305020112555781, 1.0]], [0, [1.7365906863259368, 1.0]], [0, [2.955914416619529, 1.0]], [1, [7.111647311717248, 1.0]], [1, [23.170311917936324, 1.0]], [1, [99.78636647405695, 1.0]], [1, [0.26720608171634797, 1.0]], [1, [2.446125011021619, 1.0]], [1, [0.8372940322110113, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7709251]
bas 1, expnt(s) = [24413.7941862]
bas 2, expnt(s) = [3661.45158794]
bas 3, expnt(s) = [833.31903181]
bas 4, expnt(s) = [235.44429577]
bas 5, expnt(s) = [76.11618944]
bas 6, expnt(s) = [10.23978768]
bas 7, expnt(s) = [26.95993292]
bas 8, expnt(s) = [0.30502011]
bas 9, expnt(s) = [1.73659069]
bas 10, expnt(s) = [2.95591442]
bas 11, expnt(s) = [7.11164731]
bas 12, expnt(s) = [23.17031192]
bas 13, expnt(s) = [99.78636647]
bas 14, expnt(s) = [0.26720608]
bas 15, expnt(s) = [2.44612501]
bas 16, expnt(s) = [0.83729403]
CPU time:       133.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.70925102e-01 2.07861551e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319032e+02 3.91853292e+02
 2.35444296e+02 1.51855720e+02 7.61161894e+01 6.51062682e+01
 1.02397877e+01 1.44621625e+01 2.69599329e+01 2.98919419e+01
 3.05020113e-01 1.03695851e+00 1.73659069e+00 3.82197749e+00
 2.95591442e+00 5.69552701e+00 7.11164731e+00 3.38802929e+01
 2.31703119e+01 1.48302763e+02 9.97863665e+01 9.20075367e+02
 2.67206082e-01 5.60457023e-01 2.44612501e+00 8.92447552e+00
 8.37294032e-01 2.33658663e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629676634134
cond(S) = 2018.7484219955352
E1 = -183.5898722308131  E_coul = 55.08019193617214
init E= -128.509680294641
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400775354588  LUMO = 0.758502001702003
  mo_energy =
[-3.25551168e+01 -1.85273153e+00 -7.75400775e-01 -7.75400775e-01
 -7.75400775e-01  7.58502002e-01  8.28148237e-01  8.28148237e-01
  8.28148237e-01  3.88914889e+00  3.97195312e+00  3.97195312e+00
  3.97195312e+00  1.21966939e+01  1.43843047e+01  1.43843047e+01
  1.43843047e+01  4.08608769e+01  5.30282946e+01  5.30282946e+01
  5.30282946e+01  1.44574423e+02  2.40847450e+02  2.40847450e+02
  2.40847450e+02  5.07218194e+02  1.87345503e+03  8.00246648e+03
  4.77697089e+04]
E1 = -182.08672977901088  E_coul = 53.5485198165553
cycle= 1 E= -128.538209962456  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518666
diis-c [-0.26901436  1.        ]
  HOMO = -0.884248059146477  LUMO = 0.731437624813118
  mo_energy =
[-3.28782056e+01 -1.96654851e+00 -8.84248059e-01 -8.84248059e-01
 -8.84248059e-01  7.31437625e-01  8.01232465e-01  8.01232465e-01
  8.01232465e-01  3.81754981e+00  3.87435365e+00  3.87435365e+00
  3.87435365e+00  1.20542630e+01  1.41936586e+01  1.41936586e+01
  1.41936586e+01  4.06160030e+01  5.27474579e+01  5.27474579e+01
  5.27474579e+01  1.44258001e+02  2.40501238e+02  2.40501238e+02
  2.40501238e+02  5.06857058e+02  1.87305757e+03  8.00203988e+03
  4.77692635e+04]
E1 = -182.8476214944097  E_coul = 54.30682607906806
cycle= 2 E= -128.540795415342  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26335
diis-c [-6.63192237e-04  3.35961056e-01  6.64038944e-01]
  HOMO = -0.848639259246193  LUMO = 0.740105265512757
  mo_energy =
[-3.27701568e+01 -1.92905353e+00 -8.48639259e-01 -8.48639259e-01
 -8.48639259e-01  7.40105266e-01  8.10009778e-01  8.10009778e-01
  8.10009778e-01  3.84067562e+00  3.90601841e+00  3.90601841e+00
  3.90601841e+00  1.21010220e+01  1.42568134e+01  1.42568134e+01
  1.42568134e+01  4.06979930e+01  5.28414243e+01  5.28414243e+01
  5.28414243e+01  1.44363553e+02  2.40614856e+02  2.40614856e+02
  2.40614856e+02  5.06973722e+02  1.87317957e+03  8.00216434e+03
  4.77693889e+04]
E1 = -182.58915092136058  E_coul = 54.0474368127359
cycle= 3 E= -128.541714108625  delta_E= -0.000919  |g|= 0.000531  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119018
diis-c [-2.06104318e-07 -2.36411656e-03 -4.72286266e-04  1.00283640e+00]
  HOMO = -0.848905160858864  LUMO = 0.740053480878388
  mo_energy =
[-3.27706381e+01 -1.92925511e+00 -8.48905161e-01 -8.48905161e-01
 -8.48905161e-01  7.40053481e-01  8.09967111e-01  8.09967111e-01
  8.09967111e-01  3.84054086e+00  3.90583254e+00  3.90583254e+00
  3.90583254e+00  1.21007711e+01  1.42564932e+01  1.42564932e+01
  1.42564932e+01  4.06976197e+01  5.28409995e+01  5.28409995e+01
  5.28409995e+01  1.44363070e+02  2.40614302e+02  2.40614302e+02
  2.40614302e+02  5.06973111e+02  1.87317883e+03  8.00216349e+03
  4.77693880e+04]
E1 = -182.58964847024095  E_coul = 54.047934333875375
cycle= 4 E= -128.541714136366  delta_E= -2.77e-08  |g|= 8.05e-05  |ddm|= 0.000403
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186315
diis-c [-1.08423350e-09  2.40748542e-04  4.61891519e-04 -1.85941274e-01
  1.18523863e+00]
  HOMO = -0.848948406386832  LUMO = 0.74004116172723
  mo_energy =
[-3.27707113e+01 -1.92928770e+00 -8.48948406e-01 -8.48948406e-01
 -8.48948406e-01  7.40041162e-01  8.09953538e-01  8.09953538e-01
  8.09953538e-01  3.84051220e+00  3.90579222e+00  3.90579222e+00
  3.90579222e+00  1.21007222e+01  1.42564336e+01  1.42564336e+01
  1.42564336e+01  4.06975548e+01  5.28409303e+01  5.28409303e+01
  5.28409303e+01  1.44362997e+02  2.40614224e+02  2.40614224e+02
  2.40614224e+02  5.06973030e+02  1.87317874e+03  8.00216340e+03
  4.77693879e+04]
E1 = -182.58978026570486  E_coul = 54.04806612860922
cycle= 5 E= -128.541714137096  delta_E= -7.3e-10  |g|= 5.89e-06  |ddm|= 6.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58978026570486  E_coul = 54.04806612860922
  HOMO = -0.848945306840763  LUMO = 0.740042398694769
  mo_energy =
[-3.27707043e+01 -1.92928381e+00 -8.48945307e-01 -8.48945307e-01
 -8.48945307e-01  7.40042399e-01  8.09954454e-01  8.09954454e-01
  8.09954454e-01  3.84051477e+00  3.90579520e+00  3.90579520e+00
  3.90579520e+00  1.21007265e+01  1.42564387e+01  1.42564387e+01
  1.42564387e+01  4.06975610e+01  5.28409369e+01  5.28409369e+01
  5.28409369e+01  1.44363004e+02  2.40614231e+02  2.40614231e+02
  2.40614231e+02  5.06973036e+02  1.87317874e+03  8.00216340e+03
  4.77693879e+04]
E1 = -182.5897644515295  E_coul = 54.048050314431386
Extra cycle  E= -128.541714137098  delta_E= -2.47e-12  |g|= 2.23e-06  |ddm|= 2.01e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.70925102e-01 2.44137942e+04 3.66145159e+03 8.33319032e+02
 2.35444296e+02 7.61161894e+01 1.02397877e+01 2.69599329e+01
 3.05020113e-01 1.73659069e+00 2.95591442e+00 7.11164731e+00
 2.31703119e+01 9.97863665e+01 2.67206082e-01 2.44612501e+00
 8.37294032e-01]
E = -128.54171413709813
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.770925101636       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158794        1
[INPUT] 0    0    [1    /1   ]  833.31903181         1
[INPUT] 0    0    [1    /1   ]  235.444295769        1
[INPUT] 0    0    [1    /1   ]  76.1161894396        1
[INPUT] 0    0    [1    /1   ]  10.2397876782        1
[INPUT] 0    0    [1    /1   ]  26.9599329152        1
[INPUT] 0    0    [1    /1   ]  0.305020112556       1
[INPUT] 0    0    [1    /1   ]  1.73659068633        1
[INPUT] 0    0    [1    /1   ]  2.95591441662        1
[INPUT] 1    0    [1    /1   ]  7.11164731172        1
[INPUT] 1    0    [1    /1   ]  23.1703119179        1
[INPUT] 1    0    [1    /1   ]  99.7863664741        1
[INPUT] 1    0    [1    /1   ]  0.267206081716       1
[INPUT] 1    0    [1    /1   ]  2.44612501102        1
[INPUT] 1    0    [1    /1   ]  0.837294032211       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7709251016361138, 1.0]], [0, [24413.794186201125, 1.0]], [0, [3661.4515879424703, 1.0]], [0, [833.3190318095857, 1.0]], [0, [235.4442957689855, 1.0]], [0, [76.11618943960502, 1.0]], [0, [10.239787678188048, 1.0]], [0, [26.95993291517804, 1.0]], [0, [0.305020112555781, 1.0]], [0, [1.7365906863259368, 1.0]], [0, [2.955914416619529, 1.0]], [1, [7.111647311717248, 1.0]], [1, [23.170311917936324, 1.0]], [1, [99.78636647405695, 1.0]], [1, [0.26720608171634797, 1.0]], [1, [2.446125011021619, 1.0]], [1, [0.8372940322110113, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7709251]
bas 1, expnt(s) = [24413.7941862]
bas 2, expnt(s) = [3661.45158794]
bas 3, expnt(s) = [833.31903181]
bas 4, expnt(s) = [235.44429577]
bas 5, expnt(s) = [76.11618944]
bas 6, expnt(s) = [10.23978768]
bas 7, expnt(s) = [26.95993292]
bas 8, expnt(s) = [0.30502011]
bas 9, expnt(s) = [1.73659069]
bas 10, expnt(s) = [2.95591442]
bas 11, expnt(s) = [7.11164731]
bas 12, expnt(s) = [23.17031192]
bas 13, expnt(s) = [99.78636647]
bas 14, expnt(s) = [0.26720608]
bas 15, expnt(s) = [2.44612501]
bas 16, expnt(s) = [0.83729403]
CPU time:       134.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.70925102e-01 2.07861551e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319032e+02 3.91853292e+02
 2.35444296e+02 1.51855720e+02 7.61161894e+01 6.51062682e+01
 1.02397877e+01 1.44621625e+01 2.69599329e+01 2.98919419e+01
 3.05020113e-01 1.03695851e+00 1.73659069e+00 3.82197749e+00
 2.95591442e+00 5.69552701e+00 7.11164731e+00 3.38802929e+01
 2.31703119e+01 1.48302763e+02 9.97863665e+01 9.20075367e+02
 2.67206082e-01 5.60457023e-01 2.44612501e+00 8.92447552e+00
 8.37294032e-01 2.33658663e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629676634134
cond(S) = 2018.7484219955352
E1 = -183.5898722308131  E_coul = 55.08019193617214
init E= -128.509680294641
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400775354588  LUMO = 0.758502001702003
  mo_energy =
[-3.25551168e+01 -1.85273153e+00 -7.75400775e-01 -7.75400775e-01
 -7.75400775e-01  7.58502002e-01  8.28148237e-01  8.28148237e-01
  8.28148237e-01  3.88914889e+00  3.97195312e+00  3.97195312e+00
  3.97195312e+00  1.21966939e+01  1.43843047e+01  1.43843047e+01
  1.43843047e+01  4.08608769e+01  5.30282946e+01  5.30282946e+01
  5.30282946e+01  1.44574423e+02  2.40847450e+02  2.40847450e+02
  2.40847450e+02  5.07218194e+02  1.87345503e+03  8.00246648e+03
  4.77697089e+04]
E1 = -182.08672977901088  E_coul = 53.5485198165553
cycle= 1 E= -128.538209962456  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518666
diis-c [-0.26901436  1.        ]
  HOMO = -0.884248059146477  LUMO = 0.731437624813118
  mo_energy =
[-3.28782056e+01 -1.96654851e+00 -8.84248059e-01 -8.84248059e-01
 -8.84248059e-01  7.31437625e-01  8.01232465e-01  8.01232465e-01
  8.01232465e-01  3.81754981e+00  3.87435365e+00  3.87435365e+00
  3.87435365e+00  1.20542630e+01  1.41936586e+01  1.41936586e+01
  1.41936586e+01  4.06160030e+01  5.27474579e+01  5.27474579e+01
  5.27474579e+01  1.44258001e+02  2.40501238e+02  2.40501238e+02
  2.40501238e+02  5.06857058e+02  1.87305757e+03  8.00203988e+03
  4.77692635e+04]
E1 = -182.8476214944097  E_coul = 54.30682607906806
cycle= 2 E= -128.540795415342  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0627
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.26335
diis-c [-6.63192237e-04  3.35961056e-01  6.64038944e-01]
  HOMO = -0.848639259246193  LUMO = 0.740105265512757
  mo_energy =
[-3.27701568e+01 -1.92905353e+00 -8.48639259e-01 -8.48639259e-01
 -8.48639259e-01  7.40105266e-01  8.10009778e-01  8.10009778e-01
  8.10009778e-01  3.84067562e+00  3.90601841e+00  3.90601841e+00
  3.90601841e+00  1.21010220e+01  1.42568134e+01  1.42568134e+01
  1.42568134e+01  4.06979930e+01  5.28414243e+01  5.28414243e+01
  5.28414243e+01  1.44363553e+02  2.40614856e+02  2.40614856e+02
  2.40614856e+02  5.06973722e+02  1.87317957e+03  8.00216434e+03
  4.77693889e+04]
E1 = -182.58915092136058  E_coul = 54.0474368127359
cycle= 3 E= -128.541714108625  delta_E= -0.000919  |g|= 0.000531  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119018
diis-c [-2.06104318e-07 -2.36411656e-03 -4.72286266e-04  1.00283640e+00]
  HOMO = -0.848905160858864  LUMO = 0.740053480878388
  mo_energy =
[-3.27706381e+01 -1.92925511e+00 -8.48905161e-01 -8.48905161e-01
 -8.48905161e-01  7.40053481e-01  8.09967111e-01  8.09967111e-01
  8.09967111e-01  3.84054086e+00  3.90583254e+00  3.90583254e+00
  3.90583254e+00  1.21007711e+01  1.42564932e+01  1.42564932e+01
  1.42564932e+01  4.06976197e+01  5.28409995e+01  5.28409995e+01
  5.28409995e+01  1.44363070e+02  2.40614302e+02  2.40614302e+02
  2.40614302e+02  5.06973111e+02  1.87317883e+03  8.00216349e+03
  4.77693880e+04]
E1 = -182.58964847024095  E_coul = 54.047934333875375
cycle= 4 E= -128.541714136366  delta_E= -2.77e-08  |g|= 8.05e-05  |ddm|= 0.000403
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186315
diis-c [-1.08423350e-09  2.40748542e-04  4.61891519e-04 -1.85941274e-01
  1.18523863e+00]
  HOMO = -0.848948406386832  LUMO = 0.74004116172723
  mo_energy =
[-3.27707113e+01 -1.92928770e+00 -8.48948406e-01 -8.48948406e-01
 -8.48948406e-01  7.40041162e-01  8.09953538e-01  8.09953538e-01
  8.09953538e-01  3.84051220e+00  3.90579222e+00  3.90579222e+00
  3.90579222e+00  1.21007222e+01  1.42564336e+01  1.42564336e+01
  1.42564336e+01  4.06975548e+01  5.28409303e+01  5.28409303e+01
  5.28409303e+01  1.44362997e+02  2.40614224e+02  2.40614224e+02
  2.40614224e+02  5.06973030e+02  1.87317874e+03  8.00216340e+03
  4.77693879e+04]
E1 = -182.58978026570486  E_coul = 54.04806612860922
cycle= 5 E= -128.541714137096  delta_E= -7.3e-10  |g|= 5.89e-06  |ddm|= 6.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58978026570486  E_coul = 54.04806612860922
  HOMO = -0.848945306840763  LUMO = 0.740042398694769
  mo_energy =
[-3.27707043e+01 -1.92928381e+00 -8.48945307e-01 -8.48945307e-01
 -8.48945307e-01  7.40042399e-01  8.09954454e-01  8.09954454e-01
  8.09954454e-01  3.84051477e+00  3.90579520e+00  3.90579520e+00
  3.90579520e+00  1.21007265e+01  1.42564387e+01  1.42564387e+01
  1.42564387e+01  4.06975610e+01  5.28409369e+01  5.28409369e+01
  5.28409369e+01  1.44363004e+02  2.40614231e+02  2.40614231e+02
  2.40614231e+02  5.06973036e+02  1.87317874e+03  8.00216340e+03
  4.77693879e+04]
E1 = -182.5897644515295  E_coul = 54.048050314431386
Extra cycle  E= -128.541714137098  delta_E= -2.47e-12  |g|= 2.23e-06  |ddm|= 2.01e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2018.7484219955352
E1 = -182.5897644515295  E_coul = 54.048050314431386
init E= -128.541714137098
    CPU time for initialize scf      0.40 sec, wall time      0.41 sec
  HOMO = -0.848946425782736  LUMO = 0.740042204360121
  mo_energy =
[-3.27707078e+01 -1.92928484e+00 -8.48946426e-01 -8.48946426e-01
 -8.48946426e-01  7.40042204e-01  8.09954196e-01  8.09954196e-01
  8.09954196e-01  3.84051413e+00  3.90579423e+00  3.90579423e+00
  3.90579423e+00  1.21007251e+01  1.42564367e+01  1.42564367e+01
  1.42564367e+01  4.06975584e+01  5.28409339e+01  5.28409339e+01
  5.28409339e+01  1.44363000e+02  2.40614227e+02  2.40614227e+02
  2.40614227e+02  5.06973033e+02  1.87317874e+03  8.00216340e+03
  4.77693879e+04]
E1 = -182.5897732310281  E_coul = 54.04805909392918
cycle= 1 E= -128.541714137099  delta_E= -7.67e-13  |g|= 1.2e-06  |ddm|= 8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5897732310281  E_coul = 54.04805909392918
  HOMO = -0.848945807775934  LUMO = 0.740042370388447
  mo_energy =
[-3.27707059e+01 -1.92928416e+00 -8.48945808e-01 -8.48945808e-01
 -8.48945808e-01  7.40042370e-01  8.09954352e-01  8.09954352e-01
  8.09954352e-01  3.84051455e+00  3.90579478e+00  3.90579478e+00
  3.90579478e+00  1.21007259e+01  1.42564378e+01  1.42564378e+01
  1.42564378e+01  4.06975598e+01  5.28409355e+01  5.28409355e+01
  5.28409355e+01  1.44363002e+02  2.40614229e+02  2.40614229e+02
  2.40614229e+02  5.06973034e+02  1.87317874e+03  8.00216340e+03
  4.77693879e+04]
E1 = -182.58976881938202  E_coul = 54.048054682283244
Extra cycle  E= -128.541714137099  delta_E= 1.14e-13  |g|= 5.99e-07  |ddm|= 3.75e-07
    CPU time for scf_cycle      0.47 sec, wall time      0.48 sec
exp = [7.70925102e-01 2.44137942e+04 3.66145159e+03 8.33319032e+02
 2.35444296e+02 7.61161894e+01 1.02397877e+01 2.69599329e+01
 3.05020113e-01 1.73659069e+00 2.95591442e+00 7.11164731e+00
 2.31703119e+01 9.97863665e+01 2.67206082e-01 2.44612501e+00
 8.37294032e-01]
grad_E = [-3.89832266e-07  5.51844566e-10 -2.79812568e-08  5.15383339e-07
 -5.87307735e-06  5.35996595e-05  1.14602993e-05 -1.97107622e-04
  1.48534059e-04 -5.53034886e-06 -1.40862684e-04 -9.28703025e-05
  1.33539200e-05 -4.75728409e-07  2.75779533e-04  8.21595919e-05
  2.97407359e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.780811850391       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158934        1
[INPUT] 0    0    [1    /1   ]  833.319011653        1
[INPUT] 0    0    [1    /1   ]  235.444464247        1
[INPUT] 0    0    [1    /1   ]  76.1141076914        1
[INPUT] 0    0    [1    /1   ]  10.2680090281        1
[INPUT] 0    0    [1    /1   ]  26.963484454         1
[INPUT] 0    0    [1    /1   ]  0.308013555969       1
[INPUT] 0    0    [1    /1   ]  1.77121130154        1
[INPUT] 0    0    [1    /1   ]  2.96557666791        1
[INPUT] 1    0    [1    /1   ]  7.11363982114        1
[INPUT] 1    0    [1    /1   ]  23.169856078         1
[INPUT] 1    0    [1    /1   ]  99.7863829559        1
[INPUT] 1    0    [1    /1   ]  0.26648091658        1
[INPUT] 1    0    [1    /1   ]  2.44415781301        1
[INPUT] 1    0    [1    /1   ]  0.8353442131         1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7808118503907875, 1.0]], [0, [24413.794186171657, 1.0]], [0, [3661.4515893393595, 1.0]], [0, [833.3190116528508, 1.0]], [0, [235.44446424697756, 1.0]], [0, [76.1141076914277, 1.0]], [0, [10.268009028111166, 1.0]], [0, [26.963484454049162, 1.0]], [0, [0.30801355596933816, 1.0]], [0, [1.7712113015402644, 1.0]], [0, [2.9655766679096494, 1.0]], [1, [7.113639821142111, 1.0]], [1, [23.169856078006955, 1.0]], [1, [99.78638295588661, 1.0]], [1, [0.2664809165798541, 1.0]], [1, [2.444157813012292, 1.0]], [1, [0.8353442130999852, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78081185]
bas 1, expnt(s) = [24413.79418617]
bas 2, expnt(s) = [3661.45158934]
bas 3, expnt(s) = [833.31901165]
bas 4, expnt(s) = [235.44446425]
bas 5, expnt(s) = [76.11410769]
bas 6, expnt(s) = [10.26800903]
bas 7, expnt(s) = [26.96348445]
bas 8, expnt(s) = [0.30801356]
bas 9, expnt(s) = [1.7712113]
bas 10, expnt(s) = [2.96557667]
bas 11, expnt(s) = [7.11363982]
bas 12, expnt(s) = [23.16985608]
bas 13, expnt(s) = [99.78638296]
bas 14, expnt(s) = [0.26648092]
bas 15, expnt(s) = [2.44415781]
bas 16, expnt(s) = [0.83534421]
CPU time:       137.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.80811850e-01 2.09857658e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319012e+02 3.91853285e+02
 2.35444464e+02 1.51855801e+02 7.61141077e+01 6.51049327e+01
 1.02680090e+01 1.44920461e+01 2.69634845e+01 2.98948952e+01
 3.08013556e-01 1.04458166e+00 1.77121130e+00 3.87898237e+00
 2.96557667e+00 5.70948441e+00 7.11363982e+00 3.38921588e+01
 2.31698561e+01 1.48299116e+02 9.97863830e+01 9.20075557e+02
 2.66480917e-01 5.58556403e-01 2.44415781e+00 8.91550499e+00
 8.35344213e-01 2.32978706e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999634318291385
cond(S) = 2131.9161945042174
E1 = -183.5898163033392  E_coul = 55.08017974329823
init E= -128.509636560041
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775402485446011  LUMO = 0.770285019657107
  mo_energy =
[-3.25551191e+01 -1.85273266e+00 -7.75402485e-01 -7.75402485e-01
 -7.75402485e-01  7.70285020e-01  8.25572188e-01  8.25572188e-01
  8.25572188e-01  3.95034560e+00  3.96310507e+00  3.96310507e+00
  3.96310507e+00  1.23581353e+01  1.43714230e+01  1.43714230e+01
  1.43714230e+01  4.11423154e+01  5.30189795e+01  5.30189795e+01
  5.30189795e+01  1.44908141e+02  2.40841525e+02  2.40841525e+02
  2.40841525e+02  5.07540265e+02  1.87374678e+03  8.00272370e+03
  4.77699220e+04]
E1 = -182.086177489786  E_coul = 53.54796840530514
cycle= 1 E= -128.538209084481  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518711
diis-c [-0.26906092  1.        ]
  HOMO = -0.88429220564415  LUMO = 0.742759094513591
  mo_energy =
[-3.28782959e+01 -1.96660305e+00 -8.84292206e-01 -8.84292206e-01
 -8.84292206e-01  7.42759095e-01  7.98740908e-01  7.98740908e-01
  7.98740908e-01  3.86555923e+00  3.86555923e+00  3.86555923e+00
  3.87786615e+00  1.22149244e+01  1.41806916e+01  1.41806916e+01
  1.41806916e+01  4.08972508e+01  5.27380410e+01  5.27380410e+01
  5.27380410e+01  1.44591664e+02  2.40495229e+02  2.40495229e+02
  2.40495229e+02  5.07179058e+02  1.87334925e+03  8.00229702e+03
  4.77694764e+04]
E1 = -182.84744937970112  E_coul = 54.306653360183894
cycle= 2 E= -128.540796019517  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263423
diis-c [-0.00066472  0.33600235  0.66399765]
  HOMO = -0.848666847338164  LUMO = 0.751574294176141
  mo_energy =
[-3.27702043e+01 -1.92909006e+00 -8.48666847e-01 -8.48666847e-01
 -8.48666847e-01  7.51574294e-01  8.07491371e-01  8.07491371e-01
  8.07491371e-01  3.89720758e+00  3.89720758e+00  3.89720758e+00
  3.90128074e+00  1.22619481e+01  1.42438813e+01  1.42438813e+01
  1.42438813e+01  4.09793133e+01  5.28320510e+01  5.28320510e+01
  5.28320510e+01  1.44697246e+02  2.40608891e+02  2.40608891e+02
  2.40608891e+02  5.07295763e+02  1.87347129e+03  8.00242152e+03
  4.77696019e+04]
E1 = -182.5888296901947  E_coul = 54.04711405263792
cycle= 3 E= -128.541715637557  delta_E= -0.00092  |g|= 0.000529  |ddm|= 0.0217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00118531
diis-c [-2.02057519e-07 -2.35584729e-03 -4.69329134e-04  1.00282518e+00]
  HOMO = -0.848932103348948  LUMO = 0.751521779760066
  mo_energy =
[-3.27706844e+01 -1.92929156e+00 -8.48932103e-01 -8.48932103e-01
 -8.48932103e-01  7.51521780e-01  8.07449140e-01  8.07449140e-01
  8.07449140e-01  3.89702240e+00  3.89702240e+00  3.89702240e+00
  3.90114476e+00  1.22616966e+01  1.42435620e+01  1.42435620e+01
  1.42435620e+01  4.09789407e+01  5.28316272e+01  5.28316272e+01
  5.28316272e+01  1.44696765e+02  2.40608339e+02  2.40608339e+02
  2.40608339e+02  5.07295153e+02  1.87347055e+03  8.00242068e+03
  4.77696010e+04]
E1 = -182.5893249105397  E_coul = 54.04760924558318
cycle= 4 E= -128.541715664957  delta_E= -2.74e-08  |g|= 8.02e-05  |ddm|= 0.000403
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185619
diis-c [-1.07287970e-09  2.37961935e-04  4.61909626e-04 -1.84684965e-01
  1.18398509e+00]
  HOMO = -0.848975226093331  LUMO = 0.751509265285742
  mo_energy =
[-3.27707574e+01 -1.92932421e+00 -8.48975226e-01 -8.48975226e-01
 -8.48975226e-01  7.51509265e-01  8.07435652e-01  8.07435652e-01
  8.07435652e-01  3.89698218e+00  3.89698218e+00  3.89698218e+00
  3.90111582e+00  1.22616476e+01  1.42435025e+01  1.42435025e+01
  1.42435025e+01  4.09788759e+01  5.28315582e+01  5.28315582e+01
  5.28315582e+01  1.44696692e+02  2.40608262e+02  2.40608262e+02
  2.40608262e+02  5.07295072e+02  1.87347046e+03  8.00242058e+03
  4.77696009e+04]
E1 = -182.5894565524202  E_coul = 54.047740886745224
cycle= 5 E= -128.541715665675  delta_E= -7.18e-10  |g|= 5.83e-06  |ddm|= 6.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5894565524202  E_coul = 54.047740886745224
  HOMO = -0.848972168420405  LUMO = 0.751510503228359
  mo_energy =
[-3.27707505e+01 -1.92932036e+00 -8.48972168e-01 -8.48972168e-01
 -8.48972168e-01  7.51510503e-01  8.07436551e-01  8.07436551e-01
  8.07436551e-01  3.89698511e+00  3.89698511e+00  3.89698511e+00
  3.90111839e+00  1.22616518e+01  1.42435076e+01  1.42435076e+01
  1.42435076e+01  4.09788819e+01  5.28315646e+01  5.28315646e+01
  5.28315646e+01  1.44696699e+02  2.40608268e+02  2.40608268e+02
  2.40608268e+02  5.07295078e+02  1.87347046e+03  8.00242059e+03
  4.77696009e+04]
E1 = -182.58944089967636  E_coul = 54.047725233998804
Extra cycle  E= -128.541715665678  delta_E= -2.59e-12  |g|= 2.2e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.80811850e-01 2.44137942e+04 3.66145159e+03 8.33319012e+02
 2.35444464e+02 7.61141077e+01 1.02680090e+01 2.69634845e+01
 3.08013556e-01 1.77121130e+00 2.96557667e+00 7.11363982e+00
 2.31698561e+01 9.97863830e+01 2.66480917e-01 2.44415781e+00
 8.35344213e-01]
E = -128.54171566567754
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.780811850391       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158934        1
[INPUT] 0    0    [1    /1   ]  833.319011653        1
[INPUT] 0    0    [1    /1   ]  235.444464247        1
[INPUT] 0    0    [1    /1   ]  76.1141076914        1
[INPUT] 0    0    [1    /1   ]  10.2680090281        1
[INPUT] 0    0    [1    /1   ]  26.963484454         1
[INPUT] 0    0    [1    /1   ]  0.308013555969       1
[INPUT] 0    0    [1    /1   ]  1.77121130154        1
[INPUT] 0    0    [1    /1   ]  2.96557666791        1
[INPUT] 1    0    [1    /1   ]  7.11363982114        1
[INPUT] 1    0    [1    /1   ]  23.169856078         1
[INPUT] 1    0    [1    /1   ]  99.7863829559        1
[INPUT] 1    0    [1    /1   ]  0.26648091658        1
[INPUT] 1    0    [1    /1   ]  2.44415781301        1
[INPUT] 1    0    [1    /1   ]  0.8353442131         1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7808118503907875, 1.0]], [0, [24413.794186171657, 1.0]], [0, [3661.4515893393595, 1.0]], [0, [833.3190116528508, 1.0]], [0, [235.44446424697756, 1.0]], [0, [76.1141076914277, 1.0]], [0, [10.268009028111166, 1.0]], [0, [26.963484454049162, 1.0]], [0, [0.30801355596933816, 1.0]], [0, [1.7712113015402644, 1.0]], [0, [2.9655766679096494, 1.0]], [1, [7.113639821142111, 1.0]], [1, [23.169856078006955, 1.0]], [1, [99.78638295588661, 1.0]], [1, [0.2664809165798541, 1.0]], [1, [2.444157813012292, 1.0]], [1, [0.8353442130999852, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78081185]
bas 1, expnt(s) = [24413.79418617]
bas 2, expnt(s) = [3661.45158934]
bas 3, expnt(s) = [833.31901165]
bas 4, expnt(s) = [235.44446425]
bas 5, expnt(s) = [76.11410769]
bas 6, expnt(s) = [10.26800903]
bas 7, expnt(s) = [26.96348445]
bas 8, expnt(s) = [0.30801356]
bas 9, expnt(s) = [1.7712113]
bas 10, expnt(s) = [2.96557667]
bas 11, expnt(s) = [7.11363982]
bas 12, expnt(s) = [23.16985608]
bas 13, expnt(s) = [99.78638296]
bas 14, expnt(s) = [0.26648092]
bas 15, expnt(s) = [2.44415781]
bas 16, expnt(s) = [0.83534421]
CPU time:       138.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.80811850e-01 2.09857658e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319012e+02 3.91853285e+02
 2.35444464e+02 1.51855801e+02 7.61141077e+01 6.51049327e+01
 1.02680090e+01 1.44920461e+01 2.69634845e+01 2.98948952e+01
 3.08013556e-01 1.04458166e+00 1.77121130e+00 3.87898237e+00
 2.96557667e+00 5.70948441e+00 7.11363982e+00 3.38921588e+01
 2.31698561e+01 1.48299116e+02 9.97863830e+01 9.20075557e+02
 2.66480917e-01 5.58556403e-01 2.44415781e+00 8.91550499e+00
 8.35344213e-01 2.32978706e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999634318291385
cond(S) = 2131.9161945042174
E1 = -183.5898163033392  E_coul = 55.08017974329823
init E= -128.509636560041
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402485446011  LUMO = 0.770285019657107
  mo_energy =
[-3.25551191e+01 -1.85273266e+00 -7.75402485e-01 -7.75402485e-01
 -7.75402485e-01  7.70285020e-01  8.25572188e-01  8.25572188e-01
  8.25572188e-01  3.95034560e+00  3.96310507e+00  3.96310507e+00
  3.96310507e+00  1.23581353e+01  1.43714230e+01  1.43714230e+01
  1.43714230e+01  4.11423154e+01  5.30189795e+01  5.30189795e+01
  5.30189795e+01  1.44908141e+02  2.40841525e+02  2.40841525e+02
  2.40841525e+02  5.07540265e+02  1.87374678e+03  8.00272370e+03
  4.77699220e+04]
E1 = -182.086177489786  E_coul = 53.54796840530514
cycle= 1 E= -128.538209084481  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518711
diis-c [-0.26906092  1.        ]
  HOMO = -0.88429220564415  LUMO = 0.742759094513591
  mo_energy =
[-3.28782959e+01 -1.96660305e+00 -8.84292206e-01 -8.84292206e-01
 -8.84292206e-01  7.42759095e-01  7.98740908e-01  7.98740908e-01
  7.98740908e-01  3.86555923e+00  3.86555923e+00  3.86555923e+00
  3.87786615e+00  1.22149244e+01  1.41806916e+01  1.41806916e+01
  1.41806916e+01  4.08972508e+01  5.27380410e+01  5.27380410e+01
  5.27380410e+01  1.44591664e+02  2.40495229e+02  2.40495229e+02
  2.40495229e+02  5.07179058e+02  1.87334925e+03  8.00229702e+03
  4.77694764e+04]
E1 = -182.84744937970112  E_coul = 54.306653360183894
cycle= 2 E= -128.540796019517  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263423
diis-c [-0.00066472  0.33600235  0.66399765]
  HOMO = -0.848666847338164  LUMO = 0.751574294176141
  mo_energy =
[-3.27702043e+01 -1.92909006e+00 -8.48666847e-01 -8.48666847e-01
 -8.48666847e-01  7.51574294e-01  8.07491371e-01  8.07491371e-01
  8.07491371e-01  3.89720758e+00  3.89720758e+00  3.89720758e+00
  3.90128074e+00  1.22619481e+01  1.42438813e+01  1.42438813e+01
  1.42438813e+01  4.09793133e+01  5.28320510e+01  5.28320510e+01
  5.28320510e+01  1.44697246e+02  2.40608891e+02  2.40608891e+02
  2.40608891e+02  5.07295763e+02  1.87347129e+03  8.00242152e+03
  4.77696019e+04]
E1 = -182.5888296901947  E_coul = 54.04711405263792
cycle= 3 E= -128.541715637557  delta_E= -0.00092  |g|= 0.000529  |ddm|= 0.0217
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00118531
diis-c [-2.02057519e-07 -2.35584729e-03 -4.69329134e-04  1.00282518e+00]
  HOMO = -0.848932103348948  LUMO = 0.751521779760066
  mo_energy =
[-3.27706844e+01 -1.92929156e+00 -8.48932103e-01 -8.48932103e-01
 -8.48932103e-01  7.51521780e-01  8.07449140e-01  8.07449140e-01
  8.07449140e-01  3.89702240e+00  3.89702240e+00  3.89702240e+00
  3.90114476e+00  1.22616966e+01  1.42435620e+01  1.42435620e+01
  1.42435620e+01  4.09789407e+01  5.28316272e+01  5.28316272e+01
  5.28316272e+01  1.44696765e+02  2.40608339e+02  2.40608339e+02
  2.40608339e+02  5.07295153e+02  1.87347055e+03  8.00242068e+03
  4.77696010e+04]
E1 = -182.5893249105397  E_coul = 54.04760924558318
cycle= 4 E= -128.541715664957  delta_E= -2.74e-08  |g|= 8.02e-05  |ddm|= 0.000403
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185619
diis-c [-1.07287970e-09  2.37961935e-04  4.61909626e-04 -1.84684965e-01
  1.18398509e+00]
  HOMO = -0.848975226093331  LUMO = 0.751509265285742
  mo_energy =
[-3.27707574e+01 -1.92932421e+00 -8.48975226e-01 -8.48975226e-01
 -8.48975226e-01  7.51509265e-01  8.07435652e-01  8.07435652e-01
  8.07435652e-01  3.89698218e+00  3.89698218e+00  3.89698218e+00
  3.90111582e+00  1.22616476e+01  1.42435025e+01  1.42435025e+01
  1.42435025e+01  4.09788759e+01  5.28315582e+01  5.28315582e+01
  5.28315582e+01  1.44696692e+02  2.40608262e+02  2.40608262e+02
  2.40608262e+02  5.07295072e+02  1.87347046e+03  8.00242058e+03
  4.77696009e+04]
E1 = -182.5894565524202  E_coul = 54.047740886745224
cycle= 5 E= -128.541715665675  delta_E= -7.18e-10  |g|= 5.83e-06  |ddm|= 6.88e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5894565524202  E_coul = 54.047740886745224
  HOMO = -0.848972168420405  LUMO = 0.751510503228359
  mo_energy =
[-3.27707505e+01 -1.92932036e+00 -8.48972168e-01 -8.48972168e-01
 -8.48972168e-01  7.51510503e-01  8.07436551e-01  8.07436551e-01
  8.07436551e-01  3.89698511e+00  3.89698511e+00  3.89698511e+00
  3.90111839e+00  1.22616518e+01  1.42435076e+01  1.42435076e+01
  1.42435076e+01  4.09788819e+01  5.28315646e+01  5.28315646e+01
  5.28315646e+01  1.44696699e+02  2.40608268e+02  2.40608268e+02
  2.40608268e+02  5.07295078e+02  1.87347046e+03  8.00242059e+03
  4.77696009e+04]
E1 = -182.58944089967636  E_coul = 54.047725233998804
Extra cycle  E= -128.541715665678  delta_E= -2.59e-12  |g|= 2.2e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2131.9161945042174
E1 = -182.58944089967636  E_coul = 54.047725233998804
init E= -128.541715665678
    CPU time for initialize scf      0.39 sec, wall time      0.39 sec
  HOMO = -0.848973276486524  LUMO = 0.751510307080672
  mo_energy =
[-3.27707540e+01 -1.92932139e+00 -8.48973276e-01 -8.48973276e-01
 -8.48973276e-01  7.51510307e-01  8.07436297e-01  8.07436297e-01
  8.07436297e-01  3.89698415e+00  3.89698415e+00  3.89698415e+00
  3.90111774e+00  1.22616504e+01  1.42435056e+01  1.42435056e+01
  1.42435056e+01  4.09788794e+01  5.28315616e+01  5.28315616e+01
  5.28315616e+01  1.44696695e+02  2.40608264e+02  2.40608264e+02
  2.40608264e+02  5.07295074e+02  1.87347046e+03  8.00242058e+03
  4.77696009e+04]
E1 = -182.58944958543458  E_coul = 54.04773391975688
cycle= 1 E= -128.541715665678  delta_E= -1.71e-13  |g|= 1.19e-06  |ddm|= 7.91e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58944958543458  E_coul = 54.04773391975688
  HOMO = -0.848972665142363  LUMO = 0.751510474003619
  mo_energy =
[-3.27707522e+01 -1.92932071e+00 -8.48972665e-01 -8.48972665e-01
 -8.48972665e-01  7.51510474e-01  8.07436451e-01  8.07436451e-01
  8.07436451e-01  3.89698470e+00  3.89698470e+00  3.89698470e+00
  3.90111817e+00  1.22616512e+01  1.42435067e+01  1.42435067e+01
  1.42435067e+01  4.09788808e+01  5.28315632e+01  5.28315632e+01
  5.28315632e+01  1.44696697e+02  2.40608266e+02  2.40608266e+02
  2.40608266e+02  5.07295076e+02  1.87347046e+03  8.00242059e+03
  4.77696009e+04]
E1 = -182.5894452197916  E_coul = 54.047729554113566
Extra cycle  E= -128.541715665678  delta_E= -3.13e-13  |g|= 5.93e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.46 sec, wall time      0.45 sec
exp = [7.80811850e-01 2.44137942e+04 3.66145159e+03 8.33319012e+02
 2.35444464e+02 7.61141077e+01 1.02680090e+01 2.69634845e+01
 3.08013556e-01 1.77121130e+00 2.96557667e+00 7.11363982e+00
 2.31698561e+01 9.97863830e+01 2.66480917e-01 2.44415781e+00
 8.35344213e-01]
grad_E = [-7.17439722e-05  6.50149794e-10 -3.31382374e-08  6.20200024e-07
 -7.14668730e-06  6.37868299e-05  7.98918354e-05 -2.40762904e-04
  3.32234828e-04 -9.38921027e-07 -1.48426382e-04 -5.04385612e-05
  6.07296014e-06 -1.75479191e-07 -6.04749009e-06  8.86608940e-05
  7.78230567e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.781936648866       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158976        1
[INPUT] 0    0    [1    /1   ]  833.319004077        1
[INPUT] 0    0    [1    /1   ]  235.444548299        1
[INPUT] 0    0    [1    /1   ]  76.1133216503        1
[INPUT] 0    0    [1    /1   ]  10.2733796011        1
[INPUT] 0    0    [1    /1   ]  26.9657104387        1
[INPUT] 0    0    [1    /1   ]  0.308348815788       1
[INPUT] 0    0    [1    /1   ]  1.76195090027        1
[INPUT] 0    0    [1    /1   ]  2.96898160626        1
[INPUT] 1    0    [1    /1   ]  7.11426350828        1
[INPUT] 1    0    [1    /1   ]  23.1697058734        1
[INPUT] 1    0    [1    /1   ]  99.7863891679        1
[INPUT] 1    0    [1    /1   ]  0.266311248938       1
[INPUT] 1    0    [1    /1   ]  2.443842212          1
[INPUT] 1    0    [1    /1   ]  0.834923923099       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7819366488658709, 1.0]], [0, [24413.794186163217, 1.0]], [0, [3661.4515897627184, 1.0]], [0, [833.3190040771103, 1.0]], [0, [235.4445482994559, 1.0]], [0, [76.11332165034854, 1.0]], [0, [10.273379601108276, 1.0]], [0, [26.965710438710268, 1.0]], [0, [0.30834881578778506, 1.0]], [0, [1.7619509002659413, 1.0]], [0, [2.968981606258708, 1.0]], [1, [7.114263508279947, 1.0]], [1, [23.169705873391052, 1.0]], [1, [99.78638916794436, 1.0]], [1, [0.2663112489383122, 1.0]], [1, [2.4438422120013525, 1.0]], [1, [0.8349239230990106, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78193665]
bas 1, expnt(s) = [24413.79418616]
bas 2, expnt(s) = [3661.45158976]
bas 3, expnt(s) = [833.31900408]
bas 4, expnt(s) = [235.4445483]
bas 5, expnt(s) = [76.11332165]
bas 6, expnt(s) = [10.2733796]
bas 7, expnt(s) = [26.96571044]
bas 8, expnt(s) = [0.30834882]
bas 9, expnt(s) = [1.7619509]
bas 10, expnt(s) = [2.96898161]
bas 11, expnt(s) = [7.11426351]
bas 12, expnt(s) = [23.16970587]
bas 13, expnt(s) = [99.78638917]
bas 14, expnt(s) = [0.26631125]
bas 15, expnt(s) = [2.44384221]
bas 16, expnt(s) = [0.83492392]
CPU time:       141.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.81936649e-01 2.10084350e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319004e+02 3.91853282e+02
 2.35444548e+02 1.51855842e+02 7.61133217e+01 6.51044285e+01
 1.02733796e+01 1.44977306e+01 2.69657104e+01 2.98967462e+01
 3.08348816e-01 1.04543428e+00 1.76195090e+00 3.86376208e+00
 2.96898161e+00 5.71440023e+00 7.11426351e+00 3.38958732e+01
 2.31697059e+01 1.48297914e+02 9.97863892e+01 9.20075629e+02
 2.66311249e-01 5.58111899e-01 2.44384221e+00 8.91406600e+00
 8.34923923e-01 2.32832190e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999635240357303
cond(S) = 2109.5060935918664
E1 = -183.58981463698063  E_coul = 55.080188519358956
init E= -128.509626117622
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775402127357493  LUMO = 0.771004730243343
  mo_energy =
[-3.25551160e+01 -1.85273303e+00 -7.75402127e-01 -7.75402127e-01
 -7.75402127e-01  7.71004730e-01  8.24980500e-01  8.24980500e-01
  8.24980500e-01  3.94834544e+00  3.96120617e+00  3.96120617e+00
  3.96120617e+00  1.23461532e+01  1.43690571e+01  1.43690571e+01
  1.43690571e+01  4.11335675e+01  5.30178150e+01  5.30178150e+01
  5.30178150e+01  1.44913438e+02  2.40840938e+02  2.40840938e+02
  2.40840938e+02  5.07550617e+02  1.87375704e+03  8.00273292e+03
  4.77699297e+04]
E1 = -182.08600802929007  E_coul = 53.547799272032506
cycle= 1 E= -128.538208757258  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518708
diis-c [-0.26905747  1.        ]
  HOMO = -0.88430729357499  LUMO = 0.743458115338562
  mo_energy =
[-3.28783186e+01 -1.96662001e+00 -8.84307294e-01 -8.84307294e-01
 -8.84307294e-01  7.43458115e-01  7.98164894e-01  7.98164894e-01
  7.98164894e-01  3.86366553e+00  3.86366553e+00  3.86366553e+00
  3.87593807e+00  1.22029875e+01  1.41782950e+01  1.41782950e+01
  1.41782950e+01  4.08884511e+01  5.27368468e+01  5.27368468e+01
  5.27368468e+01  1.44596929e+02  2.40494620e+02  2.40494620e+02
  2.40494620e+02  5.07189385e+02  1.87335948e+03  8.00230621e+03
  4.77694841e+04]
E1 = -182.84738346022726  E_coul = 54.30658729183301
cycle= 2 E= -128.540796168394  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263432
diis-c [-0.00066477  0.33601147  0.66398853]
  HOMO = -0.848677474660131  LUMO = 0.752279047160638
  mo_energy =
[-3.27702144e+01 -1.92910213e+00 -8.48677475e-01 -8.48677475e-01
 -8.48677475e-01  7.52279047e-01  8.06909426e-01  8.06909426e-01
  8.06909426e-01  3.89531195e+00  3.89531195e+00  3.89531195e+00
  3.89932791e+00  1.22499951e+01  1.42414952e+01  1.42414952e+01
  1.42414952e+01  4.09705324e+01  5.28308691e+01  5.28308691e+01
  5.28308691e+01  1.44702526e+02  2.40608296e+02  2.40608296e+02
  2.40608296e+02  5.07306104e+02  1.87348154e+03  8.00243074e+03
  4.77696095e+04]
E1 = -182.5887158532031  E_coul = 54.04699978658719
cycle= 3 E= -128.541716066616  delta_E= -0.00092  |g|= 0.000531  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.0011864
diis-c [-2.02067101e-07 -2.35676514e-03 -4.66610080e-04  1.00282338e+00]
  HOMO = -0.848943210944907  LUMO = 0.752226247141076
  mo_energy =
[-3.27706953e+01 -1.92930410e+00 -8.48943211e-01 -8.48943211e-01
 -8.48943211e-01  7.52226247e-01  8.06867030e-01  8.06867030e-01
  8.06867030e-01  3.89512637e+00  3.89512637e+00  3.89512637e+00
  3.89919162e+00  1.22497432e+01  1.42411752e+01  1.42411752e+01
  1.42411752e+01  4.09701592e+01  5.28304446e+01  5.28304446e+01
  5.28304446e+01  1.44702044e+02  2.40607743e+02  2.40607743e+02
  2.40607743e+02  5.07305494e+02  1.87348079e+03  8.00242989e+03
  4.77696086e+04]
E1 = -182.58921100384617  E_coul = 54.04749490967696
cycle= 4 E= -128.541716094169  delta_E= -2.76e-08  |g|= 8.04e-05  |ddm|= 0.000407
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185867
diis-c [-1.07341010e-09  2.37719725e-04  4.62243301e-04 -1.84578429e-01
  1.18387847e+00]
  HOMO = -0.848986441938724  LUMO = 0.75221367298145
  mo_energy =
[-3.27707684e+01 -1.92933686e+00 -8.48986442e-01 -8.48986442e-01
 -8.48986442e-01  7.52213673e-01  8.06853509e-01  8.06853509e-01
  8.06853509e-01  3.89508606e+00  3.89508606e+00  3.89508606e+00
  3.89916261e+00  1.22496940e+01  1.42411156e+01  1.42411156e+01
  1.42411156e+01  4.09700942e+01  5.28303755e+01  5.28303755e+01
  5.28303755e+01  1.44701971e+02  2.40607665e+02  2.40607665e+02
  2.40607665e+02  5.07305412e+02  1.87348071e+03  8.00242979e+03
  4.77696085e+04]
E1 = -182.58934274928197  E_coul = 54.047626654391316
cycle= 5 E= -128.541716094891  delta_E= -7.21e-10  |g|= 5.82e-06  |ddm|= 6.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.58934274928197  E_coul = 54.047626654391316
  HOMO = -0.848983388170158  LUMO = 0.752214910568099
  mo_energy =
[-3.27707615e+01 -1.92933302e+00 -8.48983388e-01 -8.48983388e-01
 -8.48983388e-01  7.52214911e-01  8.06854407e-01  8.06854407e-01
  8.06854407e-01  3.89508898e+00  3.89508898e+00  3.89508898e+00
  3.89916517e+00  1.22496983e+01  1.42411206e+01  1.42411206e+01
  1.42411206e+01  4.09701003e+01  5.28303819e+01  5.28303819e+01
  5.28303819e+01  1.44701978e+02  2.40607672e+02  2.40607672e+02
  2.40607672e+02  5.07305419e+02  1.87348071e+03  8.00242980e+03
  4.77696085e+04]
E1 = -182.58932711797573  E_coul = 54.047611023082844
Extra cycle  E= -128.541716094893  delta_E= -2.22e-12  |g|= 2.2e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.14 sec
exp = [7.81936649e-01 2.44137942e+04 3.66145159e+03 8.33319004e+02
 2.35444548e+02 7.61133217e+01 1.02733796e+01 2.69657104e+01
 3.08348816e-01 1.76195090e+00 2.96898161e+00 7.11426351e+00
 2.31697059e+01 9.97863892e+01 2.66311249e-01 2.44384221e+00
 8.34923923e-01]
E = -128.54171609489288
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.781936648866       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45158976        1
[INPUT] 0    0    [1    /1   ]  833.319004077        1
[INPUT] 0    0    [1    /1   ]  235.444548299        1
[INPUT] 0    0    [1    /1   ]  76.1133216503        1
[INPUT] 0    0    [1    /1   ]  10.2733796011        1
[INPUT] 0    0    [1    /1   ]  26.9657104387        1
[INPUT] 0    0    [1    /1   ]  0.308348815788       1
[INPUT] 0    0    [1    /1   ]  1.76195090027        1
[INPUT] 0    0    [1    /1   ]  2.96898160626        1
[INPUT] 1    0    [1    /1   ]  7.11426350828        1
[INPUT] 1    0    [1    /1   ]  23.1697058734        1
[INPUT] 1    0    [1    /1   ]  99.7863891679        1
[INPUT] 1    0    [1    /1   ]  0.266311248938       1
[INPUT] 1    0    [1    /1   ]  2.443842212          1
[INPUT] 1    0    [1    /1   ]  0.834923923099       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7819366488658709, 1.0]], [0, [24413.794186163217, 1.0]], [0, [3661.4515897627184, 1.0]], [0, [833.3190040771103, 1.0]], [0, [235.4445482994559, 1.0]], [0, [76.11332165034854, 1.0]], [0, [10.273379601108276, 1.0]], [0, [26.965710438710268, 1.0]], [0, [0.30834881578778506, 1.0]], [0, [1.7619509002659413, 1.0]], [0, [2.968981606258708, 1.0]], [1, [7.114263508279947, 1.0]], [1, [23.169705873391052, 1.0]], [1, [99.78638916794436, 1.0]], [1, [0.2663112489383122, 1.0]], [1, [2.4438422120013525, 1.0]], [1, [0.8349239230990106, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78193665]
bas 1, expnt(s) = [24413.79418616]
bas 2, expnt(s) = [3661.45158976]
bas 3, expnt(s) = [833.31900408]
bas 4, expnt(s) = [235.4445483]
bas 5, expnt(s) = [76.11332165]
bas 6, expnt(s) = [10.2733796]
bas 7, expnt(s) = [26.96571044]
bas 8, expnt(s) = [0.30834882]
bas 9, expnt(s) = [1.7619509]
bas 10, expnt(s) = [2.96898161]
bas 11, expnt(s) = [7.11426351]
bas 12, expnt(s) = [23.16970587]
bas 13, expnt(s) = [99.78638917]
bas 14, expnt(s) = [0.26631125]
bas 15, expnt(s) = [2.44384221]
bas 16, expnt(s) = [0.83492392]
CPU time:       142.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.81936649e-01 2.10084350e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319004e+02 3.91853282e+02
 2.35444548e+02 1.51855842e+02 7.61133217e+01 6.51044285e+01
 1.02733796e+01 1.44977306e+01 2.69657104e+01 2.98967462e+01
 3.08348816e-01 1.04543428e+00 1.76195090e+00 3.86376208e+00
 2.96898161e+00 5.71440023e+00 7.11426351e+00 3.38958732e+01
 2.31697059e+01 1.48297914e+02 9.97863892e+01 9.20075629e+02
 2.66311249e-01 5.58111899e-01 2.44384221e+00 8.91406600e+00
 8.34923923e-01 2.32832190e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999635240357303
cond(S) = 2109.5060935918664
E1 = -183.58981463698063  E_coul = 55.080188519358956
init E= -128.509626117622
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402127357493  LUMO = 0.771004730243343
  mo_energy =
[-3.25551160e+01 -1.85273303e+00 -7.75402127e-01 -7.75402127e-01
 -7.75402127e-01  7.71004730e-01  8.24980500e-01  8.24980500e-01
  8.24980500e-01  3.94834544e+00  3.96120617e+00  3.96120617e+00
  3.96120617e+00  1.23461532e+01  1.43690571e+01  1.43690571e+01
  1.43690571e+01  4.11335675e+01  5.30178150e+01  5.30178150e+01
  5.30178150e+01  1.44913438e+02  2.40840938e+02  2.40840938e+02
  2.40840938e+02  5.07550617e+02  1.87375704e+03  8.00273292e+03
  4.77699297e+04]
E1 = -182.08600802929007  E_coul = 53.547799272032506
cycle= 1 E= -128.538208757258  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.147
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.518708
diis-c [-0.26905747  1.        ]
  HOMO = -0.88430729357499  LUMO = 0.743458115338562
  mo_energy =
[-3.28783186e+01 -1.96662001e+00 -8.84307294e-01 -8.84307294e-01
 -8.84307294e-01  7.43458115e-01  7.98164894e-01  7.98164894e-01
  7.98164894e-01  3.86366553e+00  3.86366553e+00  3.86366553e+00
  3.87593807e+00  1.22029875e+01  1.41782950e+01  1.41782950e+01
  1.41782950e+01  4.08884511e+01  5.27368468e+01  5.27368468e+01
  5.27368468e+01  1.44596929e+02  2.40494620e+02  2.40494620e+02
  2.40494620e+02  5.07189385e+02  1.87335948e+03  8.00230621e+03
  4.77694841e+04]
E1 = -182.84738346022726  E_coul = 54.30658729183301
cycle= 2 E= -128.540796168394  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263432
diis-c [-0.00066477  0.33601147  0.66398853]
  HOMO = -0.848677474660131  LUMO = 0.752279047160638
  mo_energy =
[-3.27702144e+01 -1.92910213e+00 -8.48677475e-01 -8.48677475e-01
 -8.48677475e-01  7.52279047e-01  8.06909426e-01  8.06909426e-01
  8.06909426e-01  3.89531195e+00  3.89531195e+00  3.89531195e+00
  3.89932791e+00  1.22499951e+01  1.42414952e+01  1.42414952e+01
  1.42414952e+01  4.09705324e+01  5.28308691e+01  5.28308691e+01
  5.28308691e+01  1.44702526e+02  2.40608296e+02  2.40608296e+02
  2.40608296e+02  5.07306104e+02  1.87348154e+03  8.00243074e+03
  4.77696095e+04]
E1 = -182.5887158532031  E_coul = 54.04699978658719
cycle= 3 E= -128.541716066616  delta_E= -0.00092  |g|= 0.000531  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.0011864
diis-c [-2.02067101e-07 -2.35676514e-03 -4.66610080e-04  1.00282338e+00]
  HOMO = -0.848943210944907  LUMO = 0.752226247141076
  mo_energy =
[-3.27706953e+01 -1.92930410e+00 -8.48943211e-01 -8.48943211e-01
 -8.48943211e-01  7.52226247e-01  8.06867030e-01  8.06867030e-01
  8.06867030e-01  3.89512637e+00  3.89512637e+00  3.89512637e+00
  3.89919162e+00  1.22497432e+01  1.42411752e+01  1.42411752e+01
  1.42411752e+01  4.09701592e+01  5.28304446e+01  5.28304446e+01
  5.28304446e+01  1.44702044e+02  2.40607743e+02  2.40607743e+02
  2.40607743e+02  5.07305494e+02  1.87348079e+03  8.00242989e+03
  4.77696086e+04]
E1 = -182.58921100384617  E_coul = 54.04749490967696
cycle= 4 E= -128.541716094169  delta_E= -2.76e-08  |g|= 8.04e-05  |ddm|= 0.000407
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185867
diis-c [-1.07341010e-09  2.37719725e-04  4.62243301e-04 -1.84578429e-01
  1.18387847e+00]
  HOMO = -0.848986441938724  LUMO = 0.75221367298145
  mo_energy =
[-3.27707684e+01 -1.92933686e+00 -8.48986442e-01 -8.48986442e-01
 -8.48986442e-01  7.52213673e-01  8.06853509e-01  8.06853509e-01
  8.06853509e-01  3.89508606e+00  3.89508606e+00  3.89508606e+00
  3.89916261e+00  1.22496940e+01  1.42411156e+01  1.42411156e+01
  1.42411156e+01  4.09700942e+01  5.28303755e+01  5.28303755e+01
  5.28303755e+01  1.44701971e+02  2.40607665e+02  2.40607665e+02
  2.40607665e+02  5.07305412e+02  1.87348071e+03  8.00242979e+03
  4.77696085e+04]
E1 = -182.58934274928197  E_coul = 54.047626654391316
cycle= 5 E= -128.541716094891  delta_E= -7.21e-10  |g|= 5.82e-06  |ddm|= 6.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58934274928197  E_coul = 54.047626654391316
  HOMO = -0.848983388170158  LUMO = 0.752214910568099
  mo_energy =
[-3.27707615e+01 -1.92933302e+00 -8.48983388e-01 -8.48983388e-01
 -8.48983388e-01  7.52214911e-01  8.06854407e-01  8.06854407e-01
  8.06854407e-01  3.89508898e+00  3.89508898e+00  3.89508898e+00
  3.89916517e+00  1.22496983e+01  1.42411206e+01  1.42411206e+01
  1.42411206e+01  4.09701003e+01  5.28303819e+01  5.28303819e+01
  5.28303819e+01  1.44701978e+02  2.40607672e+02  2.40607672e+02
  2.40607672e+02  5.07305419e+02  1.87348071e+03  8.00242980e+03
  4.77696085e+04]
E1 = -182.58932711797573  E_coul = 54.047611023082844
Extra cycle  E= -128.541716094893  delta_E= -2.22e-12  |g|= 2.2e-06  |ddm|= 1.99e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2109.5060935918664
E1 = -182.58932711797573  E_coul = 54.047611023082844
init E= -128.541716094893
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848984494744229  LUMO = 0.75221471472032
  mo_energy =
[-3.27707650e+01 -1.92933404e+00 -8.48984495e-01 -8.48984495e-01
 -8.48984495e-01  7.52214715e-01  8.06854153e-01  8.06854153e-01
  8.06854153e-01  3.89508802e+00  3.89508802e+00  3.89508802e+00
  3.89916453e+00  1.22496969e+01  1.42411186e+01  1.42411186e+01
  1.42411186e+01  4.09700977e+01  5.28303789e+01  5.28303789e+01
  5.28303789e+01  1.44701975e+02  2.40607668e+02  2.40607668e+02
  2.40607668e+02  5.07305415e+02  1.87348071e+03  8.00242979e+03
  4.77696085e+04]
E1 = -182.58933579377194  E_coul = 54.047619698878535
cycle= 1 E= -128.541716094893  delta_E= -5.12e-13  |g|= 1.19e-06  |ddm|= 7.9e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58933579377194  E_coul = 54.047619698878535
  HOMO = -0.848983884098052  LUMO = 0.75221488157241
  mo_energy =
[-3.27707632e+01 -1.92933337e+00 -8.48983884e-01 -8.48983884e-01
 -8.48983884e-01  7.52214882e-01  8.06854307e-01  8.06854307e-01
  8.06854307e-01  3.89508857e+00  3.89508857e+00  3.89508857e+00
  3.89916495e+00  1.22496977e+01  1.42411197e+01  1.42411197e+01
  1.42411197e+01  4.09700991e+01  5.28303805e+01  5.28303805e+01
  5.28303805e+01  1.44701976e+02  2.40607670e+02  2.40607670e+02
  2.40607670e+02  5.07305417e+02  1.87348071e+03  8.00242980e+03
  4.77696085e+04]
E1 = -182.58933143319047  E_coul = 54.04761533829674
Extra cycle  E= -128.541716094894  delta_E= -3.41e-13  |g|= 5.92e-07  |ddm|= 3.71e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.41 sec
exp = [7.81936649e-01 2.44137942e+04 3.66145159e+03 8.33319004e+02
 2.35444548e+02 7.61133217e+01 1.02733796e+01 2.69657104e+01
 3.08348816e-01 1.76195090e+00 2.96898161e+00 7.11426351e+00
 2.31697059e+01 9.97863892e+01 2.66311249e-01 2.44384221e+00
 8.34923923e-01]
grad_E = [ 6.44895954e-05  6.66460885e-10 -3.39992514e-08  6.37954600e-07
 -7.37669724e-06  6.58652168e-05  1.06009623e-04 -2.52009760e-04
  1.24744027e-04 -3.69959436e-05 -1.47955539e-04 -4.26957577e-05
  4.44241572e-06 -1.04284191e-07 -6.66293138e-05  1.01644522e-04
  8.75297477e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.789364935305       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45159019        1
[INPUT] 0    0    [1    /1   ]  833.318998103        1
[INPUT] 0    0    [1    /1   ]  235.444594002        1
[INPUT] 0    0    [1    /1   ]  76.1127403986        1
[INPUT] 0    0    [1    /1   ]  10.2783925813        1
[INPUT] 0    0    [1    /1   ]  26.9668824399        1
[INPUT] 0    0    [1    /1   ]  0.309641464414       1
[INPUT] 0    0    [1    /1   ]  1.78252743943        1
[INPUT] 0    0    [1    /1   ]  2.97177177793        1
[INPUT] 1    0    [1    /1   ]  7.11449300985        1
[INPUT] 1    0    [1    /1   ]  23.1696681301        1
[INPUT] 1    0    [1    /1   ]  99.7863894304        1
[INPUT] 1    0    [1    /1   ]  0.266224176702       1
[INPUT] 1    0    [1    /1   ]  2.44320481731        1
[INPUT] 1    0    [1    /1   ]  0.834575182224       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7893649353048667, 1.0]], [0, [24413.794186154137, 1.0]], [0, [3661.451590190791, 1.0]], [0, [833.3189981034691, 1.0]], [0, [235.4445940019474, 1.0]], [0, [76.11274039861652, 1.0]], [0, [10.278392581341539, 1.0]], [0, [26.96688243985014, 1.0]], [0, [0.3096414644138901, 1.0]], [0, [1.782527439427171, 1.0]], [0, [2.9717717779316652, 1.0]], [1, [7.114493009854693, 1.0]], [1, [23.16966813014799, 1.0]], [1, [99.7863894304344, 1.0]], [1, [0.26622417670210885, 1.0]], [1, [2.443204817314248, 1.0]], [1, [0.8345751822242554, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78936494]
bas 1, expnt(s) = [24413.79418615]
bas 2, expnt(s) = [3661.45159019]
bas 3, expnt(s) = [833.3189981]
bas 4, expnt(s) = [235.444594]
bas 5, expnt(s) = [76.1127404]
bas 6, expnt(s) = [10.27839258]
bas 7, expnt(s) = [26.96688244]
bas 8, expnt(s) = [0.30964146]
bas 9, expnt(s) = [1.78252744]
bas 10, expnt(s) = [2.97177178]
bas 11, expnt(s) = [7.11449301]
bas 12, expnt(s) = [23.16966813]
bas 13, expnt(s) = [99.78638943]
bas 14, expnt(s) = [0.26622418]
bas 15, expnt(s) = [2.44320482]
bas 16, expnt(s) = [0.83457518]
CPU time:       145.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.89364935e-01 2.11579408e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33318998e+02 3.91853280e+02
 2.35444594e+02 1.51855864e+02 7.61127404e+01 6.51040556e+01
 1.02783926e+01 1.45030360e+01 2.69668824e+01 2.98977207e+01
 3.09641464e-01 1.04871954e+00 1.78252744e+00 3.89755446e+00
 2.97177178e+00 5.71842744e+00 7.11449301e+00 3.38972400e+01
 2.31696681e+01 1.48297612e+02 9.97863894e+01 9.20075632e+02
 2.66224177e-01 5.57883810e-01 2.44320482e+00 8.91115992e+00
 8.34575182e-01 2.32710632e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999635814247615
cond(S) = 2192.703900070941
E1 = -183.58981930292993  E_coul = 55.08019415179169
init E= -128.509625151138
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401871506856  LUMO = 0.777610614245984
  mo_energy =
[-3.25551153e+01 -1.85273202e+00 -7.75401872e-01 -7.75401872e-01
 -7.75401872e-01  7.77610614e-01  8.24637001e-01  8.24637001e-01
  8.24637001e-01  3.95962385e+00  3.95962385e+00  3.95962385e+00
  3.98558504e+00  1.24392627e+01  1.43660351e+01  1.43660351e+01
  1.43660351e+01  4.12739149e+01  5.30149709e+01  5.30149709e+01
  5.30149709e+01  1.45061564e+02  2.40838964e+02  2.40838964e+02
  2.40838964e+02  5.07688603e+02  1.87388119e+03  8.00284221e+03
  4.77700201e+04]
E1 = -182.08593302001995  E_coul = 53.54772432434756
cycle= 1 E= -128.538208695672  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518699
diis-c [-0.26904866  1.        ]
  HOMO = -0.884313614052348  LUMO = 0.749801876584499
  mo_energy =
[-3.28783319e+01 -1.96662555e+00 -8.84313614e-01 -8.84313614e-01
 -8.84313614e-01  7.49801877e-01  7.97833180e-01  7.97833180e-01
  7.97833180e-01  3.86210123e+00  3.86210123e+00  3.86210123e+00
  3.91266230e+00  1.22957243e+01  1.41752627e+01  1.41752627e+01
  1.41752627e+01  4.10287737e+01  5.27339867e+01  5.27339867e+01
  5.27339867e+01  1.44745064e+02  2.40492631e+02  2.40492631e+02
  2.40492631e+02  5.07327365e+02  1.87348362e+03  8.00241549e+03
  4.77695746e+04]
E1 = -182.84735440778294  E_coul = 54.30655806211437
cycle= 2 E= -128.540796345669  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26343
diis-c [-0.00066545  0.3360124   0.6639876 ]
  HOMO = -0.848681650367049  LUMO = 0.758706849478778
  mo_energy =
[-3.27702216e+01 -1.92910525e+00 -8.48681650e-01 -8.48681650e-01
 -8.48681650e-01  7.58706849e-01  8.06573586e-01  8.06573586e-01
  8.06573586e-01  3.89374188e+00  3.89374188e+00  3.89374188e+00
  3.93622069e+00  1.23428572e+01  1.42384662e+01  1.42384662e+01
  1.42384662e+01  4.11108630e+01  5.28280154e+01  5.28280154e+01
  5.28280154e+01  1.44850659e+02  2.40606313e+02  2.40606313e+02
  2.40606313e+02  5.07444087e+02  1.87360569e+03  8.00254002e+03
  4.77697000e+04]
E1 = -182.58866662144825  E_coul = 54.046950260770906
cycle= 3 E= -128.541716360677  delta_E= -0.00092  |g|= 0.000531  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118749
diis-c [-2.01767967e-07 -2.35660489e-03 -4.61157579e-04  1.00281776e+00]
  HOMO = -0.848947619258999  LUMO = 0.75865352323685
  mo_energy =
[-3.27707029e+01 -1.92930743e+00 -8.48947619e-01 -8.48947619e-01
 -8.48947619e-01  7.58653523e-01  8.06531147e-01  8.06531147e-01
  8.06531147e-01  3.89355612e+00  3.89355612e+00  3.89355612e+00
  3.93608328e+00  1.23426044e+01  1.42381459e+01  1.42381459e+01
  1.42381459e+01  4.11104893e+01  5.28275905e+01  5.28275905e+01
  5.28275905e+01  1.44850177e+02  2.40605760e+02  2.40605760e+02
  2.40605760e+02  5.07443476e+02  1.87360494e+03  8.00253917e+03
  4.77696991e+04]
E1 = -182.5891624848212  E_coul = 54.047446096547574
cycle= 4 E= -128.541716388274  delta_E= -2.76e-08  |g|= 8.05e-05  |ddm|= 0.000411
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186057
diis-c [-1.07427774e-09  2.37550599e-04  4.62374832e-04 -1.84486992e-01
  1.18378707e+00]
  HOMO = -0.848990887547568  LUMO = 0.75864083763419
  mo_energy =
[-3.27707762e+01 -1.92934022e+00 -8.48990888e-01 -8.48990888e-01
 -8.48990888e-01  7.58640838e-01  8.06517626e-01  8.06517626e-01
  8.06517626e-01  3.89351577e+00  3.89351577e+00  3.89351577e+00
  3.93605406e+00  1.23425551e+01  1.42380862e+01  1.42380862e+01
  1.42380862e+01  4.11104242e+01  5.28275213e+01  5.28275213e+01
  5.28275213e+01  1.44850104e+02  2.40605682e+02  2.40605682e+02
  2.40605682e+02  5.07443395e+02  1.87360485e+03  8.00253907e+03
  4.77696990e+04]
E1 = -182.58929443611152  E_coul = 54.047578047115984
cycle= 5 E= -128.541716388996  delta_E= -7.22e-10  |g|= 5.82e-06  |ddm|= 6.97e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.58929443611152  E_coul = 54.047578047115984
  HOMO = -0.848987833575042  LUMO = 0.758642085755657
  mo_energy =
[-3.27707693e+01 -1.92933638e+00 -8.48987834e-01 -8.48987834e-01
 -8.48987834e-01  7.58642086e-01  8.06518524e-01  8.06518524e-01
  8.06518524e-01  3.89351869e+00  3.89351869e+00  3.89351869e+00
  3.93605663e+00  1.23425594e+01  1.42380913e+01  1.42380913e+01
  1.42380913e+01  4.11104303e+01  5.28275277e+01  5.28275277e+01
  5.28275277e+01  1.44850111e+02  2.40605689e+02  2.40605689e+02
  2.40605689e+02  5.07443401e+02  1.87360486e+03  8.00253908e+03
  4.77696990e+04]
E1 = -182.5892788168702  E_coul = 54.04756242787215
Extra cycle  E= -128.541716388998  delta_E= -2.53e-12  |g|= 2.2e-06  |ddm|= 2e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.89364935e-01 2.44137942e+04 3.66145159e+03 8.33318998e+02
 2.35444594e+02 7.61127404e+01 1.02783926e+01 2.69668824e+01
 3.09641464e-01 1.78252744e+00 2.97177178e+00 7.11449301e+00
 2.31696681e+01 9.97863894e+01 2.66224177e-01 2.44320482e+00
 8.34575182e-01]
E = -128.54171638899805
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.789364935305       1
[INPUT] 0    0    [1    /1   ]  24413.7941862        1
[INPUT] 0    0    [1    /1   ]  3661.45159019        1
[INPUT] 0    0    [1    /1   ]  833.318998103        1
[INPUT] 0    0    [1    /1   ]  235.444594002        1
[INPUT] 0    0    [1    /1   ]  76.1127403986        1
[INPUT] 0    0    [1    /1   ]  10.2783925813        1
[INPUT] 0    0    [1    /1   ]  26.9668824399        1
[INPUT] 0    0    [1    /1   ]  0.309641464414       1
[INPUT] 0    0    [1    /1   ]  1.78252743943        1
[INPUT] 0    0    [1    /1   ]  2.97177177793        1
[INPUT] 1    0    [1    /1   ]  7.11449300985        1
[INPUT] 1    0    [1    /1   ]  23.1696681301        1
[INPUT] 1    0    [1    /1   ]  99.7863894304        1
[INPUT] 1    0    [1    /1   ]  0.266224176702       1
[INPUT] 1    0    [1    /1   ]  2.44320481731        1
[INPUT] 1    0    [1    /1   ]  0.834575182224       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7893649353048667, 1.0]], [0, [24413.794186154137, 1.0]], [0, [3661.451590190791, 1.0]], [0, [833.3189981034691, 1.0]], [0, [235.4445940019474, 1.0]], [0, [76.11274039861652, 1.0]], [0, [10.278392581341539, 1.0]], [0, [26.96688243985014, 1.0]], [0, [0.3096414644138901, 1.0]], [0, [1.782527439427171, 1.0]], [0, [2.9717717779316652, 1.0]], [1, [7.114493009854693, 1.0]], [1, [23.16966813014799, 1.0]], [1, [99.7863894304344, 1.0]], [1, [0.26622417670210885, 1.0]], [1, [2.443204817314248, 1.0]], [1, [0.8345751822242554, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78936494]
bas 1, expnt(s) = [24413.79418615]
bas 2, expnt(s) = [3661.45159019]
bas 3, expnt(s) = [833.3189981]
bas 4, expnt(s) = [235.444594]
bas 5, expnt(s) = [76.1127404]
bas 6, expnt(s) = [10.27839258]
bas 7, expnt(s) = [26.96688244]
bas 8, expnt(s) = [0.30964146]
bas 9, expnt(s) = [1.78252744]
bas 10, expnt(s) = [2.97177178]
bas 11, expnt(s) = [7.11449301]
bas 12, expnt(s) = [23.16966813]
bas 13, expnt(s) = [99.78638943]
bas 14, expnt(s) = [0.26622418]
bas 15, expnt(s) = [2.44320482]
bas 16, expnt(s) = [0.83457518]
CPU time:       146.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.89364935e-01 2.11579408e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33318998e+02 3.91853280e+02
 2.35444594e+02 1.51855864e+02 7.61127404e+01 6.51040556e+01
 1.02783926e+01 1.45030360e+01 2.69668824e+01 2.98977207e+01
 3.09641464e-01 1.04871954e+00 1.78252744e+00 3.89755446e+00
 2.97177178e+00 5.71842744e+00 7.11449301e+00 3.38972400e+01
 2.31696681e+01 1.48297612e+02 9.97863894e+01 9.20075632e+02
 2.66224177e-01 5.57883810e-01 2.44320482e+00 8.91115992e+00
 8.34575182e-01 2.32710632e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999635814247615
cond(S) = 2192.703900070941
E1 = -183.58981930292993  E_coul = 55.08019415179169
init E= -128.509625151138
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401871506856  LUMO = 0.777610614245984
  mo_energy =
[-3.25551153e+01 -1.85273202e+00 -7.75401872e-01 -7.75401872e-01
 -7.75401872e-01  7.77610614e-01  8.24637001e-01  8.24637001e-01
  8.24637001e-01  3.95962385e+00  3.95962385e+00  3.95962385e+00
  3.98558504e+00  1.24392627e+01  1.43660351e+01  1.43660351e+01
  1.43660351e+01  4.12739149e+01  5.30149709e+01  5.30149709e+01
  5.30149709e+01  1.45061564e+02  2.40838964e+02  2.40838964e+02
  2.40838964e+02  5.07688603e+02  1.87388119e+03  8.00284221e+03
  4.77700201e+04]
E1 = -182.08593302001995  E_coul = 53.54772432434756
cycle= 1 E= -128.538208695672  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518699
diis-c [-0.26904866  1.        ]
  HOMO = -0.884313614052348  LUMO = 0.749801876584499
  mo_energy =
[-3.28783319e+01 -1.96662555e+00 -8.84313614e-01 -8.84313614e-01
 -8.84313614e-01  7.49801877e-01  7.97833180e-01  7.97833180e-01
  7.97833180e-01  3.86210123e+00  3.86210123e+00  3.86210123e+00
  3.91266230e+00  1.22957243e+01  1.41752627e+01  1.41752627e+01
  1.41752627e+01  4.10287737e+01  5.27339867e+01  5.27339867e+01
  5.27339867e+01  1.44745064e+02  2.40492631e+02  2.40492631e+02
  2.40492631e+02  5.07327365e+02  1.87348362e+03  8.00241549e+03
  4.77695746e+04]
E1 = -182.84735440778294  E_coul = 54.30655806211437
cycle= 2 E= -128.540796345669  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.26343
diis-c [-0.00066545  0.3360124   0.6639876 ]
  HOMO = -0.848681650367049  LUMO = 0.758706849478778
  mo_energy =
[-3.27702216e+01 -1.92910525e+00 -8.48681650e-01 -8.48681650e-01
 -8.48681650e-01  7.58706849e-01  8.06573586e-01  8.06573586e-01
  8.06573586e-01  3.89374188e+00  3.89374188e+00  3.89374188e+00
  3.93622069e+00  1.23428572e+01  1.42384662e+01  1.42384662e+01
  1.42384662e+01  4.11108630e+01  5.28280154e+01  5.28280154e+01
  5.28280154e+01  1.44850659e+02  2.40606313e+02  2.40606313e+02
  2.40606313e+02  5.07444087e+02  1.87360569e+03  8.00254002e+03
  4.77697000e+04]
E1 = -182.58866662144825  E_coul = 54.046950260770906
cycle= 3 E= -128.541716360677  delta_E= -0.00092  |g|= 0.000531  |ddm|= 0.0217
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118749
diis-c [-2.01767967e-07 -2.35660489e-03 -4.61157579e-04  1.00281776e+00]
  HOMO = -0.848947619258999  LUMO = 0.75865352323685
  mo_energy =
[-3.27707029e+01 -1.92930743e+00 -8.48947619e-01 -8.48947619e-01
 -8.48947619e-01  7.58653523e-01  8.06531147e-01  8.06531147e-01
  8.06531147e-01  3.89355612e+00  3.89355612e+00  3.89355612e+00
  3.93608328e+00  1.23426044e+01  1.42381459e+01  1.42381459e+01
  1.42381459e+01  4.11104893e+01  5.28275905e+01  5.28275905e+01
  5.28275905e+01  1.44850177e+02  2.40605760e+02  2.40605760e+02
  2.40605760e+02  5.07443476e+02  1.87360494e+03  8.00253917e+03
  4.77696991e+04]
E1 = -182.5891624848212  E_coul = 54.047446096547574
cycle= 4 E= -128.541716388274  delta_E= -2.76e-08  |g|= 8.05e-05  |ddm|= 0.000411
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186057
diis-c [-1.07427774e-09  2.37550599e-04  4.62374832e-04 -1.84486992e-01
  1.18378707e+00]
  HOMO = -0.848990887547568  LUMO = 0.75864083763419
  mo_energy =
[-3.27707762e+01 -1.92934022e+00 -8.48990888e-01 -8.48990888e-01
 -8.48990888e-01  7.58640838e-01  8.06517626e-01  8.06517626e-01
  8.06517626e-01  3.89351577e+00  3.89351577e+00  3.89351577e+00
  3.93605406e+00  1.23425551e+01  1.42380862e+01  1.42380862e+01
  1.42380862e+01  4.11104242e+01  5.28275213e+01  5.28275213e+01
  5.28275213e+01  1.44850104e+02  2.40605682e+02  2.40605682e+02
  2.40605682e+02  5.07443395e+02  1.87360485e+03  8.00253907e+03
  4.77696990e+04]
E1 = -182.58929443611152  E_coul = 54.047578047115984
cycle= 5 E= -128.541716388996  delta_E= -7.22e-10  |g|= 5.82e-06  |ddm|= 6.97e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58929443611152  E_coul = 54.047578047115984
  HOMO = -0.848987833575042  LUMO = 0.758642085755657
  mo_energy =
[-3.27707693e+01 -1.92933638e+00 -8.48987834e-01 -8.48987834e-01
 -8.48987834e-01  7.58642086e-01  8.06518524e-01  8.06518524e-01
  8.06518524e-01  3.89351869e+00  3.89351869e+00  3.89351869e+00
  3.93605663e+00  1.23425594e+01  1.42380913e+01  1.42380913e+01
  1.42380913e+01  4.11104303e+01  5.28275277e+01  5.28275277e+01
  5.28275277e+01  1.44850111e+02  2.40605689e+02  2.40605689e+02
  2.40605689e+02  5.07443401e+02  1.87360486e+03  8.00253908e+03
  4.77696990e+04]
E1 = -182.5892788168702  E_coul = 54.04756242787215
Extra cycle  E= -128.541716388998  delta_E= -2.53e-12  |g|= 2.2e-06  |ddm|= 2e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2192.703900070941
E1 = -182.5892788168702  E_coul = 54.04756242787215
init E= -128.541716388998
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.848988939198666  LUMO = 0.758641888100951
  mo_energy =
[-3.27707728e+01 -1.92933740e+00 -8.48988939e-01 -8.48988939e-01
 -8.48988939e-01  7.58641888e-01  8.06518270e-01  8.06518270e-01
  8.06518270e-01  3.89351774e+00  3.89351774e+00  3.89351774e+00
  3.93605599e+00  1.23425579e+01  1.42380893e+01  1.42380893e+01
  1.42380893e+01  4.11104277e+01  5.28275247e+01  5.28275247e+01
  5.28275247e+01  1.44850107e+02  2.40605685e+02  2.40605685e+02
  2.40605685e+02  5.07443397e+02  1.87360485e+03  8.00253907e+03
  4.77696990e+04]
E1 = -182.58928748862317  E_coul = 54.04757109962506
cycle= 1 E= -128.541716388998  delta_E= -5.68e-14  |g|= 1.19e-06  |ddm|= 7.9e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58928748862317  E_coul = 54.04757109962506
  HOMO = -0.848988328818982  LUMO = 0.75864205643036
  mo_energy =
[-3.27707709e+01 -1.92933673e+00 -8.48988329e-01 -8.48988329e-01
 -8.48988329e-01  7.58642056e-01  8.06518423e-01  8.06518423e-01
  8.06518423e-01  3.89351829e+00  3.89351829e+00  3.89351829e+00
  3.93605641e+00  1.23425588e+01  1.42380904e+01  1.42380904e+01
  1.42380904e+01  4.11104291e+01  5.28275263e+01  5.28275263e+01
  5.28275263e+01  1.44850109e+02  2.40605687e+02  2.40605687e+02
  2.40605687e+02  5.07443399e+02  1.87360485e+03  8.00253908e+03
  4.77696990e+04]
E1 = -182.58928313035761  E_coul = 54.04756674135927
Extra cycle  E= -128.541716388998  delta_E= -2.27e-13  |g|= 5.92e-07  |ddm|= 3.71e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [7.89364935e-01 2.44137942e+04 3.66145159e+03 8.33318998e+02
 2.35444594e+02 7.61127404e+01 1.02783926e+01 2.69668824e+01
 3.09641464e-01 1.78252744e+00 2.97177178e+00 7.11449301e+00
 2.31696681e+01 9.97863894e+01 2.66224177e-01 2.44320482e+00
 8.34575182e-01]
grad_E = [ 1.32321039e-04  6.71197100e-10 -3.42494206e-08  6.43174672e-07
 -7.44508934e-06  6.64572634e-05  1.06384287e-04 -2.54236583e-04
 -9.47573141e-06 -4.39204468e-05 -1.42322370e-04 -2.52573429e-05
  2.23815544e-06 -2.20279252e-08 -4.87556143e-05  6.59651016e-05
 -4.23759488e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.793856819268       1
[INPUT] 0    0    [1    /1   ]  24413.7941861        1
[INPUT] 0    0    [1    /1   ]  3661.45159059        1
[INPUT] 0    0    [1    /1   ]  833.318991927        1
[INPUT] 0    0    [1    /1   ]  235.444651356        1
[INPUT] 0    0    [1    /1   ]  76.1121287439        1
[INPUT] 0    0    [1    /1   ]  10.2811004708        1
[INPUT] 0    0    [1    /1   ]  26.9685667232        1
[INPUT] 0    0    [1    /1   ]  0.310134705692       1
[INPUT] 0    0    [1    /1   ]  1.79461996255        1
[INPUT] 0    0    [1    /1   ]  2.97399456242        1
[INPUT] 1    0    [1    /1   ]  7.11457268382        1
[INPUT] 1    0    [1    /1   ]  23.1696539371        1
[INPUT] 1    0    [1    /1   ]  99.7863890912        1
[INPUT] 1    0    [1    /1   ]  0.266234161987       1
[INPUT] 1    0    [1    /1   ]  2.44290542213        1
[INPUT] 1    0    [1    /1   ]  0.83447924772        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7938568192681407, 1.0]], [0, [24413.794186145995, 1.0]], [0, [3661.4515905853136, 1.0]], [0, [833.3189919270881, 1.0]], [0, [235.44465135586805, 1.0]], [0, [76.11212874389352, 1.0]], [0, [10.281100470830113, 1.0]], [0, [26.968566723169154, 1.0]], [0, [0.31013470569163853, 1.0]], [0, [1.7946199625476138, 1.0]], [0, [2.973994562423107, 1.0]], [1, [7.114572683819304, 1.0]], [1, [23.169653937088547, 1.0]], [1, [99.7863890911504, 1.0]], [1, [0.2662341619869113, 1.0]], [1, [2.442905422126475, 1.0]], [1, [0.8344792477197591, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79385682]
bas 1, expnt(s) = [24413.79418615]
bas 2, expnt(s) = [3661.45159059]
bas 3, expnt(s) = [833.31899193]
bas 4, expnt(s) = [235.44465136]
bas 5, expnt(s) = [76.11212874]
bas 6, expnt(s) = [10.28110047]
bas 7, expnt(s) = [26.96856672]
bas 8, expnt(s) = [0.31013471]
bas 9, expnt(s) = [1.79461996]
bas 10, expnt(s) = [2.97399456]
bas 11, expnt(s) = [7.11457268]
bas 12, expnt(s) = [23.16965394]
bas 13, expnt(s) = [99.78638909]
bas 14, expnt(s) = [0.26623416]
bas 15, expnt(s) = [2.44290542]
bas 16, expnt(s) = [0.83447925]
CPU time:       150.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.93856819e-01 2.12481762e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33318992e+02 3.91853278e+02
 2.35444651e+02 1.51855892e+02 7.61121287e+01 6.51036632e+01
 1.02811005e+01 1.45059016e+01 2.69685667e+01 2.98991212e+01
 3.10134706e-01 1.04997220e+00 1.79461996e+00 3.91736821e+00
 2.97399456e+00 5.72163503e+00 7.11457268e+00 3.38977146e+01
 2.31696539e+01 1.48297499e+02 9.97863891e+01 9.20075628e+02
 2.66234162e-01 5.57909966e-01 2.44290542e+00 8.90979495e+00
 8.34479248e-01 2.32677194e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999635810988634
cond(S) = 2241.786606476992
E1 = -183.58982840961482  E_coul = 55.080200897459456
init E= -128.509627512155
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77540143983564  LUMO = 0.781030052538705
  mo_energy =
[-3.25551143e+01 -1.85273112e+00 -7.75401440e-01 -7.75401440e-01
 -7.75401440e-01  7.81030053e-01  8.24635430e-01  8.24635430e-01
  8.24635430e-01  3.95924605e+00  3.95924605e+00  3.95924605e+00
  4.00679240e+00  1.24940585e+01  1.43650049e+01  1.43650049e+01
  1.43650049e+01  4.13578214e+01  5.30138989e+01  5.30138989e+01
  5.30138989e+01  1.45151647e+02  2.40838197e+02  2.40838197e+02
  2.40838197e+02  5.07773401e+02  1.87395764e+03  8.00290953e+03
  4.77700759e+04]
E1 = -182.08593447351075  E_coul = 53.54772543473963
cycle= 1 E= -128.538209038771  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518693
diis-c [-0.26904269  1.        ]
  HOMO = -0.884314029363764  LUMO = 0.753080929855154
  mo_energy =
[-3.28783320e+01 -1.96662379e+00 -8.84314029e-01 -8.84314029e-01
 -8.84314029e-01  7.53080930e-01  7.97832369e-01  7.97832369e-01
  7.97832369e-01  3.86173332e+00  3.86173332e+00  3.86173332e+00
  3.93356615e+00  1.23502971e+01  1.41742323e+01  1.41742323e+01
  1.41742323e+01  4.11126682e+01  5.27329129e+01  5.27329129e+01
  5.27329129e+01  1.44835159e+02  2.40491863e+02  2.40491863e+02
  2.40491863e+02  5.07412165e+02  1.87356006e+03  8.00248281e+03
  4.77696303e+04]
E1 = -182.8473514985624  E_coul = 54.3065547698882
cycle= 2 E= -128.540796728674  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263424
diis-c [-0.00066587  0.33600908  0.66399092]
  HOMO = -0.848682170005942  LUMO = 0.76203102491726
  mo_energy =
[-3.27702216e+01 -1.92910354e+00 -8.48682170e-01 -8.48682170e-01
 -8.48682170e-01  7.62031025e-01  8.06572199e-01  8.06572199e-01
  8.06572199e-01  3.89337079e+00  3.89337079e+00  3.89337079e+00
  3.95722370e+00  1.23975047e+01  1.42374350e+01  1.42374350e+01
  1.42374350e+01  4.11947603e+01  5.28269420e+01  5.28269420e+01
  5.28269420e+01  1.44940750e+02  2.40605545e+02  2.40605545e+02
  2.40605545e+02  5.07528886e+02  1.87368213e+03  8.00260734e+03
  4.77697558e+04]
E1 = -182.58866420111448  E_coul = 54.04694746490529
cycle= 3 E= -128.541716736209  delta_E= -0.00092  |g|= 0.000532  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118877
diis-c [-2.02233458e-07 -2.35770462e-03 -4.58818952e-04  1.00281652e+00]
  HOMO = -0.848948369835688  LUMO = 0.761977417557205
  mo_energy =
[-3.27707033e+01 -1.92930579e+00 -8.48948370e-01 -8.48948370e-01
 -8.48948370e-01  7.61977418e-01  8.06529687e-01  8.06529687e-01
  8.06529687e-01  3.89318485e+00  3.89318485e+00  3.89318485e+00
  3.95708558e+00  1.23972513e+01  1.42371144e+01  1.42371144e+01
  1.42371144e+01  4.11943863e+01  5.28265167e+01  5.28265167e+01
  5.28265167e+01  1.44940267e+02  2.40604991e+02  2.40604991e+02
  2.40604991e+02  5.07528275e+02  1.87368138e+03  8.00260649e+03
  4.77697549e+04]
E1 = -182.5891605918322  E_coul = 54.047443827936405
cycle= 4 E= -128.541716763896  delta_E= -2.77e-08  |g|= 8.06e-05  |ddm|= 0.000415
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018633
diis-c [-1.07769329e-09  2.37945541e-04  4.62730078e-04 -1.84672393e-01
  1.18397172e+00]
  HOMO = -0.848991691169689  LUMO = 0.761964673798741
  mo_energy =
[-3.27707767e+01 -1.92933860e+00 -8.48991691e-01 -8.48991691e-01
 -8.48991691e-01  7.61964674e-01  8.06516152e-01  8.06516152e-01
  8.06516152e-01  3.89314446e+00  3.89314446e+00  3.89314446e+00
  3.95705624e+00  1.23972019e+01  1.42370547e+01  1.42370547e+01
  1.42370547e+01  4.11943211e+01  5.28264474e+01  5.28264474e+01
  5.28264474e+01  1.44940194e+02  2.40604914e+02  2.40604914e+02
  2.40604914e+02  5.07528193e+02  1.87368129e+03  8.00260639e+03
  4.77697548e+04]
E1 = -182.58929273097488  E_coul = 54.04757596635454
cycle= 5 E= -128.54171676462  delta_E= -7.25e-10  |g|= 5.84e-06  |ddm|= 7.01e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58929273097488  E_coul = 54.04757596635454
  HOMO = -0.848988628398566  LUMO = 0.761965931167063
  mo_energy =
[-3.27707698e+01 -1.92933475e+00 -8.48988628e-01 -8.48988628e-01
 -8.48988628e-01  7.61965931e-01  8.06517053e-01  8.06517053e-01
  8.06517053e-01  3.89314739e+00  3.89314739e+00  3.89314739e+00
  3.95705883e+00  1.23972062e+01  1.42370597e+01  1.42370597e+01
  1.42370597e+01  4.11943272e+01  5.28264539e+01  5.28264539e+01
  5.28264539e+01  1.44940200e+02  2.40604920e+02  2.40604920e+02
  2.40604920e+02  5.07528200e+02  1.87368130e+03  8.00260640e+03
  4.77697548e+04]
E1 = -182.58927708830475  E_coul = 54.047560323682056
Extra cycle  E= -128.541716764623  delta_E= -2.36e-12  |g|= 2.2e-06  |ddm|= 2.02e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [7.93856819e-01 2.44137942e+04 3.66145159e+03 8.33318992e+02
 2.35444651e+02 7.61121287e+01 1.02811005e+01 2.69685667e+01
 3.10134706e-01 1.79461996e+00 2.97399456e+00 7.11457268e+00
 2.31696539e+01 9.97863891e+01 2.66234162e-01 2.44290542e+00
 8.34479248e-01]
E = -128.5417167646227
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.793856819268       1
[INPUT] 0    0    [1    /1   ]  24413.7941861        1
[INPUT] 0    0    [1    /1   ]  3661.45159059        1
[INPUT] 0    0    [1    /1   ]  833.318991927        1
[INPUT] 0    0    [1    /1   ]  235.444651356        1
[INPUT] 0    0    [1    /1   ]  76.1121287439        1
[INPUT] 0    0    [1    /1   ]  10.2811004708        1
[INPUT] 0    0    [1    /1   ]  26.9685667232        1
[INPUT] 0    0    [1    /1   ]  0.310134705692       1
[INPUT] 0    0    [1    /1   ]  1.79461996255        1
[INPUT] 0    0    [1    /1   ]  2.97399456242        1
[INPUT] 1    0    [1    /1   ]  7.11457268382        1
[INPUT] 1    0    [1    /1   ]  23.1696539371        1
[INPUT] 1    0    [1    /1   ]  99.7863890912        1
[INPUT] 1    0    [1    /1   ]  0.266234161987       1
[INPUT] 1    0    [1    /1   ]  2.44290542213        1
[INPUT] 1    0    [1    /1   ]  0.83447924772        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7938568192681407, 1.0]], [0, [24413.794186145995, 1.0]], [0, [3661.4515905853136, 1.0]], [0, [833.3189919270881, 1.0]], [0, [235.44465135586805, 1.0]], [0, [76.11212874389352, 1.0]], [0, [10.281100470830113, 1.0]], [0, [26.968566723169154, 1.0]], [0, [0.31013470569163853, 1.0]], [0, [1.7946199625476138, 1.0]], [0, [2.973994562423107, 1.0]], [1, [7.114572683819304, 1.0]], [1, [23.169653937088547, 1.0]], [1, [99.7863890911504, 1.0]], [1, [0.2662341619869113, 1.0]], [1, [2.442905422126475, 1.0]], [1, [0.8344792477197591, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79385682]
bas 1, expnt(s) = [24413.79418615]
bas 2, expnt(s) = [3661.45159059]
bas 3, expnt(s) = [833.31899193]
bas 4, expnt(s) = [235.44465136]
bas 5, expnt(s) = [76.11212874]
bas 6, expnt(s) = [10.28110047]
bas 7, expnt(s) = [26.96856672]
bas 8, expnt(s) = [0.31013471]
bas 9, expnt(s) = [1.79461996]
bas 10, expnt(s) = [2.97399456]
bas 11, expnt(s) = [7.11457268]
bas 12, expnt(s) = [23.16965394]
bas 13, expnt(s) = [99.78638909]
bas 14, expnt(s) = [0.26623416]
bas 15, expnt(s) = [2.44290542]
bas 16, expnt(s) = [0.83447925]
CPU time:       150.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.93856819e-01 2.12481762e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33318992e+02 3.91853278e+02
 2.35444651e+02 1.51855892e+02 7.61121287e+01 6.51036632e+01
 1.02811005e+01 1.45059016e+01 2.69685667e+01 2.98991212e+01
 3.10134706e-01 1.04997220e+00 1.79461996e+00 3.91736821e+00
 2.97399456e+00 5.72163503e+00 7.11457268e+00 3.38977146e+01
 2.31696539e+01 1.48297499e+02 9.97863891e+01 9.20075628e+02
 2.66234162e-01 5.57909966e-01 2.44290542e+00 8.90979495e+00
 8.34479248e-01 2.32677194e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999635810988634
cond(S) = 2241.786606476992
E1 = -183.58982840961482  E_coul = 55.080200897459456
init E= -128.509627512155
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77540143983564  LUMO = 0.781030052538705
  mo_energy =
[-3.25551143e+01 -1.85273112e+00 -7.75401440e-01 -7.75401440e-01
 -7.75401440e-01  7.81030053e-01  8.24635430e-01  8.24635430e-01
  8.24635430e-01  3.95924605e+00  3.95924605e+00  3.95924605e+00
  4.00679240e+00  1.24940585e+01  1.43650049e+01  1.43650049e+01
  1.43650049e+01  4.13578214e+01  5.30138989e+01  5.30138989e+01
  5.30138989e+01  1.45151647e+02  2.40838197e+02  2.40838197e+02
  2.40838197e+02  5.07773401e+02  1.87395764e+03  8.00290953e+03
  4.77700759e+04]
E1 = -182.08593447351075  E_coul = 53.54772543473963
cycle= 1 E= -128.538209038771  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518693
diis-c [-0.26904269  1.        ]
  HOMO = -0.884314029363764  LUMO = 0.753080929855154
  mo_energy =
[-3.28783320e+01 -1.96662379e+00 -8.84314029e-01 -8.84314029e-01
 -8.84314029e-01  7.53080930e-01  7.97832369e-01  7.97832369e-01
  7.97832369e-01  3.86173332e+00  3.86173332e+00  3.86173332e+00
  3.93356615e+00  1.23502971e+01  1.41742323e+01  1.41742323e+01
  1.41742323e+01  4.11126682e+01  5.27329129e+01  5.27329129e+01
  5.27329129e+01  1.44835159e+02  2.40491863e+02  2.40491863e+02
  2.40491863e+02  5.07412165e+02  1.87356006e+03  8.00248281e+03
  4.77696303e+04]
E1 = -182.8473514985624  E_coul = 54.3065547698882
cycle= 2 E= -128.540796728674  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0628
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263424
diis-c [-0.00066587  0.33600908  0.66399092]
  HOMO = -0.848682170005942  LUMO = 0.76203102491726
  mo_energy =
[-3.27702216e+01 -1.92910354e+00 -8.48682170e-01 -8.48682170e-01
 -8.48682170e-01  7.62031025e-01  8.06572199e-01  8.06572199e-01
  8.06572199e-01  3.89337079e+00  3.89337079e+00  3.89337079e+00
  3.95722370e+00  1.23975047e+01  1.42374350e+01  1.42374350e+01
  1.42374350e+01  4.11947603e+01  5.28269420e+01  5.28269420e+01
  5.28269420e+01  1.44940750e+02  2.40605545e+02  2.40605545e+02
  2.40605545e+02  5.07528886e+02  1.87368213e+03  8.00260734e+03
  4.77697558e+04]
E1 = -182.58866420111448  E_coul = 54.04694746490529
cycle= 3 E= -128.541716736209  delta_E= -0.00092  |g|= 0.000532  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118877
diis-c [-2.02233458e-07 -2.35770462e-03 -4.58818952e-04  1.00281652e+00]
  HOMO = -0.848948369835688  LUMO = 0.761977417557205
  mo_energy =
[-3.27707033e+01 -1.92930579e+00 -8.48948370e-01 -8.48948370e-01
 -8.48948370e-01  7.61977418e-01  8.06529687e-01  8.06529687e-01
  8.06529687e-01  3.89318485e+00  3.89318485e+00  3.89318485e+00
  3.95708558e+00  1.23972513e+01  1.42371144e+01  1.42371144e+01
  1.42371144e+01  4.11943863e+01  5.28265167e+01  5.28265167e+01
  5.28265167e+01  1.44940267e+02  2.40604991e+02  2.40604991e+02
  2.40604991e+02  5.07528275e+02  1.87368138e+03  8.00260649e+03
  4.77697549e+04]
E1 = -182.5891605918322  E_coul = 54.047443827936405
cycle= 4 E= -128.541716763896  delta_E= -2.77e-08  |g|= 8.06e-05  |ddm|= 0.000415
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018633
diis-c [-1.07769329e-09  2.37945541e-04  4.62730078e-04 -1.84672393e-01
  1.18397172e+00]
  HOMO = -0.848991691169689  LUMO = 0.761964673798741
  mo_energy =
[-3.27707767e+01 -1.92933860e+00 -8.48991691e-01 -8.48991691e-01
 -8.48991691e-01  7.61964674e-01  8.06516152e-01  8.06516152e-01
  8.06516152e-01  3.89314446e+00  3.89314446e+00  3.89314446e+00
  3.95705624e+00  1.23972019e+01  1.42370547e+01  1.42370547e+01
  1.42370547e+01  4.11943211e+01  5.28264474e+01  5.28264474e+01
  5.28264474e+01  1.44940194e+02  2.40604914e+02  2.40604914e+02
  2.40604914e+02  5.07528193e+02  1.87368129e+03  8.00260639e+03
  4.77697548e+04]
E1 = -182.58929273097488  E_coul = 54.04757596635454
cycle= 5 E= -128.54171676462  delta_E= -7.25e-10  |g|= 5.84e-06  |ddm|= 7.01e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.58929273097488  E_coul = 54.04757596635454
  HOMO = -0.848988628398566  LUMO = 0.761965931167063
  mo_energy =
[-3.27707698e+01 -1.92933475e+00 -8.48988628e-01 -8.48988628e-01
 -8.48988628e-01  7.61965931e-01  8.06517053e-01  8.06517053e-01
  8.06517053e-01  3.89314739e+00  3.89314739e+00  3.89314739e+00
  3.95705883e+00  1.23972062e+01  1.42370597e+01  1.42370597e+01
  1.42370597e+01  4.11943272e+01  5.28264539e+01  5.28264539e+01
  5.28264539e+01  1.44940200e+02  2.40604920e+02  2.40604920e+02
  2.40604920e+02  5.07528200e+02  1.87368130e+03  8.00260640e+03
  4.77697548e+04]
E1 = -182.58927708830475  E_coul = 54.047560323682056
Extra cycle  E= -128.541716764623  delta_E= -2.36e-12  |g|= 2.2e-06  |ddm|= 2.02e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2241.786606476992
E1 = -182.58927708830475  E_coul = 54.047560323682056
init E= -128.541716764623
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.848989735483486  LUMO = 0.761965732230342
  mo_energy =
[-3.27707732e+01 -1.92933578e+00 -8.48989735e-01 -8.48989735e-01
 -8.48989735e-01  7.61965732e-01  8.06516799e-01  8.06516799e-01
  8.06516799e-01  3.89314643e+00  3.89314643e+00  3.89314643e+00
  3.95705818e+00  1.23972047e+01  1.42370577e+01  1.42370577e+01
  1.42370577e+01  4.11943246e+01  5.28264509e+01  5.28264509e+01
  5.28264509e+01  1.44940197e+02  2.40604916e+02  2.40604916e+02
  2.40604916e+02  5.07528196e+02  1.87368130e+03  8.00260639e+03
  4.77697548e+04]
E1 = -182.5892857763264  E_coul = 54.047569011703345
cycle= 1 E= -128.541716764623  delta_E= -3.69e-13  |g|= 1.19e-06  |ddm|= 7.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5892857763264  E_coul = 54.047569011703345
  HOMO = -0.848989123927063  LUMO = 0.761965901718426
  mo_energy =
[-3.27707714e+01 -1.92933510e+00 -8.48989124e-01 -8.48989124e-01
 -8.48989124e-01  7.61965902e-01  8.06516953e-01  8.06516953e-01
  8.06516953e-01  3.89314698e+00  3.89314698e+00  3.89314698e+00
  3.95705860e+00  1.23972056e+01  1.42370588e+01  1.42370588e+01
  1.42370588e+01  4.11943260e+01  5.28264525e+01  5.28264525e+01
  5.28264525e+01  1.44940199e+02  2.40604918e+02  2.40604918e+02
  2.40604918e+02  5.07528198e+02  1.87368130e+03  8.00260640e+03
  4.77697548e+04]
E1 = -182.58928141031538  E_coul = 54.04756464569272
Extra cycle  E= -128.541716764623  delta_E= 3.98e-13  |g|= 5.93e-07  |ddm|= 3.72e-07
    CPU time for scf_cycle      0.44 sec, wall time      0.44 sec
exp = [7.93856819e-01 2.44137942e+04 3.66145159e+03 8.33318992e+02
 2.35444651e+02 7.61121287e+01 1.02811005e+01 2.69685667e+01
 3.10134706e-01 1.79461996e+00 2.97399456e+00 7.11457268e+00
 2.31696539e+01 9.97863891e+01 2.66234162e-01 2.44290542e+00
 8.34479248e-01]
grad_E = [ 2.10401803e-04  6.65077174e-10 -3.39320691e-08  6.37008683e-07
 -7.38176752e-06  6.61082193e-05  1.04176429e-04 -2.53300937e-04
 -1.78480743e-04 -5.30955753e-05 -1.37582444e-04 -1.57501019e-05
  1.10728321e-06  1.92889786e-08  4.59120405e-05  4.31037229e-05
 -1.42334292e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.801324796755       1
[INPUT] 0    0    [1    /1   ]  24413.7941861        1
[INPUT] 0    0    [1    /1   ]  3661.45159166        1
[INPUT] 0    0    [1    /1   ]  833.31897416         1
[INPUT] 0    0    [1    /1   ]  235.444829724        1
[INPUT] 0    0    [1    /1   ]  76.1103438843        1
[INPUT] 0    0    [1    /1   ]  10.2870959227        1
[INPUT] 0    0    [1    /1   ]  26.9739346989        1
[INPUT] 0    0    [1    /1   ]  0.310972497575       1
[INPUT] 0    0    [1    /1   ]  1.81518503836        1
[INPUT] 0    0    [1    /1   ]  2.97969532265        1
[INPUT] 1    0    [1    /1   ]  7.11472499073        1
[INPUT] 1    0    [1    /1   ]  23.1696109592        1
[INPUT] 1    0    [1    /1   ]  99.7863889037        1
[INPUT] 1    0    [1    /1   ]  0.266287390256       1
[INPUT] 1    0    [1    /1   ]  2.44252739173        1
[INPUT] 1    0    [1    /1   ]  0.834398879328       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8013247967552262, 1.0]], [0, [24413.794186124156, 1.0]], [0, [3661.4515916586874, 1.0]], [0, [833.3189741595662, 1.0]], [0, [235.44482972374783, 1.0]], [0, [76.11034388429137, 1.0]], [0, [10.287095922721951, 1.0]], [0, [26.97393469890757, 1.0]], [0, [0.310972497574886, 1.0]], [0, [1.8151850383597836, 1.0]], [0, [2.979695322645266, 1.0]], [1, [7.114724990732828, 1.0]], [1, [23.169610959196746, 1.0]], [1, [99.78638890365919, 1.0]], [1, [0.2662873902555517, 1.0]], [1, [2.442527391727864, 1.0]], [1, [0.8343988793279812, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8013248]
bas 1, expnt(s) = [24413.79418612]
bas 2, expnt(s) = [3661.45159166]
bas 3, expnt(s) = [833.31897416]
bas 4, expnt(s) = [235.44482972]
bas 5, expnt(s) = [76.11034388]
bas 6, expnt(s) = [10.28709592]
bas 7, expnt(s) = [26.9739347]
bas 8, expnt(s) = [0.3109725]
bas 9, expnt(s) = [1.81518504]
bas 10, expnt(s) = [2.97969532]
bas 11, expnt(s) = [7.11472499]
bas 12, expnt(s) = [23.16961096]
bas 13, expnt(s) = [99.7863889]
bas 14, expnt(s) = [0.26628739]
bas 15, expnt(s) = [2.44252739]
bas 16, expnt(s) = [0.83439888]
CPU time:       154.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.01324797e-01 2.13979151e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33318974e+02 3.91853272e+02
 2.35444830e+02 1.51855978e+02 7.61103439e+01 6.51025182e+01
 1.02870959e+01 1.45122455e+01 2.69739347e+01 2.99035846e+01
 3.10972498e-01 1.05209876e+00 1.81518504e+00 3.95098792e+00
 2.97969532e+00 5.72985878e+00 7.11472499e+00 3.38986216e+01
 2.31696110e+01 1.48297155e+02 9.97863889e+01 9.20075626e+02
 2.66287390e-01 5.58049398e-01 2.44252739e+00 8.90807154e+00
 8.34398879e-01 2.32649184e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999635524613206
cond(S) = 2323.3076945779235
E1 = -183.5898472052374  E_coul = 55.08021264361222
init E= -128.509634561625
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400641583142  LUMO = 0.786814712562369
  mo_energy =
[-3.25551129e+01 -1.85272942e+00 -7.75400642e-01 -7.75400642e-01
 -7.75400642e-01  7.86814713e-01  8.24756907e-01  8.24756907e-01
  8.24756907e-01  3.95902552e+00  3.95902552e+00  3.95902552e+00
  4.04285243e+00  1.25897022e+01  1.43640297e+01  1.43640297e+01
  1.43640297e+01  4.15100198e+01  5.30128980e+01  5.30128980e+01
  5.30128980e+01  1.45321806e+02  2.40837467e+02  2.40837467e+02
  2.40837467e+02  5.07936539e+02  1.87410521e+03  8.00303959e+03
  4.77701836e+04]
E1 = -182.08597592194866  E_coul = 53.547765718920445
cycle= 1 E= -128.538210203028  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518685
diis-c [-0.26903395  1.        ]
  HOMO = -0.884311648932934  LUMO = 0.758629972807694
  mo_energy =
[-3.28783261e+01 -1.96661717e+00 -8.84311649e-01 -8.84311649e-01
 -8.84311649e-01  7.58629973e-01  7.97951758e-01  7.97951758e-01
  7.97951758e-01  3.86152764e+00  3.86152764e+00  3.86152764e+00
  3.96910656e+00  1.24455383e+01  1.41732610e+01  1.41732610e+01
  1.41732610e+01  4.12648368e+01  5.27319157e+01  5.27319157e+01
  5.27319157e+01  1.45005343e+02  2.40491136e+02  2.40491136e+02
  2.40491136e+02  5.07575316e+02  1.87370765e+03  8.00261287e+03
  4.77697380e+04]
E1 = -182.8473631633264  E_coul = 54.30656529712986
cycle= 2 E= -128.540797866197  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0629
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263412
diis-c [-0.00066662  0.33600174  0.66399826]
  HOMO = -0.848680972810392  LUMO = 0.767655993551681
  mo_energy =
[-3.27702181e+01 -1.92909809e+00 -8.48680973e-01 -8.48680973e-01
 -8.48680973e-01  7.67655994e-01  8.06691803e-01  8.06691803e-01
  8.06691803e-01  3.89316044e+00  3.89316044e+00  3.89316044e+00
  3.99293405e+00  1.24928808e+01  1.42364609e+01  1.42364609e+01
  1.42364609e+01  4.13469368e+01  5.28259429e+01  5.28259429e+01
  5.28259429e+01  1.45110924e+02  2.40604816e+02  2.40604816e+02
  2.40604816e+02  5.07692032e+02  1.87382971e+03  8.00273740e+03
  4.77698635e+04]
E1 = -182.58868669971017  E_coul = 54.04696889637671
cycle= 3 E= -128.541717803333  delta_E= -0.00092  |g|= 0.000533  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119073
diis-c [-2.03060011e-07 -2.35951032e-03 -4.55627271e-04  1.00281514e+00]
  HOMO = -0.848947485741348  LUMO = 0.767601961682846
  mo_energy =
[-3.27707004e+01 -1.92930038e+00 -8.48947486e-01 -8.48947486e-01
 -8.48947486e-01  7.67601962e-01  8.06649189e-01  8.06649189e-01
  8.06649189e-01  3.89297428e+00  3.89297428e+00  3.89297428e+00
  3.99279480e+00  1.24926265e+01  1.42361399e+01  1.42361399e+01
  1.42361399e+01  4.13465622e+01  5.28255172e+01  5.28255172e+01
  5.28255172e+01  1.45110440e+02  2.40604262e+02  2.40604262e+02
  2.40604262e+02  5.07691420e+02  1.87382896e+03  8.00273655e+03
  4.77698626e+04]
E1 = -182.58918388046513  E_coul = 54.04746604930219
cycle= 4 E= -128.541717831163  delta_E= -2.78e-08  |g|= 8.08e-05  |ddm|= 0.000421
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186788
diis-c [-1.08414720e-09  2.38764873e-04  4.63473570e-04 -1.85053150e-01
  1.18435091e+00]
  HOMO = -0.848990886978358  LUMO = 0.767589129031634
  mo_energy =
[-3.27707739e+01 -1.92933320e+00 -8.48990887e-01 -8.48990887e-01
 -8.48990887e-01  7.67589129e-01  8.06635635e-01  8.06635635e-01
  8.06635635e-01  3.89293383e+00  3.89293383e+00  3.89293383e+00
  3.99276524e+00  1.24925769e+01  1.42360801e+01  1.42360801e+01
  1.42360801e+01  4.13464970e+01  5.28254477e+01  5.28254477e+01
  5.28254477e+01  1.45110367e+02  2.40604184e+02  2.40604184e+02
  2.40604184e+02  5.07691338e+02  1.87382887e+03  8.00273645e+03
  4.77698625e+04]
E1 = -182.589316341623  E_coul = 54.04759850973246
cycle= 5 E= -128.541717831891  delta_E= -7.28e-10  |g|= 5.87e-06  |ddm|= 7.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.589316341623  E_coul = 54.04759850973246
  HOMO = -0.848987806852096  LUMO = 0.767590402975714
  mo_energy =
[-3.27707669e+01 -1.92932932e+00 -8.48987807e-01 -8.48987807e-01
 -8.48987807e-01  7.67590403e-01  8.06636542e-01  8.06636542e-01
  8.06636542e-01  3.89293677e+00  3.89293677e+00  3.89293677e+00
  3.99276786e+00  1.24925812e+01  1.42360851e+01  1.42360851e+01
  1.42360851e+01  4.13465030e+01  5.28254543e+01  5.28254543e+01
  5.28254543e+01  1.45110373e+02  2.40604190e+02  2.40604190e+02
  2.40604190e+02  5.07691344e+02  1.87382888e+03  8.00273646e+03
  4.77698625e+04]
E1 = -182.58930064968015  E_coul = 54.04758281778707
Extra cycle  E= -128.541717831893  delta_E= -2.56e-12  |g|= 2.21e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.01324797e-01 2.44137942e+04 3.66145159e+03 8.33318974e+02
 2.35444830e+02 7.61103439e+01 1.02870959e+01 2.69739347e+01
 3.10972498e-01 1.81518504e+00 2.97969532e+00 7.11472499e+00
 2.31696110e+01 9.97863889e+01 2.66287390e-01 2.44252739e+00
 8.34398879e-01]
E = -128.5417178318931
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.801324796755       1
[INPUT] 0    0    [1    /1   ]  24413.7941861        1
[INPUT] 0    0    [1    /1   ]  3661.45159166        1
[INPUT] 0    0    [1    /1   ]  833.31897416         1
[INPUT] 0    0    [1    /1   ]  235.444829724        1
[INPUT] 0    0    [1    /1   ]  76.1103438843        1
[INPUT] 0    0    [1    /1   ]  10.2870959227        1
[INPUT] 0    0    [1    /1   ]  26.9739346989        1
[INPUT] 0    0    [1    /1   ]  0.310972497575       1
[INPUT] 0    0    [1    /1   ]  1.81518503836        1
[INPUT] 0    0    [1    /1   ]  2.97969532265        1
[INPUT] 1    0    [1    /1   ]  7.11472499073        1
[INPUT] 1    0    [1    /1   ]  23.1696109592        1
[INPUT] 1    0    [1    /1   ]  99.7863889037        1
[INPUT] 1    0    [1    /1   ]  0.266287390256       1
[INPUT] 1    0    [1    /1   ]  2.44252739173        1
[INPUT] 1    0    [1    /1   ]  0.834398879328       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8013247967552262, 1.0]], [0, [24413.794186124156, 1.0]], [0, [3661.4515916586874, 1.0]], [0, [833.3189741595662, 1.0]], [0, [235.44482972374783, 1.0]], [0, [76.11034388429137, 1.0]], [0, [10.287095922721951, 1.0]], [0, [26.97393469890757, 1.0]], [0, [0.310972497574886, 1.0]], [0, [1.8151850383597836, 1.0]], [0, [2.979695322645266, 1.0]], [1, [7.114724990732828, 1.0]], [1, [23.169610959196746, 1.0]], [1, [99.78638890365919, 1.0]], [1, [0.2662873902555517, 1.0]], [1, [2.442527391727864, 1.0]], [1, [0.8343988793279812, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8013248]
bas 1, expnt(s) = [24413.79418612]
bas 2, expnt(s) = [3661.45159166]
bas 3, expnt(s) = [833.31897416]
bas 4, expnt(s) = [235.44482972]
bas 5, expnt(s) = [76.11034388]
bas 6, expnt(s) = [10.28709592]
bas 7, expnt(s) = [26.9739347]
bas 8, expnt(s) = [0.3109725]
bas 9, expnt(s) = [1.81518504]
bas 10, expnt(s) = [2.97969532]
bas 11, expnt(s) = [7.11472499]
bas 12, expnt(s) = [23.16961096]
bas 13, expnt(s) = [99.7863889]
bas 14, expnt(s) = [0.26628739]
bas 15, expnt(s) = [2.44252739]
bas 16, expnt(s) = [0.83439888]
CPU time:       155.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.01324797e-01 2.13979151e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33318974e+02 3.91853272e+02
 2.35444830e+02 1.51855978e+02 7.61103439e+01 6.51025182e+01
 1.02870959e+01 1.45122455e+01 2.69739347e+01 2.99035846e+01
 3.10972498e-01 1.05209876e+00 1.81518504e+00 3.95098792e+00
 2.97969532e+00 5.72985878e+00 7.11472499e+00 3.38986216e+01
 2.31696110e+01 1.48297155e+02 9.97863889e+01 9.20075626e+02
 2.66287390e-01 5.58049398e-01 2.44252739e+00 8.90807154e+00
 8.34398879e-01 2.32649184e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999635524613206
cond(S) = 2323.3076945779235
E1 = -183.5898472052374  E_coul = 55.08021264361222
init E= -128.509634561625
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400641583142  LUMO = 0.786814712562369
  mo_energy =
[-3.25551129e+01 -1.85272942e+00 -7.75400642e-01 -7.75400642e-01
 -7.75400642e-01  7.86814713e-01  8.24756907e-01  8.24756907e-01
  8.24756907e-01  3.95902552e+00  3.95902552e+00  3.95902552e+00
  4.04285243e+00  1.25897022e+01  1.43640297e+01  1.43640297e+01
  1.43640297e+01  4.15100198e+01  5.30128980e+01  5.30128980e+01
  5.30128980e+01  1.45321806e+02  2.40837467e+02  2.40837467e+02
  2.40837467e+02  5.07936539e+02  1.87410521e+03  8.00303959e+03
  4.77701836e+04]
E1 = -182.08597592194866  E_coul = 53.547765718920445
cycle= 1 E= -128.538210203028  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518685
diis-c [-0.26903395  1.        ]
  HOMO = -0.884311648932934  LUMO = 0.758629972807694
  mo_energy =
[-3.28783261e+01 -1.96661717e+00 -8.84311649e-01 -8.84311649e-01
 -8.84311649e-01  7.58629973e-01  7.97951758e-01  7.97951758e-01
  7.97951758e-01  3.86152764e+00  3.86152764e+00  3.86152764e+00
  3.96910656e+00  1.24455383e+01  1.41732610e+01  1.41732610e+01
  1.41732610e+01  4.12648368e+01  5.27319157e+01  5.27319157e+01
  5.27319157e+01  1.45005343e+02  2.40491136e+02  2.40491136e+02
  2.40491136e+02  5.07575316e+02  1.87370765e+03  8.00261287e+03
  4.77697380e+04]
E1 = -182.8473631633264  E_coul = 54.30656529712986
cycle= 2 E= -128.540797866197  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0629
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263412
diis-c [-0.00066662  0.33600174  0.66399826]
  HOMO = -0.848680972810392  LUMO = 0.767655993551681
  mo_energy =
[-3.27702181e+01 -1.92909809e+00 -8.48680973e-01 -8.48680973e-01
 -8.48680973e-01  7.67655994e-01  8.06691803e-01  8.06691803e-01
  8.06691803e-01  3.89316044e+00  3.89316044e+00  3.89316044e+00
  3.99293405e+00  1.24928808e+01  1.42364609e+01  1.42364609e+01
  1.42364609e+01  4.13469368e+01  5.28259429e+01  5.28259429e+01
  5.28259429e+01  1.45110924e+02  2.40604816e+02  2.40604816e+02
  2.40604816e+02  5.07692032e+02  1.87382971e+03  8.00273740e+03
  4.77698635e+04]
E1 = -182.58868669971017  E_coul = 54.04696889637671
cycle= 3 E= -128.541717803333  delta_E= -0.00092  |g|= 0.000533  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119073
diis-c [-2.03060011e-07 -2.35951032e-03 -4.55627271e-04  1.00281514e+00]
  HOMO = -0.848947485741348  LUMO = 0.767601961682846
  mo_energy =
[-3.27707004e+01 -1.92930038e+00 -8.48947486e-01 -8.48947486e-01
 -8.48947486e-01  7.67601962e-01  8.06649189e-01  8.06649189e-01
  8.06649189e-01  3.89297428e+00  3.89297428e+00  3.89297428e+00
  3.99279480e+00  1.24926265e+01  1.42361399e+01  1.42361399e+01
  1.42361399e+01  4.13465622e+01  5.28255172e+01  5.28255172e+01
  5.28255172e+01  1.45110440e+02  2.40604262e+02  2.40604262e+02
  2.40604262e+02  5.07691420e+02  1.87382896e+03  8.00273655e+03
  4.77698626e+04]
E1 = -182.58918388046513  E_coul = 54.04746604930219
cycle= 4 E= -128.541717831163  delta_E= -2.78e-08  |g|= 8.08e-05  |ddm|= 0.000421
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186788
diis-c [-1.08414720e-09  2.38764873e-04  4.63473570e-04 -1.85053150e-01
  1.18435091e+00]
  HOMO = -0.848990886978358  LUMO = 0.767589129031634
  mo_energy =
[-3.27707739e+01 -1.92933320e+00 -8.48990887e-01 -8.48990887e-01
 -8.48990887e-01  7.67589129e-01  8.06635635e-01  8.06635635e-01
  8.06635635e-01  3.89293383e+00  3.89293383e+00  3.89293383e+00
  3.99276524e+00  1.24925769e+01  1.42360801e+01  1.42360801e+01
  1.42360801e+01  4.13464970e+01  5.28254477e+01  5.28254477e+01
  5.28254477e+01  1.45110367e+02  2.40604184e+02  2.40604184e+02
  2.40604184e+02  5.07691338e+02  1.87382887e+03  8.00273645e+03
  4.77698625e+04]
E1 = -182.589316341623  E_coul = 54.04759850973246
cycle= 5 E= -128.541717831891  delta_E= -7.28e-10  |g|= 5.87e-06  |ddm|= 7.07e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.589316341623  E_coul = 54.04759850973246
  HOMO = -0.848987806852096  LUMO = 0.767590402975714
  mo_energy =
[-3.27707669e+01 -1.92932932e+00 -8.48987807e-01 -8.48987807e-01
 -8.48987807e-01  7.67590403e-01  8.06636542e-01  8.06636542e-01
  8.06636542e-01  3.89293677e+00  3.89293677e+00  3.89293677e+00
  3.99276786e+00  1.24925812e+01  1.42360851e+01  1.42360851e+01
  1.42360851e+01  4.13465030e+01  5.28254543e+01  5.28254543e+01
  5.28254543e+01  1.45110373e+02  2.40604190e+02  2.40604190e+02
  2.40604190e+02  5.07691344e+02  1.87382888e+03  8.00273646e+03
  4.77698625e+04]
E1 = -182.58930064968015  E_coul = 54.04758281778707
Extra cycle  E= -128.541717831893  delta_E= -2.56e-12  |g|= 2.21e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2323.3076945779235
E1 = -182.58930064968015  E_coul = 54.04758281778707
init E= -128.541717831893
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848988917051385  LUMO = 0.76759020173343
  mo_energy =
[-3.27707704e+01 -1.92933035e+00 -8.48988917e-01 -8.48988917e-01
 -8.48988917e-01  7.67590202e-01  8.06636287e-01  8.06636287e-01
  8.06636287e-01  3.89293581e+00  3.89293581e+00  3.89293581e+00
  3.99276721e+00  1.24925797e+01  1.42360831e+01  1.42360831e+01
  1.42360831e+01  4.13465004e+01  5.28254513e+01  5.28254513e+01
  5.28254513e+01  1.45110370e+02  2.40604187e+02  2.40604187e+02
  2.40604187e+02  5.07691340e+02  1.87382887e+03  8.00273646e+03
  4.77698625e+04]
E1 = -182.58930937070144  E_coul = 54.047591538807794
cycle= 1 E= -128.541717831894  delta_E= -5.68e-13  |g|= 1.2e-06  |ddm|= 7.96e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58930937070144  E_coul = 54.047591538807794
  HOMO = -0.848988303113913  LUMO = 0.767590373286496
  mo_energy =
[-3.27707686e+01 -1.92932968e+00 -8.48988303e-01 -8.48988303e-01
 -8.48988303e-01  7.67590373e-01  8.06636442e-01  8.06636442e-01
  8.06636442e-01  3.89293637e+00  3.89293637e+00  3.89293637e+00
  3.99276764e+00  1.24925806e+01  1.42360842e+01  1.42360842e+01
  1.42360842e+01  4.13465019e+01  5.28254529e+01  5.28254529e+01
  5.28254529e+01  1.45110372e+02  2.40604189e+02  2.40604189e+02
  2.40604189e+02  5.07691342e+02  1.87382888e+03  8.00273646e+03
  4.77698625e+04]
E1 = -182.58930498887767  E_coul = 54.04758715698414
Extra cycle  E= -128.541717831894  delta_E= 1.42e-13  |g|= 5.95e-07  |ddm|= 3.74e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.41 sec
exp = [8.01324797e-01 2.44137942e+04 3.66145159e+03 8.33318974e+02
 2.35444830e+02 7.61103439e+01 1.02870959e+01 2.69739347e+01
 3.10972498e-01 1.81518504e+00 2.97969532e+00 7.11472499e+00
 2.31696110e+01 9.97863889e+01 2.66287390e-01 2.44252739e+00
 8.34398879e-01]
grad_E = [ 3.44665502e-04  6.41379104e-10 -3.27004978e-08  6.12937934e-07
 -7.12804060e-06  6.46404960e-05  9.87044491e-05 -2.49502385e-04
 -4.71537600e-04 -6.77745385e-05 -1.29405900e-04 -2.20411505e-06
 -5.33410700e-07  8.01565960e-08  2.51983143e-04  1.11852265e-05
 -5.08373949e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.8117250847         1
[INPUT] 0    0    [1    /1   ]  24413.7941861        1
[INPUT] 0    0    [1    /1   ]  3661.45159442        1
[INPUT] 0    0    [1    /1   ]  833.31892664         1
[INPUT] 0    0    [1    /1   ]  235.445330392        1
[INPUT] 0    0    [1    /1   ]  76.1055216434        1
[INPUT] 0    0    [1    /1   ]  10.3004883817        1
[INPUT] 0    0    [1    /1   ]  26.9891779474        1
[INPUT] 0    0    [1    /1   ]  0.31208230167        1
[INPUT] 0    0    [1    /1   ]  1.84393801248        1
[INPUT] 0    0    [1    /1   ]  2.99387528651        1
[INPUT] 1    0    [1    /1   ]  7.11518106749        1
[INPUT] 1    0    [1    /1   ]  23.1694615182        1
[INPUT] 1    0    [1    /1   ]  99.7863910583        1
[INPUT] 1    0    [1    /1   ]  0.266415974569       1
[INPUT] 1    0    [1    /1   ]  2.44211973546        1
[INPUT] 1    0    [1    /1   ]  0.834369952727       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8117250846996168, 1.0]], [0, [24413.79418606853, 1.0]], [0, [3661.451594421535, 1.0]], [0, [833.3189266399993, 1.0]], [0, [235.445330392203, 1.0]], [0, [76.1055216433773, 1.0]], [0, [10.300488381736555, 1.0]], [0, [26.98917794737549, 1.0]], [0, [0.312082301669779, 1.0]], [0, [1.843938012476304, 1.0]], [0, [2.993875286513201, 1.0]], [1, [7.11518106748692, 1.0]], [1, [23.169461518246713, 1.0]], [1, [99.78639105834382, 1.0]], [1, [0.2664159745687308, 1.0]], [1, [2.442119735458211, 1.0]], [1, [0.8343699527271111, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81172508]
bas 1, expnt(s) = [24413.79418607]
bas 2, expnt(s) = [3661.45159442]
bas 3, expnt(s) = [833.31892664]
bas 4, expnt(s) = [235.44533039]
bas 5, expnt(s) = [76.10552164]
bas 6, expnt(s) = [10.30048838]
bas 7, expnt(s) = [26.98917795]
bas 8, expnt(s) = [0.3120823]
bas 9, expnt(s) = [1.84393801]
bas 10, expnt(s) = [2.99387529]
bas 11, expnt(s) = [7.11518107]
bas 12, expnt(s) = [23.16946152]
bas 13, expnt(s) = [99.78639106]
bas 14, expnt(s) = [0.26641597]
bas 15, expnt(s) = [2.44211974]
bas 16, expnt(s) = [0.83436995]
CPU time:       158.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.11725085e-01 2.16058695e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33318927e+02 3.91853255e+02
 2.35445330e+02 1.51856220e+02 7.61055216e+01 6.50994245e+01
 1.03004884e+01 1.45264130e+01 2.69891779e+01 2.99162578e+01
 3.12082302e-01 1.05491357e+00 1.84393801e+00 3.99783405e+00
 2.99387529e+00 5.75029736e+00 7.11518107e+00 3.39013379e+01
 2.31694615e+01 1.48295959e+02 9.97863911e+01 9.20075651e+02
 2.66415975e-01 5.58386256e-01 2.44211974e+00 8.90621314e+00
 8.34369953e-01 2.32639102e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999634670028605
cond(S) = 2426.7652828647592
E1 = -183.58988232296147  E_coul = 55.08023085458504
init E= -128.509651468376
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775399365317052  LUMO = 0.794897188336196
  mo_energy =
[-3.25551115e+01 -1.85272662e+00 -7.75399365e-01 -7.75399365e-01
 -7.75399365e-01  7.94897188e-01  8.25100650e-01  8.25100650e-01
  8.25100650e-01  3.95919931e+00  3.95919931e+00  3.95919931e+00
  4.09430904e+00  1.27334996e+01  1.43636709e+01  1.43636709e+01
  1.43636709e+01  4.17563695e+01  5.30129125e+01  5.30129125e+01
  5.30129125e+01  1.45617366e+02  2.40837493e+02  2.40837493e+02
  2.40837493e+02  5.08228273e+02  1.87437053e+03  8.00327370e+03
  4.77703775e+04]
E1 = -182.08609117856602  E_coul = 53.547877817627246
cycle= 1 E= -128.538213360939  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518682
diis-c [-0.26903115  1.        ]
  HOMO = -0.884304155962414  LUMO = 0.76638389803395
  mo_energy =
[-3.28783087e+01 -1.96660232e+00 -8.84304156e-01 -8.84304156e-01
 -8.84304156e-01  7.66383898e-01  7.98288067e-01  7.98288067e-01
  7.98288067e-01  3.86172203e+00  3.86172203e+00  3.86172203e+00
  4.01980437e+00  1.25886856e+01  1.41729114e+01  1.41729114e+01
  1.41729114e+01  4.15111059e+01  5.27319449e+01  5.27319449e+01
  5.27319449e+01  1.45300943e+02  2.40491178e+02  2.40491178e+02
  2.40491178e+02  5.07867080e+02  1.87397299e+03  8.00284700e+03
  4.77699320e+04]
E1 = -182.84740344867993  E_coul = 54.30660258619447
cycle= 2 E= -128.540800862485  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.063
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263398
diis-c [-0.00066787  0.33598894  0.66401106]
  HOMO = -0.848676658369172  LUMO = 0.775516025955945
  mo_energy =
[-3.27702079e+01 -1.92908650e+00 -8.48676658e-01 -8.48676658e-01
 -8.48676658e-01  7.75516026e-01  8.07029883e-01  8.07029883e-01
  8.07029883e-01  3.89334851e+00  3.89334851e+00  3.89334851e+00
  4.04388016e+00  1.26362463e+01  1.42361057e+01  1.42361057e+01
  1.42361057e+01  4.15932296e+01  5.28259659e+01  5.28259659e+01
  5.28259659e+01  1.45406507e+02  2.40604851e+02  2.40604851e+02
  2.40604851e+02  5.07983784e+02  1.87409504e+03  8.00297151e+03
  4.77700574e+04]
E1 = -182.58875652482516  E_coul = 54.04703590723693
cycle= 3 E= -128.541720617588  delta_E= -0.00092  |g|= 0.000535  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119338
diis-c [-2.04511137e-07 -2.36255392e-03 -4.53218062e-04  1.00281577e+00]
  HOMO = -0.848943550894663  LUMO = 0.7754614589529
  mo_energy =
[-3.27706907e+01 -1.92928868e+00 -8.48943551e-01 -8.48943551e-01
 -8.48943551e-01  7.75461459e-01  8.06987135e-01  8.06987135e-01
  8.06987135e-01  3.89316209e+00  3.89316209e+00  3.89316209e+00
  4.04373935e+00  1.26359906e+01  1.42357842e+01  1.42357842e+01
  1.42357842e+01  4.15928543e+01  5.28255397e+01  5.28255397e+01
  5.28255397e+01  1.45406023e+02  2.40604295e+02  2.40604295e+02
  2.40604295e+02  5.07983171e+02  1.87409429e+03  8.00297066e+03
  4.77700565e+04]
E1 = -182.5892545093137  E_coul = 54.04753386367768
cycle= 4 E= -128.541720645636  delta_E= -2.8e-08  |g|= 8.11e-05  |ddm|= 0.000429
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187509
diis-c [-1.09559895e-09  2.40304154e-04  4.64977484e-04 -1.85769403e-01
  1.18506412e+00]
  HOMO = -0.848987071690419  LUMO = 0.77544851147287
  mo_energy =
[-3.27707645e+01 -1.92932149e+00 -8.48987072e-01 -8.48987072e-01
 -8.48987072e-01  7.75448511e-01  8.06973551e-01  8.06973551e-01
  8.06973551e-01  3.89312155e+00  3.89312155e+00  3.89312155e+00
  4.04370948e+00  1.26359407e+01  1.42357242e+01  1.42357242e+01
  1.42357242e+01  4.15927888e+01  5.28254700e+01  5.28254700e+01
  5.28254700e+01  1.45405950e+02  2.40604217e+02  2.40604217e+02
  2.40604217e+02  5.07983089e+02  1.87409420e+03  8.00297057e+03
  4.77700564e+04]
E1 = -182.58938746446  E_coul = 54.04766681808932
cycle= 5 E= -128.541720646371  delta_E= -7.35e-10  |g|= 5.92e-06  |ddm|= 7.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58938746446  E_coul = 54.04766681808932
  HOMO = -0.848983960193503  LUMO = 0.775449811554429
  mo_energy =
[-3.27707574e+01 -1.92931759e+00 -8.48983960e-01 -8.48983960e-01
 -8.48983960e-01  7.75449812e-01  8.06974468e-01  8.06974468e-01
  8.06974468e-01  3.89312452e+00  3.89312452e+00  3.89312452e+00
  4.04371215e+00  1.26359451e+01  1.42357293e+01  1.42357293e+01
  1.42357293e+01  4.15927950e+01  5.28254766e+01  5.28254766e+01
  5.28254766e+01  1.45405956e+02  2.40604224e+02  2.40604224e+02
  2.40604224e+02  5.07983095e+02  1.87409421e+03  8.00297057e+03
  4.77700564e+04]
E1 = -182.58937167734373  E_coul = 54.04765103097033
Extra cycle  E= -128.541720646373  delta_E= -2.7e-12  |g|= 2.22e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.11725085e-01 2.44137942e+04 3.66145159e+03 8.33318927e+02
 2.35445330e+02 7.61055216e+01 1.03004884e+01 2.69891779e+01
 3.12082302e-01 1.84393801e+00 2.99387529e+00 7.11518107e+00
 2.31694615e+01 9.97863911e+01 2.66415975e-01 2.44211974e+00
 8.34369953e-01]
E = -128.5417206463734
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.8117250847         1
[INPUT] 0    0    [1    /1   ]  24413.7941861        1
[INPUT] 0    0    [1    /1   ]  3661.45159442        1
[INPUT] 0    0    [1    /1   ]  833.31892664         1
[INPUT] 0    0    [1    /1   ]  235.445330392        1
[INPUT] 0    0    [1    /1   ]  76.1055216434        1
[INPUT] 0    0    [1    /1   ]  10.3004883817        1
[INPUT] 0    0    [1    /1   ]  26.9891779474        1
[INPUT] 0    0    [1    /1   ]  0.31208230167        1
[INPUT] 0    0    [1    /1   ]  1.84393801248        1
[INPUT] 0    0    [1    /1   ]  2.99387528651        1
[INPUT] 1    0    [1    /1   ]  7.11518106749        1
[INPUT] 1    0    [1    /1   ]  23.1694615182        1
[INPUT] 1    0    [1    /1   ]  99.7863910583        1
[INPUT] 1    0    [1    /1   ]  0.266415974569       1
[INPUT] 1    0    [1    /1   ]  2.44211973546        1
[INPUT] 1    0    [1    /1   ]  0.834369952727       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8117250846996168, 1.0]], [0, [24413.79418606853, 1.0]], [0, [3661.451594421535, 1.0]], [0, [833.3189266399993, 1.0]], [0, [235.445330392203, 1.0]], [0, [76.1055216433773, 1.0]], [0, [10.300488381736555, 1.0]], [0, [26.98917794737549, 1.0]], [0, [0.312082301669779, 1.0]], [0, [1.843938012476304, 1.0]], [0, [2.993875286513201, 1.0]], [1, [7.11518106748692, 1.0]], [1, [23.169461518246713, 1.0]], [1, [99.78639105834382, 1.0]], [1, [0.2664159745687308, 1.0]], [1, [2.442119735458211, 1.0]], [1, [0.8343699527271111, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81172508]
bas 1, expnt(s) = [24413.79418607]
bas 2, expnt(s) = [3661.45159442]
bas 3, expnt(s) = [833.31892664]
bas 4, expnt(s) = [235.44533039]
bas 5, expnt(s) = [76.10552164]
bas 6, expnt(s) = [10.30048838]
bas 7, expnt(s) = [26.98917795]
bas 8, expnt(s) = [0.3120823]
bas 9, expnt(s) = [1.84393801]
bas 10, expnt(s) = [2.99387529]
bas 11, expnt(s) = [7.11518107]
bas 12, expnt(s) = [23.16946152]
bas 13, expnt(s) = [99.78639106]
bas 14, expnt(s) = [0.26641597]
bas 15, expnt(s) = [2.44211974]
bas 16, expnt(s) = [0.83436995]
CPU time:       159.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.11725085e-01 2.16058695e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33318927e+02 3.91853255e+02
 2.35445330e+02 1.51856220e+02 7.61055216e+01 6.50994245e+01
 1.03004884e+01 1.45264130e+01 2.69891779e+01 2.99162578e+01
 3.12082302e-01 1.05491357e+00 1.84393801e+00 3.99783405e+00
 2.99387529e+00 5.75029736e+00 7.11518107e+00 3.39013379e+01
 2.31694615e+01 1.48295959e+02 9.97863911e+01 9.20075651e+02
 2.66415975e-01 5.58386256e-01 2.44211974e+00 8.90621314e+00
 8.34369953e-01 2.32639102e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999634670028605
cond(S) = 2426.7652828647592
E1 = -183.58988232296147  E_coul = 55.08023085458504
init E= -128.509651468376
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775399365317052  LUMO = 0.794897188336196
  mo_energy =
[-3.25551115e+01 -1.85272662e+00 -7.75399365e-01 -7.75399365e-01
 -7.75399365e-01  7.94897188e-01  8.25100650e-01  8.25100650e-01
  8.25100650e-01  3.95919931e+00  3.95919931e+00  3.95919931e+00
  4.09430904e+00  1.27334996e+01  1.43636709e+01  1.43636709e+01
  1.43636709e+01  4.17563695e+01  5.30129125e+01  5.30129125e+01
  5.30129125e+01  1.45617366e+02  2.40837493e+02  2.40837493e+02
  2.40837493e+02  5.08228273e+02  1.87437053e+03  8.00327370e+03
  4.77703775e+04]
E1 = -182.08609117856602  E_coul = 53.547877817627246
cycle= 1 E= -128.538213360939  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518682
diis-c [-0.26903115  1.        ]
  HOMO = -0.884304155962414  LUMO = 0.76638389803395
  mo_energy =
[-3.28783087e+01 -1.96660232e+00 -8.84304156e-01 -8.84304156e-01
 -8.84304156e-01  7.66383898e-01  7.98288067e-01  7.98288067e-01
  7.98288067e-01  3.86172203e+00  3.86172203e+00  3.86172203e+00
  4.01980437e+00  1.25886856e+01  1.41729114e+01  1.41729114e+01
  1.41729114e+01  4.15111059e+01  5.27319449e+01  5.27319449e+01
  5.27319449e+01  1.45300943e+02  2.40491178e+02  2.40491178e+02
  2.40491178e+02  5.07867080e+02  1.87397299e+03  8.00284700e+03
  4.77699320e+04]
E1 = -182.84740344867993  E_coul = 54.30660258619447
cycle= 2 E= -128.540800862485  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.063
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263398
diis-c [-0.00066787  0.33598894  0.66401106]
  HOMO = -0.848676658369172  LUMO = 0.775516025955945
  mo_energy =
[-3.27702079e+01 -1.92908650e+00 -8.48676658e-01 -8.48676658e-01
 -8.48676658e-01  7.75516026e-01  8.07029883e-01  8.07029883e-01
  8.07029883e-01  3.89334851e+00  3.89334851e+00  3.89334851e+00
  4.04388016e+00  1.26362463e+01  1.42361057e+01  1.42361057e+01
  1.42361057e+01  4.15932296e+01  5.28259659e+01  5.28259659e+01
  5.28259659e+01  1.45406507e+02  2.40604851e+02  2.40604851e+02
  2.40604851e+02  5.07983784e+02  1.87409504e+03  8.00297151e+03
  4.77700574e+04]
E1 = -182.58875652482516  E_coul = 54.04703590723693
cycle= 3 E= -128.541720617588  delta_E= -0.00092  |g|= 0.000535  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119338
diis-c [-2.04511137e-07 -2.36255392e-03 -4.53218062e-04  1.00281577e+00]
  HOMO = -0.848943550894663  LUMO = 0.7754614589529
  mo_energy =
[-3.27706907e+01 -1.92928868e+00 -8.48943551e-01 -8.48943551e-01
 -8.48943551e-01  7.75461459e-01  8.06987135e-01  8.06987135e-01
  8.06987135e-01  3.89316209e+00  3.89316209e+00  3.89316209e+00
  4.04373935e+00  1.26359906e+01  1.42357842e+01  1.42357842e+01
  1.42357842e+01  4.15928543e+01  5.28255397e+01  5.28255397e+01
  5.28255397e+01  1.45406023e+02  2.40604295e+02  2.40604295e+02
  2.40604295e+02  5.07983171e+02  1.87409429e+03  8.00297066e+03
  4.77700565e+04]
E1 = -182.5892545093137  E_coul = 54.04753386367768
cycle= 4 E= -128.541720645636  delta_E= -2.8e-08  |g|= 8.11e-05  |ddm|= 0.000429
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187509
diis-c [-1.09559895e-09  2.40304154e-04  4.64977484e-04 -1.85769403e-01
  1.18506412e+00]
  HOMO = -0.848987071690419  LUMO = 0.77544851147287
  mo_energy =
[-3.27707645e+01 -1.92932149e+00 -8.48987072e-01 -8.48987072e-01
 -8.48987072e-01  7.75448511e-01  8.06973551e-01  8.06973551e-01
  8.06973551e-01  3.89312155e+00  3.89312155e+00  3.89312155e+00
  4.04370948e+00  1.26359407e+01  1.42357242e+01  1.42357242e+01
  1.42357242e+01  4.15927888e+01  5.28254700e+01  5.28254700e+01
  5.28254700e+01  1.45405950e+02  2.40604217e+02  2.40604217e+02
  2.40604217e+02  5.07983089e+02  1.87409420e+03  8.00297057e+03
  4.77700564e+04]
E1 = -182.58938746446  E_coul = 54.04766681808932
cycle= 5 E= -128.541720646371  delta_E= -7.35e-10  |g|= 5.92e-06  |ddm|= 7.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58938746446  E_coul = 54.04766681808932
  HOMO = -0.848983960193503  LUMO = 0.775449811554429
  mo_energy =
[-3.27707574e+01 -1.92931759e+00 -8.48983960e-01 -8.48983960e-01
 -8.48983960e-01  7.75449812e-01  8.06974468e-01  8.06974468e-01
  8.06974468e-01  3.89312452e+00  3.89312452e+00  3.89312452e+00
  4.04371215e+00  1.26359451e+01  1.42357293e+01  1.42357293e+01
  1.42357293e+01  4.15927950e+01  5.28254766e+01  5.28254766e+01
  5.28254766e+01  1.45405956e+02  2.40604224e+02  2.40604224e+02
  2.40604224e+02  5.07983095e+02  1.87409421e+03  8.00297057e+03
  4.77700564e+04]
E1 = -182.58937167734373  E_coul = 54.04765103097033
Extra cycle  E= -128.541720646373  delta_E= -2.7e-12  |g|= 2.22e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2426.7652828647592
E1 = -182.58937167734373  E_coul = 54.04765103097033
init E= -128.541720646373
    CPU time for initialize scf      0.34 sec, wall time      0.34 sec
  HOMO = -0.848985076487965  LUMO = 0.775449606733161
  mo_energy =
[-3.27707610e+01 -1.92931862e+00 -8.48985076e-01 -8.48985076e-01
 -8.48985076e-01  7.75449607e-01  8.06974213e-01  8.06974213e-01
  8.06974213e-01  3.89312356e+00  3.89312356e+00  3.89312356e+00
  4.04371149e+00  1.26359436e+01  1.42357273e+01  1.42357273e+01
  1.42357273e+01  4.15927924e+01  5.28254736e+01  5.28254736e+01
  5.28254736e+01  1.45405953e+02  2.40604220e+02  2.40604220e+02
  2.40604220e+02  5.07983092e+02  1.87409420e+03  8.00297057e+03
  4.77700564e+04]
E1 = -182.58938046010533  E_coul = 54.04765981373177
cycle= 1 E= -128.541720646374  delta_E= -1.71e-13  |g|= 1.2e-06  |ddm|= 8.03e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58938046010533  E_coul = 54.04765981373177
  HOMO = -0.848984458105841  LUMO = 0.775449781499967
  mo_energy =
[-3.27707591e+01 -1.92931794e+00 -8.48984458e-01 -8.48984458e-01
 -8.48984458e-01  7.75449781e-01  8.06974368e-01  8.06974368e-01
  8.06974368e-01  3.89312411e+00  3.89312411e+00  3.89312411e+00
  4.04371193e+00  1.26359445e+01  1.42357284e+01  1.42357284e+01
  1.42357284e+01  4.15927938e+01  5.28254752e+01  5.28254752e+01
  5.28254752e+01  1.45405955e+02  2.40604222e+02  2.40604222e+02
  2.40604222e+02  5.07983094e+02  1.87409420e+03  8.00297057e+03
  4.77700564e+04]
E1 = -182.58937604850928  E_coul = 54.04765540213555
Extra cycle  E= -128.541720646374  delta_E= -1.71e-13  |g|= 5.99e-07  |ddm|= 3.77e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [8.11725085e-01 2.44137942e+04 3.66145159e+03 8.33318927e+02
 2.35445330e+02 7.61055216e+01 1.03004884e+01 2.69891779e+01
 3.12082302e-01 1.84393801e+00 2.99387529e+00 7.11518107e+00
 2.31694615e+01 9.97863911e+01 2.66415975e-01 2.44211974e+00
 8.34369953e-01]
grad_E = [ 5.63431578e-04  5.71115021e-10 -2.90464721e-08  5.41484858e-07
 -6.37183832e-06  6.02805295e-05  8.88942207e-05 -2.39081417e-04
 -9.51532113e-04 -9.11880464e-05 -1.17238561e-04  1.80265391e-05
 -3.17665722e-06  1.82769565e-07  6.39095766e-04 -3.31109186e-05
 -1.27392314e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.824323760326       1
[INPUT] 0    0    [1    /1   ]  24413.7941859        1
[INPUT] 0    0    [1    /1   ]  3661.4516016         1
[INPUT] 0    0    [1    /1   ]  833.318800291        1
[INPUT] 0    0    [1    /1   ]  235.44669876         1
[INPUT] 0    0    [1    /1   ]  76.0926187113        1
[INPUT] 0    0    [1    /1   ]  10.3321632026        1
[INPUT] 0    0    [1    /1   ]  27.0311040373        1
[INPUT] 0    0    [1    /1   ]  0.313293029987       1
[INPUT] 0    0    [1    /1   ]  1.87873321793        1
[INPUT] 0    0    [1    /1   ]  3.02999697638        1
[INPUT] 1    0    [1    /1   ]  7.11657444296        1
[INPUT] 1    0    [1    /1   ]  23.1689939642        1
[INPUT] 1    0    [1    /1   ]  99.7864015927        1
[INPUT] 1    0    [1    /1   ]  0.266680697145       1
[INPUT] 1    0    [1    /1   ]  2.44183372893        1
[INPUT] 1    0    [1    /1   ]  0.834469902837       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8243237603260274, 1.0]], [0, [24413.794185924977, 1.0]], [0, [3661.4516015987306, 1.0]], [0, [833.318800290794, 1.0]], [0, [235.44669876034584, 1.0]], [0, [76.09261871132101, 1.0]], [0, [10.332163202634115, 1.0]], [0, [27.031104037295048, 1.0]], [0, [0.31329302998659486, 1.0]], [0, [1.8787332179300376, 1.0]], [0, [3.029996976382672, 1.0]], [1, [7.116574442960796, 1.0]], [1, [23.16899396420875, 1.0]], [1, [99.78640159272022, 1.0]], [1, [0.2666806971450912, 1.0]], [1, [2.4418337289319676, 1.0]], [1, [0.834469902837039, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82432376]
bas 1, expnt(s) = [24413.79418592]
bas 2, expnt(s) = [3661.4516016]
bas 3, expnt(s) = [833.31880029]
bas 4, expnt(s) = [235.44669876]
bas 5, expnt(s) = [76.09261871]
bas 6, expnt(s) = [10.3321632]
bas 7, expnt(s) = [27.03110404]
bas 8, expnt(s) = [0.31329303]
bas 9, expnt(s) = [1.87873322]
bas 10, expnt(s) = [3.02999698]
bas 11, expnt(s) = [7.11657444]
bas 12, expnt(s) = [23.16899396]
bas 13, expnt(s) = [99.78640159]
bas 14, expnt(s) = [0.2666807]
bas 15, expnt(s) = [2.44183373]
bas 16, expnt(s) = [0.8344699]
CPU time:       162.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.24323760e-01 2.18568911e+00 2.44137942e+04 4.93448103e+03
 3.66145160e+03 1.18920027e+03 8.33318800e+02 3.91853210e+02
 2.35446699e+02 1.51856882e+02 7.60926187e+01 6.50911466e+01
 1.03321632e+01 1.45599025e+01 2.70311040e+01 2.99511059e+01
 3.13293030e-01 1.05798150e+00 1.87873322e+00 4.05428113e+00
 3.02999698e+00 5.80225312e+00 7.11657444e+00 3.39096368e+01
 2.31689940e+01 1.48292219e+02 9.97864016e+01 9.20075772e+02
 2.66680697e-01 5.59079888e-01 2.44183373e+00 8.90490935e+00
 8.34469903e-01 2.32673937e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999632712153861
cond(S) = 2503.5987378405384
E1 = -183.58994877546957  E_coul = 55.08025584510489
init E= -128.509692930365
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775397560407447  LUMO = 0.804832613289944
  mo_energy =
[-3.25551117e+01 -1.85272236e+00 -7.75397560e-01 -7.75397560e-01
 -7.75397560e-01  8.04832613e-01  8.25858060e-01  8.25858060e-01
  8.25858060e-01  3.96027057e+00  3.96027057e+00  3.96027057e+00
  4.16061775e+00  1.29399549e+01  1.43653446e+01  1.43653446e+01
  1.43653446e+01  4.21582888e+01  5.30164542e+01  5.30164542e+01
  5.30164542e+01  1.46151960e+02  2.40840206e+02  2.40840206e+02
  2.40840206e+02  5.08776411e+02  1.87487242e+03  8.00371719e+03
  4.77707451e+04]
E1 = -182.08635409626166  E_coul = 53.54813244495629
cycle= 1 E= -128.538221651305  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518706
diis-c [-0.26905605  1.        ]
  HOMO = -0.884286272720927  LUMO = 0.775915254163404
  mo_energy =
[-3.28782684e+01 -1.96657233e+00 -8.84286273e-01 -8.84286273e-01
 -8.84286273e-01  7.75915254e-01  7.99028183e-01  7.99028183e-01
  7.99028183e-01  3.86282021e+00  3.86282021e+00  3.86282021e+00
  4.08507856e+00  1.27940811e+01  1.41746016e+01  1.41746016e+01
  1.41746016e+01  4.19128040e+01  5.27355246e+01  5.27355246e+01
  5.27355246e+01  1.45835592e+02  2.40493932e+02  2.40493932e+02
  2.40493932e+02  5.08415280e+02  1.87447492e+03  8.00329054e+03
  4.77702996e+04]
E1 = -182.84750581524028  E_coul = 54.30669711390417
cycle= 2 E= -128.540808701336  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0631
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263389
diis-c [-0.00067     0.33596849  0.66403151]
  HOMO = -0.848665839384596  LUMO = 0.785178328195539
  mo_energy =
[-3.27701846e+01 -1.92906389e+00 -8.48665839e-01 -8.48665839e-01
 -8.48665839e-01  7.85178328e-01  8.07774819e-01  8.07774819e-01
  8.07774819e-01  3.89443873e+00  3.89443873e+00  3.89443873e+00
  4.10949330e+00  1.28419981e+01  1.42377862e+01  1.42377862e+01
  1.42377862e+01  4.19949970e+01  5.28295305e+01  5.28295305e+01
  5.28295305e+01  1.45941133e+02  2.40607587e+02  2.40607587e+02
  2.40607587e+02  5.08531959e+02  1.87459696e+03  8.00341504e+03
  4.77704250e+04]
E1 = -182.58892496397232  E_coul = 54.04719690343543
cycle= 3 E= -128.541728060537  delta_E= -0.000919  |g|= 0.000537  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119624
diis-c [-2.06909072e-07 -2.36752479e-03 -4.55625466e-04  1.00282315e+00]
  HOMO = -0.848933052486797  LUMO = 0.785123227732724
  mo_energy =
[-3.27706677e+01 -1.92926558e+00 -8.48933052e-01 -8.48933052e-01
 -8.48933052e-01  7.85123228e-01  8.07731931e-01  8.07731931e-01
  8.07731931e-01  3.89425217e+00  3.89425217e+00  3.89425217e+00
  4.10935056e+00  1.28417407e+01  1.42374643e+01  1.42374643e+01
  1.42374643e+01  4.19946211e+01  5.28291041e+01  5.28291041e+01
  5.28291041e+01  1.45940649e+02  2.40607031e+02  2.40607031e+02
  2.40607031e+02  5.08531346e+02  1.87459621e+03  8.00341419e+03
  4.77704241e+04]
E1 = -182.5894230588838  E_coul = 54.04769496998605
cycle= 4 E= -128.541728088898  delta_E= -2.84e-08  |g|= 8.15e-05  |ddm|= 0.00044
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188575
diis-c [-1.11505827e-09  2.43005340e-04  4.67973082e-04 -1.87030388e-01
  1.18631941e+00]
  HOMO = -0.848976740484899  LUMO = 0.785110156620013
  mo_energy =
[-3.27707417e+01 -1.92929835e+00 -8.48976740e-01 -8.48976740e-01
 -8.48976740e-01  7.85110157e-01  8.07718301e-01  8.07718301e-01
  8.07718301e-01  3.89421150e+00  3.89421150e+00  3.89421150e+00
  4.10932029e+00  1.28416904e+01  1.42374042e+01  1.42374042e+01
  1.42374042e+01  4.19945554e+01  5.28290342e+01  5.28290342e+01
  5.28290342e+01  1.45940575e+02  2.40606953e+02  2.40606953e+02
  2.40606953e+02  5.08531263e+02  1.87459612e+03  8.00341409e+03
  4.77704240e+04]
E1 = -182.58955671847195  E_coul = 54.047828628829585
cycle= 5 E= -128.541728089642  delta_E= -7.45e-10  |g|= 6.01e-06  |ddm|= 7.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58955671847195  E_coul = 54.047828628829585
  HOMO = -0.848973575418219  LUMO = 0.785111495211388
  mo_energy =
[-3.27707346e+01 -1.92929439e+00 -8.48973575e-01 -8.48973575e-01
 -8.48973575e-01  7.85111495e-01  8.07719237e-01  8.07719237e-01
  8.07719237e-01  3.89421452e+00  3.89421452e+00  3.89421452e+00
  4.10932304e+00  1.28416949e+01  1.42374093e+01  1.42374093e+01
  1.42374093e+01  4.19945616e+01  5.28290409e+01  5.28290409e+01
  5.28290409e+01  1.45940582e+02  2.40606960e+02  2.40606960e+02
  2.40606960e+02  5.08531270e+02  1.87459612e+03  8.00341410e+03
  4.77704240e+04]
E1 = -182.5895407578878  E_coul = 54.04781266824243
Extra cycle  E= -128.541728089645  delta_E= -2.98e-12  |g|= 2.25e-06  |ddm|= 2.21e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.24323760e-01 2.44137942e+04 3.66145160e+03 8.33318800e+02
 2.35446699e+02 7.60926187e+01 1.03321632e+01 2.70311040e+01
 3.13293030e-01 1.87873322e+00 3.02999698e+00 7.11657444e+00
 2.31689940e+01 9.97864016e+01 2.66680697e-01 2.44183373e+00
 8.34469903e-01]
E = -128.54172808964535
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.824323760326       1
[INPUT] 0    0    [1    /1   ]  24413.7941859        1
[INPUT] 0    0    [1    /1   ]  3661.4516016         1
[INPUT] 0    0    [1    /1   ]  833.318800291        1
[INPUT] 0    0    [1    /1   ]  235.44669876         1
[INPUT] 0    0    [1    /1   ]  76.0926187113        1
[INPUT] 0    0    [1    /1   ]  10.3321632026        1
[INPUT] 0    0    [1    /1   ]  27.0311040373        1
[INPUT] 0    0    [1    /1   ]  0.313293029987       1
[INPUT] 0    0    [1    /1   ]  1.87873321793        1
[INPUT] 0    0    [1    /1   ]  3.02999697638        1
[INPUT] 1    0    [1    /1   ]  7.11657444296        1
[INPUT] 1    0    [1    /1   ]  23.1689939642        1
[INPUT] 1    0    [1    /1   ]  99.7864015927        1
[INPUT] 1    0    [1    /1   ]  0.266680697145       1
[INPUT] 1    0    [1    /1   ]  2.44183372893        1
[INPUT] 1    0    [1    /1   ]  0.834469902837       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8243237603260274, 1.0]], [0, [24413.794185924977, 1.0]], [0, [3661.4516015987306, 1.0]], [0, [833.318800290794, 1.0]], [0, [235.44669876034584, 1.0]], [0, [76.09261871132101, 1.0]], [0, [10.332163202634115, 1.0]], [0, [27.031104037295048, 1.0]], [0, [0.31329302998659486, 1.0]], [0, [1.8787332179300376, 1.0]], [0, [3.029996976382672, 1.0]], [1, [7.116574442960796, 1.0]], [1, [23.16899396420875, 1.0]], [1, [99.78640159272022, 1.0]], [1, [0.2666806971450912, 1.0]], [1, [2.4418337289319676, 1.0]], [1, [0.834469902837039, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82432376]
bas 1, expnt(s) = [24413.79418592]
bas 2, expnt(s) = [3661.4516016]
bas 3, expnt(s) = [833.31880029]
bas 4, expnt(s) = [235.44669876]
bas 5, expnt(s) = [76.09261871]
bas 6, expnt(s) = [10.3321632]
bas 7, expnt(s) = [27.03110404]
bas 8, expnt(s) = [0.31329303]
bas 9, expnt(s) = [1.87873322]
bas 10, expnt(s) = [3.02999698]
bas 11, expnt(s) = [7.11657444]
bas 12, expnt(s) = [23.16899396]
bas 13, expnt(s) = [99.78640159]
bas 14, expnt(s) = [0.2666807]
bas 15, expnt(s) = [2.44183373]
bas 16, expnt(s) = [0.8344699]
CPU time:       163.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.24323760e-01 2.18568911e+00 2.44137942e+04 4.93448103e+03
 3.66145160e+03 1.18920027e+03 8.33318800e+02 3.91853210e+02
 2.35446699e+02 1.51856882e+02 7.60926187e+01 6.50911466e+01
 1.03321632e+01 1.45599025e+01 2.70311040e+01 2.99511059e+01
 3.13293030e-01 1.05798150e+00 1.87873322e+00 4.05428113e+00
 3.02999698e+00 5.80225312e+00 7.11657444e+00 3.39096368e+01
 2.31689940e+01 1.48292219e+02 9.97864016e+01 9.20075772e+02
 2.66680697e-01 5.59079888e-01 2.44183373e+00 8.90490935e+00
 8.34469903e-01 2.32673937e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999632712153861
cond(S) = 2503.5987378405384
E1 = -183.58994877546957  E_coul = 55.08025584510489
init E= -128.509692930365
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775397560407447  LUMO = 0.804832613289944
  mo_energy =
[-3.25551117e+01 -1.85272236e+00 -7.75397560e-01 -7.75397560e-01
 -7.75397560e-01  8.04832613e-01  8.25858060e-01  8.25858060e-01
  8.25858060e-01  3.96027057e+00  3.96027057e+00  3.96027057e+00
  4.16061775e+00  1.29399549e+01  1.43653446e+01  1.43653446e+01
  1.43653446e+01  4.21582888e+01  5.30164542e+01  5.30164542e+01
  5.30164542e+01  1.46151960e+02  2.40840206e+02  2.40840206e+02
  2.40840206e+02  5.08776411e+02  1.87487242e+03  8.00371719e+03
  4.77707451e+04]
E1 = -182.08635409626166  E_coul = 53.54813244495629
cycle= 1 E= -128.538221651305  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518706
diis-c [-0.26905605  1.        ]
  HOMO = -0.884286272720927  LUMO = 0.775915254163404
  mo_energy =
[-3.28782684e+01 -1.96657233e+00 -8.84286273e-01 -8.84286273e-01
 -8.84286273e-01  7.75915254e-01  7.99028183e-01  7.99028183e-01
  7.99028183e-01  3.86282021e+00  3.86282021e+00  3.86282021e+00
  4.08507856e+00  1.27940811e+01  1.41746016e+01  1.41746016e+01
  1.41746016e+01  4.19128040e+01  5.27355246e+01  5.27355246e+01
  5.27355246e+01  1.45835592e+02  2.40493932e+02  2.40493932e+02
  2.40493932e+02  5.08415280e+02  1.87447492e+03  8.00329054e+03
  4.77702996e+04]
E1 = -182.84750581524028  E_coul = 54.30669711390417
cycle= 2 E= -128.540808701336  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0631
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263389
diis-c [-0.00067     0.33596849  0.66403151]
  HOMO = -0.848665839384596  LUMO = 0.785178328195539
  mo_energy =
[-3.27701846e+01 -1.92906389e+00 -8.48665839e-01 -8.48665839e-01
 -8.48665839e-01  7.85178328e-01  8.07774819e-01  8.07774819e-01
  8.07774819e-01  3.89443873e+00  3.89443873e+00  3.89443873e+00
  4.10949330e+00  1.28419981e+01  1.42377862e+01  1.42377862e+01
  1.42377862e+01  4.19949970e+01  5.28295305e+01  5.28295305e+01
  5.28295305e+01  1.45941133e+02  2.40607587e+02  2.40607587e+02
  2.40607587e+02  5.08531959e+02  1.87459696e+03  8.00341504e+03
  4.77704250e+04]
E1 = -182.58892496397232  E_coul = 54.04719690343543
cycle= 3 E= -128.541728060537  delta_E= -0.000919  |g|= 0.000537  |ddm|= 0.0218
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119624
diis-c [-2.06909072e-07 -2.36752479e-03 -4.55625466e-04  1.00282315e+00]
  HOMO = -0.848933052486797  LUMO = 0.785123227732724
  mo_energy =
[-3.27706677e+01 -1.92926558e+00 -8.48933052e-01 -8.48933052e-01
 -8.48933052e-01  7.85123228e-01  8.07731931e-01  8.07731931e-01
  8.07731931e-01  3.89425217e+00  3.89425217e+00  3.89425217e+00
  4.10935056e+00  1.28417407e+01  1.42374643e+01  1.42374643e+01
  1.42374643e+01  4.19946211e+01  5.28291041e+01  5.28291041e+01
  5.28291041e+01  1.45940649e+02  2.40607031e+02  2.40607031e+02
  2.40607031e+02  5.08531346e+02  1.87459621e+03  8.00341419e+03
  4.77704241e+04]
E1 = -182.5894230588838  E_coul = 54.04769496998605
cycle= 4 E= -128.541728088898  delta_E= -2.84e-08  |g|= 8.15e-05  |ddm|= 0.00044
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188575
diis-c [-1.11505827e-09  2.43005340e-04  4.67973082e-04 -1.87030388e-01
  1.18631941e+00]
  HOMO = -0.848976740484899  LUMO = 0.785110156620013
  mo_energy =
[-3.27707417e+01 -1.92929835e+00 -8.48976740e-01 -8.48976740e-01
 -8.48976740e-01  7.85110157e-01  8.07718301e-01  8.07718301e-01
  8.07718301e-01  3.89421150e+00  3.89421150e+00  3.89421150e+00
  4.10932029e+00  1.28416904e+01  1.42374042e+01  1.42374042e+01
  1.42374042e+01  4.19945554e+01  5.28290342e+01  5.28290342e+01
  5.28290342e+01  1.45940575e+02  2.40606953e+02  2.40606953e+02
  2.40606953e+02  5.08531263e+02  1.87459612e+03  8.00341409e+03
  4.77704240e+04]
E1 = -182.58955671847195  E_coul = 54.047828628829585
cycle= 5 E= -128.541728089642  delta_E= -7.45e-10  |g|= 6.01e-06  |ddm|= 7.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58955671847195  E_coul = 54.047828628829585
  HOMO = -0.848973575418219  LUMO = 0.785111495211388
  mo_energy =
[-3.27707346e+01 -1.92929439e+00 -8.48973575e-01 -8.48973575e-01
 -8.48973575e-01  7.85111495e-01  8.07719237e-01  8.07719237e-01
  8.07719237e-01  3.89421452e+00  3.89421452e+00  3.89421452e+00
  4.10932304e+00  1.28416949e+01  1.42374093e+01  1.42374093e+01
  1.42374093e+01  4.19945616e+01  5.28290409e+01  5.28290409e+01
  5.28290409e+01  1.45940582e+02  2.40606960e+02  2.40606960e+02
  2.40606960e+02  5.08531270e+02  1.87459612e+03  8.00341410e+03
  4.77704240e+04]
E1 = -182.5895407578878  E_coul = 54.04781266824243
Extra cycle  E= -128.541728089645  delta_E= -2.98e-12  |g|= 2.25e-06  |ddm|= 2.21e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2503.5987378405384
E1 = -182.5895407578878  E_coul = 54.04781266824243
init E= -128.541728089645
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848974702952192  LUMO = 0.785111285189266
  mo_energy =
[-3.27707382e+01 -1.92929543e+00 -8.48974703e-01 -8.48974703e-01
 -8.48974703e-01  7.85111285e-01  8.07718979e-01  8.07718979e-01
  8.07718979e-01  3.89421355e+00  3.89421355e+00  3.89421355e+00
  4.10932236e+00  1.28416934e+01  1.42374073e+01  1.42374073e+01
  1.42374073e+01  4.19945589e+01  5.28290378e+01  5.28290378e+01
  5.28290378e+01  1.45940578e+02  2.40606956e+02  2.40606956e+02
  2.40606956e+02  5.08531266e+02  1.87459612e+03  8.00341409e+03
  4.77704240e+04]
E1 = -182.5895496499448  E_coul = 54.04782156029921
cycle= 1 E= -128.541728089646  delta_E= -2.27e-13  |g|= 1.22e-06  |ddm|= 8.15e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5895496499448  E_coul = 54.04782156029921
  HOMO = -0.848974076718495  LUMO = 0.785111464623124
  mo_energy =
[-3.27707363e+01 -1.92929474e+00 -8.48974077e-01 -8.48974077e-01
 -8.48974077e-01  7.85111465e-01  8.07719136e-01  8.07719136e-01
  8.07719136e-01  3.89421411e+00  3.89421411e+00  3.89421411e+00
  4.10932281e+00  1.28416942e+01  1.42374084e+01  1.42374084e+01
  1.42374084e+01  4.19945604e+01  5.28290394e+01  5.28290394e+01
  5.28290394e+01  1.45940580e+02  2.40606958e+02  2.40606958e+02
  2.40606958e+02  5.08531268e+02  1.87459612e+03  8.00341409e+03
  4.77704240e+04]
E1 = -182.58954518532227  E_coul = 54.04781709567663
Extra cycle  E= -128.541728089646  delta_E= -5.68e-14  |g|= 6.06e-07  |ddm|= 3.82e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [8.24323760e-01 2.44137942e+04 3.66145160e+03 8.33318800e+02
 2.35446699e+02 7.60926187e+01 1.03321632e+01 2.70311040e+01
 3.13293030e-01 1.87873322e+00 3.02999698e+00 7.11657444e+00
 2.31689940e+01 9.97864016e+01 2.66680697e-01 2.44183373e+00
 8.34469903e-01]
grad_E = [ 9.02839899e-04  3.74715661e-10 -1.88244675e-08  3.41736073e-07
 -4.25235381e-06  4.81242250e-05  6.95719805e-05 -2.11206485e-04
 -1.69387584e-03 -1.27815754e-04 -1.00436517e-04  5.14768211e-05
 -8.08636507e-06  3.84909646e-07  1.33076528e-03 -9.82904615e-05
 -2.72648820e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.834572618621       1
[INPUT] 0    0    [1    /1   ]  24413.7941856        1
[INPUT] 0    0    [1    /1   ]  3661.45161944        1
[INPUT] 0    0    [1    /1   ]  833.318482495        1
[INPUT] 0    0    [1    /1   ]  235.450188848        1
[INPUT] 0    0    [1    /1   ]  76.060033711         1
[INPUT] 0    0    [1    /1   ]  10.4085944076        1
[INPUT] 0    0    [1    /1   ]  27.1383059554        1
[INPUT] 0    0    [1    /1   ]  0.313982596825       1
[INPUT] 0    0    [1    /1   ]  1.91004888298        1
[INPUT] 0    0    [1    /1   ]  3.11885572487        1
[INPUT] 1    0    [1    /1   ]  7.12044203843        1
[INPUT] 1    0    [1    /1   ]  23.1676902463        1
[INPUT] 1    0    [1    /1   ]  99.7864359716        1
[INPUT] 1    0    [1    /1   ]  0.26713295509        1
[INPUT] 1    0    [1    /1   ]  2.44219108769        1
[INPUT] 1    0    [1    /1   ]  0.834826909098       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8345726186205894, 1.0]], [0, [24413.79418556944, 1.0]], [0, [3661.451619435589, 1.0]], [0, [833.3184824954985, 1.0]], [0, [235.45018884813533, 1.0]], [0, [76.06003371097454, 1.0]], [0, [10.408594407645012, 1.0]], [0, [27.138305955425064, 1.0]], [0, [0.31398259682518026, 1.0]], [0, [1.9100488829773392, 1.0]], [0, [3.118855724874032, 1.0]], [1, [7.120442038434584, 1.0]], [1, [23.167690246311082, 1.0]], [1, [99.78643597162119, 1.0]], [1, [0.2671329550897533, 1.0]], [1, [2.442191087692044, 1.0]], [1, [0.8348269090980218, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83457262]
bas 1, expnt(s) = [24413.79418557]
bas 2, expnt(s) = [3661.45161944]
bas 3, expnt(s) = [833.3184825]
bas 4, expnt(s) = [235.45018885]
bas 5, expnt(s) = [76.06003371]
bas 6, expnt(s) = [10.40859441]
bas 7, expnt(s) = [27.13830596]
bas 8, expnt(s) = [0.3139826]
bas 9, expnt(s) = [1.91004888]
bas 10, expnt(s) = [3.11885572]
bas 11, expnt(s) = [7.12044204]
bas 12, expnt(s) = [23.16769025]
bas 13, expnt(s) = [99.78643597]
bas 14, expnt(s) = [0.26713296]
bas 15, expnt(s) = [2.44219109]
bas 16, expnt(s) = [0.83482691]
CPU time:       166.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.34572619e-01 2.20603868e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318482e+02 3.91853098e+02
 2.35450189e+02 1.51858570e+02 7.60600337e+01 6.50702401e+01
 1.04085944e+01 1.46406072e+01 2.71383060e+01 3.00401485e+01
 3.13982597e-01 1.05972751e+00 1.91004888e+00 4.10486034e+00
 3.11885572e+00 5.92941009e+00 7.12044204e+00 3.39326742e+01
 2.31676902e+01 1.48281788e+02 9.97864360e+01 9.20076168e+02
 2.67132955e-01 5.60265304e-01 2.44219109e+00 8.90653841e+00
 8.34826909e-01 2.32798373e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629343918079
cond(S) = 2409.767900674765
E1 = -183.5900697232519  E_coul = 55.08027949188308
init E= -128.509790231369
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775395679584659  LUMO = 0.813740482025007
  mo_energy =
[-3.25551178e+01 -1.85271785e+00 -7.75395680e-01 -7.75395680e-01
 -7.75395680e-01  8.13740482e-01  8.27213282e-01  8.27213282e-01
  8.27213282e-01  3.96303286e+00  3.96303286e+00  3.96303286e+00
  4.22993219e+00  1.32190456e+01  1.43723590e+01  1.43723590e+01
  1.43723590e+01  4.28268243e+01  5.30297021e+01  5.30297021e+01
  5.30297021e+01  1.47159740e+02  2.40850380e+02  2.40850380e+02
  2.40850380e+02  5.09851668e+02  1.87586383e+03  8.00459459e+03
  4.77714725e+04]
E1 = -182.0868646450414  E_coul = 53.54862307530722
cycle= 1 E= -128.538241569734  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518808
diis-c [-0.26916149  1.        ]
  HOMO = -0.884250315383209  LUMO = 0.784454461673375
  mo_energy =
[-3.28781913e+01 -1.96652044e+00 -8.84250315e-01 -8.84250315e-01
 -8.84250315e-01  7.84454462e-01  8.00352391e-01  8.00352391e-01
  8.00352391e-01  3.86560824e+00  3.86560824e+00  3.86560824e+00
  4.15312301e+00  1.30714010e+01  1.41816341e+01  1.41816341e+01
  1.41816341e+01  4.25807611e+01  5.27488514e+01  5.27488514e+01
  5.27488514e+01  1.46843427e+02  2.40504191e+02  2.40504191e+02
  2.40504191e+02  5.09490656e+02  1.87546643e+03  8.00416803e+03
  4.77710270e+04]
E1 = -182.84772664213645  E_coul = 54.306898992044886
cycle= 2 E= -128.540827650092  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0634
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263415
diis-c [-0.00067375  0.33594284  0.66405716]
  HOMO = -0.848643042873022  LUMO = 0.793837953331613
  mo_energy =
[-3.27701407e+01 -1.92902594e+00 -8.48643043e-01 -8.48643043e-01
 -8.48643043e-01  7.93837953e-01  8.09108588e-01  8.09108588e-01
  8.09108588e-01  3.89722014e+00  3.89722014e+00  3.89722014e+00
  4.17795524e+00  1.31199159e+01  1.42448070e+01  1.42448070e+01
  1.42448070e+01  4.26631434e+01  5.28428279e+01  5.28428279e+01
  5.28428279e+01  1.46948942e+02  2.40617811e+02  2.40617811e+02
  2.40617811e+02  5.09607292e+02  1.87558843e+03  8.00429249e+03
  4.77711524e+04]
E1 = -182.5892709997181  E_coul = 54.04752472018668
cycle= 3 E= -128.541746279531  delta_E= -0.000919  |g|= 0.000538  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119654
diis-c [-2.09921446e-07 -2.37391663e-03 -4.73172192e-04  1.00284709e+00]
  HOMO = -0.848909950377397  LUMO = 0.793782714223126
  mo_energy =
[-3.27706224e+01 -1.92922623e+00 -8.48909950e-01 -8.48909950e-01
 -8.48909950e-01  7.93782714e-01  8.09065720e-01  8.09065720e-01
  8.09065720e-01  3.89703404e+00  3.89703404e+00  3.89703404e+00
  4.17781077e+00  1.31196568e+01  1.42444859e+01  1.42444859e+01
  1.42444859e+01  4.26627676e+01  5.28424028e+01  5.28424028e+01
  5.28424028e+01  1.46948459e+02  2.40617256e+02  2.40617256e+02
  2.40617256e+02  5.09606679e+02  1.87558768e+03  8.00429164e+03
  4.77711515e+04]
E1 = -182.58976630093437  E_coul = 54.04801999274883
cycle= 4 E= -128.541746308186  delta_E= -2.87e-08  |g|= 8.2e-05  |ddm|= 0.000445
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018978
diis-c [-1.14291610e-09  2.46869175e-04  4.73521016e-04 -1.88852702e-01
  1.18813231e+00]
  HOMO = -0.848953798238701  LUMO = 0.793769573524519
  mo_energy =
[-3.27706967e+01 -1.92925887e+00 -8.48953798e-01 -8.48953798e-01
 -8.48953798e-01  7.93769574e-01  8.09052046e-01  8.09052046e-01
  8.09052046e-01  3.89699326e+00  3.89699326e+00  3.89699326e+00
  4.17778007e+00  1.31196060e+01  1.42444256e+01  1.42444256e+01
  1.42444256e+01  4.26627015e+01  5.28423327e+01  5.28423327e+01
  5.28423327e+01  1.46948384e+02  2.40617177e+02  2.40617177e+02
  2.40617177e+02  5.09606596e+02  1.87558759e+03  8.00429155e+03
  4.77711514e+04]
E1 = -182.58990073956147  E_coul = 54.04815443061723
cycle= 5 E= -128.541746308944  delta_E= -7.59e-10  |g|= 6.13e-06  |ddm|= 7.29e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58990073956147  E_coul = 54.04815443061723
  HOMO = -0.848950557365864  LUMO = 0.793770958493642
  mo_energy =
[-3.27706894e+01 -1.92925482e+00 -8.48950557e-01 -8.48950557e-01
 -8.48950557e-01  7.93770958e-01  8.09053007e-01  8.09053007e-01
  8.09053007e-01  3.89699636e+00  3.89699636e+00  3.89699636e+00
  4.17778292e+00  1.31196106e+01  1.42444309e+01  1.42444309e+01
  1.42444309e+01  4.26627079e+01  5.28423395e+01  5.28423395e+01
  5.28423395e+01  1.46948391e+02  2.40617184e+02  2.40617184e+02
  2.40617184e+02  5.09606603e+02  1.87558760e+03  8.00429155e+03
  4.77711514e+04]
E1 = -182.58988451299368  E_coul = 54.048138204046694
Extra cycle  E= -128.541746308947  delta_E= -2.73e-12  |g|= 2.29e-06  |ddm|= 2.33e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.34572619e-01 2.44137942e+04 3.66145162e+03 8.33318482e+02
 2.35450189e+02 7.60600337e+01 1.04085944e+01 2.71383060e+01
 3.13982597e-01 1.91004888e+00 3.11885572e+00 7.12044204e+00
 2.31676902e+01 9.97864360e+01 2.67132955e-01 2.44219109e+00
 8.34826909e-01]
E = -128.54174630894698
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.834572618621       1
[INPUT] 0    0    [1    /1   ]  24413.7941856        1
[INPUT] 0    0    [1    /1   ]  3661.45161944        1
[INPUT] 0    0    [1    /1   ]  833.318482495        1
[INPUT] 0    0    [1    /1   ]  235.450188848        1
[INPUT] 0    0    [1    /1   ]  76.060033711         1
[INPUT] 0    0    [1    /1   ]  10.4085944076        1
[INPUT] 0    0    [1    /1   ]  27.1383059554        1
[INPUT] 0    0    [1    /1   ]  0.313982596825       1
[INPUT] 0    0    [1    /1   ]  1.91004888298        1
[INPUT] 0    0    [1    /1   ]  3.11885572487        1
[INPUT] 1    0    [1    /1   ]  7.12044203843        1
[INPUT] 1    0    [1    /1   ]  23.1676902463        1
[INPUT] 1    0    [1    /1   ]  99.7864359716        1
[INPUT] 1    0    [1    /1   ]  0.26713295509        1
[INPUT] 1    0    [1    /1   ]  2.44219108769        1
[INPUT] 1    0    [1    /1   ]  0.834826909098       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8345726186205894, 1.0]], [0, [24413.79418556944, 1.0]], [0, [3661.451619435589, 1.0]], [0, [833.3184824954985, 1.0]], [0, [235.45018884813533, 1.0]], [0, [76.06003371097454, 1.0]], [0, [10.408594407645012, 1.0]], [0, [27.138305955425064, 1.0]], [0, [0.31398259682518026, 1.0]], [0, [1.9100488829773392, 1.0]], [0, [3.118855724874032, 1.0]], [1, [7.120442038434584, 1.0]], [1, [23.167690246311082, 1.0]], [1, [99.78643597162119, 1.0]], [1, [0.2671329550897533, 1.0]], [1, [2.442191087692044, 1.0]], [1, [0.8348269090980218, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.83457262]
bas 1, expnt(s) = [24413.79418557]
bas 2, expnt(s) = [3661.45161944]
bas 3, expnt(s) = [833.3184825]
bas 4, expnt(s) = [235.45018885]
bas 5, expnt(s) = [76.06003371]
bas 6, expnt(s) = [10.40859441]
bas 7, expnt(s) = [27.13830596]
bas 8, expnt(s) = [0.3139826]
bas 9, expnt(s) = [1.91004888]
bas 10, expnt(s) = [3.11885572]
bas 11, expnt(s) = [7.12044204]
bas 12, expnt(s) = [23.16769025]
bas 13, expnt(s) = [99.78643597]
bas 14, expnt(s) = [0.26713296]
bas 15, expnt(s) = [2.44219109]
bas 16, expnt(s) = [0.83482691]
CPU time:       167.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.34572619e-01 2.20603868e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318482e+02 3.91853098e+02
 2.35450189e+02 1.51858570e+02 7.60600337e+01 6.50702401e+01
 1.04085944e+01 1.46406072e+01 2.71383060e+01 3.00401485e+01
 3.13982597e-01 1.05972751e+00 1.91004888e+00 4.10486034e+00
 3.11885572e+00 5.92941009e+00 7.12044204e+00 3.39326742e+01
 2.31676902e+01 1.48281788e+02 9.97864360e+01 9.20076168e+02
 2.67132955e-01 5.60265304e-01 2.44219109e+00 8.90653841e+00
 8.34826909e-01 2.32798373e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629343918079
cond(S) = 2409.767900674765
E1 = -183.5900697232519  E_coul = 55.08027949188308
init E= -128.509790231369
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775395679584659  LUMO = 0.813740482025007
  mo_energy =
[-3.25551178e+01 -1.85271785e+00 -7.75395680e-01 -7.75395680e-01
 -7.75395680e-01  8.13740482e-01  8.27213282e-01  8.27213282e-01
  8.27213282e-01  3.96303286e+00  3.96303286e+00  3.96303286e+00
  4.22993219e+00  1.32190456e+01  1.43723590e+01  1.43723590e+01
  1.43723590e+01  4.28268243e+01  5.30297021e+01  5.30297021e+01
  5.30297021e+01  1.47159740e+02  2.40850380e+02  2.40850380e+02
  2.40850380e+02  5.09851668e+02  1.87586383e+03  8.00459459e+03
  4.77714725e+04]
E1 = -182.0868646450414  E_coul = 53.54862307530722
cycle= 1 E= -128.538241569734  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518808
diis-c [-0.26916149  1.        ]
  HOMO = -0.884250315383209  LUMO = 0.784454461673375
  mo_energy =
[-3.28781913e+01 -1.96652044e+00 -8.84250315e-01 -8.84250315e-01
 -8.84250315e-01  7.84454462e-01  8.00352391e-01  8.00352391e-01
  8.00352391e-01  3.86560824e+00  3.86560824e+00  3.86560824e+00
  4.15312301e+00  1.30714010e+01  1.41816341e+01  1.41816341e+01
  1.41816341e+01  4.25807611e+01  5.27488514e+01  5.27488514e+01
  5.27488514e+01  1.46843427e+02  2.40504191e+02  2.40504191e+02
  2.40504191e+02  5.09490656e+02  1.87546643e+03  8.00416803e+03
  4.77710270e+04]
E1 = -182.84772664213645  E_coul = 54.306898992044886
cycle= 2 E= -128.540827650092  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0634
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263415
diis-c [-0.00067375  0.33594284  0.66405716]
  HOMO = -0.848643042873022  LUMO = 0.793837953331613
  mo_energy =
[-3.27701407e+01 -1.92902594e+00 -8.48643043e-01 -8.48643043e-01
 -8.48643043e-01  7.93837953e-01  8.09108588e-01  8.09108588e-01
  8.09108588e-01  3.89722014e+00  3.89722014e+00  3.89722014e+00
  4.17795524e+00  1.31199159e+01  1.42448070e+01  1.42448070e+01
  1.42448070e+01  4.26631434e+01  5.28428279e+01  5.28428279e+01
  5.28428279e+01  1.46948942e+02  2.40617811e+02  2.40617811e+02
  2.40617811e+02  5.09607292e+02  1.87558843e+03  8.00429249e+03
  4.77711524e+04]
E1 = -182.5892709997181  E_coul = 54.04752472018668
cycle= 3 E= -128.541746279531  delta_E= -0.000919  |g|= 0.000538  |ddm|= 0.0218
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119654
diis-c [-2.09921446e-07 -2.37391663e-03 -4.73172192e-04  1.00284709e+00]
  HOMO = -0.848909950377397  LUMO = 0.793782714223126
  mo_energy =
[-3.27706224e+01 -1.92922623e+00 -8.48909950e-01 -8.48909950e-01
 -8.48909950e-01  7.93782714e-01  8.09065720e-01  8.09065720e-01
  8.09065720e-01  3.89703404e+00  3.89703404e+00  3.89703404e+00
  4.17781077e+00  1.31196568e+01  1.42444859e+01  1.42444859e+01
  1.42444859e+01  4.26627676e+01  5.28424028e+01  5.28424028e+01
  5.28424028e+01  1.46948459e+02  2.40617256e+02  2.40617256e+02
  2.40617256e+02  5.09606679e+02  1.87558768e+03  8.00429164e+03
  4.77711515e+04]
E1 = -182.58976630093437  E_coul = 54.04801999274883
cycle= 4 E= -128.541746308186  delta_E= -2.87e-08  |g|= 8.2e-05  |ddm|= 0.000445
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018978
diis-c [-1.14291610e-09  2.46869175e-04  4.73521016e-04 -1.88852702e-01
  1.18813231e+00]
  HOMO = -0.848953798238701  LUMO = 0.793769573524519
  mo_energy =
[-3.27706967e+01 -1.92925887e+00 -8.48953798e-01 -8.48953798e-01
 -8.48953798e-01  7.93769574e-01  8.09052046e-01  8.09052046e-01
  8.09052046e-01  3.89699326e+00  3.89699326e+00  3.89699326e+00
  4.17778007e+00  1.31196060e+01  1.42444256e+01  1.42444256e+01
  1.42444256e+01  4.26627015e+01  5.28423327e+01  5.28423327e+01
  5.28423327e+01  1.46948384e+02  2.40617177e+02  2.40617177e+02
  2.40617177e+02  5.09606596e+02  1.87558759e+03  8.00429155e+03
  4.77711514e+04]
E1 = -182.58990073956147  E_coul = 54.04815443061723
cycle= 5 E= -128.541746308944  delta_E= -7.59e-10  |g|= 6.13e-06  |ddm|= 7.29e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58990073956147  E_coul = 54.04815443061723
  HOMO = -0.848950557365864  LUMO = 0.793770958493642
  mo_energy =
[-3.27706894e+01 -1.92925482e+00 -8.48950557e-01 -8.48950557e-01
 -8.48950557e-01  7.93770958e-01  8.09053007e-01  8.09053007e-01
  8.09053007e-01  3.89699636e+00  3.89699636e+00  3.89699636e+00
  4.17778292e+00  1.31196106e+01  1.42444309e+01  1.42444309e+01
  1.42444309e+01  4.26627079e+01  5.28423395e+01  5.28423395e+01
  5.28423395e+01  1.46948391e+02  2.40617184e+02  2.40617184e+02
  2.40617184e+02  5.09606603e+02  1.87558760e+03  8.00429155e+03
  4.77711514e+04]
E1 = -182.58988451299368  E_coul = 54.048138204046694
Extra cycle  E= -128.541746308947  delta_E= -2.73e-12  |g|= 2.29e-06  |ddm|= 2.33e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2409.767900674765
E1 = -182.58988451299368  E_coul = 54.048138204046694
init E= -128.541746308947
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.848951702353065  LUMO = 0.793770742102439
  mo_energy =
[-3.27706931e+01 -1.92925589e+00 -8.48951702e-01 -8.48951702e-01
 -8.48951702e-01  7.93770742e-01  8.09052745e-01  8.09052745e-01
  8.09052745e-01  3.89699537e+00  3.89699537e+00  3.89699537e+00
  4.17778221e+00  1.31196091e+01  1.42444288e+01  1.42444288e+01
  1.42444288e+01  4.26627052e+01  5.28423364e+01  5.28423364e+01
  5.28423364e+01  1.46948388e+02  2.40617180e+02  2.40617180e+02
  2.40617180e+02  5.09606599e+02  1.87558759e+03  8.00429155e+03
  4.77711514e+04]
E1 = -182.58989356710046  E_coul = 54.04814725815313
cycle= 1 E= -128.541746308947  delta_E= -3.41e-13  |g|= 1.24e-06  |ddm|= 8.3e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.58989356710046  E_coul = 54.04814725815313
  HOMO = -0.848951064506706  LUMO = 0.793770927124165
  mo_energy =
[-3.27706911e+01 -1.92925519e+00 -8.48951065e-01 -8.48951065e-01
 -8.48951065e-01  7.93770927e-01  8.09052905e-01  8.09052905e-01
  8.09052905e-01  3.89699594e+00  3.89699594e+00  3.89699594e+00
  4.17778268e+00  1.31196099e+01  1.42444300e+01  1.42444300e+01
  1.42444300e+01  4.26627067e+01  5.28423381e+01  5.28423381e+01
  5.28423381e+01  1.46948390e+02  2.40617182e+02  2.40617182e+02
  2.40617182e+02  5.09606601e+02  1.87558759e+03  8.00429155e+03
  4.77711514e+04]
E1 = -182.58988902333076  E_coul = 54.04814271438323
Extra cycle  E= -128.541746308948  delta_E= -1.99e-13  |g|= 6.17e-07  |ddm|= 3.91e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [8.34572619e-01 2.44137942e+04 3.66145162e+03 8.33318482e+02
 2.35450189e+02 7.60600337e+01 1.04085944e+01 2.71383060e+01
 3.13982597e-01 1.91004888e+00 3.11885572e+00 7.12044204e+00
 2.31676902e+01 9.97864360e+01 2.67132955e-01 2.44219109e+00
 8.34826909e-01]
grad_E = [ 1.33213595e-03 -1.18271154e-10  6.87277380e-09 -1.58873938e-07
  1.06532961e-06  1.81359114e-05  3.16786285e-05 -1.45201271e-04
 -2.59256443e-03 -1.80651288e-04 -8.12020259e-05  1.07436252e-04
 -1.76153637e-05  8.02167545e-07  2.40972593e-03 -1.87436684e-04
 -5.18349023e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.834307895863       1
[INPUT] 0    0    [1    /1   ]  24413.7941848        1
[INPUT] 0    0    [1    /1   ]  3661.4516559         1
[INPUT] 0    0    [1    /1   ]  833.317831471        1
[INPUT] 0    0    [1    /1   ]  235.457360982        1
[INPUT] 0    0    [1    /1   ]  75.9930961238        1
[INPUT] 0    0    [1    /1   ]  10.5728208375        1
[INPUT] 0    0    [1    /1   ]  27.3583854567        1
[INPUT] 0    0    [1    /1   ]  0.313202640337       1
[INPUT] 0    0    [1    /1   ]  1.94033881458        1
[INPUT] 0    0    [1    /1   ]  3.29945345011        1
[INPUT] 1    0    [1    /1   ]  7.12881272322        1
[INPUT] 1    0    [1    /1   ]  23.1648299658        1
[INPUT] 1    0    [1    /1   ]  99.7865161889        1
[INPUT] 1    0    [1    /1   ]  0.267574708188       1
[INPUT] 1    0    [1    /1   ]  2.44419265402        1
[INPUT] 1    0    [1    /1   ]  0.835398851989       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8343078958627271, 1.0]], [0, [24413.794184843064, 1.0]], [0, [3661.4516558970763, 1.0]], [0, [833.3178314712108, 1.0]], [0, [235.4573609819021, 1.0]], [0, [75.99309612380277, 1.0]], [0, [10.572820837525073, 1.0]], [0, [27.35838545666258, 1.0]], [0, [0.3132026403371997, 1.0]], [0, [1.9403388145751168, 1.0]], [0, [3.2994534501089574, 1.0]], [1, [7.128812723224115, 1.0]], [1, [23.164829965758585, 1.0]], [1, [99.78651618893048, 1.0]], [1, [0.2675747081882784, 1.0]], [1, [2.444192654020623, 1.0]], [1, [0.8353988519886751, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8343079]
bas 1, expnt(s) = [24413.79418484]
bas 2, expnt(s) = [3661.4516559]
bas 3, expnt(s) = [833.31783147]
bas 4, expnt(s) = [235.45736098]
bas 5, expnt(s) = [75.99309612]
bas 6, expnt(s) = [10.57282084]
bas 7, expnt(s) = [27.35838546]
bas 8, expnt(s) = [0.31320264]
bas 9, expnt(s) = [1.94033881]
bas 10, expnt(s) = [3.29945345]
bas 11, expnt(s) = [7.12881272]
bas 12, expnt(s) = [23.16482997]
bas 13, expnt(s) = [99.78651619]
bas 14, expnt(s) = [0.26757471]
bas 15, expnt(s) = [2.44419265]
bas 16, expnt(s) = [0.83539885]
CPU time:       170.74
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.34307896e-01 2.20551385e+00 2.44137942e+04 4.93448103e+03
 3.66145166e+03 1.18920028e+03 8.33317831e+02 3.91852869e+02
 2.35457361e+02 1.51862040e+02 7.59930961e+01 6.50272860e+01
 1.05728208e+01 1.48135170e+01 2.73583855e+01 3.02226730e+01
 3.13202640e-01 1.05775256e+00 1.94033881e+00 4.15358596e+00
 3.29945345e+00 6.18509719e+00 7.12881272e+00 3.39825449e+01
 2.31648300e+01 1.48258905e+02 9.97865162e+01 9.20077093e+02
 2.67574708e-01 5.61423669e-01 2.44419265e+00 8.91566385e+00
 8.35398852e-01 2.32997754e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999626922171112
cond(S) = 2083.831224984586
E1 = -183.5902544002052  E_coul = 55.080278797303805
init E= -128.509975602901
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775395039025352  LUMO = 0.817102925413815
  mo_energy =
[-3.25551345e+01 -1.85271937e+00 -7.75395039e-01 -7.75395039e-01
 -7.75395039e-01  8.17102925e-01  8.28619585e-01  8.28619585e-01
  8.28619585e-01  3.96716937e+00  3.96716937e+00  3.96716937e+00
  4.28938996e+00  1.36092461e+01  1.43882586e+01  1.43882586e+01
  1.43882586e+01  4.39627263e+01  5.30604837e+01  5.30604837e+01
  5.30604837e+01  1.49013026e+02  2.40874095e+02  2.40874095e+02
  2.40874095e+02  5.11872954e+02  1.87773542e+03  8.00625252e+03
  4.77728473e+04]
E1 = -182.08749140142692  E_coul = 53.54921332906838
cycle= 1 E= -128.538278072359  delta_E= -0.0283  |g|= 0.204  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519079
diis-c [-0.26944351  1.        ]
  HOMO = -0.884204695593827  LUMO = 0.787632476830352
  mo_energy =
[-3.28781020e+01 -1.96646804e+00 -8.84204696e-01 -8.84204696e-01
 -8.84204696e-01  7.87632477e-01  8.01727600e-01  8.01727600e-01
  8.01727600e-01  3.86973494e+00  3.86973494e+00  3.86973494e+00
  4.21098787e+00  1.34585467e+01  1.41975114e+01  1.41975114e+01
  1.41975114e+01  4.37153909e+01  5.27797338e+01  5.27797338e+01
  5.27797338e+01  1.48696704e+02  2.40528013e+02  2.40528013e+02
  2.40528013e+02  5.11512103e+02  1.87733815e+03  8.00582609e+03
  4.77724019e+04]
E1 = -182.848043289483  E_coul = 54.30718040212804
cycle= 2 E= -128.540862887355  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0637
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263556
diis-c [-0.00068032  0.33593775  0.66406225]
  HOMO = -0.848612410377561  LUMO = 0.797077319656244
  mo_energy =
[-3.27700913e+01 -1.92898968e+00 -8.48612410e-01 -8.48612410e-01
 -8.48612410e-01  7.97077320e-01  8.10494861e-01  8.10494861e-01
  8.10494861e-01  3.90135263e+00  3.90135263e+00  3.90135263e+00
  4.23634672e+00  1.35080986e+01  1.42606887e+01  1.42606887e+01
  1.42606887e+01  4.37982011e+01  5.28736755e+01  5.28736755e+01
  5.28736755e+01  1.48802213e+02  2.40641590e+02  2.40641590e+02
  2.40641590e+02  5.11628682e+02  1.87746010e+03  8.00595051e+03
  4.77725273e+04]
E1 = -182.58973763892294  E_coul = 54.04795694408455
cycle= 3 E= -128.541780694838  delta_E= -0.000918  |g|= 0.000534  |ddm|= 0.0219
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00118662
diis-c [-2.10500399e-07 -2.37654248e-03 -5.22992693e-04  1.00289954e+00]
  HOMO = -0.84887704224675  LUMO = 0.797022881327124
  mo_energy =
[-3.27705674e+01 -1.92918700e+00 -8.48877042e-01 -8.48877042e-01
 -8.48877042e-01  7.97022881e-01  8.10452656e-01  8.10452656e-01
  8.10452656e-01  3.90116866e+00  3.90116866e+00  3.90116866e+00
  4.23620164e+00  1.35078386e+01  1.42603712e+01  1.42603712e+01
  1.42603712e+01  4.37978280e+01  5.28732555e+01  5.28732555e+01
  5.28732555e+01  1.48801735e+02  2.40641041e+02  2.40641041e+02
  2.40641041e+02  5.11628076e+02  1.87745936e+03  8.00594966e+03
  4.77725264e+04]
E1 = -182.59022277472448  E_coul = 54.04844205148324
cycle= 4 E= -128.541780723241  delta_E= -2.84e-08  |g|= 8.19e-05  |ddm|= 0.000431
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000189991
diis-c [-1.16542591e-09  2.49559184e-04  4.81862308e-04 -1.90212828e-01
  1.18948141e+00]
  HOMO = -0.848920807448859  LUMO = 0.797009802160686
  mo_energy =
[-3.27706416e+01 -1.92921937e+00 -8.48920807e-01 -8.48920807e-01
 -8.48920807e-01  7.97009802e-01  8.10439016e-01  8.10439016e-01
  8.10439016e-01  3.90112798e+00  3.90112798e+00  3.90112798e+00
  4.23617060e+00  1.35077872e+01  1.42603110e+01  1.42603110e+01
  1.42603110e+01  4.37977619e+01  5.28731855e+01  5.28731855e+01
  5.28731855e+01  1.48801660e+02  2.40640962e+02  2.40640962e+02
  2.40640962e+02  5.11627993e+02  1.87745926e+03  8.00594956e+03
  4.77725263e+04]
E1 = -182.59035747183444  E_coul = 54.048576747831056
cycle= 5 E= -128.541780724003  delta_E= -7.62e-10  |g|= 6.22e-06  |ddm|= 7.05e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59035747183444  E_coul = 54.048576747831056
  HOMO = -0.848917507192918  LUMO = 0.797011218149922
  mo_energy =
[-3.27706342e+01 -1.92921526e+00 -8.48917507e-01 -8.48917507e-01
 -8.48917507e-01  7.97011218e-01  8.10439996e-01  8.10439996e-01
  8.10439996e-01  3.90113113e+00  3.90113113e+00  3.90113113e+00
  4.23617355e+00  1.35077920e+01  1.42603164e+01  1.42603164e+01
  1.42603164e+01  4.37977684e+01  5.28731924e+01  5.28731924e+01
  5.28731924e+01  1.48801667e+02  2.40640970e+02  2.40640970e+02
  2.40640970e+02  5.11628000e+02  1.87745927e+03  8.00594957e+03
  4.77725263e+04]
E1 = -182.5903409951452  E_coul = 54.04856027113886
Extra cycle  E= -128.541780724006  delta_E= -2.96e-12  |g|= 2.32e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.34307896e-01 2.44137942e+04 3.66145166e+03 8.33317831e+02
 2.35457361e+02 7.59930961e+01 1.05728208e+01 2.73583855e+01
 3.13202640e-01 1.94033881e+00 3.29945345e+00 7.12881272e+00
 2.31648300e+01 9.97865162e+01 2.67574708e-01 2.44419265e+00
 8.35398852e-01]
E = -128.54178072400634
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.834307895863       1
[INPUT] 0    0    [1    /1   ]  24413.7941848        1
[INPUT] 0    0    [1    /1   ]  3661.4516559         1
[INPUT] 0    0    [1    /1   ]  833.317831471        1
[INPUT] 0    0    [1    /1   ]  235.457360982        1
[INPUT] 0    0    [1    /1   ]  75.9930961238        1
[INPUT] 0    0    [1    /1   ]  10.5728208375        1
[INPUT] 0    0    [1    /1   ]  27.3583854567        1
[INPUT] 0    0    [1    /1   ]  0.313202640337       1
[INPUT] 0    0    [1    /1   ]  1.94033881458        1
[INPUT] 0    0    [1    /1   ]  3.29945345011        1
[INPUT] 1    0    [1    /1   ]  7.12881272322        1
[INPUT] 1    0    [1    /1   ]  23.1648299658        1
[INPUT] 1    0    [1    /1   ]  99.7865161889        1
[INPUT] 1    0    [1    /1   ]  0.267574708188       1
[INPUT] 1    0    [1    /1   ]  2.44419265402        1
[INPUT] 1    0    [1    /1   ]  0.835398851989       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8343078958627271, 1.0]], [0, [24413.794184843064, 1.0]], [0, [3661.4516558970763, 1.0]], [0, [833.3178314712108, 1.0]], [0, [235.4573609819021, 1.0]], [0, [75.99309612380277, 1.0]], [0, [10.572820837525073, 1.0]], [0, [27.35838545666258, 1.0]], [0, [0.3132026403371997, 1.0]], [0, [1.9403388145751168, 1.0]], [0, [3.2994534501089574, 1.0]], [1, [7.128812723224115, 1.0]], [1, [23.164829965758585, 1.0]], [1, [99.78651618893048, 1.0]], [1, [0.2675747081882784, 1.0]], [1, [2.444192654020623, 1.0]], [1, [0.8353988519886751, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8343079]
bas 1, expnt(s) = [24413.79418484]
bas 2, expnt(s) = [3661.4516559]
bas 3, expnt(s) = [833.31783147]
bas 4, expnt(s) = [235.45736098]
bas 5, expnt(s) = [75.99309612]
bas 6, expnt(s) = [10.57282084]
bas 7, expnt(s) = [27.35838546]
bas 8, expnt(s) = [0.31320264]
bas 9, expnt(s) = [1.94033881]
bas 10, expnt(s) = [3.29945345]
bas 11, expnt(s) = [7.12881272]
bas 12, expnt(s) = [23.16482997]
bas 13, expnt(s) = [99.78651619]
bas 14, expnt(s) = [0.26757471]
bas 15, expnt(s) = [2.44419265]
bas 16, expnt(s) = [0.83539885]
CPU time:       171.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.34307896e-01 2.20551385e+00 2.44137942e+04 4.93448103e+03
 3.66145166e+03 1.18920028e+03 8.33317831e+02 3.91852869e+02
 2.35457361e+02 1.51862040e+02 7.59930961e+01 6.50272860e+01
 1.05728208e+01 1.48135170e+01 2.73583855e+01 3.02226730e+01
 3.13202640e-01 1.05775256e+00 1.94033881e+00 4.15358596e+00
 3.29945345e+00 6.18509719e+00 7.12881272e+00 3.39825449e+01
 2.31648300e+01 1.48258905e+02 9.97865162e+01 9.20077093e+02
 2.67574708e-01 5.61423669e-01 2.44419265e+00 8.91566385e+00
 8.35398852e-01 2.32997754e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999626922171112
cond(S) = 2083.831224984586
E1 = -183.5902544002052  E_coul = 55.080278797303805
init E= -128.509975602901
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775395039025352  LUMO = 0.817102925413815
  mo_energy =
[-3.25551345e+01 -1.85271937e+00 -7.75395039e-01 -7.75395039e-01
 -7.75395039e-01  8.17102925e-01  8.28619585e-01  8.28619585e-01
  8.28619585e-01  3.96716937e+00  3.96716937e+00  3.96716937e+00
  4.28938996e+00  1.36092461e+01  1.43882586e+01  1.43882586e+01
  1.43882586e+01  4.39627263e+01  5.30604837e+01  5.30604837e+01
  5.30604837e+01  1.49013026e+02  2.40874095e+02  2.40874095e+02
  2.40874095e+02  5.11872954e+02  1.87773542e+03  8.00625252e+03
  4.77728473e+04]
E1 = -182.08749140142692  E_coul = 53.54921332906838
cycle= 1 E= -128.538278072359  delta_E= -0.0283  |g|= 0.204  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519079
diis-c [-0.26944351  1.        ]
  HOMO = -0.884204695593827  LUMO = 0.787632476830352
  mo_energy =
[-3.28781020e+01 -1.96646804e+00 -8.84204696e-01 -8.84204696e-01
 -8.84204696e-01  7.87632477e-01  8.01727600e-01  8.01727600e-01
  8.01727600e-01  3.86973494e+00  3.86973494e+00  3.86973494e+00
  4.21098787e+00  1.34585467e+01  1.41975114e+01  1.41975114e+01
  1.41975114e+01  4.37153909e+01  5.27797338e+01  5.27797338e+01
  5.27797338e+01  1.48696704e+02  2.40528013e+02  2.40528013e+02
  2.40528013e+02  5.11512103e+02  1.87733815e+03  8.00582609e+03
  4.77724019e+04]
E1 = -182.848043289483  E_coul = 54.30718040212804
cycle= 2 E= -128.540862887355  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0637
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263556
diis-c [-0.00068032  0.33593775  0.66406225]
  HOMO = -0.848612410377561  LUMO = 0.797077319656244
  mo_energy =
[-3.27700913e+01 -1.92898968e+00 -8.48612410e-01 -8.48612410e-01
 -8.48612410e-01  7.97077320e-01  8.10494861e-01  8.10494861e-01
  8.10494861e-01  3.90135263e+00  3.90135263e+00  3.90135263e+00
  4.23634672e+00  1.35080986e+01  1.42606887e+01  1.42606887e+01
  1.42606887e+01  4.37982011e+01  5.28736755e+01  5.28736755e+01
  5.28736755e+01  1.48802213e+02  2.40641590e+02  2.40641590e+02
  2.40641590e+02  5.11628682e+02  1.87746010e+03  8.00595051e+03
  4.77725273e+04]
E1 = -182.58973763892294  E_coul = 54.04795694408455
cycle= 3 E= -128.541780694838  delta_E= -0.000918  |g|= 0.000534  |ddm|= 0.0219
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00118662
diis-c [-2.10500399e-07 -2.37654248e-03 -5.22992693e-04  1.00289954e+00]
  HOMO = -0.84887704224675  LUMO = 0.797022881327124
  mo_energy =
[-3.27705674e+01 -1.92918700e+00 -8.48877042e-01 -8.48877042e-01
 -8.48877042e-01  7.97022881e-01  8.10452656e-01  8.10452656e-01
  8.10452656e-01  3.90116866e+00  3.90116866e+00  3.90116866e+00
  4.23620164e+00  1.35078386e+01  1.42603712e+01  1.42603712e+01
  1.42603712e+01  4.37978280e+01  5.28732555e+01  5.28732555e+01
  5.28732555e+01  1.48801735e+02  2.40641041e+02  2.40641041e+02
  2.40641041e+02  5.11628076e+02  1.87745936e+03  8.00594966e+03
  4.77725264e+04]
E1 = -182.59022277472448  E_coul = 54.04844205148324
cycle= 4 E= -128.541780723241  delta_E= -2.84e-08  |g|= 8.19e-05  |ddm|= 0.000431
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000189991
diis-c [-1.16542591e-09  2.49559184e-04  4.81862308e-04 -1.90212828e-01
  1.18948141e+00]
  HOMO = -0.848920807448859  LUMO = 0.797009802160686
  mo_energy =
[-3.27706416e+01 -1.92921937e+00 -8.48920807e-01 -8.48920807e-01
 -8.48920807e-01  7.97009802e-01  8.10439016e-01  8.10439016e-01
  8.10439016e-01  3.90112798e+00  3.90112798e+00  3.90112798e+00
  4.23617060e+00  1.35077872e+01  1.42603110e+01  1.42603110e+01
  1.42603110e+01  4.37977619e+01  5.28731855e+01  5.28731855e+01
  5.28731855e+01  1.48801660e+02  2.40640962e+02  2.40640962e+02
  2.40640962e+02  5.11627993e+02  1.87745926e+03  8.00594956e+03
  4.77725263e+04]
E1 = -182.59035747183444  E_coul = 54.048576747831056
cycle= 5 E= -128.541780724003  delta_E= -7.62e-10  |g|= 6.22e-06  |ddm|= 7.05e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59035747183444  E_coul = 54.048576747831056
  HOMO = -0.848917507192918  LUMO = 0.797011218149922
  mo_energy =
[-3.27706342e+01 -1.92921526e+00 -8.48917507e-01 -8.48917507e-01
 -8.48917507e-01  7.97011218e-01  8.10439996e-01  8.10439996e-01
  8.10439996e-01  3.90113113e+00  3.90113113e+00  3.90113113e+00
  4.23617355e+00  1.35077920e+01  1.42603164e+01  1.42603164e+01
  1.42603164e+01  4.37977684e+01  5.28731924e+01  5.28731924e+01
  5.28731924e+01  1.48801667e+02  2.40640970e+02  2.40640970e+02
  2.40640970e+02  5.11628000e+02  1.87745927e+03  8.00594957e+03
  4.77725263e+04]
E1 = -182.5903409951452  E_coul = 54.04856027113886
Extra cycle  E= -128.541780724006  delta_E= -2.96e-12  |g|= 2.32e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 2083.831224984586
E1 = -182.5903409951452  E_coul = 54.04856027113886
init E= -128.541780724006
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.84891866899991  LUMO = 0.797010996385846
  mo_energy =
[-3.27706379e+01 -1.92921635e+00 -8.48918669e-01 -8.48918669e-01
 -8.48918669e-01  7.97010996e-01  8.10439730e-01  8.10439730e-01
  8.10439730e-01  3.90113013e+00  3.90113013e+00  3.90113013e+00
  4.23617282e+00  1.35077904e+01  1.42603143e+01  1.42603143e+01
  1.42603143e+01  4.37977657e+01  5.28731893e+01  5.28731893e+01
  5.28731893e+01  1.48801664e+02  2.40640966e+02  2.40640966e+02
  2.40640966e+02  5.11627996e+02  1.87745927e+03  8.00594957e+03
  4.77725263e+04]
E1 = -182.59035019157423  E_coul = 54.04856946756769
cycle= 1 E= -128.541780724007  delta_E= -1.99e-13  |g|= 1.26e-06  |ddm|= 8.4e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.59035019157423  E_coul = 54.04856946756769
  HOMO = -0.84891802100772  LUMO = 0.797011185448614
  mo_energy =
[-3.27706359e+01 -1.92921563e+00 -8.48918021e-01 -8.48918021e-01
 -8.48918021e-01  7.97011185e-01  8.10439894e-01  8.10439894e-01
  8.10439894e-01  3.90113071e+00  3.90113071e+00  3.90113071e+00
  4.23617330e+00  1.35077913e+01  1.42603154e+01  1.42603154e+01
  1.42603154e+01  4.37977672e+01  5.28731910e+01  5.28731910e+01
  5.28731910e+01  1.48801666e+02  2.40640968e+02  2.40640968e+02
  2.40640968e+02  5.11627998e+02  1.87745927e+03  8.00594957e+03
  4.77725263e+04]
E1 = -182.59034557723837  E_coul = 54.04856485323159
Extra cycle  E= -128.541780724007  delta_E= -2.27e-13  |g|= 6.27e-07  |ddm|= 3.99e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [8.34307896e-01 2.44137942e+04 3.66145166e+03 8.33317831e+02
 2.35457361e+02 7.59930961e+01 1.05728208e+01 2.73583855e+01
 3.13202640e-01 1.94033881e+00 3.29945345e+00 7.12881272e+00
 2.31648300e+01 9.97865162e+01 2.67574708e-01 2.44419265e+00
 8.35398852e-01]
grad_E = [ 1.53740772e-03 -1.06071924e-09  5.61355038e-08 -1.11165498e-06
  1.11727243e-05 -3.65523497e-05 -2.60130145e-05 -3.34935054e-05
 -2.90183799e-03 -2.15470640e-04 -7.00374408e-05  1.82683576e-04
 -3.32069338e-05  1.53072865e-06  3.43331485e-03 -2.60911492e-04
 -8.18417601e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.812402998413       1
[INPUT] 0    0    [1    /1   ]  24413.7941838        1
[INPUT] 0    0    [1    /1   ]  3661.45170774        1
[INPUT] 0    0    [1    /1   ]  833.316907981        1
[INPUT] 0    0    [1    /1   ]  235.467518809        1
[INPUT] 0    0    [1    /1   ]  75.8978635681        1
[INPUT] 0    0    [1    /1   ]  10.8289572396        1
[INPUT] 0    0    [1    /1   ]  27.669290235         1
[INPUT] 0    0    [1    /1   ]  0.307429333313       1
[INPUT] 0    0    [1    /1   ]  1.98506402359        1
[INPUT] 0    0    [1    /1   ]  3.55422268095        1
[INPUT] 1    0    [1    /1   ]  7.14097872447        1
[INPUT] 1    0    [1    /1   ]  23.1605425469        1
[INPUT] 1    0    [1    /1   ]  99.7866403618        1
[INPUT] 1    0    [1    /1   ]  0.267606123008       1
[INPUT] 1    0    [1    /1   ]  2.44885496082        1
[INPUT] 1    0    [1    /1   ]  0.83616353885        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.812402998413282, 1.0]], [0, [24413.794183809303, 1.0]], [0, [3661.451707744269, 1.0]], [0, [833.3169079808393, 1.0]], [0, [235.46751880924555, 1.0]], [0, [75.89786356805058, 1.0]], [0, [10.828957239581843, 1.0]], [0, [27.669290235034676, 1.0]], [0, [0.30742933331265204, 1.0]], [0, [1.9850640235919732, 1.0]], [0, [3.554222680950117, 1.0]], [1, [7.14097872447111, 1.0]], [1, [23.160542546939258, 1.0]], [1, [99.7866403618263, 1.0]], [1, [0.26760612300769465, 1.0]], [1, [2.448854960822914, 1.0]], [1, [0.8361635388499861, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.812403]
bas 1, expnt(s) = [24413.79418381]
bas 2, expnt(s) = [3661.45170774]
bas 3, expnt(s) = [833.31690798]
bas 4, expnt(s) = [235.46751881]
bas 5, expnt(s) = [75.89786357]
bas 6, expnt(s) = [10.82895724]
bas 7, expnt(s) = [27.66929024]
bas 8, expnt(s) = [0.30742933]
bas 9, expnt(s) = [1.98506402]
bas 10, expnt(s) = [3.55422268]
bas 11, expnt(s) = [7.14097872]
bas 12, expnt(s) = [23.16054255]
bas 13, expnt(s) = [99.78664036]
bas 14, expnt(s) = [0.26760612]
bas 15, expnt(s) = [2.44885496]
bas 16, expnt(s) = [0.83616354]
CPU time:       175.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12402998e-01 2.16194013e+00 2.44137942e+04 4.93448103e+03
 3.66145171e+03 1.18920029e+03 8.33316908e+02 3.91852543e+02
 2.35467519e+02 1.51866953e+02 7.58978636e+01 6.49661585e+01
 1.08289572e+01 1.50818634e+01 2.76692902e+01 3.04799000e+01
 3.07429333e-01 1.04309533e+00 1.98506402e+00 4.22518679e+00
 3.55422268e+00 6.53993602e+00 7.14097872e+00 3.40550535e+01
 2.31605425e+01 1.48224606e+02 9.97866404e+01 9.20078524e+02
 2.67606123e-01 5.61506063e-01 2.44885496e+00 8.93692724e+00
 8.36163539e-01 2.33264379e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629363030156
cond(S) = 1701.8869433504854
E1 = -183.59043578473242  E_coul = 55.080228756282565
init E= -128.51020702845
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775397490533017  LUMO = 0.802405988999444
  mo_energy =
[-3.25551582e+01 -1.85273277e+00 -7.75397491e-01 -7.75397491e-01
 -7.75397491e-01  8.02405989e-01  8.28978535e-01  8.28978535e-01
  8.28978535e-01  3.97170029e+00  3.97170029e+00  3.97170029e+00
  4.30006998e+00  1.40577590e+01  1.44137030e+01  1.44137030e+01
  1.44137030e+01  4.54929869e+01  5.31092263e+01  5.31092263e+01
  5.31092263e+01  1.51608456e+02  2.40911505e+02  2.40911505e+02
  2.40911505e+02  5.14733120e+02  1.88039112e+03  8.00860663e+03
  4.77747997e+04]
E1 = -182.08768089970852  E_coul = 53.549364844513775
cycle= 1 E= -128.538316055195  delta_E= -0.0281  |g|= 0.204  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519593
diis-c [-0.26997638  1.        ]
  HOMO = -0.884189825650305  LUMO = 0.773319999381543
  mo_energy =
[-3.28780870e+01 -1.96647049e+00 -8.84189826e-01 -8.84189826e-01
 -8.84189826e-01  7.73319999e-01  8.02073879e-01  8.02073879e-01
  8.02073879e-01  3.87415012e+00  3.87415012e+00  3.87415012e+00
  4.21996414e+00  1.39027997e+01  1.42228330e+01  1.42228330e+01
  1.42228330e+01  4.52436765e+01  5.28285140e+01  5.28285140e+01
  5.28285140e+01  1.51291969e+02  2.40565459e+02  2.40565459e+02
  2.40565459e+02  5.14372367e+02  1.87999390e+03  8.00818024e+03
  4.77743544e+04]
E1 = -182.84823070724204  E_coul = 54.30733028925886
cycle= 2 E= -128.540900417983  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263896
diis-c [-0.00068946  0.33599637  0.66400363]
  HOMO = -0.848600125305401  LUMO = 0.782641968748605
  mo_energy =
[-3.27700880e+01 -1.92899558e+00 -8.48600125e-01 -8.48600125e-01
 -8.48600125e-01  7.82641969e-01  8.10848974e-01  8.10848974e-01
  8.10848974e-01  3.90580649e+00  3.90580649e+00  3.90580649e+00
  4.24589034e+00  1.39538039e+01  1.42860571e+01  1.42860571e+01
  1.42860571e+01  4.53271629e+01  5.29224467e+01  5.29224467e+01
  5.29224467e+01  1.51397527e+02  2.40679022e+02  2.40679022e+02
  2.40679022e+02  5.14488916e+02  1.88011583e+03  8.00830464e+03
  4.77744797e+04]
E1 = -182.58997685373868  E_coul = 54.048158758631644
cycle= 3 E= -128.541818095107  delta_E= -0.000918  |g|= 0.00052  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115946
diis-c [-2.07033923e-07 -2.37093349e-03 -6.23030450e-04  1.00299396e+00]
  HOMO = -0.848859283348954  LUMO = 0.782590154321303
  mo_energy =
[-3.27705519e+01 -1.92918790e+00 -8.48859283e-01 -8.48859283e-01
 -8.48859283e-01  7.82590154e-01  8.10808577e-01  8.10808577e-01
  8.10808577e-01  3.90562726e+00  3.90562726e+00  3.90562726e+00
  4.24574738e+00  1.39535457e+01  1.42857480e+01  1.42857480e+01
  1.42857480e+01  4.53267974e+01  5.29220375e+01  5.29220375e+01
  5.29220375e+01  1.51397060e+02  2.40678486e+02  2.40678486e+02
  2.40678486e+02  5.14488323e+02  1.88011510e+03  8.00830381e+03
  4.77744788e+04]
E1 = -182.59044096963908  E_coul = 54.0486228475139
cycle= 4 E= -128.541818122125  delta_E= -2.7e-08  |g|= 8.07e-05  |ddm|= 0.000388
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187916
diis-c [-1.16356819e-09  2.48633025e-04  4.91562262e-04 -1.90109002e-01
  1.18936881e+00]
  HOMO = -0.848902451445873  LUMO = 0.782577434362384
  mo_energy =
[-3.27706251e+01 -1.92921979e+00 -8.48902451e-01 -8.48902451e-01
 -8.48902451e-01  7.82577434e-01  8.10795138e-01  8.10795138e-01
  8.10795138e-01  3.90558710e+00  3.90558710e+00  3.90558710e+00
  4.24571637e+00  1.39534942e+01  1.42856885e+01  1.42856885e+01
  1.42856885e+01  4.53267319e+01  5.29219684e+01  5.29219684e+01
  5.29219684e+01  1.51396987e+02  2.40678408e+02  2.40678408e+02
  2.40678408e+02  5.14488241e+02  1.88011501e+03  8.00830371e+03
  4.77744787e+04]
E1 = -182.59057462219457  E_coul = 54.048756499328434
cycle= 5 E= -128.541818122866  delta_E= -7.41e-10  |g|= 6.21e-06  |ddm|= 6.47e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59057462219457  E_coul = 54.048756499328434
  HOMO = -0.84889915015819  LUMO = 0.782578830573736
  mo_energy =
[-3.27706177e+01 -1.92921569e+00 -8.48899150e-01 -8.48899150e-01
 -8.48899150e-01  7.82578831e-01  8.10796117e-01  8.10796117e-01
  8.10796117e-01  3.90559026e+00  3.90559026e+00  3.90559026e+00
  4.24571937e+00  1.39534991e+01  1.42856939e+01  1.42856939e+01
  1.42856939e+01  4.53267384e+01  5.29219754e+01  5.29219754e+01
  5.29219754e+01  1.51396994e+02  2.40678415e+02  2.40678415e+02
  2.40678415e+02  5.14488248e+02  1.88011501e+03  8.00830372e+03
  4.77744787e+04]
E1 = -182.59055802304638  E_coul = 54.048739900177566
Extra cycle  E= -128.541818122869  delta_E= -2.7e-12  |g|= 2.34e-06  |ddm|= 2.34e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.12402998e-01 2.44137942e+04 3.66145171e+03 8.33316908e+02
 2.35467519e+02 7.58978636e+01 1.08289572e+01 2.76692902e+01
 3.07429333e-01 1.98506402e+00 3.55422268e+00 7.14097872e+00
 2.31605425e+01 9.97866404e+01 2.67606123e-01 2.44885496e+00
 8.36163539e-01]
E = -128.54181812286882
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.812402998413       1
[INPUT] 0    0    [1    /1   ]  24413.7941838        1
[INPUT] 0    0    [1    /1   ]  3661.45170774        1
[INPUT] 0    0    [1    /1   ]  833.316907981        1
[INPUT] 0    0    [1    /1   ]  235.467518809        1
[INPUT] 0    0    [1    /1   ]  75.8978635681        1
[INPUT] 0    0    [1    /1   ]  10.8289572396        1
[INPUT] 0    0    [1    /1   ]  27.669290235         1
[INPUT] 0    0    [1    /1   ]  0.307429333313       1
[INPUT] 0    0    [1    /1   ]  1.98506402359        1
[INPUT] 0    0    [1    /1   ]  3.55422268095        1
[INPUT] 1    0    [1    /1   ]  7.14097872447        1
[INPUT] 1    0    [1    /1   ]  23.1605425469        1
[INPUT] 1    0    [1    /1   ]  99.7866403618        1
[INPUT] 1    0    [1    /1   ]  0.267606123008       1
[INPUT] 1    0    [1    /1   ]  2.44885496082        1
[INPUT] 1    0    [1    /1   ]  0.83616353885        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.812402998413282, 1.0]], [0, [24413.794183809303, 1.0]], [0, [3661.451707744269, 1.0]], [0, [833.3169079808393, 1.0]], [0, [235.46751880924555, 1.0]], [0, [75.89786356805058, 1.0]], [0, [10.828957239581843, 1.0]], [0, [27.669290235034676, 1.0]], [0, [0.30742933331265204, 1.0]], [0, [1.9850640235919732, 1.0]], [0, [3.554222680950117, 1.0]], [1, [7.14097872447111, 1.0]], [1, [23.160542546939258, 1.0]], [1, [99.7866403618263, 1.0]], [1, [0.26760612300769465, 1.0]], [1, [2.448854960822914, 1.0]], [1, [0.8361635388499861, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.812403]
bas 1, expnt(s) = [24413.79418381]
bas 2, expnt(s) = [3661.45170774]
bas 3, expnt(s) = [833.31690798]
bas 4, expnt(s) = [235.46751881]
bas 5, expnt(s) = [75.89786357]
bas 6, expnt(s) = [10.82895724]
bas 7, expnt(s) = [27.66929024]
bas 8, expnt(s) = [0.30742933]
bas 9, expnt(s) = [1.98506402]
bas 10, expnt(s) = [3.55422268]
bas 11, expnt(s) = [7.14097872]
bas 12, expnt(s) = [23.16054255]
bas 13, expnt(s) = [99.78664036]
bas 14, expnt(s) = [0.26760612]
bas 15, expnt(s) = [2.44885496]
bas 16, expnt(s) = [0.83616354]
CPU time:       175.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.12402998e-01 2.16194013e+00 2.44137942e+04 4.93448103e+03
 3.66145171e+03 1.18920029e+03 8.33316908e+02 3.91852543e+02
 2.35467519e+02 1.51866953e+02 7.58978636e+01 6.49661585e+01
 1.08289572e+01 1.50818634e+01 2.76692902e+01 3.04799000e+01
 3.07429333e-01 1.04309533e+00 1.98506402e+00 4.22518679e+00
 3.55422268e+00 6.53993602e+00 7.14097872e+00 3.40550535e+01
 2.31605425e+01 1.48224606e+02 9.97866404e+01 9.20078524e+02
 2.67606123e-01 5.61506063e-01 2.44885496e+00 8.93692724e+00
 8.36163539e-01 2.33264379e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629363030156
cond(S) = 1701.8869433504854
E1 = -183.59043578473242  E_coul = 55.080228756282565
init E= -128.51020702845
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775397490533017  LUMO = 0.802405988999444
  mo_energy =
[-3.25551582e+01 -1.85273277e+00 -7.75397491e-01 -7.75397491e-01
 -7.75397491e-01  8.02405989e-01  8.28978535e-01  8.28978535e-01
  8.28978535e-01  3.97170029e+00  3.97170029e+00  3.97170029e+00
  4.30006998e+00  1.40577590e+01  1.44137030e+01  1.44137030e+01
  1.44137030e+01  4.54929869e+01  5.31092263e+01  5.31092263e+01
  5.31092263e+01  1.51608456e+02  2.40911505e+02  2.40911505e+02
  2.40911505e+02  5.14733120e+02  1.88039112e+03  8.00860663e+03
  4.77747997e+04]
E1 = -182.08768089970852  E_coul = 53.549364844513775
cycle= 1 E= -128.538316055195  delta_E= -0.0281  |g|= 0.204  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519593
diis-c [-0.26997638  1.        ]
  HOMO = -0.884189825650305  LUMO = 0.773319999381543
  mo_energy =
[-3.28780870e+01 -1.96647049e+00 -8.84189826e-01 -8.84189826e-01
 -8.84189826e-01  7.73319999e-01  8.02073879e-01  8.02073879e-01
  8.02073879e-01  3.87415012e+00  3.87415012e+00  3.87415012e+00
  4.21996414e+00  1.39027997e+01  1.42228330e+01  1.42228330e+01
  1.42228330e+01  4.52436765e+01  5.28285140e+01  5.28285140e+01
  5.28285140e+01  1.51291969e+02  2.40565459e+02  2.40565459e+02
  2.40565459e+02  5.14372367e+02  1.87999390e+03  8.00818024e+03
  4.77743544e+04]
E1 = -182.84823070724204  E_coul = 54.30733028925886
cycle= 2 E= -128.540900417983  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263896
diis-c [-0.00068946  0.33599637  0.66400363]
  HOMO = -0.848600125305401  LUMO = 0.782641968748605
  mo_energy =
[-3.27700880e+01 -1.92899558e+00 -8.48600125e-01 -8.48600125e-01
 -8.48600125e-01  7.82641969e-01  8.10848974e-01  8.10848974e-01
  8.10848974e-01  3.90580649e+00  3.90580649e+00  3.90580649e+00
  4.24589034e+00  1.39538039e+01  1.42860571e+01  1.42860571e+01
  1.42860571e+01  4.53271629e+01  5.29224467e+01  5.29224467e+01
  5.29224467e+01  1.51397527e+02  2.40679022e+02  2.40679022e+02
  2.40679022e+02  5.14488916e+02  1.88011583e+03  8.00830464e+03
  4.77744797e+04]
E1 = -182.58997685373868  E_coul = 54.048158758631644
cycle= 3 E= -128.541818095107  delta_E= -0.000918  |g|= 0.00052  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115946
diis-c [-2.07033923e-07 -2.37093349e-03 -6.23030450e-04  1.00299396e+00]
  HOMO = -0.848859283348954  LUMO = 0.782590154321303
  mo_energy =
[-3.27705519e+01 -1.92918790e+00 -8.48859283e-01 -8.48859283e-01
 -8.48859283e-01  7.82590154e-01  8.10808577e-01  8.10808577e-01
  8.10808577e-01  3.90562726e+00  3.90562726e+00  3.90562726e+00
  4.24574738e+00  1.39535457e+01  1.42857480e+01  1.42857480e+01
  1.42857480e+01  4.53267974e+01  5.29220375e+01  5.29220375e+01
  5.29220375e+01  1.51397060e+02  2.40678486e+02  2.40678486e+02
  2.40678486e+02  5.14488323e+02  1.88011510e+03  8.00830381e+03
  4.77744788e+04]
E1 = -182.59044096963908  E_coul = 54.0486228475139
cycle= 4 E= -128.541818122125  delta_E= -2.7e-08  |g|= 8.07e-05  |ddm|= 0.000388
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187916
diis-c [-1.16356819e-09  2.48633025e-04  4.91562262e-04 -1.90109002e-01
  1.18936881e+00]
  HOMO = -0.848902451445873  LUMO = 0.782577434362384
  mo_energy =
[-3.27706251e+01 -1.92921979e+00 -8.48902451e-01 -8.48902451e-01
 -8.48902451e-01  7.82577434e-01  8.10795138e-01  8.10795138e-01
  8.10795138e-01  3.90558710e+00  3.90558710e+00  3.90558710e+00
  4.24571637e+00  1.39534942e+01  1.42856885e+01  1.42856885e+01
  1.42856885e+01  4.53267319e+01  5.29219684e+01  5.29219684e+01
  5.29219684e+01  1.51396987e+02  2.40678408e+02  2.40678408e+02
  2.40678408e+02  5.14488241e+02  1.88011501e+03  8.00830371e+03
  4.77744787e+04]
E1 = -182.59057462219457  E_coul = 54.048756499328434
cycle= 5 E= -128.541818122866  delta_E= -7.41e-10  |g|= 6.21e-06  |ddm|= 6.47e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59057462219457  E_coul = 54.048756499328434
  HOMO = -0.84889915015819  LUMO = 0.782578830573736
  mo_energy =
[-3.27706177e+01 -1.92921569e+00 -8.48899150e-01 -8.48899150e-01
 -8.48899150e-01  7.82578831e-01  8.10796117e-01  8.10796117e-01
  8.10796117e-01  3.90559026e+00  3.90559026e+00  3.90559026e+00
  4.24571937e+00  1.39534991e+01  1.42856939e+01  1.42856939e+01
  1.42856939e+01  4.53267384e+01  5.29219754e+01  5.29219754e+01
  5.29219754e+01  1.51396994e+02  2.40678415e+02  2.40678415e+02
  2.40678415e+02  5.14488248e+02  1.88011501e+03  8.00830372e+03
  4.77744787e+04]
E1 = -182.59055802304638  E_coul = 54.048739900177566
Extra cycle  E= -128.541818122869  delta_E= -2.7e-12  |g|= 2.34e-06  |ddm|= 2.34e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.16 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1701.8869433504854
E1 = -182.59055802304638  E_coul = 54.048739900177566
init E= -128.541818122869
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.848900321254739  LUMO = 0.782578608819896
  mo_energy =
[-3.27706214e+01 -1.92921678e+00 -8.48900321e-01 -8.48900321e-01
 -8.48900321e-01  7.82578609e-01  8.10795848e-01  8.10795848e-01
  8.10795848e-01  3.90558924e+00  3.90558924e+00  3.90558924e+00
  4.24571861e+00  1.39534974e+01  1.42856918e+01  1.42856918e+01
  1.42856918e+01  4.53267356e+01  5.29219722e+01  5.29219722e+01
  5.29219722e+01  1.51396991e+02  2.40678411e+02  2.40678411e+02
  2.40678411e+02  5.14488244e+02  1.88011501e+03  8.00830372e+03
  4.77744787e+04]
E1 = -182.59056726592578  E_coul = 54.04874914305654
cycle= 1 E= -128.541818122869  delta_E= -4.26e-13  |g|= 1.27e-06  |ddm|= 8.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59056726592578  E_coul = 54.04874914305654
  HOMO = -0.848899670089483  LUMO = 0.78257879619723
  mo_energy =
[-3.27706194e+01 -1.92921607e+00 -8.48899670e-01 -8.48899670e-01
 -8.48899670e-01  7.82578796e-01  8.10796012e-01  8.10796012e-01
  8.10796012e-01  3.90558983e+00  3.90558983e+00  3.90558983e+00
  4.24571910e+00  1.39534984e+01  1.42856930e+01  1.42856930e+01
  1.42856930e+01  4.53267371e+01  5.29219739e+01  5.29219739e+01
  5.29219739e+01  1.51396992e+02  2.40678413e+02  2.40678413e+02
  2.40678413e+02  5.14488246e+02  1.88011501e+03  8.00830372e+03
  4.77744787e+04]
E1 = -182.59056262538036  E_coul = 54.048744502510715
Extra cycle  E= -128.54181812287  delta_E= -3.98e-13  |g|= 6.3e-07  |ddm|= 4.07e-07
    CPU time for scf_cycle      0.44 sec, wall time      0.44 sec
exp = [8.12402998e-01 2.44137942e+04 3.66145171e+03 8.33316908e+02
 2.35467519e+02 7.58978636e+01 1.08289572e+01 2.76692902e+01
 3.07429333e-01 1.98506402e+00 3.55422268e+00 7.14097872e+00
 2.31605425e+01 9.97866404e+01 2.67606123e-01 2.44885496e+00
 8.36163539e-01]
grad_E = [ 7.32443190e-04 -2.24356424e-09  1.18210289e-07 -2.29881251e-06
  2.37185788e-05 -9.99571249e-05 -8.58735771e-05  8.13192587e-05
 -1.47154294e-03 -5.95026196e-05 -7.66414472e-05  2.33948789e-04
 -4.93262044e-05  2.36204607e-06  3.30825817e-03 -2.30069428e-04
 -9.32131157e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.777920175257       1
[INPUT] 0    0    [1    /1   ]  24413.7941835        1
[INPUT] 0    0    [1    /1   ]  3661.45172543        1
[INPUT] 0    0    [1    /1   ]  833.316588582        1
[INPUT] 0    0    [1    /1   ]  235.471092577        1
[INPUT] 0    0    [1    /1   ]  75.8645961058        1
[INPUT] 0    0    [1    /1   ]  10.9245953634        1
[INPUT] 0    0    [1    /1   ]  27.7786763564        1
[INPUT] 0    0    [1    /1   ]  0.300793148894       1
[INPUT] 0    0    [1    /1   ]  1.91041486296        1
[INPUT] 0    0    [1    /1   ]  3.64259551443        1
[INPUT] 1    0    [1    /1   ]  7.14521253523        1
[INPUT] 1    0    [1    /1   ]  23.1588446028        1
[INPUT] 1    0    [1    /1   ]  99.7866967056        1
[INPUT] 1    0    [1    /1   ]  0.267332768455       1
[INPUT] 1    0    [1    /1   ]  2.45391746921        1
[INPUT] 1    0    [1    /1   ]  0.83750795107        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7779201752565076, 1.0]], [0, [24413.79418345797, 1.0]], [0, [3661.451725430974, 1.0]], [0, [833.316588581856, 1.0]], [0, [235.47109257737316, 1.0]], [0, [75.86459610577876, 1.0]], [0, [10.924595363427532, 1.0]], [0, [27.778676356404087, 1.0]], [0, [0.3007931488939521, 1.0]], [0, [1.9104148629598734, 1.0]], [0, [3.642595514432164, 1.0]], [1, [7.145212535231603, 1.0]], [1, [23.158844602809864, 1.0]], [1, [99.78669670556735, 1.0]], [1, [0.26733276845462123, 1.0]], [1, [2.4539174692053796, 1.0]], [1, [0.8375079510704254, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77792018]
bas 1, expnt(s) = [24413.79418346]
bas 2, expnt(s) = [3661.45172543]
bas 3, expnt(s) = [833.31658858]
bas 4, expnt(s) = [235.47109258]
bas 5, expnt(s) = [75.86459611]
bas 6, expnt(s) = [10.92459536]
bas 7, expnt(s) = [27.77867636]
bas 8, expnt(s) = [0.30079315]
bas 9, expnt(s) = [1.91041486]
bas 10, expnt(s) = [3.64259551]
bas 11, expnt(s) = [7.14521254]
bas 12, expnt(s) = [23.1588446]
bas 13, expnt(s) = [99.78669671]
bas 14, expnt(s) = [0.26733277]
bas 15, expnt(s) = [2.45391747]
bas 16, expnt(s) = [0.83750795]
CPU time:       179.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.77920175e-01 2.09274494e+00 2.44137942e+04 4.93448103e+03
 3.66145173e+03 1.18920030e+03 8.33316589e+02 3.91852430e+02
 2.35471093e+02 1.51868682e+02 7.58645961e+01 6.49448005e+01
 1.09245954e+01 1.51816524e+01 2.77786764e+01 3.05702285e+01
 3.00793149e-01 1.02616212e+00 1.91041486e+00 4.10545022e+00
 3.64259551e+00 6.66151846e+00 7.14521254e+00 3.40802939e+01
 2.31588446e+01 1.48211022e+02 9.97866967e+01 9.20079173e+02
 2.67332768e-01 5.60789195e-01 2.45391747e+00 8.96002730e+00
 8.37507951e-01 2.33733287e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999630518895408
cond(S) = 1416.4080762734943
E1 = -183.59042607142393  E_coul = 55.08018581835308
init E= -128.510240253071
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400859041074  LUMO = 0.772440770986591
  mo_energy =
[-3.25551654e+01 -1.85274256e+00 -7.75400859e-01 -7.75400859e-01
 -7.75400859e-01  7.72440771e-01  8.28658233e-01  8.28658233e-01
  8.28658233e-01  3.97690343e+00  3.97690343e+00  3.97690343e+00
  4.14965184e+00  1.38417612e+01  1.44345407e+01  1.44345407e+01
  1.44345407e+01  4.55354336e+01  5.31402414e+01  5.31402414e+01
  5.31402414e+01  1.52045881e+02  2.40934648e+02  2.40934648e+02
  2.40934648e+02  5.15313077e+02  1.88094546e+03  8.00910109e+03
  4.77752104e+04]
E1 = -182.08714657362918  E_coul = 53.54882316573805
cycle= 1 E= -128.538323407891  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519801
diis-c [-0.27019291  1.        ]
  HOMO = -0.88423490922286  LUMO = 0.744467298135769
  mo_energy =
[-3.28781618e+01 -1.96653650e+00 -8.84234909e-01 -8.84234909e-01
 -8.84234909e-01  7.44467298e-01  8.01725035e-01  8.01725035e-01
  8.01725035e-01  3.87915172e+00  3.87915172e+00  3.87915172e+00
  4.07099133e+00  1.36863819e+01  1.42435336e+01  1.42435336e+01
  1.42435336e+01  4.52852857e+01  5.28594697e+01  5.28594697e+01
  5.28594697e+01  1.51729158e+02  2.40588541e+02  2.40588541e+02
  2.40588541e+02  5.14952250e+02  1.88054817e+03  8.00867463e+03
  4.77747650e+04]
E1 = -182.84799542725503  E_coul = 54.30708673954814
cycle= 2 E= -128.540908687707  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264078
diis-c [-0.0006905   0.33606073  0.66393927]
  HOMO = -0.848633953232788  LUMO = 0.753425196844558
  mo_energy =
[-3.27701330e+01 -1.92905008e+00 -8.48633953e-01 -8.48633953e-01
 -8.48633953e-01  7.53425197e-01  8.10508184e-01  8.10508184e-01
  8.10508184e-01  3.91086825e+00  3.91086825e+00  3.91086825e+00
  4.09644088e+00  1.37375293e+01  1.43068061e+01  1.43068061e+01
  1.43068061e+01  4.53690648e+01  5.29534256e+01  5.29534256e+01
  5.29534256e+01  1.51834802e+02  2.40702133e+02  2.40702133e+02
  2.40702133e+02  5.15068835e+02  1.88067013e+03  8.00879907e+03
  4.77748904e+04]
E1 = -182.58961035313362  E_coul = 54.04778316424516
cycle= 3 E= -128.541827188888  delta_E= -0.000919  |g|= 0.000516  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00114969
diis-c [-2.04759063e-07 -2.37197994e-03 -6.63237524e-04  1.00303522e+00]
  HOMO = -0.848892522431348  LUMO = 0.75337461252007
  mo_energy =
[-3.27705942e+01 -1.92924300e+00 -8.48892522e-01 -8.48892522e-01
 -8.48892522e-01  7.53374613e-01  8.10467737e-01  8.10467737e-01
  8.10467737e-01  3.91068901e+00  3.91068901e+00  3.91068901e+00
  4.09630074e+00  1.37372718e+01  1.43064980e+01  1.43064980e+01
  1.43064980e+01  4.53687003e+01  5.29530187e+01  5.29530187e+01
  5.29530187e+01  1.51834338e+02  2.40701600e+02  2.40701600e+02
  2.40701600e+02  5.15068246e+02  1.88066941e+03  8.00879824e+03
  4.77748895e+04]
E1 = -182.59006571396634  E_coul = 54.048238498434706
cycle= 4 E= -128.541827215532  delta_E= -2.66e-08  |g|= 8.03e-05  |ddm|= 0.00037
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186517
diis-c [-1.13804862e-09  2.44762737e-04  4.91946071e-04 -1.88332070e-01
  1.18759536e+00]
  HOMO = -0.848935623246884  LUMO = 0.753362153716631
  mo_energy =
[-3.27706671e+01 -1.92927514e+00 -8.48935623e-01 -8.48935623e-01
 -8.48935623e-01  7.53362154e-01  8.10454263e-01  8.10454263e-01
  8.10454263e-01  3.91064882e+00  3.91064882e+00  3.91064882e+00
  4.09627016e+00  1.37372203e+01  1.43064386e+01  1.43064386e+01
  1.43064386e+01  4.53686348e+01  5.29529497e+01  5.29529497e+01
  5.29529497e+01  1.51834265e+02  2.40701523e+02  2.40701523e+02
  2.40701523e+02  5.15068164e+02  1.88066932e+03  8.00879815e+03
  4.77748894e+04]
E1 = -182.59019815286368  E_coul = 54.04837093660152
cycle= 5 E= -128.541827216262  delta_E= -7.31e-10  |g|= 6.1e-06  |ddm|= 6.27e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59019815286368  E_coul = 54.04837093660152
  HOMO = -0.848932391167195  LUMO = 0.753363475726542
  mo_energy =
[-3.27706599e+01 -1.92927111e+00 -8.48932391e-01 -8.48932391e-01
 -8.48932391e-01  7.53363476e-01  8.10455219e-01  8.10455219e-01
  8.10455219e-01  3.91065192e+00  3.91065192e+00  3.91065192e+00
  4.09627305e+00  1.37372251e+01  1.43064439e+01  1.43064439e+01
  1.43064439e+01  4.53686412e+01  5.29529566e+01  5.29529566e+01
  5.29529566e+01  1.51834272e+02  2.40701530e+02  2.40701530e+02
  2.40701530e+02  5.15068171e+02  1.88066932e+03  8.00879815e+03
  4.77748894e+04]
E1 = -182.59018174118003  E_coul = 54.04835452491486
Extra cycle  E= -128.541827216265  delta_E= -3.01e-12  |g|= 2.31e-06  |ddm|= 2.23e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.77920175e-01 2.44137942e+04 3.66145173e+03 8.33316589e+02
 2.35471093e+02 7.58645961e+01 1.09245954e+01 2.77786764e+01
 3.00793149e-01 1.91041486e+00 3.64259551e+00 7.14521254e+00
 2.31588446e+01 9.97866967e+01 2.67332768e-01 2.45391747e+00
 8.37507951e-01]
E = -128.54182721626518
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:53:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.777920175257       1
[INPUT] 0    0    [1    /1   ]  24413.7941835        1
[INPUT] 0    0    [1    /1   ]  3661.45172543        1
[INPUT] 0    0    [1    /1   ]  833.316588582        1
[INPUT] 0    0    [1    /1   ]  235.471092577        1
[INPUT] 0    0    [1    /1   ]  75.8645961058        1
[INPUT] 0    0    [1    /1   ]  10.9245953634        1
[INPUT] 0    0    [1    /1   ]  27.7786763564        1
[INPUT] 0    0    [1    /1   ]  0.300793148894       1
[INPUT] 0    0    [1    /1   ]  1.91041486296        1
[INPUT] 0    0    [1    /1   ]  3.64259551443        1
[INPUT] 1    0    [1    /1   ]  7.14521253523        1
[INPUT] 1    0    [1    /1   ]  23.1588446028        1
[INPUT] 1    0    [1    /1   ]  99.7866967056        1
[INPUT] 1    0    [1    /1   ]  0.267332768455       1
[INPUT] 1    0    [1    /1   ]  2.45391746921        1
[INPUT] 1    0    [1    /1   ]  0.83750795107        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7779201752565076, 1.0]], [0, [24413.79418345797, 1.0]], [0, [3661.451725430974, 1.0]], [0, [833.316588581856, 1.0]], [0, [235.47109257737316, 1.0]], [0, [75.86459610577876, 1.0]], [0, [10.924595363427532, 1.0]], [0, [27.778676356404087, 1.0]], [0, [0.3007931488939521, 1.0]], [0, [1.9104148629598734, 1.0]], [0, [3.642595514432164, 1.0]], [1, [7.145212535231603, 1.0]], [1, [23.158844602809864, 1.0]], [1, [99.78669670556735, 1.0]], [1, [0.26733276845462123, 1.0]], [1, [2.4539174692053796, 1.0]], [1, [0.8375079510704254, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77792018]
bas 1, expnt(s) = [24413.79418346]
bas 2, expnt(s) = [3661.45172543]
bas 3, expnt(s) = [833.31658858]
bas 4, expnt(s) = [235.47109258]
bas 5, expnt(s) = [75.86459611]
bas 6, expnt(s) = [10.92459536]
bas 7, expnt(s) = [27.77867636]
bas 8, expnt(s) = [0.30079315]
bas 9, expnt(s) = [1.91041486]
bas 10, expnt(s) = [3.64259551]
bas 11, expnt(s) = [7.14521254]
bas 12, expnt(s) = [23.1588446]
bas 13, expnt(s) = [99.78669671]
bas 14, expnt(s) = [0.26733277]
bas 15, expnt(s) = [2.45391747]
bas 16, expnt(s) = [0.83750795]
CPU time:       180.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.77920175e-01 2.09274494e+00 2.44137942e+04 4.93448103e+03
 3.66145173e+03 1.18920030e+03 8.33316589e+02 3.91852430e+02
 2.35471093e+02 1.51868682e+02 7.58645961e+01 6.49448005e+01
 1.09245954e+01 1.51816524e+01 2.77786764e+01 3.05702285e+01
 3.00793149e-01 1.02616212e+00 1.91041486e+00 4.10545022e+00
 3.64259551e+00 6.66151846e+00 7.14521254e+00 3.40802939e+01
 2.31588446e+01 1.48211022e+02 9.97866967e+01 9.20079173e+02
 2.67332768e-01 5.60789195e-01 2.45391747e+00 8.96002730e+00
 8.37507951e-01 2.33733287e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999630518895408
cond(S) = 1416.4080762734943
E1 = -183.59042607142393  E_coul = 55.08018581835308
init E= -128.510240253071
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400859041074  LUMO = 0.772440770986591
  mo_energy =
[-3.25551654e+01 -1.85274256e+00 -7.75400859e-01 -7.75400859e-01
 -7.75400859e-01  7.72440771e-01  8.28658233e-01  8.28658233e-01
  8.28658233e-01  3.97690343e+00  3.97690343e+00  3.97690343e+00
  4.14965184e+00  1.38417612e+01  1.44345407e+01  1.44345407e+01
  1.44345407e+01  4.55354336e+01  5.31402414e+01  5.31402414e+01
  5.31402414e+01  1.52045881e+02  2.40934648e+02  2.40934648e+02
  2.40934648e+02  5.15313077e+02  1.88094546e+03  8.00910109e+03
  4.77752104e+04]
E1 = -182.08714657362918  E_coul = 53.54882316573805
cycle= 1 E= -128.538323407891  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519801
diis-c [-0.27019291  1.        ]
  HOMO = -0.88423490922286  LUMO = 0.744467298135769
  mo_energy =
[-3.28781618e+01 -1.96653650e+00 -8.84234909e-01 -8.84234909e-01
 -8.84234909e-01  7.44467298e-01  8.01725035e-01  8.01725035e-01
  8.01725035e-01  3.87915172e+00  3.87915172e+00  3.87915172e+00
  4.07099133e+00  1.36863819e+01  1.42435336e+01  1.42435336e+01
  1.42435336e+01  4.52852857e+01  5.28594697e+01  5.28594697e+01
  5.28594697e+01  1.51729158e+02  2.40588541e+02  2.40588541e+02
  2.40588541e+02  5.14952250e+02  1.88054817e+03  8.00867463e+03
  4.77747650e+04]
E1 = -182.84799542725503  E_coul = 54.30708673954814
cycle= 2 E= -128.540908687707  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264078
diis-c [-0.0006905   0.33606073  0.66393927]
  HOMO = -0.848633953232788  LUMO = 0.753425196844558
  mo_energy =
[-3.27701330e+01 -1.92905008e+00 -8.48633953e-01 -8.48633953e-01
 -8.48633953e-01  7.53425197e-01  8.10508184e-01  8.10508184e-01
  8.10508184e-01  3.91086825e+00  3.91086825e+00  3.91086825e+00
  4.09644088e+00  1.37375293e+01  1.43068061e+01  1.43068061e+01
  1.43068061e+01  4.53690648e+01  5.29534256e+01  5.29534256e+01
  5.29534256e+01  1.51834802e+02  2.40702133e+02  2.40702133e+02
  2.40702133e+02  5.15068835e+02  1.88067013e+03  8.00879907e+03
  4.77748904e+04]
E1 = -182.58961035313362  E_coul = 54.04778316424516
cycle= 3 E= -128.541827188888  delta_E= -0.000919  |g|= 0.000516  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00114969
diis-c [-2.04759063e-07 -2.37197994e-03 -6.63237524e-04  1.00303522e+00]
  HOMO = -0.848892522431348  LUMO = 0.75337461252007
  mo_energy =
[-3.27705942e+01 -1.92924300e+00 -8.48892522e-01 -8.48892522e-01
 -8.48892522e-01  7.53374613e-01  8.10467737e-01  8.10467737e-01
  8.10467737e-01  3.91068901e+00  3.91068901e+00  3.91068901e+00
  4.09630074e+00  1.37372718e+01  1.43064980e+01  1.43064980e+01
  1.43064980e+01  4.53687003e+01  5.29530187e+01  5.29530187e+01
  5.29530187e+01  1.51834338e+02  2.40701600e+02  2.40701600e+02
  2.40701600e+02  5.15068246e+02  1.88066941e+03  8.00879824e+03
  4.77748895e+04]
E1 = -182.59006571396634  E_coul = 54.048238498434706
cycle= 4 E= -128.541827215532  delta_E= -2.66e-08  |g|= 8.03e-05  |ddm|= 0.00037
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186517
diis-c [-1.13804862e-09  2.44762737e-04  4.91946071e-04 -1.88332070e-01
  1.18759536e+00]
  HOMO = -0.848935623246884  LUMO = 0.753362153716631
  mo_energy =
[-3.27706671e+01 -1.92927514e+00 -8.48935623e-01 -8.48935623e-01
 -8.48935623e-01  7.53362154e-01  8.10454263e-01  8.10454263e-01
  8.10454263e-01  3.91064882e+00  3.91064882e+00  3.91064882e+00
  4.09627016e+00  1.37372203e+01  1.43064386e+01  1.43064386e+01
  1.43064386e+01  4.53686348e+01  5.29529497e+01  5.29529497e+01
  5.29529497e+01  1.51834265e+02  2.40701523e+02  2.40701523e+02
  2.40701523e+02  5.15068164e+02  1.88066932e+03  8.00879815e+03
  4.77748894e+04]
E1 = -182.59019815286368  E_coul = 54.04837093660152
cycle= 5 E= -128.541827216262  delta_E= -7.31e-10  |g|= 6.1e-06  |ddm|= 6.27e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59019815286368  E_coul = 54.04837093660152
  HOMO = -0.848932391167195  LUMO = 0.753363475726542
  mo_energy =
[-3.27706599e+01 -1.92927111e+00 -8.48932391e-01 -8.48932391e-01
 -8.48932391e-01  7.53363476e-01  8.10455219e-01  8.10455219e-01
  8.10455219e-01  3.91065192e+00  3.91065192e+00  3.91065192e+00
  4.09627305e+00  1.37372251e+01  1.43064439e+01  1.43064439e+01
  1.43064439e+01  4.53686412e+01  5.29529566e+01  5.29529566e+01
  5.29529566e+01  1.51834272e+02  2.40701530e+02  2.40701530e+02
  2.40701530e+02  5.15068171e+02  1.88066932e+03  8.00879815e+03
  4.77748894e+04]
E1 = -182.59018174118003  E_coul = 54.04835452491486
Extra cycle  E= -128.541827216265  delta_E= -3.01e-12  |g|= 2.31e-06  |ddm|= 2.23e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1416.4080762734943
E1 = -182.59018174118003  E_coul = 54.04835452491486
init E= -128.541827216265
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.848933550629427  LUMO = 0.753363265532296
  mo_energy =
[-3.27706635e+01 -1.92927219e+00 -8.48933551e-01 -8.48933551e-01
 -8.48933551e-01  7.53363266e-01  8.10454952e-01  8.10454952e-01
  8.10454952e-01  3.91065091e+00  3.91065091e+00  3.91065091e+00
  4.09627231e+00  1.37372235e+01  1.43064419e+01  1.43064419e+01
  1.43064419e+01  4.53686384e+01  5.29529534e+01  5.29529534e+01
  5.29529534e+01  1.51834268e+02  2.40701526e+02  2.40701526e+02
  2.40701526e+02  5.15068167e+02  1.88066932e+03  8.00879815e+03
  4.77748894e+04]
E1 = -182.59019085967918  E_coul = 54.04836364341355
cycle= 1 E= -128.541827216266  delta_E= -4.55e-13  |g|= 1.25e-06  |ddm|= 8.25e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.59019085967918  E_coul = 54.04836364341355
  HOMO = -0.848932908465161  LUMO = 0.75336344333463
  mo_energy =
[-3.27706616e+01 -1.92927148e+00 -8.48932908e-01 -8.48932908e-01
 -8.48932908e-01  7.53363443e-01  8.10455114e-01  8.10455114e-01
  8.10455114e-01  3.91065149e+00  3.91065149e+00  3.91065149e+00
  4.09627279e+00  1.37372244e+01  1.43064430e+01  1.43064430e+01
  1.43064430e+01  4.53686400e+01  5.29529551e+01  5.29529551e+01
  5.29529551e+01  1.51834270e+02  2.40701528e+02  2.40701528e+02
  2.40701528e+02  5.15068169e+02  1.88066932e+03  8.00879815e+03
  4.77748894e+04]
E1 = -182.59018627817187  E_coul = 54.048359061906616
Extra cycle  E= -128.541827216265  delta_E= 3.69e-13  |g|= 6.22e-07  |ddm|= 4.01e-07
    CPU time for scf_cycle      0.44 sec, wall time      0.44 sec
exp = [7.77920175e-01 2.44137942e+04 3.66145173e+03 8.33316589e+02
 2.35471093e+02 7.58645961e+01 1.09245954e+01 2.77786764e+01
 3.00793149e-01 1.91041486e+00 3.64259551e+00 7.14521254e+00
 2.31588446e+01 9.97866967e+01 2.67332768e-01 2.45391747e+00
 8.37507951e-01]
grad_E = [ 1.45221883e-04 -2.57454041e-09  1.35599952e-07 -2.62642172e-06
  2.70696573e-05 -1.14104469e-04 -4.16357021e-05  8.90084016e-05
 -3.34755076e-04 -5.81729764e-06 -1.00237625e-04  1.68785049e-04
 -4.53717093e-05  2.31151918e-06  1.59120232e-03 -5.56405635e-05
 -5.18291420e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.780534297389       1
[INPUT] 0    0    [1    /1   ]  24413.7941835        1
[INPUT] 0    0    [1    /1   ]  3661.45172334        1
[INPUT] 0    0    [1    /1   ]  833.31662765         1
[INPUT] 0    0    [1    /1   ]  235.47064791         1
[INPUT] 0    0    [1    /1   ]  75.8684094066        1
[INPUT] 0    0    [1    /1   ]  10.9280981249        1
[INPUT] 0    0    [1    /1   ]  27.7648978674        1
[INPUT] 0    0    [1    /1   ]  0.303126357537       1
[INPUT] 0    0    [1    /1   ]  1.9078505617         1
[INPUT] 0    0    [1    /1   ]  3.63535684763        1
[INPUT] 1    0    [1    /1   ]  7.14428160414        1
[INPUT] 1    0    [1    /1   ]  23.158981794         1
[INPUT] 1    0    [1    /1   ]  99.786693518         1
[INPUT] 1    0    [1    /1   ]  0.267037733849       1
[INPUT] 1    0    [1    /1   ]  2.45552341424        1
[INPUT] 1    0    [1    /1   ]  0.83797207695        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7805342973890415, 1.0]], [0, [24413.794183498874, 1.0]], [0, [3661.4517233425718, 1.0]], [0, [833.3166276503352, 1.0]], [0, [235.47064790970234, 1.0]], [0, [75.86840940663771, 1.0]], [0, [10.928098124911193, 1.0]], [0, [27.76489786739505, 1.0]], [0, [0.3031263575371577, 1.0]], [0, [1.9078505617025625, 1.0]], [0, [3.6353568476275315, 1.0]], [1, [7.144281604138266, 1.0]], [1, [23.15898179402764, 1.0]], [1, [99.78669351799512, 1.0]], [1, [0.2670377338490358, 1.0]], [1, [2.455523414243891, 1.0]], [1, [0.8379720769497827, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7805343]
bas 1, expnt(s) = [24413.7941835]
bas 2, expnt(s) = [3661.45172334]
bas 3, expnt(s) = [833.31662765]
bas 4, expnt(s) = [235.47064791]
bas 5, expnt(s) = [75.86840941]
bas 6, expnt(s) = [10.92809812]
bas 7, expnt(s) = [27.76489787]
bas 8, expnt(s) = [0.30312636]
bas 9, expnt(s) = [1.90785056]
bas 10, expnt(s) = [3.63535685]
bas 11, expnt(s) = [7.1442816]
bas 12, expnt(s) = [23.15898179]
bas 13, expnt(s) = [99.78669352]
bas 14, expnt(s) = [0.26703773]
bas 15, expnt(s) = [2.45552341]
bas 16, expnt(s) = [0.83797208]
CPU time:       183.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.80534297e-01 2.09801707e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920030e+03 8.33316628e+02 3.91852444e+02
 2.35470648e+02 1.51868467e+02 7.58684094e+01 6.49472488e+01
 1.09280981e+01 1.51853031e+01 2.77648979e+01 3.05588555e+01
 3.03126358e-01 1.03212619e+00 1.90785056e+00 4.10131654e+00
 3.63535685e+00 6.65158752e+00 7.14428160e+00 3.40747437e+01
 2.31589818e+01 1.48212120e+02 9.97866935e+01 9.20079137e+02
 2.67037734e-01 5.60015677e-01 2.45552341e+00 8.96735767e+00
 8.37972077e-01 2.33895209e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999630772116415
cond(S) = 1430.380460586535
E1 = -183.59039085092826  E_coul = 55.08018267125104
init E= -128.510208179677
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.77540121400321  LUMO = 0.778179223513063
  mo_energy =
[-3.25551663e+01 -1.85274338e+00 -7.75401214e-01 -7.75401214e-01
 -7.75401214e-01  7.78179224e-01  8.27991208e-01  8.27991208e-01
  8.27991208e-01  3.97789783e+00  3.97789783e+00  3.97789783e+00
  4.16249094e+00  1.38455037e+01  1.44386649e+01  1.44386649e+01
  1.44386649e+01  4.55213625e+01  5.31438198e+01  5.31438198e+01
  5.31438198e+01  1.52010358e+02  2.40936898e+02  2.40936898e+02
  2.40936898e+02  5.15267703e+02  1.88090237e+03  8.00906271e+03
  4.77751785e+04]
E1 = -182.08665269326343  E_coul = 53.54832931482044
cycle= 1 E= -128.538323378443  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.51978
diis-c [-0.27017156  1.        ]
  HOMO = -0.884275807476232  LUMO = 0.750011256470058
  mo_energy =
[-3.28782355e+01 -1.96658831e+00 -8.84275807e-01 -8.84275807e-01
 -8.84275807e-01  7.50011256e-01  8.01052044e-01  8.01052044e-01
  8.01052044e-01  3.88005126e+00  3.88005126e+00  3.88005126e+00
  4.08379362e+00  1.36901873e+01  1.42475915e+01  1.42475915e+01
  1.42475915e+01  4.52711889e+01  5.28629817e+01  5.28629817e+01
  5.28629817e+01  1.51693572e+02  2.40590723e+02  2.40590723e+02
  2.40590723e+02  5.14906805e+02  1.88050501e+03  8.00863618e+03
  4.77747331e+04]
E1 = -182.84773482955165  E_coul = 54.30682530839322
cycle= 2 E= -128.540909521158  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264098
diis-c [-0.00069045  0.33608716  0.66391284]
  HOMO = -0.848665045420612  LUMO = 0.759026371492825
  mo_energy =
[-3.27701793e+01 -1.92909132e+00 -8.48665045e-01 -8.48665045e-01
 -8.48665045e-01  7.59026371e-01  8.09834762e-01  8.09834762e-01
  8.09834762e-01  3.91179327e+00  3.91179327e+00  3.91179327e+00
  4.10924978e+00  1.37413083e+01  1.43108844e+01  1.43108844e+01
  1.43108844e+01  4.53549771e+01  5.29569603e+01  5.29569603e+01
  5.29569603e+01  1.51799240e+02  2.40704344e+02  2.40704344e+02
  2.40704344e+02  5.15023419e+02  1.88062701e+03  8.00876065e+03
  4.77748585e+04]
E1 = -182.58922773305622  E_coul = 54.047399025448925
cycle= 3 E= -128.541828707607  delta_E= -0.000919  |g|= 0.000518  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115218
diis-c [-2.01268694e-07 -2.37174711e-03 -6.45825885e-04  1.00301757e+00]
  HOMO = -0.848925198864725  LUMO = 0.758974326279042
  mo_energy =
[-3.27706429e+01 -1.92928675e+00 -8.48925199e-01 -8.48925199e-01
 -8.48925199e-01  7.58974326e-01  8.09793713e-01  8.09793713e-01
  8.09793713e-01  3.91161218e+00  3.91161218e+00  3.91161218e+00
  4.10910782e+00  1.37410485e+01  1.43105739e+01  1.43105739e+01
  1.43105739e+01  4.53546101e+01  5.29565508e+01  5.29565508e+01
  5.29565508e+01  1.51798774e+02  2.40703809e+02  2.40703809e+02
  2.40703809e+02  5.15022828e+02  1.88062628e+03  8.00875982e+03
  4.77748576e+04]
E1 = -182.5896853229304  E_coul = 54.047856588648976
cycle= 4 E= -128.541828734281  delta_E= -2.67e-08  |g|= 8.03e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186192
diis-c [-1.11676864e-09  2.40998407e-04  4.88963042e-04 -1.86362114e-01
  1.18563215e+00]
  HOMO = -0.848968404295514  LUMO = 0.75896162361871
  mo_energy =
[-3.27707161e+01 -1.92931926e+00 -8.48968404e-01 -8.48968404e-01
 -8.48968404e-01  7.58961624e-01  8.09780187e-01  8.09780187e-01
  8.09780187e-01  3.91157182e+00  3.91157182e+00  3.91157182e+00
  4.10907701e+00  1.37409968e+01  1.43105143e+01  1.43105143e+01
  1.43105143e+01  4.53545445e+01  5.29564817e+01  5.29564817e+01
  5.29564817e+01  1.51798700e+02  2.40703731e+02  2.40703731e+02
  2.40703731e+02  5.15022746e+02  1.88062619e+03  8.00875973e+03
  4.77748575e+04]
E1 = -182.58981766886288  E_coul = 54.047988933858186
cycle= 5 E= -128.541828735005  delta_E= -7.23e-10  |g|= 6.01e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58981766886288  E_coul = 54.047988933858186
  HOMO = -0.848965234026704  LUMO = 0.758962929825141
  mo_energy =
[-3.27707089e+01 -1.92931529e+00 -8.48965234e-01 -8.48965234e-01
 -8.48965234e-01  7.58962930e-01  8.09781124e-01  8.09781124e-01
  8.09781124e-01  3.91157486e+00  3.91157486e+00  3.91157486e+00
  4.10907985e+00  1.37410015e+01  1.43105196e+01  1.43105196e+01
  1.43105196e+01  4.53545508e+01  5.29564884e+01  5.29564884e+01
  5.29564884e+01  1.51798707e+02  2.40703738e+02  2.40703738e+02
  2.40703738e+02  5.15022753e+02  1.88062619e+03  8.00875973e+03
  4.77748575e+04]
E1 = -182.58980150920934  E_coul = 54.04797277420217
Extra cycle  E= -128.541828735007  delta_E= -2.47e-12  |g|= 2.27e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.80534297e-01 2.44137942e+04 3.66145172e+03 8.33316628e+02
 2.35470648e+02 7.58684094e+01 1.09280981e+01 2.77648979e+01
 3.03126358e-01 1.90785056e+00 3.63535685e+00 7.14428160e+00
 2.31589818e+01 9.97866935e+01 2.67037734e-01 2.45552341e+00
 8.37972077e-01]
E = -128.54182873500716
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.780534297389       1
[INPUT] 0    0    [1    /1   ]  24413.7941835        1
[INPUT] 0    0    [1    /1   ]  3661.45172334        1
[INPUT] 0    0    [1    /1   ]  833.31662765         1
[INPUT] 0    0    [1    /1   ]  235.47064791         1
[INPUT] 0    0    [1    /1   ]  75.8684094066        1
[INPUT] 0    0    [1    /1   ]  10.9280981249        1
[INPUT] 0    0    [1    /1   ]  27.7648978674        1
[INPUT] 0    0    [1    /1   ]  0.303126357537       1
[INPUT] 0    0    [1    /1   ]  1.9078505617         1
[INPUT] 0    0    [1    /1   ]  3.63535684763        1
[INPUT] 1    0    [1    /1   ]  7.14428160414        1
[INPUT] 1    0    [1    /1   ]  23.158981794         1
[INPUT] 1    0    [1    /1   ]  99.786693518         1
[INPUT] 1    0    [1    /1   ]  0.267037733849       1
[INPUT] 1    0    [1    /1   ]  2.45552341424        1
[INPUT] 1    0    [1    /1   ]  0.83797207695        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7805342973890415, 1.0]], [0, [24413.794183498874, 1.0]], [0, [3661.4517233425718, 1.0]], [0, [833.3166276503352, 1.0]], [0, [235.47064790970234, 1.0]], [0, [75.86840940663771, 1.0]], [0, [10.928098124911193, 1.0]], [0, [27.76489786739505, 1.0]], [0, [0.3031263575371577, 1.0]], [0, [1.9078505617025625, 1.0]], [0, [3.6353568476275315, 1.0]], [1, [7.144281604138266, 1.0]], [1, [23.15898179402764, 1.0]], [1, [99.78669351799512, 1.0]], [1, [0.2670377338490358, 1.0]], [1, [2.455523414243891, 1.0]], [1, [0.8379720769497827, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7805343]
bas 1, expnt(s) = [24413.7941835]
bas 2, expnt(s) = [3661.45172334]
bas 3, expnt(s) = [833.31662765]
bas 4, expnt(s) = [235.47064791]
bas 5, expnt(s) = [75.86840941]
bas 6, expnt(s) = [10.92809812]
bas 7, expnt(s) = [27.76489787]
bas 8, expnt(s) = [0.30312636]
bas 9, expnt(s) = [1.90785056]
bas 10, expnt(s) = [3.63535685]
bas 11, expnt(s) = [7.1442816]
bas 12, expnt(s) = [23.15898179]
bas 13, expnt(s) = [99.78669352]
bas 14, expnt(s) = [0.26703773]
bas 15, expnt(s) = [2.45552341]
bas 16, expnt(s) = [0.83797208]
CPU time:       184.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.80534297e-01 2.09801707e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920030e+03 8.33316628e+02 3.91852444e+02
 2.35470648e+02 1.51868467e+02 7.58684094e+01 6.49472488e+01
 1.09280981e+01 1.51853031e+01 2.77648979e+01 3.05588555e+01
 3.03126358e-01 1.03212619e+00 1.90785056e+00 4.10131654e+00
 3.63535685e+00 6.65158752e+00 7.14428160e+00 3.40747437e+01
 2.31589818e+01 1.48212120e+02 9.97866935e+01 9.20079137e+02
 2.67037734e-01 5.60015677e-01 2.45552341e+00 8.96735767e+00
 8.37972077e-01 2.33895209e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999630772116415
cond(S) = 1430.380460586535
E1 = -183.59039085092826  E_coul = 55.08018267125104
init E= -128.510208179677
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77540121400321  LUMO = 0.778179223513063
  mo_energy =
[-3.25551663e+01 -1.85274338e+00 -7.75401214e-01 -7.75401214e-01
 -7.75401214e-01  7.78179224e-01  8.27991208e-01  8.27991208e-01
  8.27991208e-01  3.97789783e+00  3.97789783e+00  3.97789783e+00
  4.16249094e+00  1.38455037e+01  1.44386649e+01  1.44386649e+01
  1.44386649e+01  4.55213625e+01  5.31438198e+01  5.31438198e+01
  5.31438198e+01  1.52010358e+02  2.40936898e+02  2.40936898e+02
  2.40936898e+02  5.15267703e+02  1.88090237e+03  8.00906271e+03
  4.77751785e+04]
E1 = -182.08665269326343  E_coul = 53.54832931482044
cycle= 1 E= -128.538323378443  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51978
diis-c [-0.27017156  1.        ]
  HOMO = -0.884275807476232  LUMO = 0.750011256470058
  mo_energy =
[-3.28782355e+01 -1.96658831e+00 -8.84275807e-01 -8.84275807e-01
 -8.84275807e-01  7.50011256e-01  8.01052044e-01  8.01052044e-01
  8.01052044e-01  3.88005126e+00  3.88005126e+00  3.88005126e+00
  4.08379362e+00  1.36901873e+01  1.42475915e+01  1.42475915e+01
  1.42475915e+01  4.52711889e+01  5.28629817e+01  5.28629817e+01
  5.28629817e+01  1.51693572e+02  2.40590723e+02  2.40590723e+02
  2.40590723e+02  5.14906805e+02  1.88050501e+03  8.00863618e+03
  4.77747331e+04]
E1 = -182.84773482955165  E_coul = 54.30682530839322
cycle= 2 E= -128.540909521158  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264098
diis-c [-0.00069045  0.33608716  0.66391284]
  HOMO = -0.848665045420612  LUMO = 0.759026371492825
  mo_energy =
[-3.27701793e+01 -1.92909132e+00 -8.48665045e-01 -8.48665045e-01
 -8.48665045e-01  7.59026371e-01  8.09834762e-01  8.09834762e-01
  8.09834762e-01  3.91179327e+00  3.91179327e+00  3.91179327e+00
  4.10924978e+00  1.37413083e+01  1.43108844e+01  1.43108844e+01
  1.43108844e+01  4.53549771e+01  5.29569603e+01  5.29569603e+01
  5.29569603e+01  1.51799240e+02  2.40704344e+02  2.40704344e+02
  2.40704344e+02  5.15023419e+02  1.88062701e+03  8.00876065e+03
  4.77748585e+04]
E1 = -182.58922773305622  E_coul = 54.047399025448925
cycle= 3 E= -128.541828707607  delta_E= -0.000919  |g|= 0.000518  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115218
diis-c [-2.01268694e-07 -2.37174711e-03 -6.45825885e-04  1.00301757e+00]
  HOMO = -0.848925198864725  LUMO = 0.758974326279042
  mo_energy =
[-3.27706429e+01 -1.92928675e+00 -8.48925199e-01 -8.48925199e-01
 -8.48925199e-01  7.58974326e-01  8.09793713e-01  8.09793713e-01
  8.09793713e-01  3.91161218e+00  3.91161218e+00  3.91161218e+00
  4.10910782e+00  1.37410485e+01  1.43105739e+01  1.43105739e+01
  1.43105739e+01  4.53546101e+01  5.29565508e+01  5.29565508e+01
  5.29565508e+01  1.51798774e+02  2.40703809e+02  2.40703809e+02
  2.40703809e+02  5.15022828e+02  1.88062628e+03  8.00875982e+03
  4.77748576e+04]
E1 = -182.5896853229304  E_coul = 54.047856588648976
cycle= 4 E= -128.541828734281  delta_E= -2.67e-08  |g|= 8.03e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186192
diis-c [-1.11676864e-09  2.40998407e-04  4.88963042e-04 -1.86362114e-01
  1.18563215e+00]
  HOMO = -0.848968404295514  LUMO = 0.75896162361871
  mo_energy =
[-3.27707161e+01 -1.92931926e+00 -8.48968404e-01 -8.48968404e-01
 -8.48968404e-01  7.58961624e-01  8.09780187e-01  8.09780187e-01
  8.09780187e-01  3.91157182e+00  3.91157182e+00  3.91157182e+00
  4.10907701e+00  1.37409968e+01  1.43105143e+01  1.43105143e+01
  1.43105143e+01  4.53545445e+01  5.29564817e+01  5.29564817e+01
  5.29564817e+01  1.51798700e+02  2.40703731e+02  2.40703731e+02
  2.40703731e+02  5.15022746e+02  1.88062619e+03  8.00875973e+03
  4.77748575e+04]
E1 = -182.58981766886288  E_coul = 54.047988933858186
cycle= 5 E= -128.541828735005  delta_E= -7.23e-10  |g|= 6.01e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58981766886288  E_coul = 54.047988933858186
  HOMO = -0.848965234026704  LUMO = 0.758962929825141
  mo_energy =
[-3.27707089e+01 -1.92931529e+00 -8.48965234e-01 -8.48965234e-01
 -8.48965234e-01  7.58962930e-01  8.09781124e-01  8.09781124e-01
  8.09781124e-01  3.91157486e+00  3.91157486e+00  3.91157486e+00
  4.10907985e+00  1.37410015e+01  1.43105196e+01  1.43105196e+01
  1.43105196e+01  4.53545508e+01  5.29564884e+01  5.29564884e+01
  5.29564884e+01  1.51798707e+02  2.40703738e+02  2.40703738e+02
  2.40703738e+02  5.15022753e+02  1.88062619e+03  8.00875973e+03
  4.77748575e+04]
E1 = -182.58980150920934  E_coul = 54.04797277420217
Extra cycle  E= -128.541828735007  delta_E= -2.47e-12  |g|= 2.27e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1430.380460586535
E1 = -182.58980150920934  E_coul = 54.04797277420217
init E= -128.541828735007
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.848966376529018  LUMO = 0.758962721528191
  mo_energy =
[-3.27707125e+01 -1.92931636e+00 -8.48966377e-01 -8.48966377e-01
 -8.48966377e-01  7.58962722e-01  8.09780861e-01  8.09780861e-01
  8.09780861e-01  3.91157387e+00  3.91157387e+00  3.91157387e+00
  4.10907912e+00  1.37409999e+01  1.43105175e+01  1.43105175e+01
  1.43105175e+01  4.53545481e+01  5.29564853e+01  5.29564853e+01
  5.29564853e+01  1.51798704e+02  2.40703734e+02  2.40703734e+02
  2.40703734e+02  5.15022749e+02  1.88062619e+03  8.00875973e+03
  4.77748575e+04]
E1 = -182.58981048290678  E_coul = 54.0479817478994
cycle= 1 E= -128.541828735007  delta_E= -2.27e-13  |g|= 1.23e-06  |ddm|= 8.12e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58981048290678  E_coul = 54.0479817478994
  HOMO = -0.848965744690356  LUMO = 0.758962897654165
  mo_energy =
[-3.27707106e+01 -1.92931566e+00 -8.48965745e-01 -8.48965745e-01
 -8.48965745e-01  7.58962898e-01  8.09781020e-01  8.09781020e-01
  8.09781020e-01  3.91157444e+00  3.91157444e+00  3.91157444e+00
  4.10907959e+00  1.37410008e+01  1.43105186e+01  1.43105186e+01
  1.43105186e+01  4.53545495e+01  5.29564870e+01  5.29564870e+01
  5.29564870e+01  1.51798706e+02  2.40703736e+02  2.40703736e+02
  2.40703736e+02  5.15022751e+02  1.88062619e+03  8.00875973e+03
  4.77748575e+04]
E1 = -182.58980597286745  E_coul = 54.04797723785994
Extra cycle  E= -128.541828735008  delta_E= -1.42e-13  |g|= 6.13e-07  |ddm|= 3.95e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [7.80534297e-01 2.44137942e+04 3.66145172e+03 8.33316628e+02
 2.35470648e+02 7.58684094e+01 1.09280981e+01 2.77648979e+01
 3.03126358e-01 1.90785056e+00 3.63535685e+00 7.14428160e+00
 2.31589818e+01 9.97866935e+01 2.67037734e-01 2.45552341e+00
 8.37972077e-01]
grad_E = [ 1.03167122e-04 -2.45536026e-09  1.29294193e-07 -2.50387405e-06
  2.56575526e-05 -1.05180668e-04  2.15199712e-06  6.02813021e-05
 -1.08606875e-04 -2.22539283e-05 -1.10488956e-04  1.19557879e-04
 -3.88526058e-05  2.06053870e-06  2.82941460e-04  1.90909605e-05
 -1.33154267e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.785502074929       1
[INPUT] 0    0    [1    /1   ]  24413.7941835        1
[INPUT] 0    0    [1    /1   ]  3661.4517219         1
[INPUT] 0    0    [1    /1   ]  833.316656216        1
[INPUT] 0    0    [1    /1   ]  235.470308527        1
[INPUT] 0    0    [1    /1   ]  75.8711191547        1
[INPUT] 0    0    [1    /1   ]  10.931587383         1
[INPUT] 0    0    [1    /1   ]  27.7549453157        1
[INPUT] 0    0    [1    /1   ]  0.304670095417       1
[INPUT] 0    0    [1    /1   ]  1.92902970078        1
[INPUT] 0    0    [1    /1   ]  3.6300268565         1
[INPUT] 1    0    [1    /1   ]  7.14342942866        1
[INPUT] 1    0    [1    /1   ]  23.1591541545        1
[INPUT] 1    0    [1    /1   ]  99.7866867117        1
[INPUT] 1    0    [1    /1   ]  0.267000047587       1
[INPUT] 1    0    [1    /1   ]  2.45618103213        1
[INPUT] 1    0    [1    /1   ]  0.838341154231       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7855020749291012, 1.0]], [0, [24413.794183526697, 1.0]], [0, [3661.45172189529, 1.0]], [0, [833.3166562159835, 1.0]], [0, [235.470308527285, 1.0]], [0, [75.87111915466643, 1.0]], [0, [10.931587383015058, 1.0]], [0, [27.754945315685077, 1.0]], [0, [0.30467009541695855, 1.0]], [0, [1.9290297007772883, 1.0]], [0, [3.630026856502311, 1.0]], [1, [7.143429428656102, 1.0]], [1, [23.159154154506975, 1.0]], [1, [99.78668671166731, 1.0]], [1, [0.26700004758720747, 1.0]], [1, [2.4561810321317346, 1.0]], [1, [0.8383411542313558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78550207]
bas 1, expnt(s) = [24413.79418353]
bas 2, expnt(s) = [3661.4517219]
bas 3, expnt(s) = [833.31665622]
bas 4, expnt(s) = [235.47030853]
bas 5, expnt(s) = [75.87111915]
bas 6, expnt(s) = [10.93158738]
bas 7, expnt(s) = [27.75494532]
bas 8, expnt(s) = [0.3046701]
bas 9, expnt(s) = [1.9290297]
bas 10, expnt(s) = [3.63002686]
bas 11, expnt(s) = [7.14342943]
bas 12, expnt(s) = [23.15915415]
bas 13, expnt(s) = [99.78668671]
bas 14, expnt(s) = [0.26700005]
bas 15, expnt(s) = [2.45618103]
bas 16, expnt(s) = [0.83834115]
CPU time:       187.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.85502075e-01 2.10802388e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920030e+03 8.33316656e+02 3.91852454e+02
 2.35470309e+02 1.51868303e+02 7.58711192e+01 6.49489885e+01
 1.09315874e+01 1.51889393e+01 2.77549453e+01 3.05506396e+01
 3.04670095e-01 1.03606594e+00 1.92902970e+00 4.13541606e+00
 3.63002686e+00 6.64427200e+00 7.14342943e+00 3.40696632e+01
 2.31591542e+01 1.48213499e+02 9.97866867e+01 9.20079058e+02
 2.67000048e-01 5.59916887e-01 2.45618103e+00 8.97035972e+00
 8.38341154e-01 2.34023988e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999630341811617
cond(S) = 1473.5787244121038
E1 = -183.59036946586897  E_coul = 55.08017856807953
init E= -128.510190897789
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401338887793  LUMO = 0.784258298123776
  mo_energy =
[-3.25551686e+01 -1.85274294e+00 -7.75401339e-01 -7.75401339e-01
 -7.75401339e-01  7.84258298e-01  8.27999862e-01  8.27999862e-01
  8.27999862e-01  3.97908116e+00  3.97908116e+00  3.97908116e+00
  4.19605210e+00  1.39224453e+01  1.44408669e+01  1.44408669e+01
  1.44408669e+01  4.56180926e+01  5.31448159e+01  5.31448159e+01
  5.31448159e+01  1.52091873e+02  2.40937276e+02  2.40937276e+02
  2.40937276e+02  5.15333189e+02  1.88095947e+03  8.00911262e+03
  4.77752198e+04]
E1 = -182.08653409766094  E_coul = 53.54821078504165
cycle= 1 E= -128.538323312619  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519768
diis-c [-0.27015905  1.        ]
  HOMO = -0.8842849047228  LUMO = 0.7558513703544
  mo_energy =
[-3.28782553e+01 -1.96660071e+00 -8.84284905e-01 -8.84284905e-01
 -8.84284905e-01  7.55851370e-01  8.01051818e-01  8.01051818e-01
  8.01051818e-01  3.88119699e+00  3.88119699e+00  3.88119699e+00
  4.11691548e+00  1.37669148e+01  1.42497855e+01  1.42497855e+01
  1.42497855e+01  4.53679361e+01  5.28639640e+01  5.28639640e+01
  5.28639640e+01  1.51775094e+02  2.40591085e+02  2.40591085e+02
  2.40591085e+02  5.14972279e+02  1.88056210e+03  8.00868608e+03
  4.77747743e+04]
E1 = -182.84766087219458  E_coul = 54.30675130782096
cycle= 2 E= -128.540909564374  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2641
diis-c [-0.00069087  0.33609366  0.66390634]
  HOMO = -0.848672290977212  LUMO = 0.764941898205174
  mo_energy =
[-3.27701942e+01 -1.92910173e+00 -8.48672291e-01 -8.48672291e-01
 -8.48672291e-01  7.64941898e-01  8.09837122e-01  8.09837122e-01
  8.09837122e-01  3.91294900e+00  3.91294900e+00  3.91294900e+00
  4.14251430e+00  1.38181062e+01  1.43130805e+01  1.43130805e+01
  1.43130805e+01  4.54517176e+01  5.29579456e+01  5.29579456e+01
  5.29579456e+01  1.51880758e+02  2.40704711e+02  2.40704711e+02
  2.40704711e+02  5.15088896e+02  1.88068410e+03  8.00881055e+03
  4.77748997e+04]
E1 = -182.58913032233832  E_coul = 54.04730143850898
cycle= 3 E= -128.541828883829  delta_E= -0.000919  |g|= 0.000518  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115199
diis-c [-1.99427539e-07 -2.37005546e-03 -6.39819909e-04  1.00300988e+00]
  HOMO = -0.848932625873362  LUMO = 0.764889245914735
  mo_energy =
[-3.27706582e+01 -1.92929772e+00 -8.48932626e-01 -8.48932626e-01
 -8.48932626e-01  7.64889246e-01  8.09796019e-01  8.09796019e-01
  8.09796019e-01  3.91276757e+00  3.91276757e+00  3.91276757e+00
  4.14237132e+00  1.38178457e+01  1.43127698e+01  1.43127698e+01
  1.43127698e+01  4.54513502e+01  5.29575358e+01  5.29575358e+01
  5.29575358e+01  1.51880292e+02  2.40704175e+02  2.40704175e+02
  2.40704175e+02  5.15088305e+02  1.88068337e+03  8.00880972e+03
  4.77748988e+04]
E1 = -182.5895887935398  E_coul = 54.04775988318708
cycle= 4 E= -128.541828910353  delta_E= -2.65e-08  |g|= 8.02e-05  |ddm|= 0.00037
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018588
diis-c [-1.10762177e-09  2.39577676e-04  4.87880423e-04 -1.85594795e-01
  1.18486734e+00]
  HOMO = -0.848975772263081  LUMO = 0.764876435041899
  mo_energy =
[-3.27707312e+01 -1.92933029e+00 -8.48975772e-01 -8.48975772e-01
 -8.48975772e-01  7.64876435e-01  8.09782511e-01  8.09782511e-01
  8.09782511e-01  3.91272723e+00  3.91272723e+00  3.91272723e+00
  4.14234036e+00  1.38177940e+01  1.43127103e+01  1.43127103e+01
  1.43127103e+01  4.54512846e+01  5.29574668e+01  5.29574668e+01
  5.29574668e+01  1.51880218e+02  2.40704098e+02  2.40704098e+02
  2.40704098e+02  5.15088223e+02  1.88068328e+03  8.00880963e+03
  4.77748987e+04]
E1 = -182.58972111022393  E_coul = 54.04789219915473
cycle= 5 E= -128.541828911069  delta_E= -7.16e-10  |g|= 5.97e-06  |ddm|= 6.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58972111022393  E_coul = 54.04789219915473
  HOMO = -0.848972624337129  LUMO = 0.764877741756107
  mo_energy =
[-3.27707241e+01 -1.92932634e+00 -8.48972624e-01 -8.48972624e-01
 -8.48972624e-01  7.64877742e-01  8.09783441e-01  8.09783441e-01
  8.09783441e-01  3.91273025e+00  3.91273025e+00  3.91273025e+00
  4.14234319e+00  1.38177986e+01  1.43127155e+01  1.43127155e+01
  1.43127155e+01  4.54512909e+01  5.29574734e+01  5.29574734e+01
  5.29574734e+01  1.51880225e+02  2.40704104e+02  2.40704104e+02
  2.40704104e+02  5.15088230e+02  1.88068329e+03  8.00880963e+03
  4.77748987e+04]
E1 = -182.58970504472614  E_coul = 54.04787613365455
Extra cycle  E= -128.541828911072  delta_E= -2.39e-12  |g|= 2.26e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.85502075e-01 2.44137942e+04 3.66145172e+03 8.33316656e+02
 2.35470309e+02 7.58711192e+01 1.09315874e+01 2.77549453e+01
 3.04670095e-01 1.92902970e+00 3.63002686e+00 7.14342943e+00
 2.31591542e+01 9.97866867e+01 2.67000048e-01 2.45618103e+00
 8.38341154e-01]
E = -128.5418289110716
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.785502074929       1
[INPUT] 0    0    [1    /1   ]  24413.7941835        1
[INPUT] 0    0    [1    /1   ]  3661.4517219         1
[INPUT] 0    0    [1    /1   ]  833.316656216        1
[INPUT] 0    0    [1    /1   ]  235.470308527        1
[INPUT] 0    0    [1    /1   ]  75.8711191547        1
[INPUT] 0    0    [1    /1   ]  10.931587383         1
[INPUT] 0    0    [1    /1   ]  27.7549453157        1
[INPUT] 0    0    [1    /1   ]  0.304670095417       1
[INPUT] 0    0    [1    /1   ]  1.92902970078        1
[INPUT] 0    0    [1    /1   ]  3.6300268565         1
[INPUT] 1    0    [1    /1   ]  7.14342942866        1
[INPUT] 1    0    [1    /1   ]  23.1591541545        1
[INPUT] 1    0    [1    /1   ]  99.7866867117        1
[INPUT] 1    0    [1    /1   ]  0.267000047587       1
[INPUT] 1    0    [1    /1   ]  2.45618103213        1
[INPUT] 1    0    [1    /1   ]  0.838341154231       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7855020749291012, 1.0]], [0, [24413.794183526697, 1.0]], [0, [3661.45172189529, 1.0]], [0, [833.3166562159835, 1.0]], [0, [235.470308527285, 1.0]], [0, [75.87111915466643, 1.0]], [0, [10.931587383015058, 1.0]], [0, [27.754945315685077, 1.0]], [0, [0.30467009541695855, 1.0]], [0, [1.9290297007772883, 1.0]], [0, [3.630026856502311, 1.0]], [1, [7.143429428656102, 1.0]], [1, [23.159154154506975, 1.0]], [1, [99.78668671166731, 1.0]], [1, [0.26700004758720747, 1.0]], [1, [2.4561810321317346, 1.0]], [1, [0.8383411542313558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78550207]
bas 1, expnt(s) = [24413.79418353]
bas 2, expnt(s) = [3661.4517219]
bas 3, expnt(s) = [833.31665622]
bas 4, expnt(s) = [235.47030853]
bas 5, expnt(s) = [75.87111915]
bas 6, expnt(s) = [10.93158738]
bas 7, expnt(s) = [27.75494532]
bas 8, expnt(s) = [0.3046701]
bas 9, expnt(s) = [1.9290297]
bas 10, expnt(s) = [3.63002686]
bas 11, expnt(s) = [7.14342943]
bas 12, expnt(s) = [23.15915415]
bas 13, expnt(s) = [99.78668671]
bas 14, expnt(s) = [0.26700005]
bas 15, expnt(s) = [2.45618103]
bas 16, expnt(s) = [0.83834115]
CPU time:       188.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.85502075e-01 2.10802388e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920030e+03 8.33316656e+02 3.91852454e+02
 2.35470309e+02 1.51868303e+02 7.58711192e+01 6.49489885e+01
 1.09315874e+01 1.51889393e+01 2.77549453e+01 3.05506396e+01
 3.04670095e-01 1.03606594e+00 1.92902970e+00 4.13541606e+00
 3.63002686e+00 6.64427200e+00 7.14342943e+00 3.40696632e+01
 2.31591542e+01 1.48213499e+02 9.97866867e+01 9.20079058e+02
 2.67000048e-01 5.59916887e-01 2.45618103e+00 8.97035972e+00
 8.38341154e-01 2.34023988e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999630341811617
cond(S) = 1473.5787244121038
E1 = -183.59036946586897  E_coul = 55.08017856807953
init E= -128.510190897789
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401338887793  LUMO = 0.784258298123776
  mo_energy =
[-3.25551686e+01 -1.85274294e+00 -7.75401339e-01 -7.75401339e-01
 -7.75401339e-01  7.84258298e-01  8.27999862e-01  8.27999862e-01
  8.27999862e-01  3.97908116e+00  3.97908116e+00  3.97908116e+00
  4.19605210e+00  1.39224453e+01  1.44408669e+01  1.44408669e+01
  1.44408669e+01  4.56180926e+01  5.31448159e+01  5.31448159e+01
  5.31448159e+01  1.52091873e+02  2.40937276e+02  2.40937276e+02
  2.40937276e+02  5.15333189e+02  1.88095947e+03  8.00911262e+03
  4.77752198e+04]
E1 = -182.08653409766094  E_coul = 53.54821078504165
cycle= 1 E= -128.538323312619  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519768
diis-c [-0.27015905  1.        ]
  HOMO = -0.8842849047228  LUMO = 0.7558513703544
  mo_energy =
[-3.28782553e+01 -1.96660071e+00 -8.84284905e-01 -8.84284905e-01
 -8.84284905e-01  7.55851370e-01  8.01051818e-01  8.01051818e-01
  8.01051818e-01  3.88119699e+00  3.88119699e+00  3.88119699e+00
  4.11691548e+00  1.37669148e+01  1.42497855e+01  1.42497855e+01
  1.42497855e+01  4.53679361e+01  5.28639640e+01  5.28639640e+01
  5.28639640e+01  1.51775094e+02  2.40591085e+02  2.40591085e+02
  2.40591085e+02  5.14972279e+02  1.88056210e+03  8.00868608e+03
  4.77747743e+04]
E1 = -182.84766087219458  E_coul = 54.30675130782096
cycle= 2 E= -128.540909564374  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.2641
diis-c [-0.00069087  0.33609366  0.66390634]
  HOMO = -0.848672290977212  LUMO = 0.764941898205174
  mo_energy =
[-3.27701942e+01 -1.92910173e+00 -8.48672291e-01 -8.48672291e-01
 -8.48672291e-01  7.64941898e-01  8.09837122e-01  8.09837122e-01
  8.09837122e-01  3.91294900e+00  3.91294900e+00  3.91294900e+00
  4.14251430e+00  1.38181062e+01  1.43130805e+01  1.43130805e+01
  1.43130805e+01  4.54517176e+01  5.29579456e+01  5.29579456e+01
  5.29579456e+01  1.51880758e+02  2.40704711e+02  2.40704711e+02
  2.40704711e+02  5.15088896e+02  1.88068410e+03  8.00881055e+03
  4.77748997e+04]
E1 = -182.58913032233832  E_coul = 54.04730143850898
cycle= 3 E= -128.541828883829  delta_E= -0.000919  |g|= 0.000518  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115199
diis-c [-1.99427539e-07 -2.37005546e-03 -6.39819909e-04  1.00300988e+00]
  HOMO = -0.848932625873362  LUMO = 0.764889245914735
  mo_energy =
[-3.27706582e+01 -1.92929772e+00 -8.48932626e-01 -8.48932626e-01
 -8.48932626e-01  7.64889246e-01  8.09796019e-01  8.09796019e-01
  8.09796019e-01  3.91276757e+00  3.91276757e+00  3.91276757e+00
  4.14237132e+00  1.38178457e+01  1.43127698e+01  1.43127698e+01
  1.43127698e+01  4.54513502e+01  5.29575358e+01  5.29575358e+01
  5.29575358e+01  1.51880292e+02  2.40704175e+02  2.40704175e+02
  2.40704175e+02  5.15088305e+02  1.88068337e+03  8.00880972e+03
  4.77748988e+04]
E1 = -182.5895887935398  E_coul = 54.04775988318708
cycle= 4 E= -128.541828910353  delta_E= -2.65e-08  |g|= 8.02e-05  |ddm|= 0.00037
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018588
diis-c [-1.10762177e-09  2.39577676e-04  4.87880423e-04 -1.85594795e-01
  1.18486734e+00]
  HOMO = -0.848975772263081  LUMO = 0.764876435041899
  mo_energy =
[-3.27707312e+01 -1.92933029e+00 -8.48975772e-01 -8.48975772e-01
 -8.48975772e-01  7.64876435e-01  8.09782511e-01  8.09782511e-01
  8.09782511e-01  3.91272723e+00  3.91272723e+00  3.91272723e+00
  4.14234036e+00  1.38177940e+01  1.43127103e+01  1.43127103e+01
  1.43127103e+01  4.54512846e+01  5.29574668e+01  5.29574668e+01
  5.29574668e+01  1.51880218e+02  2.40704098e+02  2.40704098e+02
  2.40704098e+02  5.15088223e+02  1.88068328e+03  8.00880963e+03
  4.77748987e+04]
E1 = -182.58972111022393  E_coul = 54.04789219915473
cycle= 5 E= -128.541828911069  delta_E= -7.16e-10  |g|= 5.97e-06  |ddm|= 6.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58972111022393  E_coul = 54.04789219915473
  HOMO = -0.848972624337129  LUMO = 0.764877741756107
  mo_energy =
[-3.27707241e+01 -1.92932634e+00 -8.48972624e-01 -8.48972624e-01
 -8.48972624e-01  7.64877742e-01  8.09783441e-01  8.09783441e-01
  8.09783441e-01  3.91273025e+00  3.91273025e+00  3.91273025e+00
  4.14234319e+00  1.38177986e+01  1.43127155e+01  1.43127155e+01
  1.43127155e+01  4.54512909e+01  5.29574734e+01  5.29574734e+01
  5.29574734e+01  1.51880225e+02  2.40704104e+02  2.40704104e+02
  2.40704104e+02  5.15088230e+02  1.88068329e+03  8.00880963e+03
  4.77748987e+04]
E1 = -182.58970504472614  E_coul = 54.04787613365455
Extra cycle  E= -128.541828911072  delta_E= -2.39e-12  |g|= 2.26e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1473.5787244121038
E1 = -182.58970504472614  E_coul = 54.04787613365455
init E= -128.541828911072
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848973760447064  LUMO = 0.76487753265531
  mo_energy =
[-3.27707277e+01 -1.92932740e+00 -8.48973760e-01 -8.48973760e-01
 -8.48973760e-01  7.64877533e-01  8.09783179e-01  8.09783179e-01
  8.09783179e-01  3.91272926e+00  3.91272926e+00  3.91272926e+00
  4.14234247e+00  1.38177970e+01  1.43127134e+01  1.43127134e+01
  1.43127134e+01  4.54512882e+01  5.29574703e+01  5.29574703e+01
  5.29574703e+01  1.51880222e+02  2.40704101e+02  2.40704101e+02
  2.40704101e+02  5.15088226e+02  1.88068328e+03  8.00880963e+03
  4.77748987e+04]
E1 = -182.5897139635997  E_coul = 54.047885052527526
cycle= 1 E= -128.541828911072  delta_E= -5.68e-13  |g|= 1.22e-06  |ddm|= 8.07e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5897139635997  E_coul = 54.047885052527526
  HOMO = -0.848973132512304  LUMO = 0.764877709131721
  mo_energy =
[-3.27707258e+01 -1.92932671e+00 -8.48973133e-01 -8.48973133e-01
 -8.48973133e-01  7.64877709e-01  8.09783338e-01  8.09783338e-01
  8.09783338e-01  3.91272983e+00  3.91272983e+00  3.91272983e+00
  4.14234294e+00  1.38177980e+01  1.43127145e+01  1.43127145e+01
  1.43127145e+01  4.54512897e+01  5.29574720e+01  5.29574720e+01
  5.29574720e+01  1.51880224e+02  2.40704103e+02  2.40704103e+02
  2.40704103e+02  5.15088228e+02  1.88068329e+03  8.00880963e+03
  4.77748987e+04]
E1 = -182.58970948060363  E_coul = 54.04788056953137
Extra cycle  E= -128.541828911072  delta_E= -8.53e-14  |g|= 6.09e-07  |ddm|= 3.93e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [7.85502075e-01 2.44137942e+04 3.66145172e+03 8.33316656e+02
 2.35470309e+02 7.58711192e+01 1.09315874e+01 2.77549453e+01
 3.04670095e-01 1.92902970e+00 3.63002686e+00 7.14342943e+00
 2.31591542e+01 9.97866867e+01 2.67000048e-01 2.45618103e+00
 8.38341154e-01]
grad_E = [-5.70793952e-05 -2.37958423e-09  1.25291114e-07 -2.42625126e-06
  2.47765150e-05 -9.98432363e-05  1.57964449e-05  4.53966210e-05
  1.27553957e-04  1.89462595e-05 -1.14028824e-04  9.90536336e-05
 -3.55814723e-05  1.92573130e-06 -2.33892748e-04  2.73282328e-05
  8.30940593e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.784352255538       1
[INPUT] 0    0    [1    /1   ]  24413.7941836        1
[INPUT] 0    0    [1    /1   ]  3661.45172068        1
[INPUT] 0    0    [1    /1   ]  833.316677354        1
[INPUT] 0    0    [1    /1   ]  235.470085979        1
[INPUT] 0    0    [1    /1   ]  75.8731509032        1
[INPUT] 0    0    [1    /1   ]  10.9245731022        1
[INPUT] 0    0    [1    /1   ]  27.7489013952        1
[INPUT] 0    0    [1    /1   ]  0.304565052103       1
[INPUT] 0    0    [1    /1   ]  1.91928675991        1
[INPUT] 0    0    [1    /1   ]  3.62480586249        1
[INPUT] 1    0    [1    /1   ]  7.14301310574        1
[INPUT] 1    0    [1    /1   ]  23.159284484         1
[INPUT] 1    0    [1    /1   ]  99.7866823581        1
[INPUT] 1    0    [1    /1   ]  0.267082089487       1
[INPUT] 1    0    [1    /1   ]  2.45628396293        1
[INPUT] 1    0    [1    /1   ]  0.838513225377       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.784352255538208, 1.0]], [0, [24413.794183551054, 1.0]], [0, [3661.451720679687, 1.0]], [0, [833.3166773538723, 1.0]], [0, [235.4700859787581, 1.0]], [0, [75.8731509031712, 1.0]], [0, [10.924573102199183, 1.0]], [0, [27.74890139522434, 1.0]], [0, [0.3045650521029519, 1.0]], [0, [1.91928675991216, 1.0]], [0, [3.624805862493971, 1.0]], [1, [7.14301310573994, 1.0]], [1, [23.15928448404579, 1.0]], [1, [99.78668235805439, 1.0]], [1, [0.267082089487433, 1.0]], [1, [2.4562839629302213, 1.0]], [1, [0.8385132253773161, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78435226]
bas 1, expnt(s) = [24413.79418355]
bas 2, expnt(s) = [3661.45172068]
bas 3, expnt(s) = [833.31667735]
bas 4, expnt(s) = [235.47008598]
bas 5, expnt(s) = [75.8731509]
bas 6, expnt(s) = [10.9245731]
bas 7, expnt(s) = [27.7489014]
bas 8, expnt(s) = [0.30456505]
bas 9, expnt(s) = [1.91928676]
bas 10, expnt(s) = [3.62480586]
bas 11, expnt(s) = [7.14301311]
bas 12, expnt(s) = [23.15928448]
bas 13, expnt(s) = [99.78668236]
bas 14, expnt(s) = [0.26708209]
bas 15, expnt(s) = [2.45628396]
bas 16, expnt(s) = [0.83851323]
CPU time:       192.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.84352256e-01 2.10570916e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920029e+03 8.33316677e+02 3.91852462e+02
 2.35470086e+02 1.51868195e+02 7.58731509e+01 6.49502930e+01
 1.09245731e+01 1.51816292e+01 2.77489014e+01 3.05456499e+01
 3.04565052e-01 1.03579802e+00 1.91928676e+00 4.11974111e+00
 3.62480586e+00 6.63710347e+00 7.14301311e+00 3.40671813e+01
 2.31592845e+01 1.48214541e+02 9.97866824e+01 9.20079008e+02
 2.67082089e-01 5.60131955e-01 2.45628396e+00 8.97082962e+00
 8.38513225e-01 2.34084032e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629829440261
cond(S) = 1463.4603012778846
E1 = -183.59037201554995  E_coul = 55.08018288858632
init E= -128.510189126964
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400958344189  LUMO = 0.783086599325776
  mo_energy =
[-3.25551674e+01 -1.85274292e+00 -7.75400958e-01 -7.75400958e-01
 -7.75400958e-01  7.83086599e-01  8.28275768e-01  8.28275768e-01
  8.28275768e-01  3.97989429e+00  3.97989429e+00  3.97989429e+00
  4.18453489e+00  1.38818326e+01  1.44416745e+01  1.44416745e+01
  1.44416745e+01  4.55405594e+01  5.31448503e+01  5.31448503e+01
  5.31448503e+01  1.51990853e+02  2.40937197e+02  2.40937197e+02
  2.40937197e+02  5.15230301e+02  1.88086521e+03  8.00902930e+03
  4.77751507e+04]
E1 = -182.08661706786802  E_coul = 53.54829332852456
cycle= 1 E= -128.538323739343  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519743
diis-c [-0.27013243  1.        ]
  HOMO = -0.884278463735833  LUMO = 0.754739490500662
  mo_energy =
[-3.28782405e+01 -1.96659346e+00 -8.84278464e-01 -8.84278464e-01
 -8.84278464e-01  7.54739491e-01  8.01319481e-01  8.01319481e-01
  8.01319481e-01  3.88201006e+00  3.88201006e+00  3.88201006e+00
  4.10561340e+00  1.37265099e+01  1.42506072e+01  1.42506072e+01
  1.42506072e+01  4.52904558e+01  5.28640125e+01  5.28640125e+01
  5.28640125e+01  1.51674084e+02  2.40591020e+02  2.40591020e+02
  2.40591020e+02  5.14869402e+02  1.88046786e+03  8.00860277e+03
  4.77747053e+04]
E1 = -182.8476916647209  E_coul = 54.30678187243129
cycle= 2 E= -128.54090979229  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264079
diis-c [-0.00069043  0.33608735  0.66391265]
  HOMO = -0.848668106607315  LUMO = 0.763810836605083
  mo_energy =
[-3.27701852e+01 -1.92909691e+00 -8.48668107e-01 -8.48668107e-01
 -8.48668107e-01  7.63810837e-01  8.10107263e-01  8.10107263e-01
  8.10107263e-01  3.91376225e+00  3.91376225e+00  3.91376225e+00
  4.13114136e+00  1.37776306e+01  1.43138967e+01  1.43138967e+01
  1.43138967e+01  4.53742186e+01  5.29579884e+01  5.29579884e+01
  5.29579884e+01  1.51779744e+02  2.40704640e+02  2.40704640e+02
  2.40704640e+02  5.14986014e+02  1.88058985e+03  8.00872724e+03
  4.77748307e+04]
E1 = -182.589180184453  E_coul = 54.047351195913166
cycle= 3 E= -128.54182898854  delta_E= -0.000919  |g|= 0.000519  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115298
diis-c [-1.99757454e-07 -2.37065192e-03 -6.37304998e-04  1.00300796e+00]
  HOMO = -0.848928637124552  LUMO = 0.76375821065282
  mo_energy =
[-3.27706496e+01 -1.92929305e+00 -8.48928637e-01 -8.48928637e-01
 -8.48928637e-01  7.63758211e-01  8.10066060e-01  8.10066060e-01
  8.10066060e-01  3.91358064e+00  3.91358064e+00  3.91358064e+00
  4.13099856e+00  1.37773702e+01  1.43135857e+01  1.43135857e+01
  1.43135857e+01  4.53738510e+01  5.29575782e+01  5.29575782e+01
  5.29575782e+01  1.51779277e+02  2.40704104e+02  2.40704104e+02
  2.40704104e+02  5.14985422e+02  1.88058912e+03  8.00872641e+03
  4.77748298e+04]
E1 = -182.58963923069084  E_coul = 54.04781021554514
cycle= 4 E= -128.541829015146  delta_E= -2.66e-08  |g|= 8.02e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185985
diis-c [-1.10861308e-09  2.39823426e-04  4.87716572e-04 -1.85698366e-01
  1.18497083e+00]
  HOMO = -0.848971816885902  LUMO = 0.76374541305606
  mo_energy =
[-3.27707227e+01 -1.92932563e+00 -8.48971817e-01 -8.48971817e-01
 -8.48971817e-01  7.63745413e-01  8.10052534e-01  8.10052534e-01
  8.10052534e-01  3.91354027e+00  3.91354027e+00  3.91354027e+00
  4.13096765e+00  1.37773184e+01  1.43135261e+01  1.43135261e+01
  1.43135261e+01  4.53737853e+01  5.29575092e+01  5.29575092e+01
  5.29575092e+01  1.51779204e+02  2.40704026e+02  2.40704026e+02
  2.40704026e+02  5.14985341e+02  1.88058903e+03  8.00872631e+03
  4.77748297e+04]
E1 = -182.58977155933422  E_coul = 54.04794254347006
cycle= 5 E= -128.541829015864  delta_E= -7.18e-10  |g|= 5.97e-06  |ddm|= 6.25e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58977155933422  E_coul = 54.04794254347006
  HOMO = -0.848968666931263  LUMO = 0.763746718553251
  mo_energy =
[-3.27707156e+01 -1.92932168e+00 -8.48968667e-01 -8.48968667e-01
 -8.48968667e-01  7.63746719e-01  8.10053466e-01  8.10053466e-01
  8.10053466e-01  3.91354330e+00  3.91354330e+00  3.91354330e+00
  4.13097047e+00  1.37773231e+01  1.43135313e+01  1.43135313e+01
  1.43135313e+01  4.53737916e+01  5.29575158e+01  5.29575158e+01
  5.29575158e+01  1.51779211e+02  2.40704033e+02  2.40704033e+02
  2.40704033e+02  5.14985347e+02  1.88058904e+03  8.00872632e+03
  4.77748297e+04]
E1 = -182.58975548901802  E_coul = 54.04792647315109
Extra cycle  E= -128.541829015867  delta_E= -2.79e-12  |g|= 2.26e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.16 sec
exp = [7.84352256e-01 2.44137942e+04 3.66145172e+03 8.33316677e+02
 2.35470086e+02 7.58731509e+01 1.09245731e+01 2.77489014e+01
 3.04565052e-01 1.91928676e+00 3.62480586e+00 7.14301311e+00
 2.31592845e+01 9.97866824e+01 2.67082089e-01 2.45628396e+00
 8.38513225e-01]
E = -128.54182901586694
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.784352255538       1
[INPUT] 0    0    [1    /1   ]  24413.7941836        1
[INPUT] 0    0    [1    /1   ]  3661.45172068        1
[INPUT] 0    0    [1    /1   ]  833.316677354        1
[INPUT] 0    0    [1    /1   ]  235.470085979        1
[INPUT] 0    0    [1    /1   ]  75.8731509032        1
[INPUT] 0    0    [1    /1   ]  10.9245731022        1
[INPUT] 0    0    [1    /1   ]  27.7489013952        1
[INPUT] 0    0    [1    /1   ]  0.304565052103       1
[INPUT] 0    0    [1    /1   ]  1.91928675991        1
[INPUT] 0    0    [1    /1   ]  3.62480586249        1
[INPUT] 1    0    [1    /1   ]  7.14301310574        1
[INPUT] 1    0    [1    /1   ]  23.159284484         1
[INPUT] 1    0    [1    /1   ]  99.7866823581        1
[INPUT] 1    0    [1    /1   ]  0.267082089487       1
[INPUT] 1    0    [1    /1   ]  2.45628396293        1
[INPUT] 1    0    [1    /1   ]  0.838513225377       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.784352255538208, 1.0]], [0, [24413.794183551054, 1.0]], [0, [3661.451720679687, 1.0]], [0, [833.3166773538723, 1.0]], [0, [235.4700859787581, 1.0]], [0, [75.8731509031712, 1.0]], [0, [10.924573102199183, 1.0]], [0, [27.74890139522434, 1.0]], [0, [0.3045650521029519, 1.0]], [0, [1.91928675991216, 1.0]], [0, [3.624805862493971, 1.0]], [1, [7.14301310573994, 1.0]], [1, [23.15928448404579, 1.0]], [1, [99.78668235805439, 1.0]], [1, [0.267082089487433, 1.0]], [1, [2.4562839629302213, 1.0]], [1, [0.8385132253773161, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78435226]
bas 1, expnt(s) = [24413.79418355]
bas 2, expnt(s) = [3661.45172068]
bas 3, expnt(s) = [833.31667735]
bas 4, expnt(s) = [235.47008598]
bas 5, expnt(s) = [75.8731509]
bas 6, expnt(s) = [10.9245731]
bas 7, expnt(s) = [27.7489014]
bas 8, expnt(s) = [0.30456505]
bas 9, expnt(s) = [1.91928676]
bas 10, expnt(s) = [3.62480586]
bas 11, expnt(s) = [7.14301311]
bas 12, expnt(s) = [23.15928448]
bas 13, expnt(s) = [99.78668236]
bas 14, expnt(s) = [0.26708209]
bas 15, expnt(s) = [2.45628396]
bas 16, expnt(s) = [0.83851323]
CPU time:       192.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.84352256e-01 2.10570916e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920029e+03 8.33316677e+02 3.91852462e+02
 2.35470086e+02 1.51868195e+02 7.58731509e+01 6.49502930e+01
 1.09245731e+01 1.51816292e+01 2.77489014e+01 3.05456499e+01
 3.04565052e-01 1.03579802e+00 1.91928676e+00 4.11974111e+00
 3.62480586e+00 6.63710347e+00 7.14301311e+00 3.40671813e+01
 2.31592845e+01 1.48214541e+02 9.97866824e+01 9.20079008e+02
 2.67082089e-01 5.60131955e-01 2.45628396e+00 8.97082962e+00
 8.38513225e-01 2.34084032e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629829440261
cond(S) = 1463.4603012778846
E1 = -183.59037201554995  E_coul = 55.08018288858632
init E= -128.510189126964
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400958344189  LUMO = 0.783086599325776
  mo_energy =
[-3.25551674e+01 -1.85274292e+00 -7.75400958e-01 -7.75400958e-01
 -7.75400958e-01  7.83086599e-01  8.28275768e-01  8.28275768e-01
  8.28275768e-01  3.97989429e+00  3.97989429e+00  3.97989429e+00
  4.18453489e+00  1.38818326e+01  1.44416745e+01  1.44416745e+01
  1.44416745e+01  4.55405594e+01  5.31448503e+01  5.31448503e+01
  5.31448503e+01  1.51990853e+02  2.40937197e+02  2.40937197e+02
  2.40937197e+02  5.15230301e+02  1.88086521e+03  8.00902930e+03
  4.77751507e+04]
E1 = -182.08661706786802  E_coul = 53.54829332852456
cycle= 1 E= -128.538323739343  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519743
diis-c [-0.27013243  1.        ]
  HOMO = -0.884278463735833  LUMO = 0.754739490500662
  mo_energy =
[-3.28782405e+01 -1.96659346e+00 -8.84278464e-01 -8.84278464e-01
 -8.84278464e-01  7.54739491e-01  8.01319481e-01  8.01319481e-01
  8.01319481e-01  3.88201006e+00  3.88201006e+00  3.88201006e+00
  4.10561340e+00  1.37265099e+01  1.42506072e+01  1.42506072e+01
  1.42506072e+01  4.52904558e+01  5.28640125e+01  5.28640125e+01
  5.28640125e+01  1.51674084e+02  2.40591020e+02  2.40591020e+02
  2.40591020e+02  5.14869402e+02  1.88046786e+03  8.00860277e+03
  4.77747053e+04]
E1 = -182.8476916647209  E_coul = 54.30678187243129
cycle= 2 E= -128.54090979229  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264079
diis-c [-0.00069043  0.33608735  0.66391265]
  HOMO = -0.848668106607315  LUMO = 0.763810836605083
  mo_energy =
[-3.27701852e+01 -1.92909691e+00 -8.48668107e-01 -8.48668107e-01
 -8.48668107e-01  7.63810837e-01  8.10107263e-01  8.10107263e-01
  8.10107263e-01  3.91376225e+00  3.91376225e+00  3.91376225e+00
  4.13114136e+00  1.37776306e+01  1.43138967e+01  1.43138967e+01
  1.43138967e+01  4.53742186e+01  5.29579884e+01  5.29579884e+01
  5.29579884e+01  1.51779744e+02  2.40704640e+02  2.40704640e+02
  2.40704640e+02  5.14986014e+02  1.88058985e+03  8.00872724e+03
  4.77748307e+04]
E1 = -182.589180184453  E_coul = 54.047351195913166
cycle= 3 E= -128.54182898854  delta_E= -0.000919  |g|= 0.000519  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115298
diis-c [-1.99757454e-07 -2.37065192e-03 -6.37304998e-04  1.00300796e+00]
  HOMO = -0.848928637124552  LUMO = 0.76375821065282
  mo_energy =
[-3.27706496e+01 -1.92929305e+00 -8.48928637e-01 -8.48928637e-01
 -8.48928637e-01  7.63758211e-01  8.10066060e-01  8.10066060e-01
  8.10066060e-01  3.91358064e+00  3.91358064e+00  3.91358064e+00
  4.13099856e+00  1.37773702e+01  1.43135857e+01  1.43135857e+01
  1.43135857e+01  4.53738510e+01  5.29575782e+01  5.29575782e+01
  5.29575782e+01  1.51779277e+02  2.40704104e+02  2.40704104e+02
  2.40704104e+02  5.14985422e+02  1.88058912e+03  8.00872641e+03
  4.77748298e+04]
E1 = -182.58963923069084  E_coul = 54.04781021554514
cycle= 4 E= -128.541829015146  delta_E= -2.66e-08  |g|= 8.02e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185985
diis-c [-1.10861308e-09  2.39823426e-04  4.87716572e-04 -1.85698366e-01
  1.18497083e+00]
  HOMO = -0.848971816885902  LUMO = 0.76374541305606
  mo_energy =
[-3.27707227e+01 -1.92932563e+00 -8.48971817e-01 -8.48971817e-01
 -8.48971817e-01  7.63745413e-01  8.10052534e-01  8.10052534e-01
  8.10052534e-01  3.91354027e+00  3.91354027e+00  3.91354027e+00
  4.13096765e+00  1.37773184e+01  1.43135261e+01  1.43135261e+01
  1.43135261e+01  4.53737853e+01  5.29575092e+01  5.29575092e+01
  5.29575092e+01  1.51779204e+02  2.40704026e+02  2.40704026e+02
  2.40704026e+02  5.14985341e+02  1.88058903e+03  8.00872631e+03
  4.77748297e+04]
E1 = -182.58977155933422  E_coul = 54.04794254347006
cycle= 5 E= -128.541829015864  delta_E= -7.18e-10  |g|= 5.97e-06  |ddm|= 6.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.58977155933422  E_coul = 54.04794254347006
  HOMO = -0.848968666931263  LUMO = 0.763746718553251
  mo_energy =
[-3.27707156e+01 -1.92932168e+00 -8.48968667e-01 -8.48968667e-01
 -8.48968667e-01  7.63746719e-01  8.10053466e-01  8.10053466e-01
  8.10053466e-01  3.91354330e+00  3.91354330e+00  3.91354330e+00
  4.13097047e+00  1.37773231e+01  1.43135313e+01  1.43135313e+01
  1.43135313e+01  4.53737916e+01  5.29575158e+01  5.29575158e+01
  5.29575158e+01  1.51779211e+02  2.40704033e+02  2.40704033e+02
  2.40704033e+02  5.14985347e+02  1.88058904e+03  8.00872632e+03
  4.77748297e+04]
E1 = -182.58975548901802  E_coul = 54.04792647315109
Extra cycle  E= -128.541829015867  delta_E= -2.79e-12  |g|= 2.26e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1463.4603012778846
E1 = -182.58975548901802  E_coul = 54.04792647315109
init E= -128.541829015867
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848969803342713  LUMO = 0.763746509953562
  mo_energy =
[-3.27707191e+01 -1.92932274e+00 -8.48969803e-01 -8.48969803e-01
 -8.48969803e-01  7.63746510e-01  8.10053204e-01  8.10053204e-01
  8.10053204e-01  3.91354231e+00  3.91354231e+00  3.91354231e+00
  4.13096975e+00  1.37773215e+01  1.43135293e+01  1.43135293e+01
  1.43135293e+01  4.53737889e+01  5.29575127e+01  5.29575127e+01
  5.29575127e+01  1.51779207e+02  2.40704029e+02  2.40704029e+02
  2.40704029e+02  5.14985343e+02  1.88058903e+03  8.00872632e+03
  4.77748297e+04]
E1 = -182.5897644113669  E_coul = 54.047935395499785
cycle= 1 E= -128.541829015867  delta_E= -1.71e-13  |g|= 1.22e-06  |ddm|= 8.08e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5897644113669  E_coul = 54.047935395499785
  HOMO = -0.848969175160062  LUMO = 0.763746686157715
  mo_energy =
[-3.27707172e+01 -1.92932205e+00 -8.48969175e-01 -8.48969175e-01
 -8.48969175e-01  7.63746686e-01  8.10053363e-01  8.10053363e-01
  8.10053363e-01  3.91354288e+00  3.91354288e+00  3.91354288e+00
  4.13097022e+00  1.37773224e+01  1.43135304e+01  1.43135304e+01
  1.43135304e+01  4.53737904e+01  5.29575144e+01  5.29575144e+01
  5.29575144e+01  1.51779209e+02  2.40704031e+02  2.40704031e+02
  2.40704031e+02  5.14985345e+02  1.88058903e+03  8.00872632e+03
  4.77748297e+04]
E1 = -182.58975992683986  E_coul = 54.04793091097288
Extra cycle  E= -128.541829015867  delta_E= 1.14e-13  |g|= 6.09e-07  |ddm|= 3.93e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.41 sec
exp = [7.84352256e-01 2.44137942e+04 3.66145172e+03 8.33316677e+02
 2.35470086e+02 7.58731509e+01 1.09245731e+01 2.77489014e+01
 3.04565052e-01 1.91928676e+00 3.62480586e+00 7.14301311e+00
 2.31592845e+01 9.97866824e+01 2.67082089e-01 2.45628396e+00
 8.38513225e-01]
grad_E = [ 2.07424333e-05 -2.36035713e-09  1.24279721e-07 -2.40715371e-06
  2.45774753e-05 -9.89049813e-05  1.98997511e-05  4.35015492e-05
  4.36112773e-05 -4.79624708e-06 -1.14698485e-04  9.30638633e-05
 -3.45173288e-05  1.87904265e-06 -1.48897573e-04  3.30607599e-05
  7.89443369e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783216120234       1
[INPUT] 0    0    [1    /1   ]  24413.7941836        1
[INPUT] 0    0    [1    /1   ]  3661.45172045        1
[INPUT] 0    0    [1    /1   ]  833.316681422        1
[INPUT] 0    0    [1    /1   ]  235.470048685        1
[INPUT] 0    0    [1    /1   ]  75.8733345153        1
[INPUT] 0    0    [1    /1   ]  10.9230769901        1
[INPUT] 0    0    [1    /1   ]  27.7489597953        1
[INPUT] 0    0    [1    /1   ]  0.304205061168       1
[INPUT] 0    0    [1    /1   ]  1.91549288158        1
[INPUT] 0    0    [1    /1   ]  3.62463665207        1
[INPUT] 1    0    [1    /1   ]  7.1428396564         1
[INPUT] 1    0    [1    /1   ]  23.1593480643        1
[INPUT] 1    0    [1    /1   ]  99.7866791669        1
[INPUT] 1    0    [1    /1   ]  0.267123582018       1
[INPUT] 1    0    [1    /1   ]  2.45625844817        1
[INPUT] 1    0    [1    /1   ]  0.838535966391       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7832161202339126, 1.0]], [0, [24413.79418355565, 1.0]], [0, [3661.4517204465265, 1.0]], [0, [833.3166814217162, 1.0]], [0, [235.47004868457248, 1.0]], [0, [75.87333451530148, 1.0]], [0, [10.923076990149282, 1.0]], [0, [27.748959795329764, 1.0]], [0, [0.3042050611679192, 1.0]], [0, [1.9154928815812333, 1.0]], [0, [3.624636652072072, 1.0]], [1, [7.14283965639759, 1.0]], [1, [23.159348064266133, 1.0]], [1, [99.7866791668699, 1.0]], [1, [0.2671235820176631, 1.0]], [1, [2.456258448171982, 1.0]], [1, [0.8385359663914176, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78321612]
bas 1, expnt(s) = [24413.79418356]
bas 2, expnt(s) = [3661.45172045]
bas 3, expnt(s) = [833.31668142]
bas 4, expnt(s) = [235.47004868]
bas 5, expnt(s) = [75.87333452]
bas 6, expnt(s) = [10.92307699]
bas 7, expnt(s) = [27.7489598]
bas 8, expnt(s) = [0.30420506]
bas 9, expnt(s) = [1.91549288]
bas 10, expnt(s) = [3.62463665]
bas 11, expnt(s) = [7.14283966]
bas 12, expnt(s) = [23.15934806]
bas 13, expnt(s) = [99.78667917]
bas 14, expnt(s) = [0.26712358]
bas 15, expnt(s) = [2.45625845]
bas 16, expnt(s) = [0.83853597]
CPU time:       196.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83216120e-01 2.10342115e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920029e+03 8.33316681e+02 3.91852463e+02
 2.35470049e+02 1.51868177e+02 7.58733345e+01 6.49504108e+01
 1.09230770e+01 1.51800699e+01 2.77489598e+01 3.05456981e+01
 3.04205061e-01 1.03487966e+00 1.91549288e+00 4.11363194e+00
 3.62463665e+00 6.63687109e+00 7.14283966e+00 3.40661472e+01
 2.31593481e+01 1.48215050e+02 9.97866792e+01 9.20078971e+02
 2.67123582e-01 5.60240731e-01 2.45625845e+00 8.97071314e+00
 8.38535966e-01 2.34091967e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629697995724
cond(S) = 1455.680440082456
E1 = -183.59037498216844  E_coul = 55.08018381146452
init E= -128.510191170704
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400873346614  LUMO = 0.781704790770495
  mo_energy =
[-3.25551671e+01 -1.85274294e+00 -7.75400873e-01 -7.75400873e-01
 -7.75400873e-01  7.81704791e-01  8.28395185e-01  8.28395185e-01
  8.28395185e-01  3.98009710e+00  3.98009710e+00  3.98009710e+00
  4.17737954e+00  1.38648545e+01  1.44416800e+01  1.44416800e+01
  1.44416800e+01  4.55156800e+01  5.31445104e+01  5.31445104e+01
  5.31445104e+01  1.51964138e+02  2.40936921e+02  2.40936921e+02
  2.40936921e+02  5.15205407e+02  1.88084285e+03  8.00900961e+03
  4.77751344e+04]
E1 = -182.08667256239934  E_coul = 53.5483485724563
cycle= 1 E= -128.538323989943  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51974
diis-c [-0.27012983  1.        ]
  HOMO = -0.884274021840639  LUMO = 0.753411975683154
  mo_energy =
[-3.28782316e+01 -1.96658806e+00 -8.84274022e-01 -8.84274022e-01
 -8.84274022e-01  7.53411976e-01  8.01437090e-01  8.01437090e-01
  8.01437090e-01  3.88221801e+00  3.88221801e+00  3.88221801e+00
  4.09855203e+00  1.37095897e+01  1.42506217e+01  1.42506217e+01
  1.42506217e+01  4.52655855e+01  5.28636812e+01  5.28636812e+01
  5.28636812e+01  1.51647374e+02  2.40590752e+02  2.40590752e+02
  2.40590752e+02  5.14844516e+02  1.88044550e+03  8.00858310e+03
  4.77746890e+04]
E1 = -182.84771874709352  E_coul = 54.306808813595815
cycle= 2 E= -128.540909933498  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264075
diis-c [-0.0006903   0.33608451  0.66391549]
  HOMO = -0.84866489593461  LUMO = 0.762466320984034
  mo_energy =
[-3.27701796e+01 -1.92909285e+00 -8.48664896e-01 -8.48664896e-01
 -8.48664896e-01  7.62466321e-01  8.10225630e-01  8.10225630e-01
  8.10225630e-01  3.91396898e+00  3.91396898e+00  3.91396898e+00
  4.12404951e+00  1.37606911e+01  1.43139083e+01  1.43139083e+01
  1.43139083e+01  4.53493452e+01  5.29576541e+01  5.29576541e+01
  5.29576541e+01  1.51753032e+02  2.40704369e+02  2.40704369e+02
  2.40704369e+02  5.14961125e+02  1.88056749e+03  8.00870756e+03
  4.77748144e+04]
E1 = -182.58922069627306  E_coul = 54.04739164371268
cycle= 3 E= -128.54182905256  delta_E= -0.000919  |g|= 0.000518  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115284
diis-c [-2.00148693e-07 -2.37078158e-03 -6.38833725e-04  1.00300962e+00]
  HOMO = -0.848925316420023  LUMO = 0.762413872854527
  mo_energy =
[-3.27706438e+01 -1.92928878e+00 -8.48925316e-01 -8.48925316e-01
 -8.48925316e-01  7.62413873e-01  8.10184461e-01  8.10184461e-01
  8.10184461e-01  3.91378751e+00  3.91378751e+00  3.91378751e+00
  4.12390699e+00  1.37604310e+01  1.43135974e+01  1.43135974e+01
  1.43135974e+01  4.53489778e+01  5.29572440e+01  5.29572440e+01
  5.29572440e+01  1.51752565e+02  2.40703833e+02  2.40703833e+02
  2.40703833e+02  5.14960533e+02  1.88056676e+03  8.00870673e+03
  4.77748135e+04]
E1 = -182.58967955694158  E_coul = 54.04785047776222
cycle= 4 E= -128.541829079179  delta_E= -2.66e-08  |g|= 8.02e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018602
diis-c [-1.11062299e-09  2.40218416e-04  4.87952963e-04 -1.85902655e-01
  1.18517448e+00]
  HOMO = -0.848968493489952  LUMO = 0.762401108497875
  mo_energy =
[-3.27707169e+01 -1.92932134e+00 -8.48968493e-01 -8.48968493e-01
 -8.48968493e-01  7.62401108e-01  8.10170936e-01  8.10170936e-01
  8.10170936e-01  3.91374715e+00  3.91374715e+00  3.91374715e+00
  4.12387613e+00  1.37603793e+01  1.43135379e+01  1.43135379e+01
  1.43135379e+01  4.53489121e+01  5.29571750e+01  5.29571750e+01
  5.29571750e+01  1.51752492e+02  2.40703755e+02  2.40703755e+02
  2.40703755e+02  5.14960451e+02  1.88056667e+03  8.00870663e+03
  4.77748134e+04]
E1 = -182.58981187794234  E_coul = 54.047982798043385
cycle= 5 E= -128.541829079899  delta_E= -7.2e-10  |g|= 5.98e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58981187794234  E_coul = 54.047982798043385
  HOMO = -0.84896533763584  LUMO = 0.762402414174025
  mo_energy =
[-3.27707097e+01 -1.92931739e+00 -8.48965338e-01 -8.48965338e-01
 -8.48965338e-01  7.62402414e-01  8.10171869e-01  8.10171869e-01
  8.10171869e-01  3.91375018e+00  3.91375018e+00  3.91375018e+00
  4.12387896e+00  1.37603839e+01  1.43135430e+01  1.43135430e+01
  1.43135430e+01  4.53489184e+01  5.29571817e+01  5.29571817e+01
  5.29571817e+01  1.51752499e+02  2.40703762e+02  2.40703762e+02
  2.40703762e+02  5.14960458e+02  1.88056668e+03  8.00870664e+03
  4.77748134e+04]
E1 = -182.58979578323863  E_coul = 54.047966703337266
Extra cycle  E= -128.541829079901  delta_E= -2.42e-12  |g|= 2.26e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.83216120e-01 2.44137942e+04 3.66145172e+03 8.33316681e+02
 2.35470049e+02 7.58733345e+01 1.09230770e+01 2.77489598e+01
 3.04205061e-01 1.91549288e+00 3.62463665e+00 7.14283966e+00
 2.31593481e+01 9.97866792e+01 2.67123582e-01 2.45625845e+00
 8.38535966e-01]
E = -128.54182907990136
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783216120234       1
[INPUT] 0    0    [1    /1   ]  24413.7941836        1
[INPUT] 0    0    [1    /1   ]  3661.45172045        1
[INPUT] 0    0    [1    /1   ]  833.316681422        1
[INPUT] 0    0    [1    /1   ]  235.470048685        1
[INPUT] 0    0    [1    /1   ]  75.8733345153        1
[INPUT] 0    0    [1    /1   ]  10.9230769901        1
[INPUT] 0    0    [1    /1   ]  27.7489597953        1
[INPUT] 0    0    [1    /1   ]  0.304205061168       1
[INPUT] 0    0    [1    /1   ]  1.91549288158        1
[INPUT] 0    0    [1    /1   ]  3.62463665207        1
[INPUT] 1    0    [1    /1   ]  7.1428396564         1
[INPUT] 1    0    [1    /1   ]  23.1593480643        1
[INPUT] 1    0    [1    /1   ]  99.7866791669        1
[INPUT] 1    0    [1    /1   ]  0.267123582018       1
[INPUT] 1    0    [1    /1   ]  2.45625844817        1
[INPUT] 1    0    [1    /1   ]  0.838535966391       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7832161202339126, 1.0]], [0, [24413.79418355565, 1.0]], [0, [3661.4517204465265, 1.0]], [0, [833.3166814217162, 1.0]], [0, [235.47004868457248, 1.0]], [0, [75.87333451530148, 1.0]], [0, [10.923076990149282, 1.0]], [0, [27.748959795329764, 1.0]], [0, [0.3042050611679192, 1.0]], [0, [1.9154928815812333, 1.0]], [0, [3.624636652072072, 1.0]], [1, [7.14283965639759, 1.0]], [1, [23.159348064266133, 1.0]], [1, [99.7866791668699, 1.0]], [1, [0.2671235820176631, 1.0]], [1, [2.456258448171982, 1.0]], [1, [0.8385359663914176, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78321612]
bas 1, expnt(s) = [24413.79418356]
bas 2, expnt(s) = [3661.45172045]
bas 3, expnt(s) = [833.31668142]
bas 4, expnt(s) = [235.47004868]
bas 5, expnt(s) = [75.87333452]
bas 6, expnt(s) = [10.92307699]
bas 7, expnt(s) = [27.7489598]
bas 8, expnt(s) = [0.30420506]
bas 9, expnt(s) = [1.91549288]
bas 10, expnt(s) = [3.62463665]
bas 11, expnt(s) = [7.14283966]
bas 12, expnt(s) = [23.15934806]
bas 13, expnt(s) = [99.78667917]
bas 14, expnt(s) = [0.26712358]
bas 15, expnt(s) = [2.45625845]
bas 16, expnt(s) = [0.83853597]
CPU time:       197.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83216120e-01 2.10342115e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920029e+03 8.33316681e+02 3.91852463e+02
 2.35470049e+02 1.51868177e+02 7.58733345e+01 6.49504108e+01
 1.09230770e+01 1.51800699e+01 2.77489598e+01 3.05456981e+01
 3.04205061e-01 1.03487966e+00 1.91549288e+00 4.11363194e+00
 3.62463665e+00 6.63687109e+00 7.14283966e+00 3.40661472e+01
 2.31593481e+01 1.48215050e+02 9.97866792e+01 9.20078971e+02
 2.67123582e-01 5.60240731e-01 2.45625845e+00 8.97071314e+00
 8.38535966e-01 2.34091967e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629697995724
cond(S) = 1455.680440082456
E1 = -183.59037498216844  E_coul = 55.08018381146452
init E= -128.510191170704
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400873346614  LUMO = 0.781704790770495
  mo_energy =
[-3.25551671e+01 -1.85274294e+00 -7.75400873e-01 -7.75400873e-01
 -7.75400873e-01  7.81704791e-01  8.28395185e-01  8.28395185e-01
  8.28395185e-01  3.98009710e+00  3.98009710e+00  3.98009710e+00
  4.17737954e+00  1.38648545e+01  1.44416800e+01  1.44416800e+01
  1.44416800e+01  4.55156800e+01  5.31445104e+01  5.31445104e+01
  5.31445104e+01  1.51964138e+02  2.40936921e+02  2.40936921e+02
  2.40936921e+02  5.15205407e+02  1.88084285e+03  8.00900961e+03
  4.77751344e+04]
E1 = -182.08667256239934  E_coul = 53.5483485724563
cycle= 1 E= -128.538323989943  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51974
diis-c [-0.27012983  1.        ]
  HOMO = -0.884274021840639  LUMO = 0.753411975683154
  mo_energy =
[-3.28782316e+01 -1.96658806e+00 -8.84274022e-01 -8.84274022e-01
 -8.84274022e-01  7.53411976e-01  8.01437090e-01  8.01437090e-01
  8.01437090e-01  3.88221801e+00  3.88221801e+00  3.88221801e+00
  4.09855203e+00  1.37095897e+01  1.42506217e+01  1.42506217e+01
  1.42506217e+01  4.52655855e+01  5.28636812e+01  5.28636812e+01
  5.28636812e+01  1.51647374e+02  2.40590752e+02  2.40590752e+02
  2.40590752e+02  5.14844516e+02  1.88044550e+03  8.00858310e+03
  4.77746890e+04]
E1 = -182.84771874709352  E_coul = 54.306808813595815
cycle= 2 E= -128.540909933498  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264075
diis-c [-0.0006903   0.33608451  0.66391549]
  HOMO = -0.84866489593461  LUMO = 0.762466320984034
  mo_energy =
[-3.27701796e+01 -1.92909285e+00 -8.48664896e-01 -8.48664896e-01
 -8.48664896e-01  7.62466321e-01  8.10225630e-01  8.10225630e-01
  8.10225630e-01  3.91396898e+00  3.91396898e+00  3.91396898e+00
  4.12404951e+00  1.37606911e+01  1.43139083e+01  1.43139083e+01
  1.43139083e+01  4.53493452e+01  5.29576541e+01  5.29576541e+01
  5.29576541e+01  1.51753032e+02  2.40704369e+02  2.40704369e+02
  2.40704369e+02  5.14961125e+02  1.88056749e+03  8.00870756e+03
  4.77748144e+04]
E1 = -182.58922069627306  E_coul = 54.04739164371268
cycle= 3 E= -128.54182905256  delta_E= -0.000919  |g|= 0.000518  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115284
diis-c [-2.00148693e-07 -2.37078158e-03 -6.38833725e-04  1.00300962e+00]
  HOMO = -0.848925316420023  LUMO = 0.762413872854527
  mo_energy =
[-3.27706438e+01 -1.92928878e+00 -8.48925316e-01 -8.48925316e-01
 -8.48925316e-01  7.62413873e-01  8.10184461e-01  8.10184461e-01
  8.10184461e-01  3.91378751e+00  3.91378751e+00  3.91378751e+00
  4.12390699e+00  1.37604310e+01  1.43135974e+01  1.43135974e+01
  1.43135974e+01  4.53489778e+01  5.29572440e+01  5.29572440e+01
  5.29572440e+01  1.51752565e+02  2.40703833e+02  2.40703833e+02
  2.40703833e+02  5.14960533e+02  1.88056676e+03  8.00870673e+03
  4.77748135e+04]
E1 = -182.58967955694158  E_coul = 54.04785047776222
cycle= 4 E= -128.541829079179  delta_E= -2.66e-08  |g|= 8.02e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018602
diis-c [-1.11062299e-09  2.40218416e-04  4.87952963e-04 -1.85902655e-01
  1.18517448e+00]
  HOMO = -0.848968493489952  LUMO = 0.762401108497875
  mo_energy =
[-3.27707169e+01 -1.92932134e+00 -8.48968493e-01 -8.48968493e-01
 -8.48968493e-01  7.62401108e-01  8.10170936e-01  8.10170936e-01
  8.10170936e-01  3.91374715e+00  3.91374715e+00  3.91374715e+00
  4.12387613e+00  1.37603793e+01  1.43135379e+01  1.43135379e+01
  1.43135379e+01  4.53489121e+01  5.29571750e+01  5.29571750e+01
  5.29571750e+01  1.51752492e+02  2.40703755e+02  2.40703755e+02
  2.40703755e+02  5.14960451e+02  1.88056667e+03  8.00870663e+03
  4.77748134e+04]
E1 = -182.58981187794234  E_coul = 54.047982798043385
cycle= 5 E= -128.541829079899  delta_E= -7.2e-10  |g|= 5.98e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58981187794234  E_coul = 54.047982798043385
  HOMO = -0.84896533763584  LUMO = 0.762402414174025
  mo_energy =
[-3.27707097e+01 -1.92931739e+00 -8.48965338e-01 -8.48965338e-01
 -8.48965338e-01  7.62402414e-01  8.10171869e-01  8.10171869e-01
  8.10171869e-01  3.91375018e+00  3.91375018e+00  3.91375018e+00
  4.12387896e+00  1.37603839e+01  1.43135430e+01  1.43135430e+01
  1.43135430e+01  4.53489184e+01  5.29571817e+01  5.29571817e+01
  5.29571817e+01  1.51752499e+02  2.40703762e+02  2.40703762e+02
  2.40703762e+02  5.14960458e+02  1.88056668e+03  8.00870664e+03
  4.77748134e+04]
E1 = -182.58979578323863  E_coul = 54.047966703337266
Extra cycle  E= -128.541829079901  delta_E= -2.42e-12  |g|= 2.26e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1455.680440082456
E1 = -182.58979578323863  E_coul = 54.047966703337266
init E= -128.541829079901
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.848966475696801  LUMO = 0.762402205693359
  mo_energy =
[-3.27707133e+01 -1.92931845e+00 -8.48966476e-01 -8.48966476e-01
 -8.48966476e-01  7.62402206e-01  8.10171607e-01  8.10171607e-01
  8.10171607e-01  3.91374919e+00  3.91374919e+00  3.91374919e+00
  4.12387823e+00  1.37603823e+01  1.43135410e+01  1.43135410e+01
  1.43135410e+01  4.53489157e+01  5.29571786e+01  5.29571786e+01
  5.29571786e+01  1.51752496e+02  2.40703758e+02  2.40703758e+02
  2.40703758e+02  5.14960454e+02  1.88056668e+03  8.00870664e+03
  4.77748134e+04]
E1 = -182.58980471957852  E_coul = 54.047975639676615
cycle= 1 E= -128.541829079902  delta_E= -5.4e-13  |g|= 1.22e-06  |ddm|= 8.09e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58980471957852  E_coul = 54.047975639676615
  HOMO = -0.848965846518221  LUMO = 0.762402381850306
  mo_energy =
[-3.27707114e+01 -1.92931775e+00 -8.48965847e-01 -8.48965847e-01
 -8.48965847e-01  7.62402382e-01  8.10171765e-01  8.10171765e-01
  8.10171765e-01  3.91374976e+00  3.91374976e+00  3.91374976e+00
  4.12387870e+00  1.37603832e+01  1.43135421e+01  1.43135421e+01
  1.43135421e+01  4.53489172e+01  5.29571802e+01  5.29571802e+01
  5.29571802e+01  1.51752497e+02  2.40703760e+02  2.40703760e+02
  2.40703760e+02  5.14960456e+02  1.88056668e+03  8.00870664e+03
  4.77748134e+04]
E1 = -182.5898002281491  E_coul = 54.04797114824744
Extra cycle  E= -128.541829079902  delta_E= 2.27e-13  |g|= 6.1e-07  |ddm|= 3.93e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [7.83216120e-01 2.44137942e+04 3.66145172e+03 8.33316681e+02
 2.35470049e+02 7.58733345e+01 1.09230770e+01 2.77489598e+01
 3.04205061e-01 1.91549288e+00 3.62463665e+00 7.14283966e+00
 2.31593481e+01 9.97866792e+01 2.67123582e-01 2.45625845e+00
 8.38535966e-01]
grad_E = [ 3.87994696e-05 -2.36473632e-09  1.24512164e-07 -2.41178200e-06
  2.46340524e-05 -9.93061580e-05  1.87695849e-05  4.48201824e-05
  1.20979725e-05 -9.59382556e-06 -1.14529569e-04  9.00700399e-05
 -3.40767798e-05  1.86005539e-06 -2.24934907e-05  4.47185052e-05
  2.95351421e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.779233076023       1
[INPUT] 0    0    [1    /1   ]  24413.7941836        1
[INPUT] 0    0    [1    /1   ]  3661.4517185         1
[INPUT] 0    0    [1    /1   ]  833.316717362        1
[INPUT] 0    0    [1    /1   ]  235.469694305        1
[INPUT] 0    0    [1    /1   ]  75.8750424752        1
[INPUT] 0    0    [1    /1   ]  10.9168995765        1
[INPUT] 0    0    [1    /1   ]  27.7478826069        1
[INPUT] 0    0    [1    /1   ]  0.302958863801       1
[INPUT] 0    0    [1    /1   ]  1.9019993577         1
[INPUT] 0    0    [1    /1   ]  3.62425351446        1
[INPUT] 1    0    [1    /1   ]  7.14136180024        1
[INPUT] 1    0    [1    /1   ]  23.1598692365        1
[INPUT] 1    0    [1    /1   ]  99.7866523015        1
[INPUT] 1    0    [1    /1   ]  0.267296816372       1
[INPUT] 1    0    [1    /1   ]  2.45599407179        1
[INPUT] 1    0    [1    /1   ]  0.838614167174       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7792330760226743, 1.0]], [0, [24413.794183593403, 1.0]], [0, [3661.451718497275, 1.0]], [0, [833.316717362409, 1.0]], [0, [235.46969430480019, 1.0]], [0, [75.87504247521389, 1.0]], [0, [10.916899576456856, 1.0]], [0, [27.747882606880616, 1.0]], [0, [0.3029588638014799, 1.0]], [0, [1.9019993576958871, 1.0]], [0, [3.6242535144553165, 1.0]], [1, [7.1413618002381245, 1.0]], [1, [23.159869236488973, 1.0]], [1, [99.78665230146602, 1.0]], [1, [0.2672968163721368, 1.0]], [1, [2.4559940717881266, 1.0]], [1, [0.8386141671742188, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77923308]
bas 1, expnt(s) = [24413.79418359]
bas 2, expnt(s) = [3661.4517185]
bas 3, expnt(s) = [833.31671736]
bas 4, expnt(s) = [235.4696943]
bas 5, expnt(s) = [75.87504248]
bas 6, expnt(s) = [10.91689958]
bas 7, expnt(s) = [27.74788261]
bas 8, expnt(s) = [0.30295886]
bas 9, expnt(s) = [1.90199936]
bas 10, expnt(s) = [3.62425351]
bas 11, expnt(s) = [7.1413618]
bas 12, expnt(s) = [23.15986924]
bas 13, expnt(s) = [99.7866523]
bas 14, expnt(s) = [0.26729682]
bas 15, expnt(s) = [2.45599407]
bas 16, expnt(s) = [0.83861417]
CPU time:       200.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.79233076e-01 2.09539334e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920029e+03 8.33316717e+02 3.91852476e+02
 2.35469694e+02 1.51868005e+02 7.58750425e+01 6.49515074e+01
 1.09168996e+01 1.51736307e+01 2.77478826e+01 3.05448088e+01
 3.02958864e-01 1.03169844e+00 1.90199936e+00 4.09187915e+00
 3.62425351e+00 6.63634493e+00 7.14136180e+00 3.40573371e+01
 2.31598692e+01 1.48219219e+02 9.97866523e+01 9.20078662e+02
 2.67296816e-01 5.60694925e-01 2.45599407e+00 8.96950622e+00
 8.38614167e-01 2.34119256e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629136051155
cond(S) = 1428.7258009688514
E1 = -183.59038650657433  E_coul = 55.08018785535801
init E= -128.510198651216
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400479965063  LUMO = 0.776891911546822
  mo_energy =
[-3.25551662e+01 -1.85274287e+00 -7.75400480e-01 -7.75400480e-01
 -7.75400480e-01  7.76891912e-01  8.28885942e-01  8.28885942e-01
  8.28885942e-01  3.98082276e+00  3.98082276e+00  3.98082276e+00
  4.15221632e+00  1.38049423e+01  1.44405873e+01  1.44405873e+01
  1.44405873e+01  4.54263115e+01  5.31406051e+01  5.31406051e+01
  5.31406051e+01  1.51865287e+02  2.40933816e+02  2.40933816e+02
  2.40933816e+02  5.15112724e+02  1.88075978e+03  8.00893649e+03
  4.77750739e+04]
E1 = -182.08691421084487  E_coul = 53.548589011813554
cycle= 1 E= -128.538325199031  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519723
diis-c [-0.2701124  1.       ]
  HOMO = -0.884254476898351  LUMO = 0.748791326120814
  mo_energy =
[-3.28781933e+01 -1.96656466e+00 -8.84254477e-01 -8.84254477e-01
 -8.84254477e-01  7.48791326e-01  8.01921434e-01  8.01921434e-01
  8.01921434e-01  3.88296993e+00  3.88296993e+00  3.88296993e+00
  4.07372512e+00  1.36498883e+01  1.42495764e+01  1.42495764e+01
  1.42495764e+01  4.51762596e+01  5.28598134e+01  5.28598134e+01
  5.28598134e+01  1.51548549e+02  2.40587684e+02  2.40587684e+02
  2.40587684e+02  5.14751864e+02  1.88036248e+03  8.00851001e+03
  4.77746285e+04]
E1 = -182.84783769616115  E_coul = 54.30692703725222
cycle= 2 E= -128.540910658909  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264051
diis-c [-0.00068982  0.33607254  0.66392746]
  HOMO = -0.848650671926943  LUMO = 0.757785889796151
  mo_energy =
[-3.27701558e+01 -1.92907522e+00 -8.48650672e-01 -8.48650672e-01
 -8.48650672e-01  7.57785890e-01  8.10712903e-01  8.10712903e-01
  8.10712903e-01  3.91471435e+00  3.91471435e+00  3.91471435e+00
  4.09911385e+00  1.37009198e+01  1.43128474e+01  1.43128474e+01
  1.43128474e+01  4.52600049e+01  5.29537728e+01  5.29537728e+01
  5.29537728e+01  1.51654197e+02  2.40701286e+02  2.40701286e+02
  2.40701286e+02  5.14868460e+02  1.88048445e+03  8.00863446e+03
  4.77747539e+04]
E1 = -182.58939817063353  E_coul = 54.04756872742692
cycle= 3 E= -128.541829443207  delta_E= -0.000919  |g|= 0.000518  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115197
diis-c [-2.01543502e-07 -2.37070852e-03 -6.44749000e-04  1.00301546e+00]
  HOMO = -0.848910550551869  LUMO = 0.757734160293761
  mo_energy =
[-3.27706191e+01 -1.92927027e+00 -8.48910551e-01 -8.48910551e-01
 -8.48910551e-01  7.57734160e-01  8.10671912e-01  8.10671912e-01
  8.10671912e-01  3.91453352e+00  3.91453352e+00  3.91453352e+00
  4.09897249e+00  1.37006608e+01  1.43125373e+01  1.43125373e+01
  1.43125373e+01  4.52596384e+01  5.29533636e+01  5.29533636e+01
  5.29533636e+01  1.51653731e+02  2.40700751e+02  2.40700751e+02
  2.40700751e+02  5.14867869e+02  1.88048372e+03  8.00863363e+03
  4.77747530e+04]
E1 = -182.58985624565858  E_coul = 54.048026775808346
cycle= 4 E= -128.54182946985  delta_E= -2.66e-08  |g|= 8.03e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186116
diis-c [-1.11833481e-09  2.41769327e-04  4.88898034e-04 -1.86710458e-01
  1.18597979e+00]
  HOMO = -0.848953696745862  LUMO = 0.757721528143901
  mo_energy =
[-3.27706921e+01 -1.92930268e+00 -8.48953697e-01 -8.48953697e-01
 -8.48953697e-01  7.57721528e-01  8.10658396e-01  8.10658396e-01
  8.10658396e-01  3.91449321e+00  3.91449321e+00  3.91449321e+00
  4.09894181e+00  1.37006092e+01  1.43124778e+01  1.43124778e+01
  1.43124778e+01  4.52595728e+01  5.29532946e+01  5.29532946e+01
  5.29532946e+01  1.51653658e+02  2.40700673e+02  2.40700673e+02
  2.40700673e+02  5.14867787e+02  1.88048363e+03  8.00863354e+03
  4.77747529e+04]
E1 = -182.58998852822216  E_coul = 54.048159057648576
cycle= 5 E= -128.541829470574  delta_E= -7.23e-10  |g|= 6.02e-06  |ddm|= 6.27e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58998852822216  E_coul = 54.048159057648576
  HOMO = -0.848950517861387  LUMO = 0.75772283513825
  mo_energy =
[-3.27706849e+01 -1.92929871e+00 -8.48950518e-01 -8.48950518e-01
 -8.48950518e-01  7.57722835e-01  8.10659337e-01  8.10659337e-01
  8.10659337e-01  3.91449627e+00  3.91449627e+00  3.91449627e+00
  4.09894465e+00  1.37006139e+01  1.43124831e+01  1.43124831e+01
  1.43124831e+01  4.52595791e+01  5.29533014e+01  5.29533014e+01
  5.29533014e+01  1.51653664e+02  2.40700680e+02  2.40700680e+02
  2.40700680e+02  5.14867794e+02  1.88048364e+03  8.00863354e+03
  4.77747529e+04]
E1 = -182.58997233850008  E_coul = 54.04814286792365
Extra cycle  E= -128.541829470576  delta_E= -2.84e-12  |g|= 2.28e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.16 sec
exp = [7.79233076e-01 2.44137942e+04 3.66145172e+03 8.33316717e+02
 2.35469694e+02 7.58750425e+01 1.09168996e+01 2.77478826e+01
 3.02958864e-01 1.90199936e+00 3.62425351e+00 7.14136180e+00
 2.31598692e+01 9.97866523e+01 2.67296816e-01 2.45599407e+00
 8.38614167e-01]
E = -128.54182947057643
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.779233076023       1
[INPUT] 0    0    [1    /1   ]  24413.7941836        1
[INPUT] 0    0    [1    /1   ]  3661.4517185         1
[INPUT] 0    0    [1    /1   ]  833.316717362        1
[INPUT] 0    0    [1    /1   ]  235.469694305        1
[INPUT] 0    0    [1    /1   ]  75.8750424752        1
[INPUT] 0    0    [1    /1   ]  10.9168995765        1
[INPUT] 0    0    [1    /1   ]  27.7478826069        1
[INPUT] 0    0    [1    /1   ]  0.302958863801       1
[INPUT] 0    0    [1    /1   ]  1.9019993577         1
[INPUT] 0    0    [1    /1   ]  3.62425351446        1
[INPUT] 1    0    [1    /1   ]  7.14136180024        1
[INPUT] 1    0    [1    /1   ]  23.1598692365        1
[INPUT] 1    0    [1    /1   ]  99.7866523015        1
[INPUT] 1    0    [1    /1   ]  0.267296816372       1
[INPUT] 1    0    [1    /1   ]  2.45599407179        1
[INPUT] 1    0    [1    /1   ]  0.838614167174       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7792330760226743, 1.0]], [0, [24413.794183593403, 1.0]], [0, [3661.451718497275, 1.0]], [0, [833.316717362409, 1.0]], [0, [235.46969430480019, 1.0]], [0, [75.87504247521389, 1.0]], [0, [10.916899576456856, 1.0]], [0, [27.747882606880616, 1.0]], [0, [0.3029588638014799, 1.0]], [0, [1.9019993576958871, 1.0]], [0, [3.6242535144553165, 1.0]], [1, [7.1413618002381245, 1.0]], [1, [23.159869236488973, 1.0]], [1, [99.78665230146602, 1.0]], [1, [0.2672968163721368, 1.0]], [1, [2.4559940717881266, 1.0]], [1, [0.8386141671742188, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77923308]
bas 1, expnt(s) = [24413.79418359]
bas 2, expnt(s) = [3661.4517185]
bas 3, expnt(s) = [833.31671736]
bas 4, expnt(s) = [235.4696943]
bas 5, expnt(s) = [75.87504248]
bas 6, expnt(s) = [10.91689958]
bas 7, expnt(s) = [27.74788261]
bas 8, expnt(s) = [0.30295886]
bas 9, expnt(s) = [1.90199936]
bas 10, expnt(s) = [3.62425351]
bas 11, expnt(s) = [7.1413618]
bas 12, expnt(s) = [23.15986924]
bas 13, expnt(s) = [99.7866523]
bas 14, expnt(s) = [0.26729682]
bas 15, expnt(s) = [2.45599407]
bas 16, expnt(s) = [0.83861417]
CPU time:       201.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.79233076e-01 2.09539334e+00 2.44137942e+04 4.93448103e+03
 3.66145172e+03 1.18920029e+03 8.33316717e+02 3.91852476e+02
 2.35469694e+02 1.51868005e+02 7.58750425e+01 6.49515074e+01
 1.09168996e+01 1.51736307e+01 2.77478826e+01 3.05448088e+01
 3.02958864e-01 1.03169844e+00 1.90199936e+00 4.09187915e+00
 3.62425351e+00 6.63634493e+00 7.14136180e+00 3.40573371e+01
 2.31598692e+01 1.48219219e+02 9.97866523e+01 9.20078662e+02
 2.67296816e-01 5.60694925e-01 2.45599407e+00 8.96950622e+00
 8.38614167e-01 2.34119256e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629136051155
cond(S) = 1428.7258009688514
E1 = -183.59038650657433  E_coul = 55.08018785535801
init E= -128.510198651216
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400479965063  LUMO = 0.776891911546822
  mo_energy =
[-3.25551662e+01 -1.85274287e+00 -7.75400480e-01 -7.75400480e-01
 -7.75400480e-01  7.76891912e-01  8.28885942e-01  8.28885942e-01
  8.28885942e-01  3.98082276e+00  3.98082276e+00  3.98082276e+00
  4.15221632e+00  1.38049423e+01  1.44405873e+01  1.44405873e+01
  1.44405873e+01  4.54263115e+01  5.31406051e+01  5.31406051e+01
  5.31406051e+01  1.51865287e+02  2.40933816e+02  2.40933816e+02
  2.40933816e+02  5.15112724e+02  1.88075978e+03  8.00893649e+03
  4.77750739e+04]
E1 = -182.08691421084487  E_coul = 53.548589011813554
cycle= 1 E= -128.538325199031  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519723
diis-c [-0.2701124  1.       ]
  HOMO = -0.884254476898351  LUMO = 0.748791326120814
  mo_energy =
[-3.28781933e+01 -1.96656466e+00 -8.84254477e-01 -8.84254477e-01
 -8.84254477e-01  7.48791326e-01  8.01921434e-01  8.01921434e-01
  8.01921434e-01  3.88296993e+00  3.88296993e+00  3.88296993e+00
  4.07372512e+00  1.36498883e+01  1.42495764e+01  1.42495764e+01
  1.42495764e+01  4.51762596e+01  5.28598134e+01  5.28598134e+01
  5.28598134e+01  1.51548549e+02  2.40587684e+02  2.40587684e+02
  2.40587684e+02  5.14751864e+02  1.88036248e+03  8.00851001e+03
  4.77746285e+04]
E1 = -182.84783769616115  E_coul = 54.30692703725222
cycle= 2 E= -128.540910658909  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264051
diis-c [-0.00068982  0.33607254  0.66392746]
  HOMO = -0.848650671926943  LUMO = 0.757785889796151
  mo_energy =
[-3.27701558e+01 -1.92907522e+00 -8.48650672e-01 -8.48650672e-01
 -8.48650672e-01  7.57785890e-01  8.10712903e-01  8.10712903e-01
  8.10712903e-01  3.91471435e+00  3.91471435e+00  3.91471435e+00
  4.09911385e+00  1.37009198e+01  1.43128474e+01  1.43128474e+01
  1.43128474e+01  4.52600049e+01  5.29537728e+01  5.29537728e+01
  5.29537728e+01  1.51654197e+02  2.40701286e+02  2.40701286e+02
  2.40701286e+02  5.14868460e+02  1.88048445e+03  8.00863446e+03
  4.77747539e+04]
E1 = -182.58939817063353  E_coul = 54.04756872742692
cycle= 3 E= -128.541829443207  delta_E= -0.000919  |g|= 0.000518  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115197
diis-c [-2.01543502e-07 -2.37070852e-03 -6.44749000e-04  1.00301546e+00]
  HOMO = -0.848910550551869  LUMO = 0.757734160293761
  mo_energy =
[-3.27706191e+01 -1.92927027e+00 -8.48910551e-01 -8.48910551e-01
 -8.48910551e-01  7.57734160e-01  8.10671912e-01  8.10671912e-01
  8.10671912e-01  3.91453352e+00  3.91453352e+00  3.91453352e+00
  4.09897249e+00  1.37006608e+01  1.43125373e+01  1.43125373e+01
  1.43125373e+01  4.52596384e+01  5.29533636e+01  5.29533636e+01
  5.29533636e+01  1.51653731e+02  2.40700751e+02  2.40700751e+02
  2.40700751e+02  5.14867869e+02  1.88048372e+03  8.00863363e+03
  4.77747530e+04]
E1 = -182.58985624565858  E_coul = 54.048026775808346
cycle= 4 E= -128.54182946985  delta_E= -2.66e-08  |g|= 8.03e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186116
diis-c [-1.11833481e-09  2.41769327e-04  4.88898034e-04 -1.86710458e-01
  1.18597979e+00]
  HOMO = -0.848953696745862  LUMO = 0.757721528143901
  mo_energy =
[-3.27706921e+01 -1.92930268e+00 -8.48953697e-01 -8.48953697e-01
 -8.48953697e-01  7.57721528e-01  8.10658396e-01  8.10658396e-01
  8.10658396e-01  3.91449321e+00  3.91449321e+00  3.91449321e+00
  4.09894181e+00  1.37006092e+01  1.43124778e+01  1.43124778e+01
  1.43124778e+01  4.52595728e+01  5.29532946e+01  5.29532946e+01
  5.29532946e+01  1.51653658e+02  2.40700673e+02  2.40700673e+02
  2.40700673e+02  5.14867787e+02  1.88048363e+03  8.00863354e+03
  4.77747529e+04]
E1 = -182.58998852822216  E_coul = 54.048159057648576
cycle= 5 E= -128.541829470574  delta_E= -7.23e-10  |g|= 6.02e-06  |ddm|= 6.27e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58998852822216  E_coul = 54.048159057648576
  HOMO = -0.848950517861387  LUMO = 0.75772283513825
  mo_energy =
[-3.27706849e+01 -1.92929871e+00 -8.48950518e-01 -8.48950518e-01
 -8.48950518e-01  7.57722835e-01  8.10659337e-01  8.10659337e-01
  8.10659337e-01  3.91449627e+00  3.91449627e+00  3.91449627e+00
  4.09894465e+00  1.37006139e+01  1.43124831e+01  1.43124831e+01
  1.43124831e+01  4.52595791e+01  5.29533014e+01  5.29533014e+01
  5.29533014e+01  1.51653664e+02  2.40700680e+02  2.40700680e+02
  2.40700680e+02  5.14867794e+02  1.88048364e+03  8.00863354e+03
  4.77747529e+04]
E1 = -182.58997233850008  E_coul = 54.04814286792365
Extra cycle  E= -128.541829470576  delta_E= -2.84e-12  |g|= 2.28e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1428.7258009688514
E1 = -182.58997233850008  E_coul = 54.04814286792365
init E= -128.541829470576
    CPU time for initialize scf      0.37 sec, wall time      0.37 sec
  HOMO = -0.848951662338483  LUMO = 0.757722626937658
  mo_energy =
[-3.27706885e+01 -1.92929977e+00 -8.48951662e-01 -8.48951662e-01
 -8.48951662e-01  7.57722627e-01  8.10659073e-01  8.10659073e-01
  8.10659073e-01  3.91449527e+00  3.91449527e+00  3.91449527e+00
  4.09894392e+00  1.37006123e+01  1.43124810e+01  1.43124810e+01
  1.43124810e+01  4.52595764e+01  5.29532983e+01  5.29532983e+01
  5.29532983e+01  1.51653661e+02  2.40700677e+02  2.40700677e+02
  2.40700677e+02  5.14867790e+02  1.88048363e+03  8.00863354e+03
  4.77747529e+04]
E1 = -182.58998132918782  E_coul = 54.04815185861132
cycle= 1 E= -128.541829470576  delta_E= -5.68e-14  |g|= 1.23e-06  |ddm|= 8.14e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58998132918782  E_coul = 54.04815185861132
  HOMO = -0.848951029289904  LUMO = 0.757722803016696
  mo_energy =
[-3.27706866e+01 -1.92929908e+00 -8.48951029e-01 -8.48951029e-01
 -8.48951029e-01  7.57722803e-01  8.10659233e-01  8.10659233e-01
  8.10659233e-01  3.91449584e+00  3.91449584e+00  3.91449584e+00
  4.09894440e+00  1.37006132e+01  1.43124821e+01  1.43124821e+01
  1.43124821e+01  4.52595779e+01  5.29532999e+01  5.29532999e+01
  5.29532999e+01  1.51653663e+02  2.40700679e+02  2.40700679e+02
  2.40700679e+02  5.14867792e+02  1.88048364e+03  8.00863354e+03
  4.77747529e+04]
E1 = -182.58997681095212  E_coul = 54.048147340375415
Extra cycle  E= -128.541829470577  delta_E= -2.27e-13  |g|= 6.14e-07  |ddm|= 3.95e-07
    CPU time for scf_cycle      0.45 sec, wall time      0.45 sec
exp = [7.79233076e-01 2.44137942e+04 3.66145172e+03 8.33316717e+02
 2.35469694e+02 7.58750425e+01 1.09168996e+01 2.77478826e+01
 3.02958864e-01 1.90199936e+00 3.62425351e+00 7.14136180e+00
 2.31598692e+01 9.97866523e+01 2.67296816e-01 2.45599407e+00
 8.38614167e-01]
grad_E = [ 1.04607132e-04 -2.37272325e-09  1.24940705e-07 -2.42077188e-06
  2.47586709e-05 -1.00375761e-04  1.48182459e-05  4.89313073e-05
 -9.84658277e-05 -2.75394897e-05 -1.13570851e-04  6.98357490e-05
 -3.07569707e-05  1.71274431e-06  5.14564290e-04  1.06438743e-04
 -1.86050863e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.774606298767       1
[INPUT] 0    0    [1    /1   ]  24413.7941837        1
[INPUT] 0    0    [1    /1   ]  3661.45171446        1
[INPUT] 0    0    [1    /1   ]  833.316794061        1
[INPUT] 0    0    [1    /1   ]  235.468928871        1
[INPUT] 0    0    [1    /1   ]  75.8781371064        1
[INPUT] 0    0    [1    /1   ]  10.9110954831        1
[INPUT] 0    0    [1    /1   ]  27.7476324595        1
[INPUT] 0    0    [1    /1   ]  0.30147139339        1
[INPUT] 0    0    [1    /1   ]  1.88726087448        1
[INPUT] 0    0    [1    /1   ]  3.62741406909        1
[INPUT] 1    0    [1    /1   ]  7.13813027251        1
[INPUT] 1    0    [1    /1   ]  23.1610307869        1
[INPUT] 1    0    [1    /1   ]  99.7865902435        1
[INPUT] 1    0    [1    /1   ]  0.267484476534       1
[INPUT] 1    0    [1    /1   ]  2.45504281242        1
[INPUT] 1    0    [1    /1   ]  0.838526606837       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7746062987669229, 1.0]], [0, [24413.794183670674, 1.0]], [0, [3661.4517144570304, 1.0]], [0, [833.3167940609671, 1.0]], [0, [235.46892887117326, 1.0]], [0, [75.87813710640651, 1.0]], [0, [10.911095483071005, 1.0]], [0, [27.747632459521405, 1.0]], [0, [0.3014713933901248, 1.0]], [0, [1.8872608744827217, 1.0]], [0, [3.6274140690931818, 1.0]], [1, [7.13813027251331, 1.0]], [1, [23.161030786856227, 1.0]], [1, [99.78659024352912, 1.0]], [1, [0.2674844765336056, 1.0]], [1, [2.455042812424394, 1.0]], [1, [0.8385266068370606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7746063]
bas 1, expnt(s) = [24413.79418367]
bas 2, expnt(s) = [3661.45171446]
bas 3, expnt(s) = [833.31679406]
bas 4, expnt(s) = [235.46892887]
bas 5, expnt(s) = [75.87813711]
bas 6, expnt(s) = [10.91109548]
bas 7, expnt(s) = [27.74763246]
bas 8, expnt(s) = [0.30147139]
bas 9, expnt(s) = [1.88726087]
bas 10, expnt(s) = [3.62741407]
bas 11, expnt(s) = [7.13813027]
bas 12, expnt(s) = [23.16103079]
bas 13, expnt(s) = [99.78659024]
bas 14, expnt(s) = [0.26748448]
bas 15, expnt(s) = [2.45504281]
bas 16, expnt(s) = [0.83852661]
CPU time:       205.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.74606299e-01 2.08605518e+00 2.44137942e+04 4.93448103e+03
 3.66145171e+03 1.18920029e+03 8.33316794e+02 3.91852503e+02
 2.35468929e+02 1.51867635e+02 7.58781371e+01 6.49534942e+01
 1.09110955e+01 1.51675799e+01 2.77476325e+01 3.05446023e+01
 3.01471393e-01 1.02789702e+00 1.88726087e+00 4.06807524e+00
 3.62741407e+00 6.64068491e+00 7.13813027e+00 3.40380741e+01
 2.31610308e+01 1.48228511e+02 9.97865902e+01 9.20077946e+02
 2.67484477e-01 5.61187025e-01 2.45504281e+00 8.96516382e+00
 8.38526607e-01 2.34088701e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999628718316524
cond(S) = 1397.0205014275423
E1 = -183.59040125724502  E_coul = 55.08019251243752
init E= -128.510208744807
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400035239773  LUMO = 0.771314158236445
  mo_energy =
[-3.25551654e+01 -1.85274268e+00 -7.75400035e-01 -7.75400035e-01
 -7.75400035e-01  7.71314158e-01  8.29358872e-01  8.29358872e-01
  8.29358872e-01  3.98081685e+00  3.98081685e+00  3.98081685e+00
  4.12408677e+00  1.37431899e+01  1.44356509e+01  1.44356509e+01
  1.44356509e+01  4.53414282e+01  5.31295262e+01  5.31295262e+01
  5.31295262e+01  1.51776099e+02  2.40925233e+02  2.40925233e+02
  2.40925233e+02  5.15033183e+02  1.88069007e+03  8.00887534e+03
  4.77750233e+04]
E1 = -182.08721472703263  E_coul = 53.54888775125399
cycle= 1 E= -128.538326975779  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519703
diis-c [-0.27009168  1.        ]
  HOMO = -0.884229881658702  LUMO = 0.743435697141334
  mo_energy =
[-3.28781471e+01 -1.96653532e+00 -8.84229882e-01 -8.84229882e-01
 -8.84229882e-01  7.43435697e-01  8.02393554e-01  8.02393554e-01
  8.02393554e-01  3.88301587e+00  3.88301587e+00  3.88301587e+00
  4.04595635e+00  1.35883261e+01  1.42447167e+01  1.42447167e+01
  1.42447167e+01  4.50914126e+01  5.28487803e+01  5.28487803e+01
  5.28487803e+01  1.51459392e+02  2.40579143e+02  2.40579143e+02
  2.40579143e+02  5.14672364e+02  1.88029281e+03  8.00844891e+03
  4.77745780e+04]
E1 = -182.8479920568769  E_coul = 54.30708020413671
cycle= 2 E= -128.54091185274  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264025
diis-c [-0.00068937  0.33605915  0.66394085]
  HOMO = -0.848632428398993  LUMO = 0.752361600148579
  mo_energy =
[-3.27701271e+01 -1.92905276e+00 -8.48632428e-01 -8.48632428e-01
 -8.48632428e-01  7.52361600e-01  8.11186549e-01  8.11186549e-01
  8.11186549e-01  3.91474614e+00  3.91474614e+00  3.91474614e+00
  4.07122908e+00  1.36392956e+01  1.43079626e+01  1.43079626e+01
  1.43079626e+01  4.51751460e+01  5.29427233e+01  5.29427233e+01
  5.29427233e+01  1.51565028e+02  2.40692727e+02  2.40692727e+02
  2.40692727e+02  5.14788943e+02  1.88041476e+03  8.00857334e+03
  4.77747033e+04]
E1 = -182.58962470053805  E_coul = 54.047794470619046
cycle= 3 E= -128.541830229919  delta_E= -0.000918  |g|= 0.000517  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115018
diis-c [-2.03171433e-07 -2.37002721e-03 -6.53671459e-04  1.00302370e+00]
  HOMO = -0.848891464108267  LUMO = 0.752310808007862
  mo_energy =
[-3.27705890e+01 -1.92924653e+00 -8.48891464e-01 -8.48891464e-01
 -8.48891464e-01  7.52310808e-01  8.11145857e-01  8.11145857e-01
  8.11145857e-01  3.91456629e+00  3.91456629e+00  3.91456629e+00
  4.07108922e+00  1.36390381e+01  1.43076539e+01  1.43076539e+01
  1.43076539e+01  4.51747808e+01  5.29423156e+01  5.29423156e+01
  5.29423156e+01  1.51564563e+02  2.40692194e+02  2.40692194e+02
  2.40692194e+02  5.14788353e+02  1.88041403e+03  8.00857251e+03
  4.77747024e+04]
E1 = -182.59008134769311  E_coul = 54.04825109113505
cycle= 4 E= -128.541830256558  delta_E= -2.66e-08  |g|= 8.02e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186186
diis-c [-1.12800381e-09  2.43676954e-04  4.90274063e-04 -1.87728660e-01
  1.18699471e+00]
  HOMO = -0.84893455193292  LUMO = 0.752298342553451
  mo_energy =
[-3.27706619e+01 -1.92927876e+00 -8.48934552e-01 -8.48934552e-01
 -8.48934552e-01  7.52298343e-01  8.11132363e-01  8.11132363e-01
  8.11132363e-01  3.91452609e+00  3.91452609e+00  3.91452609e+00
  4.07105876e+00  1.36389866e+01  1.43075945e+01  1.43075945e+01
  1.43075945e+01  4.51747154e+01  5.29422467e+01  5.29422467e+01
  5.29422467e+01  1.51564490e+02  2.40692116e+02  2.40692116e+02
  2.40692116e+02  5.14788271e+02  1.88041394e+03  8.00857242e+03
  4.77747023e+04]
E1 = -182.5902135633289  E_coul = 54.04838330604345
cycle= 5 E= -128.541830257285  delta_E= -7.27e-10  |g|= 6.06e-06  |ddm|= 6.28e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5902135633289  E_coul = 54.04838330604345
  HOMO = -0.848931344426518  LUMO = 0.7522996515035
  mo_energy =
[-3.27706547e+01 -1.92927475e+00 -8.48931344e-01 -8.48931344e-01
 -8.48931344e-01  7.52299652e-01  8.11133313e-01  8.11133313e-01
  8.11133313e-01  3.91452917e+00  3.91452917e+00  3.91452917e+00
  4.07106162e+00  1.36389914e+01  1.43075998e+01  1.43075998e+01
  1.43075998e+01  4.51747218e+01  5.29422535e+01  5.29422535e+01
  5.29422535e+01  1.51564497e+02  2.40692123e+02  2.40692123e+02
  2.40692123e+02  5.14788278e+02  1.88041395e+03  8.00857242e+03
  4.77747023e+04]
E1 = -182.59019725417187  E_coul = 54.048366996883644
Extra cycle  E= -128.541830257288  delta_E= -2.79e-12  |g|= 2.29e-06  |ddm|= 2.2e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.74606299e-01 2.44137942e+04 3.66145171e+03 8.33316794e+02
 2.35468929e+02 7.58781371e+01 1.09110955e+01 2.77476325e+01
 3.01471393e-01 1.88726087e+00 3.62741407e+00 7.13813027e+00
 2.31610308e+01 9.97865902e+01 2.67484477e-01 2.45504281e+00
 8.38526607e-01]
E = -128.5418302572882
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.774606298767       1
[INPUT] 0    0    [1    /1   ]  24413.7941837        1
[INPUT] 0    0    [1    /1   ]  3661.45171446        1
[INPUT] 0    0    [1    /1   ]  833.316794061        1
[INPUT] 0    0    [1    /1   ]  235.468928871        1
[INPUT] 0    0    [1    /1   ]  75.8781371064        1
[INPUT] 0    0    [1    /1   ]  10.9110954831        1
[INPUT] 0    0    [1    /1   ]  27.7476324595        1
[INPUT] 0    0    [1    /1   ]  0.30147139339        1
[INPUT] 0    0    [1    /1   ]  1.88726087448        1
[INPUT] 0    0    [1    /1   ]  3.62741406909        1
[INPUT] 1    0    [1    /1   ]  7.13813027251        1
[INPUT] 1    0    [1    /1   ]  23.1610307869        1
[INPUT] 1    0    [1    /1   ]  99.7865902435        1
[INPUT] 1    0    [1    /1   ]  0.267484476534       1
[INPUT] 1    0    [1    /1   ]  2.45504281242        1
[INPUT] 1    0    [1    /1   ]  0.838526606837       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7746062987669229, 1.0]], [0, [24413.794183670674, 1.0]], [0, [3661.4517144570304, 1.0]], [0, [833.3167940609671, 1.0]], [0, [235.46892887117326, 1.0]], [0, [75.87813710640651, 1.0]], [0, [10.911095483071005, 1.0]], [0, [27.747632459521405, 1.0]], [0, [0.3014713933901248, 1.0]], [0, [1.8872608744827217, 1.0]], [0, [3.6274140690931818, 1.0]], [1, [7.13813027251331, 1.0]], [1, [23.161030786856227, 1.0]], [1, [99.78659024352912, 1.0]], [1, [0.2674844765336056, 1.0]], [1, [2.455042812424394, 1.0]], [1, [0.8385266068370606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7746063]
bas 1, expnt(s) = [24413.79418367]
bas 2, expnt(s) = [3661.45171446]
bas 3, expnt(s) = [833.31679406]
bas 4, expnt(s) = [235.46892887]
bas 5, expnt(s) = [75.87813711]
bas 6, expnt(s) = [10.91109548]
bas 7, expnt(s) = [27.74763246]
bas 8, expnt(s) = [0.30147139]
bas 9, expnt(s) = [1.88726087]
bas 10, expnt(s) = [3.62741407]
bas 11, expnt(s) = [7.13813027]
bas 12, expnt(s) = [23.16103079]
bas 13, expnt(s) = [99.78659024]
bas 14, expnt(s) = [0.26748448]
bas 15, expnt(s) = [2.45504281]
bas 16, expnt(s) = [0.83852661]
CPU time:       206.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.74606299e-01 2.08605518e+00 2.44137942e+04 4.93448103e+03
 3.66145171e+03 1.18920029e+03 8.33316794e+02 3.91852503e+02
 2.35468929e+02 1.51867635e+02 7.58781371e+01 6.49534942e+01
 1.09110955e+01 1.51675799e+01 2.77476325e+01 3.05446023e+01
 3.01471393e-01 1.02789702e+00 1.88726087e+00 4.06807524e+00
 3.62741407e+00 6.64068491e+00 7.13813027e+00 3.40380741e+01
 2.31610308e+01 1.48228511e+02 9.97865902e+01 9.20077946e+02
 2.67484477e-01 5.61187025e-01 2.45504281e+00 8.96516382e+00
 8.38526607e-01 2.34088701e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999628718316524
cond(S) = 1397.0205014275423
E1 = -183.59040125724502  E_coul = 55.08019251243752
init E= -128.510208744807
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400035239773  LUMO = 0.771314158236445
  mo_energy =
[-3.25551654e+01 -1.85274268e+00 -7.75400035e-01 -7.75400035e-01
 -7.75400035e-01  7.71314158e-01  8.29358872e-01  8.29358872e-01
  8.29358872e-01  3.98081685e+00  3.98081685e+00  3.98081685e+00
  4.12408677e+00  1.37431899e+01  1.44356509e+01  1.44356509e+01
  1.44356509e+01  4.53414282e+01  5.31295262e+01  5.31295262e+01
  5.31295262e+01  1.51776099e+02  2.40925233e+02  2.40925233e+02
  2.40925233e+02  5.15033183e+02  1.88069007e+03  8.00887534e+03
  4.77750233e+04]
E1 = -182.08721472703263  E_coul = 53.54888775125399
cycle= 1 E= -128.538326975779  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519703
diis-c [-0.27009168  1.        ]
  HOMO = -0.884229881658702  LUMO = 0.743435697141334
  mo_energy =
[-3.28781471e+01 -1.96653532e+00 -8.84229882e-01 -8.84229882e-01
 -8.84229882e-01  7.43435697e-01  8.02393554e-01  8.02393554e-01
  8.02393554e-01  3.88301587e+00  3.88301587e+00  3.88301587e+00
  4.04595635e+00  1.35883261e+01  1.42447167e+01  1.42447167e+01
  1.42447167e+01  4.50914126e+01  5.28487803e+01  5.28487803e+01
  5.28487803e+01  1.51459392e+02  2.40579143e+02  2.40579143e+02
  2.40579143e+02  5.14672364e+02  1.88029281e+03  8.00844891e+03
  4.77745780e+04]
E1 = -182.8479920568769  E_coul = 54.30708020413671
cycle= 2 E= -128.54091185274  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264025
diis-c [-0.00068937  0.33605915  0.66394085]
  HOMO = -0.848632428398993  LUMO = 0.752361600148579
  mo_energy =
[-3.27701271e+01 -1.92905276e+00 -8.48632428e-01 -8.48632428e-01
 -8.48632428e-01  7.52361600e-01  8.11186549e-01  8.11186549e-01
  8.11186549e-01  3.91474614e+00  3.91474614e+00  3.91474614e+00
  4.07122908e+00  1.36392956e+01  1.43079626e+01  1.43079626e+01
  1.43079626e+01  4.51751460e+01  5.29427233e+01  5.29427233e+01
  5.29427233e+01  1.51565028e+02  2.40692727e+02  2.40692727e+02
  2.40692727e+02  5.14788943e+02  1.88041476e+03  8.00857334e+03
  4.77747033e+04]
E1 = -182.58962470053805  E_coul = 54.047794470619046
cycle= 3 E= -128.541830229919  delta_E= -0.000918  |g|= 0.000517  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115018
diis-c [-2.03171433e-07 -2.37002721e-03 -6.53671459e-04  1.00302370e+00]
  HOMO = -0.848891464108267  LUMO = 0.752310808007862
  mo_energy =
[-3.27705890e+01 -1.92924653e+00 -8.48891464e-01 -8.48891464e-01
 -8.48891464e-01  7.52310808e-01  8.11145857e-01  8.11145857e-01
  8.11145857e-01  3.91456629e+00  3.91456629e+00  3.91456629e+00
  4.07108922e+00  1.36390381e+01  1.43076539e+01  1.43076539e+01
  1.43076539e+01  4.51747808e+01  5.29423156e+01  5.29423156e+01
  5.29423156e+01  1.51564563e+02  2.40692194e+02  2.40692194e+02
  2.40692194e+02  5.14788353e+02  1.88041403e+03  8.00857251e+03
  4.77747024e+04]
E1 = -182.59008134769311  E_coul = 54.04825109113505
cycle= 4 E= -128.541830256558  delta_E= -2.66e-08  |g|= 8.02e-05  |ddm|= 0.000371
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186186
diis-c [-1.12800381e-09  2.43676954e-04  4.90274063e-04 -1.87728660e-01
  1.18699471e+00]
  HOMO = -0.84893455193292  LUMO = 0.752298342553451
  mo_energy =
[-3.27706619e+01 -1.92927876e+00 -8.48934552e-01 -8.48934552e-01
 -8.48934552e-01  7.52298343e-01  8.11132363e-01  8.11132363e-01
  8.11132363e-01  3.91452609e+00  3.91452609e+00  3.91452609e+00
  4.07105876e+00  1.36389866e+01  1.43075945e+01  1.43075945e+01
  1.43075945e+01  4.51747154e+01  5.29422467e+01  5.29422467e+01
  5.29422467e+01  1.51564490e+02  2.40692116e+02  2.40692116e+02
  2.40692116e+02  5.14788271e+02  1.88041394e+03  8.00857242e+03
  4.77747023e+04]
E1 = -182.5902135633289  E_coul = 54.04838330604345
cycle= 5 E= -128.541830257285  delta_E= -7.27e-10  |g|= 6.06e-06  |ddm|= 6.28e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5902135633289  E_coul = 54.04838330604345
  HOMO = -0.848931344426518  LUMO = 0.7522996515035
  mo_energy =
[-3.27706547e+01 -1.92927475e+00 -8.48931344e-01 -8.48931344e-01
 -8.48931344e-01  7.52299652e-01  8.11133313e-01  8.11133313e-01
  8.11133313e-01  3.91452917e+00  3.91452917e+00  3.91452917e+00
  4.07106162e+00  1.36389914e+01  1.43075998e+01  1.43075998e+01
  1.43075998e+01  4.51747218e+01  5.29422535e+01  5.29422535e+01
  5.29422535e+01  1.51564497e+02  2.40692123e+02  2.40692123e+02
  2.40692123e+02  5.14788278e+02  1.88041395e+03  8.00857242e+03
  4.77747023e+04]
E1 = -182.59019725417187  E_coul = 54.048366996883644
Extra cycle  E= -128.541830257288  delta_E= -2.79e-12  |g|= 2.29e-06  |ddm|= 2.2e-06
    CPU time for scf_cycle      0.16 sec, wall time      0.16 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1397.0205014275423
E1 = -182.59019725417187  E_coul = 54.048366996883644
init E= -128.541830257288
    CPU time for initialize scf      0.37 sec, wall time      0.37 sec
  HOMO = -0.848932496965866  LUMO = 0.75229944346743
  mo_energy =
[-3.27706583e+01 -1.92927583e+00 -8.48932497e-01 -8.48932497e-01
 -8.48932497e-01  7.52299443e-01  8.11133047e-01  8.11133047e-01
  8.11133047e-01  3.91452816e+00  3.91452816e+00  3.91452816e+00
  4.07106089e+00  1.36389898e+01  1.43075977e+01  1.43075977e+01
  1.43075977e+01  4.51747190e+01  5.29422504e+01  5.29422504e+01
  5.29422504e+01  1.51564493e+02  2.40692120e+02  2.40692120e+02
  2.40692120e+02  5.14788274e+02  1.88041395e+03  8.00857242e+03
  4.77747023e+04]
E1 = -182.59020631286208  E_coul = 54.048376055573364
cycle= 1 E= -128.541830257289  delta_E= -5.12e-13  |g|= 1.24e-06  |ddm|= 8.2e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.59020631286208  E_coul = 54.048376055573364
  HOMO = -0.848931859072773  LUMO = 0.75229961953805
  mo_energy =
[-3.27706564e+01 -1.92927512e+00 -8.48931859e-01 -8.48931859e-01
 -8.48931859e-01  7.52299620e-01  8.11133208e-01  8.11133208e-01
  8.11133208e-01  3.91452874e+00  3.91452874e+00  3.91452874e+00
  4.07106136e+00  1.36389907e+01  1.43075988e+01  1.43075988e+01
  1.43075988e+01  4.51747205e+01  5.29422521e+01  5.29422521e+01
  5.29422521e+01  1.51564495e+02  2.40692122e+02  2.40692122e+02
  2.40692122e+02  5.14788276e+02  1.88041395e+03  8.00857242e+03
  4.77747023e+04]
E1 = -182.59020176105597  E_coul = 54.048371503767335
Extra cycle  E= -128.541830257289  delta_E= 8.53e-14  |g|= 6.18e-07  |ddm|= 3.98e-07
    CPU time for scf_cycle      0.46 sec, wall time      0.46 sec
exp = [7.74606299e-01 2.44137942e+04 3.66145171e+03 8.33316794e+02
 2.35468929e+02 7.58781371e+01 1.09110955e+01 2.77476325e+01
 3.01471393e-01 1.88726087e+00 3.62741407e+00 7.13813027e+00
 2.31610308e+01 9.97865902e+01 2.67484477e-01 2.45504281e+00
 8.38526607e-01]
grad_E = [ 1.77798343e-04 -2.37932382e-09  1.25300144e-07 -2.42879477e-06
  2.48832940e-05 -1.01562886e-04  9.37282599e-06  5.37793642e-05
 -2.22175827e-04 -4.76820089e-05 -1.11586206e-04  3.76668580e-05
 -2.47305604e-05  1.43352098e-06  1.23487685e-03  1.91182300e-04
 -4.80057615e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.767657479782       1
[INPUT] 0    0    [1    /1   ]  24413.7941839        1
[INPUT] 0    0    [1    /1   ]  3661.45170373        1
[INPUT] 0    0    [1    /1   ]  833.317001322        1
[INPUT] 0    0    [1    /1   ]  235.46684912         1
[INPUT] 0    0    [1    /1   ]  75.8855270943        1
[INPUT] 0    0    [1    /1   ]  10.907258892         1
[INPUT] 0    0    [1    /1   ]  27.7507791051        1
[INPUT] 0    0    [1    /1   ]  0.299126593732       1
[INPUT] 0    0    [1    /1   ]  1.8674311047         1
[INPUT] 0    0    [1    /1   ]  3.64273439533        1
[INPUT] 1    0    [1    /1   ]  7.12933017974        1
[INPUT] 1    0    [1    /1   ]  23.1642458448        1
[INPUT] 1    0    [1    /1   ]  99.7864148675        1
[INPUT] 1    0    [1    /1   ]  0.267672654921       1
[INPUT] 1    0    [1    /1   ]  2.45174377869        1
[INPUT] 1    0    [1    /1   ]  0.83782876254        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7676574797822397, 1.0]], [0, [24413.79418387427, 1.0]], [0, [3661.4517037264513, 1.0]], [0, [833.3170013224996, 1.0]], [0, [235.46684911960926, 1.0]], [0, [75.88552709434904, 1.0]], [0, [10.907258892028484, 1.0]], [0, [27.750779105095397, 1.0]], [0, [0.2991265937320035, 1.0]], [0, [1.8674311047035845, 1.0]], [0, [3.642734395333101, 1.0]], [1, [7.12933017973872, 1.0]], [1, [23.164245844807606, 1.0]], [1, [99.78641486746504, 1.0]], [1, [0.26767265492145303, 1.0]], [1, [2.4517437786943965, 1.0]], [1, [0.83782876253994, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76765748]
bas 1, expnt(s) = [24413.79418387]
bas 2, expnt(s) = [3661.45170373]
bas 3, expnt(s) = [833.31700132]
bas 4, expnt(s) = [235.46684912]
bas 5, expnt(s) = [75.88552709]
bas 6, expnt(s) = [10.90725889]
bas 7, expnt(s) = [27.75077911]
bas 8, expnt(s) = [0.29912659]
bas 9, expnt(s) = [1.8674311]
bas 10, expnt(s) = [3.6427344]
bas 11, expnt(s) = [7.12933018]
bas 12, expnt(s) = [23.16424584]
bas 13, expnt(s) = [99.78641487]
bas 14, expnt(s) = [0.26767265]
bas 15, expnt(s) = [2.45174378]
bas 16, expnt(s) = [0.83782876]
CPU time:       209.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.67657480e-01 2.07200423e+00 2.44137942e+04 4.93448103e+03
 3.66145170e+03 1.18920029e+03 8.33317001e+02 3.91852576e+02
 2.35466849e+02 1.51866629e+02 7.58855271e+01 6.49582387e+01
 1.09072589e+01 1.51635798e+01 2.77507791e+01 3.05472001e+01
 2.99126594e-01 1.02189505e+00 1.86743110e+00 4.03597498e+00
 3.64273440e+00 6.66170894e+00 7.12933018e+00 3.39856283e+01
 2.31642458e+01 1.48254232e+02 9.97864149e+01 9.20075925e+02
 2.67672655e-01 5.61680570e-01 2.45174378e+00 8.95010736e+00
 8.37828763e-01 2.33845208e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629016248122
cond(S) = 1347.4361169334397
E1 = -183.59042472454132  E_coul = 55.08019847825606
init E= -128.510226246285
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775399503757844  LUMO = 0.762957507867473
  mo_energy =
[-3.25551650e+01 -1.85274228e+00 -7.75399504e-01 -7.75399504e-01
 -7.75399504e-01  7.62957508e-01  8.29625975e-01  8.29625975e-01
  8.29625975e-01  3.97800901e+00  3.97800901e+00  3.97800901e+00
  4.08473762e+00  1.36724640e+01  1.44176189e+01  1.44176189e+01
  1.44176189e+01  4.52694786e+01  5.30947449e+01  5.30947449e+01
  5.30947449e+01  1.51719487e+02  2.40898624e+02  2.40898624e+02
  2.40898624e+02  5.14998676e+02  1.88066605e+03  8.00885518e+03
  4.77750068e+04]
E1 = -182.08764054702502  E_coul = 53.54931018738297
cycle= 1 E= -128.538330359642  delta_E= -0.0281  |g|= 0.204  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519681
diis-c [-0.27006812  1.        ]
  HOMO = -0.884194344434898  LUMO = 0.735406162787021
  mo_energy =
[-3.28780856e+01 -1.96649288e+00 -8.84194344e-01 -8.84194344e-01
 -8.84194344e-01  7.35406163e-01  8.02680733e-01  8.02680733e-01
  8.02680733e-01  3.88034173e+00  3.88034173e+00  3.88034173e+00
  4.00706021e+00  1.35177178e+01  1.42268470e+01  1.42268470e+01
  1.42268470e+01  4.50194643e+01  5.28140608e+01  5.28140608e+01
  5.28140608e+01  1.51402819e+02  2.40552589e+02  2.40552589e+02
  2.40552589e+02  5.14637912e+02  1.88026885e+03  8.00842882e+03
  4.77745615e+04]
E1 = -182.84822824047333  E_coul = 54.30731376815693
cycle= 2 E= -128.540914472316  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263996
diis-c [-0.00068904  0.33604435  0.66395565]
  HOMO = -0.84860518633607  LUMO = 0.744231432007136
  mo_energy =
[-3.27700890e+01 -1.92901932e+00 -8.48605186e-01 -8.48605186e-01
 -8.48605186e-01  7.44231432e-01  8.11469486e-01  8.11469486e-01
  8.11469486e-01  3.91203308e+00  3.91203308e+00  3.91203308e+00
  4.03218868e+00  1.35686522e+01  1.42900403e+01  1.42900403e+01
  1.42900403e+01  4.51031989e+01  5.29079823e+01  5.29079823e+01
  5.29079823e+01  1.51508440e+02  2.40666150e+02  2.40666150e+02
  2.40666150e+02  5.14754468e+02  1.88039078e+03  8.00855322e+03
  4.77746868e+04]
E1 = -182.58996114530814  E_coul = 54.04812884676516
cycle= 3 E= -128.541832298543  delta_E= -0.000918  |g|= 0.000514  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00114587
diis-c [-2.05539944e-07 -2.36805613e-03 -6.71947279e-04  1.00304000e+00]
  HOMO = -0.848862615563084  LUMO = 0.744182170360612
  mo_energy =
[-3.27705480e+01 -1.92921081e+00 -8.48862616e-01 -8.48862616e-01
 -8.48862616e-01  7.44182170e-01  8.11429397e-01  8.11429397e-01
  8.11429397e-01  3.91185514e+00  3.91185514e+00  3.91185514e+00
  4.03205121e+00  1.35683971e+01  1.42897341e+01  1.42897341e+01
  1.42897341e+01  4.51028364e+01  5.29075774e+01  5.29075774e+01
  5.29075774e+01  1.51507978e+02  2.40665619e+02  2.40665619e+02
  2.40665619e+02  5.14753881e+02  1.88039006e+03  8.00855240e+03
  4.77746860e+04]
E1 = -182.59041433450903  E_coul = 54.04858200938762
cycle= 4 E= -128.541832325121  delta_E= -2.66e-08  |g|= 8.02e-05  |ddm|= 0.00037
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186211
diis-c [-1.14326320e-09  2.46517088e-04  4.92932466e-04 -1.89320495e-01
  1.18858105e+00]
  HOMO = -0.848905588974874  LUMO = 0.744169964323949
  mo_energy =
[-3.27706208e+01 -1.92924271e+00 -8.48905589e-01 -8.48905589e-01
 -8.48905589e-01  7.44169964e-01  8.11415954e-01  8.11415954e-01
  8.11415954e-01  3.91181512e+00  3.91181512e+00  3.91181512e+00
  4.03202110e+00  1.35683459e+01  1.42896749e+01  1.42896749e+01
  1.42896749e+01  4.51027712e+01  5.29075087e+01  5.29075087e+01
  5.29075087e+01  1.51507905e+02  2.40665542e+02  2.40665542e+02
  2.40665542e+02  5.14753799e+02  1.88038997e+03  8.00855230e+03
  4.77746859e+04]
E1 = -182.59054639687545  E_coul = 54.048714071020946
cycle= 5 E= -128.541832325855  delta_E= -7.33e-10  |g|= 6.13e-06  |ddm|= 6.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59054639687545  E_coul = 54.048714071020946
  HOMO = -0.848902337811448  LUMO = 0.744171275995873
  mo_energy =
[-3.27706135e+01 -1.92923866e+00 -8.48902338e-01 -8.48902338e-01
 -8.48902338e-01  7.44171276e-01  8.11416917e-01  8.11416917e-01
  8.11416917e-01  3.91181824e+00  3.91181824e+00  3.91181824e+00
  4.03202398e+00  1.35683507e+01  1.42896803e+01  1.42896803e+01
  1.42896803e+01  4.51027776e+01  5.29075155e+01  5.29075155e+01
  5.29075155e+01  1.51507912e+02  2.40665549e+02  2.40665549e+02
  2.40665549e+02  5.14753806e+02  1.88038997e+03  8.00855231e+03
  4.77746859e+04]
E1 = -182.59052990194857  E_coul = 54.04869757609108
Extra cycle  E= -128.541832325857  delta_E= -2.98e-12  |g|= 2.32e-06  |ddm|= 2.23e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.67657480e-01 2.44137942e+04 3.66145170e+03 8.33317001e+02
 2.35466849e+02 7.58855271e+01 1.09072589e+01 2.77507791e+01
 2.99126594e-01 1.86743110e+00 3.64273440e+00 7.12933018e+00
 2.31642458e+01 9.97864149e+01 2.67672655e-01 2.45174378e+00
 8.37828763e-01]
E = -128.54183232585748
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.767657479782       1
[INPUT] 0    0    [1    /1   ]  24413.7941839        1
[INPUT] 0    0    [1    /1   ]  3661.45170373        1
[INPUT] 0    0    [1    /1   ]  833.317001322        1
[INPUT] 0    0    [1    /1   ]  235.46684912         1
[INPUT] 0    0    [1    /1   ]  75.8855270943        1
[INPUT] 0    0    [1    /1   ]  10.907258892         1
[INPUT] 0    0    [1    /1   ]  27.7507791051        1
[INPUT] 0    0    [1    /1   ]  0.299126593732       1
[INPUT] 0    0    [1    /1   ]  1.8674311047         1
[INPUT] 0    0    [1    /1   ]  3.64273439533        1
[INPUT] 1    0    [1    /1   ]  7.12933017974        1
[INPUT] 1    0    [1    /1   ]  23.1642458448        1
[INPUT] 1    0    [1    /1   ]  99.7864148675        1
[INPUT] 1    0    [1    /1   ]  0.267672654921       1
[INPUT] 1    0    [1    /1   ]  2.45174377869        1
[INPUT] 1    0    [1    /1   ]  0.83782876254        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7676574797822397, 1.0]], [0, [24413.79418387427, 1.0]], [0, [3661.4517037264513, 1.0]], [0, [833.3170013224996, 1.0]], [0, [235.46684911960926, 1.0]], [0, [75.88552709434904, 1.0]], [0, [10.907258892028484, 1.0]], [0, [27.750779105095397, 1.0]], [0, [0.2991265937320035, 1.0]], [0, [1.8674311047035845, 1.0]], [0, [3.642734395333101, 1.0]], [1, [7.12933017973872, 1.0]], [1, [23.164245844807606, 1.0]], [1, [99.78641486746504, 1.0]], [1, [0.26767265492145303, 1.0]], [1, [2.4517437786943965, 1.0]], [1, [0.83782876253994, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76765748]
bas 1, expnt(s) = [24413.79418387]
bas 2, expnt(s) = [3661.45170373]
bas 3, expnt(s) = [833.31700132]
bas 4, expnt(s) = [235.46684912]
bas 5, expnt(s) = [75.88552709]
bas 6, expnt(s) = [10.90725889]
bas 7, expnt(s) = [27.75077911]
bas 8, expnt(s) = [0.29912659]
bas 9, expnt(s) = [1.8674311]
bas 10, expnt(s) = [3.6427344]
bas 11, expnt(s) = [7.12933018]
bas 12, expnt(s) = [23.16424584]
bas 13, expnt(s) = [99.78641487]
bas 14, expnt(s) = [0.26767265]
bas 15, expnt(s) = [2.45174378]
bas 16, expnt(s) = [0.83782876]
CPU time:       210.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.67657480e-01 2.07200423e+00 2.44137942e+04 4.93448103e+03
 3.66145170e+03 1.18920029e+03 8.33317001e+02 3.91852576e+02
 2.35466849e+02 1.51866629e+02 7.58855271e+01 6.49582387e+01
 1.09072589e+01 1.51635798e+01 2.77507791e+01 3.05472001e+01
 2.99126594e-01 1.02189505e+00 1.86743110e+00 4.03597498e+00
 3.64273440e+00 6.66170894e+00 7.12933018e+00 3.39856283e+01
 2.31642458e+01 1.48254232e+02 9.97864149e+01 9.20075925e+02
 2.67672655e-01 5.61680570e-01 2.45174378e+00 8.95010736e+00
 8.37828763e-01 2.33845208e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999629016248122
cond(S) = 1347.4361169334397
E1 = -183.59042472454132  E_coul = 55.08019847825606
init E= -128.510226246285
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775399503757844  LUMO = 0.762957507867473
  mo_energy =
[-3.25551650e+01 -1.85274228e+00 -7.75399504e-01 -7.75399504e-01
 -7.75399504e-01  7.62957508e-01  8.29625975e-01  8.29625975e-01
  8.29625975e-01  3.97800901e+00  3.97800901e+00  3.97800901e+00
  4.08473762e+00  1.36724640e+01  1.44176189e+01  1.44176189e+01
  1.44176189e+01  4.52694786e+01  5.30947449e+01  5.30947449e+01
  5.30947449e+01  1.51719487e+02  2.40898624e+02  2.40898624e+02
  2.40898624e+02  5.14998676e+02  1.88066605e+03  8.00885518e+03
  4.77750068e+04]
E1 = -182.08764054702502  E_coul = 53.54931018738297
cycle= 1 E= -128.538330359642  delta_E= -0.0281  |g|= 0.204  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519681
diis-c [-0.27006812  1.        ]
  HOMO = -0.884194344434898  LUMO = 0.735406162787021
  mo_energy =
[-3.28780856e+01 -1.96649288e+00 -8.84194344e-01 -8.84194344e-01
 -8.84194344e-01  7.35406163e-01  8.02680733e-01  8.02680733e-01
  8.02680733e-01  3.88034173e+00  3.88034173e+00  3.88034173e+00
  4.00706021e+00  1.35177178e+01  1.42268470e+01  1.42268470e+01
  1.42268470e+01  4.50194643e+01  5.28140608e+01  5.28140608e+01
  5.28140608e+01  1.51402819e+02  2.40552589e+02  2.40552589e+02
  2.40552589e+02  5.14637912e+02  1.88026885e+03  8.00842882e+03
  4.77745615e+04]
E1 = -182.84822824047333  E_coul = 54.30731376815693
cycle= 2 E= -128.540914472316  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263996
diis-c [-0.00068904  0.33604435  0.66395565]
  HOMO = -0.84860518633607  LUMO = 0.744231432007136
  mo_energy =
[-3.27700890e+01 -1.92901932e+00 -8.48605186e-01 -8.48605186e-01
 -8.48605186e-01  7.44231432e-01  8.11469486e-01  8.11469486e-01
  8.11469486e-01  3.91203308e+00  3.91203308e+00  3.91203308e+00
  4.03218868e+00  1.35686522e+01  1.42900403e+01  1.42900403e+01
  1.42900403e+01  4.51031989e+01  5.29079823e+01  5.29079823e+01
  5.29079823e+01  1.51508440e+02  2.40666150e+02  2.40666150e+02
  2.40666150e+02  5.14754468e+02  1.88039078e+03  8.00855322e+03
  4.77746868e+04]
E1 = -182.58996114530814  E_coul = 54.04812884676516
cycle= 3 E= -128.541832298543  delta_E= -0.000918  |g|= 0.000514  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00114587
diis-c [-2.05539944e-07 -2.36805613e-03 -6.71947279e-04  1.00304000e+00]
  HOMO = -0.848862615563084  LUMO = 0.744182170360612
  mo_energy =
[-3.27705480e+01 -1.92921081e+00 -8.48862616e-01 -8.48862616e-01
 -8.48862616e-01  7.44182170e-01  8.11429397e-01  8.11429397e-01
  8.11429397e-01  3.91185514e+00  3.91185514e+00  3.91185514e+00
  4.03205121e+00  1.35683971e+01  1.42897341e+01  1.42897341e+01
  1.42897341e+01  4.51028364e+01  5.29075774e+01  5.29075774e+01
  5.29075774e+01  1.51507978e+02  2.40665619e+02  2.40665619e+02
  2.40665619e+02  5.14753881e+02  1.88039006e+03  8.00855240e+03
  4.77746860e+04]
E1 = -182.59041433450903  E_coul = 54.04858200938762
cycle= 4 E= -128.541832325121  delta_E= -2.66e-08  |g|= 8.02e-05  |ddm|= 0.00037
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186211
diis-c [-1.14326320e-09  2.46517088e-04  4.92932466e-04 -1.89320495e-01
  1.18858105e+00]
  HOMO = -0.848905588974874  LUMO = 0.744169964323949
  mo_energy =
[-3.27706208e+01 -1.92924271e+00 -8.48905589e-01 -8.48905589e-01
 -8.48905589e-01  7.44169964e-01  8.11415954e-01  8.11415954e-01
  8.11415954e-01  3.91181512e+00  3.91181512e+00  3.91181512e+00
  4.03202110e+00  1.35683459e+01  1.42896749e+01  1.42896749e+01
  1.42896749e+01  4.51027712e+01  5.29075087e+01  5.29075087e+01
  5.29075087e+01  1.51507905e+02  2.40665542e+02  2.40665542e+02
  2.40665542e+02  5.14753799e+02  1.88038997e+03  8.00855230e+03
  4.77746859e+04]
E1 = -182.59054639687545  E_coul = 54.048714071020946
cycle= 5 E= -128.541832325855  delta_E= -7.33e-10  |g|= 6.13e-06  |ddm|= 6.28e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59054639687545  E_coul = 54.048714071020946
  HOMO = -0.848902337811448  LUMO = 0.744171275995873
  mo_energy =
[-3.27706135e+01 -1.92923866e+00 -8.48902338e-01 -8.48902338e-01
 -8.48902338e-01  7.44171276e-01  8.11416917e-01  8.11416917e-01
  8.11416917e-01  3.91181824e+00  3.91181824e+00  3.91181824e+00
  4.03202398e+00  1.35683507e+01  1.42896803e+01  1.42896803e+01
  1.42896803e+01  4.51027776e+01  5.29075155e+01  5.29075155e+01
  5.29075155e+01  1.51507912e+02  2.40665549e+02  2.40665549e+02
  2.40665549e+02  5.14753806e+02  1.88038997e+03  8.00855231e+03
  4.77746859e+04]
E1 = -182.59052990194857  E_coul = 54.04869757609108
Extra cycle  E= -128.541832325857  delta_E= -2.98e-12  |g|= 2.32e-06  |ddm|= 2.23e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1347.4361169334397
E1 = -182.59052990194857  E_coul = 54.04869757609108
init E= -128.541832325857
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.848903502894894  LUMO = 0.744171068032097
  mo_energy =
[-3.27706171e+01 -1.92923975e+00 -8.48903503e-01 -8.48903503e-01
 -8.48903503e-01  7.44171068e-01  8.11416648e-01  8.11416648e-01
  8.11416648e-01  3.91181723e+00  3.91181723e+00  3.91181723e+00
  4.03202325e+00  1.35683491e+01  1.42896782e+01  1.42896782e+01
  1.42896782e+01  4.51027749e+01  5.29075124e+01  5.29075124e+01
  5.29075124e+01  1.51507908e+02  2.40665545e+02  2.40665545e+02
  2.40665545e+02  5.14753802e+02  1.88038997e+03  8.00855230e+03
  4.77746859e+04]
E1 = -182.59053906587147  E_coul = 54.04870674001369
cycle= 1 E= -128.541832325858  delta_E= -2.84e-13  |g|= 1.25e-06  |ddm|= 8.29e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59053906587147  E_coul = 54.04870674001369
  HOMO = -0.848902857499553  LUMO = 0.74417124414058
  mo_energy =
[-3.27706152e+01 -1.92923904e+00 -8.48902857e-01 -8.48902857e-01
 -8.48902857e-01  7.44171244e-01  8.11416811e-01  8.11416811e-01
  8.11416811e-01  3.91181781e+00  3.91181781e+00  3.91181781e+00
  4.03202372e+00  1.35683500e+01  1.42896793e+01  1.42896793e+01
  1.42896793e+01  4.51027764e+01  5.29075141e+01  5.29075141e+01
  5.29075141e+01  1.51507910e+02  2.40665547e+02  2.40665547e+02
  2.40665547e+02  5.14753804e+02  1.88038997e+03  8.00855230e+03
  4.77746859e+04]
E1 = -182.5905344620396  E_coul = 54.048702136181376
Extra cycle  E= -128.541832325858  delta_E= -4.83e-13  |g|= 6.25e-07  |ddm|= 4.02e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [7.67657480e-01 2.44137942e+04 3.66145170e+03 8.33317001e+02
 2.35466849e+02 7.58855271e+01 1.09072589e+01 2.77507791e+01
 2.99126594e-01 1.86743110e+00 3.64273440e+00 7.12933018e+00
 2.31642458e+01 9.97864149e+01 2.67672655e-01 2.45174378e+00
 8.37828763e-01]
grad_E = [ 2.82558164e-04 -2.38236188e-09  1.25483802e-07 -2.43453637e-06
  2.50141419e-05 -1.03108027e-04  4.14695912e-07  6.05733611e-05
 -4.00778433e-04 -7.67442509e-05 -1.06804809e-04 -2.76201972e-05
 -1.05960773e-05  7.53309376e-07  2.43924048e-03  3.30905989e-04
 -9.78133977e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.760298113336       1
[INPUT] 0    0    [1    /1   ]  24413.7941843        1
[INPUT] 0    0    [1    /1   ]  3661.45168148        1
[INPUT] 0    0    [1    /1   ]  833.317436475        1
[INPUT] 0    0    [1    /1   ]  235.462472029        1
[INPUT] 0    0    [1    /1   ]  75.899370379         1
[INPUT] 0    0    [1    /1   ]  10.9171035206        1
[INPUT] 0    0    [1    /1   ]  27.7643569191        1
[INPUT] 0    0    [1    /1   ]  0.296381951854       1
[INPUT] 0    0    [1    /1   ]  1.85202176889        1
[INPUT] 0    0    [1    /1   ]  3.68602604307        1
[INPUT] 1    0    [1    /1   ]  7.11075816743        1
[INPUT] 1    0    [1    /1   ]  23.1711242711        1
[INPUT] 1    0    [1    /1   ]  99.7860339775        1
[INPUT] 1    0    [1    /1   ]  0.267571816484       1
[INPUT] 1    0    [1    /1   ]  2.44363532322        1
[INPUT] 1    0    [1    /1   ]  0.835634112524       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.760298113335517, 1.0]], [0, [24413.79418429391, 1.0]], [0, [3661.4516814756594, 1.0]], [0, [833.3174364746242, 1.0]], [0, [235.462472029212, 1.0]], [0, [75.89937037898667, 1.0]], [0, [10.91710352056393, 1.0]], [0, [27.76435691913848, 1.0]], [0, [0.29638195185378324, 1.0]], [0, [1.8520217688899743, 1.0]], [0, [3.686026043065235, 1.0]], [1, [7.110758167432515, 1.0]], [1, [23.17112427113483, 1.0]], [1, [99.78603397747328, 1.0]], [1, [0.2675718164837462, 1.0]], [1, [2.4436353232218986, 1.0]], [1, [0.8356341125243796, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76029811]
bas 1, expnt(s) = [24413.79418429]
bas 2, expnt(s) = [3661.45168148]
bas 3, expnt(s) = [833.31743647]
bas 4, expnt(s) = [235.46247203]
bas 5, expnt(s) = [75.89937038]
bas 6, expnt(s) = [10.91710352]
bas 7, expnt(s) = [27.76435692]
bas 8, expnt(s) = [0.29638195]
bas 9, expnt(s) = [1.85202177]
bas 10, expnt(s) = [3.68602604]
bas 11, expnt(s) = [7.11075817]
bas 12, expnt(s) = [23.17112427]
bas 13, expnt(s) = [99.78603398]
bas 14, expnt(s) = [0.26757182]
bas 15, expnt(s) = [2.44363532]
bas 16, expnt(s) = [0.83563411]
CPU time:       213.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.60298113e-01 2.05708842e+00 2.44137942e+04 4.93448103e+03
 3.66145168e+03 1.18920029e+03 8.33317436e+02 3.91852729e+02
 2.35462472e+02 1.51864512e+02 7.58993704e+01 6.49671259e+01
 1.09171035e+01 1.51738433e+01 2.77643569e+01 3.05584089e+01
 2.96381952e-01 1.01485464e+00 1.85202177e+00 4.01097162e+00
 3.68602604e+00 6.72099889e+00 7.11075817e+00 3.38749980e+01
 2.31711243e+01 1.48309263e+02 9.97860340e+01 9.20071535e+02
 2.67571816e-01 5.61416085e-01 2.44363532e+00 8.91312271e+00
 8.35634113e-01 2.33079777e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999632023042864
cond(S) = 1289.0598212435389
E1 = -183.5904499901729  E_coul = 55.080200641729306
init E= -128.510249348444
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775399391572894  LUMO = 0.754148320094514
  mo_energy =
[-3.25551669e+01 -1.85274197e+00 -7.75399392e-01 -7.75399392e-01
 -7.75399392e-01  7.54148320e-01  8.28611753e-01  8.28611753e-01
  8.28611753e-01  3.96771618e+00  3.96771618e+00  3.96771618e+00
  4.05027309e+00  1.36534863e+01  1.43722962e+01  1.43722962e+01
  1.43722962e+01  4.53371728e+01  5.30140109e+01  5.30140109e+01
  5.30140109e+01  1.51863173e+02  2.40837390e+02  2.40837390e+02
  2.40837390e+02  5.15185819e+02  1.88085267e+03  8.00902219e+03
  4.77751456e+04]
E1 = -182.0879169780141  E_coul = 53.54958179339431
cycle= 1 E= -128.53833518462  delta_E= -0.0281  |g|= 0.204  |ddm|= 0.148
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519686
diis-c [-0.27007337  1.        ]
  HOMO = -0.884169269676116  LUMO = 0.726922168242242
  mo_energy =
[-3.28780573e+01 -1.96646254e+00 -8.84169270e-01 -8.84169270e-01
 -8.84169270e-01  7.26922168e-01  8.01742772e-01  8.01742772e-01
  8.01742772e-01  3.87032002e+00  3.87032002e+00  3.87032002e+00
  3.97284109e+00  1.34984214e+01  1.41817942e+01  1.41817942e+01
  1.41817942e+01  4.50870030e+01  5.27333574e+01  5.27333574e+01
  5.27333574e+01  1.51546512e+02  2.40491369e+02  2.40491369e+02
  2.40491369e+02  5.14825082e+02  1.88045550e+03  8.00859586e+03
  4.77747004e+04]
E1 = -182.84843172792088  E_coul = 54.30751273412708
cycle= 2 E= -128.540918993794  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264002
diis-c [-0.00068963  0.33604687  0.66395313]
  HOMO = -0.848583487055939  LUMO = 0.73564773765618
  mo_energy =
[-3.27700721e+01 -1.92899267e+00 -8.48583487e-01 -8.48583487e-01
 -8.48583487e-01  7.35647738e-01  8.10509587e-01  8.10509587e-01
  8.10509587e-01  3.90192829e+00  3.90192829e+00  3.90192829e+00
  3.99789475e+00  1.35494707e+01  1.42449004e+01  1.42449004e+01
  1.42449004e+01  4.51707947e+01  5.28272697e+01  5.28272697e+01
  5.28272697e+01  1.51652129e+02  2.40604921e+02  2.40604921e+02
  2.40604921e+02  5.14941626e+02  1.88057742e+03  8.00872025e+03
  4.77748257e+04]
E1 = -182.5902243947322  E_coul = 54.0483878589933
cycle= 3 E= -128.541836535739  delta_E= -0.000918  |g|= 0.00051  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0011379
diis-c [-2.07628228e-07 -2.36434753e-03 -7.01858654e-04  1.00306621e+00]
  HOMO = -0.848838692174368  LUMO = 0.735600204681885
  mo_energy =
[-3.27705268e+01 -1.92918124e+00 -8.48838692e-01 -8.48838692e-01
 -8.48838692e-01  7.35600205e-01  8.10470399e-01  8.10470399e-01
  8.10470399e-01  3.90175308e+00  3.90175308e+00  3.90175308e+00
  3.99775988e+00  1.35492184e+01  1.42445978e+01  1.42445978e+01
  1.42445978e+01  4.51704358e+01  5.28268688e+01  5.28268688e+01
  5.28268688e+01  1.51651672e+02  2.40604395e+02  2.40604395e+02
  2.40604395e+02  5.14941044e+02  1.88057670e+03  8.00871943e+03
  4.77748248e+04]
E1 = -182.59067087893789  E_coul = 54.048834316781
cycle= 4 E= -128.541836562157  delta_E= -2.64e-08  |g|= 8e-05  |ddm|= 0.000367
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186072
diis-c [-1.15964823e-09  2.49074948e-04  4.96969456e-04 -1.90955192e-01
  1.19020915e+00]
  HOMO = -0.848881520778881  LUMO = 0.735588263085152
  mo_energy =
[-3.27705993e+01 -1.92921280e+00 -8.48881521e-01 -8.48881521e-01
 -8.48881521e-01  7.35588263e-01  8.10457044e-01  8.10457044e-01
  8.10457044e-01  3.90171332e+00  3.90171332e+00  3.90171332e+00
  3.99773008e+00  1.35491675e+01  1.42445389e+01  1.42445389e+01
  1.42445389e+01  4.51703708e+01  5.28268004e+01  5.28268004e+01
  5.28268004e+01  1.51651599e+02  2.40604318e+02  2.40604318e+02
  2.40604318e+02  5.14940963e+02  1.88057661e+03  8.00871933e+03
  4.77748247e+04]
E1 = -182.59080266404342  E_coul = 54.04896610114741
cycle= 5 E= -128.541836562896  delta_E= -7.39e-10  |g|= 6.19e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59080266404342  E_coul = 54.04896610114741
  HOMO = -0.848878227033604  LUMO = 0.735589575977582
  mo_energy =
[-3.27705918e+01 -1.92920870e+00 -8.48878227e-01 -8.48878227e-01
 -8.48878227e-01  7.35589576e-01  8.10458017e-01  8.10458017e-01
  8.10458017e-01  3.90171647e+00  3.90171647e+00  3.90171647e+00
  3.99773299e+00  1.35491723e+01  1.42445443e+01  1.42445443e+01
  1.42445443e+01  4.51703773e+01  5.28268074e+01  5.28268074e+01
  5.28268074e+01  1.51651606e+02  2.40604325e+02  2.40604325e+02
  2.40604325e+02  5.14940970e+02  1.88057662e+03  8.00871934e+03
  4.77748247e+04]
E1 = -182.59078597953427  E_coul = 54.04894941663581
Extra cycle  E= -128.541836562898  delta_E= -2.47e-12  |g|= 2.35e-06  |ddm|= 2.26e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.16 sec
exp = [7.60298113e-01 2.44137942e+04 3.66145168e+03 8.33317436e+02
 2.35462472e+02 7.58993704e+01 1.09171035e+01 2.77643569e+01
 2.96381952e-01 1.85202177e+00 3.68602604e+00 7.11075817e+00
 2.31711243e+01 9.97860340e+01 2.67571816e-01 2.44363532e+00
 8.35634113e-01]
E = -128.54183656289848
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.760298113336       1
[INPUT] 0    0    [1    /1   ]  24413.7941843        1
[INPUT] 0    0    [1    /1   ]  3661.45168148        1
[INPUT] 0    0    [1    /1   ]  833.317436475        1
[INPUT] 0    0    [1    /1   ]  235.462472029        1
[INPUT] 0    0    [1    /1   ]  75.899370379         1
[INPUT] 0    0    [1    /1   ]  10.9171035206        1
[INPUT] 0    0    [1    /1   ]  27.7643569191        1
[INPUT] 0    0    [1    /1   ]  0.296381951854       1
[INPUT] 0    0    [1    /1   ]  1.85202176889        1
[INPUT] 0    0    [1    /1   ]  3.68602604307        1
[INPUT] 1    0    [1    /1   ]  7.11075816743        1
[INPUT] 1    0    [1    /1   ]  23.1711242711        1
[INPUT] 1    0    [1    /1   ]  99.7860339775        1
[INPUT] 1    0    [1    /1   ]  0.267571816484       1
[INPUT] 1    0    [1    /1   ]  2.44363532322        1
[INPUT] 1    0    [1    /1   ]  0.835634112524       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.760298113335517, 1.0]], [0, [24413.79418429391, 1.0]], [0, [3661.4516814756594, 1.0]], [0, [833.3174364746242, 1.0]], [0, [235.462472029212, 1.0]], [0, [75.89937037898667, 1.0]], [0, [10.91710352056393, 1.0]], [0, [27.76435691913848, 1.0]], [0, [0.29638195185378324, 1.0]], [0, [1.8520217688899743, 1.0]], [0, [3.686026043065235, 1.0]], [1, [7.110758167432515, 1.0]], [1, [23.17112427113483, 1.0]], [1, [99.78603397747328, 1.0]], [1, [0.2675718164837462, 1.0]], [1, [2.4436353232218986, 1.0]], [1, [0.8356341125243796, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76029811]
bas 1, expnt(s) = [24413.79418429]
bas 2, expnt(s) = [3661.45168148]
bas 3, expnt(s) = [833.31743647]
bas 4, expnt(s) = [235.46247203]
bas 5, expnt(s) = [75.89937038]
bas 6, expnt(s) = [10.91710352]
bas 7, expnt(s) = [27.76435692]
bas 8, expnt(s) = [0.29638195]
bas 9, expnt(s) = [1.85202177]
bas 10, expnt(s) = [3.68602604]
bas 11, expnt(s) = [7.11075817]
bas 12, expnt(s) = [23.17112427]
bas 13, expnt(s) = [99.78603398]
bas 14, expnt(s) = [0.26757182]
bas 15, expnt(s) = [2.44363532]
bas 16, expnt(s) = [0.83563411]
CPU time:       214.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.60298113e-01 2.05708842e+00 2.44137942e+04 4.93448103e+03
 3.66145168e+03 1.18920029e+03 8.33317436e+02 3.91852729e+02
 2.35462472e+02 1.51864512e+02 7.58993704e+01 6.49671259e+01
 1.09171035e+01 1.51738433e+01 2.77643569e+01 3.05584089e+01
 2.96381952e-01 1.01485464e+00 1.85202177e+00 4.01097162e+00
 3.68602604e+00 6.72099889e+00 7.11075817e+00 3.38749980e+01
 2.31711243e+01 1.48309263e+02 9.97860340e+01 9.20071535e+02
 2.67571816e-01 5.61416085e-01 2.44363532e+00 8.91312271e+00
 8.35634113e-01 2.33079777e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999632023042864
cond(S) = 1289.0598212435389
E1 = -183.5904499901729  E_coul = 55.080200641729306
init E= -128.510249348444
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775399391572894  LUMO = 0.754148320094514
  mo_energy =
[-3.25551669e+01 -1.85274197e+00 -7.75399392e-01 -7.75399392e-01
 -7.75399392e-01  7.54148320e-01  8.28611753e-01  8.28611753e-01
  8.28611753e-01  3.96771618e+00  3.96771618e+00  3.96771618e+00
  4.05027309e+00  1.36534863e+01  1.43722962e+01  1.43722962e+01
  1.43722962e+01  4.53371728e+01  5.30140109e+01  5.30140109e+01
  5.30140109e+01  1.51863173e+02  2.40837390e+02  2.40837390e+02
  2.40837390e+02  5.15185819e+02  1.88085267e+03  8.00902219e+03
  4.77751456e+04]
E1 = -182.0879169780141  E_coul = 53.54958179339431
cycle= 1 E= -128.53833518462  delta_E= -0.0281  |g|= 0.204  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519686
diis-c [-0.27007337  1.        ]
  HOMO = -0.884169269676116  LUMO = 0.726922168242242
  mo_energy =
[-3.28780573e+01 -1.96646254e+00 -8.84169270e-01 -8.84169270e-01
 -8.84169270e-01  7.26922168e-01  8.01742772e-01  8.01742772e-01
  8.01742772e-01  3.87032002e+00  3.87032002e+00  3.87032002e+00
  3.97284109e+00  1.34984214e+01  1.41817942e+01  1.41817942e+01
  1.41817942e+01  4.50870030e+01  5.27333574e+01  5.27333574e+01
  5.27333574e+01  1.51546512e+02  2.40491369e+02  2.40491369e+02
  2.40491369e+02  5.14825082e+02  1.88045550e+03  8.00859586e+03
  4.77747004e+04]
E1 = -182.84843172792088  E_coul = 54.30751273412708
cycle= 2 E= -128.540918993794  delta_E= -0.00258  |g|= 0.104  |ddm|= 0.0641
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264002
diis-c [-0.00068963  0.33604687  0.66395313]
  HOMO = -0.848583487055939  LUMO = 0.73564773765618
  mo_energy =
[-3.27700721e+01 -1.92899267e+00 -8.48583487e-01 -8.48583487e-01
 -8.48583487e-01  7.35647738e-01  8.10509587e-01  8.10509587e-01
  8.10509587e-01  3.90192829e+00  3.90192829e+00  3.90192829e+00
  3.99789475e+00  1.35494707e+01  1.42449004e+01  1.42449004e+01
  1.42449004e+01  4.51707947e+01  5.28272697e+01  5.28272697e+01
  5.28272697e+01  1.51652129e+02  2.40604921e+02  2.40604921e+02
  2.40604921e+02  5.14941626e+02  1.88057742e+03  8.00872025e+03
  4.77748257e+04]
E1 = -182.5902243947322  E_coul = 54.0483878589933
cycle= 3 E= -128.541836535739  delta_E= -0.000918  |g|= 0.00051  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011379
diis-c [-2.07628228e-07 -2.36434753e-03 -7.01858654e-04  1.00306621e+00]
  HOMO = -0.848838692174368  LUMO = 0.735600204681885
  mo_energy =
[-3.27705268e+01 -1.92918124e+00 -8.48838692e-01 -8.48838692e-01
 -8.48838692e-01  7.35600205e-01  8.10470399e-01  8.10470399e-01
  8.10470399e-01  3.90175308e+00  3.90175308e+00  3.90175308e+00
  3.99775988e+00  1.35492184e+01  1.42445978e+01  1.42445978e+01
  1.42445978e+01  4.51704358e+01  5.28268688e+01  5.28268688e+01
  5.28268688e+01  1.51651672e+02  2.40604395e+02  2.40604395e+02
  2.40604395e+02  5.14941044e+02  1.88057670e+03  8.00871943e+03
  4.77748248e+04]
E1 = -182.59067087893789  E_coul = 54.048834316781
cycle= 4 E= -128.541836562157  delta_E= -2.64e-08  |g|= 8e-05  |ddm|= 0.000367
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186072
diis-c [-1.15964823e-09  2.49074948e-04  4.96969456e-04 -1.90955192e-01
  1.19020915e+00]
  HOMO = -0.848881520778881  LUMO = 0.735588263085152
  mo_energy =
[-3.27705993e+01 -1.92921280e+00 -8.48881521e-01 -8.48881521e-01
 -8.48881521e-01  7.35588263e-01  8.10457044e-01  8.10457044e-01
  8.10457044e-01  3.90171332e+00  3.90171332e+00  3.90171332e+00
  3.99773008e+00  1.35491675e+01  1.42445389e+01  1.42445389e+01
  1.42445389e+01  4.51703708e+01  5.28268004e+01  5.28268004e+01
  5.28268004e+01  1.51651599e+02  2.40604318e+02  2.40604318e+02
  2.40604318e+02  5.14940963e+02  1.88057661e+03  8.00871933e+03
  4.77748247e+04]
E1 = -182.59080266404342  E_coul = 54.04896610114741
cycle= 5 E= -128.541836562896  delta_E= -7.39e-10  |g|= 6.19e-06  |ddm|= 6.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59080266404342  E_coul = 54.04896610114741
  HOMO = -0.848878227033604  LUMO = 0.735589575977582
  mo_energy =
[-3.27705918e+01 -1.92920870e+00 -8.48878227e-01 -8.48878227e-01
 -8.48878227e-01  7.35589576e-01  8.10458017e-01  8.10458017e-01
  8.10458017e-01  3.90171647e+00  3.90171647e+00  3.90171647e+00
  3.99773299e+00  1.35491723e+01  1.42445443e+01  1.42445443e+01
  1.42445443e+01  4.51703773e+01  5.28268074e+01  5.28268074e+01
  5.28268074e+01  1.51651606e+02  2.40604325e+02  2.40604325e+02
  2.40604325e+02  5.14940970e+02  1.88057662e+03  8.00871934e+03
  4.77748247e+04]
E1 = -182.59078597953427  E_coul = 54.04894941663581
Extra cycle  E= -128.541836562898  delta_E= -2.47e-12  |g|= 2.35e-06  |ddm|= 2.26e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1289.0598212435389
E1 = -182.59078597953427  E_coul = 54.04894941663581
init E= -128.541836562898
    CPU time for initialize scf      0.34 sec, wall time      0.34 sec
  HOMO = -0.848879404949909  LUMO = 0.735589367966429
  mo_energy =
[-3.27705956e+01 -1.92920980e+00 -8.48879405e-01 -8.48879405e-01
 -8.48879405e-01  7.35589368e-01  8.10457746e-01  8.10457746e-01
  8.10457746e-01  3.90171545e+00  3.90171545e+00  3.90171545e+00
  3.99773225e+00  1.35491707e+01  1.42445422e+01  1.42445422e+01
  1.42445422e+01  4.51703745e+01  5.28268042e+01  5.28268042e+01
  5.28268042e+01  1.51651603e+02  2.40604321e+02  2.40604321e+02
  2.40604321e+02  5.14940966e+02  1.88057661e+03  8.00871934e+03
  4.77748247e+04]
E1 = -182.5907952500492  E_coul = 54.048958687150126
cycle= 1 E= -128.541836562899  delta_E= -5.97e-13  |g|= 1.27e-06  |ddm|= 8.38e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5907952500492  E_coul = 54.048958687150126
  HOMO = -0.848878751945215  LUMO = 0.73558954407322
  mo_energy =
[-3.27705936e+01 -1.92920909e+00 -8.48878752e-01 -8.48878752e-01
 -8.48878752e-01  7.35589544e-01  8.10457910e-01  8.10457910e-01
  8.10457910e-01  3.90171603e+00  3.90171603e+00  3.90171603e+00
  3.99773273e+00  1.35491717e+01  1.42445434e+01  1.42445434e+01
  1.42445434e+01  4.51703760e+01  5.28268059e+01  5.28268059e+01
  5.28268059e+01  1.51651605e+02  2.40604323e+02  2.40604323e+02
  2.40604323e+02  5.14940968e+02  1.88057662e+03  8.00871934e+03
  4.77748247e+04]
E1 = -182.5907905932733  E_coul = 54.048954030374375
Extra cycle  E= -128.541836562899  delta_E= 1.42e-13  |g|= 6.33e-07  |ddm|= 4.07e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [7.60298113e-01 2.44137942e+04 3.66145168e+03 8.33317436e+02
 2.35462472e+02 7.58993704e+01 1.09171035e+01 2.77643569e+01
 2.96381952e-01 1.85202177e+00 3.68602604e+00 7.11075817e+00
 2.31711243e+01 9.97860340e+01 2.67571816e-01 2.44363532e+00
 8.35634113e-01]
grad_E = [ 3.70641316e-04 -2.37245014e-09  1.24999596e-07 -2.42869680e-06
  2.50465117e-05 -1.04223654e-04 -9.62822943e-06  6.60913232e-05
 -5.63765954e-04 -1.00082998e-04 -9.85748396e-05 -1.30356609e-04
  1.57514206e-05 -5.56399130e-07  3.81390885e-03  4.79989151e-04
 -1.55697999e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.756206249599       1
[INPUT] 0    0    [1    /1   ]  24413.794185         1
[INPUT] 0    0    [1    /1   ]  3661.4516458         1
[INPUT] 0    0    [1    /1   ]  833.318141704        1
[INPUT] 0    0    [1    /1   ]  235.455376734        1
[INPUT] 0    0    [1    /1   ]  75.9190189681        1
[INPUT] 0    0    [1    /1   ]  10.9587912081        1
[INPUT] 0    0    [1    /1   ]  27.7986591171        1
[INPUT] 0    0    [1    /1   ]  0.294467089936       1
[INPUT] 0    0    [1    /1   ]  1.85515227453        1
[INPUT] 0    0    [1    /1   ]  3.77388199443        1
[INPUT] 1    0    [1    /1   ]  7.08051468852        1
[INPUT] 1    0    [1    /1   ]  23.1824771633        1
[INPUT] 1    0    [1    /1   ]  99.7853967324        1
[INPUT] 1    0    [1    /1   ]  0.266681302383       1
[INPUT] 1    0    [1    /1   ]  2.42876511837        1
[INPUT] 1    0    [1    /1   ]  0.831020861089       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7562062495990215, 1.0]], [0, [24413.79418496302, 1.0]], [0, [3661.4516457999357, 1.0]], [0, [833.3181417039503, 1.0]], [0, [235.45537673442362, 1.0]], [0, [75.91901896811079, 1.0]], [0, [10.958791208115082, 1.0]], [0, [27.79865911705871, 1.0]], [0, [0.2944670899355875, 1.0]], [0, [1.8551522745297837, 1.0]], [0, [3.7738819944302433, 1.0]], [1, [7.080514688522993, 1.0]], [1, [23.182477163253964, 1.0]], [1, [99.7853967323522, 1.0]], [1, [0.26668130238251786, 1.0]], [1, [2.4287651183692103, 1.0]], [1, [0.8310208610888985, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.75620625]
bas 1, expnt(s) = [24413.79418496]
bas 2, expnt(s) = [3661.4516458]
bas 3, expnt(s) = [833.3181417]
bas 4, expnt(s) = [235.45537673]
bas 5, expnt(s) = [75.91901897]
bas 6, expnt(s) = [10.95879121]
bas 7, expnt(s) = [27.79865912]
bas 8, expnt(s) = [0.29446709]
bas 9, expnt(s) = [1.85515227]
bas 10, expnt(s) = [3.77388199]
bas 11, expnt(s) = [7.08051469]
bas 12, expnt(s) = [23.18247716]
bas 13, expnt(s) = [99.78539673]
bas 14, expnt(s) = [0.2666813]
bas 15, expnt(s) = [2.42876512]
bas 16, expnt(s) = [0.83102086]
CPU time:       218.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.56206250e-01 2.04877950e+00 2.44137942e+04 4.93448103e+03
 3.66145165e+03 1.18920028e+03 8.33318142e+02 3.91852978e+02
 2.35455377e+02 1.51861080e+02 7.59190190e+01 6.49797393e+01
 1.09587912e+01 1.52172794e+01 2.77986591e+01 3.05867202e+01
 2.94467090e-01 1.00993308e+00 1.85515227e+00 4.01605541e+00
 3.77388199e+00 6.84079004e+00 7.08051469e+00 3.36949974e+01
 2.31824772e+01 1.48400100e+02 9.97853967e+01 9.20064190e+02
 2.66681302e-01 5.59081474e-01 2.42876512e+00 8.84537580e+00
 8.31020861e-01 2.31472446e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640735105988
cond(S) = 1240.4502702853943
E1 = -183.59046017618468  E_coul = 55.080189645816844
init E= -128.510270530368
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775400618309933  LUMO = 0.749653657891231
  mo_energy =
[-3.25551732e+01 -1.85274273e+00 -7.75400618e-01 -7.75400618e-01
 -7.75400618e-01  7.49653658e-01  8.24668707e-01  8.24668707e-01
  8.24668707e-01  3.94462991e+00  3.94462991e+00  3.94462991e+00
  4.04794799e+00  1.37725788e+01  1.42879468e+01  1.42879468e+01
  1.42879468e+01  4.57151987e+01  5.28719156e+01  5.28719156e+01
  5.28719156e+01  1.52433653e+02  2.40730449e+02  2.40730449e+02
  2.40730449e+02  5.15829452e+02  1.88146726e+03  8.00956875e+03
  4.77755993e+04]
E1 = -182.08743353167444  E_coul = 53.54909418824179
cycle= 1 E= -128.538339343433  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519773
diis-c [-0.27016446  1.        ]
  HOMO = -0.884203481933359  LUMO = 0.72254052075317
  mo_energy =
[-3.28781631e+01 -1.96650183e+00 -8.84203482e-01 -8.84203482e-01
 -8.84203482e-01  7.22540521e-01  7.97971836e-01  7.97971836e-01
  7.97971836e-01  3.84765811e+00  3.84765811e+00  3.84765811e+00
  3.97009874e+00  1.36162893e+01  1.40977765e+01  1.40977765e+01
  1.40977765e+01  4.54645309e+01  5.25911619e+01  5.25911619e+01
  5.25911619e+01  1.52116871e+02  2.40384301e+02  2.40384301e+02
  2.40384301e+02  5.15468622e+02  1.88106999e+03  8.00914231e+03
  4.77751539e+04]
E1 = -182.8483170437715  E_coul = 54.30739240419205
cycle= 2 E= -128.540924639579  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264113
diis-c [-0.00069223  0.33610055  0.66389945]
  HOMO = -0.848602147808473  LUMO = 0.731230603012089
  mo_energy =
[-3.27701394e+01 -1.92901519e+00 -8.48602148e-01 -8.48602148e-01
 -8.48602148e-01  7.31230603e-01  8.06684205e-01  8.06684205e-01
  8.06684205e-01  3.87912979e+00  3.87912979e+00  3.87912979e+00
  3.99529322e+00  1.36677606e+01  1.41607759e+01  1.41607759e+01
  1.41607759e+01  4.55484998e+01  5.26851134e+01  5.26851134e+01
  5.26851134e+01  1.52222533e+02  2.40497901e+02  2.40497901e+02
  2.40497901e+02  5.15585203e+02  1.88119195e+03  8.00926675e+03
  4.77752793e+04]
E1 = -182.5899802466039  E_coul = 54.04813721548563
cycle= 3 E= -128.541843031118  delta_E= -0.000918  |g|= 0.000506  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112691
diis-c [-2.07151282e-07 -2.35967901e-03 -7.38370581e-04  1.00309805e+00]
  HOMO = -0.848855581990319  LUMO = 0.731183860500646
  mo_energy =
[-3.27705897e+01 -1.92920189e+00 -8.48855582e-01 -8.48855582e-01
 -8.48855582e-01  7.31183861e-01  8.06645872e-01  8.06645872e-01
  8.06645872e-01  3.87895702e+00  3.87895702e+00  3.87895702e+00
  3.99515929e+00  1.36675094e+01  1.41604768e+01  1.41604768e+01
  1.41604768e+01  4.55481439e+01  5.26847164e+01  5.26847164e+01
  5.26847164e+01  1.52222080e+02  2.40497379e+02  2.40497379e+02
  2.40497379e+02  5.15584626e+02  1.88119123e+03  8.00926593e+03
  4.77752784e+04]
E1 = -182.59041655621465  E_coul = 54.04857349893021
cycle= 4 E= -128.541843057284  delta_E= -2.62e-08  |g|= 7.99e-05  |ddm|= 0.000362
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185654
diis-c [-1.16513054e-09  2.48551297e-04  5.01284699e-04 -1.91254452e-01
  1.19050462e+00]
  HOMO = -0.848898360251806  LUMO = 0.731171970232964
  mo_energy =
[-3.27706620e+01 -1.92923339e+00 -8.48898360e-01 -8.48898360e-01
 -8.48898360e-01  7.31171970e-01  8.06632606e-01  8.06632606e-01
  8.06632606e-01  3.87891743e+00  3.87891743e+00  3.87891743e+00
  3.99512944e+00  1.36674583e+01  1.41604181e+01  1.41604181e+01
  1.41604181e+01  4.55480790e+01  5.26846481e+01  5.26846481e+01
  5.26846481e+01  1.52222007e+02  2.40497302e+02  2.40497302e+02
  2.40497302e+02  5.15584545e+02  1.88119114e+03  8.00926584e+03
  4.77752783e+04]
E1 = -182.59054795516423  E_coul = 54.04870489714125
cycle= 5 E= -128.541843058023  delta_E= -7.39e-10  |g|= 6.19e-06  |ddm|= 6.2e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59054795516423  E_coul = 54.04870489714125
  HOMO = -0.848895063752573  LUMO = 0.731173277487948
  mo_energy =
[-3.27706546e+01 -1.92922929e+00 -8.48895064e-01 -8.48895064e-01
 -8.48895064e-01  7.31173277e-01  8.06633573e-01  8.06633573e-01
  8.06633573e-01  3.87892057e+00  3.87892057e+00  3.87892057e+00
  3.99513236e+00  1.36674632e+01  1.41604235e+01  1.41604235e+01
  1.41604235e+01  4.55480856e+01  5.26846551e+01  5.26846551e+01
  5.26846551e+01  1.52222015e+02  2.40497309e+02  2.40497309e+02
  2.40497309e+02  5.15584552e+02  1.88119115e+03  8.00926584e+03
  4.77752783e+04]
E1 = -182.5905312353606  E_coul = 54.04868817733509
Extra cycle  E= -128.541843058026  delta_E= -2.53e-12  |g|= 2.35e-06  |ddm|= 2.26e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.56206250e-01 2.44137942e+04 3.66145165e+03 8.33318142e+02
 2.35455377e+02 7.59190190e+01 1.09587912e+01 2.77986591e+01
 2.94467090e-01 1.85515227e+00 3.77388199e+00 7.08051469e+00
 2.31824772e+01 9.97853967e+01 2.66681302e-01 2.42876512e+00
 8.31020861e-01]
E = -128.5418430580255
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.756206249599       1
[INPUT] 0    0    [1    /1   ]  24413.794185         1
[INPUT] 0    0    [1    /1   ]  3661.4516458         1
[INPUT] 0    0    [1    /1   ]  833.318141704        1
[INPUT] 0    0    [1    /1   ]  235.455376734        1
[INPUT] 0    0    [1    /1   ]  75.9190189681        1
[INPUT] 0    0    [1    /1   ]  10.9587912081        1
[INPUT] 0    0    [1    /1   ]  27.7986591171        1
[INPUT] 0    0    [1    /1   ]  0.294467089936       1
[INPUT] 0    0    [1    /1   ]  1.85515227453        1
[INPUT] 0    0    [1    /1   ]  3.77388199443        1
[INPUT] 1    0    [1    /1   ]  7.08051468852        1
[INPUT] 1    0    [1    /1   ]  23.1824771633        1
[INPUT] 1    0    [1    /1   ]  99.7853967324        1
[INPUT] 1    0    [1    /1   ]  0.266681302383       1
[INPUT] 1    0    [1    /1   ]  2.42876511837        1
[INPUT] 1    0    [1    /1   ]  0.831020861089       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7562062495990215, 1.0]], [0, [24413.79418496302, 1.0]], [0, [3661.4516457999357, 1.0]], [0, [833.3181417039503, 1.0]], [0, [235.45537673442362, 1.0]], [0, [75.91901896811079, 1.0]], [0, [10.958791208115082, 1.0]], [0, [27.79865911705871, 1.0]], [0, [0.2944670899355875, 1.0]], [0, [1.8551522745297837, 1.0]], [0, [3.7738819944302433, 1.0]], [1, [7.080514688522993, 1.0]], [1, [23.182477163253964, 1.0]], [1, [99.7853967323522, 1.0]], [1, [0.26668130238251786, 1.0]], [1, [2.4287651183692103, 1.0]], [1, [0.8310208610888985, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.75620625]
bas 1, expnt(s) = [24413.79418496]
bas 2, expnt(s) = [3661.4516458]
bas 3, expnt(s) = [833.3181417]
bas 4, expnt(s) = [235.45537673]
bas 5, expnt(s) = [75.91901897]
bas 6, expnt(s) = [10.95879121]
bas 7, expnt(s) = [27.79865912]
bas 8, expnt(s) = [0.29446709]
bas 9, expnt(s) = [1.85515227]
bas 10, expnt(s) = [3.77388199]
bas 11, expnt(s) = [7.08051469]
bas 12, expnt(s) = [23.18247716]
bas 13, expnt(s) = [99.78539673]
bas 14, expnt(s) = [0.2666813]
bas 15, expnt(s) = [2.42876512]
bas 16, expnt(s) = [0.83102086]
CPU time:       219.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.56206250e-01 2.04877950e+00 2.44137942e+04 4.93448103e+03
 3.66145165e+03 1.18920028e+03 8.33318142e+02 3.91852978e+02
 2.35455377e+02 1.51861080e+02 7.59190190e+01 6.49797393e+01
 1.09587912e+01 1.52172794e+01 2.77986591e+01 3.05867202e+01
 2.94467090e-01 1.00993308e+00 1.85515227e+00 4.01605541e+00
 3.77388199e+00 6.84079004e+00 7.08051469e+00 3.36949974e+01
 2.31824772e+01 1.48400100e+02 9.97853967e+01 9.20064190e+02
 2.66681302e-01 5.59081474e-01 2.42876512e+00 8.84537580e+00
 8.31020861e-01 2.31472446e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640735105988
cond(S) = 1240.4502702853943
E1 = -183.59046017618468  E_coul = 55.080189645816844
init E= -128.510270530368
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775400618309933  LUMO = 0.749653657891231
  mo_energy =
[-3.25551732e+01 -1.85274273e+00 -7.75400618e-01 -7.75400618e-01
 -7.75400618e-01  7.49653658e-01  8.24668707e-01  8.24668707e-01
  8.24668707e-01  3.94462991e+00  3.94462991e+00  3.94462991e+00
  4.04794799e+00  1.37725788e+01  1.42879468e+01  1.42879468e+01
  1.42879468e+01  4.57151987e+01  5.28719156e+01  5.28719156e+01
  5.28719156e+01  1.52433653e+02  2.40730449e+02  2.40730449e+02
  2.40730449e+02  5.15829452e+02  1.88146726e+03  8.00956875e+03
  4.77755993e+04]
E1 = -182.08743353167444  E_coul = 53.54909418824179
cycle= 1 E= -128.538339343433  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519773
diis-c [-0.27016446  1.        ]
  HOMO = -0.884203481933359  LUMO = 0.72254052075317
  mo_energy =
[-3.28781631e+01 -1.96650183e+00 -8.84203482e-01 -8.84203482e-01
 -8.84203482e-01  7.22540521e-01  7.97971836e-01  7.97971836e-01
  7.97971836e-01  3.84765811e+00  3.84765811e+00  3.84765811e+00
  3.97009874e+00  1.36162893e+01  1.40977765e+01  1.40977765e+01
  1.40977765e+01  4.54645309e+01  5.25911619e+01  5.25911619e+01
  5.25911619e+01  1.52116871e+02  2.40384301e+02  2.40384301e+02
  2.40384301e+02  5.15468622e+02  1.88106999e+03  8.00914231e+03
  4.77751539e+04]
E1 = -182.8483170437715  E_coul = 54.30739240419205
cycle= 2 E= -128.540924639579  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0642
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264113
diis-c [-0.00069223  0.33610055  0.66389945]
  HOMO = -0.848602147808473  LUMO = 0.731230603012089
  mo_energy =
[-3.27701394e+01 -1.92901519e+00 -8.48602148e-01 -8.48602148e-01
 -8.48602148e-01  7.31230603e-01  8.06684205e-01  8.06684205e-01
  8.06684205e-01  3.87912979e+00  3.87912979e+00  3.87912979e+00
  3.99529322e+00  1.36677606e+01  1.41607759e+01  1.41607759e+01
  1.41607759e+01  4.55484998e+01  5.26851134e+01  5.26851134e+01
  5.26851134e+01  1.52222533e+02  2.40497901e+02  2.40497901e+02
  2.40497901e+02  5.15585203e+02  1.88119195e+03  8.00926675e+03
  4.77752793e+04]
E1 = -182.5899802466039  E_coul = 54.04813721548563
cycle= 3 E= -128.541843031118  delta_E= -0.000918  |g|= 0.000506  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112691
diis-c [-2.07151282e-07 -2.35967901e-03 -7.38370581e-04  1.00309805e+00]
  HOMO = -0.848855581990319  LUMO = 0.731183860500646
  mo_energy =
[-3.27705897e+01 -1.92920189e+00 -8.48855582e-01 -8.48855582e-01
 -8.48855582e-01  7.31183861e-01  8.06645872e-01  8.06645872e-01
  8.06645872e-01  3.87895702e+00  3.87895702e+00  3.87895702e+00
  3.99515929e+00  1.36675094e+01  1.41604768e+01  1.41604768e+01
  1.41604768e+01  4.55481439e+01  5.26847164e+01  5.26847164e+01
  5.26847164e+01  1.52222080e+02  2.40497379e+02  2.40497379e+02
  2.40497379e+02  5.15584626e+02  1.88119123e+03  8.00926593e+03
  4.77752784e+04]
E1 = -182.59041655621465  E_coul = 54.04857349893021
cycle= 4 E= -128.541843057284  delta_E= -2.62e-08  |g|= 7.99e-05  |ddm|= 0.000362
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185654
diis-c [-1.16513054e-09  2.48551297e-04  5.01284699e-04 -1.91254452e-01
  1.19050462e+00]
  HOMO = -0.848898360251806  LUMO = 0.731171970232964
  mo_energy =
[-3.27706620e+01 -1.92923339e+00 -8.48898360e-01 -8.48898360e-01
 -8.48898360e-01  7.31171970e-01  8.06632606e-01  8.06632606e-01
  8.06632606e-01  3.87891743e+00  3.87891743e+00  3.87891743e+00
  3.99512944e+00  1.36674583e+01  1.41604181e+01  1.41604181e+01
  1.41604181e+01  4.55480790e+01  5.26846481e+01  5.26846481e+01
  5.26846481e+01  1.52222007e+02  2.40497302e+02  2.40497302e+02
  2.40497302e+02  5.15584545e+02  1.88119114e+03  8.00926584e+03
  4.77752783e+04]
E1 = -182.59054795516423  E_coul = 54.04870489714125
cycle= 5 E= -128.541843058023  delta_E= -7.39e-10  |g|= 6.19e-06  |ddm|= 6.2e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59054795516423  E_coul = 54.04870489714125
  HOMO = -0.848895063752573  LUMO = 0.731173277487948
  mo_energy =
[-3.27706546e+01 -1.92922929e+00 -8.48895064e-01 -8.48895064e-01
 -8.48895064e-01  7.31173277e-01  8.06633573e-01  8.06633573e-01
  8.06633573e-01  3.87892057e+00  3.87892057e+00  3.87892057e+00
  3.99513236e+00  1.36674632e+01  1.41604235e+01  1.41604235e+01
  1.41604235e+01  4.55480856e+01  5.26846551e+01  5.26846551e+01
  5.26846551e+01  1.52222015e+02  2.40497309e+02  2.40497309e+02
  2.40497309e+02  5.15584552e+02  1.88119115e+03  8.00926584e+03
  4.77752783e+04]
E1 = -182.5905312353606  E_coul = 54.04868817733509
Extra cycle  E= -128.541843058026  delta_E= -2.53e-12  |g|= 2.35e-06  |ddm|= 2.26e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1240.4502702853943
E1 = -182.5905312353606  E_coul = 54.04868817733509
init E= -128.541843058026
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848896244195036  LUMO = 0.731173069795472
  mo_energy =
[-3.27706583e+01 -1.92923039e+00 -8.48896244e-01 -8.48896244e-01
 -8.48896244e-01  7.31173070e-01  8.06633303e-01  8.06633303e-01
  8.06633303e-01  3.87891955e+00  3.87891955e+00  3.87891955e+00
  3.99513161e+00  1.36674615e+01  1.41604214e+01  1.41604214e+01
  1.41604214e+01  4.55480827e+01  5.26846519e+01  5.26846519e+01
  5.26846519e+01  1.52222011e+02  2.40497305e+02  2.40497305e+02
  2.40497305e+02  5.15584548e+02  1.88119115e+03  8.00926584e+03
  4.77752783e+04]
E1 = -182.59054052438245  E_coul = 54.04869746635655
cycle= 1 E= -128.541843058026  delta_E= -3.98e-13  |g|= 1.27e-06  |ddm|= 8.38e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59054052438245  E_coul = 54.04869746635655
  HOMO = -0.848895589849202  LUMO = 0.731173245453239
  mo_energy =
[-3.27706564e+01 -1.92922967e+00 -8.48895590e-01 -8.48895590e-01
 -8.48895590e-01  7.31173245e-01  8.06633467e-01  8.06633467e-01
  8.06633467e-01  3.87892014e+00  3.87892014e+00  3.87892014e+00
  3.99513210e+00  1.36674625e+01  1.41604225e+01  1.41604225e+01
  1.41604225e+01  4.55480843e+01  5.26846536e+01  5.26846536e+01
  5.26846536e+01  1.52222013e+02  2.40497307e+02  2.40497307e+02
  2.40497307e+02  5.15584550e+02  1.88119115e+03  8.00926584e+03
  4.77752783e+04]
E1 = -182.5905358576906  E_coul = 54.04869279966434
Extra cycle  E= -128.541843058026  delta_E= -3.69e-13  |g|= 6.34e-07  |ddm|= 4.08e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.41 sec
exp = [7.56206250e-01 2.44137942e+04 3.66145165e+03 8.33318142e+02
 2.35455377e+02 7.59190190e+01 1.09587912e+01 2.77986591e+01
 2.94467090e-01 1.85515227e+00 3.77388199e+00 7.08051469e+00
 2.31824772e+01 9.97853967e+01 2.66681302e-01 2.42876512e+00
 8.31020861e-01]
grad_E = [ 3.27876587e-04 -2.34506396e-09  1.23603029e-07 -2.40586411e-06
  2.48888935e-05 -1.03766446e-04 -1.30520417e-05  6.42317101e-05
 -5.46701535e-04 -8.35672602e-05 -8.96564353e-05 -2.46733624e-04
  5.38999025e-05 -2.51304456e-06  4.34669387e-03  5.01686232e-04
 -1.79736597e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.759059963822       1
[INPUT] 0    0    [1    /1   ]  24413.7941855        1
[INPUT] 0    0    [1    /1   ]  3661.45161766        1
[INPUT] 0    0    [1    /1   ]  833.318705625        1
[INPUT] 0    0    [1    /1   ]  235.449714618        1
[INPUT] 0    0    [1    /1   ]  75.9314556255        1
[INPUT] 0    0    [1    /1   ]  11.0198774462        1
[INPUT] 0    0    [1    /1   ]  27.8410097286        1
[INPUT] 0    0    [1    /1   ]  0.295472556707       1
[INPUT] 0    0    [1    /1   ]  1.87527955883        1
[INPUT] 0    0    [1    /1   ]  3.86465497764        1
[INPUT] 1    0    [1    /1   ]  7.05635528055        1
[INPUT] 1    0    [1    /1   ]  23.1917378919        1
[INPUT] 1    0    [1    /1   ]  99.7848672056        1
[INPUT] 1    0    [1    /1   ]  0.265102884491       1
[INPUT] 1    0    [1    /1   ]  2.41502332148        1
[INPUT] 1    0    [1    /1   ]  0.826144151782       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7590599638220755, 1.0]], [0, [24413.79418548684, 1.0]], [0, [3661.4516176598945, 1.0]], [0, [833.3187056254437, 1.0]], [0, [235.44971461779048, 1.0]], [0, [75.93145562547667, 1.0]], [0, [11.019877446222848, 1.0]], [0, [27.84100972858112, 1.0]], [0, [0.29547255670660266, 1.0]], [0, [1.8752795588305775, 1.0]], [0, [3.8646549776424797, 1.0]], [1, [7.056355280553936, 1.0]], [1, [23.191737891863273, 1.0]], [1, [99.78486720561287, 1.0]], [1, [0.26510288449130925, 1.0]], [1, [2.4150233214835906, 1.0]], [1, [0.8261441517818924, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.75905996]
bas 1, expnt(s) = [24413.79418549]
bas 2, expnt(s) = [3661.45161766]
bas 3, expnt(s) = [833.31870563]
bas 4, expnt(s) = [235.44971462]
bas 5, expnt(s) = [75.93145563]
bas 6, expnt(s) = [11.01987745]
bas 7, expnt(s) = [27.84100973]
bas 8, expnt(s) = [0.29547256]
bas 9, expnt(s) = [1.87527956]
bas 10, expnt(s) = [3.86465498]
bas 11, expnt(s) = [7.05635528]
bas 12, expnt(s) = [23.19173789]
bas 13, expnt(s) = [99.78486721]
bas 14, expnt(s) = [0.26510288]
bas 15, expnt(s) = [2.41502332]
bas 16, expnt(s) = [0.82614415]
CPU time:       222.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.59059964e-01 2.05457542e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318706e+02 3.91853177e+02
 2.35449715e+02 1.51858341e+02 7.59314556e+01 6.49877227e+01
 1.10198774e+01 1.52808530e+01 2.78410097e+01 3.06216622e+01
 2.95472557e-01 1.01251831e+00 1.87527956e+00 4.04869013e+00
 3.86465498e+00 6.96382855e+00 7.05635528e+00 3.35513455e+01
 2.31917379e+01 1.48474206e+02 9.97848672e+01 9.20058087e+02
 2.65102884e-01 5.54948215e-01 2.41502332e+00 8.78286190e+00
 8.26144152e-01 2.29775745e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999652144665426
cond(S) = 1228.8878157206198
E1 = -183.59043730883747  E_coul = 55.08016708156732
init E= -128.51027022727
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403336062364  LUMO = 0.754736226821461
  mo_energy =
[-3.25551800e+01 -1.85274499e+00 -7.75403336e-01 -7.75403336e-01
 -7.75403336e-01  7.54736227e-01  8.18807297e-01  8.18807297e-01
  8.18807297e-01  3.91883175e+00  3.91883175e+00  3.91883175e+00
  4.08834388e+00  1.39872089e+01  1.42084794e+01  1.42084794e+01
  1.42084794e+01  4.62496835e+01  5.27463559e+01  5.27463559e+01
  5.27463559e+01  1.53201766e+02  2.40636863e+02  2.40636863e+02
  2.40636863e+02  5.16666444e+02  1.88225593e+03  8.01026882e+03
  4.77761801e+04]
E1 = -182.08595316393888  E_coul = 53.5476146284191
cycle= 1 E= -128.53833853552  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519929
diis-c [-0.27032566  1.        ]
  HOMO = -0.88431957661557  LUMO = 0.727347355562748
  mo_energy =
[-3.28784233e+01 -1.96663749e+00 -8.84319577e-01 -8.84319577e-01
 -8.84319577e-01  7.27347356e-01  7.92303792e-01  7.92303792e-01
  7.92303792e-01  3.82217740e+00  3.82217740e+00  3.82217740e+00
  4.00952267e+00  1.38293263e+01  1.40184451e+01  1.40184451e+01
  1.40184451e+01  4.59983303e+01  5.24653467e+01  5.24653467e+01
  5.24653467e+01  1.52884721e+02  2.40290440e+02  2.40290440e+02
  2.40290440e+02  5.16305375e+02  1.88185841e+03  8.00984212e+03
  4.77757345e+04]
E1 = -182.84770408719484  E_coul = 54.30677672103967
cycle= 2 E= -128.540927366155  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0643
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264314
diis-c [-0.00069586  0.33620115  0.66379885]
  HOMO = -0.848681117311719  LUMO = 0.736118129638639
  mo_energy =
[-3.27703013e+01 -1.92911077e+00 -8.48681117e-01 -8.48681117e-01
 -8.48681117e-01  7.36118130e-01  8.00950392e-01  8.00950392e-01
  8.00950392e-01  3.85353896e+00  3.85353896e+00  3.85353896e+00
  4.03503280e+00  1.38813386e+01  1.40814009e+01  1.40814009e+01
  1.40814009e+01  4.60825402e+01  5.25593933e+01  5.25593933e+01
  5.25593933e+01  1.52990482e+02  2.40404147e+02  2.40404147e+02
  2.40404147e+02  5.16422055e+02  1.88198047e+03  8.00996667e+03
  4.77758599e+04]
E1 = -182.5889935088  E_coul = 54.04714551625466
cycle= 3 E= -128.541847992545  delta_E= -0.000921  |g|= 0.000506  |ddm|= 0.0221
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112141
diis-c [-2.02827774e-07 -2.35901923e-03 -7.52945120e-04  1.00311196e+00]
  HOMO = -0.848935623019389  LUMO = 0.736069686765285
  mo_energy =
[-3.27707518e+01 -1.92929962e+00 -8.48935623e-01 -8.48935623e-01
 -8.48935623e-01  7.36069687e-01  8.00911883e-01  8.00911883e-01
  8.00911883e-01  3.85336550e+00  3.85336550e+00  3.85336550e+00
  4.03489605e+00  1.38810842e+01  1.40811011e+01  1.40811011e+01
  1.40811011e+01  4.60821830e+01  5.25589958e+01  5.25589958e+01
  5.25589958e+01  1.52990028e+02  2.40403625e+02  2.40403625e+02
  2.40403625e+02  5.16421477e+02  1.88197976e+03  8.00996585e+03
  4.77758591e+04]
E1 = -182.58942259159085  E_coul = 54.04757457295159
cycle= 4 E= -128.541848018639  delta_E= -2.61e-08  |g|= 8e-05  |ddm|= 0.00036
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185245
diis-c [-1.14494699e-09  2.42671897e-04  5.01755755e-04 -1.88742844e-01
  1.18799842e+00]
  HOMO = -0.848978652081228  LUMO = 0.736057403432154
  mo_energy =
[-3.27708244e+01 -1.92933172e+00 -8.48978652e-01 -8.48978652e-01
 -8.48978652e-01  7.36057403e-01  8.00898597e-01  8.00898597e-01
  8.00898597e-01  3.85332570e+00  3.85332570e+00  3.85332570e+00
  4.03486552e+00  1.38810324e+01  1.40810421e+01  1.40810421e+01
  1.40810421e+01  4.60821176e+01  5.25589271e+01  5.25589271e+01
  5.25589271e+01  1.52989955e+02  2.40403548e+02  2.40403548e+02
  2.40403548e+02  5.16421396e+02  1.88197967e+03  8.00996576e+03
  4.77758590e+04]
E1 = -182.58955374179462  E_coul = 54.047705722424865
cycle= 5 E= -128.54184801937  delta_E= -7.3e-10  |g|= 6.07e-06  |ddm|= 6.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58955374179462  E_coul = 54.047705722424865
  HOMO = -0.848975432186714  LUMO = 0.736058692151479
  mo_energy =
[-3.27708172e+01 -1.92932770e+00 -8.48975432e-01 -8.48975432e-01
 -8.48975432e-01  7.36058692e-01  8.00899533e-01  8.00899533e-01
  8.00899533e-01  3.85332875e+00  3.85332875e+00  3.85332875e+00
  4.03486840e+00  1.38810372e+01  1.40810474e+01  1.40810474e+01
  1.40810474e+01  4.60821240e+01  5.25589339e+01  5.25589339e+01
  5.25589339e+01  1.52989962e+02  2.40403555e+02  2.40403555e+02
  2.40403555e+02  5.16421403e+02  1.88197968e+03  8.00996577e+03
  4.77758590e+04]
E1 = -182.5895373133453  E_coul = 54.0476892939726
Extra cycle  E= -128.541848019373  delta_E= -2.93e-12  |g|= 2.31e-06  |ddm|= 2.21e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.59059964e-01 2.44137942e+04 3.66145162e+03 8.33318706e+02
 2.35449715e+02 7.59314556e+01 1.10198774e+01 2.78410097e+01
 2.95472557e-01 1.87527956e+00 3.86465498e+00 7.05635528e+00
 2.31917379e+01 9.97848672e+01 2.65102884e-01 2.41502332e+00
 8.26144152e-01]
E = -128.54184801937268
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.759059963822       1
[INPUT] 0    0    [1    /1   ]  24413.7941855        1
[INPUT] 0    0    [1    /1   ]  3661.45161766        1
[INPUT] 0    0    [1    /1   ]  833.318705625        1
[INPUT] 0    0    [1    /1   ]  235.449714618        1
[INPUT] 0    0    [1    /1   ]  75.9314556255        1
[INPUT] 0    0    [1    /1   ]  11.0198774462        1
[INPUT] 0    0    [1    /1   ]  27.8410097286        1
[INPUT] 0    0    [1    /1   ]  0.295472556707       1
[INPUT] 0    0    [1    /1   ]  1.87527955883        1
[INPUT] 0    0    [1    /1   ]  3.86465497764        1
[INPUT] 1    0    [1    /1   ]  7.05635528055        1
[INPUT] 1    0    [1    /1   ]  23.1917378919        1
[INPUT] 1    0    [1    /1   ]  99.7848672056        1
[INPUT] 1    0    [1    /1   ]  0.265102884491       1
[INPUT] 1    0    [1    /1   ]  2.41502332148        1
[INPUT] 1    0    [1    /1   ]  0.826144151782       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7590599638220755, 1.0]], [0, [24413.79418548684, 1.0]], [0, [3661.4516176598945, 1.0]], [0, [833.3187056254437, 1.0]], [0, [235.44971461779048, 1.0]], [0, [75.93145562547667, 1.0]], [0, [11.019877446222848, 1.0]], [0, [27.84100972858112, 1.0]], [0, [0.29547255670660266, 1.0]], [0, [1.8752795588305775, 1.0]], [0, [3.8646549776424797, 1.0]], [1, [7.056355280553936, 1.0]], [1, [23.191737891863273, 1.0]], [1, [99.78486720561287, 1.0]], [1, [0.26510288449130925, 1.0]], [1, [2.4150233214835906, 1.0]], [1, [0.8261441517818924, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.75905996]
bas 1, expnt(s) = [24413.79418549]
bas 2, expnt(s) = [3661.45161766]
bas 3, expnt(s) = [833.31870563]
bas 4, expnt(s) = [235.44971462]
bas 5, expnt(s) = [75.93145563]
bas 6, expnt(s) = [11.01987745]
bas 7, expnt(s) = [27.84100973]
bas 8, expnt(s) = [0.29547256]
bas 9, expnt(s) = [1.87527956]
bas 10, expnt(s) = [3.86465498]
bas 11, expnt(s) = [7.05635528]
bas 12, expnt(s) = [23.19173789]
bas 13, expnt(s) = [99.78486721]
bas 14, expnt(s) = [0.26510288]
bas 15, expnt(s) = [2.41502332]
bas 16, expnt(s) = [0.82614415]
CPU time:       223.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.59059964e-01 2.05457542e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318706e+02 3.91853177e+02
 2.35449715e+02 1.51858341e+02 7.59314556e+01 6.49877227e+01
 1.10198774e+01 1.52808530e+01 2.78410097e+01 3.06216622e+01
 2.95472557e-01 1.01251831e+00 1.87527956e+00 4.04869013e+00
 3.86465498e+00 6.96382855e+00 7.05635528e+00 3.35513455e+01
 2.31917379e+01 1.48474206e+02 9.97848672e+01 9.20058087e+02
 2.65102884e-01 5.54948215e-01 2.41502332e+00 8.78286190e+00
 8.26144152e-01 2.29775745e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999652144665426
cond(S) = 1228.8878157206198
E1 = -183.59043730883747  E_coul = 55.08016708156732
init E= -128.51027022727
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403336062364  LUMO = 0.754736226821461
  mo_energy =
[-3.25551800e+01 -1.85274499e+00 -7.75403336e-01 -7.75403336e-01
 -7.75403336e-01  7.54736227e-01  8.18807297e-01  8.18807297e-01
  8.18807297e-01  3.91883175e+00  3.91883175e+00  3.91883175e+00
  4.08834388e+00  1.39872089e+01  1.42084794e+01  1.42084794e+01
  1.42084794e+01  4.62496835e+01  5.27463559e+01  5.27463559e+01
  5.27463559e+01  1.53201766e+02  2.40636863e+02  2.40636863e+02
  2.40636863e+02  5.16666444e+02  1.88225593e+03  8.01026882e+03
  4.77761801e+04]
E1 = -182.08595316393888  E_coul = 53.5476146284191
cycle= 1 E= -128.53833853552  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.148
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519929
diis-c [-0.27032566  1.        ]
  HOMO = -0.88431957661557  LUMO = 0.727347355562748
  mo_energy =
[-3.28784233e+01 -1.96663749e+00 -8.84319577e-01 -8.84319577e-01
 -8.84319577e-01  7.27347356e-01  7.92303792e-01  7.92303792e-01
  7.92303792e-01  3.82217740e+00  3.82217740e+00  3.82217740e+00
  4.00952267e+00  1.38293263e+01  1.40184451e+01  1.40184451e+01
  1.40184451e+01  4.59983303e+01  5.24653467e+01  5.24653467e+01
  5.24653467e+01  1.52884721e+02  2.40290440e+02  2.40290440e+02
  2.40290440e+02  5.16305375e+02  1.88185841e+03  8.00984212e+03
  4.77757345e+04]
E1 = -182.84770408719484  E_coul = 54.30677672103967
cycle= 2 E= -128.540927366155  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0643
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264314
diis-c [-0.00069586  0.33620115  0.66379885]
  HOMO = -0.848681117311719  LUMO = 0.736118129638639
  mo_energy =
[-3.27703013e+01 -1.92911077e+00 -8.48681117e-01 -8.48681117e-01
 -8.48681117e-01  7.36118130e-01  8.00950392e-01  8.00950392e-01
  8.00950392e-01  3.85353896e+00  3.85353896e+00  3.85353896e+00
  4.03503280e+00  1.38813386e+01  1.40814009e+01  1.40814009e+01
  1.40814009e+01  4.60825402e+01  5.25593933e+01  5.25593933e+01
  5.25593933e+01  1.52990482e+02  2.40404147e+02  2.40404147e+02
  2.40404147e+02  5.16422055e+02  1.88198047e+03  8.00996667e+03
  4.77758599e+04]
E1 = -182.5889935088  E_coul = 54.04714551625466
cycle= 3 E= -128.541847992545  delta_E= -0.000921  |g|= 0.000506  |ddm|= 0.0221
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00112141
diis-c [-2.02827774e-07 -2.35901923e-03 -7.52945120e-04  1.00311196e+00]
  HOMO = -0.848935623019389  LUMO = 0.736069686765285
  mo_energy =
[-3.27707518e+01 -1.92929962e+00 -8.48935623e-01 -8.48935623e-01
 -8.48935623e-01  7.36069687e-01  8.00911883e-01  8.00911883e-01
  8.00911883e-01  3.85336550e+00  3.85336550e+00  3.85336550e+00
  4.03489605e+00  1.38810842e+01  1.40811011e+01  1.40811011e+01
  1.40811011e+01  4.60821830e+01  5.25589958e+01  5.25589958e+01
  5.25589958e+01  1.52990028e+02  2.40403625e+02  2.40403625e+02
  2.40403625e+02  5.16421477e+02  1.88197976e+03  8.00996585e+03
  4.77758591e+04]
E1 = -182.58942259159085  E_coul = 54.04757457295159
cycle= 4 E= -128.541848018639  delta_E= -2.61e-08  |g|= 8e-05  |ddm|= 0.00036
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185245
diis-c [-1.14494699e-09  2.42671897e-04  5.01755755e-04 -1.88742844e-01
  1.18799842e+00]
  HOMO = -0.848978652081228  LUMO = 0.736057403432154
  mo_energy =
[-3.27708244e+01 -1.92933172e+00 -8.48978652e-01 -8.48978652e-01
 -8.48978652e-01  7.36057403e-01  8.00898597e-01  8.00898597e-01
  8.00898597e-01  3.85332570e+00  3.85332570e+00  3.85332570e+00
  4.03486552e+00  1.38810324e+01  1.40810421e+01  1.40810421e+01
  1.40810421e+01  4.60821176e+01  5.25589271e+01  5.25589271e+01
  5.25589271e+01  1.52989955e+02  2.40403548e+02  2.40403548e+02
  2.40403548e+02  5.16421396e+02  1.88197967e+03  8.00996576e+03
  4.77758590e+04]
E1 = -182.58955374179462  E_coul = 54.047705722424865
cycle= 5 E= -128.54184801937  delta_E= -7.3e-10  |g|= 6.07e-06  |ddm|= 6.14e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58955374179462  E_coul = 54.047705722424865
  HOMO = -0.848975432186714  LUMO = 0.736058692151479
  mo_energy =
[-3.27708172e+01 -1.92932770e+00 -8.48975432e-01 -8.48975432e-01
 -8.48975432e-01  7.36058692e-01  8.00899533e-01  8.00899533e-01
  8.00899533e-01  3.85332875e+00  3.85332875e+00  3.85332875e+00
  4.03486840e+00  1.38810372e+01  1.40810474e+01  1.40810474e+01
  1.40810474e+01  4.60821240e+01  5.25589339e+01  5.25589339e+01
  5.25589339e+01  1.52989962e+02  2.40403555e+02  2.40403555e+02
  2.40403555e+02  5.16421403e+02  1.88197968e+03  8.00996577e+03
  4.77758590e+04]
E1 = -182.5895373133453  E_coul = 54.0476892939726
Extra cycle  E= -128.541848019373  delta_E= -2.93e-12  |g|= 2.31e-06  |ddm|= 2.21e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1228.8878157206198
E1 = -182.5895373133453  E_coul = 54.0476892939726
init E= -128.541848019373
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.848976593215599  LUMO = 0.736058486190532
  mo_energy =
[-3.27708208e+01 -1.92932878e+00 -8.48976593e-01 -8.48976593e-01
 -8.48976593e-01  7.36058486e-01  8.00899270e-01  8.00899270e-01
  8.00899270e-01  3.85332776e+00  3.85332776e+00  3.85332776e+00
  4.03486766e+00  1.38810355e+01  1.40810453e+01  1.40810453e+01
  1.40810453e+01  4.60821212e+01  5.25589308e+01  5.25589308e+01
  5.25589308e+01  1.52989959e+02  2.40403551e+02  2.40403551e+02
  2.40403551e+02  5.16421399e+02  1.88197967e+03  8.00996576e+03
  4.77758590e+04]
E1 = -182.5895464356812  E_coul = 54.047698416308194
cycle= 1 E= -128.541848019373  delta_E= -3.13e-13  |g|= 1.25e-06  |ddm|= 8.22e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5895464356812  E_coul = 54.047698416308194
  HOMO = -0.84897595073525  LUMO = 0.73605866023458
  mo_energy =
[-3.27708189e+01 -1.92932808e+00 -8.48975951e-01 -8.48975951e-01
 -8.48975951e-01  7.36058660e-01  8.00899429e-01  8.00899429e-01
  8.00899429e-01  3.85332833e+00  3.85332833e+00  3.85332833e+00
  4.03486814e+00  1.38810365e+01  1.40810464e+01  1.40810464e+01
  1.40810464e+01  4.60821228e+01  5.25589325e+01  5.25589325e+01
  5.25589325e+01  1.52989961e+02  2.40403553e+02  2.40403553e+02
  2.40403553e+02  5.16421401e+02  1.88197967e+03  8.00996576e+03
  4.77758590e+04]
E1 = -182.58954185032897  E_coul = 54.047693830955446
Extra cycle  E= -128.541848019374  delta_E= -5.4e-13  |g|= 6.23e-07  |ddm|= 4.02e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [7.59059964e-01 2.44137942e+04 3.66145162e+03 8.33318706e+02
 2.35449715e+02 7.59314556e+01 1.10198774e+01 2.78410097e+01
 2.95472557e-01 1.87527956e+00 3.86465498e+00 7.05635528e+00
 2.31917379e+01 9.97848672e+01 2.65102884e-01 2.41502332e+00
 8.26144152e-01]
grad_E = [ 1.50947024e-04 -2.31756072e-09  1.22174187e-07 -2.37988135e-06
  2.46087882e-05 -1.01334922e-04  2.10674792e-06  5.14862155e-05
 -2.77697780e-04 -3.71647192e-05 -8.76975818e-05 -2.77784829e-04
  7.86171057e-05 -3.87355606e-06  2.76201288e-03  2.54687497e-04
 -1.15459203e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.766734082074       1
[INPUT] 0    0    [1    /1   ]  24413.7941856        1
[INPUT] 0    0    [1    /1   ]  3661.45161251        1
[INPUT] 0    0    [1    /1   ]  833.318815429        1
[INPUT] 0    0    [1    /1   ]  235.448617221        1
[INPUT] 0    0    [1    /1   ]  75.931255996         1
[INPUT] 0    0    [1    /1   ]  11.0549176515        1
[INPUT] 0    0    [1    /1   ]  27.8610502524        1
[INPUT] 0    0    [1    /1   ]  0.298508737511       1
[INPUT] 0    0    [1    /1   ]  1.89636361778        1
[INPUT] 0    0    [1    /1   ]  3.89934878228        1
[INPUT] 1    0    [1    /1   ]  7.05193555482        1
[INPUT] 1    0    [1    /1   ]  23.1936057543        1
[INPUT] 1    0    [1    /1   ]  99.7847520584        1
[INPUT] 1    0    [1    /1   ]  0.264012344605       1
[INPUT] 1    0    [1    /1   ]  2.41080110562        1
[INPUT] 1    0    [1    /1   ]  0.824123276867       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.766734082073847, 1.0]], [0, [24413.794185579347, 1.0]], [0, [3661.4516125103764, 1.0]], [0, [833.3188154286939, 1.0]], [0, [235.44861722055546, 1.0]], [0, [75.9312559960235, 1.0]], [0, [11.054917651493898, 1.0]], [0, [27.861050252418575, 1.0]], [0, [0.29850873751104723, 1.0]], [0, [1.8963636177776124, 1.0]], [0, [3.8993487822819346, 1.0]], [1, [7.051935554816162, 1.0]], [1, [23.19360575426825, 1.0]], [1, [99.78475205842493, 1.0]], [1, [0.2640123446050501, 1.0]], [1, [2.410801105622708, 1.0]], [1, [0.8241232768674382, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76673408]
bas 1, expnt(s) = [24413.79418558]
bas 2, expnt(s) = [3661.45161251]
bas 3, expnt(s) = [833.31881543]
bas 4, expnt(s) = [235.44861722]
bas 5, expnt(s) = [75.931256]
bas 6, expnt(s) = [11.05491765]
bas 7, expnt(s) = [27.86105025]
bas 8, expnt(s) = [0.29850874]
bas 9, expnt(s) = [1.89636362]
bas 10, expnt(s) = [3.89934878]
bas 11, expnt(s) = [7.05193555]
bas 12, expnt(s) = [23.19360575]
bas 13, expnt(s) = [99.78475206]
bas 14, expnt(s) = [0.26401234]
bas 15, expnt(s) = [2.41080111]
bas 16, expnt(s) = [0.82412328]
CPU time:       226.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.66734082e-01 2.07013468e+00 2.44137942e+04 4.93448103e+03
 3.66145161e+03 1.18920027e+03 8.33318815e+02 3.91853216e+02
 2.35448617e+02 1.51857810e+02 7.59312560e+01 6.49875945e+01
 1.10549177e+01 1.53172802e+01 2.78610503e+01 3.06381922e+01
 2.98508738e-01 1.02031157e+00 1.89636362e+00 4.08278241e+00
 3.89934878e+00 7.01066292e+00 7.05193555e+00 3.35250791e+01
 2.31936058e+01 1.48489153e+02 9.97847521e+01 9.20056760e+02
 2.64012345e-01 5.52096107e-01 2.41080111e+00 8.76367211e+00
 8.24123277e-01 2.29073377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999657944189746
cond(S) = 1252.3195808966482
E1 = -183.59040716037728  E_coul = 55.08015255676154
init E= -128.510254603616
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775405428662445  LUMO = 0.765493739042403
  mo_energy =
[-3.25551823e+01 -1.85274666e+00 -7.75405429e-01 -7.75405429e-01
 -7.75405429e-01  7.65493739e-01  8.15216979e-01  8.15216979e-01
  8.15216979e-01  3.90724033e+00  3.90724033e+00  3.90724033e+00
  4.14186914e+00  1.41475201e+01  1.41827109e+01  1.41827109e+01
  1.41827109e+01  4.65690946e+01  5.27122426e+01  5.27122426e+01
  5.27122426e+01  1.53630491e+02  2.40612060e+02  2.40612060e+02
  2.40612060e+02  5.17114489e+02  1.88267171e+03  8.01063705e+03
  4.77764854e+04]
E1 = -182.08472203883798  E_coul = 53.54638628637698
cycle= 1 E= -128.538335752461  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520021
diis-c [-0.27042171  1.        ]
  HOMO = -0.884419190748595  LUMO = 0.737654626345945
  mo_energy =
[-3.28786239e+01 -1.96675448e+00 -8.84419191e-01 -8.84419191e-01
 -8.84419191e-01  7.37654626e-01  7.88802638e-01  7.88802638e-01
  7.88802638e-01  3.81062796e+00  3.81062796e+00  3.81062796e+00
  4.06222284e+00  1.39887829e+01  1.39925853e+01  1.39925853e+01
  1.39925853e+01  4.63173732e+01  5.24310328e+01  5.24310328e+01
  5.24310328e+01  1.53313257e+02  2.40265434e+02  2.40265434e+02
  2.40265434e+02  5.16753233e+02  1.88227399e+03  8.01021015e+03
  4.77760396e+04]
E1 = -182.84713865607426  E_coul = 54.30621137120459
cycle= 2 E= -128.54092728487  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0643
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264445
diis-c [-0.00069797  0.33627081  0.66372919]
  HOMO = -0.848752079599811  LUMO = 0.746560895647097
  mo_energy =
[-3.27704244e+01 -1.92919676e+00 -8.48752080e-01 -8.48752080e-01
 -8.48752080e-01  7.46560896e-01  7.97416036e-01  7.97416036e-01
  7.97416036e-01  3.84196764e+00  3.84196764e+00  3.84196764e+00
  4.08799745e+00  1.40410810e+01  1.40555707e+01  1.40555707e+01
  1.40555707e+01  4.64017114e+01  5.25251532e+01  5.25251532e+01
  5.25251532e+01  1.53419090e+02  2.40379224e+02  2.40379224e+02
  2.40379224e+02  5.16869990e+02  1.88239614e+03  8.01033478e+03
  4.77761651e+04]
E1 = -182.58811797064257  E_coul = 54.046268267198045
cycle= 3 E= -128.541849703445  delta_E= -0.000922  |g|= 0.00051  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011238
diis-c [-1.98458846e-07 -2.36189392e-03 -7.40994819e-04  1.00310289e+00]
  HOMO = -0.849009108401448  LUMO = 0.746509852415164
  mo_energy =
[-3.27708784e+01 -1.92938942e+00 -8.49009108e-01 -8.49009108e-01
 -8.49009108e-01  7.46509852e-01  7.97376703e-01  7.97376703e-01
  7.97376703e-01  3.84179159e+00  3.84179159e+00  3.84179159e+00
  4.08785668e+00  1.40408221e+01  1.40552675e+01  1.40552675e+01
  1.40552675e+01  4.64013503e+01  5.25247520e+01  5.25247520e+01
  5.25247520e+01  1.53418633e+02  2.40378699e+02  2.40378699e+02
  2.40378699e+02  5.16869410e+02  1.88239542e+03  8.01033396e+03
  4.77761643e+04]
E1 = -182.58854686957102  E_coul = 54.04669713990072
cycle= 4 E= -128.54184972967  delta_E= -2.62e-08  |g|= 8.03e-05  |ddm|= 0.000362
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185137
diis-c [-1.11778142e-09  2.36422329e-04  4.98942238e-04 -1.85685355e-01
  1.18494999e+00]
  HOMO = -0.849052450066631  LUMO = 0.746497068483651
  mo_energy =
[-3.27709515e+01 -1.92942223e+00 -8.49052450e-01 -8.49052450e-01
 -8.49052450e-01  7.46497068e-01  7.97363332e-01  7.97363332e-01
  7.97363332e-01  3.84175143e+00  3.84175143e+00  3.84175143e+00
  4.08782543e+00  1.40407695e+01  1.40552080e+01  1.40552080e+01
  1.40552080e+01  4.64012843e+01  5.25246829e+01  5.25246829e+01
  5.25246829e+01  1.53418560e+02  2.40378621e+02  2.40378621e+02
  2.40378621e+02  5.16869329e+02  1.88239533e+03  8.01033387e+03
  4.77761642e+04]
E1 = -182.5886780464719  E_coul = 54.04682831607924
cycle= 5 E= -128.541849730393  delta_E= -7.22e-10  |g|= 5.94e-06  |ddm|= 6.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.5886780464719  E_coul = 54.04682831607924
  HOMO = -0.8490493208624  LUMO = 0.746498340373342
  mo_energy =
[-3.27709444e+01 -1.92941831e+00 -8.49049321e-01 -8.49049321e-01
 -8.49049321e-01  7.46498340e-01  7.97364237e-01  7.97364237e-01
  7.97364237e-01  3.84175440e+00  3.84175440e+00  3.84175440e+00
  4.08782826e+00  1.40407742e+01  1.40552131e+01  1.40552131e+01
  1.40552131e+01  4.64012906e+01  5.25246895e+01  5.25246895e+01
  5.25246895e+01  1.53418567e+02  2.40378628e+02  2.40378628e+02
  2.40378628e+02  5.16869335e+02  1.88239534e+03  8.01033387e+03
  4.77761642e+04]
E1 = -182.58866197933918  E_coul = 54.046812248943795
Extra cycle  E= -128.541849730395  delta_E= -2.73e-12  |g|= 2.26e-06  |ddm|= 2.15e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.66734082e-01 2.44137942e+04 3.66145161e+03 8.33318815e+02
 2.35448617e+02 7.59312560e+01 1.10549177e+01 2.78610503e+01
 2.98508738e-01 1.89636362e+00 3.89934878e+00 7.05193555e+00
 2.31936058e+01 9.97847521e+01 2.64012345e-01 2.41080111e+00
 8.24123277e-01]
E = -128.54184973039537
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.766734082074       1
[INPUT] 0    0    [1    /1   ]  24413.7941856        1
[INPUT] 0    0    [1    /1   ]  3661.45161251        1
[INPUT] 0    0    [1    /1   ]  833.318815429        1
[INPUT] 0    0    [1    /1   ]  235.448617221        1
[INPUT] 0    0    [1    /1   ]  75.931255996         1
[INPUT] 0    0    [1    /1   ]  11.0549176515        1
[INPUT] 0    0    [1    /1   ]  27.8610502524        1
[INPUT] 0    0    [1    /1   ]  0.298508737511       1
[INPUT] 0    0    [1    /1   ]  1.89636361778        1
[INPUT] 0    0    [1    /1   ]  3.89934878228        1
[INPUT] 1    0    [1    /1   ]  7.05193555482        1
[INPUT] 1    0    [1    /1   ]  23.1936057543        1
[INPUT] 1    0    [1    /1   ]  99.7847520584        1
[INPUT] 1    0    [1    /1   ]  0.264012344605       1
[INPUT] 1    0    [1    /1   ]  2.41080110562        1
[INPUT] 1    0    [1    /1   ]  0.824123276867       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.766734082073847, 1.0]], [0, [24413.794185579347, 1.0]], [0, [3661.4516125103764, 1.0]], [0, [833.3188154286939, 1.0]], [0, [235.44861722055546, 1.0]], [0, [75.9312559960235, 1.0]], [0, [11.054917651493898, 1.0]], [0, [27.861050252418575, 1.0]], [0, [0.29850873751104723, 1.0]], [0, [1.8963636177776124, 1.0]], [0, [3.8993487822819346, 1.0]], [1, [7.051935554816162, 1.0]], [1, [23.19360575426825, 1.0]], [1, [99.78475205842493, 1.0]], [1, [0.2640123446050501, 1.0]], [1, [2.410801105622708, 1.0]], [1, [0.8241232768674382, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76673408]
bas 1, expnt(s) = [24413.79418558]
bas 2, expnt(s) = [3661.45161251]
bas 3, expnt(s) = [833.31881543]
bas 4, expnt(s) = [235.44861722]
bas 5, expnt(s) = [75.931256]
bas 6, expnt(s) = [11.05491765]
bas 7, expnt(s) = [27.86105025]
bas 8, expnt(s) = [0.29850874]
bas 9, expnt(s) = [1.89636362]
bas 10, expnt(s) = [3.89934878]
bas 11, expnt(s) = [7.05193555]
bas 12, expnt(s) = [23.19360575]
bas 13, expnt(s) = [99.78475206]
bas 14, expnt(s) = [0.26401234]
bas 15, expnt(s) = [2.41080111]
bas 16, expnt(s) = [0.82412328]
CPU time:       227.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.66734082e-01 2.07013468e+00 2.44137942e+04 4.93448103e+03
 3.66145161e+03 1.18920027e+03 8.33318815e+02 3.91853216e+02
 2.35448617e+02 1.51857810e+02 7.59312560e+01 6.49875945e+01
 1.10549177e+01 1.53172802e+01 2.78610503e+01 3.06381922e+01
 2.98508738e-01 1.02031157e+00 1.89636362e+00 4.08278241e+00
 3.89934878e+00 7.01066292e+00 7.05193555e+00 3.35250791e+01
 2.31936058e+01 1.48489153e+02 9.97847521e+01 9.20056760e+02
 2.64012345e-01 5.52096107e-01 2.41080111e+00 8.76367211e+00
 8.24123277e-01 2.29073377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999657944189746
cond(S) = 1252.3195808966482
E1 = -183.59040716037728  E_coul = 55.08015255676154
init E= -128.510254603616
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775405428662445  LUMO = 0.765493739042403
  mo_energy =
[-3.25551823e+01 -1.85274666e+00 -7.75405429e-01 -7.75405429e-01
 -7.75405429e-01  7.65493739e-01  8.15216979e-01  8.15216979e-01
  8.15216979e-01  3.90724033e+00  3.90724033e+00  3.90724033e+00
  4.14186914e+00  1.41475201e+01  1.41827109e+01  1.41827109e+01
  1.41827109e+01  4.65690946e+01  5.27122426e+01  5.27122426e+01
  5.27122426e+01  1.53630491e+02  2.40612060e+02  2.40612060e+02
  2.40612060e+02  5.17114489e+02  1.88267171e+03  8.01063705e+03
  4.77764854e+04]
E1 = -182.08472203883798  E_coul = 53.54638628637698
cycle= 1 E= -128.538335752461  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520021
diis-c [-0.27042171  1.        ]
  HOMO = -0.884419190748595  LUMO = 0.737654626345945
  mo_energy =
[-3.28786239e+01 -1.96675448e+00 -8.84419191e-01 -8.84419191e-01
 -8.84419191e-01  7.37654626e-01  7.88802638e-01  7.88802638e-01
  7.88802638e-01  3.81062796e+00  3.81062796e+00  3.81062796e+00
  4.06222284e+00  1.39887829e+01  1.39925853e+01  1.39925853e+01
  1.39925853e+01  4.63173732e+01  5.24310328e+01  5.24310328e+01
  5.24310328e+01  1.53313257e+02  2.40265434e+02  2.40265434e+02
  2.40265434e+02  5.16753233e+02  1.88227399e+03  8.01021015e+03
  4.77760396e+04]
E1 = -182.84713865607426  E_coul = 54.30621137120459
cycle= 2 E= -128.54092728487  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264445
diis-c [-0.00069797  0.33627081  0.66372919]
  HOMO = -0.848752079599811  LUMO = 0.746560895647097
  mo_energy =
[-3.27704244e+01 -1.92919676e+00 -8.48752080e-01 -8.48752080e-01
 -8.48752080e-01  7.46560896e-01  7.97416036e-01  7.97416036e-01
  7.97416036e-01  3.84196764e+00  3.84196764e+00  3.84196764e+00
  4.08799745e+00  1.40410810e+01  1.40555707e+01  1.40555707e+01
  1.40555707e+01  4.64017114e+01  5.25251532e+01  5.25251532e+01
  5.25251532e+01  1.53419090e+02  2.40379224e+02  2.40379224e+02
  2.40379224e+02  5.16869990e+02  1.88239614e+03  8.01033478e+03
  4.77761651e+04]
E1 = -182.58811797064257  E_coul = 54.046268267198045
cycle= 3 E= -128.541849703445  delta_E= -0.000922  |g|= 0.00051  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011238
diis-c [-1.98458846e-07 -2.36189392e-03 -7.40994819e-04  1.00310289e+00]
  HOMO = -0.849009108401448  LUMO = 0.746509852415164
  mo_energy =
[-3.27708784e+01 -1.92938942e+00 -8.49009108e-01 -8.49009108e-01
 -8.49009108e-01  7.46509852e-01  7.97376703e-01  7.97376703e-01
  7.97376703e-01  3.84179159e+00  3.84179159e+00  3.84179159e+00
  4.08785668e+00  1.40408221e+01  1.40552675e+01  1.40552675e+01
  1.40552675e+01  4.64013503e+01  5.25247520e+01  5.25247520e+01
  5.25247520e+01  1.53418633e+02  2.40378699e+02  2.40378699e+02
  2.40378699e+02  5.16869410e+02  1.88239542e+03  8.01033396e+03
  4.77761643e+04]
E1 = -182.58854686957102  E_coul = 54.04669713990072
cycle= 4 E= -128.54184972967  delta_E= -2.62e-08  |g|= 8.03e-05  |ddm|= 0.000362
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185137
diis-c [-1.11778142e-09  2.36422329e-04  4.98942238e-04 -1.85685355e-01
  1.18494999e+00]
  HOMO = -0.849052450066631  LUMO = 0.746497068483651
  mo_energy =
[-3.27709515e+01 -1.92942223e+00 -8.49052450e-01 -8.49052450e-01
 -8.49052450e-01  7.46497068e-01  7.97363332e-01  7.97363332e-01
  7.97363332e-01  3.84175143e+00  3.84175143e+00  3.84175143e+00
  4.08782543e+00  1.40407695e+01  1.40552080e+01  1.40552080e+01
  1.40552080e+01  4.64012843e+01  5.25246829e+01  5.25246829e+01
  5.25246829e+01  1.53418560e+02  2.40378621e+02  2.40378621e+02
  2.40378621e+02  5.16869329e+02  1.88239533e+03  8.01033387e+03
  4.77761642e+04]
E1 = -182.5886780464719  E_coul = 54.04682831607924
cycle= 5 E= -128.541849730393  delta_E= -7.22e-10  |g|= 5.94e-06  |ddm|= 6.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5886780464719  E_coul = 54.04682831607924
  HOMO = -0.8490493208624  LUMO = 0.746498340373342
  mo_energy =
[-3.27709444e+01 -1.92941831e+00 -8.49049321e-01 -8.49049321e-01
 -8.49049321e-01  7.46498340e-01  7.97364237e-01  7.97364237e-01
  7.97364237e-01  3.84175440e+00  3.84175440e+00  3.84175440e+00
  4.08782826e+00  1.40407742e+01  1.40552131e+01  1.40552131e+01
  1.40552131e+01  4.64012906e+01  5.25246895e+01  5.25246895e+01
  5.25246895e+01  1.53418567e+02  2.40378628e+02  2.40378628e+02
  2.40378628e+02  5.16869335e+02  1.88239534e+03  8.01033387e+03
  4.77761642e+04]
E1 = -182.58866197933918  E_coul = 54.046812248943795
Extra cycle  E= -128.541849730395  delta_E= -2.73e-12  |g|= 2.26e-06  |ddm|= 2.15e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1252.3195808966482
E1 = -182.58866197933918  E_coul = 54.046812248943795
init E= -128.541849730395
    CPU time for initialize scf      0.38 sec, wall time      0.38 sec
  HOMO = -0.84905045763477  LUMO = 0.746498135698236
  mo_energy =
[-3.27709480e+01 -1.92941937e+00 -8.49050458e-01 -8.49050458e-01
 -8.49050458e-01  7.46498136e-01  7.97363980e-01  7.97363980e-01
  7.97363980e-01  3.84175343e+00  3.84175343e+00  3.84175343e+00
  4.08782753e+00  1.40407726e+01  1.40552111e+01  1.40552111e+01
  1.40552111e+01  4.64012879e+01  5.25246865e+01  5.25246865e+01
  5.25246865e+01  1.53418563e+02  2.40378624e+02  2.40378624e+02
  2.40378624e+02  5.16869331e+02  1.88239533e+03  8.01033387e+03
  4.77761642e+04]
E1 = -182.5886708951721  E_coul = 54.04682116477621
cycle= 1 E= -128.541849730396  delta_E= -5.12e-13  |g|= 1.22e-06  |ddm|= 8.03e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5886708951721  E_coul = 54.04682116477621
  HOMO = -0.849049829862414  LUMO = 0.746498308394831
  mo_energy =
[-3.27709461e+01 -1.92941868e+00 -8.49049830e-01 -8.49049830e-01
 -8.49049830e-01  7.46498308e-01  7.97364135e-01  7.97364135e-01
  7.97364135e-01  3.84175398e+00  3.84175398e+00  3.84175398e+00
  4.08782800e+00  1.40407735e+01  1.40552122e+01  1.40552122e+01
  1.40552122e+01  4.64012894e+01  5.25246881e+01  5.25246881e+01
  5.25246881e+01  1.53418565e+02  2.40378626e+02  2.40378626e+02
  2.40378626e+02  5.16869333e+02  1.88239534e+03  8.01033387e+03
  4.77761642e+04]
E1 = -182.58866641134273  E_coul = 54.046816680947046
Extra cycle  E= -128.541849730396  delta_E= 1.99e-13  |g|= 6.09e-07  |ddm|= 3.94e-07
    CPU time for scf_cycle      0.45 sec, wall time      0.44 sec
exp = [7.66734082e-01 2.44137942e+04 3.66145161e+03 8.33318815e+02
 2.35448617e+02 7.59312560e+01 1.10549177e+01 2.78610503e+01
 2.98508738e-01 1.89636362e+00 3.89934878e+00 7.05193555e+00
 2.31936058e+01 9.97847521e+01 2.64012345e-01 2.41080111e+00
 8.24123277e-01]
grad_E = [ 4.43051225e-05 -2.30370093e-09  1.21433173e-07 -2.36446752e-06
  2.43817894e-05 -9.88888349e-05  2.05880185e-05  3.90526863e-05
 -4.12807794e-05 -1.42500880e-05 -9.08325947e-05 -2.25724826e-04
  7.73895163e-05 -3.93066999e-06  6.82637024e-04 -1.85949124e-05
 -3.12749646e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.770058150668       1
[INPUT] 0    0    [1    /1   ]  24413.7941855        1
[INPUT] 0    0    [1    /1   ]  3661.45161625        1
[INPUT] 0    0    [1    /1   ]  833.318744954        1
[INPUT] 0    0    [1    /1   ]  235.449333716        1
[INPUT] 0    0    [1    /1   ]  75.9276959183        1
[INPUT] 0    0    [1    /1   ]  11.0626686412        1
[INPUT] 0    0    [1    /1   ]  27.8651167461        1
[INPUT] 0    0    [1    /1   ]  0.299745160075       1
[INPUT] 0    0    [1    /1   ]  1.90480002541        1
[INPUT] 0    0    [1    /1   ]  3.90028545848        1
[INPUT] 1    0    [1    /1   ]  7.05512795961        1
[INPUT] 1    0    [1    /1   ]  23.1924833933        1
[INPUT] 1    0    [1    /1   ]  99.7848103187        1
[INPUT] 1    0    [1    /1   ]  0.263783037605       1
[INPUT] 1    0    [1    /1   ]  2.41163438426        1
[INPUT] 1    0    [1    /1   ]  0.824126733054       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7700581506676341, 1.0]], [0, [24413.79418550727, 1.0]], [0, [3661.451616254585, 1.0]], [0, [833.3187449539007, 1.0]], [0, [235.4493337163638, 1.0]], [0, [75.9276959183117, 1.0]], [0, [11.062668641223226, 1.0]], [0, [27.86511674610029, 1.0]], [0, [0.29974516007522484, 1.0]], [0, [1.9048000254058217, 1.0]], [0, [3.900285458476715, 1.0]], [1, [7.055127959613081, 1.0]], [1, [23.19248339333467, 1.0]], [1, [99.78481031872688, 1.0]], [1, [0.26378303760489424, 1.0]], [1, [2.4116343842571215, 1.0]], [1, [0.8241267330542823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77005815]
bas 1, expnt(s) = [24413.79418551]
bas 2, expnt(s) = [3661.45161625]
bas 3, expnt(s) = [833.31874495]
bas 4, expnt(s) = [235.44933372]
bas 5, expnt(s) = [75.92769592]
bas 6, expnt(s) = [11.06266864]
bas 7, expnt(s) = [27.86511675]
bas 8, expnt(s) = [0.29974516]
bas 9, expnt(s) = [1.90480003]
bas 10, expnt(s) = [3.90028546]
bas 11, expnt(s) = [7.05512796]
bas 12, expnt(s) = [23.19248339]
bas 13, expnt(s) = [99.78481032]
bas 14, expnt(s) = [0.26378304]
bas 15, expnt(s) = [2.41163438]
bas 16, expnt(s) = [0.82412673]
CPU time:       230.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.70058151e-01 2.07686212e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318745e+02 3.91853191e+02
 2.35449334e+02 1.51858157e+02 7.59276959e+01 6.49853093e+01
 1.10626686e+01 1.53253341e+01 2.78651167e+01 3.06415461e+01
 2.99745160e-01 1.02347952e+00 1.90480003e+00 4.09639724e+00
 3.90028546e+00 7.01192593e+00 7.05512796e+00 3.35440511e+01
 2.31924834e+01 1.48480171e+02 9.97848103e+01 9.20057432e+02
 2.63783038e-01 5.51496771e-01 2.41163438e+00 8.76745866e+00
 8.24126733e-01 2.29074578e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999658511346693
cond(S) = 1266.771447767627
E1 = -183.59039687021337  E_coul = 55.080149006880056
init E= -128.510247863333
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406044267368  LUMO = 0.769823126331039
  mo_energy =
[-3.25551824e+01 -1.85274707e+00 -7.75406044e-01 -7.75406044e-01
 -7.75406044e-01  7.69823126e-01  8.14606919e-01  8.14606919e-01
  8.14606919e-01  3.90680423e+00  3.90680423e+00  3.90680423e+00
  4.16214123e+00  1.41868615e+01  1.41868615e+01  1.41868615e+01
  1.41930001e+01  4.66410773e+01  5.27225123e+01  5.27225123e+01
  5.27225123e+01  1.53719177e+02  2.40620043e+02  2.40620043e+02
  2.40620043e+02  5.17200456e+02  1.88274882e+03  8.01070500e+03
  4.77765417e+04]
E1 = -182.08439440706266  E_coul = 53.546059517599495
cycle= 1 E= -128.538334889463  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520044
diis-c [-0.27044552  1.        ]
  HOMO = -0.884446628684965  LUMO = 0.74181072078451
  mo_energy =
[-3.28786732e+01 -1.96678672e+00 -8.84446629e-01 -8.84446629e-01
 -8.84446629e-01  7.41810721e-01  7.88197174e-01  7.88197174e-01
  7.88197174e-01  3.81014255e+00  3.81014255e+00  3.81014255e+00
  4.08223461e+00  1.39966548e+01  1.39966548e+01  1.39966548e+01
  1.40341005e+01  4.63892919e+01  5.24412523e+01  5.24412523e+01
  5.24412523e+01  1.53401901e+02  2.40273370e+02  2.40273370e+02
  2.40273370e+02  5.16839155e+02  1.88235105e+03  8.01027804e+03
  4.77760958e+04]
E1 = -182.8469745687256  E_coul = 54.30604749193083
cycle= 2 E= -128.540927076795  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264476
diis-c [-0.00069841  0.33628651  0.66371349]
  HOMO = -0.848772461294613  LUMO = 0.750769592833485
  mo_energy =
[-3.27704542e+01 -1.92922135e+00 -8.48772461e-01 -8.48772461e-01
 -8.48772461e-01  7.50769593e-01  7.96807552e-01  7.96807552e-01
  7.96807552e-01  3.84149541e+00  3.84149541e+00  3.84149541e+00
  4.10809213e+00  1.40596665e+01  1.40596665e+01  1.40596665e+01
  1.40864514e+01  4.64736517e+01  5.25353910e+01  5.25353910e+01
  5.25353910e+01  1.53507750e+02  2.40387180e+02  2.40387180e+02
  2.40387180e+02  5.16955932e+02  1.88247322e+03  8.01040270e+03
  4.77762214e+04]
E1 = -182.58787202362092  E_coul = 54.04602206881908
cycle= 3 E= -128.541849954802  delta_E= -0.000923  |g|= 0.000511  |ddm|= 0.0222
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00112594
diis-c [-1.97146776e-07 -2.36362931e-03 -7.33153862e-04  1.00309678e+00]
  HOMO = -0.849030507447201  LUMO = 0.750717589118439
  mo_energy =
[-3.27709099e+01 -1.92941545e+00 -8.49030507e-01 -8.49030507e-01
 -8.49030507e-01  7.50717589e-01  7.96767851e-01  7.96767851e-01
  7.96767851e-01  3.84131822e+00  3.84131822e+00  3.84131822e+00
  4.10794987e+00  1.40593618e+01  1.40593618e+01  1.40593618e+01
  1.40861909e+01  4.64732891e+01  5.25349882e+01  5.25349882e+01
  5.25349882e+01  1.53507292e+02  2.40386653e+02  2.40386653e+02
  2.40386653e+02  5.16955350e+02  1.88247250e+03  8.01040188e+03
  4.77762205e+04]
E1 = -182.58830215411817  E_coul = 54.04645217302293
cycle= 4 E= -128.541849981095  delta_E= -2.63e-08  |g|= 8.03e-05  |ddm|= 0.000362
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185154
diis-c [-1.10815389e-09  2.34457102e-04  4.97545309e-04 -1.84650265e-01
  1.18391826e+00]
  HOMO = -0.849073949732933  LUMO = 0.750704633818882
  mo_energy =
[-3.27709831e+01 -1.92944850e+00 -8.49073950e-01 -8.49073950e-01
 -8.49073950e-01  7.50704634e-01  7.96754443e-01  7.96754443e-01
  7.96754443e-01  3.84127793e+00  3.84127793e+00  3.84127793e+00
  4.10791840e+00  1.40593021e+01  1.40593021e+01  1.40593021e+01
  1.40861381e+01  4.64732229e+01  5.25349189e+01  5.25349189e+01
  5.25349189e+01  1.53507218e+02  2.40386575e+02  2.40386575e+02
  2.40386575e+02  5.16955269e+02  1.88247241e+03  8.01040178e+03
  4.77762204e+04]
E1 = -182.5884333938894  E_coul = 54.04658341207403
cycle= 5 E= -128.541849981815  delta_E= -7.2e-10  |g|= 5.89e-06  |ddm|= 6.11e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5884333938894  E_coul = 54.04658341207403
  HOMO = -0.84907085050293  LUMO = 0.750705900960096
  mo_energy =
[-3.27709761e+01 -1.92944461e+00 -8.49070851e-01 -8.49070851e-01
 -8.49070851e-01  7.50705901e-01  7.96755339e-01  7.96755339e-01
  7.96755339e-01  3.84128087e+00  3.84128087e+00  3.84128087e+00
  4.10792120e+00  1.40593072e+01  1.40593072e+01  1.40593072e+01
  1.40861428e+01  4.64732291e+01  5.25349254e+01  5.25349254e+01
  5.25349254e+01  1.53507225e+02  2.40386582e+02  2.40386582e+02
  2.40386582e+02  5.16955275e+02  1.88247242e+03  8.01040179e+03
  4.77762204e+04]
E1 = -182.58841744817414  E_coul = 54.04656746635638
Extra cycle  E= -128.541849981818  delta_E= -2.39e-12  |g|= 2.24e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.70058151e-01 2.44137942e+04 3.66145162e+03 8.33318745e+02
 2.35449334e+02 7.59276959e+01 1.10626686e+01 2.78651167e+01
 2.99745160e-01 1.90480003e+00 3.90028546e+00 7.05512796e+00
 2.31924834e+01 9.97848103e+01 2.63783038e-01 2.41163438e+00
 8.24126733e-01]
E = -128.54184998181776
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.770058150668       1
[INPUT] 0    0    [1    /1   ]  24413.7941855        1
[INPUT] 0    0    [1    /1   ]  3661.45161625        1
[INPUT] 0    0    [1    /1   ]  833.318744954        1
[INPUT] 0    0    [1    /1   ]  235.449333716        1
[INPUT] 0    0    [1    /1   ]  75.9276959183        1
[INPUT] 0    0    [1    /1   ]  11.0626686412        1
[INPUT] 0    0    [1    /1   ]  27.8651167461        1
[INPUT] 0    0    [1    /1   ]  0.299745160075       1
[INPUT] 0    0    [1    /1   ]  1.90480002541        1
[INPUT] 0    0    [1    /1   ]  3.90028545848        1
[INPUT] 1    0    [1    /1   ]  7.05512795961        1
[INPUT] 1    0    [1    /1   ]  23.1924833933        1
[INPUT] 1    0    [1    /1   ]  99.7848103187        1
[INPUT] 1    0    [1    /1   ]  0.263783037605       1
[INPUT] 1    0    [1    /1   ]  2.41163438426        1
[INPUT] 1    0    [1    /1   ]  0.824126733054       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7700581506676341, 1.0]], [0, [24413.79418550727, 1.0]], [0, [3661.451616254585, 1.0]], [0, [833.3187449539007, 1.0]], [0, [235.4493337163638, 1.0]], [0, [75.9276959183117, 1.0]], [0, [11.062668641223226, 1.0]], [0, [27.86511674610029, 1.0]], [0, [0.29974516007522484, 1.0]], [0, [1.9048000254058217, 1.0]], [0, [3.900285458476715, 1.0]], [1, [7.055127959613081, 1.0]], [1, [23.19248339333467, 1.0]], [1, [99.78481031872688, 1.0]], [1, [0.26378303760489424, 1.0]], [1, [2.4116343842571215, 1.0]], [1, [0.8241267330542823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77005815]
bas 1, expnt(s) = [24413.79418551]
bas 2, expnt(s) = [3661.45161625]
bas 3, expnt(s) = [833.31874495]
bas 4, expnt(s) = [235.44933372]
bas 5, expnt(s) = [75.92769592]
bas 6, expnt(s) = [11.06266864]
bas 7, expnt(s) = [27.86511675]
bas 8, expnt(s) = [0.29974516]
bas 9, expnt(s) = [1.90480003]
bas 10, expnt(s) = [3.90028546]
bas 11, expnt(s) = [7.05512796]
bas 12, expnt(s) = [23.19248339]
bas 13, expnt(s) = [99.78481032]
bas 14, expnt(s) = [0.26378304]
bas 15, expnt(s) = [2.41163438]
bas 16, expnt(s) = [0.82412673]
CPU time:       231.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.70058151e-01 2.07686212e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318745e+02 3.91853191e+02
 2.35449334e+02 1.51858157e+02 7.59276959e+01 6.49853093e+01
 1.10626686e+01 1.53253341e+01 2.78651167e+01 3.06415461e+01
 2.99745160e-01 1.02347952e+00 1.90480003e+00 4.09639724e+00
 3.90028546e+00 7.01192593e+00 7.05512796e+00 3.35440511e+01
 2.31924834e+01 1.48480171e+02 9.97848103e+01 9.20057432e+02
 2.63783038e-01 5.51496771e-01 2.41163438e+00 8.76745866e+00
 8.24126733e-01 2.29074578e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999658511346693
cond(S) = 1266.771447767627
E1 = -183.59039687021337  E_coul = 55.080149006880056
init E= -128.510247863333
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406044267368  LUMO = 0.769823126331039
  mo_energy =
[-3.25551824e+01 -1.85274707e+00 -7.75406044e-01 -7.75406044e-01
 -7.75406044e-01  7.69823126e-01  8.14606919e-01  8.14606919e-01
  8.14606919e-01  3.90680423e+00  3.90680423e+00  3.90680423e+00
  4.16214123e+00  1.41868615e+01  1.41868615e+01  1.41868615e+01
  1.41930001e+01  4.66410773e+01  5.27225123e+01  5.27225123e+01
  5.27225123e+01  1.53719177e+02  2.40620043e+02  2.40620043e+02
  2.40620043e+02  5.17200456e+02  1.88274882e+03  8.01070500e+03
  4.77765417e+04]
E1 = -182.08439440706266  E_coul = 53.546059517599495
cycle= 1 E= -128.538334889463  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.520044
diis-c [-0.27044552  1.        ]
  HOMO = -0.884446628684965  LUMO = 0.74181072078451
  mo_energy =
[-3.28786732e+01 -1.96678672e+00 -8.84446629e-01 -8.84446629e-01
 -8.84446629e-01  7.41810721e-01  7.88197174e-01  7.88197174e-01
  7.88197174e-01  3.81014255e+00  3.81014255e+00  3.81014255e+00
  4.08223461e+00  1.39966548e+01  1.39966548e+01  1.39966548e+01
  1.40341005e+01  4.63892919e+01  5.24412523e+01  5.24412523e+01
  5.24412523e+01  1.53401901e+02  2.40273370e+02  2.40273370e+02
  2.40273370e+02  5.16839155e+02  1.88235105e+03  8.01027804e+03
  4.77760958e+04]
E1 = -182.8469745687256  E_coul = 54.30604749193083
cycle= 2 E= -128.540927076795  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264476
diis-c [-0.00069841  0.33628651  0.66371349]
  HOMO = -0.848772461294613  LUMO = 0.750769592833485
  mo_energy =
[-3.27704542e+01 -1.92922135e+00 -8.48772461e-01 -8.48772461e-01
 -8.48772461e-01  7.50769593e-01  7.96807552e-01  7.96807552e-01
  7.96807552e-01  3.84149541e+00  3.84149541e+00  3.84149541e+00
  4.10809213e+00  1.40596665e+01  1.40596665e+01  1.40596665e+01
  1.40864514e+01  4.64736517e+01  5.25353910e+01  5.25353910e+01
  5.25353910e+01  1.53507750e+02  2.40387180e+02  2.40387180e+02
  2.40387180e+02  5.16955932e+02  1.88247322e+03  8.01040270e+03
  4.77762214e+04]
E1 = -182.58787202362092  E_coul = 54.04602206881908
cycle= 3 E= -128.541849954802  delta_E= -0.000923  |g|= 0.000511  |ddm|= 0.0222
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00112594
diis-c [-1.97146776e-07 -2.36362931e-03 -7.33153862e-04  1.00309678e+00]
  HOMO = -0.849030507447201  LUMO = 0.750717589118439
  mo_energy =
[-3.27709099e+01 -1.92941545e+00 -8.49030507e-01 -8.49030507e-01
 -8.49030507e-01  7.50717589e-01  7.96767851e-01  7.96767851e-01
  7.96767851e-01  3.84131822e+00  3.84131822e+00  3.84131822e+00
  4.10794987e+00  1.40593618e+01  1.40593618e+01  1.40593618e+01
  1.40861909e+01  4.64732891e+01  5.25349882e+01  5.25349882e+01
  5.25349882e+01  1.53507292e+02  2.40386653e+02  2.40386653e+02
  2.40386653e+02  5.16955350e+02  1.88247250e+03  8.01040188e+03
  4.77762205e+04]
E1 = -182.58830215411817  E_coul = 54.04645217302293
cycle= 4 E= -128.541849981095  delta_E= -2.63e-08  |g|= 8.03e-05  |ddm|= 0.000362
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185154
diis-c [-1.10815389e-09  2.34457102e-04  4.97545309e-04 -1.84650265e-01
  1.18391826e+00]
  HOMO = -0.849073949732933  LUMO = 0.750704633818882
  mo_energy =
[-3.27709831e+01 -1.92944850e+00 -8.49073950e-01 -8.49073950e-01
 -8.49073950e-01  7.50704634e-01  7.96754443e-01  7.96754443e-01
  7.96754443e-01  3.84127793e+00  3.84127793e+00  3.84127793e+00
  4.10791840e+00  1.40593021e+01  1.40593021e+01  1.40593021e+01
  1.40861381e+01  4.64732229e+01  5.25349189e+01  5.25349189e+01
  5.25349189e+01  1.53507218e+02  2.40386575e+02  2.40386575e+02
  2.40386575e+02  5.16955269e+02  1.88247241e+03  8.01040178e+03
  4.77762204e+04]
E1 = -182.5884333938894  E_coul = 54.04658341207403
cycle= 5 E= -128.541849981815  delta_E= -7.2e-10  |g|= 5.89e-06  |ddm|= 6.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5884333938894  E_coul = 54.04658341207403
  HOMO = -0.84907085050293  LUMO = 0.750705900960096
  mo_energy =
[-3.27709761e+01 -1.92944461e+00 -8.49070851e-01 -8.49070851e-01
 -8.49070851e-01  7.50705901e-01  7.96755339e-01  7.96755339e-01
  7.96755339e-01  3.84128087e+00  3.84128087e+00  3.84128087e+00
  4.10792120e+00  1.40593072e+01  1.40593072e+01  1.40593072e+01
  1.40861428e+01  4.64732291e+01  5.25349254e+01  5.25349254e+01
  5.25349254e+01  1.53507225e+02  2.40386582e+02  2.40386582e+02
  2.40386582e+02  5.16955275e+02  1.88247242e+03  8.01040179e+03
  4.77762204e+04]
E1 = -182.58841744817414  E_coul = 54.04656746635638
Extra cycle  E= -128.541849981818  delta_E= -2.39e-12  |g|= 2.24e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1266.771447767627
E1 = -182.58841744817414  E_coul = 54.04656746635638
init E= -128.541849981818
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.849071979099259  LUMO = 0.750705696546025
  mo_energy =
[-3.27709797e+01 -1.92944566e+00 -8.49071979e-01 -8.49071979e-01
 -8.49071979e-01  7.50705697e-01  7.96755084e-01  7.96755084e-01
  7.96755084e-01  3.84127990e+00  3.84127990e+00  3.84127990e+00
  4.10792047e+00  1.40593052e+01  1.40593052e+01  1.40593052e+01
  1.40861412e+01  4.64732264e+01  5.25349224e+01  5.25349224e+01
  5.25349224e+01  1.53507222e+02  2.40386578e+02  2.40386578e+02
  2.40386578e+02  5.16955271e+02  1.88247241e+03  8.01040179e+03
  4.77762204e+04]
E1 = -182.58842629448046  E_coul = 54.046576312662424
cycle= 1 E= -128.541849981818  delta_E= -2.56e-13  |g|= 1.21e-06  |ddm|= 7.97e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.04 sec
E1 = -182.58842629448046  E_coul = 54.046576312662424
  HOMO = -0.849071356280286  LUMO = 0.750705868898468
  mo_energy =
[-3.27709778e+01 -1.92944498e+00 -8.49071356e-01 -8.49071356e-01
 -8.49071356e-01  7.50705869e-01  7.96755238e-01  7.96755238e-01
  7.96755238e-01  3.84128046e+00  3.84128046e+00  3.84128046e+00
  4.10792094e+00  1.40593063e+01  1.40593063e+01  1.40593063e+01
  1.40861421e+01  4.64732279e+01  5.25349240e+01  5.25349240e+01
  5.25349240e+01  1.53507223e+02  2.40386580e+02  2.40386580e+02
  2.40386580e+02  5.16955273e+02  1.88247242e+03  8.01040179e+03
  4.77762204e+04]
E1 = -182.58842184490635  E_coul = 54.04657186308831
Extra cycle  E= -128.541849981818  delta_E= -2.84e-14  |g|= 6.04e-07  |ddm|= 3.91e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.45 sec
exp = [7.70058151e-01 2.44137942e+04 3.66145162e+03 8.33318745e+02
 2.35449334e+02 7.59276959e+01 1.10626686e+01 2.78651167e+01
 2.99745160e-01 1.90480003e+00 3.90028546e+00 7.05512796e+00
 2.31924834e+01 9.97848103e+01 2.63783038e-01 2.41163438e+00
 8.24126733e-01]
grad_E = [ 8.19590548e-06 -2.31096562e-09  1.21805092e-07 -2.37056451e-06
  2.44129365e-05 -9.85516402e-05  2.62020560e-05  3.59781845e-05
  3.95377547e-05 -5.78095365e-06 -9.28847452e-05 -1.89294245e-04
  7.08079518e-05 -3.64068681e-06 -6.88815201e-05 -1.09406577e-04
 -1.17054827e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.770898058377       1
[INPUT] 0    0    [1    /1   ]  24413.7941855        1
[INPUT] 0    0    [1    /1   ]  3661.45161808        1
[INPUT] 0    0    [1    /1   ]  833.318710016        1
[INPUT] 0    0    [1    /1   ]  235.449687896        1
[INPUT] 0    0    [1    /1   ]  75.9262065513        1
[INPUT] 0    0    [1    /1   ]  11.0643790576        1
[INPUT] 0    0    [1    /1   ]  27.8658697876        1
[INPUT] 0    0    [1    /1   ]  0.300035421589       1
[INPUT] 0    0    [1    /1   ]  1.90702970108        1
[INPUT] 0    0    [1    /1   ]  3.89896876669        1
[INPUT] 1    0    [1    /1   ]  7.05701575945        1
[INPUT] 1    0    [1    /1   ]  23.1917960324        1
[INPUT] 1    0    [1    /1   ]  99.7848469361        1
[INPUT] 1    0    [1    /1   ]  0.263752868379       1
[INPUT] 1    0    [1    /1   ]  2.41238091767        1
[INPUT] 1    0    [1    /1   ]  0.824297596788       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7708980583774463, 1.0]], [0, [24413.79418547248, 1.0]], [0, [3661.4516180783226, 1.0]], [0, [833.3187100158063, 1.0]], [0, [235.44968789601458, 1.0]], [0, [75.9262065513309, 1.0]], [0, [11.064379057580755, 1.0]], [0, [27.865869787561355, 1.0]], [0, [0.3000354215892189, 1.0]], [0, [1.9070297010845656, 1.0]], [0, [3.8989687666901807, 1.0]], [1, [7.057015759451784, 1.0]], [1, [23.19179603240957, 1.0]], [1, [99.7848469361051, 1.0]], [1, [0.26375286837890166, 1.0]], [1, [2.4123809176737208, 1.0]], [1, [0.8242975967884002, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77089806]
bas 1, expnt(s) = [24413.79418547]
bas 2, expnt(s) = [3661.45161808]
bas 3, expnt(s) = [833.31871002]
bas 4, expnt(s) = [235.4496879]
bas 5, expnt(s) = [75.92620655]
bas 6, expnt(s) = [11.06437906]
bas 7, expnt(s) = [27.86586979]
bas 8, expnt(s) = [0.30003542]
bas 9, expnt(s) = [1.9070297]
bas 10, expnt(s) = [3.89896877]
bas 11, expnt(s) = [7.05701576]
bas 12, expnt(s) = [23.19179603]
bas 13, expnt(s) = [99.78484694]
bas 14, expnt(s) = [0.26375287]
bas 15, expnt(s) = [2.41238092]
bas 16, expnt(s) = [0.8242976]
CPU time:       235.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.70898058e-01 2.07856083e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318710e+02 3.91853179e+02
 2.35449688e+02 1.51858328e+02 7.59262066e+01 6.49843532e+01
 1.10643791e+01 1.53271112e+01 2.78658698e+01 3.06421671e+01
 3.00035422e-01 1.02422276e+00 1.90702970e+00 4.09999302e+00
 3.89896877e+00 7.01015049e+00 7.05701576e+00 3.35552711e+01
 2.31917960e+01 1.48474671e+02 9.97848469e+01 9.20057854e+02
 2.63752868e-01 5.51417928e-01 2.41238092e+00 8.77085130e+00
 8.24297597e-01 2.29133946e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999658350705566
cond(S) = 1270.9958703242764
E1 = -183.59039364006958  E_coul = 55.080148287852325
init E= -128.510245352217
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406196742822  LUMO = 0.770859606716292
  mo_energy =
[-3.25551823e+01 -1.85274717e+00 -7.75406197e-01 -7.75406197e-01
 -7.75406197e-01  7.70859607e-01  8.14583744e-01  8.14583744e-01
  8.14583744e-01  3.90751867e+00  3.90751867e+00  3.90751867e+00
  4.16702184e+00  1.41909425e+01  1.41909425e+01  1.41909425e+01
  1.42023822e+01  4.66536902e+01  5.27302106e+01  5.27302106e+01
  5.27302106e+01  1.53733882e+02  2.40625892e+02  2.40625892e+02
  2.40625892e+02  5.17213361e+02  1.88275975e+03  8.01071454e+03
  4.77765496e+04]
E1 = -182.08431882558926  E_coul = 53.54598405000297
cycle= 1 E= -128.538334775586  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.52005
diis-c [-0.27045212  1.        ]
  HOMO = -0.884453267031744  LUMO = 0.742805120787289
  mo_energy =
[-3.28786835e+01 -1.96679441e+00 -8.84453267e-01 -8.84453267e-01
 -8.84453267e-01  7.42805121e-01  7.88168782e-01  7.88168782e-01
  7.88168782e-01  3.81082796e+00  3.81082796e+00  3.81082796e+00
  4.08705594e+00  1.40007019e+01  1.40007019e+01  1.40007019e+01
  1.40434588e+01  4.64018949e+01  5.24489402e+01  5.24489402e+01
  5.24489402e+01  1.53416597e+02  2.40279211e+02  2.40279211e+02
  2.40279211e+02  5.16852051e+02  1.88236197e+03  8.01028758e+03
  4.77761037e+04]
E1 = -182.84693136108544  E_coul = 54.306004269528906
cycle= 2 E= -128.540927091557  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264483
diis-c [-0.00069849  0.33628941  0.66371059]
  HOMO = -0.848777715737536  LUMO = 0.75177656466983
  mo_energy =
[-3.27704605e+01 -1.92922755e+00 -8.48777716e-01 -8.48777716e-01
 -8.48777716e-01  7.51776565e-01  7.96780340e-01  7.96780340e-01
  7.96780340e-01  3.84218932e+00  3.84218932e+00  3.84218932e+00
  4.11293202e+00  1.40637245e+01  1.40637245e+01  1.40637245e+01
  1.40958169e+01  4.64862577e+01  5.25430824e+01  5.25430824e+01
  5.25430824e+01  1.53522450e+02  2.40393024e+02  2.40393024e+02
  2.40393024e+02  5.16968831e+02  1.88248414e+03  8.01041223e+03
  4.77762293e+04]
E1 = -182.5878104911544  E_coul = 54.04596042311284
cycle= 3 E= -128.541850068042  delta_E= -0.000923  |g|= 0.000512  |ddm|= 0.0222
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00112687
diis-c [-1.96879929e-07 -2.36451385e-03 -7.30569024e-04  1.00309508e+00]
  HOMO = -0.849036110582053  LUMO = 0.751724277450949
  mo_energy =
[-3.27709167e+01 -1.92942212e+00 -8.49036111e-01 -8.49036111e-01
 -8.49036111e-01  7.51724277e-01  7.96740502e-01  7.96740502e-01
  7.96740502e-01  3.84201173e+00  3.84201173e+00  3.84201173e+00
  4.11278932e+00  1.40634192e+01  1.40634192e+01  1.40634192e+01
  1.40955558e+01  4.64858945e+01  5.25426790e+01  5.25426790e+01
  5.25426790e+01  1.53521991e+02  2.40392497e+02  2.40392497e+02
  2.40392497e+02  5.16968249e+02  1.88248342e+03  8.01041142e+03
  4.77762284e+04]
E1 = -182.5882411870917  E_coul = 54.04639109272372
cycle= 4 E= -128.541850094368  delta_E= -2.63e-08  |g|= 8.04e-05  |ddm|= 0.000363
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185185
diis-c [-1.10552929e-09  2.33958898e-04  4.97098555e-04 -1.84371187e-01
  1.18364013e+00]
  HOMO = -0.849079586881033  LUMO = 0.751711275221817
  mo_energy =
[-3.27709900e+01 -1.92945523e+00 -8.49079587e-01 -8.49079587e-01
 -8.49079587e-01  7.51711275e-01  7.96727079e-01  7.96727079e-01
  7.96727079e-01  3.84197139e+00  3.84197139e+00  3.84197139e+00
  4.11275777e+00  1.40633595e+01  1.40633595e+01  1.40633595e+01
  1.40955030e+01  4.64858283e+01  5.25426097e+01  5.25426097e+01
  5.25426097e+01  1.53521917e+02  2.40392419e+02  2.40392419e+02
  2.40392419e+02  5.16968167e+02  1.88248333e+03  8.01041132e+03
  4.77762283e+04]
E1 = -182.5883724561771  E_coul = 54.046522361089906
cycle= 5 E= -128.541850095087  delta_E= -7.19e-10  |g|= 5.88e-06  |ddm|= 6.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.5883724561771  E_coul = 54.046522361089906
  HOMO = -0.849076495408508  LUMO = 0.751712541078475
  mo_energy =
[-3.27709830e+01 -1.92945135e+00 -8.49076495e-01 -8.49076495e-01
 -8.49076495e-01  7.51712541e-01  7.96727972e-01  7.96727972e-01
  7.96727972e-01  3.84197432e+00  3.84197432e+00  3.84197432e+00
  4.11276057e+00  1.40633646e+01  1.40633646e+01  1.40633646e+01
  1.40955076e+01  4.64858345e+01  5.25426162e+01  5.25426162e+01
  5.25426162e+01  1.53521924e+02  2.40392426e+02  2.40392426e+02
  2.40392426e+02  5.16968174e+02  1.88248334e+03  8.01041133e+03
  4.77762283e+04]
E1 = -182.5883565425982  E_coul = 54.0465064475082
Extra cycle  E= -128.54185009509  delta_E= -2.81e-12  |g|= 2.24e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.70898058e-01 2.44137942e+04 3.66145162e+03 8.33318710e+02
 2.35449688e+02 7.59262066e+01 1.10643791e+01 2.78658698e+01
 3.00035422e-01 1.90702970e+00 3.89896877e+00 7.05701576e+00
 2.31917960e+01 9.97848469e+01 2.63752868e-01 2.41238092e+00
 8.24297597e-01]
E = -128.54185009509
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.770898058377       1
[INPUT] 0    0    [1    /1   ]  24413.7941855        1
[INPUT] 0    0    [1    /1   ]  3661.45161808        1
[INPUT] 0    0    [1    /1   ]  833.318710016        1
[INPUT] 0    0    [1    /1   ]  235.449687896        1
[INPUT] 0    0    [1    /1   ]  75.9262065513        1
[INPUT] 0    0    [1    /1   ]  11.0643790576        1
[INPUT] 0    0    [1    /1   ]  27.8658697876        1
[INPUT] 0    0    [1    /1   ]  0.300035421589       1
[INPUT] 0    0    [1    /1   ]  1.90702970108        1
[INPUT] 0    0    [1    /1   ]  3.89896876669        1
[INPUT] 1    0    [1    /1   ]  7.05701575945        1
[INPUT] 1    0    [1    /1   ]  23.1917960324        1
[INPUT] 1    0    [1    /1   ]  99.7848469361        1
[INPUT] 1    0    [1    /1   ]  0.263752868379       1
[INPUT] 1    0    [1    /1   ]  2.41238091767        1
[INPUT] 1    0    [1    /1   ]  0.824297596788       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7708980583774463, 1.0]], [0, [24413.79418547248, 1.0]], [0, [3661.4516180783226, 1.0]], [0, [833.3187100158063, 1.0]], [0, [235.44968789601458, 1.0]], [0, [75.9262065513309, 1.0]], [0, [11.064379057580755, 1.0]], [0, [27.865869787561355, 1.0]], [0, [0.3000354215892189, 1.0]], [0, [1.9070297010845656, 1.0]], [0, [3.8989687666901807, 1.0]], [1, [7.057015759451784, 1.0]], [1, [23.19179603240957, 1.0]], [1, [99.7848469361051, 1.0]], [1, [0.26375286837890166, 1.0]], [1, [2.4123809176737208, 1.0]], [1, [0.8242975967884002, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77089806]
bas 1, expnt(s) = [24413.79418547]
bas 2, expnt(s) = [3661.45161808]
bas 3, expnt(s) = [833.31871002]
bas 4, expnt(s) = [235.4496879]
bas 5, expnt(s) = [75.92620655]
bas 6, expnt(s) = [11.06437906]
bas 7, expnt(s) = [27.86586979]
bas 8, expnt(s) = [0.30003542]
bas 9, expnt(s) = [1.9070297]
bas 10, expnt(s) = [3.89896877]
bas 11, expnt(s) = [7.05701576]
bas 12, expnt(s) = [23.19179603]
bas 13, expnt(s) = [99.78484694]
bas 14, expnt(s) = [0.26375287]
bas 15, expnt(s) = [2.41238092]
bas 16, expnt(s) = [0.8242976]
CPU time:       236.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.70898058e-01 2.07856083e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318710e+02 3.91853179e+02
 2.35449688e+02 1.51858328e+02 7.59262066e+01 6.49843532e+01
 1.10643791e+01 1.53271112e+01 2.78658698e+01 3.06421671e+01
 3.00035422e-01 1.02422276e+00 1.90702970e+00 4.09999302e+00
 3.89896877e+00 7.01015049e+00 7.05701576e+00 3.35552711e+01
 2.31917960e+01 1.48474671e+02 9.97848469e+01 9.20057854e+02
 2.63752868e-01 5.51417928e-01 2.41238092e+00 8.77085130e+00
 8.24297597e-01 2.29133946e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999658350705566
cond(S) = 1270.9958703242764
E1 = -183.59039364006958  E_coul = 55.080148287852325
init E= -128.510245352217
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406196742822  LUMO = 0.770859606716292
  mo_energy =
[-3.25551823e+01 -1.85274717e+00 -7.75406197e-01 -7.75406197e-01
 -7.75406197e-01  7.70859607e-01  8.14583744e-01  8.14583744e-01
  8.14583744e-01  3.90751867e+00  3.90751867e+00  3.90751867e+00
  4.16702184e+00  1.41909425e+01  1.41909425e+01  1.41909425e+01
  1.42023822e+01  4.66536902e+01  5.27302106e+01  5.27302106e+01
  5.27302106e+01  1.53733882e+02  2.40625892e+02  2.40625892e+02
  2.40625892e+02  5.17213361e+02  1.88275975e+03  8.01071454e+03
  4.77765496e+04]
E1 = -182.08431882558926  E_coul = 53.54598405000297
cycle= 1 E= -128.538334775586  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.52005
diis-c [-0.27045212  1.        ]
  HOMO = -0.884453267031744  LUMO = 0.742805120787289
  mo_energy =
[-3.28786835e+01 -1.96679441e+00 -8.84453267e-01 -8.84453267e-01
 -8.84453267e-01  7.42805121e-01  7.88168782e-01  7.88168782e-01
  7.88168782e-01  3.81082796e+00  3.81082796e+00  3.81082796e+00
  4.08705594e+00  1.40007019e+01  1.40007019e+01  1.40007019e+01
  1.40434588e+01  4.64018949e+01  5.24489402e+01  5.24489402e+01
  5.24489402e+01  1.53416597e+02  2.40279211e+02  2.40279211e+02
  2.40279211e+02  5.16852051e+02  1.88236197e+03  8.01028758e+03
  4.77761037e+04]
E1 = -182.84693136108544  E_coul = 54.306004269528906
cycle= 2 E= -128.540927091557  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264483
diis-c [-0.00069849  0.33628941  0.66371059]
  HOMO = -0.848777715737536  LUMO = 0.75177656466983
  mo_energy =
[-3.27704605e+01 -1.92922755e+00 -8.48777716e-01 -8.48777716e-01
 -8.48777716e-01  7.51776565e-01  7.96780340e-01  7.96780340e-01
  7.96780340e-01  3.84218932e+00  3.84218932e+00  3.84218932e+00
  4.11293202e+00  1.40637245e+01  1.40637245e+01  1.40637245e+01
  1.40958169e+01  4.64862577e+01  5.25430824e+01  5.25430824e+01
  5.25430824e+01  1.53522450e+02  2.40393024e+02  2.40393024e+02
  2.40393024e+02  5.16968831e+02  1.88248414e+03  8.01041223e+03
  4.77762293e+04]
E1 = -182.5878104911544  E_coul = 54.04596042311284
cycle= 3 E= -128.541850068042  delta_E= -0.000923  |g|= 0.000512  |ddm|= 0.0222
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00112687
diis-c [-1.96879929e-07 -2.36451385e-03 -7.30569024e-04  1.00309508e+00]
  HOMO = -0.849036110582053  LUMO = 0.751724277450949
  mo_energy =
[-3.27709167e+01 -1.92942212e+00 -8.49036111e-01 -8.49036111e-01
 -8.49036111e-01  7.51724277e-01  7.96740502e-01  7.96740502e-01
  7.96740502e-01  3.84201173e+00  3.84201173e+00  3.84201173e+00
  4.11278932e+00  1.40634192e+01  1.40634192e+01  1.40634192e+01
  1.40955558e+01  4.64858945e+01  5.25426790e+01  5.25426790e+01
  5.25426790e+01  1.53521991e+02  2.40392497e+02  2.40392497e+02
  2.40392497e+02  5.16968249e+02  1.88248342e+03  8.01041142e+03
  4.77762284e+04]
E1 = -182.5882411870917  E_coul = 54.04639109272372
cycle= 4 E= -128.541850094368  delta_E= -2.63e-08  |g|= 8.04e-05  |ddm|= 0.000363
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185185
diis-c [-1.10552929e-09  2.33958898e-04  4.97098555e-04 -1.84371187e-01
  1.18364013e+00]
  HOMO = -0.849079586881033  LUMO = 0.751711275221817
  mo_energy =
[-3.27709900e+01 -1.92945523e+00 -8.49079587e-01 -8.49079587e-01
 -8.49079587e-01  7.51711275e-01  7.96727079e-01  7.96727079e-01
  7.96727079e-01  3.84197139e+00  3.84197139e+00  3.84197139e+00
  4.11275777e+00  1.40633595e+01  1.40633595e+01  1.40633595e+01
  1.40955030e+01  4.64858283e+01  5.25426097e+01  5.25426097e+01
  5.25426097e+01  1.53521917e+02  2.40392419e+02  2.40392419e+02
  2.40392419e+02  5.16968167e+02  1.88248333e+03  8.01041132e+03
  4.77762283e+04]
E1 = -182.5883724561771  E_coul = 54.046522361089906
cycle= 5 E= -128.541850095087  delta_E= -7.19e-10  |g|= 5.88e-06  |ddm|= 6.11e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5883724561771  E_coul = 54.046522361089906
  HOMO = -0.849076495408508  LUMO = 0.751712541078475
  mo_energy =
[-3.27709830e+01 -1.92945135e+00 -8.49076495e-01 -8.49076495e-01
 -8.49076495e-01  7.51712541e-01  7.96727972e-01  7.96727972e-01
  7.96727972e-01  3.84197432e+00  3.84197432e+00  3.84197432e+00
  4.11276057e+00  1.40633646e+01  1.40633646e+01  1.40633646e+01
  1.40955076e+01  4.64858345e+01  5.25426162e+01  5.25426162e+01
  5.25426162e+01  1.53521924e+02  2.40392426e+02  2.40392426e+02
  2.40392426e+02  5.16968174e+02  1.88248334e+03  8.01041133e+03
  4.77762283e+04]
E1 = -182.5883565425982  E_coul = 54.0465064475082
Extra cycle  E= -128.54185009509  delta_E= -2.81e-12  |g|= 2.24e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1270.9958703242764
E1 = -182.5883565425982  E_coul = 54.0465064475082
init E= -128.54185009509
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.84907762183769  LUMO = 0.751712336780449
  mo_energy =
[-3.27709866e+01 -1.92945240e+00 -8.49077622e-01 -8.49077622e-01
 -8.49077622e-01  7.51712337e-01  7.96727718e-01  7.96727718e-01
  7.96727718e-01  3.84197336e+00  3.84197336e+00  3.84197336e+00
  4.11275984e+00  1.40633626e+01  1.40633626e+01  1.40633626e+01
  1.40955060e+01  4.64858318e+01  5.25426132e+01  5.25426132e+01
  5.25426132e+01  1.53521920e+02  2.40392422e+02  2.40392422e+02
  2.40392422e+02  5.16968170e+02  1.88248333e+03  8.01041132e+03
  4.77762283e+04]
E1 = -182.58836537058622  E_coul = 54.0465152754957
cycle= 1 E= -128.541850095091  delta_E= -5.12e-13  |g|= 1.21e-06  |ddm|= 7.95e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.58836537058622  E_coul = 54.0465152754957
  HOMO = -0.849077000324516  LUMO = 0.75171250901939
  mo_energy =
[-3.27709847e+01 -1.92945172e+00 -8.49077000e-01 -8.49077000e-01
 -8.49077000e-01  7.51712509e-01  7.96727872e-01  7.96727872e-01
  7.96727872e-01  3.84197391e+00  3.84197391e+00  3.84197391e+00
  4.11276031e+00  1.40633637e+01  1.40633637e+01  1.40633637e+01
  1.40955069e+01  4.64858333e+01  5.25426148e+01  5.25426148e+01
  5.25426148e+01  1.53521922e+02  2.40392424e+02  2.40392424e+02
  2.40392424e+02  5.16968172e+02  1.88248334e+03  8.01041133e+03
  4.77762283e+04]
E1 = -182.58836093005107  E_coul = 54.046510834960905
Extra cycle  E= -128.54185009509  delta_E= 3.69e-13  |g|= 6.03e-07  |ddm|= 3.9e-07
    CPU time for scf_cycle      0.46 sec, wall time      0.45 sec
exp = [7.70898058e-01 2.44137942e+04 3.66145162e+03 8.33318710e+02
 2.35449688e+02 7.59262066e+01 1.10643791e+01 2.78658698e+01
 3.00035422e-01 1.90702970e+00 3.89896877e+00 7.05701576e+00
 2.31917960e+01 9.97848469e+01 2.63752868e-01 2.41238092e+00
 8.24297597e-01]
grad_E = [-6.39463330e-07 -2.31384607e-09  1.21952513e-07 -2.37298605e-06
  2.44261776e-05 -9.84485888e-05  2.82844976e-05  3.49672544e-05
  5.72256232e-05 -3.65150337e-06 -9.38001657e-05 -1.75469174e-04
  6.77134846e-05 -3.49576218e-06 -3.01974000e-04 -1.35536971e-04
  8.48188679e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.77282158178        1
[INPUT] 0    0    [1    /1   ]  24413.7941854        1
[INPUT] 0    0    [1    /1   ]  3661.45162151        1
[INPUT] 0    0    [1    /1   ]  833.318644926        1
[INPUT] 0    0    [1    /1   ]  235.450347505        1
[INPUT] 0    0    [1    /1   ]  75.9232091928        1
[INPUT] 0    0    [1    /1   ]  11.0694122567        1
[INPUT] 0    0    [1    /1   ]  27.8683547737        1
[INPUT] 0    0    [1    /1   ]  0.300614507796       1
[INPUT] 0    0    [1    /1   ]  1.9126294876         1
[INPUT] 0    0    [1    /1   ]  3.89776446081        1
[INPUT] 1    0    [1    /1   ]  7.06195063493        1
[INPUT] 1    0    [1    /1   ]  23.1899961242        1
[INPUT] 1    0    [1    /1   ]  99.7849416747        1
[INPUT] 1    0    [1    /1   ]  0.263707245028       1
[INPUT] 1    0    [1    /1   ]  2.41442031802        1
[INPUT] 1    0    [1    /1   ]  0.824804182027       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7728215817804002, 1.0]], [0, [24413.79418540682, 1.0]], [0, [3661.4516215059043, 1.0]], [0, [833.3186449262188, 1.0]], [0, [235.4503475045132, 1.0]], [0, [75.92320919276418, 1.0]], [0, [11.069412256739442, 1.0]], [0, [27.868354773729198, 1.0]], [0, [0.30061450779579724, 1.0]], [0, [1.9126294875970866, 1.0]], [0, [3.8977644608051984, 1.0]], [1, [7.061950634929638, 1.0]], [1, [23.18999612421649, 1.0]], [1, [99.78494167473316, 1.0]], [1, [0.26370724502825, 1.0]], [1, [2.414420318017264, 1.0]], [1, [0.824804182026691, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77282158]
bas 1, expnt(s) = [24413.79418541]
bas 2, expnt(s) = [3661.45162151]
bas 3, expnt(s) = [833.31864493]
bas 4, expnt(s) = [235.4503475]
bas 5, expnt(s) = [75.92320919]
bas 6, expnt(s) = [11.06941226]
bas 7, expnt(s) = [27.86835477]
bas 8, expnt(s) = [0.30061451]
bas 9, expnt(s) = [1.91262949]
bas 10, expnt(s) = [3.89776446]
bas 11, expnt(s) = [7.06195063]
bas 12, expnt(s) = [23.18999612]
bas 13, expnt(s) = [99.78494167]
bas 14, expnt(s) = [0.26370725]
bas 15, expnt(s) = [2.41442032]
bas 16, expnt(s) = [0.82480418]
CPU time:       240.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.72821582e-01 2.08244939e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318645e+02 3.91853156e+02
 2.35450348e+02 1.51858647e+02 7.59232092e+01 6.49824292e+01
 1.10694123e+01 1.53323402e+01 2.78683548e+01 3.06442165e+01
 3.00614508e-01 1.02570501e+00 1.91262949e+00 4.10901910e+00
 3.89776446e+00 7.00852647e+00 7.06195063e+00 3.35846046e+01
 2.31899961e+01 1.48460267e+02 9.97849417e+01 9.20058946e+02
 2.63707245e-01 5.51298702e-01 2.41442032e+00 8.78012076e+00
 8.24804182e-01 2.29309982e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999657755705515
cond(S) = 1280.2931069983238
E1 = -183.5903860824508  E_coul = 55.08014687194565
init E= -128.510239210505
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406505366544  LUMO = 0.773096595656599
  mo_energy =
[-3.25551821e+01 -1.85274739e+00 -7.75406505e-01 -7.75406505e-01
 -7.75406505e-01  7.73096596e-01  8.14631558e-01  8.14631558e-01
  8.14631558e-01  3.90971461e+00  3.90971461e+00  3.90971461e+00
  4.17849698e+00  1.42021681e+01  1.42021681e+01  1.42021681e+01
  1.42276638e+01  4.66926647e+01  5.27508988e+01  5.27508988e+01
  5.27508988e+01  1.53782182e+02  2.40641587e+02  2.40641587e+02
  2.40641587e+02  5.17259098e+02  1.88280013e+03  8.01075006e+03
  4.77765790e+04]
E1 = -182.08415367580344  E_coul = 53.54581894096102
cycle= 1 E= -128.538334734842  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520066
diis-c [-0.27046897  1.        ]
  HOMO = -0.884468025587331  LUMO = 0.744948373903248
  mo_energy =
[-3.28787052e+01 -1.96681132e+00 -8.84468026e-01 -8.84468026e-01
 -8.84468026e-01  7.44948374e-01  7.88200072e-01  7.88200072e-01
  7.88200072e-01  3.81294726e+00  3.81294726e+00  3.81294726e+00
  4.09837926e+00  1.40118431e+01  1.40118431e+01  1.40118431e+01
  1.40686573e+01  4.64408384e+01  5.24696063e+01  5.24696063e+01
  5.24696063e+01  1.53464878e+02  2.40294888e+02  2.40294888e+02
  2.40294888e+02  5.16897769e+02  1.88240233e+03  8.01032307e+03
  4.77761331e+04]
E1 = -182.84683158496438  E_coul = 54.30590427325385
cycle= 2 E= -128.540927311711  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264498
diis-c [-0.00069873  0.33629547  0.66370453]
  HOMO = -0.848789717175319  LUMO = 0.753947638557876
  mo_energy =
[-3.27704741e+01 -1.92924147e+00 -8.48789717e-01 -8.48789717e-01
 -8.48789717e-01  7.53947639e-01  7.96815714e-01  7.96815714e-01
  7.96815714e-01  3.84433123e+00  3.84433123e+00  3.84433123e+00
  4.12430294e+00  1.40748924e+01  1.40748924e+01  1.40748924e+01
  1.41210411e+01  4.65252104e+01  5.25637557e+01  5.25637557e+01
  5.25637557e+01  1.53570737e+02  2.40408709e+02  2.40408709e+02
  2.40408709e+02  5.17014557e+02  1.88252451e+03  8.01044774e+03
  4.77762587e+04]
E1 = -182.58767155727926  E_coul = 54.04582106205657
cycle= 3 E= -128.541850495223  delta_E= -0.000923  |g|= 0.000513  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00112918
diis-c [-1.96389940e-07 -2.36705108e-03 -7.25184217e-04  1.00309224e+00]
  HOMO = -0.849048960828773  LUMO = 0.753894684153456
  mo_energy =
[-3.27709317e+01 -1.92943713e+00 -8.49048961e-01 -8.49048961e-01
 -8.49048961e-01  7.53894684e-01  7.96775534e-01  7.96775534e-01
  7.96775534e-01  3.84415264e+00  3.84415264e+00  3.84415264e+00
  4.12415915e+00  1.40745859e+01  1.40745859e+01  1.40745859e+01
  1.41207787e+01  4.65248459e+01  5.25633510e+01  5.25633510e+01
  5.25633510e+01  1.53570277e+02  2.40408181e+02  2.40408181e+02
  2.40408181e+02  5.17013974e+02  1.88252380e+03  8.01044692e+03
  4.77762578e+04]
E1 = -182.58810355535437  E_coul = 54.046253033713704
cycle= 4 E= -128.541850521641  delta_E= -2.64e-08  |g|= 8.05e-05  |ddm|= 0.000363
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185293
diis-c [-1.09987241e-09  2.32874547e-04  4.96160890e-04 -1.83754550e-01
  1.18302551e+00]
  HOMO = -0.849092524628395  LUMO = 0.753881573009444
  mo_energy =
[-3.27710051e+01 -1.92947041e+00 -8.49092525e-01 -8.49092525e-01
 -8.49092525e-01  7.53881573e-01  7.96762071e-01  7.96762071e-01
  7.96762071e-01  3.84411218e+00  3.84411218e+00  3.84411218e+00
  4.12412745e+00  1.40745261e+01  1.40745261e+01  1.40745261e+01
  1.41207257e+01  4.65247795e+01  5.25632815e+01  5.25632815e+01
  5.25632815e+01  1.53570203e+02  2.40408103e+02  2.40408103e+02
  2.40408103e+02  5.17013892e+02  1.88252371e+03  8.01044682e+03
  4.77762577e+04]
E1 = -182.58823490906653  E_coul = 54.04638438670716
cycle= 5 E= -128.541850522359  delta_E= -7.19e-10  |g|= 5.85e-06  |ddm|= 6.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58823490906653  E_coul = 54.04638438670716
  HOMO = -0.84908944977856  LUMO = 0.753882836310793
  mo_energy =
[-3.27709982e+01 -1.92946655e+00 -8.49089450e-01 -8.49089450e-01
 -8.49089450e-01  7.53882836e-01  7.96762960e-01  7.96762960e-01
  7.96762960e-01  3.84411510e+00  3.84411510e+00  3.84411510e+00
  4.12413024e+00  1.40745311e+01  1.40745311e+01  1.40745311e+01
  1.41207304e+01  4.65247857e+01  5.25632880e+01  5.25632880e+01
  5.25632880e+01  1.53570210e+02  2.40408109e+02  2.40408109e+02
  2.40408109e+02  5.17013898e+02  1.88252371e+03  8.01044683e+03
  4.77762577e+04]
E1 = -182.58821906542337  E_coul = 54.046368543061284
Extra cycle  E= -128.541850522362  delta_E= -2.73e-12  |g|= 2.23e-06  |ddm|= 2.12e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.72821582e-01 2.44137942e+04 3.66145162e+03 8.33318645e+02
 2.35450348e+02 7.59232092e+01 1.10694123e+01 2.78683548e+01
 3.00614508e-01 1.91262949e+00 3.89776446e+00 7.06195063e+00
 2.31899961e+01 9.97849417e+01 2.63707245e-01 2.41442032e+00
 8.24804182e-01]
E = -128.5418505223621
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:54:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.77282158178        1
[INPUT] 0    0    [1    /1   ]  24413.7941854        1
[INPUT] 0    0    [1    /1   ]  3661.45162151        1
[INPUT] 0    0    [1    /1   ]  833.318644926        1
[INPUT] 0    0    [1    /1   ]  235.450347505        1
[INPUT] 0    0    [1    /1   ]  75.9232091928        1
[INPUT] 0    0    [1    /1   ]  11.0694122567        1
[INPUT] 0    0    [1    /1   ]  27.8683547737        1
[INPUT] 0    0    [1    /1   ]  0.300614507796       1
[INPUT] 0    0    [1    /1   ]  1.9126294876         1
[INPUT] 0    0    [1    /1   ]  3.89776446081        1
[INPUT] 1    0    [1    /1   ]  7.06195063493        1
[INPUT] 1    0    [1    /1   ]  23.1899961242        1
[INPUT] 1    0    [1    /1   ]  99.7849416747        1
[INPUT] 1    0    [1    /1   ]  0.263707245028       1
[INPUT] 1    0    [1    /1   ]  2.41442031802        1
[INPUT] 1    0    [1    /1   ]  0.824804182027       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7728215817804002, 1.0]], [0, [24413.79418540682, 1.0]], [0, [3661.4516215059043, 1.0]], [0, [833.3186449262188, 1.0]], [0, [235.4503475045132, 1.0]], [0, [75.92320919276418, 1.0]], [0, [11.069412256739442, 1.0]], [0, [27.868354773729198, 1.0]], [0, [0.30061450779579724, 1.0]], [0, [1.9126294875970866, 1.0]], [0, [3.8977644608051984, 1.0]], [1, [7.061950634929638, 1.0]], [1, [23.18999612421649, 1.0]], [1, [99.78494167473316, 1.0]], [1, [0.26370724502825, 1.0]], [1, [2.414420318017264, 1.0]], [1, [0.824804182026691, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77282158]
bas 1, expnt(s) = [24413.79418541]
bas 2, expnt(s) = [3661.45162151]
bas 3, expnt(s) = [833.31864493]
bas 4, expnt(s) = [235.4503475]
bas 5, expnt(s) = [75.92320919]
bas 6, expnt(s) = [11.06941226]
bas 7, expnt(s) = [27.86835477]
bas 8, expnt(s) = [0.30061451]
bas 9, expnt(s) = [1.91262949]
bas 10, expnt(s) = [3.89776446]
bas 11, expnt(s) = [7.06195063]
bas 12, expnt(s) = [23.18999612]
bas 13, expnt(s) = [99.78494167]
bas 14, expnt(s) = [0.26370725]
bas 15, expnt(s) = [2.41442032]
bas 16, expnt(s) = [0.82480418]
CPU time:       241.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.72821582e-01 2.08244939e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318645e+02 3.91853156e+02
 2.35450348e+02 1.51858647e+02 7.59232092e+01 6.49824292e+01
 1.10694123e+01 1.53323402e+01 2.78683548e+01 3.06442165e+01
 3.00614508e-01 1.02570501e+00 1.91262949e+00 4.10901910e+00
 3.89776446e+00 7.00852647e+00 7.06195063e+00 3.35846046e+01
 2.31899961e+01 1.48460267e+02 9.97849417e+01 9.20058946e+02
 2.63707245e-01 5.51298702e-01 2.41442032e+00 8.78012076e+00
 8.24804182e-01 2.29309982e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999657755705515
cond(S) = 1280.2931069983238
E1 = -183.5903860824508  E_coul = 55.08014687194565
init E= -128.510239210505
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406505366544  LUMO = 0.773096595656599
  mo_energy =
[-3.25551821e+01 -1.85274739e+00 -7.75406505e-01 -7.75406505e-01
 -7.75406505e-01  7.73096596e-01  8.14631558e-01  8.14631558e-01
  8.14631558e-01  3.90971461e+00  3.90971461e+00  3.90971461e+00
  4.17849698e+00  1.42021681e+01  1.42021681e+01  1.42021681e+01
  1.42276638e+01  4.66926647e+01  5.27508988e+01  5.27508988e+01
  5.27508988e+01  1.53782182e+02  2.40641587e+02  2.40641587e+02
  2.40641587e+02  5.17259098e+02  1.88280013e+03  8.01075006e+03
  4.77765790e+04]
E1 = -182.08415367580344  E_coul = 53.54581894096102
cycle= 1 E= -128.538334734842  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.149
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.520066
diis-c [-0.27046897  1.        ]
  HOMO = -0.884468025587331  LUMO = 0.744948373903248
  mo_energy =
[-3.28787052e+01 -1.96681132e+00 -8.84468026e-01 -8.84468026e-01
 -8.84468026e-01  7.44948374e-01  7.88200072e-01  7.88200072e-01
  7.88200072e-01  3.81294726e+00  3.81294726e+00  3.81294726e+00
  4.09837926e+00  1.40118431e+01  1.40118431e+01  1.40118431e+01
  1.40686573e+01  4.64408384e+01  5.24696063e+01  5.24696063e+01
  5.24696063e+01  1.53464878e+02  2.40294888e+02  2.40294888e+02
  2.40294888e+02  5.16897769e+02  1.88240233e+03  8.01032307e+03
  4.77761331e+04]
E1 = -182.84683158496438  E_coul = 54.30590427325385
cycle= 2 E= -128.540927311711  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264498
diis-c [-0.00069873  0.33629547  0.66370453]
  HOMO = -0.848789717175319  LUMO = 0.753947638557876
  mo_energy =
[-3.27704741e+01 -1.92924147e+00 -8.48789717e-01 -8.48789717e-01
 -8.48789717e-01  7.53947639e-01  7.96815714e-01  7.96815714e-01
  7.96815714e-01  3.84433123e+00  3.84433123e+00  3.84433123e+00
  4.12430294e+00  1.40748924e+01  1.40748924e+01  1.40748924e+01
  1.41210411e+01  4.65252104e+01  5.25637557e+01  5.25637557e+01
  5.25637557e+01  1.53570737e+02  2.40408709e+02  2.40408709e+02
  2.40408709e+02  5.17014557e+02  1.88252451e+03  8.01044774e+03
  4.77762587e+04]
E1 = -182.58767155727926  E_coul = 54.04582106205657
cycle= 3 E= -128.541850495223  delta_E= -0.000923  |g|= 0.000513  |ddm|= 0.0222
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00112918
diis-c [-1.96389940e-07 -2.36705108e-03 -7.25184217e-04  1.00309224e+00]
  HOMO = -0.849048960828773  LUMO = 0.753894684153456
  mo_energy =
[-3.27709317e+01 -1.92943713e+00 -8.49048961e-01 -8.49048961e-01
 -8.49048961e-01  7.53894684e-01  7.96775534e-01  7.96775534e-01
  7.96775534e-01  3.84415264e+00  3.84415264e+00  3.84415264e+00
  4.12415915e+00  1.40745859e+01  1.40745859e+01  1.40745859e+01
  1.41207787e+01  4.65248459e+01  5.25633510e+01  5.25633510e+01
  5.25633510e+01  1.53570277e+02  2.40408181e+02  2.40408181e+02
  2.40408181e+02  5.17013974e+02  1.88252380e+03  8.01044692e+03
  4.77762578e+04]
E1 = -182.58810355535437  E_coul = 54.046253033713704
cycle= 4 E= -128.541850521641  delta_E= -2.64e-08  |g|= 8.05e-05  |ddm|= 0.000363
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185293
diis-c [-1.09987241e-09  2.32874547e-04  4.96160890e-04 -1.83754550e-01
  1.18302551e+00]
  HOMO = -0.849092524628395  LUMO = 0.753881573009444
  mo_energy =
[-3.27710051e+01 -1.92947041e+00 -8.49092525e-01 -8.49092525e-01
 -8.49092525e-01  7.53881573e-01  7.96762071e-01  7.96762071e-01
  7.96762071e-01  3.84411218e+00  3.84411218e+00  3.84411218e+00
  4.12412745e+00  1.40745261e+01  1.40745261e+01  1.40745261e+01
  1.41207257e+01  4.65247795e+01  5.25632815e+01  5.25632815e+01
  5.25632815e+01  1.53570203e+02  2.40408103e+02  2.40408103e+02
  2.40408103e+02  5.17013892e+02  1.88252371e+03  8.01044682e+03
  4.77762577e+04]
E1 = -182.58823490906653  E_coul = 54.04638438670716
cycle= 5 E= -128.541850522359  delta_E= -7.19e-10  |g|= 5.85e-06  |ddm|= 6.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58823490906653  E_coul = 54.04638438670716
  HOMO = -0.84908944977856  LUMO = 0.753882836310793
  mo_energy =
[-3.27709982e+01 -1.92946655e+00 -8.49089450e-01 -8.49089450e-01
 -8.49089450e-01  7.53882836e-01  7.96762960e-01  7.96762960e-01
  7.96762960e-01  3.84411510e+00  3.84411510e+00  3.84411510e+00
  4.12413024e+00  1.40745311e+01  1.40745311e+01  1.40745311e+01
  1.41207304e+01  4.65247857e+01  5.25632880e+01  5.25632880e+01
  5.25632880e+01  1.53570210e+02  2.40408109e+02  2.40408109e+02
  2.40408109e+02  5.17013898e+02  1.88252371e+03  8.01044683e+03
  4.77762577e+04]
E1 = -182.58821906542337  E_coul = 54.046368543061284
Extra cycle  E= -128.541850522362  delta_E= -2.73e-12  |g|= 2.23e-06  |ddm|= 2.12e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1280.2931069983238
E1 = -182.58821906542337  E_coul = 54.046368543061284
init E= -128.541850522362
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.849090571485828  LUMO = 0.753882632274494
  mo_energy =
[-3.27710017e+01 -1.92946759e+00 -8.49090571e-01 -8.49090571e-01
 -8.49090571e-01  7.53882632e-01  7.96762707e-01  7.96762707e-01
  7.96762707e-01  3.84411414e+00  3.84411414e+00  3.84411414e+00
  4.12412951e+00  1.40745291e+01  1.40745291e+01  1.40745291e+01
  1.41207287e+01  4.65247830e+01  5.25632850e+01  5.25632850e+01
  5.25632850e+01  1.53570206e+02  2.40408106e+02  2.40408106e+02
  2.40408106e+02  5.17013895e+02  1.88252371e+03  8.01044682e+03
  4.77762577e+04]
E1 = -182.5882278537489  E_coul = 54.04637733138683
cycle= 1 E= -128.541850522362  delta_E= 2.84e-14  |g|= 1.2e-06  |ddm|= 7.92e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.5882278537489  E_coul = 54.04637733138683
  HOMO = -0.849089952799874  LUMO = 0.753882804279875
  mo_energy =
[-3.27709998e+01 -1.92946691e+00 -8.49089953e-01 -8.49089953e-01
 -8.49089953e-01  7.53882804e-01  7.96762859e-01  7.96762859e-01
  7.96762859e-01  3.84411469e+00  3.84411469e+00  3.84411469e+00
  4.12412998e+00  1.40745302e+01  1.40745302e+01  1.40745302e+01
  1.41207297e+01  4.65247845e+01  5.25632866e+01  5.25632866e+01
  5.25632866e+01  1.53570208e+02  2.40408108e+02  2.40408108e+02
  2.40408108e+02  5.17013897e+02  1.88252371e+03  8.01044683e+03
  4.77762577e+04]
E1 = -182.58822343279942  E_coul = 54.04637291043721
Extra cycle  E= -128.541850522362  delta_E= -1.42e-13  |g|= 6e-07  |ddm|= 3.89e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [7.72821582e-01 2.44137942e+04 3.66145162e+03 8.33318645e+02
 2.35450348e+02 7.59232092e+01 1.10694123e+01 2.78683548e+01
 3.00614508e-01 1.91262949e+00 3.89776446e+00 7.06195063e+00
 2.31899961e+01 9.97849417e+01 2.63707245e-01 2.41442032e+00
 8.24804182e-01]
grad_E = [-1.65505425e-05 -2.31925697e-09  1.22228469e-07 -2.37741397e-06
  2.44455447e-05 -9.81498839e-05  3.32357900e-05  3.24367107e-05
  8.44169048e-05  1.06718479e-06 -9.57834963e-05 -1.41830688e-04
  5.98997137e-05 -3.12585377e-06 -8.53914731e-04 -1.96228292e-04
  3.16917273e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.775200908441       1
[INPUT] 0    0    [1    /1   ]  24413.7941854        1
[INPUT] 0    0    [1    /1   ]  3661.45162312        1
[INPUT] 0    0    [1    /1   ]  833.318616519        1
[INPUT] 0    0    [1    /1   ]  235.450635827        1
[INPUT] 0    0    [1    /1   ]  75.9209614341        1
[INPUT] 0    0    [1    /1   ]  11.0793185648        1
[INPUT] 0    0    [1    /1   ]  27.8739677899        1
[INPUT] 0    0    [1    /1   ]  0.301232469564       1
[INPUT] 0    0    [1    /1   ]  1.92029968431        1
[INPUT] 0    0    [1    /1   ]  3.90266693567        1
[INPUT] 1    0    [1    /1   ]  7.06886475421        1
[INPUT] 1    0    [1    /1   ]  23.1874808994        1
[INPUT] 1    0    [1    /1   ]  99.7850707173        1
[INPUT] 1    0    [1    /1   ]  0.263669248646       1
[INPUT] 1    0    [1    /1   ]  2.41736222476        1
[INPUT] 1    0    [1    /1   ]  0.82556970086        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7752009084405562, 1.0]], [0, [24413.79418537472, 1.0]], [0, [3661.4516231224484, 1.0]], [0, [833.3186165192831, 1.0]], [0, [235.4506358269298, 1.0]], [0, [75.92096143410592, 1.0]], [0, [11.079318564788156, 1.0]], [0, [27.873967789891886, 1.0]], [0, [0.3012324695638566, 1.0]], [0, [1.9202996843093576, 1.0]], [0, [3.9026669356675163, 1.0]], [1, [7.068864754207934, 1.0]], [1, [23.187480899400214, 1.0]], [1, [99.78507071727198, 1.0]], [1, [0.2636692486462552, 1.0]], [1, [2.4173622247646933, 1.0]], [1, [0.8255697008598974, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77520091]
bas 1, expnt(s) = [24413.79418537]
bas 2, expnt(s) = [3661.45162312]
bas 3, expnt(s) = [833.31861652]
bas 4, expnt(s) = [235.45063583]
bas 5, expnt(s) = [75.92096143]
bas 6, expnt(s) = [11.07931856]
bas 7, expnt(s) = [27.87396779]
bas 8, expnt(s) = [0.30123247]
bas 9, expnt(s) = [1.92029968]
bas 10, expnt(s) = [3.90266694]
bas 11, expnt(s) = [7.06886475]
bas 12, expnt(s) = [23.1874809]
bas 13, expnt(s) = [99.78507072]
bas 14, expnt(s) = [0.26366925]
bas 15, expnt(s) = [2.41736222]
bas 16, expnt(s) = [0.8255697]
CPU time:       244.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.75200908e-01 2.08725605e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318617e+02 3.91853146e+02
 2.35450636e+02 1.51858786e+02 7.59209614e+01 6.49809863e+01
 1.10793186e+01 1.53426300e+01 2.78739678e+01 3.06488455e+01
 3.01232470e-01 1.02728598e+00 1.92029968e+00 4.12137168e+00
 3.90266694e+00 7.01513674e+00 7.06886475e+00 3.36257116e+01
 2.31874809e+01 1.48440140e+02 9.97850707e+01 9.20060433e+02
 2.63669249e-01 5.51199411e-01 2.41736222e+00 8.79349572e+00
 8.25569701e-01 2.29576047e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999656749759623
cond(S) = 1289.9122909996436
E1 = -183.59037592288055  E_coul = 55.0801451392117
init E= -128.510230783669
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406839978268  LUMO = 0.775763375436718
  mo_energy =
[-3.25551821e+01 -1.85274768e+00 -7.75406840e-01 -7.75406840e-01
 -7.75406840e-01  7.75763375e-01  8.14785652e-01  8.14785652e-01
  8.14785652e-01  3.91307984e+00  3.91307984e+00  3.91307984e+00
  4.19382293e+00  1.42184056e+01  1.42184056e+01  1.42184056e+01
  1.42704601e+01  4.67728142e+01  5.27804156e+01  5.27804156e+01
  5.27804156e+01  1.53889094e+02  2.40663981e+02  2.40663981e+02
  2.40663981e+02  5.17368329e+02  1.88290022e+03  8.01083855e+03
  4.77766523e+04]
E1 = -182.08394347427287  E_coul = 53.54560837645372
cycle= 1 E= -128.538335097819  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520091
diis-c [-0.270495  1.      ]
  HOMO = -0.884487031262327  LUMO = 0.747498554513563
  mo_energy =
[-3.28787326e+01 -1.96683286e+00 -8.84487031e-01 -8.84487031e-01
 -8.84487031e-01  7.47498555e-01  7.88328359e-01  7.88328359e-01
  7.88328359e-01  3.81620355e+00  3.81620355e+00  3.81620355e+00
  4.11347344e+00  1.40279647e+01  1.40279647e+01  1.40279647e+01
  1.41112602e+01  4.65209172e+01  5.24990958e+01  5.24990958e+01
  5.24990958e+01  1.53571764e+02  2.40317261e+02  2.40317261e+02
  2.40317261e+02  5.17006977e+02  1.88250239e+03  8.01041153e+03
  4.77762064e+04]
E1 = -182.84669905950673  E_coul = 54.3057710724065
cycle= 2 E= -128.5409279871  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264521
diis-c [-0.00069922  0.33630357  0.66369643]
  HOMO = -0.848805527024183  LUMO = 0.756532095464776
  mo_energy =
[-3.27704918e+01 -1.92925956e+00 -8.48805527e-01 -8.48805527e-01
 -8.48805527e-01  7.56532095e-01  7.96950572e-01  7.96950572e-01
  7.96950572e-01  3.84761968e+00  3.84761968e+00  3.84761968e+00
  4.13947012e+00  1.40910505e+01  1.40910505e+01  1.40910505e+01
  1.41637062e+01  4.66053111e+01  5.25932535e+01  5.25932535e+01
  5.25932535e+01  1.53677632e+02  2.40431091e+02  2.40431091e+02
  2.40431091e+02  5.17123774e+02  1.88262458e+03  8.01053621e+03
  4.77763320e+04]
E1 = -182.587490343618  E_coul = 54.04563891781362
cycle= 3 E= -128.541851425804  delta_E= -0.000923  |g|= 0.000515  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113216
diis-c [-1.95887048e-07 -2.37103524e-03 -7.19889500e-04  1.00309092e+00]
  HOMO = -0.849065908725798  LUMO = 0.756478257467998
  mo_energy =
[-3.27709512e+01 -1.92945667e+00 -8.49065909e-01 -8.49065909e-01
 -8.49065909e-01  7.56478257e-01  7.96909921e-01  7.96909921e-01
  7.96909921e-01  3.84743975e+00  3.84743975e+00  3.84743975e+00
  4.13932483e+00  1.40907423e+01  1.40907423e+01  1.40907423e+01
  1.41634421e+01  4.66049448e+01  5.25928471e+01  5.25928471e+01
  5.25928471e+01  1.53677170e+02  2.40430560e+02  2.40430560e+02
  2.40430560e+02  5.17123188e+02  1.88262386e+03  8.01053539e+03
  4.77763311e+04]
E1 = -182.58792378522935  E_coul = 54.046072332871965
cycle= 4 E= -128.541851452357  delta_E= -2.66e-08  |g|= 8.06e-05  |ddm|= 0.000364
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185481
diis-c [-1.09299672e-09  2.31504309e-04  4.95185730e-04 -1.82976363e-01
  1.18224967e+00]
  HOMO = -0.849109599681813  LUMO = 0.756465002328423
  mo_energy =
[-3.27710248e+01 -1.92949017e+00 -8.49109600e-01 -8.49109600e-01
 -8.49109600e-01  7.56465002e-01  7.96896398e-01  7.96896398e-01
  7.96896398e-01  3.84739911e+00  3.84739911e+00  3.84739911e+00
  4.13929289e+00  1.40906822e+01  1.40906822e+01  1.40906822e+01
  1.41633888e+01  4.66048783e+01  5.25927774e+01  5.25927774e+01
  5.25927774e+01  1.53677096e+02  2.40430482e+02  2.40430482e+02
  2.40430482e+02  5.17123106e+02  1.88262377e+03  8.01053529e+03
  4.77763310e+04]
E1 = -182.58805526986723  E_coul = 54.04620381679168
cycle= 5 E= -128.541851453076  delta_E= -7.18e-10  |g|= 5.82e-06  |ddm|= 6.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58805526986723  E_coul = 54.04620381679168
  HOMO = -0.849106545221788  LUMO = 0.756466262599814
  mo_energy =
[-3.27710179e+01 -1.92948633e+00 -8.49106545e-01 -8.49106545e-01
 -8.49106545e-01  7.56466263e-01  7.96897282e-01  7.96897282e-01
  7.96897282e-01  3.84740201e+00  3.84740201e+00  3.84740201e+00
  4.13929567e+00  1.40906872e+01  1.40906872e+01  1.40906872e+01
  1.41633934e+01  4.66048844e+01  5.25927839e+01  5.25927839e+01
  5.25927839e+01  1.53677102e+02  2.40430489e+02  2.40430489e+02
  2.40430489e+02  5.17123113e+02  1.88262378e+03  8.01053530e+03
  4.77763310e+04]
E1 = -182.58803951286538  E_coul = 54.04618805978721
Extra cycle  E= -128.541851453078  delta_E= -2.61e-12  |g|= 2.21e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.75200908e-01 2.44137942e+04 3.66145162e+03 8.33318617e+02
 2.35450636e+02 7.59209614e+01 1.10793186e+01 2.78739678e+01
 3.01232470e-01 1.92029968e+00 3.90266694e+00 7.06886475e+00
 2.31874809e+01 9.97850707e+01 2.63669249e-01 2.41736222e+00
 8.25569701e-01]
E = -128.54185145307815
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.775200908441       1
[INPUT] 0    0    [1    /1   ]  24413.7941854        1
[INPUT] 0    0    [1    /1   ]  3661.45162312        1
[INPUT] 0    0    [1    /1   ]  833.318616519        1
[INPUT] 0    0    [1    /1   ]  235.450635827        1
[INPUT] 0    0    [1    /1   ]  75.9209614341        1
[INPUT] 0    0    [1    /1   ]  11.0793185648        1
[INPUT] 0    0    [1    /1   ]  27.8739677899        1
[INPUT] 0    0    [1    /1   ]  0.301232469564       1
[INPUT] 0    0    [1    /1   ]  1.92029968431        1
[INPUT] 0    0    [1    /1   ]  3.90266693567        1
[INPUT] 1    0    [1    /1   ]  7.06886475421        1
[INPUT] 1    0    [1    /1   ]  23.1874808994        1
[INPUT] 1    0    [1    /1   ]  99.7850707173        1
[INPUT] 1    0    [1    /1   ]  0.263669248646       1
[INPUT] 1    0    [1    /1   ]  2.41736222476        1
[INPUT] 1    0    [1    /1   ]  0.82556970086        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7752009084405562, 1.0]], [0, [24413.79418537472, 1.0]], [0, [3661.4516231224484, 1.0]], [0, [833.3186165192831, 1.0]], [0, [235.4506358269298, 1.0]], [0, [75.92096143410592, 1.0]], [0, [11.079318564788156, 1.0]], [0, [27.873967789891886, 1.0]], [0, [0.3012324695638566, 1.0]], [0, [1.9202996843093576, 1.0]], [0, [3.9026669356675163, 1.0]], [1, [7.068864754207934, 1.0]], [1, [23.187480899400214, 1.0]], [1, [99.78507071727198, 1.0]], [1, [0.2636692486462552, 1.0]], [1, [2.4173622247646933, 1.0]], [1, [0.8255697008598974, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77520091]
bas 1, expnt(s) = [24413.79418537]
bas 2, expnt(s) = [3661.45162312]
bas 3, expnt(s) = [833.31861652]
bas 4, expnt(s) = [235.45063583]
bas 5, expnt(s) = [75.92096143]
bas 6, expnt(s) = [11.07931856]
bas 7, expnt(s) = [27.87396779]
bas 8, expnt(s) = [0.30123247]
bas 9, expnt(s) = [1.92029968]
bas 10, expnt(s) = [3.90266694]
bas 11, expnt(s) = [7.06886475]
bas 12, expnt(s) = [23.1874809]
bas 13, expnt(s) = [99.78507072]
bas 14, expnt(s) = [0.26366925]
bas 15, expnt(s) = [2.41736222]
bas 16, expnt(s) = [0.8255697]
CPU time:       245.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.75200908e-01 2.08725605e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318617e+02 3.91853146e+02
 2.35450636e+02 1.51858786e+02 7.59209614e+01 6.49809863e+01
 1.10793186e+01 1.53426300e+01 2.78739678e+01 3.06488455e+01
 3.01232470e-01 1.02728598e+00 1.92029968e+00 4.12137168e+00
 3.90266694e+00 7.01513674e+00 7.06886475e+00 3.36257116e+01
 2.31874809e+01 1.48440140e+02 9.97850707e+01 9.20060433e+02
 2.63669249e-01 5.51199411e-01 2.41736222e+00 8.79349572e+00
 8.25569701e-01 2.29576047e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999656749759623
cond(S) = 1289.9122909996436
E1 = -183.59037592288055  E_coul = 55.0801451392117
init E= -128.510230783669
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406839978268  LUMO = 0.775763375436718
  mo_energy =
[-3.25551821e+01 -1.85274768e+00 -7.75406840e-01 -7.75406840e-01
 -7.75406840e-01  7.75763375e-01  8.14785652e-01  8.14785652e-01
  8.14785652e-01  3.91307984e+00  3.91307984e+00  3.91307984e+00
  4.19382293e+00  1.42184056e+01  1.42184056e+01  1.42184056e+01
  1.42704601e+01  4.67728142e+01  5.27804156e+01  5.27804156e+01
  5.27804156e+01  1.53889094e+02  2.40663981e+02  2.40663981e+02
  2.40663981e+02  5.17368329e+02  1.88290022e+03  8.01083855e+03
  4.77766523e+04]
E1 = -182.08394347427287  E_coul = 53.54560837645372
cycle= 1 E= -128.538335097819  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520091
diis-c [-0.270495  1.      ]
  HOMO = -0.884487031262327  LUMO = 0.747498554513563
  mo_energy =
[-3.28787326e+01 -1.96683286e+00 -8.84487031e-01 -8.84487031e-01
 -8.84487031e-01  7.47498555e-01  7.88328359e-01  7.88328359e-01
  7.88328359e-01  3.81620355e+00  3.81620355e+00  3.81620355e+00
  4.11347344e+00  1.40279647e+01  1.40279647e+01  1.40279647e+01
  1.41112602e+01  4.65209172e+01  5.24990958e+01  5.24990958e+01
  5.24990958e+01  1.53571764e+02  2.40317261e+02  2.40317261e+02
  2.40317261e+02  5.17006977e+02  1.88250239e+03  8.01041153e+03
  4.77762064e+04]
E1 = -182.84669905950673  E_coul = 54.3057710724065
cycle= 2 E= -128.5409279871  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264521
diis-c [-0.00069922  0.33630357  0.66369643]
  HOMO = -0.848805527024183  LUMO = 0.756532095464776
  mo_energy =
[-3.27704918e+01 -1.92925956e+00 -8.48805527e-01 -8.48805527e-01
 -8.48805527e-01  7.56532095e-01  7.96950572e-01  7.96950572e-01
  7.96950572e-01  3.84761968e+00  3.84761968e+00  3.84761968e+00
  4.13947012e+00  1.40910505e+01  1.40910505e+01  1.40910505e+01
  1.41637062e+01  4.66053111e+01  5.25932535e+01  5.25932535e+01
  5.25932535e+01  1.53677632e+02  2.40431091e+02  2.40431091e+02
  2.40431091e+02  5.17123774e+02  1.88262458e+03  8.01053621e+03
  4.77763320e+04]
E1 = -182.587490343618  E_coul = 54.04563891781362
cycle= 3 E= -128.541851425804  delta_E= -0.000923  |g|= 0.000515  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113216
diis-c [-1.95887048e-07 -2.37103524e-03 -7.19889500e-04  1.00309092e+00]
  HOMO = -0.849065908725798  LUMO = 0.756478257467998
  mo_energy =
[-3.27709512e+01 -1.92945667e+00 -8.49065909e-01 -8.49065909e-01
 -8.49065909e-01  7.56478257e-01  7.96909921e-01  7.96909921e-01
  7.96909921e-01  3.84743975e+00  3.84743975e+00  3.84743975e+00
  4.13932483e+00  1.40907423e+01  1.40907423e+01  1.40907423e+01
  1.41634421e+01  4.66049448e+01  5.25928471e+01  5.25928471e+01
  5.25928471e+01  1.53677170e+02  2.40430560e+02  2.40430560e+02
  2.40430560e+02  5.17123188e+02  1.88262386e+03  8.01053539e+03
  4.77763311e+04]
E1 = -182.58792378522935  E_coul = 54.046072332871965
cycle= 4 E= -128.541851452357  delta_E= -2.66e-08  |g|= 8.06e-05  |ddm|= 0.000364
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185481
diis-c [-1.09299672e-09  2.31504309e-04  4.95185730e-04 -1.82976363e-01
  1.18224967e+00]
  HOMO = -0.849109599681813  LUMO = 0.756465002328423
  mo_energy =
[-3.27710248e+01 -1.92949017e+00 -8.49109600e-01 -8.49109600e-01
 -8.49109600e-01  7.56465002e-01  7.96896398e-01  7.96896398e-01
  7.96896398e-01  3.84739911e+00  3.84739911e+00  3.84739911e+00
  4.13929289e+00  1.40906822e+01  1.40906822e+01  1.40906822e+01
  1.41633888e+01  4.66048783e+01  5.25927774e+01  5.25927774e+01
  5.25927774e+01  1.53677096e+02  2.40430482e+02  2.40430482e+02
  2.40430482e+02  5.17123106e+02  1.88262377e+03  8.01053529e+03
  4.77763310e+04]
E1 = -182.58805526986723  E_coul = 54.04620381679168
cycle= 5 E= -128.541851453076  delta_E= -7.18e-10  |g|= 5.82e-06  |ddm|= 6.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58805526986723  E_coul = 54.04620381679168
  HOMO = -0.849106545221788  LUMO = 0.756466262599814
  mo_energy =
[-3.27710179e+01 -1.92948633e+00 -8.49106545e-01 -8.49106545e-01
 -8.49106545e-01  7.56466263e-01  7.96897282e-01  7.96897282e-01
  7.96897282e-01  3.84740201e+00  3.84740201e+00  3.84740201e+00
  4.13929567e+00  1.40906872e+01  1.40906872e+01  1.40906872e+01
  1.41633934e+01  4.66048844e+01  5.25927839e+01  5.25927839e+01
  5.25927839e+01  1.53677102e+02  2.40430489e+02  2.40430489e+02
  2.40430489e+02  5.17123113e+02  1.88262378e+03  8.01053530e+03
  4.77763310e+04]
E1 = -182.58803951286538  E_coul = 54.04618805978721
Extra cycle  E= -128.541851453078  delta_E= -2.61e-12  |g|= 2.21e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1289.9122909996436
E1 = -182.58803951286538  E_coul = 54.04618805978721
init E= -128.541851453078
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.849107661075544  LUMO = 0.7564660589186
  mo_energy =
[-3.27710213e+01 -1.92948736e+00 -8.49107661e-01 -8.49107661e-01
 -8.49107661e-01  7.56466059e-01  7.96897030e-01  7.96897030e-01
  7.96897030e-01  3.84740106e+00  3.84740106e+00  3.84740106e+00
  4.13929495e+00  1.40906852e+01  1.40906852e+01  1.40906852e+01
  1.41633918e+01  4.66048817e+01  5.25927809e+01  5.25927809e+01
  5.25927809e+01  1.53677099e+02  2.40430485e+02  2.40430485e+02
  2.40430485e+02  5.17123109e+02  1.88262377e+03  8.01053529e+03
  4.77763310e+04]
E1 = -182.58804825225224  E_coul = 54.0461967991739
cycle= 1 E= -128.541851453078  delta_E= -1.71e-13  |g|= 1.2e-06  |ddm|= 7.88e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58804825225224  E_coul = 54.0461967991739
  HOMO = -0.849107045878192  LUMO = 0.756466230633459
  mo_energy =
[-3.27710195e+01 -1.92948669e+00 -8.49107046e-01 -8.49107046e-01
 -8.49107046e-01  7.56466231e-01  7.96897182e-01  7.96897182e-01
  7.96897182e-01  3.84740160e+00  3.84740160e+00  3.84740160e+00
  4.13929541e+00  1.40906863e+01  1.40906863e+01  1.40906863e+01
  1.41633927e+01  4.66048832e+01  5.25927825e+01  5.25927825e+01
  5.25927825e+01  1.53677101e+02  2.40430487e+02  2.40430487e+02
  2.40430487e+02  5.17123111e+02  1.88262377e+03  8.01053530e+03
  4.77763310e+04]
E1 = -182.5880438554818  E_coul = 54.04619240240309
Extra cycle  E= -128.541851453079  delta_E= -3.98e-13  |g|= 5.97e-07  |ddm|= 3.87e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [7.75200908e-01 2.44137942e+04 3.66145162e+03 8.33318617e+02
 2.35450636e+02 7.59209614e+01 1.10793186e+01 2.78739678e+01
 3.01232470e-01 1.92029968e+00 3.90266694e+00 7.06886475e+00
 2.31874809e+01 9.97850707e+01 2.63669249e-01 2.41736222e+00
 8.25569701e-01]
grad_E = [-2.97166027e-05 -2.32174086e-09  1.22350870e-07 -2.37892562e-06
  2.44307552e-05 -9.75627210e-05  4.01416283e-05  2.85542955e-05
  1.02208844e-04  6.05528282e-06 -9.78482619e-05 -9.71089800e-05
  4.92391750e-05 -2.61654345e-06 -1.59394779e-03 -2.75484517e-04
  6.31709794e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.778705251697       1
[INPUT] 0    0    [1    /1   ]  24413.7941855        1
[INPUT] 0    0    [1    /1   ]  3661.45161767        1
[INPUT] 0    0    [1    /1   ]  833.318729961        1
[INPUT] 0    0    [1    /1   ]  235.449487602        1
[INPUT] 0    0    [1    /1   ]  75.9221390329        1
[INPUT] 0    0    [1    /1   ]  11.1038333609        1
[INPUT] 0    0    [1    /1   ]  27.8891294679        1
[INPUT] 0    0    [1    /1   ]  0.301954869746       1
[INPUT] 0    0    [1    /1   ]  1.93346768945        1
[INPUT] 0    0    [1    /1   ]  3.92820603125        1
[INPUT] 1    0    [1    /1   ]  7.08094141531        1
[INPUT] 1    0    [1    /1   ]  23.18311424          1
[INPUT] 1    0    [1    /1   ]  99.7852860187        1
[INPUT] 1    0    [1    /1   ]  0.263656070917       1
[INPUT] 1    0    [1    /1   ]  2.42262621504        1
[INPUT] 1    0    [1    /1   ]  0.826993696185       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.778705251696903, 1.0]], [0, [24413.794185474282, 1.0]], [0, [3661.4516176708485, 1.0]], [0, [833.318729960922, 1.0]], [0, [235.44948760207245, 1.0]], [0, [75.92213903289401, 1.0]], [0, [11.103833360929647, 1.0]], [0, [27.889129467888278, 1.0]], [0, [0.30195486974638436, 1.0]], [0, [1.933467689447015, 1.0]], [0, [3.928206031251766, 1.0]], [1, [7.080941415307399, 1.0]], [1, [23.183114240004766, 1.0]], [1, [99.785286018668, 1.0]], [1, [0.26365607091706805, 1.0]], [1, [2.422626215042561, 1.0]], [1, [0.8269936961849218, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77870525]
bas 1, expnt(s) = [24413.79418547]
bas 2, expnt(s) = [3661.45161767]
bas 3, expnt(s) = [833.31872996]
bas 4, expnt(s) = [235.4494876]
bas 5, expnt(s) = [75.92213903]
bas 6, expnt(s) = [11.10383336]
bas 7, expnt(s) = [27.88912947]
bas 8, expnt(s) = [0.30195487]
bas 9, expnt(s) = [1.93346769]
bas 10, expnt(s) = [3.92820603]
bas 11, expnt(s) = [7.08094142]
bas 12, expnt(s) = [23.18311424]
bas 13, expnt(s) = [99.78528602]
bas 14, expnt(s) = [0.26365607]
bas 15, expnt(s) = [2.42262622]
bas 16, expnt(s) = [0.8269937]
CPU time:       248.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.78705252e-01 2.09432874e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318730e+02 3.91853186e+02
 2.35449488e+02 1.51858231e+02 7.59221390e+01 6.49817422e+01
 1.11038334e+01 1.53680840e+01 2.78891295e+01 3.06613479e+01
 3.01954870e-01 1.02913311e+00 1.93346769e+00 4.14254957e+00
 3.92820603e+00 7.04953900e+00 7.08094142e+00 3.36975359e+01
 2.31831142e+01 1.48405198e+02 9.97852860e+01 9.20062914e+02
 2.63656071e-01 5.51164976e-01 2.42262622e+00 8.81743787e+00
 8.26993696e-01 2.30071138e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999654670072353
cond(S) = 1298.5005882028872
E1 = -183.59035933443158  E_coul = 55.08014230724593
init E= -128.510217027186
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775407225405065  LUMO = 0.779583875451605
  mo_energy =
[-3.25551829e+01 -1.85274817e+00 -7.75407225e-01 -7.75407225e-01
 -7.75407225e-01  7.79583875e-01  8.15224979e-01  8.15224979e-01
  8.15224979e-01  3.91945305e+00  3.91945305e+00  3.91945305e+00
  4.21986341e+00  1.42475872e+01  1.42475872e+01  1.42475872e+01
  1.43661744e+01  4.69804387e+01  5.28328274e+01  5.28328274e+01
  5.28328274e+01  1.54178225e+02  2.40703787e+02  2.40703787e+02
  2.40703787e+02  5.17676494e+02  1.88318803e+03  8.01109373e+03
  4.77768640e+04]
E1 = -182.0836279895598  E_coul = 53.54529121202591
cycle= 1 E= -128.538336777534  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520141
diis-c [-0.27054652  1.        ]
  HOMO = -0.884516023308581  LUMO = 0.751141713120687
  mo_energy =
[-3.28787732e+01 -1.96686538e+00 -8.84516023e-01 -8.84516023e-01
 -8.84516023e-01  7.51141713e-01  7.88718237e-01  7.88718237e-01
  7.88718237e-01  3.82238601e+00  3.82238601e+00  3.82238601e+00
  4.13905097e+00  1.40569502e+01  1.40569502e+01  1.40569502e+01
  1.42064389e+01  4.67283494e+01  5.25514681e+01  5.25514681e+01
  5.25514681e+01  1.53860853e+02  2.40357037e+02  2.40357037e+02
  2.40357037e+02  5.17315112e+02  1.88279017e+03  8.01066667e+03
  4.77764180e+04]
E1 = -182.8464891092759  E_coul = 54.30555901367552
cycle= 2 E= -128.5409300956  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0645
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264564
diis-c [-0.00070051  0.33631711  0.66368289]
  HOMO = -0.848830385457663  LUMO = 0.760226879436263
  mo_energy =
[-3.27705193e+01 -1.92928763e+00 -8.48830385e-01 -8.48830385e-01
 -8.48830385e-01  7.60226879e-01  7.97353435e-01  7.97353435e-01
  7.97353435e-01  3.85385861e+00  3.85385861e+00  3.85385861e+00
  4.16519460e+00  1.41200973e+01  1.41200973e+01  1.41200973e+01
  1.42590608e+01  4.68128043e+01  5.26456368e+01  5.26456368e+01
  5.26456368e+01  1.53966733e+02  2.40470878e+02  2.40470878e+02
  2.40470878e+02  5.17431920e+02  1.88291237e+03  8.01079136e+03
  4.77765436e+04]
E1 = -182.58720996179622  E_coul = 54.04535606113791
cycle= 3 E= -128.541853900658  delta_E= -0.000924  |g|= 0.000518  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113649
diis-c [-1.95314771e-07 -2.37859097e-03 -7.16135435e-04  1.00309473e+00]
  HOMO = -0.849092545759816  LUMO = 0.760171645139372
  mo_energy =
[-3.27709812e+01 -1.92948696e+00 -8.49092546e-01 -8.49092546e-01
 -8.49092546e-01  7.60171645e-01  7.97312015e-01  7.97312015e-01
  7.97312015e-01  3.85367654e+00  3.85367654e+00  3.85367654e+00
  4.16504679e+00  1.41197864e+01  1.41197864e+01  1.41197864e+01
  1.42587937e+01  4.68124353e+01  5.26452278e+01  5.26452278e+01
  5.26452278e+01  1.53966268e+02  2.40470345e+02  2.40470345e+02
  2.40470345e+02  5.17431332e+02  1.88291165e+03  8.01079054e+03
  4.77765427e+04]
E1 = -182.5876449156791  E_coul = 54.04579098824011
cycle= 4 E= -128.541853927439  delta_E= -2.68e-08  |g|= 8.09e-05  |ddm|= 0.000366
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185858
diis-c [-1.08323693e-09  2.29417990e-04  4.94291921e-04 -1.81804302e-01
  1.18108059e+00]
  HOMO = -0.849136455583822  LUMO = 0.760158161140884
  mo_energy =
[-3.27710552e+01 -1.92952081e+00 -8.49136456e-01 -8.49136456e-01
 -8.49136456e-01  7.60158161e-01  7.97298391e-01  7.97298391e-01
  7.97298391e-01  3.85363561e+00  3.85363561e+00  3.85363561e+00
  4.16501445e+00  1.41197260e+01  1.41197260e+01  1.41197260e+01
  1.42587400e+01  4.68123684e+01  5.26451578e+01  5.26451578e+01
  5.26451578e+01  1.53966194e+02  2.40470266e+02  2.40470266e+02
  2.40470266e+02  5.17431250e+02  1.88291156e+03  8.01079044e+03
  4.77765426e+04]
E1 = -182.58777665134377  E_coul = 54.04592272318573
cycle= 5 E= -128.541853928158  delta_E= -7.19e-10  |g|= 5.78e-06  |ddm|= 6.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58777665134377  E_coul = 54.04592272318573
  HOMO = -0.849133430494027  LUMO = 0.760159417493512
  mo_energy =
[-3.27710483e+01 -1.92951700e+00 -8.49133430e-01 -8.49133430e-01
 -8.49133430e-01  7.60159417e-01  7.97299268e-01  7.97299268e-01
  7.97299268e-01  3.85363849e+00  3.85363849e+00  3.85363849e+00
  4.16501722e+00  1.41197310e+01  1.41197310e+01  1.41197310e+01
  1.42587446e+01  4.68123745e+01  5.26451643e+01  5.26451643e+01
  5.26451643e+01  1.53966200e+02  2.40470273e+02  2.40470273e+02
  2.40470273e+02  5.17431256e+02  1.88291157e+03  8.01079045e+03
  4.77765426e+04]
E1 = -182.58776102039457  E_coul = 54.045907092234394
Extra cycle  E= -128.54185392816  delta_E= -2.13e-12  |g|= 2.2e-06  |ddm|= 2.1e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.78705252e-01 2.44137942e+04 3.66145162e+03 8.33318730e+02
 2.35449488e+02 7.59221390e+01 1.11038334e+01 2.78891295e+01
 3.01954870e-01 1.93346769e+00 3.92820603e+00 7.08094142e+00
 2.31831142e+01 9.97852860e+01 2.63656071e-01 2.42262622e+00
 8.26993696e-01]
E = -128.54185392816018
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.778705251697       1
[INPUT] 0    0    [1    /1   ]  24413.7941855        1
[INPUT] 0    0    [1    /1   ]  3661.45161767        1
[INPUT] 0    0    [1    /1   ]  833.318729961        1
[INPUT] 0    0    [1    /1   ]  235.449487602        1
[INPUT] 0    0    [1    /1   ]  75.9221390329        1
[INPUT] 0    0    [1    /1   ]  11.1038333609        1
[INPUT] 0    0    [1    /1   ]  27.8891294679        1
[INPUT] 0    0    [1    /1   ]  0.301954869746       1
[INPUT] 0    0    [1    /1   ]  1.93346768945        1
[INPUT] 0    0    [1    /1   ]  3.92820603125        1
[INPUT] 1    0    [1    /1   ]  7.08094141531        1
[INPUT] 1    0    [1    /1   ]  23.18311424          1
[INPUT] 1    0    [1    /1   ]  99.7852860187        1
[INPUT] 1    0    [1    /1   ]  0.263656070917       1
[INPUT] 1    0    [1    /1   ]  2.42262621504        1
[INPUT] 1    0    [1    /1   ]  0.826993696185       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.778705251696903, 1.0]], [0, [24413.794185474282, 1.0]], [0, [3661.4516176708485, 1.0]], [0, [833.318729960922, 1.0]], [0, [235.44948760207245, 1.0]], [0, [75.92213903289401, 1.0]], [0, [11.103833360929647, 1.0]], [0, [27.889129467888278, 1.0]], [0, [0.30195486974638436, 1.0]], [0, [1.933467689447015, 1.0]], [0, [3.928206031251766, 1.0]], [1, [7.080941415307399, 1.0]], [1, [23.183114240004766, 1.0]], [1, [99.785286018668, 1.0]], [1, [0.26365607091706805, 1.0]], [1, [2.422626215042561, 1.0]], [1, [0.8269936961849218, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77870525]
bas 1, expnt(s) = [24413.79418547]
bas 2, expnt(s) = [3661.45161767]
bas 3, expnt(s) = [833.31872996]
bas 4, expnt(s) = [235.4494876]
bas 5, expnt(s) = [75.92213903]
bas 6, expnt(s) = [11.10383336]
bas 7, expnt(s) = [27.88912947]
bas 8, expnt(s) = [0.30195487]
bas 9, expnt(s) = [1.93346769]
bas 10, expnt(s) = [3.92820603]
bas 11, expnt(s) = [7.08094142]
bas 12, expnt(s) = [23.18311424]
bas 13, expnt(s) = [99.78528602]
bas 14, expnt(s) = [0.26365607]
bas 15, expnt(s) = [2.42262622]
bas 16, expnt(s) = [0.8269937]
CPU time:       249.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.78705252e-01 2.09432874e+00 2.44137942e+04 4.93448103e+03
 3.66145162e+03 1.18920027e+03 8.33318730e+02 3.91853186e+02
 2.35449488e+02 1.51858231e+02 7.59221390e+01 6.49817422e+01
 1.11038334e+01 1.53680840e+01 2.78891295e+01 3.06613479e+01
 3.01954870e-01 1.02913311e+00 1.93346769e+00 4.14254957e+00
 3.92820603e+00 7.04953900e+00 7.08094142e+00 3.36975359e+01
 2.31831142e+01 1.48405198e+02 9.97852860e+01 9.20062914e+02
 2.63656071e-01 5.51164976e-01 2.42262622e+00 8.81743787e+00
 8.26993696e-01 2.30071138e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999654670072353
cond(S) = 1298.5005882028872
E1 = -183.59035933443158  E_coul = 55.08014230724593
init E= -128.510217027186
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775407225405065  LUMO = 0.779583875451605
  mo_energy =
[-3.25551829e+01 -1.85274817e+00 -7.75407225e-01 -7.75407225e-01
 -7.75407225e-01  7.79583875e-01  8.15224979e-01  8.15224979e-01
  8.15224979e-01  3.91945305e+00  3.91945305e+00  3.91945305e+00
  4.21986341e+00  1.42475872e+01  1.42475872e+01  1.42475872e+01
  1.43661744e+01  4.69804387e+01  5.28328274e+01  5.28328274e+01
  5.28328274e+01  1.54178225e+02  2.40703787e+02  2.40703787e+02
  2.40703787e+02  5.17676494e+02  1.88318803e+03  8.01109373e+03
  4.77768640e+04]
E1 = -182.0836279895598  E_coul = 53.54529121202591
cycle= 1 E= -128.538336777534  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520141
diis-c [-0.27054652  1.        ]
  HOMO = -0.884516023308581  LUMO = 0.751141713120687
  mo_energy =
[-3.28787732e+01 -1.96686538e+00 -8.84516023e-01 -8.84516023e-01
 -8.84516023e-01  7.51141713e-01  7.88718237e-01  7.88718237e-01
  7.88718237e-01  3.82238601e+00  3.82238601e+00  3.82238601e+00
  4.13905097e+00  1.40569502e+01  1.40569502e+01  1.40569502e+01
  1.42064389e+01  4.67283494e+01  5.25514681e+01  5.25514681e+01
  5.25514681e+01  1.53860853e+02  2.40357037e+02  2.40357037e+02
  2.40357037e+02  5.17315112e+02  1.88279017e+03  8.01066667e+03
  4.77764180e+04]
E1 = -182.8464891092759  E_coul = 54.30555901367552
cycle= 2 E= -128.5409300956  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264564
diis-c [-0.00070051  0.33631711  0.66368289]
  HOMO = -0.848830385457663  LUMO = 0.760226879436263
  mo_energy =
[-3.27705193e+01 -1.92928763e+00 -8.48830385e-01 -8.48830385e-01
 -8.48830385e-01  7.60226879e-01  7.97353435e-01  7.97353435e-01
  7.97353435e-01  3.85385861e+00  3.85385861e+00  3.85385861e+00
  4.16519460e+00  1.41200973e+01  1.41200973e+01  1.41200973e+01
  1.42590608e+01  4.68128043e+01  5.26456368e+01  5.26456368e+01
  5.26456368e+01  1.53966733e+02  2.40470878e+02  2.40470878e+02
  2.40470878e+02  5.17431920e+02  1.88291237e+03  8.01079136e+03
  4.77765436e+04]
E1 = -182.58720996179622  E_coul = 54.04535606113791
cycle= 3 E= -128.541853900658  delta_E= -0.000924  |g|= 0.000518  |ddm|= 0.0222
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00113649
diis-c [-1.95314771e-07 -2.37859097e-03 -7.16135435e-04  1.00309473e+00]
  HOMO = -0.849092545759816  LUMO = 0.760171645139372
  mo_energy =
[-3.27709812e+01 -1.92948696e+00 -8.49092546e-01 -8.49092546e-01
 -8.49092546e-01  7.60171645e-01  7.97312015e-01  7.97312015e-01
  7.97312015e-01  3.85367654e+00  3.85367654e+00  3.85367654e+00
  4.16504679e+00  1.41197864e+01  1.41197864e+01  1.41197864e+01
  1.42587937e+01  4.68124353e+01  5.26452278e+01  5.26452278e+01
  5.26452278e+01  1.53966268e+02  2.40470345e+02  2.40470345e+02
  2.40470345e+02  5.17431332e+02  1.88291165e+03  8.01079054e+03
  4.77765427e+04]
E1 = -182.5876449156791  E_coul = 54.04579098824011
cycle= 4 E= -128.541853927439  delta_E= -2.68e-08  |g|= 8.09e-05  |ddm|= 0.000366
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185858
diis-c [-1.08323693e-09  2.29417990e-04  4.94291921e-04 -1.81804302e-01
  1.18108059e+00]
  HOMO = -0.849136455583822  LUMO = 0.760158161140884
  mo_energy =
[-3.27710552e+01 -1.92952081e+00 -8.49136456e-01 -8.49136456e-01
 -8.49136456e-01  7.60158161e-01  7.97298391e-01  7.97298391e-01
  7.97298391e-01  3.85363561e+00  3.85363561e+00  3.85363561e+00
  4.16501445e+00  1.41197260e+01  1.41197260e+01  1.41197260e+01
  1.42587400e+01  4.68123684e+01  5.26451578e+01  5.26451578e+01
  5.26451578e+01  1.53966194e+02  2.40470266e+02  2.40470266e+02
  2.40470266e+02  5.17431250e+02  1.88291156e+03  8.01079044e+03
  4.77765426e+04]
E1 = -182.58777665134377  E_coul = 54.04592272318573
cycle= 5 E= -128.541853928158  delta_E= -7.19e-10  |g|= 5.78e-06  |ddm|= 6.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58777665134377  E_coul = 54.04592272318573
  HOMO = -0.849133430494027  LUMO = 0.760159417493512
  mo_energy =
[-3.27710483e+01 -1.92951700e+00 -8.49133430e-01 -8.49133430e-01
 -8.49133430e-01  7.60159417e-01  7.97299268e-01  7.97299268e-01
  7.97299268e-01  3.85363849e+00  3.85363849e+00  3.85363849e+00
  4.16501722e+00  1.41197310e+01  1.41197310e+01  1.41197310e+01
  1.42587446e+01  4.68123745e+01  5.26451643e+01  5.26451643e+01
  5.26451643e+01  1.53966200e+02  2.40470273e+02  2.40470273e+02
  2.40470273e+02  5.17431256e+02  1.88291157e+03  8.01079045e+03
  4.77765426e+04]
E1 = -182.58776102039457  E_coul = 54.045907092234394
Extra cycle  E= -128.54185392816  delta_E= -2.13e-12  |g|= 2.2e-06  |ddm|= 2.1e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1298.5005882028872
E1 = -182.58776102039457  E_coul = 54.045907092234394
init E= -128.54185392816
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.849134537828725  LUMO = 0.760159214331137
  mo_energy =
[-3.27710518e+01 -1.92951802e+00 -8.49134538e-01 -8.49134538e-01
 -8.49134538e-01  7.60159214e-01  7.97299017e-01  7.97299017e-01
  7.97299017e-01  3.85363753e+00  3.85363753e+00  3.85363753e+00
  4.16501649e+00  1.41197290e+01  1.41197290e+01  1.41197290e+01
  1.42587430e+01  4.68123719e+01  5.26451613e+01  5.26451613e+01
  5.26451613e+01  1.53966197e+02  2.40470269e+02  2.40470269e+02
  2.40470269e+02  5.17431252e+02  1.88291156e+03  8.01079044e+03
  4.77765426e+04]
E1 = -182.58776968889615  E_coul = 54.045915760735326
cycle= 1 E= -128.541853928161  delta_E= -6.54e-13  |g|= 1.19e-06  |ddm|= 7.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58776968889615  E_coul = 54.045915760735326
  HOMO = -0.84913392768532  LUMO = 0.760159385657806
  mo_energy =
[-3.27710499e+01 -1.92951735e+00 -8.49133928e-01 -8.49133928e-01
 -8.49133928e-01  7.60159386e-01  7.97299168e-01  7.97299168e-01
  7.97299168e-01  3.85363808e+00  3.85363808e+00  3.85363808e+00
  4.16501696e+00  1.41197301e+01  1.41197301e+01  1.41197301e+01
  1.42587439e+01  4.68123733e+01  5.26451629e+01  5.26451629e+01
  5.26451629e+01  1.53966199e+02  2.40470271e+02  2.40470271e+02
  2.40470271e+02  5.17431254e+02  1.88291156e+03  8.01079045e+03
  4.77765426e+04]
E1 = -182.58776532713802  E_coul = 54.04591139897714
Extra cycle  E= -128.541853928161  delta_E= -5.68e-14  |g|= 5.92e-07  |ddm|= 3.84e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [7.78705252e-01 2.44137942e+04 3.66145162e+03 8.33318730e+02
 2.35449488e+02 7.59221390e+01 1.11038334e+01 2.78891295e+01
 3.01954870e-01 1.93346769e+00 3.92820603e+00 7.08094142e+00
 2.31831142e+01 9.97852860e+01 2.63656071e-01 2.42262622e+00
 8.26993696e-01]
grad_E = [-4.12483038e-05 -2.31313065e-09  1.21894011e-07 -2.36971185e-06
  2.43010866e-05 -9.61547374e-05  5.13067895e-05  2.12285849e-05
  1.04460925e-04  1.33728227e-05 -9.95169481e-05 -2.35976034e-05
  3.11712172e-05 -1.74352813e-06 -2.79146380e-03 -4.00878990e-04
  1.14636394e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.782257000521       1
[INPUT] 0    0    [1    /1   ]  24413.794186         1
[INPUT] 0    0    [1    /1   ]  3661.45158962        1
[INPUT] 0    0    [1    /1   ]  833.319291414        1
[INPUT] 0    0    [1    /1   ]  235.443799407        1
[INPUT] 0    0    [1    /1   ]  75.9363492031        1
[INPUT] 0    0    [1    /1   ]  11.1570927881        1
[INPUT] 0    0    [1    /1   ]  27.9237401634        1
[INPUT] 0    0    [1    /1   ]  0.302323069683       1
[INPUT] 0    0    [1    /1   ]  1.95137107982        1
[INPUT] 0    0    [1    /1   ]  4.00623526969        1
[INPUT] 1    0    [1    /1   ]  7.09946288663        1
[INPUT] 1    0    [1    /1   ]  23.1764881563        1
[INPUT] 1    0    [1    /1   ]  99.7855924274        1
[INPUT] 1    0    [1    /1   ]  0.263749462629       1
[INPUT] 1    0    [1    /1   ]  2.43093767575        1
[INPUT] 1    0    [1    /1   ]  0.829342497385       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7822570005209544, 1.0]], [0, [24413.794185997584, 1.0]], [0, [3661.4515896187017, 1.0]], [0, [833.3192914137665, 1.0]], [0, [235.44379940687412, 1.0]], [0, [75.93634920309964, 1.0]], [0, [11.15709278810048, 1.0]], [0, [27.923740163412738, 1.0]], [0, [0.3023230696828112, 1.0]], [0, [1.9513710798159192, 1.0]], [0, [4.006235269689691, 1.0]], [1, [7.09946288662548, 1.0]], [1, [23.176488156345098, 1.0]], [1, [99.7855924273906, 1.0]], [1, [0.2637494626289626, 1.0]], [1, [2.430937675752128, 1.0]], [1, [0.8293424973853515, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.782257]
bas 1, expnt(s) = [24413.794186]
bas 2, expnt(s) = [3661.45158962]
bas 3, expnt(s) = [833.31929141]
bas 4, expnt(s) = [235.44379941]
bas 5, expnt(s) = [75.9363492]
bas 6, expnt(s) = [11.15709279]
bas 7, expnt(s) = [27.92374016]
bas 8, expnt(s) = [0.30232307]
bas 9, expnt(s) = [1.95137108]
bas 10, expnt(s) = [4.00623527]
bas 11, expnt(s) = [7.09946289]
bas 12, expnt(s) = [23.17648816]
bas 13, expnt(s) = [99.78559243]
bas 14, expnt(s) = [0.26374946]
bas 15, expnt(s) = [2.43093768]
bas 16, expnt(s) = [0.8293425]
CPU time:       252.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.82257001e-01 2.10148899e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319291e+02 3.91853384e+02
 2.35443799e+02 1.51855479e+02 7.59363492e+01 6.49908638e+01
 1.11570928e+01 1.54233356e+01 2.79237402e+01 3.06898818e+01
 3.02323070e-01 1.03007416e+00 1.95137108e+00 4.17128556e+00
 4.00623527e+00 7.15430353e+00 7.09946289e+00 3.38077493e+01
 2.31764882e+01 1.48352179e+02 9.97855924e+01 9.20066446e+02
 2.63749463e-01 5.51409027e-01 2.43093768e+00 8.85526726e+00
 8.29342497e-01 2.30888229e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999650864708794
cond(S) = 1292.475308087141
E1 = -183.59033659327739  E_coul = 55.08013783902763
init E= -128.51019875425
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775407442023097  LUMO = 0.783443778399475
  mo_energy =
[-3.25551862e+01 -1.85274892e+00 -7.75407442e-01 -7.75407442e-01
 -7.75407442e-01  7.83443778e-01  8.16256367e-01  8.16256367e-01
  8.16256367e-01  3.93021645e+00  3.93021645e+00  3.93021645e+00
  4.25619290e+00  1.42939401e+01  1.42939401e+01  1.42939401e+01
  1.45547000e+01  4.74428712e+01  5.29148878e+01  5.29148878e+01
  5.29148878e+01  1.54843225e+02  2.40766237e+02  2.40766237e+02
  2.40766237e+02  5.18405817e+02  1.88387758e+03  8.01170616e+03
  4.77773721e+04]
E1 = -182.08326374889106  E_coul = 53.54492199558914
cycle= 1 E= -128.538341753302  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520225
diis-c [-0.27063428  1.        ]
  HOMO = -0.884550611181614  LUMO = 0.754797592547348
  mo_energy =
[-3.28788190e+01 -1.96690359e+00 -8.84550611e-01 -8.84550611e-01
 -8.84550611e-01  7.54797593e-01  7.89665452e-01  7.89665452e-01
  7.89665452e-01  3.83285816e+00  3.83285816e+00  3.83285816e+00
  4.17457650e+00  1.41030179e+01  1.41030179e+01  1.41030179e+01
  1.43937252e+01  4.71903348e+01  5.26334867e+01  5.26334867e+01
  5.26334867e+01  1.54525793e+02  2.40419459e+02  2.40419459e+02
  2.40419459e+02  5.18044409e+02  1.88347968e+03  8.01127906e+03
  4.77769261e+04]
E1 = -182.84622146584888  E_coul = 54.30528599310869
cycle= 2 E= -128.54093547274  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0646
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264633
diis-c [-0.00070339  0.33633667  0.66366333]
  HOMO = -0.848861759850653  LUMO = 0.763940747929494
  mo_energy =
[-3.27705535e+01 -1.92932241e+00 -8.48861760e-01 -8.48861760e-01
 -8.48861760e-01  7.63940748e-01  7.98323613e-01  7.98323613e-01
  7.98323613e-01  3.86441752e+00  3.86441752e+00  3.86441752e+00
  4.20097743e+00  1.41662530e+01  1.41662530e+01  1.41662530e+01
  1.44467599e+01  4.72749343e+01  5.27276643e+01  5.27276643e+01
  5.27276643e+01  1.54631687e+02  2.40533309e+02  2.40533309e+02
  2.40533309e+02  5.18161224e+02  1.88360189e+03  8.01140376e+03
  4.77770517e+04]
E1 = -182.58686737049143  E_coul = 54.04500770731229
cycle= 3 E= -128.541859663179  delta_E= -0.000924  |g|= 0.000522  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114086
diis-c [-1.94967786e-07 -2.39094781e-03 -7.22475851e-04  1.00311342e+00]
  HOMO = -0.849126084692907  LUMO = 0.763883762396381
  mo_energy =
[-3.27710180e+01 -1.92952439e+00 -8.49126085e-01 -8.49126085e-01
 -8.49126085e-01  7.63883762e-01  7.98281176e-01  7.98281176e-01
  7.98281176e-01  3.86423269e+00  3.86423269e+00  3.86423269e+00
  4.20082618e+00  1.41659391e+01  1.41659391e+01  1.41659391e+01
  1.44464885e+01  4.72745621e+01  5.27272526e+01  5.27272526e+01
  5.27272526e+01  1.54631220e+02  2.40532773e+02  2.40532773e+02
  2.40532773e+02  5.18160633e+02  1.88360117e+03  8.01140293e+03
  4.77770509e+04]
E1 = -182.58730232884741  E_coul = 54.04544263858605
cycle= 4 E= -128.541859690261  delta_E= -2.71e-08  |g|= 8.14e-05  |ddm|= 0.000367
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186496
diis-c [-1.07275686e-09  2.26849777e-04  4.94661743e-04 -1.80397266e-01
  1.17967575e+00]
  HOMO = -0.849170306159853  LUMO = 0.763869987830983
  mo_energy =
[-3.27710924e+01 -1.92955871e+00 -8.49170306e-01 -8.49170306e-01
 -8.49170306e-01  7.63869988e-01  7.98267401e-01  7.98267401e-01
  7.98267401e-01  3.86419134e+00  3.86419134e+00  3.86419134e+00
  4.20079324e+00  1.41658782e+01  1.41658782e+01  1.41658782e+01
  1.44464341e+01  4.72744946e+01  5.27271821e+01  5.27271821e+01
  5.27271821e+01  1.54631145e+02  2.40532695e+02  2.40532695e+02
  2.40532695e+02  5.18160551e+02  1.88360108e+03  8.01140283e+03
  4.77770508e+04]
E1 = -182.58743447910305  E_coul = 54.04557478812073
cycle= 5 E= -128.541859690982  delta_E= -7.21e-10  |g|= 5.73e-06  |ddm|= 6.09e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58743447910305  E_coul = 54.04557478812073
  HOMO = -0.849167313460611  LUMO = 0.763871240530982
  mo_energy =
[-3.27710856e+01 -1.92955493e+00 -8.49167313e-01 -8.49167313e-01
 -8.49167313e-01  7.63871241e-01  7.98268271e-01  7.98268271e-01
  7.98268271e-01  3.86419420e+00  3.86419420e+00  3.86419420e+00
  4.20079600e+00  1.41658831e+01  1.41658831e+01  1.41658831e+01
  1.44464386e+01  4.72745007e+01  5.27271885e+01  5.27271885e+01
  5.27271885e+01  1.54631152e+02  2.40532701e+02  2.40532701e+02
  2.40532701e+02  5.18160557e+02  1.88360108e+03  8.01140284e+03
  4.77770508e+04]
E1 = -182.5874189890416  E_coul = 54.04555929805704
Extra cycle  E= -128.541859690985  delta_E= -2.22e-12  |g|= 2.18e-06  |ddm|= 2.09e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.82257001e-01 2.44137942e+04 3.66145159e+03 8.33319291e+02
 2.35443799e+02 7.59363492e+01 1.11570928e+01 2.79237402e+01
 3.02323070e-01 1.95137108e+00 4.00623527e+00 7.09946289e+00
 2.31764882e+01 9.97855924e+01 2.63749463e-01 2.43093768e+00
 8.29342497e-01]
E = -128.54185969098455
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.782257000521       1
[INPUT] 0    0    [1    /1   ]  24413.794186         1
[INPUT] 0    0    [1    /1   ]  3661.45158962        1
[INPUT] 0    0    [1    /1   ]  833.319291414        1
[INPUT] 0    0    [1    /1   ]  235.443799407        1
[INPUT] 0    0    [1    /1   ]  75.9363492031        1
[INPUT] 0    0    [1    /1   ]  11.1570927881        1
[INPUT] 0    0    [1    /1   ]  27.9237401634        1
[INPUT] 0    0    [1    /1   ]  0.302323069683       1
[INPUT] 0    0    [1    /1   ]  1.95137107982        1
[INPUT] 0    0    [1    /1   ]  4.00623526969        1
[INPUT] 1    0    [1    /1   ]  7.09946288663        1
[INPUT] 1    0    [1    /1   ]  23.1764881563        1
[INPUT] 1    0    [1    /1   ]  99.7855924274        1
[INPUT] 1    0    [1    /1   ]  0.263749462629       1
[INPUT] 1    0    [1    /1   ]  2.43093767575        1
[INPUT] 1    0    [1    /1   ]  0.829342497385       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7822570005209544, 1.0]], [0, [24413.794185997584, 1.0]], [0, [3661.4515896187017, 1.0]], [0, [833.3192914137665, 1.0]], [0, [235.44379940687412, 1.0]], [0, [75.93634920309964, 1.0]], [0, [11.15709278810048, 1.0]], [0, [27.923740163412738, 1.0]], [0, [0.3023230696828112, 1.0]], [0, [1.9513710798159192, 1.0]], [0, [4.006235269689691, 1.0]], [1, [7.09946288662548, 1.0]], [1, [23.176488156345098, 1.0]], [1, [99.7855924273906, 1.0]], [1, [0.2637494626289626, 1.0]], [1, [2.430937675752128, 1.0]], [1, [0.8293424973853515, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.782257]
bas 1, expnt(s) = [24413.794186]
bas 2, expnt(s) = [3661.45158962]
bas 3, expnt(s) = [833.31929141]
bas 4, expnt(s) = [235.44379941]
bas 5, expnt(s) = [75.9363492]
bas 6, expnt(s) = [11.15709279]
bas 7, expnt(s) = [27.92374016]
bas 8, expnt(s) = [0.30232307]
bas 9, expnt(s) = [1.95137108]
bas 10, expnt(s) = [4.00623527]
bas 11, expnt(s) = [7.09946289]
bas 12, expnt(s) = [23.17648816]
bas 13, expnt(s) = [99.78559243]
bas 14, expnt(s) = [0.26374946]
bas 15, expnt(s) = [2.43093768]
bas 16, expnt(s) = [0.8293425]
CPU time:       253.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.82257001e-01 2.10148899e+00 2.44137942e+04 4.93448103e+03
 3.66145159e+03 1.18920026e+03 8.33319291e+02 3.91853384e+02
 2.35443799e+02 1.51855479e+02 7.59363492e+01 6.49908638e+01
 1.11570928e+01 1.54233356e+01 2.79237402e+01 3.06898818e+01
 3.02323070e-01 1.03007416e+00 1.95137108e+00 4.17128556e+00
 4.00623527e+00 7.15430353e+00 7.09946289e+00 3.38077493e+01
 2.31764882e+01 1.48352179e+02 9.97855924e+01 9.20066446e+02
 2.63749463e-01 5.51409027e-01 2.43093768e+00 8.85526726e+00
 8.29342497e-01 2.30888229e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999650864708794
cond(S) = 1292.475308087141
E1 = -183.59033659327739  E_coul = 55.08013783902763
init E= -128.51019875425
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775407442023097  LUMO = 0.783443778399475
  mo_energy =
[-3.25551862e+01 -1.85274892e+00 -7.75407442e-01 -7.75407442e-01
 -7.75407442e-01  7.83443778e-01  8.16256367e-01  8.16256367e-01
  8.16256367e-01  3.93021645e+00  3.93021645e+00  3.93021645e+00
  4.25619290e+00  1.42939401e+01  1.42939401e+01  1.42939401e+01
  1.45547000e+01  4.74428712e+01  5.29148878e+01  5.29148878e+01
  5.29148878e+01  1.54843225e+02  2.40766237e+02  2.40766237e+02
  2.40766237e+02  5.18405817e+02  1.88387758e+03  8.01170616e+03
  4.77773721e+04]
E1 = -182.08326374889106  E_coul = 53.54492199558914
cycle= 1 E= -128.538341753302  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520225
diis-c [-0.27063428  1.        ]
  HOMO = -0.884550611181614  LUMO = 0.754797592547348
  mo_energy =
[-3.28788190e+01 -1.96690359e+00 -8.84550611e-01 -8.84550611e-01
 -8.84550611e-01  7.54797593e-01  7.89665452e-01  7.89665452e-01
  7.89665452e-01  3.83285816e+00  3.83285816e+00  3.83285816e+00
  4.17457650e+00  1.41030179e+01  1.41030179e+01  1.41030179e+01
  1.43937252e+01  4.71903348e+01  5.26334867e+01  5.26334867e+01
  5.26334867e+01  1.54525793e+02  2.40419459e+02  2.40419459e+02
  2.40419459e+02  5.18044409e+02  1.88347968e+03  8.01127906e+03
  4.77769261e+04]
E1 = -182.84622146584888  E_coul = 54.30528599310869
cycle= 2 E= -128.54093547274  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0646
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264633
diis-c [-0.00070339  0.33633667  0.66366333]
  HOMO = -0.848861759850653  LUMO = 0.763940747929494
  mo_energy =
[-3.27705535e+01 -1.92932241e+00 -8.48861760e-01 -8.48861760e-01
 -8.48861760e-01  7.63940748e-01  7.98323613e-01  7.98323613e-01
  7.98323613e-01  3.86441752e+00  3.86441752e+00  3.86441752e+00
  4.20097743e+00  1.41662530e+01  1.41662530e+01  1.41662530e+01
  1.44467599e+01  4.72749343e+01  5.27276643e+01  5.27276643e+01
  5.27276643e+01  1.54631687e+02  2.40533309e+02  2.40533309e+02
  2.40533309e+02  5.18161224e+02  1.88360189e+03  8.01140376e+03
  4.77770517e+04]
E1 = -182.58686737049143  E_coul = 54.04500770731229
cycle= 3 E= -128.541859663179  delta_E= -0.000924  |g|= 0.000522  |ddm|= 0.0223
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00114086
diis-c [-1.94967786e-07 -2.39094781e-03 -7.22475851e-04  1.00311342e+00]
  HOMO = -0.849126084692907  LUMO = 0.763883762396381
  mo_energy =
[-3.27710180e+01 -1.92952439e+00 -8.49126085e-01 -8.49126085e-01
 -8.49126085e-01  7.63883762e-01  7.98281176e-01  7.98281176e-01
  7.98281176e-01  3.86423269e+00  3.86423269e+00  3.86423269e+00
  4.20082618e+00  1.41659391e+01  1.41659391e+01  1.41659391e+01
  1.44464885e+01  4.72745621e+01  5.27272526e+01  5.27272526e+01
  5.27272526e+01  1.54631220e+02  2.40532773e+02  2.40532773e+02
  2.40532773e+02  5.18160633e+02  1.88360117e+03  8.01140293e+03
  4.77770509e+04]
E1 = -182.58730232884741  E_coul = 54.04544263858605
cycle= 4 E= -128.541859690261  delta_E= -2.71e-08  |g|= 8.14e-05  |ddm|= 0.000367
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186496
diis-c [-1.07275686e-09  2.26849777e-04  4.94661743e-04 -1.80397266e-01
  1.17967575e+00]
  HOMO = -0.849170306159853  LUMO = 0.763869987830983
  mo_energy =
[-3.27710924e+01 -1.92955871e+00 -8.49170306e-01 -8.49170306e-01
 -8.49170306e-01  7.63869988e-01  7.98267401e-01  7.98267401e-01
  7.98267401e-01  3.86419134e+00  3.86419134e+00  3.86419134e+00
  4.20079324e+00  1.41658782e+01  1.41658782e+01  1.41658782e+01
  1.44464341e+01  4.72744946e+01  5.27271821e+01  5.27271821e+01
  5.27271821e+01  1.54631145e+02  2.40532695e+02  2.40532695e+02
  2.40532695e+02  5.18160551e+02  1.88360108e+03  8.01140283e+03
  4.77770508e+04]
E1 = -182.58743447910305  E_coul = 54.04557478812073
cycle= 5 E= -128.541859690982  delta_E= -7.21e-10  |g|= 5.73e-06  |ddm|= 6.09e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58743447910305  E_coul = 54.04557478812073
  HOMO = -0.849167313460611  LUMO = 0.763871240530982
  mo_energy =
[-3.27710856e+01 -1.92955493e+00 -8.49167313e-01 -8.49167313e-01
 -8.49167313e-01  7.63871241e-01  7.98268271e-01  7.98268271e-01
  7.98268271e-01  3.86419420e+00  3.86419420e+00  3.86419420e+00
  4.20079600e+00  1.41658831e+01  1.41658831e+01  1.41658831e+01
  1.44464386e+01  4.72745007e+01  5.27271885e+01  5.27271885e+01
  5.27271885e+01  1.54631152e+02  2.40532701e+02  2.40532701e+02
  2.40532701e+02  5.18160557e+02  1.88360108e+03  8.01140284e+03
  4.77770508e+04]
E1 = -182.5874189890416  E_coul = 54.04555929805704
Extra cycle  E= -128.541859690985  delta_E= -2.22e-12  |g|= 2.18e-06  |ddm|= 2.09e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1292.475308087141
E1 = -182.5874189890416  E_coul = 54.04555929805704
init E= -128.541859690985
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.849168411283475  LUMO = 0.763871038034586
  mo_energy =
[-3.27710890e+01 -1.92955595e+00 -8.49168411e-01 -8.49168411e-01
 -8.49168411e-01  7.63871038e-01  7.98268022e-01  7.98268022e-01
  7.98268022e-01  3.86419325e+00  3.86419325e+00  3.86419325e+00
  4.20079528e+00  1.41658812e+01  1.41658812e+01  1.41658812e+01
  1.44464370e+01  4.72744980e+01  5.27271856e+01  5.27271856e+01
  5.27271856e+01  1.54631149e+02  2.40532697e+02  2.40532697e+02
  2.40532697e+02  5.18160553e+02  1.88360108e+03  8.01140284e+03
  4.77770508e+04]
E1 = -182.5874275787864  E_coul = 54.045567887801454
cycle= 1 E= -128.541859690985  delta_E= -3.98e-13  |g|= 1.18e-06  |ddm|= 7.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5874275787864  E_coul = 54.045567887801454
  HOMO = -0.849167806761025  LUMO = 0.763871208946198
  mo_energy =
[-3.27710872e+01 -1.92955528e+00 -8.49167807e-01 -8.49167807e-01
 -8.49167807e-01  7.63871209e-01  7.98268172e-01  7.98268172e-01
  7.98268172e-01  3.86419380e+00  3.86419380e+00  3.86419380e+00
  4.20079574e+00  1.41658823e+01  1.41658823e+01  1.41658823e+01
  1.44464379e+01  4.72744995e+01  5.27271871e+01  5.27271871e+01
  5.27271871e+01  1.54631150e+02  2.40532699e+02  2.40532699e+02
  2.40532699e+02  5.18160555e+02  1.88360108e+03  8.01140284e+03
  4.77770508e+04]
E1 = -182.58742325591794  E_coul = 54.045563564932564
Extra cycle  E= -128.541859690985  delta_E= -4.26e-13  |g|= 5.87e-07  |ddm|= 3.82e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [7.82257001e-01 2.44137942e+04 3.66145159e+03 8.33319291e+02
 2.35443799e+02 7.59363492e+01 1.11570928e+01 2.79237402e+01
 3.02323070e-01 1.95137108e+00 4.00623527e+00 7.09946289e+00
 2.31764882e+01 9.97855924e+01 2.63749463e-01 2.43093768e+00
 8.29342497e-01]
grad_E = [-4.88321703e-05 -2.26744551e-09  1.19510903e-07 -2.32580240e-06
  2.38424789e-05 -9.31026755e-05  6.51839541e-05  9.24086699e-06
  7.57422817e-05  2.41055828e-05 -9.76971931e-05  7.92644513e-05
  4.65790959e-06 -4.40364327e-07 -4.40110884e-03 -5.63354236e-04
  1.84718045e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.782637588905       1
[INPUT] 0    0    [1    /1   ]  24413.7941876        1
[INPUT] 0    0    [1    /1   ]  3661.45150358        1
[INPUT] 0    0    [1    /1   ]  833.320997249        1
[INPUT] 0    0    [1    /1   ]  235.426510794        1
[INPUT] 0    0    [1    /1   ]  75.9859667839        1
[INPUT] 0    0    [1    /1   ]  11.2679298003        1
[INPUT] 0    0    [1    /1   ]  27.9977315807        1
[INPUT] 0    0    [1    /1   ]  0.301296190148       1
[INPUT] 0    0    [1    /1   ]  1.96823568766        1
[INPUT] 0    0    [1    /1   ]  4.20636648762        1
[INPUT] 1    0    [1    /1   ]  7.12585288126        1
[INPUT] 1    0    [1    /1   ]  23.1672302833        1
[INPUT] 1    0    [1    /1   ]  99.7859731922        1
[INPUT] 1    0    [1    /1   ]  0.2641078445         1
[INPUT] 1    0    [1    /1   ]  2.44320370516        1
[INPUT] 1    0    [1    /1   ]  0.83298137617        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7826375889048154, 1.0]], [0, [24413.794187610732, 1.0]], [0, [3661.4515035764034, 1.0]], [0, [833.3209972489901, 1.0]], [0, [235.42651079354584, 1.0]], [0, [75.98596678385962, 1.0]], [0, [11.267929800251238, 1.0]], [0, [27.9977315806997, 1.0]], [0, [0.30129619014760944, 1.0]], [0, [1.9682356876555862, 1.0]], [0, [4.206366487619127, 1.0]], [1, [7.125852881257825, 1.0]], [1, [23.167230283298206, 1.0]], [1, [99.7859731922466, 1.0]], [1, [0.2641078445002103, 1.0]], [1, [2.443203705155352, 1.0]], [1, [0.8329813761695105, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78263759]
bas 1, expnt(s) = [24413.79418761]
bas 2, expnt(s) = [3661.45150358]
bas 3, expnt(s) = [833.32099725]
bas 4, expnt(s) = [235.42651079]
bas 5, expnt(s) = [75.98596678]
bas 6, expnt(s) = [11.2679298]
bas 7, expnt(s) = [27.99773158]
bas 8, expnt(s) = [0.30129619]
bas 9, expnt(s) = [1.96823569]
bas 10, expnt(s) = [4.20636649]
bas 11, expnt(s) = [7.12585288]
bas 12, expnt(s) = [23.16723028]
bas 13, expnt(s) = [99.78597319]
bas 14, expnt(s) = [0.26410784]
bas 15, expnt(s) = [2.44320371]
bas 16, expnt(s) = [0.83298138]
CPU time:       257.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.82637589e-01 2.10225576e+00 2.44137942e+04 4.93448103e+03
 3.66145150e+03 1.18920024e+03 8.33320997e+02 3.91853985e+02
 2.35426511e+02 1.51847116e+02 7.59859668e+01 6.50227105e+01
 1.12679298e+01 1.55381076e+01 2.79977316e+01 3.07508524e+01
 3.01296190e-01 1.02744895e+00 1.96823569e+00 4.19829402e+00
 4.20636649e+00 7.42070822e+00 7.12585288e+00 3.39649091e+01
 2.31672303e+01 1.48278108e+02 9.97859732e+01 9.20070834e+02
 2.64107845e-01 5.52345752e-01 2.44320371e+00 8.91115485e+00
 8.32981376e-01 2.32155249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999644465017967
cond(S) = 1252.0471149676248
E1 = -183.5903128902052  E_coul = 55.08013053298385
init E= -128.510182357221
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775407193383347  LUMO = 0.784132753894166
  mo_energy =
[-3.25551949e+01 -1.85274996e+00 -7.75407193e-01 -7.75407193e-01
 -7.75407193e-01  7.84132754e-01  8.18426816e-01  8.18426816e-01
  8.18426816e-01  3.94739874e+00  3.94739874e+00  3.94739874e+00
  4.29506929e+00  1.43628978e+01  1.43628978e+01  1.43628978e+01
  1.49045366e+01  4.84092878e+01  5.30349190e+01  5.30349190e+01
  5.30349190e+01  1.56275945e+02  2.40857933e+02  2.40857933e+02
  2.40857933e+02  5.20013679e+02  1.88541189e+03  8.01307074e+03
  4.77785048e+04]
E1 = -182.08299870501585  E_coul = 53.54464456531268
cycle= 1 E= -128.538354139703  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.520334
diis-c [-0.27074776  1.        ]
  HOMO = -0.884578747942806  LUMO = 0.755368824372021
  mo_energy =
[-3.28788499e+01 -1.96693333e+00 -8.84578748e-01 -8.84578748e-01
 -8.84578748e-01  7.55368824e-01  7.91701195e-01  7.91701195e-01
  7.91701195e-01  3.84963208e+00  3.84963208e+00  3.84963208e+00
  4.21218689e+00  1.41716022e+01  1.41716022e+01  1.41716022e+01
  1.47409315e+01  4.81557732e+01  5.27534967e+01  5.27534967e+01
  5.27534967e+01  1.55958433e+02  2.40511150e+02  2.40511150e+02
  2.40511150e+02  5.19652278e+02  1.88501397e+03  8.01264360e+03
  4.77780587e+04]
E1 = -182.8459644271712  E_coul = 54.305016506215566
cycle= 2 E= -128.540947920956  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0648
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264727
diis-c [-0.00070939  0.33636211  0.66363789]
  HOMO = -0.848891495307934  LUMO = 0.764540747558189
  mo_energy =
[-3.27705848e+01 -1.92935399e+00 -8.48891495e-01 -8.48891495e-01
 -8.48891495e-01  7.64540748e-01  8.00397847e-01  8.00397847e-01
  8.00397847e-01  3.88131455e+00  3.88131455e+00  3.88131455e+00
  4.23899698e+00  1.42349516e+01  1.42349516e+01  1.42349516e+01
  1.47948511e+01  4.82406939e+01  5.28476712e+01  5.28476712e+01
  5.28476712e+01  1.56064340e+02  2.40624994e+02  2.40624994e+02
  2.40624994e+02  5.19769082e+02  1.88513618e+03  8.01276830e+03
  4.77781843e+04]
E1 = -182.58657239582303  E_coul = 54.044700096191626
cycle= 3 E= -128.541872299631  delta_E= -0.000924  |g|= 0.000525  |ddm|= 0.0224
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0011418
diis-c [-1.95331331e-07 -2.40918215e-03 -7.56225288e-04  1.00316541e+00]
  HOMO = -0.849157557404162  LUMO = 0.764482228666455
  mo_energy =
[-3.27710499e+01 -1.92955805e+00 -8.49157557e-01 -8.49157557e-01
 -8.49157557e-01  7.64482229e-01  8.00354365e-01  8.00354365e-01
  8.00354365e-01  3.88112713e+00  3.88112713e+00  3.88112713e+00
  4.23884200e+00  1.42346354e+01  1.42346354e+01  1.42346354e+01
  1.47945746e+01  4.82403192e+01  5.28472586e+01  5.28472586e+01
  5.28472586e+01  1.56063871e+02  2.40624458e+02  2.40624458e+02
  2.40624458e+02  5.19768491e+02  1.88513546e+03  8.01276748e+03
  4.77781835e+04]
E1 = -182.58700241053577  E_coul = 54.04513008354494
cycle= 4 E= -128.541872326991  delta_E= -2.74e-08  |g|= 8.19e-05  |ddm|= 0.000364
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187454
diis-c [-1.06605085e-09  2.24385014e-04  4.98760612e-04 -1.79147530e-01
  1.17842438e+00]
  HOMO = -0.849202148083427  LUMO = 0.764468189560875
  mo_energy =
[-3.27711249e+01 -1.92959285e+00 -8.49202148e-01 -8.49202148e-01
 -8.49202148e-01  7.64468190e-01  8.00340401e-01  8.00340401e-01
  8.00340401e-01  3.88108527e+00  3.88108527e+00  3.88108527e+00
  4.23880830e+00  1.42345739e+01  1.42345739e+01  1.42345739e+01
  1.47945192e+01  4.82402511e+01  5.28471875e+01  5.28471875e+01
  5.28471875e+01  1.56063796e+02  2.40624379e+02  2.40624379e+02
  2.40624379e+02  5.19768408e+02  1.88513536e+03  8.01276738e+03
  4.77781834e+04]
E1 = -182.58713519224355  E_coul = 54.045262864527935
cycle= 5 E= -128.541872327716  delta_E= -7.25e-10  |g|= 5.71e-06  |ddm|= 6.02e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58713519224355  E_coul = 54.045262864527935
  HOMO = -0.849199178242118  LUMO = 0.764469440200217
  mo_energy =
[-3.27711181e+01 -1.92958909e+00 -8.49199178e-01 -8.49199178e-01
 -8.49199178e-01  7.64469440e-01  8.00341269e-01  8.00341269e-01
  8.00341269e-01  3.88108812e+00  3.88108812e+00  3.88108812e+00
  4.23881108e+00  1.42345788e+01  1.42345788e+01  1.42345788e+01
  1.47945238e+01  4.82402571e+01  5.28471938e+01  5.28471938e+01
  5.28471938e+01  1.56063803e+02  2.40624385e+02  2.40624385e+02
  2.40624385e+02  5.19768414e+02  1.88513537e+03  8.01276739e+03
  4.77781834e+04]
E1 = -182.58711980549398  E_coul = 54.04524747777549
Extra cycle  E= -128.541872327718  delta_E= -2.87e-12  |g|= 2.16e-06  |ddm|= 2.09e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.82637589e-01 2.44137942e+04 3.66145150e+03 8.33320997e+02
 2.35426511e+02 7.59859668e+01 1.12679298e+01 2.79977316e+01
 3.01296190e-01 1.96823569e+00 4.20636649e+00 7.12585288e+00
 2.31672303e+01 9.97859732e+01 2.64107845e-01 2.44320371e+00
 8.32981376e-01]
E = -128.5418723277185
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.782637588905       1
[INPUT] 0    0    [1    /1   ]  24413.7941876        1
[INPUT] 0    0    [1    /1   ]  3661.45150358        1
[INPUT] 0    0    [1    /1   ]  833.320997249        1
[INPUT] 0    0    [1    /1   ]  235.426510794        1
[INPUT] 0    0    [1    /1   ]  75.9859667839        1
[INPUT] 0    0    [1    /1   ]  11.2679298003        1
[INPUT] 0    0    [1    /1   ]  27.9977315807        1
[INPUT] 0    0    [1    /1   ]  0.301296190148       1
[INPUT] 0    0    [1    /1   ]  1.96823568766        1
[INPUT] 0    0    [1    /1   ]  4.20636648762        1
[INPUT] 1    0    [1    /1   ]  7.12585288126        1
[INPUT] 1    0    [1    /1   ]  23.1672302833        1
[INPUT] 1    0    [1    /1   ]  99.7859731922        1
[INPUT] 1    0    [1    /1   ]  0.2641078445         1
[INPUT] 1    0    [1    /1   ]  2.44320370516        1
[INPUT] 1    0    [1    /1   ]  0.83298137617        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7826375889048154, 1.0]], [0, [24413.794187610732, 1.0]], [0, [3661.4515035764034, 1.0]], [0, [833.3209972489901, 1.0]], [0, [235.42651079354584, 1.0]], [0, [75.98596678385962, 1.0]], [0, [11.267929800251238, 1.0]], [0, [27.9977315806997, 1.0]], [0, [0.30129619014760944, 1.0]], [0, [1.9682356876555862, 1.0]], [0, [4.206366487619127, 1.0]], [1, [7.125852881257825, 1.0]], [1, [23.167230283298206, 1.0]], [1, [99.7859731922466, 1.0]], [1, [0.2641078445002103, 1.0]], [1, [2.443203705155352, 1.0]], [1, [0.8329813761695105, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78263759]
bas 1, expnt(s) = [24413.79418761]
bas 2, expnt(s) = [3661.45150358]
bas 3, expnt(s) = [833.32099725]
bas 4, expnt(s) = [235.42651079]
bas 5, expnt(s) = [75.98596678]
bas 6, expnt(s) = [11.2679298]
bas 7, expnt(s) = [27.99773158]
bas 8, expnt(s) = [0.30129619]
bas 9, expnt(s) = [1.96823569]
bas 10, expnt(s) = [4.20636649]
bas 11, expnt(s) = [7.12585288]
bas 12, expnt(s) = [23.16723028]
bas 13, expnt(s) = [99.78597319]
bas 14, expnt(s) = [0.26410784]
bas 15, expnt(s) = [2.44320371]
bas 16, expnt(s) = [0.83298138]
CPU time:       258.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.82637589e-01 2.10225576e+00 2.44137942e+04 4.93448103e+03
 3.66145150e+03 1.18920024e+03 8.33320997e+02 3.91853985e+02
 2.35426511e+02 1.51847116e+02 7.59859668e+01 6.50227105e+01
 1.12679298e+01 1.55381076e+01 2.79977316e+01 3.07508524e+01
 3.01296190e-01 1.02744895e+00 1.96823569e+00 4.19829402e+00
 4.20636649e+00 7.42070822e+00 7.12585288e+00 3.39649091e+01
 2.31672303e+01 1.48278108e+02 9.97859732e+01 9.20070834e+02
 2.64107845e-01 5.52345752e-01 2.44320371e+00 8.91115485e+00
 8.32981376e-01 2.32155249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999644465017967
cond(S) = 1252.0471149676248
E1 = -183.5903128902052  E_coul = 55.08013053298385
init E= -128.510182357221
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775407193383347  LUMO = 0.784132753894166
  mo_energy =
[-3.25551949e+01 -1.85274996e+00 -7.75407193e-01 -7.75407193e-01
 -7.75407193e-01  7.84132754e-01  8.18426816e-01  8.18426816e-01
  8.18426816e-01  3.94739874e+00  3.94739874e+00  3.94739874e+00
  4.29506929e+00  1.43628978e+01  1.43628978e+01  1.43628978e+01
  1.49045366e+01  4.84092878e+01  5.30349190e+01  5.30349190e+01
  5.30349190e+01  1.56275945e+02  2.40857933e+02  2.40857933e+02
  2.40857933e+02  5.20013679e+02  1.88541189e+03  8.01307074e+03
  4.77785048e+04]
E1 = -182.08299870501585  E_coul = 53.54464456531268
cycle= 1 E= -128.538354139703  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520334
diis-c [-0.27074776  1.        ]
  HOMO = -0.884578747942806  LUMO = 0.755368824372021
  mo_energy =
[-3.28788499e+01 -1.96693333e+00 -8.84578748e-01 -8.84578748e-01
 -8.84578748e-01  7.55368824e-01  7.91701195e-01  7.91701195e-01
  7.91701195e-01  3.84963208e+00  3.84963208e+00  3.84963208e+00
  4.21218689e+00  1.41716022e+01  1.41716022e+01  1.41716022e+01
  1.47409315e+01  4.81557732e+01  5.27534967e+01  5.27534967e+01
  5.27534967e+01  1.55958433e+02  2.40511150e+02  2.40511150e+02
  2.40511150e+02  5.19652278e+02  1.88501397e+03  8.01264360e+03
  4.77780587e+04]
E1 = -182.8459644271712  E_coul = 54.305016506215566
cycle= 2 E= -128.540947920956  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264727
diis-c [-0.00070939  0.33636211  0.66363789]
  HOMO = -0.848891495307934  LUMO = 0.764540747558189
  mo_energy =
[-3.27705848e+01 -1.92935399e+00 -8.48891495e-01 -8.48891495e-01
 -8.48891495e-01  7.64540748e-01  8.00397847e-01  8.00397847e-01
  8.00397847e-01  3.88131455e+00  3.88131455e+00  3.88131455e+00
  4.23899698e+00  1.42349516e+01  1.42349516e+01  1.42349516e+01
  1.47948511e+01  4.82406939e+01  5.28476712e+01  5.28476712e+01
  5.28476712e+01  1.56064340e+02  2.40624994e+02  2.40624994e+02
  2.40624994e+02  5.19769082e+02  1.88513618e+03  8.01276830e+03
  4.77781843e+04]
E1 = -182.58657239582303  E_coul = 54.044700096191626
cycle= 3 E= -128.541872299631  delta_E= -0.000924  |g|= 0.000525  |ddm|= 0.0224
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011418
diis-c [-1.95331331e-07 -2.40918215e-03 -7.56225288e-04  1.00316541e+00]
  HOMO = -0.849157557404162  LUMO = 0.764482228666455
  mo_energy =
[-3.27710499e+01 -1.92955805e+00 -8.49157557e-01 -8.49157557e-01
 -8.49157557e-01  7.64482229e-01  8.00354365e-01  8.00354365e-01
  8.00354365e-01  3.88112713e+00  3.88112713e+00  3.88112713e+00
  4.23884200e+00  1.42346354e+01  1.42346354e+01  1.42346354e+01
  1.47945746e+01  4.82403192e+01  5.28472586e+01  5.28472586e+01
  5.28472586e+01  1.56063871e+02  2.40624458e+02  2.40624458e+02
  2.40624458e+02  5.19768491e+02  1.88513546e+03  8.01276748e+03
  4.77781835e+04]
E1 = -182.58700241053577  E_coul = 54.04513008354494
cycle= 4 E= -128.541872326991  delta_E= -2.74e-08  |g|= 8.19e-05  |ddm|= 0.000364
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187454
diis-c [-1.06605085e-09  2.24385014e-04  4.98760612e-04 -1.79147530e-01
  1.17842438e+00]
  HOMO = -0.849202148083427  LUMO = 0.764468189560875
  mo_energy =
[-3.27711249e+01 -1.92959285e+00 -8.49202148e-01 -8.49202148e-01
 -8.49202148e-01  7.64468190e-01  8.00340401e-01  8.00340401e-01
  8.00340401e-01  3.88108527e+00  3.88108527e+00  3.88108527e+00
  4.23880830e+00  1.42345739e+01  1.42345739e+01  1.42345739e+01
  1.47945192e+01  4.82402511e+01  5.28471875e+01  5.28471875e+01
  5.28471875e+01  1.56063796e+02  2.40624379e+02  2.40624379e+02
  2.40624379e+02  5.19768408e+02  1.88513536e+03  8.01276738e+03
  4.77781834e+04]
E1 = -182.58713519224355  E_coul = 54.045262864527935
cycle= 5 E= -128.541872327716  delta_E= -7.25e-10  |g|= 5.71e-06  |ddm|= 6.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58713519224355  E_coul = 54.045262864527935
  HOMO = -0.849199178242118  LUMO = 0.764469440200217
  mo_energy =
[-3.27711181e+01 -1.92958909e+00 -8.49199178e-01 -8.49199178e-01
 -8.49199178e-01  7.64469440e-01  8.00341269e-01  8.00341269e-01
  8.00341269e-01  3.88108812e+00  3.88108812e+00  3.88108812e+00
  4.23881108e+00  1.42345788e+01  1.42345788e+01  1.42345788e+01
  1.47945238e+01  4.82402571e+01  5.28471938e+01  5.28471938e+01
  5.28471938e+01  1.56063803e+02  2.40624385e+02  2.40624385e+02
  2.40624385e+02  5.19768414e+02  1.88513537e+03  8.01276739e+03
  4.77781834e+04]
E1 = -182.58711980549398  E_coul = 54.04524747777549
Extra cycle  E= -128.541872327718  delta_E= -2.87e-12  |g|= 2.16e-06  |ddm|= 2.09e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1252.0471149676248
E1 = -182.58711980549398  E_coul = 54.04524747777549
init E= -128.541872327718
    CPU time for initialize scf      0.37 sec, wall time      0.38 sec
  HOMO = -0.849200269155822  LUMO = 0.764469238767119
  mo_energy =
[-3.27711215e+01 -1.92959010e+00 -8.49200269e-01 -8.49200269e-01
 -8.49200269e-01  7.64469239e-01  8.00341020e-01  8.00341020e-01
  8.00341020e-01  3.88108718e+00  3.88108718e+00  3.88108718e+00
  4.23881035e+00  1.42345769e+01  1.42345769e+01  1.42345769e+01
  1.47945222e+01  4.82402545e+01  5.28471909e+01  5.28471909e+01
  5.28471909e+01  1.56063799e+02  2.40624382e+02  2.40624382e+02
  2.40624382e+02  5.19768410e+02  1.88513537e+03  8.01276738e+03
  4.77781834e+04]
E1 = -182.5871283384609  E_coul = 54.045256010742094
cycle= 1 E= -128.541872327719  delta_E= -3.13e-13  |g|= 1.17e-06  |ddm|= 7.72e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5871283384609  E_coul = 54.045256010742094
  HOMO = -0.849199668710274  LUMO = 0.764469409199968
  mo_energy =
[-3.27711197e+01 -1.92958944e+00 -8.49199669e-01 -8.49199669e-01
 -8.49199669e-01  7.64469409e-01  8.00341170e-01  8.00341170e-01
  8.00341170e-01  3.88108772e+00  3.88108772e+00  3.88108772e+00
  4.23881082e+00  1.42345780e+01  1.42345780e+01  1.42345780e+01
  1.47945231e+01  4.82402559e+01  5.28471925e+01  5.28471925e+01
  5.28471925e+01  1.56063801e+02  2.40624384e+02  2.40624384e+02
  2.40624384e+02  5.19768412e+02  1.88513537e+03  8.01276738e+03
  4.77781834e+04]
E1 = -182.58712404361734  E_coul = 54.04525171589836
Extra cycle  E= -128.541872327719  delta_E= -1.71e-13  |g|= 5.83e-07  |ddm|= 3.82e-07
    CPU time for scf_cycle      0.44 sec, wall time      0.46 sec
exp = [7.82637589e-01 2.44137942e+04 3.66145150e+03 8.33320997e+02
 2.35426511e+02 7.59859668e+01 1.12679298e+01 2.79977316e+01
 3.01296190e-01 1.96823569e+00 4.20636649e+00 7.12585288e+00
 2.31672303e+01 9.97859732e+01 2.64107845e-01 2.44320371e+00
 8.32981376e-01]
grad_E = [-7.44559162e-05 -2.13037754e-09  1.12397366e-07 -2.19800883e-06
  2.26455998e-05 -8.72830332e-05  7.28545563e-05 -6.64462106e-06
  3.19369543e-05  4.43711609e-05 -8.47543708e-05  2.06594669e-04
 -3.07644766e-05  1.34458991e-06 -6.19372611e-03 -7.32775535e-04
  2.64464372e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.774668381323       1
[INPUT] 0    0    [1    /1   ]  24413.7941912        1
[INPUT] 0    0    [1    /1   ]  3661.45131061        1
[INPUT] 0    0    [1    /1   ]  833.324804712        1
[INPUT] 0    0    [1    /1   ]  235.387894895        1
[INPUT] 0    0    [1    /1   ]  76.1047477501        1
[INPUT] 0    0    [1    /1   ]  11.4592816303        1
[INPUT] 0    0    [1    /1   ]  28.1232258222        1
[INPUT] 0    0    [1    /1   ]  0.297797067718       1
[INPUT] 0    0    [1    /1   ]  1.96605217181        1
[INPUT] 0    0    [1    /1   ]  4.60846987218        1
[INPUT] 1    0    [1    /1   ]  7.15320172835        1
[INPUT] 1    0    [1    /1   ]  23.1580650851        1
[INPUT] 1    0    [1    /1   ]  99.7862434309        1
[INPUT] 1    0    [1    /1   ]  0.264883249229       1
[INPUT] 1    0    [1    /1   ]  2.45665580778        1
[INPUT] 1    0    [1    /1   ]  0.837240392601       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7746683813227714, 1.0]], [0, [24413.79419123793, 1.0]], [0, [3661.451310605462, 1.0]], [0, [833.3248047116889, 1.0]], [0, [235.38789489526656, 1.0]], [0, [76.10474775007268, 1.0]], [0, [11.459281630327665, 1.0]], [0, [28.123225822231486, 1.0]], [0, [0.2977970677182054, 1.0]], [0, [1.9660521718074389, 1.0]], [0, [4.608469872184306, 1.0]], [1, [7.153201728352578, 1.0]], [1, [23.158065085096467, 1.0]], [1, [99.78624343093324, 1.0]], [1, [0.26488324922935313, 1.0]], [1, [2.4566558077823566, 1.0]], [1, [0.837240392600615, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77466838]
bas 1, expnt(s) = [24413.79419124]
bas 2, expnt(s) = [3661.45131061]
bas 3, expnt(s) = [833.32480471]
bas 4, expnt(s) = [235.3878949]
bas 5, expnt(s) = [76.10474775]
bas 6, expnt(s) = [11.45928163]
bas 7, expnt(s) = [28.12322582]
bas 8, expnt(s) = [0.29779707]
bas 9, expnt(s) = [1.96605217]
bas 10, expnt(s) = [4.60846987]
bas 11, expnt(s) = [7.15320173]
bas 12, expnt(s) = [23.15806509]
bas 13, expnt(s) = [99.78624343]
bas 14, expnt(s) = [0.26488325]
bas 15, expnt(s) = [2.45665581]
bas 16, expnt(s) = [0.83724039]
CPU time:       262.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.74668381e-01 2.08618057e+00 2.44137942e+04 4.93448103e+03
 3.66145131e+03 1.18920019e+03 8.33324805e+02 3.91855328e+02
 2.35387895e+02 1.51828436e+02 7.61047478e+01 6.50989281e+01
 1.14592816e+01 1.57355914e+01 2.81232258e+01 3.08541705e+01
 2.97797068e-01 1.01848664e+00 1.96605217e+00 4.19480042e+00
 4.60846987e+00 7.94662261e+00 7.15320173e+00 3.41279328e+01
 2.31580651e+01 1.48204787e+02 9.97862434e+01 9.20073949e+02
 2.64883249e-01 5.54373563e-01 2.45665581e+00 8.97252722e+00
 8.37240393e-01 2.33639952e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999636552687356
cond(S) = 1198.2497354185582
E1 = -183.59031443208082  E_coul = 55.080124915491965
init E= -128.510189516589
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406285609081  LUMO = 0.776621482304859
  mo_energy =
[-3.25552095e+01 -1.85275027e+00 -7.75406286e-01 -7.75406286e-01
 -7.75406286e-01  7.76621482e-01  8.21927285e-01  8.21927285e-01
  8.21927285e-01  3.96840934e+00  3.96840934e+00  3.96840934e+00
  4.30896974e+00  1.44393985e+01  1.44393985e+01  1.44393985e+01
  1.54383362e+01  5.00731278e+01  5.31648616e+01  5.31648616e+01
  5.31648616e+01  1.58816203e+02  2.40957925e+02  2.40957925e+02
  2.40957925e+02  5.22923101e+02  1.88821086e+03  8.01556323e+03
  4.77805743e+04]
E1 = -182.08321912486818  E_coul = 53.544841799887074
cycle= 1 E= -128.538377324981  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.52031
diis-c [-0.27072254  1.        ]
  HOMO = -0.884566858653673  LUMO = 0.748048939568253
  mo_energy =
[-3.28788149e+01 -1.96691588e+00 -8.84566859e-01 -8.84566859e-01
 -8.84566859e-01  7.48048940e-01  7.95037876e-01  7.95037876e-01
  7.95037876e-01  3.87023683e+00  3.87023683e+00  3.87023683e+00
  4.22460589e+00  1.42477779e+01  1.42477779e+01  1.42477779e+01
  1.52702606e+01  4.98178697e+01  5.28834905e+01  5.28834905e+01
  5.28834905e+01  1.58498597e+02  2.40611206e+02  2.40611206e+02
  2.40611206e+02  5.22561792e+02  1.88781301e+03  8.01513613e+03
  4.77801282e+04]
E1 = -182.84595371085825  E_coul = 54.304983467757566
cycle= 2 E= -128.540970243101  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264751
diis-c [-0.00071958  0.3363807   0.6636193 ]
  HOMO = -0.848892448032429  LUMO = 0.757153661925494
  mo_energy =
[-3.27705810e+01 -1.92935059e+00 -8.48892448e-01 -8.48892448e-01
 -8.48892448e-01  7.57153662e-01  8.03784351e-01  8.03784351e-01
  8.03784351e-01  3.90204533e+00  3.90204533e+00  3.90204533e+00
  4.25190248e+00  1.43112252e+01  1.43112252e+01  1.43112252e+01
  1.53256986e+01  4.99033713e+01  5.29776334e+01  5.29776334e+01
  5.29776334e+01  1.58604511e+02  2.40725012e+02  2.40725012e+02
  2.40725012e+02  5.22678547e+02  1.88793518e+03  8.01526079e+03
  4.77802538e+04]
E1 = -182.58665191823326  E_coul = 54.04475778036103
cycle= 3 E= -128.541894137872  delta_E= -0.000924  |g|= 0.000523  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00113314
diis-c [-1.96669761e-07 -2.42749005e-03 -8.31000663e-04  1.00325849e+00]
  HOMO = -0.84915772319639  LUMO = 0.757095380697051
  mo_energy =
[-3.27710412e+01 -1.92955358e+00 -8.49157723e-01 -8.49157723e-01
 -8.49157723e-01  7.57095381e-01  8.03740585e-01  8.03740585e-01
  8.03740585e-01  3.90185778e+00  3.90185778e+00  3.90185778e+00
  4.25174606e+00  1.43109107e+01  1.43109107e+01  1.43109107e+01
  1.53254189e+01  4.99029979e+01  5.29772247e+01  5.29772247e+01
  5.29772247e+01  1.58604047e+02  2.40724481e+02  2.40724481e+02
  2.40724481e+02  5.22677961e+02  1.88793445e+03  8.01525997e+03
  4.77802529e+04]
E1 = -182.58706808687884  E_coul = 54.045173921679556
cycle= 4 E= -128.541894165199  delta_E= -2.73e-08  |g|= 8.24e-05  |ddm|= 0.000357
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188571
diis-c [-1.07113682e-09  2.23562073e-04  5.09666297e-04 -1.79004088e-01
  1.17827086e+00]
  HOMO = -0.849202549846368  LUMO = 0.757081344314984
  mo_energy =
[-3.27711166e+01 -1.92958857e+00 -8.49202550e-01 -8.49202550e-01
 -8.49202550e-01  7.57081344e-01  8.03726474e-01  8.03726474e-01
  8.03726474e-01  3.90181558e+00  3.90181558e+00  3.90181558e+00
  4.25171178e+00  1.43108488e+01  1.43108488e+01  1.43108488e+01
  1.53253624e+01  4.99029291e+01  5.29771533e+01  5.29771533e+01
  5.29771533e+01  1.58603971e+02  2.40724401e+02  2.40724401e+02
  2.40724401e+02  5.22677877e+02  1.88793436e+03  8.01525987e+03
  4.77802528e+04]
E1 = -182.58720167667184  E_coul = 54.04530751073961
cycle= 5 E= -128.541894165932  delta_E= -7.33e-10  |g|= 5.73e-06  |ddm|= 5.9e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58720167667184  E_coul = 54.04530751073961
  HOMO = -0.849199572447713  LUMO = 0.757082595562751
  mo_energy =
[-3.27711098e+01 -1.92958480e+00 -8.49199572e-01 -8.49199572e-01
 -8.49199572e-01  7.57082596e-01  8.03727350e-01  8.03727350e-01
  8.03727350e-01  3.90181845e+00  3.90181845e+00  3.90181845e+00
  4.25171460e+00  1.43108537e+01  1.43108537e+01  1.43108537e+01
  1.53253670e+01  4.99029351e+01  5.29771596e+01  5.29771596e+01
  5.29771596e+01  1.58603978e+02  2.40724408e+02  2.40724408e+02
  2.40724408e+02  5.22677884e+02  1.88793437e+03  8.01525988e+03
  4.77802529e+04]
E1 = -182.58718627141894  E_coul = 54.04529210548399
Extra cycle  E= -128.541894165935  delta_E= -2.73e-12  |g|= 2.17e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.74668381e-01 2.44137942e+04 3.66145131e+03 8.33324805e+02
 2.35387895e+02 7.61047478e+01 1.14592816e+01 2.81232258e+01
 2.97797068e-01 1.96605217e+00 4.60846987e+00 7.15320173e+00
 2.31580651e+01 9.97862434e+01 2.64883249e-01 2.45665581e+00
 8.37240393e-01]
E = -128.54189416593496
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.774668381323       1
[INPUT] 0    0    [1    /1   ]  24413.7941912        1
[INPUT] 0    0    [1    /1   ]  3661.45131061        1
[INPUT] 0    0    [1    /1   ]  833.324804712        1
[INPUT] 0    0    [1    /1   ]  235.387894895        1
[INPUT] 0    0    [1    /1   ]  76.1047477501        1
[INPUT] 0    0    [1    /1   ]  11.4592816303        1
[INPUT] 0    0    [1    /1   ]  28.1232258222        1
[INPUT] 0    0    [1    /1   ]  0.297797067718       1
[INPUT] 0    0    [1    /1   ]  1.96605217181        1
[INPUT] 0    0    [1    /1   ]  4.60846987218        1
[INPUT] 1    0    [1    /1   ]  7.15320172835        1
[INPUT] 1    0    [1    /1   ]  23.1580650851        1
[INPUT] 1    0    [1    /1   ]  99.7862434309        1
[INPUT] 1    0    [1    /1   ]  0.264883249229       1
[INPUT] 1    0    [1    /1   ]  2.45665580778        1
[INPUT] 1    0    [1    /1   ]  0.837240392601       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7746683813227714, 1.0]], [0, [24413.79419123793, 1.0]], [0, [3661.451310605462, 1.0]], [0, [833.3248047116889, 1.0]], [0, [235.38789489526656, 1.0]], [0, [76.10474775007268, 1.0]], [0, [11.459281630327665, 1.0]], [0, [28.123225822231486, 1.0]], [0, [0.2977970677182054, 1.0]], [0, [1.9660521718074389, 1.0]], [0, [4.608469872184306, 1.0]], [1, [7.153201728352578, 1.0]], [1, [23.158065085096467, 1.0]], [1, [99.78624343093324, 1.0]], [1, [0.26488324922935313, 1.0]], [1, [2.4566558077823566, 1.0]], [1, [0.837240392600615, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77466838]
bas 1, expnt(s) = [24413.79419124]
bas 2, expnt(s) = [3661.45131061]
bas 3, expnt(s) = [833.32480471]
bas 4, expnt(s) = [235.3878949]
bas 5, expnt(s) = [76.10474775]
bas 6, expnt(s) = [11.45928163]
bas 7, expnt(s) = [28.12322582]
bas 8, expnt(s) = [0.29779707]
bas 9, expnt(s) = [1.96605217]
bas 10, expnt(s) = [4.60846987]
bas 11, expnt(s) = [7.15320173]
bas 12, expnt(s) = [23.15806509]
bas 13, expnt(s) = [99.78624343]
bas 14, expnt(s) = [0.26488325]
bas 15, expnt(s) = [2.45665581]
bas 16, expnt(s) = [0.83724039]
CPU time:       263.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.74668381e-01 2.08618057e+00 2.44137942e+04 4.93448103e+03
 3.66145131e+03 1.18920019e+03 8.33324805e+02 3.91855328e+02
 2.35387895e+02 1.51828436e+02 7.61047478e+01 6.50989281e+01
 1.14592816e+01 1.57355914e+01 2.81232258e+01 3.08541705e+01
 2.97797068e-01 1.01848664e+00 1.96605217e+00 4.19480042e+00
 4.60846987e+00 7.94662261e+00 7.15320173e+00 3.41279328e+01
 2.31580651e+01 1.48204787e+02 9.97862434e+01 9.20073949e+02
 2.64883249e-01 5.54373563e-01 2.45665581e+00 8.97252722e+00
 8.37240393e-01 2.33639952e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999636552687356
cond(S) = 1198.2497354185582
E1 = -183.59031443208082  E_coul = 55.080124915491965
init E= -128.510189516589
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406285609081  LUMO = 0.776621482304859
  mo_energy =
[-3.25552095e+01 -1.85275027e+00 -7.75406286e-01 -7.75406286e-01
 -7.75406286e-01  7.76621482e-01  8.21927285e-01  8.21927285e-01
  8.21927285e-01  3.96840934e+00  3.96840934e+00  3.96840934e+00
  4.30896974e+00  1.44393985e+01  1.44393985e+01  1.44393985e+01
  1.54383362e+01  5.00731278e+01  5.31648616e+01  5.31648616e+01
  5.31648616e+01  1.58816203e+02  2.40957925e+02  2.40957925e+02
  2.40957925e+02  5.22923101e+02  1.88821086e+03  8.01556323e+03
  4.77805743e+04]
E1 = -182.08321912486818  E_coul = 53.544841799887074
cycle= 1 E= -128.538377324981  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.52031
diis-c [-0.27072254  1.        ]
  HOMO = -0.884566858653673  LUMO = 0.748048939568253
  mo_energy =
[-3.28788149e+01 -1.96691588e+00 -8.84566859e-01 -8.84566859e-01
 -8.84566859e-01  7.48048940e-01  7.95037876e-01  7.95037876e-01
  7.95037876e-01  3.87023683e+00  3.87023683e+00  3.87023683e+00
  4.22460589e+00  1.42477779e+01  1.42477779e+01  1.42477779e+01
  1.52702606e+01  4.98178697e+01  5.28834905e+01  5.28834905e+01
  5.28834905e+01  1.58498597e+02  2.40611206e+02  2.40611206e+02
  2.40611206e+02  5.22561792e+02  1.88781301e+03  8.01513613e+03
  4.77801282e+04]
E1 = -182.84595371085825  E_coul = 54.304983467757566
cycle= 2 E= -128.540970243101  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264751
diis-c [-0.00071958  0.3363807   0.6636193 ]
  HOMO = -0.848892448032429  LUMO = 0.757153661925494
  mo_energy =
[-3.27705810e+01 -1.92935059e+00 -8.48892448e-01 -8.48892448e-01
 -8.48892448e-01  7.57153662e-01  8.03784351e-01  8.03784351e-01
  8.03784351e-01  3.90204533e+00  3.90204533e+00  3.90204533e+00
  4.25190248e+00  1.43112252e+01  1.43112252e+01  1.43112252e+01
  1.53256986e+01  4.99033713e+01  5.29776334e+01  5.29776334e+01
  5.29776334e+01  1.58604511e+02  2.40725012e+02  2.40725012e+02
  2.40725012e+02  5.22678547e+02  1.88793518e+03  8.01526079e+03
  4.77802538e+04]
E1 = -182.58665191823326  E_coul = 54.04475778036103
cycle= 3 E= -128.541894137872  delta_E= -0.000924  |g|= 0.000523  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00113314
diis-c [-1.96669761e-07 -2.42749005e-03 -8.31000663e-04  1.00325849e+00]
  HOMO = -0.84915772319639  LUMO = 0.757095380697051
  mo_energy =
[-3.27710412e+01 -1.92955358e+00 -8.49157723e-01 -8.49157723e-01
 -8.49157723e-01  7.57095381e-01  8.03740585e-01  8.03740585e-01
  8.03740585e-01  3.90185778e+00  3.90185778e+00  3.90185778e+00
  4.25174606e+00  1.43109107e+01  1.43109107e+01  1.43109107e+01
  1.53254189e+01  4.99029979e+01  5.29772247e+01  5.29772247e+01
  5.29772247e+01  1.58604047e+02  2.40724481e+02  2.40724481e+02
  2.40724481e+02  5.22677961e+02  1.88793445e+03  8.01525997e+03
  4.77802529e+04]
E1 = -182.58706808687884  E_coul = 54.045173921679556
cycle= 4 E= -128.541894165199  delta_E= -2.73e-08  |g|= 8.24e-05  |ddm|= 0.000357
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188571
diis-c [-1.07113682e-09  2.23562073e-04  5.09666297e-04 -1.79004088e-01
  1.17827086e+00]
  HOMO = -0.849202549846368  LUMO = 0.757081344314984
  mo_energy =
[-3.27711166e+01 -1.92958857e+00 -8.49202550e-01 -8.49202550e-01
 -8.49202550e-01  7.57081344e-01  8.03726474e-01  8.03726474e-01
  8.03726474e-01  3.90181558e+00  3.90181558e+00  3.90181558e+00
  4.25171178e+00  1.43108488e+01  1.43108488e+01  1.43108488e+01
  1.53253624e+01  4.99029291e+01  5.29771533e+01  5.29771533e+01
  5.29771533e+01  1.58603971e+02  2.40724401e+02  2.40724401e+02
  2.40724401e+02  5.22677877e+02  1.88793436e+03  8.01525987e+03
  4.77802528e+04]
E1 = -182.58720167667184  E_coul = 54.04530751073961
cycle= 5 E= -128.541894165932  delta_E= -7.33e-10  |g|= 5.73e-06  |ddm|= 5.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58720167667184  E_coul = 54.04530751073961
  HOMO = -0.849199572447713  LUMO = 0.757082595562751
  mo_energy =
[-3.27711098e+01 -1.92958480e+00 -8.49199572e-01 -8.49199572e-01
 -8.49199572e-01  7.57082596e-01  8.03727350e-01  8.03727350e-01
  8.03727350e-01  3.90181845e+00  3.90181845e+00  3.90181845e+00
  4.25171460e+00  1.43108537e+01  1.43108537e+01  1.43108537e+01
  1.53253670e+01  4.99029351e+01  5.29771596e+01  5.29771596e+01
  5.29771596e+01  1.58603978e+02  2.40724408e+02  2.40724408e+02
  2.40724408e+02  5.22677884e+02  1.88793437e+03  8.01525988e+03
  4.77802529e+04]
E1 = -182.58718627141894  E_coul = 54.04529210548399
Extra cycle  E= -128.541894165935  delta_E= -2.73e-12  |g|= 2.17e-06  |ddm|= 2.11e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1198.2497354185582
E1 = -182.58718627141894  E_coul = 54.04529210548399
init E= -128.541894165935
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.849200664812085  LUMO = 0.757082396227272
  mo_energy =
[-3.27711132e+01 -1.92958581e+00 -8.49200665e-01 -8.49200665e-01
 -8.49200665e-01  7.57082396e-01  8.03727099e-01  8.03727099e-01
  8.03727099e-01  3.90181750e+00  3.90181750e+00  3.90181750e+00
  4.25171386e+00  1.43108517e+01  1.43108517e+01  1.43108517e+01
  1.53253654e+01  4.99029325e+01  5.29771567e+01  5.29771567e+01
  5.29771567e+01  1.58603974e+02  2.40724404e+02  2.40724404e+02
  2.40724404e+02  5.22677880e+02  1.88793436e+03  8.01525987e+03
  4.77802529e+04]
E1 = -182.5871948176151  E_coul = 54.045300651679916
cycle= 1 E= -128.541894165935  delta_E= -2.27e-13  |g|= 1.17e-06  |ddm|= 7.76e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5871948176151  E_coul = 54.045300651679916
  HOMO = -0.849200063500492  LUMO = 0.757082565900001
  mo_energy =
[-3.27711114e+01 -1.92958514e+00 -8.49200064e-01 -8.49200064e-01
 -8.49200064e-01  7.57082566e-01  8.03727250e-01  8.03727250e-01
  8.03727250e-01  3.90181804e+00  3.90181804e+00  3.90181804e+00
  4.25171434e+00  1.43108528e+01  1.43108528e+01  1.43108528e+01
  1.53253663e+01  4.99029339e+01  5.29771583e+01  5.29771583e+01
  5.29771583e+01  1.58603976e+02  2.40724406e+02  2.40724406e+02
  2.40724406e+02  5.22677882e+02  1.88793437e+03  8.01525988e+03
  4.77802529e+04]
E1 = -182.58719051657917  E_coul = 54.045296350643916
Extra cycle  E= -128.541894165935  delta_E= -5.68e-14  |g|= 5.84e-07  |ddm|= 3.84e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [7.74668381e-01 2.44137942e+04 3.66145131e+03 8.33324805e+02
 2.35387895e+02 7.61047478e+01 1.14592816e+01 2.81232258e+01
 2.97797068e-01 1.96605217e+00 4.60846987e+00 7.15320173e+00
 2.31580651e+01 9.97862434e+01 2.64883249e-01 2.45665581e+00
 8.37240393e-01]
grad_E = [-1.22842282e-04 -1.82704626e-09  9.67160945e-08 -1.92022183e-06
  2.02347129e-05 -7.87417091e-05  4.99917590e-05 -1.62745472e-05
  2.06358443e-05  5.65118250e-05 -4.58025701e-05  3.05343015e-04
 -6.35415292e-05  3.06350782e-06 -7.04976651e-03 -7.86765049e-04
  3.05559033e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.771805944094       1
[INPUT] 0    0    [1    /1   ]  24413.794196         1
[INPUT] 0    0    [1    /1   ]  3661.45105973        1
[INPUT] 0    0    [1    /1   ]  833.329735539        1
[INPUT] 0    0    [1    /1   ]  235.33776155         1
[INPUT] 0    0    [1    /1   ]  76.2705053405        1
[INPUT] 0    0    [1    /1   ]  11.6471215838        1
[INPUT] 0    0    [1    /1   ]  28.2239360228        1
[INPUT] 0    0    [1    /1   ]  0.296439240572       1
[INPUT] 0    0    [1    /1   ]  1.9635491465         1
[INPUT] 0    0    [1    /1   ]  5.06734484841        1
[INPUT] 1    0    [1    /1   ]  7.15734798131        1
[INPUT] 1    0    [1    /1   ]  23.1575400578        1
[INPUT] 1    0    [1    /1   ]  99.7860285806        1
[INPUT] 1    0    [1    /1   ]  0.265786811256       1
[INPUT] 1    0    [1    /1   ]  2.45999399582        1
[INPUT] 1    0    [1    /1   ]  0.83872644957        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7718059440937157, 1.0]], [0, [24413.794195964594, 1.0]], [0, [3661.4510597266967, 1.0]], [0, [833.3297355388056, 1.0]], [0, [235.33776155030995, 1.0]], [0, [76.2705053405241, 1.0]], [0, [11.647121583844763, 1.0]], [0, [28.223936022846818, 1.0]], [0, [0.2964392405719755, 1.0]], [0, [1.9635491464952013, 1.0]], [0, [5.067344848410182, 1.0]], [1, [7.1573479813147225, 1.0]], [1, [23.157540057823027, 1.0]], [1, [99.78602858059133, 1.0]], [1, [0.2657868112564653, 1.0]], [1, [2.4599939958163164, 1.0]], [1, [0.838726449569755, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77180594]
bas 1, expnt(s) = [24413.79419596]
bas 2, expnt(s) = [3661.45105973]
bas 3, expnt(s) = [833.32973554]
bas 4, expnt(s) = [235.33776155]
bas 5, expnt(s) = [76.27050534]
bas 6, expnt(s) = [11.64712158]
bas 7, expnt(s) = [28.22393602]
bas 8, expnt(s) = [0.29643924]
bas 9, expnt(s) = [1.96354915]
bas 10, expnt(s) = [5.06734485]
bas 11, expnt(s) = [7.15734798]
bas 12, expnt(s) = [23.15754006]
bas 13, expnt(s) = [99.78602858]
bas 14, expnt(s) = [0.26578681]
bas 15, expnt(s) = [2.459994]
bas 16, expnt(s) = [0.83872645]
CPU time:       266.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.71805944e-01 2.08039650e+00 2.44137942e+04 4.93448103e+03
 3.66145106e+03 1.18920013e+03 8.33329736e+02 3.91857067e+02
 2.35337762e+02 1.51804183e+02 7.62705053e+01 6.52052392e+01
 1.16471216e+01 1.59286504e+01 2.82239360e+01 3.09370008e+01
 2.96439241e-01 1.01500176e+00 1.96354915e+00 4.19079441e+00
 5.06734485e+00 8.53297296e+00 7.15734798e+00 3.41526619e+01
 2.31575401e+01 1.48200587e+02 9.97860286e+01 9.20071473e+02
 2.65786811e-01 5.56738399e-01 2.45999400e+00 8.98777003e+00
 8.38726450e-01 2.34158440e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963332806235
cond(S) = 1227.1661946601398
E1 = -183.59035342232886  E_coul = 55.08013755165094
init E= -128.510215870678
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775405060772947  LUMO = 0.775548511879565
  mo_energy =
[-3.25552184e+01 -1.85274743e+00 -7.75405061e-01 -7.75405061e-01
 -7.75405061e-01  7.75548512e-01  8.24859315e-01  8.24859315e-01
  8.24859315e-01  3.97745010e+00  3.97745010e+00  3.97745010e+00
  4.34222713e+00  1.44600396e+01  1.44600396e+01  1.44600396e+01
  1.60481787e+01  5.18986924e+01  5.31946659e+01  5.31946659e+01
  5.31946659e+01  1.61559850e+02  2.40981945e+02  2.40981945e+02
  2.40981945e+02  5.26084788e+02  1.89126953e+03  8.01828916e+03
  4.77828380e+04]
E1 = -182.08431799380853  E_coul = 53.545916681228334
cycle= 1 E= -128.53840131258  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519926
diis-c [-0.2703232  1.       ]
  HOMO = -0.884478127222405  LUMO = 0.747011198436017
  mo_energy =
[-3.28786580e+01 -1.96681043e+00 -8.84478127e-01 -8.84478127e-01
 -8.84478127e-01  7.47011198e-01  7.97903141e-01  7.97903141e-01
  7.97903141e-01  3.87926266e+00  3.87926266e+00  3.87926266e+00
  4.25633135e+00  1.42684968e+01  1.42684968e+01  1.42684968e+01
  1.58755590e+01  5.16417644e+01  5.29134601e+01  5.29134601e+01
  5.29134601e+01  1.61242268e+02  2.40635390e+02  2.40635390e+02
  2.40635390e+02  5.25723692e+02  1.89087187e+03  8.01786223e+03
  4.77823922e+04]
E1 = -182.8464899997516  E_coul = 54.305497995013354
cycle= 2 E= -128.540992004738  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264545
diis-c [-0.00073     0.33635819  0.66364181]
  HOMO = -0.848829838439029  LUMO = 0.756111221407181
  mo_energy =
[-3.27704957e+01 -1.92927333e+00 -8.48829838e-01 -8.48829838e-01
 -8.48829838e-01  7.56111221e-01  8.06674943e-01  8.06674943e-01
  8.06674943e-01  3.91108347e+00  3.91108347e+00  3.91108347e+00
  4.28414409e+00  1.43319159e+01  1.43319159e+01  1.43319159e+01
  1.59325562e+01  5.17278295e+01  5.30075367e+01  5.30075367e+01
  5.30075367e+01  1.61348149e+02  2.40749120e+02  2.40749120e+02
  2.40749120e+02  5.25840355e+02  1.89099395e+03  8.01798681e+03
  4.77825177e+04]
E1 = -182.587476841287  E_coul = 54.04556249510957
cycle= 3 E= -128.541914346177  delta_E= -0.000922  |g|= 0.000514  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00111454
diis-c [-1.96672119e-07 -2.42586216e-03 -9.02855847e-04  1.00332872e+00]
  HOMO = -0.84909011403145  LUMO = 0.756055472011568
  mo_energy =
[-3.27709452e+01 -1.92947013e+00 -8.49090114e-01 -8.49090114e-01
 -8.49090114e-01  7.56055472e-01  8.06632724e-01  8.06632724e-01
  8.06632724e-01  3.91090073e+00  3.91090073e+00  3.91090073e+00
  4.28399031e+00  1.43316091e+01  1.43316091e+01  1.43316091e+01
  1.59322789e+01  5.17274633e+01  5.30071379e+01  5.30071379e+01
  5.30071379e+01  1.61347695e+02  2.40748600e+02  2.40748600e+02
  2.40748600e+02  5.25839780e+02  1.89099324e+03  8.01798600e+03
  4.77825168e+04]
E1 = -182.5878761902711  E_coul = 54.045961817441764
cycle= 4 E= -128.541914372829  delta_E= -2.67e-08  |g|= 8.22e-05  |ddm|= 0.000349
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000189132
diis-c [-1.09299506e-09  2.26065218e-04  5.24414285e-04 -1.80788170e-01
  1.18003769e+00]
  HOMO = -0.849134664663608  LUMO = 0.756041748880792
  mo_energy =
[-3.27710203e+01 -1.92950453e+00 -8.49134665e-01 -8.49134665e-01
 -8.49134665e-01  7.56041749e-01  8.06618716e-01  8.06618716e-01
  8.06618716e-01  3.91085885e+00  3.91085885e+00  3.91085885e+00
  4.28395603e+00  1.43315476e+01  1.43315476e+01  1.43315476e+01
  1.59322220e+01  5.17273945e+01  5.30070667e+01  5.30070667e+01
  5.30070667e+01  1.61347620e+02  2.40748520e+02  2.40748520e+02
  2.40748520e+02  5.25839696e+02  1.89099315e+03  8.01798590e+03
  4.77825167e+04]
E1 = -182.5880105829948  E_coul = 54.046096209428384
cycle= 5 E= -128.541914373566  delta_E= -7.37e-10  |g|= 5.82e-06  |ddm|= 5.78e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5880105829948  E_coul = 54.046096209428384
  HOMO = -0.849131637382545  LUMO = 0.75604302425046
  mo_energy =
[-3.27710135e+01 -1.92950070e+00 -8.49131637e-01 -8.49131637e-01
 -8.49131637e-01  7.56043024e-01  8.06619611e-01  8.06619611e-01
  8.06619611e-01  3.91086177e+00  3.91086177e+00  3.91086177e+00
  4.28395895e+00  1.43315526e+01  1.43315526e+01  1.43315526e+01
  1.59322268e+01  5.17274007e+01  5.30070732e+01  5.30070732e+01
  5.30070732e+01  1.61347626e+02  2.40748527e+02  2.40748527e+02
  2.40748527e+02  5.25839703e+02  1.89099316e+03  8.01798591e+03
  4.77825167e+04]
E1 = -182.58799501621561  E_coul = 54.0460806426464
Extra cycle  E= -128.541914373569  delta_E= -2.81e-12  |g|= 2.19e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.71805944e-01 2.44137942e+04 3.66145106e+03 8.33329736e+02
 2.35337762e+02 7.62705053e+01 1.16471216e+01 2.82239360e+01
 2.96439241e-01 1.96354915e+00 5.06734485e+00 7.15734798e+00
 2.31575401e+01 9.97860286e+01 2.65786811e-01 2.45999400e+00
 8.38726450e-01]
E = -128.54191437356923
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.771805944094       1
[INPUT] 0    0    [1    /1   ]  24413.794196         1
[INPUT] 0    0    [1    /1   ]  3661.45105973        1
[INPUT] 0    0    [1    /1   ]  833.329735539        1
[INPUT] 0    0    [1    /1   ]  235.33776155         1
[INPUT] 0    0    [1    /1   ]  76.2705053405        1
[INPUT] 0    0    [1    /1   ]  11.6471215838        1
[INPUT] 0    0    [1    /1   ]  28.2239360228        1
[INPUT] 0    0    [1    /1   ]  0.296439240572       1
[INPUT] 0    0    [1    /1   ]  1.9635491465         1
[INPUT] 0    0    [1    /1   ]  5.06734484841        1
[INPUT] 1    0    [1    /1   ]  7.15734798131        1
[INPUT] 1    0    [1    /1   ]  23.1575400578        1
[INPUT] 1    0    [1    /1   ]  99.7860285806        1
[INPUT] 1    0    [1    /1   ]  0.265786811256       1
[INPUT] 1    0    [1    /1   ]  2.45999399582        1
[INPUT] 1    0    [1    /1   ]  0.83872644957        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7718059440937157, 1.0]], [0, [24413.794195964594, 1.0]], [0, [3661.4510597266967, 1.0]], [0, [833.3297355388056, 1.0]], [0, [235.33776155030995, 1.0]], [0, [76.2705053405241, 1.0]], [0, [11.647121583844763, 1.0]], [0, [28.223936022846818, 1.0]], [0, [0.2964392405719755, 1.0]], [0, [1.9635491464952013, 1.0]], [0, [5.067344848410182, 1.0]], [1, [7.1573479813147225, 1.0]], [1, [23.157540057823027, 1.0]], [1, [99.78602858059133, 1.0]], [1, [0.2657868112564653, 1.0]], [1, [2.4599939958163164, 1.0]], [1, [0.838726449569755, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77180594]
bas 1, expnt(s) = [24413.79419596]
bas 2, expnt(s) = [3661.45105973]
bas 3, expnt(s) = [833.32973554]
bas 4, expnt(s) = [235.33776155]
bas 5, expnt(s) = [76.27050534]
bas 6, expnt(s) = [11.64712158]
bas 7, expnt(s) = [28.22393602]
bas 8, expnt(s) = [0.29643924]
bas 9, expnt(s) = [1.96354915]
bas 10, expnt(s) = [5.06734485]
bas 11, expnt(s) = [7.15734798]
bas 12, expnt(s) = [23.15754006]
bas 13, expnt(s) = [99.78602858]
bas 14, expnt(s) = [0.26578681]
bas 15, expnt(s) = [2.459994]
bas 16, expnt(s) = [0.83872645]
CPU time:       267.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.71805944e-01 2.08039650e+00 2.44137942e+04 4.93448103e+03
 3.66145106e+03 1.18920013e+03 8.33329736e+02 3.91857067e+02
 2.35337762e+02 1.51804183e+02 7.62705053e+01 6.52052392e+01
 1.16471216e+01 1.59286504e+01 2.82239360e+01 3.09370008e+01
 2.96439241e-01 1.01500176e+00 1.96354915e+00 4.19079441e+00
 5.06734485e+00 8.53297296e+00 7.15734798e+00 3.41526619e+01
 2.31575401e+01 1.48200587e+02 9.97860286e+01 9.20071473e+02
 2.65786811e-01 5.56738399e-01 2.45999400e+00 8.98777003e+00
 8.38726450e-01 2.34158440e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963332806235
cond(S) = 1227.1661946601398
E1 = -183.59035342232886  E_coul = 55.08013755165094
init E= -128.510215870678
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775405060772947  LUMO = 0.775548511879565
  mo_energy =
[-3.25552184e+01 -1.85274743e+00 -7.75405061e-01 -7.75405061e-01
 -7.75405061e-01  7.75548512e-01  8.24859315e-01  8.24859315e-01
  8.24859315e-01  3.97745010e+00  3.97745010e+00  3.97745010e+00
  4.34222713e+00  1.44600396e+01  1.44600396e+01  1.44600396e+01
  1.60481787e+01  5.18986924e+01  5.31946659e+01  5.31946659e+01
  5.31946659e+01  1.61559850e+02  2.40981945e+02  2.40981945e+02
  2.40981945e+02  5.26084788e+02  1.89126953e+03  8.01828916e+03
  4.77828380e+04]
E1 = -182.08431799380853  E_coul = 53.545916681228334
cycle= 1 E= -128.53840131258  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519926
diis-c [-0.2703232  1.       ]
  HOMO = -0.884478127222405  LUMO = 0.747011198436017
  mo_energy =
[-3.28786580e+01 -1.96681043e+00 -8.84478127e-01 -8.84478127e-01
 -8.84478127e-01  7.47011198e-01  7.97903141e-01  7.97903141e-01
  7.97903141e-01  3.87926266e+00  3.87926266e+00  3.87926266e+00
  4.25633135e+00  1.42684968e+01  1.42684968e+01  1.42684968e+01
  1.58755590e+01  5.16417644e+01  5.29134601e+01  5.29134601e+01
  5.29134601e+01  1.61242268e+02  2.40635390e+02  2.40635390e+02
  2.40635390e+02  5.25723692e+02  1.89087187e+03  8.01786223e+03
  4.77823922e+04]
E1 = -182.8464899997516  E_coul = 54.305497995013354
cycle= 2 E= -128.540992004738  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264545
diis-c [-0.00073     0.33635819  0.66364181]
  HOMO = -0.848829838439029  LUMO = 0.756111221407181
  mo_energy =
[-3.27704957e+01 -1.92927333e+00 -8.48829838e-01 -8.48829838e-01
 -8.48829838e-01  7.56111221e-01  8.06674943e-01  8.06674943e-01
  8.06674943e-01  3.91108347e+00  3.91108347e+00  3.91108347e+00
  4.28414409e+00  1.43319159e+01  1.43319159e+01  1.43319159e+01
  1.59325562e+01  5.17278295e+01  5.30075367e+01  5.30075367e+01
  5.30075367e+01  1.61348149e+02  2.40749120e+02  2.40749120e+02
  2.40749120e+02  5.25840355e+02  1.89099395e+03  8.01798681e+03
  4.77825177e+04]
E1 = -182.587476841287  E_coul = 54.04556249510957
cycle= 3 E= -128.541914346177  delta_E= -0.000922  |g|= 0.000514  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00111454
diis-c [-1.96672119e-07 -2.42586216e-03 -9.02855847e-04  1.00332872e+00]
  HOMO = -0.84909011403145  LUMO = 0.756055472011568
  mo_energy =
[-3.27709452e+01 -1.92947013e+00 -8.49090114e-01 -8.49090114e-01
 -8.49090114e-01  7.56055472e-01  8.06632724e-01  8.06632724e-01
  8.06632724e-01  3.91090073e+00  3.91090073e+00  3.91090073e+00
  4.28399031e+00  1.43316091e+01  1.43316091e+01  1.43316091e+01
  1.59322789e+01  5.17274633e+01  5.30071379e+01  5.30071379e+01
  5.30071379e+01  1.61347695e+02  2.40748600e+02  2.40748600e+02
  2.40748600e+02  5.25839780e+02  1.89099324e+03  8.01798600e+03
  4.77825168e+04]
E1 = -182.5878761902711  E_coul = 54.045961817441764
cycle= 4 E= -128.541914372829  delta_E= -2.67e-08  |g|= 8.22e-05  |ddm|= 0.000349
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000189132
diis-c [-1.09299506e-09  2.26065218e-04  5.24414285e-04 -1.80788170e-01
  1.18003769e+00]
  HOMO = -0.849134664663608  LUMO = 0.756041748880792
  mo_energy =
[-3.27710203e+01 -1.92950453e+00 -8.49134665e-01 -8.49134665e-01
 -8.49134665e-01  7.56041749e-01  8.06618716e-01  8.06618716e-01
  8.06618716e-01  3.91085885e+00  3.91085885e+00  3.91085885e+00
  4.28395603e+00  1.43315476e+01  1.43315476e+01  1.43315476e+01
  1.59322220e+01  5.17273945e+01  5.30070667e+01  5.30070667e+01
  5.30070667e+01  1.61347620e+02  2.40748520e+02  2.40748520e+02
  2.40748520e+02  5.25839696e+02  1.89099315e+03  8.01798590e+03
  4.77825167e+04]
E1 = -182.5880105829948  E_coul = 54.046096209428384
cycle= 5 E= -128.541914373566  delta_E= -7.37e-10  |g|= 5.82e-06  |ddm|= 5.78e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5880105829948  E_coul = 54.046096209428384
  HOMO = -0.849131637382545  LUMO = 0.75604302425046
  mo_energy =
[-3.27710135e+01 -1.92950070e+00 -8.49131637e-01 -8.49131637e-01
 -8.49131637e-01  7.56043024e-01  8.06619611e-01  8.06619611e-01
  8.06619611e-01  3.91086177e+00  3.91086177e+00  3.91086177e+00
  4.28395895e+00  1.43315526e+01  1.43315526e+01  1.43315526e+01
  1.59322268e+01  5.17274007e+01  5.30070732e+01  5.30070732e+01
  5.30070732e+01  1.61347626e+02  2.40748527e+02  2.40748527e+02
  2.40748527e+02  5.25839703e+02  1.89099316e+03  8.01798591e+03
  4.77825167e+04]
E1 = -182.58799501621561  E_coul = 54.0460806426464
Extra cycle  E= -128.541914373569  delta_E= -2.81e-12  |g|= 2.19e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.15 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1227.1661946601398
E1 = -182.58799501621561  E_coul = 54.0460806426464
init E= -128.541914373569
    CPU time for initialize scf      0.38 sec, wall time      0.38 sec
  HOMO = -0.849132740579467  LUMO = 0.75604282375083
  mo_energy =
[-3.27710169e+01 -1.92950172e+00 -8.49132741e-01 -8.49132741e-01
 -8.49132741e-01  7.56042824e-01  8.06619357e-01  8.06619357e-01
  8.06619357e-01  3.91086081e+00  3.91086081e+00  3.91086081e+00
  4.28395818e+00  1.43315506e+01  1.43315506e+01  1.43315506e+01
  1.59322251e+01  5.17273980e+01  5.30070702e+01  5.30070702e+01
  5.30070702e+01  1.61347623e+02  2.40748523e+02  2.40748523e+02
  2.40748523e+02  5.25839699e+02  1.89099315e+03  8.01798590e+03
  4.77825167e+04]
E1 = -182.58800366093598  E_coul = 54.046089287366435
cycle= 1 E= -128.54191437357  delta_E= -3.13e-13  |g|= 1.19e-06  |ddm|= 7.87e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
E1 = -182.58800366093598  E_coul = 54.046089287366435
  HOMO = -0.849132132301743  LUMO = 0.756042995481687
  mo_energy =
[-3.27710151e+01 -1.92950105e+00 -8.49132132e-01 -8.49132132e-01
 -8.49132132e-01  7.56042995e-01  8.06619510e-01  8.06619510e-01
  8.06619510e-01  3.91086136e+00  3.91086136e+00  3.91086136e+00
  4.28395868e+00  1.43315517e+01  1.43315517e+01  1.43315517e+01
  1.59322261e+01  5.17273995e+01  5.30070718e+01  5.30070718e+01
  5.30070718e+01  1.61347625e+02  2.40748525e+02  2.40748525e+02
  2.40748525e+02  5.25839701e+02  1.89099316e+03  8.01798591e+03
  4.77825167e+04]
E1 = -182.58799931307735  E_coul = 54.04608493950788
Extra cycle  E= -128.541914373569  delta_E= 8.53e-14  |g|= 5.9e-07  |ddm|= 3.9e-07
    CPU time for scf_cycle      0.46 sec, wall time      0.46 sec
exp = [7.71805944e-01 2.44137942e+04 3.66145106e+03 8.33329736e+02
 2.35337762e+02 7.62705053e+01 1.16471216e+01 2.82239360e+01
 2.96439241e-01 1.96354915e+00 5.06734485e+00 7.15734798e+00
 2.31575401e+01 9.97860286e+01 2.65786811e-01 2.45999400e+00
 8.38726450e-01]
grad_E = [-8.07008360e-06 -1.34491866e-09  7.17914018e-08 -1.47401512e-06
  1.63460440e-05 -6.61667547e-05  5.18073655e-06 -1.99138021e-05
 -1.18739754e-04 -2.07326460e-06  1.00039970e-05  2.63412131e-04
 -6.25241335e-05  3.09864825e-06 -5.00649433e-03 -5.39634856e-04
  2.18984816e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.791170743169       1
[INPUT] 0    0    [1    /1   ]  24413.7941986        1
[INPUT] 0    0    [1    /1   ]  3661.45092038        1
[INPUT] 0    0    [1    /1   ]  833.332465177        1
[INPUT] 0    0    [1    /1   ]  235.309866286        1
[INPUT] 0    0    [1    /1   ]  76.3710205552        1
[INPUT] 0    0    [1    /1   ]  11.7186825682        1
[INPUT] 0    0    [1    /1   ]  28.2323242738        1
[INPUT] 0    0    [1    /1   ]  0.301775017893       1
[INPUT] 0    0    [1    /1   ]  2.01386896878        1
[INPUT] 0    0    [1    /1   ]  5.27887339189        1
[INPUT] 1    0    [1    /1   ]  7.13497240633        1
[INPUT] 1    0    [1    /1   ]  23.1661347852        1
[INPUT] 1    0    [1    /1   ]  99.7854642773        1
[INPUT] 1    0    [1    /1   ]  0.266186571931       1
[INPUT] 1    0    [1    /1   ]  2.45064171839        1
[INPUT] 1    0    [1    /1   ]  0.836336973461       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7911707431689574, 1.0]], [0, [24413.794198596202, 1.0]], [0, [3661.4509203799457, 1.0]], [0, [833.3324651765726, 1.0]], [0, [235.30986628636717, 1.0]], [0, [76.37102055515372, 1.0]], [0, [11.718682568241052, 1.0]], [0, [28.23232427378032, 1.0]], [0, [0.301775017892754, 1.0]], [0, [2.013868968784072, 1.0]], [0, [5.278873391893045, 1.0]], [1, [7.13497240633274, 1.0]], [1, [23.166134785232806, 1.0]], [1, [99.78546427729033, 1.0]], [1, [0.266186571931123, 1.0]], [1, [2.45064171838611, 1.0]], [1, [0.8363369734610667, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79117074]
bas 1, expnt(s) = [24413.7941986]
bas 2, expnt(s) = [3661.45092038]
bas 3, expnt(s) = [833.33246518]
bas 4, expnt(s) = [235.30986629]
bas 5, expnt(s) = [76.37102056]
bas 6, expnt(s) = [11.71868257]
bas 7, expnt(s) = [28.23232427]
bas 8, expnt(s) = [0.30177502]
bas 9, expnt(s) = [2.01386897]
bas 10, expnt(s) = [5.27887339]
bas 11, expnt(s) = [7.13497241]
bas 12, expnt(s) = [23.16613479]
bas 13, expnt(s) = [99.78546428]
bas 14, expnt(s) = [0.26618657]
bas 15, expnt(s) = [2.45064172]
bas 16, expnt(s) = [0.83633697]
CPU time:       271.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.91170743e-01 2.11942322e+00 2.44137942e+04 4.93448103e+03
 3.66145092e+03 1.18920010e+03 8.33332465e+02 3.91858030e+02
 2.35309866e+02 1.51790687e+02 7.63710206e+01 6.52696780e+01
 1.17186826e+01 1.60019945e+01 2.82323243e+01 3.09438965e+01
 3.01775018e-01 1.02867335e+00 2.01386897e+00 4.27108714e+00
 5.27887339e+00 8.79874961e+00 7.13497241e+00 3.40192524e+01
 2.31661348e+01 1.48269344e+02 9.97854643e+01 9.20064969e+02
 2.66186572e-01 5.57785309e-01 2.45064172e+00 8.94507880e+00
 8.36336973e-01 2.33324860e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999636374099808
cond(S) = 1316.9223611087364
E1 = -183.5903936335191  E_coul = 55.08016444268283
init E= -128.510229190836
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403486571158  LUMO = 0.798705505117461
  mo_energy =
[-3.25552175e+01 -1.85274307e+00 -7.75403487e-01 -7.75403487e-01
 -7.75403487e-01  7.98705505e-01  8.25142962e-01  8.25142962e-01
  8.25142962e-01  3.96789987e+00  3.96789987e+00  3.96789987e+00
  4.48165577e+00  1.44091735e+01  1.44091735e+01  1.44091735e+01
  1.65848583e+01  5.30042367e+01  5.31013805e+01  5.31013805e+01
  5.31013805e+01  1.63012681e+02  2.40911415e+02  2.40911415e+02
  2.40911415e+02  5.27693869e+02  1.89281831e+03  8.01966788e+03
  4.77839827e+04]
E1 = -182.08558460116092  E_coul = 53.54717118018078
cycle= 1 E= -128.53841342098  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519536
diis-c [-0.26991756  1.        ]
  HOMO = -0.884370447688402  LUMO = 0.769335428998502
  mo_energy =
[-3.28784779e+01 -1.96668920e+00 -8.84370448e-01 -8.84370448e-01
 -8.84370448e-01  7.69335429e-01  7.98269314e-01  7.98269314e-01
  7.98269314e-01  3.87010554e+00  3.87010554e+00  3.87010554e+00
  4.39369678e+00  1.42180729e+01  1.42180729e+01  1.42180729e+01
  1.64099804e+01  5.27468410e+01  5.28203463e+01  5.28203463e+01
  5.28203463e+01  1.62695293e+02  2.40565024e+02  2.40565024e+02
  2.40565024e+02  5.27332995e+02  1.89242086e+03  8.01924115e+03
  4.77835370e+04]
E1 = -182.8472369344991  E_coul = 54.30623509452153
cycle= 2 E= -128.541001839978  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264311
diis-c [-0.00073548  0.3363202   0.6636798 ]
  HOMO = -0.848744722591568  LUMO = 0.778718663104923
  mo_energy =
[-3.27703819e+01 -1.92917610e+00 -8.48744723e-01 -8.48744723e-01
 -8.48744723e-01  7.78718663e-01  8.07023681e-01  8.07023681e-01
  8.07023681e-01  3.90181302e+00  3.90181302e+00  3.90181302e+00
  4.42220480e+00  1.42813540e+01  1.42813540e+01  1.42813540e+01
  1.64677620e+01  5.28330700e+01  5.29143644e+01  5.29143644e+01
  5.29143644e+01  1.62801100e+02  2.40678689e+02  2.40678689e+02
  2.40678689e+02  5.27449575e+02  1.89254287e+03  8.01936566e+03
  4.77836625e+04]
E1 = -182.5885270480791  E_coul = 54.046604466216884
cycle= 3 E= -128.541922581862  delta_E= -0.000921  |g|= 0.000501  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109397
diis-c [-1.92743995e-07 -2.40073325e-03 -9.29117473e-04  1.00332985e+00]
  HOMO = -0.848998005567601  LUMO = 0.778665547685846
  mo_energy =
[-3.27708198e+01 -1.92936474e+00 -8.48998006e-01 -8.48998006e-01
 -8.48998006e-01  7.78665548e-01  8.06984319e-01  8.06984319e-01
  8.06984319e-01  3.90163777e+00  3.90163777e+00  3.90163777e+00
  4.42205452e+00  1.42810574e+01  1.42810574e+01  1.42810574e+01
  1.64674915e+01  5.28327137e+01  5.29139767e+01  5.29139767e+01
  5.29139767e+01  1.62800657e+02  2.40678181e+02  2.40678181e+02
  2.40678181e+02  5.27449012e+02  1.89254217e+03  8.01936486e+03
  4.77836616e+04]
E1 = -182.58891646635837  E_coul = 54.04699385912926
cycle= 4 E= -128.541922607229  delta_E= -2.54e-08  |g|= 8.11e-05  |ddm|= 0.000338
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188285
diis-c [-1.11594748e-09  2.30052863e-04  5.34611181e-04 -1.83157504e-01
  1.18239284e+00]
  HOMO = -0.84904171381244  LUMO = 0.778652091555704
  mo_energy =
[-3.27708940e+01 -1.92939798e+00 -8.49041714e-01 -8.49041714e-01
 -8.49041714e-01  7.78652092e-01  8.06970702e-01  8.06970702e-01
  8.06970702e-01  3.90159688e+00  3.90159688e+00  3.90159688e+00
  4.42202056e+00  1.42809971e+01  1.42809971e+01  1.42809971e+01
  1.64674352e+01  5.28326460e+01  5.29139066e+01  5.29139066e+01
  5.29139066e+01  1.62800583e+02  2.40678102e+02  2.40678102e+02
  2.40678102e+02  5.27448929e+02  1.89254208e+03  8.01936476e+03
  4.77836615e+04]
E1 = -182.58905126390422  E_coul = 54.04712865595169
cycle= 5 E= -128.541922607953  delta_E= -7.23e-10  |g|= 5.92e-06  |ddm|= 5.62e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58905126390422  E_coul = 54.04712865595169
  HOMO = -0.84903862280942  LUMO = 0.778653425021231
  mo_energy =
[-3.27708870e+01 -1.92939408e+00 -8.49038623e-01 -8.49038623e-01
 -8.49038623e-01  7.78653425e-01  8.06971615e-01  8.06971615e-01
  8.06971615e-01  3.90159985e+00  3.90159985e+00  3.90159985e+00
  4.42202360e+00  1.42810022e+01  1.42810022e+01  1.42810022e+01
  1.64674402e+01  5.28326523e+01  5.29139132e+01  5.29139132e+01
  5.29139132e+01  1.62800589e+02  2.40678109e+02  2.40678109e+02
  2.40678109e+02  5.27448936e+02  1.89254208e+03  8.01936477e+03
  4.77836615e+04]
E1 = -182.58903548891558  E_coul = 54.047112880960725
Extra cycle  E= -128.541922607955  delta_E= -2.33e-12  |g|= 2.22e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.91170743e-01 2.44137942e+04 3.66145092e+03 8.33332465e+02
 2.35309866e+02 7.63710206e+01 1.17186826e+01 2.82323243e+01
 3.01775018e-01 2.01386897e+00 5.27887339e+00 7.13497241e+00
 2.31661348e+01 9.97854643e+01 2.66186572e-01 2.45064172e+00
 8.36336973e-01]
E = -128.54192260795486
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.791170743169       1
[INPUT] 0    0    [1    /1   ]  24413.7941986        1
[INPUT] 0    0    [1    /1   ]  3661.45092038        1
[INPUT] 0    0    [1    /1   ]  833.332465177        1
[INPUT] 0    0    [1    /1   ]  235.309866286        1
[INPUT] 0    0    [1    /1   ]  76.3710205552        1
[INPUT] 0    0    [1    /1   ]  11.7186825682        1
[INPUT] 0    0    [1    /1   ]  28.2323242738        1
[INPUT] 0    0    [1    /1   ]  0.301775017893       1
[INPUT] 0    0    [1    /1   ]  2.01386896878        1
[INPUT] 0    0    [1    /1   ]  5.27887339189        1
[INPUT] 1    0    [1    /1   ]  7.13497240633        1
[INPUT] 1    0    [1    /1   ]  23.1661347852        1
[INPUT] 1    0    [1    /1   ]  99.7854642773        1
[INPUT] 1    0    [1    /1   ]  0.266186571931       1
[INPUT] 1    0    [1    /1   ]  2.45064171839        1
[INPUT] 1    0    [1    /1   ]  0.836336973461       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7911707431689574, 1.0]], [0, [24413.794198596202, 1.0]], [0, [3661.4509203799457, 1.0]], [0, [833.3324651765726, 1.0]], [0, [235.30986628636717, 1.0]], [0, [76.37102055515372, 1.0]], [0, [11.718682568241052, 1.0]], [0, [28.23232427378032, 1.0]], [0, [0.301775017892754, 1.0]], [0, [2.013868968784072, 1.0]], [0, [5.278873391893045, 1.0]], [1, [7.13497240633274, 1.0]], [1, [23.166134785232806, 1.0]], [1, [99.78546427729033, 1.0]], [1, [0.266186571931123, 1.0]], [1, [2.45064171838611, 1.0]], [1, [0.8363369734610667, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79117074]
bas 1, expnt(s) = [24413.7941986]
bas 2, expnt(s) = [3661.45092038]
bas 3, expnt(s) = [833.33246518]
bas 4, expnt(s) = [235.30986629]
bas 5, expnt(s) = [76.37102056]
bas 6, expnt(s) = [11.71868257]
bas 7, expnt(s) = [28.23232427]
bas 8, expnt(s) = [0.30177502]
bas 9, expnt(s) = [2.01386897]
bas 10, expnt(s) = [5.27887339]
bas 11, expnt(s) = [7.13497241]
bas 12, expnt(s) = [23.16613479]
bas 13, expnt(s) = [99.78546428]
bas 14, expnt(s) = [0.26618657]
bas 15, expnt(s) = [2.45064172]
bas 16, expnt(s) = [0.83633697]
CPU time:       272.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.91170743e-01 2.11942322e+00 2.44137942e+04 4.93448103e+03
 3.66145092e+03 1.18920010e+03 8.33332465e+02 3.91858030e+02
 2.35309866e+02 1.51790687e+02 7.63710206e+01 6.52696780e+01
 1.17186826e+01 1.60019945e+01 2.82323243e+01 3.09438965e+01
 3.01775018e-01 1.02867335e+00 2.01386897e+00 4.27108714e+00
 5.27887339e+00 8.79874961e+00 7.13497241e+00 3.40192524e+01
 2.31661348e+01 1.48269344e+02 9.97854643e+01 9.20064969e+02
 2.66186572e-01 5.57785309e-01 2.45064172e+00 8.94507880e+00
 8.36336973e-01 2.33324860e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999636374099808
cond(S) = 1316.9223611087364
E1 = -183.5903936335191  E_coul = 55.08016444268283
init E= -128.510229190836
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403486571158  LUMO = 0.798705505117461
  mo_energy =
[-3.25552175e+01 -1.85274307e+00 -7.75403487e-01 -7.75403487e-01
 -7.75403487e-01  7.98705505e-01  8.25142962e-01  8.25142962e-01
  8.25142962e-01  3.96789987e+00  3.96789987e+00  3.96789987e+00
  4.48165577e+00  1.44091735e+01  1.44091735e+01  1.44091735e+01
  1.65848583e+01  5.30042367e+01  5.31013805e+01  5.31013805e+01
  5.31013805e+01  1.63012681e+02  2.40911415e+02  2.40911415e+02
  2.40911415e+02  5.27693869e+02  1.89281831e+03  8.01966788e+03
  4.77839827e+04]
E1 = -182.08558460116092  E_coul = 53.54717118018078
cycle= 1 E= -128.53841342098  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519536
diis-c [-0.26991756  1.        ]
  HOMO = -0.884370447688402  LUMO = 0.769335428998502
  mo_energy =
[-3.28784779e+01 -1.96668920e+00 -8.84370448e-01 -8.84370448e-01
 -8.84370448e-01  7.69335429e-01  7.98269314e-01  7.98269314e-01
  7.98269314e-01  3.87010554e+00  3.87010554e+00  3.87010554e+00
  4.39369678e+00  1.42180729e+01  1.42180729e+01  1.42180729e+01
  1.64099804e+01  5.27468410e+01  5.28203463e+01  5.28203463e+01
  5.28203463e+01  1.62695293e+02  2.40565024e+02  2.40565024e+02
  2.40565024e+02  5.27332995e+02  1.89242086e+03  8.01924115e+03
  4.77835370e+04]
E1 = -182.8472369344991  E_coul = 54.30623509452153
cycle= 2 E= -128.541001839978  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264311
diis-c [-0.00073548  0.3363202   0.6636798 ]
  HOMO = -0.848744722591568  LUMO = 0.778718663104923
  mo_energy =
[-3.27703819e+01 -1.92917610e+00 -8.48744723e-01 -8.48744723e-01
 -8.48744723e-01  7.78718663e-01  8.07023681e-01  8.07023681e-01
  8.07023681e-01  3.90181302e+00  3.90181302e+00  3.90181302e+00
  4.42220480e+00  1.42813540e+01  1.42813540e+01  1.42813540e+01
  1.64677620e+01  5.28330700e+01  5.29143644e+01  5.29143644e+01
  5.29143644e+01  1.62801100e+02  2.40678689e+02  2.40678689e+02
  2.40678689e+02  5.27449575e+02  1.89254287e+03  8.01936566e+03
  4.77836625e+04]
E1 = -182.5885270480791  E_coul = 54.046604466216884
cycle= 3 E= -128.541922581862  delta_E= -0.000921  |g|= 0.000501  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109397
diis-c [-1.92743995e-07 -2.40073325e-03 -9.29117473e-04  1.00332985e+00]
  HOMO = -0.848998005567601  LUMO = 0.778665547685846
  mo_energy =
[-3.27708198e+01 -1.92936474e+00 -8.48998006e-01 -8.48998006e-01
 -8.48998006e-01  7.78665548e-01  8.06984319e-01  8.06984319e-01
  8.06984319e-01  3.90163777e+00  3.90163777e+00  3.90163777e+00
  4.42205452e+00  1.42810574e+01  1.42810574e+01  1.42810574e+01
  1.64674915e+01  5.28327137e+01  5.29139767e+01  5.29139767e+01
  5.29139767e+01  1.62800657e+02  2.40678181e+02  2.40678181e+02
  2.40678181e+02  5.27449012e+02  1.89254217e+03  8.01936486e+03
  4.77836616e+04]
E1 = -182.58891646635837  E_coul = 54.04699385912926
cycle= 4 E= -128.541922607229  delta_E= -2.54e-08  |g|= 8.11e-05  |ddm|= 0.000338
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188285
diis-c [-1.11594748e-09  2.30052863e-04  5.34611181e-04 -1.83157504e-01
  1.18239284e+00]
  HOMO = -0.84904171381244  LUMO = 0.778652091555704
  mo_energy =
[-3.27708940e+01 -1.92939798e+00 -8.49041714e-01 -8.49041714e-01
 -8.49041714e-01  7.78652092e-01  8.06970702e-01  8.06970702e-01
  8.06970702e-01  3.90159688e+00  3.90159688e+00  3.90159688e+00
  4.42202056e+00  1.42809971e+01  1.42809971e+01  1.42809971e+01
  1.64674352e+01  5.28326460e+01  5.29139066e+01  5.29139066e+01
  5.29139066e+01  1.62800583e+02  2.40678102e+02  2.40678102e+02
  2.40678102e+02  5.27448929e+02  1.89254208e+03  8.01936476e+03
  4.77836615e+04]
E1 = -182.58905126390422  E_coul = 54.04712865595169
cycle= 5 E= -128.541922607953  delta_E= -7.23e-10  |g|= 5.92e-06  |ddm|= 5.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58905126390422  E_coul = 54.04712865595169
  HOMO = -0.84903862280942  LUMO = 0.778653425021231
  mo_energy =
[-3.27708870e+01 -1.92939408e+00 -8.49038623e-01 -8.49038623e-01
 -8.49038623e-01  7.78653425e-01  8.06971615e-01  8.06971615e-01
  8.06971615e-01  3.90159985e+00  3.90159985e+00  3.90159985e+00
  4.42202360e+00  1.42810022e+01  1.42810022e+01  1.42810022e+01
  1.64674402e+01  5.28326523e+01  5.29139132e+01  5.29139132e+01
  5.29139132e+01  1.62800589e+02  2.40678109e+02  2.40678109e+02
  2.40678109e+02  5.27448936e+02  1.89254208e+03  8.01936477e+03
  4.77836615e+04]
E1 = -182.58903548891558  E_coul = 54.047112880960725
Extra cycle  E= -128.541922607955  delta_E= -2.33e-12  |g|= 2.22e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1316.9223611087364
E1 = -182.58903548891558  E_coul = 54.047112880960725
init E= -128.541922607955
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.849039739489003  LUMO = 0.778653214539136
  mo_energy =
[-3.27708905e+01 -1.92939512e+00 -8.49039739e-01 -8.49039739e-01
 -8.49039739e-01  7.78653215e-01  8.06971359e-01  8.06971359e-01
  8.06971359e-01  3.90159888e+00  3.90159888e+00  3.90159888e+00
  4.42202280e+00  1.42810002e+01  1.42810002e+01  1.42810002e+01
  1.64674384e+01  5.28326495e+01  5.29139102e+01  5.29139102e+01
  5.29139102e+01  1.62800586e+02  2.40678105e+02  2.40678105e+02
  2.40678105e+02  5.27448932e+02  1.89254208e+03  8.01936477e+03
  4.77836615e+04]
E1 = -182.58904425711208  E_coul = 54.047121649156615
cycle= 1 E= -128.541922607955  delta_E= -5.97e-13  |g|= 1.2e-06  |ddm|= 7.98e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58904425711208  E_coul = 54.047121649156615
  HOMO = -0.849039122362813  LUMO = 0.778653393925109
  mo_energy =
[-3.27708887e+01 -1.92939444e+00 -8.49039122e-01 -8.49039122e-01
 -8.49039122e-01  7.78653394e-01  8.06971514e-01  8.06971514e-01
  8.06971514e-01  3.90159944e+00  3.90159944e+00  3.90159944e+00
  4.42202332e+00  1.42810013e+01  1.42810013e+01  1.42810013e+01
  1.64674394e+01  5.28326510e+01  5.29139118e+01  5.29139118e+01
  5.29139118e+01  1.62800588e+02  2.40678107e+02  2.40678107e+02
  2.40678107e+02  5.27448934e+02  1.89254208e+03  8.01936477e+03
  4.77836615e+04]
E1 = -182.5890398500091  E_coul = 54.04711724205363
Extra cycle  E= -128.541922607955  delta_E= -2.84e-14  |g|= 5.99e-07  |ddm|= 3.95e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.41 sec
exp = [7.91170743e-01 2.44137942e+04 3.66145092e+03 8.33332465e+02
 2.35309866e+02 7.63710206e+01 1.17186826e+01 2.82323243e+01
 3.01775018e-01 2.01386897e+00 5.27887339e+00 7.13497241e+00
 2.31661348e+01 9.97854643e+01 2.66186572e-01 2.45064172e+00
 8.36336973e-01]
grad_E = [-7.57426860e-05 -9.33707795e-10  5.04575384e-08 -1.08131641e-06
  1.26687135e-05 -5.16197135e-05 -1.10021618e-05 -3.62206094e-05
 -8.49453282e-05  6.21590967e-05  3.05217334e-05  1.11047214e-04
 -2.83316308e-05  1.41248611e-06 -1.51646354e-03 -1.70644524e-04
  6.68727926e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.784123137798       1
[INPUT] 0    0    [1    /1   ]  24413.7941991        1
[INPUT] 0    0    [1    /1   ]  3661.45089272        1
[INPUT] 0    0    [1    /1   ]  833.332997108        1
[INPUT] 0    0    [1    /1   ]  235.304428568        1
[INPUT] 0    0    [1    /1   ]  76.3944962307        1
[INPUT] 0    0    [1    /1   ]  11.7091091597        1
[INPUT] 0    0    [1    /1   ]  28.2147256449        1
[INPUT] 0    0    [1    /1   ]  0.301614483139       1
[INPUT] 0    0    [1    /1   ]  1.97689018148        1
[INPUT] 0    0    [1    /1   ]  5.29868251555        1
[INPUT] 1    0    [1    /1   ]  7.11683365997        1
[INPUT] 1    0    [1    /1   ]  23.1728010729        1
[INPUT] 1    0    [1    /1   ]  99.7851041461        1
[INPUT] 1    0    [1    /1   ]  0.26615795318        1
[INPUT] 1    0    [1    /1   ]  2.44340285877        1
[INPUT] 1    0    [1    /1   ]  0.834508285522       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7841231377977637, 1.0]], [0, [24413.794199123393, 1.0]], [0, [3661.4508927214856, 1.0]], [0, [833.3329971081446, 1.0]], [0, [235.30442856752254, 1.0]], [0, [76.39449623074866, 1.0]], [0, [11.709109159661484, 1.0]], [0, [28.214725644866007, 1.0]], [0, [0.3016144831386823, 1.0]], [0, [1.9768901814840592, 1.0]], [0, [5.298682515546775, 1.0]], [1, [7.11683365996628, 1.0]], [1, [23.17280107291806, 1.0]], [1, [99.78510414609539, 1.0]], [1, [0.26615795318035645, 1.0]], [1, [2.443402858773119, 1.0]], [1, [0.8345082855224613, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78412314]
bas 1, expnt(s) = [24413.79419912]
bas 2, expnt(s) = [3661.45089272]
bas 3, expnt(s) = [833.33299711]
bas 4, expnt(s) = [235.30442857]
bas 5, expnt(s) = [76.39449623]
bas 6, expnt(s) = [11.70910916]
bas 7, expnt(s) = [28.21472564]
bas 8, expnt(s) = [0.30161448]
bas 9, expnt(s) = [1.97689018]
bas 10, expnt(s) = [5.29868252]
bas 11, expnt(s) = [7.11683366]
bas 12, expnt(s) = [23.17280107]
bas 13, expnt(s) = [99.78510415]
bas 14, expnt(s) = [0.26615795]
bas 15, expnt(s) = [2.44340286]
bas 16, expnt(s) = [0.83450829]
CPU time:       275.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.84123138e-01 2.10524782e+00 2.44137942e+04 4.93448103e+03
 3.66145089e+03 1.18920009e+03 8.33332997e+02 3.91858217e+02
 2.35304429e+02 1.51788056e+02 7.63944962e+01 6.52847248e+01
 1.17091092e+01 1.59921891e+01 2.82147256e+01 3.09294287e+01
 3.01614483e-01 1.02826290e+00 1.97689018e+00 4.21213161e+00
 5.29868252e+00 8.82350118e+00 7.11683366e+00 3.39111807e+01
 2.31728011e+01 1.48322678e+02 9.97851041e+01 9.20060818e+02
 2.66157953e-01 5.57710348e-01 2.44340286e+00 8.91206283e+00
 8.34508286e-01 2.32687315e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639122228931
cond(S) = 1295.6086292072102
E1 = -183.59037772751347  E_coul = 55.080160625978394
init E= -128.510217101535
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403915157319  LUMO = 0.794036964033102
  mo_energy =
[-3.25552189e+01 -1.85274262e+00 -7.75403915e-01 -7.75403915e-01
 -7.75403915e-01  7.94036964e-01  8.24443824e-01  8.24443824e-01
  8.24443824e-01  3.95930058e+00  3.95930058e+00  3.95930058e+00
  4.43046877e+00  1.43680564e+01  1.43680564e+01  1.43680564e+01
  1.64639101e+01  5.28611829e+01  5.30259452e+01  5.30259452e+01
  5.30259452e+01  1.62857425e+02  2.40854021e+02  2.40854021e+02
  2.40854021e+02  5.27563002e+02  1.89271118e+03  8.01957481e+03
  4.77839059e+04]
E1 = -182.08596762301315  E_coul = 53.54755239225842
cycle= 1 E= -128.538415230755  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.02 sec, wall time      0.03 sec
diis-norm(errvec)=0.519406
diis-c [-0.26978282  1.        ]
  HOMO = -0.884334847752548  LUMO = 0.764935555289591
  mo_energy =
[-3.28784336e+01 -1.96664979e+00 -8.84334848e-01 -8.84334848e-01
 -8.84334848e-01  7.64935555e-01  7.97634943e-01  7.97634943e-01
  7.97634943e-01  3.86175939e+00  3.86175939e+00  3.86175939e+00
  4.34333402e+00  1.41772276e+01  1.41772276e+01  1.41772276e+01
  1.62892771e+01  5.26037986e+01  5.27449607e+01  5.27449607e+01
  5.27449607e+01  1.62540063e+02  2.40507663e+02  2.40507663e+02
  2.40507663e+02  5.27202162e+02  1.89231378e+03  8.01914812e+03
  4.77834602e+04]
E1 = -182.847477859849  E_coul = 54.30647475588292
cycle= 2 E= -128.541003103966  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264226
diis-c [-0.00073458  0.3363046   0.6636954 ]
  HOMO = -0.848714889811986  LUMO = 0.774236930543045
  mo_energy =
[-3.27703553e+01 -1.92914292e+00 -8.48714890e-01 -8.48714890e-01
 -8.48714890e-01  7.74236931e-01  8.06370850e-01  8.06370850e-01
  8.06370850e-01  3.89339119e+00  3.89339119e+00  3.89339119e+00
  4.37157671e+00  1.42404205e+01  1.42404205e+01  1.42404205e+01
  1.63469832e+01  5.26900288e+01  5.28389632e+01  5.28389632e+01
  5.28389632e+01  1.62645860e+02  2.40621312e+02  2.40621312e+02
  2.40621312e+02  5.27318726e+02  1.89243576e+03  8.01927261e+03
  4.77835857e+04]
E1 = -182.5888481524429  E_coul = 54.04692475304799
cycle= 3 E= -128.541923399395  delta_E= -0.00092  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0010895
diis-c [-1.92478764e-07 -2.39297188e-03 -9.31068596e-04  1.00332404e+00]
  HOMO = -0.848966709183337  LUMO = 0.774185006072827
  mo_energy =
[-3.27707911e+01 -1.92932982e+00 -8.48966709e-01 -8.48966709e-01
 -8.48966709e-01  7.74185006e-01  8.06332078e-01  8.06332078e-01
  8.06332078e-01  3.89321785e+00  3.89321785e+00  3.89321785e+00
  4.37142908e+00  1.42401262e+01  1.42401262e+01  1.42401262e+01
  1.63467151e+01  5.26896746e+01  5.28385776e+01  5.28385776e+01
  5.28385776e+01  1.62645420e+02  2.40620806e+02  2.40620806e+02
  2.40620806e+02  5.27318165e+02  1.89243507e+03  8.01927181e+03
  4.77835848e+04]
E1 = -182.5892349028823  E_coul = 54.04731147820382
cycle= 4 E= -128.541923424678  delta_E= -2.53e-08  |g|= 8.09e-05  |ddm|= 0.00034
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188001
diis-c [-1.12030831e-09  2.30621331e-04  5.35469796e-04 -1.83772386e-01
  1.18300629e+00]
  HOMO = -0.849010299127016  LUMO = 0.774171732052345
  mo_energy =
[-3.27708651e+01 -1.92936287e+00 -8.49010299e-01 -8.49010299e-01
 -8.49010299e-01  7.74171732e-01  8.06318526e-01  8.06318526e-01
  8.06318526e-01  3.89317716e+00  3.89317716e+00  3.89317716e+00
  4.37139552e+00  1.42400661e+01  1.42400661e+01  1.42400661e+01
  1.63466591e+01  5.26896070e+01  5.28385077e+01  5.28385077e+01
  5.28385077e+01  1.62645346e+02  2.40620728e+02  2.40620728e+02
  2.40620728e+02  5.27318083e+02  1.89243498e+03  8.01927172e+03
  4.77835847e+04]
E1 = -182.5893694132367  E_coul = 54.04744598783278
cycle= 5 E= -128.541923425404  delta_E= -7.25e-10  |g|= 5.92e-06  |ddm|= 5.67e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5893694132367  E_coul = 54.04744598783278
  HOMO = -0.849007204294743  LUMO = 0.774173056743129
  mo_energy =
[-3.27708581e+01 -1.92935897e+00 -8.49007204e-01 -8.49007204e-01
 -8.49007204e-01  7.74173057e-01  8.06319439e-01  8.06319439e-01
  8.06319439e-01  3.89318013e+00  3.89318013e+00  3.89318013e+00
  4.37139854e+00  1.42400712e+01  1.42400712e+01  1.42400712e+01
  1.63466641e+01  5.26896133e+01  5.28385143e+01  5.28385143e+01
  5.28385143e+01  1.62645352e+02  2.40620735e+02  2.40620735e+02
  2.40620735e+02  5.27318089e+02  1.89243499e+03  8.01927172e+03
  4.77835847e+04]
E1 = -182.58935361124838  E_coul = 54.047430185841534
Extra cycle  E= -128.541923425407  delta_E= -2.93e-12  |g|= 2.23e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.17 sec
exp = [7.84123138e-01 2.44137942e+04 3.66145089e+03 8.33332997e+02
 2.35304429e+02 7.63944962e+01 1.17091092e+01 2.82147256e+01
 3.01614483e-01 1.97689018e+00 5.29868252e+00 7.11683366e+00
 2.31728011e+01 9.97851041e+01 2.66157953e-01 2.44340286e+00
 8.34508286e-01]
E = -128.54192342540685
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.784123137798       1
[INPUT] 0    0    [1    /1   ]  24413.7941991        1
[INPUT] 0    0    [1    /1   ]  3661.45089272        1
[INPUT] 0    0    [1    /1   ]  833.332997108        1
[INPUT] 0    0    [1    /1   ]  235.304428568        1
[INPUT] 0    0    [1    /1   ]  76.3944962307        1
[INPUT] 0    0    [1    /1   ]  11.7091091597        1
[INPUT] 0    0    [1    /1   ]  28.2147256449        1
[INPUT] 0    0    [1    /1   ]  0.301614483139       1
[INPUT] 0    0    [1    /1   ]  1.97689018148        1
[INPUT] 0    0    [1    /1   ]  5.29868251555        1
[INPUT] 1    0    [1    /1   ]  7.11683365997        1
[INPUT] 1    0    [1    /1   ]  23.1728010729        1
[INPUT] 1    0    [1    /1   ]  99.7851041461        1
[INPUT] 1    0    [1    /1   ]  0.26615795318        1
[INPUT] 1    0    [1    /1   ]  2.44340285877        1
[INPUT] 1    0    [1    /1   ]  0.834508285522       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7841231377977637, 1.0]], [0, [24413.794199123393, 1.0]], [0, [3661.4508927214856, 1.0]], [0, [833.3329971081446, 1.0]], [0, [235.30442856752254, 1.0]], [0, [76.39449623074866, 1.0]], [0, [11.709109159661484, 1.0]], [0, [28.214725644866007, 1.0]], [0, [0.3016144831386823, 1.0]], [0, [1.9768901814840592, 1.0]], [0, [5.298682515546775, 1.0]], [1, [7.11683365996628, 1.0]], [1, [23.17280107291806, 1.0]], [1, [99.78510414609539, 1.0]], [1, [0.26615795318035645, 1.0]], [1, [2.443402858773119, 1.0]], [1, [0.8345082855224613, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78412314]
bas 1, expnt(s) = [24413.79419912]
bas 2, expnt(s) = [3661.45089272]
bas 3, expnt(s) = [833.33299711]
bas 4, expnt(s) = [235.30442857]
bas 5, expnt(s) = [76.39449623]
bas 6, expnt(s) = [11.70910916]
bas 7, expnt(s) = [28.21472564]
bas 8, expnt(s) = [0.30161448]
bas 9, expnt(s) = [1.97689018]
bas 10, expnt(s) = [5.29868252]
bas 11, expnt(s) = [7.11683366]
bas 12, expnt(s) = [23.17280107]
bas 13, expnt(s) = [99.78510415]
bas 14, expnt(s) = [0.26615795]
bas 15, expnt(s) = [2.44340286]
bas 16, expnt(s) = [0.83450829]
CPU time:       276.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.84123138e-01 2.10524782e+00 2.44137942e+04 4.93448103e+03
 3.66145089e+03 1.18920009e+03 8.33332997e+02 3.91858217e+02
 2.35304429e+02 1.51788056e+02 7.63944962e+01 6.52847248e+01
 1.17091092e+01 1.59921891e+01 2.82147256e+01 3.09294287e+01
 3.01614483e-01 1.02826290e+00 1.97689018e+00 4.21213161e+00
 5.29868252e+00 8.82350118e+00 7.11683366e+00 3.39111807e+01
 2.31728011e+01 1.48322678e+02 9.97851041e+01 9.20060818e+02
 2.66157953e-01 5.57710348e-01 2.44340286e+00 8.91206283e+00
 8.34508286e-01 2.32687315e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639122228931
cond(S) = 1295.6086292072102
E1 = -183.59037772751347  E_coul = 55.080160625978394
init E= -128.510217101535
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403915157319  LUMO = 0.794036964033102
  mo_energy =
[-3.25552189e+01 -1.85274262e+00 -7.75403915e-01 -7.75403915e-01
 -7.75403915e-01  7.94036964e-01  8.24443824e-01  8.24443824e-01
  8.24443824e-01  3.95930058e+00  3.95930058e+00  3.95930058e+00
  4.43046877e+00  1.43680564e+01  1.43680564e+01  1.43680564e+01
  1.64639101e+01  5.28611829e+01  5.30259452e+01  5.30259452e+01
  5.30259452e+01  1.62857425e+02  2.40854021e+02  2.40854021e+02
  2.40854021e+02  5.27563002e+02  1.89271118e+03  8.01957481e+03
  4.77839059e+04]
E1 = -182.08596762301315  E_coul = 53.54755239225842
cycle= 1 E= -128.538415230755  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519406
diis-c [-0.26978282  1.        ]
  HOMO = -0.884334847752548  LUMO = 0.764935555289591
  mo_energy =
[-3.28784336e+01 -1.96664979e+00 -8.84334848e-01 -8.84334848e-01
 -8.84334848e-01  7.64935555e-01  7.97634943e-01  7.97634943e-01
  7.97634943e-01  3.86175939e+00  3.86175939e+00  3.86175939e+00
  4.34333402e+00  1.41772276e+01  1.41772276e+01  1.41772276e+01
  1.62892771e+01  5.26037986e+01  5.27449607e+01  5.27449607e+01
  5.27449607e+01  1.62540063e+02  2.40507663e+02  2.40507663e+02
  2.40507663e+02  5.27202162e+02  1.89231378e+03  8.01914812e+03
  4.77834602e+04]
E1 = -182.847477859849  E_coul = 54.30647475588292
cycle= 2 E= -128.541003103966  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264226
diis-c [-0.00073458  0.3363046   0.6636954 ]
  HOMO = -0.848714889811986  LUMO = 0.774236930543045
  mo_energy =
[-3.27703553e+01 -1.92914292e+00 -8.48714890e-01 -8.48714890e-01
 -8.48714890e-01  7.74236931e-01  8.06370850e-01  8.06370850e-01
  8.06370850e-01  3.89339119e+00  3.89339119e+00  3.89339119e+00
  4.37157671e+00  1.42404205e+01  1.42404205e+01  1.42404205e+01
  1.63469832e+01  5.26900288e+01  5.28389632e+01  5.28389632e+01
  5.28389632e+01  1.62645860e+02  2.40621312e+02  2.40621312e+02
  2.40621312e+02  5.27318726e+02  1.89243576e+03  8.01927261e+03
  4.77835857e+04]
E1 = -182.5888481524429  E_coul = 54.04692475304799
cycle= 3 E= -128.541923399395  delta_E= -0.00092  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0010895
diis-c [-1.92478764e-07 -2.39297188e-03 -9.31068596e-04  1.00332404e+00]
  HOMO = -0.848966709183337  LUMO = 0.774185006072827
  mo_energy =
[-3.27707911e+01 -1.92932982e+00 -8.48966709e-01 -8.48966709e-01
 -8.48966709e-01  7.74185006e-01  8.06332078e-01  8.06332078e-01
  8.06332078e-01  3.89321785e+00  3.89321785e+00  3.89321785e+00
  4.37142908e+00  1.42401262e+01  1.42401262e+01  1.42401262e+01
  1.63467151e+01  5.26896746e+01  5.28385776e+01  5.28385776e+01
  5.28385776e+01  1.62645420e+02  2.40620806e+02  2.40620806e+02
  2.40620806e+02  5.27318165e+02  1.89243507e+03  8.01927181e+03
  4.77835848e+04]
E1 = -182.5892349028823  E_coul = 54.04731147820382
cycle= 4 E= -128.541923424678  delta_E= -2.53e-08  |g|= 8.09e-05  |ddm|= 0.00034
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188001
diis-c [-1.12030831e-09  2.30621331e-04  5.35469796e-04 -1.83772386e-01
  1.18300629e+00]
  HOMO = -0.849010299127016  LUMO = 0.774171732052345
  mo_energy =
[-3.27708651e+01 -1.92936287e+00 -8.49010299e-01 -8.49010299e-01
 -8.49010299e-01  7.74171732e-01  8.06318526e-01  8.06318526e-01
  8.06318526e-01  3.89317716e+00  3.89317716e+00  3.89317716e+00
  4.37139552e+00  1.42400661e+01  1.42400661e+01  1.42400661e+01
  1.63466591e+01  5.26896070e+01  5.28385077e+01  5.28385077e+01
  5.28385077e+01  1.62645346e+02  2.40620728e+02  2.40620728e+02
  2.40620728e+02  5.27318083e+02  1.89243498e+03  8.01927172e+03
  4.77835847e+04]
E1 = -182.5893694132367  E_coul = 54.04744598783278
cycle= 5 E= -128.541923425404  delta_E= -7.25e-10  |g|= 5.92e-06  |ddm|= 5.67e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5893694132367  E_coul = 54.04744598783278
  HOMO = -0.849007204294743  LUMO = 0.774173056743129
  mo_energy =
[-3.27708581e+01 -1.92935897e+00 -8.49007204e-01 -8.49007204e-01
 -8.49007204e-01  7.74173057e-01  8.06319439e-01  8.06319439e-01
  8.06319439e-01  3.89318013e+00  3.89318013e+00  3.89318013e+00
  4.37139854e+00  1.42400712e+01  1.42400712e+01  1.42400712e+01
  1.63466641e+01  5.26896133e+01  5.28385143e+01  5.28385143e+01
  5.28385143e+01  1.62645352e+02  2.40620735e+02  2.40620735e+02
  2.40620735e+02  5.27318089e+02  1.89243499e+03  8.01927172e+03
  4.77835847e+04]
E1 = -182.58935361124838  E_coul = 54.047430185841534
Extra cycle  E= -128.541923425407  delta_E= -2.93e-12  |g|= 2.23e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1295.6086292072102
E1 = -182.58935361124838  E_coul = 54.047430185841534
init E= -128.541923425407
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.849008322875198  LUMO = 0.774172847928841
  mo_energy =
[-3.27708616e+01 -1.92936000e+00 -8.49008323e-01 -8.49008323e-01
 -8.49008323e-01  7.74172848e-01  8.06319182e-01  8.06319182e-01
  8.06319182e-01  3.89317916e+00  3.89317916e+00  3.89317916e+00
  4.37139775e+00  1.42400692e+01  1.42400692e+01  1.42400692e+01
  1.63466623e+01  5.26896106e+01  5.28385112e+01  5.28385112e+01
  5.28385112e+01  1.62645349e+02  2.40620731e+02  2.40620731e+02
  2.40620731e+02  5.27318085e+02  1.89243498e+03  8.01927172e+03
  4.77835847e+04]
E1 = -182.58936239318348  E_coul = 54.047438967776515
cycle= 1 E= -128.541923425407  delta_E= -1.14e-13  |g|= 1.2e-06  |ddm|= 7.99e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58936239318348  E_coul = 54.047438967776515
  HOMO = -0.8490077047777  LUMO = 0.774173026092578
  mo_energy =
[-3.27708598e+01 -1.92935932e+00 -8.49007705e-01 -8.49007705e-01
 -8.49007705e-01  7.74173026e-01  8.06319337e-01  8.06319337e-01
  8.06319337e-01  3.89317972e+00  3.89317972e+00  3.89317972e+00
  4.37139826e+00  1.42400703e+01  1.42400703e+01  1.42400703e+01
  1.63466633e+01  5.26896121e+01  5.28385129e+01  5.28385129e+01
  5.28385129e+01  1.62645351e+02  2.40620733e+02  2.40620733e+02
  2.40620733e+02  5.27318087e+02  1.89243498e+03  8.01927172e+03
  4.77835847e+04]
E1 = -182.58935797983946  E_coul = 54.04743455443261
Extra cycle  E= -128.541923425407  delta_E= 1.14e-13  |g|= 5.99e-07  |ddm|= 3.95e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [7.84123138e-01 2.44137942e+04 3.66145089e+03 8.33332997e+02
 2.35304429e+02 7.63944962e+01 1.17091092e+01 2.82147256e+01
 3.01614483e-01 1.97689018e+00 5.29868252e+00 7.11683366e+00
 2.31728011e+01 9.97851041e+01 2.66157953e-01 2.44340286e+00
 8.34508286e-01]
grad_E = [ 2.46680765e-04 -7.91084918e-10  4.30353213e-08 -9.41308016e-07
  1.12738875e-05 -4.50456351e-05  4.83876637e-06 -4.94734203e-05
 -2.16071341e-04 -1.05772176e-04  3.18899903e-05 -5.28603383e-06
 -8.53523963e-07  6.79268288e-08 -1.75724116e-04  1.88583783e-05
  8.06634554e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.786447392414       1
[INPUT] 0    0    [1    /1   ]  24413.7941988        1
[INPUT] 0    0    [1    /1   ]  3661.45090873        1
[INPUT] 0    0    [1    /1   ]  833.332691719        1
[INPUT] 0    0    [1    /1   ]  235.307590157        1
[INPUT] 0    0    [1    /1   ]  76.3786826492        1
[INPUT] 0    0    [1    /1   ]  11.7232218021        1
[INPUT] 0    0    [1    /1   ]  28.2366980896        1
[INPUT] 0    0    [1    /1   ]  0.301765107854       1
[INPUT] 0    0    [1    /1   ]  1.99549662466        1
[INPUT] 0    0    [1    /1   ]  5.3002107525         1
[INPUT] 1    0    [1    /1   ]  7.11423124282        1
[INPUT] 1    0    [1    /1   ]  23.1737651006        1
[INPUT] 1    0    [1    /1   ]  99.7850555902        1
[INPUT] 1    0    [1    /1   ]  0.266012158196       1
[INPUT] 1    0    [1    /1   ]  2.44144037245        1
[INPUT] 1    0    [1    /1   ]  0.833740449215       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7864473924140624, 1.0]], [0, [24413.794198816533, 1.0]], [0, [3661.4509087287233, 1.0]], [0, [833.3326917192162, 1.0]], [0, [235.30759015716876, 1.0]], [0, [76.3786826492268, 1.0]], [0, [11.723221802075557, 1.0]], [0, [28.236698089621598, 1.0]], [0, [0.30176510785414584, 1.0]], [0, [1.9954966246600163, 1.0]], [0, [5.300210752500469, 1.0]], [1, [7.114231242822681, 1.0]], [1, [23.17376510063451, 1.0]], [1, [99.78505559018274, 1.0]], [1, [0.2660121581957151, 1.0]], [1, [2.441440372449861, 1.0]], [1, [0.8337404492153371, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78644739]
bas 1, expnt(s) = [24413.79419882]
bas 2, expnt(s) = [3661.45090873]
bas 3, expnt(s) = [833.33269172]
bas 4, expnt(s) = [235.30759016]
bas 5, expnt(s) = [76.37868265]
bas 6, expnt(s) = [11.7232218]
bas 7, expnt(s) = [28.23669809]
bas 8, expnt(s) = [0.30176511]
bas 9, expnt(s) = [1.99549662]
bas 10, expnt(s) = [5.30021075]
bas 11, expnt(s) = [7.11423124]
bas 12, expnt(s) = [23.1737651]
bas 13, expnt(s) = [99.78505559]
bas 14, expnt(s) = [0.26601216]
bas 15, expnt(s) = [2.44144037]
bas 16, expnt(s) = [0.83374045]
CPU time:       280.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.86447392e-01 2.10992628e+00 2.44137942e+04 4.93448103e+03
 3.66145091e+03 1.18920010e+03 8.33332692e+02 3.91858110e+02
 2.35307590e+02 1.51789586e+02 7.63786826e+01 6.52745891e+01
 1.17232218e+01 1.60066431e+01 2.82366981e+01 3.09474918e+01
 3.01765108e-01 1.02864801e+00 1.99549662e+00 4.24183013e+00
 5.30021075e+00 8.82540975e+00 7.11423124e+00 3.38956811e+01
 2.31737651e+01 1.48330392e+02 9.97850556e+01 9.20060259e+02
 2.66012158e-01 5.57328499e-01 2.44144037e+00 8.90311627e+00
 8.33740449e-01 2.32419725e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99964060272198
cond(S) = 1306.5084402349082
E1 = -183.5904165867064  E_coul = 55.08016620503051
init E= -128.510250381676
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403807121072  LUMO = 0.79605694910901
  mo_energy =
[-3.25552175e+01 -1.85274266e+00 -7.75403807e-01 -7.75403807e-01
 -7.75403807e-01  7.96056949e-01  8.23803451e-01  8.23803451e-01
  8.23803451e-01  3.95571823e+00  3.95571823e+00  3.95571823e+00
  4.45444881e+00  1.43574383e+01  1.43574383e+01  1.43574383e+01
  1.65367971e+01  5.29866232e+01  5.30100622e+01  5.30100622e+01
  5.30100622e+01  1.63033402e+02  2.40842097e+02  2.40842097e+02
  2.40842097e+02  5.27740246e+02  1.89286949e+03  8.01971440e+03
  4.77840215e+04]
E1 = -182.08592325598272  E_coul = 53.547507714840876
cycle= 1 E= -128.538415541142  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519439
diis-c [-0.2698169  1.       ]
  HOMO = -0.884337951724548  LUMO = 0.766848872173051
  mo_energy =
[-3.28784419e+01 -1.96665502e+00 -8.84337952e-01 -8.84337952e-01
 -8.84337952e-01  7.66848872e-01  7.97025869e-01  7.97025869e-01
  7.97025869e-01  3.85823738e+00  3.85823738e+00  3.85823738e+00
  4.36690166e+00  1.41666435e+01  1.41666435e+01  1.41666435e+01
  1.63619350e+01  5.27290637e+01  5.27290637e+01  5.27290637e+01
  5.27291810e+01  1.62716031e+02  2.40495726e+02  2.40495726e+02
  2.40495726e+02  5.27379404e+02  1.89247208e+03  8.01928770e+03
  4.77835759e+04]
E1 = -182.8475149011888  E_coul = 54.30651122000796
cycle= 2 E= -128.541003681181  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264256
diis-c [-0.00073523  0.33631466  0.66368534]
  HOMO = -0.848714356984111  LUMO = 0.776186799957251
  mo_energy =
[-3.27703553e+01 -1.92914420e+00 -8.48714357e-01 -8.48714357e-01
 -8.48714357e-01  7.76186800e-01  8.05753460e-01  8.05753460e-01
  8.05753460e-01  3.88985113e+00  3.88985113e+00  3.88985113e+00
  4.39528288e+00  1.42298298e+01  1.42298298e+01  1.42298298e+01
  1.64197219e+01  5.28154344e+01  5.28230751e+01  5.28230751e+01
  5.28230751e+01  1.62821836e+02  2.40609385e+02  2.40609385e+02
  2.40609385e+02  5.27495975e+02  1.89259407e+03  8.01941220e+03
  4.77837013e+04]
E1 = -182.58886952964812  E_coul = 54.04694540675412
cycle= 3 E= -128.541924122894  delta_E= -0.00092  |g|= 0.000495  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010853
diis-c [-1.91669452e-07 -2.38759578e-03 -9.36687562e-04  1.00332428e+00]
  HOMO = -0.848964821924599  LUMO = 0.77613542922501
  mo_energy =
[-3.27707889e+01 -1.92932972e+00 -8.48964822e-01 -8.48964822e-01
 -8.48964822e-01  7.76135429e-01  8.05715290e-01  8.05715290e-01
  8.05715290e-01  3.88967918e+00  3.88967918e+00  3.88967918e+00
  4.39513599e+00  1.42295374e+01  1.42295374e+01  1.42295374e+01
  1.64194553e+01  5.28150822e+01  5.28226915e+01  5.28226915e+01
  5.28226915e+01  1.62821398e+02  2.40608881e+02  2.40608881e+02
  2.40608881e+02  5.27495416e+02  1.89259338e+03  8.01941141e+03
  4.77837004e+04]
E1 = -182.5892546348265  E_coul = 54.04733048699564
cycle= 4 E= -128.541924147831  delta_E= -2.49e-08  |g|= 8.06e-05  |ddm|= 0.000335
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187578
diis-c [-1.12125071e-09  2.31091875e-04  5.36596448e-04 -1.84010256e-01
  1.18324257e+00]
  HOMO = -0.849008205907344  LUMO = 0.776122222262195
  mo_energy =
[-3.27708627e+01 -1.92936256e+00 -8.49008206e-01 -8.49008206e-01
 -8.49008206e-01  7.76122222e-01  8.05701832e-01  8.05701832e-01
  8.05701832e-01  3.88963872e+00  3.88963872e+00  3.88963872e+00
  4.39510252e+00  1.42294776e+01  1.42294776e+01  1.42294776e+01
  1.64193995e+01  5.28150149e+01  5.28226219e+01  5.28226219e+01
  5.28226219e+01  1.62821324e+02  2.40608803e+02  2.40608803e+02
  2.40608803e+02  5.27495334e+02  1.89259329e+03  8.01941131e+03
  4.77837003e+04]
E1 = -182.58938907205854  E_coul = 54.04746492350813
cycle= 5 E= -128.54192414855  delta_E= -7.2e-10  |g|= 5.93e-06  |ddm|= 5.6e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58938907205854  E_coul = 54.04746492350813
  HOMO = -0.849005103625461  LUMO = 0.776123552412429
  mo_energy =
[-3.27708557e+01 -1.92935865e+00 -8.49005104e-01 -8.49005104e-01
 -8.49005104e-01  7.76123552e-01  8.05702745e-01  8.05702745e-01
  8.05702745e-01  3.88964169e+00  3.88964169e+00  3.88964169e+00
  4.39510555e+00  1.42294827e+01  1.42294827e+01  1.42294827e+01
  1.64194045e+01  5.28150213e+01  5.28226285e+01  5.28226285e+01
  5.28226285e+01  1.62821330e+02  2.40608809e+02  2.40608809e+02
  2.40608809e+02  5.27495341e+02  1.89259330e+03  8.01941132e+03
  4.77837004e+04]
E1 = -182.589373226399  E_coul = 54.047449077845904
Extra cycle  E= -128.541924148553  delta_E= -2.7e-12  |g|= 2.23e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.86447392e-01 2.44137942e+04 3.66145091e+03 8.33332692e+02
 2.35307590e+02 7.63786826e+01 1.17232218e+01 2.82366981e+01
 3.01765108e-01 1.99549662e+00 5.30021075e+00 7.11423124e+00
 2.31737651e+01 9.97850556e+01 2.66012158e-01 2.44144037e+00
 8.33740449e-01]
E = -128.5419241485531
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.786447392414       1
[INPUT] 0    0    [1    /1   ]  24413.7941988        1
[INPUT] 0    0    [1    /1   ]  3661.45090873        1
[INPUT] 0    0    [1    /1   ]  833.332691719        1
[INPUT] 0    0    [1    /1   ]  235.307590157        1
[INPUT] 0    0    [1    /1   ]  76.3786826492        1
[INPUT] 0    0    [1    /1   ]  11.7232218021        1
[INPUT] 0    0    [1    /1   ]  28.2366980896        1
[INPUT] 0    0    [1    /1   ]  0.301765107854       1
[INPUT] 0    0    [1    /1   ]  1.99549662466        1
[INPUT] 0    0    [1    /1   ]  5.3002107525         1
[INPUT] 1    0    [1    /1   ]  7.11423124282        1
[INPUT] 1    0    [1    /1   ]  23.1737651006        1
[INPUT] 1    0    [1    /1   ]  99.7850555902        1
[INPUT] 1    0    [1    /1   ]  0.266012158196       1
[INPUT] 1    0    [1    /1   ]  2.44144037245        1
[INPUT] 1    0    [1    /1   ]  0.833740449215       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7864473924140624, 1.0]], [0, [24413.794198816533, 1.0]], [0, [3661.4509087287233, 1.0]], [0, [833.3326917192162, 1.0]], [0, [235.30759015716876, 1.0]], [0, [76.3786826492268, 1.0]], [0, [11.723221802075557, 1.0]], [0, [28.236698089621598, 1.0]], [0, [0.30176510785414584, 1.0]], [0, [1.9954966246600163, 1.0]], [0, [5.300210752500469, 1.0]], [1, [7.114231242822681, 1.0]], [1, [23.17376510063451, 1.0]], [1, [99.78505559018274, 1.0]], [1, [0.2660121581957151, 1.0]], [1, [2.441440372449861, 1.0]], [1, [0.8337404492153371, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78644739]
bas 1, expnt(s) = [24413.79419882]
bas 2, expnt(s) = [3661.45090873]
bas 3, expnt(s) = [833.33269172]
bas 4, expnt(s) = [235.30759016]
bas 5, expnt(s) = [76.37868265]
bas 6, expnt(s) = [11.7232218]
bas 7, expnt(s) = [28.23669809]
bas 8, expnt(s) = [0.30176511]
bas 9, expnt(s) = [1.99549662]
bas 10, expnt(s) = [5.30021075]
bas 11, expnt(s) = [7.11423124]
bas 12, expnt(s) = [23.1737651]
bas 13, expnt(s) = [99.78505559]
bas 14, expnt(s) = [0.26601216]
bas 15, expnt(s) = [2.44144037]
bas 16, expnt(s) = [0.83374045]
CPU time:       281.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.86447392e-01 2.10992628e+00 2.44137942e+04 4.93448103e+03
 3.66145091e+03 1.18920010e+03 8.33332692e+02 3.91858110e+02
 2.35307590e+02 1.51789586e+02 7.63786826e+01 6.52745891e+01
 1.17232218e+01 1.60066431e+01 2.82366981e+01 3.09474918e+01
 3.01765108e-01 1.02864801e+00 1.99549662e+00 4.24183013e+00
 5.30021075e+00 8.82540975e+00 7.11423124e+00 3.38956811e+01
 2.31737651e+01 1.48330392e+02 9.97850556e+01 9.20060259e+02
 2.66012158e-01 5.57328499e-01 2.44144037e+00 8.90311627e+00
 8.33740449e-01 2.32419725e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99964060272198
cond(S) = 1306.5084402349082
E1 = -183.5904165867064  E_coul = 55.08016620503051
init E= -128.510250381676
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403807121072  LUMO = 0.79605694910901
  mo_energy =
[-3.25552175e+01 -1.85274266e+00 -7.75403807e-01 -7.75403807e-01
 -7.75403807e-01  7.96056949e-01  8.23803451e-01  8.23803451e-01
  8.23803451e-01  3.95571823e+00  3.95571823e+00  3.95571823e+00
  4.45444881e+00  1.43574383e+01  1.43574383e+01  1.43574383e+01
  1.65367971e+01  5.29866232e+01  5.30100622e+01  5.30100622e+01
  5.30100622e+01  1.63033402e+02  2.40842097e+02  2.40842097e+02
  2.40842097e+02  5.27740246e+02  1.89286949e+03  8.01971440e+03
  4.77840215e+04]
E1 = -182.08592325598272  E_coul = 53.547507714840876
cycle= 1 E= -128.538415541142  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519439
diis-c [-0.2698169  1.       ]
  HOMO = -0.884337951724548  LUMO = 0.766848872173051
  mo_energy =
[-3.28784419e+01 -1.96665502e+00 -8.84337952e-01 -8.84337952e-01
 -8.84337952e-01  7.66848872e-01  7.97025869e-01  7.97025869e-01
  7.97025869e-01  3.85823738e+00  3.85823738e+00  3.85823738e+00
  4.36690166e+00  1.41666435e+01  1.41666435e+01  1.41666435e+01
  1.63619350e+01  5.27290637e+01  5.27290637e+01  5.27290637e+01
  5.27291810e+01  1.62716031e+02  2.40495726e+02  2.40495726e+02
  2.40495726e+02  5.27379404e+02  1.89247208e+03  8.01928770e+03
  4.77835759e+04]
E1 = -182.8475149011888  E_coul = 54.30651122000796
cycle= 2 E= -128.541003681181  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264256
diis-c [-0.00073523  0.33631466  0.66368534]
  HOMO = -0.848714356984111  LUMO = 0.776186799957251
  mo_energy =
[-3.27703553e+01 -1.92914420e+00 -8.48714357e-01 -8.48714357e-01
 -8.48714357e-01  7.76186800e-01  8.05753460e-01  8.05753460e-01
  8.05753460e-01  3.88985113e+00  3.88985113e+00  3.88985113e+00
  4.39528288e+00  1.42298298e+01  1.42298298e+01  1.42298298e+01
  1.64197219e+01  5.28154344e+01  5.28230751e+01  5.28230751e+01
  5.28230751e+01  1.62821836e+02  2.40609385e+02  2.40609385e+02
  2.40609385e+02  5.27495975e+02  1.89259407e+03  8.01941220e+03
  4.77837013e+04]
E1 = -182.58886952964812  E_coul = 54.04694540675412
cycle= 3 E= -128.541924122894  delta_E= -0.00092  |g|= 0.000495  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010853
diis-c [-1.91669452e-07 -2.38759578e-03 -9.36687562e-04  1.00332428e+00]
  HOMO = -0.848964821924599  LUMO = 0.77613542922501
  mo_energy =
[-3.27707889e+01 -1.92932972e+00 -8.48964822e-01 -8.48964822e-01
 -8.48964822e-01  7.76135429e-01  8.05715290e-01  8.05715290e-01
  8.05715290e-01  3.88967918e+00  3.88967918e+00  3.88967918e+00
  4.39513599e+00  1.42295374e+01  1.42295374e+01  1.42295374e+01
  1.64194553e+01  5.28150822e+01  5.28226915e+01  5.28226915e+01
  5.28226915e+01  1.62821398e+02  2.40608881e+02  2.40608881e+02
  2.40608881e+02  5.27495416e+02  1.89259338e+03  8.01941141e+03
  4.77837004e+04]
E1 = -182.5892546348265  E_coul = 54.04733048699564
cycle= 4 E= -128.541924147831  delta_E= -2.49e-08  |g|= 8.06e-05  |ddm|= 0.000335
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187578
diis-c [-1.12125071e-09  2.31091875e-04  5.36596448e-04 -1.84010256e-01
  1.18324257e+00]
  HOMO = -0.849008205907344  LUMO = 0.776122222262195
  mo_energy =
[-3.27708627e+01 -1.92936256e+00 -8.49008206e-01 -8.49008206e-01
 -8.49008206e-01  7.76122222e-01  8.05701832e-01  8.05701832e-01
  8.05701832e-01  3.88963872e+00  3.88963872e+00  3.88963872e+00
  4.39510252e+00  1.42294776e+01  1.42294776e+01  1.42294776e+01
  1.64193995e+01  5.28150149e+01  5.28226219e+01  5.28226219e+01
  5.28226219e+01  1.62821324e+02  2.40608803e+02  2.40608803e+02
  2.40608803e+02  5.27495334e+02  1.89259329e+03  8.01941131e+03
  4.77837003e+04]
E1 = -182.58938907205854  E_coul = 54.04746492350813
cycle= 5 E= -128.54192414855  delta_E= -7.2e-10  |g|= 5.93e-06  |ddm|= 5.6e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58938907205854  E_coul = 54.04746492350813
  HOMO = -0.849005103625461  LUMO = 0.776123552412429
  mo_energy =
[-3.27708557e+01 -1.92935865e+00 -8.49005104e-01 -8.49005104e-01
 -8.49005104e-01  7.76123552e-01  8.05702745e-01  8.05702745e-01
  8.05702745e-01  3.88964169e+00  3.88964169e+00  3.88964169e+00
  4.39510555e+00  1.42294827e+01  1.42294827e+01  1.42294827e+01
  1.64194045e+01  5.28150213e+01  5.28226285e+01  5.28226285e+01
  5.28226285e+01  1.62821330e+02  2.40608809e+02  2.40608809e+02
  2.40608809e+02  5.27495341e+02  1.89259330e+03  8.01941132e+03
  4.77837004e+04]
E1 = -182.589373226399  E_coul = 54.047449077845904
Extra cycle  E= -128.541924148553  delta_E= -2.7e-12  |g|= 2.23e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1306.5084402349082
E1 = -182.589373226399  E_coul = 54.047449077845904
init E= -128.541924148553
    CPU time for initialize scf      0.34 sec, wall time      0.34 sec
  HOMO = -0.84900622519832  LUMO = 0.776123341708317
  mo_energy =
[-3.27708592e+01 -1.92935969e+00 -8.49006225e-01 -8.49006225e-01
 -8.49006225e-01  7.76123342e-01  8.05702489e-01  8.05702489e-01
  8.05702489e-01  3.88964072e+00  3.88964072e+00  3.88964072e+00
  4.39510475e+00  1.42294807e+01  1.42294807e+01  1.42294807e+01
  1.64194027e+01  5.28150185e+01  5.28226255e+01  5.28226255e+01
  5.28226255e+01  1.62821327e+02  2.40608806e+02  2.40608806e+02
  2.40608806e+02  5.27495337e+02  1.89259329e+03  8.01941131e+03
  4.77837003e+04]
E1 = -182.58938203009302  E_coul = 54.047457881539735
cycle= 1 E= -128.541924148553  delta_E= -1.71e-13  |g|= 1.21e-06  |ddm|= 8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58938203009302  E_coul = 54.047457881539735
  HOMO = -0.84900560554773  LUMO = 0.776123520889847
  mo_energy =
[-3.27708573e+01 -1.92935900e+00 -8.49005606e-01 -8.49005606e-01
 -8.49005606e-01  7.76123521e-01  8.05702644e-01  8.05702644e-01
  8.05702644e-01  3.88964127e+00  3.88964127e+00  3.88964127e+00
  4.39510527e+00  1.42294818e+01  1.42294818e+01  1.42294818e+01
  1.64194037e+01  5.28150200e+01  5.28226271e+01  5.28226271e+01
  5.28226271e+01  1.62821329e+02  2.40608808e+02  2.40608808e+02
  2.40608808e+02  5.27495339e+02  1.89259329e+03  8.01941132e+03
  4.77837004e+04]
E1 = -182.58937760538134  E_coul = 54.04745345682777
Extra cycle  E= -128.541924148554  delta_E= -2.84e-13  |g|= 6.01e-07  |ddm|= 3.96e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [7.86447392e-01 2.44137942e+04 3.66145091e+03 8.33332692e+02
 2.35307590e+02 7.63786826e+01 1.17232218e+01 2.82366981e+01
 3.01765108e-01 1.99549662e+00 5.30021075e+00 7.11423124e+00
 2.31737651e+01 9.97850556e+01 2.66012158e-01 2.44144037e+00
 8.33740449e-01]
grad_E = [-8.60708322e-05 -9.23818303e-10  4.99620905e-08 -1.07355204e-06
  1.26399570e-05 -5.19980082e-05 -1.34882736e-05 -3.38027477e-05
  9.53724748e-05  2.35330490e-05  3.51665252e-05 -8.29533260e-07
  7.15722893e-07 -4.06558872e-08 -2.46360000e-05 -4.16185439e-06
  1.12299886e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.787377206391       1
[INPUT] 0    0    [1    /1   ]  24413.7941985        1
[INPUT] 0    0    [1    /1   ]  3661.45092355        1
[INPUT] 0    0    [1    /1   ]  833.332398322        1
[INPUT] 0    0    [1    /1   ]  235.310552589        1
[INPUT] 0    0    [1    /1   ]  76.3703159121        1
[INPUT] 0    0    [1    /1   ]  11.7048159363        1
[INPUT] 0    0    [1    /1   ]  28.2232623477        1
[INPUT] 0    0    [1    /1   ]  0.301959843669       1
[INPUT] 0    0    [1    /1   ]  1.99518346045        1
[INPUT] 0    0    [1    /1   ]  5.26472821194        1
[INPUT] 1    0    [1    /1   ]  7.11610758943        1
[INPUT] 1    0    [1    /1   ]  23.172998321         1
[INPUT] 1    0    [1    /1   ]  99.7851135844        1
[INPUT] 1    0    [1    /1   ]  0.266063226108       1
[INPUT] 1    0    [1    /1   ]  2.44234210247        1
[INPUT] 1    0    [1    /1   ]  0.834014583059       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.787377206391062, 1.0]], [0, [24413.79419853852, 1.0]], [0, [3661.4509235529504, 1.0]], [0, [833.3323983221015, 1.0]], [0, [235.3105525885796, 1.0]], [0, [76.37031591211124, 1.0]], [0, [11.704815936285321, 1.0]], [0, [28.22326234765314, 1.0]], [0, [0.30195984366908585, 1.0]], [0, [1.9951834604515035, 1.0]], [0, [5.264728211938341, 1.0]], [1, [7.1161075894339545, 1.0]], [1, [23.172998321035884, 1.0]], [1, [99.78511358440828, 1.0]], [1, [0.26606322610793426, 1.0]], [1, [2.442342102474693, 1.0]], [1, [0.8340145830588799, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78737721]
bas 1, expnt(s) = [24413.79419854]
bas 2, expnt(s) = [3661.45092355]
bas 3, expnt(s) = [833.33239832]
bas 4, expnt(s) = [235.31055259]
bas 5, expnt(s) = [76.37031591]
bas 6, expnt(s) = [11.70481594]
bas 7, expnt(s) = [28.22326235]
bas 8, expnt(s) = [0.30195984]
bas 9, expnt(s) = [1.99518346]
bas 10, expnt(s) = [5.26472821]
bas 11, expnt(s) = [7.11610759]
bas 12, expnt(s) = [23.17299832]
bas 13, expnt(s) = [99.78511358]
bas 14, expnt(s) = [0.26606323]
bas 15, expnt(s) = [2.4423421]
bas 16, expnt(s) = [0.83401458]
CPU time:       285.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.87377206e-01 2.11179692e+00 2.44137942e+04 4.93448103e+03
 3.66145092e+03 1.18920010e+03 8.33332398e+02 3.91858006e+02
 2.35310553e+02 1.51791019e+02 7.63703159e+01 6.52692263e+01
 1.17048159e+01 1.59877911e+01 2.82232623e+01 3.09364470e+01
 3.01959844e-01 1.02914583e+00 1.99518346e+00 4.24133085e+00
 5.26472821e+00 8.78106094e+00 7.11610759e+00 3.39068562e+01
 2.31729983e+01 1.48324257e+02 9.97851136e+01 9.20060927e+02
 2.66063226e-01 5.57462244e-01 2.44234210e+00 8.90722684e+00
 8.34014583e-01 2.32515253e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640077244349
cond(S) = 1301.3737528893619
E1 = -183.59040832219443  E_coul = 55.080165771751126
init E= -128.510242550443
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403721362749  LUMO = 0.79667305215681
  mo_energy =
[-3.25552177e+01 -1.85274270e+00 -7.75403721e-01 -7.75403721e-01
 -7.75403721e-01  7.96673052e-01  8.24032271e-01  8.24032271e-01
  8.24032271e-01  3.95709263e+00  3.95709263e+00  3.95709263e+00
  4.45407851e+00  1.43625608e+01  1.43625608e+01  1.43625608e+01
  1.64922135e+01  5.28404563e+01  5.30186785e+01  5.30186785e+01
  5.30186785e+01  1.62800814e+02  2.40848484e+02  2.40848484e+02
  2.40848484e+02  5.27472215e+02  1.89261193e+03  8.01948495e+03
  4.77838310e+04]
E1 = -182.0859413726741  E_coul = 53.54752562433867
cycle= 1 E= -128.538415748335  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.519465
diis-c [-0.26984437  1.        ]
  HOMO = -0.884336977023981  LUMO = 0.767446635479938
  mo_energy =
[-3.28784374e+01 -1.96665345e+00 -8.84336977e-01 -8.84336977e-01
 -8.84336977e-01  7.67446635e-01  7.97243565e-01  7.97243565e-01
  7.97243565e-01  3.85958549e+00  3.85958549e+00  3.85958549e+00
  4.36663525e+00  1.41717438e+01  1.41717438e+01  1.41717438e+01
  1.63177038e+01  5.25831728e+01  5.27376850e+01  5.27376850e+01
  5.27376850e+01  1.62483464e+02  2.40502119e+02  2.40502119e+02
  2.40502119e+02  5.27111373e+02  1.89221451e+03  8.01905826e+03
  4.77833853e+04]
E1 = -182.84750573715968  E_coul = 54.30650194989343
cycle= 2 E= -128.541003787266  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264262
diis-c [-0.00073439  0.33630944  0.66369056]
  HOMO = -0.848714509894224  LUMO = 0.776790063823949
  mo_energy =
[-3.27703533e+01 -1.92914384e+00 -8.48714510e-01 -8.48714510e-01
 -8.48714510e-01  7.76790064e-01  8.05974296e-01  8.05974296e-01
  8.05974296e-01  3.89120728e+00  3.89120728e+00  3.89120728e+00
  4.39498089e+00  1.42349364e+01  1.42349364e+01  1.42349364e+01
  1.63753688e+01  5.26693710e+01  5.28316938e+01  5.28316938e+01
  5.28316938e+01  1.62589261e+02  2.40615775e+02  2.40615775e+02
  2.40615775e+02  5.27227942e+02  1.89233651e+03  8.01918276e+03
  4.77835108e+04]
E1 = -182.58886570451145  E_coul = 54.04694152656327
cycle= 3 E= -128.541924177948  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00108735
diis-c [-1.92008996e-07 -2.38889131e-03 -9.31534233e-04  1.00332043e+00]
  HOMO = -0.848965464135429  LUMO = 0.776738465846752
  mo_energy =
[-3.27707879e+01 -1.92932984e+00 -8.48965464e-01 -8.48965464e-01
 -8.48965464e-01  7.76738466e-01  8.05935939e-01  8.05935939e-01
  8.05935939e-01  3.89103483e+00  3.89103483e+00  3.89103483e+00
  4.39483366e+00  1.42346433e+01  1.42346433e+01  1.42346433e+01
  1.63751018e+01  5.26690181e+01  5.28313094e+01  5.28313094e+01
  5.28313094e+01  1.62588822e+02  2.40615270e+02  2.40615270e+02
  2.40615270e+02  5.27227383e+02  1.89233582e+03  8.01918196e+03
  4.77835099e+04]
E1 = -182.5892523309982  E_coul = 54.04732812800765
cycle= 4 E= -128.541924202991  delta_E= -2.5e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187663
diis-c [-1.12209446e-09  2.31271155e-04  5.35682863e-04 -1.84041833e-01
  1.18327488e+00]
  HOMO = -0.849008893108218  LUMO = 0.776725232886079
  mo_energy =
[-3.27708617e+01 -1.92936271e+00 -8.49008893e-01 -8.49008893e-01
 -8.49008893e-01  7.76725233e-01  8.05922460e-01  8.05922460e-01
  8.05922460e-01  3.89099431e+00  3.89099431e+00  3.89099431e+00
  4.39480016e+00  1.42345834e+01  1.42345834e+01  1.42345834e+01
  1.63750460e+01  5.26689508e+01  5.28312397e+01  5.28312397e+01
  5.28312397e+01  1.62588748e+02  2.40615192e+02  2.40615192e+02
  2.40615192e+02  5.27227301e+02  1.89233573e+03  8.01918187e+03
  4.77835098e+04]
E1 = -182.58938677296007  E_coul = 54.04746256924818
cycle= 5 E= -128.541924203712  delta_E= -7.21e-10  |g|= 5.93e-06  |ddm|= 5.62e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58938677296007  E_coul = 54.04746256924818
  HOMO = -0.84900578767085  LUMO = 0.776726565111135
  mo_energy =
[-3.27708547e+01 -1.92935880e+00 -8.49005788e-01 -8.49005788e-01
 -8.49005788e-01  7.76726565e-01  8.05923374e-01  8.05923374e-01
  8.05923374e-01  3.89099729e+00  3.89099729e+00  3.89099729e+00
  4.39480320e+00  1.42345885e+01  1.42345885e+01  1.42345885e+01
  1.63750510e+01  5.26689571e+01  5.28312463e+01  5.28312463e+01
  5.28312463e+01  1.62588755e+02  2.40615199e+02  2.40615199e+02
  2.40615199e+02  5.27227307e+02  1.89233573e+03  8.01918187e+03
  4.77835098e+04]
E1 = -182.58937091916565  E_coul = 54.0474467154515
Extra cycle  E= -128.541924203714  delta_E= -2.25e-12  |g|= 2.23e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.87377206e-01 2.44137942e+04 3.66145092e+03 8.33332398e+02
 2.35310553e+02 7.63703159e+01 1.17048159e+01 2.82232623e+01
 3.01959844e-01 1.99518346e+00 5.26472821e+00 7.11610759e+00
 2.31729983e+01 9.97851136e+01 2.66063226e-01 2.44234210e+00
 8.34014583e-01]
E = -128.54192420371413
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.787377206391       1
[INPUT] 0    0    [1    /1   ]  24413.7941985        1
[INPUT] 0    0    [1    /1   ]  3661.45092355        1
[INPUT] 0    0    [1    /1   ]  833.332398322        1
[INPUT] 0    0    [1    /1   ]  235.310552589        1
[INPUT] 0    0    [1    /1   ]  76.3703159121        1
[INPUT] 0    0    [1    /1   ]  11.7048159363        1
[INPUT] 0    0    [1    /1   ]  28.2232623477        1
[INPUT] 0    0    [1    /1   ]  0.301959843669       1
[INPUT] 0    0    [1    /1   ]  1.99518346045        1
[INPUT] 0    0    [1    /1   ]  5.26472821194        1
[INPUT] 1    0    [1    /1   ]  7.11610758943        1
[INPUT] 1    0    [1    /1   ]  23.172998321         1
[INPUT] 1    0    [1    /1   ]  99.7851135844        1
[INPUT] 1    0    [1    /1   ]  0.266063226108       1
[INPUT] 1    0    [1    /1   ]  2.44234210247        1
[INPUT] 1    0    [1    /1   ]  0.834014583059       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.787377206391062, 1.0]], [0, [24413.79419853852, 1.0]], [0, [3661.4509235529504, 1.0]], [0, [833.3323983221015, 1.0]], [0, [235.3105525885796, 1.0]], [0, [76.37031591211124, 1.0]], [0, [11.704815936285321, 1.0]], [0, [28.22326234765314, 1.0]], [0, [0.30195984366908585, 1.0]], [0, [1.9951834604515035, 1.0]], [0, [5.264728211938341, 1.0]], [1, [7.1161075894339545, 1.0]], [1, [23.172998321035884, 1.0]], [1, [99.78511358440828, 1.0]], [1, [0.26606322610793426, 1.0]], [1, [2.442342102474693, 1.0]], [1, [0.8340145830588799, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78737721]
bas 1, expnt(s) = [24413.79419854]
bas 2, expnt(s) = [3661.45092355]
bas 3, expnt(s) = [833.33239832]
bas 4, expnt(s) = [235.31055259]
bas 5, expnt(s) = [76.37031591]
bas 6, expnt(s) = [11.70481594]
bas 7, expnt(s) = [28.22326235]
bas 8, expnt(s) = [0.30195984]
bas 9, expnt(s) = [1.99518346]
bas 10, expnt(s) = [5.26472821]
bas 11, expnt(s) = [7.11610759]
bas 12, expnt(s) = [23.17299832]
bas 13, expnt(s) = [99.78511358]
bas 14, expnt(s) = [0.26606323]
bas 15, expnt(s) = [2.4423421]
bas 16, expnt(s) = [0.83401458]
CPU time:       286.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.87377206e-01 2.11179692e+00 2.44137942e+04 4.93448103e+03
 3.66145092e+03 1.18920010e+03 8.33332398e+02 3.91858006e+02
 2.35310553e+02 1.51791019e+02 7.63703159e+01 6.52692263e+01
 1.17048159e+01 1.59877911e+01 2.82232623e+01 3.09364470e+01
 3.01959844e-01 1.02914583e+00 1.99518346e+00 4.24133085e+00
 5.26472821e+00 8.78106094e+00 7.11610759e+00 3.39068562e+01
 2.31729983e+01 1.48324257e+02 9.97851136e+01 9.20060927e+02
 2.66063226e-01 5.57462244e-01 2.44234210e+00 8.90722684e+00
 8.34014583e-01 2.32515253e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640077244349
cond(S) = 1301.3737528893619
E1 = -183.59040832219443  E_coul = 55.080165771751126
init E= -128.510242550443
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403721362749  LUMO = 0.79667305215681
  mo_energy =
[-3.25552177e+01 -1.85274270e+00 -7.75403721e-01 -7.75403721e-01
 -7.75403721e-01  7.96673052e-01  8.24032271e-01  8.24032271e-01
  8.24032271e-01  3.95709263e+00  3.95709263e+00  3.95709263e+00
  4.45407851e+00  1.43625608e+01  1.43625608e+01  1.43625608e+01
  1.64922135e+01  5.28404563e+01  5.30186785e+01  5.30186785e+01
  5.30186785e+01  1.62800814e+02  2.40848484e+02  2.40848484e+02
  2.40848484e+02  5.27472215e+02  1.89261193e+03  8.01948495e+03
  4.77838310e+04]
E1 = -182.0859413726741  E_coul = 53.54752562433867
cycle= 1 E= -128.538415748335  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519465
diis-c [-0.26984437  1.        ]
  HOMO = -0.884336977023981  LUMO = 0.767446635479938
  mo_energy =
[-3.28784374e+01 -1.96665345e+00 -8.84336977e-01 -8.84336977e-01
 -8.84336977e-01  7.67446635e-01  7.97243565e-01  7.97243565e-01
  7.97243565e-01  3.85958549e+00  3.85958549e+00  3.85958549e+00
  4.36663525e+00  1.41717438e+01  1.41717438e+01  1.41717438e+01
  1.63177038e+01  5.25831728e+01  5.27376850e+01  5.27376850e+01
  5.27376850e+01  1.62483464e+02  2.40502119e+02  2.40502119e+02
  2.40502119e+02  5.27111373e+02  1.89221451e+03  8.01905826e+03
  4.77833853e+04]
E1 = -182.84750573715968  E_coul = 54.30650194989343
cycle= 2 E= -128.541003787266  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264262
diis-c [-0.00073439  0.33630944  0.66369056]
  HOMO = -0.848714509894224  LUMO = 0.776790063823949
  mo_energy =
[-3.27703533e+01 -1.92914384e+00 -8.48714510e-01 -8.48714510e-01
 -8.48714510e-01  7.76790064e-01  8.05974296e-01  8.05974296e-01
  8.05974296e-01  3.89120728e+00  3.89120728e+00  3.89120728e+00
  4.39498089e+00  1.42349364e+01  1.42349364e+01  1.42349364e+01
  1.63753688e+01  5.26693710e+01  5.28316938e+01  5.28316938e+01
  5.28316938e+01  1.62589261e+02  2.40615775e+02  2.40615775e+02
  2.40615775e+02  5.27227942e+02  1.89233651e+03  8.01918276e+03
  4.77835108e+04]
E1 = -182.58886570451145  E_coul = 54.04694152656327
cycle= 3 E= -128.541924177948  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108735
diis-c [-1.92008996e-07 -2.38889131e-03 -9.31534233e-04  1.00332043e+00]
  HOMO = -0.848965464135429  LUMO = 0.776738465846752
  mo_energy =
[-3.27707879e+01 -1.92932984e+00 -8.48965464e-01 -8.48965464e-01
 -8.48965464e-01  7.76738466e-01  8.05935939e-01  8.05935939e-01
  8.05935939e-01  3.89103483e+00  3.89103483e+00  3.89103483e+00
  4.39483366e+00  1.42346433e+01  1.42346433e+01  1.42346433e+01
  1.63751018e+01  5.26690181e+01  5.28313094e+01  5.28313094e+01
  5.28313094e+01  1.62588822e+02  2.40615270e+02  2.40615270e+02
  2.40615270e+02  5.27227383e+02  1.89233582e+03  8.01918196e+03
  4.77835099e+04]
E1 = -182.5892523309982  E_coul = 54.04732812800765
cycle= 4 E= -128.541924202991  delta_E= -2.5e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187663
diis-c [-1.12209446e-09  2.31271155e-04  5.35682863e-04 -1.84041833e-01
  1.18327488e+00]
  HOMO = -0.849008893108218  LUMO = 0.776725232886079
  mo_energy =
[-3.27708617e+01 -1.92936271e+00 -8.49008893e-01 -8.49008893e-01
 -8.49008893e-01  7.76725233e-01  8.05922460e-01  8.05922460e-01
  8.05922460e-01  3.89099431e+00  3.89099431e+00  3.89099431e+00
  4.39480016e+00  1.42345834e+01  1.42345834e+01  1.42345834e+01
  1.63750460e+01  5.26689508e+01  5.28312397e+01  5.28312397e+01
  5.28312397e+01  1.62588748e+02  2.40615192e+02  2.40615192e+02
  2.40615192e+02  5.27227301e+02  1.89233573e+03  8.01918187e+03
  4.77835098e+04]
E1 = -182.58938677296007  E_coul = 54.04746256924818
cycle= 5 E= -128.541924203712  delta_E= -7.21e-10  |g|= 5.93e-06  |ddm|= 5.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58938677296007  E_coul = 54.04746256924818
  HOMO = -0.84900578767085  LUMO = 0.776726565111135
  mo_energy =
[-3.27708547e+01 -1.92935880e+00 -8.49005788e-01 -8.49005788e-01
 -8.49005788e-01  7.76726565e-01  8.05923374e-01  8.05923374e-01
  8.05923374e-01  3.89099729e+00  3.89099729e+00  3.89099729e+00
  4.39480320e+00  1.42345885e+01  1.42345885e+01  1.42345885e+01
  1.63750510e+01  5.26689571e+01  5.28312463e+01  5.28312463e+01
  5.28312463e+01  1.62588755e+02  2.40615199e+02  2.40615199e+02
  2.40615199e+02  5.27227307e+02  1.89233573e+03  8.01918187e+03
  4.77835098e+04]
E1 = -182.58937091916565  E_coul = 54.0474467154515
Extra cycle  E= -128.541924203714  delta_E= -2.25e-12  |g|= 2.23e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1301.3737528893619
E1 = -182.58937091916565  E_coul = 54.0474467154515
init E= -128.541924203714
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.849006909744274  LUMO = 0.77672635419962
  mo_energy =
[-3.27708582e+01 -1.92935984e+00 -8.49006910e-01 -8.49006910e-01
 -8.49006910e-01  7.76726354e-01  8.05923117e-01  8.05923117e-01
  8.05923117e-01  3.89099632e+00  3.89099632e+00  3.89099632e+00
  4.39480240e+00  1.42345865e+01  1.42345865e+01  1.42345865e+01
  1.63750493e+01  5.26689543e+01  5.28312432e+01  5.28312432e+01
  5.28312432e+01  1.62588751e+02  2.40615195e+02  2.40615195e+02
  2.40615195e+02  5.27227303e+02  1.89233573e+03  8.01918187e+03
  4.77835098e+04]
E1 = -182.58937972855819  E_coul = 54.0474555248436
cycle= 1 E= -128.541924203715  delta_E= -4.55e-13  |g|= 1.21e-06  |ddm|= 8.01e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58937972855819  E_coul = 54.0474555248436
  HOMO = -0.849006289681485  LUMO = 0.776726533609002
  mo_energy =
[-3.27708563e+01 -1.92935916e+00 -8.49006290e-01 -8.49006290e-01
 -8.49006290e-01  7.76726534e-01  8.05923273e-01  8.05923273e-01
  8.05923273e-01  3.89099688e+00  3.89099688e+00  3.89099688e+00
  4.39480291e+00  1.42345876e+01  1.42345876e+01  1.42345876e+01
  1.63750503e+01  5.26689558e+01  5.28312449e+01  5.28312449e+01
  5.28312449e+01  1.62588753e+02  2.40615197e+02  2.40615197e+02
  2.40615197e+02  5.27227305e+02  1.89233573e+03  8.01918187e+03
  4.77835098e+04]
E1 = -182.58937530112013  E_coul = 54.04745109740541
Extra cycle  E= -128.541924203715  delta_E= -1.42e-13  |g|= 6.01e-07  |ddm|= 3.97e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [7.87377206e-01 2.44137942e+04 3.66145092e+03 8.33332398e+02
 2.35310553e+02 7.63703159e+01 1.17048159e+01 2.82232623e+01
 3.01959844e-01 1.99518346e+00 5.26472821e+00 7.11610759e+00
 2.31729983e+01 9.97851136e+01 2.66063226e-01 2.44234210e+00
 8.34014583e-01]
grad_E = [ 5.42730515e-07 -9.21176450e-10  4.97979463e-08 -1.06819919e-06
  1.25214047e-05 -5.07889127e-05 -5.84168080e-06 -3.84697673e-05
 -1.21352399e-05  2.67862774e-06  2.99367100e-05  6.50019753e-06
 -1.68264881e-06  8.41710727e-08 -5.79883023e-05 -5.19121723e-06
  2.36335601e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.785874407888       1
[INPUT] 0    0    [1    /1   ]  24413.7941985        1
[INPUT] 0    0    [1    /1   ]  3661.45092372        1
[INPUT] 0    0    [1    /1   ]  833.332395668        1
[INPUT] 0    0    [1    /1   ]  235.310589345        1
[INPUT] 0    0    [1    /1   ]  76.3696474449        1
[INPUT] 0    0    [1    /1   ]  11.7064304155        1
[INPUT] 0    0    [1    /1   ]  28.2264133397        1
[INPUT] 0    0    [1    /1   ]  0.301534150983       1
[INPUT] 0    0    [1    /1   ]  1.99181608244        1
[INPUT] 0    0    [1    /1   ]  5.26725592137        1
[INPUT] 1    0    [1    /1   ]  7.11572742794        1
[INPUT] 1    0    [1    /1   ]  23.1731423696        1
[INPUT] 1    0    [1    /1   ]  99.785105052         1
[INPUT] 1    0    [1    /1   ]  0.266067548568       1
[INPUT] 1    0    [1    /1   ]  2.44218904845        1
[INPUT] 1    0    [1    /1   ]  0.833978166095       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7858744078878702, 1.0]], [0, [24413.79419853503, 1.0]], [0, [3661.450923716846, 1.0]], [0, [833.332395668058, 1.0]], [0, [235.31058934534974, 1.0]], [0, [76.36964744494803, 1.0]], [0, [11.706430415543217, 1.0]], [0, [28.226413339651184, 1.0]], [0, [0.30153415098341624, 1.0]], [0, [1.9918160824423465, 1.0]], [0, [5.2672559213676955, 1.0]], [1, [7.115727427938835, 1.0]], [1, [23.173142369619633, 1.0]], [1, [99.78510505199723, 1.0]], [1, [0.26606754856762554, 1.0]], [1, [2.442189048451755, 1.0]], [1, [0.8339781660948347, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78587441]
bas 1, expnt(s) = [24413.79419854]
bas 2, expnt(s) = [3661.45092372]
bas 3, expnt(s) = [833.33239567]
bas 4, expnt(s) = [235.31058935]
bas 5, expnt(s) = [76.36964744]
bas 6, expnt(s) = [11.70643042]
bas 7, expnt(s) = [28.22641334]
bas 8, expnt(s) = [0.30153415]
bas 9, expnt(s) = [1.99181608]
bas 10, expnt(s) = [5.26725592]
bas 11, expnt(s) = [7.11572743]
bas 12, expnt(s) = [23.17314237]
bas 13, expnt(s) = [99.78510505]
bas 14, expnt(s) = [0.26606755]
bas 15, expnt(s) = [2.44218905]
bas 16, expnt(s) = [0.83397817]
CPU time:       289.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.85874408e-01 2.10877325e+00 2.44137942e+04 4.93448103e+03
 3.66145092e+03 1.18920010e+03 8.33332396e+02 3.91858005e+02
 2.35310589e+02 1.51791037e+02 7.63696474e+01 6.52687978e+01
 1.17064304e+01 1.59894450e+01 2.82264133e+01 3.09390374e+01
 3.01534151e-01 1.02805750e+00 1.99181608e+00 4.23596097e+00
 5.26725592e+00 8.78422273e+00 7.11572743e+00 3.39045920e+01
 2.31731424e+01 1.48325409e+02 9.97851051e+01 9.20060829e+02
 2.66067549e-01 5.57473564e-01 2.44218905e+00 8.90652911e+00
 8.33978166e-01 2.32502562e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640136327253
cond(S) = 1297.840303712049
E1 = -183.59041117035463  E_coul = 55.080165336918505
init E= -128.510245833436
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403778233229  LUMO = 0.794976186381762
  mo_energy =
[-3.25552177e+01 -1.85274275e+00 -7.75403778e-01 -7.75403778e-01
 -7.75403778e-01  7.94976186e-01  8.24031657e-01  8.24031657e-01
  8.24031657e-01  3.95693511e+00  3.95693511e+00  3.95693511e+00
  4.44547668e+00  1.43617186e+01  1.43617186e+01  1.43617186e+01
  1.64773925e+01  5.28308617e+01  5.30171167e+01  5.30171167e+01
  5.30171167e+01  1.62801528e+02  2.40847303e+02  2.40847303e+02
  2.40847303e+02  5.27478138e+02  1.89261842e+03  8.01949089e+03
  4.77838359e+04]
E1 = -182.08595164431085  E_coul = 53.547535864746976
cycle= 1 E= -128.538415779564  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519466
diis-c [-0.2698451  1.       ]
  HOMO = -0.884336069550122  LUMO = 0.765813981838673
  mo_energy =
[-3.28784363e+01 -1.96665219e+00 -8.84336070e-01 -8.84336070e-01
 -8.84336070e-01  7.65813982e-01  7.97244038e-01  7.97244038e-01
  7.97244038e-01  3.85943360e+00  3.85943360e+00  3.85943360e+00
  4.35812707e+00  1.41709076e+01  1.41709076e+01  1.41709076e+01
  1.63028851e+01  5.25735585e+01  5.27361245e+01  5.27361245e+01
  5.27361245e+01  1.62484173e+02  2.40500939e+02  2.40500939e+02
  2.40500939e+02  5.27117297e+02  1.89222100e+03  8.01906420e+03
  4.77833903e+04]
E1 = -182.8475136927407  E_coul = 54.30650987786964
cycle= 2 E= -128.541003814871  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264262
diis-c [-0.00073435  0.33630929  0.66369071]
  HOMO = -0.848713691510925  LUMO = 0.775136938649681
  mo_energy =
[-3.27703525e+01 -1.92914270e+00 -8.48713692e-01 -8.48713692e-01
 -8.48713692e-01  7.75136939e-01  8.05974516e-01  8.05974516e-01
  8.05974516e-01  3.89105383e+00  3.89105383e+00  3.89105383e+00
  4.38644224e+00  1.42340984e+01  1.42340984e+01  1.42340984e+01
  1.63605498e+01  5.26597637e+01  5.28301330e+01  5.28301330e+01
  5.28301330e+01  1.62589972e+02  2.40614595e+02  2.40614595e+02
  2.40614595e+02  5.27233866e+02  1.89234300e+03  8.01918869e+03
  4.77835157e+04]
E1 = -182.58887589266226  E_coul = 54.04695169765744
cycle= 3 E= -128.541924195005  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108713
diis-c [-1.92243209e-07 -2.38895581e-03 -9.33036429e-04  1.00332199e+00]
  HOMO = -0.848964568620676  LUMO = 0.775085483375166
  mo_energy =
[-3.27707869e+01 -1.92932858e+00 -8.48964569e-01 -8.48964569e-01
 -8.48964569e-01  7.75085483e-01  8.05936182e-01  8.05936182e-01
  8.05936182e-01  3.89088147e+00  3.89088147e+00  3.89088147e+00
  4.38629526e+00  1.42338054e+01  1.42338054e+01  1.42338054e+01
  1.63602830e+01  5.26594110e+01  5.28297488e+01  5.28297488e+01
  5.28297488e+01  1.62589533e+02  2.40614090e+02  2.40614090e+02
  2.40614090e+02  5.27233307e+02  1.89234231e+03  8.01918790e+03
  4.77835149e+04]
E1 = -182.5892622191403  E_coul = 54.04733799908692
cycle= 4 E= -128.541924220053  delta_E= -2.5e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187677
diis-c [-1.12286588e-09  2.31419766e-04  5.35879052e-04 -1.84133346e-01
  1.18336605e+00]
  HOMO = -0.849007999347421  LUMO = 0.775072277631782
  mo_energy =
[-3.27708607e+01 -1.92936144e+00 -8.49007999e-01 -8.49007999e-01
 -8.49007999e-01  7.75072278e-01  8.05922702e-01  8.05922702e-01
  8.05922702e-01  3.89084096e+00  3.89084096e+00  3.89084096e+00
  4.38626180e+00  1.42337455e+01  1.42337455e+01  1.42337455e+01
  1.63602272e+01  5.26593436e+01  5.28296791e+01  5.28296791e+01
  5.28296791e+01  1.62589459e+02  2.40614012e+02  2.40614012e+02
  2.40614012e+02  5.27233225e+02  1.89234222e+03  8.01918780e+03
  4.77835148e+04]
E1 = -182.58939664241376  E_coul = 54.04747242163861
cycle= 5 E= -128.541924220775  delta_E= -7.22e-10  |g|= 5.94e-06  |ddm|= 5.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58939664241376  E_coul = 54.04747242163861
  HOMO = -0.849004891930721  LUMO = 0.775073608147075
  mo_energy =
[-3.27708537e+01 -1.92935753e+00 -8.49004892e-01 -8.49004892e-01
 -8.49004892e-01  7.75073608e-01  8.05923617e-01  8.05923617e-01
  8.05923617e-01  3.89084394e+00  3.89084394e+00  3.89084394e+00
  4.38626483e+00  1.42337506e+01  1.42337506e+01  1.42337506e+01
  1.63602322e+01  5.26593500e+01  5.28296857e+01  5.28296857e+01
  5.28296857e+01  1.62589466e+02  2.40614019e+02  2.40614019e+02
  2.40614019e+02  5.27233231e+02  1.89234222e+03  8.01918781e+03
  4.77835148e+04]
E1 = -182.58938077774062  E_coul = 54.04745655696306
Extra cycle  E= -128.541924220778  delta_E= -2.42e-12  |g|= 2.23e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.85874408e-01 2.44137942e+04 3.66145092e+03 8.33332396e+02
 2.35310589e+02 7.63696474e+01 1.17064304e+01 2.82264133e+01
 3.01534151e-01 1.99181608e+00 5.26725592e+00 7.11572743e+00
 2.31731424e+01 9.97851051e+01 2.66067549e-01 2.44218905e+00
 8.33978166e-01]
E = -128.54192422077756
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.785874407888       1
[INPUT] 0    0    [1    /1   ]  24413.7941985        1
[INPUT] 0    0    [1    /1   ]  3661.45092372        1
[INPUT] 0    0    [1    /1   ]  833.332395668        1
[INPUT] 0    0    [1    /1   ]  235.310589345        1
[INPUT] 0    0    [1    /1   ]  76.3696474449        1
[INPUT] 0    0    [1    /1   ]  11.7064304155        1
[INPUT] 0    0    [1    /1   ]  28.2264133397        1
[INPUT] 0    0    [1    /1   ]  0.301534150983       1
[INPUT] 0    0    [1    /1   ]  1.99181608244        1
[INPUT] 0    0    [1    /1   ]  5.26725592137        1
[INPUT] 1    0    [1    /1   ]  7.11572742794        1
[INPUT] 1    0    [1    /1   ]  23.1731423696        1
[INPUT] 1    0    [1    /1   ]  99.785105052         1
[INPUT] 1    0    [1    /1   ]  0.266067548568       1
[INPUT] 1    0    [1    /1   ]  2.44218904845        1
[INPUT] 1    0    [1    /1   ]  0.833978166095       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7858744078878702, 1.0]], [0, [24413.79419853503, 1.0]], [0, [3661.450923716846, 1.0]], [0, [833.332395668058, 1.0]], [0, [235.31058934534974, 1.0]], [0, [76.36964744494803, 1.0]], [0, [11.706430415543217, 1.0]], [0, [28.226413339651184, 1.0]], [0, [0.30153415098341624, 1.0]], [0, [1.9918160824423465, 1.0]], [0, [5.2672559213676955, 1.0]], [1, [7.115727427938835, 1.0]], [1, [23.173142369619633, 1.0]], [1, [99.78510505199723, 1.0]], [1, [0.26606754856762554, 1.0]], [1, [2.442189048451755, 1.0]], [1, [0.8339781660948347, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78587441]
bas 1, expnt(s) = [24413.79419854]
bas 2, expnt(s) = [3661.45092372]
bas 3, expnt(s) = [833.33239567]
bas 4, expnt(s) = [235.31058935]
bas 5, expnt(s) = [76.36964744]
bas 6, expnt(s) = [11.70643042]
bas 7, expnt(s) = [28.22641334]
bas 8, expnt(s) = [0.30153415]
bas 9, expnt(s) = [1.99181608]
bas 10, expnt(s) = [5.26725592]
bas 11, expnt(s) = [7.11572743]
bas 12, expnt(s) = [23.17314237]
bas 13, expnt(s) = [99.78510505]
bas 14, expnt(s) = [0.26606755]
bas 15, expnt(s) = [2.44218905]
bas 16, expnt(s) = [0.83397817]
CPU time:       290.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.85874408e-01 2.10877325e+00 2.44137942e+04 4.93448103e+03
 3.66145092e+03 1.18920010e+03 8.33332396e+02 3.91858005e+02
 2.35310589e+02 1.51791037e+02 7.63696474e+01 6.52687978e+01
 1.17064304e+01 1.59894450e+01 2.82264133e+01 3.09390374e+01
 3.01534151e-01 1.02805750e+00 1.99181608e+00 4.23596097e+00
 5.26725592e+00 8.78422273e+00 7.11572743e+00 3.39045920e+01
 2.31731424e+01 1.48325409e+02 9.97851051e+01 9.20060829e+02
 2.66067549e-01 5.57473564e-01 2.44218905e+00 8.90652911e+00
 8.33978166e-01 2.32502562e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640136327253
cond(S) = 1297.840303712049
E1 = -183.59041117035463  E_coul = 55.080165336918505
init E= -128.510245833436
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403778233229  LUMO = 0.794976186381762
  mo_energy =
[-3.25552177e+01 -1.85274275e+00 -7.75403778e-01 -7.75403778e-01
 -7.75403778e-01  7.94976186e-01  8.24031657e-01  8.24031657e-01
  8.24031657e-01  3.95693511e+00  3.95693511e+00  3.95693511e+00
  4.44547668e+00  1.43617186e+01  1.43617186e+01  1.43617186e+01
  1.64773925e+01  5.28308617e+01  5.30171167e+01  5.30171167e+01
  5.30171167e+01  1.62801528e+02  2.40847303e+02  2.40847303e+02
  2.40847303e+02  5.27478138e+02  1.89261842e+03  8.01949089e+03
  4.77838359e+04]
E1 = -182.08595164431085  E_coul = 53.547535864746976
cycle= 1 E= -128.538415779564  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519466
diis-c [-0.2698451  1.       ]
  HOMO = -0.884336069550122  LUMO = 0.765813981838673
  mo_energy =
[-3.28784363e+01 -1.96665219e+00 -8.84336070e-01 -8.84336070e-01
 -8.84336070e-01  7.65813982e-01  7.97244038e-01  7.97244038e-01
  7.97244038e-01  3.85943360e+00  3.85943360e+00  3.85943360e+00
  4.35812707e+00  1.41709076e+01  1.41709076e+01  1.41709076e+01
  1.63028851e+01  5.25735585e+01  5.27361245e+01  5.27361245e+01
  5.27361245e+01  1.62484173e+02  2.40500939e+02  2.40500939e+02
  2.40500939e+02  5.27117297e+02  1.89222100e+03  8.01906420e+03
  4.77833903e+04]
E1 = -182.8475136927407  E_coul = 54.30650987786964
cycle= 2 E= -128.541003814871  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264262
diis-c [-0.00073435  0.33630929  0.66369071]
  HOMO = -0.848713691510925  LUMO = 0.775136938649681
  mo_energy =
[-3.27703525e+01 -1.92914270e+00 -8.48713692e-01 -8.48713692e-01
 -8.48713692e-01  7.75136939e-01  8.05974516e-01  8.05974516e-01
  8.05974516e-01  3.89105383e+00  3.89105383e+00  3.89105383e+00
  4.38644224e+00  1.42340984e+01  1.42340984e+01  1.42340984e+01
  1.63605498e+01  5.26597637e+01  5.28301330e+01  5.28301330e+01
  5.28301330e+01  1.62589972e+02  2.40614595e+02  2.40614595e+02
  2.40614595e+02  5.27233866e+02  1.89234300e+03  8.01918869e+03
  4.77835157e+04]
E1 = -182.58887589266226  E_coul = 54.04695169765744
cycle= 3 E= -128.541924195005  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108713
diis-c [-1.92243209e-07 -2.38895581e-03 -9.33036429e-04  1.00332199e+00]
  HOMO = -0.848964568620676  LUMO = 0.775085483375166
  mo_energy =
[-3.27707869e+01 -1.92932858e+00 -8.48964569e-01 -8.48964569e-01
 -8.48964569e-01  7.75085483e-01  8.05936182e-01  8.05936182e-01
  8.05936182e-01  3.89088147e+00  3.89088147e+00  3.89088147e+00
  4.38629526e+00  1.42338054e+01  1.42338054e+01  1.42338054e+01
  1.63602830e+01  5.26594110e+01  5.28297488e+01  5.28297488e+01
  5.28297488e+01  1.62589533e+02  2.40614090e+02  2.40614090e+02
  2.40614090e+02  5.27233307e+02  1.89234231e+03  8.01918790e+03
  4.77835149e+04]
E1 = -182.5892622191403  E_coul = 54.04733799908692
cycle= 4 E= -128.541924220053  delta_E= -2.5e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187677
diis-c [-1.12286588e-09  2.31419766e-04  5.35879052e-04 -1.84133346e-01
  1.18336605e+00]
  HOMO = -0.849007999347421  LUMO = 0.775072277631782
  mo_energy =
[-3.27708607e+01 -1.92936144e+00 -8.49007999e-01 -8.49007999e-01
 -8.49007999e-01  7.75072278e-01  8.05922702e-01  8.05922702e-01
  8.05922702e-01  3.89084096e+00  3.89084096e+00  3.89084096e+00
  4.38626180e+00  1.42337455e+01  1.42337455e+01  1.42337455e+01
  1.63602272e+01  5.26593436e+01  5.28296791e+01  5.28296791e+01
  5.28296791e+01  1.62589459e+02  2.40614012e+02  2.40614012e+02
  2.40614012e+02  5.27233225e+02  1.89234222e+03  8.01918780e+03
  4.77835148e+04]
E1 = -182.58939664241376  E_coul = 54.04747242163861
cycle= 5 E= -128.541924220775  delta_E= -7.22e-10  |g|= 5.94e-06  |ddm|= 5.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58939664241376  E_coul = 54.04747242163861
  HOMO = -0.849004891930721  LUMO = 0.775073608147075
  mo_energy =
[-3.27708537e+01 -1.92935753e+00 -8.49004892e-01 -8.49004892e-01
 -8.49004892e-01  7.75073608e-01  8.05923617e-01  8.05923617e-01
  8.05923617e-01  3.89084394e+00  3.89084394e+00  3.89084394e+00
  4.38626483e+00  1.42337506e+01  1.42337506e+01  1.42337506e+01
  1.63602322e+01  5.26593500e+01  5.28296857e+01  5.28296857e+01
  5.28296857e+01  1.62589466e+02  2.40614019e+02  2.40614019e+02
  2.40614019e+02  5.27233231e+02  1.89234222e+03  8.01918781e+03
  4.77835148e+04]
E1 = -182.58938077774062  E_coul = 54.04745655696306
Extra cycle  E= -128.541924220778  delta_E= -2.42e-12  |g|= 2.23e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1297.840303712049
E1 = -182.58938077774062  E_coul = 54.04745655696306
init E= -128.541924220778
    CPU time for initialize scf      0.33 sec, wall time      0.33 sec
  HOMO = -0.849006014770152  LUMO = 0.775073397603578
  mo_energy =
[-3.27708572e+01 -1.92935857e+00 -8.49006015e-01 -8.49006015e-01
 -8.49006015e-01  7.75073398e-01  8.05923360e-01  8.05923360e-01
  8.05923360e-01  3.89084297e+00  3.89084297e+00  3.89084297e+00
  4.38626403e+00  1.42337486e+01  1.42337486e+01  1.42337486e+01
  1.63602304e+01  5.26593472e+01  5.28296827e+01  5.28296827e+01
  5.28296827e+01  1.62589463e+02  2.40614015e+02  2.40614015e+02
  2.40614015e+02  5.27233227e+02  1.89234222e+03  8.01918780e+03
  4.77835148e+04]
E1 = -182.58938959299888  E_coul = 54.047465372220984
cycle= 1 E= -128.541924220778  delta_E= -3.41e-13  |g|= 1.21e-06  |ddm|= 8.01e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58938959299888  E_coul = 54.047465372220984
  HOMO = -0.849005394293476  LUMO = 0.77507357674787
  mo_energy =
[-3.27708554e+01 -1.92935789e+00 -8.49005394e-01 -8.49005394e-01
 -8.49005394e-01  7.75073577e-01  8.05923515e-01  8.05923515e-01
  8.05923515e-01  3.89084352e+00  3.89084352e+00  3.89084352e+00
  4.38626455e+00  1.42337497e+01  1.42337497e+01  1.42337497e+01
  1.63602314e+01  5.26593487e+01  5.28296843e+01  5.28296843e+01
  5.28296843e+01  1.62589464e+02  2.40614017e+02  2.40614017e+02
  2.40614017e+02  5.27233229e+02  1.89234222e+03  8.01918781e+03
  4.77835148e+04]
E1 = -182.58938516261156  E_coul = 54.04746094183356
Extra cycle  E= -128.541924220778  delta_E= -1.14e-13  |g|= 6.02e-07  |ddm|= 3.97e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [7.85874408e-01 2.44137942e+04 3.66145092e+03 8.33332396e+02
 2.35310589e+02 7.63696474e+01 1.17064304e+01 2.82264133e+01
 3.01534151e-01 1.99181608e+00 5.26725592e+00 7.11572743e+00
 2.31731424e+01 9.97851051e+01 2.66067549e-01 2.44218905e+00
 8.33978166e-01]
grad_E = [-4.89402097e-06 -9.35443260e-10  5.05461105e-08 -1.08272749e-06
  1.26795214e-05 -5.16669841e-05 -7.72072526e-06 -3.63479995e-05
 -5.69195205e-06  9.72886758e-08  3.10958230e-05  3.91568722e-06
 -1.09289716e-06  5.56320605e-08 -1.43056307e-05 -3.24044404e-07
  6.00995146e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.785545385295       1
[INPUT] 0    0    [1    /1   ]  24413.7941985        1
[INPUT] 0    0    [1    /1   ]  3661.45092421        1
[INPUT] 0    0    [1    /1   ]  833.332386268        1
[INPUT] 0    0    [1    /1   ]  235.310685477        1
[INPUT] 0    0    [1    /1   ]  76.3692079197        1
[INPUT] 0    0    [1    /1   ]  11.7061740449        1
[INPUT] 0    0    [1    /1   ]  28.2270638702        1
[INPUT] 0    0    [1    /1   ]  0.301426659605       1
[INPUT] 0    0    [1    /1   ]  1.9911569879         1
[INPUT] 0    0    [1    /1   ]  5.266863802          1
[INPUT] 1    0    [1    /1   ]  7.11531861988        1
[INPUT] 1    0    [1    /1   ]  23.1732862681        1
[INPUT] 1    0    [1    /1   ]  99.7850978501        1
[INPUT] 1    0    [1    /1   ]  0.266073594145       1
[INPUT] 1    0    [1    /1   ]  2.442043958          1
[INPUT] 1    0    [1    /1   ]  0.833949172981       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7855453852952189, 1.0]], [0, [24413.79419852569, 1.0]], [0, [3661.4509242066265, 1.0]], [0, [833.332386268367, 1.0]], [0, [235.31068547712044, 1.0]], [0, [76.36920791968718, 1.0]], [0, [11.706174044882877, 1.0]], [0, [28.227063870220913, 1.0]], [0, [0.3014266596052547, 1.0]], [0, [1.9911569879029551, 1.0]], [0, [5.266863801999402, 1.0]], [1, [7.115318619882141, 1.0]], [1, [23.173286268053207, 1.0]], [1, [99.7850978500744, 1.0]], [1, [0.26607359414519816, 1.0]], [1, [2.4420439580044144, 1.0]], [1, [0.8339491729810775, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78554539]
bas 1, expnt(s) = [24413.79419853]
bas 2, expnt(s) = [3661.45092421]
bas 3, expnt(s) = [833.33238627]
bas 4, expnt(s) = [235.31068548]
bas 5, expnt(s) = [76.36920792]
bas 6, expnt(s) = [11.70617404]
bas 7, expnt(s) = [28.22706387]
bas 8, expnt(s) = [0.30142666]
bas 9, expnt(s) = [1.99115699]
bas 10, expnt(s) = [5.2668638]
bas 11, expnt(s) = [7.11531862]
bas 12, expnt(s) = [23.17328627]
bas 13, expnt(s) = [99.78509785]
bas 14, expnt(s) = [0.26607359]
bas 15, expnt(s) = [2.44204396]
bas 16, expnt(s) = [0.83394917]
CPU time:       294.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.85545385e-01 2.10811105e+00 2.44137942e+04 4.93448103e+03
 3.66145092e+03 1.18920010e+03 8.33332386e+02 3.91858002e+02
 2.35310685e+02 1.51791083e+02 7.63692079e+01 6.52685161e+01
 1.17061740e+01 1.59891824e+01 2.82270639e+01 3.09395721e+01
 3.01426660e-01 1.02778262e+00 1.99115699e+00 4.23490967e+00
 5.26686380e+00 8.78373227e+00 7.11531862e+00 3.39021572e+01
 2.31732863e+01 1.48326560e+02 9.97850979e+01 9.20060746e+02
 2.66073594e-01 5.57489398e-01 2.44204396e+00 8.90586770e+00
 8.33949173e-01 2.32492459e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640163898038
cond(S) = 1296.9246310023034
E1 = -183.59041271445113  E_coul = 55.080165460088466
init E= -128.510247254363
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403766815617  LUMO = 0.794570527113664
  mo_energy =
[-3.25552177e+01 -1.85274274e+00 -7.75403767e-01 -7.75403767e-01
 -7.75403767e-01  7.94570527e-01  8.24037868e-01  8.24037868e-01
  8.24037868e-01  3.95680794e+00  3.95680794e+00  3.95680794e+00
  4.44351149e+00  1.43609055e+01  1.43609055e+01  1.43609055e+01
  1.64730027e+01  5.28249639e+01  5.30155252e+01  5.30155252e+01
  5.30155252e+01  1.62795908e+02  2.40846077e+02  2.40846077e+02
  2.40846077e+02  5.27472957e+02  1.89261364e+03  8.01948667e+03
  4.77838324e+04]
E1 = -182.08596584117362  E_coul = 53.547550010921825
cycle= 1 E= -128.538415830252  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519466
diis-c [-0.26984441  1.        ]
  HOMO = -0.884334848380796  LUMO = 0.765423964837632
  mo_energy =
[-3.28784343e+01 -1.96665074e+00 -8.84334848e-01 -8.84334848e-01
 -8.84334848e-01  7.65423965e-01  7.97251151e-01  7.97251151e-01
  7.97251151e-01  3.85931186e+00  3.85931186e+00  3.85931186e+00
  4.35618531e+00  1.41701014e+01  1.41701014e+01  1.41701014e+01
  1.62985058e+01  5.25676620e+01  5.27345351e+01  5.27345351e+01
  5.27345351e+01  1.62478553e+02  2.40499714e+02  2.40499714e+02
  2.40499714e+02  5.27112117e+02  1.89221623e+03  8.01905998e+03
  4.77833868e+04]
E1 = -182.8475219884453  E_coul = 54.30651814688435
cycle= 2 E= -128.541003841561  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264261
diis-c [-0.00073432  0.3363087   0.6636913 ]
  HOMO = -0.84871271693688  LUMO = 0.77474208009205
  mo_energy =
[-3.27703513e+01 -1.92914151e+00 -8.48712717e-01 -8.48712717e-01
 -8.48712717e-01  7.74742080e-01  8.05981439e-01  8.05981439e-01
  8.05981439e-01  3.89093050e+00  3.89093050e+00  3.89093050e+00
  4.38449295e+00  1.42332900e+01  1.42332900e+01  1.42332900e+01
  1.63561671e+01  5.26538669e+01  5.28285429e+01  5.28285429e+01
  5.28285429e+01  1.62584352e+02  2.40613369e+02  2.40613369e+02
  2.40613369e+02  5.27228686e+02  1.89233822e+03  8.01918448e+03
  4.77835122e+04]
E1 = -182.58888755251306  E_coul = 54.04696334903879
cycle= 3 E= -128.541924203474  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108698
diis-c [-1.92315882e-07 -2.38879604e-03 -9.33462947e-04  1.00332226e+00]
  HOMO = -0.848963530702825  LUMO = 0.774690690540611
  mo_energy =
[-3.27707856e+01 -1.92932731e+00 -8.48963531e-01 -8.48963531e-01
 -8.48963531e-01  7.74690691e-01  8.05943130e-01  8.05943130e-01
  8.05943130e-01  3.89075822e+00  3.89075822e+00  3.89075822e+00
  4.38434607e+00  1.42329971e+01  1.42329971e+01  1.42329971e+01
  1.63559004e+01  5.26535143e+01  5.28281588e+01  5.28281588e+01
  5.28281588e+01  1.62583913e+02  2.40612865e+02  2.40612865e+02
  2.40612865e+02  5.27228127e+02  1.89233753e+03  8.01918368e+03
  4.77835114e+04]
E1 = -182.5892737884588  E_coul = 54.04734955993988
cycle= 4 E= -128.541924228519  delta_E= -2.5e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187674
diis-c [-1.12338863e-09  2.31528717e-04  5.35968666e-04 -1.84193001e-01
  1.18342550e+00]
  HOMO = -0.849006955827389  LUMO = 0.774677496463506
  mo_energy =
[-3.27708594e+01 -1.92936016e+00 -8.49006956e-01 -8.49006956e-01
 -8.49006956e-01  7.74677496e-01  8.05929652e-01  8.05929652e-01
  8.05929652e-01  3.89071772e+00  3.89071772e+00  3.89071772e+00
  4.38431262e+00  1.42329372e+01  1.42329372e+01  1.42329372e+01
  1.63558446e+01  5.26534469e+01  5.28280891e+01  5.28280891e+01
  5.28280891e+01  1.62583839e+02  2.40612786e+02  2.40612786e+02
  2.40612786e+02  5.27228044e+02  1.89233744e+03  8.01918359e+03
  4.77835113e+04]
E1 = -182.58940820490693  E_coul = 54.04748397566653
cycle= 5 E= -128.54192422924  delta_E= -7.21e-10  |g|= 5.94e-06  |ddm|= 5.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58940820490693  E_coul = 54.04748397566653
  HOMO = -0.84900384683759  LUMO = 0.774678826971103
  mo_energy =
[-3.27708523e+01 -1.92935624e+00 -8.49003847e-01 -8.49003847e-01
 -8.49003847e-01  7.74678827e-01  8.05930568e-01  8.05930568e-01
  8.05930568e-01  3.89072070e+00  3.89072070e+00  3.89072070e+00
  4.38431566e+00  1.42329423e+01  1.42329423e+01  1.42329423e+01
  1.63558496e+01  5.26534533e+01  5.28280957e+01  5.28280957e+01
  5.28280957e+01  1.62583846e+02  2.40612793e+02  2.40612793e+02
  2.40612793e+02  5.27228051e+02  1.89233744e+03  8.01918359e+03
  4.77835113e+04]
E1 = -182.58939233324153  E_coul = 54.04746810399867
Extra cycle  E= -128.541924229243  delta_E= -2.44e-12  |g|= 2.24e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.85545385e-01 2.44137942e+04 3.66145092e+03 8.33332386e+02
 2.35310685e+02 7.63692079e+01 1.17061740e+01 2.82270639e+01
 3.01426660e-01 1.99115699e+00 5.26686380e+00 7.11531862e+00
 2.31732863e+01 9.97850979e+01 2.66073594e-01 2.44204396e+00
 8.33949173e-01]
E = -128.54192422924285
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.785545385295       1
[INPUT] 0    0    [1    /1   ]  24413.7941985        1
[INPUT] 0    0    [1    /1   ]  3661.45092421        1
[INPUT] 0    0    [1    /1   ]  833.332386268        1
[INPUT] 0    0    [1    /1   ]  235.310685477        1
[INPUT] 0    0    [1    /1   ]  76.3692079197        1
[INPUT] 0    0    [1    /1   ]  11.7061740449        1
[INPUT] 0    0    [1    /1   ]  28.2270638702        1
[INPUT] 0    0    [1    /1   ]  0.301426659605       1
[INPUT] 0    0    [1    /1   ]  1.9911569879         1
[INPUT] 0    0    [1    /1   ]  5.266863802          1
[INPUT] 1    0    [1    /1   ]  7.11531861988        1
[INPUT] 1    0    [1    /1   ]  23.1732862681        1
[INPUT] 1    0    [1    /1   ]  99.7850978501        1
[INPUT] 1    0    [1    /1   ]  0.266073594145       1
[INPUT] 1    0    [1    /1   ]  2.442043958          1
[INPUT] 1    0    [1    /1   ]  0.833949172981       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7855453852952189, 1.0]], [0, [24413.79419852569, 1.0]], [0, [3661.4509242066265, 1.0]], [0, [833.332386268367, 1.0]], [0, [235.31068547712044, 1.0]], [0, [76.36920791968718, 1.0]], [0, [11.706174044882877, 1.0]], [0, [28.227063870220913, 1.0]], [0, [0.3014266596052547, 1.0]], [0, [1.9911569879029551, 1.0]], [0, [5.266863801999402, 1.0]], [1, [7.115318619882141, 1.0]], [1, [23.173286268053207, 1.0]], [1, [99.7850978500744, 1.0]], [1, [0.26607359414519816, 1.0]], [1, [2.4420439580044144, 1.0]], [1, [0.8339491729810775, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78554539]
bas 1, expnt(s) = [24413.79419853]
bas 2, expnt(s) = [3661.45092421]
bas 3, expnt(s) = [833.33238627]
bas 4, expnt(s) = [235.31068548]
bas 5, expnt(s) = [76.36920792]
bas 6, expnt(s) = [11.70617404]
bas 7, expnt(s) = [28.22706387]
bas 8, expnt(s) = [0.30142666]
bas 9, expnt(s) = [1.99115699]
bas 10, expnt(s) = [5.2668638]
bas 11, expnt(s) = [7.11531862]
bas 12, expnt(s) = [23.17328627]
bas 13, expnt(s) = [99.78509785]
bas 14, expnt(s) = [0.26607359]
bas 15, expnt(s) = [2.44204396]
bas 16, expnt(s) = [0.83394917]
CPU time:       295.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.85545385e-01 2.10811105e+00 2.44137942e+04 4.93448103e+03
 3.66145092e+03 1.18920010e+03 8.33332386e+02 3.91858002e+02
 2.35310685e+02 1.51791083e+02 7.63692079e+01 6.52685161e+01
 1.17061740e+01 1.59891824e+01 2.82270639e+01 3.09395721e+01
 3.01426660e-01 1.02778262e+00 1.99115699e+00 4.23490967e+00
 5.26686380e+00 8.78373227e+00 7.11531862e+00 3.39021572e+01
 2.31732863e+01 1.48326560e+02 9.97850979e+01 9.20060746e+02
 2.66073594e-01 5.57489398e-01 2.44204396e+00 8.90586770e+00
 8.33949173e-01 2.32492459e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640163898038
cond(S) = 1296.9246310023034
E1 = -183.59041271445113  E_coul = 55.080165460088466
init E= -128.510247254363
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403766815617  LUMO = 0.794570527113664
  mo_energy =
[-3.25552177e+01 -1.85274274e+00 -7.75403767e-01 -7.75403767e-01
 -7.75403767e-01  7.94570527e-01  8.24037868e-01  8.24037868e-01
  8.24037868e-01  3.95680794e+00  3.95680794e+00  3.95680794e+00
  4.44351149e+00  1.43609055e+01  1.43609055e+01  1.43609055e+01
  1.64730027e+01  5.28249639e+01  5.30155252e+01  5.30155252e+01
  5.30155252e+01  1.62795908e+02  2.40846077e+02  2.40846077e+02
  2.40846077e+02  5.27472957e+02  1.89261364e+03  8.01948667e+03
  4.77838324e+04]
E1 = -182.08596584117362  E_coul = 53.547550010921825
cycle= 1 E= -128.538415830252  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519466
diis-c [-0.26984441  1.        ]
  HOMO = -0.884334848380796  LUMO = 0.765423964837632
  mo_energy =
[-3.28784343e+01 -1.96665074e+00 -8.84334848e-01 -8.84334848e-01
 -8.84334848e-01  7.65423965e-01  7.97251151e-01  7.97251151e-01
  7.97251151e-01  3.85931186e+00  3.85931186e+00  3.85931186e+00
  4.35618531e+00  1.41701014e+01  1.41701014e+01  1.41701014e+01
  1.62985058e+01  5.25676620e+01  5.27345351e+01  5.27345351e+01
  5.27345351e+01  1.62478553e+02  2.40499714e+02  2.40499714e+02
  2.40499714e+02  5.27112117e+02  1.89221623e+03  8.01905998e+03
  4.77833868e+04]
E1 = -182.8475219884453  E_coul = 54.30651814688435
cycle= 2 E= -128.541003841561  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264261
diis-c [-0.00073432  0.3363087   0.6636913 ]
  HOMO = -0.84871271693688  LUMO = 0.77474208009205
  mo_energy =
[-3.27703513e+01 -1.92914151e+00 -8.48712717e-01 -8.48712717e-01
 -8.48712717e-01  7.74742080e-01  8.05981439e-01  8.05981439e-01
  8.05981439e-01  3.89093050e+00  3.89093050e+00  3.89093050e+00
  4.38449295e+00  1.42332900e+01  1.42332900e+01  1.42332900e+01
  1.63561671e+01  5.26538669e+01  5.28285429e+01  5.28285429e+01
  5.28285429e+01  1.62584352e+02  2.40613369e+02  2.40613369e+02
  2.40613369e+02  5.27228686e+02  1.89233822e+03  8.01918448e+03
  4.77835122e+04]
E1 = -182.58888755251306  E_coul = 54.04696334903879
cycle= 3 E= -128.541924203474  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108698
diis-c [-1.92315882e-07 -2.38879604e-03 -9.33462947e-04  1.00332226e+00]
  HOMO = -0.848963530702825  LUMO = 0.774690690540611
  mo_energy =
[-3.27707856e+01 -1.92932731e+00 -8.48963531e-01 -8.48963531e-01
 -8.48963531e-01  7.74690691e-01  8.05943130e-01  8.05943130e-01
  8.05943130e-01  3.89075822e+00  3.89075822e+00  3.89075822e+00
  4.38434607e+00  1.42329971e+01  1.42329971e+01  1.42329971e+01
  1.63559004e+01  5.26535143e+01  5.28281588e+01  5.28281588e+01
  5.28281588e+01  1.62583913e+02  2.40612865e+02  2.40612865e+02
  2.40612865e+02  5.27228127e+02  1.89233753e+03  8.01918368e+03
  4.77835114e+04]
E1 = -182.5892737884588  E_coul = 54.04734955993988
cycle= 4 E= -128.541924228519  delta_E= -2.5e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187674
diis-c [-1.12338863e-09  2.31528717e-04  5.35968666e-04 -1.84193001e-01
  1.18342550e+00]
  HOMO = -0.849006955827389  LUMO = 0.774677496463506
  mo_energy =
[-3.27708594e+01 -1.92936016e+00 -8.49006956e-01 -8.49006956e-01
 -8.49006956e-01  7.74677496e-01  8.05929652e-01  8.05929652e-01
  8.05929652e-01  3.89071772e+00  3.89071772e+00  3.89071772e+00
  4.38431262e+00  1.42329372e+01  1.42329372e+01  1.42329372e+01
  1.63558446e+01  5.26534469e+01  5.28280891e+01  5.28280891e+01
  5.28280891e+01  1.62583839e+02  2.40612786e+02  2.40612786e+02
  2.40612786e+02  5.27228044e+02  1.89233744e+03  8.01918359e+03
  4.77835113e+04]
E1 = -182.58940820490693  E_coul = 54.04748397566653
cycle= 5 E= -128.54192422924  delta_E= -7.21e-10  |g|= 5.94e-06  |ddm|= 5.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58940820490693  E_coul = 54.04748397566653
  HOMO = -0.84900384683759  LUMO = 0.774678826971103
  mo_energy =
[-3.27708523e+01 -1.92935624e+00 -8.49003847e-01 -8.49003847e-01
 -8.49003847e-01  7.74678827e-01  8.05930568e-01  8.05930568e-01
  8.05930568e-01  3.89072070e+00  3.89072070e+00  3.89072070e+00
  4.38431566e+00  1.42329423e+01  1.42329423e+01  1.42329423e+01
  1.63558496e+01  5.26534533e+01  5.28280957e+01  5.28280957e+01
  5.28280957e+01  1.62583846e+02  2.40612793e+02  2.40612793e+02
  2.40612793e+02  5.27228051e+02  1.89233744e+03  8.01918359e+03
  4.77835113e+04]
E1 = -182.58939233324153  E_coul = 54.04746810399867
Extra cycle  E= -128.541924229243  delta_E= -2.44e-12  |g|= 2.24e-06  |ddm|= 2.17e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1296.9246310023034
E1 = -182.58939233324153  E_coul = 54.04746810399867
init E= -128.541924229243
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.849004970153451  LUMO = 0.774678616447924
  mo_energy =
[-3.27708559e+01 -1.92935728e+00 -8.49004970e-01 -8.49004970e-01
 -8.49004970e-01  7.74678616e-01  8.05930311e-01  8.05930311e-01
  8.05930311e-01  3.89071973e+00  3.89071973e+00  3.89071973e+00
  4.38431486e+00  1.42329403e+01  1.42329403e+01  1.42329403e+01
  1.63558479e+01  5.26534505e+01  5.28280926e+01  5.28280926e+01
  5.28280926e+01  1.62583843e+02  2.40612789e+02  2.40612789e+02
  2.40612789e+02  5.27228047e+02  1.89233744e+03  8.01918359e+03
  4.77835113e+04]
E1 = -182.58940115240313  E_coul = 54.04747692315993
cycle= 1 E= -128.541924229243  delta_E= -3.41e-13  |g|= 1.21e-06  |ddm|= 8.01e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58940115240313  E_coul = 54.04747692315993
  HOMO = -0.849004349399102  LUMO = 0.774678795578594
  mo_energy =
[-3.27708540e+01 -1.92935660e+00 -8.49004349e-01 -8.49004349e-01
 -8.49004349e-01  7.74678796e-01  8.05930466e-01  8.05930466e-01
  8.05930466e-01  3.89072029e+00  3.89072029e+00  3.89072029e+00
  4.38431537e+00  1.42329414e+01  1.42329414e+01  1.42329414e+01
  1.63558489e+01  5.26534520e+01  5.28280943e+01  5.28280943e+01
  5.28280943e+01  1.62583845e+02  2.40612791e+02  2.40612791e+02
  2.40612791e+02  5.27228049e+02  1.89233744e+03  8.01918359e+03
  4.77835113e+04]
E1 = -182.58939672007764  E_coul = 54.04747249083421
Extra cycle  E= -128.541924229243  delta_E= -2.27e-13  |g|= 6.02e-07  |ddm|= 3.97e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [7.85545385e-01 2.44137942e+04 3.66145092e+03 8.33332386e+02
 2.35310685e+02 7.63692079e+01 1.17061740e+01 2.82270639e+01
 3.01426660e-01 1.99115699e+00 5.26686380e+00 7.11531862e+00
 2.31732863e+01 9.97850979e+01 2.66073594e-01 2.44204396e+00
 8.33949173e-01]
grad_E = [-6.64687455e-06 -9.40776982e-10  5.08252599e-08 -1.08810773e-06
  1.27371399e-05 -5.19842385e-05 -8.48578203e-06 -3.55652189e-05
 -5.68525843e-06  1.74055111e-07  3.14153642e-05  8.54741605e-07
 -4.23666785e-07  2.37877184e-08  2.75323150e-05  5.18541224e-06
 -1.08400630e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.784634263408       1
[INPUT] 0    0    [1    /1   ]  24413.7941985        1
[INPUT] 0    0    [1    /1   ]  3661.45092629        1
[INPUT] 0    0    [1    /1   ]  833.332346188        1
[INPUT] 0    0    [1    /1   ]  235.311086364        1
[INPUT] 0    0    [1    /1   ]  76.3676591925        1
[INPUT] 0    0    [1    /1   ]  11.7038488906        1
[INPUT] 0    0    [1    /1   ]  28.2283892077        1
[INPUT] 0    0    [1    /1   ]  0.301090692306       1
[INPUT] 0    0    [1    /1   ]  1.98935535645        1
[INPUT] 0    0    [1    /1   ]  5.2633524422         1
[INPUT] 1    0    [1    /1   ]  7.11423549052        1
[INPUT] 1    0    [1    /1   ]  23.1736562224        1
[INPUT] 1    0    [1    /1   ]  99.7850806021        1
[INPUT] 1    0    [1    /1   ]  0.266098165222       1
[INPUT] 1    0    [1    /1   ]  2.44171055895        1
[INPUT] 1    0    [1    /1   ]  0.833903184724       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7846342634080139, 1.0]], [0, [24413.79419848612, 1.0]], [0, [3661.450926291029, 1.0]], [0, [833.3323461875856, 1.0]], [0, [235.31108636445282, 1.0]], [0, [76.36765919251556, 1.0]], [0, [11.703848890643947, 1.0]], [0, [28.228389207742854, 1.0]], [0, [0.3010906923058574, 1.0]], [0, [1.9893553564494146, 1.0]], [0, [5.263352442195864, 1.0]], [1, [7.114235490522665, 1.0]], [1, [23.173656222361505, 1.0]], [1, [99.78508060212376, 1.0]], [1, [0.2660981652223657, 1.0]], [1, [2.441710558951867, 1.0]], [1, [0.8339031847240592, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78463426]
bas 1, expnt(s) = [24413.79419849]
bas 2, expnt(s) = [3661.45092629]
bas 3, expnt(s) = [833.33234619]
bas 4, expnt(s) = [235.31108636]
bas 5, expnt(s) = [76.36765919]
bas 6, expnt(s) = [11.70384889]
bas 7, expnt(s) = [28.22838921]
bas 8, expnt(s) = [0.30109069]
bas 9, expnt(s) = [1.98935536]
bas 10, expnt(s) = [5.26335244]
bas 11, expnt(s) = [7.11423549]
bas 12, expnt(s) = [23.17365622]
bas 13, expnt(s) = [99.7850806]
bas 14, expnt(s) = [0.26609817]
bas 15, expnt(s) = [2.44171056]
bas 16, expnt(s) = [0.83390318]
CPU time:       298.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.84634263e-01 2.10627695e+00 2.44137942e+04 4.93448103e+03
 3.66145093e+03 1.18920010e+03 8.33332346e+02 3.91857988e+02
 2.35311086e+02 1.51791277e+02 7.63676592e+01 6.52675234e+01
 1.17038489e+01 1.59868004e+01 2.82283892e+01 3.09406617e+01
 3.01090692e-01 1.02692333e+00 1.98935536e+00 4.23203548e+00
 5.26335244e+00 8.77933990e+00 7.11423549e+00 3.38957063e+01
 2.31736562e+01 1.48329520e+02 9.97850806e+01 9.20060547e+02
 2.66098165e-01 5.57553752e-01 2.44171056e+00 8.90434788e+00
 8.33903185e-01 2.32476433e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640170106503
cond(S) = 1293.9414545063903
E1 = -183.5904172805345  E_coul = 55.08016589476278
init E= -128.510251385772
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.775403712830948  LUMO = 0.793350281096576
  mo_energy =
[-3.25552177e+01 -1.85274269e+00 -7.75403713e-01 -7.75403713e-01
 -7.75403713e-01  7.93350281e-01  8.24087086e-01  8.24087086e-01
  8.24087086e-01  3.95661079e+00  3.95661079e+00  3.95661079e+00
  4.43769367e+00  1.43590247e+01  1.43590247e+01  1.43590247e+01
  1.64573509e+01  5.27979101e+01  5.30115855e+01  5.30115855e+01
  5.30115855e+01  1.62764091e+02  2.40843009e+02  2.40843009e+02
  2.40843009e+02  5.27440799e+02  1.89258359e+03  8.01946006e+03
  4.77838104e+04]
E1 = -182.08600755027976  E_coul = 53.547591545840326
cycle= 1 E= -128.538416004439  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519466
diis-c [-0.26984459  1.        ]
  HOMO = -0.884331337095628  LUMO = 0.764249995638197
  mo_energy =
[-3.28784283e+01 -1.96664646e+00 -8.84331337e-01 -8.84331337e-01
 -8.84331337e-01  7.64249996e-01  7.97301445e-01  7.97301445e-01
  7.97301445e-01  3.85912740e+00  3.85912740e+00  3.85912740e+00
  4.35044077e+00  1.41682391e+01  1.41682391e+01  1.41682391e+01
  1.62829075e+01  5.25406233e+01  5.27306020e+01  5.27306020e+01
  5.27306020e+01  1.62446740e+02  2.40496651e+02  2.40496651e+02
  2.40496651e+02  5.27079964e+02  1.89218619e+03  8.01903338e+03
  4.77833648e+04]
E1 = -182.84754369151224  E_coul = 54.30653975693122
cycle= 2 E= -128.541003934581  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264258
diis-c [-0.00073416  0.33630662  0.66369338]
  HOMO = -0.84871005101417  LUMO = 0.773553704001622
  mo_energy =
[-3.27703477e+01 -1.92913815e+00 -8.48710051e-01 -8.48710051e-01
 -8.48710051e-01  7.73553704e-01  8.06031616e-01  8.06031616e-01
  8.06031616e-01  3.89074231e+00  3.89074231e+00  3.89074231e+00
  4.37872464e+00  1.42314216e+01  1.42314216e+01  1.42314216e+01
  1.63405509e+01  5.26268231e+01  5.28246075e+01  5.28246075e+01
  5.28246075e+01  1.62552538e+02  2.40610304e+02  2.40610304e+02
  2.40610304e+02  5.27196531e+02  1.89230818e+03  8.01915787e+03
  4.77834902e+04]
E1 = -182.58891948814139  E_coul = 54.04699524931247
cycle= 3 E= -128.541924238829  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00108677
diis-c [-1.92588287e-07 -2.38856709e-03 -9.34455058e-04  1.00332302e+00]
  HOMO = -0.848960734766335  LUMO = 0.77350248428715
  mo_energy =
[-3.27707818e+01 -1.92932375e+00 -8.48960735e-01 -8.48960735e-01
 -8.48960735e-01  7.73502484e-01  8.05993357e-01  8.05993357e-01
  8.05993357e-01  3.89057019e+00  3.89057019e+00  3.89057019e+00
  4.37857802e+00  1.42311289e+01  1.42311289e+01  1.42311289e+01
  1.63402845e+01  5.26264707e+01  5.28242236e+01  5.28242236e+01
  5.28242236e+01  1.62552099e+02  2.40609799e+02  2.40609799e+02
  2.40609799e+02  5.27195972e+02  1.89230749e+03  8.01915708e+03
  4.77834893e+04]
E1 = -182.58930557967165  E_coul = 54.04738131579838
cycle= 4 E= -128.541924263873  delta_E= -2.5e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018768
diis-c [-1.12506135e-09  2.31877515e-04  5.36177997e-04 -1.84376028e-01
  1.18360797e+00]
  HOMO = -0.849004149860563  LUMO = 0.773489322094149
  mo_energy =
[-3.27708556e+01 -1.92935657e+00 -8.49004150e-01 -8.49004150e-01
 -8.49004150e-01  7.73489322e-01  8.05979884e-01  8.05979884e-01
  8.05979884e-01  3.89052970e+00  3.89052970e+00  3.89052970e+00
  4.37854462e+00  1.42310690e+01  1.42310690e+01  1.42310690e+01
  1.63402287e+01  5.26264034e+01  5.28241539e+01  5.28241539e+01
  5.28241539e+01  1.62552025e+02  2.40609721e+02  2.40609721e+02
  2.40609721e+02  5.27195889e+02  1.89230740e+03  8.01915698e+03
  4.77834892e+04]
E1 = -182.58943997956618  E_coul = 54.0475157149704
cycle= 5 E= -128.541924264596  delta_E= -7.23e-10  |g|= 5.95e-06  |ddm|= 5.63e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58943997956618  E_coul = 54.0475157149704
  HOMO = -0.849001035725767  LUMO = 0.773490652792148
  mo_energy =
[-3.27708485e+01 -1.92935265e+00 -8.49001036e-01 -8.49001036e-01
 -8.49001036e-01  7.73490653e-01  8.05980800e-01  8.05980800e-01
  8.05980800e-01  3.89053269e+00  3.89053269e+00  3.89053269e+00
  4.37854766e+00  1.42310742e+01  1.42310742e+01  1.42310742e+01
  1.63402337e+01  5.26264097e+01  5.28241605e+01  5.28241605e+01
  5.28241605e+01  1.62552032e+02  2.40609728e+02  2.40609728e+02
  2.40609728e+02  5.27195896e+02  1.89230740e+03  8.01915699e+03
  4.77834892e+04]
E1 = -182.58942408586844  E_coul = 54.04749982127032
Extra cycle  E= -128.541924264598  delta_E= -2.36e-12  |g|= 2.24e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.16 sec, wall time      0.16 sec
exp = [7.84634263e-01 2.44137942e+04 3.66145093e+03 8.33332346e+02
 2.35311086e+02 7.63676592e+01 1.17038489e+01 2.82283892e+01
 3.01090692e-01 1.98935536e+00 5.26335244e+00 7.11423549e+00
 2.31736562e+01 9.97850806e+01 2.66098165e-01 2.44171056e+00
 8.33903185e-01]
E = -128.54192426459812
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.784634263408       1
[INPUT] 0    0    [1    /1   ]  24413.7941985        1
[INPUT] 0    0    [1    /1   ]  3661.45092629        1
[INPUT] 0    0    [1    /1   ]  833.332346188        1
[INPUT] 0    0    [1    /1   ]  235.311086364        1
[INPUT] 0    0    [1    /1   ]  76.3676591925        1
[INPUT] 0    0    [1    /1   ]  11.7038488906        1
[INPUT] 0    0    [1    /1   ]  28.2283892077        1
[INPUT] 0    0    [1    /1   ]  0.301090692306       1
[INPUT] 0    0    [1    /1   ]  1.98935535645        1
[INPUT] 0    0    [1    /1   ]  5.2633524422         1
[INPUT] 1    0    [1    /1   ]  7.11423549052        1
[INPUT] 1    0    [1    /1   ]  23.1736562224        1
[INPUT] 1    0    [1    /1   ]  99.7850806021        1
[INPUT] 1    0    [1    /1   ]  0.266098165222       1
[INPUT] 1    0    [1    /1   ]  2.44171055895        1
[INPUT] 1    0    [1    /1   ]  0.833903184724       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7846342634080139, 1.0]], [0, [24413.79419848612, 1.0]], [0, [3661.450926291029, 1.0]], [0, [833.3323461875856, 1.0]], [0, [235.31108636445282, 1.0]], [0, [76.36765919251556, 1.0]], [0, [11.703848890643947, 1.0]], [0, [28.228389207742854, 1.0]], [0, [0.3010906923058574, 1.0]], [0, [1.9893553564494146, 1.0]], [0, [5.263352442195864, 1.0]], [1, [7.114235490522665, 1.0]], [1, [23.173656222361505, 1.0]], [1, [99.78508060212376, 1.0]], [1, [0.2660981652223657, 1.0]], [1, [2.441710558951867, 1.0]], [1, [0.8339031847240592, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78463426]
bas 1, expnt(s) = [24413.79419849]
bas 2, expnt(s) = [3661.45092629]
bas 3, expnt(s) = [833.33234619]
bas 4, expnt(s) = [235.31108636]
bas 5, expnt(s) = [76.36765919]
bas 6, expnt(s) = [11.70384889]
bas 7, expnt(s) = [28.22838921]
bas 8, expnt(s) = [0.30109069]
bas 9, expnt(s) = [1.98935536]
bas 10, expnt(s) = [5.26335244]
bas 11, expnt(s) = [7.11423549]
bas 12, expnt(s) = [23.17365622]
bas 13, expnt(s) = [99.7850806]
bas 14, expnt(s) = [0.26609817]
bas 15, expnt(s) = [2.44171056]
bas 16, expnt(s) = [0.83390318]
CPU time:       299.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.84634263e-01 2.10627695e+00 2.44137942e+04 4.93448103e+03
 3.66145093e+03 1.18920010e+03 8.33332346e+02 3.91857988e+02
 2.35311086e+02 1.51791277e+02 7.63676592e+01 6.52675234e+01
 1.17038489e+01 1.59868004e+01 2.82283892e+01 3.09406617e+01
 3.01090692e-01 1.02692333e+00 1.98935536e+00 4.23203548e+00
 5.26335244e+00 8.77933990e+00 7.11423549e+00 3.38957063e+01
 2.31736562e+01 1.48329520e+02 9.97850806e+01 9.20060547e+02
 2.66098165e-01 5.57553752e-01 2.44171056e+00 8.90434788e+00
 8.33903185e-01 2.32476433e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640170106503
cond(S) = 1293.9414545063903
E1 = -183.5904172805345  E_coul = 55.08016589476278
init E= -128.510251385772
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403712830948  LUMO = 0.793350281096576
  mo_energy =
[-3.25552177e+01 -1.85274269e+00 -7.75403713e-01 -7.75403713e-01
 -7.75403713e-01  7.93350281e-01  8.24087086e-01  8.24087086e-01
  8.24087086e-01  3.95661079e+00  3.95661079e+00  3.95661079e+00
  4.43769367e+00  1.43590247e+01  1.43590247e+01  1.43590247e+01
  1.64573509e+01  5.27979101e+01  5.30115855e+01  5.30115855e+01
  5.30115855e+01  1.62764091e+02  2.40843009e+02  2.40843009e+02
  2.40843009e+02  5.27440799e+02  1.89258359e+03  8.01946006e+03
  4.77838104e+04]
E1 = -182.08600755027976  E_coul = 53.547591545840326
cycle= 1 E= -128.538416004439  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.519466
diis-c [-0.26984459  1.        ]
  HOMO = -0.884331337095628  LUMO = 0.764249995638197
  mo_energy =
[-3.28784283e+01 -1.96664646e+00 -8.84331337e-01 -8.84331337e-01
 -8.84331337e-01  7.64249996e-01  7.97301445e-01  7.97301445e-01
  7.97301445e-01  3.85912740e+00  3.85912740e+00  3.85912740e+00
  4.35044077e+00  1.41682391e+01  1.41682391e+01  1.41682391e+01
  1.62829075e+01  5.25406233e+01  5.27306020e+01  5.27306020e+01
  5.27306020e+01  1.62446740e+02  2.40496651e+02  2.40496651e+02
  2.40496651e+02  5.27079964e+02  1.89218619e+03  8.01903338e+03
  4.77833648e+04]
E1 = -182.84754369151224  E_coul = 54.30653975693122
cycle= 2 E= -128.541003934581  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264258
diis-c [-0.00073416  0.33630662  0.66369338]
  HOMO = -0.84871005101417  LUMO = 0.773553704001622
  mo_energy =
[-3.27703477e+01 -1.92913815e+00 -8.48710051e-01 -8.48710051e-01
 -8.48710051e-01  7.73553704e-01  8.06031616e-01  8.06031616e-01
  8.06031616e-01  3.89074231e+00  3.89074231e+00  3.89074231e+00
  4.37872464e+00  1.42314216e+01  1.42314216e+01  1.42314216e+01
  1.63405509e+01  5.26268231e+01  5.28246075e+01  5.28246075e+01
  5.28246075e+01  1.62552538e+02  2.40610304e+02  2.40610304e+02
  2.40610304e+02  5.27196531e+02  1.89230818e+03  8.01915787e+03
  4.77834902e+04]
E1 = -182.58891948814139  E_coul = 54.04699524931247
cycle= 3 E= -128.541924238829  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00108677
diis-c [-1.92588287e-07 -2.38856709e-03 -9.34455058e-04  1.00332302e+00]
  HOMO = -0.848960734766335  LUMO = 0.77350248428715
  mo_energy =
[-3.27707818e+01 -1.92932375e+00 -8.48960735e-01 -8.48960735e-01
 -8.48960735e-01  7.73502484e-01  8.05993357e-01  8.05993357e-01
  8.05993357e-01  3.89057019e+00  3.89057019e+00  3.89057019e+00
  4.37857802e+00  1.42311289e+01  1.42311289e+01  1.42311289e+01
  1.63402845e+01  5.26264707e+01  5.28242236e+01  5.28242236e+01
  5.28242236e+01  1.62552099e+02  2.40609799e+02  2.40609799e+02
  2.40609799e+02  5.27195972e+02  1.89230749e+03  8.01915708e+03
  4.77834893e+04]
E1 = -182.58930557967165  E_coul = 54.04738131579838
cycle= 4 E= -128.541924263873  delta_E= -2.5e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018768
diis-c [-1.12506135e-09  2.31877515e-04  5.36177997e-04 -1.84376028e-01
  1.18360797e+00]
  HOMO = -0.849004149860563  LUMO = 0.773489322094149
  mo_energy =
[-3.27708556e+01 -1.92935657e+00 -8.49004150e-01 -8.49004150e-01
 -8.49004150e-01  7.73489322e-01  8.05979884e-01  8.05979884e-01
  8.05979884e-01  3.89052970e+00  3.89052970e+00  3.89052970e+00
  4.37854462e+00  1.42310690e+01  1.42310690e+01  1.42310690e+01
  1.63402287e+01  5.26264034e+01  5.28241539e+01  5.28241539e+01
  5.28241539e+01  1.62552025e+02  2.40609721e+02  2.40609721e+02
  2.40609721e+02  5.27195889e+02  1.89230740e+03  8.01915698e+03
  4.77834892e+04]
E1 = -182.58943997956618  E_coul = 54.0475157149704
cycle= 5 E= -128.541924264596  delta_E= -7.23e-10  |g|= 5.95e-06  |ddm|= 5.63e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58943997956618  E_coul = 54.0475157149704
  HOMO = -0.849001035725767  LUMO = 0.773490652792148
  mo_energy =
[-3.27708485e+01 -1.92935265e+00 -8.49001036e-01 -8.49001036e-01
 -8.49001036e-01  7.73490653e-01  8.05980800e-01  8.05980800e-01
  8.05980800e-01  3.89053269e+00  3.89053269e+00  3.89053269e+00
  4.37854766e+00  1.42310742e+01  1.42310742e+01  1.42310742e+01
  1.63402337e+01  5.26264097e+01  5.28241605e+01  5.28241605e+01
  5.28241605e+01  1.62552032e+02  2.40609728e+02  2.40609728e+02
  2.40609728e+02  5.27195896e+02  1.89230740e+03  8.01915699e+03
  4.77834892e+04]
E1 = -182.58942408586844  E_coul = 54.04749982127032
Extra cycle  E= -128.541924264598  delta_E= -2.36e-12  |g|= 2.24e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1293.9414545063903
E1 = -182.58942408586844  E_coul = 54.04749982127032
init E= -128.541924264598
    CPU time for initialize scf      0.37 sec, wall time      0.36 sec
  HOMO = -0.849002160536694  LUMO = 0.773490442321068
  mo_energy =
[-3.27708520e+01 -1.92935369e+00 -8.49002161e-01 -8.49002161e-01
 -8.49002161e-01  7.73490442e-01  8.05980543e-01  8.05980543e-01
  8.05980543e-01  3.89053171e+00  3.89053171e+00  3.89053171e+00
  4.37854686e+00  1.42310722e+01  1.42310722e+01  1.42310722e+01
  1.63402319e+01  5.26264070e+01  5.28241575e+01  5.28241575e+01
  5.28241575e+01  1.62552028e+02  2.40609724e+02  2.40609724e+02
  2.40609724e+02  5.27195892e+02  1.89230740e+03  8.01915698e+03
  4.77834892e+04]
E1 = -182.58943291748824  E_coul = 54.047508652889746
cycle= 1 E= -128.541924264598  delta_E= -3.69e-13  |g|= 1.21e-06  |ddm|= 8.02e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.58943291748824  E_coul = 54.047508652889746
  HOMO = -0.849001538895521  LUMO = 0.773490621428936
  mo_energy =
[-3.27708502e+01 -1.92935301e+00 -8.49001539e-01 -8.49001539e-01
 -8.49001539e-01  7.73490621e-01  8.05980699e-01  8.05980699e-01
  8.05980699e-01  3.89053227e+00  3.89053227e+00  3.89053227e+00
  4.37854738e+00  1.42310733e+01  1.42310733e+01  1.42310733e+01
  1.63402330e+01  5.26264085e+01  5.28241591e+01  5.28241591e+01
  5.28241591e+01  1.62552030e+02  2.40609726e+02  2.40609726e+02
  2.40609726e+02  5.27195894e+02  1.89230740e+03  8.01915699e+03
  4.77834892e+04]
E1 = -182.58942847897922  E_coul = 54.04750421438054
Extra cycle  E= -128.541924264599  delta_E= -1.71e-13  |g|= 6.03e-07  |ddm|= 3.97e-07
    CPU time for scf_cycle      0.45 sec, wall time      0.45 sec
exp = [7.84634263e-01 2.44137942e+04 3.66145093e+03 8.33332346e+02
 2.35311086e+02 7.63676592e+01 1.17038489e+01 2.82283892e+01
 3.01090692e-01 1.98935536e+00 5.26335244e+00 7.11423549e+00
 2.31736562e+01 9.97850806e+01 2.66098165e-01 2.44171056e+00
 8.33903185e-01]
grad_E = [-6.97314319e-06 -9.57721623e-10  5.17116534e-08 -1.10515955e-06
  1.29192735e-05 -5.29911955e-05 -1.09685370e-05 -3.30489896e-05
 -1.58156716e-05  5.46516450e-08  3.22939922e-05 -8.16559778e-06
  1.45762272e-06 -6.42377632e-08  1.38025963e-04  2.11490261e-05
 -5.30978022e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783644635227       1
[INPUT] 0    0    [1    /1   ]  24413.7941984        1
[INPUT] 0    0    [1    /1   ]  3661.45092822        1
[INPUT] 0    0    [1    /1   ]  833.332309784        1
[INPUT] 0    0    [1    /1   ]  235.311430854        1
[INPUT] 0    0    [1    /1   ]  76.3665780321        1
[INPUT] 0    0    [1    /1   ]  11.699450744         1
[INPUT] 0    0    [1    /1   ]  28.2291798094        1
[INPUT] 0    0    [1    /1   ]  0.300700050397       1
[INPUT] 0    0    [1    /1   ]  1.98738012115        1
[INPUT] 0    0    [1    /1   ]  5.2575836824         1
[INPUT] 1    0    [1    /1   ]  7.11298792287        1
[INPUT] 1    0    [1    /1   ]  23.1740760405        1
[INPUT] 1    0    [1    /1   ]  99.7850617094        1
[INPUT] 1    0    [1    /1   ]  0.266127796597       1
[INPUT] 1    0    [1    /1   ]  2.44135591729        1
[INPUT] 1    0    [1    /1   ]  0.833867704482       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.783644635227354, 1.0]], [0, [24413.794198449552, 1.0]], [0, [3661.450928217425, 1.0]], [0, [833.3323097844371, 1.0]], [0, [235.31143085398787, 1.0]], [0, [76.36657803206691, 1.0]], [0, [11.699450743973133, 1.0]], [0, [28.229179809384952, 1.0]], [0, [0.300700050396713, 1.0]], [0, [1.9873801211542963, 1.0]], [0, [5.2575836824003686, 1.0]], [1, [7.1129879228680934, 1.0]], [1, [23.17407604048619, 1.0]], [1, [99.78506170938311, 1.0]], [1, [0.2661277965967931, 1.0]], [1, [2.441355917285483, 1.0]], [1, [0.8338677044820757, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78364464]
bas 1, expnt(s) = [24413.79419845]
bas 2, expnt(s) = [3661.45092822]
bas 3, expnt(s) = [833.33230978]
bas 4, expnt(s) = [235.31143085]
bas 5, expnt(s) = [76.36657803]
bas 6, expnt(s) = [11.69945074]
bas 7, expnt(s) = [28.22917981]
bas 8, expnt(s) = [0.30070005]
bas 9, expnt(s) = [1.98738012]
bas 10, expnt(s) = [5.25758368]
bas 11, expnt(s) = [7.11298792]
bas 12, expnt(s) = [23.17407604]
bas 13, expnt(s) = [99.78506171]
bas 14, expnt(s) = [0.2661278]
bas 15, expnt(s) = [2.44135592]
bas 16, expnt(s) = [0.8338677]
CPU time:       303.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83644635e-01 2.10428422e+00 2.44137942e+04 4.93448103e+03
 3.66145093e+03 1.18920010e+03 8.33332310e+02 3.91857975e+02
 2.35311431e+02 1.51791444e+02 7.63665780e+01 6.52668304e+01
 1.16994507e+01 1.59822945e+01 2.82291798e+01 3.09413116e+01
 3.00700050e-01 1.02592391e+00 1.98738012e+00 4.22888359e+00
 5.25758368e+00 8.77212213e+00 7.11298792e+00 3.38882765e+01
 2.31740760e+01 1.48332879e+02 9.97850617e+01 9.20060329e+02
 2.66127797e-01 5.57631361e-01 2.44135592e+00 8.90273129e+00
 8.33867704e-01 2.32464069e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640145561614
cond(S) = 1290.371094052817
E1 = -183.5904223412177  E_coul = 55.080166432339446
init E= -128.510255908878
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403639222502  LUMO = 0.791956261543668
  mo_energy =
[-3.25552177e+01 -1.85274263e+00 -7.75403639e-01 -7.75403639e-01
 -7.75403639e-01  7.91956262e-01  8.24152792e-01  8.24152792e-01
  8.24152792e-01  3.95644993e+00  3.95644993e+00  3.95644993e+00
  4.43105447e+00  1.43570029e+01  1.43570029e+01  1.43570029e+01
  1.64372931e+01  5.27586371e+01  5.30071974e+01  5.30071974e+01
  5.30071974e+01  1.62714358e+02  2.40839573e+02  2.40839573e+02
  2.40839573e+02  5.27390312e+02  1.89253684e+03  8.01941870e+03
  4.77837761e+04]
E1 = -182.08605238094307  E_coul = 53.547636152024474
cycle= 1 E= -128.538416228919  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519468
diis-c [-0.26984658  1.        ]
  HOMO = -0.884327594844344  LUMO = 0.762908356008806
  mo_energy =
[-3.28784219e+01 -1.96664184e+00 -8.84327595e-01 -8.84327595e-01
 -8.84327595e-01  7.62908356e-01  7.97367700e-01  7.97367700e-01
  7.97367700e-01  3.85897966e+00  3.85897966e+00  3.85897966e+00
  4.34388871e+00  1.41662379e+01  1.41662379e+01  1.41662379e+01
  1.62629291e+01  5.25013771e+01  5.27262212e+01  5.27262212e+01
  5.27262212e+01  1.62397013e+02  2.40493220e+02  2.40493220e+02
  2.40493220e+02  5.27029482e+02  1.89213945e+03  8.01899203e+03
  4.77833305e+04]
E1 = -182.84756535123316  E_coul = 54.30656128652262
cycle= 2 E= -128.541004064711  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264256
diis-c [-0.00073394  0.33630419  0.66369581]
  HOMO = -0.848707293245903  LUMO = 0.772195687269111
  mo_energy =
[-3.27703439e+01 -1.92913462e+00 -8.48707293e-01 -8.48707293e-01
 -8.48707293e-01  7.72195687e-01  8.06097901e-01  8.06097901e-01
  8.06097901e-01  3.89059064e+00  3.89059064e+00  3.89059064e+00
  4.37214414e+00  1.42294136e+01  1.42294136e+01  1.42294136e+01
  1.63205457e+01  5.25875678e+01  5.28202240e+01  5.28202240e+01
  5.28202240e+01  1.62502808e+02  2.40606870e+02  2.40606870e+02
  2.40606870e+02  5.27146046e+02  1.89226144e+03  8.01911651e+03
  4.77834559e+04]
E1 = -182.5889523620134  E_coul = 54.04702805765703
cycle= 3 E= -128.541924304356  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00108666
diis-c [-1.92931366e-07 -2.38847319e-03 -9.35409883e-04  1.00332388e+00]
  HOMO = -0.8489578722202  LUMO = 0.772144639877532
  mo_energy =
[-3.27707779e+01 -1.92932003e+00 -8.48957872e-01 -8.48957872e-01
 -8.48957872e-01  7.72144640e-01  8.06059683e-01  8.06059683e-01
  8.06059683e-01  3.89041866e+00  3.89041866e+00  3.89041866e+00
  4.37199779e+00  1.42291210e+01  1.42291210e+01  1.42291210e+01
  1.63202795e+01  5.25872155e+01  5.28198402e+01  5.28198402e+01
  5.28198402e+01  1.62502370e+02  2.40606366e+02  2.40606366e+02
  2.40606366e+02  5.27145487e+02  1.89226074e+03  8.01911572e+03
  4.77834550e+04]
E1 = -182.58933836704162  E_coul = 54.04741403763207
cycle= 4 E= -128.54192432941  delta_E= -2.51e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187695
diis-c [-1.12699143e-09  2.32281579e-04  5.36369263e-04 -1.84583317e-01
  1.18381467e+00]
  HOMO = -0.849001280740487  LUMO = 0.772131511392104
  mo_energy =
[-3.27708516e+01 -1.92935281e+00 -8.49001281e-01 -8.49001281e-01
 -8.49001281e-01  7.72131511e-01  8.06046212e-01  8.06046212e-01
  8.06046212e-01  3.89037819e+00  3.89037819e+00  3.89037819e+00
  4.37196444e+00  1.42290612e+01  1.42290612e+01  1.42290612e+01
  1.63202238e+01  5.25871483e+01  5.28197706e+01  5.28197706e+01
  5.28197706e+01  1.62502296e+02  2.40606288e+02  2.40606288e+02
  2.40606288e+02  5.27145405e+02  1.89226065e+03  8.01911563e+03
  4.77834549e+04]
E1 = -182.5894727485137  E_coul = 54.04754841838094
cycle= 5 E= -128.541924330133  delta_E= -7.23e-10  |g|= 5.96e-06  |ddm|= 5.63e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.5894727485137  E_coul = 54.04754841838094
  HOMO = -0.848998160590448  LUMO = 0.772132842377713
  mo_energy =
[-3.27708446e+01 -1.92934889e+00 -8.48998161e-01 -8.48998161e-01
 -8.48998161e-01  7.72132842e-01  8.06047131e-01  8.06047131e-01
  8.06047131e-01  3.89038118e+00  3.89038118e+00  3.89038118e+00
  4.37196748e+00  1.42290663e+01  1.42290663e+01  1.42290663e+01
  1.63202288e+01  5.25871546e+01  5.28197772e+01  5.28197772e+01
  5.28197772e+01  1.62502302e+02  2.40606295e+02  2.40606295e+02
  2.40606295e+02  5.27145411e+02  1.89226066e+03  8.01911563e+03
  4.77834549e+04]
E1 = -182.58945682945347  E_coul = 54.04753249931796
Extra cycle  E= -128.541924330136  delta_E= -2.76e-12  |g|= 2.24e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.15 sec
exp = [7.83644635e-01 2.44137942e+04 3.66145093e+03 8.33332310e+02
 2.35311431e+02 7.63665780e+01 1.16994507e+01 2.82291798e+01
 3.00700050e-01 1.98738012e+00 5.25758368e+00 7.11298792e+00
 2.31740760e+01 9.97850617e+01 2.66127797e-01 2.44135592e+00
 8.33867704e-01]
E = -128.54192433013552
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:55:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783644635227       1
[INPUT] 0    0    [1    /1   ]  24413.7941984        1
[INPUT] 0    0    [1    /1   ]  3661.45092822        1
[INPUT] 0    0    [1    /1   ]  833.332309784        1
[INPUT] 0    0    [1    /1   ]  235.311430854        1
[INPUT] 0    0    [1    /1   ]  76.3665780321        1
[INPUT] 0    0    [1    /1   ]  11.699450744         1
[INPUT] 0    0    [1    /1   ]  28.2291798094        1
[INPUT] 0    0    [1    /1   ]  0.300700050397       1
[INPUT] 0    0    [1    /1   ]  1.98738012115        1
[INPUT] 0    0    [1    /1   ]  5.2575836824         1
[INPUT] 1    0    [1    /1   ]  7.11298792287        1
[INPUT] 1    0    [1    /1   ]  23.1740760405        1
[INPUT] 1    0    [1    /1   ]  99.7850617094        1
[INPUT] 1    0    [1    /1   ]  0.266127796597       1
[INPUT] 1    0    [1    /1   ]  2.44135591729        1
[INPUT] 1    0    [1    /1   ]  0.833867704482       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.783644635227354, 1.0]], [0, [24413.794198449552, 1.0]], [0, [3661.450928217425, 1.0]], [0, [833.3323097844371, 1.0]], [0, [235.31143085398787, 1.0]], [0, [76.36657803206691, 1.0]], [0, [11.699450743973133, 1.0]], [0, [28.229179809384952, 1.0]], [0, [0.300700050396713, 1.0]], [0, [1.9873801211542963, 1.0]], [0, [5.2575836824003686, 1.0]], [1, [7.1129879228680934, 1.0]], [1, [23.17407604048619, 1.0]], [1, [99.78506170938311, 1.0]], [1, [0.2661277965967931, 1.0]], [1, [2.441355917285483, 1.0]], [1, [0.8338677044820757, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78364464]
bas 1, expnt(s) = [24413.79419845]
bas 2, expnt(s) = [3661.45092822]
bas 3, expnt(s) = [833.33230978]
bas 4, expnt(s) = [235.31143085]
bas 5, expnt(s) = [76.36657803]
bas 6, expnt(s) = [11.69945074]
bas 7, expnt(s) = [28.22917981]
bas 8, expnt(s) = [0.30070005]
bas 9, expnt(s) = [1.98738012]
bas 10, expnt(s) = [5.25758368]
bas 11, expnt(s) = [7.11298792]
bas 12, expnt(s) = [23.17407604]
bas 13, expnt(s) = [99.78506171]
bas 14, expnt(s) = [0.2661278]
bas 15, expnt(s) = [2.44135592]
bas 16, expnt(s) = [0.8338677]
CPU time:       304.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83644635e-01 2.10428422e+00 2.44137942e+04 4.93448103e+03
 3.66145093e+03 1.18920010e+03 8.33332310e+02 3.91857975e+02
 2.35311431e+02 1.51791444e+02 7.63665780e+01 6.52668304e+01
 1.16994507e+01 1.59822945e+01 2.82291798e+01 3.09413116e+01
 3.00700050e-01 1.02592391e+00 1.98738012e+00 4.22888359e+00
 5.25758368e+00 8.77212213e+00 7.11298792e+00 3.38882765e+01
 2.31740760e+01 1.48332879e+02 9.97850617e+01 9.20060329e+02
 2.66127797e-01 5.57631361e-01 2.44135592e+00 8.90273129e+00
 8.33867704e-01 2.32464069e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640145561614
cond(S) = 1290.371094052817
E1 = -183.5904223412177  E_coul = 55.080166432339446
init E= -128.510255908878
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403639222502  LUMO = 0.791956261543668
  mo_energy =
[-3.25552177e+01 -1.85274263e+00 -7.75403639e-01 -7.75403639e-01
 -7.75403639e-01  7.91956262e-01  8.24152792e-01  8.24152792e-01
  8.24152792e-01  3.95644993e+00  3.95644993e+00  3.95644993e+00
  4.43105447e+00  1.43570029e+01  1.43570029e+01  1.43570029e+01
  1.64372931e+01  5.27586371e+01  5.30071974e+01  5.30071974e+01
  5.30071974e+01  1.62714358e+02  2.40839573e+02  2.40839573e+02
  2.40839573e+02  5.27390312e+02  1.89253684e+03  8.01941870e+03
  4.77837761e+04]
E1 = -182.08605238094307  E_coul = 53.547636152024474
cycle= 1 E= -128.538416228919  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519468
diis-c [-0.26984658  1.        ]
  HOMO = -0.884327594844344  LUMO = 0.762908356008806
  mo_energy =
[-3.28784219e+01 -1.96664184e+00 -8.84327595e-01 -8.84327595e-01
 -8.84327595e-01  7.62908356e-01  7.97367700e-01  7.97367700e-01
  7.97367700e-01  3.85897966e+00  3.85897966e+00  3.85897966e+00
  4.34388871e+00  1.41662379e+01  1.41662379e+01  1.41662379e+01
  1.62629291e+01  5.25013771e+01  5.27262212e+01  5.27262212e+01
  5.27262212e+01  1.62397013e+02  2.40493220e+02  2.40493220e+02
  2.40493220e+02  5.27029482e+02  1.89213945e+03  8.01899203e+03
  4.77833305e+04]
E1 = -182.84756535123316  E_coul = 54.30656128652262
cycle= 2 E= -128.541004064711  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264256
diis-c [-0.00073394  0.33630419  0.66369581]
  HOMO = -0.848707293245903  LUMO = 0.772195687269111
  mo_energy =
[-3.27703439e+01 -1.92913462e+00 -8.48707293e-01 -8.48707293e-01
 -8.48707293e-01  7.72195687e-01  8.06097901e-01  8.06097901e-01
  8.06097901e-01  3.89059064e+00  3.89059064e+00  3.89059064e+00
  4.37214414e+00  1.42294136e+01  1.42294136e+01  1.42294136e+01
  1.63205457e+01  5.25875678e+01  5.28202240e+01  5.28202240e+01
  5.28202240e+01  1.62502808e+02  2.40606870e+02  2.40606870e+02
  2.40606870e+02  5.27146046e+02  1.89226144e+03  8.01911651e+03
  4.77834559e+04]
E1 = -182.5889523620134  E_coul = 54.04702805765703
cycle= 3 E= -128.541924304356  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108666
diis-c [-1.92931366e-07 -2.38847319e-03 -9.35409883e-04  1.00332388e+00]
  HOMO = -0.8489578722202  LUMO = 0.772144639877532
  mo_energy =
[-3.27707779e+01 -1.92932003e+00 -8.48957872e-01 -8.48957872e-01
 -8.48957872e-01  7.72144640e-01  8.06059683e-01  8.06059683e-01
  8.06059683e-01  3.89041866e+00  3.89041866e+00  3.89041866e+00
  4.37199779e+00  1.42291210e+01  1.42291210e+01  1.42291210e+01
  1.63202795e+01  5.25872155e+01  5.28198402e+01  5.28198402e+01
  5.28198402e+01  1.62502370e+02  2.40606366e+02  2.40606366e+02
  2.40606366e+02  5.27145487e+02  1.89226074e+03  8.01911572e+03
  4.77834550e+04]
E1 = -182.58933836704162  E_coul = 54.04741403763207
cycle= 4 E= -128.54192432941  delta_E= -2.51e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187695
diis-c [-1.12699143e-09  2.32281579e-04  5.36369263e-04 -1.84583317e-01
  1.18381467e+00]
  HOMO = -0.849001280740487  LUMO = 0.772131511392104
  mo_energy =
[-3.27708516e+01 -1.92935281e+00 -8.49001281e-01 -8.49001281e-01
 -8.49001281e-01  7.72131511e-01  8.06046212e-01  8.06046212e-01
  8.06046212e-01  3.89037819e+00  3.89037819e+00  3.89037819e+00
  4.37196444e+00  1.42290612e+01  1.42290612e+01  1.42290612e+01
  1.63202238e+01  5.25871483e+01  5.28197706e+01  5.28197706e+01
  5.28197706e+01  1.62502296e+02  2.40606288e+02  2.40606288e+02
  2.40606288e+02  5.27145405e+02  1.89226065e+03  8.01911563e+03
  4.77834549e+04]
E1 = -182.5894727485137  E_coul = 54.04754841838094
cycle= 5 E= -128.541924330133  delta_E= -7.23e-10  |g|= 5.96e-06  |ddm|= 5.63e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5894727485137  E_coul = 54.04754841838094
  HOMO = -0.848998160590448  LUMO = 0.772132842377713
  mo_energy =
[-3.27708446e+01 -1.92934889e+00 -8.48998161e-01 -8.48998161e-01
 -8.48998161e-01  7.72132842e-01  8.06047131e-01  8.06047131e-01
  8.06047131e-01  3.89038118e+00  3.89038118e+00  3.89038118e+00
  4.37196748e+00  1.42290663e+01  1.42290663e+01  1.42290663e+01
  1.63202288e+01  5.25871546e+01  5.28197772e+01  5.28197772e+01
  5.28197772e+01  1.62502302e+02  2.40606295e+02  2.40606295e+02
  2.40606295e+02  5.27145411e+02  1.89226066e+03  8.01911563e+03
  4.77834549e+04]
E1 = -182.58945682945347  E_coul = 54.04753249931796
Extra cycle  E= -128.541924330136  delta_E= -2.76e-12  |g|= 2.24e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1290.371094052817
E1 = -182.58945682945347  E_coul = 54.04753249931796
init E= -128.541924330136
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.848999287119092  LUMO = 0.772132631966076
  mo_energy =
[-3.27708481e+01 -1.92934993e+00 -8.48999287e-01 -8.48999287e-01
 -8.48999287e-01  7.72132632e-01  8.06046873e-01  8.06046873e-01
  8.06046873e-01  3.89038020e+00  3.89038020e+00  3.89038020e+00
  4.37196668e+00  1.42290643e+01  1.42290643e+01  1.42290643e+01
  1.63202270e+01  5.25871518e+01  5.28197742e+01  5.28197742e+01
  5.28197742e+01  1.62502299e+02  2.40606291e+02  2.40606291e+02
  2.40606291e+02  5.27145408e+02  1.89226065e+03  8.01911563e+03
  4.77834549e+04]
E1 = -182.58946567549648  E_coul = 54.04754134536056
cycle= 1 E= -128.541924330136  delta_E= -4.26e-13  |g|= 1.21e-06  |ddm|= 8.04e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58946567549648  E_coul = 54.04754134536056
  HOMO = -0.848998664450691  LUMO = 0.772132811052922
  mo_energy =
[-3.27708463e+01 -1.92934924e+00 -8.48998664e-01 -8.48998664e-01
 -8.48998664e-01  7.72132811e-01  8.06047029e-01  8.06047029e-01
  8.06047029e-01  3.89038076e+00  3.89038076e+00  3.89038076e+00
  4.37196719e+00  1.42290654e+01  1.42290654e+01  1.42290654e+01
  1.63202281e+01  5.25871533e+01  5.28197758e+01  5.28197758e+01
  5.28197758e+01  1.62502301e+02  2.40606293e+02  2.40606293e+02
  2.40606293e+02  5.27145410e+02  1.89226066e+03  8.01911563e+03
  4.77834549e+04]
E1 = -182.58946122983113  E_coul = 54.047536899695324
Extra cycle  E= -128.541924330136  delta_E= 1.42e-13  |g|= 6.04e-07  |ddm|= 3.98e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [7.83644635e-01 2.44137942e+04 3.66145093e+03 8.33332310e+02
 2.35311431e+02 7.63665780e+01 1.16994507e+01 2.82291798e+01
 3.00700050e-01 1.98738012e+00 5.25758368e+00 7.11298792e+00
 2.31740760e+01 9.97850617e+01 2.66127797e-01 2.44135592e+00
 8.33867704e-01]
grad_E = [-4.25187583e-06 -9.74899440e-10  5.26117634e-08 -1.12261344e-06
  1.31106243e-05 -5.41135179e-05 -1.42052791e-05 -3.00192533e-05
 -3.37343323e-05 -2.05848917e-07  3.33851185e-05 -1.88866583e-05
  3.67206039e-06 -1.67238646e-07  2.51372066e-04  3.89424555e-05
 -9.42225472e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.781895920768       1
[INPUT] 0    0    [1    /1   ]  24413.7941984        1
[INPUT] 0    0    [1    /1   ]  3661.45092996        1
[INPUT] 0    0    [1    /1   ]  833.33227934         1
[INPUT] 0    0    [1    /1   ]  235.311649151        1
[INPUT] 0    0    [1    /1   ]  76.3667072398        1
[INPUT] 0    0    [1    /1   ]  11.6883112528        1
[INPUT] 0    0    [1    /1   ]  28.2291401594        1
[INPUT] 0    0    [1    /1   ]  0.30000039801        1
[INPUT] 0    0    [1    /1   ]  1.98377608569        1
[INPUT] 0    0    [1    /1   ]  5.24415093345        1
[INPUT] 1    0    [1    /1   ]  7.11091388709        1
[INPUT] 1    0    [1    /1   ]  23.1747644427        1
[INPUT] 1    0    [1    /1   ]  99.7850320987        1
[INPUT] 1    0    [1    /1   ]  0.266176219059       1
[INPUT] 1    0    [1    /1   ]  2.44079361957        1
[INPUT] 1    0    [1    /1   ]  0.833824806073       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7818959207678126, 1.0]], [0, [24413.794198416323, 1.0]], [0, [3661.45092996155, 1.0]], [0, [833.332279339634, 1.0]], [0, [235.31164915119467, 1.0]], [0, [76.36670723975394, 1.0]], [0, [11.688311252768392, 1.0]], [0, [28.22914015937795, 1.0]], [0, [0.30000039801012285, 1.0]], [0, [1.9837760856907294, 1.0]], [0, [5.244150933451342, 1.0]], [1, [7.110913887088755, 1.0]], [1, [23.174764442668152, 1.0]], [1, [99.78503209868049, 1.0]], [1, [0.2661762190587936, 1.0]], [1, [2.440793619572741, 1.0]], [1, [0.8338248060728077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78189592]
bas 1, expnt(s) = [24413.79419842]
bas 2, expnt(s) = [3661.45092996]
bas 3, expnt(s) = [833.33227934]
bas 4, expnt(s) = [235.31164915]
bas 5, expnt(s) = [76.36670724]
bas 6, expnt(s) = [11.68831125]
bas 7, expnt(s) = [28.22914016]
bas 8, expnt(s) = [0.3000004]
bas 9, expnt(s) = [1.98377609]
bas 10, expnt(s) = [5.24415093]
bas 11, expnt(s) = [7.11091389]
bas 12, expnt(s) = [23.17476444]
bas 13, expnt(s) = [99.7850321]
bas 14, expnt(s) = [0.26617622]
bas 15, expnt(s) = [2.44079362]
bas 16, expnt(s) = [0.83382481]
CPU time:       308.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.81895921e-01 2.10076143e+00 2.44137942e+04 4.93448103e+03
 3.66145093e+03 1.18920010e+03 8.33332279e+02 3.91857964e+02
 2.35311649e+02 1.51791550e+02 7.63667072e+01 6.52669132e+01
 1.16883113e+01 1.59708801e+01 2.82291402e+01 3.09412790e+01
 3.00000398e-01 1.02413309e+00 1.98377609e+00 4.22313060e+00
 5.24415093e+00 8.75530765e+00 7.11091389e+00 3.38759253e+01
 2.31747644e+01 1.48338387e+02 9.97850321e+01 9.20059988e+02
 2.66176219e-01 5.57758191e-01 2.44079362e+00 8.90016825e+00
 8.33824806e-01 2.32449120e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640079146545
cond(S) = 1283.554310899657
E1 = -183.590430494999  E_coul = 55.08016727821739
init E= -128.510263216782
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403515202356  LUMO = 0.789448601037404
  mo_energy =
[-3.25552177e+01 -1.85274258e+00 -7.75403515e-01 -7.75403515e-01
 -7.75403515e-01  7.89448601e-01  8.24264718e-01  8.24264718e-01
  8.24264718e-01  3.95623576e+00  3.95623576e+00  3.95623576e+00
  4.41885673e+00  1.43537683e+01  1.43537683e+01  1.43537683e+01
  1.63966100e+01  5.26720220e+01  5.30000308e+01  5.30000308e+01
  5.30000308e+01  1.62600116e+02  2.40833938e+02  2.40833938e+02
  2.40833938e+02  5.27275275e+02  1.89243147e+03  8.01932561e+03
  4.77836989e+04]
E1 = -182.0861202846733  E_coul = 53.54770362500658
cycle= 1 E= -128.538416659667  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519476
diis-c [-0.26985505  1.        ]
  HOMO = -0.884321961293896  LUMO = 0.760494543779129
  mo_energy =
[-3.28784121e+01 -1.96663482e+00 -8.84321961e-01 -8.84321961e-01
 -8.84321961e-01  7.60494544e-01  7.97479922e-01  7.97479922e-01
  7.97479922e-01  3.85878558e+00  3.85878558e+00  3.85878558e+00
  4.33185828e+00  1.41630368e+01  1.41630368e+01  1.41630368e+01
  1.62224223e+01  5.24148265e+01  5.27190660e+01  5.27190660e+01
  5.27190660e+01  1.62282780e+02  2.40487593e+02  2.40487593e+02
  2.40487593e+02  5.26914451e+02  1.89203408e+03  8.01889894e+03
  4.77832533e+04]
E1 = -182.84759639009016  E_coul = 54.30659204506072
cycle= 2 E= -128.541004345029  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264255
diis-c [-0.00073346  0.33630024  0.66369976]
  HOMO = -0.848703226464176  LUMO = 0.769752371105978
  mo_energy =
[-3.27703384e+01 -1.92912931e+00 -8.48703226e-01 -8.48703226e-01
 -8.48703226e-01  7.69752371e-01  8.06210301e-01  8.06210301e-01
  8.06210301e-01  3.89039044e+00  3.89039044e+00  3.89039044e+00
  4.36005886e+00  1.42262011e+01  1.42262011e+01  1.42262011e+01
  1.62799789e+01  5.25009949e+01  5.28130644e+01  5.28130644e+01
  5.28130644e+01  1.62388571e+02  2.40601239e+02  2.40601239e+02
  2.40601239e+02  5.27031012e+02  1.89215607e+03  8.01902343e+03
  4.77833787e+04]
E1 = -182.5890005696776  E_coul = 54.047076085654446
cycle= 3 E= -128.541924484023  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00108667
diis-c [-1.93565637e-07 -2.38854544e-03 -9.36792820e-04  1.00332534e+00]
  HOMO = -0.848953691354374  LUMO = 0.769701590635387
  mo_energy =
[-3.27707723e+01 -1.92931448e+00 -8.48953691e-01 -8.48953691e-01
 -8.48953691e-01  7.69701591e-01  8.06172127e-01  8.06172127e-01
  8.06172127e-01  3.89021863e+00  3.89021863e+00  3.89021863e+00
  4.35991293e+00  1.42259088e+01  1.42259088e+01  1.42259088e+01
  1.62797131e+01  5.25006430e+01  5.28126808e+01  5.28126808e+01
  5.28126808e+01  1.62388133e+02  2.40600735e+02  2.40600735e+02
  2.40600735e+02  5.27030453e+02  1.89215538e+03  8.01902263e+03
  4.77833779e+04]
E1 = -182.5893865400238  E_coul = 54.04746203092164
cycle= 4 E= -128.541924509102  delta_E= -2.51e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187727
diis-c [-1.13018772e-09  2.32953307e-04  5.36575768e-04 -1.84925757e-01
  1.18415623e+00]
  HOMO = -0.848997095477766  LUMO = 0.769688516831485
  mo_energy =
[-3.27708460e+01 -1.92934722e+00 -8.48997095e-01 -8.48997095e-01
 -8.48997095e-01  7.69688517e-01  8.06158657e-01  8.06158657e-01
  8.06158657e-01  3.89017818e+00  3.89017818e+00  3.89017818e+00
  4.35987965e+00  1.42258490e+01  1.42258490e+01  1.42258490e+01
  1.62796575e+01  5.25005757e+01  5.28126112e+01  5.28126112e+01
  5.28126112e+01  1.62388059e+02  2.40600657e+02  2.40600657e+02
  2.40600657e+02  5.27030371e+02  1.89215528e+03  8.01902254e+03
  4.77833778e+04]
E1 = -182.58952088402967  E_coul = 54.04759637420205
cycle= 5 E= -128.541924509828  delta_E= -7.25e-10  |g|= 5.97e-06  |ddm|= 5.64e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58952088402967  E_coul = 54.04759637420205
  HOMO = -0.848993965171883  LUMO = 0.769689848043304
  mo_energy =
[-3.27708389e+01 -1.92934328e+00 -8.48993965e-01 -8.48993965e-01
 -8.48993965e-01  7.69689848e-01  8.06159579e-01  8.06159579e-01
  8.06159579e-01  3.89018118e+00  3.89018118e+00  3.89018118e+00
  4.35988270e+00  1.42258541e+01  1.42258541e+01  1.42258541e+01
  1.62796625e+01  5.25005821e+01  5.28126178e+01  5.28126178e+01
  5.28126178e+01  1.62388066e+02  2.40600664e+02  2.40600664e+02
  2.40600664e+02  5.27030377e+02  1.89215529e+03  8.01902254e+03
  4.77833778e+04]
E1 = -182.58950492193006  E_coul = 54.047580412099876
Extra cycle  E= -128.54192450983  delta_E= -2.56e-12  |g|= 2.25e-06  |ddm|= 2.19e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.81895921e-01 2.44137942e+04 3.66145093e+03 8.33332279e+02
 2.35311649e+02 7.63667072e+01 1.16883113e+01 2.82291402e+01
 3.00000398e-01 1.98377609e+00 5.24415093e+00 7.11091389e+00
 2.31747644e+01 9.97850321e+01 2.66176219e-01 2.44079362e+00
 8.33824806e-01]
E = -128.54192450983018
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.781895920768       1
[INPUT] 0    0    [1    /1   ]  24413.7941984        1
[INPUT] 0    0    [1    /1   ]  3661.45092996        1
[INPUT] 0    0    [1    /1   ]  833.33227934         1
[INPUT] 0    0    [1    /1   ]  235.311649151        1
[INPUT] 0    0    [1    /1   ]  76.3667072398        1
[INPUT] 0    0    [1    /1   ]  11.6883112528        1
[INPUT] 0    0    [1    /1   ]  28.2291401594        1
[INPUT] 0    0    [1    /1   ]  0.30000039801        1
[INPUT] 0    0    [1    /1   ]  1.98377608569        1
[INPUT] 0    0    [1    /1   ]  5.24415093345        1
[INPUT] 1    0    [1    /1   ]  7.11091388709        1
[INPUT] 1    0    [1    /1   ]  23.1747644427        1
[INPUT] 1    0    [1    /1   ]  99.7850320987        1
[INPUT] 1    0    [1    /1   ]  0.266176219059       1
[INPUT] 1    0    [1    /1   ]  2.44079361957        1
[INPUT] 1    0    [1    /1   ]  0.833824806073       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7818959207678126, 1.0]], [0, [24413.794198416323, 1.0]], [0, [3661.45092996155, 1.0]], [0, [833.332279339634, 1.0]], [0, [235.31164915119467, 1.0]], [0, [76.36670723975394, 1.0]], [0, [11.688311252768392, 1.0]], [0, [28.22914015937795, 1.0]], [0, [0.30000039801012285, 1.0]], [0, [1.9837760856907294, 1.0]], [0, [5.244150933451342, 1.0]], [1, [7.110913887088755, 1.0]], [1, [23.174764442668152, 1.0]], [1, [99.78503209868049, 1.0]], [1, [0.2661762190587936, 1.0]], [1, [2.440793619572741, 1.0]], [1, [0.8338248060728077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78189592]
bas 1, expnt(s) = [24413.79419842]
bas 2, expnt(s) = [3661.45092996]
bas 3, expnt(s) = [833.33227934]
bas 4, expnt(s) = [235.31164915]
bas 5, expnt(s) = [76.36670724]
bas 6, expnt(s) = [11.68831125]
bas 7, expnt(s) = [28.22914016]
bas 8, expnt(s) = [0.3000004]
bas 9, expnt(s) = [1.98377609]
bas 10, expnt(s) = [5.24415093]
bas 11, expnt(s) = [7.11091389]
bas 12, expnt(s) = [23.17476444]
bas 13, expnt(s) = [99.7850321]
bas 14, expnt(s) = [0.26617622]
bas 15, expnt(s) = [2.44079362]
bas 16, expnt(s) = [0.83382481]
CPU time:       309.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.81895921e-01 2.10076143e+00 2.44137942e+04 4.93448103e+03
 3.66145093e+03 1.18920010e+03 8.33332279e+02 3.91857964e+02
 2.35311649e+02 1.51791550e+02 7.63667072e+01 6.52669132e+01
 1.16883113e+01 1.59708801e+01 2.82291402e+01 3.09412790e+01
 3.00000398e-01 1.02413309e+00 1.98377609e+00 4.22313060e+00
 5.24415093e+00 8.75530765e+00 7.11091389e+00 3.38759253e+01
 2.31747644e+01 1.48338387e+02 9.97850321e+01 9.20059988e+02
 2.66176219e-01 5.57758191e-01 2.44079362e+00 8.90016825e+00
 8.33824806e-01 2.32449120e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640079146545
cond(S) = 1283.554310899657
E1 = -183.590430494999  E_coul = 55.08016727821739
init E= -128.510263216782
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403515202356  LUMO = 0.789448601037404
  mo_energy =
[-3.25552177e+01 -1.85274258e+00 -7.75403515e-01 -7.75403515e-01
 -7.75403515e-01  7.89448601e-01  8.24264718e-01  8.24264718e-01
  8.24264718e-01  3.95623576e+00  3.95623576e+00  3.95623576e+00
  4.41885673e+00  1.43537683e+01  1.43537683e+01  1.43537683e+01
  1.63966100e+01  5.26720220e+01  5.30000308e+01  5.30000308e+01
  5.30000308e+01  1.62600116e+02  2.40833938e+02  2.40833938e+02
  2.40833938e+02  5.27275275e+02  1.89243147e+03  8.01932561e+03
  4.77836989e+04]
E1 = -182.0861202846733  E_coul = 53.54770362500658
cycle= 1 E= -128.538416659667  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519476
diis-c [-0.26985505  1.        ]
  HOMO = -0.884321961293896  LUMO = 0.760494543779129
  mo_energy =
[-3.28784121e+01 -1.96663482e+00 -8.84321961e-01 -8.84321961e-01
 -8.84321961e-01  7.60494544e-01  7.97479922e-01  7.97479922e-01
  7.97479922e-01  3.85878558e+00  3.85878558e+00  3.85878558e+00
  4.33185828e+00  1.41630368e+01  1.41630368e+01  1.41630368e+01
  1.62224223e+01  5.24148265e+01  5.27190660e+01  5.27190660e+01
  5.27190660e+01  1.62282780e+02  2.40487593e+02  2.40487593e+02
  2.40487593e+02  5.26914451e+02  1.89203408e+03  8.01889894e+03
  4.77832533e+04]
E1 = -182.84759639009016  E_coul = 54.30659204506072
cycle= 2 E= -128.541004345029  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264255
diis-c [-0.00073346  0.33630024  0.66369976]
  HOMO = -0.848703226464176  LUMO = 0.769752371105978
  mo_energy =
[-3.27703384e+01 -1.92912931e+00 -8.48703226e-01 -8.48703226e-01
 -8.48703226e-01  7.69752371e-01  8.06210301e-01  8.06210301e-01
  8.06210301e-01  3.89039044e+00  3.89039044e+00  3.89039044e+00
  4.36005886e+00  1.42262011e+01  1.42262011e+01  1.42262011e+01
  1.62799789e+01  5.25009949e+01  5.28130644e+01  5.28130644e+01
  5.28130644e+01  1.62388571e+02  2.40601239e+02  2.40601239e+02
  2.40601239e+02  5.27031012e+02  1.89215607e+03  8.01902343e+03
  4.77833787e+04]
E1 = -182.5890005696776  E_coul = 54.047076085654446
cycle= 3 E= -128.541924484023  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00108667
diis-c [-1.93565637e-07 -2.38854544e-03 -9.36792820e-04  1.00332534e+00]
  HOMO = -0.848953691354374  LUMO = 0.769701590635387
  mo_energy =
[-3.27707723e+01 -1.92931448e+00 -8.48953691e-01 -8.48953691e-01
 -8.48953691e-01  7.69701591e-01  8.06172127e-01  8.06172127e-01
  8.06172127e-01  3.89021863e+00  3.89021863e+00  3.89021863e+00
  4.35991293e+00  1.42259088e+01  1.42259088e+01  1.42259088e+01
  1.62797131e+01  5.25006430e+01  5.28126808e+01  5.28126808e+01
  5.28126808e+01  1.62388133e+02  2.40600735e+02  2.40600735e+02
  2.40600735e+02  5.27030453e+02  1.89215538e+03  8.01902263e+03
  4.77833779e+04]
E1 = -182.5893865400238  E_coul = 54.04746203092164
cycle= 4 E= -128.541924509102  delta_E= -2.51e-08  |g|= 8.07e-05  |ddm|= 0.000337
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187727
diis-c [-1.13018772e-09  2.32953307e-04  5.36575768e-04 -1.84925757e-01
  1.18415623e+00]
  HOMO = -0.848997095477766  LUMO = 0.769688516831485
  mo_energy =
[-3.27708460e+01 -1.92934722e+00 -8.48997095e-01 -8.48997095e-01
 -8.48997095e-01  7.69688517e-01  8.06158657e-01  8.06158657e-01
  8.06158657e-01  3.89017818e+00  3.89017818e+00  3.89017818e+00
  4.35987965e+00  1.42258490e+01  1.42258490e+01  1.42258490e+01
  1.62796575e+01  5.25005757e+01  5.28126112e+01  5.28126112e+01
  5.28126112e+01  1.62388059e+02  2.40600657e+02  2.40600657e+02
  2.40600657e+02  5.27030371e+02  1.89215528e+03  8.01902254e+03
  4.77833778e+04]
E1 = -182.58952088402967  E_coul = 54.04759637420205
cycle= 5 E= -128.541924509828  delta_E= -7.25e-10  |g|= 5.97e-06  |ddm|= 5.64e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58952088402967  E_coul = 54.04759637420205
  HOMO = -0.848993965171883  LUMO = 0.769689848043304
  mo_energy =
[-3.27708389e+01 -1.92934328e+00 -8.48993965e-01 -8.48993965e-01
 -8.48993965e-01  7.69689848e-01  8.06159579e-01  8.06159579e-01
  8.06159579e-01  3.89018118e+00  3.89018118e+00  3.89018118e+00
  4.35988270e+00  1.42258541e+01  1.42258541e+01  1.42258541e+01
  1.62796625e+01  5.25005821e+01  5.28126178e+01  5.28126178e+01
  5.28126178e+01  1.62388066e+02  2.40600664e+02  2.40600664e+02
  2.40600664e+02  5.27030377e+02  1.89215529e+03  8.01902254e+03
  4.77833778e+04]
E1 = -182.58950492193006  E_coul = 54.047580412099876
Extra cycle  E= -128.54192450983  delta_E= -2.56e-12  |g|= 2.25e-06  |ddm|= 2.19e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1283.554310899657
E1 = -182.58950492193006  E_coul = 54.047580412099876
init E= -128.54192450983
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.848995094616218  LUMO = 0.769689637777338
  mo_energy =
[-3.27708424e+01 -1.92934432e+00 -8.48995095e-01 -8.48995095e-01
 -8.48995095e-01  7.69689638e-01  8.06159320e-01  8.06159320e-01
  8.06159320e-01  3.89018020e+00  3.89018020e+00  3.89018020e+00
  4.35988190e+00  1.42258521e+01  1.42258521e+01  1.42258521e+01
  1.62796607e+01  5.25005793e+01  5.28126148e+01  5.28126148e+01
  5.28126148e+01  1.62388062e+02  2.40600660e+02  2.40600660e+02
  2.40600660e+02  5.27030374e+02  1.89215529e+03  8.01902254e+03
  4.77833778e+04]
E1 = -182.58951379244712  E_coul = 54.047589282616734
cycle= 1 E= -128.54192450983  delta_E= -1.99e-13  |g|= 1.22e-06  |ddm|= 8.06e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
E1 = -182.58951379244712  E_coul = 54.047589282616734
  HOMO = -0.848994470204289  LUMO = 0.769689816793748
  mo_energy =
[-3.27708406e+01 -1.92934364e+00 -8.48994470e-01 -8.48994470e-01
 -8.48994470e-01  7.69689817e-01  8.06159477e-01  8.06159477e-01
  8.06159477e-01  3.89018076e+00  3.89018076e+00  3.89018076e+00
  4.35988241e+00  1.42258532e+01  1.42258532e+01  1.42258532e+01
  1.62796617e+01  5.25005808e+01  5.28126164e+01  5.28126164e+01
  5.28126164e+01  1.62388064e+02  2.40600662e+02  2.40600662e+02
  2.40600662e+02  5.27030376e+02  1.89215529e+03  8.01902254e+03
  4.77833778e+04]
E1 = -182.58950933462395  E_coul = 54.04758482479375
Extra cycle  E= -128.54192450983  delta_E= 1.71e-13  |g|= 6.05e-07  |ddm|= 3.99e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [7.81895921e-01 2.44137942e+04 3.66145093e+03 8.33332279e+02
 2.35311649e+02 7.63667072e+01 1.16883113e+01 2.82291402e+01
 3.00000398e-01 1.98377609e+00 5.24415093e+00 7.11091389e+00
 2.31747644e+01 9.97850321e+01 2.66176219e-01 2.44079362e+00
 8.33824806e-01]
grad_E = [ 2.11435974e-06 -9.98086115e-10  5.38314929e-08 -1.14669946e-06
  1.33894709e-05 -5.59295112e-05 -2.05925078e-05 -2.45466593e-05
 -6.84577543e-05 -4.52743751e-07  3.54739660e-05 -3.69127389e-05
  7.38891277e-06 -3.39542399e-07  4.19029528e-04  6.71731892e-05
 -1.51972927e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.779228513625       1
[INPUT] 0    0    [1    /1   ]  24413.7941984        1
[INPUT] 0    0    [1    /1   ]  3661.45092825        1
[INPUT] 0    0    [1    /1   ]  833.332321834        1
[INPUT] 0    0    [1    /1   ]  235.310975162        1
[INPUT] 0    0    [1    /1   ]  76.3718070065        1
[INPUT] 0    0    [1    /1   ]  11.6655220228        1
[INPUT] 0    0    [1    /1   ]  28.2265727055        1
[INPUT] 0    0    [1    /1   ]  0.298963965974       1
[INPUT] 0    0    [1    /1   ]  1.97798266493        1
[INPUT] 0    0    [1    /1   ]  5.2182980728         1
[INPUT] 1    0    [1    /1   ]  7.10814719224        1
[INPUT] 1    0    [1    /1   ]  23.175666901         1
[INPUT] 1    0    [1    /1   ]  99.7849958311        1
[INPUT] 1    0    [1    /1   ]  0.266236464452       1
[INPUT] 1    0    [1    /1   ]  2.44006382393        1
[INPUT] 1    0    [1    /1   ]  0.833778597244       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7792285136248203, 1.0]], [0, [24413.79419844806, 1.0]], [0, [3661.4509282535514, 1.0]], [0, [833.3323218343687, 1.0]], [0, [235.31097516195132, 1.0]], [0, [76.3718070064573, 1.0]], [0, [11.66552202277354, 1.0]], [0, [28.22657270552181, 1.0]], [0, [0.2989639659735813, 1.0]], [0, [1.9779826649327565, 1.0]], [0, [5.218298072797043, 1.0]], [1, [7.108147192239939, 1.0]], [1, [23.17566690101145, 1.0]], [1, [99.78499583111152, 1.0]], [1, [0.2662364644517777, 1.0]], [1, [2.440063823934815, 1.0]], [1, [0.8337785972443411, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77922851]
bas 1, expnt(s) = [24413.79419845]
bas 2, expnt(s) = [3661.45092825]
bas 3, expnt(s) = [833.33232183]
bas 4, expnt(s) = [235.31097516]
bas 5, expnt(s) = [76.37180701]
bas 6, expnt(s) = [11.66552202]
bas 7, expnt(s) = [28.22657271]
bas 8, expnt(s) = [0.29896397]
bas 9, expnt(s) = [1.97798266]
bas 10, expnt(s) = [5.21829807]
bas 11, expnt(s) = [7.10814719]
bas 12, expnt(s) = [23.1756669]
bas 13, expnt(s) = [99.78499583]
bas 14, expnt(s) = [0.26623646]
bas 15, expnt(s) = [2.44006382]
bas 16, expnt(s) = [0.8337786]
CPU time:       313.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.79228514e-01 2.09538413e+00 2.44137942e+04 4.93448103e+03
 3.66145093e+03 1.18920010e+03 8.33332322e+02 3.91857979e+02
 2.35310975e+02 1.51791224e+02 7.63718070e+01 6.52701821e+01
 1.16655220e+01 1.59475201e+01 2.82265727e+01 3.09391684e+01
 2.98963966e-01 1.02147833e+00 1.97798266e+00 4.21387729e+00
 5.21829807e+00 8.72291592e+00 7.10814719e+00 3.38594507e+01
 2.31756669e+01 1.48345608e+02 9.97849958e+01 9.20059570e+02
 2.66236464e-01 5.57915997e-01 2.44006382e+00 8.89684195e+00
 8.33778597e-01 2.32433018e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9996399776624
cond(S) = 1272.3863951158924
E1 = -183.59044093152266  E_coul = 55.08016824347522
init E= -128.510272688047
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403363830532  LUMO = 0.785647585158674
  mo_energy =
[-3.25552177e+01 -1.85274259e+00 -7.75403364e-01 -7.75403364e-01
 -7.75403364e-01  7.85647585e-01  8.24405606e-01  8.24405606e-01
  8.24405606e-01  3.95597314e+00  3.95597314e+00  3.95597314e+00
  4.39958187e+00  1.43495320e+01  1.43495320e+01  1.43495320e+01
  1.63257002e+01  5.25106613e+01  5.29905427e+01  5.29905427e+01
  5.29905427e+01  1.62381886e+02  2.40826446e+02  2.40826446e+02
  2.40826446e+02  5.27059059e+02  1.89223605e+03  8.01915330e+03
  4.77835562e+04]
E1 = -182.08620041672708  E_coul = 53.54778303635285
cycle= 1 E= -128.538417380374  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519497
diis-c [-0.26987748  1.        ]
  HOMO = -0.884315344059319  LUMO = 0.75683621774595
  mo_energy =
[-3.28784006e+01 -1.96662654e+00 -8.84315344e-01 -8.84315344e-01
 -8.84315344e-01  7.56836218e-01  7.97620862e-01  7.97620862e-01
  7.97620862e-01  3.85854795e+00  3.85854795e+00  3.85854795e+00
  4.31286248e+00  1.41588435e+01  1.41588435e+01  1.41588435e+01
  1.61518434e+01  5.22535923e+01  5.27095916e+01  5.27095916e+01
  5.27095916e+01  1.62064561e+02  2.40480110e+02  2.40480110e+02
  2.40480110e+02  5.26698240e+02  1.89183867e+03  8.01872665e+03
  4.77831106e+04]
E1 = -182.84763150799992  E_coul = 54.30662662704009
cycle= 2 E= -128.54100488096  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.264258
diis-c [-0.00073258  0.33629517  0.66370483]
  HOMO = -0.84869851094044  LUMO = 0.766048956515078
  mo_energy =
[-3.27703322e+01 -1.92912311e+00 -8.48698511e-01 -8.48698511e-01
 -8.48698511e-01  7.66048957e-01  8.06351518e-01  8.06351518e-01
  8.06351518e-01  3.89014510e+00  3.89014510e+00  3.89014510e+00
  4.34097128e+00  1.42219932e+01  1.42219932e+01  1.42219932e+01
  1.62092872e+01  5.23397172e+01  5.28035848e+01  5.28035848e+01
  5.28035848e+01  1.62170349e+02  2.40593751e+02  2.40593751e+02
  2.40593751e+02  5.26814797e+02  1.89196064e+03  8.01885112e+03
  4.77832360e+04]
E1 = -182.5890559648131  E_coul = 54.04713106592416
cycle= 3 E= -128.541924898889  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108695
diis-c [-1.94513370e-07 -2.38887688e-03 -9.38291806e-04  1.00332717e+00]
  HOMO = -0.848948896890697  LUMO = 0.765998521890862
  mo_energy =
[-3.27707659e+01 -1.92930803e+00 -8.48948897e-01 -8.48948897e-01
 -8.48948897e-01  7.65998522e-01  8.06313375e-01  8.06313375e-01
  8.06313375e-01  3.88997345e+00  3.88997345e+00  3.88997345e+00
  4.34082592e+00  1.42217010e+01  1.42217010e+01  1.42217010e+01
  1.62090219e+01  5.23393655e+01  5.28032013e+01  5.28032013e+01
  5.28032013e+01  1.62169910e+02  2.40593247e+02  2.40593247e+02
  2.40593247e+02  5.26814238e+02  1.89195995e+03  8.01885033e+03
  4.77832351e+04]
E1 = -182.58944206216492  E_coul = 54.047517138147384
cycle= 4 E= -128.541924924018  delta_E= -2.51e-08  |g|= 8.07e-05  |ddm|= 0.000338
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187763
diis-c [-1.13436203e-09  2.33853386e-04  5.36639691e-04 -1.85380294e-01
  1.18460980e+00]
  HOMO = -0.848992301349452  LUMO = 0.76598552282499
  mo_energy =
[-3.27708396e+01 -1.92934072e+00 -8.48992301e-01 -8.48992301e-01
 -8.48992301e-01  7.65985523e-01  8.06299904e-01  8.06299904e-01
  8.06299904e-01  3.88993302e+00  3.88993302e+00  3.88993302e+00
  4.34079275e+00  1.42216412e+01  1.42216412e+01  1.42216412e+01
  1.62089663e+01  5.23392983e+01  5.28031317e+01  5.28031317e+01
  5.28031317e+01  1.62169836e+02  2.40593169e+02  2.40593169e+02
  2.40593169e+02  5.26814156e+02  1.89195986e+03  8.01885023e+03
  4.77832350e+04]
E1 = -182.58957633430103  E_coul = 54.04765140955613
cycle= 5 E= -128.541924924745  delta_E= -7.27e-10  |g|= 5.99e-06  |ddm|= 5.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58957633430103  E_coul = 54.04765140955613
  HOMO = -0.848989157324345  LUMO = 0.765986853572435
  mo_energy =
[-3.27708325e+01 -1.92933676e+00 -8.48989157e-01 -8.48989157e-01
 -8.48989157e-01  7.65986854e-01  8.06300830e-01  8.06300830e-01
  8.06300830e-01  3.88993603e+00  3.88993603e+00  3.88993603e+00
  4.34079580e+00  1.42216464e+01  1.42216464e+01  1.42216464e+01
  1.62089713e+01  5.23393046e+01  5.28031383e+01  5.28031383e+01
  5.28031383e+01  1.62169843e+02  2.40593176e+02  2.40593176e+02
  2.40593176e+02  5.26814163e+02  1.89195987e+03  8.01885024e+03
  4.77832350e+04]
E1 = -182.58956031263367  E_coul = 54.04763538788605
Extra cycle  E= -128.541924924748  delta_E= -2.7e-12  |g|= 2.26e-06  |ddm|= 2.19e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.79228514e-01 2.44137942e+04 3.66145093e+03 8.33332322e+02
 2.35310975e+02 7.63718070e+01 1.16655220e+01 2.82265727e+01
 2.98963966e-01 1.97798266e+00 5.21829807e+00 7.10814719e+00
 2.31756669e+01 9.97849958e+01 2.66236464e-01 2.44006382e+00
 8.33778597e-01]
E = -128.5419249247476
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.779228513625       1
[INPUT] 0    0    [1    /1   ]  24413.7941984        1
[INPUT] 0    0    [1    /1   ]  3661.45092825        1
[INPUT] 0    0    [1    /1   ]  833.332321834        1
[INPUT] 0    0    [1    /1   ]  235.310975162        1
[INPUT] 0    0    [1    /1   ]  76.3718070065        1
[INPUT] 0    0    [1    /1   ]  11.6655220228        1
[INPUT] 0    0    [1    /1   ]  28.2265727055        1
[INPUT] 0    0    [1    /1   ]  0.298963965974       1
[INPUT] 0    0    [1    /1   ]  1.97798266493        1
[INPUT] 0    0    [1    /1   ]  5.2182980728         1
[INPUT] 1    0    [1    /1   ]  7.10814719224        1
[INPUT] 1    0    [1    /1   ]  23.175666901         1
[INPUT] 1    0    [1    /1   ]  99.7849958311        1
[INPUT] 1    0    [1    /1   ]  0.266236464452       1
[INPUT] 1    0    [1    /1   ]  2.44006382393        1
[INPUT] 1    0    [1    /1   ]  0.833778597244       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7792285136248203, 1.0]], [0, [24413.79419844806, 1.0]], [0, [3661.4509282535514, 1.0]], [0, [833.3323218343687, 1.0]], [0, [235.31097516195132, 1.0]], [0, [76.3718070064573, 1.0]], [0, [11.66552202277354, 1.0]], [0, [28.22657270552181, 1.0]], [0, [0.2989639659735813, 1.0]], [0, [1.9779826649327565, 1.0]], [0, [5.218298072797043, 1.0]], [1, [7.108147192239939, 1.0]], [1, [23.17566690101145, 1.0]], [1, [99.78499583111152, 1.0]], [1, [0.2662364644517777, 1.0]], [1, [2.440063823934815, 1.0]], [1, [0.8337785972443411, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77922851]
bas 1, expnt(s) = [24413.79419845]
bas 2, expnt(s) = [3661.45092825]
bas 3, expnt(s) = [833.33232183]
bas 4, expnt(s) = [235.31097516]
bas 5, expnt(s) = [76.37180701]
bas 6, expnt(s) = [11.66552202]
bas 7, expnt(s) = [28.22657271]
bas 8, expnt(s) = [0.29896397]
bas 9, expnt(s) = [1.97798266]
bas 10, expnt(s) = [5.21829807]
bas 11, expnt(s) = [7.10814719]
bas 12, expnt(s) = [23.1756669]
bas 13, expnt(s) = [99.78499583]
bas 14, expnt(s) = [0.26623646]
bas 15, expnt(s) = [2.44006382]
bas 16, expnt(s) = [0.8337786]
CPU time:       314.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.79228514e-01 2.09538413e+00 2.44137942e+04 4.93448103e+03
 3.66145093e+03 1.18920010e+03 8.33332322e+02 3.91857979e+02
 2.35310975e+02 1.51791224e+02 7.63718070e+01 6.52701821e+01
 1.16655220e+01 1.59475201e+01 2.82265727e+01 3.09391684e+01
 2.98963966e-01 1.02147833e+00 1.97798266e+00 4.21387729e+00
 5.21829807e+00 8.72291592e+00 7.10814719e+00 3.38594507e+01
 2.31756669e+01 1.48345608e+02 9.97849958e+01 9.20059570e+02
 2.66236464e-01 5.57915997e-01 2.44006382e+00 8.89684195e+00
 8.33778597e-01 2.32433018e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9996399776624
cond(S) = 1272.3863951158924
E1 = -183.59044093152266  E_coul = 55.08016824347522
init E= -128.510272688047
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403363830532  LUMO = 0.785647585158674
  mo_energy =
[-3.25552177e+01 -1.85274259e+00 -7.75403364e-01 -7.75403364e-01
 -7.75403364e-01  7.85647585e-01  8.24405606e-01  8.24405606e-01
  8.24405606e-01  3.95597314e+00  3.95597314e+00  3.95597314e+00
  4.39958187e+00  1.43495320e+01  1.43495320e+01  1.43495320e+01
  1.63257002e+01  5.25106613e+01  5.29905427e+01  5.29905427e+01
  5.29905427e+01  1.62381886e+02  2.40826446e+02  2.40826446e+02
  2.40826446e+02  5.27059059e+02  1.89223605e+03  8.01915330e+03
  4.77835562e+04]
E1 = -182.08620041672708  E_coul = 53.54778303635285
cycle= 1 E= -128.538417380374  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519497
diis-c [-0.26987748  1.        ]
  HOMO = -0.884315344059319  LUMO = 0.75683621774595
  mo_energy =
[-3.28784006e+01 -1.96662654e+00 -8.84315344e-01 -8.84315344e-01
 -8.84315344e-01  7.56836218e-01  7.97620862e-01  7.97620862e-01
  7.97620862e-01  3.85854795e+00  3.85854795e+00  3.85854795e+00
  4.31286248e+00  1.41588435e+01  1.41588435e+01  1.41588435e+01
  1.61518434e+01  5.22535923e+01  5.27095916e+01  5.27095916e+01
  5.27095916e+01  1.62064561e+02  2.40480110e+02  2.40480110e+02
  2.40480110e+02  5.26698240e+02  1.89183867e+03  8.01872665e+03
  4.77831106e+04]
E1 = -182.84763150799992  E_coul = 54.30662662704009
cycle= 2 E= -128.54100488096  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264258
diis-c [-0.00073258  0.33629517  0.66370483]
  HOMO = -0.84869851094044  LUMO = 0.766048956515078
  mo_energy =
[-3.27703322e+01 -1.92912311e+00 -8.48698511e-01 -8.48698511e-01
 -8.48698511e-01  7.66048957e-01  8.06351518e-01  8.06351518e-01
  8.06351518e-01  3.89014510e+00  3.89014510e+00  3.89014510e+00
  4.34097128e+00  1.42219932e+01  1.42219932e+01  1.42219932e+01
  1.62092872e+01  5.23397172e+01  5.28035848e+01  5.28035848e+01
  5.28035848e+01  1.62170349e+02  2.40593751e+02  2.40593751e+02
  2.40593751e+02  5.26814797e+02  1.89196064e+03  8.01885112e+03
  4.77832360e+04]
E1 = -182.5890559648131  E_coul = 54.04713106592416
cycle= 3 E= -128.541924898889  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108695
diis-c [-1.94513370e-07 -2.38887688e-03 -9.38291806e-04  1.00332717e+00]
  HOMO = -0.848948896890697  LUMO = 0.765998521890862
  mo_energy =
[-3.27707659e+01 -1.92930803e+00 -8.48948897e-01 -8.48948897e-01
 -8.48948897e-01  7.65998522e-01  8.06313375e-01  8.06313375e-01
  8.06313375e-01  3.88997345e+00  3.88997345e+00  3.88997345e+00
  4.34082592e+00  1.42217010e+01  1.42217010e+01  1.42217010e+01
  1.62090219e+01  5.23393655e+01  5.28032013e+01  5.28032013e+01
  5.28032013e+01  1.62169910e+02  2.40593247e+02  2.40593247e+02
  2.40593247e+02  5.26814238e+02  1.89195995e+03  8.01885033e+03
  4.77832351e+04]
E1 = -182.58944206216492  E_coul = 54.047517138147384
cycle= 4 E= -128.541924924018  delta_E= -2.51e-08  |g|= 8.07e-05  |ddm|= 0.000338
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187763
diis-c [-1.13436203e-09  2.33853386e-04  5.36639691e-04 -1.85380294e-01
  1.18460980e+00]
  HOMO = -0.848992301349452  LUMO = 0.76598552282499
  mo_energy =
[-3.27708396e+01 -1.92934072e+00 -8.48992301e-01 -8.48992301e-01
 -8.48992301e-01  7.65985523e-01  8.06299904e-01  8.06299904e-01
  8.06299904e-01  3.88993302e+00  3.88993302e+00  3.88993302e+00
  4.34079275e+00  1.42216412e+01  1.42216412e+01  1.42216412e+01
  1.62089663e+01  5.23392983e+01  5.28031317e+01  5.28031317e+01
  5.28031317e+01  1.62169836e+02  2.40593169e+02  2.40593169e+02
  2.40593169e+02  5.26814156e+02  1.89195986e+03  8.01885023e+03
  4.77832350e+04]
E1 = -182.58957633430103  E_coul = 54.04765140955613
cycle= 5 E= -128.541924924745  delta_E= -7.27e-10  |g|= 5.99e-06  |ddm|= 5.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58957633430103  E_coul = 54.04765140955613
  HOMO = -0.848989157324345  LUMO = 0.765986853572435
  mo_energy =
[-3.27708325e+01 -1.92933676e+00 -8.48989157e-01 -8.48989157e-01
 -8.48989157e-01  7.65986854e-01  8.06300830e-01  8.06300830e-01
  8.06300830e-01  3.88993603e+00  3.88993603e+00  3.88993603e+00
  4.34079580e+00  1.42216464e+01  1.42216464e+01  1.42216464e+01
  1.62089713e+01  5.23393046e+01  5.28031383e+01  5.28031383e+01
  5.28031383e+01  1.62169843e+02  2.40593176e+02  2.40593176e+02
  2.40593176e+02  5.26814163e+02  1.89195987e+03  8.01885024e+03
  4.77832350e+04]
E1 = -182.58956031263367  E_coul = 54.04763538788605
Extra cycle  E= -128.541924924748  delta_E= -2.7e-12  |g|= 2.26e-06  |ddm|= 2.19e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1272.3863951158924
E1 = -182.58956031263367  E_coul = 54.04763538788605
init E= -128.541924924748
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.848990290812247  LUMO = 0.76598664360708
  mo_energy =
[-3.27708361e+01 -1.92933781e+00 -8.48990291e-01 -8.48990291e-01
 -8.48990291e-01  7.65986644e-01  8.06300570e-01  8.06300570e-01
  8.06300570e-01  3.88993505e+00  3.88993505e+00  3.88993505e+00
  4.34079500e+00  1.42216444e+01  1.42216444e+01  1.42216444e+01
  1.62089696e+01  5.23393019e+01  5.28031353e+01  5.28031353e+01
  5.28031353e+01  1.62169840e+02  2.40593172e+02  2.40593172e+02
  2.40593172e+02  5.26814159e+02  1.89195986e+03  8.01885024e+03
  4.77832350e+04]
E1 = -182.58956921685174  E_coul = 54.04764429210374
cycle= 1 E= -128.541924924748  delta_E= -3.98e-13  |g|= 1.22e-06  |ddm|= 8.09e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58956921685174  E_coul = 54.04764429210374
  HOMO = -0.848989663999877  LUMO = 0.765986822434065
  mo_energy =
[-3.27708342e+01 -1.92933712e+00 -8.48989664e-01 -8.48989664e-01
 -8.48989664e-01  7.65986822e-01  8.06300727e-01  8.06300727e-01
  8.06300727e-01  3.88993561e+00  3.88993561e+00  3.88993561e+00
  4.34079552e+00  1.42216455e+01  1.42216455e+01  1.42216455e+01
  1.62089706e+01  5.23393034e+01  5.28031369e+01  5.28031369e+01
  5.28031369e+01  1.62169841e+02  2.40593174e+02  2.40593174e+02
  2.40593174e+02  5.26814161e+02  1.89195987e+03  8.01885024e+03
  4.77832350e+04]
E1 = -182.5895647422375  E_coul = 54.04763981748958
Extra cycle  E= -128.541924924748  delta_E= 5.68e-14  |g|= 6.08e-07  |ddm|= 4e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.40 sec
exp = [7.79228514e-01 2.44137942e+04 3.66145093e+03 8.33332322e+02
 2.35310975e+02 7.63718070e+01 1.16655220e+01 2.82265727e+01
 2.98963966e-01 1.97798266e+00 5.21829807e+00 7.10814719e+00
 2.31756669e+01 9.97849958e+01 2.66236464e-01 2.44006382e+00
 8.33778597e-01]
grad_E = [ 9.04105946e-06 -1.01561713e-09  5.47683387e-08 -1.16654826e-06
  1.36633865e-05 -5.82134937e-05 -3.14180301e-05 -1.62629031e-05
 -1.14456654e-04  2.99161315e-07  3.89035036e-05 -6.09622369e-05
  1.23606201e-05 -5.69461049e-07  6.14131957e-04  1.02655818e-04
 -2.15434449e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.775189633149       1
[INPUT] 0    0    [1    /1   ]  24413.7941987        1
[INPUT] 0    0    [1    /1   ]  3661.45091495        1
[INPUT] 0    0    [1    /1   ]  833.332604653        1
[INPUT] 0    0    [1    /1   ]  235.307500344        1
[INPUT] 0    0    [1    /1   ]  76.3909065937        1
[INPUT] 0    0    [1    /1   ]  11.6210980829        1
[INPUT] 0    0    [1    /1   ]  28.2188971886        1
[INPUT] 0    0    [1    /1   ]  0.297503662016       1
[INPUT] 0    0    [1    /1   ]  1.96856996267        1
[INPUT] 0    0    [1    /1   ]  5.17029556083        1
[INPUT] 1    0    [1    /1   ]  7.10485378956        1
[INPUT] 1    0    [1    /1   ]  23.1767084377        1
[INPUT] 1    0    [1    /1   ]  99.7849589562        1
[INPUT] 1    0    [1    /1   ]  0.266298134024       1
[INPUT] 1    0    [1    /1   ]  2.43921379815        1
[INPUT] 1    0    [1    /1   ]  0.833731370711       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7751896331490795, 1.0]], [0, [24413.794198698037, 1.0]], [0, [3661.450914945139, 1.0]], [0, [833.3326046533966, 1.0]], [0, [235.3075003441389, 1.0]], [0, [76.39090659366035, 1.0]], [0, [11.62109808287711, 1.0]], [0, [28.218897188556753, 1.0]], [0, [0.29750366201611517, 1.0]], [0, [1.96856996266571, 1.0]], [0, [5.17029556082604, 1.0]], [1, [7.104853789557074, 1.0]], [1, [23.176708437687527, 1.0]], [1, [99.78495895623684, 1.0]], [1, [0.26629813402429664, 1.0]], [1, [2.4392137981516018, 1.0]], [1, [0.8337313707109787, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77518963]
bas 1, expnt(s) = [24413.7941987]
bas 2, expnt(s) = [3661.45091495]
bas 3, expnt(s) = [833.33260465]
bas 4, expnt(s) = [235.30750034]
bas 5, expnt(s) = [76.39090659]
bas 6, expnt(s) = [11.62109808]
bas 7, expnt(s) = [28.21889719]
bas 8, expnt(s) = [0.29750366]
bas 9, expnt(s) = [1.96856996]
bas 10, expnt(s) = [5.17029556]
bas 11, expnt(s) = [7.10485379]
bas 12, expnt(s) = [23.17670844]
bas 13, expnt(s) = [99.78495896]
bas 14, expnt(s) = [0.26629813]
bas 15, expnt(s) = [2.4392138]
bas 16, expnt(s) = [0.83373137]
CPU time:       317.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.75189633e-01 2.08723328e+00 2.44137942e+04 4.93448103e+03
 3.66145091e+03 1.18920010e+03 8.33332605e+02 3.91858079e+02
 2.35307500e+02 1.51789543e+02 7.63909066e+01 6.52824241e+01
 1.16210981e+01 1.59019506e+01 2.82188972e+01 3.09328583e+01
 2.97503662e-01 1.01773395e+00 1.96856996e+00 4.19882878e+00
 5.17029556e+00 8.66266564e+00 7.10485379e+00 3.38398418e+01
 2.31767084e+01 1.48353942e+02 9.97849590e+01 9.20059145e+02
 2.66298134e-01 5.58077543e-01 2.43921380e+00 8.89296796e+00
 8.33731371e-01 2.32416561e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639860353902
cond(S) = 1254.3832789670541
E1 = -183.59045271524246  E_coul = 55.08016900348919
init E= -128.510283711753
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403234990436  LUMO = 0.780053994267272
  mo_energy =
[-3.25552177e+01 -1.85274283e+00 -7.75403235e-01 -7.75403235e-01
 -7.75403235e-01  7.80053994e-01  8.24548446e-01  8.24548446e-01
  8.24548446e-01  3.95565280e+00  3.95565280e+00  3.95565280e+00
  4.36941219e+00  1.43445327e+01  1.43445327e+01  1.43445327e+01
  1.62034223e+01  5.22170694e+01  5.29792693e+01  5.29792693e+01
  5.29792693e+01  1.61980074e+02  2.40817484e+02  2.40817484e+02
  2.40817484e+02  5.26671581e+02  1.89189216e+03  8.01885099e+03
  4.77833059e+04]
E1 = -182.0862779537261  E_coul = 53.547859323284534
cycle= 1 E= -128.538418630442  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519546
diis-c [-0.26992855  1.        ]
  HOMO = -0.884308984514204  LUMO = 0.751454718738492
  mo_energy =
[-3.28783898e+01 -1.96661861e+00 -8.84308985e-01 -8.84308985e-01
 -8.84308985e-01  7.51454719e-01  7.97763709e-01  7.97763709e-01
  7.97763709e-01  3.85825499e+00  3.85825499e+00  3.85825499e+00
  4.28315771e+00  1.41538932e+01  1.41538932e+01  1.41538932e+01
  1.60301727e+01  5.19602392e+01  5.26983321e+01  5.26983321e+01
  5.26983321e+01  1.61662761e+02  2.40471157e+02  2.40471157e+02
  2.40471157e+02  5.26310758e+02  1.89149479e+03  8.01842435e+03
  4.77828603e+04]
E1 = -182.8476642420495  E_coul = 54.30665829817843
cycle= 2 E= -128.541005943871  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264274
diis-c [-0.00073099  0.3362894   0.6637106 ]
  HOMO = -0.84869400308989  LUMO = 0.760600093949065
  mo_energy =
[-3.27703265e+01 -1.92911723e+00 -8.48694003e-01 -8.48694003e-01
 -8.48694003e-01  7.60600094e-01  8.06494638e-01  8.06494638e-01
  8.06494638e-01  3.88984357e+00  3.88984357e+00  3.88984357e+00
  4.31111325e+00  1.42170262e+01  1.42170262e+01  1.42170262e+01
  1.60874091e+01  5.20462823e+01  5.27923199e+01  5.27923199e+01
  5.27923199e+01  1.61768544e+02  2.40584793e+02  2.40584793e+02
  2.40584793e+02  5.26427314e+02  1.89161677e+03  8.01854883e+03
  4.77829857e+04]
E1 = -182.58910797303355  E_coul = 54.047182129958635
cycle= 3 E= -128.541925843075  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108772
diis-c [-1.95837925e-07 -2.38955131e-03 -9.39327633e-04  1.00332888e+00]
  HOMO = -0.848944403602803  LUMO = 0.76055008241843
  mo_energy =
[-3.27707604e+01 -1.92930198e+00 -8.48944404e-01 -8.48944404e-01
 -8.48944404e-01  7.60550082e-01  8.06456492e-01  8.06456492e-01
  8.06456492e-01  3.88967201e+00  3.88967201e+00  3.88967201e+00
  4.31096867e+00  1.42167340e+01  1.42167340e+01  1.42167340e+01
  1.60871445e+01  5.20459307e+01  5.27919363e+01  5.27919363e+01
  5.27919363e+01  1.61768106e+02  2.40584288e+02  2.40584288e+02
  2.40584288e+02  5.26426755e+02  1.89161607e+03  8.01854803e+03
  4.77829849e+04]
E1 = -182.58949457279158  E_coul = 54.0475687045081
cycle= 4 E= -128.541925868283  delta_E= -2.52e-08  |g|= 8.07e-05  |ddm|= 0.000338
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187776
diis-c [-1.13910318e-09  2.34932187e-04  5.36236022e-04 -1.85922819e-01
  1.18515165e+00]
  HOMO = -0.848987814226114  LUMO = 0.760537181674014
  mo_energy =
[-3.27708341e+01 -1.92933461e+00 -8.48987814e-01 -8.48987814e-01
 -8.48987814e-01  7.60537182e-01  8.06443014e-01  8.06443014e-01
  8.06443014e-01  3.88963159e+00  3.88963159e+00  3.88963159e+00
  4.31093566e+00  1.42166743e+01  1.42166743e+01  1.42166743e+01
  1.60870890e+01  5.20458636e+01  5.27918667e+01  5.27918667e+01
  5.27918667e+01  1.61768032e+02  2.40584210e+02  2.40584210e+02
  2.40584210e+02  5.26426673e+02  1.89161598e+03  8.01854794e+03
  4.77829848e+04]
E1 = -182.58962870535146  E_coul = 54.04770283633794
cycle= 5 E= -128.541925869014  delta_E= -7.3e-10  |g|= 6.02e-06  |ddm|= 5.69e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58962870535146  E_coul = 54.04770283633794
  HOMO = -0.848984653484356  LUMO = 0.760538510012492
  mo_energy =
[-3.27708269e+01 -1.92933064e+00 -8.48984653e-01 -8.48984653e-01
 -8.48984653e-01  7.60538510e-01  8.06443945e-01  8.06443945e-01
  8.06443945e-01  3.88963461e+00  3.88963461e+00  3.88963461e+00
  4.31093871e+00  1.42166794e+01  1.42166794e+01  1.42166794e+01
  1.60870941e+01  5.20458700e+01  5.27918734e+01  5.27918734e+01
  5.27918734e+01  1.61768038e+02  2.40584217e+02  2.40584217e+02
  2.40584217e+02  5.26426680e+02  1.89161599e+03  8.01854794e+03
  4.77829848e+04]
E1 = -182.5896126071231  E_coul = 54.04768673810722
Extra cycle  E= -128.541925869016  delta_E= -2.36e-12  |g|= 2.27e-06  |ddm|= 2.2e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.75189633e-01 2.44137942e+04 3.66145091e+03 8.33332605e+02
 2.35307500e+02 7.63909066e+01 1.16210981e+01 2.82188972e+01
 2.97503662e-01 1.96856996e+00 5.17029556e+00 7.10485379e+00
 2.31767084e+01 9.97849590e+01 2.66298134e-01 2.43921380e+00
 8.33731371e-01]
E = -128.54192586901587
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.775189633149       1
[INPUT] 0    0    [1    /1   ]  24413.7941987        1
[INPUT] 0    0    [1    /1   ]  3661.45091495        1
[INPUT] 0    0    [1    /1   ]  833.332604653        1
[INPUT] 0    0    [1    /1   ]  235.307500344        1
[INPUT] 0    0    [1    /1   ]  76.3909065937        1
[INPUT] 0    0    [1    /1   ]  11.6210980829        1
[INPUT] 0    0    [1    /1   ]  28.2188971886        1
[INPUT] 0    0    [1    /1   ]  0.297503662016       1
[INPUT] 0    0    [1    /1   ]  1.96856996267        1
[INPUT] 0    0    [1    /1   ]  5.17029556083        1
[INPUT] 1    0    [1    /1   ]  7.10485378956        1
[INPUT] 1    0    [1    /1   ]  23.1767084377        1
[INPUT] 1    0    [1    /1   ]  99.7849589562        1
[INPUT] 1    0    [1    /1   ]  0.266298134024       1
[INPUT] 1    0    [1    /1   ]  2.43921379815        1
[INPUT] 1    0    [1    /1   ]  0.833731370711       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7751896331490795, 1.0]], [0, [24413.794198698037, 1.0]], [0, [3661.450914945139, 1.0]], [0, [833.3326046533966, 1.0]], [0, [235.3075003441389, 1.0]], [0, [76.39090659366035, 1.0]], [0, [11.62109808287711, 1.0]], [0, [28.218897188556753, 1.0]], [0, [0.29750366201611517, 1.0]], [0, [1.96856996266571, 1.0]], [0, [5.17029556082604, 1.0]], [1, [7.104853789557074, 1.0]], [1, [23.176708437687527, 1.0]], [1, [99.78495895623684, 1.0]], [1, [0.26629813402429664, 1.0]], [1, [2.4392137981516018, 1.0]], [1, [0.8337313707109787, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77518963]
bas 1, expnt(s) = [24413.7941987]
bas 2, expnt(s) = [3661.45091495]
bas 3, expnt(s) = [833.33260465]
bas 4, expnt(s) = [235.30750034]
bas 5, expnt(s) = [76.39090659]
bas 6, expnt(s) = [11.62109808]
bas 7, expnt(s) = [28.21889719]
bas 8, expnt(s) = [0.29750366]
bas 9, expnt(s) = [1.96856996]
bas 10, expnt(s) = [5.17029556]
bas 11, expnt(s) = [7.10485379]
bas 12, expnt(s) = [23.17670844]
bas 13, expnt(s) = [99.78495896]
bas 14, expnt(s) = [0.26629813]
bas 15, expnt(s) = [2.4392138]
bas 16, expnt(s) = [0.83373137]
CPU time:       318.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.75189633e-01 2.08723328e+00 2.44137942e+04 4.93448103e+03
 3.66145091e+03 1.18920010e+03 8.33332605e+02 3.91858079e+02
 2.35307500e+02 1.51789543e+02 7.63909066e+01 6.52824241e+01
 1.16210981e+01 1.59019506e+01 2.82188972e+01 3.09328583e+01
 2.97503662e-01 1.01773395e+00 1.96856996e+00 4.19882878e+00
 5.17029556e+00 8.66266564e+00 7.10485379e+00 3.38398418e+01
 2.31767084e+01 1.48353942e+02 9.97849590e+01 9.20059145e+02
 2.66298134e-01 5.58077543e-01 2.43921380e+00 8.89296796e+00
 8.33731371e-01 2.32416561e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639860353902
cond(S) = 1254.3832789670541
E1 = -183.59045271524246  E_coul = 55.08016900348919
init E= -128.510283711753
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403234990436  LUMO = 0.780053994267272
  mo_energy =
[-3.25552177e+01 -1.85274283e+00 -7.75403235e-01 -7.75403235e-01
 -7.75403235e-01  7.80053994e-01  8.24548446e-01  8.24548446e-01
  8.24548446e-01  3.95565280e+00  3.95565280e+00  3.95565280e+00
  4.36941219e+00  1.43445327e+01  1.43445327e+01  1.43445327e+01
  1.62034223e+01  5.22170694e+01  5.29792693e+01  5.29792693e+01
  5.29792693e+01  1.61980074e+02  2.40817484e+02  2.40817484e+02
  2.40817484e+02  5.26671581e+02  1.89189216e+03  8.01885099e+03
  4.77833059e+04]
E1 = -182.0862779537261  E_coul = 53.547859323284534
cycle= 1 E= -128.538418630442  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519546
diis-c [-0.26992855  1.        ]
  HOMO = -0.884308984514204  LUMO = 0.751454718738492
  mo_energy =
[-3.28783898e+01 -1.96661861e+00 -8.84308985e-01 -8.84308985e-01
 -8.84308985e-01  7.51454719e-01  7.97763709e-01  7.97763709e-01
  7.97763709e-01  3.85825499e+00  3.85825499e+00  3.85825499e+00
  4.28315771e+00  1.41538932e+01  1.41538932e+01  1.41538932e+01
  1.60301727e+01  5.19602392e+01  5.26983321e+01  5.26983321e+01
  5.26983321e+01  1.61662761e+02  2.40471157e+02  2.40471157e+02
  2.40471157e+02  5.26310758e+02  1.89149479e+03  8.01842435e+03
  4.77828603e+04]
E1 = -182.8476642420495  E_coul = 54.30665829817843
cycle= 2 E= -128.541005943871  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264274
diis-c [-0.00073099  0.3362894   0.6637106 ]
  HOMO = -0.84869400308989  LUMO = 0.760600093949065
  mo_energy =
[-3.27703265e+01 -1.92911723e+00 -8.48694003e-01 -8.48694003e-01
 -8.48694003e-01  7.60600094e-01  8.06494638e-01  8.06494638e-01
  8.06494638e-01  3.88984357e+00  3.88984357e+00  3.88984357e+00
  4.31111325e+00  1.42170262e+01  1.42170262e+01  1.42170262e+01
  1.60874091e+01  5.20462823e+01  5.27923199e+01  5.27923199e+01
  5.27923199e+01  1.61768544e+02  2.40584793e+02  2.40584793e+02
  2.40584793e+02  5.26427314e+02  1.89161677e+03  8.01854883e+03
  4.77829857e+04]
E1 = -182.58910797303355  E_coul = 54.047182129958635
cycle= 3 E= -128.541925843075  delta_E= -0.00092  |g|= 0.000496  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108772
diis-c [-1.95837925e-07 -2.38955131e-03 -9.39327633e-04  1.00332888e+00]
  HOMO = -0.848944403602803  LUMO = 0.76055008241843
  mo_energy =
[-3.27707604e+01 -1.92930198e+00 -8.48944404e-01 -8.48944404e-01
 -8.48944404e-01  7.60550082e-01  8.06456492e-01  8.06456492e-01
  8.06456492e-01  3.88967201e+00  3.88967201e+00  3.88967201e+00
  4.31096867e+00  1.42167340e+01  1.42167340e+01  1.42167340e+01
  1.60871445e+01  5.20459307e+01  5.27919363e+01  5.27919363e+01
  5.27919363e+01  1.61768106e+02  2.40584288e+02  2.40584288e+02
  2.40584288e+02  5.26426755e+02  1.89161607e+03  8.01854803e+03
  4.77829849e+04]
E1 = -182.58949457279158  E_coul = 54.0475687045081
cycle= 4 E= -128.541925868283  delta_E= -2.52e-08  |g|= 8.07e-05  |ddm|= 0.000338
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187776
diis-c [-1.13910318e-09  2.34932187e-04  5.36236022e-04 -1.85922819e-01
  1.18515165e+00]
  HOMO = -0.848987814226114  LUMO = 0.760537181674014
  mo_energy =
[-3.27708341e+01 -1.92933461e+00 -8.48987814e-01 -8.48987814e-01
 -8.48987814e-01  7.60537182e-01  8.06443014e-01  8.06443014e-01
  8.06443014e-01  3.88963159e+00  3.88963159e+00  3.88963159e+00
  4.31093566e+00  1.42166743e+01  1.42166743e+01  1.42166743e+01
  1.60870890e+01  5.20458636e+01  5.27918667e+01  5.27918667e+01
  5.27918667e+01  1.61768032e+02  2.40584210e+02  2.40584210e+02
  2.40584210e+02  5.26426673e+02  1.89161598e+03  8.01854794e+03
  4.77829848e+04]
E1 = -182.58962870535146  E_coul = 54.04770283633794
cycle= 5 E= -128.541925869014  delta_E= -7.3e-10  |g|= 6.02e-06  |ddm|= 5.69e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58962870535146  E_coul = 54.04770283633794
  HOMO = -0.848984653484356  LUMO = 0.760538510012492
  mo_energy =
[-3.27708269e+01 -1.92933064e+00 -8.48984653e-01 -8.48984653e-01
 -8.48984653e-01  7.60538510e-01  8.06443945e-01  8.06443945e-01
  8.06443945e-01  3.88963461e+00  3.88963461e+00  3.88963461e+00
  4.31093871e+00  1.42166794e+01  1.42166794e+01  1.42166794e+01
  1.60870941e+01  5.20458700e+01  5.27918734e+01  5.27918734e+01
  5.27918734e+01  1.61768038e+02  2.40584217e+02  2.40584217e+02
  2.40584217e+02  5.26426680e+02  1.89161599e+03  8.01854794e+03
  4.77829848e+04]
E1 = -182.5896126071231  E_coul = 54.04768673810722
Extra cycle  E= -128.541925869016  delta_E= -2.36e-12  |g|= 2.27e-06  |ddm|= 2.2e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1254.3832789670541
E1 = -182.5896126071231  E_coul = 54.04768673810722
init E= -128.541925869016
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.84898579219388  LUMO = 0.760538300643398
  mo_energy =
[-3.27708305e+01 -1.92933169e+00 -8.48985792e-01 -8.48985792e-01
 -8.48985792e-01  7.60538301e-01  8.06443684e-01  8.06443684e-01
  8.06443684e-01  3.88963363e+00  3.88963363e+00  3.88963363e+00
  4.31093791e+00  1.42166774e+01  1.42166774e+01  1.42166774e+01
  1.60870923e+01  5.20458672e+01  5.27918703e+01  5.27918703e+01
  5.27918703e+01  1.61768035e+02  2.40584213e+02  2.40584213e+02
  2.40584213e+02  5.26426676e+02  1.89161598e+03  8.01854794e+03
  4.77829848e+04]
E1 = -182.5896215540997  E_coul = 54.047695685082836
cycle= 1 E= -128.541925869017  delta_E= -9.95e-13  |g|= 1.23e-06  |ddm|= 8.12e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5896215540997  E_coul = 54.047695685082836
  HOMO = -0.848985162337042  LUMO = 0.760538479019744
  mo_energy =
[-3.27708286e+01 -1.92933100e+00 -8.48985162e-01 -8.48985162e-01
 -8.48985162e-01  7.60538479e-01  8.06443842e-01  8.06443842e-01
  8.06443842e-01  3.88963419e+00  3.88963419e+00  3.88963419e+00
  4.31093843e+00  1.42166785e+01  1.42166785e+01  1.42166785e+01
  1.60870933e+01  5.20458687e+01  5.27918720e+01  5.27918720e+01
  5.27918720e+01  1.61768037e+02  2.40584215e+02  2.40584215e+02
  2.40584215e+02  5.26426678e+02  1.89161599e+03  8.01854794e+03
  4.77829848e+04]
E1 = -182.58961705807647  E_coul = 54.04769118905979
Extra cycle  E= -128.541925869017  delta_E= 1.99e-13  |g|= 6.11e-07  |ddm|= 4.02e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [7.75189633e-01 2.44137942e+04 3.66145091e+03 8.33332605e+02
 2.35307500e+02 7.63909066e+01 1.16210981e+01 2.82188972e+01
 2.97503662e-01 1.96856996e+00 5.17029556e+00 7.10485379e+00
 2.31767084e+01 9.97849590e+01 2.66298134e-01 2.43921380e+00
 8.33731371e-01]
grad_E = [ 7.69531832e-06 -1.00271805e-09  5.41453276e-08 -1.15938794e-06
  1.37468649e-05 -6.06208986e-05 -5.02465872e-05 -3.80402853e-06
 -1.57473181e-04  4.57269530e-06  4.46395928e-05 -8.93644080e-05
  1.82677027e-05 -8.41971126e-07  8.00149935e-04  1.41253286e-04
 -2.70164807e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.770405042187       1
[INPUT] 0    0    [1    /1   ]  24413.7941995        1
[INPUT] 0    0    [1    /1   ]  3661.45087389        1
[INPUT] 0    0    [1    /1   ]  833.333455696        1
[INPUT] 0    0    [1    /1   ]  235.297618268        1
[INPUT] 0    0    [1    /1   ]  76.4391718072        1
[INPUT] 0    0    [1    /1   ]  11.552566205         1
[INPUT] 0    0    [1    /1   ]  28.205686585         1
[INPUT] 0    0    [1    /1   ]  0.296020195801       1
[INPUT] 0    0    [1    /1   ]  1.95618994006        1
[INPUT] 0    0    [1    /1   ]  5.10020538236        1
[INPUT] 1    0    [1    /1   ]  7.10255739467        1
[INPUT] 1    0    [1    /1   ]  23.1773641821        1
[INPUT] 1    0    [1    /1   ]  99.7849447964        1
[INPUT] 1    0    [1    /1   ]  0.266316409303       1
[INPUT] 1    0    [1    /1   ]  2.43864345793        1
[INPUT] 1    0    [1    /1   ]  0.833701971298       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7704050421870653, 1.0]], [0, [24413.794199469594, 1.0]], [0, [3661.450873890472, 1.0]], [0, [833.3334556963287, 1.0]], [0, [235.29761826827726, 1.0]], [0, [76.43917180718869, 1.0]], [0, [11.552566204962393, 1.0]], [0, [28.205686584957302, 1.0]], [0, [0.29602019580065514, 1.0]], [0, [1.956189940059354, 1.0]], [0, [5.100205382356371, 1.0]], [1, [7.102557394672909, 1.0]], [1, [23.17736418213557, 1.0]], [1, [99.78494479640197, 1.0]], [1, [0.26631640930259887, 1.0]], [1, [2.4386434579307674, 1.0]], [1, [0.8337019712975401, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77040504]
bas 1, expnt(s) = [24413.79419947]
bas 2, expnt(s) = [3661.45087389]
bas 3, expnt(s) = [833.3334557]
bas 4, expnt(s) = [235.29761827]
bas 5, expnt(s) = [76.43917181]
bas 6, expnt(s) = [11.5525662]
bas 7, expnt(s) = [28.20568658]
bas 8, expnt(s) = [0.2960202]
bas 9, expnt(s) = [1.95618994]
bas 10, expnt(s) = [5.10020538]
bas 11, expnt(s) = [7.10255739]
bas 12, expnt(s) = [23.17736418]
bas 13, expnt(s) = [99.7849448]
bas 14, expnt(s) = [0.26631641]
bas 15, expnt(s) = [2.43864346]
bas 16, expnt(s) = [0.83370197]
CPU time:       322.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.70405042e-01 2.07756376e+00 2.44137942e+04 4.93448103e+03
 3.66145087e+03 1.18920009e+03 8.33333456e+02 3.91858379e+02
 2.35297618e+02 1.51784762e+02 7.64391718e+01 6.53133566e+01
 1.15525662e+01 1.58315659e+01 2.82056866e+01 3.09219968e+01
 2.96020196e-01 1.01392546e+00 1.95618994e+00 4.17900884e+00
 5.10020538e+00 8.57444015e+00 7.10255739e+00 3.38261704e+01
 2.31773642e+01 1.48359188e+02 9.97849448e+01 9.20058982e+02
 2.66316409e-01 5.58125417e-01 2.43864346e+00 8.89036883e+00
 8.33701971e-01 2.32406317e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639834423913
cond(S) = 1231.7009332349166
E1 = -183.59045945673105  E_coul = 55.080168616831976
init E= -128.510290839899
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775403299373021  LUMO = 0.773834664009248
  mo_energy =
[-3.25552179e+01 -1.85274351e+00 -7.75403299e-01 -7.75403299e-01
 -7.75403299e-01  7.73834664e-01  8.24582095e-01  8.24582095e-01
  8.24582095e-01  3.95535725e+00  3.95535725e+00  3.95535725e+00
  4.33231197e+00  1.43410358e+01  1.43410358e+01  1.43410358e+01
  1.60355986e+01  5.17934837e+01  5.29713456e+01  5.29713456e+01
  5.29713456e+01  1.61401759e+02  2.40811058e+02  2.40811058e+02
  2.40811058e+02  5.26143385e+02  1.89143941e+03  8.01845536e+03
  4.77829788e+04]
E1 = -182.0862933333383  E_coul = 53.5478727776621
cycle= 1 E= -128.538420555676  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519632
diis-c [-0.27001709  1.        ]
  HOMO = -0.884307843242877  LUMO = 0.745476200473208
  mo_energy =
[-3.28783887e+01 -1.96661733e+00 -8.84307843e-01 -8.84307843e-01
 -8.84307843e-01  7.45476200e-01  7.97797864e-01  7.97797864e-01
  7.97797864e-01  3.85797413e+00  3.85797413e+00  3.85797413e+00
  4.24667664e+00  1.41504251e+01  1.41504251e+01  1.41504251e+01
  1.58632356e+01  5.15370077e+01  5.26904123e+01  5.26904123e+01
  5.26904123e+01  1.61084449e+02  2.40464728e+02  2.40464728e+02
  2.40464728e+02  5.25782543e+02  1.89104203e+03  8.01802873e+03
  4.77825332e+04]
E1 = -182.84766921493716  E_coul = 54.30666139900302
cycle= 2 E= -128.541007815934  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.26431
diis-c [-0.0007287   0.33628599  0.66371401]
  HOMO = -0.848693166362309  LUMO = 0.754544552799006
  mo_energy =
[-3.27703263e+01 -1.92911632e+00 -8.48693166e-01 -8.48693166e-01
 -8.48693166e-01  7.54544553e-01  8.06528714e-01  8.06528714e-01
  8.06528714e-01  3.88955791e+00  3.88955791e+00  3.88955791e+00
  4.27442766e+00  1.42135483e+01  1.42135483e+01  1.42135483e+01
  1.59201690e+01  5.16229297e+01  5.27843987e+01  5.27843987e+01
  5.27843987e+01  1.61190231e+02  2.40578363e+02  2.40578363e+02
  2.40578363e+02  5.25899104e+02  1.89116401e+03  8.01815320e+03
  4.77826586e+04]
E1 = -182.58911554269943  E_coul = 54.04718785246251
cycle= 3 E= -128.541927690237  delta_E= -0.00092  |g|= 0.000497  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108915
diis-c [-1.97141161e-07 -2.39041526e-03 -9.38141667e-04  1.00332856e+00]
  HOMO = -0.848943782838318  LUMO = 0.754494880329392
  mo_energy =
[-3.27707607e+01 -1.92930120e+00 -8.48943783e-01 -8.48943783e-01
 -8.48943783e-01  7.54494880e-01  8.06490492e-01  8.06490492e-01
  8.06490492e-01  3.88938621e+00  3.88938621e+00  3.88938621e+00
  4.27428387e+00  1.42132558e+01  1.42132558e+01  1.42132558e+01
  1.59199050e+01  5.16225781e+01  5.27840146e+01  5.27840146e+01
  5.27840146e+01  1.61189792e+02  2.40577858e+02  2.40577858e+02
  2.40577858e+02  5.25898544e+02  1.89116331e+03  8.01815240e+03
  4.77826578e+04]
E1 = -182.58950327409147  E_coul = 54.04757555855391
cycle= 4 E= -128.541927715538  delta_E= -2.53e-08  |g|= 8.07e-05  |ddm|= 0.000339
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187708
diis-c [-1.14179304e-09  2.35689088e-04  5.34892589e-04 -1.86300478e-01
  1.18552990e+00]
  HOMO = -0.848987204973252  LUMO = 0.754482071421493
  mo_energy =
[-3.27708344e+01 -1.92933381e+00 -8.48987205e-01 -8.48987205e-01
 -8.48987205e-01  7.54482071e-01  8.06477004e-01  8.06477004e-01
  8.06477004e-01  3.88934579e+00  3.88934579e+00  3.88934579e+00
  4.27425105e+00  1.42131960e+01  1.42131960e+01  1.42131960e+01
  1.59198498e+01  5.16225110e+01  5.27839450e+01  5.27839450e+01
  5.27839450e+01  1.61189718e+02  2.40577780e+02  2.40577780e+02
  2.40577780e+02  5.25898462e+02  1.89116322e+03  8.01815231e+03
  4.77826577e+04]
E1 = -182.58963719227472  E_coul = 54.047709476004826
cycle= 5 E= -128.54192771627  delta_E= -7.32e-10  |g|= 6.03e-06  |ddm|= 5.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58963719227472  E_coul = 54.047709476004826
  HOMO = -0.848984031941567  LUMO = 0.754483393982352
  mo_energy =
[-3.27708272e+01 -1.92932982e+00 -8.48984032e-01 -8.48984032e-01
 -8.48984032e-01  7.54483394e-01  8.06477938e-01  8.06477938e-01
  8.06477938e-01  3.88934882e+00  3.88934882e+00  3.88934882e+00
  4.27425410e+00  1.42132012e+01  1.42132012e+01  1.42132012e+01
  1.59198548e+01  5.16225175e+01  5.27839517e+01  5.27839517e+01
  5.27839517e+01  1.61189725e+02  2.40577787e+02  2.40577787e+02
  2.40577787e+02  5.25898469e+02  1.89116323e+03  8.01815231e+03
  4.77826577e+04]
E1 = -182.58962102852277  E_coul = 54.047693312249926
Extra cycle  E= -128.541927716273  delta_E= -2.96e-12  |g|= 2.28e-06  |ddm|= 2.21e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [7.70405042e-01 2.44137942e+04 3.66145087e+03 8.33333456e+02
 2.35297618e+02 7.64391718e+01 1.15525662e+01 2.82056866e+01
 2.96020196e-01 1.95618994e+00 5.10020538e+00 7.10255739e+00
 2.31773642e+01 9.97849448e+01 2.66316409e-01 2.43864346e+00
 8.33701971e-01]
E = -128.54192771627285
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.770405042187       1
[INPUT] 0    0    [1    /1   ]  24413.7941995        1
[INPUT] 0    0    [1    /1   ]  3661.45087389        1
[INPUT] 0    0    [1    /1   ]  833.333455696        1
[INPUT] 0    0    [1    /1   ]  235.297618268        1
[INPUT] 0    0    [1    /1   ]  76.4391718072        1
[INPUT] 0    0    [1    /1   ]  11.552566205         1
[INPUT] 0    0    [1    /1   ]  28.205686585         1
[INPUT] 0    0    [1    /1   ]  0.296020195801       1
[INPUT] 0    0    [1    /1   ]  1.95618994006        1
[INPUT] 0    0    [1    /1   ]  5.10020538236        1
[INPUT] 1    0    [1    /1   ]  7.10255739467        1
[INPUT] 1    0    [1    /1   ]  23.1773641821        1
[INPUT] 1    0    [1    /1   ]  99.7849447964        1
[INPUT] 1    0    [1    /1   ]  0.266316409303       1
[INPUT] 1    0    [1    /1   ]  2.43864345793        1
[INPUT] 1    0    [1    /1   ]  0.833701971298       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7704050421870653, 1.0]], [0, [24413.794199469594, 1.0]], [0, [3661.450873890472, 1.0]], [0, [833.3334556963287, 1.0]], [0, [235.29761826827726, 1.0]], [0, [76.43917180718869, 1.0]], [0, [11.552566204962393, 1.0]], [0, [28.205686584957302, 1.0]], [0, [0.29602019580065514, 1.0]], [0, [1.956189940059354, 1.0]], [0, [5.100205382356371, 1.0]], [1, [7.102557394672909, 1.0]], [1, [23.17736418213557, 1.0]], [1, [99.78494479640197, 1.0]], [1, [0.26631640930259887, 1.0]], [1, [2.4386434579307674, 1.0]], [1, [0.8337019712975401, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77040504]
bas 1, expnt(s) = [24413.79419947]
bas 2, expnt(s) = [3661.45087389]
bas 3, expnt(s) = [833.3334557]
bas 4, expnt(s) = [235.29761827]
bas 5, expnt(s) = [76.43917181]
bas 6, expnt(s) = [11.5525662]
bas 7, expnt(s) = [28.20568658]
bas 8, expnt(s) = [0.2960202]
bas 9, expnt(s) = [1.95618994]
bas 10, expnt(s) = [5.10020538]
bas 11, expnt(s) = [7.10255739]
bas 12, expnt(s) = [23.17736418]
bas 13, expnt(s) = [99.7849448]
bas 14, expnt(s) = [0.26631641]
bas 15, expnt(s) = [2.43864346]
bas 16, expnt(s) = [0.83370197]
CPU time:       323.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.70405042e-01 2.07756376e+00 2.44137942e+04 4.93448103e+03
 3.66145087e+03 1.18920009e+03 8.33333456e+02 3.91858379e+02
 2.35297618e+02 1.51784762e+02 7.64391718e+01 6.53133566e+01
 1.15525662e+01 1.58315659e+01 2.82056866e+01 3.09219968e+01
 2.96020196e-01 1.01392546e+00 1.95618994e+00 4.17900884e+00
 5.10020538e+00 8.57444015e+00 7.10255739e+00 3.38261704e+01
 2.31773642e+01 1.48359188e+02 9.97849448e+01 9.20058982e+02
 2.66316409e-01 5.58125417e-01 2.43864346e+00 8.89036883e+00
 8.33701971e-01 2.32406317e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639834423913
cond(S) = 1231.7009332349166
E1 = -183.59045945673105  E_coul = 55.080168616831976
init E= -128.510290839899
    CPU time for initialize scf      0.03 sec, wall time      0.05 sec
  HOMO = -0.775403299373021  LUMO = 0.773834664009248
  mo_energy =
[-3.25552179e+01 -1.85274351e+00 -7.75403299e-01 -7.75403299e-01
 -7.75403299e-01  7.73834664e-01  8.24582095e-01  8.24582095e-01
  8.24582095e-01  3.95535725e+00  3.95535725e+00  3.95535725e+00
  4.33231197e+00  1.43410358e+01  1.43410358e+01  1.43410358e+01
  1.60355986e+01  5.17934837e+01  5.29713456e+01  5.29713456e+01
  5.29713456e+01  1.61401759e+02  2.40811058e+02  2.40811058e+02
  2.40811058e+02  5.26143385e+02  1.89143941e+03  8.01845536e+03
  4.77829788e+04]
E1 = -182.0862933333383  E_coul = 53.5478727776621
cycle= 1 E= -128.538420555676  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519632
diis-c [-0.27001709  1.        ]
  HOMO = -0.884307843242877  LUMO = 0.745476200473208
  mo_energy =
[-3.28783887e+01 -1.96661733e+00 -8.84307843e-01 -8.84307843e-01
 -8.84307843e-01  7.45476200e-01  7.97797864e-01  7.97797864e-01
  7.97797864e-01  3.85797413e+00  3.85797413e+00  3.85797413e+00
  4.24667664e+00  1.41504251e+01  1.41504251e+01  1.41504251e+01
  1.58632356e+01  5.15370077e+01  5.26904123e+01  5.26904123e+01
  5.26904123e+01  1.61084449e+02  2.40464728e+02  2.40464728e+02
  2.40464728e+02  5.25782543e+02  1.89104203e+03  8.01802873e+03
  4.77825332e+04]
E1 = -182.84766921493716  E_coul = 54.30666139900302
cycle= 2 E= -128.541007815934  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26431
diis-c [-0.0007287   0.33628599  0.66371401]
  HOMO = -0.848693166362309  LUMO = 0.754544552799006
  mo_energy =
[-3.27703263e+01 -1.92911632e+00 -8.48693166e-01 -8.48693166e-01
 -8.48693166e-01  7.54544553e-01  8.06528714e-01  8.06528714e-01
  8.06528714e-01  3.88955791e+00  3.88955791e+00  3.88955791e+00
  4.27442766e+00  1.42135483e+01  1.42135483e+01  1.42135483e+01
  1.59201690e+01  5.16229297e+01  5.27843987e+01  5.27843987e+01
  5.27843987e+01  1.61190231e+02  2.40578363e+02  2.40578363e+02
  2.40578363e+02  5.25899104e+02  1.89116401e+03  8.01815320e+03
  4.77826586e+04]
E1 = -182.58911554269943  E_coul = 54.04718785246251
cycle= 3 E= -128.541927690237  delta_E= -0.00092  |g|= 0.000497  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00108915
diis-c [-1.97141161e-07 -2.39041526e-03 -9.38141667e-04  1.00332856e+00]
  HOMO = -0.848943782838318  LUMO = 0.754494880329392
  mo_energy =
[-3.27707607e+01 -1.92930120e+00 -8.48943783e-01 -8.48943783e-01
 -8.48943783e-01  7.54494880e-01  8.06490492e-01  8.06490492e-01
  8.06490492e-01  3.88938621e+00  3.88938621e+00  3.88938621e+00
  4.27428387e+00  1.42132558e+01  1.42132558e+01  1.42132558e+01
  1.59199050e+01  5.16225781e+01  5.27840146e+01  5.27840146e+01
  5.27840146e+01  1.61189792e+02  2.40577858e+02  2.40577858e+02
  2.40577858e+02  5.25898544e+02  1.89116331e+03  8.01815240e+03
  4.77826578e+04]
E1 = -182.58950327409147  E_coul = 54.04757555855391
cycle= 4 E= -128.541927715538  delta_E= -2.53e-08  |g|= 8.07e-05  |ddm|= 0.000339
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187708
diis-c [-1.14179304e-09  2.35689088e-04  5.34892589e-04 -1.86300478e-01
  1.18552990e+00]
  HOMO = -0.848987204973252  LUMO = 0.754482071421493
  mo_energy =
[-3.27708344e+01 -1.92933381e+00 -8.48987205e-01 -8.48987205e-01
 -8.48987205e-01  7.54482071e-01  8.06477004e-01  8.06477004e-01
  8.06477004e-01  3.88934579e+00  3.88934579e+00  3.88934579e+00
  4.27425105e+00  1.42131960e+01  1.42131960e+01  1.42131960e+01
  1.59198498e+01  5.16225110e+01  5.27839450e+01  5.27839450e+01
  5.27839450e+01  1.61189718e+02  2.40577780e+02  2.40577780e+02
  2.40577780e+02  5.25898462e+02  1.89116322e+03  8.01815231e+03
  4.77826577e+04]
E1 = -182.58963719227472  E_coul = 54.047709476004826
cycle= 5 E= -128.54192771627  delta_E= -7.32e-10  |g|= 6.03e-06  |ddm|= 5.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58963719227472  E_coul = 54.047709476004826
  HOMO = -0.848984031941567  LUMO = 0.754483393982352
  mo_energy =
[-3.27708272e+01 -1.92932982e+00 -8.48984032e-01 -8.48984032e-01
 -8.48984032e-01  7.54483394e-01  8.06477938e-01  8.06477938e-01
  8.06477938e-01  3.88934882e+00  3.88934882e+00  3.88934882e+00
  4.27425410e+00  1.42132012e+01  1.42132012e+01  1.42132012e+01
  1.59198548e+01  5.16225175e+01  5.27839517e+01  5.27839517e+01
  5.27839517e+01  1.61189725e+02  2.40577787e+02  2.40577787e+02
  2.40577787e+02  5.25898469e+02  1.89116323e+03  8.01815231e+03
  4.77826577e+04]
E1 = -182.58962102852277  E_coul = 54.047693312249926
Extra cycle  E= -128.541927716273  delta_E= -2.96e-12  |g|= 2.28e-06  |ddm|= 2.21e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.14 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1231.7009332349166
E1 = -182.58962102852277  E_coul = 54.047693312249926
init E= -128.541927716273
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.848985175177031  LUMO = 0.754483185542369
  mo_energy =
[-3.27708308e+01 -1.92933088e+00 -8.48985175e-01 -8.48985175e-01
 -8.48985175e-01  7.54483186e-01  8.06477676e-01  8.06477676e-01
  8.06477676e-01  3.88934783e+00  3.88934783e+00  3.88934783e+00
  4.27425330e+00  1.42131992e+01  1.42131992e+01  1.42131992e+01
  1.59198531e+01  5.16225147e+01  5.27839486e+01  5.27839486e+01
  5.27839486e+01  1.61189721e+02  2.40577783e+02  2.40577783e+02
  2.40577783e+02  5.25898465e+02  1.89116322e+03  8.01815231e+03
  4.77826577e+04]
E1 = -182.58963001083006  E_coul = 54.04770229455689
cycle= 1 E= -128.541927716273  delta_E= -3.13e-13  |g|= 1.23e-06  |ddm|= 8.15e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58963001083006  E_coul = 54.04770229455689
  HOMO = -0.848984542808295  LUMO = 0.754483363111866
  mo_energy =
[-3.27708289e+01 -1.92933019e+00 -8.48984543e-01 -8.48984543e-01
 -8.48984543e-01  7.54483363e-01  8.06477835e-01  8.06477835e-01
  8.06477835e-01  3.88934840e+00  3.88934840e+00  3.88934840e+00
  4.27425382e+00  1.42132003e+01  1.42132003e+01  1.42132003e+01
  1.59198541e+01  5.16225162e+01  5.27839503e+01  5.27839503e+01
  5.27839503e+01  1.61189723e+02  2.40577785e+02  2.40577785e+02
  2.40577785e+02  5.25898467e+02  1.89116322e+03  8.01815231e+03
  4.77826577e+04]
E1 = -182.58962549687317  E_coul = 54.0476977805998
Extra cycle  E= -128.541927716273  delta_E= -1.99e-13  |g|= 6.13e-07  |ddm|= 4.03e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [7.70405042e-01 2.44137942e+04 3.66145087e+03 8.33333456e+02
 2.35297618e+02 7.64391718e+01 1.15525662e+01 2.82056866e+01
 2.96020196e-01 1.95618994e+00 5.10020538e+00 7.10255739e+00
 2.31773642e+01 9.97849448e+01 2.66316409e-01 2.43864346e+00
 8.33701971e-01]
grad_E = [-2.12184376e-05 -9.04709303e-10  4.91314209e-08 -1.07332174e-06
  1.31664016e-05 -6.14101800e-05 -7.82342938e-05  1.12345110e-05
 -1.50058822e-04  1.62597205e-05  5.28390540e-05 -1.08346501e-04
  2.23114021e-05 -1.02816113e-06  8.33977488e-04  1.60564950e-04
 -2.66870604e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.767041104664       1
[INPUT] 0    0    [1    /1   ]  24413.7942012        1
[INPUT] 0    0    [1    /1   ]  3661.45078317        1
[INPUT] 0    0    [1    /1   ]  833.335318862        1
[INPUT] 0    0    [1    /1   ]  235.276559221        1
[INPUT] 0    0    [1    /1   ]  76.5342060302        1
[INPUT] 0    0    [1    /1   ]  11.4759880196        1
[INPUT] 0    0    [1    /1   ]  28.1946643558        1
[INPUT] 0    0    [1    /1   ]  0.295515363653       1
[INPUT] 0    0    [1    /1   ]  1.94501095578        1
[INPUT] 0    0    [1    /1   ]  5.02849749384        1
[INPUT] 1    0    [1    /1   ]  7.103807889          1
[INPUT] 1    0    [1    /1   ]  23.1767874654        1
[INPUT] 1    0    [1    /1   ]  99.7849833217        1
[INPUT] 1    0    [1    /1   ]  0.266221850453       1
[INPUT] 1    0    [1    /1   ]  2.43900790157        1
[INPUT] 1    0    [1    /1   ]  0.83371505422        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7670411046638818, 1.0]], [0, [24413.794201173274, 1.0]], [0, [3661.4507831726137, 1.0]], [0, [833.3353188619899, 1.0]], [0, [235.27655922052676, 1.0]], [0, [76.53420603015094, 1.0]], [0, [11.475988019556087, 1.0]], [0, [28.194664355755915, 1.0]], [0, [0.2955153636531971, 1.0]], [0, [1.9450109557807573, 1.0]], [0, [5.028497493839571, 1.0]], [1, [7.1038078890030985, 1.0]], [1, [23.176787465391044, 1.0]], [1, [99.78498332172515, 1.0]], [1, [0.26622185045264507, 1.0]], [1, [2.4390079015690858, 1.0]], [1, [0.8337150542203376, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7670411]
bas 1, expnt(s) = [24413.79420117]
bas 2, expnt(s) = [3661.45078317]
bas 3, expnt(s) = [833.33531886]
bas 4, expnt(s) = [235.27655922]
bas 5, expnt(s) = [76.53420603]
bas 6, expnt(s) = [11.47598802]
bas 7, expnt(s) = [28.19466436]
bas 8, expnt(s) = [0.29551536]
bas 9, expnt(s) = [1.94501096]
bas 10, expnt(s) = [5.02849749]
bas 11, expnt(s) = [7.10380789]
bas 12, expnt(s) = [23.17678747]
bas 13, expnt(s) = [99.78498332]
bas 14, expnt(s) = [0.26622185]
bas 15, expnt(s) = [2.4390079]
bas 16, expnt(s) = [0.83371505]
CPU time:       327.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.67041105e-01 2.07075635e+00 2.44137942e+04 4.93448103e+03
 3.66145078e+03 1.18920007e+03 8.33335319e+02 3.91859036e+02
 2.35276559e+02 1.51774573e+02 7.65342060e+01 6.53742486e+01
 1.14759880e+01 1.57527938e+01 2.81946644e+01 3.09129336e+01
 2.95515364e-01 1.01262833e+00 1.94501096e+00 4.16108477e+00
 5.02849749e+00 8.48386409e+00 7.10380789e+00 3.38336150e+01
 2.31767875e+01 1.48354574e+02 9.97849833e+01 9.20059426e+02
 2.66221850e-01 5.57877717e-01 2.43900790e+00 8.89202964e+00
 8.33715054e-01 2.32410876e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640090457433
cond(S) = 1213.0697993103604
E1 = -183.59044963985602  E_coul = 55.08016587550463
init E= -128.510283764351
    CPU time for initialize scf      0.05 sec, wall time      0.06 sec
  HOMO = -0.775403789816015  LUMO = 0.770367479296836
  mo_energy =
[-3.25552184e+01 -1.85274479e+00 -7.75403790e-01 -7.75403790e-01
 -7.75403790e-01  7.70367479e-01  8.24333477e-01  8.24333477e-01
  8.24333477e-01  3.95522020e+00  3.95522020e+00  3.95522020e+00
  4.30402551e+00  1.43427885e+01  1.43427885e+01  1.43427885e+01
  1.58778351e+01  5.13663656e+01  5.29753491e+01  5.29753491e+01
  5.29753491e+01  1.60838722e+02  2.40813906e+02  2.40813906e+02
  2.40813906e+02  5.25707323e+02  1.89110813e+03  8.01817256e+03
  4.77827462e+04]
E1 = -182.08615774872814  E_coul = 53.54773444103847
cycle= 1 E= -128.53842330769  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519741
diis-c [-0.27013102  1.        ]
  HOMO = -0.884319316496279  LUMO = 0.742154390860615
  mo_energy =
[-3.28784106e+01 -1.96663201e+00 -8.84319316e-01 -8.84319316e-01
 -8.84319316e-01  7.42154391e-01  7.97551233e-01  7.97551233e-01
  7.97551233e-01  3.85781549e+00  3.85781549e+00  3.85781549e+00
  4.21894586e+00  1.41521447e+01  1.41521447e+01  1.41521447e+01
  1.57063812e+01  5.11102546e+01  5.26943946e+01  5.26943946e+01
  5.26943946e+01  1.60521382e+02  2.40467554e+02  2.40467554e+02
  2.40467554e+02  5.25346434e+02  1.89071073e+03  8.01774590e+03
  4.77823006e+04]
E1 = -182.84760891513275  E_coul = 54.30659805949712
cycle= 2 E= -128.541010855636  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264367
diis-c [-0.00072637  0.33629027  0.66370973]
  HOMO = -0.848701192645487  LUMO = 0.751175193557836
  mo_energy =
[-3.27703388e+01 -1.92912727e+00 -8.48701193e-01 -8.48701193e-01
 -8.48701193e-01  7.51175194e-01  8.06281061e-01  8.06281061e-01
  8.06281061e-01  3.88940549e+00  3.88940549e+00  3.88940549e+00
  4.24651265e+00  1.42152794e+01  1.42152794e+01  1.42152794e+01
  1.57630036e+01  5.11960526e+01  5.27883895e+01  5.27883895e+01
  5.27883895e+01  1.60627176e+02  2.40581199e+02  2.40581199e+02
  2.40581199e+02  5.25463013e+02  1.89083272e+03  8.01787038e+03
  4.77824260e+04]
E1 = -182.5890181477376  E_coul = 54.04708721224303
cycle= 3 E= -128.541930935495  delta_E= -0.00092  |g|= 0.000497  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0010911
diis-c [-1.97465011e-07 -2.39094517e-03 -9.32351416e-04  1.00332330e+00]
  HOMO = -0.84895232430952  LUMO = 0.751125453672752
  mo_energy =
[-3.27707745e+01 -1.92931286e+00 -8.48952324e-01 -8.48952324e-01
 -8.48952324e-01  7.51125454e-01  8.06242658e-01  8.06242658e-01
  8.06242658e-01  3.88923326e+00  3.88923326e+00  3.88923326e+00
  4.24636920e+00  1.42149860e+01  1.42149860e+01  1.42149860e+01
  1.57627398e+01  5.11957004e+01  5.27880043e+01  5.27880043e+01
  5.27880043e+01  1.60626736e+02  2.40580693e+02  2.40580693e+02
  2.40580693e+02  5.25462452e+02  1.89083202e+03  8.01786959e+03
  4.77824252e+04]
E1 = -182.5894076735424  E_coul = 54.04747671269193
cycle= 4 E= -128.54193096085  delta_E= -2.54e-08  |g|= 8.07e-05  |ddm|= 0.00034
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187508
diis-c [-1.13807480e-09  2.35210161e-04  5.32354556e-04 -1.86057358e-01
  1.18528979e+00]
  HOMO = -0.848995762074779  LUMO = 0.751112661660017
  mo_energy =
[-3.27708481e+01 -1.92934553e+00 -8.48995762e-01 -8.48995762e-01
 -8.48995762e-01  7.51112662e-01  8.06229155e-01  8.06229155e-01
  8.06229155e-01  3.88919281e+00  3.88919281e+00  3.88919281e+00
  4.24633650e+00  1.42149262e+01  1.42149262e+01  1.42149262e+01
  1.57626847e+01  5.11956333e+01  5.27879348e+01  5.27879348e+01
  5.27879348e+01  1.60626662e+02  2.40580615e+02  2.40580615e+02
  2.40580615e+02  5.25462370e+02  1.89083193e+03  8.01786949e+03
  4.77824251e+04]
E1 = -182.58954136087834  E_coul = 54.04761039929612
cycle= 5 E= -128.541930961582  delta_E= -7.32e-10  |g|= 6.02e-06  |ddm|= 5.74e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58954136087834  E_coul = 54.04761039929612
  HOMO = -0.848992594915386  LUMO = 0.751113974920232
  mo_energy =
[-3.27708409e+01 -1.92934156e+00 -8.48992595e-01 -8.48992595e-01
 -8.48992595e-01  7.51113975e-01  8.06230087e-01  8.06230087e-01
  8.06230087e-01  3.88919584e+00  3.88919584e+00  3.88919584e+00
  4.24633953e+00  1.42149314e+01  1.42149314e+01  1.42149314e+01
  1.57626897e+01  5.11956398e+01  5.27879415e+01  5.27879415e+01
  5.27879415e+01  1.60626669e+02  2.40580622e+02  2.40580622e+02
  2.40580622e+02  5.25462376e+02  1.89083194e+03  8.01786950e+03
  4.77824251e+04]
E1 = -182.58952519983137  E_coul = 54.04759423824661
Extra cycle  E= -128.541930961585  delta_E= -2.53e-12  |g|= 2.27e-06  |ddm|= 2.2e-06
    CPU time for scf_cycle      0.17 sec, wall time      0.17 sec
exp = [7.67041105e-01 2.44137942e+04 3.66145078e+03 8.33335319e+02
 2.35276559e+02 7.65342060e+01 1.14759880e+01 2.81946644e+01
 2.95515364e-01 1.94501096e+00 5.02849749e+00 7.10380789e+00
 2.31767875e+01 9.97849833e+01 2.66221850e-01 2.43900790e+00
 8.33715054e-01]
E = -128.54193096158477
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.767041104664       1
[INPUT] 0    0    [1    /1   ]  24413.7942012        1
[INPUT] 0    0    [1    /1   ]  3661.45078317        1
[INPUT] 0    0    [1    /1   ]  833.335318862        1
[INPUT] 0    0    [1    /1   ]  235.276559221        1
[INPUT] 0    0    [1    /1   ]  76.5342060302        1
[INPUT] 0    0    [1    /1   ]  11.4759880196        1
[INPUT] 0    0    [1    /1   ]  28.1946643558        1
[INPUT] 0    0    [1    /1   ]  0.295515363653       1
[INPUT] 0    0    [1    /1   ]  1.94501095578        1
[INPUT] 0    0    [1    /1   ]  5.02849749384        1
[INPUT] 1    0    [1    /1   ]  7.103807889          1
[INPUT] 1    0    [1    /1   ]  23.1767874654        1
[INPUT] 1    0    [1    /1   ]  99.7849833217        1
[INPUT] 1    0    [1    /1   ]  0.266221850453       1
[INPUT] 1    0    [1    /1   ]  2.43900790157        1
[INPUT] 1    0    [1    /1   ]  0.83371505422        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7670411046638818, 1.0]], [0, [24413.794201173274, 1.0]], [0, [3661.4507831726137, 1.0]], [0, [833.3353188619899, 1.0]], [0, [235.27655922052676, 1.0]], [0, [76.53420603015094, 1.0]], [0, [11.475988019556087, 1.0]], [0, [28.194664355755915, 1.0]], [0, [0.2955153636531971, 1.0]], [0, [1.9450109557807573, 1.0]], [0, [5.028497493839571, 1.0]], [1, [7.1038078890030985, 1.0]], [1, [23.176787465391044, 1.0]], [1, [99.78498332172515, 1.0]], [1, [0.26622185045264507, 1.0]], [1, [2.4390079015690858, 1.0]], [1, [0.8337150542203376, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.7670411]
bas 1, expnt(s) = [24413.79420117]
bas 2, expnt(s) = [3661.45078317]
bas 3, expnt(s) = [833.33531886]
bas 4, expnt(s) = [235.27655922]
bas 5, expnt(s) = [76.53420603]
bas 6, expnt(s) = [11.47598802]
bas 7, expnt(s) = [28.19466436]
bas 8, expnt(s) = [0.29551536]
bas 9, expnt(s) = [1.94501096]
bas 10, expnt(s) = [5.02849749]
bas 11, expnt(s) = [7.10380789]
bas 12, expnt(s) = [23.17678747]
bas 13, expnt(s) = [99.78498332]
bas 14, expnt(s) = [0.26622185]
bas 15, expnt(s) = [2.4390079]
bas 16, expnt(s) = [0.83371505]
CPU time:       328.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.67041105e-01 2.07075635e+00 2.44137942e+04 4.93448103e+03
 3.66145078e+03 1.18920007e+03 8.33335319e+02 3.91859036e+02
 2.35276559e+02 1.51774573e+02 7.65342060e+01 6.53742486e+01
 1.14759880e+01 1.57527938e+01 2.81946644e+01 3.09129336e+01
 2.95515364e-01 1.01262833e+00 1.94501096e+00 4.16108477e+00
 5.02849749e+00 8.48386409e+00 7.10380789e+00 3.38336150e+01
 2.31767875e+01 1.48354574e+02 9.97849833e+01 9.20059426e+02
 2.66221850e-01 5.57877717e-01 2.43900790e+00 8.89202964e+00
 8.33715054e-01 2.32410876e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640090457433
cond(S) = 1213.0697993103604
E1 = -183.59044963985602  E_coul = 55.08016587550463
init E= -128.510283764351
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775403789816015  LUMO = 0.770367479296836
  mo_energy =
[-3.25552184e+01 -1.85274479e+00 -7.75403790e-01 -7.75403790e-01
 -7.75403790e-01  7.70367479e-01  8.24333477e-01  8.24333477e-01
  8.24333477e-01  3.95522020e+00  3.95522020e+00  3.95522020e+00
  4.30402551e+00  1.43427885e+01  1.43427885e+01  1.43427885e+01
  1.58778351e+01  5.13663656e+01  5.29753491e+01  5.29753491e+01
  5.29753491e+01  1.60838722e+02  2.40813906e+02  2.40813906e+02
  2.40813906e+02  5.25707323e+02  1.89110813e+03  8.01817256e+03
  4.77827462e+04]
E1 = -182.08615774872814  E_coul = 53.54773444103847
cycle= 1 E= -128.53842330769  delta_E= -0.0281  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519741
diis-c [-0.27013102  1.        ]
  HOMO = -0.884319316496279  LUMO = 0.742154390860615
  mo_energy =
[-3.28784106e+01 -1.96663201e+00 -8.84319316e-01 -8.84319316e-01
 -8.84319316e-01  7.42154391e-01  7.97551233e-01  7.97551233e-01
  7.97551233e-01  3.85781549e+00  3.85781549e+00  3.85781549e+00
  4.21894586e+00  1.41521447e+01  1.41521447e+01  1.41521447e+01
  1.57063812e+01  5.11102546e+01  5.26943946e+01  5.26943946e+01
  5.26943946e+01  1.60521382e+02  2.40467554e+02  2.40467554e+02
  2.40467554e+02  5.25346434e+02  1.89071073e+03  8.01774590e+03
  4.77823006e+04]
E1 = -182.84760891513275  E_coul = 54.30659805949712
cycle= 2 E= -128.541010855636  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264367
diis-c [-0.00072637  0.33629027  0.66370973]
  HOMO = -0.848701192645487  LUMO = 0.751175193557836
  mo_energy =
[-3.27703388e+01 -1.92912727e+00 -8.48701193e-01 -8.48701193e-01
 -8.48701193e-01  7.51175194e-01  8.06281061e-01  8.06281061e-01
  8.06281061e-01  3.88940549e+00  3.88940549e+00  3.88940549e+00
  4.24651265e+00  1.42152794e+01  1.42152794e+01  1.42152794e+01
  1.57630036e+01  5.11960526e+01  5.27883895e+01  5.27883895e+01
  5.27883895e+01  1.60627176e+02  2.40581199e+02  2.40581199e+02
  2.40581199e+02  5.25463013e+02  1.89083272e+03  8.01787038e+03
  4.77824260e+04]
E1 = -182.5890181477376  E_coul = 54.04708721224303
cycle= 3 E= -128.541930935495  delta_E= -0.00092  |g|= 0.000497  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.0010911
diis-c [-1.97465011e-07 -2.39094517e-03 -9.32351416e-04  1.00332330e+00]
  HOMO = -0.84895232430952  LUMO = 0.751125453672752
  mo_energy =
[-3.27707745e+01 -1.92931286e+00 -8.48952324e-01 -8.48952324e-01
 -8.48952324e-01  7.51125454e-01  8.06242658e-01  8.06242658e-01
  8.06242658e-01  3.88923326e+00  3.88923326e+00  3.88923326e+00
  4.24636920e+00  1.42149860e+01  1.42149860e+01  1.42149860e+01
  1.57627398e+01  5.11957004e+01  5.27880043e+01  5.27880043e+01
  5.27880043e+01  1.60626736e+02  2.40580693e+02  2.40580693e+02
  2.40580693e+02  5.25462452e+02  1.89083202e+03  8.01786959e+03
  4.77824252e+04]
E1 = -182.5894076735424  E_coul = 54.04747671269193
cycle= 4 E= -128.54193096085  delta_E= -2.54e-08  |g|= 8.07e-05  |ddm|= 0.00034
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187508
diis-c [-1.13807480e-09  2.35210161e-04  5.32354556e-04 -1.86057358e-01
  1.18528979e+00]
  HOMO = -0.848995762074779  LUMO = 0.751112661660017
  mo_energy =
[-3.27708481e+01 -1.92934553e+00 -8.48995762e-01 -8.48995762e-01
 -8.48995762e-01  7.51112662e-01  8.06229155e-01  8.06229155e-01
  8.06229155e-01  3.88919281e+00  3.88919281e+00  3.88919281e+00
  4.24633650e+00  1.42149262e+01  1.42149262e+01  1.42149262e+01
  1.57626847e+01  5.11956333e+01  5.27879348e+01  5.27879348e+01
  5.27879348e+01  1.60626662e+02  2.40580615e+02  2.40580615e+02
  2.40580615e+02  5.25462370e+02  1.89083193e+03  8.01786949e+03
  4.77824251e+04]
E1 = -182.58954136087834  E_coul = 54.04761039929612
cycle= 5 E= -128.541930961582  delta_E= -7.32e-10  |g|= 6.02e-06  |ddm|= 5.74e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58954136087834  E_coul = 54.04761039929612
  HOMO = -0.848992594915386  LUMO = 0.751113974920232
  mo_energy =
[-3.27708409e+01 -1.92934156e+00 -8.48992595e-01 -8.48992595e-01
 -8.48992595e-01  7.51113975e-01  8.06230087e-01  8.06230087e-01
  8.06230087e-01  3.88919584e+00  3.88919584e+00  3.88919584e+00
  4.24633953e+00  1.42149314e+01  1.42149314e+01  1.42149314e+01
  1.57626897e+01  5.11956398e+01  5.27879415e+01  5.27879415e+01
  5.27879415e+01  1.60626669e+02  2.40580622e+02  2.40580622e+02
  2.40580622e+02  5.25462376e+02  1.89083194e+03  8.01786950e+03
  4.77824251e+04]
E1 = -182.58952519983137  E_coul = 54.04759423824661
Extra cycle  E= -128.541930961585  delta_E= -2.53e-12  |g|= 2.27e-06  |ddm|= 2.2e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1213.0697993103604
E1 = -182.58952519983137  E_coul = 54.04759423824661
init E= -128.541930961585
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.848993738119841  LUMO = 0.751113767507187
  mo_energy =
[-3.27708445e+01 -1.92934262e+00 -8.48993738e-01 -8.48993738e-01
 -8.48993738e-01  7.51113768e-01  8.06229825e-01  8.06229825e-01
  8.06229825e-01  3.88919485e+00  3.88919485e+00  3.88919485e+00
  4.24633874e+00  1.42149294e+01  1.42149294e+01  1.42149294e+01
  1.57626880e+01  5.11956370e+01  5.27879384e+01  5.27879384e+01
  5.27879384e+01  1.60626665e+02  2.40580618e+02  2.40580618e+02
  2.40580618e+02  5.25462372e+02  1.89083193e+03  8.01786949e+03
  4.77824251e+04]
E1 = -182.58953417732332  E_coul = 54.04760321573836
cycle= 1 E= -128.541930961585  delta_E= -1.99e-13  |g|= 1.23e-06  |ddm|= 8.14e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.58953417732332  E_coul = 54.04760321573836
  HOMO = -0.848993106104952  LUMO = 0.751113944033115
  mo_energy =
[-3.27708426e+01 -1.92934192e+00 -8.48993106e-01 -8.48993106e-01
 -8.48993106e-01  7.51113944e-01  8.06229984e-01  8.06229984e-01
  8.06229984e-01  3.88919542e+00  3.88919542e+00  3.88919542e+00
  4.24633925e+00  1.42149305e+01  1.42149305e+01  1.42149305e+01
  1.57626890e+01  5.11956385e+01  5.27879400e+01  5.27879400e+01
  5.27879400e+01  1.60626667e+02  2.40580620e+02  2.40580620e+02
  2.40580620e+02  5.25462375e+02  1.89083193e+03  8.01786949e+03
  4.77824251e+04]
E1 = -182.5895296651454  E_coul = 54.047598703560304
Extra cycle  E= -128.541930961585  delta_E= -1.14e-13  |g|= 6.13e-07  |ddm|= 4.03e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [7.67041105e-01 2.44137942e+04 3.66145078e+03 8.33335319e+02
 2.35276559e+02 7.65342060e+01 1.14759880e+01 2.81946644e+01
 2.95515364e-01 1.94501096e+00 5.02849749e+00 7.10380789e+00
 2.31767875e+01 9.97849833e+01 2.66221850e-01 2.43900790e+00
 8.33715054e-01]
grad_E = [-9.66040176e-05 -6.49453638e-10  3.59927380e-08 -8.38761141e-07
  1.12552345e-05 -5.74827677e-05 -1.09558725e-04  2.22319919e-05
 -2.76670927e-05  3.69019121e-05  6.19427010e-05 -9.49620934e-05
  1.98099246e-05 -9.13327899e-07  5.04561445e-04  1.25479608e-04
 -1.36388164e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.768374368016       1
[INPUT] 0    0    [1    /1   ]  24413.7942042        1
[INPUT] 0    0    [1    /1   ]  3661.45062364        1
[INPUT] 0    0    [1    /1   ]  833.338588606        1
[INPUT] 0    0    [1    /1   ]  235.240086773        1
[INPUT] 0    0    [1    /1   ]  76.6890314212        1
[INPUT] 0    0    [1    /1   ]  11.4260780511        1
[INPUT] 0    0    [1    /1   ]  28.2061264307        1
[INPUT] 0    0    [1    /1   ]  0.297335789148       1
[INPUT] 0    0    [1    /1   ]  1.94230207584        1
[INPUT] 0    0    [1    /1   ]  4.98827355152        1
[INPUT] 1    0    [1    /1   ]  7.11133605886        1
[INPUT] 1    0    [1    /1   ]  23.1740690338        1
[INPUT] 1    0    [1    /1   ]  99.7851027547        1
[INPUT] 1    0    [1    /1   ]  0.265949392445       1
[INPUT] 1    0    [1    /1   ]  2.44099622575        1
[INPUT] 1    0    [1    /1   ]  0.833793609411       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.768374368015924, 1.0]], [0, [24413.794204164624, 1.0]], [0, [3661.45062364154, 1.0]], [0, [833.3385886056201, 1.0]], [0, [235.2400867727282, 1.0]], [0, [76.68903142123823, 1.0]], [0, [11.426078051114997, 1.0]], [0, [28.20612643073289, 1.0]], [0, [0.2973357891479709, 1.0]], [0, [1.9423020758441198, 1.0]], [0, [4.988273551518844, 1.0]], [1, [7.1113360588568515, 1.0]], [1, [23.17406903380822, 1.0]], [1, [99.78510275466401, 1.0]], [1, [0.2659493924452397, 1.0]], [1, [2.4409962257466407, 1.0]], [1, [0.8337936094105286, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76837437]
bas 1, expnt(s) = [24413.79420416]
bas 2, expnt(s) = [3661.45062364]
bas 3, expnt(s) = [833.33858861]
bas 4, expnt(s) = [235.24008677]
bas 5, expnt(s) = [76.68903142]
bas 6, expnt(s) = [11.42607805]
bas 7, expnt(s) = [28.20612643]
bas 8, expnt(s) = [0.29733579]
bas 9, expnt(s) = [1.94230208]
bas 10, expnt(s) = [4.98827355]
bas 11, expnt(s) = [7.11133606]
bas 12, expnt(s) = [23.17406903]
bas 13, expnt(s) = [99.78510275]
bas 14, expnt(s) = [0.26594939]
bas 15, expnt(s) = [2.44099623]
bas 16, expnt(s) = [0.83379361]
CPU time:       332.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.68374368e-01 2.07345529e+00 2.44137942e+04 4.93448103e+03
 3.66145062e+03 1.18920003e+03 8.33338589e+02 3.91860189e+02
 2.35240087e+02 1.51756927e+02 7.66890314e+01 6.54734105e+01
 1.14260781e+01 1.57013832e+01 2.82061264e+01 3.09223585e+01
 2.97335789e-01 1.01730321e+00 1.94230208e+00 4.15673755e+00
 4.98827355e+00 8.43291495e+00 7.11133606e+00 3.38784393e+01
 2.31740690e+01 1.48332823e+02 9.97851028e+01 9.20060802e+02
 2.65949392e-01 5.57164126e-01 2.44099623e+00 8.90109175e+00
 8.33793609e-01 2.32438249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640722630248
cond(S) = 1209.9824124756017
E1 = -183.59041028156548  E_coul = 55.080159974045124
init E= -128.51025030752
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775404791993103  LUMO = 0.774442587448842
  mo_energy =
[-3.25552200e+01 -1.85274653e+00 -7.75404792e-01 -7.75404792e-01
 -7.75404792e-01  7.74442587e-01  8.23640945e-01  8.23640945e-01
  8.23640945e-01  3.95540435e+00  3.95540435e+00  3.95540435e+00
  4.30871907e+00  1.43537909e+01  1.43537909e+01  1.43537909e+01
  1.58218831e+01  5.11607156e+01  5.30004303e+01  5.30004303e+01
  5.30004303e+01  1.60639134e+02  2.40833217e+02  2.40833217e+02
  2.40833217e+02  5.25764541e+02  1.89128466e+03  8.01834701e+03
  4.77828942e+04]
E1 = -182.0857981091935  E_coul = 53.54737085698969
cycle= 1 E= -128.538427252204  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519845
diis-c [-0.27023835  1.        ]
  HOMO = -0.884349390750515  LUMO = 0.74610098691052
  mo_energy =
[-3.28784667e+01 -1.96667053e+00 -8.84349391e-01 -8.84349391e-01
 -8.84349391e-01  7.46100987e-01  7.96863319e-01  7.96863319e-01
  7.96863319e-01  3.85791883e+00  3.85791883e+00  3.85791883e+00
  4.22377261e+00  1.41630104e+01  1.41630104e+01  1.41630104e+01
  1.56509004e+01  5.09047812e+01  5.27194161e+01  5.27194161e+01
  5.27194161e+01  1.60321703e+02  2.40486815e+02  2.40486815e+02
  2.40486815e+02  5.25403575e+02  1.89088721e+03  8.01792030e+03
  4.77824486e+04]
E1 = -182.84745497253306  E_coul = 54.30643936460885
cycle= 2 E= -128.541015607924  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264438
diis-c [-0.00072514  0.33630754  0.66369246]
  HOMO = -0.848722181942067  LUMO = 0.75516031763033
  mo_energy =
[-3.27703704e+01 -1.92915593e+00 -8.48722182e-01 -8.48722182e-01
 -8.48722182e-01  7.55160318e-01  8.05590597e-01  8.05590597e-01
  8.05590597e-01  3.88953329e+00  3.88953329e+00  3.88953329e+00
  4.25129368e+00  1.42261922e+01  1.42261922e+01  1.42261922e+01
  1.57073609e+01  5.09905208e+01  5.28134348e+01  5.28134348e+01
  5.28134348e+01  1.60427531e+02  2.40600484e+02  2.40600484e+02
  2.40600484e+02  5.25520186e+02  1.89100922e+03  8.01804481e+03
  4.77825740e+04]
E1 = -182.58876800233955  E_coul = 54.04683176085745
cycle= 3 E= -128.541936241482  delta_E= -0.000921  |g|= 0.000498  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109296
diis-c [-1.95523502e-07 -2.39009209e-03 -9.19727285e-04  1.00330982e+00]
  HOMO = -0.848974131800622  LUMO = 0.755109721260046
  mo_energy =
[-3.27708078e+01 -1.92934300e+00 -8.48974132e-01 -8.48974132e-01
 -8.48974132e-01  7.55109721e-01  8.05551906e-01  8.05551906e-01
  8.05551906e-01  3.88936004e+00  3.88936004e+00  3.88936004e+00
  4.25114945e+00  1.42258974e+01  1.42258974e+01  1.42258974e+01
  1.57070964e+01  5.09901673e+01  5.28130479e+01  5.28130479e+01
  5.28130479e+01  1.60427089e+02  2.40599976e+02  2.40599976e+02
  2.40599976e+02  5.25519623e+02  1.89100852e+03  8.01804401e+03
  4.77825732e+04]
E1 = -182.5891597154324  E_coul = 54.04722344864985
cycle= 4 E= -128.541936266783  delta_E= -2.53e-08  |g|= 8.06e-05  |ddm|= 0.00034
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187117
diis-c [-1.12304514e-09  2.32436433e-04  5.28695090e-04 -1.84668041e-01
  1.18390691e+00]
  HOMO = -0.849017578732128  LUMO = 0.755096784645961
  mo_energy =
[-3.27708814e+01 -1.92937587e+00 -8.49017579e-01 -8.49017579e-01
 -8.49017579e-01  7.55096785e-01  8.05538393e-01  8.05538393e-01
  8.05538393e-01  3.88931952e+00  3.88931952e+00  3.88931952e+00
  4.25111669e+00  1.42258375e+01  1.42258375e+01  1.42258375e+01
  1.57070413e+01  5.09901003e+01  5.28129783e+01  5.28129783e+01
  5.28129783e+01  1.60427015e+02  2.40599898e+02  2.40599898e+02
  2.40599898e+02  5.25519541e+02  1.89100843e+03  8.01804392e+03
  4.77825731e+04]
E1 = -182.58929324580177  E_coul = 54.047356978294815
cycle= 5 E= -128.541936267507  delta_E= -7.24e-10  |g|= 5.96e-06  |ddm|= 5.72e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58929324580177  E_coul = 54.047356978294815
  HOMO = -0.849014452155372  LUMO = 0.755098086052776
  mo_energy =
[-3.27708743e+01 -1.92937194e+00 -8.49014452e-01 -8.49014452e-01
 -8.49014452e-01  7.55098086e-01  8.05539311e-01  8.05539311e-01
  8.05539311e-01  3.88932251e+00  3.88932251e+00  3.88932251e+00
  4.25111967e+00  1.42258426e+01  1.42258426e+01  1.42258426e+01
  1.57070462e+01  5.09901066e+01  5.28129850e+01  5.28129850e+01
  5.28129850e+01  1.60427022e+02  2.40599905e+02  2.40599905e+02
  2.40599905e+02  5.25519547e+02  1.89100844e+03  8.01804392e+03
  4.77825731e+04]
E1 = -182.58927722731536  E_coul = 54.04734095980592
Extra cycle  E= -128.541936267509  delta_E= -2.47e-12  |g|= 2.25e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.68374368e-01 2.44137942e+04 3.66145062e+03 8.33338589e+02
 2.35240087e+02 7.66890314e+01 1.14260781e+01 2.82061264e+01
 2.97335789e-01 1.94230208e+00 4.98827355e+00 7.11133606e+00
 2.31740690e+01 9.97851028e+01 2.65949392e-01 2.44099623e+00
 8.33793609e-01]
E = -128.54193626750944
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.768374368016       1
[INPUT] 0    0    [1    /1   ]  24413.7942042        1
[INPUT] 0    0    [1    /1   ]  3661.45062364        1
[INPUT] 0    0    [1    /1   ]  833.338588606        1
[INPUT] 0    0    [1    /1   ]  235.240086773        1
[INPUT] 0    0    [1    /1   ]  76.6890314212        1
[INPUT] 0    0    [1    /1   ]  11.4260780511        1
[INPUT] 0    0    [1    /1   ]  28.2061264307        1
[INPUT] 0    0    [1    /1   ]  0.297335789148       1
[INPUT] 0    0    [1    /1   ]  1.94230207584        1
[INPUT] 0    0    [1    /1   ]  4.98827355152        1
[INPUT] 1    0    [1    /1   ]  7.11133605886        1
[INPUT] 1    0    [1    /1   ]  23.1740690338        1
[INPUT] 1    0    [1    /1   ]  99.7851027547        1
[INPUT] 1    0    [1    /1   ]  0.265949392445       1
[INPUT] 1    0    [1    /1   ]  2.44099622575        1
[INPUT] 1    0    [1    /1   ]  0.833793609411       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.768374368015924, 1.0]], [0, [24413.794204164624, 1.0]], [0, [3661.45062364154, 1.0]], [0, [833.3385886056201, 1.0]], [0, [235.2400867727282, 1.0]], [0, [76.68903142123823, 1.0]], [0, [11.426078051114997, 1.0]], [0, [28.20612643073289, 1.0]], [0, [0.2973357891479709, 1.0]], [0, [1.9423020758441198, 1.0]], [0, [4.988273551518844, 1.0]], [1, [7.1113360588568515, 1.0]], [1, [23.17406903380822, 1.0]], [1, [99.78510275466401, 1.0]], [1, [0.2659493924452397, 1.0]], [1, [2.4409962257466407, 1.0]], [1, [0.8337936094105286, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.76837437]
bas 1, expnt(s) = [24413.79420416]
bas 2, expnt(s) = [3661.45062364]
bas 3, expnt(s) = [833.33858861]
bas 4, expnt(s) = [235.24008677]
bas 5, expnt(s) = [76.68903142]
bas 6, expnt(s) = [11.42607805]
bas 7, expnt(s) = [28.20612643]
bas 8, expnt(s) = [0.29733579]
bas 9, expnt(s) = [1.94230208]
bas 10, expnt(s) = [4.98827355]
bas 11, expnt(s) = [7.11133606]
bas 12, expnt(s) = [23.17406903]
bas 13, expnt(s) = [99.78510275]
bas 14, expnt(s) = [0.26594939]
bas 15, expnt(s) = [2.44099623]
bas 16, expnt(s) = [0.83379361]
CPU time:       333.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.68374368e-01 2.07345529e+00 2.44137942e+04 4.93448103e+03
 3.66145062e+03 1.18920003e+03 8.33338589e+02 3.91860189e+02
 2.35240087e+02 1.51756927e+02 7.66890314e+01 6.54734105e+01
 1.14260781e+01 1.57013832e+01 2.82061264e+01 3.09223585e+01
 2.97335789e-01 1.01730321e+00 1.94230208e+00 4.15673755e+00
 4.98827355e+00 8.43291495e+00 7.11133606e+00 3.38784393e+01
 2.31740690e+01 1.48332823e+02 9.97851028e+01 9.20060802e+02
 2.65949392e-01 5.57164126e-01 2.44099623e+00 8.90109175e+00
 8.33793609e-01 2.32438249e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640722630248
cond(S) = 1209.9824124756017
E1 = -183.59041028156548  E_coul = 55.080159974045124
init E= -128.51025030752
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775404791993103  LUMO = 0.774442587448842
  mo_energy =
[-3.25552200e+01 -1.85274653e+00 -7.75404792e-01 -7.75404792e-01
 -7.75404792e-01  7.74442587e-01  8.23640945e-01  8.23640945e-01
  8.23640945e-01  3.95540435e+00  3.95540435e+00  3.95540435e+00
  4.30871907e+00  1.43537909e+01  1.43537909e+01  1.43537909e+01
  1.58218831e+01  5.11607156e+01  5.30004303e+01  5.30004303e+01
  5.30004303e+01  1.60639134e+02  2.40833217e+02  2.40833217e+02
  2.40833217e+02  5.25764541e+02  1.89128466e+03  8.01834701e+03
  4.77828942e+04]
E1 = -182.0857981091935  E_coul = 53.54737085698969
cycle= 1 E= -128.538427252204  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519845
diis-c [-0.27023835  1.        ]
  HOMO = -0.884349390750515  LUMO = 0.74610098691052
  mo_energy =
[-3.28784667e+01 -1.96667053e+00 -8.84349391e-01 -8.84349391e-01
 -8.84349391e-01  7.46100987e-01  7.96863319e-01  7.96863319e-01
  7.96863319e-01  3.85791883e+00  3.85791883e+00  3.85791883e+00
  4.22377261e+00  1.41630104e+01  1.41630104e+01  1.41630104e+01
  1.56509004e+01  5.09047812e+01  5.27194161e+01  5.27194161e+01
  5.27194161e+01  1.60321703e+02  2.40486815e+02  2.40486815e+02
  2.40486815e+02  5.25403575e+02  1.89088721e+03  8.01792030e+03
  4.77824486e+04]
E1 = -182.84745497253306  E_coul = 54.30643936460885
cycle= 2 E= -128.541015607924  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264438
diis-c [-0.00072514  0.33630754  0.66369246]
  HOMO = -0.848722181942067  LUMO = 0.75516031763033
  mo_energy =
[-3.27703704e+01 -1.92915593e+00 -8.48722182e-01 -8.48722182e-01
 -8.48722182e-01  7.55160318e-01  8.05590597e-01  8.05590597e-01
  8.05590597e-01  3.88953329e+00  3.88953329e+00  3.88953329e+00
  4.25129368e+00  1.42261922e+01  1.42261922e+01  1.42261922e+01
  1.57073609e+01  5.09905208e+01  5.28134348e+01  5.28134348e+01
  5.28134348e+01  1.60427531e+02  2.40600484e+02  2.40600484e+02
  2.40600484e+02  5.25520186e+02  1.89100922e+03  8.01804481e+03
  4.77825740e+04]
E1 = -182.58876800233955  E_coul = 54.04683176085745
cycle= 3 E= -128.541936241482  delta_E= -0.000921  |g|= 0.000498  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109296
diis-c [-1.95523502e-07 -2.39009209e-03 -9.19727285e-04  1.00330982e+00]
  HOMO = -0.848974131800622  LUMO = 0.755109721260046
  mo_energy =
[-3.27708078e+01 -1.92934300e+00 -8.48974132e-01 -8.48974132e-01
 -8.48974132e-01  7.55109721e-01  8.05551906e-01  8.05551906e-01
  8.05551906e-01  3.88936004e+00  3.88936004e+00  3.88936004e+00
  4.25114945e+00  1.42258974e+01  1.42258974e+01  1.42258974e+01
  1.57070964e+01  5.09901673e+01  5.28130479e+01  5.28130479e+01
  5.28130479e+01  1.60427089e+02  2.40599976e+02  2.40599976e+02
  2.40599976e+02  5.25519623e+02  1.89100852e+03  8.01804401e+03
  4.77825732e+04]
E1 = -182.5891597154324  E_coul = 54.04722344864985
cycle= 4 E= -128.541936266783  delta_E= -2.53e-08  |g|= 8.06e-05  |ddm|= 0.00034
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187117
diis-c [-1.12304514e-09  2.32436433e-04  5.28695090e-04 -1.84668041e-01
  1.18390691e+00]
  HOMO = -0.849017578732128  LUMO = 0.755096784645961
  mo_energy =
[-3.27708814e+01 -1.92937587e+00 -8.49017579e-01 -8.49017579e-01
 -8.49017579e-01  7.55096785e-01  8.05538393e-01  8.05538393e-01
  8.05538393e-01  3.88931952e+00  3.88931952e+00  3.88931952e+00
  4.25111669e+00  1.42258375e+01  1.42258375e+01  1.42258375e+01
  1.57070413e+01  5.09901003e+01  5.28129783e+01  5.28129783e+01
  5.28129783e+01  1.60427015e+02  2.40599898e+02  2.40599898e+02
  2.40599898e+02  5.25519541e+02  1.89100843e+03  8.01804392e+03
  4.77825731e+04]
E1 = -182.58929324580177  E_coul = 54.047356978294815
cycle= 5 E= -128.541936267507  delta_E= -7.24e-10  |g|= 5.96e-06  |ddm|= 5.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58929324580177  E_coul = 54.047356978294815
  HOMO = -0.849014452155372  LUMO = 0.755098086052776
  mo_energy =
[-3.27708743e+01 -1.92937194e+00 -8.49014452e-01 -8.49014452e-01
 -8.49014452e-01  7.55098086e-01  8.05539311e-01  8.05539311e-01
  8.05539311e-01  3.88932251e+00  3.88932251e+00  3.88932251e+00
  4.25111967e+00  1.42258426e+01  1.42258426e+01  1.42258426e+01
  1.57070462e+01  5.09901066e+01  5.28129850e+01  5.28129850e+01
  5.28129850e+01  1.60427022e+02  2.40599905e+02  2.40599905e+02
  2.40599905e+02  5.25519547e+02  1.89100844e+03  8.01804392e+03
  4.77825731e+04]
E1 = -182.58927722731536  E_coul = 54.04734095980592
Extra cycle  E= -128.541936267509  delta_E= -2.47e-12  |g|= 2.25e-06  |ddm|= 2.18e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1209.9824124756017
E1 = -182.58927722731536  E_coul = 54.04734095980592
init E= -128.541936267509
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.849015585904933  LUMO = 0.755097879275887
  mo_energy =
[-3.27708779e+01 -1.92937299e+00 -8.49015586e-01 -8.49015586e-01
 -8.49015586e-01  7.55097879e-01  8.05539052e-01  8.05539052e-01
  8.05539052e-01  3.88932153e+00  3.88932153e+00  3.88932153e+00
  4.25111889e+00  1.42258406e+01  1.42258406e+01  1.42258406e+01
  1.57070445e+01  5.09901039e+01  5.28129819e+01  5.28129819e+01
  5.28129819e+01  1.60427019e+02  2.40599901e+02  2.40599901e+02
  2.40599901e+02  5.25519543e+02  1.89100843e+03  8.01804392e+03
  4.77825731e+04]
E1 = -182.58928611915178  E_coul = 54.04734985164194
cycle= 1 E= -128.54193626751  delta_E= -3.98e-13  |g|= 1.22e-06  |ddm|= 8.07e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.58928611915178  E_coul = 54.04734985164194
  HOMO = -0.849014960007504  LUMO = 0.755098054820425
  mo_energy =
[-3.27708760e+01 -1.92937230e+00 -8.49014960e-01 -8.49014960e-01
 -8.49014960e-01  7.55098055e-01  8.05539208e-01  8.05539208e-01
  8.05539208e-01  3.88932209e+00  3.88932209e+00  3.88932209e+00
  4.25111939e+00  1.42258417e+01  1.42258417e+01  1.42258417e+01
  1.57070455e+01  5.09901054e+01  5.28129835e+01  5.28129835e+01
  5.28129835e+01  1.60427020e+02  2.40599903e+02  2.40599903e+02
  2.40599903e+02  5.25519545e+02  1.89100844e+03  8.01804392e+03
  4.77825731e+04]
E1 = -182.589281648758  E_coul = 54.04734538124827
Extra cycle  E= -128.54193626751  delta_E= 1.14e-13  |g|= 6.07e-07  |ddm|= 3.99e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [7.68374368e-01 2.44137942e+04 3.66145062e+03 8.33338589e+02
 2.35240087e+02 7.66890314e+01 1.14260781e+01 2.82061264e+01
 2.97335789e-01 1.94230208e+00 4.98827355e+00 7.11133606e+00
 2.31740690e+01 9.97851028e+01 2.65949392e-01 2.44099623e+00
 8.33793609e-01]
grad_E = [-2.26428662e-04 -1.84383923e-10  1.20334542e-08 -4.04115384e-07
  7.50234005e-06 -4.57447801e-05 -1.27614438e-04  1.78893416e-05
  2.71013553e-04  6.33893531e-05  6.77148198e-05 -2.53214785e-05
  5.82401108e-06 -2.68316718e-07 -3.78464654e-04  1.69642421e-06
  1.79406430e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.775468923695       1
[INPUT] 0    0    [1    /1   ]  24413.794208         1
[INPUT] 0    0    [1    /1   ]  3661.45041721        1
[INPUT] 0    0    [1    /1   ]  833.34284376         1
[INPUT] 0    0    [1    /1   ]  235.19261181         1
[INPUT] 0    0    [1    /1   ]  76.8816566138        1
[INPUT] 0    0    [1    /1   ]  11.4368530624        1
[INPUT] 0    0    [1    /1   ]  28.2661177406        1
[INPUT] 0    0    [1    /1   ]  0.301597498552       1
[INPUT] 0    0    [1    /1   ]  1.95224120469        1
[INPUT] 0    0    [1    /1   ]  4.98702344307        1
[INPUT] 1    0    [1    /1   ]  7.12502883648        1
[INPUT] 1    0    [1    /1   ]  23.1691945625        1
[INPUT] 1    0    [1    /1   ]  99.7853046907        1
[INPUT] 1    0    [1    /1   ]  0.265553019718       1
[INPUT] 1    0    [1    /1   ]  2.44456310342        1
[INPUT] 1    0    [1    /1   ]  0.833948119663       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7754689236950232, 1.0]], [0, [24413.794208024163, 1.0]], [0, [3661.4504172115758, 1.0]], [0, [833.3428437599783, 1.0]], [0, [235.19261180999231, 1.0]], [0, [76.88165661376726, 1.0]], [0, [11.436853062385357, 1.0]], [0, [28.26611774056009, 1.0]], [0, [0.30159749855185725, 1.0]], [0, [1.95224120469084, 1.0]], [0, [4.987023443073996, 1.0]], [1, [7.1250288364800936, 1.0]], [1, [23.16919456254032, 1.0]], [1, [99.78530469074215, 1.0]], [1, [0.26555301971809137, 1.0]], [1, [2.4445631034165505, 1.0]], [1, [0.8339481196633294, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77546892]
bas 1, expnt(s) = [24413.79420802]
bas 2, expnt(s) = [3661.45041721]
bas 3, expnt(s) = [833.34284376]
bas 4, expnt(s) = [235.19261181]
bas 5, expnt(s) = [76.88165661]
bas 6, expnt(s) = [11.43685306]
bas 7, expnt(s) = [28.26611774]
bas 8, expnt(s) = [0.3015975]
bas 9, expnt(s) = [1.9522412]
bas 10, expnt(s) = [4.98702344]
bas 11, expnt(s) = [7.12502884]
bas 12, expnt(s) = [23.16919456]
bas 13, expnt(s) = [99.78530469]
bas 14, expnt(s) = [0.26555302]
bas 15, expnt(s) = [2.4445631]
bas 16, expnt(s) = [0.83394812]
CPU time:       337.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.75468924e-01 2.08779726e+00 2.44137942e+04 4.93448103e+03
 3.66145042e+03 1.18919998e+03 8.33342844e+02 3.91861690e+02
 2.35192612e+02 1.51733956e+02 7.68816566e+01 6.55967124e+01
 1.14368531e+01 1.57124870e+01 2.82661177e+01 3.09716717e+01
 3.01597499e-01 1.02821948e+00 1.95224120e+00 4.17268048e+00
 4.98702344e+00 8.43132988e+00 7.12502884e+00 3.39599995e+01
 2.31691946e+01 1.48293824e+02 9.97853047e+01 9.20063130e+02
 2.65553020e-01 5.56126318e-01 2.44456310e+00 8.91735299e+00
 8.33948120e-01 2.32492092e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999641287664636
cond(S) = 1223.5426431558574
E1 = -183.5903452554279  E_coul = 55.08015203751552
init E= -128.510193217912
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.7754058673073  LUMO = 0.787043030568842
  mo_energy =
[-3.25552239e+01 -1.85274797e+00 -7.75405867e-01 -7.75405867e-01
 -7.75405867e-01  7.87043031e-01  8.22652865e-01  8.22652865e-01
  8.22652865e-01  3.95611647e+00  3.95611647e+00  3.95611647e+00
  4.35443319e+00  1.43740477e+01  1.43740477e+01  1.43740477e+01
  1.59034256e+01  5.12947388e+01  5.30462440e+01  5.30462440e+01
  5.30462440e+01  1.61013002e+02  2.40868619e+02  2.40868619e+02
  2.40868619e+02  5.26532036e+02  1.89216275e+03  8.01914974e+03
  4.77835645e+04]
E1 = -182.0853102124616  E_coul = 53.54687775370492
cycle= 1 E= -128.538432458757  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519908
diis-c [-0.27030449  1.        ]
  HOMO = -0.884389788941648  LUMO = 0.75826003990485
  mo_energy =
[-3.28785431e+01 -1.96672371e+00 -8.84389789e-01 -8.84389789e-01
 -8.84389789e-01  7.58260040e-01  7.95881543e-01  7.95881543e-01
  7.95881543e-01  3.85850034e+00  3.85850034e+00  3.85850034e+00
  4.26905738e+00  1.41830414e+01  1.41830414e+01  1.41830414e+01
  1.57322748e+01  5.10386647e+01  5.27651464e+01  5.27651464e+01
  5.27651464e+01  1.60695415e+02  2.40522155e+02  2.40522155e+02
  2.40522155e+02  5.26170983e+02  1.89176523e+03  8.01872295e+03
  4.77831188e+04]
E1 = -182.84725768055793  E_coul = 54.306235724029165
cycle= 2 E= -128.541021956529  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.2645
diis-c [-0.00072552  0.33633321  0.66366679]
  HOMO = -0.848749810397552  LUMO = 0.767457253369159
  mo_energy =
[-3.27704123e+01 -1.92919518e+00 -8.48749810e-01 -8.48749810e-01
 -8.48749810e-01  7.67457253e-01  8.04605499e-01  8.04605499e-01
  8.04605499e-01  3.89015533e+00  3.89015533e+00  3.89015533e+00
  4.29671819e+00  1.42463018e+01  1.42463018e+01  1.42463018e+01
  1.57887922e+01  5.11244559e+01  5.28591991e+01  5.28591991e+01
  5.28591991e+01  1.60801300e+02  2.40635858e+02  2.40635858e+02
  2.40635858e+02  5.26287633e+02  1.89188728e+03  8.01884750e+03
  4.77832443e+04]
E1 = -182.5884379894044  E_coul = 54.04649462567516
cycle= 3 E= -128.541943363729  delta_E= -0.000921  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109405
diis-c [-1.91226743e-07 -2.38670606e-03 -9.00514787e-04  1.00328722e+00]
  HOMO = -0.849002594895033  LUMO = 0.767405101333311
  mo_energy =
[-3.27708516e+01 -1.92938417e+00 -8.49002595e-01 -8.49002595e-01
 -8.49002595e-01  7.67405101e-01  8.04566518e-01  8.04566518e-01
  8.04566518e-01  3.88998087e+00  3.88998087e+00  3.88998087e+00
  4.29657212e+00  1.42460053e+01  1.42460053e+01  1.42460053e+01
  1.57885259e+01  5.11241006e+01  5.28588104e+01  5.28588104e+01
  5.28588104e+01  1.60800856e+02  2.40635348e+02  2.40635348e+02
  2.40635348e+02  5.26287068e+02  1.89188659e+03  8.01884670e+03
  4.77832434e+04]
E1 = -182.5888320754068  E_coul = 54.04688868658327
cycle= 4 E= -128.541943388824  delta_E= -2.51e-08  |g|= 8.04e-05  |ddm|= 0.000338
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186499
diis-c [-1.09747505e-09  2.27595838e-04  5.24379426e-04 -1.82222452e-01
  1.18147048e+00]
  HOMO = -0.849046004364442  LUMO = 0.767391868931687
  mo_energy =
[-3.27709252e+01 -1.92941734e+00 -8.49046004e-01 -8.49046004e-01
 -8.49046004e-01  7.67391869e-01  8.04553013e-01  8.04553013e-01
  8.04553013e-01  3.88994029e+00  3.88994029e+00  3.88994029e+00
  4.29653911e+00  1.42459453e+01  1.42459453e+01  1.42459453e+01
  1.57884707e+01  5.11240335e+01  5.28587407e+01  5.28587407e+01
  5.28587407e+01  1.60800782e+02  2.40635270e+02  2.40635270e+02
  2.40635270e+02  5.26286986e+02  1.89188650e+03  8.01884660e+03
  4.77832433e+04]
E1 = -182.58896551959612  E_coul = 54.047022130062274
cycle= 5 E= -128.541943389534  delta_E= -7.1e-10  |g|= 5.84e-06  |ddm|= 5.66e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58896551959612  E_coul = 54.047022130062274
  HOMO = -0.849042952117356  LUMO = 0.767393157119374
  mo_energy =
[-3.27709183e+01 -1.92941349e+00 -8.49042952e-01 -8.49042952e-01
 -8.49042952e-01  7.67393157e-01  8.04553909e-01  8.04553909e-01
  8.04553909e-01  3.88994322e+00  3.88994322e+00  3.88994322e+00
  4.29654203e+00  1.42459504e+01  1.42459504e+01  1.42459504e+01
  1.57884756e+01  5.11240397e+01  5.28587472e+01  5.28587472e+01
  5.28587472e+01  1.60800789e+02  2.40635277e+02  2.40635277e+02
  2.40635277e+02  5.26286993e+02  1.89188650e+03  8.01884661e+03
  4.77832433e+04]
E1 = -182.58894978311847  E_coul = 54.047006393582095
Extra cycle  E= -128.541943389536  delta_E= -2.5e-12  |g|= 2.21e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.75468924e-01 2.44137942e+04 3.66145042e+03 8.33342844e+02
 2.35192612e+02 7.68816566e+01 1.14368531e+01 2.82661177e+01
 3.01597499e-01 1.95224120e+00 4.98702344e+00 7.12502884e+00
 2.31691946e+01 9.97853047e+01 2.65553020e-01 2.44456310e+00
 8.33948120e-01]
E = -128.54194338953636
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.775468923695       1
[INPUT] 0    0    [1    /1   ]  24413.794208         1
[INPUT] 0    0    [1    /1   ]  3661.45041721        1
[INPUT] 0    0    [1    /1   ]  833.34284376         1
[INPUT] 0    0    [1    /1   ]  235.19261181         1
[INPUT] 0    0    [1    /1   ]  76.8816566138        1
[INPUT] 0    0    [1    /1   ]  11.4368530624        1
[INPUT] 0    0    [1    /1   ]  28.2661177406        1
[INPUT] 0    0    [1    /1   ]  0.301597498552       1
[INPUT] 0    0    [1    /1   ]  1.95224120469        1
[INPUT] 0    0    [1    /1   ]  4.98702344307        1
[INPUT] 1    0    [1    /1   ]  7.12502883648        1
[INPUT] 1    0    [1    /1   ]  23.1691945625        1
[INPUT] 1    0    [1    /1   ]  99.7853046907        1
[INPUT] 1    0    [1    /1   ]  0.265553019718       1
[INPUT] 1    0    [1    /1   ]  2.44456310342        1
[INPUT] 1    0    [1    /1   ]  0.833948119663       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7754689236950232, 1.0]], [0, [24413.794208024163, 1.0]], [0, [3661.4504172115758, 1.0]], [0, [833.3428437599783, 1.0]], [0, [235.19261180999231, 1.0]], [0, [76.88165661376726, 1.0]], [0, [11.436853062385357, 1.0]], [0, [28.26611774056009, 1.0]], [0, [0.30159749855185725, 1.0]], [0, [1.95224120469084, 1.0]], [0, [4.987023443073996, 1.0]], [1, [7.1250288364800936, 1.0]], [1, [23.16919456254032, 1.0]], [1, [99.78530469074215, 1.0]], [1, [0.26555301971809137, 1.0]], [1, [2.4445631034165505, 1.0]], [1, [0.8339481196633294, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.77546892]
bas 1, expnt(s) = [24413.79420802]
bas 2, expnt(s) = [3661.45041721]
bas 3, expnt(s) = [833.34284376]
bas 4, expnt(s) = [235.19261181]
bas 5, expnt(s) = [76.88165661]
bas 6, expnt(s) = [11.43685306]
bas 7, expnt(s) = [28.26611774]
bas 8, expnt(s) = [0.3015975]
bas 9, expnt(s) = [1.9522412]
bas 10, expnt(s) = [4.98702344]
bas 11, expnt(s) = [7.12502884]
bas 12, expnt(s) = [23.16919456]
bas 13, expnt(s) = [99.78530469]
bas 14, expnt(s) = [0.26555302]
bas 15, expnt(s) = [2.4445631]
bas 16, expnt(s) = [0.83394812]
CPU time:       338.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.75468924e-01 2.08779726e+00 2.44137942e+04 4.93448103e+03
 3.66145042e+03 1.18919998e+03 8.33342844e+02 3.91861690e+02
 2.35192612e+02 1.51733956e+02 7.68816566e+01 6.55967124e+01
 1.14368531e+01 1.57124870e+01 2.82661177e+01 3.09716717e+01
 3.01597499e-01 1.02821948e+00 1.95224120e+00 4.17268048e+00
 4.98702344e+00 8.43132988e+00 7.12502884e+00 3.39599995e+01
 2.31691946e+01 1.48293824e+02 9.97853047e+01 9.20063130e+02
 2.65553020e-01 5.56126318e-01 2.44456310e+00 8.91735299e+00
 8.33948120e-01 2.32492092e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999641287664636
cond(S) = 1223.5426431558574
E1 = -183.5903452554279  E_coul = 55.08015203751552
init E= -128.510193217912
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.7754058673073  LUMO = 0.787043030568842
  mo_energy =
[-3.25552239e+01 -1.85274797e+00 -7.75405867e-01 -7.75405867e-01
 -7.75405867e-01  7.87043031e-01  8.22652865e-01  8.22652865e-01
  8.22652865e-01  3.95611647e+00  3.95611647e+00  3.95611647e+00
  4.35443319e+00  1.43740477e+01  1.43740477e+01  1.43740477e+01
  1.59034256e+01  5.12947388e+01  5.30462440e+01  5.30462440e+01
  5.30462440e+01  1.61013002e+02  2.40868619e+02  2.40868619e+02
  2.40868619e+02  5.26532036e+02  1.89216275e+03  8.01914974e+03
  4.77835645e+04]
E1 = -182.0853102124616  E_coul = 53.54687775370492
cycle= 1 E= -128.538432458757  delta_E= -0.0282  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.519908
diis-c [-0.27030449  1.        ]
  HOMO = -0.884389788941648  LUMO = 0.75826003990485
  mo_energy =
[-3.28785431e+01 -1.96672371e+00 -8.84389789e-01 -8.84389789e-01
 -8.84389789e-01  7.58260040e-01  7.95881543e-01  7.95881543e-01
  7.95881543e-01  3.85850034e+00  3.85850034e+00  3.85850034e+00
  4.26905738e+00  1.41830414e+01  1.41830414e+01  1.41830414e+01
  1.57322748e+01  5.10386647e+01  5.27651464e+01  5.27651464e+01
  5.27651464e+01  1.60695415e+02  2.40522155e+02  2.40522155e+02
  2.40522155e+02  5.26170983e+02  1.89176523e+03  8.01872295e+03
  4.77831188e+04]
E1 = -182.84725768055793  E_coul = 54.306235724029165
cycle= 2 E= -128.541021956529  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.2645
diis-c [-0.00072552  0.33633321  0.66366679]
  HOMO = -0.848749810397552  LUMO = 0.767457253369159
  mo_energy =
[-3.27704123e+01 -1.92919518e+00 -8.48749810e-01 -8.48749810e-01
 -8.48749810e-01  7.67457253e-01  8.04605499e-01  8.04605499e-01
  8.04605499e-01  3.89015533e+00  3.89015533e+00  3.89015533e+00
  4.29671819e+00  1.42463018e+01  1.42463018e+01  1.42463018e+01
  1.57887922e+01  5.11244559e+01  5.28591991e+01  5.28591991e+01
  5.28591991e+01  1.60801300e+02  2.40635858e+02  2.40635858e+02
  2.40635858e+02  5.26287633e+02  1.89188728e+03  8.01884750e+03
  4.77832443e+04]
E1 = -182.5884379894044  E_coul = 54.04649462567516
cycle= 3 E= -128.541943363729  delta_E= -0.000921  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109405
diis-c [-1.91226743e-07 -2.38670606e-03 -9.00514787e-04  1.00328722e+00]
  HOMO = -0.849002594895033  LUMO = 0.767405101333311
  mo_energy =
[-3.27708516e+01 -1.92938417e+00 -8.49002595e-01 -8.49002595e-01
 -8.49002595e-01  7.67405101e-01  8.04566518e-01  8.04566518e-01
  8.04566518e-01  3.88998087e+00  3.88998087e+00  3.88998087e+00
  4.29657212e+00  1.42460053e+01  1.42460053e+01  1.42460053e+01
  1.57885259e+01  5.11241006e+01  5.28588104e+01  5.28588104e+01
  5.28588104e+01  1.60800856e+02  2.40635348e+02  2.40635348e+02
  2.40635348e+02  5.26287068e+02  1.89188659e+03  8.01884670e+03
  4.77832434e+04]
E1 = -182.5888320754068  E_coul = 54.04688868658327
cycle= 4 E= -128.541943388824  delta_E= -2.51e-08  |g|= 8.04e-05  |ddm|= 0.000338
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000186499
diis-c [-1.09747505e-09  2.27595838e-04  5.24379426e-04 -1.82222452e-01
  1.18147048e+00]
  HOMO = -0.849046004364442  LUMO = 0.767391868931687
  mo_energy =
[-3.27709252e+01 -1.92941734e+00 -8.49046004e-01 -8.49046004e-01
 -8.49046004e-01  7.67391869e-01  8.04553013e-01  8.04553013e-01
  8.04553013e-01  3.88994029e+00  3.88994029e+00  3.88994029e+00
  4.29653911e+00  1.42459453e+01  1.42459453e+01  1.42459453e+01
  1.57884707e+01  5.11240335e+01  5.28587407e+01  5.28587407e+01
  5.28587407e+01  1.60800782e+02  2.40635270e+02  2.40635270e+02
  2.40635270e+02  5.26286986e+02  1.89188650e+03  8.01884660e+03
  4.77832433e+04]
E1 = -182.58896551959612  E_coul = 54.047022130062274
cycle= 5 E= -128.541943389534  delta_E= -7.1e-10  |g|= 5.84e-06  |ddm|= 5.66e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58896551959612  E_coul = 54.047022130062274
  HOMO = -0.849042952117356  LUMO = 0.767393157119374
  mo_energy =
[-3.27709183e+01 -1.92941349e+00 -8.49042952e-01 -8.49042952e-01
 -8.49042952e-01  7.67393157e-01  8.04553909e-01  8.04553909e-01
  8.04553909e-01  3.88994322e+00  3.88994322e+00  3.88994322e+00
  4.29654203e+00  1.42459504e+01  1.42459504e+01  1.42459504e+01
  1.57884756e+01  5.11240397e+01  5.28587472e+01  5.28587472e+01
  5.28587472e+01  1.60800789e+02  2.40635277e+02  2.40635277e+02
  2.40635277e+02  5.26286993e+02  1.89188650e+03  8.01884661e+03
  4.77832433e+04]
E1 = -182.58894978311847  E_coul = 54.047006393582095
Extra cycle  E= -128.541943389536  delta_E= -2.5e-12  |g|= 2.21e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1223.5426431558574
E1 = -182.58894978311847  E_coul = 54.047006393582095
init E= -128.541943389536
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.849044066952092  LUMO = 0.767392950280016
  mo_energy =
[-3.27709218e+01 -1.92941452e+00 -8.49044067e-01 -8.49044067e-01
 -8.49044067e-01  7.67392950e-01  8.04553653e-01  8.04553653e-01
  8.04553653e-01  3.88994225e+00  3.88994225e+00  3.88994225e+00
  4.29654126e+00  1.42459484e+01  1.42459484e+01  1.42459484e+01
  1.57884739e+01  5.11240370e+01  5.28587442e+01  5.28587442e+01
  5.28587442e+01  1.60800786e+02  2.40635273e+02  2.40635273e+02
  2.40635273e+02  5.26286989e+02  1.89188650e+03  8.01884661e+03
  4.77832433e+04]
E1 = -182.58895850877207  E_coul = 54.047015119235475
cycle= 1 E= -128.541943389537  delta_E= -2.27e-13  |g|= 1.2e-06  |ddm|= 7.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58895850877207  E_coul = 54.047015119235475
  HOMO = -0.849043452905723  LUMO = 0.767393125085606
  mo_energy =
[-3.27709199e+01 -1.92941385e+00 -8.49043453e-01 -8.49043453e-01
 -8.49043453e-01  7.67393125e-01  8.04553807e-01  8.04553807e-01
  8.04553807e-01  3.88994280e+00  3.88994280e+00  3.88994280e+00
  4.29654175e+00  1.42459495e+01  1.42459495e+01  1.42459495e+01
  1.57884748e+01  5.11240385e+01  5.28587458e+01  5.28587458e+01
  5.28587458e+01  1.60800787e+02  2.40635275e+02  2.40635275e+02
  2.40635275e+02  5.26286991e+02  1.89188650e+03  8.01884661e+03
  4.77832433e+04]
E1 = -182.58895412017063  E_coul = 54.04701073063369
Extra cycle  E= -128.541943389537  delta_E= -3.41e-13  |g|= 5.96e-07  |ddm|= 3.92e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [7.75468924e-01 2.44137942e+04 3.66145042e+03 8.33342844e+02
 2.35192612e+02 7.68816566e+01 1.14368531e+01 2.82661177e+01
 3.01597499e-01 1.95224120e+00 4.98702344e+00 7.12502884e+00
 2.31691946e+01 9.97853047e+01 2.65553020e-01 2.44456310e+00
 8.33948120e-01]
grad_E = [-3.88423152e-04  3.87078686e-10 -1.73469165e-08  1.31937076e-07
  2.82614864e-06 -2.90922760e-05 -1.15596052e-04 -4.94472661e-06
  7.24423618e-04  8.95014547e-05  6.39622581e-05  9.66553104e-05
 -1.91399891e-05  8.93857116e-07 -1.63608495e-03 -1.94802809e-04
  6.06438842e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783299831028       1
[INPUT] 0    0    [1    /1   ]  24413.7942125        1
[INPUT] 0    0    [1    /1   ]  3661.4501788         1
[INPUT] 0    0    [1    /1   ]  833.347816348        1
[INPUT] 0    0    [1    /1   ]  235.136494483        1
[INPUT] 0    0    [1    /1   ]  77.1038073028        1
[INPUT] 0    0    [1    /1   ]  11.4974696968        1
[INPUT] 0    0    [1    /1   ]  28.3895563979        1
[INPUT] 0    0    [1    /1   ]  0.305900928654       1
[INPUT] 0    0    [1    /1   ]  1.96581321812        1
[INPUT] 0    0    [1    /1   ]  4.98093498572        1
[INPUT] 1    0    [1    /1   ]  7.14030695092        1
[INPUT] 1    0    [1    /1   ]  23.1635965089        1
[INPUT] 1    0    [1    /1   ]  99.7855355828        1
[INPUT] 1    0    [1    /1   ]  0.265212757351       1
[INPUT] 1    0    [1    /1   ]  2.4485401672         1
[INPUT] 1    0    [1    /1   ]  0.83415864239        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7832998310283753, 1.0]], [0, [24413.79421246442, 1.0]], [0, [3661.4501788027887, 1.0]], [0, [833.3478163479, 1.0]], [0, [235.13649448344793, 1.0]], [0, [77.10380730275622, 1.0]], [0, [11.497469696838168, 1.0]], [0, [28.389556397943064, 1.0]], [0, [0.30590092865432483, 1.0]], [0, [1.9658132181181176, 1.0]], [0, [4.980934985720688, 1.0]], [1, [7.140306950924101, 1.0]], [1, [23.163596508906185, 1.0]], [1, [99.78553558283927, 1.0]], [1, [0.2652127573511425, 1.0]], [1, [2.4485401671995484, 1.0]], [1, [0.834158642390224, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78329983]
bas 1, expnt(s) = [24413.79421246]
bas 2, expnt(s) = [3661.4501788]
bas 3, expnt(s) = [833.34781635]
bas 4, expnt(s) = [235.13649448]
bas 5, expnt(s) = [77.1038073]
bas 6, expnt(s) = [11.4974697]
bas 7, expnt(s) = [28.3895564]
bas 8, expnt(s) = [0.30590093]
bas 9, expnt(s) = [1.96581322]
bas 10, expnt(s) = [4.98093499]
bas 11, expnt(s) = [7.14030695]
bas 12, expnt(s) = [23.16359651]
bas 13, expnt(s) = [99.78553558]
bas 14, expnt(s) = [0.26521276]
bas 15, expnt(s) = [2.44854017]
bas 16, expnt(s) = [0.83415864]
CPU time:       342.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83299831e-01 2.10358976e+00 2.44137942e+04 4.93448103e+03
 3.66145018e+03 1.18919992e+03 8.33347816e+02 3.91863444e+02
 2.35136494e+02 1.51706802e+02 7.71038073e+01 6.57388181e+01
 1.14974697e+01 1.57749042e+01 2.83895564e+01 3.10730568e+01
 3.05900929e-01 1.03920355e+00 1.96581322e+00 4.19441804e+00
 4.98093499e+00 8.42360860e+00 7.14030695e+00 3.40510489e+01
 2.31635965e+01 1.48249037e+02 9.97855356e+01 9.20065791e+02
 2.65212757e-01 5.55235731e-01 2.44854017e+00 8.93549124e+00
 8.34158642e-01 2.32565457e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999641281652949
cond(S) = 1233.5073630051536
E1 = -183.59027377221173  E_coul = 55.0801440285047
init E= -128.510129743707
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406532004608  LUMO = 0.80027987842535
  mo_energy =
[-3.25552308e+01 -1.85274866e+00 -7.75406532e-01 -7.75406532e-01
 -7.75406532e-01  8.00279878e-01  8.21837850e-01  8.21837850e-01
  8.21837850e-01  3.95739190e+00  3.95739190e+00  3.95739190e+00
  4.40566196e+00  1.43971228e+01  1.43971228e+01  1.43971228e+01
  1.60066156e+01  5.15488820e+01  5.30975173e+01  5.30975173e+01
  5.30975173e+01  1.61713850e+02  2.40907906e+02  2.40907906e+02
  2.40907906e+02  5.27776099e+02  1.89353015e+03  8.02039397e+03
  4.77846024e+04]
E1 = -182.08492354439528  E_coul = 53.54648347464729
cycle= 1 E= -128.538440069748  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519948
diis-c [-0.2703462  1.       ]
  HOMO = -0.884421654777552  LUMO = 0.771031371412512
  mo_energy =
[-3.28786059e+01 -1.96676755e+00 -8.84421655e-01 -8.84421655e-01
 -8.84421655e-01  7.71031371e-01  7.95070329e-01  7.95070329e-01
  7.95070329e-01  3.85964364e+00  3.85964364e+00  3.85964364e+00
  4.31977133e+00  1.42058857e+01  1.42058857e+01  1.42058857e+01
  1.58351626e+01  5.12924849e+01  5.28163508e+01  5.28163508e+01
  5.28163508e+01  1.61396059e+02  2.40561400e+02  2.40561400e+02
  2.40561400e+02  5.27414973e+02  1.89313259e+03  8.01996713e+03
  4.77841566e+04]
E1 = -182.8471183833511  E_coul = 54.306087841626294
cycle= 2 E= -128.541030541725  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0651
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264544
diis-c [-0.00072617  0.33635199  0.66364801]
  HOMO = -0.848770628612567  LUMO = 0.780375141469243
  mo_energy =
[-3.27704454e+01 -1.92922694e+00 -8.48770629e-01 -8.48770629e-01
 -8.48770629e-01  7.80375141e-01  8.03792308e-01  8.03792308e-01
  8.03792308e-01  3.89134101e+00  3.89134101e+00  3.89134101e+00
  4.34760118e+00  1.42692274e+01  1.42692274e+01  1.42692274e+01
  1.58917840e+01  5.13783917e+01  5.29104334e+01  5.29104334e+01
  5.29104334e+01  1.61502017e+02  2.40675132e+02  2.40675132e+02
  2.40675132e+02  5.27531659e+02  1.89325467e+03  8.02009171e+03
  4.77842821e+04]
E1 = -182.58818769941524  E_coul = 54.04623510272046
cycle= 3 E= -128.541952596695  delta_E= -0.000922  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109512
diis-c [-1.86911381e-07 -2.38157985e-03 -8.77805838e-04  1.00325939e+00]
  HOMO = -0.849024027794343  LUMO = 0.780321534839796
  mo_energy =
[-3.27708865e+01 -1.92941761e+00 -8.49024028e-01 -8.49024028e-01
 -8.49024028e-01  7.80321535e-01  8.03753127e-01  8.03753127e-01
  8.03753127e-01  3.89116555e+00  3.89116555e+00  3.89116555e+00
  4.34745336e+00  1.42689295e+01  1.42689295e+01  1.42689295e+01
  1.58915161e+01  5.13780345e+01  5.29100431e+01  5.29100431e+01
  5.29100431e+01  1.61501571e+02  2.40674621e+02  2.40674621e+02
  2.40674621e+02  5.27531092e+02  1.89325397e+03  8.02009091e+03
  4.77842813e+04]
E1 = -182.58858471866444  E_coul = 54.04663209710966
cycle= 4 E= -128.541952621555  delta_E= -2.49e-08  |g|= 8.01e-05  |ddm|= 0.000336
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185816
diis-c [-1.07242273e-09  2.22988906e-04  5.19951046e-04 -1.79855581e-01
  1.17911264e+00]
  HOMO = -0.849067353210665  LUMO = 0.780308024817481
  mo_energy =
[-3.27709600e+01 -1.92945100e+00 -8.49067353e-01 -8.49067353e-01
 -8.49067353e-01  7.80308025e-01  8.03739647e-01  8.03739647e-01
  8.03739647e-01  3.89112496e+00  3.89112496e+00  3.89112496e+00
  4.34742010e+00  1.42688696e+01  1.42688696e+01  1.42688696e+01
  1.58914608e+01  5.13779675e+01  5.29099735e+01  5.29099735e+01
  5.29099735e+01  1.61501498e+02  2.40674543e+02  2.40674543e+02
  2.40674543e+02  5.27531010e+02  1.89325388e+03  8.02009081e+03
  4.77842812e+04]
E1 = -182.58871804800222  E_coul = 54.04676542575139
cycle= 5 E= -128.541952622251  delta_E= -6.96e-10  |g|= 5.73e-06  |ddm|= 5.59e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58871804800222  E_coul = 54.04676542575139
  HOMO = -0.849064374748674  LUMO = 0.780309299819195
  mo_energy =
[-3.27709532e+01 -1.92944723e+00 -8.49064375e-01 -8.49064375e-01
 -8.49064375e-01  7.80309300e-01  8.03740519e-01  8.03740519e-01
  8.03740519e-01  3.89112782e+00  3.89112782e+00  3.89112782e+00
  4.34742297e+00  1.42688745e+01  1.42688745e+01  1.42688745e+01
  1.58914656e+01  5.13779735e+01  5.29099798e+01  5.29099798e+01
  5.29099798e+01  1.61501504e+02  2.40674549e+02  2.40674549e+02
  2.40674549e+02  5.27531017e+02  1.89325389e+03  8.02009082e+03
  4.77842812e+04]
E1 = -182.58870259281426  E_coul = 54.04674997056115
Extra cycle  E= -128.541952622253  delta_E= -2.27e-12  |g|= 2.17e-06  |ddm|= 2.08e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.83299831e-01 2.44137942e+04 3.66145018e+03 8.33347816e+02
 2.35136494e+02 7.71038073e+01 1.14974697e+01 2.83895564e+01
 3.05900929e-01 1.96581322e+00 4.98093499e+00 7.14030695e+00
 2.31635965e+01 9.97855356e+01 2.65212757e-01 2.44854017e+00
 8.34158642e-01]
E = -128.54195262225312
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.783299831028       1
[INPUT] 0    0    [1    /1   ]  24413.7942125        1
[INPUT] 0    0    [1    /1   ]  3661.4501788         1
[INPUT] 0    0    [1    /1   ]  833.347816348        1
[INPUT] 0    0    [1    /1   ]  235.136494483        1
[INPUT] 0    0    [1    /1   ]  77.1038073028        1
[INPUT] 0    0    [1    /1   ]  11.4974696968        1
[INPUT] 0    0    [1    /1   ]  28.3895563979        1
[INPUT] 0    0    [1    /1   ]  0.305900928654       1
[INPUT] 0    0    [1    /1   ]  1.96581321812        1
[INPUT] 0    0    [1    /1   ]  4.98093498572        1
[INPUT] 1    0    [1    /1   ]  7.14030695092        1
[INPUT] 1    0    [1    /1   ]  23.1635965089        1
[INPUT] 1    0    [1    /1   ]  99.7855355828        1
[INPUT] 1    0    [1    /1   ]  0.265212757351       1
[INPUT] 1    0    [1    /1   ]  2.4485401672         1
[INPUT] 1    0    [1    /1   ]  0.83415864239        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7832998310283753, 1.0]], [0, [24413.79421246442, 1.0]], [0, [3661.4501788027887, 1.0]], [0, [833.3478163479, 1.0]], [0, [235.13649448344793, 1.0]], [0, [77.10380730275622, 1.0]], [0, [11.497469696838168, 1.0]], [0, [28.389556397943064, 1.0]], [0, [0.30590092865432483, 1.0]], [0, [1.9658132181181176, 1.0]], [0, [4.980934985720688, 1.0]], [1, [7.140306950924101, 1.0]], [1, [23.163596508906185, 1.0]], [1, [99.78553558283927, 1.0]], [1, [0.2652127573511425, 1.0]], [1, [2.4485401671995484, 1.0]], [1, [0.834158642390224, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.78329983]
bas 1, expnt(s) = [24413.79421246]
bas 2, expnt(s) = [3661.4501788]
bas 3, expnt(s) = [833.34781635]
bas 4, expnt(s) = [235.13649448]
bas 5, expnt(s) = [77.1038073]
bas 6, expnt(s) = [11.4974697]
bas 7, expnt(s) = [28.3895564]
bas 8, expnt(s) = [0.30590093]
bas 9, expnt(s) = [1.96581322]
bas 10, expnt(s) = [4.98093499]
bas 11, expnt(s) = [7.14030695]
bas 12, expnt(s) = [23.16359651]
bas 13, expnt(s) = [99.78553558]
bas 14, expnt(s) = [0.26521276]
bas 15, expnt(s) = [2.44854017]
bas 16, expnt(s) = [0.83415864]
CPU time:       343.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.83299831e-01 2.10358976e+00 2.44137942e+04 4.93448103e+03
 3.66145018e+03 1.18919992e+03 8.33347816e+02 3.91863444e+02
 2.35136494e+02 1.51706802e+02 7.71038073e+01 6.57388181e+01
 1.14974697e+01 1.57749042e+01 2.83895564e+01 3.10730568e+01
 3.05900929e-01 1.03920355e+00 1.96581322e+00 4.19441804e+00
 4.98093499e+00 8.42360860e+00 7.14030695e+00 3.40510489e+01
 2.31635965e+01 1.48249037e+02 9.97855356e+01 9.20065791e+02
 2.65212757e-01 5.55235731e-01 2.44854017e+00 8.93549124e+00
 8.34158642e-01 2.32565457e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999641281652949
cond(S) = 1233.5073630051536
E1 = -183.59027377221173  E_coul = 55.0801440285047
init E= -128.510129743707
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406532004608  LUMO = 0.80027987842535
  mo_energy =
[-3.25552308e+01 -1.85274866e+00 -7.75406532e-01 -7.75406532e-01
 -7.75406532e-01  8.00279878e-01  8.21837850e-01  8.21837850e-01
  8.21837850e-01  3.95739190e+00  3.95739190e+00  3.95739190e+00
  4.40566196e+00  1.43971228e+01  1.43971228e+01  1.43971228e+01
  1.60066156e+01  5.15488820e+01  5.30975173e+01  5.30975173e+01
  5.30975173e+01  1.61713850e+02  2.40907906e+02  2.40907906e+02
  2.40907906e+02  5.27776099e+02  1.89353015e+03  8.02039397e+03
  4.77846024e+04]
E1 = -182.08492354439528  E_coul = 53.54648347464729
cycle= 1 E= -128.538440069748  delta_E= -0.0283  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519948
diis-c [-0.2703462  1.       ]
  HOMO = -0.884421654777552  LUMO = 0.771031371412512
  mo_energy =
[-3.28786059e+01 -1.96676755e+00 -8.84421655e-01 -8.84421655e-01
 -8.84421655e-01  7.71031371e-01  7.95070329e-01  7.95070329e-01
  7.95070329e-01  3.85964364e+00  3.85964364e+00  3.85964364e+00
  4.31977133e+00  1.42058857e+01  1.42058857e+01  1.42058857e+01
  1.58351626e+01  5.12924849e+01  5.28163508e+01  5.28163508e+01
  5.28163508e+01  1.61396059e+02  2.40561400e+02  2.40561400e+02
  2.40561400e+02  5.27414973e+02  1.89313259e+03  8.01996713e+03
  4.77841566e+04]
E1 = -182.8471183833511  E_coul = 54.306087841626294
cycle= 2 E= -128.541030541725  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0651
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264544
diis-c [-0.00072617  0.33635199  0.66364801]
  HOMO = -0.848770628612567  LUMO = 0.780375141469243
  mo_energy =
[-3.27704454e+01 -1.92922694e+00 -8.48770629e-01 -8.48770629e-01
 -8.48770629e-01  7.80375141e-01  8.03792308e-01  8.03792308e-01
  8.03792308e-01  3.89134101e+00  3.89134101e+00  3.89134101e+00
  4.34760118e+00  1.42692274e+01  1.42692274e+01  1.42692274e+01
  1.58917840e+01  5.13783917e+01  5.29104334e+01  5.29104334e+01
  5.29104334e+01  1.61502017e+02  2.40675132e+02  2.40675132e+02
  2.40675132e+02  5.27531659e+02  1.89325467e+03  8.02009171e+03
  4.77842821e+04]
E1 = -182.58818769941524  E_coul = 54.04623510272046
cycle= 3 E= -128.541952596695  delta_E= -0.000922  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109512
diis-c [-1.86911381e-07 -2.38157985e-03 -8.77805838e-04  1.00325939e+00]
  HOMO = -0.849024027794343  LUMO = 0.780321534839796
  mo_energy =
[-3.27708865e+01 -1.92941761e+00 -8.49024028e-01 -8.49024028e-01
 -8.49024028e-01  7.80321535e-01  8.03753127e-01  8.03753127e-01
  8.03753127e-01  3.89116555e+00  3.89116555e+00  3.89116555e+00
  4.34745336e+00  1.42689295e+01  1.42689295e+01  1.42689295e+01
  1.58915161e+01  5.13780345e+01  5.29100431e+01  5.29100431e+01
  5.29100431e+01  1.61501571e+02  2.40674621e+02  2.40674621e+02
  2.40674621e+02  5.27531092e+02  1.89325397e+03  8.02009091e+03
  4.77842813e+04]
E1 = -182.58858471866444  E_coul = 54.04663209710966
cycle= 4 E= -128.541952621555  delta_E= -2.49e-08  |g|= 8.01e-05  |ddm|= 0.000336
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185816
diis-c [-1.07242273e-09  2.22988906e-04  5.19951046e-04 -1.79855581e-01
  1.17911264e+00]
  HOMO = -0.849067353210665  LUMO = 0.780308024817481
  mo_energy =
[-3.27709600e+01 -1.92945100e+00 -8.49067353e-01 -8.49067353e-01
 -8.49067353e-01  7.80308025e-01  8.03739647e-01  8.03739647e-01
  8.03739647e-01  3.89112496e+00  3.89112496e+00  3.89112496e+00
  4.34742010e+00  1.42688696e+01  1.42688696e+01  1.42688696e+01
  1.58914608e+01  5.13779675e+01  5.29099735e+01  5.29099735e+01
  5.29099735e+01  1.61501498e+02  2.40674543e+02  2.40674543e+02
  2.40674543e+02  5.27531010e+02  1.89325388e+03  8.02009081e+03
  4.77842812e+04]
E1 = -182.58871804800222  E_coul = 54.04676542575139
cycle= 5 E= -128.541952622251  delta_E= -6.96e-10  |g|= 5.73e-06  |ddm|= 5.59e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58871804800222  E_coul = 54.04676542575139
  HOMO = -0.849064374748674  LUMO = 0.780309299819195
  mo_energy =
[-3.27709532e+01 -1.92944723e+00 -8.49064375e-01 -8.49064375e-01
 -8.49064375e-01  7.80309300e-01  8.03740519e-01  8.03740519e-01
  8.03740519e-01  3.89112782e+00  3.89112782e+00  3.89112782e+00
  4.34742297e+00  1.42688745e+01  1.42688745e+01  1.42688745e+01
  1.58914656e+01  5.13779735e+01  5.29099798e+01  5.29099798e+01
  5.29099798e+01  1.61501504e+02  2.40674549e+02  2.40674549e+02
  2.40674549e+02  5.27531017e+02  1.89325389e+03  8.02009082e+03
  4.77842812e+04]
E1 = -182.58870259281426  E_coul = 54.04674997056115
Extra cycle  E= -128.541952622253  delta_E= -2.27e-12  |g|= 2.17e-06  |ddm|= 2.08e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1233.5073630051536
E1 = -182.58870259281426  E_coul = 54.04674997056115
init E= -128.541952622253
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.849065470661652  LUMO = 0.78030909272767
  mo_energy =
[-3.27709567e+01 -1.92944825e+00 -8.49065471e-01 -8.49065471e-01
 -8.49065471e-01  7.80309093e-01  8.03740268e-01  8.03740268e-01
  8.03740268e-01  3.89112687e+00  3.89112687e+00  3.89112687e+00
  4.34742221e+00  1.42688726e+01  1.42688726e+01  1.42688726e+01
  1.58914639e+01  5.13779709e+01  5.29099769e+01  5.29099769e+01
  5.29099769e+01  1.61501501e+02  2.40674546e+02  2.40674546e+02
  2.40674546e+02  5.27531013e+02  1.89325388e+03  8.02009082e+03
  4.77842812e+04]
E1 = -182.58871115240663  E_coul = 54.04675853015311
cycle= 1 E= -128.541952622254  delta_E= -3.98e-13  |g|= 1.17e-06  |ddm|= 7.76e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.58871115240663  E_coul = 54.04675853015311
  HOMO = -0.849064868449994  LUMO = 0.780309266845226
  mo_energy =
[-3.27709549e+01 -1.92944758e+00 -8.49064868e-01 -8.49064868e-01
 -8.49064868e-01  7.80309267e-01  8.03740419e-01  8.03740419e-01
  8.03740419e-01  3.89112741e+00  3.89112741e+00  3.89112741e+00
  4.34742269e+00  1.42688737e+01  1.42688737e+01  1.42688737e+01
  1.58914649e+01  5.13779723e+01  5.29099785e+01  5.29099785e+01
  5.29099785e+01  1.61501502e+02  2.40674547e+02  2.40674547e+02
  2.40674547e+02  5.27531015e+02  1.89325389e+03  8.02009082e+03
  4.77842812e+04]
E1 = -182.58870684567967  E_coul = 54.04675422342626
Extra cycle  E= -128.541952622253  delta_E= 1.14e-13  |g|= 5.85e-07  |ddm|= 3.85e-07
    CPU time for scf_cycle      0.45 sec, wall time      0.45 sec
exp = [7.83299831e-01 2.44137942e+04 3.66145018e+03 8.33347816e+02
 2.35136494e+02 7.71038073e+01 1.14974697e+01 2.83895564e+01
 3.05900929e-01 1.96581322e+00 4.98093499e+00 7.14030695e+00
 2.31635965e+01 9.97855356e+01 2.65212757e-01 2.44854017e+00
 8.34158642e-01]
grad_E = [-5.24616526e-04  9.54903052e-10 -4.64015854e-08  6.58756439e-07
 -1.60584118e-06 -1.37673540e-05 -8.24337472e-05 -3.24335476e-05
  1.16213289e-03  1.06273734e-04  5.00130328e-05  2.27311133e-04
 -4.64709543e-05  2.18473056e-06 -2.70570546e-03 -3.85812272e-04
  9.44800588e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.791456069996       1
[INPUT] 0    0    [1    /1   ]  24413.7942203        1
[INPUT] 0    0    [1    /1   ]  3661.44975717        1
[INPUT] 0    0    [1    /1   ]  833.356664225        1
[INPUT] 0    0    [1    /1   ]  235.036118686        1
[INPUT] 0    0    [1    /1   ]  77.4943982809        1
[INPUT] 0    0    [1    /1   ]  11.6477239492        1
[INPUT] 0    0    [1    /1   ]  28.6686873026        1
[INPUT] 0    0    [1    /1   ]  0.309909812968       1
[INPUT] 0    0    [1    /1   ]  1.98388669279        1
[INPUT] 0    0    [1    /1   ]  4.97497985191        1
[INPUT] 1    0    [1    /1   ]  7.15646713557        1
[INPUT] 1    0    [1    /1   ]  23.157328974         1
[INPUT] 1    0    [1    /1   ]  99.7857517356        1
[INPUT] 1    0    [1    /1   ]  0.264956885994       1
[INPUT] 1    0    [1    /1   ]  2.45269696961        1
[INPUT] 1    0    [1    /1   ]  0.834389327093       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7914560699958, 1.0]], [0, [24413.79422030048, 1.0]], [0, [3661.449757171382, 1.0]], [0, [833.3566642246274, 1.0]], [0, [235.03611868625057, 1.0]], [0, [77.49439828091155, 1.0]], [0, [11.647723949193264, 1.0]], [0, [28.66868730259935, 1.0]], [0, [0.3099098129679964, 1.0]], [0, [1.9838866927888414, 1.0]], [0, [4.974979851913289, 1.0]], [1, [7.15646713557378, 1.0]], [1, [23.157328974020512, 1.0]], [1, [99.78575173557228, 1.0]], [1, [0.26495688599418354, 1.0]], [1, [2.4526969696124463, 1.0]], [1, [0.8343893270926193, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79145607]
bas 1, expnt(s) = [24413.7942203]
bas 2, expnt(s) = [3661.44975717]
bas 3, expnt(s) = [833.35666422]
bas 4, expnt(s) = [235.03611869]
bas 5, expnt(s) = [77.49439828]
bas 6, expnt(s) = [11.64772395]
bas 7, expnt(s) = [28.6686873]
bas 8, expnt(s) = [0.30990981]
bas 9, expnt(s) = [1.98388669]
bas 10, expnt(s) = [4.97497985]
bas 11, expnt(s) = [7.15646714]
bas 12, expnt(s) = [23.15732897]
bas 13, expnt(s) = [99.78575174]
bas 14, expnt(s) = [0.26495689]
bas 15, expnt(s) = [2.45269697]
bas 16, expnt(s) = [0.83438933]
CPU time:       347.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.91456070e-01 2.11999646e+00 2.44137942e+04 4.93448103e+03
 3.66144976e+03 1.18919982e+03 8.33356664e+02 3.91866564e+02
 2.35036119e+02 1.51658229e+02 7.74943983e+01 6.59884241e+01
 1.16477239e+01 1.59292683e+01 2.86686873e+01 3.13019130e+01
 3.09909813e-01 1.04940111e+00 1.98388669e+00 4.22330720e+00
 4.97497985e+00 8.41605411e+00 7.15646714e+00 3.41474080e+01
 2.31573290e+01 1.48198898e+02 9.97857517e+01 9.20068282e+02
 2.64956886e-01 5.54566212e-01 2.45269697e+00 8.95445711e+00
 8.34389327e-01 2.32645854e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640840816113
cond(S) = 1233.2170565096094
E1 = -183.59017329273541  E_coul = 55.080136209097695
init E= -128.510037083638
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406762415514  LUMO = 0.813404673134115
  mo_energy =
[-3.25552430e+01 -1.85274869e+00 -7.75406762e-01 -7.75406762e-01
 -7.75406762e-01  8.13404673e-01  8.21259869e-01  8.21259869e-01
  8.21259869e-01  3.95912551e+00  3.95912551e+00  3.95912551e+00
  4.46186853e+00  1.44217782e+01  1.44217782e+01  1.44217782e+01
  1.61488677e+01  5.20537167e+01  5.31514250e+01  5.31514250e+01
  5.31514250e+01  1.63189530e+02  2.40948424e+02  2.40948424e+02
  2.40948424e+02  5.30308478e+02  1.89628156e+03  8.02289478e+03
  4.77866880e+04]
E1 = -182.08467803474733  E_coul = 53.54622279630645
cycle= 1 E= -128.538455238441  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519958
diis-c [-0.27035581  1.        ]
  HOMO = -0.884442295434026  LUMO = 0.783688329907929
  mo_energy =
[-3.28786523e+01 -1.96679817e+00 -8.84442295e-01 -8.84442295e-01
 -8.84442295e-01  7.83688330e-01  7.94493642e-01  7.94493642e-01
  7.94493642e-01  3.86125349e+00  3.86125349e+00  3.86125349e+00
  4.37533562e+00  1.42303185e+01  1.42303185e+01  1.42303185e+01
  1.59767933e+01  5.17965867e+01  5.28702091e+01  5.28702091e+01
  5.28702091e+01  1.62871379e+02  2.40601901e+02  2.40601901e+02
  2.40601901e+02  5.29947284e+02  1.89588398e+03  8.02246791e+03
  4.77862422e+04]
E1 = -182.8470593230292  E_coul = 54.306012860468904
cycle= 2 E= -128.54104646256  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0651
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.26456
diis-c [-0.00072733  0.33636043  0.66363957]
  HOMO = -0.848782619365417  LUMO = 0.793180727260112
  mo_energy =
[-3.27704685e+01 -1.92924810e+00 -8.48782619e-01 -8.48782619e-01
 -8.48782619e-01  7.93180727e-01  8.03215126e-01  8.03215126e-01
  8.03215126e-01  3.89299229e+00  3.89299229e+00  3.89299229e+00
  4.40337813e+00  1.42937403e+01  1.42937403e+01  1.42937403e+01
  1.60336299e+01  5.18827515e+01  5.29643157e+01  5.29643157e+01
  5.29643157e+01  1.62977458e+02  2.40715655e+02  2.40715655e+02
  2.40715655e+02  5.30064004e+02  1.89600609e+03  8.02259252e+03
  4.77863677e+04]
E1 = -182.58804804578637  E_coul = 54.046079057468006
cycle= 3 E= -128.541968988318  delta_E= -0.000923  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109652
diis-c [-1.82894259e-07 -2.37391103e-03 -8.49089407e-04  1.00322300e+00]
  HOMO = -0.849036389859163  LUMO = 0.793125880023067
  mo_energy =
[-3.27709112e+01 -1.92944006e+00 -8.49036390e-01 -8.49036390e-01
 -8.49036390e-01  7.93125880e-01  8.03175852e-01  8.03175852e-01
  8.03175852e-01  3.89281612e+00  3.89281612e+00  3.89281612e+00
  4.40322864e+00  1.42934412e+01  1.42934412e+01  1.42934412e+01
  1.60333604e+01  5.18823923e+01  5.29639239e+01  5.29639239e+01
  5.29639239e+01  1.62977010e+02  2.40715142e+02  2.40715142e+02
  2.40715142e+02  5.30063436e+02  1.89600538e+03  8.02259171e+03
  4.77863669e+04]
E1 = -182.58844883522465  E_coul = 54.04647982228373
cycle= 4 E= -128.541969012941  delta_E= -2.46e-08  |g|= 7.98e-05  |ddm|= 0.000333
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185148
diis-c [-1.05050662e-09  2.19056170e-04  5.15511371e-04 -1.77806884e-01
  1.17707232e+00]
  HOMO = -0.849079591717394  LUMO = 0.793112132044562
  mo_energy =
[-3.27709847e+01 -1.92947361e+00 -8.49079592e-01 -8.49079592e-01
 -8.49079592e-01  7.93112132e-01  8.03162412e-01  8.03162412e-01
  8.03162412e-01  3.89277557e+00  3.89277557e+00  3.89277557e+00
  4.40319517e+00  1.42933814e+01  1.42933814e+01  1.42933814e+01
  1.60333051e+01  5.18823252e+01  5.29638544e+01  5.29638544e+01
  5.29638544e+01  1.62976936e+02  2.40715064e+02  2.40715064e+02
  2.40715064e+02  5.30063354e+02  1.89600529e+03  8.02259162e+03
  4.77863668e+04]
E1 = -182.5885820602528  E_coul = 54.04661304662962
cycle= 5 E= -128.541969013623  delta_E= -6.82e-10  |g|= 5.62e-06  |ddm|= 5.51e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5885820602528  E_coul = 54.04661304662962
  HOMO = -0.849076678682895  LUMO = 0.79311339652028
  mo_energy =
[-3.27709780e+01 -1.92946992e+00 -8.49076679e-01 -8.49076679e-01
 -8.49076679e-01  7.93113397e-01  8.03163264e-01  8.03163264e-01
  8.03163264e-01  3.89277837e+00  3.89277837e+00  3.89277837e+00
  4.40319799e+00  1.42933862e+01  1.42933862e+01  1.42933862e+01
  1.60333097e+01  5.18823312e+01  5.29638607e+01  5.29638607e+01
  5.29638607e+01  1.62976943e+02  2.40715070e+02  2.40715070e+02
  2.40715070e+02  5.30063360e+02  1.89600530e+03  8.02259163e+03
  4.77863668e+04]
E1 = -182.58856685763092  E_coul = 54.04659784400507
Extra cycle  E= -128.541969013626  delta_E= -2.67e-12  |g|= 2.14e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [7.91456070e-01 2.44137942e+04 3.66144976e+03 8.33356664e+02
 2.35036119e+02 7.74943983e+01 1.16477239e+01 2.86686873e+01
 3.09909813e-01 1.98388669e+00 4.97497985e+00 7.15646714e+00
 2.31573290e+01 9.97857517e+01 2.64956886e-01 2.45269697e+00
 8.34389327e-01]
E = -128.54196901362585
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.791456069996       1
[INPUT] 0    0    [1    /1   ]  24413.7942203        1
[INPUT] 0    0    [1    /1   ]  3661.44975717        1
[INPUT] 0    0    [1    /1   ]  833.356664225        1
[INPUT] 0    0    [1    /1   ]  235.036118686        1
[INPUT] 0    0    [1    /1   ]  77.4943982809        1
[INPUT] 0    0    [1    /1   ]  11.6477239492        1
[INPUT] 0    0    [1    /1   ]  28.6686873026        1
[INPUT] 0    0    [1    /1   ]  0.309909812968       1
[INPUT] 0    0    [1    /1   ]  1.98388669279        1
[INPUT] 0    0    [1    /1   ]  4.97497985191        1
[INPUT] 1    0    [1    /1   ]  7.15646713557        1
[INPUT] 1    0    [1    /1   ]  23.157328974         1
[INPUT] 1    0    [1    /1   ]  99.7857517356        1
[INPUT] 1    0    [1    /1   ]  0.264956885994       1
[INPUT] 1    0    [1    /1   ]  2.45269696961        1
[INPUT] 1    0    [1    /1   ]  0.834389327093       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.7914560699958, 1.0]], [0, [24413.79422030048, 1.0]], [0, [3661.449757171382, 1.0]], [0, [833.3566642246274, 1.0]], [0, [235.03611868625057, 1.0]], [0, [77.49439828091155, 1.0]], [0, [11.647723949193264, 1.0]], [0, [28.66868730259935, 1.0]], [0, [0.3099098129679964, 1.0]], [0, [1.9838866927888414, 1.0]], [0, [4.974979851913289, 1.0]], [1, [7.15646713557378, 1.0]], [1, [23.157328974020512, 1.0]], [1, [99.78575173557228, 1.0]], [1, [0.26495688599418354, 1.0]], [1, [2.4526969696124463, 1.0]], [1, [0.8343893270926193, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.79145607]
bas 1, expnt(s) = [24413.7942203]
bas 2, expnt(s) = [3661.44975717]
bas 3, expnt(s) = [833.35666422]
bas 4, expnt(s) = [235.03611869]
bas 5, expnt(s) = [77.49439828]
bas 6, expnt(s) = [11.64772395]
bas 7, expnt(s) = [28.6686873]
bas 8, expnt(s) = [0.30990981]
bas 9, expnt(s) = [1.98388669]
bas 10, expnt(s) = [4.97497985]
bas 11, expnt(s) = [7.15646714]
bas 12, expnt(s) = [23.15732897]
bas 13, expnt(s) = [99.78575174]
bas 14, expnt(s) = [0.26495689]
bas 15, expnt(s) = [2.45269697]
bas 16, expnt(s) = [0.83438933]
CPU time:       348.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 7.91456070e-01 2.11999646e+00 2.44137942e+04 4.93448103e+03
 3.66144976e+03 1.18919982e+03 8.33356664e+02 3.91866564e+02
 2.35036119e+02 1.51658229e+02 7.74943983e+01 6.59884241e+01
 1.16477239e+01 1.59292683e+01 2.86686873e+01 3.13019130e+01
 3.09909813e-01 1.04940111e+00 1.98388669e+00 4.22330720e+00
 4.97497985e+00 8.41605411e+00 7.15646714e+00 3.41474080e+01
 2.31573290e+01 1.48198898e+02 9.97857517e+01 9.20068282e+02
 2.64956886e-01 5.54566212e-01 2.45269697e+00 8.95445711e+00
 8.34389327e-01 2.32645854e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640840816113
cond(S) = 1233.2170565096094
E1 = -183.59017329273541  E_coul = 55.080136209097695
init E= -128.510037083638
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406762415514  LUMO = 0.813404673134115
  mo_energy =
[-3.25552430e+01 -1.85274869e+00 -7.75406762e-01 -7.75406762e-01
 -7.75406762e-01  8.13404673e-01  8.21259869e-01  8.21259869e-01
  8.21259869e-01  3.95912551e+00  3.95912551e+00  3.95912551e+00
  4.46186853e+00  1.44217782e+01  1.44217782e+01  1.44217782e+01
  1.61488677e+01  5.20537167e+01  5.31514250e+01  5.31514250e+01
  5.31514250e+01  1.63189530e+02  2.40948424e+02  2.40948424e+02
  2.40948424e+02  5.30308478e+02  1.89628156e+03  8.02289478e+03
  4.77866880e+04]
E1 = -182.08467803474733  E_coul = 53.54622279630645
cycle= 1 E= -128.538455238441  delta_E= -0.0284  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519958
diis-c [-0.27035581  1.        ]
  HOMO = -0.884442295434026  LUMO = 0.783688329907929
  mo_energy =
[-3.28786523e+01 -1.96679817e+00 -8.84442295e-01 -8.84442295e-01
 -8.84442295e-01  7.83688330e-01  7.94493642e-01  7.94493642e-01
  7.94493642e-01  3.86125349e+00  3.86125349e+00  3.86125349e+00
  4.37533562e+00  1.42303185e+01  1.42303185e+01  1.42303185e+01
  1.59767933e+01  5.17965867e+01  5.28702091e+01  5.28702091e+01
  5.28702091e+01  1.62871379e+02  2.40601901e+02  2.40601901e+02
  2.40601901e+02  5.29947284e+02  1.89588398e+03  8.02246791e+03
  4.77862422e+04]
E1 = -182.8470593230292  E_coul = 54.306012860468904
cycle= 2 E= -128.54104646256  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0651
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26456
diis-c [-0.00072733  0.33636043  0.66363957]
  HOMO = -0.848782619365417  LUMO = 0.793180727260112
  mo_energy =
[-3.27704685e+01 -1.92924810e+00 -8.48782619e-01 -8.48782619e-01
 -8.48782619e-01  7.93180727e-01  8.03215126e-01  8.03215126e-01
  8.03215126e-01  3.89299229e+00  3.89299229e+00  3.89299229e+00
  4.40337813e+00  1.42937403e+01  1.42937403e+01  1.42937403e+01
  1.60336299e+01  5.18827515e+01  5.29643157e+01  5.29643157e+01
  5.29643157e+01  1.62977458e+02  2.40715655e+02  2.40715655e+02
  2.40715655e+02  5.30064004e+02  1.89600609e+03  8.02259252e+03
  4.77863677e+04]
E1 = -182.58804804578637  E_coul = 54.046079057468006
cycle= 3 E= -128.541968988318  delta_E= -0.000923  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109652
diis-c [-1.82894259e-07 -2.37391103e-03 -8.49089407e-04  1.00322300e+00]
  HOMO = -0.849036389859163  LUMO = 0.793125880023067
  mo_energy =
[-3.27709112e+01 -1.92944006e+00 -8.49036390e-01 -8.49036390e-01
 -8.49036390e-01  7.93125880e-01  8.03175852e-01  8.03175852e-01
  8.03175852e-01  3.89281612e+00  3.89281612e+00  3.89281612e+00
  4.40322864e+00  1.42934412e+01  1.42934412e+01  1.42934412e+01
  1.60333604e+01  5.18823923e+01  5.29639239e+01  5.29639239e+01
  5.29639239e+01  1.62977010e+02  2.40715142e+02  2.40715142e+02
  2.40715142e+02  5.30063436e+02  1.89600538e+03  8.02259171e+03
  4.77863669e+04]
E1 = -182.58844883522465  E_coul = 54.04647982228373
cycle= 4 E= -128.541969012941  delta_E= -2.46e-08  |g|= 7.98e-05  |ddm|= 0.000333
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185148
diis-c [-1.05050662e-09  2.19056170e-04  5.15511371e-04 -1.77806884e-01
  1.17707232e+00]
  HOMO = -0.849079591717394  LUMO = 0.793112132044562
  mo_energy =
[-3.27709847e+01 -1.92947361e+00 -8.49079592e-01 -8.49079592e-01
 -8.49079592e-01  7.93112132e-01  8.03162412e-01  8.03162412e-01
  8.03162412e-01  3.89277557e+00  3.89277557e+00  3.89277557e+00
  4.40319517e+00  1.42933814e+01  1.42933814e+01  1.42933814e+01
  1.60333051e+01  5.18823252e+01  5.29638544e+01  5.29638544e+01
  5.29638544e+01  1.62976936e+02  2.40715064e+02  2.40715064e+02
  2.40715064e+02  5.30063354e+02  1.89600529e+03  8.02259162e+03
  4.77863668e+04]
E1 = -182.5885820602528  E_coul = 54.04661304662962
cycle= 5 E= -128.541969013623  delta_E= -6.82e-10  |g|= 5.62e-06  |ddm|= 5.51e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5885820602528  E_coul = 54.04661304662962
  HOMO = -0.849076678682895  LUMO = 0.79311339652028
  mo_energy =
[-3.27709780e+01 -1.92946992e+00 -8.49076679e-01 -8.49076679e-01
 -8.49076679e-01  7.93113397e-01  8.03163264e-01  8.03163264e-01
  8.03163264e-01  3.89277837e+00  3.89277837e+00  3.89277837e+00
  4.40319799e+00  1.42933862e+01  1.42933862e+01  1.42933862e+01
  1.60333097e+01  5.18823312e+01  5.29638607e+01  5.29638607e+01
  5.29638607e+01  1.62976943e+02  2.40715070e+02  2.40715070e+02
  2.40715070e+02  5.30063360e+02  1.89600530e+03  8.02259163e+03
  4.77863668e+04]
E1 = -182.58856685763092  E_coul = 54.04659784400507
Extra cycle  E= -128.541969013626  delta_E= -2.67e-12  |g|= 2.14e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1233.2170565096094
E1 = -182.58856685763092  E_coul = 54.04659784400507
init E= -128.541969013626
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.849077757541722  LUMO = 0.793113188851628
  mo_energy =
[-3.27709814e+01 -1.92947091e+00 -8.49077758e-01 -8.49077758e-01
 -8.49077758e-01  7.93113189e-01  8.03163017e-01  8.03163017e-01
  8.03163017e-01  3.89277743e+00  3.89277743e+00  3.89277743e+00
  4.40319723e+00  1.42933843e+01  1.42933843e+01  1.42933843e+01
  1.60333080e+01  5.18823286e+01  5.29638578e+01  5.29638578e+01
  5.29638578e+01  1.62976939e+02  2.40715067e+02  2.40715067e+02
  2.40715067e+02  5.30063357e+02  1.89600530e+03  8.02259162e+03
  4.77863668e+04]
E1 = -182.58857526825446  E_coul = 54.046606254628486
cycle= 1 E= -128.541969013626  delta_E= -1.42e-13  |g|= 1.15e-06  |ddm|= 7.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58857526825446  E_coul = 54.046606254628486
  HOMO = -0.849077165938644  LUMO = 0.793113362561507
  mo_energy =
[-3.27709796e+01 -1.92947026e+00 -8.49077166e-01 -8.49077166e-01
 -8.49077166e-01  7.93113363e-01  8.03163164e-01  8.03163164e-01
  8.03163164e-01  3.89277796e+00  3.89277796e+00  3.89277796e+00
  4.40319772e+00  1.42933853e+01  1.42933853e+01  1.42933853e+01
  1.60333090e+01  5.18823300e+01  5.29638593e+01  5.29638593e+01
  5.29638593e+01  1.62976941e+02  2.40715069e+02  2.40715069e+02
  2.40715069e+02  5.30063359e+02  1.89600530e+03  8.02259162e+03
  4.77863668e+04]
E1 = -182.58857103516684  E_coul = 54.04660202154062
Extra cycle  E= -128.541969013626  delta_E= -2.27e-13  |g|= 5.75e-07  |ddm|= 3.79e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [7.91456070e-01 2.44137942e+04 3.66144976e+03 8.33356664e+02
 2.35036119e+02 7.74943983e+01 1.16477239e+01 2.86686873e+01
 3.09909813e-01 1.98388669e+00 4.97497985e+00 7.15646714e+00
 2.31573290e+01 9.97857517e+01 2.64956886e-01 2.45269697e+00
 8.34389327e-01]
grad_E = [-6.13647611e-04  1.80020790e-09 -8.93800184e-08  1.43003704e-06
 -7.71057912e-06  4.90539299e-06 -1.94324289e-05 -6.86810501e-05
  1.53460817e-03  1.04101480e-04  2.02200179e-05  3.60332136e-04
 -7.49679444e-05  3.55295575e-06 -3.45483701e-03 -5.56095258e-04
  1.13909290e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.800991500187       1
[INPUT] 0    0    [1    /1   ]  24413.7942332        1
[INPUT] 0    0    [1    /1   ]  3661.44906252        1
[INPUT] 0    0    [1    /1   ]  833.371246549        1
[INPUT] 0    0    [1    /1   ]  234.87107308         1
[INPUT] 0    0    [1    /1   ]  78.1238444838        1
[INPUT] 0    0    [1    /1   ]  11.9489099209        1
[INPUT] 0    0    [1    /1   ]  29.1903525692        1
[INPUT] 0    0    [1    /1   ]  0.312466160441       1
[INPUT] 0    0    [1    /1   ]  2.01548327689        1
[INPUT] 0    0    [1    /1   ]  5.04860470605        1
[INPUT] 1    0    [1    /1   ]  7.16278905606        1
[INPUT] 1    0    [1    /1   ]  23.1541273474        1
[INPUT] 1    0    [1    /1   ]  99.7857048899        1
[INPUT] 1    0    [1    /1   ]  0.264980592241       1
[INPUT] 1    0    [1    /1   ]  2.45415340441        1
[INPUT] 1    0    [1    /1   ]  0.834417211431       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8009915001871847, 1.0]], [0, [24413.794233202407, 1.0]], [0, [3661.4490625192925, 1.0]], [0, [833.3712465494436, 1.0]], [0, [234.87107308026648, 1.0]], [0, [78.12384448384933, 1.0]], [0, [11.948909920943521, 1.0]], [0, [29.190352569150022, 1.0]], [0, [0.3124661604407644, 1.0]], [0, [2.015483276885628, 1.0]], [0, [5.048604706046599, 1.0]], [1, [7.162789056062291, 1.0]], [1, [23.15412734738051, 1.0]], [1, [99.7857048898698, 1.0]], [1, [0.2649805922414765, 1.0]], [1, [2.4541534044088547, 1.0]], [1, [0.8344172114314917, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8009915]
bas 1, expnt(s) = [24413.7942332]
bas 2, expnt(s) = [3661.44906252]
bas 3, expnt(s) = [833.37124655]
bas 4, expnt(s) = [234.87107308]
bas 5, expnt(s) = [78.12384448]
bas 6, expnt(s) = [11.94890992]
bas 7, expnt(s) = [29.19035257]
bas 8, expnt(s) = [0.31246616]
bas 9, expnt(s) = [2.01548328]
bas 10, expnt(s) = [5.04860471]
bas 11, expnt(s) = [7.16278906]
bas 12, expnt(s) = [23.15412735]
bas 13, expnt(s) = [99.78570489]
bas 14, expnt(s) = [0.26498059]
bas 15, expnt(s) = [2.4541534]
bas 16, expnt(s) = [0.83441721]
CPU time:       352.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.00991500e-01 2.13912397e+00 2.44137942e+04 4.93448103e+03
 3.66144906e+03 1.18919965e+03 8.33371247e+02 3.91871707e+02
 2.34871073e+02 1.51578349e+02 7.81238445e+01 6.63900093e+01
 1.19489099e+01 1.62372037e+01 2.91903526e+01 3.17281339e+01
 3.12466160e-01 1.05588657e+00 2.01548328e+00 4.27365464e+00
 5.04860471e+00 8.50929441e+00 7.16278906e+00 3.41851189e+01
 2.31541273e+01 1.48173287e+02 9.97857049e+01 9.20067742e+02
 2.64980592e-01 5.54628236e-01 2.45415340e+00 8.96110416e+00
 8.34417211e-01 2.32655573e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640594572703
cond(S) = 1230.8588537609758
E1 = -183.59006528152833  E_coul = 55.080137536751344
init E= -128.509927744777
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775406309465464  LUMO = 0.821351337098846
  mo_energy =
[-3.25552573e+01 -1.85274744e+00 -7.75406309e-01 -7.75406309e-01
 -7.75406309e-01  8.21351337e-01  8.21351337e-01  8.21351337e-01
  8.25389377e-01  3.96001340e+00  3.96001340e+00  3.96001340e+00
  4.53800999e+00  1.44311708e+01  1.44311708e+01  1.44311708e+01
  1.64748070e+01  5.31711362e+01  5.31711362e+01  5.31711362e+01
  5.32491629e+01  1.66227630e+02  2.40961341e+02  2.40961341e+02
  2.40961341e+02  5.35154973e+02  1.90145542e+03  8.02758751e+03
  4.77905999e+04]
E1 = -182.0848132564743  E_coul = 53.546333351236676
cycle= 1 E= -128.538479905238  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519838
diis-c [-0.27023202  1.        ]
  HOMO = -0.884433154695844  LUMO = 0.794584841122111
  mo_energy =
[-3.28786457e+01 -1.96678910e+00 -8.84433155e-01 -8.84433155e-01
 -8.84433155e-01  7.94584841e-01  7.94584841e-01  7.94584841e-01
  7.95204274e-01  3.86211878e+00  3.86211878e+00  3.86211878e+00
  4.45023424e+00  1.42396524e+01  1.42396524e+01  1.42396524e+01
  1.63008614e+01  5.28899323e+01  5.28899323e+01  5.28899323e+01
  5.29904935e+01  1.65908925e+02  2.40614855e+02  2.40614855e+02
  2.40614855e+02  5.34793755e+02  1.90105791e+03  8.02716068e+03
  4.77901541e+04]
E1 = -182.84717257255767  E_coul = 54.30610149415597
cycle= 2 E= -128.541071078402  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264491
diis-c [-0.00073105  0.33634875  0.66365125]
  HOMO = -0.848773901336871  LUMO = 0.803307460326895
  mo_energy =
[-3.27704631e+01 -1.92923944e+00 -8.48773901e-01 -8.48773901e-01
 -8.48773901e-01  8.03307460e-01  8.03307460e-01  8.03307460e-01
  8.04848651e-01  3.89386797e+00  3.89386797e+00  3.89386797e+00
  4.47869000e+00  1.43030978e+01  1.43030978e+01  1.43030978e+01
  1.63583427e+01  5.29840387e+01  5.29840387e+01  5.29840387e+01
  5.30771907e+01  1.66015178e+02  2.40728606e+02  2.40728606e+02
  2.40728606e+02  5.34910486e+02  1.90118001e+03  8.02728528e+03
  4.77902797e+04]
E1 = -182.58817918825778  E_coul = 54.04618567882352
cycle= 3 E= -128.541993509434  delta_E= -0.000922  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109668
diis-c [-1.80706694e-07 -2.36504016e-03 -8.25829098e-04  1.00319087e+00]
  HOMO = -0.849027226853248  LUMO = 0.803268423377136
  mo_energy =
[-3.27709058e+01 -1.92943110e+00 -8.49027227e-01 -8.49027227e-01
 -8.49027227e-01  8.03268423e-01  8.03268423e-01  8.03268423e-01
  8.04793329e-01  3.89369217e+00  3.89369217e+00  3.89369217e+00
  4.47853900e+00  1.43027990e+01  1.43027990e+01  1.43027990e+01
  1.63580716e+01  5.29836470e+01  5.29836470e+01  5.29836470e+01
  5.30768300e+01  1.66014728e+02  2.40728093e+02  2.40728093e+02
  2.40728093e+02  5.34909917e+02  1.90117931e+03  8.02728448e+03
  4.77902788e+04]
E1 = -182.58858228796817  E_coul = 54.04658875411102
cycle= 4 E= -128.541993533857  delta_E= -2.44e-08  |g|= 7.96e-05  |ddm|= 0.00033
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185015
diis-c [-1.04646963e-09  2.18234384e-04  5.14722698e-04 -1.77363804e-01
  1.17663085e+00]
  HOMO = -0.849070299617371  LUMO = 0.803255042638287
  mo_energy =
[-3.27709792e+01 -1.92946457e+00 -8.49070300e-01 -8.49070300e-01
 -8.49070300e-01  8.03255043e-01  8.03255043e-01  8.03255043e-01
  8.04779461e-01  3.89365172e+00  3.89365172e+00  3.89365172e+00
  4.47850526e+00  1.43027393e+01  1.43027393e+01  1.43027393e+01
  1.63580161e+01  5.29835776e+01  5.29835776e+01  5.29835776e+01
  5.30767629e+01  1.66014655e+02  2.40728016e+02  2.40728016e+02
  2.40728016e+02  5.34909836e+02  1.90117922e+03  8.02728438e+03
  4.77902787e+04]
E1 = -182.58871575690716  E_coul = 54.04672222237373
cycle= 5 E= -128.541993534533  delta_E= -6.76e-10  |g|= 5.6e-06  |ddm|= 5.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58871575690716  E_coul = 54.04672222237373
  HOMO = -0.849067400902648  LUMO = 0.803255890289348
  mo_energy =
[-3.27709726e+01 -1.92946089e+00 -8.49067401e-01 -8.49067401e-01
 -8.49067401e-01  8.03255890e-01  8.03255890e-01  8.03255890e-01
  8.04780737e-01  3.89365451e+00  3.89365451e+00  3.89365451e+00
  4.47850810e+00  1.43027441e+01  1.43027441e+01  1.43027441e+01
  1.63580208e+01  5.29835838e+01  5.29835838e+01  5.29835838e+01
  5.30767689e+01  1.66014661e+02  2.40728022e+02  2.40728022e+02
  2.40728022e+02  5.34909842e+02  1.90117923e+03  8.02728439e+03
  4.77902787e+04]
E1 = -182.58870063366936  E_coul = 54.04670709913354
Extra cycle  E= -128.541993534536  delta_E= -2.39e-12  |g|= 2.13e-06  |ddm|= 2.04e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.00991500e-01 2.44137942e+04 3.66144906e+03 8.33371247e+02
 2.34871073e+02 7.81238445e+01 1.19489099e+01 2.91903526e+01
 3.12466160e-01 2.01548328e+00 5.04860471e+00 7.16278906e+00
 2.31541273e+01 9.97857049e+01 2.64980592e-01 2.45415340e+00
 8.34417211e-01]
E = -128.54199353453583
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.800991500187       1
[INPUT] 0    0    [1    /1   ]  24413.7942332        1
[INPUT] 0    0    [1    /1   ]  3661.44906252        1
[INPUT] 0    0    [1    /1   ]  833.371246549        1
[INPUT] 0    0    [1    /1   ]  234.87107308         1
[INPUT] 0    0    [1    /1   ]  78.1238444838        1
[INPUT] 0    0    [1    /1   ]  11.9489099209        1
[INPUT] 0    0    [1    /1   ]  29.1903525692        1
[INPUT] 0    0    [1    /1   ]  0.312466160441       1
[INPUT] 0    0    [1    /1   ]  2.01548327689        1
[INPUT] 0    0    [1    /1   ]  5.04860470605        1
[INPUT] 1    0    [1    /1   ]  7.16278905606        1
[INPUT] 1    0    [1    /1   ]  23.1541273474        1
[INPUT] 1    0    [1    /1   ]  99.7857048899        1
[INPUT] 1    0    [1    /1   ]  0.264980592241       1
[INPUT] 1    0    [1    /1   ]  2.45415340441        1
[INPUT] 1    0    [1    /1   ]  0.834417211431       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8009915001871847, 1.0]], [0, [24413.794233202407, 1.0]], [0, [3661.4490625192925, 1.0]], [0, [833.3712465494436, 1.0]], [0, [234.87107308026648, 1.0]], [0, [78.12384448384933, 1.0]], [0, [11.948909920943521, 1.0]], [0, [29.190352569150022, 1.0]], [0, [0.3124661604407644, 1.0]], [0, [2.015483276885628, 1.0]], [0, [5.048604706046599, 1.0]], [1, [7.162789056062291, 1.0]], [1, [23.15412734738051, 1.0]], [1, [99.7857048898698, 1.0]], [1, [0.2649805922414765, 1.0]], [1, [2.4541534044088547, 1.0]], [1, [0.8344172114314917, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8009915]
bas 1, expnt(s) = [24413.7942332]
bas 2, expnt(s) = [3661.44906252]
bas 3, expnt(s) = [833.37124655]
bas 4, expnt(s) = [234.87107308]
bas 5, expnt(s) = [78.12384448]
bas 6, expnt(s) = [11.94890992]
bas 7, expnt(s) = [29.19035257]
bas 8, expnt(s) = [0.31246616]
bas 9, expnt(s) = [2.01548328]
bas 10, expnt(s) = [5.04860471]
bas 11, expnt(s) = [7.16278906]
bas 12, expnt(s) = [23.15412735]
bas 13, expnt(s) = [99.78570489]
bas 14, expnt(s) = [0.26498059]
bas 15, expnt(s) = [2.4541534]
bas 16, expnt(s) = [0.83441721]
CPU time:       353.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.00991500e-01 2.13912397e+00 2.44137942e+04 4.93448103e+03
 3.66144906e+03 1.18919965e+03 8.33371247e+02 3.91871707e+02
 2.34871073e+02 1.51578349e+02 7.81238445e+01 6.63900093e+01
 1.19489099e+01 1.62372037e+01 2.91903526e+01 3.17281339e+01
 3.12466160e-01 1.05588657e+00 2.01548328e+00 4.27365464e+00
 5.04860471e+00 8.50929441e+00 7.16278906e+00 3.41851189e+01
 2.31541273e+01 1.48173287e+02 9.97857049e+01 9.20067742e+02
 2.64980592e-01 5.54628236e-01 2.45415340e+00 8.96110416e+00
 8.34417211e-01 2.32655573e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640594572703
cond(S) = 1230.8588537609758
E1 = -183.59006528152833  E_coul = 55.080137536751344
init E= -128.509927744777
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775406309465464  LUMO = 0.821351337098846
  mo_energy =
[-3.25552573e+01 -1.85274744e+00 -7.75406309e-01 -7.75406309e-01
 -7.75406309e-01  8.21351337e-01  8.21351337e-01  8.21351337e-01
  8.25389377e-01  3.96001340e+00  3.96001340e+00  3.96001340e+00
  4.53800999e+00  1.44311708e+01  1.44311708e+01  1.44311708e+01
  1.64748070e+01  5.31711362e+01  5.31711362e+01  5.31711362e+01
  5.32491629e+01  1.66227630e+02  2.40961341e+02  2.40961341e+02
  2.40961341e+02  5.35154973e+02  1.90145542e+03  8.02758751e+03
  4.77905999e+04]
E1 = -182.0848132564743  E_coul = 53.546333351236676
cycle= 1 E= -128.538479905238  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.151
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.519838
diis-c [-0.27023202  1.        ]
  HOMO = -0.884433154695844  LUMO = 0.794584841122111
  mo_energy =
[-3.28786457e+01 -1.96678910e+00 -8.84433155e-01 -8.84433155e-01
 -8.84433155e-01  7.94584841e-01  7.94584841e-01  7.94584841e-01
  7.95204274e-01  3.86211878e+00  3.86211878e+00  3.86211878e+00
  4.45023424e+00  1.42396524e+01  1.42396524e+01  1.42396524e+01
  1.63008614e+01  5.28899323e+01  5.28899323e+01  5.28899323e+01
  5.29904935e+01  1.65908925e+02  2.40614855e+02  2.40614855e+02
  2.40614855e+02  5.34793755e+02  1.90105791e+03  8.02716068e+03
  4.77901541e+04]
E1 = -182.84717257255767  E_coul = 54.30610149415597
cycle= 2 E= -128.541071078402  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0652
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264491
diis-c [-0.00073105  0.33634875  0.66365125]
  HOMO = -0.848773901336871  LUMO = 0.803307460326895
  mo_energy =
[-3.27704631e+01 -1.92923944e+00 -8.48773901e-01 -8.48773901e-01
 -8.48773901e-01  8.03307460e-01  8.03307460e-01  8.03307460e-01
  8.04848651e-01  3.89386797e+00  3.89386797e+00  3.89386797e+00
  4.47869000e+00  1.43030978e+01  1.43030978e+01  1.43030978e+01
  1.63583427e+01  5.29840387e+01  5.29840387e+01  5.29840387e+01
  5.30771907e+01  1.66015178e+02  2.40728606e+02  2.40728606e+02
  2.40728606e+02  5.34910486e+02  1.90118001e+03  8.02728528e+03
  4.77902797e+04]
E1 = -182.58817918825778  E_coul = 54.04618567882352
cycle= 3 E= -128.541993509434  delta_E= -0.000922  |g|= 0.000499  |ddm|= 0.0225
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109668
diis-c [-1.80706694e-07 -2.36504016e-03 -8.25829098e-04  1.00319087e+00]
  HOMO = -0.849027226853248  LUMO = 0.803268423377136
  mo_energy =
[-3.27709058e+01 -1.92943110e+00 -8.49027227e-01 -8.49027227e-01
 -8.49027227e-01  8.03268423e-01  8.03268423e-01  8.03268423e-01
  8.04793329e-01  3.89369217e+00  3.89369217e+00  3.89369217e+00
  4.47853900e+00  1.43027990e+01  1.43027990e+01  1.43027990e+01
  1.63580716e+01  5.29836470e+01  5.29836470e+01  5.29836470e+01
  5.30768300e+01  1.66014728e+02  2.40728093e+02  2.40728093e+02
  2.40728093e+02  5.34909917e+02  1.90117931e+03  8.02728448e+03
  4.77902788e+04]
E1 = -182.58858228796817  E_coul = 54.04658875411102
cycle= 4 E= -128.541993533857  delta_E= -2.44e-08  |g|= 7.96e-05  |ddm|= 0.00033
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185015
diis-c [-1.04646963e-09  2.18234384e-04  5.14722698e-04 -1.77363804e-01
  1.17663085e+00]
  HOMO = -0.849070299617371  LUMO = 0.803255042638287
  mo_energy =
[-3.27709792e+01 -1.92946457e+00 -8.49070300e-01 -8.49070300e-01
 -8.49070300e-01  8.03255043e-01  8.03255043e-01  8.03255043e-01
  8.04779461e-01  3.89365172e+00  3.89365172e+00  3.89365172e+00
  4.47850526e+00  1.43027393e+01  1.43027393e+01  1.43027393e+01
  1.63580161e+01  5.29835776e+01  5.29835776e+01  5.29835776e+01
  5.30767629e+01  1.66014655e+02  2.40728016e+02  2.40728016e+02
  2.40728016e+02  5.34909836e+02  1.90117922e+03  8.02728438e+03
  4.77902787e+04]
E1 = -182.58871575690716  E_coul = 54.04672222237373
cycle= 5 E= -128.541993534533  delta_E= -6.76e-10  |g|= 5.6e-06  |ddm|= 5.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58871575690716  E_coul = 54.04672222237373
  HOMO = -0.849067400902648  LUMO = 0.803255890289348
  mo_energy =
[-3.27709726e+01 -1.92946089e+00 -8.49067401e-01 -8.49067401e-01
 -8.49067401e-01  8.03255890e-01  8.03255890e-01  8.03255890e-01
  8.04780737e-01  3.89365451e+00  3.89365451e+00  3.89365451e+00
  4.47850810e+00  1.43027441e+01  1.43027441e+01  1.43027441e+01
  1.63580208e+01  5.29835838e+01  5.29835838e+01  5.29835838e+01
  5.30767689e+01  1.66014661e+02  2.40728022e+02  2.40728022e+02
  2.40728022e+02  5.34909842e+02  1.90117923e+03  8.02728439e+03
  4.77902787e+04]
E1 = -182.58870063366936  E_coul = 54.04670709913354
Extra cycle  E= -128.541993534536  delta_E= -2.39e-12  |g|= 2.13e-06  |ddm|= 2.04e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1230.8588537609758
E1 = -182.58870063366936  E_coul = 54.04670709913354
init E= -128.541993534536
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.849068474178958  LUMO = 0.803255644109384
  mo_energy =
[-3.27709759e+01 -1.92946188e+00 -8.49068474e-01 -8.49068474e-01
 -8.49068474e-01  8.03255644e-01  8.03255644e-01  8.03255644e-01
  8.04780527e-01  3.89365358e+00  3.89365358e+00  3.89365358e+00
  4.47850733e+00  1.43027422e+01  1.43027422e+01  1.43027422e+01
  1.63580191e+01  5.29835809e+01  5.29835809e+01  5.29835809e+01
  5.30767662e+01  1.66014658e+02  2.40728018e+02  2.40728018e+02
  2.40728018e+02  5.34909838e+02  1.90117922e+03  8.02728439e+03
  4.77902787e+04]
E1 = -182.58870900122338  E_coul = 54.04671546668726
cycle= 1 E= -128.541993534536  delta_E= -2.84e-13  |g|= 1.15e-06  |ddm|= 7.59e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58870900122338  E_coul = 54.04671546668726
  HOMO = -0.849067885623791  LUMO = 0.8032557912771
  mo_energy =
[-3.27709741e+01 -1.92946123e+00 -8.49067886e-01 -8.49067886e-01
 -8.49067886e-01  8.03255791e-01  8.03255791e-01  8.03255791e-01
  8.04780703e-01  3.89365411e+00  3.89365411e+00  3.89365411e+00
  4.47850782e+00  1.43027432e+01  1.43027432e+01  1.43027432e+01
  1.63580200e+01  5.29835825e+01  5.29835825e+01  5.29835825e+01
  5.30767677e+01  1.66014660e+02  2.40728020e+02  2.40728020e+02
  2.40728020e+02  5.34909840e+02  1.90117922e+03  8.02728439e+03
  4.77902787e+04]
E1 = -182.58870479017534  E_coul = 54.04671125563885
Extra cycle  E= -128.541993534536  delta_E= -3.69e-13  |g|= 5.72e-07  |ddm|= 3.78e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [8.00991500e-01 2.44137942e+04 3.66144906e+03 8.33371247e+02
 2.34871073e+02 7.81238445e+01 1.19489099e+01 2.91903526e+01
 3.12466160e-01 2.01548328e+00 5.04860471e+00 7.16278906e+00
 2.31541273e+01 9.97857049e+01 2.64980592e-01 2.45415340e+00
 8.34417211e-01]
grad_E = [-5.71732027e-04  2.94911222e-09 -1.47299620e-07  2.45650758e-06
 -1.51553985e-05  2.27425731e-05  5.82105809e-05 -9.96796522e-05
  1.56354980e-03  7.47170689e-05 -2.17454511e-05  4.10114642e-04
 -8.63237298e-05  4.11469220e-06 -3.20721511e-03 -5.82905779e-04
  9.76804110e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.818080713177       1
[INPUT] 0    0    [1    /1   ]  24413.7942508        1
[INPUT] 0    0    [1    /1   ]  3661.44811583        1
[INPUT] 0    0    [1    /1   ]  833.391049566        1
[INPUT] 0    0    [1    /1   ]  234.648846892        1
[INPUT] 0    0    [1    /1   ]  78.9459882352        1
[INPUT] 0    0    [1    /1   ]  12.4608973504        1
[INPUT] 0    0    [1    /1   ]  29.9726810464        1
[INPUT] 0    0    [1    /1   ]  0.314191466099       1
[INPUT] 0    0    [1    /1   ]  2.08014313897        1
[INPUT] 0    0    [1    /1   ]  5.37971408538        1
[INPUT] 1    0    [1    /1   ]  7.14892017194        1
[INPUT] 1    0    [1    /1   ]  23.1580192746        1
[INPUT] 1    0    [1    /1   ]  99.7851220247        1
[INPUT] 1    0    [1    /1   ]  0.265371646026       1
[INPUT] 1    0    [1    /1   ]  2.45024734797        1
[INPUT] 1    0    [1    /1   ]  0.834046707311       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8180807131773036, 1.0]], [0, [24413.79425078835, 1.0]], [0, [3661.448115829056, 1.0]], [0, [833.3910495662508, 1.0]], [0, [234.6488468922797, 1.0]], [0, [78.94598823519306, 1.0]], [0, [12.460897350400376, 1.0]], [0, [29.972681046350257, 1.0]], [0, [0.3141914660987584, 1.0]], [0, [2.080143138968694, 1.0]], [0, [5.379714085376607, 1.0]], [1, [7.148920171938248, 1.0]], [1, [23.15801927463106, 1.0]], [1, [99.78512202467485, 1.0]], [1, [0.2653716460259035, 1.0]], [1, [2.4502473479713585, 1.0]], [1, [0.8340467073109824, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81808071]
bas 1, expnt(s) = [24413.79425079]
bas 2, expnt(s) = [3661.44811583]
bas 3, expnt(s) = [833.39104957]
bas 4, expnt(s) = [234.64884689]
bas 5, expnt(s) = [78.94598824]
bas 6, expnt(s) = [12.46089735]
bas 7, expnt(s) = [29.97268105]
bas 8, expnt(s) = [0.31419147]
bas 9, expnt(s) = [2.08014314]
bas 10, expnt(s) = [5.37971409]
bas 11, expnt(s) = [7.14892017]
bas 12, expnt(s) = [23.15801927]
bas 13, expnt(s) = [99.78512202]
bas 14, expnt(s) = [0.26537165]
bas 15, expnt(s) = [2.45024735]
bas 16, expnt(s) = [0.83404671]
CPU time:       357.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.18080713e-01 2.17326227e+00 2.44137943e+04 4.93448104e+03
 3.66144812e+03 1.18919942e+03 8.33391050e+02 3.91878691e+02
 2.34648847e+02 1.51470773e+02 7.89459882e+01 6.69133192e+01
 1.24608974e+01 1.67562570e+01 2.99726810e+01 3.23637784e+01
 3.14191466e-01 1.06025618e+00 2.08014314e+00 4.37607685e+00
 5.37971409e+00 8.92451082e+00 7.14892017e+00 3.41024006e+01
 2.31580193e+01 1.48204420e+02 9.97851220e+01 9.20061024e+02
 2.65371646e-01 5.55651563e-01 2.45024735e+00 8.94327947e+00
 8.34046707e-01 2.32526448e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640749888663
cond(S) = 1271.955037900366
E1 = -183.59004161360144  E_coul = 55.08015961781777
init E= -128.509881995784
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775404690458387  LUMO = 0.822260266626656
  mo_energy =
[-3.25552692e+01 -1.85274350e+00 -7.75404690e-01 -7.75404690e-01
 -7.75404690e-01  8.22260267e-01  8.22260267e-01  8.22260267e-01
  8.42163614e-01  3.95853531e+00  3.95853531e+00  3.95853531e+00
  4.68985529e+00  1.44090829e+01  1.44090829e+01  1.44090829e+01
  1.73198808e+01  5.31218190e+01  5.31218190e+01  5.31218190e+01
  5.59265926e+01  1.71827162e+02  2.40920259e+02  2.40920259e+02
  2.40920259e+02  5.43259425e+02  1.90990121e+03  8.03522363e+03
  4.77969613e+04]
E1 = -182.08543277003997  E_coul = 53.54692051934615
cycle= 1 E= -128.538512250694  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.519401
diis-c [-0.26977735  1.        ]
  HOMO = -0.884385673139816  LUMO = 0.795496691330559
  mo_energy =
[-3.28785707e+01 -1.96672744e+00 -8.84385673e-01 -8.84385673e-01
 -8.84385673e-01  7.95496691e-01  7.95496691e-01  7.95496691e-01
  8.11243146e-01  3.86079232e+00  3.86079232e+00  3.86079232e+00
  4.59911931e+00  1.42178017e+01  1.42178017e+01  1.42178017e+01
  1.71411067e+01  5.28407099e+01  5.28407099e+01  5.28407099e+01
  5.56651430e+01  1.71507758e+02  2.40573856e+02  2.40573856e+02
  2.40573856e+02  5.42898266e+02  1.90950385e+03  8.03479692e+03
  4.77965157e+04]
E1 = -182.84747524324564  E_coul = 54.306373086330936
cycle= 2 E= -128.541102156915  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264252
diis-c [-0.00074149  0.33632024  0.66367976]
  HOMO = -0.84874030880215  LUMO = 0.804220692625483
  mo_energy =
[-3.27704258e+01 -1.92919270e+00 -8.48740309e-01 -8.48740309e-01
 -8.48740309e-01  8.04220693e-01  8.04220693e-01  8.04220693e-01
  8.21128693e-01  3.89249512e+00  3.89249512e+00  3.89249512e+00
  4.62855811e+00  1.42811658e+01  1.42811658e+01  1.42811658e+01
  1.72002460e+01  5.29347789e+01  5.29347789e+01  5.29347789e+01
  5.57527880e+01  1.71614211e+02  2.40687570e+02  2.40687570e+02
  2.40687570e+02  5.43014963e+02  1.90962590e+03  8.03492147e+03
  4.77966412e+04]
E1 = -182.5886379899046  E_coul = 54.04661427766265
cycle= 3 E= -128.542023712242  delta_E= -0.000922  |g|= 0.000495  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109231
diis-c [-1.80142308e-07 -2.35794467e-03 -8.25864393e-04  1.00318381e+00]
  HOMO = -0.848991701229434  LUMO = 0.804182489785383
  mo_energy =
[-3.27708648e+01 -1.92938147e+00 -8.48991701e-01 -8.48991701e-01
 -8.48991701e-01  8.04182490e-01  8.04182490e-01  8.04182490e-01
  8.21073701e-01  3.89232148e+00  3.89232148e+00  3.89232148e+00
  4.62840488e+00  1.42808702e+01  1.42808702e+01  1.42808702e+01
  1.71999726e+01  5.29343908e+01  5.29343908e+01  5.29343908e+01
  5.57524275e+01  1.71613764e+02  2.40687061e+02  2.40687061e+02
  2.40687061e+02  5.43014398e+02  1.90962520e+03  8.03492067e+03
  4.77966403e+04]
E1 = -182.58903847405546  E_coul = 54.04701473766872
cycle= 4 E= -128.542023736387  delta_E= -2.41e-08  |g|= 7.96e-05  |ddm|= 0.000323
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185847
diis-c [-1.06629845e-09  2.21239135e-04  5.22043695e-04 -1.78922407e-01
  1.17817912e+00]
  HOMO = -0.84903463373132  LUMO = 0.804169209215874
  mo_energy =
[-3.27709381e+01 -1.92941453e+00 -8.49034634e-01 -8.49034634e-01
 -8.49034634e-01  8.04169209e-01  8.04169209e-01  8.04169209e-01
  8.21059795e-01  3.89228125e+00  3.89228125e+00  3.89228125e+00
  4.62837055e+00  1.42808107e+01  1.42808107e+01  1.42808107e+01
  1.71999165e+01  5.29343215e+01  5.29343215e+01  5.29343215e+01
  5.57523602e+01  1.71613690e+02  2.40686983e+02  2.40686983e+02
  2.40686983e+02  5.43014316e+02  1.90962511e+03  8.03492058e+03
  4.77966402e+04]
E1 = -182.5891730364723  E_coul = 54.0471492994063
cycle= 5 E= -128.542023737066  delta_E= -6.79e-10  |g|= 5.69e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5891730364723  E_coul = 54.0471492994063
  HOMO = -0.849031683857714  LUMO = 0.804170074174874
  mo_energy =
[-3.27709314e+01 -1.92941079e+00 -8.49031684e-01 -8.49031684e-01
 -8.49031684e-01  8.04170074e-01  8.04170074e-01  8.04170074e-01
  8.21061124e-01  3.89228408e+00  3.89228408e+00  3.89228408e+00
  4.62837352e+00  1.42808156e+01  1.42808156e+01  1.42808156e+01
  1.71999213e+01  5.29343278e+01  5.29343278e+01  5.29343278e+01
  5.57523663e+01  1.71613696e+02  2.40686989e+02  2.40686989e+02
  2.40686989e+02  5.43014322e+02  1.90962512e+03  8.03492058e+03
  4.77966402e+04]
E1 = -182.58915779588827  E_coul = 54.04713405881975
Extra cycle  E= -128.542023737069  delta_E= -2.53e-12  |g|= 2.14e-06  |ddm|= 2.08e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.18080713e-01 2.44137943e+04 3.66144812e+03 8.33391050e+02
 2.34648847e+02 7.89459882e+01 1.24608974e+01 2.99726810e+01
 3.14191466e-01 2.08014314e+00 5.37971409e+00 7.14892017e+00
 2.31580193e+01 9.97851220e+01 2.65371646e-01 2.45024735e+00
 8.34046707e-01]
E = -128.54202373706852
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.818080713177       1
[INPUT] 0    0    [1    /1   ]  24413.7942508        1
[INPUT] 0    0    [1    /1   ]  3661.44811583        1
[INPUT] 0    0    [1    /1   ]  833.391049566        1
[INPUT] 0    0    [1    /1   ]  234.648846892        1
[INPUT] 0    0    [1    /1   ]  78.9459882352        1
[INPUT] 0    0    [1    /1   ]  12.4608973504        1
[INPUT] 0    0    [1    /1   ]  29.9726810464        1
[INPUT] 0    0    [1    /1   ]  0.314191466099       1
[INPUT] 0    0    [1    /1   ]  2.08014313897        1
[INPUT] 0    0    [1    /1   ]  5.37971408538        1
[INPUT] 1    0    [1    /1   ]  7.14892017194        1
[INPUT] 1    0    [1    /1   ]  23.1580192746        1
[INPUT] 1    0    [1    /1   ]  99.7851220247        1
[INPUT] 1    0    [1    /1   ]  0.265371646026       1
[INPUT] 1    0    [1    /1   ]  2.45024734797        1
[INPUT] 1    0    [1    /1   ]  0.834046707311       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8180807131773036, 1.0]], [0, [24413.79425078835, 1.0]], [0, [3661.448115829056, 1.0]], [0, [833.3910495662508, 1.0]], [0, [234.6488468922797, 1.0]], [0, [78.94598823519306, 1.0]], [0, [12.460897350400376, 1.0]], [0, [29.972681046350257, 1.0]], [0, [0.3141914660987584, 1.0]], [0, [2.080143138968694, 1.0]], [0, [5.379714085376607, 1.0]], [1, [7.148920171938248, 1.0]], [1, [23.15801927463106, 1.0]], [1, [99.78512202467485, 1.0]], [1, [0.2653716460259035, 1.0]], [1, [2.4502473479713585, 1.0]], [1, [0.8340467073109824, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81808071]
bas 1, expnt(s) = [24413.79425079]
bas 2, expnt(s) = [3661.44811583]
bas 3, expnt(s) = [833.39104957]
bas 4, expnt(s) = [234.64884689]
bas 5, expnt(s) = [78.94598824]
bas 6, expnt(s) = [12.46089735]
bas 7, expnt(s) = [29.97268105]
bas 8, expnt(s) = [0.31419147]
bas 9, expnt(s) = [2.08014314]
bas 10, expnt(s) = [5.37971409]
bas 11, expnt(s) = [7.14892017]
bas 12, expnt(s) = [23.15801927]
bas 13, expnt(s) = [99.78512202]
bas 14, expnt(s) = [0.26537165]
bas 15, expnt(s) = [2.45024735]
bas 16, expnt(s) = [0.83404671]
CPU time:       358.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.18080713e-01 2.17326227e+00 2.44137943e+04 4.93448104e+03
 3.66144812e+03 1.18919942e+03 8.33391050e+02 3.91878691e+02
 2.34648847e+02 1.51470773e+02 7.89459882e+01 6.69133192e+01
 1.24608974e+01 1.67562570e+01 2.99726810e+01 3.23637784e+01
 3.14191466e-01 1.06025618e+00 2.08014314e+00 4.37607685e+00
 5.37971409e+00 8.92451082e+00 7.14892017e+00 3.41024006e+01
 2.31580193e+01 1.48204420e+02 9.97851220e+01 9.20061024e+02
 2.65371646e-01 5.55651563e-01 2.45024735e+00 8.94327947e+00
 8.34046707e-01 2.32526448e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999640749888663
cond(S) = 1271.955037900366
E1 = -183.59004161360144  E_coul = 55.08015961781777
init E= -128.509881995784
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775404690458387  LUMO = 0.822260266626656
  mo_energy =
[-3.25552692e+01 -1.85274350e+00 -7.75404690e-01 -7.75404690e-01
 -7.75404690e-01  8.22260267e-01  8.22260267e-01  8.22260267e-01
  8.42163614e-01  3.95853531e+00  3.95853531e+00  3.95853531e+00
  4.68985529e+00  1.44090829e+01  1.44090829e+01  1.44090829e+01
  1.73198808e+01  5.31218190e+01  5.31218190e+01  5.31218190e+01
  5.59265926e+01  1.71827162e+02  2.40920259e+02  2.40920259e+02
  2.40920259e+02  5.43259425e+02  1.90990121e+03  8.03522363e+03
  4.77969613e+04]
E1 = -182.08543277003997  E_coul = 53.54692051934615
cycle= 1 E= -128.538512250694  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.519401
diis-c [-0.26977735  1.        ]
  HOMO = -0.884385673139816  LUMO = 0.795496691330559
  mo_energy =
[-3.28785707e+01 -1.96672744e+00 -8.84385673e-01 -8.84385673e-01
 -8.84385673e-01  7.95496691e-01  7.95496691e-01  7.95496691e-01
  8.11243146e-01  3.86079232e+00  3.86079232e+00  3.86079232e+00
  4.59911931e+00  1.42178017e+01  1.42178017e+01  1.42178017e+01
  1.71411067e+01  5.28407099e+01  5.28407099e+01  5.28407099e+01
  5.56651430e+01  1.71507758e+02  2.40573856e+02  2.40573856e+02
  2.40573856e+02  5.42898266e+02  1.90950385e+03  8.03479692e+03
  4.77965157e+04]
E1 = -182.84747524324564  E_coul = 54.306373086330936
cycle= 2 E= -128.541102156915  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0653
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264252
diis-c [-0.00074149  0.33632024  0.66367976]
  HOMO = -0.84874030880215  LUMO = 0.804220692625483
  mo_energy =
[-3.27704258e+01 -1.92919270e+00 -8.48740309e-01 -8.48740309e-01
 -8.48740309e-01  8.04220693e-01  8.04220693e-01  8.04220693e-01
  8.21128693e-01  3.89249512e+00  3.89249512e+00  3.89249512e+00
  4.62855811e+00  1.42811658e+01  1.42811658e+01  1.42811658e+01
  1.72002460e+01  5.29347789e+01  5.29347789e+01  5.29347789e+01
  5.57527880e+01  1.71614211e+02  2.40687570e+02  2.40687570e+02
  2.40687570e+02  5.43014963e+02  1.90962590e+03  8.03492147e+03
  4.77966412e+04]
E1 = -182.5886379899046  E_coul = 54.04661427766265
cycle= 3 E= -128.542023712242  delta_E= -0.000922  |g|= 0.000495  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109231
diis-c [-1.80142308e-07 -2.35794467e-03 -8.25864393e-04  1.00318381e+00]
  HOMO = -0.848991701229434  LUMO = 0.804182489785383
  mo_energy =
[-3.27708648e+01 -1.92938147e+00 -8.48991701e-01 -8.48991701e-01
 -8.48991701e-01  8.04182490e-01  8.04182490e-01  8.04182490e-01
  8.21073701e-01  3.89232148e+00  3.89232148e+00  3.89232148e+00
  4.62840488e+00  1.42808702e+01  1.42808702e+01  1.42808702e+01
  1.71999726e+01  5.29343908e+01  5.29343908e+01  5.29343908e+01
  5.57524275e+01  1.71613764e+02  2.40687061e+02  2.40687061e+02
  2.40687061e+02  5.43014398e+02  1.90962520e+03  8.03492067e+03
  4.77966403e+04]
E1 = -182.58903847405546  E_coul = 54.04701473766872
cycle= 4 E= -128.542023736387  delta_E= -2.41e-08  |g|= 7.96e-05  |ddm|= 0.000323
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000185847
diis-c [-1.06629845e-09  2.21239135e-04  5.22043695e-04 -1.78922407e-01
  1.17817912e+00]
  HOMO = -0.84903463373132  LUMO = 0.804169209215874
  mo_energy =
[-3.27709381e+01 -1.92941453e+00 -8.49034634e-01 -8.49034634e-01
 -8.49034634e-01  8.04169209e-01  8.04169209e-01  8.04169209e-01
  8.21059795e-01  3.89228125e+00  3.89228125e+00  3.89228125e+00
  4.62837055e+00  1.42808107e+01  1.42808107e+01  1.42808107e+01
  1.71999165e+01  5.29343215e+01  5.29343215e+01  5.29343215e+01
  5.57523602e+01  1.71613690e+02  2.40686983e+02  2.40686983e+02
  2.40686983e+02  5.43014316e+02  1.90962511e+03  8.03492058e+03
  4.77966402e+04]
E1 = -182.5891730364723  E_coul = 54.0471492994063
cycle= 5 E= -128.542023737066  delta_E= -6.79e-10  |g|= 5.69e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5891730364723  E_coul = 54.0471492994063
  HOMO = -0.849031683857714  LUMO = 0.804170074174874
  mo_energy =
[-3.27709314e+01 -1.92941079e+00 -8.49031684e-01 -8.49031684e-01
 -8.49031684e-01  8.04170074e-01  8.04170074e-01  8.04170074e-01
  8.21061124e-01  3.89228408e+00  3.89228408e+00  3.89228408e+00
  4.62837352e+00  1.42808156e+01  1.42808156e+01  1.42808156e+01
  1.71999213e+01  5.29343278e+01  5.29343278e+01  5.29343278e+01
  5.57523663e+01  1.71613696e+02  2.40686989e+02  2.40686989e+02
  2.40686989e+02  5.43014322e+02  1.90962512e+03  8.03492058e+03
  4.77966402e+04]
E1 = -182.58915779588827  E_coul = 54.04713405881975
Extra cycle  E= -128.542023737069  delta_E= -2.53e-12  |g|= 2.14e-06  |ddm|= 2.08e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1271.955037900366
E1 = -182.58915779588827  E_coul = 54.04713405881975
init E= -128.542023737069
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.849032764413993  LUMO = 0.804169826622965
  mo_energy =
[-3.27709348e+01 -1.92941179e+00 -8.49032764e-01 -8.49032764e-01
 -8.49032764e-01  8.04169827e-01  8.04169827e-01  8.04169827e-01
  8.21060907e-01  3.89228315e+00  3.89228315e+00  3.89228315e+00
  4.62837272e+00  1.42808137e+01  1.42808137e+01  1.42808137e+01
  1.71999196e+01  5.29343249e+01  5.29343249e+01  5.29343249e+01
  5.57523636e+01  1.71613693e+02  2.40686986e+02  2.40686986e+02
  2.40686986e+02  5.43014319e+02  1.90962512e+03  8.03492058e+03
  4.77966402e+04]
E1 = -182.5891662451102  E_coul = 54.04714250804151
cycle= 1 E= -128.542023737069  delta_E= -1.71e-13  |g|= 1.16e-06  |ddm|= 7.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5891662451102  E_coul = 54.04714250804151
  HOMO = -0.849032169992734  LUMO = 0.804169975368077
  mo_energy =
[-3.27709330e+01 -1.92941114e+00 -8.49032170e-01 -8.49032170e-01
 -8.49032170e-01  8.04169975e-01  8.04169975e-01  8.04169975e-01
  8.21061089e-01  3.89228368e+00  3.89228368e+00  3.89228368e+00
  4.62837323e+00  1.42808147e+01  1.42808147e+01  1.42808147e+01
  1.71999206e+01  5.29343264e+01  5.29343264e+01  5.29343264e+01
  5.57523651e+01  1.71613695e+02  2.40686988e+02  2.40686988e+02
  2.40686988e+02  5.43014320e+02  1.90962512e+03  8.03492058e+03
  4.77966402e+04]
E1 = -182.58916199582336  E_coul = 54.047138258754586
Extra cycle  E= -128.542023737069  delta_E= -8.53e-14  |g|= 5.77e-07  |ddm|= 3.83e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [8.18080713e-01 2.44137943e+04 3.66144812e+03 8.33391050e+02
 2.34648847e+02 7.89459882e+01 1.24608974e+01 2.99726810e+01
 3.14191466e-01 2.08014314e+00 5.37971409e+00 7.14892017e+00
 2.31580193e+01 9.97851220e+01 2.65371646e-01 2.45024735e+00
 8.34046707e-01]
grad_E = [-4.25205124e-04  4.13590313e-09 -2.06404079e-07  3.47732982e-06
 -2.14179641e-05  2.83441957e-05  6.83347301e-05 -8.84309273e-05
  1.12400023e-03  7.25281431e-05 -2.99460806e-05  2.95636595e-04
 -6.27660288e-05  3.00001560e-06 -1.71773465e-03 -3.74121692e-04
  4.22100609e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.82624896734        1
[INPUT] 0    0    [1    /1   ]  24413.7942652        1
[INPUT] 0    0    [1    /1   ]  3661.44733895        1
[INPUT] 0    0    [1    /1   ]  833.407343491        1
[INPUT] 0    0    [1    /1   ]  234.466280187        1
[INPUT] 0    0    [1    /1   ]  79.5964147236        1
[INPUT] 0    0    [1    /1   ]  13.0056067729        1
[INPUT] 0    0    [1    /1   ]  30.7518316828        1
[INPUT] 0    0    [1    /1   ]  0.311695861053       1
[INPUT] 0    0    [1    /1   ]  2.12670368044        1
[INPUT] 0    0    [1    /1   ]  5.79368706028        1
[INPUT] 1    0    [1    /1   ]  7.12544220139        1
[INPUT] 1    0    [1    /1   ]  23.1654182732        1
[INPUT] 1    0    [1    /1   ]  99.7843669312        1
[INPUT] 1    0    [1    /1   ]  0.265865641734       1
[INPUT] 1    0    [1    /1   ]  2.44475564599        1
[INPUT] 1    0    [1    /1   ]  0.834050385857       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8262489673398944, 1.0]], [0, [24413.794265195465, 1.0]], [0, [3661.447338953026, 1.0]], [0, [833.407343490877, 1.0]], [0, [234.4662801865895, 1.0]], [0, [79.5964147236233, 1.0]], [0, [13.005606772926795, 1.0]], [0, [30.751831682839136, 1.0]], [0, [0.3116958610529171, 1.0]], [0, [2.1267036804406962, 1.0]], [0, [5.793687060277274, 1.0]], [1, [7.12544220138713, 1.0]], [1, [23.165418273249834, 1.0]], [1, [99.78436693115805, 1.0]], [1, [0.26586564173372607, 1.0]], [1, [2.4447556459900945, 1.0]], [1, [0.8340503858572622, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82624897]
bas 1, expnt(s) = [24413.7942652]
bas 2, expnt(s) = [3661.44733895]
bas 3, expnt(s) = [833.40734349]
bas 4, expnt(s) = [234.46628019]
bas 5, expnt(s) = [79.59641472]
bas 6, expnt(s) = [13.00560677]
bas 7, expnt(s) = [30.75183168]
bas 8, expnt(s) = [0.31169586]
bas 9, expnt(s) = [2.12670368]
bas 10, expnt(s) = [5.79368706]
bas 11, expnt(s) = [7.1254422]
bas 12, expnt(s) = [23.16541827]
bas 13, expnt(s) = [99.78436693]
bas 14, expnt(s) = [0.26586564]
bas 15, expnt(s) = [2.44475565]
bas 16, expnt(s) = [0.83405039]
CPU time:       362.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.26248967e-01 2.18951650e+00 2.44137943e+04 4.93448104e+03
 3.66144734e+03 1.18919923e+03 8.33407343e+02 3.91884437e+02
 2.34466280e+02 1.51382377e+02 7.95964147e+01 6.73263629e+01
 1.30056068e+01 1.73026646e+01 3.07518317e+01 3.29927310e+01
 3.11695861e-01 1.05393372e+00 2.12670368e+00 4.44933659e+00
 5.79368706e+00 9.43476961e+00 7.12544220e+00 3.39624623e+01
 2.31654183e+01 1.48263612e+02 9.97843669e+01 9.20052321e+02
 2.65865642e-01 5.56944812e-01 2.44475565e+00 8.91823095e+00
 8.34050386e-01 2.32527730e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639825576494
cond(S) = 1327.6363997028793
E1 = -183.59012853015747  E_coul = 55.0801845592637
init E= -128.509943970894
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775402491676472  LUMO = 0.82353341458566
  mo_energy =
[-3.25552758e+01 -1.85273855e+00 -7.75402492e-01 -7.75402492e-01
 -7.75402492e-01  8.23533415e-01  8.23533415e-01  8.23533415e-01
  8.44955085e-01  3.95764705e+00  3.95764705e+00  3.95764705e+00
  4.79120550e+00  1.43763385e+01  1.43763385e+01  1.43763385e+01
  1.81713459e+01  5.30446173e+01  5.30446173e+01  5.30446173e+01
  5.87839626e+01  1.77588580e+02  2.40857677e+02  2.40857677e+02
  2.40857677e+02  5.51271304e+02  1.91815206e+03  8.04267473e+03
  4.78031673e+04]
E1 = -182.0858893006964  E_coul = 53.54735651237006
cycle= 1 E= -128.538532788326  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518864
diis-c [-0.26921998  1.        ]
  HOMO = -0.884352533596219  LUMO = 0.796751751848732
  mo_energy =
[-3.28785150e+01 -1.96667295e+00 -8.84352534e-01 -8.84352534e-01
 -8.84352534e-01  7.96751752e-01  7.96751752e-01  7.96751752e-01
  8.13757953e-01  3.86006603e+00  3.86006603e+00  3.86006603e+00
  4.69784317e+00  1.41853847e+01  1.41853847e+01  1.41853847e+01
  1.79874024e+01  5.27635948e+01  5.27635948e+01  5.27635948e+01
  5.85196191e+01  1.77268498e+02  2.40511319e+02  2.40511319e+02
  2.40511319e+02  5.50910193e+02  1.91775482e+03  8.04224810e+03
  4.78027217e+04]
E1 = -182.8475930328113  E_coul = 54.306471678885956
cycle= 2 E= -128.541121353925  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263962
diis-c [-0.00075265  0.33629116  0.66370884]
  HOMO = -0.848722332144658  LUMO = 0.805481490057523
  mo_energy =
[-3.27704096e+01 -1.92915463e+00 -8.48722332e-01 -8.48722332e-01
 -8.48722332e-01  8.05481490e-01  8.05481490e-01  8.05481490e-01
  8.23734041e-01  3.89171285e+00  3.89171285e+00  3.89171285e+00
  4.72815090e+00  1.42486289e+01  1.42486289e+01  1.42486289e+01
  1.80483136e+01  5.28576214e+01  5.28576214e+01  5.28576214e+01
  5.86082409e+01  1.77375137e+02  2.40624996e+02  2.40624996e+02
  2.40624996e+02  5.51026850e+02  1.91787682e+03  8.04237261e+03
  4.78028471e+04]
E1 = -182.58889696267175  E_coul = 54.04685490315619
cycle= 3 E= -128.542042059516  delta_E= -0.000921  |g|= 0.000496  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109419
diis-c [-1.83477727e-07 -2.36323217e-03 -8.31149792e-04  1.00319438e+00]
  HOMO = -0.848973641805467  LUMO = 0.805443418646776
  mo_energy =
[-3.27708471e+01 -1.92934173e+00 -8.48973642e-01 -8.48973642e-01
 -8.48973642e-01  8.05443419e-01  8.05443419e-01  8.05443419e-01
  8.23679460e-01  3.89153973e+00  3.89153973e+00  3.89153973e+00
  4.72799469e+00  1.42483345e+01  1.42483345e+01  1.42483345e+01
  1.80480357e+01  5.28572346e+01  5.28572346e+01  5.28572346e+01
  5.86078783e+01  1.77374690e+02  2.40624488e+02  2.40624488e+02
  2.40624488e+02  5.51026287e+02  1.91787612e+03  8.04237181e+03
  4.78028463e+04]
E1 = -182.58929603390854  E_coul = 54.04725394995679
cycle= 4 E= -128.542042083952  delta_E= -2.44e-08  |g|= 8.02e-05  |ddm|= 0.00032
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187951
diis-c [-1.10075199e-09  2.26908614e-04  5.31821855e-04 -1.81682755e-01
  1.18092402e+00]
  HOMO = -0.849016803831586  LUMO = 0.805430103028934
  mo_energy =
[-3.27709208e+01 -1.92937458e+00 -8.49016804e-01 -8.49016804e-01
 -8.49016804e-01  8.05430103e-01  8.05430103e-01  8.05430103e-01
  8.23665596e-01  3.89149941e+00  3.89149941e+00  3.89149941e+00
  4.72795965e+00  1.42482748e+01  1.42482748e+01  1.42482748e+01
  1.80479785e+01  5.28571650e+01  5.28571650e+01  5.28571650e+01
  5.86078102e+01  1.77374616e+02  2.40624409e+02  2.40624409e+02
  2.40624409e+02  5.51026205e+02  1.91787603e+03  8.04237171e+03
  4.78028462e+04]
E1 = -182.58943213637014  E_coul = 54.0473900517194
cycle= 5 E= -128.542042084651  delta_E= -6.99e-10  |g|= 5.83e-06  |ddm|= 5.26e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58943213637014  E_coul = 54.0473900517194
  HOMO = -0.849013765749909  LUMO = 0.805430997837598
  mo_energy =
[-3.27709140e+01 -1.92937074e+00 -8.49013766e-01 -8.49013766e-01
 -8.49013766e-01  8.05430998e-01  8.05430998e-01  8.05430998e-01
  8.23666981e-01  3.89150232e+00  3.89150232e+00  3.89150232e+00
  4.72796278e+00  1.42482798e+01  1.42482798e+01  1.42482798e+01
  1.80479836e+01  5.28571714e+01  5.28571714e+01  5.28571714e+01
  5.86078165e+01  1.77374622e+02  2.40624416e+02  2.40624416e+02
  2.40624416e+02  5.51026211e+02  1.91787604e+03  8.04237172e+03
  4.78028462e+04]
E1 = -182.5894166604805  E_coul = 54.047374575827384
Extra cycle  E= -128.542042084653  delta_E= -2.39e-12  |g|= 2.18e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.26248967e-01 2.44137943e+04 3.66144734e+03 8.33407343e+02
 2.34466280e+02 7.95964147e+01 1.30056068e+01 3.07518317e+01
 3.11695861e-01 2.12670368e+00 5.79368706e+00 7.12544220e+00
 2.31654183e+01 9.97843669e+01 2.65865642e-01 2.44475565e+00
 8.34050386e-01]
E = -128.54204208465313
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:56:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.82624896734        1
[INPUT] 0    0    [1    /1   ]  24413.7942652        1
[INPUT] 0    0    [1    /1   ]  3661.44733895        1
[INPUT] 0    0    [1    /1   ]  833.407343491        1
[INPUT] 0    0    [1    /1   ]  234.466280187        1
[INPUT] 0    0    [1    /1   ]  79.5964147236        1
[INPUT] 0    0    [1    /1   ]  13.0056067729        1
[INPUT] 0    0    [1    /1   ]  30.7518316828        1
[INPUT] 0    0    [1    /1   ]  0.311695861053       1
[INPUT] 0    0    [1    /1   ]  2.12670368044        1
[INPUT] 0    0    [1    /1   ]  5.79368706028        1
[INPUT] 1    0    [1    /1   ]  7.12544220139        1
[INPUT] 1    0    [1    /1   ]  23.1654182732        1
[INPUT] 1    0    [1    /1   ]  99.7843669312        1
[INPUT] 1    0    [1    /1   ]  0.265865641734       1
[INPUT] 1    0    [1    /1   ]  2.44475564599        1
[INPUT] 1    0    [1    /1   ]  0.834050385857       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8262489673398944, 1.0]], [0, [24413.794265195465, 1.0]], [0, [3661.447338953026, 1.0]], [0, [833.407343490877, 1.0]], [0, [234.4662801865895, 1.0]], [0, [79.5964147236233, 1.0]], [0, [13.005606772926795, 1.0]], [0, [30.751831682839136, 1.0]], [0, [0.3116958610529171, 1.0]], [0, [2.1267036804406962, 1.0]], [0, [5.793687060277274, 1.0]], [1, [7.12544220138713, 1.0]], [1, [23.165418273249834, 1.0]], [1, [99.78436693115805, 1.0]], [1, [0.26586564173372607, 1.0]], [1, [2.4447556459900945, 1.0]], [1, [0.8340503858572622, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82624897]
bas 1, expnt(s) = [24413.7942652]
bas 2, expnt(s) = [3661.44733895]
bas 3, expnt(s) = [833.40734349]
bas 4, expnt(s) = [234.46628019]
bas 5, expnt(s) = [79.59641472]
bas 6, expnt(s) = [13.00560677]
bas 7, expnt(s) = [30.75183168]
bas 8, expnt(s) = [0.31169586]
bas 9, expnt(s) = [2.12670368]
bas 10, expnt(s) = [5.79368706]
bas 11, expnt(s) = [7.1254422]
bas 12, expnt(s) = [23.16541827]
bas 13, expnt(s) = [99.78436693]
bas 14, expnt(s) = [0.26586564]
bas 15, expnt(s) = [2.44475565]
bas 16, expnt(s) = [0.83405039]
CPU time:       363.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.26248967e-01 2.18951650e+00 2.44137943e+04 4.93448104e+03
 3.66144734e+03 1.18919923e+03 8.33407343e+02 3.91884437e+02
 2.34466280e+02 1.51382377e+02 7.95964147e+01 6.73263629e+01
 1.30056068e+01 1.73026646e+01 3.07518317e+01 3.29927310e+01
 3.11695861e-01 1.05393372e+00 2.12670368e+00 4.44933659e+00
 5.79368706e+00 9.43476961e+00 7.12544220e+00 3.39624623e+01
 2.31654183e+01 1.48263612e+02 9.97843669e+01 9.20052321e+02
 2.65865642e-01 5.56944812e-01 2.44475565e+00 8.91823095e+00
 8.34050386e-01 2.32527730e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639825576494
cond(S) = 1327.6363997028793
E1 = -183.59012853015747  E_coul = 55.0801845592637
init E= -128.509943970894
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402491676472  LUMO = 0.82353341458566
  mo_energy =
[-3.25552758e+01 -1.85273855e+00 -7.75402492e-01 -7.75402492e-01
 -7.75402492e-01  8.23533415e-01  8.23533415e-01  8.23533415e-01
  8.44955085e-01  3.95764705e+00  3.95764705e+00  3.95764705e+00
  4.79120550e+00  1.43763385e+01  1.43763385e+01  1.43763385e+01
  1.81713459e+01  5.30446173e+01  5.30446173e+01  5.30446173e+01
  5.87839626e+01  1.77588580e+02  2.40857677e+02  2.40857677e+02
  2.40857677e+02  5.51271304e+02  1.91815206e+03  8.04267473e+03
  4.78031673e+04]
E1 = -182.0858893006964  E_coul = 53.54735651237006
cycle= 1 E= -128.538532788326  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518864
diis-c [-0.26921998  1.        ]
  HOMO = -0.884352533596219  LUMO = 0.796751751848732
  mo_energy =
[-3.28785150e+01 -1.96667295e+00 -8.84352534e-01 -8.84352534e-01
 -8.84352534e-01  7.96751752e-01  7.96751752e-01  7.96751752e-01
  8.13757953e-01  3.86006603e+00  3.86006603e+00  3.86006603e+00
  4.69784317e+00  1.41853847e+01  1.41853847e+01  1.41853847e+01
  1.79874024e+01  5.27635948e+01  5.27635948e+01  5.27635948e+01
  5.85196191e+01  1.77268498e+02  2.40511319e+02  2.40511319e+02
  2.40511319e+02  5.50910193e+02  1.91775482e+03  8.04224810e+03
  4.78027217e+04]
E1 = -182.8475930328113  E_coul = 54.306471678885956
cycle= 2 E= -128.541121353925  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263962
diis-c [-0.00075265  0.33629116  0.66370884]
  HOMO = -0.848722332144658  LUMO = 0.805481490057523
  mo_energy =
[-3.27704096e+01 -1.92915463e+00 -8.48722332e-01 -8.48722332e-01
 -8.48722332e-01  8.05481490e-01  8.05481490e-01  8.05481490e-01
  8.23734041e-01  3.89171285e+00  3.89171285e+00  3.89171285e+00
  4.72815090e+00  1.42486289e+01  1.42486289e+01  1.42486289e+01
  1.80483136e+01  5.28576214e+01  5.28576214e+01  5.28576214e+01
  5.86082409e+01  1.77375137e+02  2.40624996e+02  2.40624996e+02
  2.40624996e+02  5.51026850e+02  1.91787682e+03  8.04237261e+03
  4.78028471e+04]
E1 = -182.58889696267175  E_coul = 54.04685490315619
cycle= 3 E= -128.542042059516  delta_E= -0.000921  |g|= 0.000496  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109419
diis-c [-1.83477727e-07 -2.36323217e-03 -8.31149792e-04  1.00319438e+00]
  HOMO = -0.848973641805467  LUMO = 0.805443418646776
  mo_energy =
[-3.27708471e+01 -1.92934173e+00 -8.48973642e-01 -8.48973642e-01
 -8.48973642e-01  8.05443419e-01  8.05443419e-01  8.05443419e-01
  8.23679460e-01  3.89153973e+00  3.89153973e+00  3.89153973e+00
  4.72799469e+00  1.42483345e+01  1.42483345e+01  1.42483345e+01
  1.80480357e+01  5.28572346e+01  5.28572346e+01  5.28572346e+01
  5.86078783e+01  1.77374690e+02  2.40624488e+02  2.40624488e+02
  2.40624488e+02  5.51026287e+02  1.91787612e+03  8.04237181e+03
  4.78028463e+04]
E1 = -182.58929603390854  E_coul = 54.04725394995679
cycle= 4 E= -128.542042083952  delta_E= -2.44e-08  |g|= 8.02e-05  |ddm|= 0.00032
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187951
diis-c [-1.10075199e-09  2.26908614e-04  5.31821855e-04 -1.81682755e-01
  1.18092402e+00]
  HOMO = -0.849016803831586  LUMO = 0.805430103028934
  mo_energy =
[-3.27709208e+01 -1.92937458e+00 -8.49016804e-01 -8.49016804e-01
 -8.49016804e-01  8.05430103e-01  8.05430103e-01  8.05430103e-01
  8.23665596e-01  3.89149941e+00  3.89149941e+00  3.89149941e+00
  4.72795965e+00  1.42482748e+01  1.42482748e+01  1.42482748e+01
  1.80479785e+01  5.28571650e+01  5.28571650e+01  5.28571650e+01
  5.86078102e+01  1.77374616e+02  2.40624409e+02  2.40624409e+02
  2.40624409e+02  5.51026205e+02  1.91787603e+03  8.04237171e+03
  4.78028462e+04]
E1 = -182.58943213637014  E_coul = 54.0473900517194
cycle= 5 E= -128.542042084651  delta_E= -6.99e-10  |g|= 5.83e-06  |ddm|= 5.26e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58943213637014  E_coul = 54.0473900517194
  HOMO = -0.849013765749909  LUMO = 0.805430997837598
  mo_energy =
[-3.27709140e+01 -1.92937074e+00 -8.49013766e-01 -8.49013766e-01
 -8.49013766e-01  8.05430998e-01  8.05430998e-01  8.05430998e-01
  8.23666981e-01  3.89150232e+00  3.89150232e+00  3.89150232e+00
  4.72796278e+00  1.42482798e+01  1.42482798e+01  1.42482798e+01
  1.80479836e+01  5.28571714e+01  5.28571714e+01  5.28571714e+01
  5.86078165e+01  1.77374622e+02  2.40624416e+02  2.40624416e+02
  2.40624416e+02  5.51026211e+02  1.91787604e+03  8.04237172e+03
  4.78028462e+04]
E1 = -182.5894166604805  E_coul = 54.047374575827384
Extra cycle  E= -128.542042084653  delta_E= -2.39e-12  |g|= 2.18e-06  |ddm|= 2.13e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.14 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1327.6363997028793
E1 = -182.5894166604805  E_coul = 54.047374575827384
init E= -128.542042084653
    CPU time for initialize scf      0.35 sec, wall time      0.34 sec
  HOMO = -0.849014861476235  LUMO = 0.805430747174748
  mo_energy =
[-3.27709174e+01 -1.92937175e+00 -8.49014861e-01 -8.49014861e-01
 -8.49014861e-01  8.05430747e-01  8.05430747e-01  8.05430747e-01
  8.23666760e-01  3.89150137e+00  3.89150137e+00  3.89150137e+00
  4.72796194e+00  1.42482779e+01  1.42482779e+01  1.42482779e+01
  1.80479817e+01  5.28571685e+01  5.28571685e+01  5.28571685e+01
  5.86078137e+01  1.77374619e+02  2.40624412e+02  2.40624412e+02
  2.40624412e+02  5.51026207e+02  1.91787604e+03  8.04237172e+03
  4.78028462e+04]
E1 = -182.58942526599887  E_coul = 54.04738318134536
cycle= 1 E= -128.542042084654  delta_E= -3.69e-13  |g|= 1.18e-06  |ddm|= 7.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58942526599887  E_coul = 54.04738318134536
  HOMO = -0.849014255871757  LUMO = 0.805430898934387
  mo_energy =
[-3.27709156e+01 -1.92937108e+00 -8.49014256e-01 -8.49014256e-01
 -8.49014256e-01  8.05430899e-01  8.05430899e-01  8.05430899e-01
  8.23666947e-01  3.89150192e+00  3.89150192e+00  3.89150192e+00
  4.72796248e+00  1.42482790e+01  1.42482790e+01  1.42482790e+01
  1.80479828e+01  5.28571701e+01  5.28571701e+01  5.28571701e+01
  5.86078152e+01  1.77374621e+02  2.40624414e+02  2.40624414e+02
  2.40624414e+02  5.51026209e+02  1.91787604e+03  8.04237172e+03
  4.78028462e+04]
E1 = -182.5894209416955  E_coul = 54.04737885704174
Extra cycle  E= -128.542042084654  delta_E= -2.56e-13  |g|= 5.87e-07  |ddm|= 3.9e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [8.26248967e-01 2.44137943e+04 3.66144734e+03 8.33407343e+02
 2.34466280e+02 7.95964147e+01 1.30056068e+01 3.07518317e+01
 3.11695861e-01 2.12670368e+00 5.79368706e+00 7.12544220e+00
 2.31654183e+01 9.97843669e+01 2.65865642e-01 2.44475565e+00
 8.34050386e-01]
grad_E = [-2.17059424e-04  4.66088833e-09 -2.31798685e-07  3.86351915e-06
 -2.21381849e-05  1.33784227e-05  2.06270296e-06 -3.13914614e-05
  2.30865273e-04  9.04688777e-05  1.23637042e-05  9.28578115e-05
 -2.06639776e-05  1.02833913e-06 -5.32431107e-04 -1.08681198e-04
  1.23941010e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.819191722875       1
[INPUT] 0    0    [1    /1   ]  24413.7942677        1
[INPUT] 0    0    [1    /1   ]  3661.44720187        1
[INPUT] 0    0    [1    /1   ]  833.410403155        1
[INPUT] 0    0    [1    /1   ]  234.429409033        1
[INPUT] 0    0    [1    /1   ]  79.7271480337        1
[INPUT] 0    0    [1    /1   ]  13.1234569025        1
[INPUT] 0    0    [1    /1   ]  31.0120736202        1
[INPUT] 0    0    [1    /1   ]  0.308752073964       1
[INPUT] 0    0    [1    /1   ]  2.10733639005        1
[INPUT] 0    0    [1    /1   ]  5.73667283164        1
[INPUT] 1    0    [1    /1   ]  7.11338139621        1
[INPUT] 1    0    [1    /1   ]  23.1688010174        1
[INPUT] 1    0    [1    /1   ]  99.7841746009        1
[INPUT] 1    0    [1    /1   ]  0.266042602221       1
[INPUT] 1    0    [1    /1   ]  2.441989868          1
[INPUT] 1    0    [1    /1   ]  0.83412754794        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8191917228750444, 1.0]], [0, [24413.794267692374, 1.0]], [0, [3661.4472018654874, 1.0]], [0, [833.4104031546591, 1.0]], [0, [234.4294090326706, 1.0]], [0, [79.72714803374122, 1.0]], [0, [13.123456902452793, 1.0]], [0, [31.012073620230876, 1.0]], [0, [0.308752073963607, 1.0]], [0, [2.107336390048726, 1.0]], [0, [5.736672831639505, 1.0]], [1, [7.113381396214847, 1.0]], [1, [23.168801017432095, 1.0]], [1, [99.78417460091748, 1.0]], [1, [0.2660426022212615, 1.0]], [1, [2.44198986800465, 1.0]], [1, [0.8341275479403585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81919172]
bas 1, expnt(s) = [24413.79426769]
bas 2, expnt(s) = [3661.44720187]
bas 3, expnt(s) = [833.41040315]
bas 4, expnt(s) = [234.42940903]
bas 5, expnt(s) = [79.72714803]
bas 6, expnt(s) = [13.1234569]
bas 7, expnt(s) = [31.01207362]
bas 8, expnt(s) = [0.30875207]
bas 9, expnt(s) = [2.10733639]
bas 10, expnt(s) = [5.73667283]
bas 11, expnt(s) = [7.1133814]
bas 12, expnt(s) = [23.16880102]
bas 13, expnt(s) = [99.7841746]
bas 14, expnt(s) = [0.2660426]
bas 15, expnt(s) = [2.44198987]
bas 16, expnt(s) = [0.83412755]
CPU time:       367.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.19191723e-01 2.17547547e+00 2.44137943e+04 4.93448104e+03
 3.66144720e+03 1.18919919e+03 8.33410403e+02 3.91885516e+02
 2.34429409e+02 1.51364522e+02 7.97271480e+01 6.74092812e+01
 1.31234569e+01 1.74201228e+01 3.10120736e+01 3.32019147e+01
 3.08752074e-01 1.04645953e+00 2.10733639e+00 4.41891273e+00
 5.73667283e+00 9.36504969e+00 7.11338140e+00 3.38906198e+01
 2.31688010e+01 1.48290675e+02 9.97841746e+01 9.20050105e+02
 2.66042602e-01 5.57408230e-01 2.44198987e+00 8.90562112e+00
 8.34127548e-01 2.32554621e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963942207282
cond(S) = 1282.6700085372215
E1 = -183.59011490732576  E_coul = 55.08018314529836
init E= -128.509931762027
    CPU time for initialize scf      0.05 sec, wall time      0.06 sec
  HOMO = -0.775402185438657  LUMO = 0.824002164893131
  mo_energy =
[-3.25552794e+01 -1.85273717e+00 -7.75402185e-01 -7.75402185e-01
 -7.75402185e-01  8.24002165e-01  8.24002165e-01  8.24002165e-01
  8.34391921e-01  3.95712286e+00  3.95712286e+00  3.95712286e+00
  4.73786972e+00  1.43596805e+01  1.43596805e+01  1.43596805e+01
  1.80343269e+01  5.30046424e+01  5.30046424e+01  5.30046424e+01
  5.88182170e+01  1.78290846e+02  2.40824730e+02  2.40824730e+02
  2.40824730e+02  5.52590888e+02  1.91959857e+03  8.04399643e+03
  4.78042708e+04]
E1 = -182.08597748288608  E_coul = 53.54744072211988
cycle= 1 E= -128.538536760766  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51886
diis-c [-0.26921542  1.        ]
  HOMO = -0.884346249182015  LUMO = 0.797207588153789
  mo_energy =
[-3.28785083e+01 -1.96665781e+00 -8.84346249e-01 -8.84346249e-01
 -8.84346249e-01  7.97207588e-01  7.97207588e-01  7.97207588e-01
  8.03575332e-01  3.85961030e+00  3.85961030e+00  3.85961030e+00
  4.64515110e+00  1.41688754e+01  1.41688754e+01  1.41688754e+01
  1.78506018e+01  5.27236473e+01  5.27236473e+01  5.27236473e+01
  5.85534486e+01  1.77970532e+02  2.40478377e+02  2.40478377e+02
  2.40478377e+02  5.52229750e+02  1.91920136e+03  8.04356981e+03
  4.78038253e+04]
E1 = -182.84755392802066  E_coul = 54.30642901691862
cycle= 2 E= -128.541124911102  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263929
diis-c [-0.00075125  0.33626626  0.66373374]
  HOMO = -0.848721166830993  LUMO = 0.805939483651099
  mo_energy =
[-3.27704147e+01 -1.92914520e+00 -8.48721167e-01 -8.48721167e-01
 -8.48721167e-01  8.05939484e-01  8.05939484e-01  8.05939484e-01
  8.13427013e-01  3.89123226e+00  3.89123226e+00  3.89123226e+00
  4.67524274e+00  1.42320629e+01  1.42320629e+01  1.42320629e+01
  1.79114365e+01  5.28176594e+01  5.28176594e+01  5.28176594e+01
  5.86422120e+01  1.78077236e+02  2.40592043e+02  2.40592043e+02
  2.40592043e+02  5.52346405e+02  1.91932334e+03  8.04369431e+03
  4.78039507e+04]
E1 = -182.5888843450677  E_coul = 54.046838981442264
cycle= 3 E= -128.542045363625  delta_E= -0.00092  |g|= 0.000502  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00110396
diis-c [-1.87031713e-07 -2.36950775e-03 -8.09544956e-04  1.00317905e+00]
  HOMO = -0.84897486158763  LUMO = 0.805900538796177
  mo_energy =
[-3.27708563e+01 -1.92933419e+00 -8.48974862e-01 -8.48974862e-01
 -8.48974862e-01  8.05900539e-01  8.05900539e-01  8.05900539e-01
  8.13372112e-01  3.89105709e+00  3.89105709e+00  3.89105709e+00
  4.67508539e+00  1.42317653e+01  1.42317653e+01  1.42317653e+01
  1.79111558e+01  5.28172687e+01  5.28172687e+01  5.28172687e+01
  5.86418452e+01  1.78076784e+02  2.40591531e+02  2.40591531e+02
  2.40591531e+02  5.52345837e+02  1.91932264e+03  8.04369351e+03
  4.78039499e+04]
E1 = -182.58928878805764  E_coul = 54.047243399304406
cycle= 4 E= -128.542045388753  delta_E= -2.51e-08  |g|= 8.09e-05  |ddm|= 0.000327
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188925
diis-c [-1.11443182e-09  2.29272305e-04  5.29817753e-04 -1.82773050e-01
  1.18201396e+00]
  HOMO = -0.849018385011913  LUMO = 0.805887086660112
  mo_energy =
[-3.27709305e+01 -1.92936724e+00 -8.49018385e-01 -8.49018385e-01
 -8.49018385e-01  8.05887087e-01  8.05887087e-01  8.05887087e-01
  8.13358274e-01  3.89101646e+00  3.89101646e+00  3.89101646e+00
  4.67505025e+00  1.42317053e+01  1.42317053e+01  1.42317053e+01
  1.79110983e+01  5.28171986e+01  5.28171986e+01  5.28171986e+01
  5.86417767e+01  1.78076709e+02  2.40591452e+02  2.40591452e+02
  2.40591452e+02  5.52345754e+02  1.91932255e+03  8.04369341e+03
  4.78039498e+04]
E1 = -182.58942505008258  E_coul = 54.047379660614276
cycle= 5 E= -128.542045389468  delta_E= -7.15e-10  |g|= 5.89e-06  |ddm|= 5.38e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58942505008258  E_coul = 54.047379660614276
  HOMO = -0.849015310685314  LUMO = 0.805887993521821
  mo_energy =
[-3.27709236e+01 -1.92936335e+00 -8.49015311e-01 -8.49015311e-01
 -8.49015311e-01  8.05887994e-01  8.05887994e-01  8.05887994e-01
  8.13359661e-01  3.89101941e+00  3.89101941e+00  3.89101941e+00
  4.67505341e+00  1.42317103e+01  1.42317103e+01  1.42317103e+01
  1.79111034e+01  5.28172051e+01  5.28172051e+01  5.28172051e+01
  5.86417831e+01  1.78076716e+02  2.40591459e+02  2.40591459e+02
  2.40591459e+02  5.52345761e+02  1.91932255e+03  8.04369342e+03
  4.78039498e+04]
E1 = -182.58940945225535  E_coul = 54.047364062784425
Extra cycle  E= -128.542045389471  delta_E= -2.61e-12  |g|= 2.2e-06  |ddm|= 2.16e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.19191723e-01 2.44137943e+04 3.66144720e+03 8.33410403e+02
 2.34429409e+02 7.97271480e+01 1.31234569e+01 3.10120736e+01
 3.08752074e-01 2.10733639e+00 5.73667283e+00 7.11338140e+00
 2.31688010e+01 9.97841746e+01 2.66042602e-01 2.44198987e+00
 8.34127548e-01]
E = -128.54204538947093
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.819191722875       1
[INPUT] 0    0    [1    /1   ]  24413.7942677        1
[INPUT] 0    0    [1    /1   ]  3661.44720187        1
[INPUT] 0    0    [1    /1   ]  833.410403155        1
[INPUT] 0    0    [1    /1   ]  234.429409033        1
[INPUT] 0    0    [1    /1   ]  79.7271480337        1
[INPUT] 0    0    [1    /1   ]  13.1234569025        1
[INPUT] 0    0    [1    /1   ]  31.0120736202        1
[INPUT] 0    0    [1    /1   ]  0.308752073964       1
[INPUT] 0    0    [1    /1   ]  2.10733639005        1
[INPUT] 0    0    [1    /1   ]  5.73667283164        1
[INPUT] 1    0    [1    /1   ]  7.11338139621        1
[INPUT] 1    0    [1    /1   ]  23.1688010174        1
[INPUT] 1    0    [1    /1   ]  99.7841746009        1
[INPUT] 1    0    [1    /1   ]  0.266042602221       1
[INPUT] 1    0    [1    /1   ]  2.441989868          1
[INPUT] 1    0    [1    /1   ]  0.83412754794        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8191917228750444, 1.0]], [0, [24413.794267692374, 1.0]], [0, [3661.4472018654874, 1.0]], [0, [833.4104031546591, 1.0]], [0, [234.4294090326706, 1.0]], [0, [79.72714803374122, 1.0]], [0, [13.123456902452793, 1.0]], [0, [31.012073620230876, 1.0]], [0, [0.308752073963607, 1.0]], [0, [2.107336390048726, 1.0]], [0, [5.736672831639505, 1.0]], [1, [7.113381396214847, 1.0]], [1, [23.168801017432095, 1.0]], [1, [99.78417460091748, 1.0]], [1, [0.2660426022212615, 1.0]], [1, [2.44198986800465, 1.0]], [1, [0.8341275479403585, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.81919172]
bas 1, expnt(s) = [24413.79426769]
bas 2, expnt(s) = [3661.44720187]
bas 3, expnt(s) = [833.41040315]
bas 4, expnt(s) = [234.42940903]
bas 5, expnt(s) = [79.72714803]
bas 6, expnt(s) = [13.1234569]
bas 7, expnt(s) = [31.01207362]
bas 8, expnt(s) = [0.30875207]
bas 9, expnt(s) = [2.10733639]
bas 10, expnt(s) = [5.73667283]
bas 11, expnt(s) = [7.1133814]
bas 12, expnt(s) = [23.16880102]
bas 13, expnt(s) = [99.7841746]
bas 14, expnt(s) = [0.2660426]
bas 15, expnt(s) = [2.44198987]
bas 16, expnt(s) = [0.83412755]
CPU time:       368.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.19191723e-01 2.17547547e+00 2.44137943e+04 4.93448104e+03
 3.66144720e+03 1.18919919e+03 8.33410403e+02 3.91885516e+02
 2.34429409e+02 1.51364522e+02 7.97271480e+01 6.74092812e+01
 1.31234569e+01 1.74201228e+01 3.10120736e+01 3.32019147e+01
 3.08752074e-01 1.04645953e+00 2.10733639e+00 4.41891273e+00
 5.73667283e+00 9.36504969e+00 7.11338140e+00 3.38906198e+01
 2.31688010e+01 1.48290675e+02 9.97841746e+01 9.20050105e+02
 2.66042602e-01 5.57408230e-01 2.44198987e+00 8.90562112e+00
 8.34127548e-01 2.32554621e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99963942207282
cond(S) = 1282.6700085372215
E1 = -183.59011490732576  E_coul = 55.08018314529836
init E= -128.509931762027
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775402185438657  LUMO = 0.824002164893131
  mo_energy =
[-3.25552794e+01 -1.85273717e+00 -7.75402185e-01 -7.75402185e-01
 -7.75402185e-01  8.24002165e-01  8.24002165e-01  8.24002165e-01
  8.34391921e-01  3.95712286e+00  3.95712286e+00  3.95712286e+00
  4.73786972e+00  1.43596805e+01  1.43596805e+01  1.43596805e+01
  1.80343269e+01  5.30046424e+01  5.30046424e+01  5.30046424e+01
  5.88182170e+01  1.78290846e+02  2.40824730e+02  2.40824730e+02
  2.40824730e+02  5.52590888e+02  1.91959857e+03  8.04399643e+03
  4.78042708e+04]
E1 = -182.08597748288608  E_coul = 53.54744072211988
cycle= 1 E= -128.538536760766  delta_E= -0.0286  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.51886
diis-c [-0.26921542  1.        ]
  HOMO = -0.884346249182015  LUMO = 0.797207588153789
  mo_energy =
[-3.28785083e+01 -1.96665781e+00 -8.84346249e-01 -8.84346249e-01
 -8.84346249e-01  7.97207588e-01  7.97207588e-01  7.97207588e-01
  8.03575332e-01  3.85961030e+00  3.85961030e+00  3.85961030e+00
  4.64515110e+00  1.41688754e+01  1.41688754e+01  1.41688754e+01
  1.78506018e+01  5.27236473e+01  5.27236473e+01  5.27236473e+01
  5.85534486e+01  1.77970532e+02  2.40478377e+02  2.40478377e+02
  2.40478377e+02  5.52229750e+02  1.91920136e+03  8.04356981e+03
  4.78038253e+04]
E1 = -182.84755392802066  E_coul = 54.30642901691862
cycle= 2 E= -128.541124911102  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263929
diis-c [-0.00075125  0.33626626  0.66373374]
  HOMO = -0.848721166830993  LUMO = 0.805939483651099
  mo_energy =
[-3.27704147e+01 -1.92914520e+00 -8.48721167e-01 -8.48721167e-01
 -8.48721167e-01  8.05939484e-01  8.05939484e-01  8.05939484e-01
  8.13427013e-01  3.89123226e+00  3.89123226e+00  3.89123226e+00
  4.67524274e+00  1.42320629e+01  1.42320629e+01  1.42320629e+01
  1.79114365e+01  5.28176594e+01  5.28176594e+01  5.28176594e+01
  5.86422120e+01  1.78077236e+02  2.40592043e+02  2.40592043e+02
  2.40592043e+02  5.52346405e+02  1.91932334e+03  8.04369431e+03
  4.78039507e+04]
E1 = -182.5888843450677  E_coul = 54.046838981442264
cycle= 3 E= -128.542045363625  delta_E= -0.00092  |g|= 0.000502  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00110396
diis-c [-1.87031713e-07 -2.36950775e-03 -8.09544956e-04  1.00317905e+00]
  HOMO = -0.84897486158763  LUMO = 0.805900538796177
  mo_energy =
[-3.27708563e+01 -1.92933419e+00 -8.48974862e-01 -8.48974862e-01
 -8.48974862e-01  8.05900539e-01  8.05900539e-01  8.05900539e-01
  8.13372112e-01  3.89105709e+00  3.89105709e+00  3.89105709e+00
  4.67508539e+00  1.42317653e+01  1.42317653e+01  1.42317653e+01
  1.79111558e+01  5.28172687e+01  5.28172687e+01  5.28172687e+01
  5.86418452e+01  1.78076784e+02  2.40591531e+02  2.40591531e+02
  2.40591531e+02  5.52345837e+02  1.91932264e+03  8.04369351e+03
  4.78039499e+04]
E1 = -182.58928878805764  E_coul = 54.047243399304406
cycle= 4 E= -128.542045388753  delta_E= -2.51e-08  |g|= 8.09e-05  |ddm|= 0.000327
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188925
diis-c [-1.11443182e-09  2.29272305e-04  5.29817753e-04 -1.82773050e-01
  1.18201396e+00]
  HOMO = -0.849018385011913  LUMO = 0.805887086660112
  mo_energy =
[-3.27709305e+01 -1.92936724e+00 -8.49018385e-01 -8.49018385e-01
 -8.49018385e-01  8.05887087e-01  8.05887087e-01  8.05887087e-01
  8.13358274e-01  3.89101646e+00  3.89101646e+00  3.89101646e+00
  4.67505025e+00  1.42317053e+01  1.42317053e+01  1.42317053e+01
  1.79110983e+01  5.28171986e+01  5.28171986e+01  5.28171986e+01
  5.86417767e+01  1.78076709e+02  2.40591452e+02  2.40591452e+02
  2.40591452e+02  5.52345754e+02  1.91932255e+03  8.04369341e+03
  4.78039498e+04]
E1 = -182.58942505008258  E_coul = 54.047379660614276
cycle= 5 E= -128.542045389468  delta_E= -7.15e-10  |g|= 5.89e-06  |ddm|= 5.38e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58942505008258  E_coul = 54.047379660614276
  HOMO = -0.849015310685314  LUMO = 0.805887993521821
  mo_energy =
[-3.27709236e+01 -1.92936335e+00 -8.49015311e-01 -8.49015311e-01
 -8.49015311e-01  8.05887994e-01  8.05887994e-01  8.05887994e-01
  8.13359661e-01  3.89101941e+00  3.89101941e+00  3.89101941e+00
  4.67505341e+00  1.42317103e+01  1.42317103e+01  1.42317103e+01
  1.79111034e+01  5.28172051e+01  5.28172051e+01  5.28172051e+01
  5.86417831e+01  1.78076716e+02  2.40591459e+02  2.40591459e+02
  2.40591459e+02  5.52345761e+02  1.91932255e+03  8.04369342e+03
  4.78039498e+04]
E1 = -182.58940945225535  E_coul = 54.047364062784425
Extra cycle  E= -128.542045389471  delta_E= -2.61e-12  |g|= 2.2e-06  |ddm|= 2.16e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1282.6700085372215
E1 = -182.58940945225535  E_coul = 54.047364062784425
init E= -128.542045389471
    CPU time for initialize scf      0.36 sec, wall time      0.36 sec
  HOMO = -0.849016414513523  LUMO = 0.805887741118413
  mo_energy =
[-3.27709270e+01 -1.92936437e+00 -8.49016415e-01 -8.49016415e-01
 -8.49016415e-01  8.05887741e-01  8.05887741e-01  8.05887741e-01
  8.13359442e-01  3.89101845e+00  3.89101845e+00  3.89101845e+00
  4.67505257e+00  1.42317083e+01  1.42317083e+01  1.42317083e+01
  1.79111015e+01  5.28172022e+01  5.28172022e+01  5.28172022e+01
  5.86417803e+01  1.78076712e+02  2.40591455e+02  2.40591455e+02
  2.40591455e+02  5.52345757e+02  1.91932255e+03  8.04369341e+03
  4.78039498e+04]
E1 = -182.58941813436118  E_coul = 54.04737274489015
cycle= 1 E= -128.542045389471  delta_E= -1.14e-13  |g|= 1.19e-06  |ddm|= 7.91e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58941813436118  E_coul = 54.04737274489015
  HOMO = -0.849015803436784  LUMO = 0.805887894336202
  mo_energy =
[-3.27709252e+01 -1.92936370e+00 -8.49015803e-01 -8.49015803e-01
 -8.49015803e-01  8.05887894e-01  8.05887894e-01  8.05887894e-01
  8.13359629e-01  3.89101900e+00  3.89101900e+00  3.89101900e+00
  4.67505310e+00  1.42317094e+01  1.42317094e+01  1.42317094e+01
  1.79111026e+01  5.28172038e+01  5.28172038e+01  5.28172038e+01
  5.86417818e+01  1.78076714e+02  2.40591457e+02  2.40591457e+02
  2.40591457e+02  5.52345759e+02  1.91932255e+03  8.04369342e+03
  4.78039498e+04]
E1 = -182.58941377267178  E_coul = 54.04736838320038
Extra cycle  E= -128.542045389471  delta_E= -3.69e-13  |g|= 5.92e-07  |ddm|= 3.93e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [8.19191723e-01 2.44137943e+04 3.66144720e+03 8.33410403e+02
 2.34429409e+02 7.97271480e+01 1.31234569e+01 3.10120736e+01
 3.08752074e-01 2.10733639e+00 5.73667283e+00 7.11338140e+00
 2.31688010e+01 9.97841746e+01 2.66042602e-01 2.44198987e+00
 8.34127548e-01]
grad_E = [ 2.02283367e-04  4.60163207e-09 -2.28515914e-07  3.77790988e-06
 -2.08346310e-05  6.12789255e-06  3.64920532e-05 -2.55104357e-05
 -3.80550166e-04 -4.30464588e-05 -2.83184205e-05 -6.56568784e-06
  5.70093884e-07  4.54489091e-08 -3.41628285e-04 -1.85129235e-05
  1.79815316e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823348246679       1
[INPUT] 0    0    [1    /1   ]  24413.7942686        1
[INPUT] 0    0    [1    /1   ]  3661.44715093        1
[INPUT] 0    0    [1    /1   ]  833.411470826        1
[INPUT] 0    0    [1    /1   ]  234.417935777        1
[INPUT] 0    0    [1    /1   ]  79.7545468644        1
[INPUT] 0    0    [1    /1   ]  13.2279523071        1
[INPUT] 0    0    [1    /1   ]  31.1200695186        1
[INPUT] 0    0    [1    /1   ]  0.310458100282       1
[INPUT] 0    0    [1    /1   ]  2.1173952127         1
[INPUT] 0    0    [1    /1   ]  5.86167924863        1
[INPUT] 1    0    [1    /1   ]  7.10995601398        1
[INPUT] 1    0    [1    /1   ]  23.1701216458        1
[INPUT] 1    0    [1    /1   ]  99.7840414537        1
[INPUT] 1    0    [1    /1   ]  0.266041046148       1
[INPUT] 1    0    [1    /1   ]  2.44073749168        1
[INPUT] 1    0    [1    /1   ]  0.833853404756       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8233482466791465, 1.0]], [0, [24413.794268629434, 1.0]], [0, [3661.4471509309333, 1.0]], [0, [833.4114708255405, 1.0]], [0, [234.4179357768456, 1.0]], [0, [79.7545468643841, 1.0]], [0, [13.227952307072142, 1.0]], [0, [31.120069518599575, 1.0]], [0, [0.3104581002816122, 1.0]], [0, [2.1173952126954694, 1.0]], [0, [5.861679248625202, 1.0]], [1, [7.109956013977187, 1.0]], [1, [23.170121645814678, 1.0]], [1, [99.78404145371076, 1.0]], [1, [0.2660410461480649, 1.0]], [1, [2.440737491683807, 1.0]], [1, [0.8338534047564433, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82334825]
bas 1, expnt(s) = [24413.79426863]
bas 2, expnt(s) = [3661.44715093]
bas 3, expnt(s) = [833.41147083]
bas 4, expnt(s) = [234.41793578]
bas 5, expnt(s) = [79.75454686]
bas 6, expnt(s) = [13.22795231]
bas 7, expnt(s) = [31.12006952]
bas 8, expnt(s) = [0.3104581]
bas 9, expnt(s) = [2.11739521]
bas 10, expnt(s) = [5.86167925]
bas 11, expnt(s) = [7.10995601]
bas 12, expnt(s) = [23.17012165]
bas 13, expnt(s) = [99.78404145]
bas 14, expnt(s) = [0.26604105]
bas 15, expnt(s) = [2.44073749]
bas 16, expnt(s) = [0.8338534]
CPU time:       372.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23348247e-01 2.18374889e+00 2.44137943e+04 4.93448104e+03
 3.66144715e+03 1.18919918e+03 8.33411471e+02 3.91885892e+02
 2.34417936e+02 1.51358966e+02 7.97545469e+01 6.74266547e+01
 1.32279523e+01 1.75240502e+01 3.11200695e+01 3.32885933e+01
 3.10458100e-01 1.05079324e+00 2.11739521e+00 4.43472270e+00
 5.86167925e+00 9.51769014e+00 7.10995601e+00 3.38702214e+01
 2.31701216e+01 1.48301241e+02 9.97840415e+01 9.20048570e+02
 2.66041046e-01 5.57404154e-01 2.44073749e+00 8.89991242e+00
 8.33853405e-01 2.32459086e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639707922903
cond(S) = 1313.990228549975
E1 = -183.59018147092434  E_coul = 55.08018769493383
init E= -128.50999377599
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401796816446  LUMO = 0.823903382794075
  mo_energy =
[-3.25552794e+01 -1.85273677e+00 -7.75401797e-01 -7.75401797e-01
 -7.75401797e-01  8.23903383e-01  8.23903383e-01  8.23903383e-01
  8.41160061e-01  3.95576029e+00  3.95576029e+00  3.95576029e+00
  4.77848741e+00  1.43524832e+01  1.43524832e+01  1.43524832e+01
  1.82782973e+01  5.29910933e+01  5.29910933e+01  5.29910933e+01
  5.95113499e+01  1.79437108e+02  2.40814445e+02  2.40814445e+02
  2.40814445e+02  5.53955246e+02  1.92092832e+03  8.04518647e+03
  4.78052601e+04]
E1 = -182.08608592313473  E_coul = 53.5475477904225
cycle= 1 E= -128.538538132712  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518688
diis-c [-0.26903683  1.        ]
  HOMO = -0.884335944803863  LUMO = 0.797121844046292
  mo_energy =
[-3.28784944e+01 -1.96664959e+00 -8.84335945e-01 -8.84335945e-01
 -8.84335945e-01  7.97121844e-01  7.97121844e-01  7.97121844e-01
  8.10097564e-01  3.85829214e+00  3.85829214e+00  3.85829214e+00
  4.68504918e+00  1.41617342e+01  1.41617342e+01  1.41617342e+01
  1.80932940e+01  5.27101131e+01  5.27101131e+01  5.27101131e+01
  5.92460221e+01  1.79116727e+02  2.40468101e+02  2.40468101e+02
  2.40468101e+02  5.53594138e+02  1.92053112e+03  8.04475987e+03
  4.78048146e+04]
E1 = -182.84763511185034  E_coul = 54.3065090047905
cycle= 2 E= -128.54112610706  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263847
diis-c [-0.00075425  0.33626694  0.66373306]
  HOMO = -0.848712065434936  LUMO = 0.80585092232288
  mo_energy =
[-3.27704052e+01 -1.92913818e+00 -8.48712065e-01 -8.48712065e-01
 -8.48712065e-01  8.05850922e-01  8.05850922e-01  8.05850922e-01
  8.20029798e-01  3.88990128e+00  3.88990128e+00  3.88990128e+00
  4.71538213e+00  1.42249050e+01  1.42249050e+01  1.42249050e+01
  1.81545704e+01  5.28041212e+01  5.28041212e+01  5.28041212e+01
  5.93349767e+01  1.79223451e+02  2.40581763e+02  2.40581763e+02
  2.40581763e+02  5.53710784e+02  1.92065310e+03  8.04488436e+03
  4.78049400e+04]
E1 = -182.58898992466763  E_coul = 54.046943473718166
cycle= 3 E= -128.542046450949  delta_E= -0.00092  |g|= 0.000499  |ddm|= 0.0226
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109987
diis-c [-1.84808451e-07 -2.36436263e-03 -8.10942790e-04  1.00317531e+00]
  HOMO = -0.84896457857025  LUMO = 0.805812448344539
  mo_energy =
[-3.27708449e+01 -1.92932616e+00 -8.48964579e-01 -8.48964579e-01
 -8.48964579e-01  8.05812448e-01  8.05812448e-01  8.05812448e-01
  8.19975045e-01  3.88972725e+00  3.88972725e+00  3.88972725e+00
  4.71522484e+00  1.42246091e+01  1.42246091e+01  1.42246091e+01
  1.81542899e+01  5.28037323e+01  5.28037323e+01  5.28037323e+01
  5.93346110e+01  1.79223001e+02  2.40581252e+02  2.40581252e+02
  2.40581252e+02  5.53710218e+02  1.92065240e+03  8.04488356e+03
  4.78049392e+04]
E1 = -182.5893928377338  E_coul = 54.04734636199761
cycle= 4 E= -128.542046475736  delta_E= -2.48e-08  |g|= 8.06e-05  |ddm|= 0.000323
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001886
diis-c [-1.10838890e-09  2.28369045e-04  5.31274681e-04 -1.82309963e-01
  1.18155032e+00]
  HOMO = -0.849007917303343  LUMO = 0.805799074395423
  mo_energy =
[-3.27709190e+01 -1.92935907e+00 -8.49007917e-01 -8.49007917e-01
 -8.49007917e-01  8.05799074e-01  8.05799074e-01  8.05799074e-01
  8.19961193e-01  3.88968680e+00  3.88968680e+00  3.88968680e+00
  4.71518966e+00  1.42245492e+01  1.42245492e+01  1.42245492e+01
  1.81542324e+01  5.28036625e+01  5.28036625e+01  5.28036625e+01
  5.93345426e+01  1.79222927e+02  2.40581174e+02  2.40581174e+02
  2.40581174e+02  5.53710135e+02  1.92065231e+03  8.04488347e+03
  4.78049391e+04]
E1 = -182.58952919479262  E_coul = 54.04748271834865
cycle= 5 E= -128.542046476444  delta_E= -7.08e-10  |g|= 5.86e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58952919479262  E_coul = 54.04748271834865
  HOMO = -0.849004863465166  LUMO = 0.805799974733159
  mo_energy =
[-3.27709121e+01 -1.92935521e+00 -8.49004863e-01 -8.49004863e-01
 -8.49004863e-01  8.05799975e-01  8.05799975e-01  8.05799975e-01
  8.19962581e-01  3.88968973e+00  3.88968973e+00  3.88968973e+00
  4.71519282e+00  1.42245542e+01  1.42245542e+01  1.42245542e+01
  1.81542375e+01  5.28036689e+01  5.28036689e+01  5.28036689e+01
  5.93345490e+01  1.79222933e+02  2.40581181e+02  2.40581181e+02
  2.40581181e+02  5.53710142e+02  1.92065232e+03  8.04488347e+03
  4.78049391e+04]
E1 = -182.58951368639535  E_coul = 54.047467209948664
Extra cycle  E= -128.542046476447  delta_E= -2.7e-12  |g|= 2.19e-06  |ddm|= 2.15e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [8.23348247e-01 2.44137943e+04 3.66144715e+03 8.33411471e+02
 2.34417936e+02 7.97545469e+01 1.32279523e+01 3.11200695e+01
 3.10458100e-01 2.11739521e+00 5.86167925e+00 7.10995601e+00
 2.31701216e+01 9.97840415e+01 2.66041046e-01 2.44073749e+00
 8.33853405e-01]
E = -128.54204647644667
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823348246679       1
[INPUT] 0    0    [1    /1   ]  24413.7942686        1
[INPUT] 0    0    [1    /1   ]  3661.44715093        1
[INPUT] 0    0    [1    /1   ]  833.411470826        1
[INPUT] 0    0    [1    /1   ]  234.417935777        1
[INPUT] 0    0    [1    /1   ]  79.7545468644        1
[INPUT] 0    0    [1    /1   ]  13.2279523071        1
[INPUT] 0    0    [1    /1   ]  31.1200695186        1
[INPUT] 0    0    [1    /1   ]  0.310458100282       1
[INPUT] 0    0    [1    /1   ]  2.1173952127         1
[INPUT] 0    0    [1    /1   ]  5.86167924863        1
[INPUT] 1    0    [1    /1   ]  7.10995601398        1
[INPUT] 1    0    [1    /1   ]  23.1701216458        1
[INPUT] 1    0    [1    /1   ]  99.7840414537        1
[INPUT] 1    0    [1    /1   ]  0.266041046148       1
[INPUT] 1    0    [1    /1   ]  2.44073749168        1
[INPUT] 1    0    [1    /1   ]  0.833853404756       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8233482466791465, 1.0]], [0, [24413.794268629434, 1.0]], [0, [3661.4471509309333, 1.0]], [0, [833.4114708255405, 1.0]], [0, [234.4179357768456, 1.0]], [0, [79.7545468643841, 1.0]], [0, [13.227952307072142, 1.0]], [0, [31.120069518599575, 1.0]], [0, [0.3104581002816122, 1.0]], [0, [2.1173952126954694, 1.0]], [0, [5.861679248625202, 1.0]], [1, [7.109956013977187, 1.0]], [1, [23.170121645814678, 1.0]], [1, [99.78404145371076, 1.0]], [1, [0.2660410461480649, 1.0]], [1, [2.440737491683807, 1.0]], [1, [0.8338534047564433, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82334825]
bas 1, expnt(s) = [24413.79426863]
bas 2, expnt(s) = [3661.44715093]
bas 3, expnt(s) = [833.41147083]
bas 4, expnt(s) = [234.41793578]
bas 5, expnt(s) = [79.75454686]
bas 6, expnt(s) = [13.22795231]
bas 7, expnt(s) = [31.12006952]
bas 8, expnt(s) = [0.3104581]
bas 9, expnt(s) = [2.11739521]
bas 10, expnt(s) = [5.86167925]
bas 11, expnt(s) = [7.10995601]
bas 12, expnt(s) = [23.17012165]
bas 13, expnt(s) = [99.78404145]
bas 14, expnt(s) = [0.26604105]
bas 15, expnt(s) = [2.44073749]
bas 16, expnt(s) = [0.8338534]
CPU time:       373.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23348247e-01 2.18374889e+00 2.44137943e+04 4.93448104e+03
 3.66144715e+03 1.18919918e+03 8.33411471e+02 3.91885892e+02
 2.34417936e+02 1.51358966e+02 7.97545469e+01 6.74266547e+01
 1.32279523e+01 1.75240502e+01 3.11200695e+01 3.32885933e+01
 3.10458100e-01 1.05079324e+00 2.11739521e+00 4.43472270e+00
 5.86167925e+00 9.51769014e+00 7.10995601e+00 3.38702214e+01
 2.31701216e+01 1.48301241e+02 9.97840415e+01 9.20048570e+02
 2.66041046e-01 5.57404154e-01 2.44073749e+00 8.89991242e+00
 8.33853405e-01 2.32459086e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639707922903
cond(S) = 1313.990228549975
E1 = -183.59018147092434  E_coul = 55.08018769493383
init E= -128.50999377599
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401796816446  LUMO = 0.823903382794075
  mo_energy =
[-3.25552794e+01 -1.85273677e+00 -7.75401797e-01 -7.75401797e-01
 -7.75401797e-01  8.23903383e-01  8.23903383e-01  8.23903383e-01
  8.41160061e-01  3.95576029e+00  3.95576029e+00  3.95576029e+00
  4.77848741e+00  1.43524832e+01  1.43524832e+01  1.43524832e+01
  1.82782973e+01  5.29910933e+01  5.29910933e+01  5.29910933e+01
  5.95113499e+01  1.79437108e+02  2.40814445e+02  2.40814445e+02
  2.40814445e+02  5.53955246e+02  1.92092832e+03  8.04518647e+03
  4.78052601e+04]
E1 = -182.08608592313473  E_coul = 53.5475477904225
cycle= 1 E= -128.538538132712  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518688
diis-c [-0.26903683  1.        ]
  HOMO = -0.884335944803863  LUMO = 0.797121844046292
  mo_energy =
[-3.28784944e+01 -1.96664959e+00 -8.84335945e-01 -8.84335945e-01
 -8.84335945e-01  7.97121844e-01  7.97121844e-01  7.97121844e-01
  8.10097564e-01  3.85829214e+00  3.85829214e+00  3.85829214e+00
  4.68504918e+00  1.41617342e+01  1.41617342e+01  1.41617342e+01
  1.80932940e+01  5.27101131e+01  5.27101131e+01  5.27101131e+01
  5.92460221e+01  1.79116727e+02  2.40468101e+02  2.40468101e+02
  2.40468101e+02  5.53594138e+02  1.92053112e+03  8.04475987e+03
  4.78048146e+04]
E1 = -182.84763511185034  E_coul = 54.3065090047905
cycle= 2 E= -128.54112610706  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263847
diis-c [-0.00075425  0.33626694  0.66373306]
  HOMO = -0.848712065434936  LUMO = 0.80585092232288
  mo_energy =
[-3.27704052e+01 -1.92913818e+00 -8.48712065e-01 -8.48712065e-01
 -8.48712065e-01  8.05850922e-01  8.05850922e-01  8.05850922e-01
  8.20029798e-01  3.88990128e+00  3.88990128e+00  3.88990128e+00
  4.71538213e+00  1.42249050e+01  1.42249050e+01  1.42249050e+01
  1.81545704e+01  5.28041212e+01  5.28041212e+01  5.28041212e+01
  5.93349767e+01  1.79223451e+02  2.40581763e+02  2.40581763e+02
  2.40581763e+02  5.53710784e+02  1.92065310e+03  8.04488436e+03
  4.78049400e+04]
E1 = -182.58898992466763  E_coul = 54.046943473718166
cycle= 3 E= -128.542046450949  delta_E= -0.00092  |g|= 0.000499  |ddm|= 0.0226
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109987
diis-c [-1.84808451e-07 -2.36436263e-03 -8.10942790e-04  1.00317531e+00]
  HOMO = -0.84896457857025  LUMO = 0.805812448344539
  mo_energy =
[-3.27708449e+01 -1.92932616e+00 -8.48964579e-01 -8.48964579e-01
 -8.48964579e-01  8.05812448e-01  8.05812448e-01  8.05812448e-01
  8.19975045e-01  3.88972725e+00  3.88972725e+00  3.88972725e+00
  4.71522484e+00  1.42246091e+01  1.42246091e+01  1.42246091e+01
  1.81542899e+01  5.28037323e+01  5.28037323e+01  5.28037323e+01
  5.93346110e+01  1.79223001e+02  2.40581252e+02  2.40581252e+02
  2.40581252e+02  5.53710218e+02  1.92065240e+03  8.04488356e+03
  4.78049392e+04]
E1 = -182.5893928377338  E_coul = 54.04734636199761
cycle= 4 E= -128.542046475736  delta_E= -2.48e-08  |g|= 8.06e-05  |ddm|= 0.000323
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001886
diis-c [-1.10838890e-09  2.28369045e-04  5.31274681e-04 -1.82309963e-01
  1.18155032e+00]
  HOMO = -0.849007917303343  LUMO = 0.805799074395423
  mo_energy =
[-3.27709190e+01 -1.92935907e+00 -8.49007917e-01 -8.49007917e-01
 -8.49007917e-01  8.05799074e-01  8.05799074e-01  8.05799074e-01
  8.19961193e-01  3.88968680e+00  3.88968680e+00  3.88968680e+00
  4.71518966e+00  1.42245492e+01  1.42245492e+01  1.42245492e+01
  1.81542324e+01  5.28036625e+01  5.28036625e+01  5.28036625e+01
  5.93345426e+01  1.79222927e+02  2.40581174e+02  2.40581174e+02
  2.40581174e+02  5.53710135e+02  1.92065231e+03  8.04488347e+03
  4.78049391e+04]
E1 = -182.58952919479262  E_coul = 54.04748271834865
cycle= 5 E= -128.542046476444  delta_E= -7.08e-10  |g|= 5.86e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58952919479262  E_coul = 54.04748271834865
  HOMO = -0.849004863465166  LUMO = 0.805799974733159
  mo_energy =
[-3.27709121e+01 -1.92935521e+00 -8.49004863e-01 -8.49004863e-01
 -8.49004863e-01  8.05799975e-01  8.05799975e-01  8.05799975e-01
  8.19962581e-01  3.88968973e+00  3.88968973e+00  3.88968973e+00
  4.71519282e+00  1.42245542e+01  1.42245542e+01  1.42245542e+01
  1.81542375e+01  5.28036689e+01  5.28036689e+01  5.28036689e+01
  5.93345490e+01  1.79222933e+02  2.40581181e+02  2.40581181e+02
  2.40581181e+02  5.53710142e+02  1.92065232e+03  8.04488347e+03
  4.78049391e+04]
E1 = -182.58951368639535  E_coul = 54.047467209948664
Extra cycle  E= -128.542046476447  delta_E= -2.7e-12  |g|= 2.19e-06  |ddm|= 2.15e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1313.990228549975
E1 = -182.58951368639535  E_coul = 54.047467209948664
init E= -128.542046476447
    CPU time for initialize scf      0.34 sec, wall time      0.33 sec
  HOMO = -0.8490059612147  LUMO = 0.805799723751802
  mo_energy =
[-3.27709155e+01 -1.92935623e+00 -8.49005961e-01 -8.49005961e-01
 -8.49005961e-01  8.05799724e-01  8.05799724e-01  8.05799724e-01
  8.19962361e-01  3.88968878e+00  3.88968878e+00  3.88968878e+00
  4.71519198e+00  1.42245523e+01  1.42245523e+01  1.42245523e+01
  1.81542356e+01  5.28036659e+01  5.28036659e+01  5.28036659e+01
  5.93345462e+01  1.79222930e+02  2.40581177e+02  2.40581177e+02
  2.40581177e+02  5.53710138e+02  1.92065231e+03  8.04488347e+03
  4.78049391e+04]
E1 = -182.58952231643227  E_coul = 54.04747583998523
cycle= 1 E= -128.542046476447  delta_E= -3.69e-13  |g|= 1.18e-06  |ddm|= 7.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58952231643227  E_coul = 54.04747583998523
  HOMO = -0.849005353852454  LUMO = 0.805799875988857
  mo_energy =
[-3.27709137e+01 -1.92935556e+00 -8.49005354e-01 -8.49005354e-01
 -8.49005354e-01  8.05799876e-01  8.05799876e-01  8.05799876e-01
  8.19962548e-01  3.88968932e+00  3.88968932e+00  3.88968932e+00
  4.71519252e+00  1.42245534e+01  1.42245534e+01  1.42245534e+01
  1.81542367e+01  5.28036675e+01  5.28036675e+01  5.28036675e+01
  5.93345477e+01  1.79222932e+02  2.40581179e+02  2.40581179e+02
  2.40581179e+02  5.53710140e+02  1.92065231e+03  8.04488347e+03
  4.78049391e+04]
E1 = -182.58951798087435  E_coul = 54.04747150442691
Extra cycle  E= -128.542046476447  delta_E= -3.98e-13  |g|= 5.89e-07  |ddm|= 3.91e-07
    CPU time for scf_cycle      0.41 sec, wall time      0.40 sec
exp = [8.23348247e-01 2.44137943e+04 3.66144715e+03 8.33411471e+02
 2.34417936e+02 7.97545469e+01 1.32279523e+01 3.11200695e+01
 3.10458100e-01 2.11739521e+00 5.86167925e+00 7.10995601e+00
 2.31701216e+01 9.97840415e+01 2.66041046e-01 2.44073749e+00
 8.33853405e-01]
grad_E = [ 5.21705304e-05  4.45110817e-09 -2.20743722e-07  3.61650472e-06
 -1.90782712e-05 -3.17622894e-06 -7.34536298e-06  3.25867194e-07
 -1.27308138e-04 -4.65249425e-06  6.12396752e-06 -2.93516587e-05
  5.99145763e-06 -2.17364522e-07 -1.74610540e-04  9.50301999e-06
  1.15301037e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.822620184305       1
[INPUT] 0    0    [1    /1   ]  24413.7942681        1
[INPUT] 0    0    [1    /1   ]  3661.44717652        1
[INPUT] 0    0    [1    /1   ]  833.410956556        1
[INPUT] 0    0    [1    /1   ]  234.423450345        1
[INPUT] 0    0    [1    /1   ]  79.7328837211        1
[INPUT] 0    0    [1    /1   ]  13.2242286877        1
[INPUT] 0    0    [1    /1   ]  31.1170374905        1
[INPUT] 0    0    [1    /1   ]  0.310514976135       1
[INPUT] 0    0    [1    /1   ]  2.115692909          1
[INPUT] 0    0    [1    /1   ]  5.84742539542        1
[INPUT] 1    0    [1    /1   ]  7.11271740209        1
[INPUT] 1    0    [1    /1   ]  23.1691449627        1
[INPUT] 1    0    [1    /1   ]  99.7841035763        1
[INPUT] 1    0    [1    /1   ]  0.266040856487       1
[INPUT] 1    0    [1    /1   ]  2.44138825461        1
[INPUT] 1    0    [1    /1   ]  0.833862715554       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8226201843047818, 1.0]], [0, [24413.794268148147, 1.0]], [0, [3661.4471765193157, 1.0]], [0, [833.4109565561798, 1.0]], [0, [234.4234503446472, 1.0]], [0, [79.73288372107562, 1.0]], [0, [13.224228687672722, 1.0]], [0, [31.117037490450254, 1.0]], [0, [0.3105149761347367, 1.0]], [0, [2.115692908999532, 1.0]], [0, [5.847425395424922, 1.0]], [1, [7.1127174020877915, 1.0]], [1, [23.169144962697466, 1.0]], [1, [99.78410357626365, 1.0]], [1, [0.26604085648651704, 1.0]], [1, [2.441388254611644, 1.0]], [1, [0.8338627155539522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82262018]
bas 1, expnt(s) = [24413.79426815]
bas 2, expnt(s) = [3661.44717652]
bas 3, expnt(s) = [833.41095656]
bas 4, expnt(s) = [234.42345034]
bas 5, expnt(s) = [79.73288372]
bas 6, expnt(s) = [13.22422869]
bas 7, expnt(s) = [31.11703749]
bas 8, expnt(s) = [0.31051498]
bas 9, expnt(s) = [2.11569291]
bas 10, expnt(s) = [5.8474254]
bas 11, expnt(s) = [7.1127174]
bas 12, expnt(s) = [23.16914496]
bas 13, expnt(s) = [99.78410358]
bas 14, expnt(s) = [0.26604086]
bas 15, expnt(s) = [2.44138825]
bas 16, expnt(s) = [0.83386272]
CPU time:       377.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.22620184e-01 2.18230047e+00 2.44137943e+04 4.93448104e+03
 3.66144718e+03 1.18919919e+03 8.33410957e+02 3.91885711e+02
 2.34423450e+02 1.51361636e+02 7.97328837e+01 6.74129183e+01
 1.32242287e+01 1.75203504e+01 3.11170375e+01 3.32861608e+01
 3.10514976e-01 1.05093762e+00 2.11569291e+00 4.43204843e+00
 5.84742540e+00 9.50032673e+00 7.11271740e+00 3.38866654e+01
 2.31691450e+01 1.48293427e+02 9.97841036e+01 9.20049286e+02
 2.66040856e-01 5.57403658e-01 2.44138825e+00 8.90287870e+00
 8.33862716e-01 2.32462330e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639745995726
cond(S) = 1309.8587361582522
E1 = -183.59018471551772  E_coul = 55.08018655120356
init E= -128.509998164314
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401988477554  LUMO = 0.82391419062394
  mo_energy =
[-3.25552794e+01 -1.85273702e+00 -7.75401988e-01 -7.75401988e-01
 -7.75401988e-01  8.23914191e-01  8.23914191e-01  8.23914191e-01
  8.40820507e-01  3.95611049e+00  3.95611049e+00  3.95611049e+00
  4.77381270e+00  1.43565758e+01  1.43565758e+01  1.43565758e+01
  1.82510909e+01  5.30002468e+01  5.30002468e+01  5.30002468e+01
  5.94483832e+01  1.79338855e+02  2.40821553e+02  2.40821553e+02
  2.40821553e+02  5.53818554e+02  1.92078399e+03  8.04505574e+03
  4.78051511e+04]
E1 = -182.08611386727114  E_coul = 53.5475756162803
cycle= 1 E= -128.538538250991  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518714
diis-c [-0.26906447  1.        ]
  HOMO = -0.884333592680724  LUMO = 0.797133167793128
  mo_energy =
[-3.28784896e+01 -1.96664765e+00 -8.84333593e-01 -8.84333593e-01
 -8.84333593e-01  7.97133168e-01  7.97133168e-01  7.97133168e-01
  8.09780012e-01  3.85863045e+00  3.85863045e+00  3.85863045e+00
  4.68047193e+00  1.41657982e+01  1.41657982e+01  1.41657982e+01
  1.80662215e+01  5.27192687e+01  5.27192687e+01  5.27192687e+01
  5.91830979e+01  1.79018485e+02  2.40475215e+02  2.40475215e+02
  2.40475215e+02  5.53457451e+02  1.92038680e+03  8.04462915e+03
  4.78047056e+04]
E1 = -182.84766791301442  E_coul = 54.30654166131592
cycle= 2 E= -128.541126251699  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263859
diis-c [-0.00075393  0.33626577  0.66373423]
  HOMO = -0.848709368707429  LUMO = 0.805862609849247
  mo_energy =
[-3.27703997e+01 -1.92913588e+00 -8.48709369e-01 -8.48709369e-01
 -8.48709369e-01  8.05862610e-01  8.05862610e-01  8.05862610e-01
  8.19705959e-01  3.89024478e+00  3.89024478e+00  3.89024478e+00
  4.71077391e+00  1.42289803e+01  1.42289803e+01  1.42289803e+01
  1.81274533e+01  5.28132780e+01  5.28132780e+01  5.28132780e+01
  5.92720398e+01  1.79125208e+02  2.40588877e+02  2.40588877e+02
  2.40588877e+02  5.53574097e+02  1.92050878e+03  8.04475364e+03
  4.78048310e+04]
E1 = -182.58902585070098  E_coul = 54.04697926186539
cycle= 3 E= -128.542046588836  delta_E= -0.00092  |g|= 0.000499  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109922
diis-c [-1.84616301e-07 -2.36279308e-03 -8.10385194e-04  1.00317318e+00]
  HOMO = -0.848961555610237  LUMO = 0.805824259486804
  mo_energy =
[-3.27708391e+01 -1.92932356e+00 -8.48961556e-01 -8.48961556e-01
 -8.48961556e-01  8.05824259e-01  8.05824259e-01  8.05824259e-01
  8.19651405e-01  3.89007105e+00  3.89007105e+00  3.89007105e+00
  4.71061710e+00  1.42286848e+01  1.42286848e+01  1.42286848e+01
  1.81271733e+01  5.28128895e+01  5.28128895e+01  5.28128895e+01
  5.92716745e+01  1.79124759e+02  2.40588367e+02  2.40588367e+02
  2.40588367e+02  5.53573532e+02  1.92050808e+03  8.04475284e+03
  4.78048302e+04]
E1 = -182.58942874960064  E_coul = 54.04738213604857
cycle= 4 E= -128.542046613552  delta_E= -2.47e-08  |g|= 8.05e-05  |ddm|= 0.000322
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018846
diis-c [-1.10766008e-09  2.28325627e-04  5.31048519e-04 -1.82295580e-01
  1.18153621e+00]
  HOMO = -0.849004840305301  LUMO = 0.805810904231352
  mo_energy =
[-3.27709130e+01 -1.92935642e+00 -8.49004840e-01 -8.49004840e-01
 -8.49004840e-01  8.05810904e-01  8.05810904e-01  8.05810904e-01
  8.19637585e-01  3.89003065e+00  3.89003065e+00  3.89003065e+00
  4.71058200e+00  1.42286250e+01  1.42286250e+01  1.42286250e+01
  1.81271159e+01  5.28128197e+01  5.28128197e+01  5.28128197e+01
  5.92716063e+01  1.79124684e+02  2.40588289e+02  2.40588289e+02
  2.40588289e+02  5.53573449e+02  1.92050799e+03  8.04475275e+03
  4.78048301e+04]
E1 = -182.5895650466335  E_coul = 54.04751843237557
cycle= 5 E= -128.542046614258  delta_E= -7.06e-10  |g|= 5.86e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5895650466335  E_coul = 54.04751843237557
  HOMO = -0.849001787709133  LUMO = 0.805811804022404
  mo_energy =
[-3.27709062e+01 -1.92935257e+00 -8.49001788e-01 -8.49001788e-01
 -8.49001788e-01  8.05811804e-01  8.05811804e-01  8.05811804e-01
  8.19638971e-01  3.89003358e+00  3.89003358e+00  3.89003358e+00
  4.71058515e+00  1.42286300e+01  1.42286300e+01  1.42286300e+01
  1.81271210e+01  5.28128262e+01  5.28128262e+01  5.28128262e+01
  5.92716126e+01  1.79124691e+02  2.40588296e+02  2.40588296e+02
  2.40588296e+02  5.53573456e+02  1.92050800e+03  8.04475275e+03
  4.78048301e+04]
E1 = -182.58954953367376  E_coul = 54.04750291941296
Extra cycle  E= -128.542046614261  delta_E= -2.87e-12  |g|= 2.19e-06  |ddm|= 2.15e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.22620184e-01 2.44137943e+04 3.66144718e+03 8.33410957e+02
 2.34423450e+02 7.97328837e+01 1.32242287e+01 3.11170375e+01
 3.10514976e-01 2.11569291e+00 5.84742540e+00 7.11271740e+00
 2.31691450e+01 9.97841036e+01 2.66040856e-01 2.44138825e+00
 8.33862716e-01]
E = -128.5420466142608
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.822620184305       1
[INPUT] 0    0    [1    /1   ]  24413.7942681        1
[INPUT] 0    0    [1    /1   ]  3661.44717652        1
[INPUT] 0    0    [1    /1   ]  833.410956556        1
[INPUT] 0    0    [1    /1   ]  234.423450345        1
[INPUT] 0    0    [1    /1   ]  79.7328837211        1
[INPUT] 0    0    [1    /1   ]  13.2242286877        1
[INPUT] 0    0    [1    /1   ]  31.1170374905        1
[INPUT] 0    0    [1    /1   ]  0.310514976135       1
[INPUT] 0    0    [1    /1   ]  2.115692909          1
[INPUT] 0    0    [1    /1   ]  5.84742539542        1
[INPUT] 1    0    [1    /1   ]  7.11271740209        1
[INPUT] 1    0    [1    /1   ]  23.1691449627        1
[INPUT] 1    0    [1    /1   ]  99.7841035763        1
[INPUT] 1    0    [1    /1   ]  0.266040856487       1
[INPUT] 1    0    [1    /1   ]  2.44138825461        1
[INPUT] 1    0    [1    /1   ]  0.833862715554       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8226201843047818, 1.0]], [0, [24413.794268148147, 1.0]], [0, [3661.4471765193157, 1.0]], [0, [833.4109565561798, 1.0]], [0, [234.4234503446472, 1.0]], [0, [79.73288372107562, 1.0]], [0, [13.224228687672722, 1.0]], [0, [31.117037490450254, 1.0]], [0, [0.3105149761347367, 1.0]], [0, [2.115692908999532, 1.0]], [0, [5.847425395424922, 1.0]], [1, [7.1127174020877915, 1.0]], [1, [23.169144962697466, 1.0]], [1, [99.78410357626365, 1.0]], [1, [0.26604085648651704, 1.0]], [1, [2.441388254611644, 1.0]], [1, [0.8338627155539522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82262018]
bas 1, expnt(s) = [24413.79426815]
bas 2, expnt(s) = [3661.44717652]
bas 3, expnt(s) = [833.41095656]
bas 4, expnt(s) = [234.42345034]
bas 5, expnt(s) = [79.73288372]
bas 6, expnt(s) = [13.22422869]
bas 7, expnt(s) = [31.11703749]
bas 8, expnt(s) = [0.31051498]
bas 9, expnt(s) = [2.11569291]
bas 10, expnt(s) = [5.8474254]
bas 11, expnt(s) = [7.1127174]
bas 12, expnt(s) = [23.16914496]
bas 13, expnt(s) = [99.78410358]
bas 14, expnt(s) = [0.26604086]
bas 15, expnt(s) = [2.44138825]
bas 16, expnt(s) = [0.83386272]
CPU time:       378.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.22620184e-01 2.18230047e+00 2.44137943e+04 4.93448104e+03
 3.66144718e+03 1.18919919e+03 8.33410957e+02 3.91885711e+02
 2.34423450e+02 1.51361636e+02 7.97328837e+01 6.74129183e+01
 1.32242287e+01 1.75203504e+01 3.11170375e+01 3.32861608e+01
 3.10514976e-01 1.05093762e+00 2.11569291e+00 4.43204843e+00
 5.84742540e+00 9.50032673e+00 7.11271740e+00 3.38866654e+01
 2.31691450e+01 1.48293427e+02 9.97841036e+01 9.20049286e+02
 2.66040856e-01 5.57403658e-01 2.44138825e+00 8.90287870e+00
 8.33862716e-01 2.32462330e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639745995726
cond(S) = 1309.8587361582522
E1 = -183.59018471551772  E_coul = 55.08018655120356
init E= -128.509998164314
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401988477554  LUMO = 0.82391419062394
  mo_energy =
[-3.25552794e+01 -1.85273702e+00 -7.75401988e-01 -7.75401988e-01
 -7.75401988e-01  8.23914191e-01  8.23914191e-01  8.23914191e-01
  8.40820507e-01  3.95611049e+00  3.95611049e+00  3.95611049e+00
  4.77381270e+00  1.43565758e+01  1.43565758e+01  1.43565758e+01
  1.82510909e+01  5.30002468e+01  5.30002468e+01  5.30002468e+01
  5.94483832e+01  1.79338855e+02  2.40821553e+02  2.40821553e+02
  2.40821553e+02  5.53818554e+02  1.92078399e+03  8.04505574e+03
  4.78051511e+04]
E1 = -182.08611386727114  E_coul = 53.5475756162803
cycle= 1 E= -128.538538250991  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518714
diis-c [-0.26906447  1.        ]
  HOMO = -0.884333592680724  LUMO = 0.797133167793128
  mo_energy =
[-3.28784896e+01 -1.96664765e+00 -8.84333593e-01 -8.84333593e-01
 -8.84333593e-01  7.97133168e-01  7.97133168e-01  7.97133168e-01
  8.09780012e-01  3.85863045e+00  3.85863045e+00  3.85863045e+00
  4.68047193e+00  1.41657982e+01  1.41657982e+01  1.41657982e+01
  1.80662215e+01  5.27192687e+01  5.27192687e+01  5.27192687e+01
  5.91830979e+01  1.79018485e+02  2.40475215e+02  2.40475215e+02
  2.40475215e+02  5.53457451e+02  1.92038680e+03  8.04462915e+03
  4.78047056e+04]
E1 = -182.84766791301442  E_coul = 54.30654166131592
cycle= 2 E= -128.541126251699  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263859
diis-c [-0.00075393  0.33626577  0.66373423]
  HOMO = -0.848709368707429  LUMO = 0.805862609849247
  mo_energy =
[-3.27703997e+01 -1.92913588e+00 -8.48709369e-01 -8.48709369e-01
 -8.48709369e-01  8.05862610e-01  8.05862610e-01  8.05862610e-01
  8.19705959e-01  3.89024478e+00  3.89024478e+00  3.89024478e+00
  4.71077391e+00  1.42289803e+01  1.42289803e+01  1.42289803e+01
  1.81274533e+01  5.28132780e+01  5.28132780e+01  5.28132780e+01
  5.92720398e+01  1.79125208e+02  2.40588877e+02  2.40588877e+02
  2.40588877e+02  5.53574097e+02  1.92050878e+03  8.04475364e+03
  4.78048310e+04]
E1 = -182.58902585070098  E_coul = 54.04697926186539
cycle= 3 E= -128.542046588836  delta_E= -0.00092  |g|= 0.000499  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109922
diis-c [-1.84616301e-07 -2.36279308e-03 -8.10385194e-04  1.00317318e+00]
  HOMO = -0.848961555610237  LUMO = 0.805824259486804
  mo_energy =
[-3.27708391e+01 -1.92932356e+00 -8.48961556e-01 -8.48961556e-01
 -8.48961556e-01  8.05824259e-01  8.05824259e-01  8.05824259e-01
  8.19651405e-01  3.89007105e+00  3.89007105e+00  3.89007105e+00
  4.71061710e+00  1.42286848e+01  1.42286848e+01  1.42286848e+01
  1.81271733e+01  5.28128895e+01  5.28128895e+01  5.28128895e+01
  5.92716745e+01  1.79124759e+02  2.40588367e+02  2.40588367e+02
  2.40588367e+02  5.53573532e+02  1.92050808e+03  8.04475284e+03
  4.78048302e+04]
E1 = -182.58942874960064  E_coul = 54.04738213604857
cycle= 4 E= -128.542046613552  delta_E= -2.47e-08  |g|= 8.05e-05  |ddm|= 0.000322
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018846
diis-c [-1.10766008e-09  2.28325627e-04  5.31048519e-04 -1.82295580e-01
  1.18153621e+00]
  HOMO = -0.849004840305301  LUMO = 0.805810904231352
  mo_energy =
[-3.27709130e+01 -1.92935642e+00 -8.49004840e-01 -8.49004840e-01
 -8.49004840e-01  8.05810904e-01  8.05810904e-01  8.05810904e-01
  8.19637585e-01  3.89003065e+00  3.89003065e+00  3.89003065e+00
  4.71058200e+00  1.42286250e+01  1.42286250e+01  1.42286250e+01
  1.81271159e+01  5.28128197e+01  5.28128197e+01  5.28128197e+01
  5.92716063e+01  1.79124684e+02  2.40588289e+02  2.40588289e+02
  2.40588289e+02  5.53573449e+02  1.92050799e+03  8.04475275e+03
  4.78048301e+04]
E1 = -182.5895650466335  E_coul = 54.04751843237557
cycle= 5 E= -128.542046614258  delta_E= -7.06e-10  |g|= 5.86e-06  |ddm|= 5.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.02 sec
E1 = -182.5895650466335  E_coul = 54.04751843237557
  HOMO = -0.849001787709133  LUMO = 0.805811804022404
  mo_energy =
[-3.27709062e+01 -1.92935257e+00 -8.49001788e-01 -8.49001788e-01
 -8.49001788e-01  8.05811804e-01  8.05811804e-01  8.05811804e-01
  8.19638971e-01  3.89003358e+00  3.89003358e+00  3.89003358e+00
  4.71058515e+00  1.42286300e+01  1.42286300e+01  1.42286300e+01
  1.81271210e+01  5.28128262e+01  5.28128262e+01  5.28128262e+01
  5.92716126e+01  1.79124691e+02  2.40588296e+02  2.40588296e+02
  2.40588296e+02  5.53573456e+02  1.92050800e+03  8.04475275e+03
  4.78048301e+04]
E1 = -182.58954953367376  E_coul = 54.04750291941296
Extra cycle  E= -128.542046614261  delta_E= -2.87e-12  |g|= 2.19e-06  |ddm|= 2.15e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1309.8587361582522
E1 = -182.58954953367376  E_coul = 54.04750291941296
init E= -128.542046614261
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.849002885831819  LUMO = 0.805811552909267
  mo_energy =
[-3.27709096e+01 -1.92935358e+00 -8.49002886e-01 -8.49002886e-01
 -8.49002886e-01  8.05811553e-01  8.05811553e-01  8.05811553e-01
  8.19638751e-01  3.89003263e+00  3.89003263e+00  3.89003263e+00
  4.71058431e+00  1.42286280e+01  1.42286280e+01  1.42286280e+01
  1.81271191e+01  5.28128232e+01  5.28128232e+01  5.28128232e+01
  5.92716098e+01  1.79124687e+02  2.40588292e+02  2.40588292e+02
  2.40588292e+02  5.53573452e+02  1.92050799e+03  8.04475275e+03
  4.78048301e+04]
E1 = -182.58955816455722  E_coul = 54.04751155029627
cycle= 1 E= -128.542046614261  delta_E= -1.42e-13  |g|= 1.18e-06  |ddm|= 7.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58955816455722  E_coul = 54.04751155029627
  HOMO = -0.849002278416993  LUMO = 0.805811705158247
  mo_energy =
[-3.27709078e+01 -1.92935291e+00 -8.49002278e-01 -8.49002278e-01
 -8.49002278e-01  8.05811705e-01  8.05811705e-01  8.05811705e-01
  8.19638938e-01  3.89003317e+00  3.89003317e+00  3.89003317e+00
  4.71058485e+00  1.42286291e+01  1.42286291e+01  1.42286291e+01
  1.81271202e+01  5.28128248e+01  5.28128248e+01  5.28128248e+01
  5.92716113e+01  1.79124689e+02  2.40588294e+02  2.40588294e+02
  2.40588294e+02  5.53573454e+02  1.92050800e+03  8.04475275e+03
  4.78048301e+04]
E1 = -182.58955382842302  E_coul = 54.04750721416156
Extra cycle  E= -128.542046614261  delta_E= -5.12e-13  |g|= 5.89e-07  |ddm|= 3.91e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.43 sec
exp = [8.22620184e-01 2.44137943e+04 3.66144718e+03 8.33410957e+02
 2.34423450e+02 7.97328837e+01 1.32242287e+01 3.11170375e+01
 3.10514976e-01 2.11569291e+00 5.84742540e+00 7.11271740e+00
 2.31691450e+01 9.97841036e+01 2.66040856e-01 2.44138825e+00
 8.33862716e-01]
grad_E = [ 9.92518925e-06  4.39463004e-09 -2.17905336e-07  3.56410855e-06
 -1.86746000e-05 -4.27717878e-06 -3.95101697e-06  6.11964724e-07
 -3.75690849e-05  3.74290626e-07  1.91326577e-06 -7.50686432e-06
  1.11064398e-06  1.23207985e-08 -1.00065221e-04 -2.53224629e-06
  5.75497623e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823221574791       1
[INPUT] 0    0    [1    /1   ]  24413.7942682        1
[INPUT] 0    0    [1    /1   ]  3661.44717315        1
[INPUT] 0    0    [1    /1   ]  833.41104088         1
[INPUT] 0    0    [1    /1   ]  234.422360292        1
[INPUT] 0    0    [1    /1   ]  79.7353364617        1
[INPUT] 0    0    [1    /1   ]  13.2383116674        1
[INPUT] 0    0    [1    /1   ]  31.1344105046        1
[INPUT] 0    0    [1    /1   ]  0.310832415055       1
[INPUT] 0    0    [1    /1   ]  2.11702599718        1
[INPUT] 0    0    [1    /1   ]  5.85214868411        1
[INPUT] 1    0    [1    /1   ]  7.11347324724        1
[INPUT] 1    0    [1    /1   ]  23.1688653089        1
[INPUT] 1    0    [1    /1   ]  99.7841145167        1
[INPUT] 1    0    [1    /1   ]  0.266050599523       1
[INPUT] 1    0    [1    /1   ]  2.44148896884        1
[INPUT] 1    0    [1    /1   ]  0.833818205201       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.823221574791325, 1.0]], [0, [24413.794268206344, 1.0]], [0, [3661.447173145584, 1.0]], [0, [833.4110408803075, 1.0]], [0, [234.4223602921686, 1.0]], [0, [79.73533646172473, 1.0]], [0, [13.238311667445299, 1.0]], [0, [31.134410504607672, 1.0]], [0, [0.3108324150546982, 1.0]], [0, [2.11702599717601, 1.0]], [0, [5.852148684106681, 1.0]], [1, [7.113473247236131, 1.0]], [1, [23.16886530886235, 1.0]], [1, [99.78411451673125, 1.0]], [1, [0.26605059952316684, 1.0]], [1, [2.4414889688428807, 1.0]], [1, [0.8338182052009651, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82322157]
bas 1, expnt(s) = [24413.79426821]
bas 2, expnt(s) = [3661.44717315]
bas 3, expnt(s) = [833.41104088]
bas 4, expnt(s) = [234.42236029]
bas 5, expnt(s) = [79.73533646]
bas 6, expnt(s) = [13.23831167]
bas 7, expnt(s) = [31.1344105]
bas 8, expnt(s) = [0.31083242]
bas 9, expnt(s) = [2.117026]
bas 10, expnt(s) = [5.85214868]
bas 11, expnt(s) = [7.11347325]
bas 12, expnt(s) = [23.16886531]
bas 13, expnt(s) = [99.78411452]
bas 14, expnt(s) = [0.2660506]
bas 15, expnt(s) = [2.44148897]
bas 16, expnt(s) = [0.83381821]
CPU time:       382.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23221575e-01 2.18349691e+00 2.44137943e+04 4.93448104e+03
 3.66144717e+03 1.18919919e+03 8.33411041e+02 3.91885741e+02
 2.34422360e+02 1.51361109e+02 7.97353365e+01 6.74144736e+01
 1.32383117e+01 1.75343421e+01 3.11344105e+01 3.33000979e+01
 3.10832415e-01 1.05174329e+00 2.11702600e+00 4.43414272e+00
 5.85214868e+00 9.50608160e+00 7.11347325e+00 3.38911668e+01
 2.31688653e+01 1.48291189e+02 9.97841145e+01 9.20049412e+02
 2.66050600e-01 5.57429175e-01 2.44148897e+00 8.90333779e+00
 8.33818205e-01 2.32446820e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639766202321
cond(S) = 1311.3780724790367
E1 = -183.59018734000696  E_coul = 55.08018665402002
init E= -128.510000685987
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401997597791  LUMO = 0.823929079362085
  mo_energy =
[-3.25552794e+01 -1.85273695e+00 -7.75401998e-01 -7.75401998e-01
 -7.75401998e-01  8.23929079e-01  8.23929079e-01  8.23929079e-01
  8.41892993e-01  3.95607956e+00  3.95607956e+00  3.95607956e+00
  4.77868967e+00  1.43573566e+01  1.43573566e+01  1.43573566e+01
  1.82692874e+01  5.30023535e+01  5.30023535e+01  5.30023535e+01
  5.95054292e+01  1.79451809e+02  2.40823165e+02  2.40823165e+02
  2.40823165e+02  5.53963622e+02  1.92092822e+03  8.04518539e+03
  4.78052590e+04]
E1 = -182.0861589427582  E_coul = 53.54762057169788
cycle= 1 E= -128.53853837106  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518705
diis-c [-0.26905535  1.        ]
  HOMO = -0.884329693752427  LUMO = 0.79715012398145
  mo_energy =
[-3.28784827e+01 -1.96664375e+00 -8.84329694e-01 -8.84329694e-01
 -8.84329694e-01  7.97150124e-01  7.97150124e-01  7.97150124e-01
  8.10818145e-01  3.85860279e+00  3.85860279e+00  3.85860279e+00
  4.68529052e+00  1.41665762e+01  1.41665762e+01  1.41665762e+01
  1.80843416e+01  5.27213810e+01  5.27213810e+01  5.27213810e+01
  5.92400960e+01  1.79131433e+02  2.40476835e+02  2.40476835e+02
  2.40476835e+02  5.53602526e+02  1.92053104e+03  8.04475881e+03
  4.78048135e+04]
E1 = -182.84770115569734  E_coul = 54.30657483464637
cycle= 2 E= -128.541126321051  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263852
diis-c [-0.00075409  0.33626371  0.66373629]
  HOMO = -0.848705900720961  LUMO = 0.805879369049825
  mo_energy =
[-3.27703942e+01 -1.92913243e+00 -8.48705901e-01 -8.48705901e-01
 -8.48705901e-01  8.05879369e-01  8.05879369e-01  8.05879369e-01
  8.20755868e-01  3.89021702e+00  3.89021702e+00  3.89021702e+00
  4.71561280e+00  1.42297603e+01  1.42297603e+01  1.42297603e+01
  1.81456006e+01  5.28153895e+01  5.28153895e+01  5.28153895e+01
  5.93290551e+01  1.79238158e+02  2.40590496e+02  2.40590496e+02
  2.40590496e+02  5.53719171e+02  1.92065302e+03  8.04488330e+03
  4.78049389e+04]
E1 = -182.58906812032873  E_coul = 54.04702150691998
cycle= 3 E= -128.542046613409  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109858
diis-c [-1.84295092e-07 -2.36125740e-03 -8.09346089e-04  1.00317060e+00]
  HOMO = -0.848957796500784  LUMO = 0.805841138036549
  mo_energy =
[-3.27708333e+01 -1.92931982e+00 -8.48957797e-01 -8.48957797e-01
 -8.48957797e-01  8.05841138e-01  8.05841138e-01  8.05841138e-01
  8.20701423e-01  3.89004357e+00  3.89004357e+00  3.89004357e+00
  4.71545618e+00  1.42294651e+01  1.42294651e+01  1.42294651e+01
  1.81453210e+01  5.28150013e+01  5.28150013e+01  5.28150013e+01
  5.93286901e+01  1.79237709e+02  2.40589986e+02  2.40589986e+02
  2.40589986e+02  5.53718606e+02  1.92065232e+03  8.04488250e+03
  4.78049381e+04]
E1 = -182.5894710166782  E_coul = 54.04742437862017
cycle= 4 E= -128.542046638058  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188369
diis-c [-1.10729315e-09  2.28318023e-04  5.31080598e-04 -1.82291143e-01
  1.18153174e+00]
  HOMO = -0.849001032356571  LUMO = 0.805827802323525
  mo_energy =
[-3.27709071e+01 -1.92935264e+00 -8.49001032e-01 -8.49001032e-01
 -8.49001032e-01  8.05827802e-01  8.05827802e-01  8.05827802e-01
  8.20687615e-01  3.89000322e+00  3.89000322e+00  3.89000322e+00
  4.71542111e+00  1.42294054e+01  1.42294054e+01  1.42294054e+01
  1.81452635e+01  5.28149316e+01  5.28149316e+01  5.28149316e+01
  5.93286219e+01  1.79237634e+02  2.40589908e+02  2.40589908e+02
  2.40589908e+02  5.53718524e+02  1.92065223e+03  8.04488240e+03
  4.78049380e+04]
E1 = -182.58960730756226  E_coul = 54.04756066879905
cycle= 5 E= -128.542046638763  delta_E= -7.05e-10  |g|= 5.86e-06  |ddm|= 5.29e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58960730756226  E_coul = 54.04756066879905
  HOMO = -0.848997980731346  LUMO = 0.805828701725574
  mo_energy =
[-3.27709003e+01 -1.92934878e+00 -8.48997981e-01 -8.48997981e-01
 -8.48997981e-01  8.05828702e-01  8.05828702e-01  8.05828702e-01
  8.20689002e-01  3.89000615e+00  3.89000615e+00  3.89000615e+00
  4.71542427e+00  1.42294104e+01  1.42294104e+01  1.42294104e+01
  1.81452686e+01  5.28149380e+01  5.28149380e+01  5.28149380e+01
  5.93286282e+01  1.79237641e+02  2.40589914e+02  2.40589914e+02
  2.40589914e+02  5.53718530e+02  1.92065223e+03  8.04488241e+03
  4.78049380e+04]
E1 = -182.5895917966834  E_coul = 54.04754515791751
Extra cycle  E= -128.542046638766  delta_E= -2.67e-12  |g|= 2.19e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [8.23221575e-01 2.44137943e+04 3.66144717e+03 8.33411041e+02
 2.34422360e+02 7.97353365e+01 1.32383117e+01 3.11344105e+01
 3.10832415e-01 2.11702600e+00 5.85214868e+00 7.11347325e+00
 2.31688653e+01 9.97841145e+01 2.66050600e-01 2.44148897e+00
 8.33818205e-01]
E = -128.5420466387659
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823221574791       1
[INPUT] 0    0    [1    /1   ]  24413.7942682        1
[INPUT] 0    0    [1    /1   ]  3661.44717315        1
[INPUT] 0    0    [1    /1   ]  833.41104088         1
[INPUT] 0    0    [1    /1   ]  234.422360292        1
[INPUT] 0    0    [1    /1   ]  79.7353364617        1
[INPUT] 0    0    [1    /1   ]  13.2383116674        1
[INPUT] 0    0    [1    /1   ]  31.1344105046        1
[INPUT] 0    0    [1    /1   ]  0.310832415055       1
[INPUT] 0    0    [1    /1   ]  2.11702599718        1
[INPUT] 0    0    [1    /1   ]  5.85214868411        1
[INPUT] 1    0    [1    /1   ]  7.11347324724        1
[INPUT] 1    0    [1    /1   ]  23.1688653089        1
[INPUT] 1    0    [1    /1   ]  99.7841145167        1
[INPUT] 1    0    [1    /1   ]  0.266050599523       1
[INPUT] 1    0    [1    /1   ]  2.44148896884        1
[INPUT] 1    0    [1    /1   ]  0.833818205201       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.823221574791325, 1.0]], [0, [24413.794268206344, 1.0]], [0, [3661.447173145584, 1.0]], [0, [833.4110408803075, 1.0]], [0, [234.4223602921686, 1.0]], [0, [79.73533646172473, 1.0]], [0, [13.238311667445299, 1.0]], [0, [31.134410504607672, 1.0]], [0, [0.3108324150546982, 1.0]], [0, [2.11702599717601, 1.0]], [0, [5.852148684106681, 1.0]], [1, [7.113473247236131, 1.0]], [1, [23.16886530886235, 1.0]], [1, [99.78411451673125, 1.0]], [1, [0.26605059952316684, 1.0]], [1, [2.4414889688428807, 1.0]], [1, [0.8338182052009651, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82322157]
bas 1, expnt(s) = [24413.79426821]
bas 2, expnt(s) = [3661.44717315]
bas 3, expnt(s) = [833.41104088]
bas 4, expnt(s) = [234.42236029]
bas 5, expnt(s) = [79.73533646]
bas 6, expnt(s) = [13.23831167]
bas 7, expnt(s) = [31.1344105]
bas 8, expnt(s) = [0.31083242]
bas 9, expnt(s) = [2.117026]
bas 10, expnt(s) = [5.85214868]
bas 11, expnt(s) = [7.11347325]
bas 12, expnt(s) = [23.16886531]
bas 13, expnt(s) = [99.78411452]
bas 14, expnt(s) = [0.2660506]
bas 15, expnt(s) = [2.44148897]
bas 16, expnt(s) = [0.83381821]
CPU time:       383.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23221575e-01 2.18349691e+00 2.44137943e+04 4.93448104e+03
 3.66144717e+03 1.18919919e+03 8.33411041e+02 3.91885741e+02
 2.34422360e+02 1.51361109e+02 7.97353365e+01 6.74144736e+01
 1.32383117e+01 1.75343421e+01 3.11344105e+01 3.33000979e+01
 3.10832415e-01 1.05174329e+00 2.11702600e+00 4.43414272e+00
 5.85214868e+00 9.50608160e+00 7.11347325e+00 3.38911668e+01
 2.31688653e+01 1.48291189e+02 9.97841145e+01 9.20049412e+02
 2.66050600e-01 5.57429175e-01 2.44148897e+00 8.90333779e+00
 8.33818205e-01 2.32446820e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639766202321
cond(S) = 1311.3780724790367
E1 = -183.59018734000696  E_coul = 55.08018665402002
init E= -128.510000685987
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401997597791  LUMO = 0.823929079362085
  mo_energy =
[-3.25552794e+01 -1.85273695e+00 -7.75401998e-01 -7.75401998e-01
 -7.75401998e-01  8.23929079e-01  8.23929079e-01  8.23929079e-01
  8.41892993e-01  3.95607956e+00  3.95607956e+00  3.95607956e+00
  4.77868967e+00  1.43573566e+01  1.43573566e+01  1.43573566e+01
  1.82692874e+01  5.30023535e+01  5.30023535e+01  5.30023535e+01
  5.95054292e+01  1.79451809e+02  2.40823165e+02  2.40823165e+02
  2.40823165e+02  5.53963622e+02  1.92092822e+03  8.04518539e+03
  4.78052590e+04]
E1 = -182.0861589427582  E_coul = 53.54762057169788
cycle= 1 E= -128.53853837106  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.518705
diis-c [-0.26905535  1.        ]
  HOMO = -0.884329693752427  LUMO = 0.79715012398145
  mo_energy =
[-3.28784827e+01 -1.96664375e+00 -8.84329694e-01 -8.84329694e-01
 -8.84329694e-01  7.97150124e-01  7.97150124e-01  7.97150124e-01
  8.10818145e-01  3.85860279e+00  3.85860279e+00  3.85860279e+00
  4.68529052e+00  1.41665762e+01  1.41665762e+01  1.41665762e+01
  1.80843416e+01  5.27213810e+01  5.27213810e+01  5.27213810e+01
  5.92400960e+01  1.79131433e+02  2.40476835e+02  2.40476835e+02
  2.40476835e+02  5.53602526e+02  1.92053104e+03  8.04475881e+03
  4.78048135e+04]
E1 = -182.84770115569734  E_coul = 54.30657483464637
cycle= 2 E= -128.541126321051  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263852
diis-c [-0.00075409  0.33626371  0.66373629]
  HOMO = -0.848705900720961  LUMO = 0.805879369049825
  mo_energy =
[-3.27703942e+01 -1.92913243e+00 -8.48705901e-01 -8.48705901e-01
 -8.48705901e-01  8.05879369e-01  8.05879369e-01  8.05879369e-01
  8.20755868e-01  3.89021702e+00  3.89021702e+00  3.89021702e+00
  4.71561280e+00  1.42297603e+01  1.42297603e+01  1.42297603e+01
  1.81456006e+01  5.28153895e+01  5.28153895e+01  5.28153895e+01
  5.93290551e+01  1.79238158e+02  2.40590496e+02  2.40590496e+02
  2.40590496e+02  5.53719171e+02  1.92065302e+03  8.04488330e+03
  4.78049389e+04]
E1 = -182.58906812032873  E_coul = 54.04702150691998
cycle= 3 E= -128.542046613409  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109858
diis-c [-1.84295092e-07 -2.36125740e-03 -8.09346089e-04  1.00317060e+00]
  HOMO = -0.848957796500784  LUMO = 0.805841138036549
  mo_energy =
[-3.27708333e+01 -1.92931982e+00 -8.48957797e-01 -8.48957797e-01
 -8.48957797e-01  8.05841138e-01  8.05841138e-01  8.05841138e-01
  8.20701423e-01  3.89004357e+00  3.89004357e+00  3.89004357e+00
  4.71545618e+00  1.42294651e+01  1.42294651e+01  1.42294651e+01
  1.81453210e+01  5.28150013e+01  5.28150013e+01  5.28150013e+01
  5.93286901e+01  1.79237709e+02  2.40589986e+02  2.40589986e+02
  2.40589986e+02  5.53718606e+02  1.92065232e+03  8.04488250e+03
  4.78049381e+04]
E1 = -182.5894710166782  E_coul = 54.04742437862017
cycle= 4 E= -128.542046638058  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188369
diis-c [-1.10729315e-09  2.28318023e-04  5.31080598e-04 -1.82291143e-01
  1.18153174e+00]
  HOMO = -0.849001032356571  LUMO = 0.805827802323525
  mo_energy =
[-3.27709071e+01 -1.92935264e+00 -8.49001032e-01 -8.49001032e-01
 -8.49001032e-01  8.05827802e-01  8.05827802e-01  8.05827802e-01
  8.20687615e-01  3.89000322e+00  3.89000322e+00  3.89000322e+00
  4.71542111e+00  1.42294054e+01  1.42294054e+01  1.42294054e+01
  1.81452635e+01  5.28149316e+01  5.28149316e+01  5.28149316e+01
  5.93286219e+01  1.79237634e+02  2.40589908e+02  2.40589908e+02
  2.40589908e+02  5.53718524e+02  1.92065223e+03  8.04488240e+03
  4.78049380e+04]
E1 = -182.58960730756226  E_coul = 54.04756066879905
cycle= 5 E= -128.542046638763  delta_E= -7.05e-10  |g|= 5.86e-06  |ddm|= 5.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58960730756226  E_coul = 54.04756066879905
  HOMO = -0.848997980731346  LUMO = 0.805828701725574
  mo_energy =
[-3.27709003e+01 -1.92934878e+00 -8.48997981e-01 -8.48997981e-01
 -8.48997981e-01  8.05828702e-01  8.05828702e-01  8.05828702e-01
  8.20689002e-01  3.89000615e+00  3.89000615e+00  3.89000615e+00
  4.71542427e+00  1.42294104e+01  1.42294104e+01  1.42294104e+01
  1.81452686e+01  5.28149380e+01  5.28149380e+01  5.28149380e+01
  5.93286282e+01  1.79237641e+02  2.40589914e+02  2.40589914e+02
  2.40589914e+02  5.53718530e+02  1.92065223e+03  8.04488241e+03
  4.78049380e+04]
E1 = -182.5895917966834  E_coul = 54.04754515791751
Extra cycle  E= -128.542046638766  delta_E= -2.67e-12  |g|= 2.19e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1311.3780724790367
E1 = -182.5895917966834  E_coul = 54.04754515791751
init E= -128.542046638766
    CPU time for initialize scf      0.35 sec, wall time      0.35 sec
  HOMO = -0.848999078719282  LUMO = 0.805828450633309
  mo_energy =
[-3.27709037e+01 -1.92934979e+00 -8.48999079e-01 -8.48999079e-01
 -8.48999079e-01  8.05828451e-01  8.05828451e-01  8.05828451e-01
  8.20688782e-01  3.89000520e+00  3.89000520e+00  3.89000520e+00
  4.71542342e+00  1.42294085e+01  1.42294085e+01  1.42294085e+01
  1.81452668e+01  5.28149351e+01  5.28149351e+01  5.28149351e+01
  5.93286254e+01  1.79237638e+02  2.40589911e+02  2.40589911e+02
  2.40589911e+02  5.53718526e+02  1.92065223e+03  8.04488240e+03
  4.78049380e+04]
E1 = -182.5896004257657  E_coul = 54.047553786999536
cycle= 1 E= -128.542046638766  delta_E= -2.56e-13  |g|= 1.18e-06  |ddm|= 7.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5896004257657  E_coul = 54.047553786999536
  HOMO = -0.848998471434418  LUMO = 0.805828602845049
  mo_energy =
[-3.27709019e+01 -1.92934912e+00 -8.48998471e-01 -8.48998471e-01
 -8.48998471e-01  8.05828603e-01  8.05828603e-01  8.05828603e-01
  8.20688969e-01  3.89000575e+00  3.89000575e+00  3.89000575e+00
  4.71542396e+00  1.42294095e+01  1.42294095e+01  1.42294095e+01
  1.81452678e+01  5.28149366e+01  5.28149366e+01  5.28149366e+01
  5.93286269e+01  1.79237640e+02  2.40589912e+02  2.40589912e+02
  2.40589912e+02  5.53718528e+02  1.92065223e+03  8.04488241e+03
  4.78049380e+04]
E1 = -182.58959609053753  E_coul = 54.04754945177126
Extra cycle  E= -128.542046638766  delta_E= -1.14e-13  |g|= 5.89e-07  |ddm|= 3.91e-07
    CPU time for scf_cycle      0.43 sec, wall time      0.42 sec
exp = [8.23221575e-01 2.44137943e+04 3.66144717e+03 8.33411041e+02
 2.34422360e+02 7.97353365e+01 1.32383117e+01 3.11344105e+01
 3.10832415e-01 2.11702600e+00 5.85214868e+00 7.11347325e+00
 2.31688653e+01 9.97841145e+01 2.66050600e-01 2.44148897e+00
 8.33818205e-01]
grad_E = [-5.91545901e-06  4.37798194e-09 -2.17050622e-07  3.54688945e-06
 -1.85057970e-05 -4.93183327e-06 -2.84074881e-06  1.18466260e-06
  5.26980200e-06  2.22572079e-06  5.51569096e-07 -1.50164693e-06
 -2.89227974e-07  7.82143049e-08  9.93897871e-06  1.63442241e-06
 -3.57031564e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823538249177       1
[INPUT] 0    0    [1    /1   ]  24413.7942683        1
[INPUT] 0    0    [1    /1   ]  3661.44716616        1
[INPUT] 0    0    [1    /1   ]  833.411191503        1
[INPUT] 0    0    [1    /1   ]  234.420624411        1
[INPUT] 0    0    [1    /1   ]  79.741056883         1
[INPUT] 0    0    [1    /1   ]  13.2487287465        1
[INPUT] 0    0    [1    /1   ]  31.1453725954        1
[INPUT] 0    0    [1    /1   ]  0.310938261247       1
[INPUT] 0    0    [1    /1   ]  2.11785696818        1
[INPUT] 0    0    [1    /1   ]  5.8586379618         1
[INPUT] 1    0    [1    /1   ]  7.11368972421        1
[INPUT] 1    0    [1    /1   ]  23.1687825337        1
[INPUT] 1    0    [1    /1   ]  99.7841139637        1
[INPUT] 1    0    [1    /1   ]  0.266056651585       1
[INPUT] 1    0    [1    /1   ]  2.44154710221        1
[INPUT] 1    0    [1    /1   ]  0.833823970049       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8235382491770052, 1.0]], [0, [24413.794268334277, 1.0]], [0, [3661.447166164075, 1.0]], [0, [833.4111915030304, 1.0]], [0, [234.42062441089544, 1.0]], [0, [79.74105688304508, 1.0]], [0, [13.248728746461131, 1.0]], [0, [31.145372595355425, 1.0]], [0, [0.31093826124675883, 1.0]], [0, [2.1178569681799986, 1.0]], [0, [5.858637961798777, 1.0]], [1, [7.113689724212121, 1.0]], [1, [23.168782533713447, 1.0]], [1, [99.78411396368948, 1.0]], [1, [0.2660566515845195, 1.0]], [1, [2.4415471022059774, 1.0]], [1, [0.8338239700486557, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82353825]
bas 1, expnt(s) = [24413.79426833]
bas 2, expnt(s) = [3661.44716616]
bas 3, expnt(s) = [833.4111915]
bas 4, expnt(s) = [234.42062441]
bas 5, expnt(s) = [79.74105688]
bas 6, expnt(s) = [13.24872875]
bas 7, expnt(s) = [31.1453726]
bas 8, expnt(s) = [0.31093826]
bas 9, expnt(s) = [2.11785697]
bas 10, expnt(s) = [5.85863796]
bas 11, expnt(s) = [7.11368972]
bas 12, expnt(s) = [23.16878253]
bas 13, expnt(s) = [99.78411396]
bas 14, expnt(s) = [0.26605665]
bas 15, expnt(s) = [2.4415471]
bas 16, expnt(s) = [0.83382397]
CPU time:       387.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23538249e-01 2.18412684e+00 2.44137943e+04 4.93448104e+03
 3.66144717e+03 1.18919919e+03 8.33411192e+02 3.91885794e+02
 2.34420624e+02 1.51360268e+02 7.97410569e+01 6.74181009e+01
 1.32487287e+01 1.75446893e+01 3.11453726e+01 3.33088909e+01
 3.10938261e-01 1.05201189e+00 2.11785697e+00 4.43544802e+00
 5.85863796e+00 9.51398627e+00 7.11368972e+00 3.38924560e+01
 2.31687825e+01 1.48290527e+02 9.97841140e+01 9.20049406e+02
 2.66056652e-01 5.57445025e-01 2.44154710e+00 8.90360278e+00
 8.33823970e-01 2.32448829e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639731103153
cond(S) = 1312.9384519894247
E1 = -183.59018690283332  E_coul = 55.080186784794314
init E= -128.510000118039
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401982645059  LUMO = 0.82394793707679
  mo_energy =
[-3.25552795e+01 -1.85273687e+00 -7.75401983e-01 -7.75401983e-01
 -7.75401983e-01  8.23947937e-01  8.23947937e-01  8.23947937e-01
  8.42347540e-01  3.95614680e+00  3.95614680e+00  3.95614680e+00
  4.78150110e+00  1.43577345e+01  1.43577345e+01  1.43577345e+01
  1.82848936e+01  5.30031189e+01  5.30031189e+01  5.30031189e+01
  5.95545141e+01  1.79543964e+02  2.40823734e+02  2.40823734e+02
  2.40823734e+02  5.54083206e+02  1.92104850e+03  8.04529367e+03
  4.78053491e+04]
E1 = -182.08617096770305  E_coul = 53.54763255688079
cycle= 1 E= -128.538538410822  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518696
diis-c [-0.26904581  1.        ]
  HOMO = -0.88432867977082  LUMO = 0.797168808106858
  mo_energy =
[-3.28784808e+01 -1.96664264e+00 -8.84328680e-01 -8.84328680e-01
 -8.84328680e-01  7.97168808e-01  7.97168808e-01  7.97168808e-01
  8.11255979e-01  3.85866968e+00  3.85866968e+00  3.85866968e+00
  4.68805454e+00  1.41669531e+01  1.41669531e+01  1.41669531e+01
  1.80998671e+01  5.27221481e+01  5.27221481e+01  5.27221481e+01
  5.92891370e+01  1.79223580e+02  2.40477405e+02  2.40477405e+02
  2.40477405e+02  5.53722112e+02  1.92065132e+03  8.04486708e+03
  4.78049036e+04]
E1 = -182.8477085400707  E_coul = 54.306582198142515
cycle= 2 E= -128.541126341928  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263847
diis-c [-0.00075427  0.33626302  0.66373698]
  HOMO = -0.848705071666752  LUMO = 0.80589820040572
  mo_energy =
[-3.27703929e+01 -1.92913151e+00 -8.48705072e-01 -8.48705072e-01
 -8.48705072e-01  8.05898200e-01  8.05898200e-01  8.05898200e-01
  8.21199211e-01  3.89028421e+00  3.89028421e+00  3.89028421e+00
  4.71839274e+00  1.42301377e+01  1.42301377e+01  1.42301377e+01
  1.81611540e+01  5.28161561e+01  5.28161561e+01  5.28161561e+01
  5.93781113e+01  1.79330308e+02  2.40591066e+02  2.40591066e+02
  2.40591066e+02  5.53838757e+02  1.92077330e+03  8.04499158e+03
  4.78050290e+04]
E1 = -182.58907821460832  E_coul = 54.04703159483484
cycle= 3 E= -128.542046619773  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109847
diis-c [-1.84196211e-07 -2.36092413e-03 -8.08876365e-04  1.00316980e+00]
  HOMO = -0.84895691098595  LUMO = 0.8058599929081
  mo_energy =
[-3.27708319e+01 -1.92931884e+00 -8.48956911e-01 -8.48956911e-01
 -8.48956911e-01  8.05859993e-01  8.05859993e-01  8.05859993e-01
  8.21144773e-01  3.89011081e+00  3.89011081e+00  3.89011081e+00
  4.71823611e+00  1.42298426e+01  1.42298426e+01  1.42298426e+01
  1.81608743e+01  5.28157680e+01  5.28157680e+01  5.28157680e+01
  5.93777463e+01  1.79329859e+02  2.40590556e+02  2.40590556e+02
  2.40590556e+02  5.53838192e+02  1.92077260e+03  8.04499078e+03
  4.78050282e+04]
E1 = -182.58948113623217  E_coul = 54.04743449182382
cycle= 4 E= -128.542046644408  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188362
diis-c [-1.10717513e-09  2.28303010e-04  5.31132227e-04 -1.82281682e-01
  1.18152225e+00]
  HOMO = -0.849000137277094  LUMO = 0.805846661232503
  mo_energy =
[-3.27709057e+01 -1.92935165e+00 -8.49000137e-01 -8.49000137e-01
 -8.49000137e-01  8.05846661e-01  8.05846661e-01  8.05846661e-01
  8.21130964e-01  3.89007047e+00  3.89007047e+00  3.89007047e+00
  4.71820104e+00  1.42297829e+01  1.42297829e+01  1.42297829e+01
  1.81608169e+01  5.28156982e+01  5.28156982e+01  5.28156982e+01
  5.93776781e+01  1.79329784e+02  2.40590478e+02  2.40590478e+02
  2.40590478e+02  5.53838109e+02  1.92077251e+03  8.04499068e+03
  4.78050281e+04]
E1 = -182.58961744076063  E_coul = 54.04757079564759
cycle= 5 E= -128.542046645113  delta_E= -7.05e-10  |g|= 5.86e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58961744076063  E_coul = 54.04757079564759
  HOMO = -0.848997086185747  LUMO = 0.805847560497575
  mo_energy =
[-3.27708989e+01 -1.92934780e+00 -8.48997086e-01 -8.48997086e-01
 -8.48997086e-01  8.05847560e-01  8.05847560e-01  8.05847560e-01
  8.21132352e-01  3.89007339e+00  3.89007339e+00  3.89007339e+00
  4.71820419e+00  1.42297879e+01  1.42297879e+01  1.42297879e+01
  1.81608220e+01  5.28157047e+01  5.28157047e+01  5.28157047e+01
  5.93776844e+01  1.79329791e+02  2.40590484e+02  2.40590484e+02
  2.40590484e+02  5.53838116e+02  1.92077252e+03  8.04499069e+03
  4.78050281e+04]
E1 = -182.5896019329426  E_coul = 54.047555287826945
Extra cycle  E= -128.542046645116  delta_E= -2.61e-12  |g|= 2.19e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.15 sec
exp = [8.23538249e-01 2.44137943e+04 3.66144717e+03 8.33411192e+02
 2.34420624e+02 7.97410569e+01 1.32487287e+01 3.11453726e+01
 3.10938261e-01 2.11785697e+00 5.85863796e+00 7.11368972e+00
 2.31687825e+01 9.97841140e+01 2.66056652e-01 2.44154710e+00
 8.33823970e-01]
E = -128.54204664511565
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823538249177       1
[INPUT] 0    0    [1    /1   ]  24413.7942683        1
[INPUT] 0    0    [1    /1   ]  3661.44716616        1
[INPUT] 0    0    [1    /1   ]  833.411191503        1
[INPUT] 0    0    [1    /1   ]  234.420624411        1
[INPUT] 0    0    [1    /1   ]  79.741056883         1
[INPUT] 0    0    [1    /1   ]  13.2487287465        1
[INPUT] 0    0    [1    /1   ]  31.1453725954        1
[INPUT] 0    0    [1    /1   ]  0.310938261247       1
[INPUT] 0    0    [1    /1   ]  2.11785696818        1
[INPUT] 0    0    [1    /1   ]  5.8586379618         1
[INPUT] 1    0    [1    /1   ]  7.11368972421        1
[INPUT] 1    0    [1    /1   ]  23.1687825337        1
[INPUT] 1    0    [1    /1   ]  99.7841139637        1
[INPUT] 1    0    [1    /1   ]  0.266056651585       1
[INPUT] 1    0    [1    /1   ]  2.44154710221        1
[INPUT] 1    0    [1    /1   ]  0.833823970049       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8235382491770052, 1.0]], [0, [24413.794268334277, 1.0]], [0, [3661.447166164075, 1.0]], [0, [833.4111915030304, 1.0]], [0, [234.42062441089544, 1.0]], [0, [79.74105688304508, 1.0]], [0, [13.248728746461131, 1.0]], [0, [31.145372595355425, 1.0]], [0, [0.31093826124675883, 1.0]], [0, [2.1178569681799986, 1.0]], [0, [5.858637961798777, 1.0]], [1, [7.113689724212121, 1.0]], [1, [23.168782533713447, 1.0]], [1, [99.78411396368948, 1.0]], [1, [0.2660566515845195, 1.0]], [1, [2.4415471022059774, 1.0]], [1, [0.8338239700486557, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82353825]
bas 1, expnt(s) = [24413.79426833]
bas 2, expnt(s) = [3661.44716616]
bas 3, expnt(s) = [833.4111915]
bas 4, expnt(s) = [234.42062441]
bas 5, expnt(s) = [79.74105688]
bas 6, expnt(s) = [13.24872875]
bas 7, expnt(s) = [31.1453726]
bas 8, expnt(s) = [0.31093826]
bas 9, expnt(s) = [2.11785697]
bas 10, expnt(s) = [5.85863796]
bas 11, expnt(s) = [7.11368972]
bas 12, expnt(s) = [23.16878253]
bas 13, expnt(s) = [99.78411396]
bas 14, expnt(s) = [0.26605665]
bas 15, expnt(s) = [2.4415471]
bas 16, expnt(s) = [0.83382397]
CPU time:       388.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23538249e-01 2.18412684e+00 2.44137943e+04 4.93448104e+03
 3.66144717e+03 1.18919919e+03 8.33411192e+02 3.91885794e+02
 2.34420624e+02 1.51360268e+02 7.97410569e+01 6.74181009e+01
 1.32487287e+01 1.75446893e+01 3.11453726e+01 3.33088909e+01
 3.10938261e-01 1.05201189e+00 2.11785697e+00 4.43544802e+00
 5.85863796e+00 9.51398627e+00 7.11368972e+00 3.38924560e+01
 2.31687825e+01 1.48290527e+02 9.97841140e+01 9.20049406e+02
 2.66056652e-01 5.57445025e-01 2.44154710e+00 8.90360278e+00
 8.33823970e-01 2.32448829e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639731103153
cond(S) = 1312.9384519894247
E1 = -183.59018690283332  E_coul = 55.080186784794314
init E= -128.510000118039
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401982645059  LUMO = 0.82394793707679
  mo_energy =
[-3.25552795e+01 -1.85273687e+00 -7.75401983e-01 -7.75401983e-01
 -7.75401983e-01  8.23947937e-01  8.23947937e-01  8.23947937e-01
  8.42347540e-01  3.95614680e+00  3.95614680e+00  3.95614680e+00
  4.78150110e+00  1.43577345e+01  1.43577345e+01  1.43577345e+01
  1.82848936e+01  5.30031189e+01  5.30031189e+01  5.30031189e+01
  5.95545141e+01  1.79543964e+02  2.40823734e+02  2.40823734e+02
  2.40823734e+02  5.54083206e+02  1.92104850e+03  8.04529367e+03
  4.78053491e+04]
E1 = -182.08617096770305  E_coul = 53.54763255688079
cycle= 1 E= -128.538538410822  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518696
diis-c [-0.26904581  1.        ]
  HOMO = -0.88432867977082  LUMO = 0.797168808106858
  mo_energy =
[-3.28784808e+01 -1.96664264e+00 -8.84328680e-01 -8.84328680e-01
 -8.84328680e-01  7.97168808e-01  7.97168808e-01  7.97168808e-01
  8.11255979e-01  3.85866968e+00  3.85866968e+00  3.85866968e+00
  4.68805454e+00  1.41669531e+01  1.41669531e+01  1.41669531e+01
  1.80998671e+01  5.27221481e+01  5.27221481e+01  5.27221481e+01
  5.92891370e+01  1.79223580e+02  2.40477405e+02  2.40477405e+02
  2.40477405e+02  5.53722112e+02  1.92065132e+03  8.04486708e+03
  4.78049036e+04]
E1 = -182.8477085400707  E_coul = 54.306582198142515
cycle= 2 E= -128.541126341928  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263847
diis-c [-0.00075427  0.33626302  0.66373698]
  HOMO = -0.848705071666752  LUMO = 0.80589820040572
  mo_energy =
[-3.27703929e+01 -1.92913151e+00 -8.48705072e-01 -8.48705072e-01
 -8.48705072e-01  8.05898200e-01  8.05898200e-01  8.05898200e-01
  8.21199211e-01  3.89028421e+00  3.89028421e+00  3.89028421e+00
  4.71839274e+00  1.42301377e+01  1.42301377e+01  1.42301377e+01
  1.81611540e+01  5.28161561e+01  5.28161561e+01  5.28161561e+01
  5.93781113e+01  1.79330308e+02  2.40591066e+02  2.40591066e+02
  2.40591066e+02  5.53838757e+02  1.92077330e+03  8.04499158e+03
  4.78050290e+04]
E1 = -182.58907821460832  E_coul = 54.04703159483484
cycle= 3 E= -128.542046619773  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109847
diis-c [-1.84196211e-07 -2.36092413e-03 -8.08876365e-04  1.00316980e+00]
  HOMO = -0.84895691098595  LUMO = 0.8058599929081
  mo_energy =
[-3.27708319e+01 -1.92931884e+00 -8.48956911e-01 -8.48956911e-01
 -8.48956911e-01  8.05859993e-01  8.05859993e-01  8.05859993e-01
  8.21144773e-01  3.89011081e+00  3.89011081e+00  3.89011081e+00
  4.71823611e+00  1.42298426e+01  1.42298426e+01  1.42298426e+01
  1.81608743e+01  5.28157680e+01  5.28157680e+01  5.28157680e+01
  5.93777463e+01  1.79329859e+02  2.40590556e+02  2.40590556e+02
  2.40590556e+02  5.53838192e+02  1.92077260e+03  8.04499078e+03
  4.78050282e+04]
E1 = -182.58948113623217  E_coul = 54.04743449182382
cycle= 4 E= -128.542046644408  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188362
diis-c [-1.10717513e-09  2.28303010e-04  5.31132227e-04 -1.82281682e-01
  1.18152225e+00]
  HOMO = -0.849000137277094  LUMO = 0.805846661232503
  mo_energy =
[-3.27709057e+01 -1.92935165e+00 -8.49000137e-01 -8.49000137e-01
 -8.49000137e-01  8.05846661e-01  8.05846661e-01  8.05846661e-01
  8.21130964e-01  3.89007047e+00  3.89007047e+00  3.89007047e+00
  4.71820104e+00  1.42297829e+01  1.42297829e+01  1.42297829e+01
  1.81608169e+01  5.28156982e+01  5.28156982e+01  5.28156982e+01
  5.93776781e+01  1.79329784e+02  2.40590478e+02  2.40590478e+02
  2.40590478e+02  5.53838109e+02  1.92077251e+03  8.04499068e+03
  4.78050281e+04]
E1 = -182.58961744076063  E_coul = 54.04757079564759
cycle= 5 E= -128.542046645113  delta_E= -7.05e-10  |g|= 5.86e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58961744076063  E_coul = 54.04757079564759
  HOMO = -0.848997086185747  LUMO = 0.805847560497575
  mo_energy =
[-3.27708989e+01 -1.92934780e+00 -8.48997086e-01 -8.48997086e-01
 -8.48997086e-01  8.05847560e-01  8.05847560e-01  8.05847560e-01
  8.21132352e-01  3.89007339e+00  3.89007339e+00  3.89007339e+00
  4.71820419e+00  1.42297879e+01  1.42297879e+01  1.42297879e+01
  1.81608220e+01  5.28157047e+01  5.28157047e+01  5.28157047e+01
  5.93776844e+01  1.79329791e+02  2.40590484e+02  2.40590484e+02
  2.40590484e+02  5.53838116e+02  1.92077252e+03  8.04499069e+03
  4.78050281e+04]
E1 = -182.5896019329426  E_coul = 54.047555287826945
Extra cycle  E= -128.542046645116  delta_E= -2.61e-12  |g|= 2.19e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1312.9384519894247
E1 = -182.5896019329426  E_coul = 54.047555287826945
init E= -128.542046645116
    CPU time for initialize scf      0.36 sec, wall time      0.35 sec
  HOMO = -0.848998183960685  LUMO = 0.805847309449347
  mo_energy =
[-3.27709023e+01 -1.92934881e+00 -8.48998184e-01 -8.48998184e-01
 -8.48998184e-01  8.05847309e-01  8.05847309e-01  8.05847309e-01
  8.21132132e-01  3.89007245e+00  3.89007245e+00  3.89007245e+00
  4.71820335e+00  1.42297859e+01  1.42297859e+01  1.42297859e+01
  1.81608202e+01  5.28157017e+01  5.28157017e+01  5.28157017e+01
  5.93776816e+01  1.79329787e+02  2.40590481e+02  2.40590481e+02
  2.40590481e+02  5.53838112e+02  1.92077251e+03  8.04499068e+03
  4.78050281e+04]
E1 = -182.58961056032717  E_coul = 54.047563915211164
cycle= 1 E= -128.542046645116  delta_E= -3.69e-13  |g|= 1.18e-06  |ddm|= 7.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58961056032717  E_coul = 54.047563915211164
  HOMO = -0.848997576796767  LUMO = 0.805847461633919
  mo_energy =
[-3.27709005e+01 -1.92934814e+00 -8.48997577e-01 -8.48997577e-01
 -8.48997577e-01  8.05847462e-01  8.05847462e-01  8.05847462e-01
  8.21132319e-01  3.89007299e+00  3.89007299e+00  3.89007299e+00
  4.71820389e+00  1.42297870e+01  1.42297870e+01  1.42297870e+01
  1.81608212e+01  5.28157033e+01  5.28157033e+01  5.28157033e+01
  5.93776831e+01  1.79329789e+02  2.40590483e+02  2.40590483e+02
  2.40590483e+02  5.53838114e+02  1.92077251e+03  8.04499068e+03
  4.78050281e+04]
E1 = -182.58960622597445  E_coul = 54.04755958085832
Extra cycle  E= -128.542046645116  delta_E= -1.14e-13  |g|= 5.89e-07  |ddm|= 3.91e-07
    CPU time for scf_cycle      0.42 sec, wall time      0.42 sec
exp = [8.23538249e-01 2.44137943e+04 3.66144717e+03 8.33411192e+02
 2.34420624e+02 7.97410569e+01 1.32487287e+01 3.11453726e+01
 3.10938261e-01 2.11785697e+00 5.85863796e+00 7.11368972e+00
 2.31687825e+01 9.97841140e+01 2.66056652e-01 2.44154710e+00
 8.33823970e-01]
grad_E = [-7.30248116e-06  4.38239453e-09 -2.17265105e-07  3.55028680e-06
 -1.85199752e-05 -4.91255357e-06 -1.99485884e-06  8.99185220e-07
  1.06611503e-05  2.21116859e-06  1.40462963e-07 -1.52286245e-07
 -6.38667789e-07  9.52209100e-08  3.32340548e-05  2.58217215e-06
 -1.56904795e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823918235694       1
[INPUT] 0    0    [1    /1   ]  24413.7942685        1
[INPUT] 0    0    [1    /1   ]  3661.44715752        1
[INPUT] 0    0    [1    /1   ]  833.411377208        1
[INPUT] 0    0    [1    /1   ]  234.418488388        1
[INPUT] 0    0    [1    /1   ]  79.7481021281        1
[INPUT] 0    0    [1    /1   ]  13.263105489         1
[INPUT] 0    0    [1    /1   ]  31.158008364         1
[INPUT] 0    0    [1    /1   ]  0.311042763267       1
[INPUT] 0    0    [1    /1   ]  2.1188146237         1
[INPUT] 0    0    [1    /1   ]  5.86923396855        1
[INPUT] 1    0    [1    /1   ]  7.11381683931        1
[INPUT] 1    0    [1    /1   ]  23.1687372362        1
[INPUT] 1    0    [1    /1   ]  99.7841091276        1
[INPUT] 1    0    [1    /1   ]  0.266057282074       1
[INPUT] 1    0    [1    /1   ]  2.441596013          1
[INPUT] 1    0    [1    /1   ]  0.833835523339       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8239182356943288, 1.0]], [0, [24413.794268492613, 1.0]], [0, [3661.4471575217585, 1.0]], [0, [833.4113772078097, 1.0]], [0, [234.41848838759537, 1.0]], [0, [79.74810212814857, 1.0]], [0, [13.263105488993627, 1.0]], [0, [31.15800836404046, 1.0]], [0, [0.3110427632667215, 1.0]], [0, [2.1188146236982073, 1.0]], [0, [5.869233968546883, 1.0]], [1, [7.113816839309945, 1.0]], [1, [23.168737236150477, 1.0]], [1, [99.78410912763508, 1.0]], [1, [0.26605728207400464, 1.0]], [1, [2.4415960129964716, 1.0]], [1, [0.833835523339032, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82391824]
bas 1, expnt(s) = [24413.79426849]
bas 2, expnt(s) = [3661.44715752]
bas 3, expnt(s) = [833.41137721]
bas 4, expnt(s) = [234.41848839]
bas 5, expnt(s) = [79.74810213]
bas 6, expnt(s) = [13.26310549]
bas 7, expnt(s) = [31.15800836]
bas 8, expnt(s) = [0.31104276]
bas 9, expnt(s) = [2.11881462]
bas 10, expnt(s) = [5.86923397]
bas 11, expnt(s) = [7.11381684]
bas 12, expnt(s) = [23.16873724]
bas 13, expnt(s) = [99.78410913]
bas 14, expnt(s) = [0.26605728]
bas 15, expnt(s) = [2.44159601]
bas 16, expnt(s) = [0.83383552]
CPU time:       392.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23918236e-01 2.18488262e+00 2.44137943e+04 4.93448104e+03
 3.66144716e+03 1.18919918e+03 8.33411377e+02 3.91885859e+02
 2.34418488e+02 1.51359234e+02 7.97481021e+01 6.74225682e+01
 1.32631055e+01 1.75589662e+01 3.11580084e+01 3.33190255e+01
 3.11042763e-01 1.05227705e+00 2.11881462e+00 4.43695215e+00
 5.86923397e+00 9.52688869e+00 7.11381684e+00 3.38932130e+01
 2.31687372e+01 1.48290165e+02 9.97841091e+01 9.20049350e+02
 2.66057282e-01 5.57446676e-01 2.44159601e+00 8.90382573e+00
 8.33835523e-01 2.32452855e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9996396990708
cond(S) = 1315.4335400970215
E1 = -183.5901850032574  E_coul = 55.080186851967404
init E= -128.50999815129
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401970210194  LUMO = 0.823953589987176
  mo_energy =
[-3.25552796e+01 -1.85273676e+00 -7.75401970e-01 -7.75401970e-01
 -7.75401970e-01  8.23953590e-01  8.23953590e-01  8.23953590e-01
  8.42856700e-01  3.95620447e+00  3.95620447e+00  3.95620447e+00
  4.78500185e+00  1.43580148e+01  1.43580148e+01  1.43580148e+01
  1.83074141e+01  5.30036403e+01  5.30036403e+01  5.30036403e+01
  5.96249898e+01  1.79670454e+02  2.40824121e+02  2.40824121e+02
  2.40824121e+02  5.54242918e+02  1.92120786e+03  8.04543692e+03
  4.78054683e+04]
E1 = -182.08617037771435  E_coul = 53.547631960804004
cycle= 1 E= -128.53853841691  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518682
diis-c [-0.26903127  1.        ]
  HOMO = -0.884328726033762  LUMO = 0.797174069322239
  mo_energy =
[-3.28784810e+01 -1.96664263e+00 -8.84328726e-01 -8.84328726e-01
 -8.84328726e-01  7.97174069e-01  7.97174069e-01  7.97174069e-01
  8.11744889e-01  3.85872586e+00  3.85872586e+00  3.85872586e+00
  4.69148878e+00  1.41672317e+01  1.41672317e+01  1.41672317e+01
  1.81222639e+01  5.27226693e+01  5.27226693e+01  5.27226693e+01
  5.93595488e+01  1.79350058e+02  2.40477793e+02  2.40477793e+02
  2.40477793e+02  5.53881825e+02  1.92081068e+03  8.04501033e+03
  4.78050228e+04]
E1 = -182.84770768993886  E_coul = 54.30658134178722
cycle= 2 E= -128.541126348152  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26384
diis-c [-0.00075456  0.33626288  0.66373712]
  HOMO = -0.848705127061957  LUMO = 0.805903571695319
  mo_energy =
[-3.27703931e+01 -1.92913151e+00 -8.48705127e-01 -8.48705127e-01
 -8.48705127e-01  8.05903572e-01  8.05903572e-01  8.05903572e-01
  8.21694574e-01  3.89034085e+00  3.89034085e+00  3.89034085e+00
  4.72184907e+00  1.42304168e+01  1.42304168e+01  1.42304168e+01
  1.81835933e+01  5.28166773e+01  5.28166773e+01  5.28166773e+01
  5.94485448e+01  1.79456789e+02  2.40591453e+02  2.40591453e+02
  2.40591453e+02  5.53998469e+02  1.92093266e+03  8.04513483e+03
  4.78051482e+04]
E1 = -182.58907733164537  E_coul = 54.04703070580247
cycle= 3 E= -128.542046625843  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010985
diis-c [-1.84097203e-07 -2.36084631e-03 -8.08307767e-04  1.00316915e+00]
  HOMO = -0.84895697589104  LUMO = 0.80586536186826
  mo_energy =
[-3.27708321e+01 -1.92931886e+00 -8.48956976e-01 -8.48956976e-01
 -8.48956976e-01  8.05865362e-01  8.05865362e-01  8.05865362e-01
  8.21640098e-01  3.89016744e+00  3.89016744e+00  3.89016744e+00
  4.72169233e+00  1.42301217e+01  1.42301217e+01  1.42301217e+01
  1.81833135e+01  5.28162892e+01  5.28162892e+01  5.28162892e+01
  5.94481797e+01  1.79456340e+02  2.40590943e+02  2.40590943e+02
  2.40590943e+02  5.53997904e+02  1.92093196e+03  8.04513403e+03
  4.78051474e+04]
E1 = -182.5894802968936  E_coul = 54.04743364641929
cycle= 4 E= -128.542046650474  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188376
diis-c [-1.10685296e-09  2.28231578e-04  5.31188611e-04 -1.82242511e-01
  1.18148309e+00]
  HOMO = -0.849000202763827  LUMO = 0.805852030495166
  mo_energy =
[-3.27709059e+01 -1.92935167e+00 -8.49000203e-01 -8.49000203e-01
 -8.49000203e-01  8.05852030e-01  8.05852030e-01  8.05852030e-01
  8.21626282e-01  3.89012710e+00  3.89012710e+00  3.89012710e+00
  4.72165723e+00  1.42300620e+01  1.42300620e+01  1.42300620e+01
  1.81832560e+01  5.28162195e+01  5.28162195e+01  5.28162195e+01
  5.94481115e+01  1.79456266e+02  2.40590865e+02  2.40590865e+02
  2.40590865e+02  5.53997822e+02  1.92093187e+03  8.04513393e+03
  4.78051473e+04]
E1 = -182.5896166259416  E_coul = 54.04756997476244
cycle= 5 E= -128.542046651179  delta_E= -7.05e-10  |g|= 5.85e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5896166259416  E_coul = 54.04756997476244
  HOMO = -0.848997153086684  LUMO = 0.805852929383874
  mo_energy =
[-3.27708991e+01 -1.92934782e+00 -8.48997153e-01 -8.48997153e-01
 -8.48997153e-01  8.05852929e-01  8.05852929e-01  8.05852929e-01
  8.21627670e-01  3.89013002e+00  3.89013002e+00  3.89013002e+00
  4.72166039e+00  1.42300670e+01  1.42300670e+01  1.42300670e+01
  1.81832611e+01  5.28162260e+01  5.28162260e+01  5.28162260e+01
  5.94481178e+01  1.79456272e+02  2.40590872e+02  2.40590872e+02
  2.40590872e+02  5.53997828e+02  1.92093188e+03  8.04513394e+03
  4.78051473e+04]
E1 = -182.58960112596404  E_coul = 54.047554474782544
Extra cycle  E= -128.542046651181  delta_E= -2.33e-12  |g|= 2.19e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.23918236e-01 2.44137943e+04 3.66144716e+03 8.33411377e+02
 2.34418488e+02 7.97481021e+01 1.32631055e+01 3.11580084e+01
 3.11042763e-01 2.11881462e+00 5.86923397e+00 7.11381684e+00
 2.31687372e+01 9.97841091e+01 2.66057282e-01 2.44159601e+00
 8.33835523e-01]
E = -128.5420466511815
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823918235694       1
[INPUT] 0    0    [1    /1   ]  24413.7942685        1
[INPUT] 0    0    [1    /1   ]  3661.44715752        1
[INPUT] 0    0    [1    /1   ]  833.411377208        1
[INPUT] 0    0    [1    /1   ]  234.418488388        1
[INPUT] 0    0    [1    /1   ]  79.7481021281        1
[INPUT] 0    0    [1    /1   ]  13.263105489         1
[INPUT] 0    0    [1    /1   ]  31.158008364         1
[INPUT] 0    0    [1    /1   ]  0.311042763267       1
[INPUT] 0    0    [1    /1   ]  2.1188146237         1
[INPUT] 0    0    [1    /1   ]  5.86923396855        1
[INPUT] 1    0    [1    /1   ]  7.11381683931        1
[INPUT] 1    0    [1    /1   ]  23.1687372362        1
[INPUT] 1    0    [1    /1   ]  99.7841091276        1
[INPUT] 1    0    [1    /1   ]  0.266057282074       1
[INPUT] 1    0    [1    /1   ]  2.441596013          1
[INPUT] 1    0    [1    /1   ]  0.833835523339       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8239182356943288, 1.0]], [0, [24413.794268492613, 1.0]], [0, [3661.4471575217585, 1.0]], [0, [833.4113772078097, 1.0]], [0, [234.41848838759537, 1.0]], [0, [79.74810212814857, 1.0]], [0, [13.263105488993627, 1.0]], [0, [31.15800836404046, 1.0]], [0, [0.3110427632667215, 1.0]], [0, [2.1188146236982073, 1.0]], [0, [5.869233968546883, 1.0]], [1, [7.113816839309945, 1.0]], [1, [23.168737236150477, 1.0]], [1, [99.78410912763508, 1.0]], [1, [0.26605728207400464, 1.0]], [1, [2.4415960129964716, 1.0]], [1, [0.833835523339032, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82391824]
bas 1, expnt(s) = [24413.79426849]
bas 2, expnt(s) = [3661.44715752]
bas 3, expnt(s) = [833.41137721]
bas 4, expnt(s) = [234.41848839]
bas 5, expnt(s) = [79.74810213]
bas 6, expnt(s) = [13.26310549]
bas 7, expnt(s) = [31.15800836]
bas 8, expnt(s) = [0.31104276]
bas 9, expnt(s) = [2.11881462]
bas 10, expnt(s) = [5.86923397]
bas 11, expnt(s) = [7.11381684]
bas 12, expnt(s) = [23.16873724]
bas 13, expnt(s) = [99.78410913]
bas 14, expnt(s) = [0.26605728]
bas 15, expnt(s) = [2.44159601]
bas 16, expnt(s) = [0.83383552]
CPU time:       394.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23918236e-01 2.18488262e+00 2.44137943e+04 4.93448104e+03
 3.66144716e+03 1.18919918e+03 8.33411377e+02 3.91885859e+02
 2.34418488e+02 1.51359234e+02 7.97481021e+01 6.74225682e+01
 1.32631055e+01 1.75589662e+01 3.11580084e+01 3.33190255e+01
 3.11042763e-01 1.05227705e+00 2.11881462e+00 4.43695215e+00
 5.86923397e+00 9.52688869e+00 7.11381684e+00 3.38932130e+01
 2.31687372e+01 1.48290165e+02 9.97841091e+01 9.20049350e+02
 2.66057282e-01 5.57446676e-01 2.44159601e+00 8.90382573e+00
 8.33835523e-01 2.32452855e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9996396990708
cond(S) = 1315.4335400970215
E1 = -183.5901850032574  E_coul = 55.080186851967404
init E= -128.50999815129
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401970210194  LUMO = 0.823953589987176
  mo_energy =
[-3.25552796e+01 -1.85273676e+00 -7.75401970e-01 -7.75401970e-01
 -7.75401970e-01  8.23953590e-01  8.23953590e-01  8.23953590e-01
  8.42856700e-01  3.95620447e+00  3.95620447e+00  3.95620447e+00
  4.78500185e+00  1.43580148e+01  1.43580148e+01  1.43580148e+01
  1.83074141e+01  5.30036403e+01  5.30036403e+01  5.30036403e+01
  5.96249898e+01  1.79670454e+02  2.40824121e+02  2.40824121e+02
  2.40824121e+02  5.54242918e+02  1.92120786e+03  8.04543692e+03
  4.78054683e+04]
E1 = -182.08617037771435  E_coul = 53.547631960804004
cycle= 1 E= -128.53853841691  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518682
diis-c [-0.26903127  1.        ]
  HOMO = -0.884328726033762  LUMO = 0.797174069322239
  mo_energy =
[-3.28784810e+01 -1.96664263e+00 -8.84328726e-01 -8.84328726e-01
 -8.84328726e-01  7.97174069e-01  7.97174069e-01  7.97174069e-01
  8.11744889e-01  3.85872586e+00  3.85872586e+00  3.85872586e+00
  4.69148878e+00  1.41672317e+01  1.41672317e+01  1.41672317e+01
  1.81222639e+01  5.27226693e+01  5.27226693e+01  5.27226693e+01
  5.93595488e+01  1.79350058e+02  2.40477793e+02  2.40477793e+02
  2.40477793e+02  5.53881825e+02  1.92081068e+03  8.04501033e+03
  4.78050228e+04]
E1 = -182.84770768993886  E_coul = 54.30658134178722
cycle= 2 E= -128.541126348152  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26384
diis-c [-0.00075456  0.33626288  0.66373712]
  HOMO = -0.848705127061957  LUMO = 0.805903571695319
  mo_energy =
[-3.27703931e+01 -1.92913151e+00 -8.48705127e-01 -8.48705127e-01
 -8.48705127e-01  8.05903572e-01  8.05903572e-01  8.05903572e-01
  8.21694574e-01  3.89034085e+00  3.89034085e+00  3.89034085e+00
  4.72184907e+00  1.42304168e+01  1.42304168e+01  1.42304168e+01
  1.81835933e+01  5.28166773e+01  5.28166773e+01  5.28166773e+01
  5.94485448e+01  1.79456789e+02  2.40591453e+02  2.40591453e+02
  2.40591453e+02  5.53998469e+02  1.92093266e+03  8.04513483e+03
  4.78051482e+04]
E1 = -182.58907733164537  E_coul = 54.04703070580247
cycle= 3 E= -128.542046625843  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010985
diis-c [-1.84097203e-07 -2.36084631e-03 -8.08307767e-04  1.00316915e+00]
  HOMO = -0.84895697589104  LUMO = 0.80586536186826
  mo_energy =
[-3.27708321e+01 -1.92931886e+00 -8.48956976e-01 -8.48956976e-01
 -8.48956976e-01  8.05865362e-01  8.05865362e-01  8.05865362e-01
  8.21640098e-01  3.89016744e+00  3.89016744e+00  3.89016744e+00
  4.72169233e+00  1.42301217e+01  1.42301217e+01  1.42301217e+01
  1.81833135e+01  5.28162892e+01  5.28162892e+01  5.28162892e+01
  5.94481797e+01  1.79456340e+02  2.40590943e+02  2.40590943e+02
  2.40590943e+02  5.53997904e+02  1.92093196e+03  8.04513403e+03
  4.78051474e+04]
E1 = -182.5894802968936  E_coul = 54.04743364641929
cycle= 4 E= -128.542046650474  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188376
diis-c [-1.10685296e-09  2.28231578e-04  5.31188611e-04 -1.82242511e-01
  1.18148309e+00]
  HOMO = -0.849000202763827  LUMO = 0.805852030495166
  mo_energy =
[-3.27709059e+01 -1.92935167e+00 -8.49000203e-01 -8.49000203e-01
 -8.49000203e-01  8.05852030e-01  8.05852030e-01  8.05852030e-01
  8.21626282e-01  3.89012710e+00  3.89012710e+00  3.89012710e+00
  4.72165723e+00  1.42300620e+01  1.42300620e+01  1.42300620e+01
  1.81832560e+01  5.28162195e+01  5.28162195e+01  5.28162195e+01
  5.94481115e+01  1.79456266e+02  2.40590865e+02  2.40590865e+02
  2.40590865e+02  5.53997822e+02  1.92093187e+03  8.04513393e+03
  4.78051473e+04]
E1 = -182.5896166259416  E_coul = 54.04756997476244
cycle= 5 E= -128.542046651179  delta_E= -7.05e-10  |g|= 5.85e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5896166259416  E_coul = 54.04756997476244
  HOMO = -0.848997153086684  LUMO = 0.805852929383874
  mo_energy =
[-3.27708991e+01 -1.92934782e+00 -8.48997153e-01 -8.48997153e-01
 -8.48997153e-01  8.05852929e-01  8.05852929e-01  8.05852929e-01
  8.21627670e-01  3.89013002e+00  3.89013002e+00  3.89013002e+00
  4.72166039e+00  1.42300670e+01  1.42300670e+01  1.42300670e+01
  1.81832611e+01  5.28162260e+01  5.28162260e+01  5.28162260e+01
  5.94481178e+01  1.79456272e+02  2.40590872e+02  2.40590872e+02
  2.40590872e+02  5.53997828e+02  1.92093188e+03  8.04513394e+03
  4.78051473e+04]
E1 = -182.58960112596404  E_coul = 54.047554474782544
Extra cycle  E= -128.542046651181  delta_E= -2.33e-12  |g|= 2.19e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1315.4335400970215
E1 = -182.58960112596404  E_coul = 54.047554474782544
init E= -128.542046651181
    CPU time for initialize scf      0.33 sec, wall time      0.33 sec
  HOMO = -0.848998250320082  LUMO = 0.805852678460489
  mo_energy =
[-3.27709025e+01 -1.92934883e+00 -8.48998250e-01 -8.48998250e-01
 -8.48998250e-01  8.05852678e-01  8.05852678e-01  8.05852678e-01
  8.21627450e-01  3.89012907e+00  3.89012907e+00  3.89012907e+00
  4.72165955e+00  1.42300650e+01  1.42300650e+01  1.42300650e+01
  1.81832593e+01  5.28162230e+01  5.28162230e+01  5.28162230e+01
  5.94481150e+01  1.79456269e+02  2.40590868e+02  2.40590868e+02
  2.40590868e+02  5.53997824e+02  1.92093187e+03  8.04513393e+03
  4.78051473e+04]
E1 = -182.5896097491497  E_coul = 54.047563097967824
cycle= 1 E= -128.542046651182  delta_E= -3.69e-13  |g|= 1.18e-06  |ddm|= 7.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5896097491497  E_coul = 54.047563097967824
  HOMO = -0.848997643454784  LUMO = 0.805852830573022
  mo_energy =
[-3.27709007e+01 -1.92934816e+00 -8.48997643e-01 -8.48997643e-01
 -8.48997643e-01  8.05852831e-01  8.05852831e-01  8.05852831e-01
  8.21627637e-01  3.89012962e+00  3.89012962e+00  3.89012962e+00
  4.72166008e+00  1.42300661e+01  1.42300661e+01  1.42300661e+01
  1.81832603e+01  5.28162246e+01  5.28162246e+01  5.28162246e+01
  5.94481165e+01  1.79456271e+02  2.40590870e+02  2.40590870e+02
  2.40590870e+02  5.53997826e+02  1.92093187e+03  8.04513393e+03
  4.78051473e+04]
E1 = -182.58960541693193  E_coul = 54.04755876575029
Extra cycle  E= -128.542046651182  delta_E= 2.27e-13  |g|= 5.88e-07  |ddm|= 3.91e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.39 sec
exp = [8.23918236e-01 2.44137943e+04 3.66144716e+03 8.33411377e+02
 2.34418488e+02 7.97481021e+01 1.32631055e+01 3.11580084e+01
 3.11042763e-01 2.11881462e+00 5.86923397e+00 7.11381684e+00
 2.31687372e+01 9.97841091e+01 2.66057282e-01 2.44159601e+00
 8.33835523e-01]
grad_E = [-3.84694996e-06  4.39264872e-09 -2.17775956e-07  3.55941475e-06
 -1.85872168e-05 -4.64840084e-06 -4.72009427e-07 -1.58947511e-09
  7.98310500e-06  9.21983898e-07 -3.30117000e-07  6.25439099e-07
 -8.29200254e-07  1.04518475e-07  2.69476053e-05  1.67150065e-06
 -1.34243667e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823946704861       1
[INPUT] 0    0    [1    /1   ]  24413.7942685        1
[INPUT] 0    0    [1    /1   ]  3661.44715816        1
[INPUT] 0    0    [1    /1   ]  833.411365212        1
[INPUT] 0    0    [1    /1   ]  234.418600108        1
[INPUT] 0    0    [1    /1   ]  79.7475266823        1
[INPUT] 0    0    [1    /1   ]  13.2659525605        1
[INPUT] 0    0    [1    /1   ]  31.1584424462        1
[INPUT] 0    0    [1    /1   ]  0.31103795843        1
[INPUT] 0    0    [1    /1   ]  2.11886924236        1
[INPUT] 0    0    [1    /1   ]  5.87230758732        1
[INPUT] 1    0    [1    /1   ]  7.11376179732        1
[INPUT] 1    0    [1    /1   ]  23.1687642979        1
[INPUT] 1    0    [1    /1   ]  99.7841063342        1
[INPUT] 1    0    [1    /1   ]  0.266052667333       1
[INPUT] 1    0    [1    /1   ]  2.44158513634        1
[INPUT] 1    0    [1    /1   ]  0.833836171617       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8239467048606668, 1.0]], [0, [24413.79426847997, 1.0]], [0, [3661.447158161253, 1.0]], [0, [833.4113652124495, 1.0]], [0, [234.4186001083108, 1.0]], [0, [79.74752668231575, 1.0]], [0, [13.265952560462463, 1.0]], [0, [31.158442446185475, 1.0]], [0, [0.3110379584296739, 1.0]], [0, [2.1188692423596853, 1.0]], [0, [5.872307587315722, 1.0]], [1, [7.113761797316906, 1.0]], [1, [23.168764297920262, 1.0]], [1, [99.78410633415652, 1.0]], [1, [0.2660526673330466, 1.0]], [1, [2.4415851363353154, 1.0]], [1, [0.8338361716173055, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8239467]
bas 1, expnt(s) = [24413.79426848]
bas 2, expnt(s) = [3661.44715816]
bas 3, expnt(s) = [833.41136521]
bas 4, expnt(s) = [234.41860011]
bas 5, expnt(s) = [79.74752668]
bas 6, expnt(s) = [13.26595256]
bas 7, expnt(s) = [31.15844245]
bas 8, expnt(s) = [0.31103796]
bas 9, expnt(s) = [2.11886924]
bas 10, expnt(s) = [5.87230759]
bas 11, expnt(s) = [7.1137618]
bas 12, expnt(s) = [23.1687643]
bas 13, expnt(s) = [99.78410633]
bas 14, expnt(s) = [0.26605267]
bas 15, expnt(s) = [2.44158514]
bas 16, expnt(s) = [0.83383617]
CPU time:       397.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23946705e-01 2.18493924e+00 2.44137943e+04 4.93448104e+03
 3.66144716e+03 1.18919918e+03 8.33411365e+02 3.91885855e+02
 2.34418600e+02 1.51359288e+02 7.97475267e+01 6.74222034e+01
 1.32659526e+01 1.75617930e+01 3.11584424e+01 3.33193737e+01
 3.11037958e-01 1.05226486e+00 2.11886924e+00 4.43703794e+00
 5.87230759e+00 9.53063025e+00 7.11376180e+00 3.38928852e+01
 2.31687643e+01 1.48290381e+02 9.97841063e+01 9.20049318e+02
 2.66052667e-01 5.57434590e-01 2.44158514e+00 8.90377615e+00
 8.33836172e-01 2.32453081e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639708783706
cond(S) = 1316.1508171382409
E1 = -183.59018410559534  E_coul = 55.0801867840085
init E= -128.509997321587
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775401975503025  LUMO = 0.823941091284394
  mo_energy =
[-3.25552796e+01 -1.85273675e+00 -7.75401976e-01 -7.75401976e-01
 -7.75401976e-01  8.23941091e-01  8.23941091e-01  8.23941091e-01
  8.42878636e-01  3.95618339e+00  3.95618339e+00  3.95618339e+00
  4.78540691e+00  1.43579263e+01  1.43579263e+01  1.43579263e+01
  1.83123056e+01  5.30034648e+01  5.30034648e+01  5.30034648e+01
  5.96401030e+01  1.79692712e+02  2.40824000e+02  2.40824000e+02
  2.40824000e+02  5.54265911e+02  1.92122903e+03  8.04545568e+03
  4.78054839e+04]
E1 = -182.08616106026884  E_coul = 53.547622668463724
cycle= 1 E= -128.538538391805  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518679
diis-c [-0.26902764  1.        ]
  HOMO = -0.884329505508124  LUMO = 0.79716154691603
  mo_energy =
[-3.28784825e+01 -1.96664344e+00 -8.84329506e-01 -8.84329506e-01
 -8.84329506e-01  7.97161547e-01  7.97161547e-01  7.97161547e-01
  8.11764940e-01  3.85870415e+00  3.85870415e+00  3.85870415e+00
  4.69188093e+00  1.41671426e+01  1.41671426e+01  1.41671426e+01
  1.81271241e+01  5.27224926e+01  5.27224926e+01  5.27224926e+01
  5.93746478e+01  1.79372313e+02  2.40477670e+02  2.40477670e+02
  2.40477670e+02  5.53904817e+02  1.92083185e+03  8.04502909e+03
  4.78050384e+04]
E1 = -182.84770190990588  E_coul = 54.306575571361805
cycle= 2 E= -128.541126338544  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263839
diis-c [-0.00075464  0.33626331  0.66373669]
  HOMO = -0.848705762578445  LUMO = 0.805890984098175
  mo_energy =
[-3.27703942e+01 -1.92913216e+00 -8.48705763e-01 -8.48705763e-01
 -8.48705763e-01  8.05890984e-01  8.05890984e-01  8.05890984e-01
  8.21715101e-01  3.89031921e+00  3.89031921e+00  3.89031921e+00
  4.72224539e+00  1.42303278e+01  1.42303278e+01  1.42303278e+01
  1.81884642e+01  5.28165009e+01  5.28165009e+01  5.28165009e+01
  5.94636486e+01  1.79479045e+02  2.40591331e+02  2.40591331e+02
  2.40591331e+02  5.54021462e+02  1.92095383e+03  8.04515359e+03
  4.78051638e+04]
E1 = -182.5890694838411  E_coul = 54.047022856540266
cycle= 3 E= -128.542046627301  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109859
diis-c [-1.84097277e-07 -2.36102255e-03 -8.08282429e-04  1.00316930e+00]
  HOMO = -0.848957654788398  LUMO = 0.805852757272607
  mo_energy =
[-3.27708332e+01 -1.92931956e+00 -8.48957655e-01 -8.48957655e-01
 -8.48957655e-01  8.05852757e-01  8.05852757e-01  8.05852757e-01
  8.21660595e-01  3.89014575e+00  3.89014575e+00  3.89014575e+00
  4.72208859e+00  1.42300326e+01  1.42300326e+01  1.42300326e+01
  1.81881843e+01  5.28161128e+01  5.28161128e+01  5.28161128e+01
  5.94632834e+01  1.79478596e+02  2.40590821e+02  2.40590821e+02
  2.40590821e+02  5.54020897e+02  1.92095313e+03  8.04515279e+03
  4.78051630e+04]
E1 = -182.5894724500197  E_coul = 54.047425798080276
cycle= 4 E= -128.542046651939  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188392
diis-c [-1.10671245e-09  2.28191233e-04  5.31199545e-04 -1.82221811e-01
  1.18146242e+00]
  HOMO = -0.849000888725345  LUMO = 0.805839423354831
  mo_energy =
[-3.27709071e+01 -1.92935238e+00 -8.49000889e-01 -8.49000889e-01
 -8.49000889e-01  8.05839423e-01  8.05839423e-01  8.05839423e-01
  8.21646773e-01  3.89010540e+00  3.89010540e+00  3.89010540e+00
  4.72205349e+00  1.42299728e+01  1.42299728e+01  1.42299728e+01
  1.81881268e+01  5.28160430e+01  5.28160430e+01  5.28160430e+01
  5.94632152e+01  1.79478522e+02  2.40590743e+02  2.40590743e+02
  2.40590743e+02  5.54020814e+02  1.92095304e+03  8.04515269e+03
  4.78051629e+04]
E1 = -182.58960878672215  E_coul = 54.047562134077786
cycle= 5 E= -128.542046652644  delta_E= -7.05e-10  |g|= 5.85e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58960878672215  E_coul = 54.047562134077786
  HOMO = -0.848997839685779  LUMO = 0.805840322064813
  mo_energy =
[-3.27709002e+01 -1.92934853e+00 -8.48997840e-01 -8.48997840e-01
 -8.48997840e-01  8.05840322e-01  8.05840322e-01  8.05840322e-01
  8.21648161e-01  3.89010833e+00  3.89010833e+00  3.89010833e+00
  4.72205664e+00  1.42299778e+01  1.42299778e+01  1.42299778e+01
  1.81881319e+01  5.28160495e+01  5.28160495e+01  5.28160495e+01
  5.94632215e+01  1.79478528e+02  2.40590749e+02  2.40590749e+02
  2.40590749e+02  5.54020821e+02  1.92095305e+03  8.04515270e+03
  4.78051629e+04]
E1 = -182.58959329013916  E_coul = 54.047546637492154
Extra cycle  E= -128.542046652647  delta_E= -2.64e-12  |g|= 2.18e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [8.23946705e-01 2.44137943e+04 3.66144716e+03 8.33411365e+02
 2.34418600e+02 7.97475267e+01 1.32659526e+01 3.11584424e+01
 3.11037958e-01 2.11886924e+00 5.87230759e+00 7.11376180e+00
 2.31687643e+01 9.97841063e+01 2.66052667e-01 2.44158514e+00
 8.33836172e-01]
E = -128.542046652647
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823946704861       1
[INPUT] 0    0    [1    /1   ]  24413.7942685        1
[INPUT] 0    0    [1    /1   ]  3661.44715816        1
[INPUT] 0    0    [1    /1   ]  833.411365212        1
[INPUT] 0    0    [1    /1   ]  234.418600108        1
[INPUT] 0    0    [1    /1   ]  79.7475266823        1
[INPUT] 0    0    [1    /1   ]  13.2659525605        1
[INPUT] 0    0    [1    /1   ]  31.1584424462        1
[INPUT] 0    0    [1    /1   ]  0.31103795843        1
[INPUT] 0    0    [1    /1   ]  2.11886924236        1
[INPUT] 0    0    [1    /1   ]  5.87230758732        1
[INPUT] 1    0    [1    /1   ]  7.11376179732        1
[INPUT] 1    0    [1    /1   ]  23.1687642979        1
[INPUT] 1    0    [1    /1   ]  99.7841063342        1
[INPUT] 1    0    [1    /1   ]  0.266052667333       1
[INPUT] 1    0    [1    /1   ]  2.44158513634        1
[INPUT] 1    0    [1    /1   ]  0.833836171617       1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8239467048606668, 1.0]], [0, [24413.79426847997, 1.0]], [0, [3661.447158161253, 1.0]], [0, [833.4113652124495, 1.0]], [0, [234.4186001083108, 1.0]], [0, [79.74752668231575, 1.0]], [0, [13.265952560462463, 1.0]], [0, [31.158442446185475, 1.0]], [0, [0.3110379584296739, 1.0]], [0, [2.1188692423596853, 1.0]], [0, [5.872307587315722, 1.0]], [1, [7.113761797316906, 1.0]], [1, [23.168764297920262, 1.0]], [1, [99.78410633415652, 1.0]], [1, [0.2660526673330466, 1.0]], [1, [2.4415851363353154, 1.0]], [1, [0.8338361716173055, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.8239467]
bas 1, expnt(s) = [24413.79426848]
bas 2, expnt(s) = [3661.44715816]
bas 3, expnt(s) = [833.41136521]
bas 4, expnt(s) = [234.41860011]
bas 5, expnt(s) = [79.74752668]
bas 6, expnt(s) = [13.26595256]
bas 7, expnt(s) = [31.15844245]
bas 8, expnt(s) = [0.31103796]
bas 9, expnt(s) = [2.11886924]
bas 10, expnt(s) = [5.87230759]
bas 11, expnt(s) = [7.1137618]
bas 12, expnt(s) = [23.1687643]
bas 13, expnt(s) = [99.78410633]
bas 14, expnt(s) = [0.26605267]
bas 15, expnt(s) = [2.44158514]
bas 16, expnt(s) = [0.83383617]
CPU time:       399.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23946705e-01 2.18493924e+00 2.44137943e+04 4.93448104e+03
 3.66144716e+03 1.18919918e+03 8.33411365e+02 3.91885855e+02
 2.34418600e+02 1.51359288e+02 7.97475267e+01 6.74222034e+01
 1.32659526e+01 1.75617930e+01 3.11584424e+01 3.33193737e+01
 3.11037958e-01 1.05226486e+00 2.11886924e+00 4.43703794e+00
 5.87230759e+00 9.53063025e+00 7.11376180e+00 3.38928852e+01
 2.31687643e+01 1.48290381e+02 9.97841063e+01 9.20049318e+02
 2.66052667e-01 5.57434590e-01 2.44158514e+00 8.90377615e+00
 8.33836172e-01 2.32453081e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639708783706
cond(S) = 1316.1508171382409
E1 = -183.59018410559534  E_coul = 55.0801867840085
init E= -128.509997321587
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775401975503025  LUMO = 0.823941091284394
  mo_energy =
[-3.25552796e+01 -1.85273675e+00 -7.75401976e-01 -7.75401976e-01
 -7.75401976e-01  8.23941091e-01  8.23941091e-01  8.23941091e-01
  8.42878636e-01  3.95618339e+00  3.95618339e+00  3.95618339e+00
  4.78540691e+00  1.43579263e+01  1.43579263e+01  1.43579263e+01
  1.83123056e+01  5.30034648e+01  5.30034648e+01  5.30034648e+01
  5.96401030e+01  1.79692712e+02  2.40824000e+02  2.40824000e+02
  2.40824000e+02  5.54265911e+02  1.92122903e+03  8.04545568e+03
  4.78054839e+04]
E1 = -182.08616106026884  E_coul = 53.547622668463724
cycle= 1 E= -128.538538391805  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.518679
diis-c [-0.26902764  1.        ]
  HOMO = -0.884329505508124  LUMO = 0.79716154691603
  mo_energy =
[-3.28784825e+01 -1.96664344e+00 -8.84329506e-01 -8.84329506e-01
 -8.84329506e-01  7.97161547e-01  7.97161547e-01  7.97161547e-01
  8.11764940e-01  3.85870415e+00  3.85870415e+00  3.85870415e+00
  4.69188093e+00  1.41671426e+01  1.41671426e+01  1.41671426e+01
  1.81271241e+01  5.27224926e+01  5.27224926e+01  5.27224926e+01
  5.93746478e+01  1.79372313e+02  2.40477670e+02  2.40477670e+02
  2.40477670e+02  5.53904817e+02  1.92083185e+03  8.04502909e+03
  4.78050384e+04]
E1 = -182.84770190990588  E_coul = 54.306575571361805
cycle= 2 E= -128.541126338544  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263839
diis-c [-0.00075464  0.33626331  0.66373669]
  HOMO = -0.848705762578445  LUMO = 0.805890984098175
  mo_energy =
[-3.27703942e+01 -1.92913216e+00 -8.48705763e-01 -8.48705763e-01
 -8.48705763e-01  8.05890984e-01  8.05890984e-01  8.05890984e-01
  8.21715101e-01  3.89031921e+00  3.89031921e+00  3.89031921e+00
  4.72224539e+00  1.42303278e+01  1.42303278e+01  1.42303278e+01
  1.81884642e+01  5.28165009e+01  5.28165009e+01  5.28165009e+01
  5.94636486e+01  1.79479045e+02  2.40591331e+02  2.40591331e+02
  2.40591331e+02  5.54021462e+02  1.92095383e+03  8.04515359e+03
  4.78051638e+04]
E1 = -182.5890694838411  E_coul = 54.047022856540266
cycle= 3 E= -128.542046627301  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109859
diis-c [-1.84097277e-07 -2.36102255e-03 -8.08282429e-04  1.00316930e+00]
  HOMO = -0.848957654788398  LUMO = 0.805852757272607
  mo_energy =
[-3.27708332e+01 -1.92931956e+00 -8.48957655e-01 -8.48957655e-01
 -8.48957655e-01  8.05852757e-01  8.05852757e-01  8.05852757e-01
  8.21660595e-01  3.89014575e+00  3.89014575e+00  3.89014575e+00
  4.72208859e+00  1.42300326e+01  1.42300326e+01  1.42300326e+01
  1.81881843e+01  5.28161128e+01  5.28161128e+01  5.28161128e+01
  5.94632834e+01  1.79478596e+02  2.40590821e+02  2.40590821e+02
  2.40590821e+02  5.54020897e+02  1.92095313e+03  8.04515279e+03
  4.78051630e+04]
E1 = -182.5894724500197  E_coul = 54.047425798080276
cycle= 4 E= -128.542046651939  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188392
diis-c [-1.10671245e-09  2.28191233e-04  5.31199545e-04 -1.82221811e-01
  1.18146242e+00]
  HOMO = -0.849000888725345  LUMO = 0.805839423354831
  mo_energy =
[-3.27709071e+01 -1.92935238e+00 -8.49000889e-01 -8.49000889e-01
 -8.49000889e-01  8.05839423e-01  8.05839423e-01  8.05839423e-01
  8.21646773e-01  3.89010540e+00  3.89010540e+00  3.89010540e+00
  4.72205349e+00  1.42299728e+01  1.42299728e+01  1.42299728e+01
  1.81881268e+01  5.28160430e+01  5.28160430e+01  5.28160430e+01
  5.94632152e+01  1.79478522e+02  2.40590743e+02  2.40590743e+02
  2.40590743e+02  5.54020814e+02  1.92095304e+03  8.04515269e+03
  4.78051629e+04]
E1 = -182.58960878672215  E_coul = 54.047562134077786
cycle= 5 E= -128.542046652644  delta_E= -7.05e-10  |g|= 5.85e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58960878672215  E_coul = 54.047562134077786
  HOMO = -0.848997839685779  LUMO = 0.805840322064813
  mo_energy =
[-3.27709002e+01 -1.92934853e+00 -8.48997840e-01 -8.48997840e-01
 -8.48997840e-01  8.05840322e-01  8.05840322e-01  8.05840322e-01
  8.21648161e-01  3.89010833e+00  3.89010833e+00  3.89010833e+00
  4.72205664e+00  1.42299778e+01  1.42299778e+01  1.42299778e+01
  1.81881319e+01  5.28160495e+01  5.28160495e+01  5.28160495e+01
  5.94632215e+01  1.79478528e+02  2.40590749e+02  2.40590749e+02
  2.40590749e+02  5.54020821e+02  1.92095305e+03  8.04515270e+03
  4.78051629e+04]
E1 = -182.58959329013916  E_coul = 54.047546637492154
Extra cycle  E= -128.542046652647  delta_E= -2.64e-12  |g|= 2.18e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1316.1508171382409
E1 = -182.58959329013916  E_coul = 54.047546637492154
init E= -128.542046652647
    CPU time for initialize scf      0.33 sec, wall time      0.33 sec
  HOMO = -0.848998936686541  LUMO = 0.805840071199935
  mo_energy =
[-3.27709037e+01 -1.92934954e+00 -8.48998937e-01 -8.48998937e-01
 -8.48998937e-01  8.05840071e-01  8.05840071e-01  8.05840071e-01
  8.21647941e-01  3.89010738e+00  3.89010738e+00  3.89010738e+00
  4.72205580e+00  1.42299759e+01  1.42299759e+01  1.42299759e+01
  1.81881301e+01  5.28160465e+01  5.28160465e+01  5.28160465e+01
  5.94632187e+01  1.79478525e+02  2.40590746e+02  2.40590746e+02
  2.40590746e+02  5.54020817e+02  1.92095304e+03  8.04515269e+03
  4.78051629e+04]
E1 = -182.58960191153963  E_coul = 54.04755525889268
cycle= 1 E= -128.542046652647  delta_E= 5.68e-14  |g|= 1.18e-06  |ddm|= 7.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58960191153963  E_coul = 54.04755525889268
  HOMO = -0.848998329948127  LUMO = 0.805840223279798
  mo_energy =
[-3.27709018e+01 -1.92934887e+00 -8.48998330e-01 -8.48998330e-01
 -8.48998330e-01  8.05840223e-01  8.05840223e-01  8.05840223e-01
  8.21648128e-01  3.89010792e+00  3.89010792e+00  3.89010792e+00
  4.72205634e+00  1.42299770e+01  1.42299770e+01  1.42299770e+01
  1.81881311e+01  5.28160481e+01  5.28160481e+01  5.28160481e+01
  5.94632202e+01  1.79478527e+02  2.40590748e+02  2.40590748e+02
  2.40590748e+02  5.54020819e+02  1.92095304e+03  8.04515269e+03
  4.78051629e+04]
E1 = -182.58959758022348  E_coul = 54.047550927576346
Extra cycle  E= -128.542046652647  delta_E= -1.99e-13  |g|= 5.88e-07  |ddm|= 3.91e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.39 sec
exp = [8.23946705e-01 2.44137943e+04 3.66144716e+03 8.33411365e+02
 2.34418600e+02 7.97475267e+01 1.32659526e+01 3.11584424e+01
 3.11037958e-01 2.11886924e+00 5.87230759e+00 7.11376180e+00
 2.31687643e+01 9.97841063e+01 2.66052667e-01 2.44158514e+00
 8.33836172e-01]
grad_E = [-6.65914852e-07  4.39419253e-09 -2.17856611e-07  3.56118129e-06
 -1.86096556e-05 -4.49916160e-06  1.14972617e-07 -4.75636695e-07
  2.66765756e-06  1.43721497e-08 -4.23301523e-07  3.97416366e-07
 -7.43683132e-07  1.00128108e-07  6.89339534e-06  1.45409263e-07
 -3.83675268e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823899431609       1
[INPUT] 0    0    [1    /1   ]  24413.7942684        1
[INPUT] 0    0    [1    /1   ]  3661.44716177        1
[INPUT] 0    0    [1    /1   ]  833.411291311        1
[INPUT] 0    0    [1    /1   ]  234.419392712        1
[INPUT] 0    0    [1    /1   ]  79.744632656         1
[INPUT] 0    0    [1    /1   ]  13.2657748096        1
[INPUT] 0    0    [1    /1   ]  31.1558219099        1
[INPUT] 0    0    [1    /1   ]  0.311013209826       1
[INPUT] 0    0    [1    /1   ]  2.1187348032         1
[INPUT] 0    0    [1    /1   ]  5.87320763358        1
[INPUT] 1    0    [1    /1   ]  7.11367905975        1
[INPUT] 1    0    [1    /1   ]  23.1688031834        1
[INPUT] 1    0    [1    /1   ]  99.7841045643        1
[INPUT] 1    0    [1    /1   ]  0.26604839679        1
[INPUT] 1    0    [1    /1   ]  2.44156132894        1
[INPUT] 1    0    [1    /1   ]  0.83383311228        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8238994316087327, 1.0]], [0, [24413.794268412075, 1.0]], [0, [3661.4471617740746, 1.0]], [0, [833.4112913107015, 1.0]], [0, [234.41939271202455, 1.0]], [0, [79.74463265603156, 1.0]], [0, [13.265774809551862, 1.0]], [0, [31.155821909878355, 1.0]], [0, [0.3110132098255959, 1.0]], [0, [2.1187348031984423, 1.0]], [0, [5.873207633577888, 1.0]], [1, [7.113679059745267, 1.0]], [1, [23.168803183418742, 1.0]], [1, [99.78410456433393, 1.0]], [1, [0.2660483967896208, 1.0]], [1, [2.441561328940381, 1.0]], [1, [0.8338331122795126, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82389943]
bas 1, expnt(s) = [24413.79426841]
bas 2, expnt(s) = [3661.44716177]
bas 3, expnt(s) = [833.41129131]
bas 4, expnt(s) = [234.41939271]
bas 5, expnt(s) = [79.74463266]
bas 6, expnt(s) = [13.26577481]
bas 7, expnt(s) = [31.15582191]
bas 8, expnt(s) = [0.31101321]
bas 9, expnt(s) = [2.1187348]
bas 10, expnt(s) = [5.87320763]
bas 11, expnt(s) = [7.11367906]
bas 12, expnt(s) = [23.16880318]
bas 13, expnt(s) = [99.78410456]
bas 14, expnt(s) = [0.2660484]
bas 15, expnt(s) = [2.44156133]
bas 16, expnt(s) = [0.83383311]
CPU time:       402.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23899432e-01 2.18484522e+00 2.44137943e+04 4.93448104e+03
 3.66144716e+03 1.18919918e+03 8.33411291e+02 3.91885829e+02
 2.34419393e+02 1.51359672e+02 7.97446327e+01 6.74203683e+01
 1.32657748e+01 1.75616165e+01 3.11558219e+01 3.33172720e+01
 3.11013210e-01 1.05220207e+00 2.11873480e+00 4.43682679e+00
 5.87320763e+00 9.53172579e+00 7.11367906e+00 3.38923925e+01
 2.31688032e+01 1.48290692e+02 9.97841046e+01 9.20049298e+02
 2.66048397e-01 5.57423406e-01 2.44156133e+00 8.90366763e+00
 8.33833112e-01 2.32452014e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639725566704
cond(S) = 1316.3925851795593
E1 = -183.59018375309432  E_coul = 55.08018671189223
init E= -128.509997041202
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.77540198241236  LUMO = 0.823928299138784
  mo_energy =
[-3.25552796e+01 -1.85273675e+00 -7.75401982e-01 -7.75401982e-01
 -7.75401982e-01  8.23928299e-01  8.23928299e-01  8.23928299e-01
  8.42800592e-01  3.95614725e+00  3.95614725e+00  3.95614725e+00
  4.78511111e+00  1.43577680e+01  1.43577680e+01  1.43577680e+01
  1.83125803e+01  5.30031680e+01  5.30031680e+01  5.30031680e+01
  5.96404279e+01  1.79687237e+02  2.40823793e+02  2.40823793e+02
  2.40823793e+02  5.54252335e+02  1.92121314e+03  8.04544104e+03
  4.78054717e+04]
E1 = -182.08615308748963  E_coul = 53.54761471798456
cycle= 1 E= -128.538538369505  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.518678
diis-c [-0.26902685  1.        ]
  HOMO = -0.884330171378102  LUMO = 0.797148857208547
  mo_energy =
[-3.28784838e+01 -1.96664414e+00 -8.84330171e-01 -8.84330171e-01
 -8.84330171e-01  7.97148857e-01  7.97148857e-01  7.97148857e-01
  8.11689088e-01  3.85866791e+00  3.85866791e+00  3.85866791e+00
  4.69158585e+00  1.41669842e+01  1.41669842e+01  1.41669842e+01
  1.81273933e+01  5.27221946e+01  5.27221946e+01  5.27221946e+01
  5.93749725e+01  1.79366839e+02  2.40477462e+02  2.40477462e+02
  2.40477462e+02  5.53891240e+02  1.92081596e+03  8.04501446e+03
  4.78050261e+04]
E1 = -182.8476970752502  E_coul = 54.306570745423464
cycle= 2 E= -128.541126329827  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.263839
diis-c [-0.00075466  0.33626373  0.66373627]
  HOMO = -0.848706301576357  LUMO = 0.805878201544069
  mo_energy =
[-3.27703951e+01 -1.92913272e+00 -8.48706302e-01 -8.48706302e-01
 -8.48706302e-01  8.05878202e-01  8.05878202e-01  8.05878202e-01
  8.21638442e-01  3.89028289e+00  3.89028289e+00  3.89028289e+00
  4.72194998e+00  1.42301693e+01  1.42301693e+01  1.42301693e+01
  1.81887352e+01  5.28162033e+01  5.28162033e+01  5.28162033e+01
  5.94639733e+01  1.79473571e+02  2.40591122e+02  2.40591122e+02
  2.40591122e+02  5.54007885e+02  1.92093793e+03  8.04513895e+03
  4.78051516e+04]
E1 = -182.5890628671198  E_coul = 54.04701623889255
cycle= 3 E= -128.542046628227  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109865
diis-c [-1.84115971e-07 -2.36119178e-03 -8.08397226e-04  1.00316959e+00]
  HOMO = -0.84895822846427  LUMO = 0.805839960834987
  mo_energy =
[-3.27708341e+01 -1.92932016e+00 -8.48958228e-01 -8.48958228e-01
 -8.48958228e-01  8.05839961e-01  8.05839961e-01  8.05839961e-01
  8.21583918e-01  3.89010940e+00  3.89010940e+00  3.89010940e+00
  4.72179314e+00  1.42298741e+01  1.42298741e+01  1.42298741e+01
  1.81884552e+01  5.28158151e+01  5.28158151e+01  5.28158151e+01
  5.94636081e+01  1.79473122e+02  2.40590613e+02  2.40590613e+02
  2.40590613e+02  5.54007320e+02  1.92093723e+03  8.04513815e+03
  4.78051507e+04]
E1 = -182.58946581791946  E_coul = 54.04741916504661
cycle= 4 E= -128.542046652873  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188403
diis-c [-1.10665941e-09  2.28168737e-04  5.31203436e-04 -1.82211600e-01
  1.18145223e+00]
  HOMO = -0.849001468497  LUMO = 0.805826624659711
  mo_energy =
[-3.27709080e+01 -1.92935299e+00 -8.49001468e-01 -8.49001468e-01
 -8.49001468e-01  8.05826625e-01  8.05826625e-01  8.05826625e-01
  8.21570093e-01  3.89006904e+00  3.89006904e+00  3.89006904e+00
  4.72175803e+00  1.42298144e+01  1.42298144e+01  1.42298144e+01
  1.81883978e+01  5.28157453e+01  5.28157453e+01  5.28157453e+01
  5.94635398e+01  1.79473048e+02  2.40590535e+02  2.40590535e+02
  2.40590535e+02  5.54007237e+02  1.92093714e+03  8.04513805e+03
  4.78051506e+04]
E1 = -182.5896021570753  E_coul = 54.04755550349766
cycle= 5 E= -128.542046653578  delta_E= -7.05e-10  |g|= 5.85e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5896021570753  E_coul = 54.04755550349766
  HOMO = -0.848998419745957  LUMO = 0.8058275232846
  mo_energy =
[-3.27709012e+01 -1.92934914e+00 -8.48998420e-01 -8.48998420e-01
 -8.48998420e-01  8.05827523e-01  8.05827523e-01  8.05827523e-01
  8.21571481e-01  3.89007196e+00  3.89007196e+00  3.89007196e+00
  4.72176119e+00  1.42298194e+01  1.42298194e+01  1.42298194e+01
  1.81884029e+01  5.28157518e+01  5.28157518e+01  5.28157518e+01
  5.94635461e+01  1.79473054e+02  2.40590541e+02  2.40590541e+02
  2.40590541e+02  5.54007244e+02  1.92093715e+03  8.04513806e+03
  4.78051506e+04]
E1 = -182.58958666201266  E_coul = 54.04754000843267
Extra cycle  E= -128.54204665358  delta_E= -2.36e-12  |g|= 2.18e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.16 sec, wall time      0.16 sec
exp = [8.23899432e-01 2.44137943e+04 3.66144716e+03 8.33411291e+02
 2.34419393e+02 7.97446327e+01 1.32657748e+01 3.11558219e+01
 3.11013210e-01 2.11873480e+00 5.87320763e+00 7.11367906e+00
 2.31688032e+01 9.97841046e+01 2.66048397e-01 2.44156133e+00
 8.33833112e-01]
E = -128.54204665358
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    final_E = atomic_energy(res.x, basis_str)
    print(res)
    print(f"E = {final_E}")
    
    nums_orbs = parse_basis_str(basis_str)
    max_n = max([n for [n, _] in nums_orbs])
    orbs = [orb for [_, orb] in nums_orbs]
    basis_nums = [num for [num, _] in nums_orbs]
    basis_cum_nums = np.cumsum(basis_nums)
    basis_cum_nums = np.concatenate(([0], basis_cum_nums))


    results = res.x

    print(''.join([f"{orb:<26}" for orb in orbs]))

    for i in range(max_n):
        print('    '.join([f"{results[i+basis_cum_nums[j]]:.16e}" if i < basis_nums[j] else '' for j in range(len(nums_orbs))]))

    print(f"E = {final_E}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]
basis_sets["9s6p"] = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
basis_sets["10s5p"] = [2.4413794129990565e+04,3.6614544699930652e+03,8.3327105710227954e+02,2.3573473657470291e+02,7.6433058080797622e+01,1.0036885276749757e+01,2.7050561740223941e+01,3.8143140543204801e-01,1.1170658350677358e+00,2.8824538920925851e+00,3.6848842291763377e+00,1.2450038737732893e+01,5.4785312306740778e+01,3.3026400429387798e-01,1.1441596434027714e+00]
basis_sets["11s5p"] = [8.4398862863370094e-01,2.4413794225702706e+04,3.6614494370702905e+03,8.3336851913760461e+02,2.3474278876808955e+02,8.0039421790599391e+01,1.3423101334609910e+01,3.1383887821739560e+01,3.1748626007276254e-01,2.1640160057688664e+00,5.9689311784613244e+00,3.6793998873912845e+00,1.2432658497667036e+01,5.4711786350854865e+01,3.2981584820904386e-01,1.1423900009921806e+00]
basis_sets["10s6p"] = [2.4413794186547566e+04,3.6614515715933576e+03,8.3331926164157414e+02,2.3544249760504746e+02,7.6138925685975124e+01,9.9917908657856156e+00,2.6918651321937844e+01,3.7985359460434670e-01,1.1097723200203859e+00,2.8599527636453970e+00,7.1138216686992184e+00,2.3171012506273396e+01,9.9786372110063894e+01,2.6639866269987839e-01,2.4420955233184571e+00,8.3448659373197043e-01]

basis = "11s6p"

exps = np.zeros((17, 2))
exps[1:, 0] = basis_sets["10s6p"][:]
exps[0, 0] = 0.5

# exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]


minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MBP-Home', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 23:57:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  0.823899431609       1
[INPUT] 0    0    [1    /1   ]  24413.7942684        1
[INPUT] 0    0    [1    /1   ]  3661.44716177        1
[INPUT] 0    0    [1    /1   ]  833.411291311        1
[INPUT] 0    0    [1    /1   ]  234.419392712        1
[INPUT] 0    0    [1    /1   ]  79.744632656         1
[INPUT] 0    0    [1    /1   ]  13.2657748096        1
[INPUT] 0    0    [1    /1   ]  31.1558219099        1
[INPUT] 0    0    [1    /1   ]  0.311013209826       1
[INPUT] 0    0    [1    /1   ]  2.1187348032         1
[INPUT] 0    0    [1    /1   ]  5.87320763358        1
[INPUT] 1    0    [1    /1   ]  7.11367905975        1
[INPUT] 1    0    [1    /1   ]  23.1688031834        1
[INPUT] 1    0    [1    /1   ]  99.7841045643        1
[INPUT] 1    0    [1    /1   ]  0.26604839679        1
[INPUT] 1    0    [1    /1   ]  2.44156132894        1
[INPUT] 1    0    [1    /1   ]  0.83383311228        1

nuclear repulsion = 0
number of shells = 17
number of NR pGTOs = 29
number of NR cGTOs = 29
basis = {'Ne': [[0, [0.8238994316087327, 1.0]], [0, [24413.794268412075, 1.0]], [0, [3661.4471617740746, 1.0]], [0, [833.4112913107015, 1.0]], [0, [234.41939271202455, 1.0]], [0, [79.74463265603156, 1.0]], [0, [13.265774809551862, 1.0]], [0, [31.155821909878355, 1.0]], [0, [0.3110132098255959, 1.0]], [0, [2.1187348031984423, 1.0]], [0, [5.873207633577888, 1.0]], [1, [7.113679059745267, 1.0]], [1, [23.168803183418742, 1.0]], [1, [99.78410456433393, 1.0]], [1, [0.2660483967896208, 1.0]], [1, [2.441561328940381, 1.0]], [1, [0.8338331122795126, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [0.82389943]
bas 1, expnt(s) = [24413.79426841]
bas 2, expnt(s) = [3661.44716177]
bas 3, expnt(s) = [833.41129131]
bas 4, expnt(s) = [234.41939271]
bas 5, expnt(s) = [79.74463266]
bas 6, expnt(s) = [13.26577481]
bas 7, expnt(s) = [31.15582191]
bas 8, expnt(s) = [0.31101321]
bas 9, expnt(s) = [2.1187348]
bas 10, expnt(s) = [5.87320763]
bas 11, expnt(s) = [7.11367906]
bas 12, expnt(s) = [23.16880318]
bas 13, expnt(s) = [99.78410456]
bas 14, expnt(s) = [0.2660484]
bas 15, expnt(s) = [2.44156133]
bas 16, expnt(s) = [0.83383311]
CPU time:       404.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  0  1  1  0 42 43  0]
 [ 0  0  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]
 [ 0  1  1  1  0 54 55  0]
 [ 0  1  1  1  0 56 57  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 8.23899432e-01 2.18484522e+00 2.44137943e+04 4.93448104e+03
 3.66144716e+03 1.18919918e+03 8.33411291e+02 3.91885829e+02
 2.34419393e+02 1.51359672e+02 7.97446327e+01 6.74203683e+01
 1.32657748e+01 1.75616165e+01 3.11558219e+01 3.33172720e+01
 3.11013210e-01 1.05220207e+00 2.11873480e+00 4.43682679e+00
 5.87320763e+00 9.53172579e+00 7.11367906e+00 3.38923925e+01
 2.31688032e+01 1.48290692e+02 9.97841046e+01 9.20049298e+02
 2.66048397e-01 5.57423406e-01 2.44156133e+00 8.90366763e+00
 8.33833112e-01 2.32452014e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999639725566704
cond(S) = 1316.3925851795593
E1 = -183.59018375309432  E_coul = 55.08018671189223
init E= -128.509997041202
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.77540198241236  LUMO = 0.823928299138784
  mo_energy =
[-3.25552796e+01 -1.85273675e+00 -7.75401982e-01 -7.75401982e-01
 -7.75401982e-01  8.23928299e-01  8.23928299e-01  8.23928299e-01
  8.42800592e-01  3.95614725e+00  3.95614725e+00  3.95614725e+00
  4.78511111e+00  1.43577680e+01  1.43577680e+01  1.43577680e+01
  1.83125803e+01  5.30031680e+01  5.30031680e+01  5.30031680e+01
  5.96404279e+01  1.79687237e+02  2.40823793e+02  2.40823793e+02
  2.40823793e+02  5.54252335e+02  1.92121314e+03  8.04544104e+03
  4.78054717e+04]
E1 = -182.08615308748963  E_coul = 53.54761471798456
cycle= 1 E= -128.538538369505  delta_E= -0.0285  |g|= 0.205  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.518678
diis-c [-0.26902685  1.        ]
  HOMO = -0.884330171378102  LUMO = 0.797148857208547
  mo_energy =
[-3.28784838e+01 -1.96664414e+00 -8.84330171e-01 -8.84330171e-01
 -8.84330171e-01  7.97148857e-01  7.97148857e-01  7.97148857e-01
  8.11689088e-01  3.85866791e+00  3.85866791e+00  3.85866791e+00
  4.69158585e+00  1.41669842e+01  1.41669842e+01  1.41669842e+01
  1.81273933e+01  5.27221946e+01  5.27221946e+01  5.27221946e+01
  5.93749725e+01  1.79366839e+02  2.40477462e+02  2.40477462e+02
  2.40477462e+02  5.53891240e+02  1.92081596e+03  8.04501446e+03
  4.78050261e+04]
E1 = -182.8476970752502  E_coul = 54.306570745423464
cycle= 2 E= -128.541126329827  delta_E= -0.00259  |g|= 0.104  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263839
diis-c [-0.00075466  0.33626373  0.66373627]
  HOMO = -0.848706301576357  LUMO = 0.805878201544069
  mo_energy =
[-3.27703951e+01 -1.92913272e+00 -8.48706302e-01 -8.48706302e-01
 -8.48706302e-01  8.05878202e-01  8.05878202e-01  8.05878202e-01
  8.21638442e-01  3.89028289e+00  3.89028289e+00  3.89028289e+00
  4.72194998e+00  1.42301693e+01  1.42301693e+01  1.42301693e+01
  1.81887352e+01  5.28162033e+01  5.28162033e+01  5.28162033e+01
  5.94639733e+01  1.79473571e+02  2.40591122e+02  2.40591122e+02
  2.40591122e+02  5.54007885e+02  1.92093793e+03  8.04513895e+03
  4.78051516e+04]
E1 = -182.5890628671198  E_coul = 54.04701623889255
cycle= 3 E= -128.542046628227  delta_E= -0.00092  |g|= 0.000498  |ddm|= 0.0226
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00109865
diis-c [-1.84115971e-07 -2.36119178e-03 -8.08397226e-04  1.00316959e+00]
  HOMO = -0.84895822846427  LUMO = 0.805839960834987
  mo_energy =
[-3.27708341e+01 -1.92932016e+00 -8.48958228e-01 -8.48958228e-01
 -8.48958228e-01  8.05839961e-01  8.05839961e-01  8.05839961e-01
  8.21583918e-01  3.89010940e+00  3.89010940e+00  3.89010940e+00
  4.72179314e+00  1.42298741e+01  1.42298741e+01  1.42298741e+01
  1.81884552e+01  5.28158151e+01  5.28158151e+01  5.28158151e+01
  5.94636081e+01  1.79473122e+02  2.40590613e+02  2.40590613e+02
  2.40590613e+02  5.54007320e+02  1.92093723e+03  8.04513815e+03
  4.78051507e+04]
E1 = -182.58946581791946  E_coul = 54.04741916504661
cycle= 4 E= -128.542046652873  delta_E= -2.46e-08  |g|= 8.04e-05  |ddm|= 0.000321
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188403
diis-c [-1.10665941e-09  2.28168737e-04  5.31203436e-04 -1.82211600e-01
  1.18145223e+00]
  HOMO = -0.849001468497  LUMO = 0.805826624659711
  mo_energy =
[-3.27709080e+01 -1.92935299e+00 -8.49001468e-01 -8.49001468e-01
 -8.49001468e-01  8.05826625e-01  8.05826625e-01  8.05826625e-01
  8.21570093e-01  3.89006904e+00  3.89006904e+00  3.89006904e+00
  4.72175803e+00  1.42298144e+01  1.42298144e+01  1.42298144e+01
  1.81883978e+01  5.28157453e+01  5.28157453e+01  5.28157453e+01
  5.94635398e+01  1.79473048e+02  2.40590535e+02  2.40590535e+02
  2.40590535e+02  5.54007237e+02  1.92093714e+03  8.04513805e+03
  4.78051506e+04]
E1 = -182.5896021570753  E_coul = 54.04755550349766
cycle= 5 E= -128.542046653578  delta_E= -7.05e-10  |g|= 5.85e-06  |ddm|= 5.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5896021570753  E_coul = 54.04755550349766
  HOMO = -0.848998419745957  LUMO = 0.8058275232846
  mo_energy =
[-3.27709012e+01 -1.92934914e+00 -8.48998420e-01 -8.48998420e-01
 -8.48998420e-01  8.05827523e-01  8.05827523e-01  8.05827523e-01
  8.21571481e-01  3.89007196e+00  3.89007196e+00  3.89007196e+00
  4.72176119e+00  1.42298194e+01  1.42298194e+01  1.42298194e+01
  1.81884029e+01  5.28157518e+01  5.28157518e+01  5.28157518e+01
  5.94635461e+01  1.79473054e+02  2.40590541e+02  2.40590541e+02
  2.40590541e+02  5.54007244e+02  1.92093715e+03  8.04513806e+03
  4.78051506e+04]
E1 = -182.58958666201266  E_coul = 54.04754000843267
Extra cycle  E= -128.54204665358  delta_E= -2.36e-12  |g|= 2.18e-06  |ddm|= 2.14e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [8.23899432e-01 2.44137943e+04 3.66144716e+03 8.33411291e+02
 2.34419393e+02 7.97446327e+01 1.32657748e+01 3.11558219e+01
 3.11013210e-01 2.11873480e+00 5.87320763e+00 7.11367906e+00
 2.31688032e+01 9.97841046e+01 2.66048397e-01 2.44156133e+00
 8.33833112e-01]
E = -128.54204665358
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -128.54204665358
       x: [ 8.239e-01  2.441e+04 ...  2.442e+00  8.338e-01]
     nit: 96
     jac: [-6.659e-07  4.394e-09 ...  1.454e-07 -3.837e-06]
    nfev: 98
    njev: 96
E = -128.54204665358
S                         P                         
8.2389943160873269e-01    7.1136790597452668e+00
2.4413794268412075e+04    2.3168803183418742e+01
3.6614471617740746e+03    9.9784104564333930e+01
8.3341129131070147e+02    2.6604839678962078e-01
2.3441939271202455e+02    2.4415613289403808e+00
7.9744632656031555e+01    8.3383311227951262e-01
1.3265774809551862e+01    
3.1155821909878355e+01    
3.1101320982559588e-01    
2.1187348031984423e+00    
5.8732076335778878e+00    
E = -128.54204665358
exp = [8.2389943160873269e-01,2.4413794268412075e+04,3.6614471617740746e+03,8.3341129131070147e+02,2.3441939271202455e+02,7.9744632656031555e+01,1.3265774809551862e+01,3.1155821909878355e+01,3.1101320982559588e-01,2.1187348031984423e+00,5.8732076335778878e+00,7.1136790597452668e+00,2.3168803183418742e+01,9.9784104564333930e+01,2.6604839678962078e-01,2.4415613289403808e+00,8.3383311227951262e-01]
