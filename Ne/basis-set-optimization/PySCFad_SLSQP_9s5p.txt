#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:37:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482378        1
[INPUT] 0    0    [1    /1   ]  174.907019526        1
[INPUT] 0    0    [1    /1   ]  20.4816964043        1
[INPUT] 0    0    [1    /1   ]  56.9551056879        1
[INPUT] 0    0    [1    /1   ]  0.487083150113       1
[INPUT] 0    0    [1    /1   ]  7.81995346673        1
[INPUT] 0    0    [1    /1   ]  1.65427857646        1
[INPUT] 1    0    [1    /1   ]  1.69521041396        1
[INPUT] 1    0    [1    /1   ]  6.27099828716        1
[INPUT] 1    0    [1    /1   ]  28.3916473097        1
[INPUT] 1    0    [1    /1   ]  0.431732418033       1
[INPUT] 1    0    [1    /1   ]  0.5                  1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025585, 1.0]], [0, [2712.0968240743605, 1.0]], [0, [617.4984823779516, 1.0]], [0, [174.90701952603408, 1.0]], [0, [20.481696404333736, 1.0]], [0, [56.95510568790738, 1.0]], [0, [0.4870831501131921, 1.0]], [0, [7.819953466725583, 1.0]], [0, [1.6542785764618793, 1.0]], [1, [1.6952104139604154, 1.0]], [1, [6.270998287162074, 1.0]], [1, [28.391647309720582, 1.0]], [1, [0.43173241803281515, 1.0]], [1, [0.5, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848238]
bas 3, expnt(s) = [174.90701953]
bas 4, expnt(s) = [20.4816964]
bas 5, expnt(s) = [56.95510569]
bas 6, expnt(s) = [0.48708315]
bas 7, expnt(s) = [7.81995347]
bas 8, expnt(s) = [1.65427858]
bas 9, expnt(s) = [1.69521041]
bas 10, expnt(s) = [6.27099829]
bas 11, expnt(s) = [28.39164731]
bas 12, expnt(s) = [0.43173242]
bas 13, expnt(s) = [0.5]
CPU time:         1.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907020e+02 1.21512359e+02
 2.04816964e+01 2.43242505e+01 5.69551057e+01 5.23798826e+01
 4.87083150e-01 1.47304954e+00 7.81995347e+00 1.18145763e+01
 1.65427858e+00 3.68528864e+00 1.69521041e+00 5.64305011e+00
 6.27099829e+00 2.89504451e+01 2.83916473e+01 1.91193284e+02
 4.31732418e-01 1.02094587e+00 5.00000000e-01 1.22658288e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.992799514017376
cond(S) = 1202.7153306159978
E1 = -183.51384917484168  E_coul = 55.06690631601356
init E= -128.446942858828
    CPU time for initialize scf      0.12 sec, wall time      0.13 sec
  HOMO = -0.768184719512769  LUMO = 0.954799743276874
  mo_energy =
[-3.25566823e+01 -1.85263260e+00 -7.68184720e-01 -7.68184720e-01
 -7.68184720e-01  9.54799743e-01  9.54799743e-01  9.54799743e-01
  2.05799075e+00  3.26848148e+00  3.26848148e+00  3.26848148e+00
  1.10545925e+01  1.10545925e+01  1.10545925e+01  1.94255422e+01
  5.42135517e+01  5.42135517e+01  5.42135517e+01  9.38377430e+01
  3.56154277e+02  1.34951806e+03  5.83596824e+03  3.50985965e+04]
E1 = -182.17161972206526  E_coul = 53.685795609697976
cycle= 1 E= -128.485824112367  delta_E= -0.0389  |g|= 0.192  |ddm|= 0.381
    CPU time for cycle= 1      0.28 sec, wall time      0.29 sec
diis-norm(errvec)=0.464844
diis-c [-0.21607989  1.        ]
  HOMO = -0.863006539379963  LUMO = 0.936714537939422
  mo_energy =
[-3.28619289e+01 -1.95130559e+00 -8.63006539e-01 -8.63006539e-01
 -8.63006539e-01  9.36714538e-01  9.36714538e-01  9.36714538e-01
  1.99401408e+00  3.20958790e+00  3.20958790e+00  3.20958790e+00
  1.08986703e+01  1.08986703e+01  1.08986703e+01  1.92219811e+01
  5.39379817e+01  5.39379817e+01  5.39379817e+01  9.35515993e+01
  3.55818959e+02  1.34914378e+03  5.83556193e+03  3.50981686e+04]
E1 = -182.85170963097775  E_coul = 54.36354626827855
cycle= 2 E= -128.488163362699  delta_E= -0.00234  |g|= 0.0919  |ddm|= 0.263
    CPU time for cycle= 2      0.09 sec, wall time      0.09 sec
diis-norm(errvec)=0.224304
diis-c [-4.71702408e-04  3.24686076e-01  6.75313924e-01]
  HOMO = -0.830736663210439  LUMO = 0.94419480711831
  mo_energy =
[-3.27633705e+01 -1.91733790e+00 -8.30736663e-01 -8.30736663e-01
 -8.30736663e-01  9.44194807e-01  9.44194807e-01  9.44194807e-01
  2.01690607e+00  3.23058206e+00  3.23058206e+00  3.23058206e+00
  1.09508379e+01  1.09508379e+01  1.09508379e+01  1.92894012e+01
  5.40276924e+01  5.40276924e+01  5.40276924e+01  9.36445846e+01
  3.55923973e+02  1.34925475e+03  5.83567577e+03  3.50982835e+04]
E1 = -182.63429116737322  E_coul = 54.14543279810915
cycle= 3 E= -128.488858369264  delta_E= -0.000695  |g|= 0.000918  |ddm|= 0.0505
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000522191
diis-c [-2.28982186e-07 -1.31171649e-03 -3.54216769e-03  1.00485388e+00]
  HOMO = -0.830552429382715  LUMO = 0.944333013776153
  mo_energy =
[-3.27631172e+01 -1.91702212e+00 -8.30552429e-01 -8.30552429e-01
 -8.30552429e-01  9.44333014e-01  9.44333014e-01  9.44333014e-01
  2.01723632e+00  3.23081695e+00  3.23081695e+00  3.23081695e+00
  1.09511259e+01  1.09511259e+01  1.09511259e+01  1.92896962e+01
  5.40279642e+01  5.40279642e+01  5.40279642e+01  9.36448531e+01
  3.55924208e+02  1.34925493e+03  5.83567588e+03  3.50982836e+04]
E1 = -182.63444524993625  E_coul = 54.145586737707276
cycle= 4 E= -128.488858512229  delta_E= -1.43e-07  |g|= 0.000144  |ddm|= 0.00486
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000121153
diis-c [-2.65570047e-09  4.60226801e-04  1.36999548e-03 -2.83759546e-01
  1.28192932e+00]
  HOMO = -0.830514837092436  LUMO = 0.944352391949577
  mo_energy =
[-3.27630761e+01 -1.91695030e+00 -8.30514837e-01 -8.30514837e-01
 -8.30514837e-01  9.44352392e-01  9.44352392e-01  9.44352392e-01
  2.01730122e+00  3.23085536e+00  3.23085536e+00  3.23085536e+00
  1.09511754e+01  1.09511754e+01  1.09511754e+01  1.92897523e+01
  5.40280097e+01  5.40280097e+01  5.40280097e+01  9.36448968e+01
  3.55924238e+02  1.34925494e+03  5.83567589e+03  3.50982836e+04]
E1 = -182.63453025109698  E_coul = 54.14567173482087
cycle= 5 E= -128.488858516276  delta_E= -4.05e-09  |g|= 1.05e-05  |ddm|= 0.000903
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.16984e-05
diis-c [-7.18418539e-12 -1.49564195e-05 -2.01863510e-06  1.49381802e-02
 -7.30978740e-02  1.05817667e+00]
  HOMO = -0.830518021117636  LUMO = 0.944350959359623
  mo_energy =
[-3.27630815e+01 -1.91695325e+00 -8.30518021e-01 -8.30518021e-01
 -8.30518021e-01  9.44350959e-01  9.44350959e-01  9.44350959e-01
  2.01729842e+00  3.23085253e+00  3.23085253e+00  3.23085253e+00
  1.09511714e+01  1.09511714e+01  1.09511714e+01  1.92897484e+01
  5.40280047e+01  5.40280047e+01  5.40280047e+01  9.36448916e+01
  3.55924232e+02  1.34925493e+03  5.83567588e+03  3.50982836e+04]
E1 = -182.6345299611392  E_coul = 54.14567144484702
cycle= 6 E= -128.488858516292  delta_E= -1.61e-11  |g|= 1.37e-06  |ddm|= 5.81e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.6345299611392  E_coul = 54.14567144484702
  HOMO = -0.83051878607334  LUMO = 0.944350715235155
  mo_energy =
[-3.27630831e+01 -1.91695410e+00 -8.30518786e-01 -8.30518786e-01
 -8.30518786e-01  9.44350715e-01  9.44350715e-01  9.44350715e-01
  2.01729774e+00  3.23085194e+00  3.23085194e+00  3.23085194e+00
  1.09511703e+01  1.09511703e+01  1.09511703e+01  1.92897472e+01
  5.40280032e+01  5.40280032e+01  5.40280032e+01  9.36448901e+01
  3.55924230e+02  1.34925493e+03  5.83567588e+03  3.50982836e+04]
E1 = -182.63453244596235  E_coul = 54.1456739296697
Extra cycle  E= -128.488858516293  delta_E= -4.55e-13  |g|= 3.91e-07  |ddm|= 4.81e-06
    CPU time for scf_cycle      0.55 sec, wall time      0.56 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907020e+02
 2.04816964e+01 5.69551057e+01 4.87083150e-01 7.81995347e+00
 1.65427858e+00 1.69521041e+00 6.27099829e+00 2.83916473e+01
 4.31732418e-01 5.00000000e-01]
E = -128.48885851629265
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482378        1
[INPUT] 0    0    [1    /1   ]  174.907019526        1
[INPUT] 0    0    [1    /1   ]  20.4816964043        1
[INPUT] 0    0    [1    /1   ]  56.9551056879        1
[INPUT] 0    0    [1    /1   ]  0.487083150113       1
[INPUT] 0    0    [1    /1   ]  7.81995346673        1
[INPUT] 0    0    [1    /1   ]  1.65427857646        1
[INPUT] 1    0    [1    /1   ]  1.69521041396        1
[INPUT] 1    0    [1    /1   ]  6.27099828716        1
[INPUT] 1    0    [1    /1   ]  28.3916473097        1
[INPUT] 1    0    [1    /1   ]  0.431732418033       1
[INPUT] 1    0    [1    /1   ]  0.5                  1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025585, 1.0]], [0, [2712.0968240743605, 1.0]], [0, [617.4984823779516, 1.0]], [0, [174.90701952603408, 1.0]], [0, [20.481696404333736, 1.0]], [0, [56.95510568790738, 1.0]], [0, [0.4870831501131921, 1.0]], [0, [7.819953466725583, 1.0]], [0, [1.6542785764618793, 1.0]], [1, [1.6952104139604154, 1.0]], [1, [6.270998287162074, 1.0]], [1, [28.391647309720582, 1.0]], [1, [0.43173241803281515, 1.0]], [1, [0.5, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848238]
bas 3, expnt(s) = [174.90701953]
bas 4, expnt(s) = [20.4816964]
bas 5, expnt(s) = [56.95510569]
bas 6, expnt(s) = [0.48708315]
bas 7, expnt(s) = [7.81995347]
bas 8, expnt(s) = [1.65427858]
bas 9, expnt(s) = [1.69521041]
bas 10, expnt(s) = [6.27099829]
bas 11, expnt(s) = [28.39164731]
bas 12, expnt(s) = [0.43173242]
bas 13, expnt(s) = [0.5]
CPU time:         2.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907020e+02 1.21512359e+02
 2.04816964e+01 2.43242505e+01 5.69551057e+01 5.23798826e+01
 4.87083150e-01 1.47304954e+00 7.81995347e+00 1.18145763e+01
 1.65427858e+00 3.68528864e+00 1.69521041e+00 5.64305011e+00
 6.27099829e+00 2.89504451e+01 2.83916473e+01 1.91193284e+02
 4.31732418e-01 1.02094587e+00 5.00000000e-01 1.22658288e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.992799514017376
cond(S) = 1202.7153306159978
E1 = -183.51384917484168  E_coul = 55.06690631601356
init E= -128.446942858828
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.768184719512769  LUMO = 0.954799743276874
  mo_energy =
[-3.25566823e+01 -1.85263260e+00 -7.68184720e-01 -7.68184720e-01
 -7.68184720e-01  9.54799743e-01  9.54799743e-01  9.54799743e-01
  2.05799075e+00  3.26848148e+00  3.26848148e+00  3.26848148e+00
  1.10545925e+01  1.10545925e+01  1.10545925e+01  1.94255422e+01
  5.42135517e+01  5.42135517e+01  5.42135517e+01  9.38377430e+01
  3.56154277e+02  1.34951806e+03  5.83596824e+03  3.50985965e+04]
E1 = -182.17161972206526  E_coul = 53.685795609697976
cycle= 1 E= -128.485824112367  delta_E= -0.0389  |g|= 0.192  |ddm|= 0.381
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.464844
diis-c [-0.21607989  1.        ]
  HOMO = -0.863006539379963  LUMO = 0.936714537939422
  mo_energy =
[-3.28619289e+01 -1.95130559e+00 -8.63006539e-01 -8.63006539e-01
 -8.63006539e-01  9.36714538e-01  9.36714538e-01  9.36714538e-01
  1.99401408e+00  3.20958790e+00  3.20958790e+00  3.20958790e+00
  1.08986703e+01  1.08986703e+01  1.08986703e+01  1.92219811e+01
  5.39379817e+01  5.39379817e+01  5.39379817e+01  9.35515993e+01
  3.55818959e+02  1.34914378e+03  5.83556193e+03  3.50981686e+04]
E1 = -182.85170963097775  E_coul = 54.36354626827855
cycle= 2 E= -128.488163362699  delta_E= -0.00234  |g|= 0.0919  |ddm|= 0.263
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224304
diis-c [-4.71702408e-04  3.24686076e-01  6.75313924e-01]
  HOMO = -0.830736663210439  LUMO = 0.94419480711831
  mo_energy =
[-3.27633705e+01 -1.91733790e+00 -8.30736663e-01 -8.30736663e-01
 -8.30736663e-01  9.44194807e-01  9.44194807e-01  9.44194807e-01
  2.01690607e+00  3.23058206e+00  3.23058206e+00  3.23058206e+00
  1.09508379e+01  1.09508379e+01  1.09508379e+01  1.92894012e+01
  5.40276924e+01  5.40276924e+01  5.40276924e+01  9.36445846e+01
  3.55923973e+02  1.34925475e+03  5.83567577e+03  3.50982835e+04]
E1 = -182.63429116737322  E_coul = 54.14543279810915
cycle= 3 E= -128.488858369264  delta_E= -0.000695  |g|= 0.000918  |ddm|= 0.0505
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000522191
diis-c [-2.28982186e-07 -1.31171649e-03 -3.54216769e-03  1.00485388e+00]
  HOMO = -0.830552429382715  LUMO = 0.944333013776153
  mo_energy =
[-3.27631172e+01 -1.91702212e+00 -8.30552429e-01 -8.30552429e-01
 -8.30552429e-01  9.44333014e-01  9.44333014e-01  9.44333014e-01
  2.01723632e+00  3.23081695e+00  3.23081695e+00  3.23081695e+00
  1.09511259e+01  1.09511259e+01  1.09511259e+01  1.92896962e+01
  5.40279642e+01  5.40279642e+01  5.40279642e+01  9.36448531e+01
  3.55924208e+02  1.34925493e+03  5.83567588e+03  3.50982836e+04]
E1 = -182.63444524993625  E_coul = 54.145586737707276
cycle= 4 E= -128.488858512229  delta_E= -1.43e-07  |g|= 0.000144  |ddm|= 0.00486
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000121153
diis-c [-2.65570047e-09  4.60226801e-04  1.36999548e-03 -2.83759546e-01
  1.28192932e+00]
  HOMO = -0.830514837092436  LUMO = 0.944352391949577
  mo_energy =
[-3.27630761e+01 -1.91695030e+00 -8.30514837e-01 -8.30514837e-01
 -8.30514837e-01  9.44352392e-01  9.44352392e-01  9.44352392e-01
  2.01730122e+00  3.23085536e+00  3.23085536e+00  3.23085536e+00
  1.09511754e+01  1.09511754e+01  1.09511754e+01  1.92897523e+01
  5.40280097e+01  5.40280097e+01  5.40280097e+01  9.36448968e+01
  3.55924238e+02  1.34925494e+03  5.83567589e+03  3.50982836e+04]
E1 = -182.63453025109698  E_coul = 54.14567173482087
cycle= 5 E= -128.488858516276  delta_E= -4.05e-09  |g|= 1.05e-05  |ddm|= 0.000903
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.16984e-05
diis-c [-7.18418539e-12 -1.49564195e-05 -2.01863510e-06  1.49381802e-02
 -7.30978740e-02  1.05817667e+00]
  HOMO = -0.830518021117636  LUMO = 0.944350959359623
  mo_energy =
[-3.27630815e+01 -1.91695325e+00 -8.30518021e-01 -8.30518021e-01
 -8.30518021e-01  9.44350959e-01  9.44350959e-01  9.44350959e-01
  2.01729842e+00  3.23085253e+00  3.23085253e+00  3.23085253e+00
  1.09511714e+01  1.09511714e+01  1.09511714e+01  1.92897484e+01
  5.40280047e+01  5.40280047e+01  5.40280047e+01  9.36448916e+01
  3.55924232e+02  1.34925493e+03  5.83567588e+03  3.50982836e+04]
E1 = -182.6345299611392  E_coul = 54.14567144484702
cycle= 6 E= -128.488858516292  delta_E= -1.61e-11  |g|= 1.37e-06  |ddm|= 5.81e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.6345299611392  E_coul = 54.14567144484702
  HOMO = -0.83051878607334  LUMO = 0.944350715235155
  mo_energy =
[-3.27630831e+01 -1.91695410e+00 -8.30518786e-01 -8.30518786e-01
 -8.30518786e-01  9.44350715e-01  9.44350715e-01  9.44350715e-01
  2.01729774e+00  3.23085194e+00  3.23085194e+00  3.23085194e+00
  1.09511703e+01  1.09511703e+01  1.09511703e+01  1.92897472e+01
  5.40280032e+01  5.40280032e+01  5.40280032e+01  9.36448901e+01
  3.55924230e+02  1.34925493e+03  5.83567588e+03  3.50982836e+04]
E1 = -182.63453244596235  E_coul = 54.1456739296697
Extra cycle  E= -128.488858516293  delta_E= -4.55e-13  |g|= 3.91e-07  |ddm|= 4.81e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 1202.7153306159978
E1 = -182.63453244596235  E_coul = 54.1456739296697
init E= -128.488858516293
    CPU time for initialize scf      0.41 sec, wall time      0.42 sec
  HOMO = -0.830518622790328  LUMO = 0.94435074254597
  mo_energy =
[-3.27630825e+01 -1.91695395e+00 -8.30518623e-01 -8.30518623e-01
 -8.30518623e-01  9.44350743e-01  9.44350743e-01  9.44350743e-01
  2.01729783e+00  3.23085203e+00  3.23085203e+00  3.23085203e+00
  1.09511705e+01  1.09511705e+01  1.09511705e+01  1.92897476e+01
  5.40280037e+01  5.40280037e+01  5.40280037e+01  9.36448907e+01
  3.55924231e+02  1.34925493e+03  5.83567588e+03  3.50982836e+04]
E1 = -182.63453096148152  E_coul = 54.14567244518865
cycle= 1 E= -128.488858516293  delta_E= -1.99e-13  |g|= 1.99e-07  |ddm|= 1.15e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.63453096148152  E_coul = 54.14567244518865
  HOMO = -0.830518728267375  LUMO = 0.944350717106496
  mo_energy =
[-3.27630828e+01 -1.91695406e+00 -8.30518728e-01 -8.30518728e-01
 -8.30518728e-01  9.44350717e-01  9.44350717e-01  9.44350717e-01
  2.01729775e+00  3.23085196e+00  3.23085196e+00  3.23085196e+00
  1.09511704e+01  1.09511704e+01  1.09511704e+01  1.92897473e+01
  5.40280034e+01  5.40280034e+01  5.40280034e+01  9.36448904e+01
  3.55924230e+02  1.34925493e+03  5.83567588e+03  3.50982836e+04]
E1 = -182.63453163340753  E_coul = 54.145673117114995
Extra cycle  E= -128.488858516293  delta_E= 3.13e-13  |g|= 9.15e-08  |ddm|= 9.18e-08
    CPU time for scf_cycle      1.13 sec, wall time      1.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907020e+02
 2.04816964e+01 5.69551057e+01 4.87083150e-01 7.81995347e+00
 1.65427858e+00 1.69521041e+00 6.27099829e+00 2.83916473e+01
 4.31732418e-01 5.00000000e-01]
grad_E = [ 2.72591672e-12  7.48013409e-11 -1.51017231e-09  1.32082664e-08
  4.83421334e-07 -7.86481275e-08 -1.78108171e-04 -8.67006678e-07
  6.84383975e-06 -1.15429511e-02  1.26056902e-03 -4.38945081e-05
  3.94372082e-02 -2.01169603e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482379        1
[INPUT] 0    0    [1    /1   ]  174.907019513        1
[INPUT] 0    0    [1    /1   ]  20.4816959209        1
[INPUT] 0    0    [1    /1   ]  56.9551057666        1
[INPUT] 0    0    [1    /1   ]  0.487261258284       1
[INPUT] 0    0    [1    /1   ]  7.81995433373        1
[INPUT] 0    0    [1    /1   ]  1.65427173262        1
[INPUT] 1    0    [1    /1   ]  1.70675336507        1
[INPUT] 1    0    [1    /1   ]  6.26973771814        1
[INPUT] 1    0    [1    /1   ]  28.3916912042        1
[INPUT] 1    0    [1    /1   ]  0.39229520987        1
[INPUT] 1    0    [1    /1   ]  0.502011696029       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002558, 1.0]], [0, [2712.096824074286, 1.0]], [0, [617.4984823794618, 1.0]], [0, [174.9070195128258, 1.0]], [0, [20.4816959209124, 1.0]], [0, [56.955105766555505, 1.0]], [0, [0.4872612582844223, 1.0]], [0, [7.819954333732261, 1.0]], [0, [1.6542717326221248, 1.0]], [1, [1.7067533650741618, 1.0]], [1, [6.26973771814443, 1.0]], [1, [28.39169120422871, 1.0]], [1, [0.39229520987008415, 1.0]], [1, [0.502011696029026, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848238]
bas 3, expnt(s) = [174.90701951]
bas 4, expnt(s) = [20.48169592]
bas 5, expnt(s) = [56.95510577]
bas 6, expnt(s) = [0.48726126]
bas 7, expnt(s) = [7.81995433]
bas 8, expnt(s) = [1.65427173]
bas 9, expnt(s) = [1.70675337]
bas 10, expnt(s) = [6.26973772]
bas 11, expnt(s) = [28.3916912]
bas 12, expnt(s) = [0.39229521]
bas 13, expnt(s) = [0.5020117]
CPU time:         7.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907020e+02 1.21512359e+02
 2.04816959e+01 2.43242501e+01 5.69551058e+01 5.23798827e+01
 4.87261258e-01 1.47345350e+00 7.81995433e+00 1.18145773e+01
 1.65427173e+00 3.68527720e+00 1.70675337e+00 5.69112143e+00
 6.26973772e+00 2.89431709e+01 2.83916912e+01 1.91193653e+02
 3.92295210e-01 9.05733954e-01 5.02011696e-01 1.23275476e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99350117072471
cond(S) = 415.3107747172099
E1 = -183.51589381933368  E_coul = 55.06688988450939
init E= -128.449003934824
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.768513711070939  LUMO = 0.901681583070417
  mo_energy =
[-3.25567562e+01 -1.85260310e+00 -7.68513711e-01 -7.68513711e-01
 -7.68513711e-01  9.01681583e-01  9.01681583e-01  9.01681583e-01
  2.05859787e+00  3.15525086e+00  3.15525086e+00  3.15525086e+00
  1.09501201e+01  1.09501201e+01  1.09501201e+01  1.94263487e+01
  5.41499766e+01  5.41499766e+01  5.41499766e+01  9.38383536e+01
  3.56154840e+02  1.34951860e+03  5.83596873e+03  3.50985969e+04]
E1 = -182.1412767790788  E_coul = 53.65375114368779
cycle= 1 E= -128.487525635391  delta_E= -0.0385  |g|= 0.196  |ddm|= 0.233
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.47133
diis-c [-0.22215215  1.        ]
  HOMO = -0.865857879056663  LUMO = 0.884004209598299
  mo_energy =
[-3.28674608e+01 -1.95419518e+00 -8.65857879e-01 -8.65857879e-01
 -8.65857879e-01  8.84004210e-01  8.84004210e-01  8.84004210e-01
  1.99232116e+00  3.09498050e+00  3.09498050e+00  3.09498050e+00
  1.07898461e+01  1.07898461e+01  1.07898461e+01  1.92183823e+01
  5.38691741e+01  5.38691741e+01  5.38691741e+01  9.35469465e+01
  3.55813886e+02  1.34913854e+03  5.83555661e+03  3.50981632e+04]
E1 = -182.84001228890762  E_coul = 54.350059896914985
cycle= 2 E= -128.489952391993  delta_E= -0.00243  |g|= 0.0944  |ddm|= 0.136
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229292
diis-c [-4.77724024e-04  3.26501456e-01  6.73498544e-01]
  HOMO = -0.83276450541193  LUMO = 0.891229028632454
  mo_energy =
[-3.27666003e+01 -1.91934162e+00 -8.32764505e-01 -8.32764505e-01
 -8.32764505e-01  8.91229029e-01  8.91229029e-01  8.91229029e-01
  2.01582602e+00  3.11634199e+00  3.11634199e+00  3.11634199e+00
  1.08435301e+01  1.08435301e+01  1.08435301e+01  1.92874530e+01
  5.39610360e+01  5.39610360e+01  5.39610360e+01  9.36421166e+01
  3.55921319e+02  1.34925205e+03  5.83567303e+03  3.50982807e+04]
E1 = -182.6154528976059  E_coul = 54.12476373470793
cycle= 3 E= -128.490689162898  delta_E= -0.000737  |g|= 0.000908  |ddm|= 0.0305
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000527175
diis-c [-2.12591861e-07 -1.27469932e-03 -3.65109722e-03  1.00492580e+00]
  HOMO = -0.832572144814406  LUMO = 0.891365931265713
  mo_energy =
[-3.27663297e+01 -1.91902663e+00 -8.32572145e-01 -8.32572145e-01
 -8.32572145e-01  8.91365931e-01  8.91365931e-01  8.91365931e-01
  2.01615694e+00  3.11658463e+00  3.11658463e+00  3.11658463e+00
  1.08438309e+01  1.08438309e+01  1.08438309e+01  1.92877599e+01
  5.39613240e+01  5.39613240e+01  5.39613240e+01  9.36424014e+01
  3.55921574e+02  1.34925225e+03  5.83567317e+03  3.50982809e+04]
E1 = -182.61557228903717  E_coul = 54.124882982716336
cycle= 4 E= -128.490689306321  delta_E= -1.43e-07  |g|= 0.000142  |ddm|= 0.0025
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000114342
diis-c [-2.86229292e-09  4.33015023e-04  1.31598696e-03 -2.71464167e-01
  1.26971516e+00]
  HOMO = -0.832532960170855  LUMO = 0.891385077232357
  mo_energy =
[-3.27662865e+01 -1.91895577e+00 -8.32532960e-01 -8.32532960e-01
 -8.32532960e-01  8.91385077e-01  8.91385077e-01  8.91385077e-01
  2.01622119e+00  3.11662413e+00  3.11662413e+00  3.11662413e+00
  1.08438820e+01  1.08438820e+01  1.08438820e+01  1.92878168e+01
  5.39613712e+01  5.39613712e+01  5.39613712e+01  9.36424471e+01
  3.55921608e+02  1.34925227e+03  5.83567318e+03  3.50982809e+04]
E1 = -182.61566045538805  E_coul = 54.124971144998355
cycle= 5 E= -128.49068931039  delta_E= -4.07e-09  |g|= 9.26e-06  |ddm|= 0.000473
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.06831e-05
diis-c [-9.86492912e-12 -1.39427928e-05 -1.15103906e-05  1.61413707e-02
 -8.83040662e-02  1.07218815e+00]
  HOMO = -0.832535459860225  LUMO = 0.891383964877652
  mo_energy =
[-3.27662909e+01 -1.91895761e+00 -8.32535460e-01 -8.32535460e-01
 -8.32535460e-01  8.91383965e-01  8.91383965e-01  8.91383965e-01
  2.01621935e+00  3.11662191e+00  3.11662191e+00  3.11662191e+00
  1.08438789e+01  1.08438789e+01  1.08438789e+01  1.92878141e+01
  5.39613672e+01  5.39613672e+01  5.39613672e+01  9.36424429e+01
  3.55921602e+02  1.34925226e+03  5.83567318e+03  3.50982809e+04]
E1 = -182.61565934111616  E_coul = 54.124970030713484
cycle= 6 E= -128.490689310403  delta_E= -1.3e-11  |g|= 1.36e-06  |ddm|= 2.53e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.61565934111616  E_coul = 54.124970030713484
  HOMO = -0.832536241024948  LUMO = 0.891383730851259
  mo_energy =
[-3.27662925e+01 -1.91895846e+00 -8.32536241e-01 -8.32536241e-01
 -8.32536241e-01  8.91383731e-01  8.91383731e-01  8.91383731e-01
  2.01621867e+00  3.11662132e+00  3.11662132e+00  3.11662132e+00
  1.08438778e+01  1.08438778e+01  1.08438778e+01  1.92878128e+01
  5.39613657e+01  5.39613657e+01  5.39613657e+01  9.36424414e+01
  3.55921601e+02  1.34925226e+03  5.83567317e+03  3.50982809e+04]
E1 = -182.61566194415946  E_coul = 54.12497263375662
Extra cycle  E= -128.490689310403  delta_E= -1.71e-13  |g|= 4.05e-07  |ddm|= 2.44e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907020e+02
 2.04816959e+01 5.69551058e+01 4.87261258e-01 7.81995433e+00
 1.65427173e+00 1.70675337e+00 6.26973772e+00 2.83916912e+01
 3.92295210e-01 5.02011696e-01]
E = -128.49068931040284
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482379        1
[INPUT] 0    0    [1    /1   ]  174.907019513        1
[INPUT] 0    0    [1    /1   ]  20.4816959209        1
[INPUT] 0    0    [1    /1   ]  56.9551057666        1
[INPUT] 0    0    [1    /1   ]  0.487261258284       1
[INPUT] 0    0    [1    /1   ]  7.81995433373        1
[INPUT] 0    0    [1    /1   ]  1.65427173262        1
[INPUT] 1    0    [1    /1   ]  1.70675336507        1
[INPUT] 1    0    [1    /1   ]  6.26973771814        1
[INPUT] 1    0    [1    /1   ]  28.3916912042        1
[INPUT] 1    0    [1    /1   ]  0.39229520987        1
[INPUT] 1    0    [1    /1   ]  0.502011696029       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002558, 1.0]], [0, [2712.096824074286, 1.0]], [0, [617.4984823794618, 1.0]], [0, [174.9070195128258, 1.0]], [0, [20.4816959209124, 1.0]], [0, [56.955105766555505, 1.0]], [0, [0.4872612582844223, 1.0]], [0, [7.819954333732261, 1.0]], [0, [1.6542717326221248, 1.0]], [1, [1.7067533650741618, 1.0]], [1, [6.26973771814443, 1.0]], [1, [28.39169120422871, 1.0]], [1, [0.39229520987008415, 1.0]], [1, [0.502011696029026, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848238]
bas 3, expnt(s) = [174.90701951]
bas 4, expnt(s) = [20.48169592]
bas 5, expnt(s) = [56.95510577]
bas 6, expnt(s) = [0.48726126]
bas 7, expnt(s) = [7.81995433]
bas 8, expnt(s) = [1.65427173]
bas 9, expnt(s) = [1.70675337]
bas 10, expnt(s) = [6.26973772]
bas 11, expnt(s) = [28.3916912]
bas 12, expnt(s) = [0.39229521]
bas 13, expnt(s) = [0.5020117]
CPU time:         7.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907020e+02 1.21512359e+02
 2.04816959e+01 2.43242501e+01 5.69551058e+01 5.23798827e+01
 4.87261258e-01 1.47345350e+00 7.81995433e+00 1.18145773e+01
 1.65427173e+00 3.68527720e+00 1.70675337e+00 5.69112143e+00
 6.26973772e+00 2.89431709e+01 2.83916912e+01 1.91193653e+02
 3.92295210e-01 9.05733954e-01 5.02011696e-01 1.23275476e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99350117072471
cond(S) = 415.3107747172099
E1 = -183.51589381933368  E_coul = 55.06688988450939
init E= -128.449003934824
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.768513711070939  LUMO = 0.901681583070417
  mo_energy =
[-3.25567562e+01 -1.85260310e+00 -7.68513711e-01 -7.68513711e-01
 -7.68513711e-01  9.01681583e-01  9.01681583e-01  9.01681583e-01
  2.05859787e+00  3.15525086e+00  3.15525086e+00  3.15525086e+00
  1.09501201e+01  1.09501201e+01  1.09501201e+01  1.94263487e+01
  5.41499766e+01  5.41499766e+01  5.41499766e+01  9.38383536e+01
  3.56154840e+02  1.34951860e+03  5.83596873e+03  3.50985969e+04]
E1 = -182.1412767790788  E_coul = 53.65375114368779
cycle= 1 E= -128.487525635391  delta_E= -0.0385  |g|= 0.196  |ddm|= 0.233
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.47133
diis-c [-0.22215215  1.        ]
  HOMO = -0.865857879056663  LUMO = 0.884004209598299
  mo_energy =
[-3.28674608e+01 -1.95419518e+00 -8.65857879e-01 -8.65857879e-01
 -8.65857879e-01  8.84004210e-01  8.84004210e-01  8.84004210e-01
  1.99232116e+00  3.09498050e+00  3.09498050e+00  3.09498050e+00
  1.07898461e+01  1.07898461e+01  1.07898461e+01  1.92183823e+01
  5.38691741e+01  5.38691741e+01  5.38691741e+01  9.35469465e+01
  3.55813886e+02  1.34913854e+03  5.83555661e+03  3.50981632e+04]
E1 = -182.84001228890762  E_coul = 54.350059896914985
cycle= 2 E= -128.489952391993  delta_E= -0.00243  |g|= 0.0944  |ddm|= 0.136
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229292
diis-c [-4.77724024e-04  3.26501456e-01  6.73498544e-01]
  HOMO = -0.83276450541193  LUMO = 0.891229028632454
  mo_energy =
[-3.27666003e+01 -1.91934162e+00 -8.32764505e-01 -8.32764505e-01
 -8.32764505e-01  8.91229029e-01  8.91229029e-01  8.91229029e-01
  2.01582602e+00  3.11634199e+00  3.11634199e+00  3.11634199e+00
  1.08435301e+01  1.08435301e+01  1.08435301e+01  1.92874530e+01
  5.39610360e+01  5.39610360e+01  5.39610360e+01  9.36421166e+01
  3.55921319e+02  1.34925205e+03  5.83567303e+03  3.50982807e+04]
E1 = -182.6154528976059  E_coul = 54.12476373470793
cycle= 3 E= -128.490689162898  delta_E= -0.000737  |g|= 0.000908  |ddm|= 0.0305
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000527175
diis-c [-2.12591861e-07 -1.27469932e-03 -3.65109722e-03  1.00492580e+00]
  HOMO = -0.832572144814406  LUMO = 0.891365931265713
  mo_energy =
[-3.27663297e+01 -1.91902663e+00 -8.32572145e-01 -8.32572145e-01
 -8.32572145e-01  8.91365931e-01  8.91365931e-01  8.91365931e-01
  2.01615694e+00  3.11658463e+00  3.11658463e+00  3.11658463e+00
  1.08438309e+01  1.08438309e+01  1.08438309e+01  1.92877599e+01
  5.39613240e+01  5.39613240e+01  5.39613240e+01  9.36424014e+01
  3.55921574e+02  1.34925225e+03  5.83567317e+03  3.50982809e+04]
E1 = -182.61557228903717  E_coul = 54.124882982716336
cycle= 4 E= -128.490689306321  delta_E= -1.43e-07  |g|= 0.000142  |ddm|= 0.0025
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000114342
diis-c [-2.86229292e-09  4.33015023e-04  1.31598696e-03 -2.71464167e-01
  1.26971516e+00]
  HOMO = -0.832532960170855  LUMO = 0.891385077232357
  mo_energy =
[-3.27662865e+01 -1.91895577e+00 -8.32532960e-01 -8.32532960e-01
 -8.32532960e-01  8.91385077e-01  8.91385077e-01  8.91385077e-01
  2.01622119e+00  3.11662413e+00  3.11662413e+00  3.11662413e+00
  1.08438820e+01  1.08438820e+01  1.08438820e+01  1.92878168e+01
  5.39613712e+01  5.39613712e+01  5.39613712e+01  9.36424471e+01
  3.55921608e+02  1.34925227e+03  5.83567318e+03  3.50982809e+04]
E1 = -182.61566045538805  E_coul = 54.124971144998355
cycle= 5 E= -128.49068931039  delta_E= -4.07e-09  |g|= 9.26e-06  |ddm|= 0.000473
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.06831e-05
diis-c [-9.86492912e-12 -1.39427928e-05 -1.15103906e-05  1.61413707e-02
 -8.83040662e-02  1.07218815e+00]
  HOMO = -0.832535459860225  LUMO = 0.891383964877652
  mo_energy =
[-3.27662909e+01 -1.91895761e+00 -8.32535460e-01 -8.32535460e-01
 -8.32535460e-01  8.91383965e-01  8.91383965e-01  8.91383965e-01
  2.01621935e+00  3.11662191e+00  3.11662191e+00  3.11662191e+00
  1.08438789e+01  1.08438789e+01  1.08438789e+01  1.92878141e+01
  5.39613672e+01  5.39613672e+01  5.39613672e+01  9.36424429e+01
  3.55921602e+02  1.34925226e+03  5.83567318e+03  3.50982809e+04]
E1 = -182.61565934111616  E_coul = 54.124970030713484
cycle= 6 E= -128.490689310403  delta_E= -1.3e-11  |g|= 1.36e-06  |ddm|= 2.53e-05
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.61565934111616  E_coul = 54.124970030713484
  HOMO = -0.832536241024948  LUMO = 0.891383730851259
  mo_energy =
[-3.27662925e+01 -1.91895846e+00 -8.32536241e-01 -8.32536241e-01
 -8.32536241e-01  8.91383731e-01  8.91383731e-01  8.91383731e-01
  2.01621867e+00  3.11662132e+00  3.11662132e+00  3.11662132e+00
  1.08438778e+01  1.08438778e+01  1.08438778e+01  1.92878128e+01
  5.39613657e+01  5.39613657e+01  5.39613657e+01  9.36424414e+01
  3.55921601e+02  1.34925226e+03  5.83567317e+03  3.50982809e+04]
E1 = -182.61566194415946  E_coul = 54.12497263375662
Extra cycle  E= -128.490689310403  delta_E= -1.71e-13  |g|= 4.05e-07  |ddm|= 2.44e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 415.3107747172099
E1 = -182.61566194415946  E_coul = 54.12497263375662
init E= -128.490689310403
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.832536070104473  LUMO = 0.89138375792258
  mo_energy =
[-3.27662918e+01 -1.91895829e+00 -8.32536070e-01 -8.32536070e-01
 -8.32536070e-01  8.91383758e-01  8.91383758e-01  8.91383758e-01
  2.01621877e+00  3.11662141e+00  3.11662141e+00  3.11662141e+00
  1.08438781e+01  1.08438781e+01  1.08438781e+01  1.92878132e+01
  5.39613663e+01  5.39613663e+01  5.39613663e+01  9.36424420e+01
  3.55921601e+02  1.34925226e+03  5.83567318e+03  3.50982809e+04]
E1 = -182.61566038943263  E_coul = 54.12497107902988
cycle= 1 E= -128.490689310403  delta_E= 8.53e-14  |g|= 2.08e-07  |ddm|= 5.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61566038943263  E_coul = 54.12497107902988
  HOMO = -0.832536180787097  LUMO = 0.891383732788341
  mo_energy =
[-3.27662922e+01 -1.91895841e+00 -8.32536181e-01 -8.32536181e-01
 -8.32536181e-01  8.91383733e-01  8.91383733e-01  8.91383733e-01
  2.01621869e+00  3.11662134e+00  3.11662134e+00  3.11662134e+00
  1.08438779e+01  1.08438779e+01  1.08438779e+01  1.92878130e+01
  5.39613660e+01  5.39613660e+01  5.39613660e+01  9.36424417e+01
  3.55921601e+02  1.34925226e+03  5.83567318e+03  3.50982809e+04]
E1 = -182.61566110010733  E_coul = 54.124971789704546
Extra cycle  E= -128.490689310403  delta_E= -2.84e-14  |g|= 9.68e-08  |ddm|= 7.86e-08
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907020e+02
 2.04816959e+01 5.69551058e+01 4.87261258e-01 7.81995433e+00
 1.65427173e+00 1.70675337e+00 6.26973772e+00 2.83916912e+01
 3.92295210e-01 5.02011696e-01]
grad_E = [ 1.05398633e-12  1.66262661e-10 -3.24265441e-09  3.59490632e-08
  1.64236175e-06 -2.43846403e-07  2.66023876e-04 -3.27013295e-06
 -9.38615624e-05 -5.42795979e-03 -3.58204587e-04  3.14962512e-05
  4.72521424e-02 -2.38630509e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482401        1
[INPUT] 0    0    [1    /1   ]  174.90701929         1
[INPUT] 0    0    [1    /1   ]  20.4816862954        1
[INPUT] 0    0    [1    /1   ]  56.9551072286        1
[INPUT] 0    0    [1    /1   ]  0.486929763506       1
[INPUT] 0    0    [1    /1   ]  7.81997304181        1
[INPUT] 0    0    [1    /1   ]  1.6546567955         1
[INPUT] 1    0    [1    /1   ]  1.7861799497         1
[INPUT] 1    0    [1    /1   ]  6.2652970996         1
[INPUT] 1    0    [1    /1   ]  28.3917611495        1
[INPUT] 1    0    [1    /1   ]  1.00000008274e-09      1
[INPUT] 1    0    [1    /1   ]  0.617870446259       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025563, 1.0]], [0, [2712.0968240731877, 1.0]], [0, [617.4984824011269, 1.0]], [0, [174.9070192895602, 1.0]], [0, [20.48168629540723, 1.0]], [0, [56.955107228589405, 1.0]], [0, [0.4869297635055647, 1.0]], [0, [7.819973041810812, 1.0]], [0, [1.6546567954967948, 1.0]], [1, [1.7861799496957609, 1.0]], [1, [6.2652970996030275, 1.0]], [1, [28.391761149473698, 1.0]], [1, [1.000000082740371e-09, 1.0]], [1, [0.6178704462585701, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.4984824]
bas 3, expnt(s) = [174.90701929]
bas 4, expnt(s) = [20.4816863]
bas 5, expnt(s) = [56.95510723]
bas 6, expnt(s) = [0.48692976]
bas 7, expnt(s) = [7.81997304]
bas 8, expnt(s) = [1.6546568]
bas 9, expnt(s) = [1.78617995]
bas 10, expnt(s) = [6.2652971]
bas 11, expnt(s) = [28.39176115]
bas 12, expnt(s) = [1.00000008e-09]
bas 13, expnt(s) = [0.61787045]
CPU time:         9.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816863e+01 2.43242415e+01 5.69551072e+01 5.23798837e+01
 4.86929764e-01 1.47270162e+00 7.81997304e+00 1.18145985e+01
 1.65465680e+00 3.68592055e+00 1.78617995e+00 6.02408242e+00
 6.26529710e+00 2.89175490e+01 2.83917611e+01 1.91194242e+02
 1.00000008e-09 1.64053099e-11 6.17870446e-01 1.59810817e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.953493214303
cond(S) = 239.35421606231705
E1 = -183.30351952791423  E_coul = 55.00733899682567
init E= -128.296180531089
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.758691181095497  LUMO = -0.000336415183520747
  mo_energy =
[-3.25601004e+01 -1.85994852e+00 -7.58691181e-01 -7.58691181e-01
 -7.58691181e-01 -3.36415184e-04 -3.36415184e-04 -3.36415184e-04
  2.05337443e+00  2.22829003e+00  2.22829003e+00  2.22829003e+00
  1.04466621e+01  1.04466621e+01  1.04466621e+01  1.94171152e+01
  5.39345772e+01  5.39345772e+01  5.39345772e+01  9.38344365e+01
  3.56148954e+02  1.34951019e+03  5.83595944e+03  3.50985874e+04]
E1 = -183.33779224611348  E_coul = 54.937597351144035
cycle= 1 E= -128.400194894969  delta_E= -0.104  |g|= 0.0718  |ddm|= 0.228
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.130261
diis-c [-0.01696799  1.        ]
  HOMO = -0.749213093811002  LUMO = -0.000336415183522133
  mo_energy =
[-3.26429885e+01 -1.84085153e+00 -7.49213094e-01 -7.49213094e-01
 -7.49213094e-01 -3.36415184e-04 -3.36415184e-04 -3.36415184e-04
  2.07981542e+00  2.24771075e+00  2.24771075e+00  2.24771075e+00
  1.04414066e+01  1.04414066e+01  1.04414066e+01  1.93958559e+01
  5.38677804e+01  5.38677804e+01  5.38677804e+01  9.37632733e+01
  3.56043760e+02  1.34937242e+03  5.83579149e+03  3.50983983e+04]
E1 = -183.4749611100485  E_coul = 55.07447065351133
cycle= 2 E= -128.400490456537  delta_E= -0.000296  |g|= 0.0194  |ddm|= 0.0259
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0348254
diis-c [-4.35759275e-04  1.78171972e-01  8.21828028e-01]
  HOMO = -0.741516495783148  LUMO = -0.000336415183519886
  mo_energy =
[-3.26186142e+01 -1.83205803e+00 -7.41516496e-01 -7.41516496e-01
 -7.41516496e-01 -3.36415184e-04 -3.36415184e-04 -3.36415184e-04
  2.08575061e+00  2.25278088e+00  2.25278088e+00  2.25278088e+00
  1.04545429e+01  1.04545429e+01  1.04545429e+01  1.94126050e+01
  5.38900222e+01  5.38900222e+01  5.38900222e+01  9.37863531e+01
  3.56069926e+02  1.34939999e+03  5.83581963e+03  3.50984266e+04]
E1 = -183.43221220035718  E_coul = 55.031694515733804
cycle= 3 E= -128.400517684623  delta_E= -2.72e-05  |g|= 0.00295  |ddm|= 0.0069
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00616986
diis-c [-5.50343139e-06 -1.44937964e-02  1.06140717e-01  9.08353079e-01]
  HOMO = -0.742437043271665  LUMO = -0.000336415183527949
  mo_energy =
[-3.26216149e+01 -1.83253425e+00 -7.42437043e-01 -7.42437043e-01
 -7.42437043e-01 -3.36415184e-04 -3.36415184e-04 -3.36415184e-04
  2.08550549e+00  2.25219491e+00  2.25219491e+00  2.25219491e+00
  1.04530530e+01  1.04530530e+01  1.04530530e+01  1.94108367e+01
  5.38873627e+01  5.38873627e+01  5.38873627e+01  9.37835895e+01
  3.56066612e+02  1.34939628e+03  5.83581566e+03  3.50984225e+04]
E1 = -183.43748325515915  E_coul = 55.0369646217504
cycle= 4 E= -128.400518633409  delta_E= -9.49e-07  |g|= 0.000345  |ddm|= 0.00114
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000533629
diis-c [-1.07711012e-08  1.01933545e-03 -1.90085121e-02 -1.97151983e-01
  1.21514116e+00]
  HOMO = -0.742490535381714  LUMO = -0.000336415183526166
  mo_energy =
[-3.26217141e+01 -1.83247890e+00 -7.42490535e-01 -7.42490535e-01
 -7.42490535e-01 -3.36415184e-04 -3.36415184e-04 -3.36415184e-04
  2.08554984e+00  2.25215914e+00  2.25215914e+00  2.25215914e+00
  1.04529929e+01  1.04529929e+01  1.04529929e+01  1.94108095e+01
  5.38872815e+01  5.38872815e+01  5.38872815e+01  9.37835007e+01
  3.56066453e+02  1.34939604e+03  5.83581536e+03  3.50984222e+04]
E1 = -183.43760923366162  E_coul = 55.03709058301597
cycle= 5 E= -128.400518650646  delta_E= -1.72e-08  |g|= 1.35e-05  |ddm|= 0.000254
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.65812e-05
diis-c [-1.42434501e-11 -5.75792130e-05  1.85137110e-03  1.17163399e-02
 -8.06560266e-02  1.06714589e+00]
  HOMO = -0.742496662441607  LUMO = -0.000336415183520289
  mo_energy =
[-3.26217279e+01 -1.83248525e+00 -7.42496662e-01 -7.42496662e-01
 -7.42496662e-01 -3.36415184e-04 -3.36415184e-04 -3.36415184e-04
  2.08554526e+00  2.25215501e+00  2.25215501e+00  2.25215501e+00
  1.04529833e+01  1.04529833e+01  1.04529833e+01  1.94107986e+01
  5.38872683e+01  5.38872683e+01  5.38872683e+01  9.37834871e+01
  3.56066437e+02  1.34939602e+03  5.83581534e+03  3.50984222e+04]
E1 = -183.43763330241202  E_coul = 55.037114651754806
cycle= 6 E= -128.400518650657  delta_E= -1.15e-11  |g|= 2.94e-07  |ddm|= 3.41e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -183.43763330241202  E_coul = 55.037114651754806
  HOMO = -0.742496492442552  LUMO = -0.000336415183526641
  mo_energy =
[-3.26217274e+01 -1.83248508e+00 -7.42496492e-01 -7.42496492e-01
 -7.42496492e-01 -3.36415184e-04 -3.36415184e-04 -3.36415184e-04
  2.08554538e+00  2.25215512e+00  2.25215512e+00  2.25215512e+00
  1.04529836e+01  1.04529836e+01  1.04529836e+01  1.94107989e+01
  5.38872687e+01  5.38872687e+01  5.38872687e+01  9.37834875e+01
  3.56066437e+02  1.34939602e+03  5.83581534e+03  3.50984222e+04]
E1 = -183.43763253180472  E_coul = 55.037113881147775
Extra cycle  E= -128.400518650657  delta_E= 2.56e-13  |g|= 1.05e-07  |ddm|= 9.99e-08
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816863e+01 5.69551072e+01 4.86929764e-01 7.81997304e+00
 1.65465680e+00 1.78617995e+00 6.26529710e+00 2.83917611e+01
 1.00000008e-09 6.17870446e-01]
E = -128.40051865065695
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482382        1
[INPUT] 0    0    [1    /1   ]  174.90701949         1
[INPUT] 0    0    [1    /1   ]  20.4816949584        1
[INPUT] 0    0    [1    /1   ]  56.9551059128        1
[INPUT] 0    0    [1    /1   ]  0.487228108807       1
[INPUT] 0    0    [1    /1   ]  7.81995620454        1
[INPUT] 0    0    [1    /1   ]  1.65431023891        1
[INPUT] 1    0    [1    /1   ]  1.71469602354        1
[INPUT] 1    0    [1    /1   ]  6.26929365629        1
[INPUT] 1    0    [1    /1   ]  28.3916981988        1
[INPUT] 1    0    [1    /1   ]  0.353065688983       1
[INPUT] 1    0    [1    /1   ]  0.513597571052       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002558, 1.0]], [0, [2712.096824074176, 1.0]], [0, [617.4984823816284, 1.0]], [0, [174.90701949049924, 1.0]], [0, [20.481694958361885, 1.0]], [0, [56.955105912758896, 1.0]], [0, [0.48722810880653655, 1.0]], [0, [7.819956204540116, 1.0]], [0, [1.6543102389095918, 1.0]], [1, [1.7146960235363216, 1.0]], [1, [6.26929365629029, 1.0]], [1, [28.391698198753208, 1.0]], [1, [0.3530656889830757, 1.0]], [1, [0.5135975710519803, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848238]
bas 3, expnt(s) = [174.90701949]
bas 4, expnt(s) = [20.48169496]
bas 5, expnt(s) = [56.95510591]
bas 6, expnt(s) = [0.48722811]
bas 7, expnt(s) = [7.8199562]
bas 8, expnt(s) = [1.65431024]
bas 9, expnt(s) = [1.71469602]
bas 10, expnt(s) = [6.26929366]
bas 11, expnt(s) = [28.3916982]
bas 12, expnt(s) = [0.35306569]
bas 13, expnt(s) = [0.51359757]
CPU time:         9.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816950e+01 2.43242492e+01 5.69551059e+01 5.23798828e+01
 4.87228109e-01 1.47337832e+00 7.81995620e+00 1.18145794e+01
 1.65431024e+00 3.68534154e+00 1.71469602e+00 5.72424638e+00
 6.26929366e+00 2.89406085e+01 2.83916982e+01 1.91193712e+02
 3.53065689e-01 7.93969439e-01 5.13597571e-01 1.26842004e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.994497372955854
cond(S) = 239.35753824957396
E1 = -183.5201915724703  E_coul = 55.06753746823889
init E= -128.452654104231
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.768938785509193  LUMO = 0.851031279410695
  mo_energy =
[-3.25566853e+01 -1.85251659e+00 -7.68938786e-01 -7.68938786e-01
 -7.68938786e-01  8.51031279e-01  8.51031279e-01  8.51031279e-01
  2.05866494e+00  3.06211243e+00  3.06211243e+00  3.06211243e+00
  1.08722193e+01  1.08722193e+01  1.08722193e+01  1.94263853e+01
  5.41052593e+01  5.41052593e+01  5.41052593e+01  9.38384501e+01
  3.56154919e+02  1.34951865e+03  5.83596877e+03  3.50985970e+04]
E1 = -182.10184077774184  E_coul = 53.611952098397175
cycle= 1 E= -128.489888679345  delta_E= -0.0372  |g|=  0.2  |ddm|= 0.188
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.479926
diis-c [-0.23032867  1.        ]
  HOMO = -0.869565199541503  LUMO = 0.833309809080908
  mo_energy =
[-3.28748413e+01 -1.95790952e+00 -8.69565200e-01 -8.69565200e-01
 -8.69565200e-01  8.33309809e-01  8.33309809e-01  8.33309809e-01
  1.98940666e+00  2.99952717e+00  2.99952717e+00  2.99952717e+00
  1.07064673e+01  1.07064673e+01  1.07064673e+01  1.92125285e+01
  5.38173405e+01  5.38173405e+01  5.38173405e+01  9.35398700e+01
  3.55806382e+02  1.34913091e+03  5.83554895e+03  3.50981555e+04]
E1 = -182.82408032381167  E_coul = 54.33164951191461
cycle= 2 E= -128.492430811897  delta_E= -0.00254  |g|= 0.0975  |ddm|= 0.0981
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.235517
diis-c [-4.89317225e-04  3.28447958e-01  6.71552042e-01]
  HOMO = -0.835433132717718  LUMO = 0.840361284439294
  mo_energy =
[-3.27710044e+01 -1.92194012e+00 -8.35433133e-01 -8.35433133e-01
 -8.35433133e-01  8.40361284e-01  8.40361284e-01  8.40361284e-01
  2.01366988e+00  3.02148913e+00  3.02148913e+00  3.02148913e+00
  1.07620042e+01  1.07620042e+01  1.07620042e+01  1.92837159e+01
  5.39119609e+01  5.39119609e+01  5.39119609e+01  9.36378618e+01
  3.55916947e+02  1.34924770e+03  5.83566872e+03  3.50982765e+04]
E1 = -182.59046668567595  E_coul = 54.09724428357926
cycle= 3 E= -128.493222402097  delta_E= -0.000792  |g|= 0.000829  |ddm|= 0.0262
    CPU time for cycle= 3      0.02 sec, wall time      0.04 sec
diis-norm(errvec)=0.000530391
diis-c [-1.89965163e-07 -1.32278058e-03 -3.90291275e-03  1.00522569e+00]
  HOMO = -0.835246592700335  LUMO = 0.840489800124659
  mo_energy =
[-3.27707380e+01 -1.92164652e+00 -8.35246593e-01 -8.35246593e-01
 -8.35246593e-01  8.40489800e-01  8.40489800e-01  8.40489800e-01
  2.01398254e+00  3.02172662e+00  3.02172662e+00  3.02172662e+00
  1.07623005e+01  1.07623005e+01  1.07623005e+01  1.92840159e+01
  5.39122440e+01  5.39122440e+01  5.39122440e+01  9.36381422e+01
  3.55917199e+02  1.34924790e+03  5.83566887e+03  3.50982766e+04]
E1 = -182.59050877481448  E_coul = 54.097286251860396
cycle= 4 E= -128.493222522954  delta_E= -1.21e-07  |g|= 0.000128  |ddm|= 0.00154
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000102469
diis-c [-2.80137720e-09  3.74463942e-04  1.18219367e-03 -2.43509062e-01
  1.24195240e+00]
  HOMO = -0.835210739950812  LUMO = 0.840506702673179
  mo_energy =
[-3.27706993e+01 -1.92158418e+00 -8.35210740e-01 -8.35210740e-01
 -8.35210740e-01  8.40506703e-01  8.40506703e-01  8.40506703e-01
  2.01403944e+00  3.02176278e+00  3.02176278e+00  3.02176278e+00
  1.07623466e+01  1.07623466e+01  1.07623466e+01  1.92840662e+01
  5.39122863e+01  5.39122863e+01  5.39122863e+01  9.36381831e+01
  3.55917231e+02  1.34924792e+03  5.83566888e+03  3.50982766e+04]
E1 = -182.59059576901018  E_coul = 54.09737324263341
cycle= 5 E= -128.493222526377  delta_E= -3.42e-09  |g|= 6.86e-06  |ddm|= 0.000292
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.11874e-06
diis-c [-1.22649507e-11 -1.08019065e-05 -2.36613982e-05  1.72636185e-02
 -1.13782988e-01  1.09655383e+00]
  HOMO = -0.835211817317199  LUMO = 0.840506186880249
  mo_energy =
[-3.27707015e+01 -1.92158399e+00 -8.35211817e-01 -8.35211817e-01
 -8.35211817e-01  8.40506187e-01  8.40506187e-01  8.40506187e-01
  2.01403937e+00  3.02176182e+00  3.02176182e+00  3.02176182e+00
  1.07623455e+01  1.07623455e+01  1.07623455e+01  1.92840657e+01
  5.39122845e+01  5.39122845e+01  5.39122845e+01  9.36381811e+01
  3.55917227e+02  1.34924792e+03  5.83566888e+03  3.50982766e+04]
E1 = -182.59059422300376  E_coul = 54.09737169662054
cycle= 6 E= -128.493222526383  delta_E= -6.45e-12  |g|= 1.22e-06  |ddm|= 9.73e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.59059422300376  E_coul = 54.09737169662054
  HOMO = -0.83521254878845  LUMO = 0.840505984262679
  mo_energy =
[-3.27707030e+01 -1.92158475e+00 -8.35212549e-01 -8.35212549e-01
 -8.35212549e-01  8.40505984e-01  8.40505984e-01  8.40505984e-01
  2.01403877e+00  3.02176128e+00  3.02176128e+00  3.02176128e+00
  1.07623444e+01  1.07623444e+01  1.07623444e+01  1.92840644e+01
  5.39122830e+01  5.39122830e+01  5.39122830e+01  9.36381797e+01
  3.55917226e+02  1.34924792e+03  5.83566888e+03  3.50982766e+04]
E1 = -182.5905968686676  E_coul = 54.097374342284496
Extra cycle  E= -128.493222526383  delta_E= 1.14e-13  |g|= 4e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.15 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816950e+01 5.69551059e+01 4.87228109e-01 7.81995620e+00
 1.65431024e+00 1.71469602e+00 6.26929366e+00 2.83916982e+01
 3.53065689e-01 5.13597571e-01]
E = -128.4932225263831
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482382        1
[INPUT] 0    0    [1    /1   ]  174.90701949         1
[INPUT] 0    0    [1    /1   ]  20.4816949584        1
[INPUT] 0    0    [1    /1   ]  56.9551059128        1
[INPUT] 0    0    [1    /1   ]  0.487228108807       1
[INPUT] 0    0    [1    /1   ]  7.81995620454        1
[INPUT] 0    0    [1    /1   ]  1.65431023891        1
[INPUT] 1    0    [1    /1   ]  1.71469602354        1
[INPUT] 1    0    [1    /1   ]  6.26929365629        1
[INPUT] 1    0    [1    /1   ]  28.3916981988        1
[INPUT] 1    0    [1    /1   ]  0.353065688983       1
[INPUT] 1    0    [1    /1   ]  0.513597571052       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002558, 1.0]], [0, [2712.096824074176, 1.0]], [0, [617.4984823816284, 1.0]], [0, [174.90701949049924, 1.0]], [0, [20.481694958361885, 1.0]], [0, [56.955105912758896, 1.0]], [0, [0.48722810880653655, 1.0]], [0, [7.819956204540116, 1.0]], [0, [1.6543102389095918, 1.0]], [1, [1.7146960235363216, 1.0]], [1, [6.26929365629029, 1.0]], [1, [28.391698198753208, 1.0]], [1, [0.3530656889830757, 1.0]], [1, [0.5135975710519803, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848238]
bas 3, expnt(s) = [174.90701949]
bas 4, expnt(s) = [20.48169496]
bas 5, expnt(s) = [56.95510591]
bas 6, expnt(s) = [0.48722811]
bas 7, expnt(s) = [7.8199562]
bas 8, expnt(s) = [1.65431024]
bas 9, expnt(s) = [1.71469602]
bas 10, expnt(s) = [6.26929366]
bas 11, expnt(s) = [28.3916982]
bas 12, expnt(s) = [0.35306569]
bas 13, expnt(s) = [0.51359757]
CPU time:         9.97
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816950e+01 2.43242492e+01 5.69551059e+01 5.23798828e+01
 4.87228109e-01 1.47337832e+00 7.81995620e+00 1.18145794e+01
 1.65431024e+00 3.68534154e+00 1.71469602e+00 5.72424638e+00
 6.26929366e+00 2.89406085e+01 2.83916982e+01 1.91193712e+02
 3.53065689e-01 7.93969439e-01 5.13597571e-01 1.26842004e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.994497372955854
cond(S) = 239.35753824957396
E1 = -183.5201915724703  E_coul = 55.06753746823889
init E= -128.452654104231
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.768938785509193  LUMO = 0.851031279410695
  mo_energy =
[-3.25566853e+01 -1.85251659e+00 -7.68938786e-01 -7.68938786e-01
 -7.68938786e-01  8.51031279e-01  8.51031279e-01  8.51031279e-01
  2.05866494e+00  3.06211243e+00  3.06211243e+00  3.06211243e+00
  1.08722193e+01  1.08722193e+01  1.08722193e+01  1.94263853e+01
  5.41052593e+01  5.41052593e+01  5.41052593e+01  9.38384501e+01
  3.56154919e+02  1.34951865e+03  5.83596877e+03  3.50985970e+04]
E1 = -182.10184077774184  E_coul = 53.611952098397175
cycle= 1 E= -128.489888679345  delta_E= -0.0372  |g|=  0.2  |ddm|= 0.188
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.479926
diis-c [-0.23032867  1.        ]
  HOMO = -0.869565199541503  LUMO = 0.833309809080908
  mo_energy =
[-3.28748413e+01 -1.95790952e+00 -8.69565200e-01 -8.69565200e-01
 -8.69565200e-01  8.33309809e-01  8.33309809e-01  8.33309809e-01
  1.98940666e+00  2.99952717e+00  2.99952717e+00  2.99952717e+00
  1.07064673e+01  1.07064673e+01  1.07064673e+01  1.92125285e+01
  5.38173405e+01  5.38173405e+01  5.38173405e+01  9.35398700e+01
  3.55806382e+02  1.34913091e+03  5.83554895e+03  3.50981555e+04]
E1 = -182.82408032381167  E_coul = 54.33164951191461
cycle= 2 E= -128.492430811897  delta_E= -0.00254  |g|= 0.0975  |ddm|= 0.0981
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.235517
diis-c [-4.89317225e-04  3.28447958e-01  6.71552042e-01]
  HOMO = -0.835433132717718  LUMO = 0.840361284439294
  mo_energy =
[-3.27710044e+01 -1.92194012e+00 -8.35433133e-01 -8.35433133e-01
 -8.35433133e-01  8.40361284e-01  8.40361284e-01  8.40361284e-01
  2.01366988e+00  3.02148913e+00  3.02148913e+00  3.02148913e+00
  1.07620042e+01  1.07620042e+01  1.07620042e+01  1.92837159e+01
  5.39119609e+01  5.39119609e+01  5.39119609e+01  9.36378618e+01
  3.55916947e+02  1.34924770e+03  5.83566872e+03  3.50982765e+04]
E1 = -182.59046668567595  E_coul = 54.09724428357926
cycle= 3 E= -128.493222402097  delta_E= -0.000792  |g|= 0.000829  |ddm|= 0.0262
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000530391
diis-c [-1.89965163e-07 -1.32278058e-03 -3.90291275e-03  1.00522569e+00]
  HOMO = -0.835246592700335  LUMO = 0.840489800124659
  mo_energy =
[-3.27707380e+01 -1.92164652e+00 -8.35246593e-01 -8.35246593e-01
 -8.35246593e-01  8.40489800e-01  8.40489800e-01  8.40489800e-01
  2.01398254e+00  3.02172662e+00  3.02172662e+00  3.02172662e+00
  1.07623005e+01  1.07623005e+01  1.07623005e+01  1.92840159e+01
  5.39122440e+01  5.39122440e+01  5.39122440e+01  9.36381422e+01
  3.55917199e+02  1.34924790e+03  5.83566887e+03  3.50982766e+04]
E1 = -182.59050877481448  E_coul = 54.097286251860396
cycle= 4 E= -128.493222522954  delta_E= -1.21e-07  |g|= 0.000128  |ddm|= 0.00154
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000102469
diis-c [-2.80137720e-09  3.74463942e-04  1.18219367e-03 -2.43509062e-01
  1.24195240e+00]
  HOMO = -0.835210739950812  LUMO = 0.840506702673179
  mo_energy =
[-3.27706993e+01 -1.92158418e+00 -8.35210740e-01 -8.35210740e-01
 -8.35210740e-01  8.40506703e-01  8.40506703e-01  8.40506703e-01
  2.01403944e+00  3.02176278e+00  3.02176278e+00  3.02176278e+00
  1.07623466e+01  1.07623466e+01  1.07623466e+01  1.92840662e+01
  5.39122863e+01  5.39122863e+01  5.39122863e+01  9.36381831e+01
  3.55917231e+02  1.34924792e+03  5.83566888e+03  3.50982766e+04]
E1 = -182.59059576901018  E_coul = 54.09737324263341
cycle= 5 E= -128.493222526377  delta_E= -3.42e-09  |g|= 6.86e-06  |ddm|= 0.000292
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.11874e-06
diis-c [-1.22649507e-11 -1.08019065e-05 -2.36613982e-05  1.72636185e-02
 -1.13782988e-01  1.09655383e+00]
  HOMO = -0.835211817317199  LUMO = 0.840506186880249
  mo_energy =
[-3.27707015e+01 -1.92158399e+00 -8.35211817e-01 -8.35211817e-01
 -8.35211817e-01  8.40506187e-01  8.40506187e-01  8.40506187e-01
  2.01403937e+00  3.02176182e+00  3.02176182e+00  3.02176182e+00
  1.07623455e+01  1.07623455e+01  1.07623455e+01  1.92840657e+01
  5.39122845e+01  5.39122845e+01  5.39122845e+01  9.36381811e+01
  3.55917227e+02  1.34924792e+03  5.83566888e+03  3.50982766e+04]
E1 = -182.59059422300376  E_coul = 54.09737169662054
cycle= 6 E= -128.493222526383  delta_E= -6.45e-12  |g|= 1.22e-06  |ddm|= 9.73e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.59059422300376  E_coul = 54.09737169662054
  HOMO = -0.83521254878845  LUMO = 0.840505984262679
  mo_energy =
[-3.27707030e+01 -1.92158475e+00 -8.35212549e-01 -8.35212549e-01
 -8.35212549e-01  8.40505984e-01  8.40505984e-01  8.40505984e-01
  2.01403877e+00  3.02176128e+00  3.02176128e+00  3.02176128e+00
  1.07623444e+01  1.07623444e+01  1.07623444e+01  1.92840644e+01
  5.39122830e+01  5.39122830e+01  5.39122830e+01  9.36381797e+01
  3.55917226e+02  1.34924792e+03  5.83566888e+03  3.50982766e+04]
E1 = -182.5905968686676  E_coul = 54.097374342284496
Extra cycle  E= -128.493222526383  delta_E= 1.14e-13  |g|= 4e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.35753824957396
E1 = -182.5905968686676  E_coul = 54.097374342284496
init E= -128.493222526383
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.835212374037214  LUMO = 0.840506011930425
  mo_energy =
[-3.27707024e+01 -1.92158458e+00 -8.35212374e-01 -8.35212374e-01
 -8.35212374e-01  8.40506012e-01  8.40506012e-01  8.40506012e-01
  2.01403888e+00  3.02176138e+00  3.02176138e+00  3.02176138e+00
  1.07623447e+01  1.07623447e+01  1.07623447e+01  1.92840648e+01
  5.39122836e+01  5.39122836e+01  5.39122836e+01  9.36381803e+01
  3.55917226e+02  1.34924792e+03  5.83566888e+03  3.50982766e+04]
E1 = -182.59059532674303  E_coul = 54.09737280036003
cycle= 1 E= -128.493222526383  delta_E= 1.14e-13  |g|= 2.06e-07  |ddm|= 3.48e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59059532674303  E_coul = 54.09737280036003
  HOMO = -0.835212483906279  LUMO = 0.840505988463898
  mo_energy =
[-3.27707027e+01 -1.92158469e+00 -8.35212484e-01 -8.35212484e-01
 -8.35212484e-01  8.40505988e-01  8.40505988e-01  8.40505988e-01
  2.01403880e+00  3.02176131e+00  3.02176131e+00  3.02176131e+00
  1.07623445e+01  1.07623445e+01  1.07623445e+01  1.92840646e+01
  5.39122833e+01  5.39122833e+01  5.39122833e+01  9.36381800e+01
  3.55917226e+02  1.34924792e+03  5.83566888e+03  3.50982766e+04]
E1 = -182.59059604452696  E_coul = 54.09737351814385
Extra cycle  E= -128.493222526383  delta_E= -1.14e-13  |g|= 9.77e-08  |ddm|= 7.5e-08
    CPU time for scf_cycle      0.22 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816950e+01 5.69551059e+01 4.87228109e-01 7.81995620e+00
 1.65431024e+00 1.71469602e+00 6.26929366e+00 2.83916982e+01
 3.53065689e-01 5.13597571e-01]
grad_E = [ 8.16114813e-13  1.77438938e-10 -3.50220885e-09  3.82466694e-08
  1.55524818e-06 -2.63457150e-07  8.51718562e-05 -2.75338014e-06
 -1.82205623e-05 -6.36218793e-03 -6.84586751e-04  5.30607416e-05
  5.96940306e-02 -4.22061896e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482402        1
[INPUT] 0    0    [1    /1   ]  174.907019282        1
[INPUT] 0    0    [1    /1   ]  20.4816865595        1
[INPUT] 0    0    [1    /1   ]  56.9551072754        1
[INPUT] 0    0    [1    /1   ]  0.487704602273       1
[INPUT] 0    0    [1    /1   ]  7.81997157814        1
[INPUT] 0    0    [1    /1   ]  1.65442917954        1
[INPUT] 1    0    [1    /1   ]  1.80129567613        1
[INPUT] 1    0    [1    /1   ]  6.26425726067        1
[INPUT] 1    0    [1    /1   ]  28.3917812832        1
[INPUT] 1    0    [1    /1   ]  1.00000002723e-09      1
[INPUT] 1    0    [1    /1   ]  0.653807356358       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025563, 1.0]], [0, [2712.0968240731327, 1.0]], [0, [617.4984824023579, 1.0]], [0, [174.90701928193843, 1.0]], [0, [20.48168655953995, 1.0]], [0, [56.95510727539505, 1.0]], [0, [0.48770460227306517, 1.0]], [0, [7.81997157813874, 1.0]], [0, [1.6544291795428516, 1.0]], [1, [1.8012956761328627, 1.0]], [1, [6.264257260674792, 1.0]], [1, [28.39178128317706, 1.0]], [1, [1.0000000272292198e-09, 1.0]], [1, [0.6538073563582534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.4984824]
bas 3, expnt(s) = [174.90701928]
bas 4, expnt(s) = [20.48168656]
bas 5, expnt(s) = [56.95510728]
bas 6, expnt(s) = [0.4877046]
bas 7, expnt(s) = [7.81997158]
bas 8, expnt(s) = [1.65442918]
bas 9, expnt(s) = [1.80129568]
bas 10, expnt(s) = [6.26425726]
bas 11, expnt(s) = [28.39178128]
bas 12, expnt(s) = [1.00000003e-09]
bas 13, expnt(s) = [0.65380736]
CPU time:        12.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816866e+01 2.43242417e+01 5.69551073e+01 5.23798837e+01
 4.87704602e-01 1.47445888e+00 7.81997158e+00 1.18145968e+01
 1.65442918e+00 3.68554026e+00 1.80129568e+00 6.08787394e+00
 6.26425726e+00 2.89115499e+01 2.83917813e+01 1.91194411e+02
 1.00000003e-09 1.64053087e-11 6.53807356e-01 1.71512843e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.941881824545819
cond(S) = 239.39497957893045
E1 = -183.21717036902604  E_coul = 54.97830402749602
init E= -128.23886634153
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.756267806967542  LUMO = -0.000336415174186921
  mo_energy =
[-3.25626030e+01 -1.86323792e+00 -7.56267807e-01 -7.56267807e-01
 -7.56267807e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  2.05281192e+00  2.33361805e+00  2.33361805e+00  2.33361805e+00
  1.06165112e+01  1.06165112e+01  1.06165112e+01  1.94161068e+01
  5.40724944e+01  5.40724944e+01  5.40724944e+01  9.38338715e+01
  3.56147825e+02  1.34950848e+03  5.83595741e+03  3.50985851e+04]
E1 = -183.54818796722043  E_coul = 55.17916605139257
cycle= 1 E= -128.369021915828  delta_E= -0.13  |g|= 0.0696  |ddm|= 0.281
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101859
diis-c [-0.01037535  1.        ]
  HOMO = -0.725314767712771  LUMO = -0.00033641517419003
  mo_energy =
[-3.25987106e+01 -1.82038729e+00 -7.25314768e-01 -7.25314768e-01
 -7.25314768e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  2.09766026e+00  2.37059463e+00  2.37059463e+00  2.37059463e+00
  1.06432800e+01  1.06432800e+01  1.06432800e+01  1.94323420e+01
  5.40496978e+01  5.40496978e+01  5.40496978e+01  9.38077790e+01
  3.56091002e+02  1.34942035e+03  5.83583945e+03  3.50984461e+04]
E1 = -183.59947338152136  E_coul = 55.230206088949856
cycle= 2 E= -128.369267292572  delta_E= -0.000245  |g|= 0.00953  |ddm|= 0.0247
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0129898
diis-c [-1.59266149e-04  2.95443539e-02  9.70455646e-01]
  HOMO = -0.722042371701516  LUMO = -0.000336415174186624
  mo_energy =
[-3.25885285e+01 -1.81563277e+00 -7.22042372e-01 -7.22042372e-01
 -7.22042372e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  2.10101426e+00  2.37282415e+00  2.37282415e+00  2.37282415e+00
  1.06489855e+01  1.06489855e+01  1.06489855e+01  1.94398376e+01
  5.40591151e+01  5.40591151e+01  5.40591151e+01  9.38175740e+01
  3.56101924e+02  1.34943160e+03  5.83585069e+03  3.50984572e+04]
E1 = -183.58227154395465  E_coul = 55.21299614885088
cycle= 3 E= -128.369275395104  delta_E= -8.1e-06  |g|= 0.00241  |ddm|= 0.00496
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00510938
diis-c [-7.33654908e-06 -1.72956906e-02  2.18185902e-01  7.99109789e-01]
  HOMO = -0.722882759965308  LUMO = -0.000336415174183064
  mo_energy =
[-3.25911631e+01 -1.81615873e+00 -7.22882760e-01 -7.22882760e-01
 -7.22882760e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  2.10070562e+00  2.37226626e+00  2.37226626e+00  2.37226626e+00
  1.06476332e+01  1.06476332e+01  1.06476332e+01  1.94382304e+01
  5.40567654e+01  5.40567654e+01  5.40567654e+01  9.38151272e+01
  3.56098991e+02  1.34942831e+03  5.83584718e+03  3.50984536e+04]
E1 = -183.58667415170126  E_coul = 55.21739817666689
cycle= 4 E= -128.369275975034  delta_E= -5.8e-07  |g|= 0.000366  |ddm|= 0.000823
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000474314
diis-c [-1.24037212e-08  1.09631044e-03 -4.46287122e-02 -1.43549441e-01
  1.18708184e+00]
  HOMO = -0.722905673924648  LUMO = -0.000336415174183505
  mo_energy =
[-3.25911460e+01 -1.81606669e+00 -7.22905674e-01 -7.22905674e-01
 -7.22905674e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  2.10077280e+00  2.37224875e+00  2.37224875e+00  2.37224875e+00
  1.06476295e+01  1.06476295e+01  1.06476295e+01  1.94382796e+01
  5.40567891e+01  5.40567891e+01  5.40567891e+01  9.38151468e+01
  3.56098950e+02  1.34942819e+03  5.83584701e+03  3.50984534e+04]
E1 = -183.58657803949427  E_coul = 55.21730204584897
cycle= 5 E= -128.369275993645  delta_E= -1.86e-08  |g|= 1.56e-05  |ddm|= 0.000276
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.06709e-05
diis-c [-1.91024255e-11 -6.04298030e-05  3.66765950e-03  4.19552408e-03
 -6.87966560e-02  1.06099390e+00]
  HOMO = -0.722912717349658  LUMO = -0.000336415174193169
  mo_energy =
[-3.25911623e+01 -1.81607401e+00 -7.22912717e-01 -7.22912717e-01
 -7.22912717e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  2.10076759e+00  2.37224393e+00  2.37224393e+00  2.37224393e+00
  1.06476185e+01  1.06476185e+01  1.06476185e+01  1.94382669e+01
  5.40567735e+01  5.40567735e+01  5.40567735e+01  9.38151307e+01
  3.56098932e+02  1.34942817e+03  5.83584698e+03  3.50984534e+04]
E1 = -183.58660580247303  E_coul = 55.217329808812586
cycle= 6 E= -128.36927599366  delta_E= -1.51e-11  |g|= 3.72e-07  |ddm|= 4.07e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -183.58660580247303  E_coul = 55.217329808812586
  HOMO = -0.722912502551668  LUMO = -0.000336415174183089
  mo_energy =
[-3.25911618e+01 -1.81607379e+00 -7.22912503e-01 -7.22912503e-01
 -7.22912503e-01 -3.36415174e-04 -3.36415174e-04 -3.36415174e-04
  2.10076774e+00  2.37224408e+00  2.37224408e+00  2.37224408e+00
  1.06476188e+01  1.06476188e+01  1.06476188e+01  1.94382673e+01
  5.40567740e+01  5.40567740e+01  5.40567740e+01  9.38151313e+01
  3.56098932e+02  1.34942817e+03  5.83584699e+03  3.50984534e+04]
E1 = -183.58660483939667  E_coul = 55.21732884573604
Extra cycle  E= -128.369275993661  delta_E= -1.99e-13  |g|= 1.31e-07  |ddm|= 1.27e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816866e+01 5.69551073e+01 4.87704602e-01 7.81997158e+00
 1.65442918e+00 1.80129568e+00 6.26425726e+00 2.83917813e+01
 1.00000003e-09 6.53807356e-01]
E = -128.36927599366064
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482384        1
[INPUT] 0    0    [1    /1   ]  174.90701947         1
[INPUT] 0    0    [1    /1   ]  20.4816941185        1
[INPUT] 0    0    [1    /1   ]  56.955106049         1
[INPUT] 0    0    [1    /1   ]  0.487275758153       1
[INPUT] 0    0    [1    /1   ]  7.8199577419         1
[INPUT] 0    0    [1    /1   ]  1.65432213297        1
[INPUT] 1    0    [1    /1   ]  1.7233559888         1
[INPUT] 1    0    [1    /1   ]  6.26879001673        1
[INPUT] 1    0    [1    /1   ]  28.3917065072        1
[INPUT] 1    0    [1    /1   ]  0.317759120185       1
[INPUT] 1    0    [1    /1   ]  0.527618549583       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025578, 1.0]], [0, [2712.0968240740717, 1.0]], [0, [617.4984823837013, 1.0]], [0, [174.90701946964316, 1.0]], [0, [20.48169411847969, 1.0]], [0, [56.95510604902251, 1.0]], [0, [0.4872757581531894, 1.0]], [0, [7.819957741899978, 1.0]], [0, [1.6543221329729179, 1.0]], [1, [1.7233559887959757, 1.0]], [1, [6.26879001672874, 1.0]], [1, [28.391706507195593, 1.0]], [1, [0.31775912018476815, 1.0]], [1, [0.5276185495826077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848238]
bas 3, expnt(s) = [174.90701947]
bas 4, expnt(s) = [20.48169412]
bas 5, expnt(s) = [56.95510605]
bas 6, expnt(s) = [0.48727576]
bas 7, expnt(s) = [7.81995774]
bas 8, expnt(s) = [1.65432213]
bas 9, expnt(s) = [1.72335599]
bas 10, expnt(s) = [6.26879002]
bas 11, expnt(s) = [28.39170651]
bas 12, expnt(s) = [0.31775912]
bas 13, expnt(s) = [0.52761855]
CPU time:        12.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816941e+01 2.43242485e+01 5.69551060e+01 5.23798829e+01
 4.87275758e-01 1.47348639e+00 7.81995774e+00 1.18145811e+01
 1.65432213e+00 3.68536141e+00 1.72335599e+00 5.76040660e+00
 6.26879002e+00 2.89377024e+01 2.83917065e+01 1.91193782e+02
 3.17759120e-01 6.95996287e-01 5.27618550e-01 1.31185085e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.995655295556759
cond(S) = 239.36128121222106
E1 = -183.52585029646946  E_coul = 55.068615451375166
init E= -128.457234845094
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.769424525786312  LUMO = 0.800831839687518
  mo_energy =
[-3.25565403e+01 -1.85238853e+00 -7.69424526e-01 -7.69424526e-01
 -7.69424526e-01  8.00831840e-01  8.00831840e-01  8.00831840e-01
  2.05907380e+00  2.98369342e+00  2.98369342e+00  2.98369342e+00
  1.08200611e+01  1.08200611e+01  1.08200611e+01  1.94266920e+01
  5.40804228e+01  5.40804228e+01  5.40804228e+01  9.38388187e+01
  3.56155213e+02  1.34951887e+03  5.83596894e+03  3.50985971e+04]
E1 = -182.05891120885303  E_coul = 53.56617610702005
cycle= 1 E= -128.492735101833  delta_E= -0.0355  |g|= 0.205  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.488743
diis-c [-0.2388696  1.       ]
  HOMO = -0.873647781998527  LUMO = 0.782880155490103
  mo_energy =
[-3.28830050e+01 -1.96196276e+00 -8.73647782e-01 -8.73647782e-01
 -8.73647782e-01  7.82880155e-01  7.82880155e-01  7.82880155e-01
  1.98651609e+00  2.91817906e+00  2.91817906e+00  2.91817906e+00
  1.06483418e+01  1.06483418e+01  1.06483418e+01  1.92063311e+01
  5.37845945e+01  5.37845945e+01  5.37845945e+01  9.35322487e+01
  3.55798256e+02  1.34912263e+03  5.83554061e+03  3.50981472e+04]
E1 = -182.80684560311238  E_coul = 54.31144002556342
cycle= 2 E= -128.495405577549  delta_E= -0.00267  |g|= 0.101  |ddm|= 0.0846
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.242073
diis-c [-5.03174593e-04  3.30515085e-01  6.69484915e-01]
  HOMO = -0.838387367742855  LUMO = 0.78978398321012
  mo_energy =
[-3.27759151e+01 -1.92477988e+00 -8.38387368e-01 -8.38387368e-01
 -8.38387368e-01  7.89783983e-01  7.89783983e-01  7.89783983e-01
  2.01160121e+00  2.94090023e+00  2.94090023e+00  2.94090023e+00
  1.07058810e+01  1.07058810e+01  1.07058810e+01  1.92798296e+01
  5.38822193e+01  5.38822193e+01  5.38822193e+01  9.36333243e+01
  3.55912244e+02  1.34924300e+03  5.83566404e+03  3.50982718e+04]
E1 = -182.56317141645098  E_coul = 54.06691143221451
cycle= 3 E= -128.496259984236  delta_E= -0.000854  |g|= 0.000703  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000532758
diis-c [-1.55244721e-07 -1.36721939e-03 -4.17373209e-03  1.00554095e+00]
  HOMO = -0.838217357660858  LUMO = 0.789898949041905
  mo_energy =
[-3.27756657e+01 -1.92452311e+00 -8.38217358e-01 -8.38217358e-01
 -8.38217358e-01  7.89898949e-01  7.89898949e-01  7.89898949e-01
  2.01188115e+00  2.94112233e+00  2.94112233e+00  2.94112233e+00
  1.07061602e+01  1.07061602e+01  1.07061602e+01  1.92801096e+01
  5.38824844e+01  5.38824844e+01  5.38824844e+01  9.36335875e+01
  3.55912482e+02  1.34924319e+03  5.83566419e+03  3.50982719e+04]
E1 = -182.5630927360878  E_coul = 54.066832666365656
cycle= 4 E= -128.496260069722  delta_E= -8.55e-08  |g|= 0.000104  |ddm|= 0.000992
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.53948e-05
diis-c [-2.35152151e-09  2.92312848e-04  9.89859670e-04 -2.07494047e-01
  1.20621187e+00]
  HOMO = -0.838188224368644  LUMO = 0.789912370048784
  mo_energy =
[-3.27756354e+01 -1.92447424e+00 -8.38188224e-01 -8.38188224e-01
 -8.38188224e-01  7.89912370e-01  7.89912370e-01  7.89912370e-01
  2.01192620e+00  2.94115206e+00  2.94115206e+00  2.94115206e+00
  1.07061971e+01  1.07061971e+01  1.07061971e+01  1.92801486e+01
  5.38825175e+01  5.38825175e+01  5.38825175e+01  9.36336197e+01
  3.55912509e+02  1.34924321e+03  5.83566420e+03  3.50982719e+04]
E1 = -182.5631731974804  E_coul = 54.0669131253764
cycle= 5 E= -128.496260072104  delta_E= -2.38e-09  |g|= 5.62e-06  |ddm|= 0.000186
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.6141e-06
diis-c [-1.31386779e-11 -4.24252849e-06 -2.85778893e-05  1.61250838e-02
 -1.35619908e-01  1.11952764e+00]
  HOMO = -0.838187735555714  LUMO = 0.789912459462018
  mo_energy =
[-3.27756352e+01 -1.92447208e+00 -8.38187736e-01 -8.38187736e-01
 -8.38187736e-01  7.89912459e-01  7.89912459e-01  7.89912459e-01
  2.01192788e+00  2.94115248e+00  2.94115248e+00  2.94115248e+00
  1.07061980e+01  1.07061980e+01  1.07061980e+01  1.92801503e+01
  5.38825180e+01  5.38825180e+01  5.38825180e+01  9.36336201e+01
  3.55912507e+02  1.34924321e+03  5.83566420e+03  3.50982719e+04]
E1 = -182.5631712928908  E_coul = 54.06691122078298
cycle= 6 E= -128.496260072108  delta_E= -3.81e-12  |g|= 1.06e-06  |ddm|= 3.98e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.5631712928908  E_coul = 54.06691122078298
  HOMO = -0.838188384725557  LUMO = 0.789912292832041
  mo_energy =
[-3.27756365e+01 -1.92447273e+00 -8.38188385e-01 -8.38188385e-01
 -8.38188385e-01  7.89912293e-01  7.89912293e-01  7.89912293e-01
  2.01192738e+00  2.94115200e+00  2.94115200e+00  2.94115200e+00
  1.07061970e+01  1.07061970e+01  1.07061970e+01  1.92801492e+01
  5.38825167e+01  5.38825167e+01  5.38825167e+01  9.36336187e+01
  3.55912506e+02  1.34924321e+03  5.83566420e+03  3.50982719e+04]
E1 = -182.5631738441775  E_coul = 54.066913772069725
Extra cycle  E= -128.496260072108  delta_E= 5.68e-14  |g|= 3.79e-07  |ddm|= 8.18e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816941e+01 5.69551060e+01 4.87275758e-01 7.81995774e+00
 1.65432213e+00 1.72335599e+00 6.26879002e+00 2.83917065e+01
 3.17759120e-01 5.27618550e-01]
E = -128.49626007210776
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482384        1
[INPUT] 0    0    [1    /1   ]  174.90701947         1
[INPUT] 0    0    [1    /1   ]  20.4816941185        1
[INPUT] 0    0    [1    /1   ]  56.955106049         1
[INPUT] 0    0    [1    /1   ]  0.487275758153       1
[INPUT] 0    0    [1    /1   ]  7.8199577419         1
[INPUT] 0    0    [1    /1   ]  1.65432213297        1
[INPUT] 1    0    [1    /1   ]  1.7233559888         1
[INPUT] 1    0    [1    /1   ]  6.26879001673        1
[INPUT] 1    0    [1    /1   ]  28.3917065072        1
[INPUT] 1    0    [1    /1   ]  0.317759120185       1
[INPUT] 1    0    [1    /1   ]  0.527618549583       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025578, 1.0]], [0, [2712.0968240740717, 1.0]], [0, [617.4984823837013, 1.0]], [0, [174.90701946964316, 1.0]], [0, [20.48169411847969, 1.0]], [0, [56.95510604902251, 1.0]], [0, [0.4872757581531894, 1.0]], [0, [7.819957741899978, 1.0]], [0, [1.6543221329729179, 1.0]], [1, [1.7233559887959757, 1.0]], [1, [6.26879001672874, 1.0]], [1, [28.391706507195593, 1.0]], [1, [0.31775912018476815, 1.0]], [1, [0.5276185495826077, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848238]
bas 3, expnt(s) = [174.90701947]
bas 4, expnt(s) = [20.48169412]
bas 5, expnt(s) = [56.95510605]
bas 6, expnt(s) = [0.48727576]
bas 7, expnt(s) = [7.81995774]
bas 8, expnt(s) = [1.65432213]
bas 9, expnt(s) = [1.72335599]
bas 10, expnt(s) = [6.26879002]
bas 11, expnt(s) = [28.39170651]
bas 12, expnt(s) = [0.31775912]
bas 13, expnt(s) = [0.52761855]
CPU time:        12.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816941e+01 2.43242485e+01 5.69551060e+01 5.23798829e+01
 4.87275758e-01 1.47348639e+00 7.81995774e+00 1.18145811e+01
 1.65432213e+00 3.68536141e+00 1.72335599e+00 5.76040660e+00
 6.26879002e+00 2.89377024e+01 2.83917065e+01 1.91193782e+02
 3.17759120e-01 6.95996287e-01 5.27618550e-01 1.31185085e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.995655295556759
cond(S) = 239.36128121222106
E1 = -183.52585029646946  E_coul = 55.068615451375166
init E= -128.457234845094
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.769424525786312  LUMO = 0.800831839687518
  mo_energy =
[-3.25565403e+01 -1.85238853e+00 -7.69424526e-01 -7.69424526e-01
 -7.69424526e-01  8.00831840e-01  8.00831840e-01  8.00831840e-01
  2.05907380e+00  2.98369342e+00  2.98369342e+00  2.98369342e+00
  1.08200611e+01  1.08200611e+01  1.08200611e+01  1.94266920e+01
  5.40804228e+01  5.40804228e+01  5.40804228e+01  9.38388187e+01
  3.56155213e+02  1.34951887e+03  5.83596894e+03  3.50985971e+04]
E1 = -182.05891120885303  E_coul = 53.56617610702005
cycle= 1 E= -128.492735101833  delta_E= -0.0355  |g|= 0.205  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.488743
diis-c [-0.2388696  1.       ]
  HOMO = -0.873647781998527  LUMO = 0.782880155490103
  mo_energy =
[-3.28830050e+01 -1.96196276e+00 -8.73647782e-01 -8.73647782e-01
 -8.73647782e-01  7.82880155e-01  7.82880155e-01  7.82880155e-01
  1.98651609e+00  2.91817906e+00  2.91817906e+00  2.91817906e+00
  1.06483418e+01  1.06483418e+01  1.06483418e+01  1.92063311e+01
  5.37845945e+01  5.37845945e+01  5.37845945e+01  9.35322487e+01
  3.55798256e+02  1.34912263e+03  5.83554061e+03  3.50981472e+04]
E1 = -182.80684560311238  E_coul = 54.31144002556342
cycle= 2 E= -128.495405577549  delta_E= -0.00267  |g|= 0.101  |ddm|= 0.0846
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.242073
diis-c [-5.03174593e-04  3.30515085e-01  6.69484915e-01]
  HOMO = -0.838387367742855  LUMO = 0.78978398321012
  mo_energy =
[-3.27759151e+01 -1.92477988e+00 -8.38387368e-01 -8.38387368e-01
 -8.38387368e-01  7.89783983e-01  7.89783983e-01  7.89783983e-01
  2.01160121e+00  2.94090023e+00  2.94090023e+00  2.94090023e+00
  1.07058810e+01  1.07058810e+01  1.07058810e+01  1.92798296e+01
  5.38822193e+01  5.38822193e+01  5.38822193e+01  9.36333243e+01
  3.55912244e+02  1.34924300e+03  5.83566404e+03  3.50982718e+04]
E1 = -182.56317141645098  E_coul = 54.06691143221451
cycle= 3 E= -128.496259984236  delta_E= -0.000854  |g|= 0.000703  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000532758
diis-c [-1.55244721e-07 -1.36721939e-03 -4.17373209e-03  1.00554095e+00]
  HOMO = -0.838217357660858  LUMO = 0.789898949041905
  mo_energy =
[-3.27756657e+01 -1.92452311e+00 -8.38217358e-01 -8.38217358e-01
 -8.38217358e-01  7.89898949e-01  7.89898949e-01  7.89898949e-01
  2.01188115e+00  2.94112233e+00  2.94112233e+00  2.94112233e+00
  1.07061602e+01  1.07061602e+01  1.07061602e+01  1.92801096e+01
  5.38824844e+01  5.38824844e+01  5.38824844e+01  9.36335875e+01
  3.55912482e+02  1.34924319e+03  5.83566419e+03  3.50982719e+04]
E1 = -182.5630927360878  E_coul = 54.066832666365656
cycle= 4 E= -128.496260069722  delta_E= -8.55e-08  |g|= 0.000104  |ddm|= 0.000992
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.53948e-05
diis-c [-2.35152151e-09  2.92312848e-04  9.89859670e-04 -2.07494047e-01
  1.20621187e+00]
  HOMO = -0.838188224368644  LUMO = 0.789912370048784
  mo_energy =
[-3.27756354e+01 -1.92447424e+00 -8.38188224e-01 -8.38188224e-01
 -8.38188224e-01  7.89912370e-01  7.89912370e-01  7.89912370e-01
  2.01192620e+00  2.94115206e+00  2.94115206e+00  2.94115206e+00
  1.07061971e+01  1.07061971e+01  1.07061971e+01  1.92801486e+01
  5.38825175e+01  5.38825175e+01  5.38825175e+01  9.36336197e+01
  3.55912509e+02  1.34924321e+03  5.83566420e+03  3.50982719e+04]
E1 = -182.5631731974804  E_coul = 54.0669131253764
cycle= 5 E= -128.496260072104  delta_E= -2.38e-09  |g|= 5.62e-06  |ddm|= 0.000186
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.6141e-06
diis-c [-1.31386779e-11 -4.24252849e-06 -2.85778893e-05  1.61250838e-02
 -1.35619908e-01  1.11952764e+00]
  HOMO = -0.838187735555714  LUMO = 0.789912459462018
  mo_energy =
[-3.27756352e+01 -1.92447208e+00 -8.38187736e-01 -8.38187736e-01
 -8.38187736e-01  7.89912459e-01  7.89912459e-01  7.89912459e-01
  2.01192788e+00  2.94115248e+00  2.94115248e+00  2.94115248e+00
  1.07061980e+01  1.07061980e+01  1.07061980e+01  1.92801503e+01
  5.38825180e+01  5.38825180e+01  5.38825180e+01  9.36336201e+01
  3.55912507e+02  1.34924321e+03  5.83566420e+03  3.50982719e+04]
E1 = -182.5631712928908  E_coul = 54.06691122078298
cycle= 6 E= -128.496260072108  delta_E= -3.81e-12  |g|= 1.06e-06  |ddm|= 3.98e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.5631712928908  E_coul = 54.06691122078298
  HOMO = -0.838188384725557  LUMO = 0.789912292832041
  mo_energy =
[-3.27756365e+01 -1.92447273e+00 -8.38188385e-01 -8.38188385e-01
 -8.38188385e-01  7.89912293e-01  7.89912293e-01  7.89912293e-01
  2.01192738e+00  2.94115200e+00  2.94115200e+00  2.94115200e+00
  1.07061970e+01  1.07061970e+01  1.07061970e+01  1.92801492e+01
  5.38825167e+01  5.38825167e+01  5.38825167e+01  9.36336187e+01
  3.55912506e+02  1.34924321e+03  5.83566420e+03  3.50982719e+04]
E1 = -182.5631738441775  E_coul = 54.066913772069725
Extra cycle  E= -128.496260072108  delta_E= 5.68e-14  |g|= 3.79e-07  |ddm|= 8.18e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.36128121222106
E1 = -182.5631738441775  E_coul = 54.066913772069725
init E= -128.496260072108
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.838188215372393  LUMO = 0.789912319509771
  mo_energy =
[-3.27756360e+01 -1.92447255e+00 -8.38188215e-01 -8.38188215e-01
 -8.38188215e-01  7.89912320e-01  7.89912320e-01  7.89912320e-01
  2.01192749e+00  2.94115210e+00  2.94115210e+00  2.94115210e+00
  1.07061973e+01  1.07061973e+01  1.07061973e+01  1.92801496e+01
  5.38825173e+01  5.38825173e+01  5.38825173e+01  9.36336193e+01
  3.55912507e+02  1.34924321e+03  5.83566420e+03  3.50982719e+04]
E1 = -182.56317239010147  E_coul = 54.06691231799374
cycle= 1 E= -128.496260072108  delta_E= 2.84e-14  |g|= 1.94e-07  |ddm|= 2.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56317239010147  E_coul = 54.06691231799374
  HOMO = -0.838188319080277  LUMO = 0.789912298632175
  mo_energy =
[-3.27756363e+01 -1.92447266e+00 -8.38188319e-01 -8.38188319e-01
 -8.38188319e-01  7.89912299e-01  7.89912299e-01  7.89912299e-01
  2.01192741e+00  2.94115204e+00  2.94115204e+00  2.94115204e+00
  1.07061972e+01  1.07061972e+01  1.07061972e+01  1.92801494e+01
  5.38825170e+01  5.38825170e+01  5.38825170e+01  9.36336190e+01
  3.55912506e+02  1.34924321e+03  5.83566420e+03  3.50982719e+04]
E1 = -182.5631730798559  E_coul = 54.0669130077481
Extra cycle  E= -128.496260072108  delta_E= -5.68e-14  |g|= 9.39e-08  |ddm|= 6.9e-08
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816941e+01 5.69551060e+01 4.87275758e-01 7.81995774e+00
 1.65432213e+00 1.72335599e+00 6.26879002e+00 2.83917065e+01
 3.17759120e-01 5.27618550e-01]
grad_E = [-6.18211098e-13  2.53608914e-10 -5.00459745e-09  5.65662924e-08
  2.21107747e-06 -3.99766951e-07 -1.76342935e-05 -3.57775287e-06
  3.36932321e-05 -1.11500130e-02 -5.60830743e-04  5.93850940e-05
  6.95594740e-02 -5.15838417e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482405        1
[INPUT] 0    0    [1    /1   ]  174.907019253        1
[INPUT] 0    0    [1    /1   ]  20.4816855734        1
[INPUT] 0    0    [1    /1   ]  56.955107489         1
[INPUT] 0    0    [1    /1   ]  0.487962379397       1
[INPUT] 0    0    [1    /1   ]  7.81997269903        1
[INPUT] 0    0    [1    /1   ]  1.65432593331        1
[INPUT] 1    0    [1    /1   ]  1.81162898625        1
[INPUT] 1    0    [1    /1   ]  6.26358915857        1
[INPUT] 1    0    [1    /1   ]  28.3917907932        1
[INPUT] 1    0    [1    /1   ]  1.00002689463e-09      1
[INPUT] 1    0    [1    /1   ]  0.663529001386       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025563, 1.0]], [0, [2712.096824073012, 1.0]], [0, [617.4984824047541, 1.0]], [0, [174.90701925316478, 1.0]], [0, [20.48168557342334, 1.0]], [0, [56.95510748898539, 1.0]], [0, [0.48796237939723247, 1.0]], [0, [7.819972699031131, 1.0]], [0, [1.6543259333096922, 1.0]], [1, [1.8116289862548194, 1.0]], [1, [6.263589158567188, 1.0]], [1, [28.391790793168738, 1.0]], [1, [1.0000268946264157e-09, 1.0]], [1, [0.6635290013864552, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.4984824]
bas 3, expnt(s) = [174.90701925]
bas 4, expnt(s) = [20.48168557]
bas 5, expnt(s) = [56.95510749]
bas 6, expnt(s) = [0.48796238]
bas 7, expnt(s) = [7.8199727]
bas 8, expnt(s) = [1.65432593]
bas 9, expnt(s) = [1.81162899]
bas 10, expnt(s) = [6.26358916]
bas 11, expnt(s) = [28.39179079]
bas 12, expnt(s) = [1.00002689e-09]
bas 13, expnt(s) = [0.663529]
CPU time:        15.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816856e+01 2.43242409e+01 5.69551075e+01 5.23798839e+01
 4.87962379e-01 1.47504333e+00 7.81997270e+00 1.18145981e+01
 1.65432593e+00 3.68536776e+00 1.81162899e+00 6.13155981e+00
 6.26358916e+00 2.89076956e+01 2.83917908e+01 1.91194491e+02
 1.00002689e-09 1.64058597e-11 6.63529001e-01 1.74706587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.93885213175339
cond(S) = 239.40734368807557
E1 = -183.19762763634137  E_coul = 54.97219013066461
init E= -128.225437505677
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.755607662572033  LUMO = -0.000336419693420533
  mo_energy =
[-3.25631188e+01 -1.86394342e+00 -7.55607663e-01 -7.55607663e-01
 -7.55607663e-01 -3.36419693e-04 -3.36419693e-04 -3.36419693e-04
  2.05290995e+00  2.36581399e+00  2.36581399e+00  2.36581399e+00
  1.06802099e+01  1.06802099e+01  1.06802099e+01  1.94161533e+01
  5.41284416e+01  5.41284416e+01  5.41284416e+01  9.38339175e+01
  3.56147745e+02  1.34950829e+03  5.83595714e+03  3.50985848e+04]
E1 = -183.6029610537917  E_coul = 55.24147554629682
cycle= 1 E= -128.361485507495  delta_E= -0.136  |g|= 0.0707  |ddm|= 0.293
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0977609
diis-c [-0.00955719  1.        ]
  HOMO = -0.719254641336411  LUMO = -0.000336419693419661
  mo_energy =
[-3.25871950e+01 -1.81515713e+00 -7.19254641e-01 -7.19254641e-01
 -7.19254641e-01 -3.36419693e-04 -3.36419693e-04 -3.36419693e-04
  2.10231907e+00  2.40730683e+00  2.40730683e+00  2.40730683e+00
  1.07150459e+01  1.07150459e+01  1.07150459e+01  1.94419240e+01
  5.41169655e+01  5.41169655e+01  5.41169655e+01  9.38194018e+01
  3.56103310e+02  1.34943283e+03  5.83585193e+03  3.50984585e+04]
E1 = -183.63233958363307  E_coul = 55.270605414701215
cycle= 2 E= -128.361734168932  delta_E= -0.000249  |g|= 0.00778  |ddm|= 0.0252
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00897854
diis-c [-7.88296332e-05 -1.39122082e-02  1.01391221e+00]
  HOMO = -0.717391707960108  LUMO = -0.000336419693431489
  mo_energy =
[-3.25815081e+01 -1.81168187e+00 -7.17391708e-01 -7.17391708e-01
 -7.17391708e-01 -3.36419693e-04 -3.36419693e-04 -3.36419693e-04
  2.10485379e+00  2.40860587e+00  2.40860587e+00  2.40860587e+00
  1.07184034e+01  1.07184034e+01  1.07184034e+01  1.94464865e+01
  5.41223243e+01  5.41223243e+01  5.41223243e+01  9.38249880e+01
  3.56109402e+02  1.34943890e+03  5.83585781e+03  3.50984642e+04]
E1 = -183.62284787292893  E_coul = 55.26110697674508
cycle= 3 E= -128.361740896184  delta_E= -6.73e-06  |g|= 0.00168  |ddm|= 0.00465
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00349317
diis-c [-7.10983142e-06 -1.59820787e-02  1.76426897e-01  8.39555182e-01]
  HOMO = -0.717994287819144  LUMO = -0.000336419693418819
  mo_energy =
[-3.25833327e+01 -1.81200705e+00 -7.17994288e-01 -7.17994288e-01
 -7.17994288e-01 -3.36419693e-04 -3.36419693e-04 -3.36419693e-04
  2.10466648e+00  2.40819980e+00  2.40819980e+00  2.40819980e+00
  1.07174547e+01  1.07174547e+01  1.07174547e+01  1.94453906e+01
  5.41207009e+01  5.41207009e+01  5.41207009e+01  9.38232933e+01
  3.56107329e+02  1.34943654e+03  5.83585526e+03  3.50984616e+04]
E1 = -183.62581286307582  E_coul = 55.264071656554805
cycle= 4 E= -128.361741206521  delta_E= -3.1e-07  |g|= 0.000351  |ddm|= 0.000665
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000408488
diis-c [-1.22843818e-08  1.09290831e-03 -5.06841918e-02 -4.20404740e-02
  1.09163176e+00]
  HOMO = -0.717967958861049  LUMO = -0.000336419693419093
  mo_energy =
[-3.25831626e+01 -1.81188392e+00 -7.17967959e-01 -7.17967959e-01
 -7.17967959e-01 -3.36419693e-04 -3.36419693e-04 -3.36419693e-04
  2.10475208e+00  2.40821509e+00  2.40821509e+00  2.40821509e+00
  1.07175301e+01  1.07175301e+01  1.07175301e+01  1.94455332e+01
  5.41208609e+01  5.41208609e+01  5.41208609e+01  9.38234552e+01
  3.56107460e+02  1.34943661e+03  5.83585529e+03  3.50984616e+04]
E1 = -183.62546344784658  E_coul = 55.263722226537155
cycle= 5 E= -128.361741221309  delta_E= -1.48e-08  |g|= 1.6e-05  |ddm|= 0.000249
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.16394e-05
diis-c [-2.01197671e-11 -5.99231859e-05  4.03013198e-03 -5.65671415e-03
 -5.16266758e-02  1.05331318e+00]
  HOMO = -0.717975181934015  LUMO = -0.000336419693431591
  mo_energy =
[-3.25831796e+01 -1.81189141e+00 -7.17975182e-01 -7.17975182e-01
 -7.17975182e-01 -3.36419693e-04 -3.36419693e-04 -3.36419693e-04
  2.10474678e+00  2.40821012e+00  2.40821012e+00  2.40821012e+00
  1.07175188e+01  1.07175188e+01  1.07175188e+01  1.94455201e+01
  5.41208447e+01  5.41208447e+01  5.41208447e+01  9.38234385e+01
  3.56107441e+02  1.34943659e+03  5.83585526e+03  3.50984616e+04]
E1 = -183.62549219937088  E_coul = 55.2637509780453
cycle= 6 E= -128.361741221326  delta_E= -1.61e-11  |g|= 3.86e-07  |ddm|= 4.21e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -183.62549219937088  E_coul = 55.2637509780453
  HOMO = -0.717974959060846  LUMO = -0.000336419693422702
  mo_energy =
[-3.25831791e+01 -1.81189119e+00 -7.17974959e-01 -7.17974959e-01
 -7.17974959e-01 -3.36419693e-04 -3.36419693e-04 -3.36419693e-04
  2.10474694e+00  2.40821027e+00  2.40821027e+00  2.40821027e+00
  1.07175191e+01  1.07175191e+01  1.07175191e+01  1.94455205e+01
  5.41208453e+01  5.41208453e+01  5.41208453e+01  9.38234390e+01
  3.56107442e+02  1.34943659e+03  5.83585527e+03  3.50984616e+04]
E1 = -183.6254912013345  E_coul = 55.26374998000919
Extra cycle  E= -128.361741221325  delta_E= 2.56e-13  |g|= 1.35e-07  |ddm|= 1.31e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816856e+01 5.69551075e+01 4.87962379e-01 7.81997270e+00
 1.65432593e+00 1.81162899e+00 6.26358916e+00 2.83917908e+01
 1.00002689e-09 6.63529001e-01]
E = -128.36174122132533
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482386        1
[INPUT] 0    0    [1    /1   ]  174.907019448        1
[INPUT] 0    0    [1    /1   ]  20.481693264         1
[INPUT] 0    0    [1    /1   ]  56.955106193         1
[INPUT] 0    0    [1    /1   ]  0.487344420278       1
[INPUT] 0    0    [1    /1   ]  7.81995923761        1
[INPUT] 0    0    [1    /1   ]  1.65432251301        1
[INPUT] 1    0    [1    /1   ]  1.73218328854        1
[INPUT] 1    0    [1    /1   ]  6.26826993091        1
[INPUT] 1    0    [1    /1   ]  28.3917149358        1
[INPUT] 1    0    [1    /1   ]  0.285983208266       1
[INPUT] 1    0    [1    /1   ]  0.541209594763       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025578, 1.0]], [0, [2712.0968240739658, 1.0]], [0, [617.4984823858066, 1.0]], [0, [174.9070194479953, 1.0]], [0, [20.481693263974055, 1.0]], [0, [56.9551061930188, 1.0]], [0, [0.4873444202775937, 1.0]], [0, [7.8199592376130935, 1.0]], [0, [1.6543225130065953, 1.0]], [1, [1.73218328854186, 1.0]], [1, [6.268269930912585, 1.0]], [1, [28.39171493579291, 1.0]], [1, [0.28598320826629403, 1.0]], [1, [0.5412095947629925, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848239]
bas 3, expnt(s) = [174.90701945]
bas 4, expnt(s) = [20.48169326]
bas 5, expnt(s) = [56.95510619]
bas 6, expnt(s) = [0.48734442]
bas 7, expnt(s) = [7.81995924]
bas 8, expnt(s) = [1.65432251]
bas 9, expnt(s) = [1.73218329]
bas 10, expnt(s) = [6.26826993]
bas 11, expnt(s) = [28.39171494]
bas 12, expnt(s) = [0.28598321]
bas 13, expnt(s) = [0.54120959]
CPU time:        15.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816933e+01 2.43242477e+01 5.69551062e+01 5.23798830e+01
 4.87344420e-01 1.47364211e+00 7.81995924e+00 1.18145828e+01
 1.65432251e+00 3.68536205e+00 1.73218329e+00 5.79731232e+00
 6.26826993e+00 2.89347014e+01 2.83917149e+01 1.91193853e+02
 2.85983208e-01 6.10112693e-01 5.41209595e-01 1.35422632e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.996832337527767
cond(S) = 239.36588518884594
E1 = -183.53181126669546  E_coul = 55.069817862423825
init E= -128.461993404272
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.769918212424138  LUMO = 0.749369545891724
  mo_energy =
[-3.25563531e+01 -1.85225397e+00 -7.69918212e-01 -7.69918212e-01
 -7.69918212e-01  7.49369546e-01  7.49369546e-01  7.49369546e-01
  2.05958816e+00  2.91186932e+00  2.91186932e+00  2.91186932e+00
  1.07804765e+01  1.07804765e+01  1.07804765e+01  1.94270323e+01
  5.40652180e+01  5.40652180e+01  5.40652180e+01  9.38392564e+01
  3.56155547e+02  1.34951909e+03  5.83596911e+03  3.50985972e+04]
E1 = -182.01563683603146  E_coul = 53.519993227785925
cycle= 1 E= -128.495643608246  delta_E= -0.0337  |g|= 0.211  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.49664
diis-c [-0.24665138  1.        ]
  HOMO = -0.877768644033382  LUMO = 0.731212220220593
  mo_energy =
[-3.28912586e+01 -1.96605183e+00 -8.77768644e-01 -8.77768644e-01
 -8.77768644e-01  7.31212220e-01  7.31212220e-01  7.31212220e-01
  1.98367598e+00  2.84314221e+00  2.84314221e+00  2.84314221e+00
  1.06027324e+01  1.06027324e+01  1.06027324e+01  1.92001038e+01
  5.37613547e+01  5.37613547e+01  5.37613547e+01  9.35245738e+01
  3.55790072e+02  1.34911428e+03  5.83553221e+03  3.50981387e+04]
E1 = -182.7895607320193  E_coul = 54.29111542016264
cycle= 2 E= -128.498445311857  delta_E= -0.0028  |g|= 0.105  |ddm|= 0.0798
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.248303
diis-c [-5.17987335e-04  3.32614358e-01  6.67385642e-01]
  HOMO = -0.841375398672273  LUMO = 0.737947185438566
  mo_energy =
[-3.27809026e+01 -1.92764841e+00 -8.41375399e-01 -8.41375399e-01
 -8.41375399e-01  7.37947185e-01  7.37947185e-01  7.37947185e-01
  2.00958648e+00  2.86669258e+00  2.86669258e+00  2.86669258e+00
  1.06622874e+01  1.06622874e+01  1.06622874e+01  1.92759259e+01
  5.38619932e+01  5.38619932e+01  5.38619932e+01  9.36287466e+01
  3.55907496e+02  1.34923825e+03  5.83565931e+03  3.50982670e+04]
E1 = -182.53546954564754  E_coul = 54.03610311386952
cycle= 3 E= -128.499366431778  delta_E= -0.000921  |g|= 0.000539  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000526588
diis-c [-1.06098279e-07 -1.35661374e-03 -4.32171704e-03  1.00567833e+00]
  HOMO = -0.841234057000628  LUMO = 0.738043564916211
  mo_energy =
[-3.27806852e+01 -1.92744378e+00 -8.41234057e-01 -8.41234057e-01
 -8.41234057e-01  7.38043565e-01  7.38043565e-01  7.38043565e-01
  2.00981942e+00  2.86688761e+00  2.86688761e+00  2.86688761e+00
  1.06625346e+01  1.06625346e+01  1.06625346e+01  1.92761709e+01
  5.38622251e+01  5.38622251e+01  5.38622251e+01  9.36289777e+01
  3.55907704e+02  1.34923842e+03  5.83565944e+03  3.50982671e+04]
E1 = -182.53523811745274  E_coul = 54.035871638376754
cycle= 4 E= -128.499366479076  delta_E= -4.73e-08  |g|= 7.35e-05  |ddm|= 0.000603
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.28219e-05
diis-c [-1.58397265e-09  1.88864328e-04  7.26225190e-04 -1.60297060e-01
  1.15938197e+00]
  HOMO = -0.841214548271836  LUMO = 0.738052582111494
  mo_energy =
[-3.27806664e+01 -1.92741221e+00 -8.41214548e-01 -8.41214548e-01
 -8.41214548e-01  7.38052582e-01  7.38052582e-01  7.38052582e-01
  2.00984912e+00  2.86690812e+00  2.86690812e+00  2.86690812e+00
  1.06625586e+01  1.06625586e+01  1.06625586e+01  1.92761950e+01
  5.38622458e+01  5.38622458e+01  5.38622458e+01  9.36289979e+01
  3.55907723e+02  1.34923843e+03  5.83565945e+03  3.50982671e+04]
E1 = -182.53530686785632  E_coul = 54.03594038753225
cycle= 5 E= -128.499366480324  delta_E= -1.25e-09  |g|= 5.72e-06  |ddm|= 0.00011
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.51107e-06
diis-c [-1.12970773e-11  4.65716267e-06 -2.29053293e-05  1.17277648e-02
 -1.50810685e-01  1.13910117e+00]
  HOMO = -0.841212743835396  LUMO = 0.73805313890067
  mo_energy =
[-3.27806641e+01 -1.92740872e+00 -8.41212744e-01 -8.41212744e-01
 -8.41212744e-01  7.38053139e-01  7.38053139e-01  7.38053139e-01
  2.00985200e+00  2.86690970e+00  2.86690970e+00  2.86690970e+00
  1.06625612e+01  1.06625612e+01  1.06625612e+01  1.92761983e+01
  5.38622483e+01  5.38622483e+01  5.38622483e+01  9.36290003e+01
  3.55907724e+02  1.34923843e+03  5.83565945e+03  3.50982671e+04]
E1 = -182.53530463437403  E_coul = 54.0359381540456
cycle= 6 E= -128.499366480328  delta_E= -4.38e-12  |g|= 8.41e-07  |ddm|= 5.52e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.53530463437403  E_coul = 54.0359381540456
  HOMO = -0.841213255314654  LUMO = 0.73805301673844
  mo_energy =
[-3.27806652e+01 -1.92740921e+00 -8.41213255e-01 -8.41213255e-01
 -8.41213255e-01  7.38053017e-01  7.38053017e-01  7.38053017e-01
  2.00985163e+00  2.86690933e+00  2.86690933e+00  2.86690933e+00
  1.06625605e+01  1.06625605e+01  1.06625605e+01  1.92761975e+01
  5.38622473e+01  5.38622473e+01  5.38622473e+01  9.36289993e+01
  3.55907723e+02  1.34923843e+03  5.83565945e+03  3.50982671e+04]
E1 = -182.53530679885617  E_coul = 54.03594031852747
Extra cycle  E= -128.499366480329  delta_E= -2.56e-13  |g|= 3.2e-07  |ddm|= 4.97e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816933e+01 5.69551062e+01 4.87344420e-01 7.81995924e+00
 1.65432251e+00 1.73218329e+00 6.26826993e+00 2.83917149e+01
 2.85983208e-01 5.41209595e-01]
E = -128.4993664803287
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482386        1
[INPUT] 0    0    [1    /1   ]  174.907019448        1
[INPUT] 0    0    [1    /1   ]  20.481693264         1
[INPUT] 0    0    [1    /1   ]  56.955106193         1
[INPUT] 0    0    [1    /1   ]  0.487344420278       1
[INPUT] 0    0    [1    /1   ]  7.81995923761        1
[INPUT] 0    0    [1    /1   ]  1.65432251301        1
[INPUT] 1    0    [1    /1   ]  1.73218328854        1
[INPUT] 1    0    [1    /1   ]  6.26826993091        1
[INPUT] 1    0    [1    /1   ]  28.3917149358        1
[INPUT] 1    0    [1    /1   ]  0.285983208266       1
[INPUT] 1    0    [1    /1   ]  0.541209594763       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025578, 1.0]], [0, [2712.0968240739658, 1.0]], [0, [617.4984823858066, 1.0]], [0, [174.9070194479953, 1.0]], [0, [20.481693263974055, 1.0]], [0, [56.9551061930188, 1.0]], [0, [0.4873444202775937, 1.0]], [0, [7.8199592376130935, 1.0]], [0, [1.6543225130065953, 1.0]], [1, [1.73218328854186, 1.0]], [1, [6.268269930912585, 1.0]], [1, [28.39171493579291, 1.0]], [1, [0.28598320826629403, 1.0]], [1, [0.5412095947629925, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848239]
bas 3, expnt(s) = [174.90701945]
bas 4, expnt(s) = [20.48169326]
bas 5, expnt(s) = [56.95510619]
bas 6, expnt(s) = [0.48734442]
bas 7, expnt(s) = [7.81995924]
bas 8, expnt(s) = [1.65432251]
bas 9, expnt(s) = [1.73218329]
bas 10, expnt(s) = [6.26826993]
bas 11, expnt(s) = [28.39171494]
bas 12, expnt(s) = [0.28598321]
bas 13, expnt(s) = [0.54120959]
CPU time:        15.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816933e+01 2.43242477e+01 5.69551062e+01 5.23798830e+01
 4.87344420e-01 1.47364211e+00 7.81995924e+00 1.18145828e+01
 1.65432251e+00 3.68536205e+00 1.73218329e+00 5.79731232e+00
 6.26826993e+00 2.89347014e+01 2.83917149e+01 1.91193853e+02
 2.85983208e-01 6.10112693e-01 5.41209595e-01 1.35422632e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.996832337527767
cond(S) = 239.36588518884594
E1 = -183.53181126669546  E_coul = 55.069817862423825
init E= -128.461993404272
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.769918212424138  LUMO = 0.749369545891724
  mo_energy =
[-3.25563531e+01 -1.85225397e+00 -7.69918212e-01 -7.69918212e-01
 -7.69918212e-01  7.49369546e-01  7.49369546e-01  7.49369546e-01
  2.05958816e+00  2.91186932e+00  2.91186932e+00  2.91186932e+00
  1.07804765e+01  1.07804765e+01  1.07804765e+01  1.94270323e+01
  5.40652180e+01  5.40652180e+01  5.40652180e+01  9.38392564e+01
  3.56155547e+02  1.34951909e+03  5.83596911e+03  3.50985972e+04]
E1 = -182.01563683603146  E_coul = 53.519993227785925
cycle= 1 E= -128.495643608246  delta_E= -0.0337  |g|= 0.211  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.49664
diis-c [-0.24665138  1.        ]
  HOMO = -0.877768644033382  LUMO = 0.731212220220593
  mo_energy =
[-3.28912586e+01 -1.96605183e+00 -8.77768644e-01 -8.77768644e-01
 -8.77768644e-01  7.31212220e-01  7.31212220e-01  7.31212220e-01
  1.98367598e+00  2.84314221e+00  2.84314221e+00  2.84314221e+00
  1.06027324e+01  1.06027324e+01  1.06027324e+01  1.92001038e+01
  5.37613547e+01  5.37613547e+01  5.37613547e+01  9.35245738e+01
  3.55790072e+02  1.34911428e+03  5.83553221e+03  3.50981387e+04]
E1 = -182.7895607320193  E_coul = 54.29111542016264
cycle= 2 E= -128.498445311857  delta_E= -0.0028  |g|= 0.105  |ddm|= 0.0798
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.248303
diis-c [-5.17987335e-04  3.32614358e-01  6.67385642e-01]
  HOMO = -0.841375398672273  LUMO = 0.737947185438566
  mo_energy =
[-3.27809026e+01 -1.92764841e+00 -8.41375399e-01 -8.41375399e-01
 -8.41375399e-01  7.37947185e-01  7.37947185e-01  7.37947185e-01
  2.00958648e+00  2.86669258e+00  2.86669258e+00  2.86669258e+00
  1.06622874e+01  1.06622874e+01  1.06622874e+01  1.92759259e+01
  5.38619932e+01  5.38619932e+01  5.38619932e+01  9.36287466e+01
  3.55907496e+02  1.34923825e+03  5.83565931e+03  3.50982670e+04]
E1 = -182.53546954564754  E_coul = 54.03610311386952
cycle= 3 E= -128.499366431778  delta_E= -0.000921  |g|= 0.000539  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000526588
diis-c [-1.06098279e-07 -1.35661374e-03 -4.32171704e-03  1.00567833e+00]
  HOMO = -0.841234057000628  LUMO = 0.738043564916211
  mo_energy =
[-3.27806852e+01 -1.92744378e+00 -8.41234057e-01 -8.41234057e-01
 -8.41234057e-01  7.38043565e-01  7.38043565e-01  7.38043565e-01
  2.00981942e+00  2.86688761e+00  2.86688761e+00  2.86688761e+00
  1.06625346e+01  1.06625346e+01  1.06625346e+01  1.92761709e+01
  5.38622251e+01  5.38622251e+01  5.38622251e+01  9.36289777e+01
  3.55907704e+02  1.34923842e+03  5.83565944e+03  3.50982671e+04]
E1 = -182.53523811745274  E_coul = 54.035871638376754
cycle= 4 E= -128.499366479076  delta_E= -4.73e-08  |g|= 7.35e-05  |ddm|= 0.000603
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.28219e-05
diis-c [-1.58397265e-09  1.88864328e-04  7.26225190e-04 -1.60297060e-01
  1.15938197e+00]
  HOMO = -0.841214548271836  LUMO = 0.738052582111494
  mo_energy =
[-3.27806664e+01 -1.92741221e+00 -8.41214548e-01 -8.41214548e-01
 -8.41214548e-01  7.38052582e-01  7.38052582e-01  7.38052582e-01
  2.00984912e+00  2.86690812e+00  2.86690812e+00  2.86690812e+00
  1.06625586e+01  1.06625586e+01  1.06625586e+01  1.92761950e+01
  5.38622458e+01  5.38622458e+01  5.38622458e+01  9.36289979e+01
  3.55907723e+02  1.34923843e+03  5.83565945e+03  3.50982671e+04]
E1 = -182.53530686785632  E_coul = 54.03594038753225
cycle= 5 E= -128.499366480324  delta_E= -1.25e-09  |g|= 5.72e-06  |ddm|= 0.00011
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.51107e-06
diis-c [-1.12970773e-11  4.65716267e-06 -2.29053293e-05  1.17277648e-02
 -1.50810685e-01  1.13910117e+00]
  HOMO = -0.841212743835396  LUMO = 0.73805313890067
  mo_energy =
[-3.27806641e+01 -1.92740872e+00 -8.41212744e-01 -8.41212744e-01
 -8.41212744e-01  7.38053139e-01  7.38053139e-01  7.38053139e-01
  2.00985200e+00  2.86690970e+00  2.86690970e+00  2.86690970e+00
  1.06625612e+01  1.06625612e+01  1.06625612e+01  1.92761983e+01
  5.38622483e+01  5.38622483e+01  5.38622483e+01  9.36290003e+01
  3.55907724e+02  1.34923843e+03  5.83565945e+03  3.50982671e+04]
E1 = -182.53530463437403  E_coul = 54.0359381540456
cycle= 6 E= -128.499366480328  delta_E= -4.38e-12  |g|= 8.41e-07  |ddm|= 5.52e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.53530463437403  E_coul = 54.0359381540456
  HOMO = -0.841213255314654  LUMO = 0.73805301673844
  mo_energy =
[-3.27806652e+01 -1.92740921e+00 -8.41213255e-01 -8.41213255e-01
 -8.41213255e-01  7.38053017e-01  7.38053017e-01  7.38053017e-01
  2.00985163e+00  2.86690933e+00  2.86690933e+00  2.86690933e+00
  1.06625605e+01  1.06625605e+01  1.06625605e+01  1.92761975e+01
  5.38622473e+01  5.38622473e+01  5.38622473e+01  9.36289993e+01
  3.55907723e+02  1.34923843e+03  5.83565945e+03  3.50982671e+04]
E1 = -182.53530679885617  E_coul = 54.03594031852747
Extra cycle  E= -128.499366480329  delta_E= -2.56e-13  |g|= 3.2e-07  |ddm|= 4.97e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.36588518884594
E1 = -182.53530679885617  E_coul = 54.03594031852747
init E= -128.499366480329
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.841213111406982  LUMO = 0.738053038932927
  mo_energy =
[-3.27806647e+01 -1.92740905e+00 -8.41213111e-01 -8.41213111e-01
 -8.41213111e-01  7.38053039e-01  7.38053039e-01  7.38053039e-01
  2.00985173e+00  2.86690942e+00  2.86690942e+00  2.86690942e+00
  1.06625607e+01  1.06625607e+01  1.06625607e+01  1.92761978e+01
  5.38622477e+01  5.38622477e+01  5.38622477e+01  9.36289997e+01
  3.55907723e+02  1.34923843e+03  5.83565945e+03  3.50982671e+04]
E1 = -182.53530558530227  E_coul = 54.03593910497356
cycle= 1 E= -128.499366480329  delta_E= -2.84e-14  |g|= 1.62e-07  |ddm|= 1.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53530558530227  E_coul = 54.03593910497356
  HOMO = -0.84121319810552  LUMO = 0.738053022496598
  mo_energy =
[-3.27806650e+01 -1.92740914e+00 -8.41213198e-01 -8.41213198e-01
 -8.41213198e-01  7.38053022e-01  7.38053022e-01  7.38053022e-01
  2.00985167e+00  2.86690936e+00  2.86690936e+00  2.86690936e+00
  1.06625606e+01  1.06625606e+01  1.06625606e+01  1.92761976e+01
  5.38622475e+01  5.38622475e+01  5.38622475e+01  9.36289995e+01
  3.55907723e+02  1.34923843e+03  5.83565945e+03  3.50982671e+04]
E1 = -182.53530617136622  E_coul = 54.035939691037534
Extra cycle  E= -128.499366480329  delta_E= 2.84e-14  |g|= 7.97e-08  |ddm|= 5.65e-08
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816933e+01 5.69551062e+01 4.87344420e-01 7.81995924e+00
 1.65432251e+00 1.73218329e+00 6.26826993e+00 2.83917149e+01
 2.85983208e-01 5.41209595e-01]
grad_E = [-2.41268334e-12  3.49167224e-10 -6.88238937e-09  7.96195606e-08
  3.06274442e-06 -5.70840657e-07 -1.77774384e-04 -4.68885307e-06
  9.65676074e-05 -1.89734153e-02 -3.32689898e-05  5.12626130e-05
  7.18028389e-02 -5.02585629e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482409        1
[INPUT] 0    0    [1    /1   ]  174.907019197        1
[INPUT] 0    0    [1    /1   ]  20.4816834564        1
[INPUT] 0    0    [1    /1   ]  56.9551079022        1
[INPUT] 0    0    [1    /1   ]  0.488233726582       1
[INPUT] 0    0    [1    /1   ]  7.81997562066        1
[INPUT] 0    0    [1    /1   ]  1.65420376068        1
[INPUT] 1    0    [1    /1   ]  1.8277591094         1
[INPUT] 1    0    [1    /1   ]  6.26273847847        1
[INPUT] 1    0    [1    /1   ]  28.3917938906        1
[INPUT] 1    0    [1    /1   ]  1.00382507862e-09      1
[INPUT] 1    0    [1    /1   ]  0.664999164675       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002557, 1.0]], [0, [2712.096824072782, 1.0]], [0, [617.4984824092599, 1.0]], [0, [174.90701919745484, 1.0]], [0, [20.481683456424015, 1.0]], [0, [56.95510790218722, 1.0]], [0, [0.4882337265816422, 1.0]], [0, [7.81997562065637, 1.0]], [0, [1.6542037606810178, 1.0]], [1, [1.8277591093988783, 1.0]], [1, [6.262738478469324, 1.0]], [1, [28.391793890619937, 1.0]], [1, [1.0038250786159608e-09, 1.0]], [1, [0.6649991646747518, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848241]
bas 3, expnt(s) = [174.9070192]
bas 4, expnt(s) = [20.48168346]
bas 5, expnt(s) = [56.9551079]
bas 6, expnt(s) = [0.48823373]
bas 7, expnt(s) = [7.81997562]
bas 8, expnt(s) = [1.65420376]
bas 9, expnt(s) = [1.82775911]
bas 10, expnt(s) = [6.26273848]
bas 11, expnt(s) = [28.39179389]
bas 12, expnt(s) = [1.00382508e-09]
bas 13, expnt(s) = [0.66499916]
CPU time:        17.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816835e+01 2.43242390e+01 5.69551079e+01 5.23798841e+01
 4.88233727e-01 1.47565848e+00 7.81997562e+00 1.18146014e+01
 1.65420376e+00 3.68516364e+00 1.82775911e+00 6.19987722e+00
 6.26273848e+00 2.89027881e+01 2.83917939e+01 1.91194517e+02
 1.00382508e-09 1.64837851e-11 6.64999165e-01 1.75190587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.938917208723778
cond(S) = 239.41980214874482
E1 = -183.20671114629118  E_coul = 54.97648383693546
init E= -128.230227309356
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.755532252507698  LUMO = -0.000337057957955663
  mo_energy =
[-3.25627019e+01 -1.86349571e+00 -7.55532253e-01 -7.55532253e-01
 -7.55532253e-01 -3.37057958e-04 -3.37057958e-04 -3.37057958e-04
  2.05405657e+00  2.38021739e+00  2.38021739e+00  2.38021739e+00
  1.07313710e+01  1.07313710e+01  1.07313710e+01  1.94175268e+01
  5.41803467e+01  5.41803467e+01  5.41803467e+01  9.38349369e+01
  3.56148742e+02  1.34950931e+03  5.83595814e+03  3.50985857e+04]
E1 = -183.60867193807533  E_coul = 55.24516554149895
cycle= 1 E= -128.363506396576  delta_E= -0.133  |g|= 0.0696  |ddm|= 0.288
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0966585
diis-c [-0.00934286  1.        ]
  HOMO = -0.7193102255037  LUMO = -0.000337057957960168
  mo_energy =
[-3.25864641e+01 -1.81488363e+00 -7.19310226e-01 -7.19310226e-01
 -7.19310226e-01 -3.37057958e-04 -3.37057958e-04 -3.37057958e-04
  2.10323211e+00  2.42159011e+00  2.42159011e+00  2.42159011e+00
  1.07661214e+01  1.07661214e+01  1.07661214e+01  1.94433637e+01
  5.41692058e+01  5.41692058e+01  5.41692058e+01  9.38207011e+01
  3.56104500e+02  1.34943395e+03  5.83585300e+03  3.50984595e+04]
E1 = -183.63606563174005  E_coul = 55.27231691059077
cycle= 2 E= -128.363748721149  delta_E= -0.000242  |g|= 0.00761  |ddm|= 0.0249
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00870181
diis-c [-7.33628047e-05 -1.62102295e-02  1.01621023e+00]
  HOMO = -0.717594214556639  LUMO = -0.000337057957969344
  mo_energy =
[-3.25811589e+01 -1.81155756e+00 -7.17594215e-01 -7.17594215e-01
 -7.17594215e-01 -3.37057958e-04 -3.37057958e-04 -3.37057958e-04
  2.10566317e+00  2.42279580e+00  2.42279580e+00  2.42279580e+00
  1.07692522e+01  1.07692522e+01  1.07692522e+01  1.94476454e+01
  5.41742114e+01  5.41742114e+01  5.41742114e+01  9.38259238e+01
  3.56110198e+02  1.34943962e+03  5.83585847e+03  3.50984648e+04]
E1 = -183.62718036542827  E_coul = 55.26342507757427
cycle= 3 E= -128.363755287854  delta_E= -6.57e-06  |g|= 0.00162  |ddm|= 0.0046
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00333276
diis-c [-6.88885114e-06 -1.57172186e-02  1.64327066e-01  8.51390152e-01]
  HOMO = -0.71817487370353  LUMO = -0.000337057957955527
  mo_energy =
[-3.25829048e+01 -1.81186202e+00 -7.18174874e-01 -7.18174874e-01
 -7.18174874e-01 -3.37057958e-04 -3.37057958e-04 -3.37057958e-04
  2.10548858e+00  2.42240154e+00  2.42240154e+00  2.42240154e+00
  1.07683410e+01  1.07683410e+01  1.07683410e+01  1.94465991e+01
  5.41726588e+01  5.41726588e+01  5.41726588e+01  9.38243022e+01
  3.56108209e+02  1.34943734e+03  5.83585600e+03  3.50984623e+04]
E1 = -183.63000286434115  E_coul = 55.266247286731954
cycle= 4 E= -128.363755577609  delta_E= -2.9e-07  |g|= 0.000345  |ddm|= 0.000654
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000404491
diis-c [-1.18233907e-08  1.08683913e-03 -5.08261023e-02 -2.51960208e-02
  1.07493528e+00]
  HOMO = -0.71814275759646  LUMO = -0.00033705795795671
  mo_energy =
[-3.25827184e+01 -1.81173768e+00 -7.18142758e-01 -7.18142758e-01
 -7.18142758e-01 -3.37057958e-04 -3.37057958e-04 -3.37057958e-04
  2.10557455e+00  2.42242089e+00  2.42242089e+00  2.42242089e+00
  1.07684252e+01  1.07684252e+01  1.07684252e+01  1.94467508e+01
  5.41728331e+01  5.41728331e+01  5.41728331e+01  9.38244792e+01
  3.56108359e+02  1.34943744e+03  5.83585606e+03  3.50984623e+04]
E1 = -183.62962736491087  E_coul = 55.2658717734337
cycle= 5 E= -128.363755591477  delta_E= -1.39e-08  |g|= 1.56e-05  |ddm|= 0.00024
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.08345e-05
diis-c [-1.93913548e-11 -5.79835594e-05  3.98661909e-03 -6.83332926e-03
 -4.87907357e-02  1.05169543e+00]
  HOMO = -0.718149774616961  LUMO = -0.000337057957956182
  mo_energy =
[-3.25827350e+01 -1.81174497e+00 -7.18149775e-01 -7.18149775e-01
 -7.18149775e-01 -3.37057958e-04 -3.37057958e-04 -3.37057958e-04
  2.10556940e+00  2.42241604e+00  2.42241604e+00  2.42241604e+00
  1.07684142e+01  1.07684142e+01  1.07684142e+01  1.94467380e+01
  5.41728173e+01  5.41728173e+01  5.41728173e+01  9.38244629e+01
  3.56108341e+02  1.34943742e+03  5.83585604e+03  3.50984623e+04]
E1 = -183.6296554764926  E_coul = 55.26589988500005
cycle= 6 E= -128.363755591493  delta_E= -1.53e-11  |g|= 3.72e-07  |ddm|= 4.13e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -183.6296554764926  E_coul = 55.26589988500005
  HOMO = -0.718149559878654  LUMO = -0.000337057957973446
  mo_energy =
[-3.25827344e+01 -1.81174476e+00 -7.18149560e-01 -7.18149560e-01
 -7.18149560e-01 -3.37057958e-04 -3.37057958e-04 -3.37057958e-04
  2.10556955e+00  2.42241619e+00  2.42241619e+00  2.42241619e+00
  1.07684145e+01  1.07684145e+01  1.07684145e+01  1.94467384e+01
  5.41728178e+01  5.41728178e+01  5.41728178e+01  9.38244634e+01
  3.56108341e+02  1.34943742e+03  5.83585604e+03  3.50984623e+04]
E1 = -183.62965451247078  E_coul = 55.26589892097796
Extra cycle  E= -128.363755591493  delta_E= -2.84e-13  |g|= 1.31e-07  |ddm|= 1.26e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816835e+01 5.69551079e+01 4.88233727e-01 7.81997562e+00
 1.65420376e+00 1.82775911e+00 6.26273848e+00 2.83917939e+01
 1.00382508e-09 6.64999165e-01]
E = -128.3637555914928
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482388        1
[INPUT] 0    0    [1    /1   ]  174.907019423        1
[INPUT] 0    0    [1    /1   ]  20.4816922832        1
[INPUT] 0    0    [1    /1   ]  56.9551063639        1
[INPUT] 0    0    [1    /1   ]  0.487433350908       1
[INPUT] 0    0    [1    /1   ]  7.81996087592        1
[INPUT] 0    0    [1    /1   ]  1.65431063777        1
[INPUT] 1    0    [1    /1   ]  1.74174087063        1
[INPUT] 1    0    [1    /1   ]  6.26771678567        1
[INPUT] 1    0    [1    /1   ]  28.3917228313        1
[INPUT] 1    0    [1    /1   ]  0.25738488754        1
[INPUT] 1    0    [1    /1   ]  0.553588551754       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025578, 1.0]], [0, [2712.0968240738475, 1.0]], [0, [617.498482388152, 1.0]], [0, [174.90701942294126, 1.0]], [0, [20.48169228321905, 1.0]], [0, [56.95510636393564, 1.0]], [0, [0.48743335090799855, 1.0]], [0, [7.819960875917421, 1.0]], [0, [1.6543106377740375, 1.0]], [1, [1.7417408706275619, 1.0]], [1, [6.267716785668259, 1.0]], [1, [28.39172283127561, 1.0]], [1, [0.2573848875400471, 1.0]], [1, [0.5535885517541684, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848239]
bas 3, expnt(s) = [174.90701942]
bas 4, expnt(s) = [20.48169228]
bas 5, expnt(s) = [56.95510636]
bas 6, expnt(s) = [0.48743335]
bas 7, expnt(s) = [7.81996088]
bas 8, expnt(s) = [1.65431064]
bas 9, expnt(s) = [1.74174087]
bas 10, expnt(s) = [6.26771679]
bas 11, expnt(s) = [28.39172283]
bas 12, expnt(s) = [0.25738489]
bas 13, expnt(s) = [0.55358855]
CPU time:        17.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816923e+01 2.43242468e+01 5.69551064e+01 5.23798831e+01
 4.87433351e-01 1.47384379e+00 7.81996088e+00 1.18145847e+01
 1.65431064e+00 3.68534221e+00 1.74174087e+00 5.83732429e+00
 6.26771679e+00 2.89315098e+01 2.83917228e+01 1.91193919e+02
 2.57384888e-01 5.34826844e-01 5.53588552e-01 1.39305501e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99786879701852
cond(S) = 239.37127317479042
E1 = -183.53702009766215  E_coul = 55.07085940445641
init E= -128.466160693206
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770361153918154  LUMO = 0.697048233453193
  mo_energy =
[-3.25561645e+01 -1.85214335e+00 -7.70361154e-01 -7.70361154e-01
 -7.70361154e-01  6.97048233e-01  6.97048233e-01  6.97048233e-01
  2.06015698e+00  2.84509639e+00  2.84509639e+00  2.84509639e+00
  1.07510407e+01  1.07510407e+01  1.07510407e+01  1.94273822e+01
  5.40581621e+01  5.40581621e+01  5.40581621e+01  9.38397199e+01
  3.56155888e+02  1.34951930e+03  5.83596926e+03  3.50985974e+04]
E1 = -181.97666148889982  E_coul = 53.47845187440056
cycle= 1 E= -128.498209614499  delta_E= -0.032  |g|= 0.215  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502176
diis-c [-0.25218117  1.        ]
  HOMO = -0.881473660752711  LUMO = 0.678876637847617
  mo_energy =
[-3.28986540e+01 -1.96974204e+00 -8.81473661e-01 -8.81473661e-01
 -8.81473661e-01  6.78876638e-01  6.78876638e-01  6.78876638e-01
  1.98119184e+00  2.77321635e+00  2.77321635e+00  2.77321635e+00
  1.05678315e+01  1.05678315e+01  1.05678315e+01  1.91945815e+01
  5.37470717e+01  5.37470717e+01  5.37470717e+01  9.35177515e+01
  3.55782792e+02  1.34910685e+03  5.83552473e+03  3.50981312e+04]
E1 = -182.77401977470103  E_coul = 54.27289047493287
cycle= 2 E= -128.501129299768  delta_E= -0.00292  |g|= 0.108  |ddm|= 0.0789
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253309
diis-c [-5.32185705e-04  3.34600269e-01  6.65399731e-01]
  HOMO = -0.844069249881672  LUMO = 0.685391764161358
  mo_energy =
[-3.27853956e+01 -1.93024705e+00 -8.44069250e-01 -8.44069250e-01
 -8.44069250e-01  6.85391764e-01  6.85391764e-01  6.85391764e-01
  2.00784032e+00  2.79757296e+00  2.79757296e+00  2.79757296e+00
  1.06292096e+01  1.06292096e+01  1.06292096e+01  1.92724757e+01
  5.38503885e+01  5.38503885e+01  5.38503885e+01  9.36246779e+01
  3.55903266e+02  1.34923401e+03  5.83565509e+03  3.50982628e+04]
E1 = -182.5101828683482  E_coul = 54.00806914770186
cycle= 3 E= -128.502113720646  delta_E= -0.000984  |g|= 0.000361  |ddm|= 0.0261
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000511845
diis-c [-5.70212932e-08 -1.30688662e-03 -4.32862717e-03  1.00563551e+00]
  HOMO = -0.843970189219797  LUMO = 0.685465102937675
  mo_energy =
[-3.27852278e+01 -1.93010942e+00 -8.43970189e-01 -8.43970189e-01
 -8.43970189e-01  6.85465103e-01  6.85465103e-01  6.85465103e-01
  2.00801243e+00  2.79772779e+00  2.79772779e+00  2.79772779e+00
  1.06294075e+01  1.06294075e+01  1.06294075e+01  1.92726681e+01
  5.38505696e+01  5.38505696e+01  5.38505696e+01  9.36248596e+01
  3.55903428e+02  1.34923414e+03  5.83565518e+03  3.50982629e+04]
E1 = -182.5097856912337  E_coul = 54.007671953269046
cycle= 4 E= -128.502113737965  delta_E= -1.73e-08  |g|= 3.86e-05  |ddm|= 0.000296
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.64971e-05
diis-c [-6.35782762e-10  5.68565666e-05  3.39668221e-04 -8.49195459e-02
  1.08452302e+00]
  HOMO = -0.843962517458518  LUMO = 0.685469184886567
  mo_energy =
[-3.27852228e+01 -1.93009750e+00 -8.43962517e-01 -8.43962517e-01
 -8.43962517e-01  6.85469185e-01  6.85469185e-01  6.85469185e-01
  2.00802453e+00  2.79773683e+00  2.79773683e+00  2.79773683e+00
  1.06294160e+01  1.06294160e+01  1.06294160e+01  1.92726748e+01
  5.38505754e+01  5.38505754e+01  5.38505754e+01  9.36248654e+01
  3.55903436e+02  1.34923415e+03  5.83565519e+03  3.50982629e+04]
E1 = -182.50983779969292  E_coul = 54.00772406136648
cycle= 5 E= -128.502113738326  delta_E= -3.62e-10  |g|= 5.17e-06  |ddm|= 4.95e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.50983779969292  E_coul = 54.00772406136648
  HOMO = -0.843960368692927  LUMO = 0.685469807789738
  mo_energy =
[-3.27852193e+01 -1.93009442e+00 -8.43960369e-01 -8.43960369e-01
 -8.43960369e-01  6.85469808e-01  6.85469808e-01  6.85469808e-01
  2.00802708e+00  2.79773865e+00  2.79773865e+00  2.79773865e+00
  1.06294190e+01  1.06294190e+01  1.06294190e+01  1.92726784e+01
  5.38505789e+01  5.38505789e+01  5.38505789e+01  9.36248689e+01
  3.55903439e+02  1.34923415e+03  5.83565519e+03  3.50982629e+04]
E1 = -182.5098338898665  E_coul = 54.0077201515357
Extra cycle  E= -128.502113738331  delta_E= -4.38e-12  |g|= 1.07e-06  |ddm|= 4.56e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816923e+01 5.69551064e+01 4.87433351e-01 7.81996088e+00
 1.65431064e+00 1.74174087e+00 6.26771679e+00 2.83917228e+01
 2.57384888e-01 5.53588552e-01]
E = -128.50211373833082
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482388        1
[INPUT] 0    0    [1    /1   ]  174.907019423        1
[INPUT] 0    0    [1    /1   ]  20.4816922832        1
[INPUT] 0    0    [1    /1   ]  56.9551063639        1
[INPUT] 0    0    [1    /1   ]  0.487433350908       1
[INPUT] 0    0    [1    /1   ]  7.81996087592        1
[INPUT] 0    0    [1    /1   ]  1.65431063777        1
[INPUT] 1    0    [1    /1   ]  1.74174087063        1
[INPUT] 1    0    [1    /1   ]  6.26771678567        1
[INPUT] 1    0    [1    /1   ]  28.3917228313        1
[INPUT] 1    0    [1    /1   ]  0.25738488754        1
[INPUT] 1    0    [1    /1   ]  0.553588551754       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025578, 1.0]], [0, [2712.0968240738475, 1.0]], [0, [617.498482388152, 1.0]], [0, [174.90701942294126, 1.0]], [0, [20.48169228321905, 1.0]], [0, [56.95510636393564, 1.0]], [0, [0.48743335090799855, 1.0]], [0, [7.819960875917421, 1.0]], [0, [1.6543106377740375, 1.0]], [1, [1.7417408706275619, 1.0]], [1, [6.267716785668259, 1.0]], [1, [28.39172283127561, 1.0]], [1, [0.2573848875400471, 1.0]], [1, [0.5535885517541684, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848239]
bas 3, expnt(s) = [174.90701942]
bas 4, expnt(s) = [20.48169228]
bas 5, expnt(s) = [56.95510636]
bas 6, expnt(s) = [0.48743335]
bas 7, expnt(s) = [7.81996088]
bas 8, expnt(s) = [1.65431064]
bas 9, expnt(s) = [1.74174087]
bas 10, expnt(s) = [6.26771679]
bas 11, expnt(s) = [28.39172283]
bas 12, expnt(s) = [0.25738489]
bas 13, expnt(s) = [0.55358855]
CPU time:        17.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816923e+01 2.43242468e+01 5.69551064e+01 5.23798831e+01
 4.87433351e-01 1.47384379e+00 7.81996088e+00 1.18145847e+01
 1.65431064e+00 3.68534221e+00 1.74174087e+00 5.83732429e+00
 6.26771679e+00 2.89315098e+01 2.83917228e+01 1.91193919e+02
 2.57384888e-01 5.34826844e-01 5.53588552e-01 1.39305501e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99786879701852
cond(S) = 239.37127317479042
E1 = -183.53702009766215  E_coul = 55.07085940445641
init E= -128.466160693206
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770361153918154  LUMO = 0.697048233453193
  mo_energy =
[-3.25561645e+01 -1.85214335e+00 -7.70361154e-01 -7.70361154e-01
 -7.70361154e-01  6.97048233e-01  6.97048233e-01  6.97048233e-01
  2.06015698e+00  2.84509639e+00  2.84509639e+00  2.84509639e+00
  1.07510407e+01  1.07510407e+01  1.07510407e+01  1.94273822e+01
  5.40581621e+01  5.40581621e+01  5.40581621e+01  9.38397199e+01
  3.56155888e+02  1.34951930e+03  5.83596926e+03  3.50985974e+04]
E1 = -181.97666148889982  E_coul = 53.47845187440056
cycle= 1 E= -128.498209614499  delta_E= -0.032  |g|= 0.215  |ddm|= 0.163
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502176
diis-c [-0.25218117  1.        ]
  HOMO = -0.881473660752711  LUMO = 0.678876637847617
  mo_energy =
[-3.28986540e+01 -1.96974204e+00 -8.81473661e-01 -8.81473661e-01
 -8.81473661e-01  6.78876638e-01  6.78876638e-01  6.78876638e-01
  1.98119184e+00  2.77321635e+00  2.77321635e+00  2.77321635e+00
  1.05678315e+01  1.05678315e+01  1.05678315e+01  1.91945815e+01
  5.37470717e+01  5.37470717e+01  5.37470717e+01  9.35177515e+01
  3.55782792e+02  1.34910685e+03  5.83552473e+03  3.50981312e+04]
E1 = -182.77401977470103  E_coul = 54.27289047493287
cycle= 2 E= -128.501129299768  delta_E= -0.00292  |g|= 0.108  |ddm|= 0.0789
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253309
diis-c [-5.32185705e-04  3.34600269e-01  6.65399731e-01]
  HOMO = -0.844069249881672  LUMO = 0.685391764161358
  mo_energy =
[-3.27853956e+01 -1.93024705e+00 -8.44069250e-01 -8.44069250e-01
 -8.44069250e-01  6.85391764e-01  6.85391764e-01  6.85391764e-01
  2.00784032e+00  2.79757296e+00  2.79757296e+00  2.79757296e+00
  1.06292096e+01  1.06292096e+01  1.06292096e+01  1.92724757e+01
  5.38503885e+01  5.38503885e+01  5.38503885e+01  9.36246779e+01
  3.55903266e+02  1.34923401e+03  5.83565509e+03  3.50982628e+04]
E1 = -182.5101828683482  E_coul = 54.00806914770186
cycle= 3 E= -128.502113720646  delta_E= -0.000984  |g|= 0.000361  |ddm|= 0.0261
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000511845
diis-c [-5.70212932e-08 -1.30688662e-03 -4.32862717e-03  1.00563551e+00]
  HOMO = -0.843970189219797  LUMO = 0.685465102937675
  mo_energy =
[-3.27852278e+01 -1.93010942e+00 -8.43970189e-01 -8.43970189e-01
 -8.43970189e-01  6.85465103e-01  6.85465103e-01  6.85465103e-01
  2.00801243e+00  2.79772779e+00  2.79772779e+00  2.79772779e+00
  1.06294075e+01  1.06294075e+01  1.06294075e+01  1.92726681e+01
  5.38505696e+01  5.38505696e+01  5.38505696e+01  9.36248596e+01
  3.55903428e+02  1.34923414e+03  5.83565518e+03  3.50982629e+04]
E1 = -182.5097856912337  E_coul = 54.007671953269046
cycle= 4 E= -128.502113737965  delta_E= -1.73e-08  |g|= 3.86e-05  |ddm|= 0.000296
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.64971e-05
diis-c [-6.35782762e-10  5.68565666e-05  3.39668221e-04 -8.49195459e-02
  1.08452302e+00]
  HOMO = -0.843962517458518  LUMO = 0.685469184886567
  mo_energy =
[-3.27852228e+01 -1.93009750e+00 -8.43962517e-01 -8.43962517e-01
 -8.43962517e-01  6.85469185e-01  6.85469185e-01  6.85469185e-01
  2.00802453e+00  2.79773683e+00  2.79773683e+00  2.79773683e+00
  1.06294160e+01  1.06294160e+01  1.06294160e+01  1.92726748e+01
  5.38505754e+01  5.38505754e+01  5.38505754e+01  9.36248654e+01
  3.55903436e+02  1.34923415e+03  5.83565519e+03  3.50982629e+04]
E1 = -182.50983779969292  E_coul = 54.00772406136648
cycle= 5 E= -128.502113738326  delta_E= -3.62e-10  |g|= 5.17e-06  |ddm|= 4.95e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.50983779969292  E_coul = 54.00772406136648
  HOMO = -0.843960368692927  LUMO = 0.685469807789738
  mo_energy =
[-3.27852193e+01 -1.93009442e+00 -8.43960369e-01 -8.43960369e-01
 -8.43960369e-01  6.85469808e-01  6.85469808e-01  6.85469808e-01
  2.00802708e+00  2.79773865e+00  2.79773865e+00  2.79773865e+00
  1.06294190e+01  1.06294190e+01  1.06294190e+01  1.92726784e+01
  5.38505789e+01  5.38505789e+01  5.38505789e+01  9.36248689e+01
  3.55903439e+02  1.34923415e+03  5.83565519e+03  3.50982629e+04]
E1 = -182.5098338898665  E_coul = 54.0077201515357
Extra cycle  E= -128.502113738331  delta_E= -4.38e-12  |g|= 1.07e-06  |ddm|= 4.56e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.37127317479042
E1 = -182.5098338898665  E_coul = 54.0077201515357
init E= -128.502113738331
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.8439606188368  LUMO = 0.685469806357328
  mo_energy =
[-3.27852204e+01 -1.93009450e+00 -8.43960619e-01 -8.43960619e-01
 -8.43960619e-01  6.85469806e-01  6.85469806e-01  6.85469806e-01
  2.00802711e+00  2.79773856e+00  2.79773856e+00  2.79773856e+00
  1.06294185e+01  1.06294185e+01  1.06294185e+01  1.92726778e+01
  5.38505779e+01  5.38505779e+01  5.38505779e+01  9.36248678e+01
  3.55903438e+02  1.34923415e+03  5.83565519e+03  3.50982629e+04]
E1 = -182.50983740427236  E_coul = 54.00772366594141
cycle= 1 E= -128.502113738331  delta_E= -1.14e-13  |g|= 5e-07  |ddm|= 8.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.50983740427236  E_coul = 54.00772366594141
  HOMO = -0.843960368748315  LUMO = 0.685469856992955
  mo_energy =
[-3.27852197e+01 -1.93009419e+00 -8.43960369e-01 -8.43960369e-01
 -8.43960369e-01  6.85469857e-01  6.85469857e-01  6.85469857e-01
  2.00802733e+00  2.79773874e+00  2.79773874e+00  2.79773874e+00
  1.06294190e+01  1.06294190e+01  1.06294190e+01  1.92726783e+01
  5.38505786e+01  5.38505786e+01  5.38505786e+01  9.36248685e+01
  3.55903438e+02  1.34923415e+03  5.83565519e+03  3.50982629e+04]
E1 = -182.50983591267368  E_coul = 54.00772217434249
Extra cycle  E= -128.502113738331  delta_E= -2.56e-13  |g|= 2.06e-07  |ddm|= 2.41e-07
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816923e+01 5.69551064e+01 4.87433351e-01 7.81996088e+00
 1.65431064e+00 1.74174087e+00 6.26771679e+00 2.83917228e+01
 2.57384888e-01 5.53588552e-01]
grad_E = [-4.29685123e-12  4.49778444e-10 -8.85225707e-09  1.03973052e-07
  3.99317272e-06 -7.51208049e-07 -3.78252795e-04 -5.95264994e-06
  1.61298781e-04 -2.83553166e-02  6.60635215e-04  3.81829455e-05
  6.31454225e-02 -3.82883373e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482599        1
[INPUT] 0    0    [1    /1   ]  174.907016898        1
[INPUT] 0    0    [1    /1   ]  20.4815971991        1
[INPUT] 0    0    [1    /1   ]  56.9551248359        1
[INPUT] 0    0    [1    /1   ]  0.500668821297       1
[INPUT] 0    0    [1    /1   ]  7.82009398834        1
[INPUT] 0    0    [1    /1   ]  1.64899957065        1
[INPUT] 1    0    [1    /1   ]  2.53593025374        1
[INPUT] 1    0    [1    /1   ]  6.22391697952        1
[INPUT] 1    0    [1    /1   ]  28.3920454561        1
[INPUT] 1    0    [1    /1   ]  1.00000030478e-09      1
[INPUT] 1    0    [1    /1   ]  0.924941764726       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025727, 1.0]], [0, [2712.0968240631423, 1.0]], [0, [617.4984825986933, 1.0]], [0, [174.90701689828327, 1.0]], [0, [20.48159719906552, 1.0]], [0, [56.95512483592095, 1.0]], [0, [0.500668821297174, 1.0]], [0, [7.820093988337928, 1.0]], [0, [1.648999570649927, 1.0]], [1, [2.535930253739674, 1.0]], [1, [6.2239169795181, 1.0]], [1, [28.392045456108892, 1.0]], [1, [1.000000304784976e-09, 1.0]], [1, [0.9249417647260889, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.4984826]
bas 3, expnt(s) = [174.9070169]
bas 4, expnt(s) = [20.4815972]
bas 5, expnt(s) = [56.95512484]
bas 6, expnt(s) = [0.50066882]
bas 7, expnt(s) = [7.82009399]
bas 8, expnt(s) = [1.64899957]
bas 9, expnt(s) = [2.53593025]
bas 10, expnt(s) = [6.22391698]
bas 11, expnt(s) = [28.39204546]
bas 12, expnt(s) = [1.0000003e-09]
bas 13, expnt(s) = [0.92494176]
CPU time:        20.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907017e+02 1.21512358e+02
 2.04815972e+01 2.43241622e+01 5.69551248e+01 5.23798958e+01
 5.00668821e-01 1.50375794e+00 7.82009399e+00 1.18147355e+01
 1.64899957e+00 3.67646496e+00 2.53593025e+00 9.33589640e+00
 6.22391698e+00 2.86790084e+01 2.83920455e+01 1.91196635e+02
 1.00000030e-09 1.64053144e-11 9.24941765e-01 2.64622873e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.846683923884289
cond(S) = 240.01654934862404
E1 = -182.71158473080635  E_coul = 54.83686962205387
init E= -127.874715108752
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.733984210599598  LUMO = -0.000336415220882069
  mo_energy =
[-3.25735768e+01 -1.88029534e+00 -7.33984211e-01 -7.33984211e-01
 -7.33984211e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  2.07234068e+00  3.52058342e+00  3.52058342e+00  3.52058342e+00
  1.35337843e+01  1.35337843e+01  1.35337843e+01  1.94392577e+01
  5.70803455e+01  5.70803455e+01  5.70803455e+01  9.38514548e+01
  3.56160933e+02  1.34951827e+03  5.83596430e+03  3.50985887e+04]
E1 = -184.97502411413245  E_coul = 56.83706532619995
cycle= 1 E= -128.137958787933  delta_E= -0.263  |g|= 0.206  |ddm|= 0.608
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.321839
diis-c [-0.1035804  1.       ]
  HOMO = -0.559582785932379  LUMO = -0.000336415220875352
  mo_energy =
[-3.22887033e+01 -1.68480118e+00 -5.59582786e-01 -5.59582786e-01
 -5.59582786e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  2.23452790e+00  3.70094613e+00  3.70094613e+00  3.70094613e+00
  1.37750314e+01  1.37750314e+01  1.37750314e+01  1.97059520e+01
  5.73578843e+01  5.73578843e+01  5.73578843e+01  9.41335325e+01
  3.56433331e+02  1.34976593e+03  5.83618379e+03  3.50987874e+04]
E1 = -184.53288640488563  E_coul = 56.39213869121282
cycle= 2 E= -128.140747713673  delta_E= -0.00279  |g|= 0.0589  |ddm|= 0.0903
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.119988
diis-c [-0.00179554  0.26027899  0.73972101]
  HOMO = -0.583003373529392  LUMO = -0.000336415220870933
  mo_energy =
[-3.23631938e+01 -1.70438724e+00 -5.83003374e-01 -5.83003374e-01
 -5.83003374e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  2.22220440e+00  3.68045724e+00  3.68045724e+00  3.68045724e+00
  1.37356349e+01  1.37356349e+01  1.37356349e+01  1.96582618e+01
  5.72916206e+01  5.72916206e+01  5.72916206e+01  9.40639416e+01
  3.56352690e+02  1.34967900e+03  5.83609345e+03  3.50986956e+04]
E1 = -184.6307461868663  E_coul = 56.489764725227836
cycle= 3 E= -128.140981461638  delta_E= -0.000234  |g|= 0.00523  |ddm|= 0.0153
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00867385
diis-c [-1.88133818e-05 -2.35610783e-02 -1.20991762e-01  1.14455284e+00]
  HOMO = -0.584437011718495  LUMO = -0.000336415220872235
  mo_energy =
[-3.23660629e+01 -1.70441387e+00 -5.84437012e-01 -5.84437012e-01
 -5.84437012e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  2.22230261e+00  3.67917310e+00  3.67917310e+00  3.67917310e+00
  1.37338172e+01  1.37338172e+01  1.37338172e+01  1.96565685e+01
  5.72890745e+01  5.72890745e+01  5.72890745e+01  9.40613204e+01
  3.56349551e+02  1.34967531e+03  5.83608933e+03  3.50986913e+04]
E1 = -184.63312262712543  E_coul = 56.49213760799359
cycle= 4 E= -128.140985019132  delta_E= -3.56e-06  |g|= 0.00051  |ddm|= 0.00328
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00080837
diis-c [-1.82319554e-08  9.55931350e-04  4.73938565e-03 -1.37044859e-01
  1.13134954e+00]
  HOMO = -0.584558780064068  LUMO = -0.000336415220869899
  mo_energy =
[-3.23662784e+01 -1.70437879e+00 -5.84558780e-01 -5.84558780e-01
 -5.84558780e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  2.22232065e+00  3.67905235e+00  3.67905235e+00  3.67905235e+00
  1.37336719e+01  1.37336719e+01  1.37336719e+01  1.96564666e+01
  5.72888856e+01  5.72888856e+01  5.72888856e+01  9.40611154e+01
  3.56349206e+02  1.34967480e+03  5.83608872e+03  3.50986906e+04]
E1 = -184.6331981072356  E_coul = 56.49221305585051
cycle= 5 E= -128.140985051385  delta_E= -3.23e-08  |g|= 1.44e-05  |ddm|= 0.000347
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.79962e-05
diis-c [-2.45257928e-11 -6.70124333e-06 -3.58579716e-04  5.78624759e-03
 -4.60647956e-02  1.04064383e+00]
  HOMO = -0.584564894471814  LUMO = -0.000336415220870024
  mo_energy =
[-3.23662948e+01 -1.70438508e+00 -5.84564894e-01 -5.84564894e-01
 -5.84564894e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  2.22231671e+00  3.67904713e+00  3.67904713e+00  3.67904713e+00
  1.37336618e+01  1.37336618e+01  1.37336618e+01  1.96564547e+01
  5.72888704e+01  5.72888704e+01  5.72888704e+01  9.40610994e+01
  3.56349188e+02  1.34967478e+03  5.83608870e+03  3.50986906e+04]
E1 = -184.63322166048647  E_coul = 56.49223660908881
cycle= 6 E= -128.140985051398  delta_E= -1.26e-11  |g|= 1.46e-07  |ddm|= 4.25e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -184.63322166048647  E_coul = 56.49223660908881
  HOMO = -0.584564838228138  LUMO = -0.000336415220871569
  mo_energy =
[-3.23662946e+01 -1.70438506e+00 -5.84564838e-01 -5.84564838e-01
 -5.84564838e-01 -3.36415221e-04 -3.36415221e-04 -3.36415221e-04
  2.22231673e+00  3.67904717e+00  3.67904717e+00  3.67904717e+00
  1.37336618e+01  1.37336618e+01  1.37336618e+01  1.96564548e+01
  5.72888705e+01  5.72888705e+01  5.72888705e+01  9.40610995e+01
  3.56349188e+02  1.34967478e+03  5.83608870e+03  3.50986906e+04]
E1 = -184.63322151537898  E_coul = 56.492236463981364
Extra cycle  E= -128.140985051398  delta_E= 2.84e-14  |g|= 3.09e-08  |ddm|= 6.8e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907017e+02
 2.04815972e+01 5.69551248e+01 5.00668821e-01 7.82009399e+00
 1.64899957e+00 2.53593025e+00 6.22391698e+00 2.83920455e+01
 1.00000030e-09 9.24941765e-01]
E = -128.14098505139762
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482409        1
[INPUT] 0    0    [1    /1   ]  174.90701917         1
[INPUT] 0    0    [1    /1   ]  20.4816827748        1
[INPUT] 0    0    [1    /1   ]  56.9551082111        1
[INPUT] 0    0    [1    /1   ]  0.488756897947       1
[INPUT] 0    0    [1    /1   ]  7.81997418716        1
[INPUT] 0    0    [1    /1   ]  1.65377953106        1
[INPUT] 1    0    [1    /1   ]  1.82115980894        1
[INPUT] 1    0    [1    /1   ]  6.26333680505        1
[INPUT] 1    0    [1    /1   ]  28.3917550938        1
[INPUT] 1    0    [1    /1   ]  0.231646398886       1
[INPUT] 1    0    [1    /1   ]  0.590723873051       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025592, 1.0]], [0, [2712.096824072777, 1.0]], [0, [617.4984824092061, 1.0]], [0, [174.90701917047545, 1.0]], [0, [20.481682774803698, 1.0]], [0, [56.955108211134174, 1.0]], [0, [0.4887568979469161, 1.0]], [0, [7.819974187159472, 1.0]], [0, [1.6537795310616266, 1.0]], [1, [1.821159808938773, 1.0]], [1, [6.263336805053243, 1.0]], [1, [28.39175509375894, 1.0]], [1, [0.23164639888604244, 1.0]], [1, [0.5907238730513604, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848241]
bas 3, expnt(s) = [174.90701917]
bas 4, expnt(s) = [20.48168277]
bas 5, expnt(s) = [56.95510821]
bas 6, expnt(s) = [0.4887569]
bas 7, expnt(s) = [7.81997419]
bas 8, expnt(s) = [1.65377953]
bas 9, expnt(s) = [1.82115981]
bas 10, expnt(s) = [6.26333681]
bas 11, expnt(s) = [28.39175509]
bas 12, expnt(s) = [0.2316464]
bas 13, expnt(s) = [0.59072387]
CPU time:        20.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816828e+01 2.43242384e+01 5.69551082e+01 5.23798844e+01
 4.88756898e-01 1.47684426e+00 7.81997419e+00 1.18145998e+01
 1.65377953e+00 3.68445480e+00 1.82115981e+00 6.17190829e+00
 6.26333681e+00 2.89062397e+01 2.83917551e+01 1.91194191e+02
 2.31646399e-01 4.68831015e-01 5.90723873e-01 1.51082807e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998827582369064
cond(S) = 239.43498084852646
E1 = -183.54391376044703  E_coul = 55.07302619106684
init E= -128.47088756938
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770802916298214  LUMO = 0.654006848937554
  mo_energy =
[-3.25562685e+01 -1.85181389e+00 -7.70802916e-01 -7.70802916e-01
 -7.70802916e-01  6.54006849e-01  6.54006849e-01  6.54006849e-01
  2.06447341e+00  2.88856569e+00  2.88856569e+00  2.88856569e+00
  1.10142474e+01  1.10142474e+01  1.10142474e+01  1.94316380e+01
  5.43272159e+01  5.43272159e+01  5.43272159e+01  9.38427137e+01
  3.56158602e+02  1.34952190e+03  5.83597163e+03  3.50985994e+04]
E1 = -181.95586233644164  E_coul = 53.453498919512406
cycle= 1 E= -128.502363416929  delta_E= -0.0315  |g|= 0.218  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50049
diis-c [-0.25049062  1.        ]
  HOMO = -0.884116189994849  LUMO = 0.635511565386061
  mo_energy =
[-3.29030593e+01 -1.97204665e+00 -8.84116190e-01 -8.84116190e-01
 -8.84116190e-01  6.35511565e-01  6.35511565e-01  6.35511565e-01
  1.98313605e+00  2.81110068e+00  2.81110068e+00  2.81110068e+00
  1.08268314e+01  1.08268314e+01  1.08268314e+01  1.91954201e+01
  5.40125063e+01  5.40125063e+01  5.40125063e+01  9.35166378e+01
  3.55780789e+02  1.34910442e+03  5.83552198e+03  3.50981281e+04]
E1 = -182.76761302861644  E_coul = 54.262277699546644
cycle= 2 E= -128.50533532907  delta_E= -0.00297  |g|= 0.11  |ddm|= 0.0788
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.255065
diis-c [-5.25538092e-04  3.36914388e-01  6.63085612e-01]
  HOMO = -0.846147101231315  LUMO = 0.641928030473788
  mo_energy =
[-3.27882486e+01 -1.93194145e+00 -8.46147101e-01 -8.46147101e-01
 -8.46147101e-01  6.41928030e-01  6.41928030e-01  6.41928030e-01
  2.01020615e+00  2.83699825e+00  2.83699825e+00  2.83699825e+00
  1.08895289e+01  1.08895289e+01  1.08895289e+01  1.92744560e+01
  5.41171667e+01  5.41171667e+01  5.41171667e+01  9.36250445e+01
  3.55902892e+02  1.34923330e+03  5.83565410e+03  3.50982615e+04]
E1 = -182.4966410630332  E_coul = 53.99027619809666
cycle= 3 E= -128.506364864937  delta_E= -0.00103  |g|= 0.00025  |ddm|= 0.0264
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000543205
diis-c [-4.15141896e-08 -1.38386281e-03 -4.64217361e-03  1.00602604e+00]
  HOMO = -0.8461014049526  LUMO = 0.641979114217953
  mo_energy =
[-3.27881160e+01 -1.93188226e+00 -8.46101405e-01 -8.46101405e-01
 -8.46101405e-01  6.41979114e-01  6.41979114e-01  6.41979114e-01
  2.01030646e+00  2.83710490e+00  2.83710490e+00  2.83710490e+00
  1.08896666e+01  1.08896666e+01  1.08896666e+01  1.92745871e+01
  5.41173066e+01  5.41173066e+01  5.41173066e+01  9.36251876e+01
  3.55903040e+02  1.34923343e+03  5.83565421e+03  3.50982616e+04]
E1 = -182.49606871288054  E_coul = 53.98970384184334
cycle= 4 E= -128.506364871037  delta_E= -6.1e-09  |g|= 1.74e-05  |ddm|= 8.58e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.11846e-05
diis-c [-1.66047234e-10 -3.18193144e-05  6.71504424e-05 -3.67243551e-02
  1.03668902e+00]
  HOMO = -0.846104427187837  LUMO = 0.641979059967046
  mo_energy =
[-3.27881222e+01 -1.93188788e+00 -8.46104427e-01 -8.46104427e-01
 -8.46104427e-01  6.41979060e-01  6.41979060e-01  6.41979060e-01
  2.01030276e+00  2.83710324e+00  2.83710324e+00  2.83710324e+00
  1.08896612e+01  1.08896612e+01  1.08896612e+01  1.92745787e+01
  5.41173002e+01  5.41173002e+01  5.41173002e+01  9.36251816e+01
  3.55903039e+02  1.34923344e+03  5.83565422e+03  3.50982616e+04]
E1 = -182.4961027183239  E_coul = 53.98973784725486
cycle= 5 E= -128.506364871069  delta_E= -3.18e-11  |g|= 2.69e-06  |ddm|= 1.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4961027183239  E_coul = 53.98973784725486
  HOMO = -0.846102832550244  LUMO = 0.641979388748197
  mo_energy =
[-3.27881185e+01 -1.93188649e+00 -8.46102833e-01 -8.46102833e-01
 -8.46102833e-01  6.41979389e-01  6.41979389e-01  6.41979389e-01
  2.01030379e+00  2.83710442e+00  2.83710442e+00  2.83710442e+00
  1.08896636e+01  1.08896636e+01  1.08896636e+01  1.92745814e+01
  5.41173036e+01  5.41173036e+01  5.41173036e+01  9.36251851e+01
  3.55903043e+02  1.34923344e+03  5.83565423e+03  3.50982616e+04]
E1 = -182.49609490484522  E_coul = 53.989730033775494
Extra cycle  E= -128.50636487107  delta_E= -7.11e-13  |g|= 1.14e-06  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816828e+01 5.69551082e+01 4.88756898e-01 7.81997419e+00
 1.65377953e+00 1.82115981e+00 6.26333681e+00 2.83917551e+01
 2.31646399e-01 5.90723873e-01]
E = -128.50636487106974
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482409        1
[INPUT] 0    0    [1    /1   ]  174.90701917         1
[INPUT] 0    0    [1    /1   ]  20.4816827748        1
[INPUT] 0    0    [1    /1   ]  56.9551082111        1
[INPUT] 0    0    [1    /1   ]  0.488756897947       1
[INPUT] 0    0    [1    /1   ]  7.81997418716        1
[INPUT] 0    0    [1    /1   ]  1.65377953106        1
[INPUT] 1    0    [1    /1   ]  1.82115980894        1
[INPUT] 1    0    [1    /1   ]  6.26333680505        1
[INPUT] 1    0    [1    /1   ]  28.3917550938        1
[INPUT] 1    0    [1    /1   ]  0.231646398886       1
[INPUT] 1    0    [1    /1   ]  0.590723873051       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025592, 1.0]], [0, [2712.096824072777, 1.0]], [0, [617.4984824092061, 1.0]], [0, [174.90701917047545, 1.0]], [0, [20.481682774803698, 1.0]], [0, [56.955108211134174, 1.0]], [0, [0.4887568979469161, 1.0]], [0, [7.819974187159472, 1.0]], [0, [1.6537795310616266, 1.0]], [1, [1.821159808938773, 1.0]], [1, [6.263336805053243, 1.0]], [1, [28.39175509375894, 1.0]], [1, [0.23164639888604244, 1.0]], [1, [0.5907238730513604, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848241]
bas 3, expnt(s) = [174.90701917]
bas 4, expnt(s) = [20.48168277]
bas 5, expnt(s) = [56.95510821]
bas 6, expnt(s) = [0.4887569]
bas 7, expnt(s) = [7.81997419]
bas 8, expnt(s) = [1.65377953]
bas 9, expnt(s) = [1.82115981]
bas 10, expnt(s) = [6.26333681]
bas 11, expnt(s) = [28.39175509]
bas 12, expnt(s) = [0.2316464]
bas 13, expnt(s) = [0.59072387]
CPU time:        20.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816828e+01 2.43242384e+01 5.69551082e+01 5.23798844e+01
 4.88756898e-01 1.47684426e+00 7.81997419e+00 1.18145998e+01
 1.65377953e+00 3.68445480e+00 1.82115981e+00 6.17190829e+00
 6.26333681e+00 2.89062397e+01 2.83917551e+01 1.91194191e+02
 2.31646399e-01 4.68831015e-01 5.90723873e-01 1.51082807e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998827582369064
cond(S) = 239.43498084852646
E1 = -183.54391376044703  E_coul = 55.07302619106684
init E= -128.47088756938
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770802916298214  LUMO = 0.654006848937554
  mo_energy =
[-3.25562685e+01 -1.85181389e+00 -7.70802916e-01 -7.70802916e-01
 -7.70802916e-01  6.54006849e-01  6.54006849e-01  6.54006849e-01
  2.06447341e+00  2.88856569e+00  2.88856569e+00  2.88856569e+00
  1.10142474e+01  1.10142474e+01  1.10142474e+01  1.94316380e+01
  5.43272159e+01  5.43272159e+01  5.43272159e+01  9.38427137e+01
  3.56158602e+02  1.34952190e+03  5.83597163e+03  3.50985994e+04]
E1 = -181.95586233644164  E_coul = 53.453498919512406
cycle= 1 E= -128.502363416929  delta_E= -0.0315  |g|= 0.218  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50049
diis-c [-0.25049062  1.        ]
  HOMO = -0.884116189994849  LUMO = 0.635511565386061
  mo_energy =
[-3.29030593e+01 -1.97204665e+00 -8.84116190e-01 -8.84116190e-01
 -8.84116190e-01  6.35511565e-01  6.35511565e-01  6.35511565e-01
  1.98313605e+00  2.81110068e+00  2.81110068e+00  2.81110068e+00
  1.08268314e+01  1.08268314e+01  1.08268314e+01  1.91954201e+01
  5.40125063e+01  5.40125063e+01  5.40125063e+01  9.35166378e+01
  3.55780789e+02  1.34910442e+03  5.83552198e+03  3.50981281e+04]
E1 = -182.76761302861644  E_coul = 54.262277699546644
cycle= 2 E= -128.50533532907  delta_E= -0.00297  |g|= 0.11  |ddm|= 0.0788
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.255065
diis-c [-5.25538092e-04  3.36914388e-01  6.63085612e-01]
  HOMO = -0.846147101231315  LUMO = 0.641928030473788
  mo_energy =
[-3.27882486e+01 -1.93194145e+00 -8.46147101e-01 -8.46147101e-01
 -8.46147101e-01  6.41928030e-01  6.41928030e-01  6.41928030e-01
  2.01020615e+00  2.83699825e+00  2.83699825e+00  2.83699825e+00
  1.08895289e+01  1.08895289e+01  1.08895289e+01  1.92744560e+01
  5.41171667e+01  5.41171667e+01  5.41171667e+01  9.36250445e+01
  3.55902892e+02  1.34923330e+03  5.83565410e+03  3.50982615e+04]
E1 = -182.4966410630332  E_coul = 53.99027619809666
cycle= 3 E= -128.506364864937  delta_E= -0.00103  |g|= 0.00025  |ddm|= 0.0264
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000543205
diis-c [-4.15141896e-08 -1.38386281e-03 -4.64217361e-03  1.00602604e+00]
  HOMO = -0.8461014049526  LUMO = 0.641979114217953
  mo_energy =
[-3.27881160e+01 -1.93188226e+00 -8.46101405e-01 -8.46101405e-01
 -8.46101405e-01  6.41979114e-01  6.41979114e-01  6.41979114e-01
  2.01030646e+00  2.83710490e+00  2.83710490e+00  2.83710490e+00
  1.08896666e+01  1.08896666e+01  1.08896666e+01  1.92745871e+01
  5.41173066e+01  5.41173066e+01  5.41173066e+01  9.36251876e+01
  3.55903040e+02  1.34923343e+03  5.83565421e+03  3.50982616e+04]
E1 = -182.49606871288054  E_coul = 53.98970384184334
cycle= 4 E= -128.506364871037  delta_E= -6.1e-09  |g|= 1.74e-05  |ddm|= 8.58e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.11846e-05
diis-c [-1.66047234e-10 -3.18193144e-05  6.71504424e-05 -3.67243551e-02
  1.03668902e+00]
  HOMO = -0.846104427187837  LUMO = 0.641979059967046
  mo_energy =
[-3.27881222e+01 -1.93188788e+00 -8.46104427e-01 -8.46104427e-01
 -8.46104427e-01  6.41979060e-01  6.41979060e-01  6.41979060e-01
  2.01030276e+00  2.83710324e+00  2.83710324e+00  2.83710324e+00
  1.08896612e+01  1.08896612e+01  1.08896612e+01  1.92745787e+01
  5.41173002e+01  5.41173002e+01  5.41173002e+01  9.36251816e+01
  3.55903039e+02  1.34923344e+03  5.83565422e+03  3.50982616e+04]
E1 = -182.4961027183239  E_coul = 53.98973784725486
cycle= 5 E= -128.506364871069  delta_E= -3.18e-11  |g|= 2.69e-06  |ddm|= 1.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4961027183239  E_coul = 53.98973784725486
  HOMO = -0.846102832550244  LUMO = 0.641979388748197
  mo_energy =
[-3.27881185e+01 -1.93188649e+00 -8.46102833e-01 -8.46102833e-01
 -8.46102833e-01  6.41979389e-01  6.41979389e-01  6.41979389e-01
  2.01030379e+00  2.83710442e+00  2.83710442e+00  2.83710442e+00
  1.08896636e+01  1.08896636e+01  1.08896636e+01  1.92745814e+01
  5.41173036e+01  5.41173036e+01  5.41173036e+01  9.36251851e+01
  3.55903043e+02  1.34923344e+03  5.83565423e+03  3.50982616e+04]
E1 = -182.49609490484522  E_coul = 53.989730033775494
Extra cycle  E= -128.50636487107  delta_E= -7.11e-13  |g|= 1.14e-06  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.43498084852646
E1 = -182.49609490484522  E_coul = 53.989730033775494
init E= -128.50636487107
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.846103357865245  LUMO = 0.641979308494677
  mo_energy =
[-3.27881202e+01 -1.93188710e+00 -8.46103358e-01 -8.46103358e-01
 -8.46103358e-01  6.41979308e-01  6.41979308e-01  6.41979308e-01
  2.01030339e+00  2.83710408e+00  2.83710408e+00  2.83710408e+00
  1.08896627e+01  1.08896627e+01  1.08896627e+01  1.92745802e+01
  5.41173020e+01  5.41173020e+01  5.41173020e+01  9.36251835e+01
  3.55903041e+02  1.34923344e+03  5.83565422e+03  3.50982616e+04]
E1 = -182.49609915136693  E_coul = 53.989734280296844
cycle= 1 E= -128.50636487107  delta_E= -3.69e-13  |g|= 5.67e-07  |ddm|= 5.02e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.49609915136693  E_coul = 53.989734280296844
  HOMO = -0.846103054212658  LUMO = 0.641979360594841
  mo_energy =
[-3.27881193e+01 -1.93188679e+00 -8.46103054e-01 -8.46103054e-01
 -8.46103054e-01  6.41979361e-01  6.41979361e-01  6.41979361e-01
  2.01030360e+00  2.83710428e+00  2.83710428e+00  2.83710428e+00
  1.08896632e+01  1.08896632e+01  1.08896632e+01  1.92745808e+01
  5.41173028e+01  5.41173028e+01  5.41173028e+01  9.36251843e+01
  3.55903042e+02  1.34923344e+03  5.83565422e+03  3.50982616e+04]
E1 = -182.4960970246133  E_coul = 53.9897321535434
Extra cycle  E= -128.50636487107  delta_E= 1.99e-13  |g|= 2.89e-07  |ddm|= 1.97e-07
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816828e+01 5.69551082e+01 4.88756898e-01 7.81997419e+00
 1.65377953e+00 1.82115981e+00 6.26333681e+00 2.83917551e+01
 2.31646399e-01 5.90723873e-01]
grad_E = [-1.71259945e-11  1.16139855e-09 -2.20804549e-08  2.83584920e-07
  1.40501866e-05 -2.03815402e-06  2.61871370e-03 -2.70760269e-05
 -7.68323256e-04 -9.38668046e-03 -7.61218363e-03  4.64552120e-04
  4.80839506e-02 -3.13102438e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482471        1
[INPUT] 0    0    [1    /1   ]  174.907018385        1
[INPUT] 0    0    [1    /1   ]  20.4816449438        1
[INPUT] 0    0    [1    /1   ]  56.9551138425        1
[INPUT] 0    0    [1    /1   ]  0.483124404161       1
[INPUT] 0    0    [1    /1   ]  7.82004552414        1
[INPUT] 0    0    [1    /1   ]  1.65548110582        1
[INPUT] 1    0    [1    /1   ]  1.88894979424        1
[INPUT] 1    0    [1    /1   ]  6.27777534947        1
[INPUT] 1    0    [1    /1   ]  28.3907388373        1
[INPUT] 1    0    [1    /1   ]  0.125621839793       1
[INPUT] 1    0    [1    /1   ]  0.64290861624        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025636, 1.0]], [0, [2712.0968240695242, 1.0]], [0, [617.4984824713545, 1.0]], [0, [174.9070183852796, 1.0]], [0, [20.48164494378147, 1.0]], [0, [56.955113842494555, 1.0]], [0, [0.4831244041611337, 1.0]], [0, [7.820045524135627, 1.0]], [0, [1.6554811058168475, 1.0]], [1, [1.888949794236653, 1.0]], [1, [6.277775349474675, 1.0]], [1, [28.390738837277276, 1.0]], [1, [0.12562183979294234, 1.0]], [1, [0.642908616239684, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848247]
bas 3, expnt(s) = [174.90701839]
bas 4, expnt(s) = [20.48164494]
bas 5, expnt(s) = [56.95511384]
bas 6, expnt(s) = [0.4831244]
bas 7, expnt(s) = [7.82004552]
bas 8, expnt(s) = [1.65548111]
bas 9, expnt(s) = [1.88894979]
bas 10, expnt(s) = [6.27777535]
bas 11, expnt(s) = [28.39073884]
bas 12, expnt(s) = [0.12562184]
bas 13, expnt(s) = [0.64290862]
CPU time:        22.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816449e+01 2.43242047e+01 5.69551138e+01 5.23798882e+01
 4.83124404e-01 1.46406128e+00 7.82004552e+00 1.18146806e+01
 1.65548111e+00 3.68729764e+00 1.88894979e+00 6.46040748e+00
 6.27777535e+00 2.89895588e+01 2.83907388e+01 1.91185636e+02
 1.25621840e-01 2.18180448e-01 6.42908616e-01 1.67946497e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.992420912956977
cond(S) = 239.1434896104646
E1 = -183.50694029960692  E_coul = 55.06256967236787
init E= -128.444370627239
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.768873473193261  LUMO = 0.376678622724442
  mo_energy =
[-3.25560872e+01 -1.85331748e+00 -7.68873473e-01 -7.68873473e-01
 -7.68873473e-01  3.76678623e-01  3.76678623e-01  3.76678623e-01
  2.04636955e+00  2.65813581e+00  2.65813581e+00  2.65813581e+00
  1.10630595e+01  1.10630595e+01  1.10630595e+01  1.94109838e+01
  5.44991625e+01  5.44991625e+01  5.44991625e+01  9.38276345e+01
  3.56144876e+02  1.34950876e+03  5.83595961e+03  3.50985890e+04]
E1 = -182.08149927099353  E_coul = 53.59525113223749
cycle= 1 E= -128.486248138756  delta_E= -0.0419  |g|= 0.197  |ddm|= 0.195
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.418206
diis-c [-0.17489656  1.        ]
  HOMO = -0.871064442476441  LUMO = 0.367096074674786
  mo_energy =
[-3.28746671e+01 -1.96005635e+00 -8.71064442e-01 -8.71064442e-01
 -8.71064442e-01  3.67096075e-01  3.67096075e-01  3.67096075e-01
  1.97428483e+00  2.58315784e+00  2.58315784e+00  2.58315784e+00
  1.08917765e+01  1.08917765e+01  1.08917765e+01  1.91974837e+01
  5.42103438e+01  5.42103438e+01  5.42103438e+01  9.35287210e+01
  3.55797171e+02  1.34912300e+03  5.83554217e+03  3.50981501e+04]
E1 = -182.79656457674733  E_coul = 54.307886596037854
cycle= 2 E= -128.488677980709  delta_E= -0.00243  |g|= 0.0966  |ddm|= 0.076
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.209776
diis-c [-6.47868462e-04  3.32811296e-01  6.67188704e-01]
  HOMO = -0.8374512943527  LUMO = 0.370557165653734
  mo_energy =
[-3.27726228e+01 -1.92468072e+00 -8.37451294e-01 -8.37451294e-01
 -8.37451294e-01  3.70557166e-01  3.70557166e-01  3.70557166e-01
  1.99798506e+00  2.60733317e+00  2.60733317e+00  2.60733317e+00
  1.09480898e+01  1.09480898e+01  1.09480898e+01  1.92676301e+01
  5.43033164e+01  5.43033164e+01  5.43033164e+01  9.36250678e+01
  3.55905764e+02  1.34923764e+03  5.83565970e+03  3.50982687e+04]
E1 = -182.54767000829304  E_coul = 54.05817319932433
cycle= 3 E= -128.489496808969  delta_E= -0.000819  |g|= 0.00183  |ddm|= 0.0252
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00258759
diis-c [-2.95834324e-06 -1.04625481e-02 -1.18823251e-02  1.02234487e+00]
  HOMO = -0.838350874390791  LUMO = 0.370369545169551
  mo_energy =
[-3.27740085e+01 -1.92565582e+00 -8.38350874e-01 -8.38350874e-01
 -8.38350874e-01  3.70369545e-01  3.70369545e-01  3.70369545e-01
  1.99716613e+00  2.60651784e+00  2.60651784e+00  2.60651784e+00
  1.09469505e+01  1.09469505e+01  1.09469505e+01  1.92664132e+01
  5.43019782e+01  5.43019782e+01  5.43019782e+01  9.36237274e+01
  3.55904385e+02  1.34923623e+03  5.83565825e+03  3.50982672e+04]
E1 = -182.54807589979322  E_coul = 54.05857842860476
cycle= 4 E= -128.489497471188  delta_E= -6.62e-07  |g|= 0.000256  |ddm|= 0.00128
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000330629
diis-c [-7.52419323e-09  4.42327096e-04  1.67929656e-04 -1.83573536e-01
  1.18296328e+00]
  HOMO = -0.838493206007775  LUMO = 0.370334987647201
  mo_energy =
[-3.27741919e+01 -1.92583265e+00 -8.38493206e-01 -8.38493206e-01
 -8.38493206e-01  3.70334988e-01  3.70334988e-01  3.70334988e-01
  1.99700614e+00  2.60637131e+00  2.60637131e+00  2.60637131e+00
  1.09467643e+01  1.09467643e+01  1.09467643e+01  1.92662212e+01
  5.43017915e+01  5.43017915e+01  5.43017915e+01  9.36235422e+01
  3.55904208e+02  1.34923606e+03  5.83565809e+03  3.50982671e+04]
E1 = -182.54804019464572  E_coul = 54.058542708019715
cycle= 5 E= -128.489497486626  delta_E= -1.54e-08  |g|= 1.47e-05  |ddm|= 0.000232
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.85767e-05
diis-c [-9.13934649e-11 -7.11740214e-05 -1.45297131e-04  3.37329918e-02
 -2.21410422e-01  1.18789390e+00]
  HOMO = -0.83849025200348  LUMO = 0.370335261315599
  mo_energy =
[-3.27741846e+01 -1.92583378e+00 -8.38490252e-01 -8.38490252e-01
 -8.38490252e-01  3.70335261e-01  3.70335261e-01  3.70335261e-01
  1.99700501e+00  2.60637324e+00  2.60637324e+00  2.60637324e+00
  1.09467682e+01  1.09467682e+01  1.09467682e+01  1.92662248e+01
  5.43017977e+01  5.43017977e+01  5.43017977e+01  9.36235487e+01
  3.55904217e+02  1.34923607e+03  5.83565810e+03  3.50982671e+04]
E1 = -182.54801805293275  E_coul = 54.058520566272406
cycle= 6 E= -128.48949748666  delta_E= -3.43e-11  |g|= 7.6e-07  |ddm|= 9.65e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.54801805293275  E_coul = 54.058520566272406
  HOMO = -0.838490130310736  LUMO = 0.370335261639027
  mo_energy =
[-3.27741842e+01 -1.92583383e+00 -8.38490130e-01 -8.38490130e-01
 -8.38490130e-01  3.70335262e-01  3.70335262e-01  3.70335262e-01
  1.99700495e+00  2.60637330e+00  2.60637330e+00  2.60637330e+00
  1.09467684e+01  1.09467684e+01  1.09467684e+01  1.92662249e+01
  5.43017980e+01  5.43017980e+01  5.43017980e+01  9.36235491e+01
  3.55904218e+02  1.34923607e+03  5.83565810e+03  3.50982671e+04]
E1 = -182.5480170359466  E_coul = 54.058519549286395
Extra cycle  E= -128.48949748666  delta_E= 1.42e-13  |g|= 1.96e-07  |ddm|= 3.59e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907018e+02
 2.04816449e+01 5.69551138e+01 4.83124404e-01 7.82004552e+00
 1.65548111e+00 1.88894979e+00 6.27777535e+00 2.83907388e+01
 1.25621840e-01 6.42908616e-01]
E = -128.4894974866602
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482419        1
[INPUT] 0    0    [1    /1   ]  174.90701905         1
[INPUT] 0    0    [1    /1   ]  20.4816769556        1
[INPUT] 0    0    [1    /1   ]  56.9551090773        1
[INPUT] 0    0    [1    /1   ]  0.487890508897       1
[INPUT] 0    0    [1    /1   ]  7.8199851602         1
[INPUT] 0    0    [1    /1   ]  1.65404126694        1
[INPUT] 1    0    [1    /1   ]  1.83158725071        1
[INPUT] 1    0    [1    /1   ]  6.26555773902        1
[INPUT] 1    0    [1    /1   ]  28.3915987734        1
[INPUT] 1    0    [1    /1   ]  0.215337722736       1
[INPUT] 1    0    [1    /1   ]  0.598750919652       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.4787300256, 1.0]], [0, [2712.096824072277, 1.0]], [0, [617.4984824187658, 1.0]], [0, [174.9070190496968, 1.0]], [0, [20.48167695564354, 1.0]], [0, [56.95510907734889, 1.0]], [0, [0.4878905088965451, 1.0]], [0, [7.819985160198658, 1.0]], [0, [1.6540412669449456, 1.0]], [1, [1.8315872507115716, 1.0]], [1, [6.265557739024196, 1.0]], [1, [28.391598773393294, 1.0]], [1, [0.21533772273613763, 1.0]], [1, [0.5987509196517334, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848242]
bas 3, expnt(s) = [174.90701905]
bas 4, expnt(s) = [20.48167696]
bas 5, expnt(s) = [56.95510908]
bas 6, expnt(s) = [0.48789051]
bas 7, expnt(s) = [7.81998516]
bas 8, expnt(s) = [1.65404127]
bas 9, expnt(s) = [1.83158725]
bas 10, expnt(s) = [6.26555774]
bas 11, expnt(s) = [28.39159877]
bas 12, expnt(s) = [0.21533772]
bas 13, expnt(s) = [0.59875092]
CPU time:        22.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816770e+01 2.43242332e+01 5.69551091e+01 5.23798850e+01
 4.87890509e-01 1.47488039e+00 7.81998516e+00 1.18146122e+01
 1.65404127e+00 3.68489214e+00 1.83158725e+00 6.21611309e+00
 6.26555774e+00 2.89190527e+01 2.83915988e+01 1.91192875e+02
 2.15337723e-01 4.27941631e-01 5.98750920e-01 1.53653386e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999128857401015
cond(S) = 239.3899344504135
E1 = -183.54594254229232  E_coul = 55.07357030972522
init E= -128.472372232567
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770942130383414  LUMO = 0.617380130475336
  mo_energy =
[-3.25560948e+01 -1.85178273e+00 -7.70942130e-01 -7.70942130e-01
 -7.70942130e-01  6.17380130e-01  6.17380130e-01  6.17380130e-01
  2.06192474e+00  2.85300832e+00  2.85300832e+00  2.85300832e+00
  1.10186006e+01  1.10186006e+01  1.10186006e+01  1.94287384e+01
  5.43509057e+01  5.43509057e+01  5.43509057e+01  9.38405574e+01
  3.56156694e+02  1.34952013e+03  5.83597005e+03  3.50985981e+04]
E1 = -181.9390819796234  E_coul = 53.43591399861197
cycle= 1 E= -128.503167981011  delta_E= -0.0308  |g|= 0.219  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.500032
diis-c [-0.25003182  1.        ]
  HOMO = -0.885694553666265  LUMO = 0.599219855633346
  mo_energy =
[-3.29060005e+01 -1.97362333e+00 -8.85694554e-01 -8.85694554e-01
 -8.85694554e-01  5.99219856e-01  5.99219856e-01  5.99219856e-01
  1.97926115e+00  2.77357688e+00  2.77357688e+00  2.77357688e+00
  1.08286843e+01  1.08286843e+01  1.08286843e+01  1.91900939e+01
  5.40331930e+01  5.40331930e+01  5.40331930e+01  9.35114850e+01
  3.55775822e+02  1.34909965e+03  5.83551742e+03  3.50981238e+04]
E1 = -182.760119976381  E_coul = 54.2539379622305
cycle= 2 E= -128.50618201415  delta_E= -0.00301  |g|= 0.111  |ddm|= 0.0795
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.255918
diis-c [-5.33813551e-04  3.37861473e-01  6.62138527e-01]
  HOMO = -0.847334561452364  LUMO = 0.60540531948644
  mo_energy =
[-3.27900916e+01 -1.93309707e+00 -8.47334561e-01 -8.47334561e-01
 -8.47334561e-01  6.05405319e-01  6.05405319e-01  6.05405319e-01
  2.00659897e+00  2.79994464e+00  2.79994464e+00  2.79994464e+00
  1.08921599e+01  1.08921599e+01  1.08921599e+01  1.92699279e+01
  5.41388649e+01  5.41388649e+01  5.41388649e+01  9.36209367e+01
  3.55899074e+02  1.34922972e+03  5.83565076e+03  3.50982584e+04]
E1 = -182.4844980825137  E_coul = 53.97725820761098
cycle= 3 E= -128.507239874903  delta_E= -0.00106  |g|= 0.000213  |ddm|= 0.0268
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000500254
diis-c [-6.35221608e-08 -1.49086072e-03 -4.53755052e-03  1.00602841e+00]
  HOMO = -0.847351073054075  LUMO = 0.605432335743456
  mo_energy =
[-3.27900446e+01 -1.93311535e+00 -8.47351073e-01 -8.47351073e-01
 -8.47351073e-01  6.05432336e-01  6.05432336e-01  6.05432336e-01
  2.00662928e+00  2.79999222e+00  2.79999222e+00  2.79999222e+00
  1.08922190e+01  1.08922190e+01  1.08922190e+01  1.92699768e+01
  5.41389196e+01  5.41389196e+01  5.41389196e+01  9.36209952e+01
  3.55899138e+02  1.34922978e+03  5.83565079e+03  3.50982584e+04]
E1 = -182.4838593898608  E_coul = 53.976619506416306
cycle= 4 E= -128.507239883444  delta_E= -8.54e-09  |g|= 3.66e-05  |ddm|= 0.000129
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.26729e-05
diis-c [-7.28932342e-10  1.86901358e-05  2.94235783e-04 -9.55631537e-02
  1.09525023e+00]
  HOMO = -0.847366630137118  LUMO = 0.605428119951558
  mo_energy =
[-3.27900666e+01 -1.93313849e+00 -8.47366630e-01 -8.47366630e-01
 -8.47366630e-01  6.05428120e-01  6.05428120e-01  6.05428120e-01
  2.00660995e+00  2.79997832e+00  2.79997832e+00  2.79997832e+00
  1.08921971e+01  1.08921971e+01  1.08921971e+01  1.92699506e+01
  5.41388968e+01  5.41388968e+01  5.41388968e+01  9.36209731e+01
  3.55899123e+02  1.34922977e+03  5.83565079e+03  3.50982584e+04]
E1 = -182.48388728268662  E_coul = 53.97664739904999
cycle= 5 E= -128.507239883637  delta_E= -1.92e-10  |g|= 4.48e-06  |ddm|= 2.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48388728268662  E_coul = 53.97664739904999
  HOMO = -0.847365295487378  LUMO = 0.605428201873703
  mo_energy =
[-3.27900624e+01 -1.93313797e+00 -8.47365295e-01 -8.47365295e-01
 -8.47365295e-01  6.05428202e-01  6.05428202e-01  6.05428202e-01
  2.00661006e+00  2.79997901e+00  2.79997901e+00  2.79997901e+00
  1.08921993e+01  1.08921993e+01  1.08921993e+01  1.92699532e+01
  5.41389005e+01  5.41389005e+01  5.41389005e+01  9.36209770e+01
  3.55899128e+02  1.34922978e+03  5.83565080e+03  3.50982584e+04]
E1 = -182.4838731854549  E_coul = 53.97663330181482
Extra cycle  E= -128.50723988364  delta_E= -3.47e-12  |g|= 2.05e-06  |ddm|= 2.81e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816770e+01 5.69551091e+01 4.87890509e-01 7.81998516e+00
 1.65404127e+00 1.83158725e+00 6.26555774e+00 2.83915988e+01
 2.15337723e-01 5.98750920e-01]
E = -128.5072398836401
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482419        1
[INPUT] 0    0    [1    /1   ]  174.90701905         1
[INPUT] 0    0    [1    /1   ]  20.4816769556        1
[INPUT] 0    0    [1    /1   ]  56.9551090773        1
[INPUT] 0    0    [1    /1   ]  0.487890508897       1
[INPUT] 0    0    [1    /1   ]  7.8199851602         1
[INPUT] 0    0    [1    /1   ]  1.65404126694        1
[INPUT] 1    0    [1    /1   ]  1.83158725071        1
[INPUT] 1    0    [1    /1   ]  6.26555773902        1
[INPUT] 1    0    [1    /1   ]  28.3915987734        1
[INPUT] 1    0    [1    /1   ]  0.215337722736       1
[INPUT] 1    0    [1    /1   ]  0.598750919652       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.4787300256, 1.0]], [0, [2712.096824072277, 1.0]], [0, [617.4984824187658, 1.0]], [0, [174.9070190496968, 1.0]], [0, [20.48167695564354, 1.0]], [0, [56.95510907734889, 1.0]], [0, [0.4878905088965451, 1.0]], [0, [7.819985160198658, 1.0]], [0, [1.6540412669449456, 1.0]], [1, [1.8315872507115716, 1.0]], [1, [6.265557739024196, 1.0]], [1, [28.391598773393294, 1.0]], [1, [0.21533772273613763, 1.0]], [1, [0.5987509196517334, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848242]
bas 3, expnt(s) = [174.90701905]
bas 4, expnt(s) = [20.48167696]
bas 5, expnt(s) = [56.95510908]
bas 6, expnt(s) = [0.48789051]
bas 7, expnt(s) = [7.81998516]
bas 8, expnt(s) = [1.65404127]
bas 9, expnt(s) = [1.83158725]
bas 10, expnt(s) = [6.26555774]
bas 11, expnt(s) = [28.39159877]
bas 12, expnt(s) = [0.21533772]
bas 13, expnt(s) = [0.59875092]
CPU time:        23.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907019e+02 1.21512359e+02
 2.04816770e+01 2.43242332e+01 5.69551091e+01 5.23798850e+01
 4.87890509e-01 1.47488039e+00 7.81998516e+00 1.18146122e+01
 1.65404127e+00 3.68489214e+00 1.83158725e+00 6.21611309e+00
 6.26555774e+00 2.89190527e+01 2.83915988e+01 1.91192875e+02
 2.15337723e-01 4.27941631e-01 5.98750920e-01 1.53653386e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999128857401015
cond(S) = 239.3899344504135
E1 = -183.54594254229232  E_coul = 55.07357030972522
init E= -128.472372232567
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770942130383414  LUMO = 0.617380130475336
  mo_energy =
[-3.25560948e+01 -1.85178273e+00 -7.70942130e-01 -7.70942130e-01
 -7.70942130e-01  6.17380130e-01  6.17380130e-01  6.17380130e-01
  2.06192474e+00  2.85300832e+00  2.85300832e+00  2.85300832e+00
  1.10186006e+01  1.10186006e+01  1.10186006e+01  1.94287384e+01
  5.43509057e+01  5.43509057e+01  5.43509057e+01  9.38405574e+01
  3.56156694e+02  1.34952013e+03  5.83597005e+03  3.50985981e+04]
E1 = -181.9390819796234  E_coul = 53.43591399861197
cycle= 1 E= -128.503167981011  delta_E= -0.0308  |g|= 0.219  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.500032
diis-c [-0.25003182  1.        ]
  HOMO = -0.885694553666265  LUMO = 0.599219855633346
  mo_energy =
[-3.29060005e+01 -1.97362333e+00 -8.85694554e-01 -8.85694554e-01
 -8.85694554e-01  5.99219856e-01  5.99219856e-01  5.99219856e-01
  1.97926115e+00  2.77357688e+00  2.77357688e+00  2.77357688e+00
  1.08286843e+01  1.08286843e+01  1.08286843e+01  1.91900939e+01
  5.40331930e+01  5.40331930e+01  5.40331930e+01  9.35114850e+01
  3.55775822e+02  1.34909965e+03  5.83551742e+03  3.50981238e+04]
E1 = -182.760119976381  E_coul = 54.2539379622305
cycle= 2 E= -128.50618201415  delta_E= -0.00301  |g|= 0.111  |ddm|= 0.0795
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.255918
diis-c [-5.33813551e-04  3.37861473e-01  6.62138527e-01]
  HOMO = -0.847334561452364  LUMO = 0.60540531948644
  mo_energy =
[-3.27900916e+01 -1.93309707e+00 -8.47334561e-01 -8.47334561e-01
 -8.47334561e-01  6.05405319e-01  6.05405319e-01  6.05405319e-01
  2.00659897e+00  2.79994464e+00  2.79994464e+00  2.79994464e+00
  1.08921599e+01  1.08921599e+01  1.08921599e+01  1.92699279e+01
  5.41388649e+01  5.41388649e+01  5.41388649e+01  9.36209367e+01
  3.55899074e+02  1.34922972e+03  5.83565076e+03  3.50982584e+04]
E1 = -182.4844980825137  E_coul = 53.97725820761098
cycle= 3 E= -128.507239874903  delta_E= -0.00106  |g|= 0.000213  |ddm|= 0.0268
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000500254
diis-c [-6.35221608e-08 -1.49086072e-03 -4.53755052e-03  1.00602841e+00]
  HOMO = -0.847351073054075  LUMO = 0.605432335743456
  mo_energy =
[-3.27900446e+01 -1.93311535e+00 -8.47351073e-01 -8.47351073e-01
 -8.47351073e-01  6.05432336e-01  6.05432336e-01  6.05432336e-01
  2.00662928e+00  2.79999222e+00  2.79999222e+00  2.79999222e+00
  1.08922190e+01  1.08922190e+01  1.08922190e+01  1.92699768e+01
  5.41389196e+01  5.41389196e+01  5.41389196e+01  9.36209952e+01
  3.55899138e+02  1.34922978e+03  5.83565079e+03  3.50982584e+04]
E1 = -182.4838593898608  E_coul = 53.976619506416306
cycle= 4 E= -128.507239883444  delta_E= -8.54e-09  |g|= 3.66e-05  |ddm|= 0.000129
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.26729e-05
diis-c [-7.28932342e-10  1.86901358e-05  2.94235783e-04 -9.55631537e-02
  1.09525023e+00]
  HOMO = -0.847366630137118  LUMO = 0.605428119951558
  mo_energy =
[-3.27900666e+01 -1.93313849e+00 -8.47366630e-01 -8.47366630e-01
 -8.47366630e-01  6.05428120e-01  6.05428120e-01  6.05428120e-01
  2.00660995e+00  2.79997832e+00  2.79997832e+00  2.79997832e+00
  1.08921971e+01  1.08921971e+01  1.08921971e+01  1.92699506e+01
  5.41388968e+01  5.41388968e+01  5.41388968e+01  9.36209731e+01
  3.55899123e+02  1.34922977e+03  5.83565079e+03  3.50982584e+04]
E1 = -182.48388728268662  E_coul = 53.97664739904999
cycle= 5 E= -128.507239883637  delta_E= -1.92e-10  |g|= 4.48e-06  |ddm|= 2.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48388728268662  E_coul = 53.97664739904999
  HOMO = -0.847365295487378  LUMO = 0.605428201873703
  mo_energy =
[-3.27900624e+01 -1.93313797e+00 -8.47365295e-01 -8.47365295e-01
 -8.47365295e-01  6.05428202e-01  6.05428202e-01  6.05428202e-01
  2.00661006e+00  2.79997901e+00  2.79997901e+00  2.79997901e+00
  1.08921993e+01  1.08921993e+01  1.08921993e+01  1.92699532e+01
  5.41389005e+01  5.41389005e+01  5.41389005e+01  9.36209770e+01
  3.55899128e+02  1.34922978e+03  5.83565080e+03  3.50982584e+04]
E1 = -182.4838731854549  E_coul = 53.97663330181482
Extra cycle  E= -128.50723988364  delta_E= -3.47e-12  |g|= 2.05e-06  |ddm|= 2.81e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.3899344504135
E1 = -182.4838731854549  E_coul = 53.97663330181482
init E= -128.50723988364
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.847366288823263  LUMO = 0.605428015112825
  mo_energy =
[-3.27900652e+01 -1.93313922e+00 -8.47366289e-01 -8.47366289e-01
 -8.47366289e-01  6.05428015e-01  6.05428015e-01  6.05428015e-01
  2.00660916e+00  2.79997828e+00  2.79997828e+00  2.79997828e+00
  1.08921976e+01  1.08921976e+01  1.08921976e+01  1.92699511e+01
  5.41388979e+01  5.41388979e+01  5.41388979e+01  9.36209743e+01
  3.55899125e+02  1.34922977e+03  5.83565079e+03  3.50982584e+04]
E1 = -182.4838793301487  E_coul = 53.97663944650826
cycle= 1 E= -128.50723988364  delta_E= -3.69e-13  |g|= 8.48e-07  |ddm|= 9.98e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4838793301487  E_coul = 53.97663944650826
  HOMO = -0.847365853600455  LUMO = 0.605428080038041
  mo_energy =
[-3.27900639e+01 -1.93313880e+00 -8.47365854e-01 -8.47365854e-01
 -8.47365854e-01  6.05428080e-01  6.05428080e-01  6.05428080e-01
  2.00660943e+00  2.79997857e+00  2.79997857e+00  2.79997857e+00
  1.08921984e+01  1.08921984e+01  1.08921984e+01  1.92699521e+01
  5.41388992e+01  5.41388992e+01  5.41388992e+01  9.36209756e+01
  3.55899126e+02  1.34922977e+03  5.83565080e+03  3.50982584e+04]
E1 = -182.4838759768477  E_coul = 53.97663609320728
Extra cycle  E= -128.50723988364  delta_E= 2.84e-14  |g|= 4.54e-07  |ddm|= 3.02e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907019e+02
 2.04816770e+01 5.69551091e+01 4.87890509e-01 7.81998516e+00
 1.65404127e+00 1.83158725e+00 6.26555774e+00 2.83915988e+01
 2.15337723e-01 5.98750920e-01]
grad_E = [-7.97757130e-12  6.58001685e-10 -1.26256917e-08  1.57866695e-07
  7.45496721e-06 -1.13426864e-06  2.36252670e-04 -1.34272582e-05
 -1.26679599e-04 -1.67204428e-02 -6.97962161e-03  4.45165789e-04
  1.85109266e-02 -8.20652298e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482471        1
[INPUT] 0    0    [1    /1   ]  174.907018392        1
[INPUT] 0    0    [1    /1   ]  20.4816476297        1
[INPUT] 0    0    [1    /1   ]  56.9551138522        1
[INPUT] 0    0    [1    /1   ]  0.487326734114       1
[INPUT] 0    0    [1    /1   ]  7.82003524535        1
[INPUT] 0    0    [1    /1   ]  1.65416365834        1
[INPUT] 1    0    [1    /1   ]  1.93576525558        1
[INPUT] 1    0    [1    /1   ]  6.27848623984        1
[INPUT] 1    0    [1    /1   ]  28.390567637         1
[INPUT] 1    0    [1    /1   ]  0.203433468296       1
[INPUT] 1    0    [1    /1   ]  0.640314548275       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002564, 1.0]], [0, [2712.0968240695474, 1.0]], [0, [617.4984824714305, 1.0]], [0, [174.90701839158197, 1.0]], [0, [20.48164762969266, 1.0]], [0, [56.95511385219901, 1.0]], [0, [0.4873267341144706, 1.0]], [0, [7.8200352453522814, 1.0]], [0, [1.6541636583356671, 1.0]], [1, [1.935765255582982, 1.0]], [1, [6.2784862398420085, 1.0]], [1, [28.39056763699824, 1.0]], [1, [0.20343346829633113, 1.0]], [1, [0.6403145482745349, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848247]
bas 3, expnt(s) = [174.90701839]
bas 4, expnt(s) = [20.48164763]
bas 5, expnt(s) = [56.95511385]
bas 6, expnt(s) = [0.48732673]
bas 7, expnt(s) = [7.82003525]
bas 8, expnt(s) = [1.65416366]
bas 9, expnt(s) = [1.93576526]
bas 10, expnt(s) = [6.27848624]
bas 11, expnt(s) = [28.39056764]
bas 12, expnt(s) = [0.20343347]
bas 13, expnt(s) = [0.64031455]
CPU time:        25.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816476e+01 2.43242071e+01 5.69551139e+01 5.23798882e+01
 4.87326734e-01 1.47360200e+00 7.82003525e+00 1.18146689e+01
 1.65416366e+00 3.68509663e+00 1.93576526e+00 6.66116599e+00
 6.27848624e+00 2.89936623e+01 2.83905676e+01 1.91184195e+02
 2.03433468e-01 3.98577149e-01 6.40314548e-01 1.67099867e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999177557901358
cond(S) = 239.35980486039338
E1 = -183.54742619482872  E_coul = 55.074542033605724
init E= -128.472884161223
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.770923356442614  LUMO = 0.598795480391715
  mo_energy =
[-3.25562515e+01 -1.85161650e+00 -7.70923356e-01 -7.70923356e-01
 -7.70923356e-01  5.98795480e-01  5.98795480e-01  5.98795480e-01
  2.06022968e+00  2.97219974e+00  2.97219974e+00  2.97219974e+00
  1.14263249e+01  1.14263249e+01  1.14263249e+01  1.94269918e+01
  5.47988406e+01  5.47988406e+01  5.47988406e+01  9.38388506e+01
  3.56155371e+02  1.34951916e+03  5.83596929e+03  3.50985975e+04]
E1 = -181.93188900281427  E_coul = 53.427807887127784
cycle= 1 E= -128.504081115686  delta_E= -0.0312  |g|= 0.22  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.495621
diis-c [-0.24564047  1.        ]
  HOMO = -0.88654723952917  LUMO = 0.580161234812233
  mo_energy =
[-3.29071750e+01 -1.97441022e+00 -8.86547240e-01 -8.86547240e-01
 -8.86547240e-01  5.80161235e-01  5.80161235e-01  5.80161235e-01
  1.97660339e+00  2.88714777e+00  2.88714777e+00  2.88714777e+00
  1.12340150e+01  1.12340150e+01  1.12340150e+01  1.91874186e+01
  5.44806818e+01  5.44806818e+01  5.44806818e+01  9.35088162e+01
  3.55773158e+02  1.34909710e+03  5.83551501e+03  3.50981216e+04]
E1 = -182.75536997383256  E_coul = 54.248281823203165
cycle= 2 E= -128.507088150629  delta_E= -0.00301  |g|= 0.111  |ddm|= 0.0796
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254858
diis-c [-5.27108870e-04  3.38921517e-01  6.61078483e-01]
  HOMO = -0.848125110992601  LUMO = 0.586404751805927
  mo_energy =
[-3.27911355e+01 -1.93382149e+00 -8.48125111e-01 -8.48125111e-01
 -8.48125111e-01  5.86404752e-01  5.86404752e-01  5.86404752e-01
  2.00395931e+00  2.91509027e+00  2.91509027e+00  2.91509027e+00
  1.12980948e+01  1.12980948e+01  1.12980948e+01  1.92673778e+01
  5.45863478e+01  5.45863478e+01  5.45863478e+01  9.36183992e+01
  3.55896548e+02  1.34922733e+03  5.83564851e+03  3.50982563e+04]
E1 = -182.47702855814293  E_coul = 53.968869209870185
cycle= 3 E= -128.508159348273  delta_E= -0.00107  |g|= 0.0003  |ddm|= 0.027
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000493376
diis-c [-1.42740093e-07 -1.95659943e-03 -4.91116641e-03  1.00686777e+00]
  HOMO = -0.848225079882228  LUMO = 0.586406477503707
  mo_energy =
[-3.27911846e+01 -1.93393983e+00 -8.48225080e-01 -8.48225080e-01
 -8.48225080e-01  5.86406478e-01  5.86406478e-01  5.86406478e-01
  2.00390051e+00  2.91505958e+00  2.91505958e+00  2.91505958e+00
  1.12980482e+01  1.12980482e+01  1.12980482e+01  1.92673167e+01
  5.45863036e+01  5.45863036e+01  5.45863036e+01  9.36183601e+01
  3.55896532e+02  1.34922732e+03  5.83564850e+03  3.50982563e+04]
E1 = -182.4763829197042  E_coul = 53.96822354826591
cycle= 4 E= -128.508159371438  delta_E= -2.32e-08  |g|= 6.48e-05  |ddm|= 0.000256
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.33718e-05
diis-c [-1.38445897e-09  9.86751920e-05  5.29388607e-04 -1.57512243e-01
  1.15688418e+00]
  HOMO = -0.848254823569272  LUMO = 0.586397665210293
  mo_energy =
[-3.27912244e+01 -1.93398261e+00 -8.48254824e-01 -8.48254824e-01
 -8.48254824e-01  5.86397665e-01  5.86397665e-01  5.86397665e-01
  2.00386369e+00  2.91503086e+00  2.91503086e+00  2.91503086e+00
  1.12980073e+01  1.12980073e+01  1.12980073e+01  1.92672704e+01
  5.45862622e+01  5.45862622e+01  5.45862622e+01  9.36183197e+01
  3.55896501e+02  1.34922730e+03  5.83564849e+03  3.50982563e+04]
E1 = -182.47640731035932  E_coul = 53.968247938198104
cycle= 5 E= -128.508159372161  delta_E= -7.23e-10  |g|= 6.04e-06  |ddm|= 5.45e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.47640731035932  E_coul = 53.968247938198104
  HOMO = -0.848252337061255  LUMO = 0.586397960948475
  mo_energy =
[-3.27912176e+01 -1.93398110e+00 -8.48252337e-01 -8.48252337e-01
 -8.48252337e-01  5.86397961e-01  5.86397961e-01  5.86397961e-01
  2.00386452e+00  2.91503248e+00  2.91503248e+00  2.91503248e+00
  1.12980112e+01  1.12980112e+01  1.12980112e+01  1.92672750e+01
  5.45862683e+01  5.45862683e+01  5.45862683e+01  9.36183260e+01
  3.55896508e+02  1.34922731e+03  5.83564849e+03  3.50982563e+04]
E1 = -182.47638670806663  E_coul = 53.96822733590029
Extra cycle  E= -128.508159372166  delta_E= -5.12e-12  |g|= 2.95e-06  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907018e+02
 2.04816476e+01 5.69551139e+01 4.87326734e-01 7.82003525e+00
 1.65416366e+00 1.93576526e+00 6.27848624e+00 2.83905676e+01
 2.03433468e-01 6.40314548e-01]
E = -128.50815937216635
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482471        1
[INPUT] 0    0    [1    /1   ]  174.907018392        1
[INPUT] 0    0    [1    /1   ]  20.4816476297        1
[INPUT] 0    0    [1    /1   ]  56.9551138522        1
[INPUT] 0    0    [1    /1   ]  0.487326734114       1
[INPUT] 0    0    [1    /1   ]  7.82003524535        1
[INPUT] 0    0    [1    /1   ]  1.65416365834        1
[INPUT] 1    0    [1    /1   ]  1.93576525558        1
[INPUT] 1    0    [1    /1   ]  6.27848623984        1
[INPUT] 1    0    [1    /1   ]  28.390567637         1
[INPUT] 1    0    [1    /1   ]  0.203433468296       1
[INPUT] 1    0    [1    /1   ]  0.640314548275       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002564, 1.0]], [0, [2712.0968240695474, 1.0]], [0, [617.4984824714305, 1.0]], [0, [174.90701839158197, 1.0]], [0, [20.48164762969266, 1.0]], [0, [56.95511385219901, 1.0]], [0, [0.4873267341144706, 1.0]], [0, [7.8200352453522814, 1.0]], [0, [1.6541636583356671, 1.0]], [1, [1.935765255582982, 1.0]], [1, [6.2784862398420085, 1.0]], [1, [28.39056763699824, 1.0]], [1, [0.20343346829633113, 1.0]], [1, [0.6403145482745349, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848247]
bas 3, expnt(s) = [174.90701839]
bas 4, expnt(s) = [20.48164763]
bas 5, expnt(s) = [56.95511385]
bas 6, expnt(s) = [0.48732673]
bas 7, expnt(s) = [7.82003525]
bas 8, expnt(s) = [1.65416366]
bas 9, expnt(s) = [1.93576526]
bas 10, expnt(s) = [6.27848624]
bas 11, expnt(s) = [28.39056764]
bas 12, expnt(s) = [0.20343347]
bas 13, expnt(s) = [0.64031455]
CPU time:        25.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816476e+01 2.43242071e+01 5.69551139e+01 5.23798882e+01
 4.87326734e-01 1.47360200e+00 7.82003525e+00 1.18146689e+01
 1.65416366e+00 3.68509663e+00 1.93576526e+00 6.66116599e+00
 6.27848624e+00 2.89936623e+01 2.83905676e+01 1.91184195e+02
 2.03433468e-01 3.98577149e-01 6.40314548e-01 1.67099867e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999177557901358
cond(S) = 239.35980486039338
E1 = -183.54742619482872  E_coul = 55.074542033605724
init E= -128.472884161223
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.770923356442614  LUMO = 0.598795480391715
  mo_energy =
[-3.25562515e+01 -1.85161650e+00 -7.70923356e-01 -7.70923356e-01
 -7.70923356e-01  5.98795480e-01  5.98795480e-01  5.98795480e-01
  2.06022968e+00  2.97219974e+00  2.97219974e+00  2.97219974e+00
  1.14263249e+01  1.14263249e+01  1.14263249e+01  1.94269918e+01
  5.47988406e+01  5.47988406e+01  5.47988406e+01  9.38388506e+01
  3.56155371e+02  1.34951916e+03  5.83596929e+03  3.50985975e+04]
E1 = -181.93188900281427  E_coul = 53.427807887127784
cycle= 1 E= -128.504081115686  delta_E= -0.0312  |g|= 0.22  |ddm|= 0.169
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.495621
diis-c [-0.24564047  1.        ]
  HOMO = -0.88654723952917  LUMO = 0.580161234812233
  mo_energy =
[-3.29071750e+01 -1.97441022e+00 -8.86547240e-01 -8.86547240e-01
 -8.86547240e-01  5.80161235e-01  5.80161235e-01  5.80161235e-01
  1.97660339e+00  2.88714777e+00  2.88714777e+00  2.88714777e+00
  1.12340150e+01  1.12340150e+01  1.12340150e+01  1.91874186e+01
  5.44806818e+01  5.44806818e+01  5.44806818e+01  9.35088162e+01
  3.55773158e+02  1.34909710e+03  5.83551501e+03  3.50981216e+04]
E1 = -182.75536997383256  E_coul = 54.248281823203165
cycle= 2 E= -128.507088150629  delta_E= -0.00301  |g|= 0.111  |ddm|= 0.0796
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254858
diis-c [-5.27108870e-04  3.38921517e-01  6.61078483e-01]
  HOMO = -0.848125110992601  LUMO = 0.586404751805927
  mo_energy =
[-3.27911355e+01 -1.93382149e+00 -8.48125111e-01 -8.48125111e-01
 -8.48125111e-01  5.86404752e-01  5.86404752e-01  5.86404752e-01
  2.00395931e+00  2.91509027e+00  2.91509027e+00  2.91509027e+00
  1.12980948e+01  1.12980948e+01  1.12980948e+01  1.92673778e+01
  5.45863478e+01  5.45863478e+01  5.45863478e+01  9.36183992e+01
  3.55896548e+02  1.34922733e+03  5.83564851e+03  3.50982563e+04]
E1 = -182.47702855814293  E_coul = 53.968869209870185
cycle= 3 E= -128.508159348273  delta_E= -0.00107  |g|= 0.0003  |ddm|= 0.027
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000493376
diis-c [-1.42740093e-07 -1.95659943e-03 -4.91116641e-03  1.00686777e+00]
  HOMO = -0.848225079882228  LUMO = 0.586406477503707
  mo_energy =
[-3.27911846e+01 -1.93393983e+00 -8.48225080e-01 -8.48225080e-01
 -8.48225080e-01  5.86406478e-01  5.86406478e-01  5.86406478e-01
  2.00390051e+00  2.91505958e+00  2.91505958e+00  2.91505958e+00
  1.12980482e+01  1.12980482e+01  1.12980482e+01  1.92673167e+01
  5.45863036e+01  5.45863036e+01  5.45863036e+01  9.36183601e+01
  3.55896532e+02  1.34922732e+03  5.83564850e+03  3.50982563e+04]
E1 = -182.4763829197042  E_coul = 53.96822354826591
cycle= 4 E= -128.508159371438  delta_E= -2.32e-08  |g|= 6.48e-05  |ddm|= 0.000256
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.33718e-05
diis-c [-1.38445897e-09  9.86751920e-05  5.29388607e-04 -1.57512243e-01
  1.15688418e+00]
  HOMO = -0.848254823569272  LUMO = 0.586397665210293
  mo_energy =
[-3.27912244e+01 -1.93398261e+00 -8.48254824e-01 -8.48254824e-01
 -8.48254824e-01  5.86397665e-01  5.86397665e-01  5.86397665e-01
  2.00386369e+00  2.91503086e+00  2.91503086e+00  2.91503086e+00
  1.12980073e+01  1.12980073e+01  1.12980073e+01  1.92672704e+01
  5.45862622e+01  5.45862622e+01  5.45862622e+01  9.36183197e+01
  3.55896501e+02  1.34922730e+03  5.83564849e+03  3.50982563e+04]
E1 = -182.47640731035932  E_coul = 53.968247938198104
cycle= 5 E= -128.508159372161  delta_E= -7.23e-10  |g|= 6.04e-06  |ddm|= 5.45e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.47640731035932  E_coul = 53.968247938198104
  HOMO = -0.848252337061255  LUMO = 0.586397960948475
  mo_energy =
[-3.27912176e+01 -1.93398110e+00 -8.48252337e-01 -8.48252337e-01
 -8.48252337e-01  5.86397961e-01  5.86397961e-01  5.86397961e-01
  2.00386452e+00  2.91503248e+00  2.91503248e+00  2.91503248e+00
  1.12980112e+01  1.12980112e+01  1.12980112e+01  1.92672750e+01
  5.45862683e+01  5.45862683e+01  5.45862683e+01  9.36183260e+01
  3.55896508e+02  1.34922731e+03  5.83564849e+03  3.50982563e+04]
E1 = -182.47638670806663  E_coul = 53.96822733590029
Extra cycle  E= -128.508159372166  delta_E= -5.12e-12  |g|= 2.95e-06  |ddm|= 3.03e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.35980486039338
E1 = -182.47638670806663  E_coul = 53.96822733590029
init E= -128.508159372166
    CPU time for initialize scf      0.17 sec, wall time      0.17 sec
  HOMO = -0.848253778243431  LUMO = 0.586397700178395
  mo_energy =
[-3.27912218e+01 -1.93398287e+00 -8.48253778e-01 -8.48253778e-01
 -8.48253778e-01  5.86397700e-01  5.86397700e-01  5.86397700e-01
  2.00386328e+00  2.91503138e+00  2.91503138e+00  2.91503138e+00
  1.12980088e+01  1.12980088e+01  1.12980088e+01  1.92672720e+01
  5.45862644e+01  5.45862644e+01  5.45862644e+01  9.36183220e+01
  3.55896503e+02  1.34922730e+03  5.83564849e+03  3.50982563e+04]
E1 = -182.47639626147804  E_coul = 53.96823688931124
cycle= 1 E= -128.508159372167  delta_E= -4.55e-13  |g|= 1.3e-06  |ddm|= 1.36e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.47639626147804  E_coul = 53.96823688931124
  HOMO = -0.848253099546922  LUMO = 0.586397805521941
  mo_energy =
[-3.27912197e+01 -1.93398220e+00 -8.48253100e-01 -8.48253100e-01
 -8.48253100e-01  5.86397806e-01  5.86397806e-01  5.86397806e-01
  2.00386372e+00  2.91503187e+00  2.91503187e+00  2.91503187e+00
  1.12980099e+01  1.12980099e+01  1.12980099e+01  1.92672734e+01
  5.45862663e+01  5.45862663e+01  5.45862663e+01  9.36183240e+01
  3.55896505e+02  1.34922730e+03  5.83564849e+03  3.50982563e+04]
E1 = -182.47639112562686  E_coul = 53.96823175346011
Extra cycle  E= -128.508159372167  delta_E= 5.68e-14  |g|= 6.95e-07  |ddm|= 4.58e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907018e+02
 2.04816476e+01 5.69551139e+01 4.87326734e-01 7.82003525e+00
 1.65416366e+00 1.93576526e+00 6.27848624e+00 2.83905676e+01
 2.03433468e-01 6.40314548e-01]
grad_E = [ 6.71213857e-13  1.92764202e-10 -3.62597569e-09  4.50603002e-08
  2.75719795e-06 -3.13529227e-07 -1.25284998e-03 -5.04877334e-06
  1.49013789e-04  2.49562813e-03 -1.46445736e-02  8.54743650e-04
 -2.39824457e-02  3.87239459e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482477        1
[INPUT] 0    0    [1    /1   ]  174.907018321        1
[INPUT] 0    0    [1    /1   ]  20.4816437162        1
[INPUT] 0    0    [1    /1   ]  56.955114355         1
[INPUT] 0    0    [1    /1   ]  0.487815088406       1
[INPUT] 0    0    [1    /1   ]  7.82004259104        1
[INPUT] 0    0    [1    /1   ]  1.65416865396        1
[INPUT] 1    0    [1    /1   ]  1.9337674707         1
[INPUT] 1    0    [1    /1   ]  6.29000797969        1
[INPUT] 1    0    [1    /1   ]  28.389892489         1
[INPUT] 1    0    [1    /1   ]  0.212146195798       1
[INPUT] 1    0    [1    /1   ]  0.638741117275       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025643, 1.0]], [0, [2712.096824069259, 1.0]], [0, [617.4984824768537, 1.0]], [0, [174.90701832122463, 1.0]], [0, [20.481643716156913, 1.0]], [0, [56.95511435504807, 1.0]], [0, [0.48781508840573584, 1.0]], [0, [7.820042591036216, 1.0]], [0, [1.6541686539590132, 1.0]], [1, [1.9337674707042365, 1.0]], [1, [6.29000797969197, 1.0]], [1, [28.389892488971153, 1.0]], [1, [0.2121461957981176, 1.0]], [1, [0.6387411172746229, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848248]
bas 3, expnt(s) = [174.90701832]
bas 4, expnt(s) = [20.48164372]
bas 5, expnt(s) = [56.95511436]
bas 6, expnt(s) = [0.48781509]
bas 7, expnt(s) = [7.82004259]
bas 8, expnt(s) = [1.65416865]
bas 9, expnt(s) = [1.93376747]
bas 10, expnt(s) = [6.29000798]
bas 11, expnt(s) = [28.38989249]
bas 12, expnt(s) = [0.2121462]
bas 13, expnt(s) = [0.63874112]
CPU time:        27.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816437e+01 2.43242036e+01 5.69551144e+01 5.23798886e+01
 4.87815088e-01 1.47470939e+00 7.82004259e+00 1.18146773e+01
 1.65416865e+00 3.68510498e+00 1.93376747e+00 6.65257387e+00
 6.29000798e+00 2.90601859e+01 2.83898925e+01 1.91178512e+02
 2.12146196e-01 4.20028204e-01 6.38741117e-01 1.66586761e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999229415098647
cond(S) = 239.3925673501722
E1 = -183.54754028163052  E_coul = 55.074486452345475
init E= -128.473053829285
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.770960589541087  LUMO = 0.621108322953474
  mo_energy =
[-3.25563171e+01 -1.85160624e+00 -7.70960590e-01 -7.70960590e-01
 -7.70960590e-01  6.21108323e-01  6.21108323e-01  6.21108323e-01
  2.06184190e+00  3.00001138e+00  3.00001138e+00  3.00001138e+00
  1.14537169e+01  1.14537169e+01  1.14537169e+01  1.94292675e+01
  5.48423620e+01  5.48423620e+01  5.48423620e+01  9.38407516e+01
  3.56157048e+02  1.34952067e+03  5.83597063e+03  3.50985986e+04]
E1 = -181.93752892420983  E_coul = 53.43316406215803
cycle= 1 E= -128.504364862052  delta_E= -0.0313  |g|= 0.219  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.497538
diis-c [-0.24754364  1.        ]
  HOMO = -0.886137751971764  LUMO = 0.602039223738163
  mo_energy =
[-3.29063457e+01 -1.97391945e+00 -8.86137752e-01 -8.86137752e-01
 -8.86137752e-01  6.02039224e-01  6.02039224e-01  6.02039224e-01
  1.97864242e+00  2.91561096e+00  2.91561096e+00  2.91561096e+00
  1.12620293e+01  1.12620293e+01  1.12620293e+01  1.91903650e+01
  5.45250797e+01  5.45250797e+01  5.45250797e+01  9.35115723e+01
  3.55775706e+02  1.34909946e+03  5.83551718e+03  3.50981235e+04]
E1 = -182.7588740507547  E_coul = 54.251508474314356
cycle= 2 E= -128.50736557644  delta_E= -0.003  |g|= 0.111  |ddm|= 0.0793
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.255464
diis-c [-5.23759828e-04  3.38595918e-01  6.61404082e-01]
  HOMO = -0.847801860074314  LUMO = 0.608470975253398
  mo_energy =
[-3.27905303e+01 -1.93342168e+00 -8.47801860e-01 -8.47801860e-01
 -8.47801860e-01  6.08470975e-01  6.08470975e-01  6.08470975e-01
  2.00594874e+00  2.94343846e+00  2.94343846e+00  2.94343846e+00
  1.13259634e+01  1.13259634e+01  1.13259634e+01  1.92701532e+01
  5.46305342e+01  5.46305342e+01  5.46305342e+01  9.36209401e+01
  3.55898863e+02  1.34922944e+03  5.83565044e+03  3.50982580e+04]
E1 = -182.4821118166949  E_coul = 53.973682882991724
cycle= 3 E= -128.508428933703  delta_E= -0.00106  |g|= 0.000235  |ddm|= 0.0269
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000488154
diis-c [-8.91357564e-08 -1.74028031e-03 -4.80913799e-03  1.00654942e+00]
  HOMO = -0.847856435161241  LUMO = 0.60848821744214
  mo_energy =
[-3.27905140e+01 -1.93348538e+00 -8.47856435e-01 -8.47856435e-01
 -8.47856435e-01  6.08488217e-01  6.08488217e-01  6.08488217e-01
  2.00593866e+00  2.94345194e+00  2.94345194e+00  2.94345194e+00
  1.13259761e+01  1.13259761e+01  1.13259761e+01  1.92701545e+01
  5.46305547e+01  5.46305547e+01  5.46305547e+01  9.36209654e+01
  3.55898909e+02  1.34922949e+03  5.83565048e+03  3.50982581e+04]
E1 = -182.48147053271558  E_coul = 53.97304158648096
cycle= 4 E= -128.508428946235  delta_E= -1.25e-08  |g|= 4.73e-05  |ddm|= 0.000172
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46822e-05
diis-c [-9.96446597e-10  5.59268878e-05  4.14127813e-04 -1.24564665e-01
  1.12409461e+00]
  HOMO = -0.847877434530943  LUMO = 0.608482146723531
  mo_energy =
[-3.27905427e+01 -1.93351617e+00 -8.47877435e-01 -8.47877435e-01
 -8.47877435e-01  6.08482147e-01  6.08482147e-01  6.08482147e-01
  2.00591256e+00  2.94343211e+00  2.94343211e+00  2.94343211e+00
  1.13259468e+01  1.13259468e+01  1.13259468e+01  1.92701205e+01
  5.46305248e+01  5.46305248e+01  5.46305248e+01  9.36209364e+01
  3.55898888e+02  1.34922948e+03  5.83565048e+03  3.50982581e+04]
E1 = -182.48149858624768  E_coul = 53.97306963966637
cycle= 5 E= -128.508428946581  delta_E= -3.47e-10  |g|= 5.14e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48149858624768  E_coul = 53.97306963966637
  HOMO = -0.847875643659509  LUMO = 0.608482314681551
  mo_energy =
[-3.27905374e+01 -1.93351527e+00 -8.47875644e-01 -8.47875644e-01
 -8.47875644e-01  6.08482315e-01  6.08482315e-01  6.08482315e-01
  2.00591294e+00  2.94343319e+00  2.94343319e+00  2.94343319e+00
  1.13259497e+01  1.13259497e+01  1.13259497e+01  1.92701239e+01
  5.46305295e+01  5.46305295e+01  5.46305295e+01  9.36209412e+01
  3.55898894e+02  1.34922949e+03  5.83565048e+03  3.50982581e+04]
E1 = -182.48148170760766  E_coul = 53.97305276102249
Extra cycle  E= -128.508428946585  delta_E= -3.87e-12  |g|= 2.43e-06  |ddm|= 2.94e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907018e+02
 2.04816437e+01 5.69551144e+01 4.87815088e-01 7.82004259e+00
 1.65416865e+00 1.93376747e+00 6.29000798e+00 2.83898925e+01
 2.12146196e-01 6.38741117e-01]
E = -128.50842894658518
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.498482477        1
[INPUT] 0    0    [1    /1   ]  174.907018321        1
[INPUT] 0    0    [1    /1   ]  20.4816437162        1
[INPUT] 0    0    [1    /1   ]  56.955114355         1
[INPUT] 0    0    [1    /1   ]  0.487815088406       1
[INPUT] 0    0    [1    /1   ]  7.82004259104        1
[INPUT] 0    0    [1    /1   ]  1.65416865396        1
[INPUT] 1    0    [1    /1   ]  1.9337674707         1
[INPUT] 1    0    [1    /1   ]  6.29000797969        1
[INPUT] 1    0    [1    /1   ]  28.389892489         1
[INPUT] 1    0    [1    /1   ]  0.212146195798       1
[INPUT] 1    0    [1    /1   ]  0.638741117275       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025643, 1.0]], [0, [2712.096824069259, 1.0]], [0, [617.4984824768537, 1.0]], [0, [174.90701832122463, 1.0]], [0, [20.481643716156913, 1.0]], [0, [56.95511435504807, 1.0]], [0, [0.48781508840573584, 1.0]], [0, [7.820042591036216, 1.0]], [0, [1.6541686539590132, 1.0]], [1, [1.9337674707042365, 1.0]], [1, [6.29000797969197, 1.0]], [1, [28.389892488971153, 1.0]], [1, [0.2121461957981176, 1.0]], [1, [0.6387411172746229, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.49848248]
bas 3, expnt(s) = [174.90701832]
bas 4, expnt(s) = [20.48164372]
bas 5, expnt(s) = [56.95511436]
bas 6, expnt(s) = [0.48781509]
bas 7, expnt(s) = [7.82004259]
bas 8, expnt(s) = [1.65416865]
bas 9, expnt(s) = [1.93376747]
bas 10, expnt(s) = [6.29000798]
bas 11, expnt(s) = [28.38989249]
bas 12, expnt(s) = [0.2121462]
bas 13, expnt(s) = [0.63874112]
CPU time:        28.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816437e+01 2.43242036e+01 5.69551144e+01 5.23798886e+01
 4.87815088e-01 1.47470939e+00 7.82004259e+00 1.18146773e+01
 1.65416865e+00 3.68510498e+00 1.93376747e+00 6.65257387e+00
 6.29000798e+00 2.90601859e+01 2.83898925e+01 1.91178512e+02
 2.12146196e-01 4.20028204e-01 6.38741117e-01 1.66586761e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999229415098647
cond(S) = 239.3925673501722
E1 = -183.54754028163052  E_coul = 55.074486452345475
init E= -128.473053829285
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.770960589541087  LUMO = 0.621108322953474
  mo_energy =
[-3.25563171e+01 -1.85160624e+00 -7.70960590e-01 -7.70960590e-01
 -7.70960590e-01  6.21108323e-01  6.21108323e-01  6.21108323e-01
  2.06184190e+00  3.00001138e+00  3.00001138e+00  3.00001138e+00
  1.14537169e+01  1.14537169e+01  1.14537169e+01  1.94292675e+01
  5.48423620e+01  5.48423620e+01  5.48423620e+01  9.38407516e+01
  3.56157048e+02  1.34952067e+03  5.83597063e+03  3.50985986e+04]
E1 = -181.93752892420983  E_coul = 53.43316406215803
cycle= 1 E= -128.504364862052  delta_E= -0.0313  |g|= 0.219  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.497538
diis-c [-0.24754364  1.        ]
  HOMO = -0.886137751971764  LUMO = 0.602039223738163
  mo_energy =
[-3.29063457e+01 -1.97391945e+00 -8.86137752e-01 -8.86137752e-01
 -8.86137752e-01  6.02039224e-01  6.02039224e-01  6.02039224e-01
  1.97864242e+00  2.91561096e+00  2.91561096e+00  2.91561096e+00
  1.12620293e+01  1.12620293e+01  1.12620293e+01  1.91903650e+01
  5.45250797e+01  5.45250797e+01  5.45250797e+01  9.35115723e+01
  3.55775706e+02  1.34909946e+03  5.83551718e+03  3.50981235e+04]
E1 = -182.7588740507547  E_coul = 54.251508474314356
cycle= 2 E= -128.50736557644  delta_E= -0.003  |g|= 0.111  |ddm|= 0.0793
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.255464
diis-c [-5.23759828e-04  3.38595918e-01  6.61404082e-01]
  HOMO = -0.847801860074314  LUMO = 0.608470975253398
  mo_energy =
[-3.27905303e+01 -1.93342168e+00 -8.47801860e-01 -8.47801860e-01
 -8.47801860e-01  6.08470975e-01  6.08470975e-01  6.08470975e-01
  2.00594874e+00  2.94343846e+00  2.94343846e+00  2.94343846e+00
  1.13259634e+01  1.13259634e+01  1.13259634e+01  1.92701532e+01
  5.46305342e+01  5.46305342e+01  5.46305342e+01  9.36209401e+01
  3.55898863e+02  1.34922944e+03  5.83565044e+03  3.50982580e+04]
E1 = -182.4821118166949  E_coul = 53.973682882991724
cycle= 3 E= -128.508428933703  delta_E= -0.00106  |g|= 0.000235  |ddm|= 0.0269
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000488154
diis-c [-8.91357564e-08 -1.74028031e-03 -4.80913799e-03  1.00654942e+00]
  HOMO = -0.847856435161241  LUMO = 0.60848821744214
  mo_energy =
[-3.27905140e+01 -1.93348538e+00 -8.47856435e-01 -8.47856435e-01
 -8.47856435e-01  6.08488217e-01  6.08488217e-01  6.08488217e-01
  2.00593866e+00  2.94345194e+00  2.94345194e+00  2.94345194e+00
  1.13259761e+01  1.13259761e+01  1.13259761e+01  1.92701545e+01
  5.46305547e+01  5.46305547e+01  5.46305547e+01  9.36209654e+01
  3.55898909e+02  1.34922949e+03  5.83565048e+03  3.50982581e+04]
E1 = -182.48147053271558  E_coul = 53.97304158648096
cycle= 4 E= -128.508428946235  delta_E= -1.25e-08  |g|= 4.73e-05  |ddm|= 0.000172
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.46822e-05
diis-c [-9.96446597e-10  5.59268878e-05  4.14127813e-04 -1.24564665e-01
  1.12409461e+00]
  HOMO = -0.847877434530943  LUMO = 0.608482146723531
  mo_energy =
[-3.27905427e+01 -1.93351617e+00 -8.47877435e-01 -8.47877435e-01
 -8.47877435e-01  6.08482147e-01  6.08482147e-01  6.08482147e-01
  2.00591256e+00  2.94343211e+00  2.94343211e+00  2.94343211e+00
  1.13259468e+01  1.13259468e+01  1.13259468e+01  1.92701205e+01
  5.46305248e+01  5.46305248e+01  5.46305248e+01  9.36209364e+01
  3.55898888e+02  1.34922948e+03  5.83565048e+03  3.50982581e+04]
E1 = -182.48149858624768  E_coul = 53.97306963966637
cycle= 5 E= -128.508428946581  delta_E= -3.47e-10  |g|= 5.14e-06  |ddm|= 3.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48149858624768  E_coul = 53.97306963966637
  HOMO = -0.847875643659509  LUMO = 0.608482314681551
  mo_energy =
[-3.27905374e+01 -1.93351527e+00 -8.47875644e-01 -8.47875644e-01
 -8.47875644e-01  6.08482315e-01  6.08482315e-01  6.08482315e-01
  2.00591294e+00  2.94343319e+00  2.94343319e+00  2.94343319e+00
  1.13259497e+01  1.13259497e+01  1.13259497e+01  1.92701239e+01
  5.46305295e+01  5.46305295e+01  5.46305295e+01  9.36209412e+01
  3.55898894e+02  1.34922949e+03  5.83565048e+03  3.50982581e+04]
E1 = -182.48148170760766  E_coul = 53.97305276102249
Extra cycle  E= -128.508428946585  delta_E= -3.87e-12  |g|= 2.43e-06  |ddm|= 2.94e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.3925673501722
E1 = -182.48148170760766  E_coul = 53.97305276102249
init E= -128.508428946585
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.847876829722435  LUMO = 0.608482087766792
  mo_energy =
[-3.27905409e+01 -1.93351675e+00 -8.47876830e-01 -8.47876830e-01
 -8.47876830e-01  6.08482088e-01  6.08482088e-01  6.08482088e-01
  2.00591189e+00  2.94343228e+00  2.94343228e+00  2.94343228e+00
  1.13259477e+01  1.13259477e+01  1.13259477e+01  1.92701214e+01
  5.46305264e+01  5.46305264e+01  5.46305264e+01  9.36209380e+01
  3.55898890e+02  1.34922949e+03  5.83565048e+03  3.50982581e+04]
E1 = -182.4814892758358  E_coul = 53.97306032925018
cycle= 1 E= -128.508428946586  delta_E= -4.26e-13  |g|= 1.04e-06  |ddm|= 1.15e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4814892758358  E_coul = 53.97306032925018
  HOMO = -0.847876292919762  LUMO = 0.608482172462927
  mo_energy =
[-3.27905392e+01 -1.93351622e+00 -8.47876293e-01 -8.47876293e-01
 -8.47876293e-01  6.08482172e-01  6.08482172e-01  6.08482172e-01
  2.00591223e+00  2.94343266e+00  2.94343266e+00  2.94343266e+00
  1.13259486e+01  1.13259486e+01  1.13259486e+01  1.92701225e+01
  5.46305279e+01  5.46305279e+01  5.46305279e+01  9.36209396e+01
  3.55898892e+02  1.34922949e+03  5.83565048e+03  3.50982581e+04]
E1 = -182.48148517092403  E_coul = 53.973056224337995
Extra cycle  E= -128.508428946586  delta_E= -4.26e-13  |g|= 5.56e-07  |ddm|= 3.66e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907018e+02
 2.04816437e+01 5.69551144e+01 4.87815088e-01 7.82004259e+00
 1.65416865e+00 1.93376747e+00 6.29000798e+00 2.83898925e+01
 2.12146196e-01 6.38741117e-01]
grad_E = [-3.95263044e-12  4.46131210e-10 -8.41624305e-09  1.08228598e-07
  6.02504892e-06 -7.72960685e-07  2.48379209e-05 -1.20330183e-05
 -1.82981822e-04  5.57806617e-03 -1.45831700e-02  8.15629378e-04
  8.59060197e-04 -1.10442810e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.4984825          1
[INPUT] 0    0    [1    /1   ]  174.907018027        1
[INPUT] 0    0    [1    /1   ]  20.4816279884        1
[INPUT] 0    0    [1    /1   ]  56.9551164642        1
[INPUT] 0    0    [1    /1   ]  0.48916539487        1
[INPUT] 0    0    [1    /1   ]  7.82007230924        1
[INPUT] 0    0    [1    /1   ]  1.65426704924        1
[INPUT] 1    0    [1    /1   ]  1.93799711281        1
[INPUT] 1    0    [1    /1   ]  6.32895831303        1
[INPUT] 1    0    [1    /1   ]  28.3876309666        1
[INPUT] 1    0    [1    /1   ]  0.219574627928       1
[INPUT] 1    0    [1    /1   ]  0.641885174322       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025654, 1.0]], [0, [2712.096824068042, 1.0]], [0, [617.4984824999293, 1.0]], [0, [174.907018026909, 1.0]], [0, [20.48162798842737, 1.0]], [0, [56.955116464178566, 1.0]], [0, [0.48916539486975724, 1.0]], [0, [7.820072309242904, 1.0]], [0, [1.6542670492440268, 1.0]], [1, [1.9379971128149776, 1.0]], [1, [6.328958313029568, 1.0]], [1, [28.387630966628723, 1.0]], [1, [0.2195746279280417, 1.0]], [1, [0.641885174321727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.4984825]
bas 3, expnt(s) = [174.90701803]
bas 4, expnt(s) = [20.48162799]
bas 5, expnt(s) = [56.95511646]
bas 6, expnt(s) = [0.48916539]
bas 7, expnt(s) = [7.82007231]
bas 8, expnt(s) = [1.65426705]
bas 9, expnt(s) = [1.93799711]
bas 10, expnt(s) = [6.32895831]
bas 11, expnt(s) = [28.38763097]
bas 12, expnt(s) = [0.21957463]
bas 13, expnt(s) = [0.64188517]
CPU time:        30.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816280e+01 2.43241896e+01 5.69551165e+01 5.23798900e+01
 4.89165395e-01 1.47776991e+00 7.82007231e+00 1.18147109e+01
 1.65426705e+00 3.68526938e+00 1.93799711e+00 6.67076743e+00
 6.32895831e+00 2.92853006e+01 2.83876310e+01 1.91159476e+02
 2.19574628e-01 4.38492417e-01 6.41885174e-01 1.67612373e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999223062527058
cond(S) = 239.4874597933038
E1 = -183.54824991996622  E_coul = 55.074566974429764
init E= -128.473682945536
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771038568303056  LUMO = 0.64127462350998
  mo_energy =
[-3.25562794e+01 -1.85160438e+00 -7.71038568e-01 -7.71038568e-01
 -7.71038568e-01  6.41274624e-01  6.41274624e-01  6.41274624e-01
  2.06651122e+00  3.03777626e+00  3.03777626e+00  3.03777626e+00
  1.15339669e+01  1.15339669e+01  1.15339669e+01  1.94358115e+01
  5.49984322e+01  5.49984322e+01  5.49984322e+01  9.38465531e+01
  3.56162064e+02  1.34952505e+03  5.83597443e+03  3.50986017e+04]
E1 = -181.94642996587115  E_coul = 53.441530926563665
cycle= 1 E= -128.504899039307  delta_E= -0.0312  |g|= 0.219  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498072
diis-c [-0.24807607  1.        ]
  HOMO = -0.885567456409481  LUMO = 0.621758322560545
  mo_energy =
[-3.29048013e+01 -1.97323311e+00 -8.85567456e-01 -8.85567456e-01
 -8.85567456e-01  6.21758323e-01  6.21758323e-01  6.21758323e-01
  1.98378946e+00  2.95372830e+00  2.95372830e+00  2.95372830e+00
  1.13427869e+01  1.13427869e+01  1.13427869e+01  1.91980398e+01
  5.46825357e+01  5.46825357e+01  5.46825357e+01  9.35187987e+01
  3.55782355e+02  1.34910556e+03  5.83552272e+03  3.50981284e+04]
E1 = -182.76378275570627  E_coul = 54.25590226407078
cycle= 2 E= -128.507880491635  delta_E= -0.00298  |g|= 0.111  |ddm|= 0.079
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.255326
diis-c [-5.24204242e-04  3.38231601e-01  6.61768399e-01]
  HOMO = -0.847403177354473  LUMO = 0.628363835254429
  mo_energy =
[-3.27894590e+01 -1.93291898e+00 -8.47403177e-01 -8.47403177e-01
 -8.47403177e-01  6.28363835e-01  6.28363835e-01  6.28363835e-01
  2.01099965e+00  2.98150347e+00  2.98150347e+00  2.98150347e+00
  1.14065792e+01  1.14065792e+01  1.14065792e+01  1.92774810e+01
  5.47875475e+01  5.47875475e+01  5.47875475e+01  9.36277146e+01
  3.55905010e+02  1.34923501e+03  5.83565543e+03  3.50982624e+04]
E1 = -182.48889941574848  E_coul = 53.97996745676865
cycle= 3 E= -128.50893195898  delta_E= -0.00105  |g|= 0.000217  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000489587
diis-c [-7.17020915e-08 -1.63055011e-03 -4.70853556e-03  1.00633909e+00]
  HOMO = -0.847436990440893  LUMO = 0.628388145331041
  mo_energy =
[-3.27894205e+01 -1.93295946e+00 -8.47436990e-01 -8.47436990e-01
 -8.47436990e-01  6.28388145e-01  6.28388145e-01  6.28388145e-01
  2.01101043e+00  2.98153622e+00  2.98153622e+00  2.98153622e+00
  1.14066165e+01  1.14066165e+01  1.14066165e+01  1.92775081e+01
  5.47875907e+01  5.47875907e+01  5.47875907e+01  9.36277624e+01
  3.55905074e+02  1.34923507e+03  5.83565549e+03  3.50982624e+04]
E1 = -182.4882755495608  E_coul = 53.979343581154595
cycle= 4 E= -128.508931968406  delta_E= -9.43e-09  |g|= 4.02e-05  |ddm|= 0.000137
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.63916e-05
diis-c [-8.28455093e-10  3.79343861e-05  3.46247161e-04 -1.09877021e-01
  1.10949284e+00]
  HOMO = -0.84745393386215  LUMO = 0.628383259599299
  mo_energy =
[-3.27894440e+01 -1.93298510e+00 -8.47453934e-01 -8.47453934e-01
 -8.47453934e-01  6.28383260e-01  6.28383260e-01  6.28383260e-01
  2.01098891e+00  2.98152036e+00  2.98152036e+00  2.98152036e+00
  1.14065925e+01  1.14065925e+01  1.14065925e+01  1.92774797e+01
  5.47875661e+01  5.47875661e+01  5.47875661e+01  9.36277386e+01
  3.55905058e+02  1.34923507e+03  5.83565549e+03  3.50982624e+04]
E1 = -182.48830341416104  E_coul = 53.9793714455214
cycle= 5 E= -128.50893196864  delta_E= -2.33e-10  |g|= 4.8e-06  |ddm|= 2.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48830341416104  E_coul = 53.9793714455214
  HOMO = -0.847452287895441  LUMO = 0.62838341953501
  mo_energy =
[-3.27894391e+01 -1.93298430e+00 -8.47452288e-01 -8.47452288e-01
 -8.47452288e-01  6.28383420e-01  6.28383420e-01  6.28383420e-01
  2.01098924e+00  2.98152136e+00  2.98152136e+00  2.98152136e+00
  1.14065952e+01  1.14065952e+01  1.14065952e+01  1.92774829e+01
  5.47875705e+01  5.47875705e+01  5.47875705e+01  9.36277432e+01
  3.55905063e+02  1.34923507e+03  5.83565549e+03  3.50982624e+04]
E1 = -182.488287887694  E_coul = 53.97935591905078
Extra cycle  E= -128.508931968643  delta_E= -3.58e-12  |g|= 2.25e-06  |ddm|= 2.75e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907018e+02
 2.04816280e+01 5.69551165e+01 4.89165395e-01 7.82007231e+00
 1.65426705e+00 1.93799711e+00 6.32895831e+00 2.83876310e+01
 2.19574628e-01 6.41885174e-01]
E = -128.50893196864322
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682407        1
[INPUT] 0    0    [1    /1   ]  617.4984825          1
[INPUT] 0    0    [1    /1   ]  174.907018027        1
[INPUT] 0    0    [1    /1   ]  20.4816279884        1
[INPUT] 0    0    [1    /1   ]  56.9551164642        1
[INPUT] 0    0    [1    /1   ]  0.48916539487        1
[INPUT] 0    0    [1    /1   ]  7.82007230924        1
[INPUT] 0    0    [1    /1   ]  1.65426704924        1
[INPUT] 1    0    [1    /1   ]  1.93799711281        1
[INPUT] 1    0    [1    /1   ]  6.32895831303        1
[INPUT] 1    0    [1    /1   ]  28.3876309666        1
[INPUT] 1    0    [1    /1   ]  0.219574627928       1
[INPUT] 1    0    [1    /1   ]  0.641885174322       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025654, 1.0]], [0, [2712.096824068042, 1.0]], [0, [617.4984824999293, 1.0]], [0, [174.907018026909, 1.0]], [0, [20.48162798842737, 1.0]], [0, [56.955116464178566, 1.0]], [0, [0.48916539486975724, 1.0]], [0, [7.820072309242904, 1.0]], [0, [1.6542670492440268, 1.0]], [1, [1.9379971128149776, 1.0]], [1, [6.328958313029568, 1.0]], [1, [28.387630966628723, 1.0]], [1, [0.2195746279280417, 1.0]], [1, [0.641885174321727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682407]
bas 2, expnt(s) = [617.4984825]
bas 3, expnt(s) = [174.90701803]
bas 4, expnt(s) = [20.48162799]
bas 5, expnt(s) = [56.95511646]
bas 6, expnt(s) = [0.48916539]
bas 7, expnt(s) = [7.82007231]
bas 8, expnt(s) = [1.65426705]
bas 9, expnt(s) = [1.93799711]
bas 10, expnt(s) = [6.32895831]
bas 11, expnt(s) = [28.38763097]
bas 12, expnt(s) = [0.21957463]
bas 13, expnt(s) = [0.64188517]
CPU time:        30.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816280e+01 2.43241896e+01 5.69551165e+01 5.23798900e+01
 4.89165395e-01 1.47776991e+00 7.82007231e+00 1.18147109e+01
 1.65426705e+00 3.68526938e+00 1.93799711e+00 6.67076743e+00
 6.32895831e+00 2.92853006e+01 2.83876310e+01 1.91159476e+02
 2.19574628e-01 4.38492417e-01 6.41885174e-01 1.67612373e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999223062527058
cond(S) = 239.4874597933038
E1 = -183.54824991996622  E_coul = 55.074566974429764
init E= -128.473682945536
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771038568303056  LUMO = 0.64127462350998
  mo_energy =
[-3.25562794e+01 -1.85160438e+00 -7.71038568e-01 -7.71038568e-01
 -7.71038568e-01  6.41274624e-01  6.41274624e-01  6.41274624e-01
  2.06651122e+00  3.03777626e+00  3.03777626e+00  3.03777626e+00
  1.15339669e+01  1.15339669e+01  1.15339669e+01  1.94358115e+01
  5.49984322e+01  5.49984322e+01  5.49984322e+01  9.38465531e+01
  3.56162064e+02  1.34952505e+03  5.83597443e+03  3.50986017e+04]
E1 = -181.94642996587115  E_coul = 53.441530926563665
cycle= 1 E= -128.504899039307  delta_E= -0.0312  |g|= 0.219  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498072
diis-c [-0.24807607  1.        ]
  HOMO = -0.885567456409481  LUMO = 0.621758322560545
  mo_energy =
[-3.29048013e+01 -1.97323311e+00 -8.85567456e-01 -8.85567456e-01
 -8.85567456e-01  6.21758323e-01  6.21758323e-01  6.21758323e-01
  1.98378946e+00  2.95372830e+00  2.95372830e+00  2.95372830e+00
  1.13427869e+01  1.13427869e+01  1.13427869e+01  1.91980398e+01
  5.46825357e+01  5.46825357e+01  5.46825357e+01  9.35187987e+01
  3.55782355e+02  1.34910556e+03  5.83552272e+03  3.50981284e+04]
E1 = -182.76378275570627  E_coul = 54.25590226407078
cycle= 2 E= -128.507880491635  delta_E= -0.00298  |g|= 0.111  |ddm|= 0.079
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.255326
diis-c [-5.24204242e-04  3.38231601e-01  6.61768399e-01]
  HOMO = -0.847403177354473  LUMO = 0.628363835254429
  mo_energy =
[-3.27894590e+01 -1.93291898e+00 -8.47403177e-01 -8.47403177e-01
 -8.47403177e-01  6.28363835e-01  6.28363835e-01  6.28363835e-01
  2.01099965e+00  2.98150347e+00  2.98150347e+00  2.98150347e+00
  1.14065792e+01  1.14065792e+01  1.14065792e+01  1.92774810e+01
  5.47875475e+01  5.47875475e+01  5.47875475e+01  9.36277146e+01
  3.55905010e+02  1.34923501e+03  5.83565543e+03  3.50982624e+04]
E1 = -182.48889941574848  E_coul = 53.97996745676865
cycle= 3 E= -128.50893195898  delta_E= -0.00105  |g|= 0.000217  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000489587
diis-c [-7.17020915e-08 -1.63055011e-03 -4.70853556e-03  1.00633909e+00]
  HOMO = -0.847436990440893  LUMO = 0.628388145331041
  mo_energy =
[-3.27894205e+01 -1.93295946e+00 -8.47436990e-01 -8.47436990e-01
 -8.47436990e-01  6.28388145e-01  6.28388145e-01  6.28388145e-01
  2.01101043e+00  2.98153622e+00  2.98153622e+00  2.98153622e+00
  1.14066165e+01  1.14066165e+01  1.14066165e+01  1.92775081e+01
  5.47875907e+01  5.47875907e+01  5.47875907e+01  9.36277624e+01
  3.55905074e+02  1.34923507e+03  5.83565549e+03  3.50982624e+04]
E1 = -182.4882755495608  E_coul = 53.979343581154595
cycle= 4 E= -128.508931968406  delta_E= -9.43e-09  |g|= 4.02e-05  |ddm|= 0.000137
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.63916e-05
diis-c [-8.28455093e-10  3.79343861e-05  3.46247161e-04 -1.09877021e-01
  1.10949284e+00]
  HOMO = -0.84745393386215  LUMO = 0.628383259599299
  mo_energy =
[-3.27894440e+01 -1.93298510e+00 -8.47453934e-01 -8.47453934e-01
 -8.47453934e-01  6.28383260e-01  6.28383260e-01  6.28383260e-01
  2.01098891e+00  2.98152036e+00  2.98152036e+00  2.98152036e+00
  1.14065925e+01  1.14065925e+01  1.14065925e+01  1.92774797e+01
  5.47875661e+01  5.47875661e+01  5.47875661e+01  9.36277386e+01
  3.55905058e+02  1.34923507e+03  5.83565549e+03  3.50982624e+04]
E1 = -182.48830341416104  E_coul = 53.9793714455214
cycle= 5 E= -128.50893196864  delta_E= -2.33e-10  |g|= 4.8e-06  |ddm|= 2.98e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.48830341416104  E_coul = 53.9793714455214
  HOMO = -0.847452287895441  LUMO = 0.62838341953501
  mo_energy =
[-3.27894391e+01 -1.93298430e+00 -8.47452288e-01 -8.47452288e-01
 -8.47452288e-01  6.28383420e-01  6.28383420e-01  6.28383420e-01
  2.01098924e+00  2.98152136e+00  2.98152136e+00  2.98152136e+00
  1.14065952e+01  1.14065952e+01  1.14065952e+01  1.92774829e+01
  5.47875705e+01  5.47875705e+01  5.47875705e+01  9.36277432e+01
  3.55905063e+02  1.34923507e+03  5.83565549e+03  3.50982624e+04]
E1 = -182.488287887694  E_coul = 53.97935591905078
Extra cycle  E= -128.508931968643  delta_E= -3.58e-12  |g|= 2.25e-06  |ddm|= 2.75e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.4874597933038
E1 = -182.488287887694  E_coul = 53.97935591905078
init E= -128.508931968643
    CPU time for initialize scf      0.17 sec, wall time      0.16 sec
  HOMO = -0.847453377398695  LUMO = 0.628383205330876
  mo_energy =
[-3.27894422e+01 -1.93298566e+00 -8.47453377e-01 -8.47453377e-01
 -8.47453377e-01  6.28383205e-01  6.28383205e-01  6.28383205e-01
  2.01098827e+00  2.98152052e+00  2.98152052e+00  2.98152052e+00
  1.14065934e+01  1.14065934e+01  1.14065934e+01  1.92774806e+01
  5.47875676e+01  5.47875676e+01  5.47875676e+01  9.36277402e+01
  3.55905060e+02  1.34923507e+03  5.83565549e+03  3.50982624e+04]
E1 = -182.48829484425104  E_coul = 53.97936287560725
cycle= 1 E= -128.508931968644  delta_E= -5.68e-13  |g|= 9.55e-07  |ddm|= 1.06e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.48829484425104  E_coul = 53.97936287560725
  HOMO = -0.847452883918815  LUMO = 0.628383285712456
  mo_energy =
[-3.27894407e+01 -1.93298518e+00 -8.47452884e-01 -8.47452884e-01
 -8.47452884e-01  6.28383286e-01  6.28383286e-01  6.28383286e-01
  2.01098858e+00  2.98152087e+00  2.98152087e+00  2.98152087e+00
  1.14065942e+01  1.14065942e+01  1.14065942e+01  1.92774816e+01
  5.47875690e+01  5.47875690e+01  5.47875690e+01  9.36277416e+01
  3.55905062e+02  1.34923507e+03  5.83565549e+03  3.50982624e+04]
E1 = -182.48829108101975  E_coul = 53.979359112375725
Extra cycle  E= -128.508931968644  delta_E= -2.27e-13  |g|= 5.1e-07  |ddm|= 3.37e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907018e+02
 2.04816280e+01 5.69551165e+01 4.89165395e-01 7.82007231e+00
 1.65426705e+00 1.93799711e+00 6.32895831e+00 2.83876310e+01
 2.19574628e-01 6.41885174e-01]
grad_E = [-1.58105410e-11  1.09400506e-09 -2.07173656e-08  2.69377708e-07
  1.41781383e-05 -1.95050167e-06  2.94132956e-03 -2.92294402e-05
 -9.22422264e-04  3.93500479e-03 -1.29044225e-02  6.34193120e-04
  1.33354138e-02 -1.53647171e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482683        1
[INPUT] 0    0    [1    /1   ]  174.907015678        1
[INPUT] 0    0    [1    /1   ]  20.4815059785        1
[INPUT] 0    0    [1    /1   ]  56.9551334011        1
[INPUT] 0    0    [1    /1   ]  0.486341494816       1
[INPUT] 0    0    [1    /1   ]  7.82030737333        1
[INPUT] 0    0    [1    /1   ]  1.65733768392        1
[INPUT] 1    0    [1    /1   ]  2.00464340269        1
[INPUT] 1    0    [1    /1   ]  6.53628557339        1
[INPUT] 1    0    [1    /1   ]  28.3758058138        1
[INPUT] 1    0    [1    /1   ]  0.247652708878       1
[INPUT] 1    0    [1    /1   ]  0.676072379241       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025767, 1.0]], [0, [2712.0968240583866, 1.0]], [0, [617.4984826834408, 1.0]], [0, [174.9070156775063, 1.0]], [0, [20.481505978510864, 1.0]], [0, [56.95513340107957, 1.0]], [0, [0.48634149481641276, 1.0]], [0, [7.820307373334036, 1.0]], [0, [1.6573376839185587, 1.0]], [1, [2.00464340268967, 1.0]], [1, [6.536285573386874, 1.0]], [1, [28.375805813841545, 1.0]], [1, [0.2476527088778477, 1.0]], [1, [0.6760723792410888, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848268]
bas 3, expnt(s) = [174.90701568]
bas 4, expnt(s) = [20.48150598]
bas 5, expnt(s) = [56.9551334]
bas 6, expnt(s) = [0.48634149]
bas 7, expnt(s) = [7.82030737]
bas 8, expnt(s) = [1.65733768]
bas 9, expnt(s) = [2.0046434]
bas 10, expnt(s) = [6.53628557]
bas 11, expnt(s) = [28.37580581]
bas 12, expnt(s) = [0.24765271]
bas 13, expnt(s) = [0.67607238]
CPU time:        33.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512357e+02
 2.04815060e+01 2.43240809e+01 5.69551334e+01 5.23799017e+01
 4.86341495e-01 1.47136702e+00 7.82030737e+00 1.18149773e+01
 1.65733768e+00 3.69039861e+00 2.00464340e+00 6.95874310e+00
 6.53628557e+00 3.04893500e+01 2.83758058e+01 1.91059944e+02
 2.47652709e-01 5.09669032e-01 6.76072379e-01 1.78844622e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999036923960734
cond(S) = 239.4486907545974
E1 = -183.5516665418754  E_coul = 55.07571441237807
init E= -128.475952129497
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771260851568871  LUMO = 0.723878498284617
  mo_energy =
[-3.25559115e+01 -1.85156616e+00 -7.71260852e-01 -7.71260852e-01
 -7.71260852e-01  7.23878498e-01  7.23878498e-01  7.23878498e-01
  2.05963977e+00  3.26443834e+00  3.26443834e+00  3.26443834e+00
  1.21089385e+01  1.21089385e+01  1.21089385e+01  1.94356725e+01
  5.59920879e+01  5.59920879e+01  5.59920879e+01  9.38489405e+01
  3.56164308e+02  1.34952687e+03  5.83597595e+03  3.50986029e+04]
E1 = -181.97581605624003  E_coul = 53.46901536682296
cycle= 1 E= -128.506800689417  delta_E= -0.0308  |g|= 0.216  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.500327
diis-c [-0.25032742  1.        ]
  HOMO = -0.883931137387309  LUMO = 0.702131564931985
  mo_energy =
[-3.28992683e+01 -1.97079940e+00 -8.83931137e-01 -8.83931137e-01
 -8.83931137e-01  7.02131565e-01  7.02131565e-01  7.02131565e-01
  1.97895800e+00  3.17909045e+00  3.17909045e+00  3.17909045e+00
  1.19179523e+01  1.19179523e+01  1.19179523e+01  1.92013920e+01
  5.56809790e+01  5.56809790e+01  5.56809790e+01  9.35260272e+01
  3.55790242e+02  1.34911338e+03  5.83553034e+03  3.50981357e+04]
E1 = -182.77958907967147  E_coul = 54.26987148461686
cycle= 2 E= -128.509717595055  delta_E= -0.00292  |g|= 0.109  |ddm|= 0.0778
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254743
diis-c [-5.30458223e-04  3.36696201e-01  6.63303799e-01]
  HOMO = -0.846337413269119  LUMO = 0.709562969326112
  mo_energy =
[-3.27854785e+01 -1.93109838e+00 -8.46337413e-01 -8.46337413e-01
 -8.46337413e-01  7.09562969e-01  7.09562969e-01  7.09562969e-01
  2.00572899e+00  3.20743866e+00  3.20743866e+00  3.20743866e+00
  1.19817454e+01  1.19817454e+01  1.19817454e+01  1.92797113e+01
  5.57844818e+01  5.57844818e+01  5.57844818e+01  9.36334635e+01
  3.55911241e+02  1.34924106e+03  5.83566122e+03  3.50982678e+04]
E1 = -182.51078627825063  E_coul = 54.000056139118286
cycle= 3 E= -128.510730139132  delta_E= -0.00101  |g|= 0.000172  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000326722
diis-c [-2.33818345e-08 -1.30717124e-03 -3.62749014e-03  1.00493466e+00]
  HOMO = -0.846332221705435  LUMO = 0.709607232001927
  mo_energy =
[-3.27854181e+01 -1.93106306e+00 -8.46332222e-01 -8.46332222e-01
 -8.46332222e-01  7.09607232e-01  7.09607232e-01  7.09607232e-01
  2.00580737e+00  3.20751378e+00  3.20751378e+00  3.20751378e+00
  1.19818291e+01  1.19818291e+01  1.19818291e+01  1.92797892e+01
  5.57845535e+01  5.57845535e+01  5.57845535e+01  9.36335364e+01
  3.55911299e+02  1.34924109e+03  5.83566121e+03  3.50982678e+04]
E1 = -182.51034157085678  E_coul = 53.99961142913929
cycle= 4 E= -128.510730141717  delta_E= -2.59e-09  |g|= 2.22e-05  |ddm|= 6.62e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.22392e-05
diis-c [-4.73599374e-11 -7.09211458e-05  5.50950506e-05  7.39190509e-03
  9.92623921e-01]
  HOMO = -0.846341274654833  LUMO = 0.709605458427055
  mo_energy =
[-3.27854360e+01 -1.93107158e+00 -8.46341275e-01 -8.46341275e-01
 -8.46341275e-01  7.09605458e-01  7.09605458e-01  7.09605458e-01
  2.00580126e+00  3.20750679e+00  3.20750679e+00  3.20750679e+00
  1.19818155e+01  1.19818155e+01  1.19818155e+01  1.92797731e+01
  5.57845363e+01  5.57845363e+01  5.57845363e+01  9.36335191e+01
  3.55911283e+02  1.34924107e+03  5.83566120e+03  3.50982678e+04]
E1 = -182.51039531387858  E_coul = 53.9996651721171
cycle= 5 E= -128.510730141761  delta_E= -4.4e-11  |g|= 1.05e-06  |ddm|= 5.24e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51039531387858  E_coul = 53.9996651721171
  HOMO = -0.84634146627103  LUMO = 0.709605449185052
  mo_energy =
[-3.27854365e+01 -1.93107154e+00 -8.46341466e-01 -8.46341466e-01
 -8.46341466e-01  7.09605449e-01  7.09605449e-01  7.09605449e-01
  2.00580133e+00  3.20750669e+00  3.20750669e+00  3.20750669e+00
  1.19818152e+01  1.19818152e+01  1.19818152e+01  1.92797728e+01
  5.57845358e+01  5.57845358e+01  5.57845358e+01  9.36335186e+01
  3.55911283e+02  1.34924107e+03  5.83566120e+03  3.50982678e+04]
E1 = -182.51039735406312  E_coul = 53.99966721230157
Extra cycle  E= -128.510730141762  delta_E= -5.68e-14  |g|= 3.5e-07  |ddm|= 7.03e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04815060e+01 5.69551334e+01 4.86341495e-01 7.82030737e+00
 1.65733768e+00 2.00464340e+00 6.53628557e+00 2.83758058e+01
 2.47652709e-01 6.76072379e-01]
E = -128.51073014176154
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482683        1
[INPUT] 0    0    [1    /1   ]  174.907015678        1
[INPUT] 0    0    [1    /1   ]  20.4815059785        1
[INPUT] 0    0    [1    /1   ]  56.9551334011        1
[INPUT] 0    0    [1    /1   ]  0.486341494816       1
[INPUT] 0    0    [1    /1   ]  7.82030737333        1
[INPUT] 0    0    [1    /1   ]  1.65733768392        1
[INPUT] 1    0    [1    /1   ]  2.00464340269        1
[INPUT] 1    0    [1    /1   ]  6.53628557339        1
[INPUT] 1    0    [1    /1   ]  28.3758058138        1
[INPUT] 1    0    [1    /1   ]  0.247652708878       1
[INPUT] 1    0    [1    /1   ]  0.676072379241       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025767, 1.0]], [0, [2712.0968240583866, 1.0]], [0, [617.4984826834408, 1.0]], [0, [174.9070156775063, 1.0]], [0, [20.481505978510864, 1.0]], [0, [56.95513340107957, 1.0]], [0, [0.48634149481641276, 1.0]], [0, [7.820307373334036, 1.0]], [0, [1.6573376839185587, 1.0]], [1, [2.00464340268967, 1.0]], [1, [6.536285573386874, 1.0]], [1, [28.375805813841545, 1.0]], [1, [0.2476527088778477, 1.0]], [1, [0.6760723792410888, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848268]
bas 3, expnt(s) = [174.90701568]
bas 4, expnt(s) = [20.48150598]
bas 5, expnt(s) = [56.9551334]
bas 6, expnt(s) = [0.48634149]
bas 7, expnt(s) = [7.82030737]
bas 8, expnt(s) = [1.65733768]
bas 9, expnt(s) = [2.0046434]
bas 10, expnt(s) = [6.53628557]
bas 11, expnt(s) = [28.37580581]
bas 12, expnt(s) = [0.24765271]
bas 13, expnt(s) = [0.67607238]
CPU time:        33.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512357e+02
 2.04815060e+01 2.43240809e+01 5.69551334e+01 5.23799017e+01
 4.86341495e-01 1.47136702e+00 7.82030737e+00 1.18149773e+01
 1.65733768e+00 3.69039861e+00 2.00464340e+00 6.95874310e+00
 6.53628557e+00 3.04893500e+01 2.83758058e+01 1.91059944e+02
 2.47652709e-01 5.09669032e-01 6.76072379e-01 1.78844622e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999036923960734
cond(S) = 239.4486907545974
E1 = -183.5516665418754  E_coul = 55.07571441237807
init E= -128.475952129497
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.771260851568871  LUMO = 0.723878498284617
  mo_energy =
[-3.25559115e+01 -1.85156616e+00 -7.71260852e-01 -7.71260852e-01
 -7.71260852e-01  7.23878498e-01  7.23878498e-01  7.23878498e-01
  2.05963977e+00  3.26443834e+00  3.26443834e+00  3.26443834e+00
  1.21089385e+01  1.21089385e+01  1.21089385e+01  1.94356725e+01
  5.59920879e+01  5.59920879e+01  5.59920879e+01  9.38489405e+01
  3.56164308e+02  1.34952687e+03  5.83597595e+03  3.50986029e+04]
E1 = -181.97581605624003  E_coul = 53.46901536682296
cycle= 1 E= -128.506800689417  delta_E= -0.0308  |g|= 0.216  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.500327
diis-c [-0.25032742  1.        ]
  HOMO = -0.883931137387309  LUMO = 0.702131564931985
  mo_energy =
[-3.28992683e+01 -1.97079940e+00 -8.83931137e-01 -8.83931137e-01
 -8.83931137e-01  7.02131565e-01  7.02131565e-01  7.02131565e-01
  1.97895800e+00  3.17909045e+00  3.17909045e+00  3.17909045e+00
  1.19179523e+01  1.19179523e+01  1.19179523e+01  1.92013920e+01
  5.56809790e+01  5.56809790e+01  5.56809790e+01  9.35260272e+01
  3.55790242e+02  1.34911338e+03  5.83553034e+03  3.50981357e+04]
E1 = -182.77958907967147  E_coul = 54.26987148461686
cycle= 2 E= -128.509717595055  delta_E= -0.00292  |g|= 0.109  |ddm|= 0.0778
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254743
diis-c [-5.30458223e-04  3.36696201e-01  6.63303799e-01]
  HOMO = -0.846337413269119  LUMO = 0.709562969326112
  mo_energy =
[-3.27854785e+01 -1.93109838e+00 -8.46337413e-01 -8.46337413e-01
 -8.46337413e-01  7.09562969e-01  7.09562969e-01  7.09562969e-01
  2.00572899e+00  3.20743866e+00  3.20743866e+00  3.20743866e+00
  1.19817454e+01  1.19817454e+01  1.19817454e+01  1.92797113e+01
  5.57844818e+01  5.57844818e+01  5.57844818e+01  9.36334635e+01
  3.55911241e+02  1.34924106e+03  5.83566122e+03  3.50982678e+04]
E1 = -182.51078627825063  E_coul = 54.000056139118286
cycle= 3 E= -128.510730139132  delta_E= -0.00101  |g|= 0.000172  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000326722
diis-c [-2.33818345e-08 -1.30717124e-03 -3.62749014e-03  1.00493466e+00]
  HOMO = -0.846332221705435  LUMO = 0.709607232001927
  mo_energy =
[-3.27854181e+01 -1.93106306e+00 -8.46332222e-01 -8.46332222e-01
 -8.46332222e-01  7.09607232e-01  7.09607232e-01  7.09607232e-01
  2.00580737e+00  3.20751378e+00  3.20751378e+00  3.20751378e+00
  1.19818291e+01  1.19818291e+01  1.19818291e+01  1.92797892e+01
  5.57845535e+01  5.57845535e+01  5.57845535e+01  9.36335364e+01
  3.55911299e+02  1.34924109e+03  5.83566121e+03  3.50982678e+04]
E1 = -182.51034157085678  E_coul = 53.99961142913929
cycle= 4 E= -128.510730141717  delta_E= -2.59e-09  |g|= 2.22e-05  |ddm|= 6.62e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.22392e-05
diis-c [-4.73599374e-11 -7.09211458e-05  5.50950506e-05  7.39190509e-03
  9.92623921e-01]
  HOMO = -0.846341274654833  LUMO = 0.709605458427055
  mo_energy =
[-3.27854360e+01 -1.93107158e+00 -8.46341275e-01 -8.46341275e-01
 -8.46341275e-01  7.09605458e-01  7.09605458e-01  7.09605458e-01
  2.00580126e+00  3.20750679e+00  3.20750679e+00  3.20750679e+00
  1.19818155e+01  1.19818155e+01  1.19818155e+01  1.92797731e+01
  5.57845363e+01  5.57845363e+01  5.57845363e+01  9.36335191e+01
  3.55911283e+02  1.34924107e+03  5.83566120e+03  3.50982678e+04]
E1 = -182.51039531387858  E_coul = 53.9996651721171
cycle= 5 E= -128.510730141761  delta_E= -4.4e-11  |g|= 1.05e-06  |ddm|= 5.24e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51039531387858  E_coul = 53.9996651721171
  HOMO = -0.84634146627103  LUMO = 0.709605449185052
  mo_energy =
[-3.27854365e+01 -1.93107154e+00 -8.46341466e-01 -8.46341466e-01
 -8.46341466e-01  7.09605449e-01  7.09605449e-01  7.09605449e-01
  2.00580133e+00  3.20750669e+00  3.20750669e+00  3.20750669e+00
  1.19818152e+01  1.19818152e+01  1.19818152e+01  1.92797728e+01
  5.57845358e+01  5.57845358e+01  5.57845358e+01  9.36335186e+01
  3.55911283e+02  1.34924107e+03  5.83566120e+03  3.50982678e+04]
E1 = -182.51039735406312  E_coul = 53.99966721230157
Extra cycle  E= -128.510730141762  delta_E= -5.68e-14  |g|= 3.5e-07  |ddm|= 7.03e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.4486907545974
E1 = -182.51039735406312  E_coul = 53.99966721230157
init E= -128.510730141762
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.846341326297925  LUMO = 0.709605482960575
  mo_energy =
[-3.27854362e+01 -1.93107134e+00 -8.46341326e-01 -8.46341326e-01
 -8.46341326e-01  7.09605483e-01  7.09605483e-01  7.09605483e-01
  2.00580148e+00  3.20750680e+00  3.20750680e+00  3.20750680e+00
  1.19818154e+01  1.19818154e+01  1.19818154e+01  1.92797731e+01
  5.57845362e+01  5.57845362e+01  5.57845362e+01  9.36335190e+01
  3.55911283e+02  1.34924107e+03  5.83566120e+03  3.50982678e+04]
E1 = -182.51039653439594  E_coul = 53.99966639263437
cycle= 1 E= -128.510730141762  delta_E= -2.84e-14  |g|= 1.19e-07  |ddm|= 1.96e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51039653439594  E_coul = 53.99966639263437
  HOMO = -0.84634138497302  LUMO = 0.709605472594783
  mo_energy =
[-3.27854363e+01 -1.93107139e+00 -8.46341385e-01 -8.46341385e-01
 -8.46341385e-01  7.09605473e-01  7.09605473e-01  7.09605473e-01
  2.00580145e+00  3.20750676e+00  3.20750676e+00  3.20750676e+00
  1.19818153e+01  1.19818153e+01  1.19818153e+01  1.92797729e+01
  5.57845360e+01  5.57845360e+01  5.57845360e+01  9.36335188e+01
  3.55911283e+02  1.34924107e+03  5.83566120e+03  3.50982678e+04]
E1 = -182.51039699585442  E_coul = 53.99966685409285
Extra cycle  E= -128.510730141762  delta_E=    0  |g|= 6.34e-08  |ddm|= 4.38e-08
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04815060e+01 5.69551334e+01 4.86341495e-01 7.82030737e+00
 1.65733768e+00 2.00464340e+00 6.53628557e+00 2.83758058e+01
 2.47652709e-01 6.76072379e-01]
grad_E = [ 2.63235981e-11 -1.22751443e-09  2.27575965e-08 -3.09178748e-07
 -1.56440083e-05  2.16336130e-06 -4.50069784e-03  2.77220642e-05
  1.26143729e-03  1.81426940e-04 -7.40975088e-03 -9.24520603e-05
  4.44798736e-02 -2.28864718e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682405        1
[INPUT] 0    0    [1    /1   ]  617.49848282         1
[INPUT] 0    0    [1    /1   ]  174.907013978        1
[INPUT] 0    0    [1    /1   ]  20.481417948         1
[INPUT] 0    0    [1    /1   ]  56.9551457359        1
[INPUT] 0    0    [1    /1   ]  0.498262921303       1
[INPUT] 0    0    [1    /1   ]  7.82047556771        1
[INPUT] 0    0    [1    /1   ]  1.65654001887        1
[INPUT] 1    0    [1    /1   ]  2.10592294263        1
[INPUT] 1    0    [1    /1   ]  6.77024965517        1
[INPUT] 1    0    [1    /1   ]  28.3630410123        1
[INPUT] 1    0    [1    /1   ]  0.266458707037       1
[INPUT] 1    0    [1    /1   ]  0.725255279904       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002582, 1.0]], [0, [2712.096824051284, 1.0]], [0, [617.4984828196896, 1.0]], [0, [174.90701397808647, 1.0]], [0, [20.481417948031314, 1.0]], [0, [56.95514573585587, 1.0]], [0, [0.4982629213030016, 1.0]], [0, [7.820475567707204, 1.0]], [0, [1.6565400188695678, 1.0]], [1, [2.1059229426293116, 1.0]], [1, [6.770249655169068, 1.0]], [1, [28.363041012256183, 1.0]], [1, [0.2664587070365137, 1.0]], [1, [0.7252552799042908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682405]
bas 2, expnt(s) = [617.49848282]
bas 3, expnt(s) = [174.90701398]
bas 4, expnt(s) = [20.48141795]
bas 5, expnt(s) = [56.95514574]
bas 6, expnt(s) = [0.49826292]
bas 7, expnt(s) = [7.82047557]
bas 8, expnt(s) = [1.65654002]
bas 9, expnt(s) = [2.10592294]
bas 10, expnt(s) = [6.77024966]
bas 11, expnt(s) = [28.36304101]
bas 12, expnt(s) = [0.26645871]
bas 13, expnt(s) = [0.72525528]
CPU time:        35.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907014e+02 1.21512357e+02
 2.04814179e+01 2.43240025e+01 5.69551457e+01 5.23799102e+01
 4.98262921e-01 1.49833509e+00 7.82047557e+00 1.18151679e+01
 1.65654002e+00 3.68906641e+00 2.10592294e+00 7.40095030e+00
 6.77024966e+00 3.18595947e+01 2.83630410e+01 1.90952515e+02
 2.66458707e-01 5.58498213e-01 7.25255280e-01 1.95253135e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998867145230882
cond(S) = 240.2124336212262
E1 = -183.55317070884212  E_coul = 55.07567758609079
init E= -128.477493122751
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771449668306935  LUMO = 0.789162925560817
  mo_energy =
[-3.25560090e+01 -1.85148383e+00 -7.71449668e-01 -7.71449668e-01
 -7.71449668e-01  7.89162926e-01  7.89162926e-01  7.89162926e-01
  2.09941594e+00  3.51354046e+00  3.51354046e+00  3.51354046e+00
  1.28270419e+01  1.28270419e+01  1.28270419e+01  1.94866510e+01
  5.72001935e+01  5.72001935e+01  5.72001935e+01  9.38927629e+01
  3.56202174e+02  1.34956006e+03  5.83600479e+03  3.50986266e+04]
E1 = -182.01636075038704  E_coul = 53.507990609981114
cycle= 1 E= -128.508370140406  delta_E= -0.0309  |g|= 0.211  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.493683
diis-c [-0.24372291  1.        ]
  HOMO = -0.880998702009862  LUMO = 0.765661510377761
  mo_energy =
[-3.28922728e+01 -1.96775363e+00 -8.80998702e-01 -8.80998702e-01
 -8.80998702e-01  7.65661510e-01  7.65661510e-01  7.65661510e-01
  2.02028332e+00  3.42643089e+00  3.42643089e+00  3.42643089e+00
  1.26371403e+01  1.26371403e+01  1.26371403e+01  1.92580349e+01
  5.68959268e+01  5.68959268e+01  5.68959268e+01  9.35766187e+01
  3.55835680e+02  1.34915447e+03  5.83556721e+03  3.50981674e+04]
E1 = -182.79869934916195  E_coul = 54.28752891874828
cycle= 2 E= -128.511170430414  delta_E= -0.0028  |g|= 0.106  |ddm|= 0.0772
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.250083
diis-c [-5.32265685e-04  3.35529035e-01  6.64470965e-01]
  HOMO = -0.844370512107633  LUMO = 0.773707515491712
  mo_energy =
[-3.27811933e+01 -1.92909285e+00 -8.44370512e-01 -8.44370512e-01
 -8.44370512e-01  7.73707515e-01  7.73707515e-01  7.73707515e-01
  2.04654944e+00  3.45544333e+00  3.45544333e+00  3.45544333e+00
  1.27004690e+01  1.27004690e+01  1.27004690e+01  1.93343903e+01
  5.69968508e+01  5.69968508e+01  5.69968508e+01  9.36814738e+01
  3.55953819e+02  1.34927914e+03  5.83569502e+03  3.50982965e+04]
E1 = -182.53799190729515  E_coul = 54.025864235241556
cycle= 3 E= -128.512127672054  delta_E= -0.000957  |g|= 0.00018  |ddm|= 0.0257
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000412753
diis-c [-3.88448541e-08 -1.38799582e-03 -4.12129483e-03  1.00550929e+00]
  HOMO = -0.844359332147731  LUMO = 0.773751582524718
  mo_energy =
[-3.27811470e+01 -1.92908501e+00 -8.44359332e-01 -8.44359332e-01
 -8.44359332e-01  7.73751583e-01  7.73751583e-01  7.73751583e-01
  2.04660468e+00  3.45551663e+00  3.45551663e+00  3.45551663e+00
  1.27005445e+01  1.27005445e+01  1.27005445e+01  1.93344578e+01
  5.69969079e+01  5.69969079e+01  5.69969079e+01  9.36815329e+01
  3.55953865e+02  1.34927916e+03  5.83569500e+03  3.50982964e+04]
E1 = -182.53755016261786  E_coul = 54.02542248650605
cycle= 4 E= -128.512127676112  delta_E= -4.06e-09  |g|= 2.42e-05  |ddm|= 6.27e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.72247e-05
diis-c [-4.54283989e-10  2.13208260e-05  1.83274049e-04 -7.84317668e-02
  1.07822717e+00]
  HOMO = -0.844365607955301  LUMO = 0.773749679011186
  mo_energy =
[-3.27811572e+01 -1.92909745e+00 -8.44365608e-01 -8.44365608e-01
 -8.44365608e-01  7.73749679e-01  7.73749679e-01  7.73749679e-01
  2.04659482e+00  3.45551064e+00  3.45551064e+00  3.45551064e+00
  1.27005342e+01  1.27005342e+01  1.27005342e+01  1.93344443e+01
  5.69968970e+01  5.69968970e+01  5.69968970e+01  9.36815226e+01
  3.55953860e+02  1.34927916e+03  5.83569501e+03  3.50982964e+04]
E1 = -182.5375740068762  E_coul = 54.02544633069464
cycle= 5 E= -128.512127676182  delta_E= -6.97e-11  |g|= 3.94e-06  |ddm|= 1.57e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5375740068762  E_coul = 54.02544633069464
  HOMO = -0.844363914847952  LUMO = 0.773749996327359
  mo_energy =
[-3.27811525e+01 -1.92909640e+00 -8.44363915e-01 -8.44363915e-01
 -8.44363915e-01  7.73749996e-01  7.73749996e-01  7.73749996e-01
  2.04659544e+00  3.45551190e+00  3.45551190e+00  3.45551190e+00
  1.27005369e+01  1.27005369e+01  1.27005369e+01  1.93344473e+01
  5.69969011e+01  5.69969011e+01  5.69969011e+01  9.36815269e+01
  3.55953865e+02  1.34927917e+03  5.83569501e+03  3.50982964e+04]
E1 = -182.5375613053367  E_coul = 54.025433629152936
Extra cycle  E= -128.512127676184  delta_E= -2.22e-12  |g|= 1.85e-06  |ddm|= 1.79e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907014e+02
 2.04814179e+01 5.69551457e+01 4.98262921e-01 7.82047557e+00
 1.65654002e+00 2.10592294e+00 6.77024966e+00 2.83630410e+01
 2.66458707e-01 7.25255280e-01]
E = -128.51212767618378
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682405        1
[INPUT] 0    0    [1    /1   ]  617.49848282         1
[INPUT] 0    0    [1    /1   ]  174.907013978        1
[INPUT] 0    0    [1    /1   ]  20.481417948         1
[INPUT] 0    0    [1    /1   ]  56.9551457359        1
[INPUT] 0    0    [1    /1   ]  0.498262921303       1
[INPUT] 0    0    [1    /1   ]  7.82047556771        1
[INPUT] 0    0    [1    /1   ]  1.65654001887        1
[INPUT] 1    0    [1    /1   ]  2.10592294263        1
[INPUT] 1    0    [1    /1   ]  6.77024965517        1
[INPUT] 1    0    [1    /1   ]  28.3630410123        1
[INPUT] 1    0    [1    /1   ]  0.266458707037       1
[INPUT] 1    0    [1    /1   ]  0.725255279904       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002582, 1.0]], [0, [2712.096824051284, 1.0]], [0, [617.4984828196896, 1.0]], [0, [174.90701397808647, 1.0]], [0, [20.481417948031314, 1.0]], [0, [56.95514573585587, 1.0]], [0, [0.4982629213030016, 1.0]], [0, [7.820475567707204, 1.0]], [0, [1.6565400188695678, 1.0]], [1, [2.1059229426293116, 1.0]], [1, [6.770249655169068, 1.0]], [1, [28.363041012256183, 1.0]], [1, [0.2664587070365137, 1.0]], [1, [0.7252552799042908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682405]
bas 2, expnt(s) = [617.49848282]
bas 3, expnt(s) = [174.90701398]
bas 4, expnt(s) = [20.48141795]
bas 5, expnt(s) = [56.95514574]
bas 6, expnt(s) = [0.49826292]
bas 7, expnt(s) = [7.82047557]
bas 8, expnt(s) = [1.65654002]
bas 9, expnt(s) = [2.10592294]
bas 10, expnt(s) = [6.77024966]
bas 11, expnt(s) = [28.36304101]
bas 12, expnt(s) = [0.26645871]
bas 13, expnt(s) = [0.72525528]
CPU time:        35.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907014e+02 1.21512357e+02
 2.04814179e+01 2.43240025e+01 5.69551457e+01 5.23799102e+01
 4.98262921e-01 1.49833509e+00 7.82047557e+00 1.18151679e+01
 1.65654002e+00 3.68906641e+00 2.10592294e+00 7.40095030e+00
 6.77024966e+00 3.18595947e+01 2.83630410e+01 1.90952515e+02
 2.66458707e-01 5.58498213e-01 7.25255280e-01 1.95253135e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998867145230882
cond(S) = 240.2124336212262
E1 = -183.55317070884212  E_coul = 55.07567758609079
init E= -128.477493122751
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771449668306935  LUMO = 0.789162925560817
  mo_energy =
[-3.25560090e+01 -1.85148383e+00 -7.71449668e-01 -7.71449668e-01
 -7.71449668e-01  7.89162926e-01  7.89162926e-01  7.89162926e-01
  2.09941594e+00  3.51354046e+00  3.51354046e+00  3.51354046e+00
  1.28270419e+01  1.28270419e+01  1.28270419e+01  1.94866510e+01
  5.72001935e+01  5.72001935e+01  5.72001935e+01  9.38927629e+01
  3.56202174e+02  1.34956006e+03  5.83600479e+03  3.50986266e+04]
E1 = -182.01636075038704  E_coul = 53.507990609981114
cycle= 1 E= -128.508370140406  delta_E= -0.0309  |g|= 0.211  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.493683
diis-c [-0.24372291  1.        ]
  HOMO = -0.880998702009862  LUMO = 0.765661510377761
  mo_energy =
[-3.28922728e+01 -1.96775363e+00 -8.80998702e-01 -8.80998702e-01
 -8.80998702e-01  7.65661510e-01  7.65661510e-01  7.65661510e-01
  2.02028332e+00  3.42643089e+00  3.42643089e+00  3.42643089e+00
  1.26371403e+01  1.26371403e+01  1.26371403e+01  1.92580349e+01
  5.68959268e+01  5.68959268e+01  5.68959268e+01  9.35766187e+01
  3.55835680e+02  1.34915447e+03  5.83556721e+03  3.50981674e+04]
E1 = -182.79869934916195  E_coul = 54.28752891874828
cycle= 2 E= -128.511170430414  delta_E= -0.0028  |g|= 0.106  |ddm|= 0.0772
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.250083
diis-c [-5.32265685e-04  3.35529035e-01  6.64470965e-01]
  HOMO = -0.844370512107633  LUMO = 0.773707515491712
  mo_energy =
[-3.27811933e+01 -1.92909285e+00 -8.44370512e-01 -8.44370512e-01
 -8.44370512e-01  7.73707515e-01  7.73707515e-01  7.73707515e-01
  2.04654944e+00  3.45544333e+00  3.45544333e+00  3.45544333e+00
  1.27004690e+01  1.27004690e+01  1.27004690e+01  1.93343903e+01
  5.69968508e+01  5.69968508e+01  5.69968508e+01  9.36814738e+01
  3.55953819e+02  1.34927914e+03  5.83569502e+03  3.50982965e+04]
E1 = -182.53799190729515  E_coul = 54.025864235241556
cycle= 3 E= -128.512127672054  delta_E= -0.000957  |g|= 0.00018  |ddm|= 0.0257
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000412753
diis-c [-3.88448541e-08 -1.38799582e-03 -4.12129483e-03  1.00550929e+00]
  HOMO = -0.844359332147731  LUMO = 0.773751582524718
  mo_energy =
[-3.27811470e+01 -1.92908501e+00 -8.44359332e-01 -8.44359332e-01
 -8.44359332e-01  7.73751583e-01  7.73751583e-01  7.73751583e-01
  2.04660468e+00  3.45551663e+00  3.45551663e+00  3.45551663e+00
  1.27005445e+01  1.27005445e+01  1.27005445e+01  1.93344578e+01
  5.69969079e+01  5.69969079e+01  5.69969079e+01  9.36815329e+01
  3.55953865e+02  1.34927916e+03  5.83569500e+03  3.50982964e+04]
E1 = -182.53755016261786  E_coul = 54.02542248650605
cycle= 4 E= -128.512127676112  delta_E= -4.06e-09  |g|= 2.42e-05  |ddm|= 6.27e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.72247e-05
diis-c [-4.54283989e-10  2.13208260e-05  1.83274049e-04 -7.84317668e-02
  1.07822717e+00]
  HOMO = -0.844365607955301  LUMO = 0.773749679011186
  mo_energy =
[-3.27811572e+01 -1.92909745e+00 -8.44365608e-01 -8.44365608e-01
 -8.44365608e-01  7.73749679e-01  7.73749679e-01  7.73749679e-01
  2.04659482e+00  3.45551064e+00  3.45551064e+00  3.45551064e+00
  1.27005342e+01  1.27005342e+01  1.27005342e+01  1.93344443e+01
  5.69968970e+01  5.69968970e+01  5.69968970e+01  9.36815226e+01
  3.55953860e+02  1.34927916e+03  5.83569501e+03  3.50982964e+04]
E1 = -182.5375740068762  E_coul = 54.02544633069464
cycle= 5 E= -128.512127676182  delta_E= -6.97e-11  |g|= 3.94e-06  |ddm|= 1.57e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5375740068762  E_coul = 54.02544633069464
  HOMO = -0.844363914847952  LUMO = 0.773749996327359
  mo_energy =
[-3.27811525e+01 -1.92909640e+00 -8.44363915e-01 -8.44363915e-01
 -8.44363915e-01  7.73749996e-01  7.73749996e-01  7.73749996e-01
  2.04659544e+00  3.45551190e+00  3.45551190e+00  3.45551190e+00
  1.27005369e+01  1.27005369e+01  1.27005369e+01  1.93344473e+01
  5.69969011e+01  5.69969011e+01  5.69969011e+01  9.36815269e+01
  3.55953865e+02  1.34927917e+03  5.83569501e+03  3.50982964e+04]
E1 = -182.5375613053367  E_coul = 54.025433629152936
Extra cycle  E= -128.512127676184  delta_E= -2.22e-12  |g|= 1.85e-06  |ddm|= 1.79e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.2124336212262
E1 = -182.5375613053367  E_coul = 54.025433629152936
init E= -128.512127676184
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.844364792073614  LUMO = 0.773749791480913
  mo_energy =
[-3.27811552e+01 -1.92909748e+00 -8.44364792e-01 -8.44364792e-01
 -8.44364792e-01  7.73749791e-01  7.73749791e-01  7.73749791e-01
  2.04659468e+00  3.45551119e+00  3.45551119e+00  3.45551119e+00
  1.27005354e+01  1.27005354e+01  1.27005354e+01  1.93344454e+01
  5.69968987e+01  5.69968987e+01  5.69968987e+01  9.36815244e+01
  3.55953863e+02  1.34927917e+03  5.83569501e+03  3.50982964e+04]
E1 = -182.53756729386146  E_coul = 54.02543961767756
cycle= 1 E= -128.512127676184  delta_E= -1.14e-13  |g|= 8.14e-07  |ddm|= 8.38e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53756729386146  E_coul = 54.02543961767756
  HOMO = -0.844364366399144  LUMO = 0.77374988214165
  mo_energy =
[-3.27811539e+01 -1.92909706e+00 -8.44364366e-01 -8.44364366e-01
 -8.44364366e-01  7.73749882e-01  7.73749882e-01  7.73749882e-01
  2.04659496e+00  3.45551152e+00  3.45551152e+00  3.45551152e+00
  1.27005361e+01  1.27005361e+01  1.27005361e+01  1.93344463e+01
  5.69968999e+01  5.69968999e+01  5.69968999e+01  9.36815257e+01
  3.55953864e+02  1.34927917e+03  5.83569501e+03  3.50982964e+04]
E1 = -182.5375641702304  E_coul = 54.02543649404648
Extra cycle  E= -128.512127676184  delta_E= -2.84e-14  |g|= 4.25e-07  |ddm|= 2.85e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907014e+02
 2.04814179e+01 5.69551457e+01 4.98262921e-01 7.82047557e+00
 1.65654002e+00 2.10592294e+00 6.77024966e+00 2.83630410e+01
 2.66458707e-01 7.25255280e-01]
grad_E = [-8.51705565e-11  4.88204848e-09 -9.27274755e-08  1.21306899e-06
  6.22983169e-05 -8.87985019e-06  2.08953859e-02 -1.32716263e-04
 -5.38790337e-03 -3.07046415e-03 -3.46937678e-03 -7.18047212e-04
  5.37843598e-02 -1.87557287e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483134        1
[INPUT] 0    0    [1    /1   ]  174.90700998         1
[INPUT] 0    0    [1    /1   ]  20.4812122617        1
[INPUT] 0    0    [1    /1   ]  56.9551748221        1
[INPUT] 0    0    [1    /1   ]  0.484864654698       1
[INPUT] 0    0    [1    /1   ]  7.8208849344         1
[INPUT] 0    0    [1    /1   ]  1.66298665493        1
[INPUT] 1    0    [1    /1   ]  2.2585920101         1
[INPUT] 1    0    [1    /1   ]  7.07856839806        1
[INPUT] 1    0    [1    /1   ]  28.3472057362        1
[INPUT] 1    0    [1    /1   ]  0.280942508461       1
[INPUT] 1    0    [1    /1   ]  0.795763553302       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730026018, 1.0]], [0, [2712.096824034841, 1.0]], [0, [617.4984831336667, 1.0]], [0, [174.9070099798482, 1.0]], [0, [20.481212261724526, 1.0]], [0, [56.95517482208179, 1.0]], [0, [0.4848646546984874, 1.0]], [0, [7.820884934397876, 1.0]], [0, [1.6629866549259764, 1.0]], [1, [2.2585920101017116, 1.0]], [1, [7.078568398059429, 1.0]], [1, [28.347205736243378, 1.0]], [1, [0.28094250846077157, 1.0]], [1, [0.7957635533016643, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.49848313]
bas 3, expnt(s) = [174.90700998]
bas 4, expnt(s) = [20.48121226]
bas 5, expnt(s) = [56.95517482]
bas 6, expnt(s) = [0.48486465]
bas 7, expnt(s) = [7.82088493]
bas 8, expnt(s) = [1.66298665]
bas 9, expnt(s) = [2.25859201]
bas 10, expnt(s) = [7.0785684]
bas 11, expnt(s) = [28.34720574]
bas 12, expnt(s) = [0.28094251]
bas 13, expnt(s) = [0.79576355]
CPU time:        38.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907010e+02 1.21512354e+02
 2.04812123e+01 2.43238193e+01 5.69551748e+01 5.23799303e+01
 4.84864655e-01 1.46801475e+00 7.82088493e+00 1.18156317e+01
 1.66298665e+00 3.69982853e+00 2.25859201e+00 8.07758668e+00
 7.07856840e+00 3.36834202e+01 2.83472057e+01 1.90819262e+02
 2.80942508e-01 5.96700240e-01 7.95763553e-01 2.19262544e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99884515822705
cond(S) = 239.62884480086316
E1 = -183.55763639357292  E_coul = 55.07781941179135
init E= -128.479816981782
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771566558750796  LUMO = 0.852305234854558
  mo_energy =
[-3.25554124e+01 -1.85142984e+00 -7.71566559e-01 -7.71566559e-01
 -7.71566559e-01  8.52305235e-01  8.52305235e-01  8.52305235e-01
  2.05983975e+00  3.82964787e+00  3.82964787e+00  3.82964787e+00
  1.38155764e+01  1.38155764e+01  1.38155764e+01  1.94523489e+01
  5.88547044e+01  5.88547044e+01  5.88547044e+01  9.38681000e+01
  3.56181198e+02  1.34954137e+03  5.83598840e+03  3.50986130e+04]
E1 = -182.0130067223339  E_coul = 53.50316324125554
cycle= 1 E= -128.509843481078  delta_E= -0.03  |g|= 0.212  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498595
diis-c [-0.2485965  1.       ]
  HOMO = -0.882057818887252  LUMO = 0.825738871841801
  mo_energy =
[-3.28921116e+01 -1.96790471e+00 -8.82057819e-01 -8.82057819e-01
 -8.82057819e-01  8.25738872e-01  8.25738872e-01  8.25738872e-01
  1.98112430e+00  3.73579248e+00  3.73579248e+00  3.73579248e+00
  1.36202799e+01  1.36202799e+01  1.36202799e+01  1.92225590e+01
  5.85499487e+01  5.85499487e+01  5.85499487e+01  9.35514095e+01
  3.55814636e+02  1.34913604e+03  5.83555116e+03  3.50981542e+04]
E1 = -182.7969280181737  E_coul = 54.284267488345904
cycle= 2 E= -128.512660529828  delta_E= -0.00282  |g|= 0.106  |ddm|= 0.0767
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.251755
diis-c [-5.51277142e-04  3.34790685e-01  6.65209315e-01]
  HOMO = -0.845330145008171  LUMO = 0.834734965929254
  mo_energy =
[-3.27806232e+01 -1.92913859e+00 -8.45330145e-01 -8.45330145e-01
 -8.45330145e-01  8.34734966e-01  8.34734966e-01  8.34734966e-01
  2.00726268e+00  3.76685856e+00  3.76685856e+00  3.76685856e+00
  1.36853456e+01  1.36853456e+01  1.36853456e+01  1.92992141e+01
  5.86511298e+01  5.86511298e+01  5.86511298e+01  9.36566515e+01
  3.55933178e+02  1.34926109e+03  5.83567932e+03  3.50982836e+04]
E1 = -182.535333614791  E_coul = 54.02171002018205
cycle= 3 E= -128.513623594609  delta_E= -0.000963  |g|= 0.000147  |ddm|= 0.026
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000204301
diis-c [-2.82491448e-08 -1.35230498e-03 -2.38022541e-03  1.00373253e+00]
  HOMO = -0.845369939580813  LUMO = 0.834769064376545
  mo_energy =
[-3.27806792e+01 -1.92912842e+00 -8.45369940e-01 -8.45369940e-01
 -8.45369940e-01  8.34769064e-01  8.34769064e-01  8.34769064e-01
  2.00731924e+00  3.76689208e+00  3.76689208e+00  3.76689208e+00
  1.36853573e+01  1.36853573e+01  1.36853573e+01  1.92992209e+01
  5.86510950e+01  5.86510950e+01  5.86510950e+01  9.36566137e+01
  3.55933085e+02  1.34926093e+03  5.83567908e+03  3.50982833e+04]
E1 = -182.53514428763634  E_coul = 54.0215206909487
cycle= 4 E= -128.513623596688  delta_E= -2.08e-09  |g|= 3.88e-05  |ddm|= 8.9e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.91064e-05
diis-c [-5.43918685e-10  5.24634606e-05  4.90637118e-04 -8.25792069e-02
  1.08203611e+00]
  HOMO = -0.845385668915773  LUMO = 0.834765018722075
  mo_energy =
[-3.27807124e+01 -1.92913917e+00 -8.45385669e-01 -8.45385669e-01
 -8.45385669e-01  8.34765019e-01  8.34765019e-01  8.34765019e-01
  2.00731157e+00  3.76687863e+00  3.76687863e+00  3.76687863e+00
  1.36853337e+01  1.36853337e+01  1.36853337e+01  1.92991956e+01
  5.86510641e+01  5.86510641e+01  5.86510641e+01  9.36565821e+01
  3.55933051e+02  1.34926089e+03  5.83567905e+03  3.50982833e+04]
E1 = -182.5352313177845  E_coul = 54.021607720930206
cycle= 5 E= -128.513623596854  delta_E= -1.67e-10  |g|= 2.81e-06  |ddm|= 1.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5352313177845  E_coul = 54.021607720930206
  HOMO = -0.845385625601475  LUMO = 0.834765082650458
  mo_energy =
[-3.27807127e+01 -1.92913840e+00 -8.45385626e-01 -8.45385626e-01
 -8.45385626e-01  8.34765083e-01  8.34765083e-01  8.34765083e-01
  2.00731221e+00  3.76687875e+00  3.76687875e+00  3.76687875e+00
  1.36853338e+01  1.36853338e+01  1.36853338e+01  1.92991960e+01
  5.86510640e+01  5.86510640e+01  5.86510640e+01  9.36565819e+01
  3.55933050e+02  1.34926089e+03  5.83567904e+03  3.50982833e+04]
E1 = -182.53523228684014  E_coul = 54.02160868998451
Extra cycle  E= -128.513623596856  delta_E= -1.34e-12  |g|= 5.82e-07  |ddm|= 1.7e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907010e+02
 2.04812123e+01 5.69551748e+01 4.84864655e-01 7.82088493e+00
 1.66298665e+00 2.25859201e+00 7.07856840e+00 2.83472057e+01
 2.80942508e-01 7.95763553e-01]
E = -128.51362359685564
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483134        1
[INPUT] 0    0    [1    /1   ]  174.90700998         1
[INPUT] 0    0    [1    /1   ]  20.4812122617        1
[INPUT] 0    0    [1    /1   ]  56.9551748221        1
[INPUT] 0    0    [1    /1   ]  0.484864654698       1
[INPUT] 0    0    [1    /1   ]  7.8208849344         1
[INPUT] 0    0    [1    /1   ]  1.66298665493        1
[INPUT] 1    0    [1    /1   ]  2.2585920101         1
[INPUT] 1    0    [1    /1   ]  7.07856839806        1
[INPUT] 1    0    [1    /1   ]  28.3472057362        1
[INPUT] 1    0    [1    /1   ]  0.280942508461       1
[INPUT] 1    0    [1    /1   ]  0.795763553302       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730026018, 1.0]], [0, [2712.096824034841, 1.0]], [0, [617.4984831336667, 1.0]], [0, [174.9070099798482, 1.0]], [0, [20.481212261724526, 1.0]], [0, [56.95517482208179, 1.0]], [0, [0.4848646546984874, 1.0]], [0, [7.820884934397876, 1.0]], [0, [1.6629866549259764, 1.0]], [1, [2.2585920101017116, 1.0]], [1, [7.078568398059429, 1.0]], [1, [28.347205736243378, 1.0]], [1, [0.28094250846077157, 1.0]], [1, [0.7957635533016643, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.49848313]
bas 3, expnt(s) = [174.90700998]
bas 4, expnt(s) = [20.48121226]
bas 5, expnt(s) = [56.95517482]
bas 6, expnt(s) = [0.48486465]
bas 7, expnt(s) = [7.82088493]
bas 8, expnt(s) = [1.66298665]
bas 9, expnt(s) = [2.25859201]
bas 10, expnt(s) = [7.0785684]
bas 11, expnt(s) = [28.34720574]
bas 12, expnt(s) = [0.28094251]
bas 13, expnt(s) = [0.79576355]
CPU time:        38.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907010e+02 1.21512354e+02
 2.04812123e+01 2.43238193e+01 5.69551748e+01 5.23799303e+01
 4.84864655e-01 1.46801475e+00 7.82088493e+00 1.18156317e+01
 1.66298665e+00 3.69982853e+00 2.25859201e+00 8.07758668e+00
 7.07856840e+00 3.36834202e+01 2.83472057e+01 1.90819262e+02
 2.80942508e-01 5.96700240e-01 7.95763553e-01 2.19262544e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99884515822705
cond(S) = 239.62884480086316
E1 = -183.55763639357292  E_coul = 55.07781941179135
init E= -128.479816981782
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771566558750796  LUMO = 0.852305234854558
  mo_energy =
[-3.25554124e+01 -1.85142984e+00 -7.71566559e-01 -7.71566559e-01
 -7.71566559e-01  8.52305235e-01  8.52305235e-01  8.52305235e-01
  2.05983975e+00  3.82964787e+00  3.82964787e+00  3.82964787e+00
  1.38155764e+01  1.38155764e+01  1.38155764e+01  1.94523489e+01
  5.88547044e+01  5.88547044e+01  5.88547044e+01  9.38681000e+01
  3.56181198e+02  1.34954137e+03  5.83598840e+03  3.50986130e+04]
E1 = -182.0130067223339  E_coul = 53.50316324125554
cycle= 1 E= -128.509843481078  delta_E= -0.03  |g|= 0.212  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498595
diis-c [-0.2485965  1.       ]
  HOMO = -0.882057818887252  LUMO = 0.825738871841801
  mo_energy =
[-3.28921116e+01 -1.96790471e+00 -8.82057819e-01 -8.82057819e-01
 -8.82057819e-01  8.25738872e-01  8.25738872e-01  8.25738872e-01
  1.98112430e+00  3.73579248e+00  3.73579248e+00  3.73579248e+00
  1.36202799e+01  1.36202799e+01  1.36202799e+01  1.92225590e+01
  5.85499487e+01  5.85499487e+01  5.85499487e+01  9.35514095e+01
  3.55814636e+02  1.34913604e+03  5.83555116e+03  3.50981542e+04]
E1 = -182.7969280181737  E_coul = 54.284267488345904
cycle= 2 E= -128.512660529828  delta_E= -0.00282  |g|= 0.106  |ddm|= 0.0767
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.251755
diis-c [-5.51277142e-04  3.34790685e-01  6.65209315e-01]
  HOMO = -0.845330145008171  LUMO = 0.834734965929254
  mo_energy =
[-3.27806232e+01 -1.92913859e+00 -8.45330145e-01 -8.45330145e-01
 -8.45330145e-01  8.34734966e-01  8.34734966e-01  8.34734966e-01
  2.00726268e+00  3.76685856e+00  3.76685856e+00  3.76685856e+00
  1.36853456e+01  1.36853456e+01  1.36853456e+01  1.92992141e+01
  5.86511298e+01  5.86511298e+01  5.86511298e+01  9.36566515e+01
  3.55933178e+02  1.34926109e+03  5.83567932e+03  3.50982836e+04]
E1 = -182.535333614791  E_coul = 54.02171002018205
cycle= 3 E= -128.513623594609  delta_E= -0.000963  |g|= 0.000147  |ddm|= 0.026
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000204301
diis-c [-2.82491448e-08 -1.35230498e-03 -2.38022541e-03  1.00373253e+00]
  HOMO = -0.845369939580813  LUMO = 0.834769064376545
  mo_energy =
[-3.27806792e+01 -1.92912842e+00 -8.45369940e-01 -8.45369940e-01
 -8.45369940e-01  8.34769064e-01  8.34769064e-01  8.34769064e-01
  2.00731924e+00  3.76689208e+00  3.76689208e+00  3.76689208e+00
  1.36853573e+01  1.36853573e+01  1.36853573e+01  1.92992209e+01
  5.86510950e+01  5.86510950e+01  5.86510950e+01  9.36566137e+01
  3.55933085e+02  1.34926093e+03  5.83567908e+03  3.50982833e+04]
E1 = -182.53514428763634  E_coul = 54.0215206909487
cycle= 4 E= -128.513623596688  delta_E= -2.08e-09  |g|= 3.88e-05  |ddm|= 8.9e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.91064e-05
diis-c [-5.43918685e-10  5.24634606e-05  4.90637118e-04 -8.25792069e-02
  1.08203611e+00]
  HOMO = -0.845385668915773  LUMO = 0.834765018722075
  mo_energy =
[-3.27807124e+01 -1.92913917e+00 -8.45385669e-01 -8.45385669e-01
 -8.45385669e-01  8.34765019e-01  8.34765019e-01  8.34765019e-01
  2.00731157e+00  3.76687863e+00  3.76687863e+00  3.76687863e+00
  1.36853337e+01  1.36853337e+01  1.36853337e+01  1.92991956e+01
  5.86510641e+01  5.86510641e+01  5.86510641e+01  9.36565821e+01
  3.55933051e+02  1.34926089e+03  5.83567905e+03  3.50982833e+04]
E1 = -182.5352313177845  E_coul = 54.021607720930206
cycle= 5 E= -128.513623596854  delta_E= -1.67e-10  |g|= 2.81e-06  |ddm|= 1.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5352313177845  E_coul = 54.021607720930206
  HOMO = -0.845385625601475  LUMO = 0.834765082650458
  mo_energy =
[-3.27807127e+01 -1.92913840e+00 -8.45385626e-01 -8.45385626e-01
 -8.45385626e-01  8.34765083e-01  8.34765083e-01  8.34765083e-01
  2.00731221e+00  3.76687875e+00  3.76687875e+00  3.76687875e+00
  1.36853338e+01  1.36853338e+01  1.36853338e+01  1.92991960e+01
  5.86510640e+01  5.86510640e+01  5.86510640e+01  9.36565819e+01
  3.55933050e+02  1.34926089e+03  5.83567904e+03  3.50982833e+04]
E1 = -182.53523228684014  E_coul = 54.02160868998451
Extra cycle  E= -128.513623596856  delta_E= -1.34e-12  |g|= 5.82e-07  |ddm|= 1.7e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.62884480086316
E1 = -182.53523228684014  E_coul = 54.02160868998451
init E= -128.513623596856
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.845385578527893  LUMO = 0.834765103679976
  mo_energy =
[-3.27807125e+01 -1.92913820e+00 -8.45385579e-01 -8.45385579e-01
 -8.45385579e-01  8.34765104e-01  8.34765104e-01  8.34765104e-01
  2.00731236e+00  3.76687881e+00  3.76687881e+00  3.76687881e+00
  1.36853339e+01  1.36853339e+01  1.36853339e+01  1.92991962e+01
  5.86510641e+01  5.86510641e+01  5.86510641e+01  9.36565821e+01
  3.55933050e+02  1.34926089e+03  5.83567904e+03  3.50982833e+04]
E1 = -182.53523212751483  E_coul = 54.02160853065886
cycle= 1 E= -128.513623596856  delta_E= -3.41e-13  |g|= 1.14e-07  |ddm|= 3.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53523212751483  E_coul = 54.02160853065886
  HOMO = -0.845385593786514  LUMO = 0.834765102097549
  mo_energy =
[-3.27807126e+01 -1.92913819e+00 -8.45385594e-01 -8.45385594e-01
 -8.45385594e-01  8.34765102e-01  8.34765102e-01  8.34765102e-01
  2.00731238e+00  3.76687880e+00  3.76687880e+00  3.76687880e+00
  1.36853339e+01  1.36853339e+01  1.36853339e+01  1.92991962e+01
  5.86510641e+01  5.86510641e+01  5.86510641e+01  9.36565820e+01
  3.55933050e+02  1.34926089e+03  5.83567904e+03  3.50982833e+04]
E1 = -182.5352322811567  E_coul = 54.0216086843011
Extra cycle  E= -128.513623596856  delta_E= 3.69e-13  |g|= 3.2e-08  |ddm|= 6.9e-08
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907010e+02
 2.04812123e+01 5.69551748e+01 4.84864655e-01 7.82088493e+00
 1.66298665e+00 2.25859201e+00 7.07856840e+00 2.83472057e+01
 2.80942508e-01 7.95763553e-01]
grad_E = [ 7.12322033e-11 -3.70783050e-09  6.89895412e-08 -9.26287251e-07
 -4.72618081e-05  6.49619772e-06 -1.08546186e-02  8.47591672e-05
  3.30022308e-03 -7.31300860e-03  1.22780488e-05 -1.35295857e-03
  4.43868287e-02 -5.31381583e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483241        1
[INPUT] 0    0    [1    /1   ]  174.907008688        1
[INPUT] 0    0    [1    /1   ]  20.4811459798        1
[INPUT] 0    0    [1    /1   ]  56.9551845223        1
[INPUT] 0    0    [1    /1   ]  0.492378404537       1
[INPUT] 0    0    [1    /1   ]  7.82102708195        1
[INPUT] 0    0    [1    /1   ]  1.66226183615        1
[INPUT] 1    0    [1    /1   ]  2.38108654794        1
[INPUT] 1    0    [1    /1   ]  7.27364629789        1
[INPUT] 1    0    [1    /1   ]  28.3388369023        1
[INPUT] 1    0    [1    /1   ]  0.277529857016       1
[INPUT] 1    0    [1    /1   ]  0.848153146681       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730026047, 1.0]], [0, [2712.096824029378, 1.0]], [0, [617.4984832405028, 1.0]], [0, [174.9070086883312, 1.0]], [0, [20.48114597981624, 1.0]], [0, [56.95518452230758, 1.0]], [0, [0.4923784045374339, 1.0]], [0, [7.821027081948666, 1.0]], [0, [1.6622618361524282, 1.0]], [1, [2.38108654793858, 1.0]], [1, [7.273646297891544, 1.0]], [1, [28.338836902285692, 1.0]], [1, [0.27752985701630745, 1.0]], [1, [0.8481531466806289, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.49848324]
bas 3, expnt(s) = [174.90700869]
bas 4, expnt(s) = [20.48114598]
bas 5, expnt(s) = [56.95518452]
bas 6, expnt(s) = [0.4923784]
bas 7, expnt(s) = [7.82102708]
bas 8, expnt(s) = [1.66226184]
bas 9, expnt(s) = [2.38108655]
bas 10, expnt(s) = [7.2736463]
bas 11, expnt(s) = [28.3388369]
bas 12, expnt(s) = [0.27752986]
bas 13, expnt(s) = [0.84815315]
CPU time:        40.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907009e+02 1.21512354e+02
 2.04811460e+01 2.43237602e+01 5.69551845e+01 5.23799370e+01
 4.92378405e-01 1.48504383e+00 7.82102708e+00 1.18157928e+01
 1.66226184e+00 3.69861903e+00 2.38108655e+00 8.62885894e+00
 7.27364630e+00 3.48477398e+01 2.83388369e+01 1.90748846e+02
 2.77529857e-01 5.87653778e-01 8.48153147e-01 2.37452770e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998971805357208
cond(S) = 240.0986672192446
E1 = -183.55797641741276  E_coul = 55.07743927730733
init E= -128.480537140105
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771690942014776  LUMO = 0.861901236491674
  mo_energy =
[-3.25555538e+01 -1.85144491e+00 -7.71690942e-01 -7.71690942e-01
 -7.71690942e-01  8.61901236e-01  8.61901236e-01  8.61901236e-01
  2.08497736e+00  4.01811055e+00  4.01811055e+00  4.01811055e+00
  1.44985031e+01  1.44985031e+01  1.44985031e+01  1.94834522e+01
  5.99833999e+01  5.99833999e+01  5.99833999e+01  9.38948065e+01
  3.56204148e+02  1.34956136e+03  5.83600570e+03  3.50986272e+04]
E1 = -182.00485616132903  E_coul = 53.49429297090822
cycle= 1 E= -128.510563190421  delta_E= -0.03  |g|= 0.212  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.497198
diis-c [-0.24720542  1.        ]
  HOMO = -0.88287107840877  LUMO = 0.833640019638798
  mo_energy =
[-3.28932848e+01 -1.96909801e+00 -8.82871078e-01 -8.82871078e-01
 -8.82871078e-01  8.33640020e-01  8.33640020e-01  8.33640020e-01
  2.00463251e+00  3.91867939e+00  3.91867939e+00  3.91867939e+00
  1.42989621e+01  1.42989621e+01  1.42989621e+01  1.92529325e+01
  5.96777638e+01  5.96777638e+01  5.96777638e+01  9.35770910e+01
  3.55836833e+02  1.34915548e+03  5.83556800e+03  3.50981679e+04]
E1 = -182.7906469314883  E_coul = 54.27726670204505
cycle= 2 E= -128.513380229443  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0774
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25193
diis-c [-5.67035892e-04  3.35553053e-01  6.64446947e-01]
  HOMO = -0.846101571999278  LUMO = 0.843020805049713
  mo_energy =
[-3.27816374e+01 -1.93028987e+00 -8.46101572e-01 -8.46101572e-01
 -8.46101572e-01  8.43020805e-01  8.43020805e-01  8.43020805e-01
  2.03091157e+00  3.95130007e+00  3.95130007e+00  3.95130007e+00
  1.43651800e+01  1.43651800e+01  1.43651800e+01  1.93296861e+01
  5.97790227e+01  5.97790227e+01  5.97790227e+01  9.36824784e+01
  3.55955536e+02  1.34928070e+03  5.83569633e+03  3.50982975e+04]
E1 = -182.5267204121052  E_coul = 54.01236646061366
cycle= 3 E= -128.514353951492  delta_E= -0.000974  |g|= 0.000259  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000306494
diis-c [-5.86333117e-08 -1.71091367e-03 -2.76692603e-03  1.00447784e+00]
  HOMO = -0.8462256446318  LUMO = 0.843015689102903
  mo_energy =
[-3.27818216e+01 -1.93041691e+00 -8.46225645e-01 -8.46225645e-01
 -8.46225645e-01  8.43015689e-01  8.43015689e-01  8.43015689e-01
  2.03084796e+00  3.95123834e+00  3.95123834e+00  3.95123834e+00
  1.43650676e+01  1.43650676e+01  1.43650676e+01  1.93295644e+01
  5.97788583e+01  5.97788583e+01  5.97788583e+01  9.36823128e+01
  3.55955325e+02  1.34928043e+03  5.83569600e+03  3.50982971e+04]
E1 = -182.52654096046743  E_coul = 54.01218699903488
cycle= 4 E= -128.514353961433  delta_E= -9.94e-09  |g|= 5.13e-05  |ddm|= 0.000177
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.49869e-05
diis-c [-6.54111004e-10  7.77883439e-05  3.74497385e-04 -1.17469374e-01
  1.11701709e+00]
  HOMO = -0.8462508225667  LUMO = 0.843006316434905
  mo_energy =
[-3.27818626e+01 -1.93044962e+00 -8.46250823e-01 -8.46250823e-01
 -8.46250823e-01  8.43006316e-01  8.43006316e-01  8.43006316e-01
  2.03082055e+00  3.95121242e+00  3.95121242e+00  3.95121242e+00
  1.43650305e+01  1.43650305e+01  1.43650305e+01  1.93295241e+01
  5.97788175e+01  5.97788175e+01  5.97788175e+01  9.36822723e+01
  3.55955288e+02  1.34928040e+03  5.83569597e+03  3.50982971e+04]
E1 = -182.5266016373272  E_coul = 54.0122476756084
cycle= 5 E= -128.514353961719  delta_E= -2.86e-10  |g|= 4.32e-06  |ddm|= 3.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5266016373272  E_coul = 54.0122476756084
  HOMO = -0.846249032913894  LUMO = 0.843006702418302
  mo_energy =
[-3.27818575e+01 -1.93044853e+00 -8.46249033e-01 -8.46249033e-01
 -8.46249033e-01  8.43006702e-01  8.43006702e-01  8.43006702e-01
  2.03082116e+00  3.95121390e+00  3.95121390e+00  3.95121390e+00
  1.43650335e+01  1.43650335e+01  1.43650335e+01  1.93295274e+01
  5.97788220e+01  5.97788220e+01  5.97788220e+01  9.36822770e+01
  3.55955294e+02  1.34928041e+03  5.83569598e+03  3.50982971e+04]
E1 = -182.52658736190372  E_coul = 54.01223340018253
Extra cycle  E= -128.514353961721  delta_E= -2.39e-12  |g|= 2.06e-06  |ddm|= 2.06e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907009e+02
 2.04811460e+01 5.69551845e+01 4.92378405e-01 7.82102708e+00
 1.66226184e+00 2.38108655e+00 7.27364630e+00 2.83388369e+01
 2.77529857e-01 8.48153147e-01]
E = -128.51435396172118
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483241        1
[INPUT] 0    0    [1    /1   ]  174.907008688        1
[INPUT] 0    0    [1    /1   ]  20.4811459798        1
[INPUT] 0    0    [1    /1   ]  56.9551845223        1
[INPUT] 0    0    [1    /1   ]  0.492378404537       1
[INPUT] 0    0    [1    /1   ]  7.82102708195        1
[INPUT] 0    0    [1    /1   ]  1.66226183615        1
[INPUT] 1    0    [1    /1   ]  2.38108654794        1
[INPUT] 1    0    [1    /1   ]  7.27364629789        1
[INPUT] 1    0    [1    /1   ]  28.3388369023        1
[INPUT] 1    0    [1    /1   ]  0.277529857016       1
[INPUT] 1    0    [1    /1   ]  0.848153146681       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730026047, 1.0]], [0, [2712.096824029378, 1.0]], [0, [617.4984832405028, 1.0]], [0, [174.9070086883312, 1.0]], [0, [20.48114597981624, 1.0]], [0, [56.95518452230758, 1.0]], [0, [0.4923784045374339, 1.0]], [0, [7.821027081948666, 1.0]], [0, [1.6622618361524282, 1.0]], [1, [2.38108654793858, 1.0]], [1, [7.273646297891544, 1.0]], [1, [28.338836902285692, 1.0]], [1, [0.27752985701630745, 1.0]], [1, [0.8481531466806289, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.49848324]
bas 3, expnt(s) = [174.90700869]
bas 4, expnt(s) = [20.48114598]
bas 5, expnt(s) = [56.95518452]
bas 6, expnt(s) = [0.4923784]
bas 7, expnt(s) = [7.82102708]
bas 8, expnt(s) = [1.66226184]
bas 9, expnt(s) = [2.38108655]
bas 10, expnt(s) = [7.2736463]
bas 11, expnt(s) = [28.3388369]
bas 12, expnt(s) = [0.27752986]
bas 13, expnt(s) = [0.84815315]
CPU time:        41.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907009e+02 1.21512354e+02
 2.04811460e+01 2.43237602e+01 5.69551845e+01 5.23799370e+01
 4.92378405e-01 1.48504383e+00 7.82102708e+00 1.18157928e+01
 1.66226184e+00 3.69861903e+00 2.38108655e+00 8.62885894e+00
 7.27364630e+00 3.48477398e+01 2.83388369e+01 1.90748846e+02
 2.77529857e-01 5.87653778e-01 8.48153147e-01 2.37452770e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998971805357208
cond(S) = 240.0986672192446
E1 = -183.55797641741276  E_coul = 55.07743927730733
init E= -128.480537140105
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771690942014776  LUMO = 0.861901236491674
  mo_energy =
[-3.25555538e+01 -1.85144491e+00 -7.71690942e-01 -7.71690942e-01
 -7.71690942e-01  8.61901236e-01  8.61901236e-01  8.61901236e-01
  2.08497736e+00  4.01811055e+00  4.01811055e+00  4.01811055e+00
  1.44985031e+01  1.44985031e+01  1.44985031e+01  1.94834522e+01
  5.99833999e+01  5.99833999e+01  5.99833999e+01  9.38948065e+01
  3.56204148e+02  1.34956136e+03  5.83600570e+03  3.50986272e+04]
E1 = -182.00485616132903  E_coul = 53.49429297090822
cycle= 1 E= -128.510563190421  delta_E= -0.03  |g|= 0.212  |ddm|= 0.17
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.497198
diis-c [-0.24720542  1.        ]
  HOMO = -0.88287107840877  LUMO = 0.833640019638798
  mo_energy =
[-3.28932848e+01 -1.96909801e+00 -8.82871078e-01 -8.82871078e-01
 -8.82871078e-01  8.33640020e-01  8.33640020e-01  8.33640020e-01
  2.00463251e+00  3.91867939e+00  3.91867939e+00  3.91867939e+00
  1.42989621e+01  1.42989621e+01  1.42989621e+01  1.92529325e+01
  5.96777638e+01  5.96777638e+01  5.96777638e+01  9.35770910e+01
  3.55836833e+02  1.34915548e+03  5.83556800e+03  3.50981679e+04]
E1 = -182.7906469314883  E_coul = 54.27726670204505
cycle= 2 E= -128.513380229443  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0774
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25193
diis-c [-5.67035892e-04  3.35553053e-01  6.64446947e-01]
  HOMO = -0.846101571999278  LUMO = 0.843020805049713
  mo_energy =
[-3.27816374e+01 -1.93028987e+00 -8.46101572e-01 -8.46101572e-01
 -8.46101572e-01  8.43020805e-01  8.43020805e-01  8.43020805e-01
  2.03091157e+00  3.95130007e+00  3.95130007e+00  3.95130007e+00
  1.43651800e+01  1.43651800e+01  1.43651800e+01  1.93296861e+01
  5.97790227e+01  5.97790227e+01  5.97790227e+01  9.36824784e+01
  3.55955536e+02  1.34928070e+03  5.83569633e+03  3.50982975e+04]
E1 = -182.5267204121052  E_coul = 54.01236646061366
cycle= 3 E= -128.514353951492  delta_E= -0.000974  |g|= 0.000259  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000306494
diis-c [-5.86333117e-08 -1.71091367e-03 -2.76692603e-03  1.00447784e+00]
  HOMO = -0.8462256446318  LUMO = 0.843015689102903
  mo_energy =
[-3.27818216e+01 -1.93041691e+00 -8.46225645e-01 -8.46225645e-01
 -8.46225645e-01  8.43015689e-01  8.43015689e-01  8.43015689e-01
  2.03084796e+00  3.95123834e+00  3.95123834e+00  3.95123834e+00
  1.43650676e+01  1.43650676e+01  1.43650676e+01  1.93295644e+01
  5.97788583e+01  5.97788583e+01  5.97788583e+01  9.36823128e+01
  3.55955325e+02  1.34928043e+03  5.83569600e+03  3.50982971e+04]
E1 = -182.52654096046743  E_coul = 54.01218699903488
cycle= 4 E= -128.514353961433  delta_E= -9.94e-09  |g|= 5.13e-05  |ddm|= 0.000177
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.49869e-05
diis-c [-6.54111004e-10  7.77883439e-05  3.74497385e-04 -1.17469374e-01
  1.11701709e+00]
  HOMO = -0.8462508225667  LUMO = 0.843006316434905
  mo_energy =
[-3.27818626e+01 -1.93044962e+00 -8.46250823e-01 -8.46250823e-01
 -8.46250823e-01  8.43006316e-01  8.43006316e-01  8.43006316e-01
  2.03082055e+00  3.95121242e+00  3.95121242e+00  3.95121242e+00
  1.43650305e+01  1.43650305e+01  1.43650305e+01  1.93295241e+01
  5.97788175e+01  5.97788175e+01  5.97788175e+01  9.36822723e+01
  3.55955288e+02  1.34928040e+03  5.83569597e+03  3.50982971e+04]
E1 = -182.5266016373272  E_coul = 54.0122476756084
cycle= 5 E= -128.514353961719  delta_E= -2.86e-10  |g|= 4.32e-06  |ddm|= 3.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5266016373272  E_coul = 54.0122476756084
  HOMO = -0.846249032913894  LUMO = 0.843006702418302
  mo_energy =
[-3.27818575e+01 -1.93044853e+00 -8.46249033e-01 -8.46249033e-01
 -8.46249033e-01  8.43006702e-01  8.43006702e-01  8.43006702e-01
  2.03082116e+00  3.95121390e+00  3.95121390e+00  3.95121390e+00
  1.43650335e+01  1.43650335e+01  1.43650335e+01  1.93295274e+01
  5.97788220e+01  5.97788220e+01  5.97788220e+01  9.36822770e+01
  3.55955294e+02  1.34928041e+03  5.83569598e+03  3.50982971e+04]
E1 = -182.52658736190372  E_coul = 54.01223340018253
Extra cycle  E= -128.514353961721  delta_E= -2.39e-12  |g|= 2.06e-06  |ddm|= 2.06e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.0986672192446
E1 = -182.52658736190372  E_coul = 54.01223340018253
init E= -128.514353961721
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.846250023158255  LUMO = 0.843006432931679
  mo_energy =
[-3.27818605e+01 -1.93044974e+00 -8.46250023e-01 -8.46250023e-01
 -8.46250023e-01  8.43006433e-01  8.43006433e-01  8.43006433e-01
  2.03082031e+00  3.95121300e+00  3.95121300e+00  3.95121300e+00
  1.43650317e+01  1.43650317e+01  1.43650317e+01  1.93295253e+01
  5.97788193e+01  5.97788193e+01  5.97788193e+01  9.36822742e+01
  3.55955290e+02  1.34928040e+03  5.83569598e+03  3.50982971e+04]
E1 = -182.52659408946926  E_coul = 54.012240127747866
cycle= 1 E= -128.514353961721  delta_E= -1.99e-13  |g|= 9.15e-07  |ddm|= 9.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52659408946926  E_coul = 54.012240127747866
  HOMO = -0.846249544827263  LUMO = 0.843006552075181
  mo_energy =
[-3.27818590e+01 -1.93044927e+00 -8.46249545e-01 -8.46249545e-01
 -8.46249545e-01  8.43006552e-01  8.43006552e-01  8.43006552e-01
  2.03082062e+00  3.95121342e+00  3.95121342e+00  3.95121342e+00
  1.43650326e+01  1.43650326e+01  1.43650326e+01  1.93295263e+01
  5.97788206e+01  5.97788206e+01  5.97788206e+01  9.36822755e+01
  3.55955292e+02  1.34928040e+03  5.83569598e+03  3.50982971e+04]
E1 = -182.52659056468582  E_coul = 54.012236602964485
Extra cycle  E= -128.514353961721  delta_E= 5.68e-14  |g|= 4.8e-07  |ddm|= 3.24e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907009e+02
 2.04811460e+01 5.69551845e+01 4.92378405e-01 7.82102708e+00
 1.66226184e+00 2.38108655e+00 7.27364630e+00 2.83388369e+01
 2.77529857e-01 8.48153147e-01]
grad_E = [ 4.07426341e-13  1.64099367e-10 -4.46024067e-09  3.72566051e-08
  1.90984039e-06 -5.43980659e-07  5.46266137e-03 -1.93039110e-05
 -9.16554853e-04 -1.20606750e-02  1.54455835e-03 -1.65417578e-03
 -7.45679428e-03  2.06430712e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483259        1
[INPUT] 0    0    [1    /1   ]  174.907008488        1
[INPUT] 0    0    [1    /1   ]  20.4811362561        1
[INPUT] 0    0    [1    /1   ]  56.9551863063        1
[INPUT] 0    0    [1    /1   ]  0.490053735959       1
[INPUT] 0    0    [1    /1   ]  7.82106224643        1
[INPUT] 0    0    [1    /1   ]  1.66253550856        1
[INPUT] 1    0    [1    /1   ]  2.42235361316        1
[INPUT] 1    0    [1    /1   ]  7.30617528458        1
[INPUT] 1    0    [1    /1   ]  28.3389449093        1
[INPUT] 1    0    [1    /1   ]  0.280413170809       1
[INPUT] 1    0    [1    /1   ]  0.861570053749       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730026047, 1.0]], [0, [2712.0968240285033, 1.0]], [0, [617.4984832591136, 1.0]], [0, [174.90700848799122, 1.0]], [0, [20.481136256064335, 1.0]], [0, [56.955186306295865, 1.0]], [0, [0.49005373595856616, 1.0]], [0, [7.821062246433629, 1.0]], [0, [1.662535508561398, 1.0]], [1, [2.4223536131622017, 1.0]], [1, [7.306175284575864, 1.0]], [1, [28.33894490932959, 1.0]], [1, [0.28041317080921685, 1.0]], [1, [0.861570053749072, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.49848326]
bas 3, expnt(s) = [174.90700849]
bas 4, expnt(s) = [20.48113626]
bas 5, expnt(s) = [56.95518631]
bas 6, expnt(s) = [0.49005374]
bas 7, expnt(s) = [7.82106225]
bas 8, expnt(s) = [1.66253551]
bas 9, expnt(s) = [2.42235361]
bas 10, expnt(s) = [7.30617528]
bas 11, expnt(s) = [28.33894491]
bas 12, expnt(s) = [0.28041317]
bas 13, expnt(s) = [0.86157005]
CPU time:        43.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907008e+02 1.21512354e+02
 2.04811363e+01 2.43237516e+01 5.69551863e+01 5.23799382e+01
 4.90053736e-01 1.47978221e+00 7.82106225e+00 1.18158326e+01
 1.66253551e+00 3.69907572e+00 2.42235361e+00 8.81619767e+00
 7.30617528e+00 3.50426549e+01 2.83389449e+01 1.90749755e+02
 2.80413171e-01 5.95295230e-01 8.61570054e-01 2.42157340e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99895285670328
cond(S) = 239.95750911973454
E1 = -183.55855785462694  E_coul = 55.07780882580918
init E= -128.480749028818
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771684582900849  LUMO = 0.87402155338556
  mo_energy =
[-3.25554981e+01 -1.85141765e+00 -7.71684583e-01 -7.71684583e-01
 -7.71684583e-01  8.74021553e-01  8.74021553e-01  8.74021553e-01
  2.07730535e+00  4.08710822e+00  4.08710822e+00  4.08710822e+00
  1.46974237e+01  1.46974237e+01  1.46974237e+01  1.94741596e+01
  6.02646386e+01  6.02646386e+01  6.02646386e+01  9.38869703e+01
  3.56197415e+02  1.34955548e+03  5.83600060e+03  3.50986230e+04]
E1 = -182.00550886251895  E_coul = 53.494785860524864
cycle= 1 E= -128.510723001994  delta_E= -0.03  |g|= 0.212  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.497633
diis-c [-0.24763888  1.        ]
  HOMO = -0.882909123914182  LUMO = 0.845247926471717
  mo_energy =
[-3.28931152e+01 -1.96898586e+00 -8.82909124e-01 -8.82909124e-01
 -8.82909124e-01  8.45247926e-01  8.45247926e-01  8.45247926e-01
  1.99717787e+00  3.98636791e+00  3.98636791e+00  3.98636791e+00
  1.44972736e+01  1.44972736e+01  1.44972736e+01  1.92436067e+01
  5.99591978e+01  5.99591978e+01  5.99591978e+01  9.35693554e+01
  3.55830151e+02  1.34914960e+03  5.83556288e+03  3.50981637e+04]
E1 = -182.7910066976993  E_coul = 54.27746703249704
cycle= 2 E= -128.513539665202  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0773
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.251995
diis-c [-5.63540760e-04  3.35420242e-01  6.64579758e-01]
  HOMO = -0.846148563987022  LUMO = 0.854807283152516
  mo_energy =
[-3.27814762e+01 -1.93018795e+00 -8.46148564e-01 -8.46148564e-01
 -8.46148564e-01  8.54807283e-01  8.54807283e-01  8.54807283e-01
  2.02340806e+00  4.01941400e+00  4.01941400e+00  4.01941400e+00
  1.45637023e+01  1.45637023e+01  1.45637023e+01  1.93203552e+01
  6.00604165e+01  6.00604165e+01  6.00604165e+01  9.36747354e+01
  3.55948845e+02  1.34927481e+03  5.83569120e+03  3.50982932e+04]
E1 = -182.52731230351665  E_coul = 54.01279974849159
cycle= 3 E= -128.514512555025  delta_E= -0.000973  |g|= 0.00023  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00030239
diis-c [-4.49737777e-08 -1.66128868e-03 -2.52503967e-03  1.00418633e+00]
  HOMO = -0.846268526109729  LUMO = 0.854805740239251
  mo_energy =
[-3.27816539e+01 -1.93029933e+00 -8.46268526e-01 -8.46268526e-01
 -8.46268526e-01  8.54805740e-01  8.54805740e-01  8.54805740e-01
  2.02335844e+00  4.01935803e+00  4.01935803e+00  4.01935803e+00
  1.45635971e+01  1.45635971e+01  1.45635971e+01  1.93202417e+01
  6.00602593e+01  6.00602593e+01  6.00602593e+01  9.36745764e+01
  3.55948638e+02  1.34927454e+03  5.83569087e+03  3.50982929e+04]
E1 = -182.52716468877637  E_coul = 54.01265212679302
cycle= 4 E= -128.514512561983  delta_E= -6.96e-09  |g|= 4.74e-05  |ddm|= 0.000146
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.24036e-05
diis-c [-4.22747893e-10  4.35385666e-05  3.54795509e-04 -9.16663679e-02
  1.09126803e+00]
  HOMO = -0.846292718126357  LUMO = 0.854797002572182
  mo_energy =
[-3.27816950e+01 -1.93032824e+00 -8.46292718e-01 -8.46292718e-01
 -8.46292718e-01  8.54797003e-01  8.54797003e-01  8.54797003e-01
  2.02333452e+00  4.01933342e+00  4.01933342e+00  4.01933342e+00
  1.45635613e+01  1.45635613e+01  1.45635613e+01  1.93202032e+01
  6.00602188e+01  6.00602188e+01  6.00602188e+01  9.36745360e+01
  3.55948599e+02  1.34927451e+03  5.83569083e+03  3.50982928e+04]
E1 = -182.52723425833253  E_coul = 54.01272169613951
cycle= 5 E= -128.514512562193  delta_E= -2.1e-10  |g|= 2.93e-06  |ddm|= 2.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52723425833253  E_coul = 54.01272169613951
  HOMO = -0.846291824500382  LUMO = 0.854797143891221
  mo_energy =
[-3.27816921e+01 -1.93032787e+00 -8.46291825e-01 -8.46291825e-01
 -8.46291825e-01  8.54797144e-01  8.54797144e-01  8.54797144e-01
  2.02333461e+00  4.01933411e+00  4.01933411e+00  4.01933411e+00
  1.45635629e+01  1.45635629e+01  1.45635629e+01  1.93202050e+01
  6.00602214e+01  6.00602214e+01  6.00602214e+01  9.36745387e+01
  3.55948602e+02  1.34927451e+03  5.83569084e+03  3.50982928e+04]
E1 = -182.52722507795949  E_coul = 54.01271251576518
Extra cycle  E= -128.514512562194  delta_E= -1.28e-12  |g|= 1.34e-06  |ddm|= 1.7e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907008e+02
 2.04811363e+01 5.69551863e+01 4.90053736e-01 7.82106225e+00
 1.66253551e+00 2.42235361e+00 7.30617528e+00 2.83389449e+01
 2.80413171e-01 8.61570054e-01]
E = -128.5145125621943
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483259        1
[INPUT] 0    0    [1    /1   ]  174.907008488        1
[INPUT] 0    0    [1    /1   ]  20.4811362561        1
[INPUT] 0    0    [1    /1   ]  56.9551863063        1
[INPUT] 0    0    [1    /1   ]  0.490053735959       1
[INPUT] 0    0    [1    /1   ]  7.82106224643        1
[INPUT] 0    0    [1    /1   ]  1.66253550856        1
[INPUT] 1    0    [1    /1   ]  2.42235361316        1
[INPUT] 1    0    [1    /1   ]  7.30617528458        1
[INPUT] 1    0    [1    /1   ]  28.3389449093        1
[INPUT] 1    0    [1    /1   ]  0.280413170809       1
[INPUT] 1    0    [1    /1   ]  0.861570053749       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730026047, 1.0]], [0, [2712.0968240285033, 1.0]], [0, [617.4984832591136, 1.0]], [0, [174.90700848799122, 1.0]], [0, [20.481136256064335, 1.0]], [0, [56.955186306295865, 1.0]], [0, [0.49005373595856616, 1.0]], [0, [7.821062246433629, 1.0]], [0, [1.662535508561398, 1.0]], [1, [2.4223536131622017, 1.0]], [1, [7.306175284575864, 1.0]], [1, [28.33894490932959, 1.0]], [1, [0.28041317080921685, 1.0]], [1, [0.861570053749072, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.49848326]
bas 3, expnt(s) = [174.90700849]
bas 4, expnt(s) = [20.48113626]
bas 5, expnt(s) = [56.95518631]
bas 6, expnt(s) = [0.49005374]
bas 7, expnt(s) = [7.82106225]
bas 8, expnt(s) = [1.66253551]
bas 9, expnt(s) = [2.42235361]
bas 10, expnt(s) = [7.30617528]
bas 11, expnt(s) = [28.33894491]
bas 12, expnt(s) = [0.28041317]
bas 13, expnt(s) = [0.86157005]
CPU time:        43.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907008e+02 1.21512354e+02
 2.04811363e+01 2.43237516e+01 5.69551863e+01 5.23799382e+01
 4.90053736e-01 1.47978221e+00 7.82106225e+00 1.18158326e+01
 1.66253551e+00 3.69907572e+00 2.42235361e+00 8.81619767e+00
 7.30617528e+00 3.50426549e+01 2.83389449e+01 1.90749755e+02
 2.80413171e-01 5.95295230e-01 8.61570054e-01 2.42157340e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99895285670328
cond(S) = 239.95750911973454
E1 = -183.55855785462694  E_coul = 55.07780882580918
init E= -128.480749028818
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771684582900849  LUMO = 0.87402155338556
  mo_energy =
[-3.25554981e+01 -1.85141765e+00 -7.71684583e-01 -7.71684583e-01
 -7.71684583e-01  8.74021553e-01  8.74021553e-01  8.74021553e-01
  2.07730535e+00  4.08710822e+00  4.08710822e+00  4.08710822e+00
  1.46974237e+01  1.46974237e+01  1.46974237e+01  1.94741596e+01
  6.02646386e+01  6.02646386e+01  6.02646386e+01  9.38869703e+01
  3.56197415e+02  1.34955548e+03  5.83600060e+03  3.50986230e+04]
E1 = -182.00550886251895  E_coul = 53.494785860524864
cycle= 1 E= -128.510723001994  delta_E= -0.03  |g|= 0.212  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.497633
diis-c [-0.24763888  1.        ]
  HOMO = -0.882909123914182  LUMO = 0.845247926471717
  mo_energy =
[-3.28931152e+01 -1.96898586e+00 -8.82909124e-01 -8.82909124e-01
 -8.82909124e-01  8.45247926e-01  8.45247926e-01  8.45247926e-01
  1.99717787e+00  3.98636791e+00  3.98636791e+00  3.98636791e+00
  1.44972736e+01  1.44972736e+01  1.44972736e+01  1.92436067e+01
  5.99591978e+01  5.99591978e+01  5.99591978e+01  9.35693554e+01
  3.55830151e+02  1.34914960e+03  5.83556288e+03  3.50981637e+04]
E1 = -182.7910066976993  E_coul = 54.27746703249704
cycle= 2 E= -128.513539665202  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0773
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.251995
diis-c [-5.63540760e-04  3.35420242e-01  6.64579758e-01]
  HOMO = -0.846148563987022  LUMO = 0.854807283152516
  mo_energy =
[-3.27814762e+01 -1.93018795e+00 -8.46148564e-01 -8.46148564e-01
 -8.46148564e-01  8.54807283e-01  8.54807283e-01  8.54807283e-01
  2.02340806e+00  4.01941400e+00  4.01941400e+00  4.01941400e+00
  1.45637023e+01  1.45637023e+01  1.45637023e+01  1.93203552e+01
  6.00604165e+01  6.00604165e+01  6.00604165e+01  9.36747354e+01
  3.55948845e+02  1.34927481e+03  5.83569120e+03  3.50982932e+04]
E1 = -182.52731230351665  E_coul = 54.01279974849159
cycle= 3 E= -128.514512555025  delta_E= -0.000973  |g|= 0.00023  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00030239
diis-c [-4.49737777e-08 -1.66128868e-03 -2.52503967e-03  1.00418633e+00]
  HOMO = -0.846268526109729  LUMO = 0.854805740239251
  mo_energy =
[-3.27816539e+01 -1.93029933e+00 -8.46268526e-01 -8.46268526e-01
 -8.46268526e-01  8.54805740e-01  8.54805740e-01  8.54805740e-01
  2.02335844e+00  4.01935803e+00  4.01935803e+00  4.01935803e+00
  1.45635971e+01  1.45635971e+01  1.45635971e+01  1.93202417e+01
  6.00602593e+01  6.00602593e+01  6.00602593e+01  9.36745764e+01
  3.55948638e+02  1.34927454e+03  5.83569087e+03  3.50982929e+04]
E1 = -182.52716468877637  E_coul = 54.01265212679302
cycle= 4 E= -128.514512561983  delta_E= -6.96e-09  |g|= 4.74e-05  |ddm|= 0.000146
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.24036e-05
diis-c [-4.22747893e-10  4.35385666e-05  3.54795509e-04 -9.16663679e-02
  1.09126803e+00]
  HOMO = -0.846292718126357  LUMO = 0.854797002572182
  mo_energy =
[-3.27816950e+01 -1.93032824e+00 -8.46292718e-01 -8.46292718e-01
 -8.46292718e-01  8.54797003e-01  8.54797003e-01  8.54797003e-01
  2.02333452e+00  4.01933342e+00  4.01933342e+00  4.01933342e+00
  1.45635613e+01  1.45635613e+01  1.45635613e+01  1.93202032e+01
  6.00602188e+01  6.00602188e+01  6.00602188e+01  9.36745360e+01
  3.55948599e+02  1.34927451e+03  5.83569083e+03  3.50982928e+04]
E1 = -182.52723425833253  E_coul = 54.01272169613951
cycle= 5 E= -128.514512562193  delta_E= -2.1e-10  |g|= 2.93e-06  |ddm|= 2.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52723425833253  E_coul = 54.01272169613951
  HOMO = -0.846291824500382  LUMO = 0.854797143891221
  mo_energy =
[-3.27816921e+01 -1.93032787e+00 -8.46291825e-01 -8.46291825e-01
 -8.46291825e-01  8.54797144e-01  8.54797144e-01  8.54797144e-01
  2.02333461e+00  4.01933411e+00  4.01933411e+00  4.01933411e+00
  1.45635629e+01  1.45635629e+01  1.45635629e+01  1.93202050e+01
  6.00602214e+01  6.00602214e+01  6.00602214e+01  9.36745387e+01
  3.55948602e+02  1.34927451e+03  5.83569084e+03  3.50982928e+04]
E1 = -182.52722507795949  E_coul = 54.01271251576518
Extra cycle  E= -128.514512562194  delta_E= -1.28e-12  |g|= 1.34e-06  |ddm|= 1.7e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.95750911973454
E1 = -182.52722507795949  E_coul = 54.01271251576518
init E= -128.514512562194
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.846292467559874  LUMO = 0.854796959730169
  mo_energy =
[-3.27816940e+01 -1.93032867e+00 -8.46292468e-01 -8.46292468e-01
 -8.46292468e-01  8.54796960e-01  8.54796960e-01  8.54796960e-01
  2.02333404e+00  4.01933351e+00  4.01933351e+00  4.01933351e+00
  1.45635618e+01  1.45635618e+01  1.45635618e+01  1.93202036e+01
  6.00602197e+01  6.00602197e+01  6.00602197e+01  9.36745369e+01
  3.55948600e+02  1.34927451e+03  5.83569083e+03  3.50982928e+04]
E1 = -182.52722920493744  E_coul = 54.01271664274309
cycle= 1 E= -128.514512562194  delta_E= -2.84e-14  |g|= 5.66e-07  |ddm|= 6.26e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52722920493744  E_coul = 54.01271664274309
  HOMO = -0.846292174474764  LUMO = 0.854797033187234
  mo_energy =
[-3.27816930e+01 -1.93032839e+00 -8.46292174e-01 -8.46292174e-01
 -8.46292174e-01  8.54797033e-01  8.54797033e-01  8.54797033e-01
  2.02333422e+00  4.01933377e+00  4.01933377e+00  4.01933377e+00
  1.45635623e+01  1.45635623e+01  1.45635623e+01  1.93202042e+01
  6.00602205e+01  6.00602205e+01  6.00602205e+01  9.36745378e+01
  3.55948601e+02  1.34927451e+03  5.83569084e+03  3.50982928e+04]
E1 = -182.52722701303168  E_coul = 54.01271445083699
Extra cycle  E= -128.514512562195  delta_E= -3.41e-13  |g|= 2.99e-07  |ddm|= 2.02e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907008e+02
 2.04811363e+01 5.69551863e+01 4.90053736e-01 7.82106225e+00
 1.66253551e+00 2.42235361e+00 7.30617528e+00 2.83389449e+01
 2.80413171e-01 8.61570054e-01]
grad_E = [ 2.40597278e-11 -1.12769546e-09  2.00612915e-08 -2.83216977e-07
 -1.41119295e-05  1.78831143e-06  4.22759596e-04  1.37173075e-05
  3.87686033e-04 -8.28830815e-03  5.75024970e-04 -1.61131859e-03
 -3.45655426e-03  1.64201419e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483234        1
[INPUT] 0    0    [1    /1   ]  174.907008885        1
[INPUT] 0    0    [1    /1   ]  20.4811563712        1
[INPUT] 0    0    [1    /1   ]  56.9551841554        1
[INPUT] 0    0    [1    /1   ]  0.489097035483       1
[INPUT] 0    0    [1    /1   ]  7.82105957103        1
[INPUT] 0    0    [1    /1   ]  1.66165635461        1
[INPUT] 1    0    [1    /1   ]  2.47149628331        1
[INPUT] 1    0    [1    /1   ]  7.33582080058        1
[INPUT] 1    0    [1    /1   ]  28.3416751431        1
[INPUT] 1    0    [1    /1   ]  0.282179881282       1
[INPUT] 1    0    [1    /1   ]  0.874230150785       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730026, 1.0]], [0, [2712.096824030016, 1.0]], [0, [617.4984832344678, 1.0]], [0, [174.90700888524876, 1.0]], [0, [20.481156371217228, 1.0]], [0, [56.95518415537793, 1.0]], [0, [0.4890970354825266, 1.0]], [0, [7.821059571025704, 1.0]], [0, [1.6616563546102472, 1.0]], [1, [2.4714962833135994, 1.0]], [1, [7.335820800577117, 1.0]], [1, [28.341675143068287, 1.0]], [1, [0.2821798812823075, 1.0]], [1, [0.8742301507846941, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.49848323]
bas 3, expnt(s) = [174.90700889]
bas 4, expnt(s) = [20.48115637]
bas 5, expnt(s) = [56.95518416]
bas 6, expnt(s) = [0.48909704]
bas 7, expnt(s) = [7.82105957]
bas 8, expnt(s) = [1.66165635]
bas 9, expnt(s) = [2.47149628]
bas 10, expnt(s) = [7.3358208]
bas 11, expnt(s) = [28.34167514]
bas 12, expnt(s) = [0.28217988]
bas 13, expnt(s) = [0.87423015]
CPU time:        46.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907009e+02 1.21512354e+02
 2.04811564e+01 2.43237695e+01 5.69551842e+01 5.23799367e+01
 4.89097035e-01 1.47761502e+00 7.82105957e+00 1.18158296e+01
 1.66165635e+00 3.69760856e+00 2.47149628e+00 9.04033127e+00
 7.33582080e+00 3.52204812e+01 2.83416751e+01 1.90772727e+02
 2.82179881e-01 5.99987152e-01 8.74230151e-01 2.46613370e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998941811523371
cond(S) = 239.8534800890388
E1 = -183.5588561302737  E_coul = 55.078000234549464
init E= -128.480855895724
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771680380545492  LUMO = 0.88282024024133
  mo_energy =
[-3.25555012e+01 -1.85139199e+00 -7.71680381e-01 -7.71680381e-01
 -7.71680381e-01  8.82820240e-01  8.82820240e-01  8.82820240e-01
  2.07323253e+00  4.15485969e+00  4.15485969e+00  4.15485969e+00
  1.49082347e+01  1.49082347e+01  1.49082347e+01  1.94664092e+01
  6.05618791e+01  6.05618791e+01  6.05618791e+01  9.38796679e+01
  3.56191053e+02  1.34954992e+03  5.83599579e+03  3.50986191e+04]
E1 = -182.00684668726237  E_coul = 53.495996381459044
cycle= 1 E= -128.510850305803  delta_E= -0.03  |g|= 0.212  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.497557
diis-c [-0.24756338  1.        ]
  HOMO = -0.882850380836388  LUMO = 0.853655176362188
  mo_energy =
[-3.28928805e+01 -1.96885152e+00 -8.82850381e-01 -8.82850381e-01
 -8.82850381e-01  8.53655176e-01  8.53655176e-01  8.53655176e-01
  1.99329431e+00  4.05275699e+00  4.05275699e+00  4.05275699e+00
  1.47075119e+01  1.47075119e+01  1.47075119e+01  1.92359760e+01
  6.02567875e+01  6.02567875e+01  6.02567875e+01  9.35622786e+01
  3.55823931e+02  1.34914411e+03  5.83555811e+03  3.50981598e+04]
E1 = -182.7917658114418  E_coul = 54.27810204320816
cycle= 2 E= -128.513663768234  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0773
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.251891
diis-c [-5.58048503e-04  3.35368594e-01  6.64631406e-01]
  HOMO = -0.846115577781593  LUMO = 0.86335797488742
  mo_energy =
[-3.27813079e+01 -1.93008177e+00 -8.46115578e-01 -8.46115578e-01
 -8.46115578e-01  8.63357975e-01  8.63357975e-01  8.63357975e-01
  2.01947802e+00  4.08625778e+00  4.08625778e+00  4.08625778e+00
  1.47741428e+01  1.47741428e+01  1.47741428e+01  1.93126760e+01
  6.03579125e+01  6.03579125e+01  6.03579125e+01  9.36675963e+01
  3.55942557e+02  1.34926926e+03  5.83568635e+03  3.50982893e+04]
E1 = -182.52839553204888  E_coul = 54.01376043692823
cycle= 3 E= -128.514635095121  delta_E= -0.000971  |g|= 0.000205  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000289739
diis-c [-3.74477227e-08 -1.61963838e-03 -2.43551921e-03  1.00405516e+00]
  HOMO = -0.846228471126199  LUMO = 0.863360627180614
  mo_energy =
[-3.27814726e+01 -1.93018046e+00 -8.46228471e-01 -8.46228471e-01
 -8.46228471e-01  8.63360627e-01  8.63360627e-01  8.63360627e-01
  2.01943994e+00  4.08620965e+00  4.08620965e+00  4.08620965e+00
  1.47740479e+01  1.47740479e+01  1.47740479e+01  1.93125734e+01
  6.03577679e+01  6.03577679e+01  6.03577679e+01  9.36674498e+01
  3.55942363e+02  1.34926900e+03  5.83568604e+03  3.50982889e+04]
E1 = -182.52825851290635  E_coul = 54.013623412661545
cycle= 4 E= -128.514635100245  delta_E= -5.12e-09  |g|= 4.44e-05  |ddm|= 0.000124
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.44061e-05
diis-c [-3.19096648e-10  2.39386784e-05  3.37555371e-04 -7.64754015e-02
  1.07611391e+00]
  HOMO = -0.846251265801459  LUMO = 0.863352536214464
  mo_energy =
[-3.27815124e+01 -1.93020653e+00 -8.46251266e-01 -8.46251266e-01
 -8.46251266e-01  8.63352536e-01  8.63352536e-01  8.63352536e-01
  2.01941857e+00  4.08618652e+00  4.08618652e+00  4.08618652e+00
  1.47740140e+01  1.47740140e+01  1.47740140e+01  1.93125370e+01
  6.03577291e+01  6.03577291e+01  6.03577291e+01  9.36674108e+01
  3.55942325e+02  1.34926896e+03  5.83568600e+03  3.50982889e+04]
E1 = -182.5283308864639  E_coul = 54.01369578604892
cycle= 5 E= -128.514635100415  delta_E= -1.7e-10  |g|= 2.15e-06  |ddm|= 1.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5283308864639  E_coul = 54.01369578604892
  HOMO = -0.846250833372976  LUMO = 0.863352557945259
  mo_energy =
[-3.27815107e+01 -1.93020649e+00 -8.46250833e-01 -8.46250833e-01
 -8.46250833e-01  8.63352558e-01  8.63352558e-01  8.63352558e-01
  2.01941844e+00  4.08618680e+00  4.08618680e+00  4.08618680e+00
  1.47740148e+01  1.47740148e+01  1.47740148e+01  1.93125380e+01
  6.03577306e+01  6.03577306e+01  6.03577306e+01  9.36674124e+01
  3.55942327e+02  1.34926897e+03  5.83568600e+03  3.50982889e+04]
E1 = -182.52832463226818  E_coul = 54.01368953185217
Extra cycle  E= -128.514635100416  delta_E= -1.02e-12  |g|= 9.19e-07  |ddm|= 1.4e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907009e+02
 2.04811564e+01 5.69551842e+01 4.89097035e-01 7.82105957e+00
 1.66165635e+00 2.47149628e+00 7.33582080e+00 2.83416751e+01
 2.82179881e-01 8.74230151e-01]
E = -128.514635100416
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483234        1
[INPUT] 0    0    [1    /1   ]  174.907008885        1
[INPUT] 0    0    [1    /1   ]  20.4811563712        1
[INPUT] 0    0    [1    /1   ]  56.9551841554        1
[INPUT] 0    0    [1    /1   ]  0.489097035483       1
[INPUT] 0    0    [1    /1   ]  7.82105957103        1
[INPUT] 0    0    [1    /1   ]  1.66165635461        1
[INPUT] 1    0    [1    /1   ]  2.47149628331        1
[INPUT] 1    0    [1    /1   ]  7.33582080058        1
[INPUT] 1    0    [1    /1   ]  28.3416751431        1
[INPUT] 1    0    [1    /1   ]  0.282179881282       1
[INPUT] 1    0    [1    /1   ]  0.874230150785       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730026, 1.0]], [0, [2712.096824030016, 1.0]], [0, [617.4984832344678, 1.0]], [0, [174.90700888524876, 1.0]], [0, [20.481156371217228, 1.0]], [0, [56.95518415537793, 1.0]], [0, [0.4890970354825266, 1.0]], [0, [7.821059571025704, 1.0]], [0, [1.6616563546102472, 1.0]], [1, [2.4714962833135994, 1.0]], [1, [7.335820800577117, 1.0]], [1, [28.341675143068287, 1.0]], [1, [0.2821798812823075, 1.0]], [1, [0.8742301507846941, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.49848323]
bas 3, expnt(s) = [174.90700889]
bas 4, expnt(s) = [20.48115637]
bas 5, expnt(s) = [56.95518416]
bas 6, expnt(s) = [0.48909704]
bas 7, expnt(s) = [7.82105957]
bas 8, expnt(s) = [1.66165635]
bas 9, expnt(s) = [2.47149628]
bas 10, expnt(s) = [7.3358208]
bas 11, expnt(s) = [28.34167514]
bas 12, expnt(s) = [0.28217988]
bas 13, expnt(s) = [0.87423015]
CPU time:        46.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907009e+02 1.21512354e+02
 2.04811564e+01 2.43237695e+01 5.69551842e+01 5.23799367e+01
 4.89097035e-01 1.47761502e+00 7.82105957e+00 1.18158296e+01
 1.66165635e+00 3.69760856e+00 2.47149628e+00 9.04033127e+00
 7.33582080e+00 3.52204812e+01 2.83416751e+01 1.90772727e+02
 2.82179881e-01 5.99987152e-01 8.74230151e-01 2.46613370e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998941811523371
cond(S) = 239.8534800890388
E1 = -183.5588561302737  E_coul = 55.078000234549464
init E= -128.480855895724
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771680380545492  LUMO = 0.88282024024133
  mo_energy =
[-3.25555012e+01 -1.85139199e+00 -7.71680381e-01 -7.71680381e-01
 -7.71680381e-01  8.82820240e-01  8.82820240e-01  8.82820240e-01
  2.07323253e+00  4.15485969e+00  4.15485969e+00  4.15485969e+00
  1.49082347e+01  1.49082347e+01  1.49082347e+01  1.94664092e+01
  6.05618791e+01  6.05618791e+01  6.05618791e+01  9.38796679e+01
  3.56191053e+02  1.34954992e+03  5.83599579e+03  3.50986191e+04]
E1 = -182.00684668726237  E_coul = 53.495996381459044
cycle= 1 E= -128.510850305803  delta_E= -0.03  |g|= 0.212  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.497557
diis-c [-0.24756338  1.        ]
  HOMO = -0.882850380836388  LUMO = 0.853655176362188
  mo_energy =
[-3.28928805e+01 -1.96885152e+00 -8.82850381e-01 -8.82850381e-01
 -8.82850381e-01  8.53655176e-01  8.53655176e-01  8.53655176e-01
  1.99329431e+00  4.05275699e+00  4.05275699e+00  4.05275699e+00
  1.47075119e+01  1.47075119e+01  1.47075119e+01  1.92359760e+01
  6.02567875e+01  6.02567875e+01  6.02567875e+01  9.35622786e+01
  3.55823931e+02  1.34914411e+03  5.83555811e+03  3.50981598e+04]
E1 = -182.7917658114418  E_coul = 54.27810204320816
cycle= 2 E= -128.513663768234  delta_E= -0.00281  |g|= 0.107  |ddm|= 0.0773
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.251891
diis-c [-5.58048503e-04  3.35368594e-01  6.64631406e-01]
  HOMO = -0.846115577781593  LUMO = 0.86335797488742
  mo_energy =
[-3.27813079e+01 -1.93008177e+00 -8.46115578e-01 -8.46115578e-01
 -8.46115578e-01  8.63357975e-01  8.63357975e-01  8.63357975e-01
  2.01947802e+00  4.08625778e+00  4.08625778e+00  4.08625778e+00
  1.47741428e+01  1.47741428e+01  1.47741428e+01  1.93126760e+01
  6.03579125e+01  6.03579125e+01  6.03579125e+01  9.36675963e+01
  3.55942557e+02  1.34926926e+03  5.83568635e+03  3.50982893e+04]
E1 = -182.52839553204888  E_coul = 54.01376043692823
cycle= 3 E= -128.514635095121  delta_E= -0.000971  |g|= 0.000205  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000289739
diis-c [-3.74477227e-08 -1.61963838e-03 -2.43551921e-03  1.00405516e+00]
  HOMO = -0.846228471126199  LUMO = 0.863360627180614
  mo_energy =
[-3.27814726e+01 -1.93018046e+00 -8.46228471e-01 -8.46228471e-01
 -8.46228471e-01  8.63360627e-01  8.63360627e-01  8.63360627e-01
  2.01943994e+00  4.08620965e+00  4.08620965e+00  4.08620965e+00
  1.47740479e+01  1.47740479e+01  1.47740479e+01  1.93125734e+01
  6.03577679e+01  6.03577679e+01  6.03577679e+01  9.36674498e+01
  3.55942363e+02  1.34926900e+03  5.83568604e+03  3.50982889e+04]
E1 = -182.52825851290635  E_coul = 54.013623412661545
cycle= 4 E= -128.514635100245  delta_E= -5.12e-09  |g|= 4.44e-05  |ddm|= 0.000124
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.44061e-05
diis-c [-3.19096648e-10  2.39386784e-05  3.37555371e-04 -7.64754015e-02
  1.07611391e+00]
  HOMO = -0.846251265801459  LUMO = 0.863352536214464
  mo_energy =
[-3.27815124e+01 -1.93020653e+00 -8.46251266e-01 -8.46251266e-01
 -8.46251266e-01  8.63352536e-01  8.63352536e-01  8.63352536e-01
  2.01941857e+00  4.08618652e+00  4.08618652e+00  4.08618652e+00
  1.47740140e+01  1.47740140e+01  1.47740140e+01  1.93125370e+01
  6.03577291e+01  6.03577291e+01  6.03577291e+01  9.36674108e+01
  3.55942325e+02  1.34926896e+03  5.83568600e+03  3.50982889e+04]
E1 = -182.5283308864639  E_coul = 54.01369578604892
cycle= 5 E= -128.514635100415  delta_E= -1.7e-10  |g|= 2.15e-06  |ddm|= 1.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5283308864639  E_coul = 54.01369578604892
  HOMO = -0.846250833372976  LUMO = 0.863352557945259
  mo_energy =
[-3.27815107e+01 -1.93020649e+00 -8.46250833e-01 -8.46250833e-01
 -8.46250833e-01  8.63352558e-01  8.63352558e-01  8.63352558e-01
  2.01941844e+00  4.08618680e+00  4.08618680e+00  4.08618680e+00
  1.47740148e+01  1.47740148e+01  1.47740148e+01  1.93125380e+01
  6.03577306e+01  6.03577306e+01  6.03577306e+01  9.36674124e+01
  3.55942327e+02  1.34926897e+03  5.83568600e+03  3.50982889e+04]
E1 = -182.52832463226818  E_coul = 54.01368953185217
Extra cycle  E= -128.514635100416  delta_E= -1.02e-12  |g|= 9.19e-07  |ddm|= 1.4e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.8534800890388
E1 = -182.52832463226818  E_coul = 54.01368953185217
init E= -128.514635100416
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.846251276341678  LUMO = 0.863352425476063
  mo_energy =
[-3.27815119e+01 -1.93020705e+00 -8.46251276e-01 -8.46251276e-01
 -8.46251276e-01  8.63352425e-01  8.63352425e-01  8.63352425e-01
  2.01941803e+00  4.08618637e+00  4.08618637e+00  4.08618637e+00
  1.47740140e+01  1.47740140e+01  1.47740140e+01  1.93125371e+01
  6.03577294e+01  6.03577294e+01  6.03577294e+01  9.36674112e+01
  3.55942325e+02  1.34926896e+03  5.83568600e+03  3.50982889e+04]
E1 = -182.52832731494726  E_coul = 54.013692214530955
cycle= 1 E= -128.514635100416  delta_E= -3.13e-13  |g|= 3.71e-07  |ddm|= 4.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52832731494726  E_coul = 54.013692214530955
  HOMO = -0.846251086177481  LUMO = 0.863352473276858
  mo_energy =
[-3.27815113e+01 -1.93020687e+00 -8.46251086e-01 -8.46251086e-01
 -8.46251086e-01  8.63352473e-01  8.63352473e-01  8.63352473e-01
  2.01941815e+00  4.08618654e+00  4.08618654e+00  4.08618654e+00
  1.47740144e+01  1.47740144e+01  1.47740144e+01  1.93125375e+01
  6.03577300e+01  6.03577300e+01  6.03577300e+01  9.36674118e+01
  3.55942326e+02  1.34926897e+03  5.83568600e+03  3.50982889e+04]
E1 = -182.52832587073354  E_coul = 54.013690770317275
Extra cycle  E= -128.514635100416  delta_E= 5.68e-14  |g|= 1.97e-07  |ddm|= 1.34e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907009e+02
 2.04811564e+01 5.69551842e+01 4.89097035e-01 7.82105957e+00
 1.66165635e+00 2.47149628e+00 7.33582080e+00 2.83416751e+01
 2.82179881e-01 8.74230151e-01]
grad_E = [ 2.97084652e-11 -1.42937180e-09  2.59825313e-08 -3.56992770e-07
 -1.74408814e-05  2.35552519e-06 -1.12625026e-03  2.18553166e-05
  7.03328652e-04 -3.23559462e-03 -8.03375169e-04 -1.52665511e-03
  8.54451166e-04  1.02379419e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483197        1
[INPUT] 0    0    [1    /1   ]  174.907009428        1
[INPUT] 0    0    [1    /1   ]  20.4811827787        1
[INPUT] 0    0    [1    /1   ]  56.9551808156        1
[INPUT] 0    0    [1    /1   ]  0.488905483685       1
[INPUT] 0    0    [1    /1   ]  7.82103971361        1
[INPUT] 0    0    [1    /1   ]  1.6607580751         1
[INPUT] 1    0    [1    /1   ]  2.49078941032        1
[INPUT] 1    0    [1    /1   ]  7.3525758565         1
[INPUT] 1    0    [1    /1   ]  28.344626247         1
[INPUT] 1    0    [1    /1   ]  0.28157339959        1
[INPUT] 1    0    [1    /1   ]  0.876919644978       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025945, 1.0]], [0, [2712.0968240321527, 1.0]], [0, [617.4984831970355, 1.0]], [0, [174.9070094283322, 1.0]], [0, [20.481182778718846, 1.0]], [0, [56.95518081559694, 1.0]], [0, [0.4889054836849705, 1.0]], [0, [7.82103971360765, 1.0]], [0, [1.6607580751012996, 1.0]], [1, [2.490789410321556, 1.0]], [1, [7.352575856501512, 1.0]], [1, [28.344626247011735, 1.0]], [1, [0.2815733995898449, 1.0]], [1, [0.8769196449782939, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.4984832]
bas 3, expnt(s) = [174.90700943]
bas 4, expnt(s) = [20.48118278]
bas 5, expnt(s) = [56.95518082]
bas 6, expnt(s) = [0.48890548]
bas 7, expnt(s) = [7.82103971]
bas 8, expnt(s) = [1.66075808]
bas 9, expnt(s) = [2.49078941]
bas 10, expnt(s) = [7.35257586]
bas 11, expnt(s) = [28.34462625]
bas 12, expnt(s) = [0.2815734]
bas 13, expnt(s) = [0.87691964]
CPU time:        48.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907009e+02 1.21512354e+02
 2.04811828e+01 2.43237930e+01 5.69551808e+01 5.23799344e+01
 4.88905484e-01 1.47718097e+00 7.82103971e+00 1.18158071e+01
 1.66075808e+00 3.69610929e+00 2.49078941e+00 9.12863108e+00
 7.35257586e+00 3.53210646e+01 2.83446262e+01 1.90797558e+02
 2.81573400e-01 5.98375665e-01 8.76919645e-01 2.47562091e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998949726926135
cond(S) = 239.79890743470656
E1 = -183.55887214420724  E_coul = 55.07800218501565
init E= -128.480869959192
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771684717758965  LUMO = 0.882004360602722
  mo_energy =
[-3.25555149e+01 -1.85138825e+00 -7.71684718e-01 -7.71684718e-01
 -7.71684718e-01  8.82004361e-01  8.82004361e-01  8.82004361e-01
  2.07176024e+00  4.17068782e+00  4.17068782e+00  4.17068782e+00
  1.49830197e+01  1.49830197e+01  1.49830197e+01  1.94619467e+01
  6.06868389e+01  6.06868389e+01  6.06868389e+01  9.38752231e+01
  3.56187122e+02  1.34954646e+03  5.83599277e+03  3.50986166e+04]
E1 = -182.00591906609336  E_coul = 53.495030311690634
cycle= 1 E= -128.510888754403  delta_E= -0.03  |g|= 0.212  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.4977
diis-c [-0.2477055  1.       ]
  HOMO = -0.882939002766013  LUMO = 0.85278606736801
  mo_energy =
[-3.28930308e+01 -1.96894094e+00 -8.82939003e-01 -8.82939003e-01
 -8.82939003e-01  8.52786067e-01  8.52786067e-01  8.52786067e-01
  1.99179196e+00  4.06800208e+00  4.06800208e+00  4.06800208e+00
  1.47818128e+01  1.47818128e+01  1.47818128e+01  1.92313838e+01
  6.03816432e+01  6.03816432e+01  6.03816432e+01  9.35576988e+01
  3.55819828e+02  1.34914045e+03  5.83555487e+03  3.50981571e+04]
E1 = -182.79145698955455  E_coul = 54.277752459631145
cycle= 2 E= -128.513704529923  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0774
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252044
diis-c [-5.56683337e-04  3.35442660e-01  6.64557340e-01]
  HOMO = -0.846178055344974  LUMO = 0.862508237619045
  mo_energy =
[-3.27813881e+01 -1.93014305e+00 -8.46178055e-01 -8.46178055e-01
 -8.46178055e-01  8.62508238e-01  8.62508238e-01  8.62508238e-01
  2.01798256e+00  4.10169414e+00  4.10169414e+00  4.10169414e+00
  1.48486136e+01  1.48486136e+01  1.48486136e+01  1.93081339e+01
  6.04828276e+01  6.04828276e+01  6.04828276e+01  9.36630837e+01
  3.55938528e+02  1.34926567e+03  5.83568320e+03  3.50982867e+04]
E1 = -182.52783703625215  E_coul = 54.013159516096955
cycle= 3 E= -128.514677520155  delta_E= -0.000973  |g|= 0.000201  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000286933
diis-c [-3.67609739e-08 -1.61376496e-03 -2.43234682e-03  1.00404611e+00]
  HOMO = -0.846290067827285  LUMO = 0.862511618098093
  mo_energy =
[-3.27815504e+01 -1.93024070e+00 -8.46290068e-01 -8.46290068e-01
 -8.46290068e-01  8.62511618e-01  8.62511618e-01  8.62511618e-01
  2.01794562e+00  4.10164697e+00  4.10164697e+00  4.10164697e+00
  1.48485199e+01  1.48485199e+01  1.48485199e+01  1.93080326e+01
  6.04826853e+01  6.04826853e+01  6.04826853e+01  9.36629394e+01
  3.55938337e+02  1.34926542e+03  5.83568289e+03  3.50982863e+04]
E1 = -182.52769977497198  E_coul = 54.013022249910854
cycle= 4 E= -128.514677525061  delta_E= -4.91e-09  |g|= 4.41e-05  |ddm|= 0.000121
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.41444e-05
diis-c [-3.12601953e-10  2.16772836e-05  3.33417165e-04 -7.51218234e-02
  1.07476673e+00]
  HOMO = -0.846312655680909  LUMO = 0.862503622699603
  mo_energy =
[-3.27815899e+01 -1.93026652e+00 -8.46312656e-01 -8.46312656e-01
 -8.46312656e-01  8.62503623e-01  8.62503623e-01  8.62503623e-01
  2.01792451e+00  4.10162399e+00  4.10162399e+00  4.10162399e+00
  1.48484862e+01  1.48484862e+01  1.48484862e+01  1.93079965e+01
  6.04826467e+01  6.04826467e+01  6.04826467e+01  9.36629007e+01
  3.55938299e+02  1.34926538e+03  5.83568285e+03  3.50982863e+04]
E1 = -182.5277722317653  E_coul = 54.013094706537814
cycle= 5 E= -128.514677525228  delta_E= -1.66e-10  |g|= 2.11e-06  |ddm|= 1.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5277722317653  E_coul = 54.013094706537814
  HOMO = -0.846312241755775  LUMO = 0.862503640166648
  mo_energy =
[-3.27815882e+01 -1.93026649e+00 -8.46312242e-01 -8.46312242e-01
 -8.46312242e-01  8.62503640e-01  8.62503640e-01  8.62503640e-01
  2.01792437e+00  4.10162426e+00  4.10162426e+00  4.10162426e+00
  1.48484871e+01  1.48484871e+01  1.48484871e+01  1.93079975e+01
  6.04826482e+01  6.04826482e+01  6.04826482e+01  9.36629022e+01
  3.55938301e+02  1.34926538e+03  5.83568286e+03  3.50982863e+04]
E1 = -182.52776611498376  E_coul = 54.013088589755384
Extra cycle  E= -128.514677525228  delta_E= -8.53e-13  |g|= 8.99e-07  |ddm|= 1.38e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907009e+02
 2.04811828e+01 5.69551808e+01 4.88905484e-01 7.82103971e+00
 1.66075808e+00 2.49078941e+00 7.35257586e+00 2.83446262e+01
 2.81573400e-01 8.76919645e-01]
E = -128.51467752522836
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682403        1
[INPUT] 0    0    [1    /1   ]  617.498483197        1
[INPUT] 0    0    [1    /1   ]  174.907009428        1
[INPUT] 0    0    [1    /1   ]  20.4811827787        1
[INPUT] 0    0    [1    /1   ]  56.9551808156        1
[INPUT] 0    0    [1    /1   ]  0.488905483685       1
[INPUT] 0    0    [1    /1   ]  7.82103971361        1
[INPUT] 0    0    [1    /1   ]  1.6607580751         1
[INPUT] 1    0    [1    /1   ]  2.49078941032        1
[INPUT] 1    0    [1    /1   ]  7.3525758565         1
[INPUT] 1    0    [1    /1   ]  28.344626247         1
[INPUT] 1    0    [1    /1   ]  0.28157339959        1
[INPUT] 1    0    [1    /1   ]  0.876919644978       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025945, 1.0]], [0, [2712.0968240321527, 1.0]], [0, [617.4984831970355, 1.0]], [0, [174.9070094283322, 1.0]], [0, [20.481182778718846, 1.0]], [0, [56.95518081559694, 1.0]], [0, [0.4889054836849705, 1.0]], [0, [7.82103971360765, 1.0]], [0, [1.6607580751012996, 1.0]], [1, [2.490789410321556, 1.0]], [1, [7.352575856501512, 1.0]], [1, [28.344626247011735, 1.0]], [1, [0.2815733995898449, 1.0]], [1, [0.8769196449782939, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682403]
bas 2, expnt(s) = [617.4984832]
bas 3, expnt(s) = [174.90700943]
bas 4, expnt(s) = [20.48118278]
bas 5, expnt(s) = [56.95518082]
bas 6, expnt(s) = [0.48890548]
bas 7, expnt(s) = [7.82103971]
bas 8, expnt(s) = [1.66075808]
bas 9, expnt(s) = [2.49078941]
bas 10, expnt(s) = [7.35257586]
bas 11, expnt(s) = [28.34462625]
bas 12, expnt(s) = [0.2815734]
bas 13, expnt(s) = [0.87691964]
CPU time:        49.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907009e+02 1.21512354e+02
 2.04811828e+01 2.43237930e+01 5.69551808e+01 5.23799344e+01
 4.88905484e-01 1.47718097e+00 7.82103971e+00 1.18158071e+01
 1.66075808e+00 3.69610929e+00 2.49078941e+00 9.12863108e+00
 7.35257586e+00 3.53210646e+01 2.83446262e+01 1.90797558e+02
 2.81573400e-01 5.98375665e-01 8.76919645e-01 2.47562091e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998949726926135
cond(S) = 239.79890743470656
E1 = -183.55887214420724  E_coul = 55.07800218501565
init E= -128.480869959192
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771684717758965  LUMO = 0.882004360602722
  mo_energy =
[-3.25555149e+01 -1.85138825e+00 -7.71684718e-01 -7.71684718e-01
 -7.71684718e-01  8.82004361e-01  8.82004361e-01  8.82004361e-01
  2.07176024e+00  4.17068782e+00  4.17068782e+00  4.17068782e+00
  1.49830197e+01  1.49830197e+01  1.49830197e+01  1.94619467e+01
  6.06868389e+01  6.06868389e+01  6.06868389e+01  9.38752231e+01
  3.56187122e+02  1.34954646e+03  5.83599277e+03  3.50986166e+04]
E1 = -182.00591906609336  E_coul = 53.495030311690634
cycle= 1 E= -128.510888754403  delta_E= -0.03  |g|= 0.212  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.4977
diis-c [-0.2477055  1.       ]
  HOMO = -0.882939002766013  LUMO = 0.85278606736801
  mo_energy =
[-3.28930308e+01 -1.96894094e+00 -8.82939003e-01 -8.82939003e-01
 -8.82939003e-01  8.52786067e-01  8.52786067e-01  8.52786067e-01
  1.99179196e+00  4.06800208e+00  4.06800208e+00  4.06800208e+00
  1.47818128e+01  1.47818128e+01  1.47818128e+01  1.92313838e+01
  6.03816432e+01  6.03816432e+01  6.03816432e+01  9.35576988e+01
  3.55819828e+02  1.34914045e+03  5.83555487e+03  3.50981571e+04]
E1 = -182.79145698955455  E_coul = 54.277752459631145
cycle= 2 E= -128.513704529923  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0774
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252044
diis-c [-5.56683337e-04  3.35442660e-01  6.64557340e-01]
  HOMO = -0.846178055344974  LUMO = 0.862508237619045
  mo_energy =
[-3.27813881e+01 -1.93014305e+00 -8.46178055e-01 -8.46178055e-01
 -8.46178055e-01  8.62508238e-01  8.62508238e-01  8.62508238e-01
  2.01798256e+00  4.10169414e+00  4.10169414e+00  4.10169414e+00
  1.48486136e+01  1.48486136e+01  1.48486136e+01  1.93081339e+01
  6.04828276e+01  6.04828276e+01  6.04828276e+01  9.36630837e+01
  3.55938528e+02  1.34926567e+03  5.83568320e+03  3.50982867e+04]
E1 = -182.52783703625215  E_coul = 54.013159516096955
cycle= 3 E= -128.514677520155  delta_E= -0.000973  |g|= 0.000201  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000286933
diis-c [-3.67609739e-08 -1.61376496e-03 -2.43234682e-03  1.00404611e+00]
  HOMO = -0.846290067827285  LUMO = 0.862511618098093
  mo_energy =
[-3.27815504e+01 -1.93024070e+00 -8.46290068e-01 -8.46290068e-01
 -8.46290068e-01  8.62511618e-01  8.62511618e-01  8.62511618e-01
  2.01794562e+00  4.10164697e+00  4.10164697e+00  4.10164697e+00
  1.48485199e+01  1.48485199e+01  1.48485199e+01  1.93080326e+01
  6.04826853e+01  6.04826853e+01  6.04826853e+01  9.36629394e+01
  3.55938337e+02  1.34926542e+03  5.83568289e+03  3.50982863e+04]
E1 = -182.52769977497198  E_coul = 54.013022249910854
cycle= 4 E= -128.514677525061  delta_E= -4.91e-09  |g|= 4.41e-05  |ddm|= 0.000121
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.41444e-05
diis-c [-3.12601953e-10  2.16772836e-05  3.33417165e-04 -7.51218234e-02
  1.07476673e+00]
  HOMO = -0.846312655680909  LUMO = 0.862503622699603
  mo_energy =
[-3.27815899e+01 -1.93026652e+00 -8.46312656e-01 -8.46312656e-01
 -8.46312656e-01  8.62503623e-01  8.62503623e-01  8.62503623e-01
  2.01792451e+00  4.10162399e+00  4.10162399e+00  4.10162399e+00
  1.48484862e+01  1.48484862e+01  1.48484862e+01  1.93079965e+01
  6.04826467e+01  6.04826467e+01  6.04826467e+01  9.36629007e+01
  3.55938299e+02  1.34926538e+03  5.83568285e+03  3.50982863e+04]
E1 = -182.5277722317653  E_coul = 54.013094706537814
cycle= 5 E= -128.514677525228  delta_E= -1.66e-10  |g|= 2.11e-06  |ddm|= 1.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5277722317653  E_coul = 54.013094706537814
  HOMO = -0.846312241755775  LUMO = 0.862503640166648
  mo_energy =
[-3.27815882e+01 -1.93026649e+00 -8.46312242e-01 -8.46312242e-01
 -8.46312242e-01  8.62503640e-01  8.62503640e-01  8.62503640e-01
  2.01792437e+00  4.10162426e+00  4.10162426e+00  4.10162426e+00
  1.48484871e+01  1.48484871e+01  1.48484871e+01  1.93079975e+01
  6.04826482e+01  6.04826482e+01  6.04826482e+01  9.36629022e+01
  3.55938301e+02  1.34926538e+03  5.83568286e+03  3.50982863e+04]
E1 = -182.52776611498376  E_coul = 54.013088589755384
Extra cycle  E= -128.514677525228  delta_E= -8.53e-13  |g|= 8.99e-07  |ddm|= 1.38e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.79890743470656
E1 = -182.52776611498376  E_coul = 54.013088589755384
init E= -128.514677525228
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.846312675200601  LUMO = 0.862503510232151
  mo_energy =
[-3.27815894e+01 -1.93026704e+00 -8.46312675e-01 -8.46312675e-01
 -8.46312675e-01  8.62503510e-01  8.62503510e-01  8.62503510e-01
  2.01792397e+00  4.10162384e+00  4.10162384e+00  4.10162384e+00
  1.48484863e+01  1.48484863e+01  1.48484863e+01  1.93079966e+01
  6.04826471e+01  6.04826471e+01  6.04826471e+01  9.36629010e+01
  3.55938300e+02  1.34926538e+03  5.83568285e+03  3.50982863e+04]
E1 = -182.5277687328878  E_coul = 54.01309120765944
cycle= 1 E= -128.514677525228  delta_E=    0  |g|= 3.62e-07  |ddm|= 4.32e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5277687328878  E_coul = 54.01309120765944
  HOMO = -0.846312489630001  LUMO = 0.862503556908975
  mo_energy =
[-3.27815888e+01 -1.93026686e+00 -8.46312490e-01 -8.46312490e-01
 -8.46312490e-01  8.62503557e-01  8.62503557e-01  8.62503557e-01
  2.01792408e+00  4.10162401e+00  4.10162401e+00  4.10162401e+00
  1.48484866e+01  1.48484866e+01  1.48484866e+01  1.93079969e+01
  6.04826476e+01  6.04826476e+01  6.04826476e+01  9.36629016e+01
  3.55938300e+02  1.34926538e+03  5.83568285e+03  3.50982863e+04]
E1 = -182.52776732202065  E_coul = 54.01308979679209
Extra cycle  E= -128.514677525229  delta_E= -1.99e-13  |g|= 1.92e-07  |ddm|= 1.31e-07
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907009e+02
 2.04811828e+01 5.69551808e+01 4.88905484e-01 7.82103971e+00
 1.66075808e+00 2.49078941e+00 7.35257586e+00 2.83446262e+01
 2.81573400e-01 8.76919645e-01]
grad_E = [ 2.74950078e-11 -1.30398087e-09  2.37390790e-08 -3.25549808e-07
 -1.57321840e-05  2.15381602e-06 -1.05306581e-03  1.95884359e-05
  6.16058337e-04 -1.36338328e-03 -1.26086429e-03 -1.50255117e-03
  7.67841710e-04  7.99215481e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682404        1
[INPUT] 0    0    [1    /1   ]  617.498483102        1
[INPUT] 0    0    [1    /1   ]  174.907010789        1
[INPUT] 0    0    [1    /1   ]  20.4812480324        1
[INPUT] 0    0    [1    /1   ]  56.955172294         1
[INPUT] 0    0    [1    /1   ]  0.48856469433        1
[INPUT] 0    0    [1    /1   ]  7.82098571716        1
[INPUT] 0    0    [1    /1   ]  1.65876361366        1
[INPUT] 1    0    [1    /1   ]  2.51458126946        1
[INPUT] 1    0    [1    /1   ]  7.38741024049        1
[INPUT] 1    0    [1    /1   ]  28.3519694471        1
[INPUT] 1    0    [1    /1   ]  0.279377703911       1
[INPUT] 1    0    [1    /1   ]  0.876000714709       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025814, 1.0]], [0, [2712.096824037534, 1.0]], [0, [617.4984831017583, 1.0]], [0, [174.90701078898633, 1.0]], [0, [20.481248032422876, 1.0]], [0, [56.9551722939883, 1.0]], [0, [0.48856469433028465, 1.0]], [0, [7.8209857171623876, 1.0]], [0, [1.6587636136583102, 1.0]], [1, [2.5145812694619365, 1.0]], [1, [7.387410240492291, 1.0]], [1, [28.35196944705923, 1.0]], [1, [0.27937770391098604, 1.0]], [1, [0.876000714708699, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682404]
bas 2, expnt(s) = [617.4984831]
bas 3, expnt(s) = [174.90701079]
bas 4, expnt(s) = [20.48124803]
bas 5, expnt(s) = [56.95517229]
bas 6, expnt(s) = [0.48856469]
bas 7, expnt(s) = [7.82098572]
bas 8, expnt(s) = [1.65876361]
bas 9, expnt(s) = [2.51458127]
bas 10, expnt(s) = [7.38741024]
bas 11, expnt(s) = [28.35196945]
bas 12, expnt(s) = [0.2793777]
bas 13, expnt(s) = [0.87600071]
CPU time:        51.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907011e+02 1.21512355e+02
 2.04812480e+01 2.43238511e+01 5.69551723e+01 5.23799286e+01
 4.88564694e-01 1.47640866e+00 7.82098572e+00 1.18157459e+01
 1.65876361e+00 3.69277970e+00 2.51458127e+00 9.23775602e+00
 7.38741024e+00 3.55303646e+01 2.83519694e+01 1.90859347e+02
 2.79377704e-01 5.92548731e-01 8.76000715e-01 2.47237856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998974447683317
cond(S) = 239.68314242405123
E1 = -183.5588557443419  E_coul = 55.07795604647166
init E= -128.48089969787
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771698833740446  LUMO = 0.875689044413328
  mo_energy =
[-3.25555396e+01 -1.85138872e+00 -7.71698834e-01 -7.71698834e-01
 -7.71698834e-01  8.75689044e-01  8.75689044e-01  8.75689044e-01
  2.06878020e+00  4.17369524e+00  4.17369524e+00  4.17369524e+00
  1.50681922e+01  1.50681922e+01  1.50681922e+01  1.94523730e+01
  6.08729835e+01  6.08729835e+01  6.08729835e+01  9.38656671e+01
  3.56178642e+02  1.34953896e+03  5.83598622e+03  3.50986112e+04]
E1 = -182.00363028411616  E_coul = 53.49267951098846
cycle= 1 E= -128.510950773128  delta_E= -0.0301  |g|= 0.212  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498142
diis-c [-0.2481458  1.       ]
  HOMO = -0.883145454026728  LUMO = 0.846580304132236
  mo_energy =
[-3.28934091e+01 -1.96915873e+00 -8.83145454e-01 -8.83145454e-01
 -8.83145454e-01  8.46580304e-01  8.46580304e-01  8.46580304e-01
  1.98873612e+00  4.07032587e+00  4.07032587e+00  4.07032587e+00
  1.48660510e+01  1.48660510e+01  1.48660510e+01  1.92214948e+01
  6.05674371e+01  6.05674371e+01  6.05674371e+01  9.35477930e+01
  3.55810951e+02  1.34913252e+03  5.83554787e+03  3.50981513e+04]
E1 = -182.79082446936127  E_coul = 54.27705123531978
cycle= 2 E= -128.513773234041  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0776
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252455
diis-c [-5.55523280e-04  3.35612473e-01  6.64387527e-01]
  HOMO = -0.846312380036132  LUMO = 0.856271674910524
  mo_energy =
[-3.27815770e+01 -1.93028281e+00 -8.46312380e-01 -8.46312380e-01
 -8.46312380e-01  8.56271675e-01  8.56271675e-01  8.56271675e-01
  2.01495526e+00  4.10425239e+00  4.10425239e+00  4.10425239e+00
  1.49331927e+01  1.49331927e+01  1.49331927e+01  1.92983810e+01
  6.06688046e+01  6.06688046e+01  6.06688046e+01  9.36533589e+01
  3.55929849e+02  1.34925794e+03  5.83567641e+03  3.50982810e+04]
E1 = -182.5265593087264  E_coul = 54.0118088669571
cycle= 3 E= -128.514750441769  delta_E= -0.000977  |g|= 0.000194  |ddm|= 0.0264
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000279219
diis-c [-3.56745608e-08 -1.59829313e-03 -2.43481295e-03  1.00403311e+00]
  HOMO = -0.846421761387318  LUMO = 0.856276696727376
  mo_energy =
[-3.27817343e+01 -1.93037778e+00 -8.46421761e-01 -8.46421761e-01
 -8.46421761e-01  8.56276697e-01  8.56276697e-01  8.56276697e-01
  2.01492111e+00  4.10420824e+00  4.10420824e+00  4.10420824e+00
  1.49331025e+01  1.49331025e+01  1.49331025e+01  1.92982835e+01
  6.06686670e+01  6.06686670e+01  6.06686670e+01  9.36532193e+01
  3.55929663e+02  1.34925769e+03  5.83567610e+03  3.50982807e+04]
E1 = -182.52641721940125  E_coul = 54.011666773060625
cycle= 4 E= -128.514750446341  delta_E= -4.57e-09  |g|= 4.35e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.33252e-05
diis-c [-3.07210081e-10  1.75881387e-05  3.25174252e-04 -7.29107633e-02
  1.07256800e+00]
  HOMO = -0.846443990977562  LUMO = 0.856268900092635
  mo_energy =
[-3.27817733e+01 -1.93040322e+00 -8.46443991e-01 -8.46443991e-01
 -8.46443991e-01  8.56268900e-01  8.56268900e-01  8.56268900e-01
  2.01490036e+00  4.10418557e+00  4.10418557e+00  4.10418557e+00
  1.49330692e+01  1.49330692e+01  1.49330692e+01  1.92982478e+01
  6.06686289e+01  6.06686289e+01  6.06686289e+01  9.36531811e+01
  3.55929626e+02  1.34925766e+03  5.83567607e+03  3.50982806e+04]
E1 = -182.52648947229585  E_coul = 54.01173902579409
cycle= 5 E= -128.514750446502  delta_E= -1.61e-10  |g|= 2.09e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52648947229585  E_coul = 54.01173902579409
  HOMO = -0.846443600505137  LUMO = 0.856268909963622
  mo_energy =
[-3.27817717e+01 -1.93040321e+00 -8.46443601e-01 -8.46443601e-01
 -8.46443601e-01  8.56268910e-01  8.56268910e-01  8.56268910e-01
  2.01490020e+00  4.10418581e+00  4.10418581e+00  4.10418581e+00
  1.49330700e+01  1.49330700e+01  1.49330700e+01  1.92982487e+01
  6.06686303e+01  6.06686303e+01  6.06686303e+01  9.36531826e+01
  3.55929627e+02  1.34925766e+03  5.83567607e+03  3.50982806e+04]
E1 = -182.5264834692844  E_coul = 54.01173302278201
Extra cycle  E= -128.514750446502  delta_E= -6.25e-13  |g|= 8.85e-07  |ddm|= 1.38e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907011e+02
 2.04812480e+01 5.69551723e+01 4.88564694e-01 7.82098572e+00
 1.65876361e+00 2.51458127e+00 7.38741024e+00 2.83519694e+01
 2.79377704e-01 8.76000715e-01]
E = -128.51475044650238
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682404        1
[INPUT] 0    0    [1    /1   ]  617.498483102        1
[INPUT] 0    0    [1    /1   ]  174.907010789        1
[INPUT] 0    0    [1    /1   ]  20.4812480324        1
[INPUT] 0    0    [1    /1   ]  56.955172294         1
[INPUT] 0    0    [1    /1   ]  0.48856469433        1
[INPUT] 0    0    [1    /1   ]  7.82098571716        1
[INPUT] 0    0    [1    /1   ]  1.65876361366        1
[INPUT] 1    0    [1    /1   ]  2.51458126946        1
[INPUT] 1    0    [1    /1   ]  7.38741024049        1
[INPUT] 1    0    [1    /1   ]  28.3519694471        1
[INPUT] 1    0    [1    /1   ]  0.279377703911       1
[INPUT] 1    0    [1    /1   ]  0.876000714709       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025814, 1.0]], [0, [2712.096824037534, 1.0]], [0, [617.4984831017583, 1.0]], [0, [174.90701078898633, 1.0]], [0, [20.481248032422876, 1.0]], [0, [56.9551722939883, 1.0]], [0, [0.48856469433028465, 1.0]], [0, [7.8209857171623876, 1.0]], [0, [1.6587636136583102, 1.0]], [1, [2.5145812694619365, 1.0]], [1, [7.387410240492291, 1.0]], [1, [28.35196944705923, 1.0]], [1, [0.27937770391098604, 1.0]], [1, [0.876000714708699, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682404]
bas 2, expnt(s) = [617.4984831]
bas 3, expnt(s) = [174.90701079]
bas 4, expnt(s) = [20.48124803]
bas 5, expnt(s) = [56.95517229]
bas 6, expnt(s) = [0.48856469]
bas 7, expnt(s) = [7.82098572]
bas 8, expnt(s) = [1.65876361]
bas 9, expnt(s) = [2.51458127]
bas 10, expnt(s) = [7.38741024]
bas 11, expnt(s) = [28.35196945]
bas 12, expnt(s) = [0.2793777]
bas 13, expnt(s) = [0.87600071]
CPU time:        51.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498483e+02 3.12962243e+02 1.74907011e+02 1.21512355e+02
 2.04812480e+01 2.43238511e+01 5.69551723e+01 5.23799286e+01
 4.88564694e-01 1.47640866e+00 7.82098572e+00 1.18157459e+01
 1.65876361e+00 3.69277970e+00 2.51458127e+00 9.23775602e+00
 7.38741024e+00 3.55303646e+01 2.83519694e+01 1.90859347e+02
 2.79377704e-01 5.92548731e-01 8.76000715e-01 2.47237856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998974447683317
cond(S) = 239.68314242405123
E1 = -183.5588557443419  E_coul = 55.07795604647166
init E= -128.48089969787
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771698833740446  LUMO = 0.875689044413328
  mo_energy =
[-3.25555396e+01 -1.85138872e+00 -7.71698834e-01 -7.71698834e-01
 -7.71698834e-01  8.75689044e-01  8.75689044e-01  8.75689044e-01
  2.06878020e+00  4.17369524e+00  4.17369524e+00  4.17369524e+00
  1.50681922e+01  1.50681922e+01  1.50681922e+01  1.94523730e+01
  6.08729835e+01  6.08729835e+01  6.08729835e+01  9.38656671e+01
  3.56178642e+02  1.34953896e+03  5.83598622e+03  3.50986112e+04]
E1 = -182.00363028411616  E_coul = 53.49267951098846
cycle= 1 E= -128.510950773128  delta_E= -0.0301  |g|= 0.212  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498142
diis-c [-0.2481458  1.       ]
  HOMO = -0.883145454026728  LUMO = 0.846580304132236
  mo_energy =
[-3.28934091e+01 -1.96915873e+00 -8.83145454e-01 -8.83145454e-01
 -8.83145454e-01  8.46580304e-01  8.46580304e-01  8.46580304e-01
  1.98873612e+00  4.07032587e+00  4.07032587e+00  4.07032587e+00
  1.48660510e+01  1.48660510e+01  1.48660510e+01  1.92214948e+01
  6.05674371e+01  6.05674371e+01  6.05674371e+01  9.35477930e+01
  3.55810951e+02  1.34913252e+03  5.83554787e+03  3.50981513e+04]
E1 = -182.79082446936127  E_coul = 54.27705123531978
cycle= 2 E= -128.513773234041  delta_E= -0.00282  |g|= 0.107  |ddm|= 0.0776
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252455
diis-c [-5.55523280e-04  3.35612473e-01  6.64387527e-01]
  HOMO = -0.846312380036132  LUMO = 0.856271674910524
  mo_energy =
[-3.27815770e+01 -1.93028281e+00 -8.46312380e-01 -8.46312380e-01
 -8.46312380e-01  8.56271675e-01  8.56271675e-01  8.56271675e-01
  2.01495526e+00  4.10425239e+00  4.10425239e+00  4.10425239e+00
  1.49331927e+01  1.49331927e+01  1.49331927e+01  1.92983810e+01
  6.06688046e+01  6.06688046e+01  6.06688046e+01  9.36533589e+01
  3.55929849e+02  1.34925794e+03  5.83567641e+03  3.50982810e+04]
E1 = -182.5265593087264  E_coul = 54.0118088669571
cycle= 3 E= -128.514750441769  delta_E= -0.000977  |g|= 0.000194  |ddm|= 0.0264
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000279219
diis-c [-3.56745608e-08 -1.59829313e-03 -2.43481295e-03  1.00403311e+00]
  HOMO = -0.846421761387318  LUMO = 0.856276696727376
  mo_energy =
[-3.27817343e+01 -1.93037778e+00 -8.46421761e-01 -8.46421761e-01
 -8.46421761e-01  8.56276697e-01  8.56276697e-01  8.56276697e-01
  2.01492111e+00  4.10420824e+00  4.10420824e+00  4.10420824e+00
  1.49331025e+01  1.49331025e+01  1.49331025e+01  1.92982835e+01
  6.06686670e+01  6.06686670e+01  6.06686670e+01  9.36532193e+01
  3.55929663e+02  1.34925769e+03  5.83567610e+03  3.50982807e+04]
E1 = -182.52641721940125  E_coul = 54.011666773060625
cycle= 4 E= -128.514750446341  delta_E= -4.57e-09  |g|= 4.35e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.33252e-05
diis-c [-3.07210081e-10  1.75881387e-05  3.25174252e-04 -7.29107633e-02
  1.07256800e+00]
  HOMO = -0.846443990977562  LUMO = 0.856268900092635
  mo_energy =
[-3.27817733e+01 -1.93040322e+00 -8.46443991e-01 -8.46443991e-01
 -8.46443991e-01  8.56268900e-01  8.56268900e-01  8.56268900e-01
  2.01490036e+00  4.10418557e+00  4.10418557e+00  4.10418557e+00
  1.49330692e+01  1.49330692e+01  1.49330692e+01  1.92982478e+01
  6.06686289e+01  6.06686289e+01  6.06686289e+01  9.36531811e+01
  3.55929626e+02  1.34925766e+03  5.83567607e+03  3.50982806e+04]
E1 = -182.52648947229585  E_coul = 54.01173902579409
cycle= 5 E= -128.514750446502  delta_E= -1.61e-10  |g|= 2.09e-06  |ddm|= 1.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52648947229585  E_coul = 54.01173902579409
  HOMO = -0.846443600505137  LUMO = 0.856268909963622
  mo_energy =
[-3.27817717e+01 -1.93040321e+00 -8.46443601e-01 -8.46443601e-01
 -8.46443601e-01  8.56268910e-01  8.56268910e-01  8.56268910e-01
  2.01490020e+00  4.10418581e+00  4.10418581e+00  4.10418581e+00
  1.49330700e+01  1.49330700e+01  1.49330700e+01  1.92982487e+01
  6.06686303e+01  6.06686303e+01  6.06686303e+01  9.36531826e+01
  3.55929627e+02  1.34925766e+03  5.83567607e+03  3.50982806e+04]
E1 = -182.5264834692844  E_coul = 54.01173302278201
Extra cycle  E= -128.514750446502  delta_E= -6.25e-13  |g|= 8.85e-07  |ddm|= 1.38e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.68314242405123
E1 = -182.5264834692844  E_coul = 54.01173302278201
init E= -128.514750446502
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.846444026202776  LUMO = 0.856268782616249
  mo_energy =
[-3.27817729e+01 -1.93040375e+00 -8.46444026e-01 -8.46444026e-01
 -8.46444026e-01  8.56268783e-01  8.56268783e-01  8.56268783e-01
  2.01489981e+00  4.10418540e+00  4.10418540e+00  4.10418540e+00
  1.49330693e+01  1.49330693e+01  1.49330693e+01  1.92982478e+01
  6.06686292e+01  6.06686292e+01  6.06686292e+01  9.36531814e+01
  3.55929626e+02  1.34925766e+03  5.83567607e+03  3.50982806e+04]
E1 = -182.52648602664044  E_coul = 54.01173558013813
cycle= 1 E= -128.514750446502  delta_E= 5.68e-14  |g|= 3.55e-07  |ddm|= 4.27e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52648602664044  E_coul = 54.01173558013813
  HOMO = -0.846443844922881  LUMO = 0.856268827897328
  mo_energy =
[-3.27817723e+01 -1.93040358e+00 -8.46443845e-01 -8.46443845e-01
 -8.46443845e-01  8.56268828e-01  8.56268828e-01  8.56268828e-01
  2.01489992e+00  4.10418557e+00  4.10418557e+00  4.10418557e+00
  1.49330696e+01  1.49330696e+01  1.49330696e+01  1.92982482e+01
  6.06686297e+01  6.06686297e+01  6.06686297e+01  9.36531820e+01
  3.55929627e+02  1.34925766e+03  5.83567607e+03  3.50982806e+04]
E1 = -182.5264846448462  E_coul = 54.011734198343866
Extra cycle  E= -128.514750446502  delta_E=    0  |g|= 1.88e-07  |ddm|= 1.28e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907011e+02
 2.04812480e+01 5.69551723e+01 4.88564694e-01 7.82098572e+00
 1.65876361e+00 2.51458127e+00 7.38741024e+00 2.83519694e+01
 2.79377704e-01 8.76000715e-01]
grad_E = [ 2.12794682e-11 -9.56225248e-10  1.74028470e-08 -2.39218706e-07
 -1.13153459e-05  1.58641685e-06 -7.02983098e-04  1.33992898e-05
  3.79591893e-04  1.19662244e-03 -1.70037945e-03 -1.49528627e-03
  1.13362187e-03  3.89233846e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682405        1
[INPUT] 0    0    [1    /1   ]  617.498482956        1
[INPUT] 0    0    [1    /1   ]  174.907012855        1
[INPUT] 0    0    [1    /1   ]  20.4813460897        1
[INPUT] 0    0    [1    /1   ]  56.95515926          1
[INPUT] 0    0    [1    /1   ]  0.488062241255       1
[INPUT] 0    0    [1    /1   ]  7.82090320461        1
[INPUT] 0    0    [1    /1   ]  1.65601036177        1
[INPUT] 1    0    [1    /1   ]  2.53045855659        1
[INPUT] 1    0    [1    /1   ]  7.4391120081         1
[INPUT] 1    0    [1    /1   ]  28.3635348511        1
[INPUT] 1    0    [1    /1   ]  0.275262699782       1
[INPUT] 1    0    [1    /1   ]  0.8683541099         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025614, 1.0]], [0, [2712.0968240457164, 1.0]], [0, [617.4984829563007, 1.0]], [0, [174.90701285468796, 1.0]], [0, [20.48134608973287, 1.0]], [0, [56.955159259970976, 1.0]], [0, [0.4880622412548519, 1.0]], [0, [7.8209032046087605, 1.0]], [0, [1.6560103617676434, 1.0]], [1, [2.5304585565896702, 1.0]], [1, [7.43911200809603, 1.0]], [1, [28.363534851064294, 1.0]], [1, [0.27526269978154666, 1.0]], [1, [0.8683541099001338, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682405]
bas 2, expnt(s) = [617.49848296]
bas 3, expnt(s) = [174.90701285]
bas 4, expnt(s) = [20.48134609]
bas 5, expnt(s) = [56.95515926]
bas 6, expnt(s) = [0.48806224]
bas 7, expnt(s) = [7.8209032]
bas 8, expnt(s) = [1.65601036]
bas 9, expnt(s) = [2.53045856]
bas 10, expnt(s) = [7.43911201]
bas 11, expnt(s) = [28.36353485]
bas 12, expnt(s) = [0.2752627]
bas 13, expnt(s) = [0.86835411]
CPU time:        54.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907013e+02 1.21512356e+02
 2.04813461e+01 2.43239385e+01 5.69551593e+01 5.23799196e+01
 4.88062241e-01 1.47526973e+00 7.82090320e+00 1.18156524e+01
 1.65601036e+00 3.68818173e+00 2.53045856e+00 9.31072348e+00
 7.43911201e+00 3.58414660e+01 2.83635349e+01 1.90956671e+02
 2.75262700e-01 5.81659196e-01 8.68354110e-01 2.44543133e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999014501056354
cond(S) = 239.5212017386355
E1 = -183.55879985335235  E_coul = 55.077852037669366
init E= -128.480947815683
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77172435952769  LUMO = 0.862009766364113
  mo_energy =
[-3.25555637e+01 -1.85139816e+00 -7.71724360e-01 -7.71724360e-01
 -7.71724360e-01  8.62009766e-01  8.62009766e-01  8.62009766e-01
  2.06455844e+00  4.14713312e+00  4.14713312e+00  4.14713312e+00
  1.51172183e+01  1.51172183e+01  1.51172183e+01  1.94389643e+01
  6.10654175e+01  6.10654175e+01  6.10654175e+01  9.38523453e+01
  3.56166798e+02  1.34952846e+03  5.83597702e+03  3.50986036e+04]
E1 = -181.99975727677577  E_coul = 53.488736949241805
cycle= 1 E= -128.511020327534  delta_E= -0.0301  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498928
diis-c [-0.24892937  1.        ]
  HOMO = -0.88348721327645  LUMO = 0.833269955707802
  mo_energy =
[-3.28940410e+01 -1.96952309e+00 -8.83487213e-01 -8.83487213e-01
 -8.83487213e-01  8.33269956e-01  8.33269956e-01  8.33269956e-01
  1.98437080e+00  4.04331853e+00  4.04331853e+00  4.04331853e+00
  1.49137805e+01  1.49137805e+01  1.49137805e+01  1.92075564e+01
  6.07591931e+01  6.07591931e+01  6.07591931e+01  9.35338690e+01
  3.55798476e+02  1.34912136e+03  5.83553801e+03  3.50981430e+04]
E1 = -182.7897647796284  E_coul = 54.27591012113078
cycle= 2 E= -128.513854658498  delta_E= -0.00283  |g|= 0.107  |ddm|= 0.078
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253141
diis-c [-5.56107067e-04  3.35869723e-01  6.64130277e-01]
  HOMO = -0.846529834500861  LUMO = 0.842845987030217
  mo_energy =
[-3.27818835e+01 -1.93051245e+00 -8.46529835e-01 -8.46529835e-01
 -8.46529835e-01  8.42845987e-01  8.42845987e-01  8.42845987e-01
  2.01064793e+00  4.07741055e+00  4.07741055e+00  4.07741055e+00
  1.49814046e+01  1.49814046e+01  1.49814046e+01  1.92846775e+01
  6.08608935e+01  6.08608935e+01  6.08608935e+01  9.36397460e+01
  3.55917713e+02  1.34924713e+03  5.83566690e+03  3.50982731e+04]
E1 = -182.52440012591387  E_coul = 54.00956118285746
cycle= 3 E= -128.514838943056  delta_E= -0.000984  |g|= 0.000187  |ddm|= 0.0265
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000271672
diis-c [-3.50425960e-08 -1.57893254e-03 -2.43348195e-03  1.00401241e+00]
  HOMO = -0.846636351369497  LUMO = 0.842852778529912
  mo_energy =
[-3.27820366e+01 -1.93060467e+00 -8.46636351e-01 -8.46636351e-01
 -8.46636351e-01  8.42852779e-01  8.42852779e-01  8.42852779e-01
  2.01061674e+00  4.07737000e+00  4.07737000e+00  4.07737000e+00
  1.49813181e+01  1.49813181e+01  1.49813181e+01  1.92845839e+01
  6.08607599e+01  6.08607599e+01  6.08607599e+01  9.36396103e+01
  3.55917530e+02  1.34924689e+03  5.83566660e+03  3.50982728e+04]
E1 = -182.52425043255647  E_coul = 54.009411485159376
cycle= 4 E= -128.514838947397  delta_E= -4.34e-09  |g|= 4.32e-05  |ddm|= 0.000112
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.26678e-05
diis-c [-3.10095243e-10  1.38729796e-05  3.17617318e-04 -7.14245071e-02
  1.07109302e+00]
  HOMO = -0.846658377126407  LUMO = 0.842845175614257
  mo_energy =
[-3.27820753e+01 -1.93062997e+00 -8.46658377e-01 -8.46658377e-01
 -8.46658377e-01  8.42845176e-01  8.42845176e-01  8.42845176e-01
  2.01059617e+00  4.07734753e+00  4.07734753e+00  4.07734753e+00
  1.49812850e+01  1.49812850e+01  1.49812850e+01  1.92845484e+01
  6.08607221e+01  6.08607221e+01  6.08607221e+01  9.36395723e+01
  3.55917493e+02  1.34924685e+03  5.83566656e+03  3.50982727e+04]
E1 = -182.5243225791873  E_coul = 54.00948363163141
cycle= 5 E= -128.514838947556  delta_E= -1.59e-10  |g|= 2.13e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5243225791873  E_coul = 54.00948363163141
  HOMO = -0.846657990763638  LUMO = 0.842845180425887
  mo_energy =
[-3.27820737e+01 -1.93062998e+00 -8.46657991e-01 -8.46657991e-01
 -8.46657991e-01  8.42845180e-01  8.42845180e-01  8.42845180e-01
  2.01059599e+00  4.07734777e+00  4.07734777e+00  4.07734777e+00
  1.49812858e+01  1.49812858e+01  1.49812858e+01  1.92845493e+01
  6.08607235e+01  6.08607235e+01  6.08607235e+01  9.36395738e+01
  3.55917495e+02  1.34924685e+03  5.83566656e+03  3.50982727e+04]
E1 = -182.52431649069263  E_coul = 54.009477543135766
Extra cycle  E= -128.514838947557  delta_E= -9.66e-13  |g|= 8.99e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907013e+02
 2.04813461e+01 5.69551593e+01 4.88062241e-01 7.82090320e+00
 1.65601036e+00 2.53045856e+00 7.43911201e+00 2.83635349e+01
 2.75262700e-01 8.68354110e-01]
E = -128.51483894755685
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682405        1
[INPUT] 0    0    [1    /1   ]  617.498482956        1
[INPUT] 0    0    [1    /1   ]  174.907012855        1
[INPUT] 0    0    [1    /1   ]  20.4813460897        1
[INPUT] 0    0    [1    /1   ]  56.95515926          1
[INPUT] 0    0    [1    /1   ]  0.488062241255       1
[INPUT] 0    0    [1    /1   ]  7.82090320461        1
[INPUT] 0    0    [1    /1   ]  1.65601036177        1
[INPUT] 1    0    [1    /1   ]  2.53045855659        1
[INPUT] 1    0    [1    /1   ]  7.4391120081         1
[INPUT] 1    0    [1    /1   ]  28.3635348511        1
[INPUT] 1    0    [1    /1   ]  0.275262699782       1
[INPUT] 1    0    [1    /1   ]  0.8683541099         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025614, 1.0]], [0, [2712.0968240457164, 1.0]], [0, [617.4984829563007, 1.0]], [0, [174.90701285468796, 1.0]], [0, [20.48134608973287, 1.0]], [0, [56.955159259970976, 1.0]], [0, [0.4880622412548519, 1.0]], [0, [7.8209032046087605, 1.0]], [0, [1.6560103617676434, 1.0]], [1, [2.5304585565896702, 1.0]], [1, [7.43911200809603, 1.0]], [1, [28.363534851064294, 1.0]], [1, [0.27526269978154666, 1.0]], [1, [0.8683541099001338, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682405]
bas 2, expnt(s) = [617.49848296]
bas 3, expnt(s) = [174.90701285]
bas 4, expnt(s) = [20.48134609]
bas 5, expnt(s) = [56.95515926]
bas 6, expnt(s) = [0.48806224]
bas 7, expnt(s) = [7.8209032]
bas 8, expnt(s) = [1.65601036]
bas 9, expnt(s) = [2.53045856]
bas 10, expnt(s) = [7.43911201]
bas 11, expnt(s) = [28.36353485]
bas 12, expnt(s) = [0.2752627]
bas 13, expnt(s) = [0.86835411]
CPU time:        54.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907013e+02 1.21512356e+02
 2.04813461e+01 2.43239385e+01 5.69551593e+01 5.23799196e+01
 4.88062241e-01 1.47526973e+00 7.82090320e+00 1.18156524e+01
 1.65601036e+00 3.68818173e+00 2.53045856e+00 9.31072348e+00
 7.43911201e+00 3.58414660e+01 2.83635349e+01 1.90956671e+02
 2.75262700e-01 5.81659196e-01 8.68354110e-01 2.44543133e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999014501056354
cond(S) = 239.5212017386355
E1 = -183.55879985335235  E_coul = 55.077852037669366
init E= -128.480947815683
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77172435952769  LUMO = 0.862009766364113
  mo_energy =
[-3.25555637e+01 -1.85139816e+00 -7.71724360e-01 -7.71724360e-01
 -7.71724360e-01  8.62009766e-01  8.62009766e-01  8.62009766e-01
  2.06455844e+00  4.14713312e+00  4.14713312e+00  4.14713312e+00
  1.51172183e+01  1.51172183e+01  1.51172183e+01  1.94389643e+01
  6.10654175e+01  6.10654175e+01  6.10654175e+01  9.38523453e+01
  3.56166798e+02  1.34952846e+03  5.83597702e+03  3.50986036e+04]
E1 = -181.99975727677577  E_coul = 53.488736949241805
cycle= 1 E= -128.511020327534  delta_E= -0.0301  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498928
diis-c [-0.24892937  1.        ]
  HOMO = -0.88348721327645  LUMO = 0.833269955707802
  mo_energy =
[-3.28940410e+01 -1.96952309e+00 -8.83487213e-01 -8.83487213e-01
 -8.83487213e-01  8.33269956e-01  8.33269956e-01  8.33269956e-01
  1.98437080e+00  4.04331853e+00  4.04331853e+00  4.04331853e+00
  1.49137805e+01  1.49137805e+01  1.49137805e+01  1.92075564e+01
  6.07591931e+01  6.07591931e+01  6.07591931e+01  9.35338690e+01
  3.55798476e+02  1.34912136e+03  5.83553801e+03  3.50981430e+04]
E1 = -182.7897647796284  E_coul = 54.27591012113078
cycle= 2 E= -128.513854658498  delta_E= -0.00283  |g|= 0.107  |ddm|= 0.078
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253141
diis-c [-5.56107067e-04  3.35869723e-01  6.64130277e-01]
  HOMO = -0.846529834500861  LUMO = 0.842845987030217
  mo_energy =
[-3.27818835e+01 -1.93051245e+00 -8.46529835e-01 -8.46529835e-01
 -8.46529835e-01  8.42845987e-01  8.42845987e-01  8.42845987e-01
  2.01064793e+00  4.07741055e+00  4.07741055e+00  4.07741055e+00
  1.49814046e+01  1.49814046e+01  1.49814046e+01  1.92846775e+01
  6.08608935e+01  6.08608935e+01  6.08608935e+01  9.36397460e+01
  3.55917713e+02  1.34924713e+03  5.83566690e+03  3.50982731e+04]
E1 = -182.52440012591387  E_coul = 54.00956118285746
cycle= 3 E= -128.514838943056  delta_E= -0.000984  |g|= 0.000187  |ddm|= 0.0265
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000271672
diis-c [-3.50425960e-08 -1.57893254e-03 -2.43348195e-03  1.00401241e+00]
  HOMO = -0.846636351369497  LUMO = 0.842852778529912
  mo_energy =
[-3.27820366e+01 -1.93060467e+00 -8.46636351e-01 -8.46636351e-01
 -8.46636351e-01  8.42852779e-01  8.42852779e-01  8.42852779e-01
  2.01061674e+00  4.07737000e+00  4.07737000e+00  4.07737000e+00
  1.49813181e+01  1.49813181e+01  1.49813181e+01  1.92845839e+01
  6.08607599e+01  6.08607599e+01  6.08607599e+01  9.36396103e+01
  3.55917530e+02  1.34924689e+03  5.83566660e+03  3.50982728e+04]
E1 = -182.52425043255647  E_coul = 54.009411485159376
cycle= 4 E= -128.514838947397  delta_E= -4.34e-09  |g|= 4.32e-05  |ddm|= 0.000112
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.26678e-05
diis-c [-3.10095243e-10  1.38729796e-05  3.17617318e-04 -7.14245071e-02
  1.07109302e+00]
  HOMO = -0.846658377126407  LUMO = 0.842845175614257
  mo_energy =
[-3.27820753e+01 -1.93062997e+00 -8.46658377e-01 -8.46658377e-01
 -8.46658377e-01  8.42845176e-01  8.42845176e-01  8.42845176e-01
  2.01059617e+00  4.07734753e+00  4.07734753e+00  4.07734753e+00
  1.49812850e+01  1.49812850e+01  1.49812850e+01  1.92845484e+01
  6.08607221e+01  6.08607221e+01  6.08607221e+01  9.36395723e+01
  3.55917493e+02  1.34924685e+03  5.83566656e+03  3.50982727e+04]
E1 = -182.5243225791873  E_coul = 54.00948363163141
cycle= 5 E= -128.514838947556  delta_E= -1.59e-10  |g|= 2.13e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5243225791873  E_coul = 54.00948363163141
  HOMO = -0.846657990763638  LUMO = 0.842845180425887
  mo_energy =
[-3.27820737e+01 -1.93062998e+00 -8.46657991e-01 -8.46657991e-01
 -8.46657991e-01  8.42845180e-01  8.42845180e-01  8.42845180e-01
  2.01059599e+00  4.07734777e+00  4.07734777e+00  4.07734777e+00
  1.49812858e+01  1.49812858e+01  1.49812858e+01  1.92845493e+01
  6.08607235e+01  6.08607235e+01  6.08607235e+01  9.36395738e+01
  3.55917495e+02  1.34924685e+03  5.83566656e+03  3.50982727e+04]
E1 = -182.52431649069263  E_coul = 54.009477543135766
Extra cycle  E= -128.514838947557  delta_E= -9.66e-13  |g|= 8.99e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.5212017386355
E1 = -182.52431649069263  E_coul = 54.009477543135766
init E= -128.514838947557
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.846658422763788  LUMO = 0.842845052759306
  mo_energy =
[-3.27820749e+01 -1.93063053e+00 -8.46658423e-01 -8.46658423e-01
 -8.46658423e-01  8.42845053e-01  8.42845053e-01  8.42845053e-01
  2.01059559e+00  4.07734735e+00  4.07734735e+00  4.07734735e+00
  1.49812850e+01  1.49812850e+01  1.49812850e+01  1.92845484e+01
  6.08607224e+01  6.08607224e+01  6.08607224e+01  9.36395727e+01
  3.55917493e+02  1.34924685e+03  5.83566656e+03  3.50982727e+04]
E1 = -182.52431907627914  E_coul = 54.009480128722245
cycle= 1 E= -128.514838947557  delta_E= -2.84e-14  |g|= 3.59e-07  |ddm|= 4.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52431907627914  E_coul = 54.009480128722245
  HOMO = -0.846658239483435  LUMO = 0.842845097749403
  mo_energy =
[-3.27820743e+01 -1.93063036e+00 -8.46658239e-01 -8.46658239e-01
 -8.46658239e-01  8.42845098e-01  8.42845098e-01  8.42845098e-01
  2.01059571e+00  4.07734752e+00  4.07734752e+00  4.07734752e+00
  1.49812854e+01  1.49812854e+01  1.49812854e+01  1.92845488e+01
  6.08607229e+01  6.08607229e+01  6.08607229e+01  9.36395732e+01
  3.55917494e+02  1.34924685e+03  5.83566656e+03  3.50982727e+04]
E1 = -182.52431767515412  E_coul = 54.009478727597525
Extra cycle  E= -128.514838947557  delta_E= 2.84e-13  |g|= 1.91e-07  |ddm|= 1.3e-07
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907013e+02
 2.04813461e+01 5.69551593e+01 4.88062241e-01 7.82090320e+00
 1.65601036e+00 2.53045856e+00 7.43911201e+00 2.83635349e+01
 2.75262700e-01 8.68354110e-01]
grad_E = [ 1.24624134e-11 -4.65031567e-10  8.40568628e-09 -1.18083011e-07
 -5.35350233e-06  7.91159978e-07 -2.81545135e-04  5.34242499e-06
  7.40234508e-05  3.25050924e-03 -1.72011416e-03 -1.53861214e-03
  1.34398900e-03 -7.98503183e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682405        1
[INPUT] 0    0    [1    /1   ]  617.498482808        1
[INPUT] 0    0    [1    /1   ]  174.907014957        1
[INPUT] 0    0    [1    /1   ]  20.4814449473        1
[INPUT] 0    0    [1    /1   ]  56.955145891         1
[INPUT] 0    0    [1    /1   ]  0.487599691256       1
[INPUT] 0    0    [1    /1   ]  7.82081897479        1
[INPUT] 0    0    [1    /1   ]  1.65353884452        1
[INPUT] 1    0    [1    /1   ]  2.52608229231        1
[INPUT] 1    0    [1    /1   ]  7.49057777805        1
[INPUT] 1    0    [1    /1   ]  28.3763756081        1
[INPUT] 1    0    [1    /1   ]  0.270255567322       1
[INPUT] 1    0    [1    /1   ]  0.854356947659       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002541, 1.0]], [0, [2712.0968240540474, 1.0]], [0, [617.4984828076995, 1.0]], [0, [174.90701495699852, 1.0]], [0, [20.481444947330118, 1.0]], [0, [56.95514589100762, 1.0]], [0, [0.4875996912558423, 1.0]], [0, [7.820818974788833, 1.0]], [0, [1.653538844521264, 1.0]], [1, [2.5260822923137205, 1.0]], [1, [7.490577778051238, 1.0]], [1, [28.376375608119147, 1.0]], [1, [0.2702555673224978, 1.0]], [1, [0.8543569476590711, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682405]
bas 2, expnt(s) = [617.49848281]
bas 3, expnt(s) = [174.90701496]
bas 4, expnt(s) = [20.48144495]
bas 5, expnt(s) = [56.95514589]
bas 6, expnt(s) = [0.48759969]
bas 7, expnt(s) = [7.82081897]
bas 8, expnt(s) = [1.65353884]
bas 9, expnt(s) = [2.52608229]
bas 10, expnt(s) = [7.49057778]
bas 11, expnt(s) = [28.37637561]
bas 12, expnt(s) = [0.27025557]
bas 13, expnt(s) = [0.85435695]
CPU time:        56.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907015e+02 1.21512357e+02
 2.04814449e+01 2.43240265e+01 5.69551459e+01 5.23799103e+01
 4.87599691e-01 1.47422099e+00 7.82081897e+00 1.18155570e+01
 1.65353884e+00 3.68405263e+00 2.52608229e+00 9.29059997e+00
 7.49057778e+00 3.61516846e+01 2.83763756e+01 1.91064740e+02
 2.70255567e-01 5.68463656e-01 8.54356948e-01 2.39625806e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999058155863736
cond(S) = 239.3749996270896
E1 = -183.55876189424683  E_coul = 55.07773320390816
init E= -128.481028690339
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771754088509618  LUMO = 0.843957060411558
  mo_energy =
[-3.25555738e+01 -1.85141424e+00 -7.71754089e-01 -7.71754089e-01
 -7.71754089e-01  8.43957060e-01  8.43957060e-01  8.43957060e-01
  2.06073001e+00  4.08870108e+00  4.08870108e+00  4.08870108e+00
  1.50860021e+01  1.50860021e+01  1.50860021e+01  1.94268248e+01
  6.11711685e+01  6.11711685e+01  6.11711685e+01  9.38403367e+01
  3.56156096e+02  1.34951893e+03  5.83596866e+03  3.50985967e+04]
E1 = -181.99569053283605  E_coul = 53.484609686476496
cycle= 1 E= -128.51108084636  delta_E= -0.0301  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.499739
diis-c [-0.24973884  1.        ]
  HOMO = -0.883843566913414  LUMO = 0.815806797361366
  mo_energy =
[-3.28947012e+01 -1.96990456e+00 -8.83843567e-01 -8.83843567e-01
 -8.83843567e-01  8.15806797e-01  8.15806797e-01  8.15806797e-01
  1.98038067e+00  3.98506118e+00  3.98506118e+00  3.98506118e+00
  1.48813901e+01  1.48813901e+01  1.48813901e+01  1.91948600e+01
  6.08641452e+01  6.08641452e+01  6.08641452e+01  9.35212152e+01
  3.55787145e+02  1.34911121e+03  5.83552903e+03  3.50981355e+04]
E1 = -182.78874109889813  E_coul = 54.2748127776386
cycle= 2 E= -128.51392832126  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.0783
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25384
diis-c [-5.58956247e-04  3.36123647e-01  6.63876353e-01]
  HOMO = -0.846750106135417  LUMO = 0.825193616543523
  mo_energy =
[-3.27821898e+01 -1.93074614e+00 -8.46750106e-01 -8.46750106e-01
 -8.46750106e-01  8.25193617e-01  8.25193617e-01  8.25193617e-01
  2.00672879e+00  4.01912081e+00  4.01912081e+00  4.01912081e+00
  1.49494628e+01  1.49494628e+01  1.49494628e+01  1.92722375e+01
  6.09662258e+01  6.09662258e+01  6.09662258e+01  9.36274300e+01
  3.55906749e+02  1.34923736e+03  5.83565831e+03  3.50982659e+04]
E1 = -182.52218761841522  E_coul = 54.0072674504763
cycle= 3 E= -128.514920167939  delta_E= -0.000992  |g|= 0.000183  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000267273
diis-c [-3.52280421e-08 -1.56241694e-03 -2.42866347e-03  1.00399108e+00]
  HOMO = -0.846854455770109  LUMO = 0.82520163377583
  mo_energy =
[-3.27823417e+01 -1.93083645e+00 -8.46854456e-01 -8.46854456e-01
 -8.46854456e-01  8.25201634e-01  8.25201634e-01  8.25201634e-01
  2.00669976e+00  4.01908335e+00  4.01908335e+00  4.01908335e+00
  1.49493787e+01  1.49493787e+01  1.49493787e+01  1.92721467e+01
  6.09660938e+01  6.09660938e+01  6.09660938e+01  9.36272956e+01
  3.55906565e+02  1.34923711e+03  5.83565800e+03  3.50982656e+04]
E1 = -182.52202967951538  E_coul = 54.00710950725339
cycle= 4 E= -128.514920172262  delta_E= -4.32e-09  |g|= 4.33e-05  |ddm|= 0.000112
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.24631e-05
diis-c [-3.22962671e-10  1.21815465e-05  3.14259605e-04 -7.14781989e-02
  1.07115176e+00]
  HOMO = -0.846876554755807  LUMO = 0.825194149075537
  mo_energy =
[-3.27823805e+01 -1.93086196e+00 -8.46876555e-01 -8.46876555e-01
 -8.46876555e-01  8.25194149e-01  8.25194149e-01  8.25194149e-01
  2.00667904e+00  4.01906088e+00  4.01906088e+00  4.01906088e+00
  1.49493453e+01  1.49493453e+01  1.49493453e+01  1.92721110e+01
  6.09660558e+01  6.09660558e+01  6.09660558e+01  9.36272575e+01
  3.55906528e+02  1.34923708e+03  5.83565796e+03  3.50982656e+04]
E1 = -182.5221018400667  E_coul = 54.00718166764294
cycle= 5 E= -128.514920172424  delta_E= -1.62e-10  |g|= 2.23e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5221018400667  E_coul = 54.00718166764294
  HOMO = -0.846876150288373  LUMO = 0.825194152277562
  mo_energy =
[-3.27823788e+01 -1.93086197e+00 -8.46876150e-01 -8.46876150e-01
 -8.46876150e-01  8.25194152e-01  8.25194152e-01  8.25194152e-01
  2.00667886e+00  4.01906112e+00  4.01906112e+00  4.01906112e+00
  1.49493462e+01  1.49493462e+01  1.49493462e+01  1.92721120e+01
  6.09660572e+01  6.09660572e+01  6.09660572e+01  9.36272590e+01
  3.55906530e+02  1.34923708e+03  5.83565796e+03  3.50982656e+04]
E1 = -182.5220954528734  E_coul = 54.00717528044854
Extra cycle  E= -128.514920172425  delta_E= -1.08e-12  |g|= 9.42e-07  |ddm|= 1.47e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907015e+02
 2.04814449e+01 5.69551459e+01 4.87599691e-01 7.82081897e+00
 1.65353884e+00 2.52608229e+00 7.49057778e+00 2.83763756e+01
 2.70255567e-01 8.54356948e-01]
E = -128.51492017242487
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682405        1
[INPUT] 0    0    [1    /1   ]  617.498482808        1
[INPUT] 0    0    [1    /1   ]  174.907014957        1
[INPUT] 0    0    [1    /1   ]  20.4814449473        1
[INPUT] 0    0    [1    /1   ]  56.955145891         1
[INPUT] 0    0    [1    /1   ]  0.487599691256       1
[INPUT] 0    0    [1    /1   ]  7.82081897479        1
[INPUT] 0    0    [1    /1   ]  1.65353884452        1
[INPUT] 1    0    [1    /1   ]  2.52608229231        1
[INPUT] 1    0    [1    /1   ]  7.49057777805        1
[INPUT] 1    0    [1    /1   ]  28.3763756081        1
[INPUT] 1    0    [1    /1   ]  0.270255567322       1
[INPUT] 1    0    [1    /1   ]  0.854356947659       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002541, 1.0]], [0, [2712.0968240540474, 1.0]], [0, [617.4984828076995, 1.0]], [0, [174.90701495699852, 1.0]], [0, [20.481444947330118, 1.0]], [0, [56.95514589100762, 1.0]], [0, [0.4875996912558423, 1.0]], [0, [7.820818974788833, 1.0]], [0, [1.653538844521264, 1.0]], [1, [2.5260822923137205, 1.0]], [1, [7.490577778051238, 1.0]], [1, [28.376375608119147, 1.0]], [1, [0.2702555673224978, 1.0]], [1, [0.8543569476590711, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682405]
bas 2, expnt(s) = [617.49848281]
bas 3, expnt(s) = [174.90701496]
bas 4, expnt(s) = [20.48144495]
bas 5, expnt(s) = [56.95514589]
bas 6, expnt(s) = [0.48759969]
bas 7, expnt(s) = [7.82081897]
bas 8, expnt(s) = [1.65353884]
bas 9, expnt(s) = [2.52608229]
bas 10, expnt(s) = [7.49057778]
bas 11, expnt(s) = [28.37637561]
bas 12, expnt(s) = [0.27025557]
bas 13, expnt(s) = [0.85435695]
CPU time:        57.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907015e+02 1.21512357e+02
 2.04814449e+01 2.43240265e+01 5.69551459e+01 5.23799103e+01
 4.87599691e-01 1.47422099e+00 7.82081897e+00 1.18155570e+01
 1.65353884e+00 3.68405263e+00 2.52608229e+00 9.29059997e+00
 7.49057778e+00 3.61516846e+01 2.83763756e+01 1.91064740e+02
 2.70255567e-01 5.68463656e-01 8.54356948e-01 2.39625806e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999058155863736
cond(S) = 239.3749996270896
E1 = -183.55876189424683  E_coul = 55.07773320390816
init E= -128.481028690339
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771754088509618  LUMO = 0.843957060411558
  mo_energy =
[-3.25555738e+01 -1.85141424e+00 -7.71754089e-01 -7.71754089e-01
 -7.71754089e-01  8.43957060e-01  8.43957060e-01  8.43957060e-01
  2.06073001e+00  4.08870108e+00  4.08870108e+00  4.08870108e+00
  1.50860021e+01  1.50860021e+01  1.50860021e+01  1.94268248e+01
  6.11711685e+01  6.11711685e+01  6.11711685e+01  9.38403367e+01
  3.56156096e+02  1.34951893e+03  5.83596866e+03  3.50985967e+04]
E1 = -181.99569053283605  E_coul = 53.484609686476496
cycle= 1 E= -128.51108084636  delta_E= -0.0301  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.499739
diis-c [-0.24973884  1.        ]
  HOMO = -0.883843566913414  LUMO = 0.815806797361366
  mo_energy =
[-3.28947012e+01 -1.96990456e+00 -8.83843567e-01 -8.83843567e-01
 -8.83843567e-01  8.15806797e-01  8.15806797e-01  8.15806797e-01
  1.98038067e+00  3.98506118e+00  3.98506118e+00  3.98506118e+00
  1.48813901e+01  1.48813901e+01  1.48813901e+01  1.91948600e+01
  6.08641452e+01  6.08641452e+01  6.08641452e+01  9.35212152e+01
  3.55787145e+02  1.34911121e+03  5.83552903e+03  3.50981355e+04]
E1 = -182.78874109889813  E_coul = 54.2748127776386
cycle= 2 E= -128.51392832126  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.0783
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25384
diis-c [-5.58956247e-04  3.36123647e-01  6.63876353e-01]
  HOMO = -0.846750106135417  LUMO = 0.825193616543523
  mo_energy =
[-3.27821898e+01 -1.93074614e+00 -8.46750106e-01 -8.46750106e-01
 -8.46750106e-01  8.25193617e-01  8.25193617e-01  8.25193617e-01
  2.00672879e+00  4.01912081e+00  4.01912081e+00  4.01912081e+00
  1.49494628e+01  1.49494628e+01  1.49494628e+01  1.92722375e+01
  6.09662258e+01  6.09662258e+01  6.09662258e+01  9.36274300e+01
  3.55906749e+02  1.34923736e+03  5.83565831e+03  3.50982659e+04]
E1 = -182.52218761841522  E_coul = 54.0072674504763
cycle= 3 E= -128.514920167939  delta_E= -0.000992  |g|= 0.000183  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000267273
diis-c [-3.52280421e-08 -1.56241694e-03 -2.42866347e-03  1.00399108e+00]
  HOMO = -0.846854455770109  LUMO = 0.82520163377583
  mo_energy =
[-3.27823417e+01 -1.93083645e+00 -8.46854456e-01 -8.46854456e-01
 -8.46854456e-01  8.25201634e-01  8.25201634e-01  8.25201634e-01
  2.00669976e+00  4.01908335e+00  4.01908335e+00  4.01908335e+00
  1.49493787e+01  1.49493787e+01  1.49493787e+01  1.92721467e+01
  6.09660938e+01  6.09660938e+01  6.09660938e+01  9.36272956e+01
  3.55906565e+02  1.34923711e+03  5.83565800e+03  3.50982656e+04]
E1 = -182.52202967951538  E_coul = 54.00710950725339
cycle= 4 E= -128.514920172262  delta_E= -4.32e-09  |g|= 4.33e-05  |ddm|= 0.000112
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.24631e-05
diis-c [-3.22962671e-10  1.21815465e-05  3.14259605e-04 -7.14781989e-02
  1.07115176e+00]
  HOMO = -0.846876554755807  LUMO = 0.825194149075537
  mo_energy =
[-3.27823805e+01 -1.93086196e+00 -8.46876555e-01 -8.46876555e-01
 -8.46876555e-01  8.25194149e-01  8.25194149e-01  8.25194149e-01
  2.00667904e+00  4.01906088e+00  4.01906088e+00  4.01906088e+00
  1.49493453e+01  1.49493453e+01  1.49493453e+01  1.92721110e+01
  6.09660558e+01  6.09660558e+01  6.09660558e+01  9.36272575e+01
  3.55906528e+02  1.34923708e+03  5.83565796e+03  3.50982656e+04]
E1 = -182.5221018400667  E_coul = 54.00718166764294
cycle= 5 E= -128.514920172424  delta_E= -1.62e-10  |g|= 2.23e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5221018400667  E_coul = 54.00718166764294
  HOMO = -0.846876150288373  LUMO = 0.825194152277562
  mo_energy =
[-3.27823788e+01 -1.93086197e+00 -8.46876150e-01 -8.46876150e-01
 -8.46876150e-01  8.25194152e-01  8.25194152e-01  8.25194152e-01
  2.00667886e+00  4.01906112e+00  4.01906112e+00  4.01906112e+00
  1.49493462e+01  1.49493462e+01  1.49493462e+01  1.92721120e+01
  6.09660572e+01  6.09660572e+01  6.09660572e+01  9.36272590e+01
  3.55906530e+02  1.34923708e+03  5.83565796e+03  3.50982656e+04]
E1 = -182.5220954528734  E_coul = 54.00717528044854
Extra cycle  E= -128.514920172425  delta_E= -1.08e-12  |g|= 9.42e-07  |ddm|= 1.47e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.3749996270896
E1 = -182.5220954528734  E_coul = 54.00717528044854
init E= -128.514920172425
    CPU time for initialize scf      0.22 sec, wall time      0.24 sec
  HOMO = -0.846876603672151  LUMO = 0.825194021070796
  mo_energy =
[-3.27823801e+01 -1.93086255e+00 -8.46876604e-01 -8.46876604e-01
 -8.46876604e-01  8.25194021e-01  8.25194021e-01  8.25194021e-01
  2.00667844e+00  4.01906069e+00  4.01906069e+00  4.01906069e+00
  1.49493454e+01  1.49493454e+01  1.49493454e+01  1.92721110e+01
  6.09660561e+01  6.09660561e+01  6.09660561e+01  9.36272579e+01
  3.55906529e+02  1.34923708e+03  5.83565796e+03  3.50982656e+04]
E1 = -182.52209816282564  E_coul = 54.00717799040094
cycle= 1 E= -128.514920172425  delta_E= 1.71e-13  |g|= 3.76e-07  |ddm|= 4.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52209816282564  E_coul = 54.00717799040094
  HOMO = -0.846876411598524  LUMO = 0.825194067031142
  mo_energy =
[-3.27823795e+01 -1.93086236e+00 -8.46876412e-01 -8.46876412e-01
 -8.46876412e-01  8.25194067e-01  8.25194067e-01  8.25194067e-01
  2.00667856e+00  4.01906086e+00  4.01906086e+00  4.01906086e+00
  1.49493457e+01  1.49493457e+01  1.49493457e+01  1.92721114e+01
  6.09660566e+01  6.09660566e+01  6.09660566e+01  9.36272584e+01
  3.55906529e+02  1.34923708e+03  5.83565796e+03  3.50982656e+04]
E1 = -182.52209669080656  E_coul = 54.00717651838154
Extra cycle  E= -128.514920172425  delta_E= -3.41e-13  |g|= 2.01e-07  |ddm|= 1.37e-07
    CPU time for scf_cycle      0.28 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907015e+02
 2.04814449e+01 5.69551459e+01 4.87599691e-01 7.82081897e+00
 1.65353884e+00 2.52608229e+00 7.49057778e+00 2.83763756e+01
 2.70255567e-01 8.54356948e-01]
grad_E = [ 3.98472652e-12  4.36174592e-12 -2.60499064e-10 -3.29221447e-09
  1.63680929e-08  3.57983319e-08  8.52252911e-05 -1.72597695e-06
 -1.92616573e-04  3.53426630e-03 -1.10179026e-03 -1.63805155e-03
  1.55670451e-03 -4.08648577e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482743        1
[INPUT] 0    0    [1    /1   ]  174.907015863        1
[INPUT] 0    0    [1    /1   ]  20.4814869237        1
[INPUT] 0    0    [1    /1   ]  56.9551400162        1
[INPUT] 0    0    [1    /1   ]  0.487450840535       1
[INPUT] 0    0    [1    /1   ]  7.82078203587        1
[INPUT] 0    0    [1    /1   ]  1.65286809745        1
[INPUT] 1    0    [1    /1   ]  2.50460408892        1
[INPUT] 1    0    [1    /1   ]  7.50981809574        1
[INPUT] 1    0    [1    /1   ]  28.3838755355        1
[INPUT] 1    0    [1    /1   ]  0.267097696231       1
[INPUT] 1    0    [1    /1   ]  0.84253983975        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002532, 1.0]], [0, [2712.096824057628, 1.0]], [0, [617.4984827434713, 1.0]], [0, [174.90701586260872, 1.0]], [0, [20.481486923663706, 1.0]], [0, [56.955140016225634, 1.0]], [0, [0.4874508405350381, 1.0]], [0, [7.82078203586716, 1.0]], [0, [1.652868097447904, 1.0]], [1, [2.5046040889223216, 1.0]], [1, [7.509818095741264, 1.0]], [1, [28.38387553554751, 1.0]], [1, [0.26709769623103685, 1.0]], [1, [0.842539839749693, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848274]
bas 3, expnt(s) = [174.90701586]
bas 4, expnt(s) = [20.48148692]
bas 5, expnt(s) = [56.95514002]
bas 6, expnt(s) = [0.48745084]
bas 7, expnt(s) = [7.82078204]
bas 8, expnt(s) = [1.6528681]
bas 9, expnt(s) = [2.50460409]
bas 10, expnt(s) = [7.5098181]
bas 11, expnt(s) = [28.38387554]
bas 12, expnt(s) = [0.2670977]
bas 13, expnt(s) = [0.84253984]
CPU time:        60.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512358e+02
 2.04814869e+01 2.43240639e+01 5.69551400e+01 5.23799063e+01
 4.87450841e-01 1.47388345e+00 7.82078204e+00 1.18155151e+01
 1.65286810e+00 3.68293176e+00 2.50460409e+00 9.19196261e+00
 7.50981810e+00 3.62677960e+01 2.83838755e+01 1.91127866e+02
 2.67097696e-01 5.60172868e-01 8.42539840e-01 2.35489989e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999085084191004
cond(S) = 239.33341259414536
E1 = -183.5588044151232  E_coul = 55.07768748106082
init E= -128.481116934062
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771771206071809  LUMO = 0.831727133837609
  mo_energy =
[-3.25555624e+01 -1.85142566e+00 -7.71771206e-01 -7.71771206e-01
 -7.71771206e-01  8.31727134e-01  8.31727134e-01  8.31727134e-01
  2.05961743e+00  4.03328707e+00  4.03328707e+00  4.03328707e+00
  1.49928548e+01  1.49928548e+01  1.49928548e+01  1.94233617e+01
  6.11265107e+01  6.11265107e+01  6.11265107e+01  9.38369777e+01
  3.56153071e+02  1.34951620e+03  5.83596624e+03  3.50985946e+04]
E1 = -181.99335662926555  E_coul = 53.48224705066366
cycle= 1 E= -128.511109578602  delta_E= -0.03  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.500141
diis-c [-0.25014132  1.        ]
  HOMO = -0.884045680580399  LUMO = 0.804023403492219
  mo_energy =
[-3.28950822e+01 -1.97012253e+00 -8.84045681e-01 -8.84045681e-01
 -8.84045681e-01  8.04023403e-01  8.04023403e-01  8.04023403e-01
  1.97913913e+00  3.93028078e+00  3.93028078e+00  3.93028078e+00
  1.47878267e+01  1.47878267e+01  1.47878267e+01  1.91910786e+01
  6.08189592e+01  6.08189592e+01  6.08189592e+01  9.35174684e+01
  3.55783784e+02  1.34910818e+03  5.83552633e+03  3.50981332e+04]
E1 = -182.7881072658587  E_coul = 54.27414262368123
cycle= 2 E= -128.513964642177  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0784
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254192
diis-c [-5.62897488e-04  3.36250645e-01  6.63749355e-01]
  HOMO = -0.846875250632399  LUMO = 0.813259941246835
  mo_energy =
[-3.27823715e+01 -1.93088041e+00 -8.46875251e-01 -8.46875251e-01
 -8.46875251e-01  8.13259941e-01  8.13259941e-01  8.13259941e-01
  2.00553688e+00  3.96414157e+00  3.96414157e+00  3.96414157e+00
  1.48560637e+01  1.48560637e+01  1.48560637e+01  1.92686016e+01
  6.09212664e+01  6.09212664e+01  6.09212664e+01  9.36238731e+01
  3.55903594e+02  1.34923454e+03  5.83565582e+03  3.50982639e+04]
E1 = -182.52085563057864  E_coul = 54.00589488508225
cycle= 3 E= -128.514960745496  delta_E= -0.000996  |g|= 0.000189  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000272859
diis-c [-3.72928415e-08 -1.56768948e-03 -2.42785931e-03  1.00399555e+00]
  HOMO = -0.846981500876123  LUMO = 0.813267045634069
  mo_energy =
[-3.27825288e+01 -1.93097342e+00 -8.46981501e-01 -8.46981501e-01
 -8.46981501e-01  8.13267046e-01  8.13267046e-01  8.13267046e-01
  2.00550555e+00  3.96410257e+00  3.96410257e+00  3.96410257e+00
  1.48559766e+01  1.48559766e+01  1.48559766e+01  1.92685079e+01
  6.09211295e+01  6.09211295e+01  6.09211295e+01  9.36237338e+01
  3.55903403e+02  1.34923429e+03  5.83565549e+03  3.50982635e+04]
E1 = -182.52069391084896  E_coul = 54.00573316056589
cycle= 4 E= -128.514960750283  delta_E= -4.79e-09  |g|= 4.45e-05  |ddm|= 0.000118
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.3179e-05
diis-c [-3.52533466e-10  1.67247872e-05  3.22229644e-04 -7.57356774e-02
  1.07539672e+00]
  HOMO = -0.84700425070687  LUMO = 0.81325939464559
  mo_energy =
[-3.27825685e+01 -1.93099988e+00 -8.47004251e-01 -8.47004251e-01
 -8.47004251e-01  8.13259395e-01  8.13259395e-01  8.13259395e-01
  2.00548400e+00  3.96407950e+00  3.96407950e+00  3.96407950e+00
  1.48559424e+01  1.48559424e+01  1.48559424e+01  1.92684713e+01
  6.09210905e+01  6.09210905e+01  6.09210905e+01  9.36236948e+01
  3.55903366e+02  1.34923425e+03  5.83565546e+03  3.50982635e+04]
E1 = -182.5207663087946  E_coul = 54.005805558336526
cycle= 5 E= -128.514960750458  delta_E= -1.75e-10  |g|= 2.41e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5207663087946  E_coul = 54.005805558336526
  HOMO = -0.847003750728125  LUMO = 0.8132594170995
  mo_energy =
[-3.27825665e+01 -1.93099982e+00 -8.47003751e-01 -8.47003751e-01
 -8.47003751e-01  8.13259417e-01  8.13259417e-01  8.13259417e-01
  2.00548386e+00  3.96407983e+00  3.96407983e+00  3.96407983e+00
  1.48559434e+01  1.48559434e+01  1.48559434e+01  1.92684724e+01
  6.09210923e+01  6.09210923e+01  6.09210923e+01  9.36236966e+01
  3.55903368e+02  1.34923425e+03  5.83565546e+03  3.50982635e+04]
E1 = -182.5207591714222  E_coul = 54.005798420963245
Extra cycle  E= -128.514960750459  delta_E= -8.81e-13  |g|= 1.05e-06  |ddm|= 1.57e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04814869e+01 5.69551400e+01 4.87450841e-01 7.82078204e+00
 1.65286810e+00 2.50460409e+00 7.50981810e+00 2.83838755e+01
 2.67097696e-01 8.42539840e-01]
E = -128.51496075045895
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:38:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482743        1
[INPUT] 0    0    [1    /1   ]  174.907015863        1
[INPUT] 0    0    [1    /1   ]  20.4814869237        1
[INPUT] 0    0    [1    /1   ]  56.9551400162        1
[INPUT] 0    0    [1    /1   ]  0.487450840535       1
[INPUT] 0    0    [1    /1   ]  7.82078203587        1
[INPUT] 0    0    [1    /1   ]  1.65286809745        1
[INPUT] 1    0    [1    /1   ]  2.50460408892        1
[INPUT] 1    0    [1    /1   ]  7.50981809574        1
[INPUT] 1    0    [1    /1   ]  28.3838755355        1
[INPUT] 1    0    [1    /1   ]  0.267097696231       1
[INPUT] 1    0    [1    /1   ]  0.84253983975        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002532, 1.0]], [0, [2712.096824057628, 1.0]], [0, [617.4984827434713, 1.0]], [0, [174.90701586260872, 1.0]], [0, [20.481486923663706, 1.0]], [0, [56.955140016225634, 1.0]], [0, [0.4874508405350381, 1.0]], [0, [7.82078203586716, 1.0]], [0, [1.652868097447904, 1.0]], [1, [2.5046040889223216, 1.0]], [1, [7.509818095741264, 1.0]], [1, [28.38387553554751, 1.0]], [1, [0.26709769623103685, 1.0]], [1, [0.842539839749693, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848274]
bas 3, expnt(s) = [174.90701586]
bas 4, expnt(s) = [20.48148692]
bas 5, expnt(s) = [56.95514002]
bas 6, expnt(s) = [0.48745084]
bas 7, expnt(s) = [7.82078204]
bas 8, expnt(s) = [1.6528681]
bas 9, expnt(s) = [2.50460409]
bas 10, expnt(s) = [7.5098181]
bas 11, expnt(s) = [28.38387554]
bas 12, expnt(s) = [0.2670977]
bas 13, expnt(s) = [0.84253984]
CPU time:        60.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512358e+02
 2.04814869e+01 2.43240639e+01 5.69551400e+01 5.23799063e+01
 4.87450841e-01 1.47388345e+00 7.82078204e+00 1.18155151e+01
 1.65286810e+00 3.68293176e+00 2.50460409e+00 9.19196261e+00
 7.50981810e+00 3.62677960e+01 2.83838755e+01 1.91127866e+02
 2.67097696e-01 5.60172868e-01 8.42539840e-01 2.35489989e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999085084191004
cond(S) = 239.33341259414536
E1 = -183.5588044151232  E_coul = 55.07768748106082
init E= -128.481116934062
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771771206071809  LUMO = 0.831727133837609
  mo_energy =
[-3.25555624e+01 -1.85142566e+00 -7.71771206e-01 -7.71771206e-01
 -7.71771206e-01  8.31727134e-01  8.31727134e-01  8.31727134e-01
  2.05961743e+00  4.03328707e+00  4.03328707e+00  4.03328707e+00
  1.49928548e+01  1.49928548e+01  1.49928548e+01  1.94233617e+01
  6.11265107e+01  6.11265107e+01  6.11265107e+01  9.38369777e+01
  3.56153071e+02  1.34951620e+03  5.83596624e+03  3.50985946e+04]
E1 = -181.99335662926555  E_coul = 53.48224705066366
cycle= 1 E= -128.511109578602  delta_E= -0.03  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.500141
diis-c [-0.25014132  1.        ]
  HOMO = -0.884045680580399  LUMO = 0.804023403492219
  mo_energy =
[-3.28950822e+01 -1.97012253e+00 -8.84045681e-01 -8.84045681e-01
 -8.84045681e-01  8.04023403e-01  8.04023403e-01  8.04023403e-01
  1.97913913e+00  3.93028078e+00  3.93028078e+00  3.93028078e+00
  1.47878267e+01  1.47878267e+01  1.47878267e+01  1.91910786e+01
  6.08189592e+01  6.08189592e+01  6.08189592e+01  9.35174684e+01
  3.55783784e+02  1.34910818e+03  5.83552633e+03  3.50981332e+04]
E1 = -182.7881072658587  E_coul = 54.27414262368123
cycle= 2 E= -128.513964642177  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0784
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.254192
diis-c [-5.62897488e-04  3.36250645e-01  6.63749355e-01]
  HOMO = -0.846875250632399  LUMO = 0.813259941246835
  mo_energy =
[-3.27823715e+01 -1.93088041e+00 -8.46875251e-01 -8.46875251e-01
 -8.46875251e-01  8.13259941e-01  8.13259941e-01  8.13259941e-01
  2.00553688e+00  3.96414157e+00  3.96414157e+00  3.96414157e+00
  1.48560637e+01  1.48560637e+01  1.48560637e+01  1.92686016e+01
  6.09212664e+01  6.09212664e+01  6.09212664e+01  9.36238731e+01
  3.55903594e+02  1.34923454e+03  5.83565582e+03  3.50982639e+04]
E1 = -182.52085563057864  E_coul = 54.00589488508225
cycle= 3 E= -128.514960745496  delta_E= -0.000996  |g|= 0.000189  |ddm|= 0.0267
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000272859
diis-c [-3.72928415e-08 -1.56768948e-03 -2.42785931e-03  1.00399555e+00]
  HOMO = -0.846981500876123  LUMO = 0.813267045634069
  mo_energy =
[-3.27825288e+01 -1.93097342e+00 -8.46981501e-01 -8.46981501e-01
 -8.46981501e-01  8.13267046e-01  8.13267046e-01  8.13267046e-01
  2.00550555e+00  3.96410257e+00  3.96410257e+00  3.96410257e+00
  1.48559766e+01  1.48559766e+01  1.48559766e+01  1.92685079e+01
  6.09211295e+01  6.09211295e+01  6.09211295e+01  9.36237338e+01
  3.55903403e+02  1.34923429e+03  5.83565549e+03  3.50982635e+04]
E1 = -182.52069391084896  E_coul = 54.00573316056589
cycle= 4 E= -128.514960750283  delta_E= -4.79e-09  |g|= 4.45e-05  |ddm|= 0.000118
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=8.3179e-05
diis-c [-3.52533466e-10  1.67247872e-05  3.22229644e-04 -7.57356774e-02
  1.07539672e+00]
  HOMO = -0.84700425070687  LUMO = 0.81325939464559
  mo_energy =
[-3.27825685e+01 -1.93099988e+00 -8.47004251e-01 -8.47004251e-01
 -8.47004251e-01  8.13259395e-01  8.13259395e-01  8.13259395e-01
  2.00548400e+00  3.96407950e+00  3.96407950e+00  3.96407950e+00
  1.48559424e+01  1.48559424e+01  1.48559424e+01  1.92684713e+01
  6.09210905e+01  6.09210905e+01  6.09210905e+01  9.36236948e+01
  3.55903366e+02  1.34923425e+03  5.83565546e+03  3.50982635e+04]
E1 = -182.5207663087946  E_coul = 54.005805558336526
cycle= 5 E= -128.514960750458  delta_E= -1.75e-10  |g|= 2.41e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5207663087946  E_coul = 54.005805558336526
  HOMO = -0.847003750728125  LUMO = 0.8132594170995
  mo_energy =
[-3.27825665e+01 -1.93099982e+00 -8.47003751e-01 -8.47003751e-01
 -8.47003751e-01  8.13259417e-01  8.13259417e-01  8.13259417e-01
  2.00548386e+00  3.96407983e+00  3.96407983e+00  3.96407983e+00
  1.48559434e+01  1.48559434e+01  1.48559434e+01  1.92684724e+01
  6.09210923e+01  6.09210923e+01  6.09210923e+01  9.36236966e+01
  3.55903368e+02  1.34923425e+03  5.83565546e+03  3.50982635e+04]
E1 = -182.5207591714222  E_coul = 54.005798420963245
Extra cycle  E= -128.514960750459  delta_E= -8.81e-13  |g|= 1.05e-06  |ddm|= 1.57e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.16 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.33341259414536
E1 = -182.5207591714222  E_coul = 54.005798420963245
init E= -128.514960750459
    CPU time for initialize scf      0.21 sec, wall time      0.22 sec
  HOMO = -0.847004256469461  LUMO = 0.8132592741424
  mo_energy =
[-3.27825679e+01 -1.93100046e+00 -8.47004256e-01 -8.47004256e-01
 -8.47004256e-01  8.13259274e-01  8.13259274e-01  8.13259274e-01
  2.00548339e+00  3.96407934e+00  3.96407934e+00  3.96407934e+00
  1.48559425e+01  1.48559425e+01  1.48559425e+01  1.92684714e+01
  6.09210910e+01  6.09210910e+01  6.09210910e+01  9.36236952e+01
  3.55903366e+02  1.34923425e+03  5.83565546e+03  3.50982635e+04]
E1 = -182.52076223613548  E_coul = 54.0058014856764
cycle= 1 E= -128.514960750459  delta_E= -1.14e-13  |g|= 4.24e-07  |ddm|= 5.03e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52076223613548  E_coul = 54.0058014856764
  HOMO = -0.84700403921509  LUMO = 0.81325932532644
  mo_energy =
[-3.27825673e+01 -1.93100026e+00 -8.47004039e-01 -8.47004039e-01
 -8.47004039e-01  8.13259325e-01  8.13259325e-01  8.13259325e-01
  2.00548353e+00  3.96407954e+00  3.96407954e+00  3.96407954e+00
  1.48559429e+01  1.48559429e+01  1.48559429e+01  1.92684718e+01
  6.09210916e+01  6.09210916e+01  6.09210916e+01  9.36236959e+01
  3.55903367e+02  1.34923425e+03  5.83565546e+03  3.50982635e+04]
E1 = -182.5207605758651  E_coul = 54.005799825405866
Extra cycle  E= -128.514960750459  delta_E= -1.71e-13  |g|= 2.26e-07  |ddm|= 1.54e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04814869e+01 5.69551400e+01 4.87450841e-01 7.82078204e+00
 1.65286810e+00 2.50460409e+00 7.50981810e+00 2.83838755e+01
 2.67097696e-01 8.42539840e-01]
grad_E = [ 1.08082882e-12  1.61448895e-10 -3.24844941e-09  3.38785484e-08
  1.39772981e-06 -2.11295631e-07  1.39466349e-04 -3.30684339e-06
 -2.42299575e-04  1.50625238e-03 -1.69006024e-04 -1.73555038e-03
  4.18744884e-04 -2.98844809e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482748        1
[INPUT] 0    0    [1    /1   ]  174.9070158          1
[INPUT] 0    0    [1    /1   ]  20.4814841432        1
[INPUT] 0    0    [1    /1   ]  56.9551403069        1
[INPUT] 0    0    [1    /1   ]  0.487509384919       1
[INPUT] 0    0    [1    /1   ]  7.82078250763        1
[INPUT] 0    0    [1    /1   ]  1.6532951456         1
[INPUT] 1    0    [1    /1   ]  2.49213136695        1
[INPUT] 1    0    [1    /1   ]  7.50176228802        1
[INPUT] 1    0    [1    /1   ]  28.386085454         1
[INPUT] 1    0    [1    /1   ]  0.266674378701       1
[INPUT] 1    0    [1    /1   ]  0.839312883282       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025323, 1.0]], [0, [2712.096824057359, 1.0]], [0, [617.4984827481527, 1.0]], [0, [174.9070157997586, 1.0]], [0, [20.481484143155416, 1.0]], [0, [56.9551403069497, 1.0]], [0, [0.4875093849188836, 1.0]], [0, [7.820782507632043, 1.0]], [0, [1.653295145599597, 1.0]], [1, [2.4921313669543457, 1.0]], [1, [7.501762288017806, 1.0]], [1, [28.386085453978268, 1.0]], [1, [0.2666743787013972, 1.0]], [1, [0.8393128832820373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848275]
bas 3, expnt(s) = [174.9070158]
bas 4, expnt(s) = [20.48148414]
bas 5, expnt(s) = [56.95514031]
bas 6, expnt(s) = [0.48750938]
bas 7, expnt(s) = [7.82078251]
bas 8, expnt(s) = [1.65329515]
bas 9, expnt(s) = [2.49213137]
bas 10, expnt(s) = [7.50176229]
bas 11, expnt(s) = [28.38608545]
bas 12, expnt(s) = [0.26667438]
bas 13, expnt(s) = [0.83931288]
CPU time:        63.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512357e+02
 2.04814841e+01 2.43240615e+01 5.69551403e+01 5.23799065e+01
 4.87509385e-01 1.47401621e+00 7.82078251e+00 1.18155157e+01
 1.65329515e+00 3.68364540e+00 2.49213137e+00 9.13477925e+00
 7.50176229e+00 3.62191718e+01 2.83860855e+01 1.91146467e+02
 2.66674379e-01 5.59063331e-01 8.39312883e-01 2.34363111e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999090077716922
cond(S) = 239.35682700901543
E1 = -183.55884904076592  E_coul = 55.07769852488234
init E= -128.481150515884
    CPU time for initialize scf      0.04 sec, wall time      0.05 sec
  HOMO = -0.771773627597909  LUMO = 0.82959760213077
  mo_energy =
[-3.25555526e+01 -1.85142709e+00 -7.71773628e-01 -7.71773628e-01
 -7.71773628e-01  8.29597602e-01  8.29597602e-01  8.29597602e-01
  2.06020846e+00  4.01619485e+00  4.01619485e+00  4.01619485e+00
  1.49387215e+01  1.49387215e+01  1.49387215e+01  1.94253208e+01
  6.10533576e+01  6.10533576e+01  6.10533576e+01  9.38389544e+01
  3.56154822e+02  1.34951774e+03  5.83596758e+03  3.50985957e+04]
E1 = -181.9931623153054  E_coul = 53.482045824082455
cycle= 1 E= -128.511116491223  delta_E= -0.03  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.500147
diis-c [-0.25014746  1.        ]
  HOMO = -0.884062527900835  LUMO = 0.801994747504977
  mo_energy =
[-3.28951190e+01 -1.97014006e+00 -8.84062528e-01 -8.84062528e-01
 -8.84062528e-01  8.01994748e-01  8.01994748e-01  8.01994748e-01
  1.97969677e+00  3.91354578e+00  3.91354578e+00  3.91354578e+00
  1.47338440e+01  1.47338440e+01  1.47338440e+01  1.91930089e+01
  6.07457242e+01  6.07457242e+01  6.07457242e+01  9.35194008e+01
  3.55785511e+02  1.34910971e+03  5.83552767e+03  3.50981343e+04]
E1 = -182.7880465863481  E_coul = 54.2740743319636
cycle= 2 E= -128.513972254384  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0783
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254204
diis-c [-5.64204325e-04  3.36256330e-01  6.63743670e-01]
  HOMO = -0.84688570700047  LUMO = 0.811195087950878
  mo_energy =
[-3.27823925e+01 -1.93089086e+00 -8.46885707e-01 -8.46885707e-01
 -8.46885707e-01  8.11195088e-01  8.11195088e-01  8.11195088e-01
  2.00610517e+00  3.94728785e+00  3.94728785e+00  3.94728785e+00
  1.48020300e+01  1.48020300e+01  1.48020300e+01  1.92705443e+01
  6.08480557e+01  6.08480557e+01  6.08480557e+01  9.36258205e+01
  3.55905337e+02  1.34923609e+03  5.83565717e+03  3.50982650e+04]
E1 = -182.52072588600504  E_coul = 54.00575718964486
cycle= 3 E= -128.51496869636  delta_E= -0.000996  |g|= 0.000193  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000276362
diis-c [-3.83658185e-08 -1.57415409e-03 -2.43134770e-03  1.00400550e+00]
  HOMO = -0.846993390957153  LUMO = 0.811201433643072
  mo_energy =
[-3.27825525e+01 -1.93098563e+00 -8.46993391e-01 -8.46993391e-01
 -8.46993391e-01  8.11201434e-01  8.11201434e-01  8.11201434e-01
  2.00607218e+00  3.94724741e+00  3.94724741e+00  3.94724741e+00
  1.48019410e+01  1.48019410e+01  1.48019410e+01  1.92704487e+01
  6.08479162e+01  6.08479162e+01  6.08479162e+01  9.36256785e+01
  3.55905143e+02  1.34923583e+03  5.83565684e+03  3.50982646e+04]
E1 = -182.52056326603258  E_coul = 54.00559456462128
cycle= 4 E= -128.514968701411  delta_E= -5.05e-09  |g|= 4.51e-05  |ddm|= 0.000122
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.36197e-05
diis-c [-3.64854661e-10  1.94602625e-05  3.27374973e-04 -7.78897356e-02
  1.07754290e+00]
  HOMO = -0.847016470063458  LUMO = 0.811193666240649
  mo_energy =
[-3.27825927e+01 -1.93101253e+00 -8.47016470e-01 -8.47016470e-01
 -8.47016470e-01  8.11193666e-01  8.11193666e-01  8.11193666e-01
  2.00605023e+00  3.94722403e+00  3.94722403e+00  3.94722403e+00
  1.48019063e+01  1.48019063e+01  1.48019063e+01  1.92704116e+01
  6.08478768e+01  6.08478768e+01  6.08478768e+01  9.36256391e+01
  3.55905105e+02  1.34923579e+03  5.83565681e+03  3.50982646e+04]
E1 = -182.52063575326366  E_coul = 54.00566705167134
cycle= 5 E= -128.514968701592  delta_E= -1.81e-10  |g|= 2.48e-06  |ddm|= 1.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52063575326366  E_coul = 54.00566705167134
  HOMO = -0.847015927590419  LUMO = 0.81119369828793
  mo_energy =
[-3.27825906e+01 -1.93101244e+00 -8.47015928e-01 -8.47015928e-01
 -8.47015928e-01  8.11193698e-01  8.11193698e-01  8.11193698e-01
  2.00605011e+00  3.94722440e+00  3.94722440e+00  3.94722440e+00
  1.48019074e+01  1.48019074e+01  1.48019074e+01  1.92704128e+01
  6.08478786e+01  6.08478786e+01  6.08478786e+01  9.36256410e+01
  3.55905107e+02  1.34923580e+03  5.83565681e+03  3.50982646e+04]
E1 = -182.52062831710666  E_coul = 54.005659615513295
Extra cycle  E= -128.514968701593  delta_E= -1.05e-12  |g|= 1.09e-06  |ddm|= 1.6e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04814841e+01 5.69551403e+01 4.87509385e-01 7.82078251e+00
 1.65329515e+00 2.49213137e+00 7.50176229e+00 2.83860855e+01
 2.66674379e-01 8.39312883e-01]
E = -128.51496870159338
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482748        1
[INPUT] 0    0    [1    /1   ]  174.9070158          1
[INPUT] 0    0    [1    /1   ]  20.4814841432        1
[INPUT] 0    0    [1    /1   ]  56.9551403069        1
[INPUT] 0    0    [1    /1   ]  0.487509384919       1
[INPUT] 0    0    [1    /1   ]  7.82078250763        1
[INPUT] 0    0    [1    /1   ]  1.6532951456         1
[INPUT] 1    0    [1    /1   ]  2.49213136695        1
[INPUT] 1    0    [1    /1   ]  7.50176228802        1
[INPUT] 1    0    [1    /1   ]  28.386085454         1
[INPUT] 1    0    [1    /1   ]  0.266674378701       1
[INPUT] 1    0    [1    /1   ]  0.839312883282       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025323, 1.0]], [0, [2712.096824057359, 1.0]], [0, [617.4984827481527, 1.0]], [0, [174.9070157997586, 1.0]], [0, [20.481484143155416, 1.0]], [0, [56.9551403069497, 1.0]], [0, [0.4875093849188836, 1.0]], [0, [7.820782507632043, 1.0]], [0, [1.653295145599597, 1.0]], [1, [2.4921313669543457, 1.0]], [1, [7.501762288017806, 1.0]], [1, [28.386085453978268, 1.0]], [1, [0.2666743787013972, 1.0]], [1, [0.8393128832820373, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848275]
bas 3, expnt(s) = [174.9070158]
bas 4, expnt(s) = [20.48148414]
bas 5, expnt(s) = [56.95514031]
bas 6, expnt(s) = [0.48750938]
bas 7, expnt(s) = [7.82078251]
bas 8, expnt(s) = [1.65329515]
bas 9, expnt(s) = [2.49213137]
bas 10, expnt(s) = [7.50176229]
bas 11, expnt(s) = [28.38608545]
bas 12, expnt(s) = [0.26667438]
bas 13, expnt(s) = [0.83931288]
CPU time:        64.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512357e+02
 2.04814841e+01 2.43240615e+01 5.69551403e+01 5.23799065e+01
 4.87509385e-01 1.47401621e+00 7.82078251e+00 1.18155157e+01
 1.65329515e+00 3.68364540e+00 2.49213137e+00 9.13477925e+00
 7.50176229e+00 3.62191718e+01 2.83860855e+01 1.91146467e+02
 2.66674379e-01 5.59063331e-01 8.39312883e-01 2.34363111e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999090077716922
cond(S) = 239.35682700901543
E1 = -183.55884904076592  E_coul = 55.07769852488234
init E= -128.481150515884
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771773627597909  LUMO = 0.82959760213077
  mo_energy =
[-3.25555526e+01 -1.85142709e+00 -7.71773628e-01 -7.71773628e-01
 -7.71773628e-01  8.29597602e-01  8.29597602e-01  8.29597602e-01
  2.06020846e+00  4.01619485e+00  4.01619485e+00  4.01619485e+00
  1.49387215e+01  1.49387215e+01  1.49387215e+01  1.94253208e+01
  6.10533576e+01  6.10533576e+01  6.10533576e+01  9.38389544e+01
  3.56154822e+02  1.34951774e+03  5.83596758e+03  3.50985957e+04]
E1 = -181.9931623153054  E_coul = 53.482045824082455
cycle= 1 E= -128.511116491223  delta_E= -0.03  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.500147
diis-c [-0.25014746  1.        ]
  HOMO = -0.884062527900835  LUMO = 0.801994747504977
  mo_energy =
[-3.28951190e+01 -1.97014006e+00 -8.84062528e-01 -8.84062528e-01
 -8.84062528e-01  8.01994748e-01  8.01994748e-01  8.01994748e-01
  1.97969677e+00  3.91354578e+00  3.91354578e+00  3.91354578e+00
  1.47338440e+01  1.47338440e+01  1.47338440e+01  1.91930089e+01
  6.07457242e+01  6.07457242e+01  6.07457242e+01  9.35194008e+01
  3.55785511e+02  1.34910971e+03  5.83552767e+03  3.50981343e+04]
E1 = -182.7880465863481  E_coul = 54.2740743319636
cycle= 2 E= -128.513972254384  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0783
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254204
diis-c [-5.64204325e-04  3.36256330e-01  6.63743670e-01]
  HOMO = -0.84688570700047  LUMO = 0.811195087950878
  mo_energy =
[-3.27823925e+01 -1.93089086e+00 -8.46885707e-01 -8.46885707e-01
 -8.46885707e-01  8.11195088e-01  8.11195088e-01  8.11195088e-01
  2.00610517e+00  3.94728785e+00  3.94728785e+00  3.94728785e+00
  1.48020300e+01  1.48020300e+01  1.48020300e+01  1.92705443e+01
  6.08480557e+01  6.08480557e+01  6.08480557e+01  9.36258205e+01
  3.55905337e+02  1.34923609e+03  5.83565717e+03  3.50982650e+04]
E1 = -182.52072588600504  E_coul = 54.00575718964486
cycle= 3 E= -128.51496869636  delta_E= -0.000996  |g|= 0.000193  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000276362
diis-c [-3.83658185e-08 -1.57415409e-03 -2.43134770e-03  1.00400550e+00]
  HOMO = -0.846993390957153  LUMO = 0.811201433643072
  mo_energy =
[-3.27825525e+01 -1.93098563e+00 -8.46993391e-01 -8.46993391e-01
 -8.46993391e-01  8.11201434e-01  8.11201434e-01  8.11201434e-01
  2.00607218e+00  3.94724741e+00  3.94724741e+00  3.94724741e+00
  1.48019410e+01  1.48019410e+01  1.48019410e+01  1.92704487e+01
  6.08479162e+01  6.08479162e+01  6.08479162e+01  9.36256785e+01
  3.55905143e+02  1.34923583e+03  5.83565684e+03  3.50982646e+04]
E1 = -182.52056326603258  E_coul = 54.00559456462128
cycle= 4 E= -128.514968701411  delta_E= -5.05e-09  |g|= 4.51e-05  |ddm|= 0.000122
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.36197e-05
diis-c [-3.64854661e-10  1.94602625e-05  3.27374973e-04 -7.78897356e-02
  1.07754290e+00]
  HOMO = -0.847016470063458  LUMO = 0.811193666240649
  mo_energy =
[-3.27825927e+01 -1.93101253e+00 -8.47016470e-01 -8.47016470e-01
 -8.47016470e-01  8.11193666e-01  8.11193666e-01  8.11193666e-01
  2.00605023e+00  3.94722403e+00  3.94722403e+00  3.94722403e+00
  1.48019063e+01  1.48019063e+01  1.48019063e+01  1.92704116e+01
  6.08478768e+01  6.08478768e+01  6.08478768e+01  9.36256391e+01
  3.55905105e+02  1.34923579e+03  5.83565681e+03  3.50982646e+04]
E1 = -182.52063575326366  E_coul = 54.00566705167134
cycle= 5 E= -128.514968701592  delta_E= -1.81e-10  |g|= 2.48e-06  |ddm|= 1.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52063575326366  E_coul = 54.00566705167134
  HOMO = -0.847015927590419  LUMO = 0.81119369828793
  mo_energy =
[-3.27825906e+01 -1.93101244e+00 -8.47015928e-01 -8.47015928e-01
 -8.47015928e-01  8.11193698e-01  8.11193698e-01  8.11193698e-01
  2.00605011e+00  3.94722440e+00  3.94722440e+00  3.94722440e+00
  1.48019074e+01  1.48019074e+01  1.48019074e+01  1.92704128e+01
  6.08478786e+01  6.08478786e+01  6.08478786e+01  9.36256410e+01
  3.55905107e+02  1.34923580e+03  5.83565681e+03  3.50982646e+04]
E1 = -182.52062831710666  E_coul = 54.005659615513295
Extra cycle  E= -128.514968701593  delta_E= -1.05e-12  |g|= 1.09e-06  |ddm|= 1.6e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.35682700901543
E1 = -182.52062831710666  E_coul = 54.005659615513295
init E= -128.514968701593
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.847016454081841  LUMO = 0.811193550475882
  mo_energy =
[-3.27825921e+01 -1.93101311e+00 -8.47016454e-01 -8.47016454e-01
 -8.47016454e-01  8.11193550e-01  8.11193550e-01  8.11193550e-01
  2.00604963e+00  3.94722389e+00  3.94722389e+00  3.94722389e+00
  1.48019065e+01  1.48019065e+01  1.48019065e+01  1.92704117e+01
  6.08478772e+01  6.08478772e+01  6.08478772e+01  9.36256396e+01
  3.55905105e+02  1.34923579e+03  5.83565681e+03  3.50982646e+04]
E1 = -182.52063152682936  E_coul = 54.00566282523609
cycle= 1 E= -128.514968701593  delta_E= 1.14e-13  |g|= 4.44e-07  |ddm|= 5.21e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52063152682936  E_coul = 54.00566282523609
  HOMO = -0.847016226530064  LUMO = 0.811193603944234
  mo_energy =
[-3.27825914e+01 -1.93101289e+00 -8.47016227e-01 -8.47016227e-01
 -8.47016227e-01  8.11193604e-01  8.11193604e-01  8.11193604e-01
  2.00604977e+00  3.94722410e+00  3.94722410e+00  3.94722410e+00
  1.48019069e+01  1.48019069e+01  1.48019069e+01  1.92704122e+01
  6.08478779e+01  6.08478779e+01  6.08478779e+01  9.36256402e+01
  3.55905106e+02  1.34923580e+03  5.83565681e+03  3.50982646e+04]
E1 = -182.52062979071928  E_coul = 54.00566108912579
Extra cycle  E= -128.514968701593  delta_E= -2.27e-13  |g|= 2.36e-07  |ddm|= 1.61e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04814841e+01 5.69551403e+01 4.87509385e-01 7.82078251e+00
 1.65329515e+00 2.49213137e+00 7.50176229e+00 2.83860855e+01
 2.66674379e-01 8.39312883e-01]
grad_E = [ 2.12016580e-12  1.01376412e-10 -2.19828923e-09  1.82985331e-08
  4.21721388e-07 -1.10033270e-07  2.98350882e-05 -1.86530340e-06
 -1.78105869e-04  2.78763863e-04  1.52917248e-04 -1.75562368e-03
 -1.50790786e-04 -1.44030092e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482753        1
[INPUT] 0    0    [1    /1   ]  174.907015746        1
[INPUT] 0    0    [1    /1   ]  20.481482537         1
[INPUT] 0    0    [1    /1   ]  56.9551405439        1
[INPUT] 0    0    [1    /1   ]  0.487592937545       1
[INPUT] 0    0    [1    /1   ]  7.82078243859        1
[INPUT] 0    0    [1    /1   ]  1.65376340656        1
[INPUT] 1    0    [1    /1   ]  2.48420107633        1
[INPUT] 1    0    [1    /1   ]  7.49211491619        1
[INPUT] 1    0    [1    /1   ]  28.3898130359        1
[INPUT] 1    0    [1    /1   ]  0.266510764842       1
[INPUT] 1    0    [1    /1   ]  0.837558146045       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025323, 1.0]], [0, [2712.0968240571, 1.0]], [0, [617.4984827530423, 1.0]], [0, [174.90701574571247, 1.0]], [0, [20.481482537048315, 1.0]], [0, [56.95514054385687, 1.0]], [0, [0.48759293754526795, 1.0]], [0, [7.820782438586293, 1.0]], [0, [1.6537634065559252, 1.0]], [1, [2.4842010763283557, 1.0]], [1, [7.492114916187609, 1.0]], [1, [28.389813035856612, 1.0]], [1, [0.2665107648418907, 1.0]], [1, [0.8375581460445679, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848275]
bas 3, expnt(s) = [174.90701575]
bas 4, expnt(s) = [20.48148254]
bas 5, expnt(s) = [56.95514054]
bas 6, expnt(s) = [0.48759294]
bas 7, expnt(s) = [7.82078244]
bas 8, expnt(s) = [1.65376341]
bas 9, expnt(s) = [2.48420108]
bas 10, expnt(s) = [7.49211492]
bas 11, expnt(s) = [28.38981304]
bas 12, expnt(s) = [0.26651076]
bas 13, expnt(s) = [0.83755815]
CPU time:        67.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512357e+02
 2.04814825e+01 2.43240600e+01 5.69551405e+01 5.23799067e+01
 4.87592938e-01 1.47420568e+00 7.82078244e+00 1.18155156e+01
 1.65376341e+00 3.68442786e+00 2.48420108e+00 9.09845863e+00
 7.49211492e+00 3.61609582e+01 2.83898130e+01 1.91177843e+02
 2.66510765e-01 5.58634608e-01 8.37558146e-01 2.33750797e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999092172135223
cond(S) = 239.38377501362615
E1 = -183.55887920349866  E_coul = 55.07770946700489
init E= -128.481169736494
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771774856271473  LUMO = 0.828607367113259
  mo_energy =
[-3.25555467e+01 -1.85142707e+00 -7.71774856e-01 -7.71774856e-01
 -7.71774856e-01  8.28607367e-01  8.28607367e-01  8.28607367e-01
  2.06091867e+00  4.00659032e+00  4.00659032e+00  4.00659032e+00
  1.49015378e+01  1.49015378e+01  1.49015378e+01  1.94275711e+01
  6.09972496e+01  6.09972496e+01  6.09972496e+01  9.38411958e+01
  3.56156822e+02  1.34951951e+03  5.83596913e+03  3.50985970e+04]
E1 = -181.9931583549444  E_coul = 53.4820353316002
cycle= 1 E= -128.511123023344  delta_E= -0.03  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50011
diis-c [-0.25010991  1.        ]
  HOMO = -0.88406338076951  LUMO = 0.801058983393584
  mo_energy =
[-3.28951244e+01 -1.97014061e+00 -8.84063381e-01 -8.84063381e-01
 -8.84063381e-01  8.01058983e-01  8.01058983e-01  8.01058983e-01
  1.98038419e+00  3.90417077e+00  3.90417077e+00  3.90417077e+00
  1.46968224e+01  1.46968224e+01  1.46968224e+01  1.91952553e+01
  6.06895865e+01  6.06895865e+01  6.06895865e+01  9.35216328e+01
  3.55787508e+02  1.34911149e+03  5.83552923e+03  3.50981355e+04]
E1 = -182.78804856588727  E_coul = 54.27406972718278
cycle= 2 E= -128.513978838704  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0783
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254187
diis-c [-5.64663814e-04  3.36257406e-01  6.63742594e-01]
  HOMO = -0.846886259052395  LUMO = 0.810239950366218
  mo_energy =
[-3.27823978e+01 -1.93089093e+00 -8.46886259e-01 -8.46886259e-01
 -8.46886259e-01  8.10239950e-01  8.10239950e-01  8.10239950e-01
  2.00679963e+00  3.93783625e+00  3.93783625e+00  3.93783625e+00
  1.47649529e+01  1.47649529e+01  1.47649529e+01  1.92727916e+01
  6.07919235e+01  6.07919235e+01  6.07919235e+01  9.36280524e+01
  3.55907334e+02  1.34923787e+03  5.83565873e+03  3.50982663e+04]
E1 = -182.52071796989642  E_coul = 54.00574267233893
cycle= 3 E= -128.514975297557  delta_E= -0.000996  |g|= 0.000195  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000277484
diis-c [-3.88768943e-08 -1.57717989e-03 -2.43647927e-03  1.00401366e+00]
  HOMO = -0.84699453551997  LUMO = 0.810245947570986
  mo_energy =
[-3.27825587e+01 -1.93098644e+00 -8.46994536e-01 -8.46994536e-01
 -8.46994536e-01  8.10245948e-01  8.10245948e-01  8.10245948e-01
  2.00676590e+00  3.93779522e+00  3.93779522e+00  3.93779522e+00
  1.47648631e+01  1.47648631e+01  1.47648631e+01  1.92726952e+01
  6.07917831e+01  6.07917831e+01  6.07917831e+01  9.36279095e+01
  3.55907139e+02  1.34923761e+03  5.83565840e+03  3.50982659e+04]
E1 = -182.52055417543815  E_coul = 54.005578872700816
cycle= 4 E= -128.514975302737  delta_E= -5.18e-09  |g|= 4.53e-05  |ddm|= 0.000124
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.37625e-05
diis-c [-3.70665372e-10  2.07889408e-05  3.29869035e-04 -7.89219592e-02
  1.07857130e+00]
  HOMO = -0.847017761543285  LUMO = 0.810238127917389
  mo_energy =
[-3.27825991e+01 -1.93101354e+00 -8.47017762e-01 -8.47017762e-01
 -8.47017762e-01  8.10238128e-01  8.10238128e-01  8.10238128e-01
  2.00674378e+00  3.93777171e+00  3.93777171e+00  3.93777171e+00
  1.47648283e+01  1.47648283e+01  1.47648283e+01  1.92726579e+01
  6.07917435e+01  6.07917435e+01  6.07917435e+01  9.36278699e+01
  3.55907101e+02  1.34923757e+03  5.83565837e+03  3.50982659e+04]
E1 = -182.52062662816763  E_coul = 54.0056513252465
cycle= 5 E= -128.514975302921  delta_E= -1.84e-10  |g|= 2.52e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52062662816763  E_coul = 54.0056513252465
  HOMO = -0.84701719934435  LUMO = 0.810238164361244
  mo_energy =
[-3.27825970e+01 -1.93101344e+00 -8.47017199e-01 -8.47017199e-01
 -8.47017199e-01  8.10238164e-01  8.10238164e-01  8.10238164e-01
  2.00674366e+00  3.93777209e+00  3.93777209e+00  3.93777209e+00
  1.47648294e+01  1.47648294e+01  1.47648294e+01  1.92726592e+01
  6.07917454e+01  6.07917454e+01  6.07917454e+01  9.36278719e+01
  3.55907103e+02  1.34923757e+03  5.83565837e+03  3.50982659e+04]
E1 = -182.52061905434093  E_coul = 54.00564375141867
Extra cycle  E= -128.514975302922  delta_E= -1.14e-12  |g|= 1.11e-06  |ddm|= 1.61e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04814825e+01 5.69551405e+01 4.87592938e-01 7.82078244e+00
 1.65376341e+00 2.48420108e+00 7.49211492e+00 2.83898130e+01
 2.66510765e-01 8.37558146e-01]
E = -128.51497530292227
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482753        1
[INPUT] 0    0    [1    /1   ]  174.907015746        1
[INPUT] 0    0    [1    /1   ]  20.481482537         1
[INPUT] 0    0    [1    /1   ]  56.9551405439        1
[INPUT] 0    0    [1    /1   ]  0.487592937545       1
[INPUT] 0    0    [1    /1   ]  7.82078243859        1
[INPUT] 0    0    [1    /1   ]  1.65376340656        1
[INPUT] 1    0    [1    /1   ]  2.48420107633        1
[INPUT] 1    0    [1    /1   ]  7.49211491619        1
[INPUT] 1    0    [1    /1   ]  28.3898130359        1
[INPUT] 1    0    [1    /1   ]  0.266510764842       1
[INPUT] 1    0    [1    /1   ]  0.837558146045       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025323, 1.0]], [0, [2712.0968240571, 1.0]], [0, [617.4984827530423, 1.0]], [0, [174.90701574571247, 1.0]], [0, [20.481482537048315, 1.0]], [0, [56.95514054385687, 1.0]], [0, [0.48759293754526795, 1.0]], [0, [7.820782438586293, 1.0]], [0, [1.6537634065559252, 1.0]], [1, [2.4842010763283557, 1.0]], [1, [7.492114916187609, 1.0]], [1, [28.389813035856612, 1.0]], [1, [0.2665107648418907, 1.0]], [1, [0.8375581460445679, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848275]
bas 3, expnt(s) = [174.90701575]
bas 4, expnt(s) = [20.48148254]
bas 5, expnt(s) = [56.95514054]
bas 6, expnt(s) = [0.48759294]
bas 7, expnt(s) = [7.82078244]
bas 8, expnt(s) = [1.65376341]
bas 9, expnt(s) = [2.48420108]
bas 10, expnt(s) = [7.49211492]
bas 11, expnt(s) = [28.38981304]
bas 12, expnt(s) = [0.26651076]
bas 13, expnt(s) = [0.83755815]
CPU time:        67.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512357e+02
 2.04814825e+01 2.43240600e+01 5.69551405e+01 5.23799067e+01
 4.87592938e-01 1.47420568e+00 7.82078244e+00 1.18155156e+01
 1.65376341e+00 3.68442786e+00 2.48420108e+00 9.09845863e+00
 7.49211492e+00 3.61609582e+01 2.83898130e+01 1.91177843e+02
 2.66510765e-01 5.58634608e-01 8.37558146e-01 2.33750797e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999092172135223
cond(S) = 239.38377501362615
E1 = -183.55887920349866  E_coul = 55.07770946700489
init E= -128.481169736494
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.771774856271473  LUMO = 0.828607367113259
  mo_energy =
[-3.25555467e+01 -1.85142707e+00 -7.71774856e-01 -7.71774856e-01
 -7.71774856e-01  8.28607367e-01  8.28607367e-01  8.28607367e-01
  2.06091867e+00  4.00659032e+00  4.00659032e+00  4.00659032e+00
  1.49015378e+01  1.49015378e+01  1.49015378e+01  1.94275711e+01
  6.09972496e+01  6.09972496e+01  6.09972496e+01  9.38411958e+01
  3.56156822e+02  1.34951951e+03  5.83596913e+03  3.50985970e+04]
E1 = -181.9931583549444  E_coul = 53.4820353316002
cycle= 1 E= -128.511123023344  delta_E= -0.03  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.50011
diis-c [-0.25010991  1.        ]
  HOMO = -0.88406338076951  LUMO = 0.801058983393584
  mo_energy =
[-3.28951244e+01 -1.97014061e+00 -8.84063381e-01 -8.84063381e-01
 -8.84063381e-01  8.01058983e-01  8.01058983e-01  8.01058983e-01
  1.98038419e+00  3.90417077e+00  3.90417077e+00  3.90417077e+00
  1.46968224e+01  1.46968224e+01  1.46968224e+01  1.91952553e+01
  6.06895865e+01  6.06895865e+01  6.06895865e+01  9.35216328e+01
  3.55787508e+02  1.34911149e+03  5.83552923e+03  3.50981355e+04]
E1 = -182.78804856588727  E_coul = 54.27406972718278
cycle= 2 E= -128.513978838704  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0783
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254187
diis-c [-5.64663814e-04  3.36257406e-01  6.63742594e-01]
  HOMO = -0.846886259052395  LUMO = 0.810239950366218
  mo_energy =
[-3.27823978e+01 -1.93089093e+00 -8.46886259e-01 -8.46886259e-01
 -8.46886259e-01  8.10239950e-01  8.10239950e-01  8.10239950e-01
  2.00679963e+00  3.93783625e+00  3.93783625e+00  3.93783625e+00
  1.47649529e+01  1.47649529e+01  1.47649529e+01  1.92727916e+01
  6.07919235e+01  6.07919235e+01  6.07919235e+01  9.36280524e+01
  3.55907334e+02  1.34923787e+03  5.83565873e+03  3.50982663e+04]
E1 = -182.52071796989642  E_coul = 54.00574267233893
cycle= 3 E= -128.514975297557  delta_E= -0.000996  |g|= 0.000195  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000277484
diis-c [-3.88768943e-08 -1.57717989e-03 -2.43647927e-03  1.00401366e+00]
  HOMO = -0.84699453551997  LUMO = 0.810245947570986
  mo_energy =
[-3.27825587e+01 -1.93098644e+00 -8.46994536e-01 -8.46994536e-01
 -8.46994536e-01  8.10245948e-01  8.10245948e-01  8.10245948e-01
  2.00676590e+00  3.93779522e+00  3.93779522e+00  3.93779522e+00
  1.47648631e+01  1.47648631e+01  1.47648631e+01  1.92726952e+01
  6.07917831e+01  6.07917831e+01  6.07917831e+01  9.36279095e+01
  3.55907139e+02  1.34923761e+03  5.83565840e+03  3.50982659e+04]
E1 = -182.52055417543815  E_coul = 54.005578872700816
cycle= 4 E= -128.514975302737  delta_E= -5.18e-09  |g|= 4.53e-05  |ddm|= 0.000124
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.37625e-05
diis-c [-3.70665372e-10  2.07889408e-05  3.29869035e-04 -7.89219592e-02
  1.07857130e+00]
  HOMO = -0.847017761543285  LUMO = 0.810238127917389
  mo_energy =
[-3.27825991e+01 -1.93101354e+00 -8.47017762e-01 -8.47017762e-01
 -8.47017762e-01  8.10238128e-01  8.10238128e-01  8.10238128e-01
  2.00674378e+00  3.93777171e+00  3.93777171e+00  3.93777171e+00
  1.47648283e+01  1.47648283e+01  1.47648283e+01  1.92726579e+01
  6.07917435e+01  6.07917435e+01  6.07917435e+01  9.36278699e+01
  3.55907101e+02  1.34923757e+03  5.83565837e+03  3.50982659e+04]
E1 = -182.52062662816763  E_coul = 54.0056513252465
cycle= 5 E= -128.514975302921  delta_E= -1.84e-10  |g|= 2.52e-06  |ddm|= 1.96e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52062662816763  E_coul = 54.0056513252465
  HOMO = -0.84701719934435  LUMO = 0.810238164361244
  mo_energy =
[-3.27825970e+01 -1.93101344e+00 -8.47017199e-01 -8.47017199e-01
 -8.47017199e-01  8.10238164e-01  8.10238164e-01  8.10238164e-01
  2.00674366e+00  3.93777209e+00  3.93777209e+00  3.93777209e+00
  1.47648294e+01  1.47648294e+01  1.47648294e+01  1.92726592e+01
  6.07917454e+01  6.07917454e+01  6.07917454e+01  9.36278719e+01
  3.55907103e+02  1.34923757e+03  5.83565837e+03  3.50982659e+04]
E1 = -182.52061905434093  E_coul = 54.00564375141867
Extra cycle  E= -128.514975302922  delta_E= -1.14e-12  |g|= 1.11e-06  |ddm|= 1.61e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.38377501362615
E1 = -182.52061905434093  E_coul = 54.00564375141867
init E= -128.514975302922
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.847017735396817  LUMO = 0.810238014352526
  mo_energy =
[-3.27825985e+01 -1.93101411e+00 -8.47017735e-01 -8.47017735e-01
 -8.47017735e-01  8.10238014e-01  8.10238014e-01  8.10238014e-01
  2.00674318e+00  3.93777158e+00  3.93777158e+00  3.93777158e+00
  1.47648284e+01  1.47648284e+01  1.47648284e+01  1.92726580e+01
  6.07917440e+01  6.07917440e+01  6.07917440e+01  9.36278704e+01
  3.55907101e+02  1.34923757e+03  5.83565837e+03  3.50982659e+04]
E1 = -182.52062233074767  E_coul = 54.0056470278253
cycle= 1 E= -128.514975302922  delta_E= -1.14e-13  |g|= 4.53e-07  |ddm|= 5.29e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52062233074767  E_coul = 54.0056470278253
  HOMO = -0.847017503111292  LUMO = 0.810238068850256
  mo_energy =
[-3.27825977e+01 -1.93101389e+00 -8.47017503e-01 -8.47017503e-01
 -8.47017503e-01  8.10238069e-01  8.10238069e-01  8.10238069e-01
  2.00674332e+00  3.93777179e+00  3.93777179e+00  3.93777179e+00
  1.47648289e+01  1.47648289e+01  1.47648289e+01  1.92726585e+01
  6.07917446e+01  6.07917446e+01  6.07917446e+01  9.36278711e+01
  3.55907102e+02  1.34923757e+03  5.83565837e+03  3.50982659e+04]
E1 = -182.52062055975946  E_coul = 54.00564525683669
Extra cycle  E= -128.514975302923  delta_E= -3.98e-13  |g|= 2.41e-07  |ddm|= 1.64e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04814825e+01 5.69551405e+01 4.87592938e-01 7.82078244e+00
 1.65376341e+00 2.48420108e+00 7.49211492e+00 2.83898130e+01
 2.66510765e-01 8.37558146e-01]
grad_E = [ 3.15807290e-12  4.17242500e-11 -1.14815967e-09  2.95792246e-09
 -4.93851931e-07 -1.09008278e-08 -5.14826921e-05 -6.30644334e-07
 -1.22523188e-04 -3.29324967e-04  2.65885792e-04 -1.75572976e-03
 -3.64442924e-04 -6.07053108e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482757        1
[INPUT] 0    0    [1    /1   ]  174.907015788        1
[INPUT] 0    0    [1    /1   ]  20.4814894959        1
[INPUT] 0    0    [1    /1   ]  56.9551399324        1
[INPUT] 0    0    [1    /1   ]  0.487931547311       1
[INPUT] 0    0    [1    /1   ]  7.82077585636        1
[INPUT] 0    0    [1    /1   ]  1.6553429516         1
[INPUT] 1    0    [1    /1   ]  2.46460945961        1
[INPUT] 1    0    [1    /1   ]  7.4660453936         1
[INPUT] 1    0    [1    /1   ]  28.4086538427        1
[INPUT] 1    0    [1    /1   ]  0.265951636882       1
[INPUT] 1    0    [1    /1   ]  0.833104244704       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025294, 1.0]], [0, [2712.0968240570305, 1.0]], [0, [617.4984827565122, 1.0]], [0, [174.90701578788526, 1.0]], [0, [20.481489495903116, 1.0]], [0, [56.95513993244628, 1.0]], [0, [0.48793154731139504, 1.0]], [0, [7.820775856361259, 1.0]], [0, [1.6553429516035243, 1.0]], [1, [2.4646094596142123, 1.0]], [1, [7.466045393601639, 1.0]], [1, [28.40865384272763, 1.0]], [1, [0.2659516368821289, 1.0]], [1, [0.8331042447037252, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848276]
bas 3, expnt(s) = [174.90701579]
bas 4, expnt(s) = [20.4814895]
bas 5, expnt(s) = [56.95513993]
bas 6, expnt(s) = [0.48793155]
bas 7, expnt(s) = [7.82077586]
bas 8, expnt(s) = [1.65534295]
bas 9, expnt(s) = [2.46460946]
bas 10, expnt(s) = [7.46604539]
bas 11, expnt(s) = [28.40865384]
bas 12, expnt(s) = [0.26595164]
bas 13, expnt(s) = [0.83310424]
CPU time:        70.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512357e+02
 2.04814895e+01 2.43240662e+01 5.69551399e+01 5.23799062e+01
 4.87931547e-01 1.47497343e+00 7.82077586e+00 1.18155081e+01
 1.65534295e+00 3.68706685e+00 2.46460946e+00 9.00885364e+00
 7.46604539e+00 3.60037448e+01 2.84086538e+01 1.91336450e+02
 2.65951637e-01 5.57170003e-01 8.33104245e-01 2.32198054e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99909694347112
cond(S) = 239.47833321056655
E1 = -183.55895489778567  E_coul = 55.07773479750173
init E= -128.481220100284
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771779610769298  LUMO = 0.82568597656714
  mo_energy =
[-3.25555317e+01 -1.85142682e+00 -7.71779611e-01 -7.71779611e-01
 -7.71779611e-01  8.25685977e-01  8.25685977e-01  8.25685977e-01
  2.06350322e+00  3.98204815e+00  3.98204815e+00  3.98204815e+00
  1.48065688e+01  1.48065688e+01  1.48065688e+01  1.94354234e+01
  6.08637732e+01  6.08637732e+01  6.08637732e+01  9.38489790e+01
  3.56163786e+02  1.34952570e+03  5.83597455e+03  3.50986015e+04]
E1 = -181.99304244841463  E_coul = 53.48189572036072
cycle= 1 E= -128.511146728054  delta_E= -0.0299  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.49997
diis-c [-0.24997034  1.        ]
  HOMO = -0.884076210933945  LUMO = 0.798283785452053
  mo_energy =
[-3.28951529e+01 -1.97015569e+00 -8.84076211e-01 -8.84076211e-01
 -8.84076211e-01  7.98283785e-01  7.98283785e-01  7.98283785e-01
  1.98287850e+00  3.88018937e+00  3.88018937e+00  3.88018937e+00
  1.46022628e+01  1.46022628e+01  1.46022628e+01  1.92030819e+01
  6.05560056e+01  6.05560056e+01  6.05560056e+01  9.35293789e+01
  3.55794444e+02  1.34911767e+03  5.83553464e+03  3.50981400e+04]
E1 = -182.78800037841967  E_coul = 54.273997606193184
cycle= 2 E= -128.514002772226  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0783
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254136
diis-c [-5.65629087e-04  3.36274054e-01  6.63725946e-01]
  HOMO = -0.84689662071015  LUMO = 0.807412630317142
  mo_energy =
[-3.27824211e+01 -1.93090273e+00 -8.46896621e-01 -8.46896621e-01
 -8.46896621e-01  8.07412630e-01  8.07412630e-01  8.07412630e-01
  2.00932004e+00  3.91366600e+00  3.91366600e+00  3.91366600e+00
  1.46702524e+01  1.46702524e+01  1.46702524e+01  1.92806243e+01
  6.06583664e+01  6.06583664e+01  6.06583664e+01  9.36358028e+01
  3.55914276e+02  1.34924405e+03  5.83566415e+03  3.50982707e+04]
E1 = -182.52061522645113  E_coul = 54.005615774730764
cycle= 3 E= -128.51499945172  delta_E= -0.000997  |g|= 0.0002  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000280177
diis-c [-4.04209918e-08 -1.58638210e-03 -2.45645260e-03  1.00404283e+00]
  HOMO = -0.847006595758604  LUMO = 0.807417664588075
  mo_energy =
[-3.27825842e+01 -1.93100059e+00 -8.47006596e-01 -8.47006596e-01
 -8.47006596e-01  8.07417665e-01  8.07417665e-01  8.07417665e-01
  2.00928401e+00  3.91362324e+00  3.91362324e+00  3.91362324e+00
  1.46701607e+01  1.46701607e+01  1.46701607e+01  1.92805257e+01
  6.06582236e+01  6.06582236e+01  6.06582236e+01  9.36356577e+01
  3.55914079e+02  1.34924379e+03  5.83566382e+03  3.50982704e+04]
E1 = -182.52044757846772  E_coul = 54.00544812118881
cycle= 4 E= -128.514999457279  delta_E= -5.56e-09  |g|= 4.6e-05  |ddm|= 0.000129
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.38895e-05
diis-c [-3.89371943e-10  2.48696439e-05  3.36423563e-04 -8.21528659e-02
  1.08179157e+00]
  HOMO = -0.847030215323061  LUMO = 0.807409700524094
  mo_energy =
[-3.27826250e+01 -1.93102828e+00 -8.47030215e-01 -8.47030215e-01
 -8.47030215e-01  8.07409701e-01  8.07409701e-01  8.07409701e-01
  2.00926134e+00  3.91359938e+00  3.91359938e+00  3.91359938e+00
  1.46701254e+01  1.46701254e+01  1.46701254e+01  1.92804879e+01
  6.06581836e+01  6.06581836e+01  6.06581836e+01  9.36356177e+01
  3.55914040e+02  1.34924375e+03  5.83566379e+03  3.50982703e+04]
E1 = -182.52051973639232  E_coul = 54.005520278921075
cycle= 5 E= -128.514999457471  delta_E= -1.92e-10  |g|= 2.63e-06  |ddm|= 2.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52051973639232  E_coul = 54.005520278921075
  HOMO = -0.847029580412942  LUMO = 0.807409753879123
  mo_energy =
[-3.27826227e+01 -1.93102812e+00 -8.47029580e-01 -8.47029580e-01
 -8.47029580e-01  8.07409754e-01  8.07409754e-01  8.07409754e-01
  2.00926127e+00  3.91359982e+00  3.91359982e+00  3.91359982e+00
  1.46701266e+01  1.46701266e+01  1.46701266e+01  1.92804893e+01
  6.06581856e+01  6.06581856e+01  6.06581856e+01  9.36356198e+01
  3.55914043e+02  1.34924375e+03  5.83566379e+03  3.50982703e+04]
E1 = -182.52051168038668  E_coul = 54.005512222914305
Extra cycle  E= -128.514999457472  delta_E= -1.11e-12  |g|= 1.18e-06  |ddm|= 1.66e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04814895e+01 5.69551399e+01 4.87931547e-01 7.82077586e+00
 1.65534295e+00 2.46460946e+00 7.46604539e+00 2.84086538e+01
 2.65951637e-01 8.33104245e-01]
E = -128.51499945747236
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482757        1
[INPUT] 0    0    [1    /1   ]  174.907015788        1
[INPUT] 0    0    [1    /1   ]  20.4814894959        1
[INPUT] 0    0    [1    /1   ]  56.9551399324        1
[INPUT] 0    0    [1    /1   ]  0.487931547311       1
[INPUT] 0    0    [1    /1   ]  7.82077585636        1
[INPUT] 0    0    [1    /1   ]  1.6553429516         1
[INPUT] 1    0    [1    /1   ]  2.46460945961        1
[INPUT] 1    0    [1    /1   ]  7.4660453936         1
[INPUT] 1    0    [1    /1   ]  28.4086538427        1
[INPUT] 1    0    [1    /1   ]  0.265951636882       1
[INPUT] 1    0    [1    /1   ]  0.833104244704       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025294, 1.0]], [0, [2712.0968240570305, 1.0]], [0, [617.4984827565122, 1.0]], [0, [174.90701578788526, 1.0]], [0, [20.481489495903116, 1.0]], [0, [56.95513993244628, 1.0]], [0, [0.48793154731139504, 1.0]], [0, [7.820775856361259, 1.0]], [0, [1.6553429516035243, 1.0]], [1, [2.4646094596142123, 1.0]], [1, [7.466045393601639, 1.0]], [1, [28.40865384272763, 1.0]], [1, [0.2659516368821289, 1.0]], [1, [0.8331042447037252, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848276]
bas 3, expnt(s) = [174.90701579]
bas 4, expnt(s) = [20.4814895]
bas 5, expnt(s) = [56.95513993]
bas 6, expnt(s) = [0.48793155]
bas 7, expnt(s) = [7.82077586]
bas 8, expnt(s) = [1.65534295]
bas 9, expnt(s) = [2.46460946]
bas 10, expnt(s) = [7.46604539]
bas 11, expnt(s) = [28.40865384]
bas 12, expnt(s) = [0.26595164]
bas 13, expnt(s) = [0.83310424]
CPU time:        71.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512357e+02
 2.04814895e+01 2.43240662e+01 5.69551399e+01 5.23799062e+01
 4.87931547e-01 1.47497343e+00 7.82077586e+00 1.18155081e+01
 1.65534295e+00 3.68706685e+00 2.46460946e+00 9.00885364e+00
 7.46604539e+00 3.60037448e+01 2.84086538e+01 1.91336450e+02
 2.65951637e-01 5.57170003e-01 8.33104245e-01 2.32198054e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99909694347112
cond(S) = 239.47833321056655
E1 = -183.55895489778567  E_coul = 55.07773479750173
init E= -128.481220100284
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771779610769298  LUMO = 0.82568597656714
  mo_energy =
[-3.25555317e+01 -1.85142682e+00 -7.71779611e-01 -7.71779611e-01
 -7.71779611e-01  8.25685977e-01  8.25685977e-01  8.25685977e-01
  2.06350322e+00  3.98204815e+00  3.98204815e+00  3.98204815e+00
  1.48065688e+01  1.48065688e+01  1.48065688e+01  1.94354234e+01
  6.08637732e+01  6.08637732e+01  6.08637732e+01  9.38489790e+01
  3.56163786e+02  1.34952570e+03  5.83597455e+03  3.50986015e+04]
E1 = -181.99304244841463  E_coul = 53.48189572036072
cycle= 1 E= -128.511146728054  delta_E= -0.0299  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.49997
diis-c [-0.24997034  1.        ]
  HOMO = -0.884076210933945  LUMO = 0.798283785452053
  mo_energy =
[-3.28951529e+01 -1.97015569e+00 -8.84076211e-01 -8.84076211e-01
 -8.84076211e-01  7.98283785e-01  7.98283785e-01  7.98283785e-01
  1.98287850e+00  3.88018937e+00  3.88018937e+00  3.88018937e+00
  1.46022628e+01  1.46022628e+01  1.46022628e+01  1.92030819e+01
  6.05560056e+01  6.05560056e+01  6.05560056e+01  9.35293789e+01
  3.55794444e+02  1.34911767e+03  5.83553464e+03  3.50981400e+04]
E1 = -182.78800037841967  E_coul = 54.273997606193184
cycle= 2 E= -128.514002772226  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0783
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254136
diis-c [-5.65629087e-04  3.36274054e-01  6.63725946e-01]
  HOMO = -0.84689662071015  LUMO = 0.807412630317142
  mo_energy =
[-3.27824211e+01 -1.93090273e+00 -8.46896621e-01 -8.46896621e-01
 -8.46896621e-01  8.07412630e-01  8.07412630e-01  8.07412630e-01
  2.00932004e+00  3.91366600e+00  3.91366600e+00  3.91366600e+00
  1.46702524e+01  1.46702524e+01  1.46702524e+01  1.92806243e+01
  6.06583664e+01  6.06583664e+01  6.06583664e+01  9.36358028e+01
  3.55914276e+02  1.34924405e+03  5.83566415e+03  3.50982707e+04]
E1 = -182.52061522645113  E_coul = 54.005615774730764
cycle= 3 E= -128.51499945172  delta_E= -0.000997  |g|= 0.0002  |ddm|= 0.0267
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000280177
diis-c [-4.04209918e-08 -1.58638210e-03 -2.45645260e-03  1.00404283e+00]
  HOMO = -0.847006595758604  LUMO = 0.807417664588075
  mo_energy =
[-3.27825842e+01 -1.93100059e+00 -8.47006596e-01 -8.47006596e-01
 -8.47006596e-01  8.07417665e-01  8.07417665e-01  8.07417665e-01
  2.00928401e+00  3.91362324e+00  3.91362324e+00  3.91362324e+00
  1.46701607e+01  1.46701607e+01  1.46701607e+01  1.92805257e+01
  6.06582236e+01  6.06582236e+01  6.06582236e+01  9.36356577e+01
  3.55914079e+02  1.34924379e+03  5.83566382e+03  3.50982704e+04]
E1 = -182.52044757846772  E_coul = 54.00544812118881
cycle= 4 E= -128.514999457279  delta_E= -5.56e-09  |g|= 4.6e-05  |ddm|= 0.000129
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.38895e-05
diis-c [-3.89371943e-10  2.48696439e-05  3.36423563e-04 -8.21528659e-02
  1.08179157e+00]
  HOMO = -0.847030215323061  LUMO = 0.807409700524094
  mo_energy =
[-3.27826250e+01 -1.93102828e+00 -8.47030215e-01 -8.47030215e-01
 -8.47030215e-01  8.07409701e-01  8.07409701e-01  8.07409701e-01
  2.00926134e+00  3.91359938e+00  3.91359938e+00  3.91359938e+00
  1.46701254e+01  1.46701254e+01  1.46701254e+01  1.92804879e+01
  6.06581836e+01  6.06581836e+01  6.06581836e+01  9.36356177e+01
  3.55914040e+02  1.34924375e+03  5.83566379e+03  3.50982703e+04]
E1 = -182.52051973639232  E_coul = 54.005520278921075
cycle= 5 E= -128.514999457471  delta_E= -1.92e-10  |g|= 2.63e-06  |ddm|= 2.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52051973639232  E_coul = 54.005520278921075
  HOMO = -0.847029580412942  LUMO = 0.807409753879123
  mo_energy =
[-3.27826227e+01 -1.93102812e+00 -8.47029580e-01 -8.47029580e-01
 -8.47029580e-01  8.07409754e-01  8.07409754e-01  8.07409754e-01
  2.00926127e+00  3.91359982e+00  3.91359982e+00  3.91359982e+00
  1.46701266e+01  1.46701266e+01  1.46701266e+01  1.92804893e+01
  6.06581856e+01  6.06581856e+01  6.06581856e+01  9.36356198e+01
  3.55914043e+02  1.34924375e+03  5.83566379e+03  3.50982703e+04]
E1 = -182.52051168038668  E_coul = 54.005512222914305
Extra cycle  E= -128.514999457472  delta_E= -1.11e-12  |g|= 1.18e-06  |ddm|= 1.66e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.47833321056655
E1 = -182.52051168038668  E_coul = 54.005512222914305
init E= -128.514999457472
    CPU time for initialize scf      0.15 sec, wall time      0.15 sec
  HOMO = -0.847030149780143  LUMO = 0.807409596149367
  mo_energy =
[-3.27826243e+01 -1.93102884e+00 -8.47030150e-01 -8.47030150e-01
 -8.47030150e-01  8.07409596e-01  8.07409596e-01  8.07409596e-01
  2.00926075e+00  3.91359929e+00  3.91359929e+00  3.91359929e+00
  1.46701256e+01  1.46701256e+01  1.46701256e+01  1.92804881e+01
  6.06581841e+01  6.06581841e+01  6.06581841e+01  9.36356183e+01
  3.55914041e+02  1.34924375e+03  5.83566379e+03  3.50982703e+04]
E1 = -182.52051519325556  E_coul = 54.005515735783135
cycle= 1 E= -128.514999457472  delta_E= -5.68e-14  |g|= 4.85e-07  |ddm|= 5.58e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52051519325556  E_coul = 54.005515735783135
  HOMO = -0.847029900687006  LUMO = 0.807409654383582
  mo_energy =
[-3.27826236e+01 -1.93102860e+00 -8.47029901e-01 -8.47029901e-01
 -8.47029901e-01  8.07409654e-01  8.07409654e-01  8.07409654e-01
  2.00926091e+00  3.91359951e+00  3.91359951e+00  3.91359951e+00
  1.46701260e+01  1.46701260e+01  1.46701260e+01  1.92804886e+01
  6.06581848e+01  6.06581848e+01  6.06581848e+01  9.36356190e+01
  3.55914042e+02  1.34924375e+03  5.83566379e+03  3.50982703e+04]
E1 = -182.52051329891256  E_coul = 54.00551384144019
Extra cycle  E= -128.514999457472  delta_E= 5.68e-14  |g|= 2.58e-07  |ddm|= 1.75e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04814895e+01 5.69551399e+01 4.87931547e-01 7.82077586e+00
 1.65534295e+00 2.46460946e+00 7.46604539e+00 2.84086538e+01
 2.65951637e-01 8.33104245e-01]
grad_E = [ 5.89114614e-12 -1.17672611e-10  1.60264360e-09 -3.86681271e-08
 -3.11436166e-06  2.53015585e-07 -2.10480365e-04  2.59588564e-06
  2.96239850e-05 -1.70556969e-03  4.74569188e-04 -1.74361402e-03
 -1.15901780e-03  1.37832874e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482741        1
[INPUT] 0    0    [1    /1   ]  174.90701627         1
[INPUT] 0    0    [1    /1   ]  20.4815251615        1
[INPUT] 0    0    [1    /1   ]  56.9551362821        1
[INPUT] 0    0    [1    /1   ]  0.488662791835       1
[INPUT] 0    0    [1    /1   ]  7.82075484851        1
[INPUT] 0    0    [1    /1   ]  1.65837588884        1
[INPUT] 1    0    [1    /1   ]  2.44014473372        1
[INPUT] 1    0    [1    /1   ]  7.43373687035        1
[INPUT] 1    0    [1    /1   ]  28.4563539918        1
[INPUT] 1    0    [1    /1   ]  0.265170063717       1
[INPUT] 1    0    [1    /1   ]  0.82748934238        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025177, 1.0]], [0, [2712.096824058315, 1.0]], [0, [617.4984827406475, 1.0]], [0, [174.90701627003955, 1.0]], [0, [20.48152516152556, 1.0]], [0, [56.95513628214115, 1.0]], [0, [0.4886627918354178, 1.0]], [0, [7.820754848509619, 1.0]], [0, [1.6583758888353028, 1.0]], [1, [2.4401447337159357, 1.0]], [1, [7.433736870350259, 1.0]], [1, [28.456353991832525, 1.0]], [1, [0.26517006371682833, 1.0]], [1, [0.8274893423801457, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848274]
bas 3, expnt(s) = [174.90701627]
bas 4, expnt(s) = [20.48152516]
bas 5, expnt(s) = [56.95513628]
bas 6, expnt(s) = [0.48866279]
bas 7, expnt(s) = [7.82075485]
bas 8, expnt(s) = [1.65837589]
bas 9, expnt(s) = [2.44014473]
bas 10, expnt(s) = [7.43373687]
bas 11, expnt(s) = [28.45635399]
bas 12, expnt(s) = [0.26517006]
bas 13, expnt(s) = [0.82748934]
CPU time:        73.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512358e+02
 2.04815252e+01 2.43240980e+01 5.69551363e+01 5.23799037e+01
 4.88662792e-01 1.47663099e+00 7.82075485e+00 1.18154843e+01
 1.65837589e+00 3.69213231e+00 2.44014473e+00 8.89721071e+00
 7.43373687e+00 3.58090973e+01 2.84563540e+01 1.91738118e+02
 2.65170064e-01 5.55124006e-01 8.27489342e-01 2.30243513e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99910085492263
cond(S) = 239.6653464679218
E1 = -183.559071792265  E_coul = 55.07776872313764
init E= -128.481303069127
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771789750822659  LUMO = 0.82179052462706
  mo_energy =
[-3.25555097e+01 -1.85142601e+00 -7.71789751e-01 -7.71789751e-01
 -7.71789751e-01  8.21790525e-01  8.21790525e-01  8.21790525e-01
  2.06873654e+00  3.95102634e+00  3.95102634e+00  3.95102634e+00
  1.46874026e+01  1.46874026e+01  1.46874026e+01  1.94508716e+01
  6.07292791e+01  6.07292791e+01  6.07292791e+01  9.38642550e+01
  3.56177483e+02  1.34953789e+03  5.83598523e+03  3.50986103e+04]
E1 = -181.9930128571365  E_coul = 53.481814205859706
cycle= 1 E= -128.511198651277  delta_E= -0.0299  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.499673
diis-c [-0.24967341  1.        ]
  HOMO = -0.884089411637976  LUMO = 0.794579676085255
  mo_energy =
[-3.28951622e+01 -1.97017342e+00 -8.84089412e-01 -8.84089412e-01
 -8.84089412e-01  7.94579676e-01  7.94579676e-01  7.94579676e-01
  1.98794452e+00  3.84987423e+00  3.84987423e+00  3.84987423e+00
  1.44836210e+01  1.44836210e+01  1.44836210e+01  1.92185076e+01
  6.04213504e+01  6.04213504e+01  6.04213504e+01  9.35446319e+01
  3.55808130e+02  1.34912987e+03  5.83554534e+03  3.50981489e+04]
E1 = -182.7879871002358  E_coul = 54.27393265225627
cycle= 2 E= -128.51405444798  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0782
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254021
diis-c [-5.66775089e-04  3.36303296e-01  6.63696704e-01]
  HOMO = -0.846910697864161  LUMO = 0.803640016193937
  mo_energy =
[-3.27824343e+01 -1.93092011e+00 -8.46910698e-01 -8.46910698e-01
 -8.46910698e-01  8.03640016e-01  8.03640016e-01  8.03640016e-01
  2.01443363e+00  3.88311092e+00  3.88311092e+00  3.88311092e+00
  1.45514283e+01  1.45514283e+01  1.45514283e+01  1.92960514e+01
  6.05237477e+01  6.05237477e+01  6.05237477e+01  9.36510507e+01
  3.55927958e+02  1.34925625e+03  5.83567485e+03  3.50982796e+04]
E1 = -182.52054863926128  E_coul = 54.005497359810796
cycle= 3 E= -128.51505127945  delta_E= -0.000997  |g|= 0.000208  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000283466
diis-c [-4.27844568e-08 -1.60099754e-03 -2.49350949e-03  1.00409451e+00]
  HOMO = -0.847023052347362  LUMO = 0.803643701015307
  mo_energy =
[-3.27826002e+01 -1.93102159e+00 -8.47023052e-01 -8.47023052e-01
 -8.47023052e-01  8.03643701e-01  8.03643701e-01  8.03643701e-01
  2.01439411e+00  3.88306568e+00  3.88306568e+00  3.88306568e+00
  1.45513339e+01  1.45513339e+01  1.45513339e+01  1.92959495e+01
  6.05236019e+01  6.05236019e+01  6.05236019e+01  9.36509029e+01
  3.55927759e+02  1.34925599e+03  5.83567452e+03  3.50982792e+04]
E1 = -182.52037497063066  E_coul = 54.00532368504775
cycle= 4 E= -128.515051285583  delta_E= -6.13e-09  |g|= 4.69e-05  |ddm|= 0.000136
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.36696e-05
diis-c [-4.19154433e-10  3.12389187e-05  3.45222158e-04 -8.71450380e-02
  1.08676858e+00]
  HOMO = -0.847047192875817  LUMO = 0.803635535441522
  mo_energy =
[-3.27826415e+01 -1.93105014e+00 -8.47047193e-01 -8.47047193e-01
 -8.47047193e-01  8.03635535e-01  8.03635535e-01  8.03635535e-01
  2.01437063e+00  3.88304134e+00  3.88304134e+00  3.88304134e+00
  1.45512980e+01  1.45512980e+01  1.45512980e+01  1.92959110e+01
  6.05235613e+01  6.05235613e+01  6.05235613e+01  9.36508622e+01
  3.55927720e+02  1.34925595e+03  5.83567448e+03  3.50982792e+04]
E1 = -182.52044637972898  E_coul = 54.00539509394106
cycle= 5 E= -128.515051285788  delta_E= -2.05e-10  |g|= 2.83e-06  |ddm|= 2.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52044637972898  E_coul = 54.00539509394106
  HOMO = -0.847046432189789  LUMO = 0.803635618947312
  mo_energy =
[-3.27826389e+01 -1.93104988e+00 -8.47046432e-01 -8.47046432e-01
 -8.47046432e-01  8.03635619e-01  8.03635619e-01  8.03635619e-01
  2.01437062e+00  3.88304188e+00  3.88304188e+00  3.88304188e+00
  1.45512994e+01  1.45512994e+01  1.45512994e+01  1.92959126e+01
  6.05235636e+01  6.05235636e+01  6.05235636e+01  9.36508647e+01
  3.55927722e+02  1.34925595e+03  5.83567449e+03  3.50982792e+04]
E1 = -182.52043752643996  E_coul = 54.00538624065072
Extra cycle  E= -128.515051285789  delta_E= -1.31e-12  |g|= 1.29e-06  |ddm|= 1.73e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04815252e+01 5.69551363e+01 4.88662792e-01 7.82075485e+00
 1.65837589e+00 2.44014473e+00 7.43373687e+00 2.84563540e+01
 2.65170064e-01 8.27489342e-01]
E = -128.51505128578924
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.498482741        1
[INPUT] 0    0    [1    /1   ]  174.90701627         1
[INPUT] 0    0    [1    /1   ]  20.4815251615        1
[INPUT] 0    0    [1    /1   ]  56.9551362821        1
[INPUT] 0    0    [1    /1   ]  0.488662791835       1
[INPUT] 0    0    [1    /1   ]  7.82075484851        1
[INPUT] 0    0    [1    /1   ]  1.65837588884        1
[INPUT] 1    0    [1    /1   ]  2.44014473372        1
[INPUT] 1    0    [1    /1   ]  7.43373687035        1
[INPUT] 1    0    [1    /1   ]  28.4563539918        1
[INPUT] 1    0    [1    /1   ]  0.265170063717       1
[INPUT] 1    0    [1    /1   ]  0.82748934238        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730025177, 1.0]], [0, [2712.096824058315, 1.0]], [0, [617.4984827406475, 1.0]], [0, [174.90701627003955, 1.0]], [0, [20.48152516152556, 1.0]], [0, [56.95513628214115, 1.0]], [0, [0.4886627918354178, 1.0]], [0, [7.820754848509619, 1.0]], [0, [1.6583758888353028, 1.0]], [1, [2.4401447337159357, 1.0]], [1, [7.433736870350259, 1.0]], [1, [28.456353991832525, 1.0]], [1, [0.26517006371682833, 1.0]], [1, [0.8274893423801457, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848274]
bas 3, expnt(s) = [174.90701627]
bas 4, expnt(s) = [20.48152516]
bas 5, expnt(s) = [56.95513628]
bas 6, expnt(s) = [0.48866279]
bas 7, expnt(s) = [7.82075485]
bas 8, expnt(s) = [1.65837589]
bas 9, expnt(s) = [2.44014473]
bas 10, expnt(s) = [7.43373687]
bas 11, expnt(s) = [28.45635399]
bas 12, expnt(s) = [0.26517006]
bas 13, expnt(s) = [0.82748934]
CPU time:        74.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907016e+02 1.21512358e+02
 2.04815252e+01 2.43240980e+01 5.69551363e+01 5.23799037e+01
 4.88662792e-01 1.47663099e+00 7.82075485e+00 1.18154843e+01
 1.65837589e+00 3.69213231e+00 2.44014473e+00 8.89721071e+00
 7.43373687e+00 3.58090973e+01 2.84563540e+01 1.91738118e+02
 2.65170064e-01 5.55124006e-01 8.27489342e-01 2.30243513e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99910085492263
cond(S) = 239.6653464679218
E1 = -183.559071792265  E_coul = 55.07776872313764
init E= -128.481303069127
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771789750822659  LUMO = 0.82179052462706
  mo_energy =
[-3.25555097e+01 -1.85142601e+00 -7.71789751e-01 -7.71789751e-01
 -7.71789751e-01  8.21790525e-01  8.21790525e-01  8.21790525e-01
  2.06873654e+00  3.95102634e+00  3.95102634e+00  3.95102634e+00
  1.46874026e+01  1.46874026e+01  1.46874026e+01  1.94508716e+01
  6.07292791e+01  6.07292791e+01  6.07292791e+01  9.38642550e+01
  3.56177483e+02  1.34953789e+03  5.83598523e+03  3.50986103e+04]
E1 = -181.9930128571365  E_coul = 53.481814205859706
cycle= 1 E= -128.511198651277  delta_E= -0.0299  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.499673
diis-c [-0.24967341  1.        ]
  HOMO = -0.884089411637976  LUMO = 0.794579676085255
  mo_energy =
[-3.28951622e+01 -1.97017342e+00 -8.84089412e-01 -8.84089412e-01
 -8.84089412e-01  7.94579676e-01  7.94579676e-01  7.94579676e-01
  1.98794452e+00  3.84987423e+00  3.84987423e+00  3.84987423e+00
  1.44836210e+01  1.44836210e+01  1.44836210e+01  1.92185076e+01
  6.04213504e+01  6.04213504e+01  6.04213504e+01  9.35446319e+01
  3.55808130e+02  1.34912987e+03  5.83554534e+03  3.50981489e+04]
E1 = -182.7879871002358  E_coul = 54.27393265225627
cycle= 2 E= -128.51405444798  delta_E= -0.00286  |g|= 0.108  |ddm|= 0.0782
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254021
diis-c [-5.66775089e-04  3.36303296e-01  6.63696704e-01]
  HOMO = -0.846910697864161  LUMO = 0.803640016193937
  mo_energy =
[-3.27824343e+01 -1.93092011e+00 -8.46910698e-01 -8.46910698e-01
 -8.46910698e-01  8.03640016e-01  8.03640016e-01  8.03640016e-01
  2.01443363e+00  3.88311092e+00  3.88311092e+00  3.88311092e+00
  1.45514283e+01  1.45514283e+01  1.45514283e+01  1.92960514e+01
  6.05237477e+01  6.05237477e+01  6.05237477e+01  9.36510507e+01
  3.55927958e+02  1.34925625e+03  5.83567485e+03  3.50982796e+04]
E1 = -182.52054863926128  E_coul = 54.005497359810796
cycle= 3 E= -128.51505127945  delta_E= -0.000997  |g|= 0.000208  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000283466
diis-c [-4.27844568e-08 -1.60099754e-03 -2.49350949e-03  1.00409451e+00]
  HOMO = -0.847023052347362  LUMO = 0.803643701015307
  mo_energy =
[-3.27826002e+01 -1.93102159e+00 -8.47023052e-01 -8.47023052e-01
 -8.47023052e-01  8.03643701e-01  8.03643701e-01  8.03643701e-01
  2.01439411e+00  3.88306568e+00  3.88306568e+00  3.88306568e+00
  1.45513339e+01  1.45513339e+01  1.45513339e+01  1.92959495e+01
  6.05236019e+01  6.05236019e+01  6.05236019e+01  9.36509029e+01
  3.55927759e+02  1.34925599e+03  5.83567452e+03  3.50982792e+04]
E1 = -182.52037497063066  E_coul = 54.00532368504775
cycle= 4 E= -128.515051285583  delta_E= -6.13e-09  |g|= 4.69e-05  |ddm|= 0.000136
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.36696e-05
diis-c [-4.19154433e-10  3.12389187e-05  3.45222158e-04 -8.71450380e-02
  1.08676858e+00]
  HOMO = -0.847047192875817  LUMO = 0.803635535441522
  mo_energy =
[-3.27826415e+01 -1.93105014e+00 -8.47047193e-01 -8.47047193e-01
 -8.47047193e-01  8.03635535e-01  8.03635535e-01  8.03635535e-01
  2.01437063e+00  3.88304134e+00  3.88304134e+00  3.88304134e+00
  1.45512980e+01  1.45512980e+01  1.45512980e+01  1.92959110e+01
  6.05235613e+01  6.05235613e+01  6.05235613e+01  9.36508622e+01
  3.55927720e+02  1.34925595e+03  5.83567448e+03  3.50982792e+04]
E1 = -182.52044637972898  E_coul = 54.00539509394106
cycle= 5 E= -128.515051285788  delta_E= -2.05e-10  |g|= 2.83e-06  |ddm|= 2.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52044637972898  E_coul = 54.00539509394106
  HOMO = -0.847046432189789  LUMO = 0.803635618947312
  mo_energy =
[-3.27826389e+01 -1.93104988e+00 -8.47046432e-01 -8.47046432e-01
 -8.47046432e-01  8.03635619e-01  8.03635619e-01  8.03635619e-01
  2.01437062e+00  3.88304188e+00  3.88304188e+00  3.88304188e+00
  1.45512994e+01  1.45512994e+01  1.45512994e+01  1.92959126e+01
  6.05235636e+01  6.05235636e+01  6.05235636e+01  9.36508647e+01
  3.55927722e+02  1.34925595e+03  5.83567449e+03  3.50982792e+04]
E1 = -182.52043752643996  E_coul = 54.00538624065072
Extra cycle  E= -128.515051285789  delta_E= -1.31e-12  |g|= 1.29e-06  |ddm|= 1.73e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.6653464679218
E1 = -182.52043752643996  E_coul = 54.00538624065072
init E= -128.515051285789
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.847047056433138  LUMO = 0.803635448530545
  mo_energy =
[-3.27826407e+01 -1.93105066e+00 -8.47047056e-01 -8.47047056e-01
 -8.47047056e-01  8.03635449e-01  8.03635449e-01  8.03635449e-01
  2.01437006e+00  3.88304130e+00  3.88304130e+00  3.88304130e+00
  1.45512983e+01  1.45512983e+01  1.45512983e+01  1.92959113e+01
  6.05235620e+01  6.05235620e+01  6.05235620e+01  9.36508630e+01
  3.55927721e+02  1.34925595e+03  5.83567449e+03  3.50982792e+04]
E1 = -182.52044143487018  E_coul = 54.00539014908061
cycle= 1 E= -128.51505128579  delta_E= -3.41e-13  |g|= 5.38e-07  |ddm|= 6.06e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52044143487018  E_coul = 54.00539014908061
  HOMO = -0.847046779203954  LUMO = 0.803635513083917
  mo_energy =
[-3.27826398e+01 -1.93105040e+00 -8.47046779e-01 -8.47046779e-01
 -8.47046779e-01  8.03635513e-01  8.03635513e-01  8.03635513e-01
  2.01437023e+00  3.88304154e+00  3.88304154e+00  3.88304154e+00
  1.45512988e+01  1.45512988e+01  1.45512988e+01  1.92959118e+01
  6.05235627e+01  6.05235627e+01  6.05235627e+01  9.36508638e+01
  3.55927722e+02  1.34925595e+03  5.83567449e+03  3.50982792e+04]
E1 = -182.52043933485913  E_coul = 54.00538804906973
Extra cycle  E= -128.515051285789  delta_E= 1.71e-13  |g|= 2.86e-07  |ddm|= 1.93e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907016e+02
 2.04815252e+01 5.69551363e+01 4.88662792e-01 7.82075485e+00
 1.65837589e+00 2.44014473e+00 7.43373687e+00 2.84563540e+01
 2.65170064e-01 8.27489342e-01]
grad_E = [ 9.88607824e-12 -3.55770696e-10  5.59351097e-09 -1.02308238e-07
 -7.43507229e-06  6.47570251e-07 -3.44264917e-04  7.41594692e-06
  2.68131355e-04 -3.42750418e-03  6.91742943e-04 -1.71355088e-03
 -2.40432411e-03  3.90483007e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.49848266         1
[INPUT] 0    0    [1    /1   ]  174.907018246        1
[INPUT] 0    0    [1    /1   ]  20.4816587533        1
[INPUT] 0    0    [1    /1   ]  56.9551224457        1
[INPUT] 0    0    [1    /1   ]  0.490619969849       1
[INPUT] 0    0    [1    /1   ]  7.82068967747        1
[INPUT] 0    0    [1    /1   ]  1.66608539522        1
[INPUT] 1    0    [1    /1   ]  2.40496022859        1
[INPUT] 1    0    [1    /1   ]  7.39276639578        1
[INPUT] 1    0    [1    /1   ]  28.600406815         1
[INPUT] 1    0    [1    /1   ]  0.264192422388       1
[INPUT] 1    0    [1    /1   ]  0.819931862296       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730024763, 1.0]], [0, [2712.09682406418, 1.0]], [0, [617.4984826600734, 1.0]], [0, [174.90701824563493, 1.0]], [0, [20.481658753316754, 1.0]], [0, [56.95512244570455, 1.0]], [0, [0.49061996984862355, 1.0]], [0, [7.820689677472143, 1.0]], [0, [1.6660853952233805, 1.0]], [1, [2.40496022858772, 1.0]], [1, [7.3927663957787795, 1.0]], [1, [28.60040681497896, 1.0]], [1, [0.26419242238787344, 1.0]], [1, [0.8199318622955841, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873002]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848266]
bas 3, expnt(s) = [174.90701825]
bas 4, expnt(s) = [20.48165875]
bas 5, expnt(s) = [56.95512245]
bas 6, expnt(s) = [0.49061997]
bas 7, expnt(s) = [7.82068968]
bas 8, expnt(s) = [1.6660854]
bas 9, expnt(s) = [2.40496023]
bas 10, expnt(s) = [7.3927664]
bas 11, expnt(s) = [28.60040681]
bas 12, expnt(s) = [0.26419242]
bas 13, expnt(s) = [0.81993186]
CPU time:        76.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816588e+01 2.43242170e+01 5.69551224e+01 5.23798942e+01
 4.90619970e-01 1.48106439e+00 7.82068968e+00 1.18154105e+01
 1.66608540e+00 3.70499791e+00 2.40496023e+00 8.73713942e+00
 7.39276640e+00 3.55625686e+01 2.86004068e+01 1.92952165e+02
 2.64192422e-01 5.52566865e-01 8.19931862e-01 2.27617997e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99909829015354
cond(S) = 240.14863316543463
E1 = -183.55933428093522  E_coul = 55.07783775389288
init E= -128.481496527042
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.771817029305446  LUMO = 0.816770408415949
  mo_energy =
[-3.25554640e+01 -1.85142204e+00 -7.71817029e-01 -7.71817029e-01
 -7.71817029e-01  8.16770408e-01  8.16770408e-01  8.16770408e-01
  2.08237661e+00  3.90840985e+00  3.90840985e+00  3.90840985e+00
  1.45222741e+01  1.45222741e+01  1.45222741e+01  1.94905752e+01
  6.06537865e+01  6.06537865e+01  6.06537865e+01  9.39035176e+01
  3.56212750e+02  1.34956931e+03  5.83601278e+03  3.50986331e+04]
E1 = -181.99368149569372  E_coul = 53.4823346224165
cycle= 1 E= -128.511346873277  delta_E= -0.0299  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498861
diis-c [-0.24886268  1.        ]
  HOMO = -0.884073447175404  LUMO = 0.78982125309515
  mo_energy =
[-3.28950336e+01 -1.97016110e+00 -8.84073447e-01 -8.84073447e-01
 -8.84073447e-01  7.89821253e-01  7.89821253e-01  7.89821253e-01
  2.00120202e+00  3.80829284e+00  3.80829284e+00  3.80829284e+00
  1.43192845e+01  1.43192845e+01  1.43192845e+01  1.92582551e+01
  6.03455790e+01  6.03455790e+01  6.03455790e+01  9.35839887e+01
  3.55843517e+02  1.34916144e+03  5.83557306e+03  3.50981718e+04]
E1 = -182.78824695254266  E_coul = 54.274047152259755
cycle= 2 E= -128.514199800283  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.078
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253659
diis-c [-5.68657990e-04  3.36343069e-01  6.63656931e-01]
  HOMO = -0.846917484519047  LUMO = 0.798785376774156
  mo_energy =
[-3.27823673e+01 -1.93092897e+00 -8.46917485e-01 -8.46917485e-01
 -8.46917485e-01  7.98785377e-01  7.98785377e-01  7.98785377e-01
  2.02779811e+00  3.84117189e+00  3.84117189e+00  3.84117189e+00
  1.43868093e+01  1.43868093e+01  1.43868093e+01  1.93357634e+01
  6.04480281e+01  6.04480281e+01  6.04480281e+01  9.36903446e+01
  3.55963282e+02  1.34928777e+03  5.83570251e+03  3.50983025e+04]
E1 = -182.52086710198319  E_coul = 54.005671220219945
cycle= 3 E= -128.515195881763  delta_E= -0.000996  |g|= 0.000222  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000289881
diis-c [-4.75742349e-08 -1.63308154e-03 -2.57535541e-03  1.00420844e+00]
  HOMO = -0.847034361056863  LUMO = 0.798786524154743
  mo_energy =
[-3.27825383e+01 -1.93103775e+00 -8.47034361e-01 -8.47034361e-01
 -8.47034361e-01  7.98786524e-01  7.98786524e-01  7.98786524e-01
  2.02775154e+00  3.84112174e+00  3.84112174e+00  3.84112174e+00
  1.43867096e+01  1.43867096e+01  1.43867096e+01  1.93356553e+01
  6.04478767e+01  6.04478767e+01  6.04478767e+01  9.36901918e+01
  3.55963079e+02  1.34928750e+03  5.83570218e+03  3.50983021e+04]
E1 = -182.52068328851263  E_coul = 54.00548739947058
cycle= 4 E= -128.515195889042  delta_E= -7.28e-09  |g|= 4.86e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.26549e-05
diis-c [-4.78464628e-10  4.42527777e-05  3.60878816e-04 -9.69331413e-02
  1.09652801e+00]
  HOMO = -0.847059376690914  LUMO = 0.798777984657831
  mo_energy =
[-3.27825803e+01 -1.93106791e+00 -8.47059377e-01 -8.47059377e-01
 -8.47059377e-01  7.98777985e-01  7.98777985e-01  7.98777985e-01
  2.02772652e+00  3.84109652e+00  3.84109652e+00  3.84109652e+00
  1.43866726e+01  1.43866726e+01  1.43866726e+01  1.93356154e+01
  6.04478352e+01  6.04478352e+01  6.04478352e+01  9.36901503e+01
  3.55963039e+02  1.34928746e+03  5.83570214e+03  3.50983021e+04]
E1 = -182.52075274499046  E_coul = 54.005556855717735
cycle= 5 E= -128.515195889273  delta_E= -2.31e-10  |g|= 3.23e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52075274499046  E_coul = 54.005556855717735
  HOMO = -0.847058345641925  LUMO = 0.798778135852696
  mo_energy =
[-3.27825770e+01 -1.93106744e+00 -8.47058346e-01 -8.47058346e-01
 -8.47058346e-01  7.98778136e-01  7.98778136e-01  7.98778136e-01
  2.02772667e+00  3.84109730e+00  3.84109730e+00  3.84109730e+00
  1.43866744e+01  1.43866744e+01  1.43866744e+01  1.93356175e+01
  6.04478381e+01  6.04478381e+01  6.04478381e+01  9.36901534e+01
  3.55963043e+02  1.34928747e+03  5.83570215e+03  3.50983021e+04]
E1 = -182.52074228522625  E_coul = 54.00554639595147
Extra cycle  E= -128.515195889275  delta_E= -2.05e-12  |g|= 1.51e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907018e+02
 2.04816588e+01 5.69551224e+01 4.90619970e-01 7.82068968e+00
 1.66608540e+00 2.40496023e+00 7.39276640e+00 2.86004068e+01
 2.64192422e-01 8.19931862e-01]
E = -128.51519588927476
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682406        1
[INPUT] 0    0    [1    /1   ]  617.49848266         1
[INPUT] 0    0    [1    /1   ]  174.907018246        1
[INPUT] 0    0    [1    /1   ]  20.4816587533        1
[INPUT] 0    0    [1    /1   ]  56.9551224457        1
[INPUT] 0    0    [1    /1   ]  0.490619969849       1
[INPUT] 0    0    [1    /1   ]  7.82068967747        1
[INPUT] 0    0    [1    /1   ]  1.66608539522        1
[INPUT] 1    0    [1    /1   ]  2.40496022859        1
[INPUT] 1    0    [1    /1   ]  7.39276639578        1
[INPUT] 1    0    [1    /1   ]  28.600406815         1
[INPUT] 1    0    [1    /1   ]  0.264192422388       1
[INPUT] 1    0    [1    /1   ]  0.819931862296       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730024763, 1.0]], [0, [2712.09682406418, 1.0]], [0, [617.4984826600734, 1.0]], [0, [174.90701824563493, 1.0]], [0, [20.481658753316754, 1.0]], [0, [56.95512244570455, 1.0]], [0, [0.49061996984862355, 1.0]], [0, [7.820689677472143, 1.0]], [0, [1.6660853952233805, 1.0]], [1, [2.40496022858772, 1.0]], [1, [7.3927663957787795, 1.0]], [1, [28.60040681497896, 1.0]], [1, [0.26419242238787344, 1.0]], [1, [0.8199318622955841, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873002]
bas 1, expnt(s) = [2712.09682406]
bas 2, expnt(s) = [617.49848266]
bas 3, expnt(s) = [174.90701825]
bas 4, expnt(s) = [20.48165875]
bas 5, expnt(s) = [56.95512245]
bas 6, expnt(s) = [0.49061997]
bas 7, expnt(s) = [7.82068968]
bas 8, expnt(s) = [1.6660854]
bas 9, expnt(s) = [2.40496023]
bas 10, expnt(s) = [7.3927664]
bas 11, expnt(s) = [28.60040681]
bas 12, expnt(s) = [0.26419242]
bas 13, expnt(s) = [0.81993186]
CPU time:        77.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498483e+02 3.12962243e+02 1.74907018e+02 1.21512359e+02
 2.04816588e+01 2.43242170e+01 5.69551224e+01 5.23798942e+01
 4.90619970e-01 1.48106439e+00 7.82068968e+00 1.18154105e+01
 1.66608540e+00 3.70499791e+00 2.40496023e+00 8.73713942e+00
 7.39276640e+00 3.55625686e+01 2.86004068e+01 1.92952165e+02
 2.64192422e-01 5.52566865e-01 8.19931862e-01 2.27617997e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99909829015354
cond(S) = 240.14863316543463
E1 = -183.55933428093522  E_coul = 55.07783775389288
init E= -128.481496527042
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.771817029305446  LUMO = 0.816770408415949
  mo_energy =
[-3.25554640e+01 -1.85142204e+00 -7.71817029e-01 -7.71817029e-01
 -7.71817029e-01  8.16770408e-01  8.16770408e-01  8.16770408e-01
  2.08237661e+00  3.90840985e+00  3.90840985e+00  3.90840985e+00
  1.45222741e+01  1.45222741e+01  1.45222741e+01  1.94905752e+01
  6.06537865e+01  6.06537865e+01  6.06537865e+01  9.39035176e+01
  3.56212750e+02  1.34956931e+03  5.83601278e+03  3.50986331e+04]
E1 = -181.99368149569372  E_coul = 53.4823346224165
cycle= 1 E= -128.511346873277  delta_E= -0.0299  |g|= 0.213  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.498861
diis-c [-0.24886268  1.        ]
  HOMO = -0.884073447175404  LUMO = 0.78982125309515
  mo_energy =
[-3.28950336e+01 -1.97016110e+00 -8.84073447e-01 -8.84073447e-01
 -8.84073447e-01  7.89821253e-01  7.89821253e-01  7.89821253e-01
  2.00120202e+00  3.80829284e+00  3.80829284e+00  3.80829284e+00
  1.43192845e+01  1.43192845e+01  1.43192845e+01  1.92582551e+01
  6.03455790e+01  6.03455790e+01  6.03455790e+01  9.35839887e+01
  3.55843517e+02  1.34916144e+03  5.83557306e+03  3.50981718e+04]
E1 = -182.78824695254266  E_coul = 54.274047152259755
cycle= 2 E= -128.514199800283  delta_E= -0.00285  |g|= 0.108  |ddm|= 0.078
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253659
diis-c [-5.68657990e-04  3.36343069e-01  6.63656931e-01]
  HOMO = -0.846917484519047  LUMO = 0.798785376774156
  mo_energy =
[-3.27823673e+01 -1.93092897e+00 -8.46917485e-01 -8.46917485e-01
 -8.46917485e-01  7.98785377e-01  7.98785377e-01  7.98785377e-01
  2.02779811e+00  3.84117189e+00  3.84117189e+00  3.84117189e+00
  1.43868093e+01  1.43868093e+01  1.43868093e+01  1.93357634e+01
  6.04480281e+01  6.04480281e+01  6.04480281e+01  9.36903446e+01
  3.55963282e+02  1.34928777e+03  5.83570251e+03  3.50983025e+04]
E1 = -182.52086710198319  E_coul = 54.005671220219945
cycle= 3 E= -128.515195881763  delta_E= -0.000996  |g|= 0.000222  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000289881
diis-c [-4.75742349e-08 -1.63308154e-03 -2.57535541e-03  1.00420844e+00]
  HOMO = -0.847034361056863  LUMO = 0.798786524154743
  mo_energy =
[-3.27825383e+01 -1.93103775e+00 -8.47034361e-01 -8.47034361e-01
 -8.47034361e-01  7.98786524e-01  7.98786524e-01  7.98786524e-01
  2.02775154e+00  3.84112174e+00  3.84112174e+00  3.84112174e+00
  1.43867096e+01  1.43867096e+01  1.43867096e+01  1.93356553e+01
  6.04478767e+01  6.04478767e+01  6.04478767e+01  9.36901918e+01
  3.55963079e+02  1.34928750e+03  5.83570218e+03  3.50983021e+04]
E1 = -182.52068328851263  E_coul = 54.00548739947058
cycle= 4 E= -128.515195889042  delta_E= -7.28e-09  |g|= 4.86e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.26549e-05
diis-c [-4.78464628e-10  4.42527777e-05  3.60878816e-04 -9.69331413e-02
  1.09652801e+00]
  HOMO = -0.847059376690914  LUMO = 0.798777984657831
  mo_energy =
[-3.27825803e+01 -1.93106791e+00 -8.47059377e-01 -8.47059377e-01
 -8.47059377e-01  7.98777985e-01  7.98777985e-01  7.98777985e-01
  2.02772652e+00  3.84109652e+00  3.84109652e+00  3.84109652e+00
  1.43866726e+01  1.43866726e+01  1.43866726e+01  1.93356154e+01
  6.04478352e+01  6.04478352e+01  6.04478352e+01  9.36901503e+01
  3.55963039e+02  1.34928746e+03  5.83570214e+03  3.50983021e+04]
E1 = -182.52075274499046  E_coul = 54.005556855717735
cycle= 5 E= -128.515195889273  delta_E= -2.31e-10  |g|= 3.23e-06  |ddm|= 2.45e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52075274499046  E_coul = 54.005556855717735
  HOMO = -0.847058345641925  LUMO = 0.798778135852696
  mo_energy =
[-3.27825770e+01 -1.93106744e+00 -8.47058346e-01 -8.47058346e-01
 -8.47058346e-01  7.98778136e-01  7.98778136e-01  7.98778136e-01
  2.02772667e+00  3.84109730e+00  3.84109730e+00  3.84109730e+00
  1.43866744e+01  1.43866744e+01  1.43866744e+01  1.93356175e+01
  6.04478381e+01  6.04478381e+01  6.04478381e+01  9.36901534e+01
  3.55963043e+02  1.34928747e+03  5.83570215e+03  3.50983021e+04]
E1 = -182.52074228522625  E_coul = 54.00554639595147
Extra cycle  E= -128.515195889275  delta_E= -2.05e-12  |g|= 1.51e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.14863316543463
E1 = -182.52074228522625  E_coul = 54.00554639595147
init E= -128.515195889275
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.847059079981199  LUMO = 0.798777940110419
  mo_energy =
[-3.27825792e+01 -1.93106835e+00 -8.47059080e-01 -8.47059080e-01
 -8.47059080e-01  7.98777940e-01  7.98777940e-01  7.98777940e-01
  2.02772601e+00  3.84109662e+00  3.84109662e+00  3.84109662e+00
  1.43866731e+01  1.43866731e+01  1.43866731e+01  1.93356159e+01
  6.04478362e+01  6.04478362e+01  6.04478362e+01  9.36901514e+01
  3.55963041e+02  1.34928746e+03  5.83570215e+03  3.50983021e+04]
E1 = -182.52074700540058  E_coul = 54.005551116126114
cycle= 1 E= -128.515195889274  delta_E= 2.84e-13  |g|= 6.47e-07  |ddm|= 7.01e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52074700540058  E_coul = 54.005551116126114
  HOMO = -0.847058744985935  LUMO = 0.798778017836306
  mo_energy =
[-3.27825781e+01 -1.93106802e+00 -8.47058745e-01 -8.47058745e-01
 -8.47058745e-01  7.98778018e-01  7.98778018e-01  7.98778018e-01
  2.02772623e+00  3.84109691e+00  3.84109691e+00  3.84109691e+00
  1.43866737e+01  1.43866737e+01  1.43866737e+01  1.93356166e+01
  6.04478371e+01  6.04478371e+01  6.04478371e+01  9.36901523e+01
  3.55963042e+02  1.34928746e+03  5.83570215e+03  3.50983021e+04]
E1 = -182.52074448588527  E_coul = 54.005548596610566
Extra cycle  E= -128.515195889275  delta_E= -2.27e-13  |g|= 3.43e-07  |ddm|= 2.32e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498483e+02 1.74907018e+02
 2.04816588e+01 5.69551224e+01 4.90619970e-01 7.82068968e+00
 1.66608540e+00 2.40496023e+00 7.39276640e+00 2.86004068e+01
 2.64192422e-01 8.19931862e-01]
grad_E = [ 1.80166966e-11 -8.50796649e-10  1.36609332e-08 -2.37815813e-07
 -1.73115924e-05  1.47587706e-06 -4.53028502e-04  1.78274680e-05
  7.92305143e-04 -6.28429784e-03  9.97038859e-04 -1.63957753e-03
 -4.87279604e-03  8.18889267e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682408        1
[INPUT] 0    0    [1    /1   ]  617.498482398        1
[INPUT] 0    0    [1    /1   ]  174.907024278        1
[INPUT] 0    0    [1    /1   ]  20.4820549958        1
[INPUT] 0    0    [1    /1   ]  56.9550815222        1
[INPUT] 0    0    [1    /1   ]  0.495296145534       1
[INPUT] 0    0    [1    /1   ]  7.82051425923        1
[INPUT] 0    0    [1    /1   ]  1.68412326752        1
[INPUT] 1    0    [1    /1   ]  2.37056719992        1
[INPUT] 1    0    [1    /1   ]  7.37520082167        1
[INPUT] 1    0    [1    /1   ]  28.9820724588        1
[INPUT] 1    0    [1    /1   ]  0.264110392298       1
[INPUT] 1    0    [1    /1   ]  0.814694582725       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002357, 1.0]], [0, [2712.0968240827174, 1.0]], [0, [617.4984823982769, 1.0]], [0, [174.9070242778244, 1.0]], [0, [20.482054995760116, 1.0]], [0, [56.95508152219883, 1.0]], [0, [0.49529614553401424, 1.0]], [0, [7.8205142592322625, 1.0]], [0, [1.684123267516884, 1.0]], [1, [2.370567199916604, 1.0]], [1, [7.375200821667074, 1.0]], [1, [28.982072458774898, 1.0]], [1, [0.2641103922980571, 1.0]], [1, [0.8146945827246315, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873002]
bas 1, expnt(s) = [2712.09682408]
bas 2, expnt(s) = [617.4984824]
bas 3, expnt(s) = [174.90702428]
bas 4, expnt(s) = [20.482055]
bas 5, expnt(s) = [56.95508152]
bas 6, expnt(s) = [0.49529615]
bas 7, expnt(s) = [7.82051426]
bas 8, expnt(s) = [1.68412327]
bas 9, expnt(s) = [2.3705672]
bas 10, expnt(s) = [7.37520082]
bas 11, expnt(s) = [28.98207246]
bas 12, expnt(s) = [0.26411039]
bas 13, expnt(s) = [0.81469458]
CPU time:        79.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907024e+02 1.21512362e+02
 2.04820550e+01 2.43245699e+01 5.69550815e+01 5.23798659e+01
 4.95296146e-01 1.49163902e+00 7.82051426e+00 1.18152117e+01
 1.68412327e+00 3.73504150e+00 2.37056720e+00 8.58123373e+00
 7.37520082e+00 3.54569770e+01 2.89820725e+01 1.96176142e+02
 2.64110392e-01 5.52352413e-01 8.14694583e-01 2.25802075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999068520322542
cond(S) = 241.29448672935112
E1 = -183.55990752384895  E_coul = 55.07798181124315
init E= -128.481925712606
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77188425620192  LUMO = 0.81499817607144
  mo_energy =
[-3.25553748e+01 -1.85140360e+00 -7.71884256e-01 -7.71884256e-01
 -7.71884256e-01  8.14998176e-01  8.14998176e-01  8.14998176e-01
  2.11468358e+00  3.87570905e+00  3.87570905e+00  3.87570905e+00
  1.43883379e+01  1.43883379e+01  1.43883379e+01  1.95837830e+01
  6.09747846e+01  6.09747846e+01  6.09747846e+01  9.39958692e+01
  3.56295843e+02  1.34964339e+03  5.83607774e+03  3.50986868e+04]
E1 = -181.99704181464838  E_coul = 53.48531005741413
cycle= 1 E= -128.511731757234  delta_E= -0.0298  |g|= 0.213  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.496851
diis-c [-0.2468607  1.       ]
  HOMO = -0.883914078755678  LUMO = 0.78823012213246
  mo_energy =
[-3.28943833e+01 -1.96998164e+00 -8.83914079e-01 -8.83914079e-01
 -8.83914079e-01  7.88230122e-01  7.88230122e-01  7.88230122e-01
  2.03273473e+00  3.77666511e+00  3.77666511e+00  3.77666511e+00
  1.41862321e+01  1.41862321e+01  1.41862321e+01  1.93518079e+01
  6.06662291e+01  6.06662291e+01  6.06662291e+01  9.36769058e+01
  3.55927244e+02  1.34923623e+03  5.83563877e+03  3.50982263e+04]
E1 = -182.7895920512945  E_coul = 54.27501915842083
cycle= 2 E= -128.514572892874  delta_E= -0.00284  |g|= 0.108  |ddm|= 0.0778
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252646
diis-c [-5.71453505e-04  3.36342482e-01  6.63657518e-01]
  HOMO = -0.846858521766434  LUMO = 0.797118773698444
  mo_energy =
[-3.27819831e+01 -1.93084976e+00 -8.46858522e-01 -8.46858522e-01
 -8.46858522e-01  7.97118774e-01  7.97118774e-01  7.97118774e-01
  2.05954447e+00  3.80915646e+00  3.80915646e+00  3.80915646e+00
  1.42534187e+01  1.42534187e+01  1.42534187e+01  1.94291434e+01
  6.07686988e+01  6.07686988e+01  6.07686988e+01  9.37829988e+01
  3.56046733e+02  1.34936228e+03  5.83576793e+03  3.50983567e+04]
E1 = -182.52280785409192  E_coul = 54.00724336897875
cycle= 3 E= -128.515564485113  delta_E= -0.000992  |g|= 0.000246  |ddm|= 0.0265
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000302114
diis-c [-5.63517693e-08 -1.69761932e-03 -2.73357270e-03  1.00443119e+00]
  HOMO = -0.846982877560184  LUMO = 0.797115730471402
  mo_energy =
[-3.27821619e+01 -1.93097140e+00 -8.46982878e-01 -8.46982878e-01
 -8.46982878e-01  7.97115730e-01  7.97115730e-01  7.97115730e-01
  2.05948541e+00  3.80909766e+00  3.80909766e+00  3.80909766e+00
  1.42533094e+01  1.42533094e+01  1.42533094e+01  1.94290240e+01
  6.07685380e+01  6.07685380e+01  6.07685380e+01  9.37828376e+01
  3.56046525e+02  1.34936201e+03  5.83576760e+03  3.50983563e+04]
E1 = -182.5226121273942  E_coul = 54.007047632986456
cycle= 4 E= -128.515564494408  delta_E= -9.29e-09  |g|= 5.13e-05  |ddm|= 0.00017
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.99549e-05
diis-c [-5.76865885e-10  6.78602802e-05  3.84766405e-04 -1.13244782e-01
  1.11279216e+00]
  HOMO = -0.84700903543775  LUMO = 0.797106597865983
  mo_energy =
[-3.27822046e+01 -1.93100405e+00 -8.47009035e-01 -8.47009035e-01
 -8.47009035e-01  7.97106598e-01  7.97106598e-01  7.97106598e-01
  2.05945790e+00  3.80907115e+00  3.80907115e+00  3.80907115e+00
  1.42532710e+01  1.42532710e+01  1.42532710e+01  1.94289824e+01
  6.07684955e+01  6.07684955e+01  6.07684955e+01  9.37827954e+01
  3.56046486e+02  1.34936197e+03  5.83576757e+03  3.50983563e+04]
E1 = -182.52267722733438  E_coul = 54.00711273265032
cycle= 5 E= -128.515564494684  delta_E= -2.76e-10  |g|= 3.9e-06  |ddm|= 2.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52267722733438  E_coul = 54.00711273265032
  HOMO = -0.847007510671645  LUMO = 0.797106881460993
  mo_energy =
[-3.27822002e+01 -1.93100316e+00 -8.47007511e-01 -8.47007511e-01
 -8.47007511e-01  7.97106881e-01  7.97106881e-01  7.97106881e-01
  2.05945837e+00  3.80907237e+00  3.80907237e+00  3.80907237e+00
  1.42532737e+01  1.42532737e+01  1.42532737e+01  1.94289854e+01
  6.07684995e+01  6.07684995e+01  6.07684995e+01  9.37827996e+01
  3.56046491e+02  1.34936198e+03  5.83576757e+03  3.50983563e+04]
E1 = -182.52266410293223  E_coul = 54.007099608245795
Extra cycle  E= -128.515564494686  delta_E= -2.36e-12  |g|= 1.89e-06  |ddm|= 1.98e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907024e+02
 2.04820550e+01 5.69550815e+01 4.95296146e-01 7.82051426e+00
 1.68412327e+00 2.37056720e+00 7.37520082e+00 2.89820725e+01
 2.64110392e-01 8.14694583e-01]
E = -128.51556449468643
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682408        1
[INPUT] 0    0    [1    /1   ]  617.498482398        1
[INPUT] 0    0    [1    /1   ]  174.907024278        1
[INPUT] 0    0    [1    /1   ]  20.4820549958        1
[INPUT] 0    0    [1    /1   ]  56.9550815222        1
[INPUT] 0    0    [1    /1   ]  0.495296145534       1
[INPUT] 0    0    [1    /1   ]  7.82051425923        1
[INPUT] 0    0    [1    /1   ]  1.68412326752        1
[INPUT] 1    0    [1    /1   ]  2.37056719992        1
[INPUT] 1    0    [1    /1   ]  7.37520082167        1
[INPUT] 1    0    [1    /1   ]  28.9820724588        1
[INPUT] 1    0    [1    /1   ]  0.264110392298       1
[INPUT] 1    0    [1    /1   ]  0.814694582725       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002357, 1.0]], [0, [2712.0968240827174, 1.0]], [0, [617.4984823982769, 1.0]], [0, [174.9070242778244, 1.0]], [0, [20.482054995760116, 1.0]], [0, [56.95508152219883, 1.0]], [0, [0.49529614553401424, 1.0]], [0, [7.8205142592322625, 1.0]], [0, [1.684123267516884, 1.0]], [1, [2.370567199916604, 1.0]], [1, [7.375200821667074, 1.0]], [1, [28.982072458774898, 1.0]], [1, [0.2641103922980571, 1.0]], [1, [0.8146945827246315, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873002]
bas 1, expnt(s) = [2712.09682408]
bas 2, expnt(s) = [617.4984824]
bas 3, expnt(s) = [174.90702428]
bas 4, expnt(s) = [20.482055]
bas 5, expnt(s) = [56.95508152]
bas 6, expnt(s) = [0.49529615]
bas 7, expnt(s) = [7.82051426]
bas 8, expnt(s) = [1.68412327]
bas 9, expnt(s) = [2.3705672]
bas 10, expnt(s) = [7.37520082]
bas 11, expnt(s) = [28.98207246]
bas 12, expnt(s) = [0.26411039]
bas 13, expnt(s) = [0.81469458]
CPU time:        80.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907024e+02 1.21512362e+02
 2.04820550e+01 2.43245699e+01 5.69550815e+01 5.23798659e+01
 4.95296146e-01 1.49163902e+00 7.82051426e+00 1.18152117e+01
 1.68412327e+00 3.73504150e+00 2.37056720e+00 8.58123373e+00
 7.37520082e+00 3.54569770e+01 2.89820725e+01 1.96176142e+02
 2.64110392e-01 5.52352413e-01 8.14694583e-01 2.25802075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999068520322542
cond(S) = 241.29448672935112
E1 = -183.55990752384895  E_coul = 55.07798181124315
init E= -128.481925712606
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77188425620192  LUMO = 0.81499817607144
  mo_energy =
[-3.25553748e+01 -1.85140360e+00 -7.71884256e-01 -7.71884256e-01
 -7.71884256e-01  8.14998176e-01  8.14998176e-01  8.14998176e-01
  2.11468358e+00  3.87570905e+00  3.87570905e+00  3.87570905e+00
  1.43883379e+01  1.43883379e+01  1.43883379e+01  1.95837830e+01
  6.09747846e+01  6.09747846e+01  6.09747846e+01  9.39958692e+01
  3.56295843e+02  1.34964339e+03  5.83607774e+03  3.50986868e+04]
E1 = -181.99704181464838  E_coul = 53.48531005741413
cycle= 1 E= -128.511731757234  delta_E= -0.0298  |g|= 0.213  |ddm|= 0.172
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.496851
diis-c [-0.2468607  1.       ]
  HOMO = -0.883914078755678  LUMO = 0.78823012213246
  mo_energy =
[-3.28943833e+01 -1.96998164e+00 -8.83914079e-01 -8.83914079e-01
 -8.83914079e-01  7.88230122e-01  7.88230122e-01  7.88230122e-01
  2.03273473e+00  3.77666511e+00  3.77666511e+00  3.77666511e+00
  1.41862321e+01  1.41862321e+01  1.41862321e+01  1.93518079e+01
  6.06662291e+01  6.06662291e+01  6.06662291e+01  9.36769058e+01
  3.55927244e+02  1.34923623e+03  5.83563877e+03  3.50982263e+04]
E1 = -182.7895920512945  E_coul = 54.27501915842083
cycle= 2 E= -128.514572892874  delta_E= -0.00284  |g|= 0.108  |ddm|= 0.0778
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252646
diis-c [-5.71453505e-04  3.36342482e-01  6.63657518e-01]
  HOMO = -0.846858521766434  LUMO = 0.797118773698444
  mo_energy =
[-3.27819831e+01 -1.93084976e+00 -8.46858522e-01 -8.46858522e-01
 -8.46858522e-01  7.97118774e-01  7.97118774e-01  7.97118774e-01
  2.05954447e+00  3.80915646e+00  3.80915646e+00  3.80915646e+00
  1.42534187e+01  1.42534187e+01  1.42534187e+01  1.94291434e+01
  6.07686988e+01  6.07686988e+01  6.07686988e+01  9.37829988e+01
  3.56046733e+02  1.34936228e+03  5.83576793e+03  3.50983567e+04]
E1 = -182.52280785409192  E_coul = 54.00724336897875
cycle= 3 E= -128.515564485113  delta_E= -0.000992  |g|= 0.000246  |ddm|= 0.0265
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000302114
diis-c [-5.63517693e-08 -1.69761932e-03 -2.73357270e-03  1.00443119e+00]
  HOMO = -0.846982877560184  LUMO = 0.797115730471402
  mo_energy =
[-3.27821619e+01 -1.93097140e+00 -8.46982878e-01 -8.46982878e-01
 -8.46982878e-01  7.97115730e-01  7.97115730e-01  7.97115730e-01
  2.05948541e+00  3.80909766e+00  3.80909766e+00  3.80909766e+00
  1.42533094e+01  1.42533094e+01  1.42533094e+01  1.94290240e+01
  6.07685380e+01  6.07685380e+01  6.07685380e+01  9.37828376e+01
  3.56046525e+02  1.34936201e+03  5.83576760e+03  3.50983563e+04]
E1 = -182.5226121273942  E_coul = 54.007047632986456
cycle= 4 E= -128.515564494408  delta_E= -9.29e-09  |g|= 5.13e-05  |ddm|= 0.00017
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.99549e-05
diis-c [-5.76865885e-10  6.78602802e-05  3.84766405e-04 -1.13244782e-01
  1.11279216e+00]
  HOMO = -0.84700903543775  LUMO = 0.797106597865983
  mo_energy =
[-3.27822046e+01 -1.93100405e+00 -8.47009035e-01 -8.47009035e-01
 -8.47009035e-01  7.97106598e-01  7.97106598e-01  7.97106598e-01
  2.05945790e+00  3.80907115e+00  3.80907115e+00  3.80907115e+00
  1.42532710e+01  1.42532710e+01  1.42532710e+01  1.94289824e+01
  6.07684955e+01  6.07684955e+01  6.07684955e+01  9.37827954e+01
  3.56046486e+02  1.34936197e+03  5.83576757e+03  3.50983563e+04]
E1 = -182.52267722733438  E_coul = 54.00711273265032
cycle= 5 E= -128.515564494684  delta_E= -2.76e-10  |g|= 3.9e-06  |ddm|= 2.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52267722733438  E_coul = 54.00711273265032
  HOMO = -0.847007510671645  LUMO = 0.797106881460993
  mo_energy =
[-3.27822002e+01 -1.93100316e+00 -8.47007511e-01 -8.47007511e-01
 -8.47007511e-01  7.97106881e-01  7.97106881e-01  7.97106881e-01
  2.05945837e+00  3.80907237e+00  3.80907237e+00  3.80907237e+00
  1.42532737e+01  1.42532737e+01  1.42532737e+01  1.94289854e+01
  6.07684995e+01  6.07684995e+01  6.07684995e+01  9.37827996e+01
  3.56046491e+02  1.34936198e+03  5.83576757e+03  3.50983563e+04]
E1 = -182.52266410293223  E_coul = 54.007099608245795
Extra cycle  E= -128.515564494686  delta_E= -2.36e-12  |g|= 1.89e-06  |ddm|= 1.98e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 241.29448672935112
E1 = -182.52266410293223  E_coul = 54.007099608245795
init E= -128.515564494686
    CPU time for initialize scf      0.15 sec, wall time      0.15 sec
  HOMO = -0.847008426517639  LUMO = 0.797106643891699
  mo_energy =
[-3.27822029e+01 -1.93100428e+00 -8.47008427e-01 -8.47008427e-01
 -8.47008427e-01  7.97106644e-01  7.97106644e-01  7.97106644e-01
  2.05945757e+00  3.80907154e+00  3.80907154e+00  3.80907154e+00
  1.42532720e+01  1.42532720e+01  1.42532720e+01  1.94289834e+01
  6.07684971e+01  6.07684971e+01  6.07684971e+01  9.37827970e+01
  3.56046488e+02  1.34936197e+03  5.83576757e+03  3.50983563e+04]
E1 = -182.52267020844945  E_coul = 54.00710571376312
cycle= 1 E= -128.515564494686  delta_E= 8.53e-14  |g|= 8.32e-07  |ddm|= 8.55e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52267020844945  E_coul = 54.00710571376312
  HOMO = -0.84700799292316  LUMO = 0.797106744867233
  mo_energy =
[-3.27822016e+01 -1.93100386e+00 -8.47007993e-01 -8.47007993e-01
 -8.47007993e-01  7.97106745e-01  7.97106745e-01  7.97106745e-01
  2.05945786e+00  3.80907192e+00  3.80907192e+00  3.80907192e+00
  1.42532728e+01  1.42532728e+01  1.42532728e+01  1.94289843e+01
  6.07684983e+01  6.07684983e+01  6.07684983e+01  9.37827983e+01
  3.56046489e+02  1.34936197e+03  5.83576757e+03  3.50983563e+04]
E1 = -182.5226669803869  E_coul = 54.007102485700244
Extra cycle  E= -128.515564494687  delta_E= -3.13e-13  |g|= 4.39e-07  |ddm|= 2.97e-07
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907024e+02
 2.04820550e+01 5.69550815e+01 4.95296146e-01 7.82051426e+00
 1.68412327e+00 2.37056720e+00 7.37520082e+00 2.89820725e+01
 2.64110392e-01 8.14694583e-01]
grad_E = [ 3.31933278e-11 -1.79562084e-09  2.86275733e-08 -5.03431454e-07
 -3.81640106e-05  3.09329919e-06 -3.49547899e-04  3.97380205e-05
  1.85393347e-03 -1.04098470e-02  1.37216069e-03 -1.49013142e-03
 -8.86035666e-03  1.45136698e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682414        1
[INPUT] 0    0    [1    /1   ]  617.498481626        1
[INPUT] 0    0    [1    /1   ]  174.907041572        1
[INPUT] 0    0    [1    /1   ]  20.4831794235        1
[INPUT] 0    0    [1    /1   ]  56.9549660957        1
[INPUT] 0    0    [1    /1   ]  0.506452753752       1
[INPUT] 0    0    [1    /1   ]  7.82003263435        1
[INPUT] 0    0    [1    /1   ]  1.72724245271        1
[INPUT] 1    0    [1    /1   ]  2.36943841995        1
[INPUT] 1    0    [1    /1   ]  7.47372484739        1
[INPUT] 1    0    [1    /1   ]  29.987504664         1
[INPUT] 1    0    [1    /1   ]  0.267895380012       1
[INPUT] 1    0    [1    /1   ]  0.82333242245        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002027, 1.0]], [0, [2712.0968241367486, 1.0]], [0, [617.4984816256816, 1.0]], [0, [174.90704157179638, 1.0]], [0, [20.48317942354558, 1.0]], [0, [56.954966095697266, 1.0]], [0, [0.5064527537519793, 1.0]], [0, [7.820032634350397, 1.0]], [0, [1.7272424527075187, 1.0]], [1, [2.369438419950641, 1.0]], [1, [7.473724847385444, 1.0]], [1, [29.987504664046675, 1.0]], [1, [0.26789538001203145, 1.0]], [1, [0.8233324224498542, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873002]
bas 1, expnt(s) = [2712.09682414]
bas 2, expnt(s) = [617.49848163]
bas 3, expnt(s) = [174.90704157]
bas 4, expnt(s) = [20.48317942]
bas 5, expnt(s) = [56.9549661]
bas 6, expnt(s) = [0.50645275]
bas 7, expnt(s) = [7.82003263]
bas 8, expnt(s) = [1.72724245]
bas 9, expnt(s) = [2.36943842]
bas 10, expnt(s) = [7.47372485]
bas 11, expnt(s) = [29.98750466]
bas 12, expnt(s) = [0.26789538]
bas 13, expnt(s) = [0.82333242]
CPU time:        82.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962242e+02 1.74907042e+02 1.21512371e+02
 2.04831794e+01 2.43255714e+01 5.69549661e+01 5.23797863e+01
 5.06452754e-01 1.51676824e+00 7.82003263e+00 1.18146660e+01
 1.72724245e+00 3.80653653e+00 2.36943842e+00 8.57612644e+00
 7.47372485e+00 3.60500419e+01 2.99875047e+01 2.04719779e+02
 2.67895380e-01 5.62264835e-01 8.23332422e-01 2.28798628e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9989541208918
cond(S) = 244.08317579743172
E1 = -183.5612328082292  E_coul = 55.07833705122569
init E= -128.482895757004
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77205174427114  LUMO = 0.828394372167797
  mo_energy =
[-3.25552046e+01 -1.85131262e+00 -7.72051744e-01 -7.72051744e-01
 -7.72051744e-01  8.28394372e-01  8.28394372e-01  8.28394372e-01
  2.19226481e+00  3.91175987e+00  3.91175987e+00  3.91175987e+00
  1.45039423e+01  1.45039423e+01  1.45039423e+01  1.98056721e+01
  6.26387862e+01  6.26387862e+01  6.26387862e+01  9.42168107e+01
  3.56495036e+02  1.34982109e+03  5.83623358e+03  3.50988156e+04]
E1 = -182.008895174875  E_coul = 53.49616379778872
cycle= 1 E= -128.512731377086  delta_E= -0.0298  |g|= 0.212  |ddm|= 0.173
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.491766
diis-c [-0.2418336  1.       ]
  HOMO = -0.883273768923745  LUMO = 0.801334002317925
  mo_energy =
[-3.28921115e+01 -1.96920422e+00 -8.83273769e-01 -8.83273769e-01
 -8.83273769e-01  8.01334002e-01  8.01334002e-01  8.01334002e-01
  2.10876747e+00  3.81302674e+00  3.81302674e+00  3.81302674e+00
  1.43022899e+01  1.43022899e+01  1.43022899e+01  1.95750410e+01
  6.23300789e+01  6.23300789e+01  6.23300789e+01  9.38999137e+01
  3.56128701e+02  1.34941635e+03  5.83579710e+03  3.50983576e+04]
E1 = -182.7944500727095  E_coul = 54.278916291408564
cycle= 2 E= -128.515533781301  delta_E= -0.0028  |g|= 0.107  |ddm|= 0.0773
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.249854
diis-c [-5.75290959e-04  3.36135443e-01  6.63864557e-01]
  HOMO = -0.846553698302738  LUMO = 0.810295885934179
  mo_energy =
[-3.27806003e+01 -1.93041440e+00 -8.46553698e-01 -8.46553698e-01
 -8.46553698e-01  8.10295886e-01  8.10295886e-01  8.10295886e-01
  2.13599724e+00  3.84534561e+00  3.84534561e+00  3.84534561e+00
  1.43692196e+01  1.43692196e+01  1.43692196e+01  1.96517797e+01
  6.24323716e+01  6.24323716e+01  6.24323716e+01  9.40051378e+01
  3.56247263e+02  1.34954145e+03  5.83592531e+03  3.50984871e+04]
E1 = -182.53003582762506  E_coul = 54.013526852311806
cycle= 3 E= -128.516508975313  delta_E= -0.000975  |g|= 0.000284  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000326306
diis-c [-7.23108828e-08 -1.82861541e-03 -3.02993422e-03  1.00485855e+00]
  HOMO = -0.846689677780852  LUMO = 0.810286218266447
  mo_energy =
[-3.27807915e+01 -1.93055791e+00 -8.46689678e-01 -8.46689678e-01
 -8.46689678e-01  8.10286218e-01  8.10286218e-01  8.10286218e-01
  2.13591652e+00  3.84527207e+00  3.84527207e+00  3.84527207e+00
  1.43690939e+01  1.43690939e+01  1.43690939e+01  1.96516406e+01
  6.24321952e+01  6.24321952e+01  6.24321952e+01  9.40049633e+01
  3.56247048e+02  1.34954118e+03  5.83592499e+03  3.50984867e+04]
E1 = -182.5298380100652  E_coul = 54.0133290222609
cycle= 4 E= -128.516508987804  delta_E= -1.25e-08  |g|= 5.49e-05  |ddm|= 0.000197
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.38438e-05
diis-c [-7.11617399e-10  1.10275700e-04  4.15463708e-04 -1.38187692e-01
  1.13766195e+00]
  HOMO = -0.846716673828514  LUMO = 0.81027628391422
  mo_energy =
[-3.27808333e+01 -1.93059378e+00 -8.46716674e-01 -8.46716674e-01
 -8.46716674e-01  8.10276284e-01  8.10276284e-01  8.10276284e-01
  2.13588552e+00  3.84524417e+00  3.84524417e+00  3.84524417e+00
  1.43690546e+01  1.43690546e+01  1.43690546e+01  1.96515977e+01
  6.24321531e+01  6.24321531e+01  6.24321531e+01  9.40049216e+01
  3.56247011e+02  1.34954115e+03  5.83592496e+03  3.50984867e+04]
E1 = -182.52989353683074  E_coul = 54.01338454867566
cycle= 5 E= -128.516508988155  delta_E= -3.51e-10  |g|= 4.93e-06  |ddm|= 3.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52989353683074  E_coul = 54.01338454867566
  HOMO = -0.846714328157009  LUMO = 0.810276816854822
  mo_energy =
[-3.27808271e+01 -1.93059213e+00 -8.46714328e-01 -8.46714328e-01
 -8.46714328e-01  8.10276817e-01  8.10276817e-01  8.10276817e-01
  2.13588662e+00  3.84524617e+00  3.84524617e+00  3.84524617e+00
  1.43690585e+01  1.43690585e+01  1.43690585e+01  1.96516020e+01
  6.24321588e+01  6.24321588e+01  6.24321588e+01  9.40049274e+01
  3.56247018e+02  1.34954115e+03  5.83592497e+03  3.50984867e+04]
E1 = -182.5298765744188  E_coul = 54.01336758626114
Extra cycle  E= -128.516508988158  delta_E= -2.61e-12  |g|= 2.43e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907042e+02
 2.04831794e+01 5.69549661e+01 5.06452754e-01 7.82003263e+00
 1.72724245e+00 2.36943842e+00 7.47372485e+00 2.99875047e+01
 2.67895380e-01 8.23332422e-01]
E = -128.51650898815768
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682414        1
[INPUT] 0    0    [1    /1   ]  617.498481626        1
[INPUT] 0    0    [1    /1   ]  174.907041572        1
[INPUT] 0    0    [1    /1   ]  20.4831794235        1
[INPUT] 0    0    [1    /1   ]  56.9549660957        1
[INPUT] 0    0    [1    /1   ]  0.506452753752       1
[INPUT] 0    0    [1    /1   ]  7.82003263435        1
[INPUT] 0    0    [1    /1   ]  1.72724245271        1
[INPUT] 1    0    [1    /1   ]  2.36943841995        1
[INPUT] 1    0    [1    /1   ]  7.47372484739        1
[INPUT] 1    0    [1    /1   ]  29.987504664         1
[INPUT] 1    0    [1    /1   ]  0.267895380012       1
[INPUT] 1    0    [1    /1   ]  0.82333242245        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873002027, 1.0]], [0, [2712.0968241367486, 1.0]], [0, [617.4984816256816, 1.0]], [0, [174.90704157179638, 1.0]], [0, [20.48317942354558, 1.0]], [0, [56.954966095697266, 1.0]], [0, [0.5064527537519793, 1.0]], [0, [7.820032634350397, 1.0]], [0, [1.7272424527075187, 1.0]], [1, [2.369438419950641, 1.0]], [1, [7.473724847385444, 1.0]], [1, [29.987504664046675, 1.0]], [1, [0.26789538001203145, 1.0]], [1, [0.8233324224498542, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873002]
bas 1, expnt(s) = [2712.09682414]
bas 2, expnt(s) = [617.49848163]
bas 3, expnt(s) = [174.90704157]
bas 4, expnt(s) = [20.48317942]
bas 5, expnt(s) = [56.9549661]
bas 6, expnt(s) = [0.50645275]
bas 7, expnt(s) = [7.82003263]
bas 8, expnt(s) = [1.72724245]
bas 9, expnt(s) = [2.36943842]
bas 10, expnt(s) = [7.47372485]
bas 11, expnt(s) = [29.98750466]
bas 12, expnt(s) = [0.26789538]
bas 13, expnt(s) = [0.82333242]
CPU time:        83.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962242e+02 1.74907042e+02 1.21512371e+02
 2.04831794e+01 2.43255714e+01 5.69549661e+01 5.23797863e+01
 5.06452754e-01 1.51676824e+00 7.82003263e+00 1.18146660e+01
 1.72724245e+00 3.80653653e+00 2.36943842e+00 8.57612644e+00
 7.47372485e+00 3.60500419e+01 2.99875047e+01 2.04719779e+02
 2.67895380e-01 5.62264835e-01 8.23332422e-01 2.28798628e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9989541208918
cond(S) = 244.08317579743172
E1 = -183.5612328082292  E_coul = 55.07833705122569
init E= -128.482895757004
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77205174427114  LUMO = 0.828394372167797
  mo_energy =
[-3.25552046e+01 -1.85131262e+00 -7.72051744e-01 -7.72051744e-01
 -7.72051744e-01  8.28394372e-01  8.28394372e-01  8.28394372e-01
  2.19226481e+00  3.91175987e+00  3.91175987e+00  3.91175987e+00
  1.45039423e+01  1.45039423e+01  1.45039423e+01  1.98056721e+01
  6.26387862e+01  6.26387862e+01  6.26387862e+01  9.42168107e+01
  3.56495036e+02  1.34982109e+03  5.83623358e+03  3.50988156e+04]
E1 = -182.008895174875  E_coul = 53.49616379778872
cycle= 1 E= -128.512731377086  delta_E= -0.0298  |g|= 0.212  |ddm|= 0.173
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.491766
diis-c [-0.2418336  1.       ]
  HOMO = -0.883273768923745  LUMO = 0.801334002317925
  mo_energy =
[-3.28921115e+01 -1.96920422e+00 -8.83273769e-01 -8.83273769e-01
 -8.83273769e-01  8.01334002e-01  8.01334002e-01  8.01334002e-01
  2.10876747e+00  3.81302674e+00  3.81302674e+00  3.81302674e+00
  1.43022899e+01  1.43022899e+01  1.43022899e+01  1.95750410e+01
  6.23300789e+01  6.23300789e+01  6.23300789e+01  9.38999137e+01
  3.56128701e+02  1.34941635e+03  5.83579710e+03  3.50983576e+04]
E1 = -182.7944500727095  E_coul = 54.278916291408564
cycle= 2 E= -128.515533781301  delta_E= -0.0028  |g|= 0.107  |ddm|= 0.0773
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.249854
diis-c [-5.75290959e-04  3.36135443e-01  6.63864557e-01]
  HOMO = -0.846553698302738  LUMO = 0.810295885934179
  mo_energy =
[-3.27806003e+01 -1.93041440e+00 -8.46553698e-01 -8.46553698e-01
 -8.46553698e-01  8.10295886e-01  8.10295886e-01  8.10295886e-01
  2.13599724e+00  3.84534561e+00  3.84534561e+00  3.84534561e+00
  1.43692196e+01  1.43692196e+01  1.43692196e+01  1.96517797e+01
  6.24323716e+01  6.24323716e+01  6.24323716e+01  9.40051378e+01
  3.56247263e+02  1.34954145e+03  5.83592531e+03  3.50984871e+04]
E1 = -182.53003582762506  E_coul = 54.013526852311806
cycle= 3 E= -128.516508975313  delta_E= -0.000975  |g|= 0.000284  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000326306
diis-c [-7.23108828e-08 -1.82861541e-03 -3.02993422e-03  1.00485855e+00]
  HOMO = -0.846689677780852  LUMO = 0.810286218266447
  mo_energy =
[-3.27807915e+01 -1.93055791e+00 -8.46689678e-01 -8.46689678e-01
 -8.46689678e-01  8.10286218e-01  8.10286218e-01  8.10286218e-01
  2.13591652e+00  3.84527207e+00  3.84527207e+00  3.84527207e+00
  1.43690939e+01  1.43690939e+01  1.43690939e+01  1.96516406e+01
  6.24321952e+01  6.24321952e+01  6.24321952e+01  9.40049633e+01
  3.56247048e+02  1.34954118e+03  5.83592499e+03  3.50984867e+04]
E1 = -182.5298380100652  E_coul = 54.0133290222609
cycle= 4 E= -128.516508987804  delta_E= -1.25e-08  |g|= 5.49e-05  |ddm|= 0.000197
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.38438e-05
diis-c [-7.11617399e-10  1.10275700e-04  4.15463708e-04 -1.38187692e-01
  1.13766195e+00]
  HOMO = -0.846716673828514  LUMO = 0.81027628391422
  mo_energy =
[-3.27808333e+01 -1.93059378e+00 -8.46716674e-01 -8.46716674e-01
 -8.46716674e-01  8.10276284e-01  8.10276284e-01  8.10276284e-01
  2.13588552e+00  3.84524417e+00  3.84524417e+00  3.84524417e+00
  1.43690546e+01  1.43690546e+01  1.43690546e+01  1.96515977e+01
  6.24321531e+01  6.24321531e+01  6.24321531e+01  9.40049216e+01
  3.56247011e+02  1.34954115e+03  5.83592496e+03  3.50984867e+04]
E1 = -182.52989353683074  E_coul = 54.01338454867566
cycle= 5 E= -128.516508988155  delta_E= -3.51e-10  |g|= 4.93e-06  |ddm|= 3.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52989353683074  E_coul = 54.01338454867566
  HOMO = -0.846714328157009  LUMO = 0.810276816854822
  mo_energy =
[-3.27808271e+01 -1.93059213e+00 -8.46714328e-01 -8.46714328e-01
 -8.46714328e-01  8.10276817e-01  8.10276817e-01  8.10276817e-01
  2.13588662e+00  3.84524617e+00  3.84524617e+00  3.84524617e+00
  1.43690585e+01  1.43690585e+01  1.43690585e+01  1.96516020e+01
  6.24321588e+01  6.24321588e+01  6.24321588e+01  9.40049274e+01
  3.56247018e+02  1.34954115e+03  5.83592497e+03  3.50984867e+04]
E1 = -182.5298765744188  E_coul = 54.01336758626114
Extra cycle  E= -128.516508988158  delta_E= -2.61e-12  |g|= 2.43e-06  |ddm|= 2.05e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 244.08317579743172
E1 = -182.5298765744188  E_coul = 54.01336758626114
init E= -128.516508988158
    CPU time for initialize scf      0.15 sec, wall time      0.15 sec
  HOMO = -0.846715503028668  LUMO = 0.810276516035831
  mo_energy =
[-3.27808307e+01 -1.93059354e+00 -8.46715503e-01 -8.46715503e-01
 -8.46715503e-01  8.10276516e-01  8.10276516e-01  8.10276516e-01
  2.13588560e+00  3.84524511e+00  3.84524511e+00  3.84524511e+00
  1.43690564e+01  1.43690564e+01  1.43690564e+01  1.96515995e+01
  6.24321555e+01  6.24321555e+01  6.24321555e+01  9.40049241e+01
  3.56247014e+02  1.34954115e+03  5.83592496e+03  3.50984867e+04]
E1 = -182.5298847633046  E_coul = 54.013375775146315
cycle= 1 E= -128.516508988158  delta_E= -6.25e-13  |g|= 1.11e-06  |ddm|= 1.07e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5298847633046  E_coul = 54.013375775146315
  HOMO = -0.846714921309684  LUMO = 0.810276655565148
  mo_energy =
[-3.27808289e+01 -1.93059296e+00 -8.46714921e-01 -8.46714921e-01
 -8.46714921e-01  8.10276656e-01  8.10276656e-01  8.10276656e-01
  2.13588600e+00  3.84524562e+00  3.84524562e+00  3.84524562e+00
  1.43690574e+01  1.43690574e+01  1.43690574e+01  1.96516007e+01
  6.24321571e+01  6.24321571e+01  6.24321571e+01  9.40049257e+01
  3.56247016e+02  1.34954115e+03  5.83592496e+03  3.50984867e+04]
E1 = -182.5298804893735  E_coul = 54.013371501215275
Extra cycle  E= -128.516508988158  delta_E= 5.68e-14  |g|= 5.81e-07  |ddm|= 3.96e-07
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907042e+02
 2.04831794e+01 5.69549661e+01 5.06452754e-01 7.82003263e+00
 1.72724245e+00 2.36943842e+00 7.47372485e+00 2.99875047e+01
 2.67895380e-01 8.23332422e-01]
grad_E = [ 5.94331512e-11 -3.47859201e-09  5.43498593e-08 -9.95539961e-07
 -8.09732412e-05  6.13740972e-06  7.15479321e-04  8.84834360e-05
  3.89234748e-03 -1.54947199e-02  1.75209924e-03 -1.21563280e-03
 -1.42164465e-02  2.28075259e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682427        1
[INPUT] 0    0    [1    /1   ]  617.498479724        1
[INPUT] 0    0    [1    /1   ]  174.907083151        1
[INPUT] 0    0    [1    /1   ]  20.4858730559        1
[INPUT] 0    0    [1    /1   ]  56.9546910833        1
[INPUT] 0    0    [1    /1   ]  0.52837645732        1
[INPUT] 0    0    [1    /1   ]  7.81884334321        1
[INPUT] 0    0    [1    /1   ]  1.81524725861        1
[INPUT] 1    0    [1    /1   ]  2.47989964686        1
[INPUT] 1    0    [1    /1   ]  7.89238232881        1
[INPUT] 1    0    [1    /1   ]  32.2399540938        1
[INPUT] 1    0    [1    /1   ]  0.280161129524       1
[INPUT] 1    0    [1    /1   ]  0.866821827762       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730012608, 1.0]], [0, [2712.096824268292, 1.0]], [0, [617.4984797239657, 1.0]], [0, [174.90708315105286, 1.0]], [0, [20.48587305586148, 1.0]], [0, [56.95469108327148, 1.0]], [0, [0.5283764573200245, 1.0]], [0, [7.818843343205792, 1.0]], [0, [1.8152472586053956, 1.0]], [1, [2.4798996468644683, 1.0]], [1, [7.892382328809361, 1.0]], [1, [32.2399540937833, 1.0]], [1, [0.28016112952392636, 1.0]], [1, [0.8668218277617663, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873001]
bas 1, expnt(s) = [2712.09682427]
bas 2, expnt(s) = [617.49847972]
bas 3, expnt(s) = [174.90708315]
bas 4, expnt(s) = [20.48587306]
bas 5, expnt(s) = [56.95469108]
bas 6, expnt(s) = [0.52837646]
bas 7, expnt(s) = [7.81884334]
bas 8, expnt(s) = [1.81524726]
bas 9, expnt(s) = [2.47989965]
bas 10, expnt(s) = [7.89238233]
bas 11, expnt(s) = [32.23995409]
bas 12, expnt(s) = [0.28016113]
bas 13, expnt(s) = [0.86682183]
CPU time:        86.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498480e+02 3.12962242e+02 1.74907083e+02 1.21512393e+02
 2.04858731e+01 2.43279706e+01 5.69546911e+01 5.23795966e+01
 5.28376457e-01 1.56575071e+00 7.81884334e+00 1.18133184e+01
 1.81524726e+00 3.95108949e+00 2.47989965e+00 9.07877025e+00
 7.89238233e+00 3.85917557e+01 3.22399541e+01 2.24118347e+02
 2.80161130e-01 5.94626476e-01 8.66821828e-01 2.44003857e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998645734924256
cond(S) = 249.9461936406213
E1 = -183.56396038325244  E_coul = 55.079259976820865
init E= -128.484700406432
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.772387592452329  LUMO = 0.876893899430993
  mo_energy =
[-3.25549500e+01 -1.85095241e+00 -7.72387592e-01 -7.72387592e-01
 -7.72387592e-01  8.76893899e-01  8.76893899e-01  8.76893899e-01
  2.34946424e+00  4.13212272e+00  4.13212272e+00  4.13212272e+00
  1.53555508e+01  1.53555508e+01  1.53555508e+01  2.02510391e+01
  6.74620838e+01  6.74620838e+01  6.74620838e+01  9.46649821e+01
  3.56900400e+02  1.35018302e+03  5.83655105e+03  3.50990781e+04]
E1 = -182.04016360809607  E_coul = 53.525337275945496
cycle= 1 E= -128.514826332151  delta_E= -0.0301  |g|= 0.208  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.48056
diis-c [-0.23093839  1.        ]
  HOMO = -0.881464970818688  LUMO = 0.848484389960371
  mo_energy =
[-3.28862097e+01 -1.96688353e+00 -8.81464971e-01 -8.81464971e-01
 -8.81464971e-01  8.48484390e-01  8.48484390e-01  8.48484390e-01
  2.26356284e+00  4.03129270e+00  4.03129270e+00  4.03129270e+00
  1.51526863e+01  1.51526863e+01  1.51526863e+01  2.00241077e+01
  6.71544724e+01  6.71544724e+01  6.71544724e+01  9.43535752e+01
  3.56540026e+02  1.34978452e+03  5.83612094e+03  3.50986265e+04]
E1 = -182.8077639289701  E_coul = 54.29023219482812
cycle= 2 E= -128.517531734142  delta_E= -0.00271  |g|= 0.104  |ddm|= 0.0764
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.243308
diis-c [-5.78105647e-04  3.35306640e-01  6.64693360e-01]
  HOMO = -0.845585572903391  LUMO = 0.857874228102444
  mo_energy =
[-3.27769481e+01 -1.92895814e+00 -8.45585573e-01 -8.45585573e-01
 -8.45585573e-01  8.57874228e-01  8.57874228e-01  8.57874228e-01
  2.29143293e+00  4.06419275e+00  4.06419275e+00  4.06419275e+00
  1.52198086e+01  1.52198086e+01  1.52198086e+01  2.00993194e+01
  6.72559522e+01  6.72559522e+01  6.72559522e+01  9.44566157e+01
  3.56656232e+02  1.34990719e+03  5.83624669e+03  3.50987534e+04]
E1 = -182.54983010112144  E_coul = 54.031366192796305
cycle= 3 E= -128.518463908325  delta_E= -0.000932  |g|= 0.000323  |ddm|= 0.0259
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000359624
diis-c [-9.19159763e-08 -2.03129419e-03 -3.43457144e-03  1.00546587e+00]
  HOMO = -0.845732457274937  LUMO = 0.857857570430872
  mo_energy =
[-3.27771529e+01 -1.92912737e+00 -8.45732457e-01 -8.45732457e-01
 -8.45732457e-01  8.57857570e-01  8.57857570e-01  8.57857570e-01
  2.29132525e+00  4.06410186e+00  4.06410186e+00  4.06410186e+00
  1.52196621e+01  1.52196621e+01  1.52196621e+01  2.00991555e+01
  6.72557572e+01  6.72557572e+01  6.72557572e+01  9.44564257e+01
  3.56656012e+02  1.34990692e+03  5.83624638e+03  3.50987531e+04]
E1 = -182.5496765336041  E_coul = 54.03121261040405
cycle= 4 E= -128.5184639232  delta_E= -1.49e-08  |g|= 5.68e-05  |ddm|= 0.000211
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.42023e-05
diis-c [-7.72048584e-10  1.72593871e-04  4.29915579e-04 -1.65630549e-01
  1.16502804e+00]
  HOMO = -0.845757670434371  LUMO = 0.85784735811372
  mo_energy =
[-3.27771891e+01 -1.92916442e+00 -8.45757670e-01 -8.45757670e-01
 -8.45757670e-01  8.57847358e-01  8.57847358e-01  8.57847358e-01
  2.29129205e+00  4.06407460e+00  4.06407460e+00  4.06407460e+00
  1.52196253e+01  1.52196253e+01  1.52196253e+01  2.00991151e+01
  6.72557201e+01  6.72557201e+01  6.72557201e+01  9.44563891e+01
  3.56655983e+02  1.34990690e+03  5.83624636e+03  3.50987531e+04]
E1 = -182.54971518636577  E_coul = 54.031251262756705
cycle= 5 E= -128.518463923609  delta_E= -4.09e-10  |g|= 5.87e-06  |ddm|= 4.01e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.54971518636577  E_coul = 54.031251262756705
  HOMO = -0.845754457469288  LUMO = 0.857848229219041
  mo_energy =
[-3.27771811e+01 -1.92916183e+00 -8.45754457e-01 -8.45754457e-01
 -8.45754457e-01  8.57848229e-01  8.57848229e-01  8.57848229e-01
  2.29129401e+00  4.06407756e+00  4.06407756e+00  4.06407756e+00
  1.52196307e+01  1.52196307e+01  1.52196307e+01  2.00991208e+01
  6.72557275e+01  6.72557275e+01  6.72557275e+01  9.44563967e+01
  3.56655991e+02  1.34990691e+03  5.83624637e+03  3.50987531e+04]
E1 = -182.54969501548928  E_coul = 54.031231091876876
Extra cycle  E= -128.518463923612  delta_E= -3.33e-12  |g|= 2.87e-06  |ddm|= 1.96e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498480e+02 1.74907083e+02
 2.04858731e+01 5.69546911e+01 5.28376457e-01 7.81884334e+00
 1.81524726e+00 2.47989965e+00 7.89238233e+00 3.22399541e+01
 2.80161130e-01 8.66821828e-01]
E = -128.5184639236124
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682427        1
[INPUT] 0    0    [1    /1   ]  617.498479724        1
[INPUT] 0    0    [1    /1   ]  174.907083151        1
[INPUT] 0    0    [1    /1   ]  20.4858730559        1
[INPUT] 0    0    [1    /1   ]  56.9546910833        1
[INPUT] 0    0    [1    /1   ]  0.52837645732        1
[INPUT] 0    0    [1    /1   ]  7.81884334321        1
[INPUT] 0    0    [1    /1   ]  1.81524725861        1
[INPUT] 1    0    [1    /1   ]  2.47989964686        1
[INPUT] 1    0    [1    /1   ]  7.89238232881        1
[INPUT] 1    0    [1    /1   ]  32.2399540938        1
[INPUT] 1    0    [1    /1   ]  0.280161129524       1
[INPUT] 1    0    [1    /1   ]  0.866821827762       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730012608, 1.0]], [0, [2712.096824268292, 1.0]], [0, [617.4984797239657, 1.0]], [0, [174.90708315105286, 1.0]], [0, [20.48587305586148, 1.0]], [0, [56.95469108327148, 1.0]], [0, [0.5283764573200245, 1.0]], [0, [7.818843343205792, 1.0]], [0, [1.8152472586053956, 1.0]], [1, [2.4798996468644683, 1.0]], [1, [7.892382328809361, 1.0]], [1, [32.2399540937833, 1.0]], [1, [0.28016112952392636, 1.0]], [1, [0.8668218277617663, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873001]
bas 1, expnt(s) = [2712.09682427]
bas 2, expnt(s) = [617.49847972]
bas 3, expnt(s) = [174.90708315]
bas 4, expnt(s) = [20.48587306]
bas 5, expnt(s) = [56.95469108]
bas 6, expnt(s) = [0.52837646]
bas 7, expnt(s) = [7.81884334]
bas 8, expnt(s) = [1.81524726]
bas 9, expnt(s) = [2.47989965]
bas 10, expnt(s) = [7.89238233]
bas 11, expnt(s) = [32.23995409]
bas 12, expnt(s) = [0.28016113]
bas 13, expnt(s) = [0.86682183]
CPU time:        86.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498480e+02 3.12962242e+02 1.74907083e+02 1.21512393e+02
 2.04858731e+01 2.43279706e+01 5.69546911e+01 5.23795966e+01
 5.28376457e-01 1.56575071e+00 7.81884334e+00 1.18133184e+01
 1.81524726e+00 3.95108949e+00 2.47989965e+00 9.07877025e+00
 7.89238233e+00 3.85917557e+01 3.22399541e+01 2.24118347e+02
 2.80161130e-01 5.94626476e-01 8.66821828e-01 2.44003857e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998645734924256
cond(S) = 249.9461936406213
E1 = -183.56396038325244  E_coul = 55.079259976820865
init E= -128.484700406432
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.772387592452329  LUMO = 0.876893899430993
  mo_energy =
[-3.25549500e+01 -1.85095241e+00 -7.72387592e-01 -7.72387592e-01
 -7.72387592e-01  8.76893899e-01  8.76893899e-01  8.76893899e-01
  2.34946424e+00  4.13212272e+00  4.13212272e+00  4.13212272e+00
  1.53555508e+01  1.53555508e+01  1.53555508e+01  2.02510391e+01
  6.74620838e+01  6.74620838e+01  6.74620838e+01  9.46649821e+01
  3.56900400e+02  1.35018302e+03  5.83655105e+03  3.50990781e+04]
E1 = -182.04016360809607  E_coul = 53.525337275945496
cycle= 1 E= -128.514826332151  delta_E= -0.0301  |g|= 0.208  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.48056
diis-c [-0.23093839  1.        ]
  HOMO = -0.881464970818688  LUMO = 0.848484389960371
  mo_energy =
[-3.28862097e+01 -1.96688353e+00 -8.81464971e-01 -8.81464971e-01
 -8.81464971e-01  8.48484390e-01  8.48484390e-01  8.48484390e-01
  2.26356284e+00  4.03129270e+00  4.03129270e+00  4.03129270e+00
  1.51526863e+01  1.51526863e+01  1.51526863e+01  2.00241077e+01
  6.71544724e+01  6.71544724e+01  6.71544724e+01  9.43535752e+01
  3.56540026e+02  1.34978452e+03  5.83612094e+03  3.50986265e+04]
E1 = -182.8077639289701  E_coul = 54.29023219482812
cycle= 2 E= -128.517531734142  delta_E= -0.00271  |g|= 0.104  |ddm|= 0.0764
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.243308
diis-c [-5.78105647e-04  3.35306640e-01  6.64693360e-01]
  HOMO = -0.845585572903391  LUMO = 0.857874228102444
  mo_energy =
[-3.27769481e+01 -1.92895814e+00 -8.45585573e-01 -8.45585573e-01
 -8.45585573e-01  8.57874228e-01  8.57874228e-01  8.57874228e-01
  2.29143293e+00  4.06419275e+00  4.06419275e+00  4.06419275e+00
  1.52198086e+01  1.52198086e+01  1.52198086e+01  2.00993194e+01
  6.72559522e+01  6.72559522e+01  6.72559522e+01  9.44566157e+01
  3.56656232e+02  1.34990719e+03  5.83624669e+03  3.50987534e+04]
E1 = -182.54983010112144  E_coul = 54.031366192796305
cycle= 3 E= -128.518463908325  delta_E= -0.000932  |g|= 0.000323  |ddm|= 0.0259
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000359624
diis-c [-9.19159763e-08 -2.03129419e-03 -3.43457144e-03  1.00546587e+00]
  HOMO = -0.845732457274937  LUMO = 0.857857570430872
  mo_energy =
[-3.27771529e+01 -1.92912737e+00 -8.45732457e-01 -8.45732457e-01
 -8.45732457e-01  8.57857570e-01  8.57857570e-01  8.57857570e-01
  2.29132525e+00  4.06410186e+00  4.06410186e+00  4.06410186e+00
  1.52196621e+01  1.52196621e+01  1.52196621e+01  2.00991555e+01
  6.72557572e+01  6.72557572e+01  6.72557572e+01  9.44564257e+01
  3.56656012e+02  1.34990692e+03  5.83624638e+03  3.50987531e+04]
E1 = -182.5496765336041  E_coul = 54.03121261040405
cycle= 4 E= -128.5184639232  delta_E= -1.49e-08  |g|= 5.68e-05  |ddm|= 0.000211
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.42023e-05
diis-c [-7.72048584e-10  1.72593871e-04  4.29915579e-04 -1.65630549e-01
  1.16502804e+00]
  HOMO = -0.845757670434371  LUMO = 0.85784735811372
  mo_energy =
[-3.27771891e+01 -1.92916442e+00 -8.45757670e-01 -8.45757670e-01
 -8.45757670e-01  8.57847358e-01  8.57847358e-01  8.57847358e-01
  2.29129205e+00  4.06407460e+00  4.06407460e+00  4.06407460e+00
  1.52196253e+01  1.52196253e+01  1.52196253e+01  2.00991151e+01
  6.72557201e+01  6.72557201e+01  6.72557201e+01  9.44563891e+01
  3.56655983e+02  1.34990690e+03  5.83624636e+03  3.50987531e+04]
E1 = -182.54971518636577  E_coul = 54.031251262756705
cycle= 5 E= -128.518463923609  delta_E= -4.09e-10  |g|= 5.87e-06  |ddm|= 4.01e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.54971518636577  E_coul = 54.031251262756705
  HOMO = -0.845754457469288  LUMO = 0.857848229219041
  mo_energy =
[-3.27771811e+01 -1.92916183e+00 -8.45754457e-01 -8.45754457e-01
 -8.45754457e-01  8.57848229e-01  8.57848229e-01  8.57848229e-01
  2.29129401e+00  4.06407756e+00  4.06407756e+00  4.06407756e+00
  1.52196307e+01  1.52196307e+01  1.52196307e+01  2.00991208e+01
  6.72557275e+01  6.72557275e+01  6.72557275e+01  9.44563967e+01
  3.56655991e+02  1.34990691e+03  5.83624637e+03  3.50987531e+04]
E1 = -182.54969501548928  E_coul = 54.031231091876876
Extra cycle  E= -128.518463923612  delta_E= -3.33e-12  |g|= 2.87e-06  |ddm|= 1.96e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 249.9461936406213
E1 = -182.54969501548928  E_coul = 54.031231091876876
init E= -128.518463923612
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.845755845987418  LUMO = 0.857847859359402
  mo_energy =
[-3.27771854e+01 -1.92916346e+00 -8.45755846e-01 -8.45755846e-01
 -8.45755846e-01  8.57847859e-01  8.57847859e-01  8.57847859e-01
  2.29129280e+00  4.06407627e+00  4.06407627e+00  4.06407627e+00
  1.52196281e+01  1.52196281e+01  1.52196281e+01  2.00991178e+01
  6.72557235e+01  6.72557235e+01  6.72557235e+01  9.44563926e+01
  3.56655986e+02  1.34990691e+03  5.83624637e+03  3.50987531e+04]
E1 = -182.5497050626728  E_coul = 54.03124113906026
cycle= 1 E= -128.518463923613  delta_E= -1.71e-13  |g|= 1.36e-06  |ddm|= 1.23e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5497050626728  E_coul = 54.03124113906026
  HOMO = -0.845755133088102  LUMO = 0.857848044734506
  mo_energy =
[-3.27771833e+01 -1.92916273e+00 -8.45755133e-01 -8.45755133e-01
 -8.45755133e-01  8.57848045e-01  8.57848045e-01  8.57848045e-01
  2.29129333e+00  4.06407692e+00  4.06407692e+00  4.06407692e+00
  1.52196294e+01  1.52196294e+01  1.52196294e+01  2.00991193e+01
  6.72557255e+01  6.72557255e+01  6.72557255e+01  9.44563946e+01
  3.56655989e+02  1.34990691e+03  5.83624637e+03  3.50987531e+04]
E1 = -182.5496998959758  E_coul = 54.031235972363056
Extra cycle  E= -128.518463923613  delta_E= -1.99e-13  |g|= 7.03e-07  |ddm|= 4.91e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498480e+02 1.74907083e+02
 2.04858731e+01 5.69546911e+01 5.28376457e-01 7.81884334e+00
 1.81524726e+00 2.47989965e+00 7.89238233e+00 3.22399541e+01
 2.80161130e-01 8.66821828e-01]
grad_E = [ 8.56991101e-11 -5.31572507e-09  7.97803502e-08 -1.59650191e-06
 -1.47133104e-04  1.01414923e-05  4.64004358e-03  1.82370938e-04
  6.71234913e-03 -1.78342015e-02  1.83521672e-03 -8.61566707e-04
 -1.55458340e-02  2.80777463e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682448        1
[INPUT] 0    0    [1    /1   ]  617.498476556        1
[INPUT] 0    0    [1    /1   ]  174.907150255        1
[INPUT] 0    0    [1    /1   ]  20.4902162199        1
[INPUT] 0    0    [1    /1   ]  56.9542490174        1
[INPUT] 0    0    [1    /1   ]  0.553192524205       1
[INPUT] 0    0    [1    /1   ]  7.81669576122        1
[INPUT] 0    0    [1    /1   ]  1.92995155964        1
[INPUT] 1    0    [1    /1   ]  2.71348159561        1
[INPUT] 1    0    [1    /1   ]  8.67832749296        1
[INPUT] 1    0    [1    /1   ]  35.5716833316        1
[INPUT] 1    0    [1    /1   ]  0.293256351258       1
[INPUT] 1    0    [1    /1   ]  0.927272113792       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730000832, 1.0]], [0, [2712.096824483828, 1.0]], [0, [617.4984765563743, 1.0]], [0, [174.90715025469723, 1.0]], [0, [20.490216219852993, 1.0]], [0, [56.95424901742764, 1.0]], [0, [0.5531925242045593, 1.0]], [0, [7.816695761221333, 1.0]], [0, [1.9299515596377863, 1.0]], [1, [2.7134815956080938, 1.0]], [1, [8.678327492958791, 1.0]], [1, [35.57168333158552, 1.0]], [1, [0.2932563512584218, 1.0]], [1, [0.9272721137920086, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873]
bas 1, expnt(s) = [2712.09682448]
bas 2, expnt(s) = [617.49847656]
bas 3, expnt(s) = [174.90715025]
bas 4, expnt(s) = [20.49021622]
bas 5, expnt(s) = [56.95424902]
bas 6, expnt(s) = [0.55319252]
bas 7, expnt(s) = [7.81669576]
bas 8, expnt(s) = [1.92995156]
bas 9, expnt(s) = [2.7134816]
bas 10, expnt(s) = [8.67832749]
bas 11, expnt(s) = [35.57168333]
bas 12, expnt(s) = [0.29325635]
bas 13, expnt(s) = [0.92727211]
CPU time:        89.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498477e+02 3.12962240e+02 1.74907150e+02 1.21512428e+02
 2.04902162e+01 2.43318388e+01 5.69542490e+01 5.23792917e+01
 5.53192524e-01 1.62058663e+00 7.81669576e+00 1.18108847e+01
 1.92995156e+00 4.13689817e+00 2.71348160e+00 1.01599833e+01
 8.67832749e+00 4.34539676e+01 3.55716833e+01 2.53434021e+02
 2.93256351e-01 6.29569494e-01 9.27272114e-01 2.65456517e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998215092677857
cond(S) = 257.7829297547909
E1 = -183.56722129477438  E_coul = 55.08064816179885
init E= -128.486573132976
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.772813413291785  LUMO = 0.93432086568451
  mo_energy =
[-3.25546992e+01 -1.85025841e+00 -7.72813413e-01 -7.72813413e-01
 -7.72813413e-01  9.34320866e-01  9.34320866e-01  9.34320866e-01
  2.54415339e+00  4.47197452e+00  4.47197452e+00  4.47197452e+00
  1.69534854e+01  1.69534854e+01  1.69534854e+01  2.08070690e+01
  7.54147304e+01  7.54147304e+01  7.54147304e+01  9.52346322e+01
  3.57418435e+02  1.35064620e+03  5.83695746e+03  3.50994140e+04]
E1 = -182.08005649043497  E_coul = 53.56272326482867
cycle= 1 E= -128.517333225606  delta_E= -0.0308  |g|= 0.204  |ddm|= 0.177
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.466532
diis-c [-0.21765209  1.        ]
  HOMO = -0.879208815814215  LUMO = 0.904345065114313
  mo_energy =
[-3.28786319e+01 -1.96365776e+00 -8.79208816e-01 -8.79208816e-01
 -8.79208816e-01  9.04345065e-01  9.04345065e-01  9.04345065e-01
  2.45578666e+00  4.36675033e+00  4.36675033e+00  4.36675033e+00
  1.67466225e+01  1.67466225e+01  1.67466225e+01  2.05847825e+01
  7.51086856e+01  7.51086856e+01  7.51086856e+01  9.49302980e+01
  3.57065761e+02  1.35025569e+03  5.83653548e+03  3.50989707e+04]
E1 = -182.8258954338508  E_coul = 54.30597450841791
cycle= 2 E= -128.519920925433  delta_E= -0.00259  |g|= 0.102  |ddm|= 0.0756
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.234979
diis-c [-5.79149873e-04  3.34083717e-01  6.65916283e-01]
  HOMO = -0.84433612905658  LUMO = 0.914269497704054
  mo_energy =
[-3.27720917e+01 -1.92676028e+00 -8.44336129e-01 -8.44336129e-01
 -8.44336129e-01  9.14269498e-01  9.14269498e-01  9.14269498e-01
  2.48435535e+00  4.40101415e+00  4.40101415e+00  4.40101415e+00
  1.68148840e+01  1.68148840e+01  1.68148840e+01  2.06581735e+01
  7.52092330e+01  7.52092330e+01  7.52092330e+01  9.50307015e+01
  3.57179104e+02  1.35037539e+03  5.83665821e+03  3.50990946e+04]
E1 = -182.5760250630433  E_coul = 54.05522400349518
cycle= 3 E= -128.520801059548  delta_E= -0.00088  |g|= 0.000323  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000377991
diis-c [-9.17715039e-08 -2.17120255e-03 -3.55399365e-03  1.00572520e+00]
  HOMO = -0.844484793491818  LUMO = 0.914251416265415
  mo_energy =
[-3.27723058e+01 -1.92693750e+00 -8.44484793e-01 -8.44484793e-01
 -8.44484793e-01  9.14251416e-01  9.14251416e-01  9.14251416e-01
  2.48423624e+00  4.40091506e+00  4.40091506e+00  4.40091506e+00
  1.68147240e+01  1.68147240e+01  1.68147240e+01  2.06579945e+01
  7.52090245e+01  7.52090245e+01  7.52090245e+01  9.50305005e+01
  3.57178877e+02  1.35037513e+03  5.83665790e+03  3.50990942e+04]
E1 = -182.5759712058551  E_coul = 54.05517013354767
cycle= 4 E= -128.520801072307  delta_E= -1.28e-08  |g|= 5.26e-05  |ddm|= 0.000188
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.66233e-05
diis-c [-6.34526197e-10  2.15687761e-04  4.05246274e-04 -1.75884585e-01
  1.17526365e+00]
  HOMO = -0.8445058424682  LUMO = 0.914242221456292
  mo_energy =
[-3.27723343e+01 -1.92697089e+00 -8.44505842e-01 -8.44505842e-01
 -8.44505842e-01  9.14242221e-01  9.14242221e-01  9.14242221e-01
  2.48420535e+00  4.40089123e+00  4.40089123e+00  4.40089123e+00
  1.68146930e+01  1.68146930e+01  1.68146930e+01  2.06579599e+01
  7.52089950e+01  7.52089950e+01  7.52089950e+01  9.50304712e+01
  3.57178855e+02  1.35037511e+03  5.83665790e+03  3.50990942e+04]
E1 = -182.5759984548097  E_coul = 54.05519738215408
cycle= 5 E= -128.520801072656  delta_E= -3.48e-10  |g|= 5.77e-06  |ddm|= 3.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5759984548097  E_coul = 54.05519738215408
  HOMO = -0.844502526565116  LUMO = 0.914243222347844
  mo_energy =
[-3.27723262e+01 -1.92696804e+00 -8.44502527e-01 -8.44502527e-01
 -8.44502527e-01  9.14243222e-01  9.14243222e-01  9.14243222e-01
  2.48420765e+00  4.40089451e+00  4.40089451e+00  4.40089451e+00
  1.68146987e+01  1.68146987e+01  1.68146987e+01  2.06579659e+01
  7.52090027e+01  7.52090027e+01  7.52090027e+01  9.50304789e+01
  3.57178864e+02  1.35037512e+03  5.83665790e+03  3.50990942e+04]
E1 = -182.5759785711413  E_coul = 54.05517749848327
Extra cycle  E= -128.520801072658  delta_E= -2.42e-12  |g|= 2.81e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498477e+02 1.74907150e+02
 2.04902162e+01 5.69542490e+01 5.53192524e-01 7.81669576e+00
 1.92995156e+00 2.71348160e+00 8.67832749e+00 3.55716833e+01
 2.93256351e-01 9.27272114e-01]
E = -128.52080107265803
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682448        1
[INPUT] 0    0    [1    /1   ]  617.498476556        1
[INPUT] 0    0    [1    /1   ]  174.907150255        1
[INPUT] 0    0    [1    /1   ]  20.4902162199        1
[INPUT] 0    0    [1    /1   ]  56.9542490174        1
[INPUT] 0    0    [1    /1   ]  0.553192524205       1
[INPUT] 0    0    [1    /1   ]  7.81669576122        1
[INPUT] 0    0    [1    /1   ]  1.92995155964        1
[INPUT] 1    0    [1    /1   ]  2.71348159561        1
[INPUT] 1    0    [1    /1   ]  8.67832749296        1
[INPUT] 1    0    [1    /1   ]  35.5716833316        1
[INPUT] 1    0    [1    /1   ]  0.293256351258       1
[INPUT] 1    0    [1    /1   ]  0.927272113792       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730000832, 1.0]], [0, [2712.096824483828, 1.0]], [0, [617.4984765563743, 1.0]], [0, [174.90715025469723, 1.0]], [0, [20.490216219852993, 1.0]], [0, [56.95424901742764, 1.0]], [0, [0.5531925242045593, 1.0]], [0, [7.816695761221333, 1.0]], [0, [1.9299515596377863, 1.0]], [1, [2.7134815956080938, 1.0]], [1, [8.678327492958791, 1.0]], [1, [35.57168333158552, 1.0]], [1, [0.2932563512584218, 1.0]], [1, [0.9272721137920086, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873]
bas 1, expnt(s) = [2712.09682448]
bas 2, expnt(s) = [617.49847656]
bas 3, expnt(s) = [174.90715025]
bas 4, expnt(s) = [20.49021622]
bas 5, expnt(s) = [56.95424902]
bas 6, expnt(s) = [0.55319252]
bas 7, expnt(s) = [7.81669576]
bas 8, expnt(s) = [1.92995156]
bas 9, expnt(s) = [2.7134816]
bas 10, expnt(s) = [8.67832749]
bas 11, expnt(s) = [35.57168333]
bas 12, expnt(s) = [0.29325635]
bas 13, expnt(s) = [0.92727211]
CPU time:        89.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498477e+02 3.12962240e+02 1.74907150e+02 1.21512428e+02
 2.04902162e+01 2.43318388e+01 5.69542490e+01 5.23792917e+01
 5.53192524e-01 1.62058663e+00 7.81669576e+00 1.18108847e+01
 1.92995156e+00 4.13689817e+00 2.71348160e+00 1.01599833e+01
 8.67832749e+00 4.34539676e+01 3.55716833e+01 2.53434021e+02
 2.93256351e-01 6.29569494e-01 9.27272114e-01 2.65456517e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998215092677857
cond(S) = 257.7829297547909
E1 = -183.56722129477438  E_coul = 55.08064816179885
init E= -128.486573132976
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.772813413291785  LUMO = 0.93432086568451
  mo_energy =
[-3.25546992e+01 -1.85025841e+00 -7.72813413e-01 -7.72813413e-01
 -7.72813413e-01  9.34320866e-01  9.34320866e-01  9.34320866e-01
  2.54415339e+00  4.47197452e+00  4.47197452e+00  4.47197452e+00
  1.69534854e+01  1.69534854e+01  1.69534854e+01  2.08070690e+01
  7.54147304e+01  7.54147304e+01  7.54147304e+01  9.52346322e+01
  3.57418435e+02  1.35064620e+03  5.83695746e+03  3.50994140e+04]
E1 = -182.08005649043497  E_coul = 53.56272326482867
cycle= 1 E= -128.517333225606  delta_E= -0.0308  |g|= 0.204  |ddm|= 0.177
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.466532
diis-c [-0.21765209  1.        ]
  HOMO = -0.879208815814215  LUMO = 0.904345065114313
  mo_energy =
[-3.28786319e+01 -1.96365776e+00 -8.79208816e-01 -8.79208816e-01
 -8.79208816e-01  9.04345065e-01  9.04345065e-01  9.04345065e-01
  2.45578666e+00  4.36675033e+00  4.36675033e+00  4.36675033e+00
  1.67466225e+01  1.67466225e+01  1.67466225e+01  2.05847825e+01
  7.51086856e+01  7.51086856e+01  7.51086856e+01  9.49302980e+01
  3.57065761e+02  1.35025569e+03  5.83653548e+03  3.50989707e+04]
E1 = -182.8258954338508  E_coul = 54.30597450841791
cycle= 2 E= -128.519920925433  delta_E= -0.00259  |g|= 0.102  |ddm|= 0.0756
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.234979
diis-c [-5.79149873e-04  3.34083717e-01  6.65916283e-01]
  HOMO = -0.84433612905658  LUMO = 0.914269497704054
  mo_energy =
[-3.27720917e+01 -1.92676028e+00 -8.44336129e-01 -8.44336129e-01
 -8.44336129e-01  9.14269498e-01  9.14269498e-01  9.14269498e-01
  2.48435535e+00  4.40101415e+00  4.40101415e+00  4.40101415e+00
  1.68148840e+01  1.68148840e+01  1.68148840e+01  2.06581735e+01
  7.52092330e+01  7.52092330e+01  7.52092330e+01  9.50307015e+01
  3.57179104e+02  1.35037539e+03  5.83665821e+03  3.50990946e+04]
E1 = -182.5760250630433  E_coul = 54.05522400349518
cycle= 3 E= -128.520801059548  delta_E= -0.00088  |g|= 0.000323  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000377991
diis-c [-9.17715039e-08 -2.17120255e-03 -3.55399365e-03  1.00572520e+00]
  HOMO = -0.844484793491818  LUMO = 0.914251416265415
  mo_energy =
[-3.27723058e+01 -1.92693750e+00 -8.44484793e-01 -8.44484793e-01
 -8.44484793e-01  9.14251416e-01  9.14251416e-01  9.14251416e-01
  2.48423624e+00  4.40091506e+00  4.40091506e+00  4.40091506e+00
  1.68147240e+01  1.68147240e+01  1.68147240e+01  2.06579945e+01
  7.52090245e+01  7.52090245e+01  7.52090245e+01  9.50305005e+01
  3.57178877e+02  1.35037513e+03  5.83665790e+03  3.50990942e+04]
E1 = -182.5759712058551  E_coul = 54.05517013354767
cycle= 4 E= -128.520801072307  delta_E= -1.28e-08  |g|= 5.26e-05  |ddm|= 0.000188
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.66233e-05
diis-c [-6.34526197e-10  2.15687761e-04  4.05246274e-04 -1.75884585e-01
  1.17526365e+00]
  HOMO = -0.8445058424682  LUMO = 0.914242221456292
  mo_energy =
[-3.27723343e+01 -1.92697089e+00 -8.44505842e-01 -8.44505842e-01
 -8.44505842e-01  9.14242221e-01  9.14242221e-01  9.14242221e-01
  2.48420535e+00  4.40089123e+00  4.40089123e+00  4.40089123e+00
  1.68146930e+01  1.68146930e+01  1.68146930e+01  2.06579599e+01
  7.52089950e+01  7.52089950e+01  7.52089950e+01  9.50304712e+01
  3.57178855e+02  1.35037511e+03  5.83665790e+03  3.50990942e+04]
E1 = -182.5759984548097  E_coul = 54.05519738215408
cycle= 5 E= -128.520801072656  delta_E= -3.48e-10  |g|= 5.77e-06  |ddm|= 3.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5759984548097  E_coul = 54.05519738215408
  HOMO = -0.844502526565116  LUMO = 0.914243222347844
  mo_energy =
[-3.27723262e+01 -1.92696804e+00 -8.44502527e-01 -8.44502527e-01
 -8.44502527e-01  9.14243222e-01  9.14243222e-01  9.14243222e-01
  2.48420765e+00  4.40089451e+00  4.40089451e+00  4.40089451e+00
  1.68146987e+01  1.68146987e+01  1.68146987e+01  2.06579659e+01
  7.52090027e+01  7.52090027e+01  7.52090027e+01  9.50304789e+01
  3.57178864e+02  1.35037512e+03  5.83665790e+03  3.50990942e+04]
E1 = -182.5759785711413  E_coul = 54.05517749848327
Extra cycle  E= -128.520801072658  delta_E= -2.42e-12  |g|= 2.81e-06  |ddm|= 1.8e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 257.7829297547909
E1 = -182.5759785711413  E_coul = 54.05517749848327
init E= -128.520801072658
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.844503894110734  LUMO = 0.914242830339402
  mo_energy =
[-3.27723305e+01 -1.92696962e+00 -8.44503894e-01 -8.44503894e-01
 -8.44503894e-01  9.14242830e-01  9.14242830e-01  9.14242830e-01
  2.48420643e+00  4.40089316e+00  4.40089316e+00  4.40089316e+00
  1.68146960e+01  1.68146960e+01  1.68146960e+01  2.06579629e+01
  7.52089986e+01  7.52089986e+01  7.52089986e+01  9.50304749e+01
  3.57178859e+02  1.35037512e+03  5.83665790e+03  3.50990942e+04]
E1 = -182.5759885419245  E_coul = 54.05518746926584
cycle= 1 E= -128.520801072659  delta_E= -6.25e-13  |g|= 1.35e-06  |ddm|= 1.18e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5759885419245  E_coul = 54.05518746926584
  HOMO = -0.844503188330241  LUMO = 0.914243030595965
  mo_energy =
[-3.27723283e+01 -1.92696889e+00 -8.44503188e-01 -8.44503188e-01
 -8.44503188e-01  9.14243031e-01  9.14243031e-01  9.14243031e-01
  2.48420699e+00  4.40089385e+00  4.40089385e+00  4.40089385e+00
  1.68146974e+01  1.68146974e+01  1.68146974e+01  2.06579644e+01
  7.52090007e+01  7.52090007e+01  7.52090007e+01  9.50304769e+01
  3.57178862e+02  1.35037512e+03  5.83665790e+03  3.50990942e+04]
E1 = -182.57598346159128  E_coul = 54.055182388932195
Extra cycle  E= -128.520801072659  delta_E= -4.26e-13  |g|= 6.93e-07  |ddm|= 4.97e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498477e+02 1.74907150e+02
 2.04902162e+01 5.69542490e+01 5.53192524e-01 7.81669576e+00
 1.92995156e+00 2.71348160e+00 8.67832749e+00 3.55716833e+01
 2.93256351e-01 9.27272114e-01]
grad_E = [ 8.99740111e-11 -5.90867643e-09  8.39348098e-08 -1.92994059e-06
 -2.11106483e-04  1.33480797e-05  7.83101071e-03  3.23031838e-04
  9.48106717e-03 -1.38187245e-02  1.50278942e-03 -6.12806758e-04
 -7.62692669e-03  2.24862988e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682471        1
[INPUT] 0    0    [1    /1   ]  617.498473213        1
[INPUT] 0    0    [1    /1   ]  174.907219164        1
[INPUT] 0    0    [1    /1   ]  20.4947237822        1
[INPUT] 0    0    [1    /1   ]  56.953794241         1
[INPUT] 0    0    [1    /1   ]  0.567411111836       1
[INPUT] 0    0    [1    /1   ]  7.81404610324        1
[INPUT] 0    0    [1    /1   ]  2.01791936314        1
[INPUT] 1    0    [1    /1   ]  2.94581626523        1
[INPUT] 1    0    [1    /1   ]  9.48964753549        1
[INPUT] 1    0    [1    /1   ]  38.6822267442        1
[INPUT] 1    0    [1    /1   ]  0.293809749624       1
[INPUT] 1    0    [1    /1   ]  0.959628795645       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47872998941, 1.0]], [0, [2712.096824707882, 1.0]], [0, [617.4984732125666, 1.0]], [0, [174.9072191644379, 1.0]], [0, [20.49472378223487, 1.0]], [0, [56.9537942410051, 1.0]], [0, [0.5674111118362509, 1.0]], [0, [7.814046103243744, 1.0]], [0, [2.017919363138467, 1.0]], [1, [2.9458162652252375, 1.0]], [1, [9.489647535488224, 1.0]], [1, [38.68222674416687, 1.0]], [1, [0.2938097496237103, 1.0]], [1, [0.959628795644697, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872999]
bas 1, expnt(s) = [2712.09682471]
bas 2, expnt(s) = [617.49847321]
bas 3, expnt(s) = [174.90721916]
bas 4, expnt(s) = [20.49472378]
bas 5, expnt(s) = [56.95379424]
bas 6, expnt(s) = [0.56741111]
bas 7, expnt(s) = [7.8140461]
bas 8, expnt(s) = [2.01791936]
bas 9, expnt(s) = [2.94581627]
bas 10, expnt(s) = [9.48964754]
bas 11, expnt(s) = [38.68222674]
bas 12, expnt(s) = [0.29380975]
bas 13, expnt(s) = [0.9596288]
CPU time:        92.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498473e+02 3.12962239e+02 1.74907219e+02 1.21512463e+02
 2.04947238e+01 2.43358532e+01 5.69537942e+01 5.23789780e+01
 5.67411112e-01 1.65172751e+00 7.81404610e+00 1.18078819e+01
 2.01791936e+00 4.27752819e+00 2.94581627e+00 1.12587834e+01
 9.48964754e+00 4.85900108e+01 3.86822267e+01 2.81432161e+02
 2.93809750e-01 6.31054905e-01 9.59628796e-01 2.77085297e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997984897861055
cond(S) = 263.7635100532086
E1 = -183.56823669635136  E_coul = 55.08108684485647
init E= -128.487149851495
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773197693098453  LUMO = 0.94700470778505
  mo_energy =
[-3.25545768e+01 -1.84970730e+00 -7.73197693e-01 -7.73197693e-01
 -7.73197693e-01  9.47004708e-01  9.47004708e-01  9.47004708e-01
  2.67791757e+00  4.69393515e+00  4.69393515e+00  4.69393515e+00
  1.84649454e+01  1.84649454e+01  1.84649454e+01  2.12055904e+01
  8.31315244e+01  8.31315244e+01  8.31315244e+01  9.56516506e+01
  3.57800522e+02  1.35098855e+03  5.83725802e+03  3.50996625e+04]
E1 = -182.09217448398175  E_coul = 53.573311218270526
cycle= 1 E= -128.518863265711  delta_E= -0.0317  |g|= 0.203  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.459773
diis-c [-0.2113913  1.       ]
  HOMO = -0.87898152647098  LUMO = 0.916373326918482
  mo_energy =
[-3.28758512e+01 -1.96255536e+00 -8.78981526e-01 -8.78981526e-01
 -8.78981526e-01  9.16373327e-01  9.16373327e-01  9.16373327e-01
  2.58698631e+00  4.58346865e+00  4.58346865e+00  4.58346865e+00
  1.82512479e+01  1.82512479e+01  1.82512479e+01  2.09843106e+01
  8.28236166e+01  8.28236166e+01  8.28236166e+01  9.53498407e+01
  3.57450688e+02  1.35060100e+03  5.83683904e+03  3.50992222e+04]
E1 = -182.8324658759043  E_coul = 54.311049573788154
cycle= 2 E= -128.521416302116  delta_E= -0.00255  |g|= 0.101  |ddm|= 0.0759
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231269
diis-c [-5.83326677e-04  3.33754647e-01  6.66245353e-01]
  HOMO = -0.844373792614138  LUMO = 0.926541201288448
  mo_energy =
[-3.27699987e+01 -1.92589743e+00 -8.44373793e-01 -8.44373793e-01
 -8.44373793e-01  9.26541201e-01  9.26541201e-01  9.26541201e-01
  2.61637336e+00  4.61942162e+00  4.61942162e+00  4.61942162e+00
  1.83218068e+01  1.83218068e+01  1.83218068e+01  2.10573251e+01
  8.29248335e+01  8.29248335e+01  8.29248335e+01  9.54495544e+01
  3.57563293e+02  1.35071993e+03  5.83696098e+03  3.50993453e+04]
E1 = -182.5845909186824  E_coul = 54.06230731566847
cycle= 3 E= -128.522283603014  delta_E= -0.000867  |g|= 0.000296  |ddm|= 0.0257
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000391346
diis-c [-6.93397940e-08 -2.18300675e-03 -3.22690988e-03  1.00540992e+00]
  HOMO = -0.844522338918456  LUMO = 0.926526253604456
  mo_energy =
[-3.27702217e+01 -1.92606526e+00 -8.44522339e-01 -8.44522339e-01
 -8.44522339e-01  9.26526254e-01  9.26526254e-01  9.26526254e-01
  2.61626095e+00  4.61932066e+00  4.61932066e+00  4.61932066e+00
  1.83216389e+01  1.83216389e+01  1.83216389e+01  2.10571407e+01
  8.29246136e+01  8.29246136e+01  8.29246136e+01  9.54493439e+01
  3.57563049e+02  1.35071964e+03  5.83696064e+03  3.50993449e+04]
E1 = -182.5846321925616  E_coul = 54.06234858086708
cycle= 4 E= -128.522283611695  delta_E= -8.68e-09  |g|= 4.47e-05  |ddm|= 0.000146
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.12899e-05
diis-c [-4.59884254e-10  1.99421055e-04  3.64129643e-04 -1.59666091e-01
  1.15910254e+00]
  HOMO = -0.844541508426568  LUMO = 0.926518070621521
  mo_energy =
[-3.27702492e+01 -1.92609418e+00 -8.44541508e-01 -8.44541508e-01
 -8.44541508e-01  9.26518071e-01  9.26518071e-01  9.26518071e-01
  2.61623384e+00  4.61929866e+00  4.61929866e+00  4.61929866e+00
  1.83216100e+01  1.83216100e+01  1.83216100e+01  2.10571089e+01
  8.29245857e+01  8.29245857e+01  8.29245857e+01  9.54493158e+01
  3.57563027e+02  1.35071962e+03  5.83696063e+03  3.50993449e+04]
E1 = -182.58466703886006  E_coul = 54.06238342694266
cycle= 5 E= -128.522283611917  delta_E= -2.23e-10  |g|= 5.02e-06  |ddm|= 2.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58466703886006  E_coul = 54.06238342694266
  HOMO = -0.844538695944569  LUMO = 0.926518925281955
  mo_energy =
[-3.27702422e+01 -1.92609179e+00 -8.44538696e-01 -8.44538696e-01
 -8.44538696e-01  9.26518925e-01  9.26518925e-01  9.26518925e-01
  2.61623581e+00  4.61930157e+00  4.61930157e+00  4.61930157e+00
  1.83216151e+01  1.83216151e+01  1.83216151e+01  2.10571140e+01
  8.29245923e+01  8.29245923e+01  8.29245923e+01  9.54493224e+01
  3.57563034e+02  1.35071963e+03  5.83696064e+03  3.50993449e+04]
E1 = -182.58464941987796  E_coul = 54.06236580795824
Extra cycle  E= -128.52228361192  delta_E= -2.33e-12  |g|= 2.49e-06  |ddm|= 1.67e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498473e+02 1.74907219e+02
 2.04947238e+01 5.69537942e+01 5.67411112e-01 7.81404610e+00
 2.01791936e+00 2.94581627e+00 9.48964754e+00 3.86822267e+01
 2.93809750e-01 9.59628796e-01]
E = -128.52228361191973
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682471        1
[INPUT] 0    0    [1    /1   ]  617.498473213        1
[INPUT] 0    0    [1    /1   ]  174.907219164        1
[INPUT] 0    0    [1    /1   ]  20.4947237822        1
[INPUT] 0    0    [1    /1   ]  56.953794241         1
[INPUT] 0    0    [1    /1   ]  0.567411111836       1
[INPUT] 0    0    [1    /1   ]  7.81404610324        1
[INPUT] 0    0    [1    /1   ]  2.01791936314        1
[INPUT] 1    0    [1    /1   ]  2.94581626523        1
[INPUT] 1    0    [1    /1   ]  9.48964753549        1
[INPUT] 1    0    [1    /1   ]  38.6822267442        1
[INPUT] 1    0    [1    /1   ]  0.293809749624       1
[INPUT] 1    0    [1    /1   ]  0.959628795645       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47872998941, 1.0]], [0, [2712.096824707882, 1.0]], [0, [617.4984732125666, 1.0]], [0, [174.9072191644379, 1.0]], [0, [20.49472378223487, 1.0]], [0, [56.9537942410051, 1.0]], [0, [0.5674111118362509, 1.0]], [0, [7.814046103243744, 1.0]], [0, [2.017919363138467, 1.0]], [1, [2.9458162652252375, 1.0]], [1, [9.489647535488224, 1.0]], [1, [38.68222674416687, 1.0]], [1, [0.2938097496237103, 1.0]], [1, [0.959628795644697, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872999]
bas 1, expnt(s) = [2712.09682471]
bas 2, expnt(s) = [617.49847321]
bas 3, expnt(s) = [174.90721916]
bas 4, expnt(s) = [20.49472378]
bas 5, expnt(s) = [56.95379424]
bas 6, expnt(s) = [0.56741111]
bas 7, expnt(s) = [7.8140461]
bas 8, expnt(s) = [2.01791936]
bas 9, expnt(s) = [2.94581627]
bas 10, expnt(s) = [9.48964754]
bas 11, expnt(s) = [38.68222674]
bas 12, expnt(s) = [0.29380975]
bas 13, expnt(s) = [0.9596288]
CPU time:        93.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498473e+02 3.12962239e+02 1.74907219e+02 1.21512463e+02
 2.04947238e+01 2.43358532e+01 5.69537942e+01 5.23789780e+01
 5.67411112e-01 1.65172751e+00 7.81404610e+00 1.18078819e+01
 2.01791936e+00 4.27752819e+00 2.94581627e+00 1.12587834e+01
 9.48964754e+00 4.85900108e+01 3.86822267e+01 2.81432161e+02
 2.93809750e-01 6.31054905e-01 9.59628796e-01 2.77085297e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997984897861055
cond(S) = 263.7635100532086
E1 = -183.56823669635136  E_coul = 55.08108684485647
init E= -128.487149851495
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773197693098453  LUMO = 0.94700470778505
  mo_energy =
[-3.25545768e+01 -1.84970730e+00 -7.73197693e-01 -7.73197693e-01
 -7.73197693e-01  9.47004708e-01  9.47004708e-01  9.47004708e-01
  2.67791757e+00  4.69393515e+00  4.69393515e+00  4.69393515e+00
  1.84649454e+01  1.84649454e+01  1.84649454e+01  2.12055904e+01
  8.31315244e+01  8.31315244e+01  8.31315244e+01  9.56516506e+01
  3.57800522e+02  1.35098855e+03  5.83725802e+03  3.50996625e+04]
E1 = -182.09217448398175  E_coul = 53.573311218270526
cycle= 1 E= -128.518863265711  delta_E= -0.0317  |g|= 0.203  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.459773
diis-c [-0.2113913  1.       ]
  HOMO = -0.87898152647098  LUMO = 0.916373326918482
  mo_energy =
[-3.28758512e+01 -1.96255536e+00 -8.78981526e-01 -8.78981526e-01
 -8.78981526e-01  9.16373327e-01  9.16373327e-01  9.16373327e-01
  2.58698631e+00  4.58346865e+00  4.58346865e+00  4.58346865e+00
  1.82512479e+01  1.82512479e+01  1.82512479e+01  2.09843106e+01
  8.28236166e+01  8.28236166e+01  8.28236166e+01  9.53498407e+01
  3.57450688e+02  1.35060100e+03  5.83683904e+03  3.50992222e+04]
E1 = -182.8324658759043  E_coul = 54.311049573788154
cycle= 2 E= -128.521416302116  delta_E= -0.00255  |g|= 0.101  |ddm|= 0.0759
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.231269
diis-c [-5.83326677e-04  3.33754647e-01  6.66245353e-01]
  HOMO = -0.844373792614138  LUMO = 0.926541201288448
  mo_energy =
[-3.27699987e+01 -1.92589743e+00 -8.44373793e-01 -8.44373793e-01
 -8.44373793e-01  9.26541201e-01  9.26541201e-01  9.26541201e-01
  2.61637336e+00  4.61942162e+00  4.61942162e+00  4.61942162e+00
  1.83218068e+01  1.83218068e+01  1.83218068e+01  2.10573251e+01
  8.29248335e+01  8.29248335e+01  8.29248335e+01  9.54495544e+01
  3.57563293e+02  1.35071993e+03  5.83696098e+03  3.50993453e+04]
E1 = -182.5845909186824  E_coul = 54.06230731566847
cycle= 3 E= -128.522283603014  delta_E= -0.000867  |g|= 0.000296  |ddm|= 0.0257
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000391346
diis-c [-6.93397940e-08 -2.18300675e-03 -3.22690988e-03  1.00540992e+00]
  HOMO = -0.844522338918456  LUMO = 0.926526253604456
  mo_energy =
[-3.27702217e+01 -1.92606526e+00 -8.44522339e-01 -8.44522339e-01
 -8.44522339e-01  9.26526254e-01  9.26526254e-01  9.26526254e-01
  2.61626095e+00  4.61932066e+00  4.61932066e+00  4.61932066e+00
  1.83216389e+01  1.83216389e+01  1.83216389e+01  2.10571407e+01
  8.29246136e+01  8.29246136e+01  8.29246136e+01  9.54493439e+01
  3.57563049e+02  1.35071964e+03  5.83696064e+03  3.50993449e+04]
E1 = -182.5846321925616  E_coul = 54.06234858086708
cycle= 4 E= -128.522283611695  delta_E= -8.68e-09  |g|= 4.47e-05  |ddm|= 0.000146
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.12899e-05
diis-c [-4.59884254e-10  1.99421055e-04  3.64129643e-04 -1.59666091e-01
  1.15910254e+00]
  HOMO = -0.844541508426568  LUMO = 0.926518070621521
  mo_energy =
[-3.27702492e+01 -1.92609418e+00 -8.44541508e-01 -8.44541508e-01
 -8.44541508e-01  9.26518071e-01  9.26518071e-01  9.26518071e-01
  2.61623384e+00  4.61929866e+00  4.61929866e+00  4.61929866e+00
  1.83216100e+01  1.83216100e+01  1.83216100e+01  2.10571089e+01
  8.29245857e+01  8.29245857e+01  8.29245857e+01  9.54493158e+01
  3.57563027e+02  1.35071962e+03  5.83696063e+03  3.50993449e+04]
E1 = -182.58466703886006  E_coul = 54.06238342694266
cycle= 5 E= -128.522283611917  delta_E= -2.23e-10  |g|= 5.02e-06  |ddm|= 2.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58466703886006  E_coul = 54.06238342694266
  HOMO = -0.844538695944569  LUMO = 0.926518925281955
  mo_energy =
[-3.27702422e+01 -1.92609179e+00 -8.44538696e-01 -8.44538696e-01
 -8.44538696e-01  9.26518925e-01  9.26518925e-01  9.26518925e-01
  2.61623581e+00  4.61930157e+00  4.61930157e+00  4.61930157e+00
  1.83216151e+01  1.83216151e+01  1.83216151e+01  2.10571140e+01
  8.29245923e+01  8.29245923e+01  8.29245923e+01  9.54493224e+01
  3.57563034e+02  1.35071963e+03  5.83696064e+03  3.50993449e+04]
E1 = -182.58464941987796  E_coul = 54.06236580795824
Extra cycle  E= -128.52228361192  delta_E= -2.33e-12  |g|= 2.49e-06  |ddm|= 1.67e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 263.7635100532086
E1 = -182.58464941987796  E_coul = 54.06236580795824
init E= -128.52228361192
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.84453991123694  LUMO = 0.926518563131126
  mo_energy =
[-3.27702460e+01 -1.92609320e+00 -8.44539911e-01 -8.44539911e-01
 -8.44539911e-01  9.26518563e-01  9.26518563e-01  9.26518563e-01
  2.61623467e+00  4.61930030e+00  4.61930030e+00  4.61930030e+00
  1.83216126e+01  1.83216126e+01  1.83216126e+01  2.10571114e+01
  8.29245887e+01  8.29245887e+01  8.29245887e+01  9.54493188e+01
  3.57563030e+02  1.35071963e+03  5.83696063e+03  3.50993449e+04]
E1 = -182.58465815581982  E_coul = 54.062374543899836
cycle= 1 E= -128.52228361192  delta_E= -2.56e-13  |g|= 1.19e-06  |ddm|= 1.05e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58465815581982  E_coul = 54.062374543899836
  HOMO = -0.84453929375009  LUMO = 0.926518743588765
  mo_energy =
[-3.27702441e+01 -1.92609256e+00 -8.44539294e-01 -8.44539294e-01
 -8.44539294e-01  9.26518744e-01  9.26518744e-01  9.26518744e-01
  2.61623518e+00  4.61930094e+00  4.61930094e+00  4.61930094e+00
  1.83216138e+01  1.83216138e+01  1.83216138e+01  2.10571127e+01
  8.29245905e+01  8.29245905e+01  8.29245905e+01  9.54493206e+01
  3.57563032e+02  1.35071963e+03  5.83696064e+03  3.50993449e+04]
E1 = -182.58465369517225  E_coul = 54.06237008325197
Extra cycle  E= -128.52228361192  delta_E= -2.84e-13  |g|= 6.09e-07  |ddm|= 4.43e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498473e+02 1.74907219e+02
 2.04947238e+01 5.69537942e+01 5.67411112e-01 7.81404610e+00
 2.01791936e+00 2.94581627e+00 9.48964754e+00 3.86822267e+01
 2.93809750e-01 9.59628796e-01]
grad_E = [ 8.31180672e-11 -5.70283727e-09  7.84110799e-08 -2.03912359e-06
 -2.57614565e-04  1.59127860e-05  3.28711475e-03  4.82716356e-04
  1.20899928e-02 -5.35597829e-03  7.86672629e-04 -4.77158431e-04
 -4.63965534e-03  7.00410356e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682482        1
[INPUT] 0    0    [1    /1   ]  617.498471551        1
[INPUT] 0    0    [1    /1   ]  174.907254134        1
[INPUT] 0    0    [1    /1   ]  20.4971713189        1
[INPUT] 0    0    [1    /1   ]  56.9535603079        1
[INPUT] 0    0    [1    /1   ]  0.570900298555       1
[INPUT] 0    0    [1    /1   ]  7.81220181124        1
[INPUT] 0    0    [1    /1   ]  2.04497068101        1
[INPUT] 1    0    [1    /1   ]  3.08960042301        1
[INPUT] 1    0    [1    /1   ]  9.91336068994        1
[INPUT] 1    0    [1    /1   ]  40.1607722541        1
[INPUT] 1    0    [1    /1   ]  0.296818944589       1
[INPUT] 1    0    [1    /1   ]  0.986677160639       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729983883, 1.0]], [0, [2712.0968248201093, 1.0]], [0, [617.4984715509728, 1.0]], [0, [174.90725413407458, 1.0]], [0, [20.49717131886171, 1.0]], [0, [56.95356030790104, 1.0]], [0, [0.5709002985547053, 1.0]], [0, [7.812201811240415, 1.0]], [0, [2.0449706810098567, 1.0]], [1, [3.089600423007613, 1.0]], [1, [9.913360689941362, 1.0]], [1, [40.160772254117624, 1.0]], [1, [0.29681894458919217, 1.0]], [1, [0.9866771606393953, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872998]
bas 1, expnt(s) = [2712.09682482]
bas 2, expnt(s) = [617.49847155]
bas 3, expnt(s) = [174.90725413]
bas 4, expnt(s) = [20.49717132]
bas 5, expnt(s) = [56.95356031]
bas 6, expnt(s) = [0.5709003]
bas 7, expnt(s) = [7.81220181]
bas 8, expnt(s) = [2.04497068]
bas 9, expnt(s) = [3.08960042]
bas 10, expnt(s) = [9.91336069]
bas 11, expnt(s) = [40.16077225]
bas 12, expnt(s) = [0.29681894]
bas 13, expnt(s) = [0.98667716]
CPU time:        96.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498472e+02 3.12962238e+02 1.74907254e+02 1.21512482e+02
 2.04971713e+01 2.43380328e+01 5.69535603e+01 5.23788167e+01
 5.70900299e-01 1.65933941e+00 7.81220181e+00 1.18057917e+01
 2.04497068e+00 4.32046348e+00 3.08960042e+00 1.19498454e+01
 9.91336069e+00 5.13169135e+01 4.01607723e+01 2.94942231e+02
 2.96818945e-01 6.39144290e-01 9.86677161e-01 2.86881958e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997855901777339
cond(S) = 265.5614979313111
E1 = -183.56806440150316  E_coul = 55.08096852407765
init E= -128.487095877426
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773340437156266  LUMO = 0.964291702628359
  mo_energy =
[-3.25545645e+01 -1.84955373e+00 -7.73340437e-01 -7.73340437e-01
 -7.73340437e-01  9.64291703e-01  9.64291703e-01  9.64291703e-01
  2.71598348e+00  4.86217942e+00  4.86217942e+00  4.86217942e+00
  1.93749165e+01  1.93749165e+01  1.93749165e+01  2.13220885e+01
  8.70919352e+01  8.70919352e+01  8.70919352e+01  9.57750231e+01
  3.57914781e+02  1.35109134e+03  5.83734837e+03  3.50997372e+04]
E1 = -182.09691450903222  E_coul = 53.57759842495755
cycle= 1 E= -128.519316084075  delta_E= -0.0322  |g|= 0.203  |ddm|= 0.186
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.4573
diis-c [-0.20912311  1.        ]
  HOMO = -0.878875638107109  LUMO = 0.932896913564472
  mo_energy =
[-3.28746981e+01 -1.96209450e+00 -8.78875638e-01 -8.78875638e-01
 -8.78875638e-01  9.32896914e-01  9.32896914e-01  9.32896914e-01
  2.62446714e+00  4.74834526e+00  4.74834526e+00  4.74834526e+00
  1.91578375e+01  1.91578375e+01  1.91578375e+01  2.11012543e+01
  8.67833056e+01  8.67833056e+01  8.67833056e+01  9.54742698e+01
  3.57566129e+02  1.35070498e+03  5.83693058e+03  3.50992981e+04]
E1 = -182.83474221504474  E_coul = 54.31288558778868
cycle= 2 E= -128.521856627256  delta_E= -0.00254  |g|= 0.101  |ddm|= 0.0762
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229723
diis-c [-5.83362592e-04  3.33449123e-01  6.66550877e-01]
  HOMO = -0.844378573259134  LUMO = 0.943334625034708
  mo_energy =
[-3.27691151e+01 -1.92554263e+00 -8.44378573e-01 -8.44378573e-01
 -8.44378573e-01  9.43334625e-01  9.43334625e-01  9.43334625e-01
  2.65405708e+00  4.78539512e+00  4.78539512e+00  4.78539512e+00
  1.92295425e+01  1.92295425e+01  1.92295425e+01  2.11741051e+01
  8.68848129e+01  8.68848129e+01  8.68848129e+01  9.55737162e+01
  3.57678445e+02  1.35082361e+03  5.83705221e+03  3.50994209e+04]
E1 = -182.58787363312175  E_coul = 54.06515562117207
cycle= 3 E= -128.52271801195  delta_E= -0.000861  |g|= 0.000277  |ddm|= 0.0258
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000407814
diis-c [-5.34001232e-08 -2.15938862e-03 -2.93993449e-03  1.00509932e+00]
  HOMO = -0.844524916391035  LUMO = 0.943322274067646
  mo_energy =
[-3.27693422e+01 -1.92570028e+00 -8.44524916e-01 -8.44524916e-01
 -8.44524916e-01  9.43322274e-01  9.43322274e-01  9.43322274e-01
  2.65395413e+00  4.78529503e+00  4.78529503e+00  4.78529503e+00
  1.92293725e+01  1.92293725e+01  1.92293725e+01  2.11739212e+01
  8.68845878e+01  8.68845878e+01  8.68845878e+01  9.55735014e+01
  3.57678190e+02  1.35082330e+03  5.83705184e+03  3.50994205e+04]
E1 = -182.58797578809714  E_coul = 54.065257769747994
cycle= 4 E= -128.522718018349  delta_E= -6.4e-09  |g|= 3.94e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.98455e-05
diis-c [-3.57159125e-10  1.70992145e-04  3.28941544e-04 -1.40930520e-01
  1.14043059e+00]
  HOMO = -0.84454285890643  LUMO = 0.943314743149767
  mo_energy =
[-3.27693696e+01 -1.92572590e+00 -8.44542859e-01 -8.44542859e-01
 -8.44542859e-01  9.43314743e-01  9.43314743e-01  9.43314743e-01
  2.65393013e+00  4.78527428e+00  4.78527428e+00  4.78527428e+00
  1.92293448e+01  1.92293448e+01  1.92293448e+01  2.11738912e+01
  8.68845603e+01  8.68845603e+01  8.68845603e+01  9.55734737e+01
  3.57678167e+02  1.35082328e+03  5.83705183e+03  3.50994205e+04]
E1 = -182.58801775107293  E_coul = 54.06529973256949
cycle= 5 E= -128.522718018503  delta_E= -1.54e-10  |g|= 4.34e-06  |ddm|= 2.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58801775107293  E_coul = 54.06529973256949
  HOMO = -0.844540516285035  LUMO = 0.943315457786128
  mo_energy =
[-3.27693636e+01 -1.92572397e+00 -8.44540516e-01 -8.44540516e-01
 -8.44540516e-01  9.43315458e-01  9.43315458e-01  9.43315458e-01
  2.65393172e+00  4.78527677e+00  4.78527677e+00  4.78527677e+00
  1.92293492e+01  1.92293492e+01  1.92293492e+01  2.11738955e+01
  8.68845660e+01  8.68845660e+01  8.68845660e+01  9.55734793e+01
  3.57678173e+02  1.35082328e+03  5.83705183e+03  3.50994205e+04]
E1 = -182.58800240453832  E_coul = 54.06528438603318
Extra cycle  E= -128.522718018505  delta_E= -1.71e-12  |g|= 2.17e-06  |ddm|= 1.55e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498472e+02 1.74907254e+02
 2.04971713e+01 5.69535603e+01 5.70900299e-01 7.81220181e+00
 2.04497068e+00 3.08960042e+00 9.91336069e+00 4.01607723e+01
 2.96818945e-01 9.86677161e-01]
E = -128.52271801850515
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682482        1
[INPUT] 0    0    [1    /1   ]  617.498471551        1
[INPUT] 0    0    [1    /1   ]  174.907254134        1
[INPUT] 0    0    [1    /1   ]  20.4971713189        1
[INPUT] 0    0    [1    /1   ]  56.9535603079        1
[INPUT] 0    0    [1    /1   ]  0.570900298555       1
[INPUT] 0    0    [1    /1   ]  7.81220181124        1
[INPUT] 0    0    [1    /1   ]  2.04497068101        1
[INPUT] 1    0    [1    /1   ]  3.08960042301        1
[INPUT] 1    0    [1    /1   ]  9.91336068994        1
[INPUT] 1    0    [1    /1   ]  40.1607722541        1
[INPUT] 1    0    [1    /1   ]  0.296818944589       1
[INPUT] 1    0    [1    /1   ]  0.986677160639       1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729983883, 1.0]], [0, [2712.0968248201093, 1.0]], [0, [617.4984715509728, 1.0]], [0, [174.90725413407458, 1.0]], [0, [20.49717131886171, 1.0]], [0, [56.95356030790104, 1.0]], [0, [0.5709002985547053, 1.0]], [0, [7.812201811240415, 1.0]], [0, [2.0449706810098567, 1.0]], [1, [3.089600423007613, 1.0]], [1, [9.913360689941362, 1.0]], [1, [40.160772254117624, 1.0]], [1, [0.29681894458919217, 1.0]], [1, [0.9866771606393953, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872998]
bas 1, expnt(s) = [2712.09682482]
bas 2, expnt(s) = [617.49847155]
bas 3, expnt(s) = [174.90725413]
bas 4, expnt(s) = [20.49717132]
bas 5, expnt(s) = [56.95356031]
bas 6, expnt(s) = [0.5709003]
bas 7, expnt(s) = [7.81220181]
bas 8, expnt(s) = [2.04497068]
bas 9, expnt(s) = [3.08960042]
bas 10, expnt(s) = [9.91336069]
bas 11, expnt(s) = [40.16077225]
bas 12, expnt(s) = [0.29681894]
bas 13, expnt(s) = [0.98667716]
CPU time:        96.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498472e+02 3.12962238e+02 1.74907254e+02 1.21512482e+02
 2.04971713e+01 2.43380328e+01 5.69535603e+01 5.23788167e+01
 5.70900299e-01 1.65933941e+00 7.81220181e+00 1.18057917e+01
 2.04497068e+00 4.32046348e+00 3.08960042e+00 1.19498454e+01
 9.91336069e+00 5.13169135e+01 4.01607723e+01 2.94942231e+02
 2.96818945e-01 6.39144290e-01 9.86677161e-01 2.86881958e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997855901777339
cond(S) = 265.5614979313111
E1 = -183.56806440150316  E_coul = 55.08096852407765
init E= -128.487095877426
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773340437156266  LUMO = 0.964291702628359
  mo_energy =
[-3.25545645e+01 -1.84955373e+00 -7.73340437e-01 -7.73340437e-01
 -7.73340437e-01  9.64291703e-01  9.64291703e-01  9.64291703e-01
  2.71598348e+00  4.86217942e+00  4.86217942e+00  4.86217942e+00
  1.93749165e+01  1.93749165e+01  1.93749165e+01  2.13220885e+01
  8.70919352e+01  8.70919352e+01  8.70919352e+01  9.57750231e+01
  3.57914781e+02  1.35109134e+03  5.83734837e+03  3.50997372e+04]
E1 = -182.09691450903222  E_coul = 53.57759842495755
cycle= 1 E= -128.519316084075  delta_E= -0.0322  |g|= 0.203  |ddm|= 0.186
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.4573
diis-c [-0.20912311  1.        ]
  HOMO = -0.878875638107109  LUMO = 0.932896913564472
  mo_energy =
[-3.28746981e+01 -1.96209450e+00 -8.78875638e-01 -8.78875638e-01
 -8.78875638e-01  9.32896914e-01  9.32896914e-01  9.32896914e-01
  2.62446714e+00  4.74834526e+00  4.74834526e+00  4.74834526e+00
  1.91578375e+01  1.91578375e+01  1.91578375e+01  2.11012543e+01
  8.67833056e+01  8.67833056e+01  8.67833056e+01  9.54742698e+01
  3.57566129e+02  1.35070498e+03  5.83693058e+03  3.50992981e+04]
E1 = -182.83474221504474  E_coul = 54.31288558778868
cycle= 2 E= -128.521856627256  delta_E= -0.00254  |g|= 0.101  |ddm|= 0.0762
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.229723
diis-c [-5.83362592e-04  3.33449123e-01  6.66550877e-01]
  HOMO = -0.844378573259134  LUMO = 0.943334625034708
  mo_energy =
[-3.27691151e+01 -1.92554263e+00 -8.44378573e-01 -8.44378573e-01
 -8.44378573e-01  9.43334625e-01  9.43334625e-01  9.43334625e-01
  2.65405708e+00  4.78539512e+00  4.78539512e+00  4.78539512e+00
  1.92295425e+01  1.92295425e+01  1.92295425e+01  2.11741051e+01
  8.68848129e+01  8.68848129e+01  8.68848129e+01  9.55737162e+01
  3.57678445e+02  1.35082361e+03  5.83705221e+03  3.50994209e+04]
E1 = -182.58787363312175  E_coul = 54.06515562117207
cycle= 3 E= -128.52271801195  delta_E= -0.000861  |g|= 0.000277  |ddm|= 0.0258
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000407814
diis-c [-5.34001232e-08 -2.15938862e-03 -2.93993449e-03  1.00509932e+00]
  HOMO = -0.844524916391035  LUMO = 0.943322274067646
  mo_energy =
[-3.27693422e+01 -1.92570028e+00 -8.44524916e-01 -8.44524916e-01
 -8.44524916e-01  9.43322274e-01  9.43322274e-01  9.43322274e-01
  2.65395413e+00  4.78529503e+00  4.78529503e+00  4.78529503e+00
  1.92293725e+01  1.92293725e+01  1.92293725e+01  2.11739212e+01
  8.68845878e+01  8.68845878e+01  8.68845878e+01  9.55735014e+01
  3.57678190e+02  1.35082330e+03  5.83705184e+03  3.50994205e+04]
E1 = -182.58797578809714  E_coul = 54.065257769747994
cycle= 4 E= -128.522718018349  delta_E= -6.4e-09  |g|= 3.94e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.98455e-05
diis-c [-3.57159125e-10  1.70992145e-04  3.28941544e-04 -1.40930520e-01
  1.14043059e+00]
  HOMO = -0.84454285890643  LUMO = 0.943314743149767
  mo_energy =
[-3.27693696e+01 -1.92572590e+00 -8.44542859e-01 -8.44542859e-01
 -8.44542859e-01  9.43314743e-01  9.43314743e-01  9.43314743e-01
  2.65393013e+00  4.78527428e+00  4.78527428e+00  4.78527428e+00
  1.92293448e+01  1.92293448e+01  1.92293448e+01  2.11738912e+01
  8.68845603e+01  8.68845603e+01  8.68845603e+01  9.55734737e+01
  3.57678167e+02  1.35082328e+03  5.83705183e+03  3.50994205e+04]
E1 = -182.58801775107293  E_coul = 54.06529973256949
cycle= 5 E= -128.522718018503  delta_E= -1.54e-10  |g|= 4.34e-06  |ddm|= 2.28e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58801775107293  E_coul = 54.06529973256949
  HOMO = -0.844540516285035  LUMO = 0.943315457786128
  mo_energy =
[-3.27693636e+01 -1.92572397e+00 -8.44540516e-01 -8.44540516e-01
 -8.44540516e-01  9.43315458e-01  9.43315458e-01  9.43315458e-01
  2.65393172e+00  4.78527677e+00  4.78527677e+00  4.78527677e+00
  1.92293492e+01  1.92293492e+01  1.92293492e+01  2.11738955e+01
  8.68845660e+01  8.68845660e+01  8.68845660e+01  9.55734793e+01
  3.57678173e+02  1.35082328e+03  5.83705183e+03  3.50994205e+04]
E1 = -182.58800240453832  E_coul = 54.06528438603318
Extra cycle  E= -128.522718018505  delta_E= -1.71e-12  |g|= 2.17e-06  |ddm|= 1.55e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 265.5614979313111
E1 = -182.58800240453832  E_coul = 54.06528438603318
init E= -128.522718018505
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.844541576855411  LUMO = 0.943315130231863
  mo_energy =
[-3.27693669e+01 -1.92572520e+00 -8.44541577e-01 -8.44541577e-01
 -8.44541577e-01  9.43315130e-01  9.43315130e-01  9.43315130e-01
  2.65393071e+00  4.78527562e+00  4.78527562e+00  4.78527562e+00
  1.92293470e+01  1.92293470e+01  1.92293470e+01  2.11738932e+01
  8.68845628e+01  8.68845628e+01  8.68845628e+01  9.55734762e+01
  3.57678170e+02  1.35082328e+03  5.83705183e+03  3.50994205e+04]
E1 = -182.5880099290349  E_coul = 54.06529191052948
cycle= 1 E= -128.522718018505  delta_E= -2.84e-13  |g|= 1.02e-06  |ddm|= 9.23e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5880099290349  E_coul = 54.06529191052948
  HOMO = -0.844541045324225  LUMO = 0.943315289851413
  mo_energy =
[-3.27693653e+01 -1.92572466e+00 -8.44541045e-01 -8.44541045e-01
 -8.44541045e-01  9.43315290e-01  9.43315290e-01  9.43315290e-01
  2.65393115e+00  4.78527619e+00  4.78527619e+00  4.78527619e+00
  1.92293481e+01  1.92293481e+01  1.92293481e+01  2.11738944e+01
  8.68845644e+01  8.68845644e+01  8.68845644e+01  9.55734777e+01
  3.57678172e+02  1.35082328e+03  5.83705183e+03  3.50994205e+04]
E1 = -182.58800607938  E_coul = 54.065288060874494
Extra cycle  E= -128.522718018505  delta_E= -5.68e-14  |g|= 5.26e-07  |ddm|= 3.85e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498472e+02 1.74907254e+02
 2.04971713e+01 5.69535603e+01 5.70900299e-01 7.81220181e+00
 2.04497068e+00 3.08960042e+00 9.91336069e+00 4.01607723e+01
 2.96818945e-01 9.86677161e-01]
grad_E = [ 5.64605370e-11 -4.33129223e-09  5.16438016e-08 -1.78241414e-06
 -2.65583549e-04  1.49783137e-05  4.31872460e-04  5.33908875e-04
  1.29905493e-02  5.52769791e-04  4.78118031e-05 -4.12030939e-04
 -2.96856200e-03 -2.88880342e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682489        1
[INPUT] 0    0    [1    /1   ]  617.498470487        1
[INPUT] 0    0    [1    /1   ]  174.907278221        1
[INPUT] 0    0    [1    /1   ]  20.4990968711        1
[INPUT] 0    0    [1    /1   ]  56.9533947916        1
[INPUT] 0    0    [1    /1   ]  0.570020843122       1
[INPUT] 0    0    [1    /1   ]  7.81027855216        1
[INPUT] 0    0    [1    /1   ]  2.04346809711        1
[INPUT] 1    0    [1    /1   ]  3.21429117896        1
[INPUT] 1    0    [1    /1   ]  10.2188727302        1
[INPUT] 1    0    [1    /1   ]  41.1009859471        1
[INPUT] 1    0    [1    /1   ]  0.304178352256       1
[INPUT] 1    0    [1    /1   ]  1.0210808893         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729980336, 1.0]], [0, [2712.096824894394, 1.0]], [0, [617.4984704867884, 1.0]], [0, [174.90727822083622, 1.0]], [0, [20.499096871139184, 1.0]], [0, [56.95339479162529, 1.0]], [0, [0.5700208431216726, 1.0]], [0, [7.810278552157643, 1.0]], [0, [2.0434680971074095, 1.0]], [1, [3.214291178956845, 1.0]], [1, [10.218872730222131, 1.0]], [1, [41.100985947133545, 1.0]], [1, [0.3041783522557002, 1.0]], [1, [1.0210808893024723, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872998]
bas 1, expnt(s) = [2712.09682489]
bas 2, expnt(s) = [617.49847049]
bas 3, expnt(s) = [174.90727822]
bas 4, expnt(s) = [20.49909687]
bas 5, expnt(s) = [56.95339479]
bas 6, expnt(s) = [0.57002084]
bas 7, expnt(s) = [7.81027855]
bas 8, expnt(s) = [2.0434681]
bas 9, expnt(s) = [3.21429118]
bas 10, expnt(s) = [10.21887273]
bas 11, expnt(s) = [41.10098595]
bas 12, expnt(s) = [0.30417835]
bas 13, expnt(s) = [1.02108089]
CPU time:        99.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498470e+02 3.12962238e+02 1.74907278e+02 1.21512494e+02
 2.04990969e+01 2.43397476e+01 5.69533948e+01 5.23787025e+01
 5.70020843e-01 1.65742191e+00 7.81027855e+00 1.18036118e+01
 2.04346810e+00 4.31808235e+00 3.21429118e+00 1.25556995e+01
 1.02188727e+01 5.33013404e+01 4.11009859e+01 3.03598550e+02
 3.04178352e-01 6.59014198e-01 1.02108089e+00 2.99439837e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997743047258645
cond(S) = 265.3369039734979
E1 = -183.56829019656206  E_coul = 55.080939282514464
init E= -128.487350914048
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773394788724111  LUMO = 0.996629109404899
  mo_energy =
[-3.25545545e+01 -1.84957103e+00 -7.73394789e-01 -7.73394789e-01
 -7.73394789e-01  9.96629109e-01  9.96629109e-01  9.96629109e-01
  2.71129349e+00  5.05693501e+00  5.05693501e+00  5.05693501e+00
  2.01640871e+01  2.01640871e+01  2.01640871e+01  2.13101031e+01
  8.98955159e+01  8.98955159e+01  8.98955159e+01  9.57627199e+01
  3.57905245e+02  1.35108346e+03  5.83734163e+03  3.50997317e+04]
E1 = -182.10558362511202  E_coul = 53.585873714377485
cycle= 1 E= -128.519709910735  delta_E= -0.0324  |g|= 0.202  |ddm|= 0.187
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.454929
diis-c [-0.20695995  1.        ]
  HOMO = -0.878342069487478  LUMO = 0.964122699840923
  mo_energy =
[-3.28730610e+01 -1.96136403e+00 -8.78342069e-01 -8.78342069e-01
 -8.78342069e-01  9.64122700e-01  9.64122700e-01  9.64122700e-01
  2.62052366e+00  4.94048480e+00  4.94048480e+00  4.94048480e+00
  1.99454387e+01  1.99454387e+01  1.99454387e+01  2.10904092e+01
  8.95874388e+01  8.95874388e+01  8.95874388e+01  9.54634891e+01
  3.57558244e+02  1.35069874e+03  5.83692547e+03  3.50992942e+04]
E1 = -182.8384241275829  E_coul = 54.31619594297748
cycle= 2 E= -128.522228184605  delta_E= -0.00252  |g|=  0.1  |ddm|= 0.0761
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.227948
diis-c [-5.80792287e-04  3.32869288e-01  6.67130712e-01]
  HOMO = -0.844060527820856  LUMO = 0.974938530812672
  mo_energy =
[-3.27680456e+01 -1.92504737e+00 -8.44060528e-01 -8.44060528e-01
 -8.44060528e-01  9.74938531e-01  9.74938531e-01  9.74938531e-01
  2.64989364e+00  4.97838747e+00  4.97838747e+00  4.97838747e+00
  2.00176388e+01  2.00176388e+01  2.00176388e+01  2.11628373e+01
  8.96887093e+01  8.96887093e+01  8.96887093e+01  9.55623971e+01
  3.57669963e+02  1.35081675e+03  5.83704646e+03  3.50994164e+04]
E1 = -182.59358536324694  E_coul = 54.07050788086227
cycle= 3 E= -128.523077482385  delta_E= -0.000849  |g|= 0.000266  |ddm|= 0.0258
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000434421
diis-c [-4.05803550e-08 -2.12618319e-03 -2.63187766e-03  1.00475806e+00]
  HOMO = -0.844205221880719  LUMO = 0.974927383592085
  mo_energy =
[-3.27682795e+01 -1.92519615e+00 -8.44205222e-01 -8.44205222e-01
 -8.44205222e-01  9.74927384e-01  9.74927384e-01  9.74927384e-01
  2.64979966e+00  4.97828681e+00  4.97828681e+00  4.97828681e+00
  2.00174655e+01  2.00174655e+01  2.00174655e+01  2.11626531e+01
  8.96884772e+01  8.96884772e+01  8.96884772e+01  9.55621763e+01
  3.57669697e+02  1.35081642e+03  5.83704607e+03  3.50994159e+04]
E1 = -182.59374830110713  E_coul = 54.07067081376348
cycle= 4 E= -128.523077487344  delta_E= -4.96e-09  |g|= 3.51e-05  |ddm|= 9.35e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.04597e-05
diis-c [-2.64546535e-10  1.36878714e-04  2.91199097e-04 -1.19367168e-01
  1.11893909e+00]
  HOMO = -0.844221970111769  LUMO = 0.97492037786766
  mo_energy =
[-3.27683066e+01 -1.92521867e+00 -8.44221970e-01 -8.44221970e-01
 -8.44221970e-01  9.74920378e-01  9.74920378e-01  9.74920378e-01
  2.64977872e+00  4.97826729e+00  4.97826729e+00  4.97826729e+00
  2.00174391e+01  2.00174391e+01  2.00174391e+01  2.11626249e+01
  8.96884501e+01  8.96884501e+01  8.96884501e+01  9.55621490e+01
  3.57669672e+02  1.35081640e+03  5.83704606e+03  3.50994159e+04]
E1 = -182.59379605773057  E_coul = 54.070718570278615
cycle= 5 E= -128.523077487452  delta_E= -1.08e-10  |g|= 3.56e-06  |ddm|= 1.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59379605773057  E_coul = 54.070718570278615
  HOMO = -0.844220140663205  LUMO = 0.974920944348554
  mo_energy =
[-3.27683018e+01 -1.92521722e+00 -8.44220141e-01 -8.44220141e-01
 -8.44220141e-01  9.74920944e-01  9.74920944e-01  9.74920944e-01
  2.64977989e+00  4.97826928e+00  4.97826928e+00  4.97826928e+00
  2.00174426e+01  2.00174426e+01  2.00174426e+01  2.11626283e+01
  8.96884547e+01  8.96884547e+01  8.96884547e+01  9.55621535e+01
  3.57669677e+02  1.35081640e+03  5.83704606e+03  3.50994159e+04]
E1 = -182.59378350965278  E_coul = 54.070706022199545
Extra cycle  E= -128.523077487453  delta_E= -1.28e-12  |g|= 1.78e-06  |ddm|= 1.37e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498470e+02 1.74907278e+02
 2.04990969e+01 5.69533948e+01 5.70020843e-01 7.81027855e+00
 2.04346810e+00 3.21429118e+00 1.02188727e+01 4.11009859e+01
 3.04178352e-01 1.02108089e+00]
E = -128.52307748745324
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682489        1
[INPUT] 0    0    [1    /1   ]  617.498470487        1
[INPUT] 0    0    [1    /1   ]  174.907278221        1
[INPUT] 0    0    [1    /1   ]  20.4990968711        1
[INPUT] 0    0    [1    /1   ]  56.9533947916        1
[INPUT] 0    0    [1    /1   ]  0.570020843122       1
[INPUT] 0    0    [1    /1   ]  7.81027855216        1
[INPUT] 0    0    [1    /1   ]  2.04346809711        1
[INPUT] 1    0    [1    /1   ]  3.21429117896        1
[INPUT] 1    0    [1    /1   ]  10.2188727302        1
[INPUT] 1    0    [1    /1   ]  41.1009859471        1
[INPUT] 1    0    [1    /1   ]  0.304178352256       1
[INPUT] 1    0    [1    /1   ]  1.0210808893         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729980336, 1.0]], [0, [2712.096824894394, 1.0]], [0, [617.4984704867884, 1.0]], [0, [174.90727822083622, 1.0]], [0, [20.499096871139184, 1.0]], [0, [56.95339479162529, 1.0]], [0, [0.5700208431216726, 1.0]], [0, [7.810278552157643, 1.0]], [0, [2.0434680971074095, 1.0]], [1, [3.214291178956845, 1.0]], [1, [10.218872730222131, 1.0]], [1, [41.100985947133545, 1.0]], [1, [0.3041783522557002, 1.0]], [1, [1.0210808893024723, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872998]
bas 1, expnt(s) = [2712.09682489]
bas 2, expnt(s) = [617.49847049]
bas 3, expnt(s) = [174.90727822]
bas 4, expnt(s) = [20.49909687]
bas 5, expnt(s) = [56.95339479]
bas 6, expnt(s) = [0.57002084]
bas 7, expnt(s) = [7.81027855]
bas 8, expnt(s) = [2.0434681]
bas 9, expnt(s) = [3.21429118]
bas 10, expnt(s) = [10.21887273]
bas 11, expnt(s) = [41.10098595]
bas 12, expnt(s) = [0.30417835]
bas 13, expnt(s) = [1.02108089]
CPU time:       100.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498470e+02 3.12962238e+02 1.74907278e+02 1.21512494e+02
 2.04990969e+01 2.43397476e+01 5.69533948e+01 5.23787025e+01
 5.70020843e-01 1.65742191e+00 7.81027855e+00 1.18036118e+01
 2.04346810e+00 4.31808235e+00 3.21429118e+00 1.25556995e+01
 1.02188727e+01 5.33013404e+01 4.11009859e+01 3.03598550e+02
 3.04178352e-01 6.59014198e-01 1.02108089e+00 2.99439837e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997743047258645
cond(S) = 265.3369039734979
E1 = -183.56829019656206  E_coul = 55.080939282514464
init E= -128.487350914048
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773394788724111  LUMO = 0.996629109404899
  mo_energy =
[-3.25545545e+01 -1.84957103e+00 -7.73394789e-01 -7.73394789e-01
 -7.73394789e-01  9.96629109e-01  9.96629109e-01  9.96629109e-01
  2.71129349e+00  5.05693501e+00  5.05693501e+00  5.05693501e+00
  2.01640871e+01  2.01640871e+01  2.01640871e+01  2.13101031e+01
  8.98955159e+01  8.98955159e+01  8.98955159e+01  9.57627199e+01
  3.57905245e+02  1.35108346e+03  5.83734163e+03  3.50997317e+04]
E1 = -182.10558362511202  E_coul = 53.585873714377485
cycle= 1 E= -128.519709910735  delta_E= -0.0324  |g|= 0.202  |ddm|= 0.187
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.454929
diis-c [-0.20695995  1.        ]
  HOMO = -0.878342069487478  LUMO = 0.964122699840923
  mo_energy =
[-3.28730610e+01 -1.96136403e+00 -8.78342069e-01 -8.78342069e-01
 -8.78342069e-01  9.64122700e-01  9.64122700e-01  9.64122700e-01
  2.62052366e+00  4.94048480e+00  4.94048480e+00  4.94048480e+00
  1.99454387e+01  1.99454387e+01  1.99454387e+01  2.10904092e+01
  8.95874388e+01  8.95874388e+01  8.95874388e+01  9.54634891e+01
  3.57558244e+02  1.35069874e+03  5.83692547e+03  3.50992942e+04]
E1 = -182.8384241275829  E_coul = 54.31619594297748
cycle= 2 E= -128.522228184605  delta_E= -0.00252  |g|=  0.1  |ddm|= 0.0761
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.227948
diis-c [-5.80792287e-04  3.32869288e-01  6.67130712e-01]
  HOMO = -0.844060527820856  LUMO = 0.974938530812672
  mo_energy =
[-3.27680456e+01 -1.92504737e+00 -8.44060528e-01 -8.44060528e-01
 -8.44060528e-01  9.74938531e-01  9.74938531e-01  9.74938531e-01
  2.64989364e+00  4.97838747e+00  4.97838747e+00  4.97838747e+00
  2.00176388e+01  2.00176388e+01  2.00176388e+01  2.11628373e+01
  8.96887093e+01  8.96887093e+01  8.96887093e+01  9.55623971e+01
  3.57669963e+02  1.35081675e+03  5.83704646e+03  3.50994164e+04]
E1 = -182.59358536324694  E_coul = 54.07050788086227
cycle= 3 E= -128.523077482385  delta_E= -0.000849  |g|= 0.000266  |ddm|= 0.0258
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000434421
diis-c [-4.05803550e-08 -2.12618319e-03 -2.63187766e-03  1.00475806e+00]
  HOMO = -0.844205221880719  LUMO = 0.974927383592085
  mo_energy =
[-3.27682795e+01 -1.92519615e+00 -8.44205222e-01 -8.44205222e-01
 -8.44205222e-01  9.74927384e-01  9.74927384e-01  9.74927384e-01
  2.64979966e+00  4.97828681e+00  4.97828681e+00  4.97828681e+00
  2.00174655e+01  2.00174655e+01  2.00174655e+01  2.11626531e+01
  8.96884772e+01  8.96884772e+01  8.96884772e+01  9.55621763e+01
  3.57669697e+02  1.35081642e+03  5.83704607e+03  3.50994159e+04]
E1 = -182.59374830110713  E_coul = 54.07067081376348
cycle= 4 E= -128.523077487344  delta_E= -4.96e-09  |g|= 3.51e-05  |ddm|= 9.35e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.04597e-05
diis-c [-2.64546535e-10  1.36878714e-04  2.91199097e-04 -1.19367168e-01
  1.11893909e+00]
  HOMO = -0.844221970111769  LUMO = 0.97492037786766
  mo_energy =
[-3.27683066e+01 -1.92521867e+00 -8.44221970e-01 -8.44221970e-01
 -8.44221970e-01  9.74920378e-01  9.74920378e-01  9.74920378e-01
  2.64977872e+00  4.97826729e+00  4.97826729e+00  4.97826729e+00
  2.00174391e+01  2.00174391e+01  2.00174391e+01  2.11626249e+01
  8.96884501e+01  8.96884501e+01  8.96884501e+01  9.55621490e+01
  3.57669672e+02  1.35081640e+03  5.83704606e+03  3.50994159e+04]
E1 = -182.59379605773057  E_coul = 54.070718570278615
cycle= 5 E= -128.523077487452  delta_E= -1.08e-10  |g|= 3.56e-06  |ddm|= 1.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59379605773057  E_coul = 54.070718570278615
  HOMO = -0.844220140663205  LUMO = 0.974920944348554
  mo_energy =
[-3.27683018e+01 -1.92521722e+00 -8.44220141e-01 -8.44220141e-01
 -8.44220141e-01  9.74920944e-01  9.74920944e-01  9.74920944e-01
  2.64977989e+00  4.97826928e+00  4.97826928e+00  4.97826928e+00
  2.00174426e+01  2.00174426e+01  2.00174426e+01  2.11626283e+01
  8.96884547e+01  8.96884547e+01  8.96884547e+01  9.55621535e+01
  3.57669677e+02  1.35081640e+03  5.83704606e+03  3.50994159e+04]
E1 = -182.59378350965278  E_coul = 54.070706022199545
Extra cycle  E= -128.523077487453  delta_E= -1.28e-12  |g|= 1.78e-06  |ddm|= 1.37e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 265.3369039734979
E1 = -182.59378350965278  E_coul = 54.070706022199545
init E= -128.523077487453
    CPU time for initialize scf      0.17 sec, wall time      0.17 sec
  HOMO = -0.844221008917368  LUMO = 0.974920663134013
  mo_energy =
[-3.27683045e+01 -1.92521824e+00 -8.44221009e-01 -8.44221009e-01
 -8.44221009e-01  9.74920663e-01  9.74920663e-01  9.74920663e-01
  2.64977906e+00  4.97826831e+00  4.97826831e+00  4.97826831e+00
  2.00174407e+01  2.00174407e+01  2.00174407e+01  2.11626265e+01
  8.96884521e+01  8.96884521e+01  8.96884521e+01  9.55621510e+01
  3.57669675e+02  1.35081640e+03  5.83704606e+03  3.50994159e+04]
E1 = -182.59378958805624  E_coul = 54.07071210060306
cycle= 1 E= -128.523077487453  delta_E= 5.68e-14  |g|= 8.27e-07  |ddm|= 7.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59378958805624  E_coul = 54.07071210060306
  HOMO = -0.844220579681111  LUMO = 0.974920797280917
  mo_energy =
[-3.27683032e+01 -1.92521780e+00 -8.44220580e-01 -8.44220580e-01
 -8.44220580e-01  9.74920797e-01  9.74920797e-01  9.74920797e-01
  2.64977941e+00  4.97826878e+00  4.97826878e+00  4.97826878e+00
  2.00174416e+01  2.00174416e+01  2.00174416e+01  2.11626274e+01
  8.96884534e+01  8.96884534e+01  8.96884534e+01  9.55621523e+01
  3.57669676e+02  1.35081640e+03  5.83704606e+03  3.50994159e+04]
E1 = -182.5937864765028  E_coul = 54.070708989049294
Extra cycle  E= -128.523077487454  delta_E= -3.41e-13  |g|= 4.26e-07  |ddm|= 3.12e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498470e+02 1.74907278e+02
 2.04990969e+01 5.69533948e+01 5.70020843e-01 7.81027855e+00
 2.04346810e+00 3.21429118e+00 1.02188727e+01 4.11009859e+01
 3.04178352e-01 1.02108089e+00]
grad_E = [ 6.18877359e-12 -1.70136209e-09 -3.19137236e-10 -1.20062566e-06
 -2.53249106e-04  1.11690018e-05 -9.10734988e-04  5.21038674e-04
  1.31824312e-02  3.95062882e-03 -4.82482843e-04 -3.74442975e-04
  6.24085972e-04 -7.38514948e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682501        1
[INPUT] 0    0    [1    /1   ]  617.498468928        1
[INPUT] 0    0    [1    /1   ]  174.907316938        1
[INPUT] 0    0    [1    /1   ]  20.5026820546        1
[INPUT] 0    0    [1    /1   ]  56.9531205312        1
[INPUT] 0    0    [1    /1   ]  0.560926308347       1
[INPUT] 0    0    [1    /1   ]  7.8058480607         1
[INPUT] 0    0    [1    /1   ]  1.99604374066        1
[INPUT] 1    0    [1    /1   ]  3.41907260182        1
[INPUT] 1    0    [1    /1   ]  10.7060399329        1
[INPUT] 1    0    [1    /1   ]  42.4108986986        1
[INPUT] 1    0    [1    /1   ]  0.316848085409       1
[INPUT] 1    0    [1    /1   ]  1.07859602022        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729975268, 1.0]], [0, [2712.096825008122, 1.0]], [0, [617.4984689277821, 1.0]], [0, [174.90731693771087, 1.0]], [0, [20.50268205457656, 1.0]], [0, [56.95312053116324, 1.0]], [0, [0.5609263083470283, 1.0]], [0, [7.80584806069801, 1.0]], [0, [1.996043740658011, 1.0]], [1, [3.4190726018173456, 1.0]], [1, [10.706039932868844, 1.0]], [1, [42.41089869858646, 1.0]], [1, [0.31684808540914206, 1.0]], [1, [1.0785960202180063, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872998]
bas 1, expnt(s) = [2712.09682501]
bas 2, expnt(s) = [617.49846893]
bas 3, expnt(s) = [174.90731694]
bas 4, expnt(s) = [20.50268205]
bas 5, expnt(s) = [56.95312053]
bas 6, expnt(s) = [0.56092631]
bas 7, expnt(s) = [7.80584806]
bas 8, expnt(s) = [1.99604374]
bas 9, expnt(s) = [3.4190726]
bas 10, expnt(s) = [10.70603993]
bas 11, expnt(s) = [42.4108987]
bas 12, expnt(s) = [0.31684809]
bas 13, expnt(s) = [1.07859602]
CPU time:       103.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498469e+02 3.12962237e+02 1.74907317e+02 1.21512514e+02
 2.05026821e+01 2.43429402e+01 5.69531205e+01 5.23785133e+01
 5.60926308e-01 1.63754929e+00 7.80584806e+00 1.17985896e+01
 1.99604374e+00 4.24270235e+00 3.41907260e+00 1.35634383e+01
 1.07060399e+01 5.64963598e+01 4.24108987e+01 3.15741187e+02
 3.16848085e-01 6.93502852e-01 1.07859602e+00 3.20669688e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99762898429779
cond(S) = 261.7191694940196
E1 = -183.56926658547974  E_coul = 55.080809585058084
init E= -128.488457000422
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773427345063801  LUMO = 1.05230132471095
  mo_energy =
[-3.25545348e+01 -1.84989937e+00 -7.73427345e-01 -7.73427345e-01
 -7.73427345e-01  1.05230132e+00  1.05230132e+00  1.05230132e+00
  2.63355206e+00  5.38410961e+00  5.38410961e+00  5.38410961e+00
  2.10829471e+01  2.14595543e+01  2.14595543e+01  2.14595543e+01
  9.41345394e+01  9.41345394e+01  9.41345394e+01  9.55244653e+01
  3.57691907e+02  1.35089424e+03  5.83717604e+03  3.50995950e+04]
E1 = -182.11856218869895  E_coul = 53.598060887129904
cycle= 1 E= -128.520501301569  delta_E= -0.032  |g|= 0.201  |ddm|= 0.185
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.451849
diis-c [-0.20416746  1.        ]
  HOMO = -0.877504273199183  LUMO = 1.01788339956986
  mo_energy =
[-3.28707704e+01 -1.96043129e+00 -8.77504273e-01 -8.77504273e-01
 -8.77504273e-01  1.01788340e+00  1.01788340e+00  1.01788340e+00
  2.54556293e+00  5.26353017e+00  5.26353017e+00  5.26353017e+00
  2.08651428e+01  2.12384952e+01  2.12384952e+01  2.12384952e+01
  9.38273399e+01  9.38273399e+01  9.38273399e+01  9.52273130e+01
  3.57347172e+02  1.35051175e+03  5.83676206e+03  3.50991597e+04]
E1 = -182.8442471876292  E_coul = 54.32125798955777
cycle= 2 E= -128.522989198071  delta_E= -0.00249  |g|= 0.0992  |ddm|= 0.0761
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.225421
diis-c [-5.75825723e-04  3.31886495e-01  6.68113505e-01]
  HOMO = -0.843518867541658  LUMO = 1.02934721069467
  mo_energy =
[-3.27665520e+01 -1.92445978e+00 -8.43518868e-01 -8.43518868e-01
 -8.43518868e-01  1.02934721e+00  1.02934721e+00  1.02934721e+00
  2.57410483e+00  5.30280389e+00  5.30280389e+00  5.30280389e+00
  2.09369103e+01  2.13114696e+01  2.13114696e+01  2.13114696e+01
  9.39282467e+01  9.39282467e+01  9.39282467e+01  9.53254844e+01
  3.57458057e+02  1.35062887e+03  5.83688214e+03  3.50992809e+04]
E1 = -182.60237737330397  E_coul = 54.07855645187587
cycle= 3 E= -128.523820921428  delta_E= -0.000832  |g|= 0.000261  |ddm|= 0.0257
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000506938
diis-c [-2.52192810e-08 -2.05488508e-03 -2.02470695e-03  1.00407959e+00]
  HOMO = -0.843662085276267  LUMO = 1.02933741736626
  mo_energy =
[-3.27668030e+01 -1.92459358e+00 -8.43662085e-01 -8.43662085e-01
 -8.43662085e-01  1.02933742e+00  1.02933742e+00  1.02933742e+00
  2.57402776e+00  5.30270065e+00  5.30270065e+00  5.30270065e+00
  2.09367242e+01  2.13112877e+01  2.13112877e+01  2.13112877e+01
  9.39279975e+01  9.39279975e+01  9.39279975e+01  9.53252485e+01
  3.57457763e+02  1.35062850e+03  5.83688170e+03  3.50992804e+04]
E1 = -182.60264390775828  E_coul = 54.07882298251747
cycle= 4 E= -128.523820925241  delta_E= -3.81e-09  |g|= 3.09e-05  |ddm|= 5.81e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.91254e-05
diis-c [-1.17816030e-10  6.31030184e-05  2.42894433e-04 -7.50054795e-02
  1.07469948e+00]
  HOMO = -0.843677487954297  LUMO = 1.02933107440993
  mo_energy =
[-3.27668308e+01 -1.92461146e+00 -8.43677488e-01 -8.43677488e-01
 -8.43677488e-01  1.02933107e+00  1.02933107e+00  1.02933107e+00
  2.57401164e+00  5.30268248e+00  5.30268248e+00  5.30268248e+00
  2.09366982e+01  2.13112624e+01  2.13112624e+01  2.13112624e+01
  9.39279699e+01  9.39279699e+01  9.39279699e+01  9.53252209e+01
  3.57457735e+02  1.35062847e+03  5.83688168e+03  3.50992804e+04]
E1 = -182.60270254099208  E_coul = 54.07888161568155
cycle= 5 E= -128.523820925311  delta_E= -6.97e-11  |g|= 1.73e-06  |ddm|= 9.79e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60270254099208  E_coul = 54.07888161568155
  HOMO = -0.843676709800914  LUMO = 1.02933131214992
  mo_energy =
[-3.27668286e+01 -1.92461089e+00 -8.43676710e-01 -8.43676710e-01
 -8.43676710e-01  1.02933131e+00  1.02933131e+00  1.02933131e+00
  2.57401206e+00  5.30268335e+00  5.30268335e+00  5.30268335e+00
  2.09366998e+01  2.13112639e+01  2.13112639e+01  2.13112639e+01
  9.39279720e+01  9.39279720e+01  9.39279720e+01  9.53252230e+01
  3.57457738e+02  1.35062848e+03  5.83688168e+03  3.50992804e+04]
E1 = -182.60269636159276  E_coul = 54.078875436281905
Extra cycle  E= -128.523820925311  delta_E= -3.41e-13  |g|= 8.76e-07  |ddm|= 7.79e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498469e+02 1.74907317e+02
 2.05026821e+01 5.69531205e+01 5.60926308e-01 7.80584806e+00
 1.99604374e+00 3.41907260e+00 1.07060399e+01 4.24108987e+01
 3.16848085e-01 1.07859602e+00]
E = -128.52382092531087
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682501        1
[INPUT] 0    0    [1    /1   ]  617.498468928        1
[INPUT] 0    0    [1    /1   ]  174.907316938        1
[INPUT] 0    0    [1    /1   ]  20.5026820546        1
[INPUT] 0    0    [1    /1   ]  56.9531205312        1
[INPUT] 0    0    [1    /1   ]  0.560926308347       1
[INPUT] 0    0    [1    /1   ]  7.8058480607         1
[INPUT] 0    0    [1    /1   ]  1.99604374066        1
[INPUT] 1    0    [1    /1   ]  3.41907260182        1
[INPUT] 1    0    [1    /1   ]  10.7060399329        1
[INPUT] 1    0    [1    /1   ]  42.4108986986        1
[INPUT] 1    0    [1    /1   ]  0.316848085409       1
[INPUT] 1    0    [1    /1   ]  1.07859602022        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729975268, 1.0]], [0, [2712.096825008122, 1.0]], [0, [617.4984689277821, 1.0]], [0, [174.90731693771087, 1.0]], [0, [20.50268205457656, 1.0]], [0, [56.95312053116324, 1.0]], [0, [0.5609263083470283, 1.0]], [0, [7.80584806069801, 1.0]], [0, [1.996043740658011, 1.0]], [1, [3.4190726018173456, 1.0]], [1, [10.706039932868844, 1.0]], [1, [42.41089869858646, 1.0]], [1, [0.31684808540914206, 1.0]], [1, [1.0785960202180063, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872998]
bas 1, expnt(s) = [2712.09682501]
bas 2, expnt(s) = [617.49846893]
bas 3, expnt(s) = [174.90731694]
bas 4, expnt(s) = [20.50268205]
bas 5, expnt(s) = [56.95312053]
bas 6, expnt(s) = [0.56092631]
bas 7, expnt(s) = [7.80584806]
bas 8, expnt(s) = [1.99604374]
bas 9, expnt(s) = [3.4190726]
bas 10, expnt(s) = [10.70603993]
bas 11, expnt(s) = [42.4108987]
bas 12, expnt(s) = [0.31684809]
bas 13, expnt(s) = [1.07859602]
CPU time:       103.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498469e+02 3.12962237e+02 1.74907317e+02 1.21512514e+02
 2.05026821e+01 2.43429402e+01 5.69531205e+01 5.23785133e+01
 5.60926308e-01 1.63754929e+00 7.80584806e+00 1.17985896e+01
 1.99604374e+00 4.24270235e+00 3.41907260e+00 1.35634383e+01
 1.07060399e+01 5.64963598e+01 4.24108987e+01 3.15741187e+02
 3.16848085e-01 6.93502852e-01 1.07859602e+00 3.20669688e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99762898429779
cond(S) = 261.7191694940196
E1 = -183.56926658547974  E_coul = 55.080809585058084
init E= -128.488457000422
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773427345063801  LUMO = 1.05230132471095
  mo_energy =
[-3.25545348e+01 -1.84989937e+00 -7.73427345e-01 -7.73427345e-01
 -7.73427345e-01  1.05230132e+00  1.05230132e+00  1.05230132e+00
  2.63355206e+00  5.38410961e+00  5.38410961e+00  5.38410961e+00
  2.10829471e+01  2.14595543e+01  2.14595543e+01  2.14595543e+01
  9.41345394e+01  9.41345394e+01  9.41345394e+01  9.55244653e+01
  3.57691907e+02  1.35089424e+03  5.83717604e+03  3.50995950e+04]
E1 = -182.11856218869895  E_coul = 53.598060887129904
cycle= 1 E= -128.520501301569  delta_E= -0.032  |g|= 0.201  |ddm|= 0.185
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.451849
diis-c [-0.20416746  1.        ]
  HOMO = -0.877504273199183  LUMO = 1.01788339956986
  mo_energy =
[-3.28707704e+01 -1.96043129e+00 -8.77504273e-01 -8.77504273e-01
 -8.77504273e-01  1.01788340e+00  1.01788340e+00  1.01788340e+00
  2.54556293e+00  5.26353017e+00  5.26353017e+00  5.26353017e+00
  2.08651428e+01  2.12384952e+01  2.12384952e+01  2.12384952e+01
  9.38273399e+01  9.38273399e+01  9.38273399e+01  9.52273130e+01
  3.57347172e+02  1.35051175e+03  5.83676206e+03  3.50991597e+04]
E1 = -182.8442471876292  E_coul = 54.32125798955777
cycle= 2 E= -128.522989198071  delta_E= -0.00249  |g|= 0.0992  |ddm|= 0.0761
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.225421
diis-c [-5.75825723e-04  3.31886495e-01  6.68113505e-01]
  HOMO = -0.843518867541658  LUMO = 1.02934721069467
  mo_energy =
[-3.27665520e+01 -1.92445978e+00 -8.43518868e-01 -8.43518868e-01
 -8.43518868e-01  1.02934721e+00  1.02934721e+00  1.02934721e+00
  2.57410483e+00  5.30280389e+00  5.30280389e+00  5.30280389e+00
  2.09369103e+01  2.13114696e+01  2.13114696e+01  2.13114696e+01
  9.39282467e+01  9.39282467e+01  9.39282467e+01  9.53254844e+01
  3.57458057e+02  1.35062887e+03  5.83688214e+03  3.50992809e+04]
E1 = -182.60237737330397  E_coul = 54.07855645187587
cycle= 3 E= -128.523820921428  delta_E= -0.000832  |g|= 0.000261  |ddm|= 0.0257
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000506938
diis-c [-2.52192810e-08 -2.05488508e-03 -2.02470695e-03  1.00407959e+00]
  HOMO = -0.843662085276267  LUMO = 1.02933741736626
  mo_energy =
[-3.27668030e+01 -1.92459358e+00 -8.43662085e-01 -8.43662085e-01
 -8.43662085e-01  1.02933742e+00  1.02933742e+00  1.02933742e+00
  2.57402776e+00  5.30270065e+00  5.30270065e+00  5.30270065e+00
  2.09367242e+01  2.13112877e+01  2.13112877e+01  2.13112877e+01
  9.39279975e+01  9.39279975e+01  9.39279975e+01  9.53252485e+01
  3.57457763e+02  1.35062850e+03  5.83688170e+03  3.50992804e+04]
E1 = -182.60264390775828  E_coul = 54.07882298251747
cycle= 4 E= -128.523820925241  delta_E= -3.81e-09  |g|= 3.09e-05  |ddm|= 5.81e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.91254e-05
diis-c [-1.17816030e-10  6.31030184e-05  2.42894433e-04 -7.50054795e-02
  1.07469948e+00]
  HOMO = -0.843677487954297  LUMO = 1.02933107440993
  mo_energy =
[-3.27668308e+01 -1.92461146e+00 -8.43677488e-01 -8.43677488e-01
 -8.43677488e-01  1.02933107e+00  1.02933107e+00  1.02933107e+00
  2.57401164e+00  5.30268248e+00  5.30268248e+00  5.30268248e+00
  2.09366982e+01  2.13112624e+01  2.13112624e+01  2.13112624e+01
  9.39279699e+01  9.39279699e+01  9.39279699e+01  9.53252209e+01
  3.57457735e+02  1.35062847e+03  5.83688168e+03  3.50992804e+04]
E1 = -182.60270254099208  E_coul = 54.07888161568155
cycle= 5 E= -128.523820925311  delta_E= -6.97e-11  |g|= 1.73e-06  |ddm|= 9.79e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60270254099208  E_coul = 54.07888161568155
  HOMO = -0.843676709800914  LUMO = 1.02933131214992
  mo_energy =
[-3.27668286e+01 -1.92461089e+00 -8.43676710e-01 -8.43676710e-01
 -8.43676710e-01  1.02933131e+00  1.02933131e+00  1.02933131e+00
  2.57401206e+00  5.30268335e+00  5.30268335e+00  5.30268335e+00
  2.09366998e+01  2.13112639e+01  2.13112639e+01  2.13112639e+01
  9.39279720e+01  9.39279720e+01  9.39279720e+01  9.53252230e+01
  3.57457738e+02  1.35062848e+03  5.83688168e+03  3.50992804e+04]
E1 = -182.60269636159276  E_coul = 54.078875436281905
Extra cycle  E= -128.523820925311  delta_E= -3.41e-13  |g|= 8.76e-07  |ddm|= 7.79e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 261.7191694940196
E1 = -182.60269636159276  E_coul = 54.078875436281905
init E= -128.523820925311
    CPU time for initialize scf      0.17 sec, wall time      0.17 sec
  HOMO = -0.843677140388332  LUMO = 1.02933116123824
  mo_energy =
[-3.27668299e+01 -1.92461140e+00 -8.43677140e-01 -8.43677140e-01
 -8.43677140e-01  1.02933116e+00  1.02933116e+00  1.02933116e+00
  2.57401165e+00  5.30268285e+00  5.30268285e+00  5.30268285e+00
  2.09366988e+01  2.13112630e+01  2.13112630e+01  2.13112630e+01
  9.39279708e+01  9.39279708e+01  9.39279708e+01  9.53252218e+01
  3.57457736e+02  1.35062848e+03  5.83688168e+03  3.50992804e+04]
E1 = -182.6026992781017  E_coul = 54.07887835279046
cycle= 1 E= -128.523820925311  delta_E= -3.69e-13  |g|= 3.98e-07  |ddm|= 3.78e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6026992781017  E_coul = 54.07887835279046
  HOMO = -0.84367693463641  LUMO = 1.02933122974981
  mo_energy =
[-3.27668293e+01 -1.92461119e+00 -8.43676935e-01 -8.43676935e-01
 -8.43676935e-01  1.02933123e+00  1.02933123e+00  1.02933123e+00
  2.57401181e+00  5.30268309e+00  5.30268309e+00  5.30268309e+00
  2.09366993e+01  2.13112635e+01  2.13112635e+01  2.13112635e+01
  9.39279714e+01  9.39279714e+01  9.39279714e+01  9.53252224e+01
  3.57457737e+02  1.35062848e+03  5.83688168e+03  3.50992804e+04]
E1 = -182.60269778299332  E_coul = 54.07887685768227
Extra cycle  E= -128.523820925311  delta_E= 1.99e-13  |g|= 2.05e-07  |ddm|= 1.51e-07
    CPU time for scf_cycle      0.23 sec, wall time      0.23 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498469e+02 1.74907317e+02
 2.05026821e+01 5.69531205e+01 5.60926308e-01 7.80584806e+00
 1.99604374e+00 3.41907260e+00 1.07060399e+01 4.24108987e+01
 3.16848085e-01 1.07859602e+00]
grad_E = [-1.43534867e-10  6.17161240e-09 -1.56212934e-07  6.12414660e-07
 -1.94485275e-04 -1.79802001e-06 -2.33175602e-03  3.96277358e-04
  1.26363861e-02  8.11176607e-03 -1.04599042e-03 -3.41216807e-04
  7.68473937e-03 -1.33744992e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682514        1
[INPUT] 0    0    [1    /1   ]  617.498467362        1
[INPUT] 0    0    [1    /1   ]  174.907364712        1
[INPUT] 0    0    [1    /1   ]  20.508030606         1
[INPUT] 0    0    [1    /1   ]  56.9527699451        1
[INPUT] 0    0    [1    /1   ]  0.537398135843       1
[INPUT] 0    0    [1    /1   ]  7.79819204572        1
[INPUT] 0    0    [1    /1   ]  1.86484401715        1
[INPUT] 1    0    [1    /1   ]  3.67261971837        1
[INPUT] 1    0    [1    /1   ]  11.3031734283        1
[INPUT] 1    0    [1    /1   ]  43.8018823973        1
[INPUT] 1    0    [1    /1   ]  0.331315231153       1
[INPUT] 1    0    [1    /1   ]  1.14963547022        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729969895, 1.0]], [0, [2712.096825135925, 1.0]], [0, [617.498467362135, 1.0]], [0, [174.9073647124517, 1.0]], [0, [20.508030605976646, 1.0]], [0, [56.9527699450702, 1.0]], [0, [0.5373981358433827, 1.0]], [0, [7.798192045720144, 1.0]], [0, [1.864844017148882, 1.0]], [1, [3.6726197183679123, 1.0]], [1, [11.303173428321086, 1.0]], [1, [43.801882397252044, 1.0]], [1, [0.33131523115349176, 1.0]], [1, [1.149635470222253, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682514]
bas 2, expnt(s) = [617.49846736]
bas 3, expnt(s) = [174.90736471]
bas 4, expnt(s) = [20.50803061]
bas 5, expnt(s) = [56.95276995]
bas 6, expnt(s) = [0.53739814]
bas 7, expnt(s) = [7.79819205]
bas 8, expnt(s) = [1.86484402]
bas 9, expnt(s) = [3.67261972]
bas 10, expnt(s) = [11.30317343]
bas 11, expnt(s) = [43.8018824]
bas 12, expnt(s) = [0.33131523]
bas 13, expnt(s) = [1.14963547]
CPU time:       106.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498467e+02 3.12962237e+02 1.74907365e+02 1.21512539e+02
 2.05080306e+01 2.43477028e+01 5.69527699e+01 5.23782715e+01
 5.37398136e-01 1.58575884e+00 7.79819205e+00 1.17899094e+01
 1.86484402e+00 4.03178076e+00 3.67261972e+00 1.48321580e+01
 1.13031734e+01 6.04623303e+01 4.38018824e+01 3.28738342e+02
 3.31315231e-01 7.33307530e-01 1.14963547e+00 3.47283849e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997579052188337
cond(S) = 252.52040578009974
E1 = -183.57137238710732  E_coul = 55.080525758069626
init E= -128.490846629038
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773389904932368  LUMO = 1.11850415507119
  mo_energy =
[-3.25545390e+01 -1.85066710e+00 -7.73389905e-01 -7.73389905e-01
 -7.73389905e-01  1.11850416e+00  1.11850416e+00  1.11850416e+00
  2.42645645e+00  5.78805284e+00  5.78805284e+00  5.78805284e+00
  2.04609729e+01  2.30649093e+01  2.30649093e+01  2.30649093e+01
  9.48785126e+01  9.90438699e+01  9.90438699e+01  9.90438699e+01
  3.57111486e+02  1.35037835e+03  5.83672425e+03  3.50992220e+04]
E1 = -182.13061644764153  E_coul = 53.608987593716236
cycle= 1 E= -128.521628853925  delta_E= -0.0308  |g|= 0.199  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.448998
diis-c [-0.20159946  1.        ]
  HOMO = -0.876668998226716  LUMO = 1.08167365707353
  mo_energy =
[-3.28689214e+01 -1.95985066e+00 -8.76668998e-01 -8.76668998e-01
 -8.76668998e-01  1.08167366e+00  1.08167366e+00  1.08167366e+00
  2.34430619e+00  5.66241927e+00  5.66241927e+00  5.66241927e+00
  2.02453650e+01  2.28406575e+01  2.28406575e+01  2.28406575e+01
  9.45829512e+01  9.87371729e+01  9.87371729e+01  9.87371729e+01
  3.56768512e+02  1.34999750e+03  5.83631181e+03  3.50987881e+04]
E1 = -182.84971384773937  E_coul = 54.32562450892442
cycle= 2 E= -128.524089338815  delta_E= -0.00246  |g|= 0.0982  |ddm|= 0.0763
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.222852
diis-c [-5.68618097e-04  3.30736627e-01  6.69263373e-01]
  HOMO = -0.842932053751127  LUMO = 1.09393810458507
  mo_energy =
[-3.27654146e+01 -1.92421016e+00 -8.42932054e-01 -8.42932054e-01
 -8.42932054e-01  1.09393810e+00  1.09393810e+00  1.09393810e+00
  2.37104628e+00  5.70338161e+00  5.70338161e+00  5.70338161e+00
  2.03164196e+01  2.29146455e+01  2.29146455e+01  2.29146455e+01
  9.46805064e+01  9.88377992e+01  9.88377992e+01  9.88377992e+01
  3.56878660e+02  1.35011382e+03  5.83643106e+03  3.50989085e+04]
E1 = -182.61049959745145  E_coul = 54.08559504824821
cycle= 3 E= -128.524904549203  delta_E= -0.000815  |g|= 0.000295  |ddm|= 0.0258
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000654057
diis-c [-2.29113329e-08 -2.00786003e-03 -1.20284237e-03  1.00321070e+00]
  HOMO = -0.843086485135893  LUMO = 1.09392307202515
  mo_energy =
[-3.27657146e+01 -1.92434527e+00 -8.43086485e-01 -8.43086485e-01
 -8.43086485e-01  1.09392307e+00  1.09392307e+00  1.09392307e+00
  2.37097522e+00  5.70325809e+00  5.70325809e+00  5.70325809e+00
  2.03162112e+01  2.29144285e+01  2.29144285e+01  2.29144285e+01
  9.46802254e+01  9.88375017e+01  9.88375017e+01  9.88375017e+01
  3.56878304e+02  1.35011337e+03  5.83643053e+03  3.50989079e+04]
E1 = -182.61091055845563  E_coul = 54.086006004111965
cycle= 4 E= -128.524904554344  delta_E= -5.14e-09  |g|= 3.33e-05  |ddm|= 4.52e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.53813e-05
diis-c [-9.18526520e-11  4.97465302e-05  2.74668577e-04 -6.38450433e-02
  1.06352063e+00]
  HOMO = -0.843102475725737  LUMO = 1.09391643662693
  mo_energy =
[-3.27657464e+01 -1.92436131e+00 -8.43102476e-01 -8.43102476e-01
 -8.43102476e-01  1.09391644e+00  1.09391644e+00  1.09391644e+00
  2.37096168e+00  5.70323879e+00  5.70323879e+00  5.70323879e+00
  2.03161844e+01  2.29144010e+01  2.29144010e+01  2.29144010e+01
  9.46801944e+01  9.88374703e+01  9.88374703e+01  9.88374703e+01
  3.56878271e+02  1.35011334e+03  5.83643049e+03  3.50989079e+04]
E1 = -182.61098291247578  E_coul = 54.08607835804761
cycle= 5 E= -128.524904554428  delta_E= -8.45e-11  |g|= 7.44e-07  |ddm|= 6.79e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61098291247578  E_coul = 54.08607835804761
  HOMO = -0.843102180252841  LUMO = 1.09391654372565
  mo_energy =
[-3.27657456e+01 -1.92436093e+00 -8.43102180e-01 -8.43102180e-01
 -8.43102180e-01  1.09391654e+00  1.09391654e+00  1.09391654e+00
  2.37096197e+00  5.70323915e+00  5.70323915e+00  5.70323915e+00
  2.03161851e+01  2.29144017e+01  2.29144017e+01  2.29144017e+01
  9.46801951e+01  9.88374710e+01  9.88374710e+01  9.88374710e+01
  3.56878271e+02  1.35011334e+03  5.83643050e+03  3.50989079e+04]
E1 = -182.61098055325328  E_coul = 54.08607599882519
Extra cycle  E= -128.524904554428  delta_E= 5.68e-14  |g|= 3.16e-07  |ddm|= 3.41e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498467e+02 1.74907365e+02
 2.05080306e+01 5.69527699e+01 5.37398136e-01 7.79819205e+00
 1.86484402e+00 3.67261972e+00 1.13031734e+01 4.38018824e+01
 3.31315231e-01 1.14963547e+00]
E = -128.5249045544281
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682514        1
[INPUT] 0    0    [1    /1   ]  617.498467362        1
[INPUT] 0    0    [1    /1   ]  174.907364712        1
[INPUT] 0    0    [1    /1   ]  20.508030606         1
[INPUT] 0    0    [1    /1   ]  56.9527699451        1
[INPUT] 0    0    [1    /1   ]  0.537398135843       1
[INPUT] 0    0    [1    /1   ]  7.79819204572        1
[INPUT] 0    0    [1    /1   ]  1.86484401715        1
[INPUT] 1    0    [1    /1   ]  3.67261971837        1
[INPUT] 1    0    [1    /1   ]  11.3031734283        1
[INPUT] 1    0    [1    /1   ]  43.8018823973        1
[INPUT] 1    0    [1    /1   ]  0.331315231153       1
[INPUT] 1    0    [1    /1   ]  1.14963547022        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729969895, 1.0]], [0, [2712.096825135925, 1.0]], [0, [617.498467362135, 1.0]], [0, [174.9073647124517, 1.0]], [0, [20.508030605976646, 1.0]], [0, [56.9527699450702, 1.0]], [0, [0.5373981358433827, 1.0]], [0, [7.798192045720144, 1.0]], [0, [1.864844017148882, 1.0]], [1, [3.6726197183679123, 1.0]], [1, [11.303173428321086, 1.0]], [1, [43.801882397252044, 1.0]], [1, [0.33131523115349176, 1.0]], [1, [1.149635470222253, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682514]
bas 2, expnt(s) = [617.49846736]
bas 3, expnt(s) = [174.90736471]
bas 4, expnt(s) = [20.50803061]
bas 5, expnt(s) = [56.95276995]
bas 6, expnt(s) = [0.53739814]
bas 7, expnt(s) = [7.79819205]
bas 8, expnt(s) = [1.86484402]
bas 9, expnt(s) = [3.67261972]
bas 10, expnt(s) = [11.30317343]
bas 11, expnt(s) = [43.8018824]
bas 12, expnt(s) = [0.33131523]
bas 13, expnt(s) = [1.14963547]
CPU time:       107.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498467e+02 3.12962237e+02 1.74907365e+02 1.21512539e+02
 2.05080306e+01 2.43477028e+01 5.69527699e+01 5.23782715e+01
 5.37398136e-01 1.58575884e+00 7.79819205e+00 1.17899094e+01
 1.86484402e+00 4.03178076e+00 3.67261972e+00 1.48321580e+01
 1.13031734e+01 6.04623303e+01 4.38018824e+01 3.28738342e+02
 3.31315231e-01 7.33307530e-01 1.14963547e+00 3.47283849e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997579052188337
cond(S) = 252.52040578009974
E1 = -183.57137238710732  E_coul = 55.080525758069626
init E= -128.490846629038
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773389904932368  LUMO = 1.11850415507119
  mo_energy =
[-3.25545390e+01 -1.85066710e+00 -7.73389905e-01 -7.73389905e-01
 -7.73389905e-01  1.11850416e+00  1.11850416e+00  1.11850416e+00
  2.42645645e+00  5.78805284e+00  5.78805284e+00  5.78805284e+00
  2.04609729e+01  2.30649093e+01  2.30649093e+01  2.30649093e+01
  9.48785126e+01  9.90438699e+01  9.90438699e+01  9.90438699e+01
  3.57111486e+02  1.35037835e+03  5.83672425e+03  3.50992220e+04]
E1 = -182.13061644764153  E_coul = 53.608987593716236
cycle= 1 E= -128.521628853925  delta_E= -0.0308  |g|= 0.199  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.448998
diis-c [-0.20159946  1.        ]
  HOMO = -0.876668998226716  LUMO = 1.08167365707353
  mo_energy =
[-3.28689214e+01 -1.95985066e+00 -8.76668998e-01 -8.76668998e-01
 -8.76668998e-01  1.08167366e+00  1.08167366e+00  1.08167366e+00
  2.34430619e+00  5.66241927e+00  5.66241927e+00  5.66241927e+00
  2.02453650e+01  2.28406575e+01  2.28406575e+01  2.28406575e+01
  9.45829512e+01  9.87371729e+01  9.87371729e+01  9.87371729e+01
  3.56768512e+02  1.34999750e+03  5.83631181e+03  3.50987881e+04]
E1 = -182.84971384773937  E_coul = 54.32562450892442
cycle= 2 E= -128.524089338815  delta_E= -0.00246  |g|= 0.0982  |ddm|= 0.0763
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.222852
diis-c [-5.68618097e-04  3.30736627e-01  6.69263373e-01]
  HOMO = -0.842932053751127  LUMO = 1.09393810458507
  mo_energy =
[-3.27654146e+01 -1.92421016e+00 -8.42932054e-01 -8.42932054e-01
 -8.42932054e-01  1.09393810e+00  1.09393810e+00  1.09393810e+00
  2.37104628e+00  5.70338161e+00  5.70338161e+00  5.70338161e+00
  2.03164196e+01  2.29146455e+01  2.29146455e+01  2.29146455e+01
  9.46805064e+01  9.88377992e+01  9.88377992e+01  9.88377992e+01
  3.56878660e+02  1.35011382e+03  5.83643106e+03  3.50989085e+04]
E1 = -182.61049959745145  E_coul = 54.08559504824821
cycle= 3 E= -128.524904549203  delta_E= -0.000815  |g|= 0.000295  |ddm|= 0.0258
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000654057
diis-c [-2.29113329e-08 -2.00786003e-03 -1.20284237e-03  1.00321070e+00]
  HOMO = -0.843086485135893  LUMO = 1.09392307202515
  mo_energy =
[-3.27657146e+01 -1.92434527e+00 -8.43086485e-01 -8.43086485e-01
 -8.43086485e-01  1.09392307e+00  1.09392307e+00  1.09392307e+00
  2.37097522e+00  5.70325809e+00  5.70325809e+00  5.70325809e+00
  2.03162112e+01  2.29144285e+01  2.29144285e+01  2.29144285e+01
  9.46802254e+01  9.88375017e+01  9.88375017e+01  9.88375017e+01
  3.56878304e+02  1.35011337e+03  5.83643053e+03  3.50989079e+04]
E1 = -182.61091055845563  E_coul = 54.086006004111965
cycle= 4 E= -128.524904554344  delta_E= -5.14e-09  |g|= 3.33e-05  |ddm|= 4.52e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.53813e-05
diis-c [-9.18526520e-11  4.97465302e-05  2.74668577e-04 -6.38450433e-02
  1.06352063e+00]
  HOMO = -0.843102475725737  LUMO = 1.09391643662693
  mo_energy =
[-3.27657464e+01 -1.92436131e+00 -8.43102476e-01 -8.43102476e-01
 -8.43102476e-01  1.09391644e+00  1.09391644e+00  1.09391644e+00
  2.37096168e+00  5.70323879e+00  5.70323879e+00  5.70323879e+00
  2.03161844e+01  2.29144010e+01  2.29144010e+01  2.29144010e+01
  9.46801944e+01  9.88374703e+01  9.88374703e+01  9.88374703e+01
  3.56878271e+02  1.35011334e+03  5.83643049e+03  3.50989079e+04]
E1 = -182.61098291247578  E_coul = 54.08607835804761
cycle= 5 E= -128.524904554428  delta_E= -8.45e-11  |g|= 7.44e-07  |ddm|= 6.79e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61098291247578  E_coul = 54.08607835804761
  HOMO = -0.843102180252841  LUMO = 1.09391654372565
  mo_energy =
[-3.27657456e+01 -1.92436093e+00 -8.43102180e-01 -8.43102180e-01
 -8.43102180e-01  1.09391654e+00  1.09391654e+00  1.09391654e+00
  2.37096197e+00  5.70323915e+00  5.70323915e+00  5.70323915e+00
  2.03161851e+01  2.29144017e+01  2.29144017e+01  2.29144017e+01
  9.46801951e+01  9.88374710e+01  9.88374710e+01  9.88374710e+01
  3.56878271e+02  1.35011334e+03  5.83643050e+03  3.50989079e+04]
E1 = -182.61098055325328  E_coul = 54.08607599882519
Extra cycle  E= -128.524904554428  delta_E= 5.68e-14  |g|= 3.16e-07  |ddm|= 3.41e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 252.52040578009974
E1 = -182.61098055325328  E_coul = 54.08607599882519
init E= -128.524904554428
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.843102350353643  LUMO = 1.09391648128914
  mo_energy =
[-3.27657461e+01 -1.92436110e+00 -8.43102350e-01 -8.43102350e-01
 -8.43102350e-01  1.09391648e+00  1.09391648e+00  1.09391648e+00
  2.37096184e+00  5.70323895e+00  5.70323895e+00  5.70323895e+00
  2.03161847e+01  2.29144013e+01  2.29144013e+01  2.29144013e+01
  9.46801947e+01  9.88374705e+01  9.88374705e+01  9.88374705e+01
  3.56878271e+02  1.35011334e+03  5.83643049e+03  3.50989078e+04]
E1 = -182.6109817135555  E_coul = 54.08607715912734
cycle= 1 E= -128.524904554428  delta_E= -5.68e-14  |g|= 1.6e-07  |ddm|= 1.15e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6109817135555  E_coul = 54.08607715912734
  HOMO = -0.843102269385735  LUMO = 1.09391651076803
  mo_energy =
[-3.27657459e+01 -1.92436101e+00 -8.43102269e-01 -8.43102269e-01
 -8.43102269e-01  1.09391651e+00  1.09391651e+00  1.09391651e+00
  2.37096190e+00  5.70323904e+00  5.70323904e+00  5.70323904e+00
  2.03161849e+01  2.29144015e+01  2.29144015e+01  2.29144015e+01
  9.46801949e+01  9.88374708e+01  9.88374708e+01  9.88374708e+01
  3.56878271e+02  1.35011334e+03  5.83643049e+03  3.50989079e+04]
E1 = -182.61098113400146  E_coul = 54.08607657957343
Extra cycle  E= -128.524904554428  delta_E= 1.42e-13  |g|= 7.9e-08  |ddm|= 6.44e-08
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498467e+02 1.74907365e+02
 2.05080306e+01 5.69527699e+01 5.37398136e-01 7.79819205e+00
 1.86484402e+00 3.67261972e+00 1.13031734e+01 4.38018824e+01
 3.31315231e-01 1.14963547e+00]
grad_E = [-4.82477403e-10  2.42355158e-08 -5.08808942e-07  4.89607310e-06
 -2.43069680e-05 -3.28229500e-05  2.27565892e-03  3.09879128e-05
  8.68786644e-03  1.09895291e-02 -1.33471620e-03 -3.26845741e-04
  9.92726217e-03 -1.61021799e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682519        1
[INPUT] 0    0    [1    /1   ]  617.498467049        1
[INPUT] 0    0    [1    /1   ]  174.907392843        1
[INPUT] 0    0    [1    /1   ]  20.5124054444        1
[INPUT] 0    0    [1    /1   ]  56.9525521162        1
[INPUT] 0    0    [1    /1   ]  0.508075769925       1
[INPUT] 0    0    [1    /1   ]  7.79136875072        1
[INPUT] 0    0    [1    /1   ]  1.71663371288        1
[INPUT] 1    0    [1    /1   ]  3.80123274513        1
[INPUT] 1    0    [1    /1   ]  11.6489448062        1
[INPUT] 1    0    [1    /1   ]  44.6315709013        1
[INPUT] 1    0    [1    /1   ]  0.338418347814       1
[INPUT] 1    0    [1    /1   ]  1.18343722529        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729967253, 1.0]], [0, [2712.0968251910094, 1.0]], [0, [617.4984670490605, 1.0]], [0, [174.90739284347916, 1.0]], [0, [20.5124054443668, 1.0]], [0, [56.95255211615827, 1.0]], [0, [0.5080757699253861, 1.0]], [0, [7.791368750715915, 1.0]], [0, [1.7166337128776847, 1.0]], [1, [3.8012327451302985, 1.0]], [1, [11.648944806184213, 1.0]], [1, [44.631570901302474, 1.0]], [1, [0.3384183478141913, 1.0]], [1, [1.183437225286908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682519]
bas 2, expnt(s) = [617.49846705]
bas 3, expnt(s) = [174.90739284]
bas 4, expnt(s) = [20.51240544]
bas 5, expnt(s) = [56.95255212]
bas 6, expnt(s) = [0.50807577]
bas 7, expnt(s) = [7.79136875]
bas 8, expnt(s) = [1.71663371]
bas 9, expnt(s) = [3.80123275]
bas 10, expnt(s) = [11.64894481]
bas 11, expnt(s) = [44.6315709]
bas 12, expnt(s) = [0.33841835]
bas 13, expnt(s) = [1.18343723]
CPU time:       109.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498467e+02 3.12962237e+02 1.74907393e+02 1.21512554e+02
 2.05124054e+01 2.43515981e+01 5.69525521e+01 5.23781213e+01
 5.08075770e-01 1.52041234e+00 7.79136875e+00 1.17821716e+01
 1.71663371e+00 3.78898820e+00 3.80123275e+00 1.54842427e+01
 1.16489448e+01 6.27830814e+01 4.46315709e+01 3.36540324e+02
 3.38418348e-01 7.53011777e-01 1.18343723e+00 3.60094033e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997670897053975
cond(S) = 242.83795038478968
E1 = -183.57169241147193  E_coul = 55.079552023541915
init E= -128.49214038793
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773422949900888  LUMO = 1.15100604562632
  mo_energy =
[-3.25546922e+01 -1.85125252e+00 -7.73422950e-01 -7.73422950e-01
 -7.73422950e-01  1.15100605e+00  1.15100605e+00  1.15100605e+00
  2.18721320e+00  5.98736329e+00  5.98736329e+00  5.98736329e+00
  1.97363142e+01  2.39186455e+01  2.39186455e+01  2.39186455e+01
  9.41416683e+01  1.01847805e+02  1.01847805e+02  1.01847805e+02
  3.56451416e+02  1.34979189e+03  5.83621067e+03  3.50987979e+04]
E1 = -182.13374738614993  E_coul = 53.611422344835
cycle= 1 E= -128.522325041315  delta_E= -0.0302  |g|= 0.198  |ddm|= 0.173
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.448854
diis-c [-0.20146998  1.        ]
  HOMO = -0.876423043735346  LUMO = 1.11294490627817
  mo_energy =
[-3.28689920e+01 -1.95964229e+00 -8.76423044e-01 -8.76423044e-01
 -8.76423044e-01  1.11294491e+00  1.11294491e+00  1.11294491e+00
  2.11148070e+00  5.85918290e+00  5.85918290e+00  5.85918290e+00
  1.95219303e+01  2.36921400e+01  2.36921400e+01  2.36921400e+01
  9.38460102e+01  1.01540455e+02  1.01540455e+02  1.01540455e+02
  3.56108302e+02  1.34941061e+03  5.83579763e+03  3.50983633e+04]
E1 = -182.8517726467316  E_coul = 54.32698841638806
cycle= 2 E= -128.524784230344  delta_E= -0.00246  |g|= 0.098  |ddm|= 0.0767
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.221919
diis-c [-5.61367382e-04  3.29880906e-01  6.70119094e-01]
  HOMO = -0.842671106328369  LUMO = 1.12564394090028
  mo_energy =
[-3.27655334e+01 -1.92405235e+00 -8.42671106e-01 -8.42671106e-01
 -8.42671106e-01  1.12564394e+00  1.12564394e+00  1.12564394e+00
  2.13630308e+00  5.90109612e+00  5.90109612e+00  5.90109612e+00
  1.95927648e+01  2.37669263e+01  2.37669263e+01  2.37669263e+01
  9.39435965e+01  1.01641282e+02  1.01641282e+02  1.01641282e+02
  3.56218404e+02  1.34952685e+03  5.83591677e+03  3.50984835e+04]
E1 = -182.61319034008622  E_coul = 54.08759585790515
cycle= 3 E= -128.525594482181  delta_E= -0.00081  |g|= 0.00034  |ddm|= 0.0259
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000813861
diis-c [-3.47742526e-08 -1.95659526e-03 -3.84670143e-04  1.00234127e+00]
  HOMO = -0.842835379051377  LUMO = 1.1256250378802
  mo_energy =
[-3.27658856e+01 -1.92418669e+00 -8.42835379e-01 -8.42835379e-01
 -8.42835379e-01  1.12562504e+00  1.12562504e+00  1.12562504e+00
  2.13624172e+00  5.90095621e+00  5.90095621e+00  5.90095621e+00
  1.95925390e+01  2.37666752e+01  2.37666752e+01  2.37666752e+01
  9.39432687e+01  1.01640934e+02  1.01640934e+02  1.01640934e+02
  3.56217980e+02  1.34952631e+03  5.83591614e+03  3.50984828e+04]
E1 = -182.6137278945226  E_coul = 54.08813340467356
cycle= 4 E= -128.525594489849  delta_E= -7.67e-09  |g|= 4.02e-05  |ddm|= 4.83e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.77404e-05
diis-c [-1.81859111e-10  1.02547739e-04  3.48002973e-04 -9.28480795e-02
  1.09239753e+00]
  HOMO = -0.842853708359871  LUMO = 1.12561752018371
  mo_energy =
[-3.27659248e+01 -1.92420263e+00 -8.42853708e-01 -8.42853708e-01
 -8.42853708e-01  1.12561752e+00  1.12561752e+00  1.12561752e+00
  2.13622942e+00  5.90093389e+00  5.90093389e+00  5.90093389e+00
  1.95925088e+01  2.37666426e+01  2.37666426e+01  2.37666426e+01
  9.39432309e+01  1.01640895e+02  1.01640895e+02  1.01640895e+02
  3.56217937e+02  1.34952626e+03  5.83591609e+03  3.50984828e+04]
E1 = -182.61381979748165  E_coul = 54.0882253074922
cycle= 5 E= -128.525594489989  delta_E= -1.4e-10  |g|= 1.74e-06  |ddm|= 8.55e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61381979748165  E_coul = 54.0882253074922
  HOMO = -0.842853129901159  LUMO = 1.12561777969398
  mo_energy =
[-3.27659235e+01 -1.92420168e+00 -8.42853130e-01 -8.42853130e-01
 -8.42853130e-01  1.12561778e+00  1.12561778e+00  1.12561778e+00
  2.13623015e+00  5.90093464e+00  5.90093464e+00  5.90093464e+00
  1.95925100e+01  2.37666438e+01  2.37666438e+01  2.37666438e+01
  9.39432321e+01  1.01640896e+02  1.01640896e+02  1.01640896e+02
  3.56217938e+02  1.34952626e+03  5.83591609e+03  3.50984828e+04]
E1 = -182.61381666955847  E_coul = 54.08822217956895
Extra cycle  E= -128.52559448999  delta_E= -5.68e-14  |g|= 4.82e-07  |ddm|= 9.85e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498467e+02 1.74907393e+02
 2.05124054e+01 5.69525521e+01 5.08075770e-01 7.79136875e+00
 1.71663371e+00 3.80123275e+00 1.16489448e+01 4.46315709e+01
 3.38418348e-01 1.18343723e+00]
E = -128.52559448998952
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682519        1
[INPUT] 0    0    [1    /1   ]  617.498467049        1
[INPUT] 0    0    [1    /1   ]  174.907392843        1
[INPUT] 0    0    [1    /1   ]  20.5124054444        1
[INPUT] 0    0    [1    /1   ]  56.9525521162        1
[INPUT] 0    0    [1    /1   ]  0.508075769925       1
[INPUT] 0    0    [1    /1   ]  7.79136875072        1
[INPUT] 0    0    [1    /1   ]  1.71663371288        1
[INPUT] 1    0    [1    /1   ]  3.80123274513        1
[INPUT] 1    0    [1    /1   ]  11.6489448062        1
[INPUT] 1    0    [1    /1   ]  44.6315709013        1
[INPUT] 1    0    [1    /1   ]  0.338418347814       1
[INPUT] 1    0    [1    /1   ]  1.18343722529        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729967253, 1.0]], [0, [2712.0968251910094, 1.0]], [0, [617.4984670490605, 1.0]], [0, [174.90739284347916, 1.0]], [0, [20.5124054443668, 1.0]], [0, [56.95255211615827, 1.0]], [0, [0.5080757699253861, 1.0]], [0, [7.791368750715915, 1.0]], [0, [1.7166337128776847, 1.0]], [1, [3.8012327451302985, 1.0]], [1, [11.648944806184213, 1.0]], [1, [44.631570901302474, 1.0]], [1, [0.3384183478141913, 1.0]], [1, [1.183437225286908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682519]
bas 2, expnt(s) = [617.49846705]
bas 3, expnt(s) = [174.90739284]
bas 4, expnt(s) = [20.51240544]
bas 5, expnt(s) = [56.95255212]
bas 6, expnt(s) = [0.50807577]
bas 7, expnt(s) = [7.79136875]
bas 8, expnt(s) = [1.71663371]
bas 9, expnt(s) = [3.80123275]
bas 10, expnt(s) = [11.64894481]
bas 11, expnt(s) = [44.6315709]
bas 12, expnt(s) = [0.33841835]
bas 13, expnt(s) = [1.18343723]
CPU time:       110.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498467e+02 3.12962237e+02 1.74907393e+02 1.21512554e+02
 2.05124054e+01 2.43515981e+01 5.69525521e+01 5.23781213e+01
 5.08075770e-01 1.52041234e+00 7.79136875e+00 1.17821716e+01
 1.71663371e+00 3.78898820e+00 3.80123275e+00 1.54842427e+01
 1.16489448e+01 6.27830814e+01 4.46315709e+01 3.36540324e+02
 3.38418348e-01 7.53011777e-01 1.18343723e+00 3.60094033e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997670897053975
cond(S) = 242.83795038478968
E1 = -183.57169241147193  E_coul = 55.079552023541915
init E= -128.49214038793
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773422949900888  LUMO = 1.15100604562632
  mo_energy =
[-3.25546922e+01 -1.85125252e+00 -7.73422950e-01 -7.73422950e-01
 -7.73422950e-01  1.15100605e+00  1.15100605e+00  1.15100605e+00
  2.18721320e+00  5.98736329e+00  5.98736329e+00  5.98736329e+00
  1.97363142e+01  2.39186455e+01  2.39186455e+01  2.39186455e+01
  9.41416683e+01  1.01847805e+02  1.01847805e+02  1.01847805e+02
  3.56451416e+02  1.34979189e+03  5.83621067e+03  3.50987979e+04]
E1 = -182.13374738614993  E_coul = 53.611422344835
cycle= 1 E= -128.522325041315  delta_E= -0.0302  |g|= 0.198  |ddm|= 0.173
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.448854
diis-c [-0.20146998  1.        ]
  HOMO = -0.876423043735346  LUMO = 1.11294490627817
  mo_energy =
[-3.28689920e+01 -1.95964229e+00 -8.76423044e-01 -8.76423044e-01
 -8.76423044e-01  1.11294491e+00  1.11294491e+00  1.11294491e+00
  2.11148070e+00  5.85918290e+00  5.85918290e+00  5.85918290e+00
  1.95219303e+01  2.36921400e+01  2.36921400e+01  2.36921400e+01
  9.38460102e+01  1.01540455e+02  1.01540455e+02  1.01540455e+02
  3.56108302e+02  1.34941061e+03  5.83579763e+03  3.50983633e+04]
E1 = -182.8517726467316  E_coul = 54.32698841638806
cycle= 2 E= -128.524784230344  delta_E= -0.00246  |g|= 0.098  |ddm|= 0.0767
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.221919
diis-c [-5.61367382e-04  3.29880906e-01  6.70119094e-01]
  HOMO = -0.842671106328369  LUMO = 1.12564394090028
  mo_energy =
[-3.27655334e+01 -1.92405235e+00 -8.42671106e-01 -8.42671106e-01
 -8.42671106e-01  1.12564394e+00  1.12564394e+00  1.12564394e+00
  2.13630308e+00  5.90109612e+00  5.90109612e+00  5.90109612e+00
  1.95927648e+01  2.37669263e+01  2.37669263e+01  2.37669263e+01
  9.39435965e+01  1.01641282e+02  1.01641282e+02  1.01641282e+02
  3.56218404e+02  1.34952685e+03  5.83591677e+03  3.50984835e+04]
E1 = -182.61319034008622  E_coul = 54.08759585790515
cycle= 3 E= -128.525594482181  delta_E= -0.00081  |g|= 0.00034  |ddm|= 0.0259
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000813861
diis-c [-3.47742526e-08 -1.95659526e-03 -3.84670143e-04  1.00234127e+00]
  HOMO = -0.842835379051377  LUMO = 1.1256250378802
  mo_energy =
[-3.27658856e+01 -1.92418669e+00 -8.42835379e-01 -8.42835379e-01
 -8.42835379e-01  1.12562504e+00  1.12562504e+00  1.12562504e+00
  2.13624172e+00  5.90095621e+00  5.90095621e+00  5.90095621e+00
  1.95925390e+01  2.37666752e+01  2.37666752e+01  2.37666752e+01
  9.39432687e+01  1.01640934e+02  1.01640934e+02  1.01640934e+02
  3.56217980e+02  1.34952631e+03  5.83591614e+03  3.50984828e+04]
E1 = -182.6137278945226  E_coul = 54.08813340467356
cycle= 4 E= -128.525594489849  delta_E= -7.67e-09  |g|= 4.02e-05  |ddm|= 4.83e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.77404e-05
diis-c [-1.81859111e-10  1.02547739e-04  3.48002973e-04 -9.28480795e-02
  1.09239753e+00]
  HOMO = -0.842853708359871  LUMO = 1.12561752018371
  mo_energy =
[-3.27659248e+01 -1.92420263e+00 -8.42853708e-01 -8.42853708e-01
 -8.42853708e-01  1.12561752e+00  1.12561752e+00  1.12561752e+00
  2.13622942e+00  5.90093389e+00  5.90093389e+00  5.90093389e+00
  1.95925088e+01  2.37666426e+01  2.37666426e+01  2.37666426e+01
  9.39432309e+01  1.01640895e+02  1.01640895e+02  1.01640895e+02
  3.56217937e+02  1.34952626e+03  5.83591609e+03  3.50984828e+04]
E1 = -182.61381979748165  E_coul = 54.0882253074922
cycle= 5 E= -128.525594489989  delta_E= -1.4e-10  |g|= 1.74e-06  |ddm|= 8.55e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61381979748165  E_coul = 54.0882253074922
  HOMO = -0.842853129901159  LUMO = 1.12561777969398
  mo_energy =
[-3.27659235e+01 -1.92420168e+00 -8.42853130e-01 -8.42853130e-01
 -8.42853130e-01  1.12561778e+00  1.12561778e+00  1.12561778e+00
  2.13623015e+00  5.90093464e+00  5.90093464e+00  5.90093464e+00
  1.95925100e+01  2.37666438e+01  2.37666438e+01  2.37666438e+01
  9.39432321e+01  1.01640896e+02  1.01640896e+02  1.01640896e+02
  3.56217938e+02  1.34952626e+03  5.83591609e+03  3.50984828e+04]
E1 = -182.61381666955847  E_coul = 54.08822217956895
Extra cycle  E= -128.52559448999  delta_E= -5.68e-14  |g|= 4.82e-07  |ddm|= 9.85e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 242.83795038478968
E1 = -182.61381666955847  E_coul = 54.08822217956895
init E= -128.52559448999
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.842853359432826  LUMO = 1.12561769793046
  mo_energy =
[-3.27659242e+01 -1.92420186e+00 -8.42853359e-01 -8.42853359e-01
 -8.42853359e-01  1.12561770e+00  1.12561770e+00  1.12561770e+00
  2.13623004e+00  5.90093436e+00  5.90093436e+00  5.90093436e+00
  1.95925096e+01  2.37666433e+01  2.37666433e+01  2.37666433e+01
  9.39432315e+01  1.01640895e+02  1.01640895e+02  1.01640895e+02
  3.56217937e+02  1.34952626e+03  5.83591609e+03  3.50984828e+04]
E1 = -182.61381836364174  E_coul = 54.08822387365196
cycle= 1 E= -128.52559448999  delta_E= -2.56e-13  |g|= 2.4e-07  |ddm|= 1.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.61381836364174  E_coul = 54.08822387365196
  HOMO = -0.842853242382385  LUMO = 1.12561774288942
  mo_energy =
[-3.27659239e+01 -1.92420172e+00 -8.42853242e-01 -8.42853242e-01
 -8.42853242e-01  1.12561774e+00  1.12561774e+00  1.12561774e+00
  2.13623014e+00  5.90093451e+00  5.90093451e+00  5.90093451e+00
  1.95925098e+01  2.37666436e+01  2.37666436e+01  2.37666436e+01
  9.39432318e+01  1.01640896e+02  1.01640896e+02  1.01640896e+02
  3.56217938e+02  1.34952626e+03  5.83591609e+03  3.50984828e+04]
E1 = -182.6138175438019  E_coul = 54.08822305381217
Extra cycle  E= -128.52559448999  delta_E= 5.68e-14  |g|= 1.11e-07  |ddm|= 1.05e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498467e+02 1.74907393e+02
 2.05124054e+01 5.69525521e+01 5.08075770e-01 7.79136875e+00
 1.71663371e+00 3.80123275e+00 1.16489448e+01 4.46315709e+01
 3.38418348e-01 1.18343723e+00]
grad_E = [-8.63943350e-10  4.50891369e-08 -9.01959779e-07  9.97885611e-06
  2.08223757e-04 -6.79695560e-05  1.08706045e-02 -3.65074852e-04
  7.86850523e-04  1.19635731e-02 -1.30830296e-03 -3.25658751e-04
  1.43543508e-02 -1.83676817e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682517        1
[INPUT] 0    0    [1    /1   ]  617.498467824        1
[INPUT] 0    0    [1    /1   ]  174.907392312        1
[INPUT] 0    0    [1    /1   ]  20.5135440907        1
[INPUT] 0    0    [1    /1   ]  56.9525482829        1
[INPUT] 0    0    [1    /1   ]  0.496907773163       1
[INPUT] 0    0    [1    /1   ]  7.78981523307        1
[INPUT] 0    0    [1    /1   ]  1.68338650757        1
[INPUT] 1    0    [1    /1   ]  3.74952992081        1
[INPUT] 1    0    [1    /1   ]  11.6364033264        1
[INPUT] 1    0    [1    /1   ]  45.0321888105        1
[INPUT] 1    0    [1    /1   ]  0.334620226219       1
[INPUT] 1    0    [1    /1   ]  1.16833959365        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729966977, 1.0]], [0, [2712.0968251652766, 1.0]], [0, [617.4984678241999, 1.0]], [0, [174.907392312453, 1.0]], [0, [20.513544090654143, 1.0]], [0, [56.95254828290346, 1.0]], [0, [0.4969077731630629, 1.0]], [0, [7.789815233073062, 1.0]], [0, [1.683386507571723, 1.0]], [1, [3.7495299208107484, 1.0]], [1, [11.636403326367015, 1.0]], [1, [45.032188810529675, 1.0]], [1, [0.33462022621880433, 1.0]], [1, [1.1683395936502783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682517]
bas 2, expnt(s) = [617.49846782]
bas 3, expnt(s) = [174.90739231]
bas 4, expnt(s) = [20.51354409]
bas 5, expnt(s) = [56.95254828]
bas 6, expnt(s) = [0.49690777]
bas 7, expnt(s) = [7.78981523]
bas 8, expnt(s) = [1.68338651]
bas 9, expnt(s) = [3.74952992]
bas 10, expnt(s) = [11.63640333]
bas 11, expnt(s) = [45.03218881]
bas 12, expnt(s) = [0.33462023]
bas 13, expnt(s) = [1.16833959]
CPU time:       113.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498468e+02 3.12962237e+02 1.74907392e+02 1.21512554e+02
 2.05135441e+01 2.43526120e+01 5.69525483e+01 5.23781186e+01
 4.96907773e-01 1.49527774e+00 7.78981523e+00 1.17804096e+01
 1.68338651e+00 3.73381594e+00 3.74952992e+00 1.52214289e+01
 1.16364033e+01 6.26986009e+01 4.50321888e+01 3.40320580e+02
 3.34620226e-01 7.42462679e-01 1.16833959e+00 3.54360871e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997845901979062
cond(S) = 240.47200278760317
E1 = -183.5723401371674  E_coul = 55.079552787971636
init E= -128.492787349196
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773529017742028  LUMO = 1.13477821797095
  mo_energy =
[-3.25546364e+01 -1.85132703e+00 -7.73529018e-01 -7.73529018e-01
 -7.73529018e-01  1.13477822e+00  1.13477822e+00  1.13477822e+00
  2.11870314e+00  5.89938827e+00  5.89938827e+00  5.89938827e+00
  1.95511276e+01  2.36942617e+01  2.36942617e+01  2.36942617e+01
  9.39589135e+01  1.02180811e+02  1.02180811e+02  1.02180811e+02
  3.56288887e+02  1.34964776e+03  5.83608452e+03  3.50986937e+04]
E1 = -182.12046247724933  E_coul = 53.59760484872326
cycle= 1 E= -128.522857628526  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.45195
diis-c [-0.20425857  1.        ]
  HOMO = -0.877683030547048  LUMO = 1.09679545007351
  mo_energy =
[-3.28713846e+01 -1.96068899e+00 -8.77683031e-01 -8.77683031e-01
 -8.77683031e-01  1.09679545e+00  1.09679545e+00  1.09679545e+00
  2.04377843e+00  5.77095951e+00  5.77095951e+00  5.77095951e+00
  1.93350111e+01  2.34659692e+01  2.34659692e+01  2.34659692e+01
  9.36608567e+01  1.01870603e+02  1.01870603e+02  1.01870603e+02
  3.55943227e+02  1.34926385e+03  5.83566879e+03  3.50982564e+04]
E1 = -182.84624244159497  E_coul = 54.32088755165624
cycle= 2 E= -128.525354889939  delta_E= -0.0025  |g|= 0.099  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.223832
diis-c [-5.65720879e-04  3.30269264e-01  6.69730736e-01]
  HOMO = -0.843567921198014  LUMO = 1.10943659852432
  mo_energy =
[-3.27669374e+01 -1.92472170e+00 -8.43567921e-01 -8.43567921e-01
 -8.43567921e-01  1.10943660e+00  1.10943660e+00  1.10943660e+00
  2.06834978e+00  5.81294388e+00  5.81294388e+00  5.81294388e+00
  1.94065264e+01  2.35414372e+01  2.35414372e+01  2.35414372e+01
  9.37594034e+01  1.01972530e+02  1.01972530e+02  1.01972530e+02
  3.56054365e+02  1.34938114e+03  5.83578901e+03  3.50983777e+04]
E1 = -182.60459638101685  E_coul = 54.07841316856062
cycle= 3 E= -128.526183212456  delta_E= -0.000828  |g|= 0.000379  |ddm|= 0.0261
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000918569
diis-c [-5.51021566e-08 -1.99040553e-03 -4.38420548e-05  1.00203425e+00]
  HOMO = -0.843746224720303  LUMO = 1.10941375965337
  mo_energy =
[-3.27673158e+01 -1.92485621e+00 -8.43746225e-01 -8.43746225e-01
 -8.43746225e-01  1.10941376e+00  1.10941376e+00  1.10941376e+00
  2.06829026e+00  5.81279108e+00  5.81279108e+00  5.81279108e+00
  1.94062873e+01  2.35411674e+01  2.35411674e+01  2.35411674e+01
  9.37590512e+01  1.01972155e+02  1.01972155e+02  1.01972155e+02
  3.56053905e+02  1.34938056e+03  5.83578832e+03  3.50983770e+04]
E1 = -182.60518402007344  E_coul = 54.07900079717318
cycle= 4 E= -128.5261832229  delta_E= -1.04e-08  |g|= 5.02e-05  |ddm|= 6.55e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000123494
diis-c [-3.32956919e-10  1.70529504e-04  4.24667206e-04 -1.31869790e-01
  1.13127459e+00]
  HOMO = -0.843768445471932  LUMO = 1.10940496271518
  mo_energy =
[-3.27673639e+01 -1.92487310e+00 -8.43768445e-01 -8.43768445e-01
 -8.43768445e-01  1.10940496e+00  1.10940496e+00  1.10940496e+00
  2.06827766e+00  5.81276449e+00  5.81276449e+00  5.81276449e+00
  1.94062517e+01  2.35411283e+01  2.35411283e+01  2.35411283e+01
  9.37590051e+01  1.01972108e+02  1.01972108e+02  1.01972108e+02
  3.56053852e+02  1.34938050e+03  5.83578826e+03  3.50983769e+04]
E1 = -182.60529828959687  E_coul = 54.07911506645349
cycle= 5 E= -128.526183223143  delta_E= -2.43e-10  |g|= 2.93e-06  |ddm|= 1.36e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60529828959687  E_coul = 54.07911506645349
  HOMO = -0.843767205687379  LUMO = 1.10940550668203
  mo_energy =
[-3.27673612e+01 -1.92487130e+00 -8.43767206e-01 -8.43767206e-01
 -8.43767206e-01  1.10940551e+00  1.10940551e+00  1.10940551e+00
  2.06827904e+00  5.81276607e+00  5.81276607e+00  5.81276607e+00
  1.94062542e+01  2.35411307e+01  2.35411307e+01  2.35411307e+01
  9.37590078e+01  1.01972111e+02  1.01972111e+02  1.01972111e+02
  3.56053854e+02  1.34938050e+03  5.83578826e+03  3.50983769e+04]
E1 = -182.60529208753184  E_coul = 54.079108864387436
Extra cycle  E= -128.526183223144  delta_E= -1.02e-12  |g|= 9.1e-07  |ddm|= 1.6e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498468e+02 1.74907392e+02
 2.05135441e+01 5.69525483e+01 4.96907773e-01 7.78981523e+00
 1.68338651e+00 3.74952992e+00 1.16364033e+01 4.50321888e+01
 3.34620226e-01 1.16833959e+00]
E = -128.52618322314441
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682517        1
[INPUT] 0    0    [1    /1   ]  617.498467824        1
[INPUT] 0    0    [1    /1   ]  174.907392312        1
[INPUT] 0    0    [1    /1   ]  20.5135440907        1
[INPUT] 0    0    [1    /1   ]  56.9525482829        1
[INPUT] 0    0    [1    /1   ]  0.496907773163       1
[INPUT] 0    0    [1    /1   ]  7.78981523307        1
[INPUT] 0    0    [1    /1   ]  1.68338650757        1
[INPUT] 1    0    [1    /1   ]  3.74952992081        1
[INPUT] 1    0    [1    /1   ]  11.6364033264        1
[INPUT] 1    0    [1    /1   ]  45.0321888105        1
[INPUT] 1    0    [1    /1   ]  0.334620226219       1
[INPUT] 1    0    [1    /1   ]  1.16833959365        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729966977, 1.0]], [0, [2712.0968251652766, 1.0]], [0, [617.4984678241999, 1.0]], [0, [174.907392312453, 1.0]], [0, [20.513544090654143, 1.0]], [0, [56.95254828290346, 1.0]], [0, [0.4969077731630629, 1.0]], [0, [7.789815233073062, 1.0]], [0, [1.683386507571723, 1.0]], [1, [3.7495299208107484, 1.0]], [1, [11.636403326367015, 1.0]], [1, [45.032188810529675, 1.0]], [1, [0.33462022621880433, 1.0]], [1, [1.1683395936502783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682517]
bas 2, expnt(s) = [617.49846782]
bas 3, expnt(s) = [174.90739231]
bas 4, expnt(s) = [20.51354409]
bas 5, expnt(s) = [56.95254828]
bas 6, expnt(s) = [0.49690777]
bas 7, expnt(s) = [7.78981523]
bas 8, expnt(s) = [1.68338651]
bas 9, expnt(s) = [3.74952992]
bas 10, expnt(s) = [11.63640333]
bas 11, expnt(s) = [45.03218881]
bas 12, expnt(s) = [0.33462023]
bas 13, expnt(s) = [1.16833959]
CPU time:       113.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498468e+02 3.12962237e+02 1.74907392e+02 1.21512554e+02
 2.05135441e+01 2.43526120e+01 5.69525483e+01 5.23781186e+01
 4.96907773e-01 1.49527774e+00 7.78981523e+00 1.17804096e+01
 1.68338651e+00 3.73381594e+00 3.74952992e+00 1.52214289e+01
 1.16364033e+01 6.26986009e+01 4.50321888e+01 3.40320580e+02
 3.34620226e-01 7.42462679e-01 1.16833959e+00 3.54360871e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997845901979062
cond(S) = 240.47200278760317
E1 = -183.5723401371674  E_coul = 55.079552787971636
init E= -128.492787349196
    CPU time for initialize scf      0.02 sec, wall time      0.06 sec
  HOMO = -0.773529017742028  LUMO = 1.13477821797095
  mo_energy =
[-3.25546364e+01 -1.85132703e+00 -7.73529018e-01 -7.73529018e-01
 -7.73529018e-01  1.13477822e+00  1.13477822e+00  1.13477822e+00
  2.11870314e+00  5.89938827e+00  5.89938827e+00  5.89938827e+00
  1.95511276e+01  2.36942617e+01  2.36942617e+01  2.36942617e+01
  9.39589135e+01  1.02180811e+02  1.02180811e+02  1.02180811e+02
  3.56288887e+02  1.34964776e+03  5.83608452e+03  3.50986937e+04]
E1 = -182.12046247724933  E_coul = 53.59760484872326
cycle= 1 E= -128.522857628526  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.175
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.45195
diis-c [-0.20425857  1.        ]
  HOMO = -0.877683030547048  LUMO = 1.09679545007351
  mo_energy =
[-3.28713846e+01 -1.96068899e+00 -8.77683031e-01 -8.77683031e-01
 -8.77683031e-01  1.09679545e+00  1.09679545e+00  1.09679545e+00
  2.04377843e+00  5.77095951e+00  5.77095951e+00  5.77095951e+00
  1.93350111e+01  2.34659692e+01  2.34659692e+01  2.34659692e+01
  9.36608567e+01  1.01870603e+02  1.01870603e+02  1.01870603e+02
  3.55943227e+02  1.34926385e+03  5.83566879e+03  3.50982564e+04]
E1 = -182.84624244159497  E_coul = 54.32088755165624
cycle= 2 E= -128.525354889939  delta_E= -0.0025  |g|= 0.099  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.223832
diis-c [-5.65720879e-04  3.30269264e-01  6.69730736e-01]
  HOMO = -0.843567921198014  LUMO = 1.10943659852432
  mo_energy =
[-3.27669374e+01 -1.92472170e+00 -8.43567921e-01 -8.43567921e-01
 -8.43567921e-01  1.10943660e+00  1.10943660e+00  1.10943660e+00
  2.06834978e+00  5.81294388e+00  5.81294388e+00  5.81294388e+00
  1.94065264e+01  2.35414372e+01  2.35414372e+01  2.35414372e+01
  9.37594034e+01  1.01972530e+02  1.01972530e+02  1.01972530e+02
  3.56054365e+02  1.34938114e+03  5.83578901e+03  3.50983777e+04]
E1 = -182.60459638101685  E_coul = 54.07841316856062
cycle= 3 E= -128.526183212456  delta_E= -0.000828  |g|= 0.000379  |ddm|= 0.0261
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000918569
diis-c [-5.51021566e-08 -1.99040553e-03 -4.38420548e-05  1.00203425e+00]
  HOMO = -0.843746224720303  LUMO = 1.10941375965337
  mo_energy =
[-3.27673158e+01 -1.92485621e+00 -8.43746225e-01 -8.43746225e-01
 -8.43746225e-01  1.10941376e+00  1.10941376e+00  1.10941376e+00
  2.06829026e+00  5.81279108e+00  5.81279108e+00  5.81279108e+00
  1.94062873e+01  2.35411674e+01  2.35411674e+01  2.35411674e+01
  9.37590512e+01  1.01972155e+02  1.01972155e+02  1.01972155e+02
  3.56053905e+02  1.34938056e+03  5.83578832e+03  3.50983770e+04]
E1 = -182.60518402007344  E_coul = 54.07900079717318
cycle= 4 E= -128.5261832229  delta_E= -1.04e-08  |g|= 5.02e-05  |ddm|= 6.55e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000123494
diis-c [-3.32956919e-10  1.70529504e-04  4.24667206e-04 -1.31869790e-01
  1.13127459e+00]
  HOMO = -0.843768445471932  LUMO = 1.10940496271518
  mo_energy =
[-3.27673639e+01 -1.92487310e+00 -8.43768445e-01 -8.43768445e-01
 -8.43768445e-01  1.10940496e+00  1.10940496e+00  1.10940496e+00
  2.06827766e+00  5.81276449e+00  5.81276449e+00  5.81276449e+00
  1.94062517e+01  2.35411283e+01  2.35411283e+01  2.35411283e+01
  9.37590051e+01  1.01972108e+02  1.01972108e+02  1.01972108e+02
  3.56053852e+02  1.34938050e+03  5.83578826e+03  3.50983769e+04]
E1 = -182.60529828959687  E_coul = 54.07911506645349
cycle= 5 E= -128.526183223143  delta_E= -2.43e-10  |g|= 2.93e-06  |ddm|= 1.36e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60529828959687  E_coul = 54.07911506645349
  HOMO = -0.843767205687379  LUMO = 1.10940550668203
  mo_energy =
[-3.27673612e+01 -1.92487130e+00 -8.43767206e-01 -8.43767206e-01
 -8.43767206e-01  1.10940551e+00  1.10940551e+00  1.10940551e+00
  2.06827904e+00  5.81276607e+00  5.81276607e+00  5.81276607e+00
  1.94062542e+01  2.35411307e+01  2.35411307e+01  2.35411307e+01
  9.37590078e+01  1.01972111e+02  1.01972111e+02  1.01972111e+02
  3.56053854e+02  1.34938050e+03  5.83578826e+03  3.50983769e+04]
E1 = -182.60529208753184  E_coul = 54.079108864387436
Extra cycle  E= -128.526183223144  delta_E= -1.02e-12  |g|= 9.1e-07  |ddm|= 1.6e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.16 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.47200278760317
E1 = -182.60529208753184  E_coul = 54.079108864387436
init E= -128.526183223144
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.84376765187655  LUMO = 1.10940535007349
  mo_energy =
[-3.27673625e+01 -1.92487167e+00 -8.43767652e-01 -8.43767652e-01
 -8.43767652e-01  1.10940535e+00  1.10940535e+00  1.10940535e+00
  2.06827881e+00  5.81276553e+00  5.81276553e+00  5.81276553e+00
  1.94062533e+01  2.35411297e+01  2.35411297e+01  2.35411297e+01
  9.37590065e+01  1.01972109e+02  1.01972109e+02  1.01972109e+02
  3.56053853e+02  1.34938050e+03  5.83578826e+03  3.50983769e+04]
E1 = -182.60529545359384  E_coul = 54.07911223044962
cycle= 1 E= -128.526183223144  delta_E= 1.99e-13  |g|= 4.7e-07  |ddm|= 3.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60529545359384  E_coul = 54.07911223044962
  HOMO = -0.843767417838966  LUMO = 1.10940543834705
  mo_energy =
[-3.27673618e+01 -1.92487141e+00 -8.43767418e-01 -8.43767418e-01
 -8.43767418e-01  1.10940544e+00  1.10940544e+00  1.10940544e+00
  2.06827899e+00  5.81276582e+00  5.81276582e+00  5.81276582e+00
  1.94062538e+01  2.35411302e+01  2.35411302e+01  2.35411302e+01
  9.37590072e+01  1.01972110e+02  1.01972110e+02  1.01972110e+02
  3.56053853e+02  1.34938050e+03  5.83578826e+03  3.50983769e+04]
E1 = -182.60529381316604  E_coul = 54.07911059002157
Extra cycle  E= -128.526183223144  delta_E= -2.56e-13  |g|= 2.23e-07  |ddm|= 2.01e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498468e+02 1.74907392e+02
 2.05135441e+01 5.69525483e+01 4.96907773e-01 7.78981523e+00
 1.68338651e+00 3.74952992e+00 1.16364033e+01 4.50321888e+01
 3.34620226e-01 1.16833959e+00]
grad_E = [-9.21835161e-10  4.83273320e-08 -9.60760964e-07  1.07711851e-05
  2.43969478e-04 -7.28976385e-05  4.64690561e-03 -3.94188101e-04
  4.81818974e-04  1.01738866e-02 -9.87685168e-04 -3.21840114e-04
  7.80095205e-03 -1.45653989e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682498        1
[INPUT] 0    0    [1    /1   ]  617.49847276         1
[INPUT] 0    0    [1    /1   ]  174.907374788        1
[INPUT] 0    0    [1    /1   ]  20.5178781453        1
[INPUT] 0    0    [1    /1   ]  56.9526436559        1
[INPUT] 0    0    [1    /1   ]  0.471617967458       1
[INPUT] 0    0    [1    /1   ]  7.7854330126         1
[INPUT] 0    0    [1    /1   ]  1.62871798099        1
[INPUT] 1    0    [1    /1   ]  3.35526942002        1
[INPUT] 1    0    [1    /1   ]  11.3995086148        1
[INPUT] 1    0    [1    /1   ]  47.6636010608        1
[INPUT] 1    0    [1    /1   ]  0.316666204048       1
[INPUT] 1    0    [1    /1   ]  1.0598799366         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729965187, 1.0]], [0, [2712.096824979844, 1.0]], [0, [617.4984727602023, 1.0]], [0, [174.90737478839083, 1.0]], [0, [20.517878145329714, 1.0]], [0, [56.95264365592437, 1.0]], [0, [0.47161796745831763, 1.0]], [0, [7.785433012597365, 1.0]], [0, [1.6287179809862815, 1.0]], [1, [3.355269420016124, 1.0]], [1, [11.39950861483594, 1.0]], [1, [47.66360106075549, 1.0]], [1, [0.31666620404769813, 1.0]], [1, [1.0598799366037537, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682498]
bas 2, expnt(s) = [617.49847276]
bas 3, expnt(s) = [174.90737479]
bas 4, expnt(s) = [20.51787815]
bas 5, expnt(s) = [56.95264366]
bas 6, expnt(s) = [0.47161797]
bas 7, expnt(s) = [7.78543301]
bas 8, expnt(s) = [1.62871798]
bas 9, expnt(s) = [3.35526942]
bas 10, expnt(s) = [11.39950861]
bas 11, expnt(s) = [47.66360106]
bas 12, expnt(s) = [0.3166662]
bas 13, expnt(s) = [1.05987994]
CPU time:       116.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498473e+02 3.12962239e+02 1.74907375e+02 1.21512545e+02
 2.05178781e+01 2.43564707e+01 5.69526437e+01 5.23781844e+01
 4.71617967e-01 1.43783079e+00 7.78543301e+00 1.17754389e+01
 1.62871798e+00 3.64249901e+00 3.35526942e+00 1.32477963e+01
 1.13995086e+01 6.11071539e+01 4.76636011e+01 3.65357440e+02
 3.16666204e-01 6.93005271e-01 1.05987994e+00 3.13729409e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99839836893516
cond(S) = 236.20130744815467
E1 = -183.5743350523888  E_coul = 55.08018578781517
init E= -128.494149264574
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77377968809894  LUMO = 1.04753684212124
  mo_energy =
[-3.25542983e+01 -1.85128747e+00 -7.73779688e-01 -7.73779688e-01
 -7.73779688e-01  1.04753684e+00  1.04753684e+00  1.04753684e+00
  1.98347023e+00  5.28902249e+00  5.28902249e+00  5.28902249e+00
  1.92112897e+01  2.18826378e+01  2.18826378e+01  2.18826378e+01
  9.36308089e+01  1.03776090e+02  1.03776090e+02  1.03776090e+02
  3.56000968e+02  1.34939367e+03  5.83586243e+03  3.50985104e+04]
E1 = -182.0834573003968  E_coul = 53.55962484414622
cycle= 1 E= -128.523832456251  delta_E= -0.0297  |g|= 0.204  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.45822
diis-c [-0.20996599  1.        ]
  HOMO = -0.880983565018999  LUMO = 1.01205764487349
  mo_energy =
[-3.28784458e+01 -1.96333322e+00 -8.80983565e-01 -8.80983565e-01
 -8.80983565e-01  1.01205764e+00  1.01205764e+00  1.01205764e+00
  1.90958898e+00  5.16638300e+00  5.16638300e+00  5.16638300e+00
  1.89901288e+01  2.16513521e+01  2.16513521e+01  2.16513521e+01
  9.33256700e+01  1.03455631e+02  1.03455631e+02  1.03455631e+02
  3.55647723e+02  1.34900210e+03  5.83543898e+03  3.50980653e+04]
E1 = -182.83195569395707  E_coul = 54.305514819912574
cycle= 2 E= -128.526440874045  delta_E= -0.00261  |g|= 0.102  |ddm|= 0.0773
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.228388
diis-c [-5.84399359e-04  3.31691209e-01  6.68308791e-01]
  HOMO = -0.845814377495754  LUMO = 1.02380817111508
  mo_energy =
[-3.27712065e+01 -1.92624977e+00 -8.45814377e-01 -8.45814377e-01
 -8.45814377e-01  1.02380817e+00  1.02380817e+00  1.02380817e+00
  1.93390759e+00  5.20651447e+00  5.20651447e+00  5.20651447e+00
  1.90636458e+01  2.17280768e+01  2.17280768e+01  2.17280768e+01
  9.34269210e+01  1.03561177e+02  1.03561177e+02  1.03561177e+02
  3.55761793e+02  1.34912243e+03  5.83556226e+03  3.50981898e+04]
E1 = -182.5814261517969  E_coul = 54.054103670697245
cycle= 3 E= -128.5273224811  delta_E= -0.000882  |g|= 0.000476  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00110409
diis-c [-1.47387592e-07 -2.10063424e-03  3.29930177e-04  1.00177070e+00]
  HOMO = -0.846018975044835  LUMO = 1.02378137803661
  mo_energy =
[-3.27716209e+01 -1.92636956e+00 -8.46018975e-01 -8.46018975e-01
 -8.46018975e-01  1.02378138e+00  1.02378138e+00  1.02378138e+00
  1.93386122e+00  5.20635197e+00  5.20635197e+00  5.20635197e+00
  1.90633955e+01  2.17277876e+01  2.17277876e+01  2.17277876e+01
  9.34265379e+01  1.03560761e+02  1.03560761e+02  1.03560761e+02
  3.55761280e+02  1.34912177e+03  5.83556148e+03  3.50981889e+04]
E1 = -182.5820408229346  E_coul = 54.05471832075263
cycle= 4 E= -128.527322502182  delta_E= -2.11e-08  |g|= 8.02e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000191858
diis-c [-7.28199150e-10  2.80016181e-04  5.92702873e-04 -2.00958340e-01
  1.20008562e+00]
  HOMO = -0.846052045386403  LUMO = 1.02376980366838
  mo_energy =
[-3.27716914e+01 -1.92638799e+00 -8.46052045e-01 -8.46052045e-01
 -8.46052045e-01  1.02376980e+00  1.02376980e+00  1.02376980e+00
  1.93384831e+00  5.20631560e+00  5.20631560e+00  5.20631560e+00
  1.90633465e+01  2.17277318e+01  2.17277318e+01  2.17277318e+01
  9.34264707e+01  1.03560691e+02  1.03560691e+02  1.03560691e+02
  3.55761199e+02  1.34912167e+03  5.83556138e+03  3.50981888e+04]
E1 = -182.5822124400871  E_coul = 54.054889937152275
cycle= 5 E= -128.527322502935  delta_E= -7.53e-10  |g|= 5.4e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5822124400871  E_coul = 54.054889937152275
  HOMO = -0.84604900584838  LUMO = 1.02377100003681
  mo_energy =
[-3.27716850e+01 -1.92638431e+00 -8.46049006e-01 -8.46049006e-01
 -8.46049006e-01  1.02377100e+00  1.02377100e+00  1.02377100e+00
  1.93385108e+00  5.20631915e+00  5.20631915e+00  5.20631915e+00
  1.90633521e+01  2.17277373e+01  2.17277373e+01  2.17277373e+01
  9.34264770e+01  1.03560697e+02  1.03560697e+02  1.03560697e+02
  3.55761205e+02  1.34912168e+03  5.83556139e+03  3.50981888e+04]
E1 = -182.58219792745354  E_coul = 54.05487542451662
Extra cycle  E= -128.527322502937  delta_E= -2.1e-12  |g|= 2.03e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498473e+02 1.74907375e+02
 2.05178781e+01 5.69526437e+01 4.71617967e-01 7.78543301e+00
 1.62871798e+00 3.35526942e+00 1.13995086e+01 4.76636011e+01
 3.16666204e-01 1.05987994e+00]
E = -128.52732250293693
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682498        1
[INPUT] 0    0    [1    /1   ]  617.49847276         1
[INPUT] 0    0    [1    /1   ]  174.907374788        1
[INPUT] 0    0    [1    /1   ]  20.5178781453        1
[INPUT] 0    0    [1    /1   ]  56.9526436559        1
[INPUT] 0    0    [1    /1   ]  0.471617967458       1
[INPUT] 0    0    [1    /1   ]  7.7854330126         1
[INPUT] 0    0    [1    /1   ]  1.62871798099        1
[INPUT] 1    0    [1    /1   ]  3.35526942002        1
[INPUT] 1    0    [1    /1   ]  11.3995086148        1
[INPUT] 1    0    [1    /1   ]  47.6636010608        1
[INPUT] 1    0    [1    /1   ]  0.316666204048       1
[INPUT] 1    0    [1    /1   ]  1.0598799366         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729965187, 1.0]], [0, [2712.096824979844, 1.0]], [0, [617.4984727602023, 1.0]], [0, [174.90737478839083, 1.0]], [0, [20.517878145329714, 1.0]], [0, [56.95264365592437, 1.0]], [0, [0.47161796745831763, 1.0]], [0, [7.785433012597365, 1.0]], [0, [1.6287179809862815, 1.0]], [1, [3.355269420016124, 1.0]], [1, [11.39950861483594, 1.0]], [1, [47.66360106075549, 1.0]], [1, [0.31666620404769813, 1.0]], [1, [1.0598799366037537, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682498]
bas 2, expnt(s) = [617.49847276]
bas 3, expnt(s) = [174.90737479]
bas 4, expnt(s) = [20.51787815]
bas 5, expnt(s) = [56.95264366]
bas 6, expnt(s) = [0.47161797]
bas 7, expnt(s) = [7.78543301]
bas 8, expnt(s) = [1.62871798]
bas 9, expnt(s) = [3.35526942]
bas 10, expnt(s) = [11.39950861]
bas 11, expnt(s) = [47.66360106]
bas 12, expnt(s) = [0.3166662]
bas 13, expnt(s) = [1.05987994]
CPU time:       117.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498473e+02 3.12962239e+02 1.74907375e+02 1.21512545e+02
 2.05178781e+01 2.43564707e+01 5.69526437e+01 5.23781844e+01
 4.71617967e-01 1.43783079e+00 7.78543301e+00 1.17754389e+01
 1.62871798e+00 3.64249901e+00 3.35526942e+00 1.32477963e+01
 1.13995086e+01 6.11071539e+01 4.76636011e+01 3.65357440e+02
 3.16666204e-01 6.93005271e-01 1.05987994e+00 3.13729409e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99839836893516
cond(S) = 236.20130744815467
E1 = -183.5743350523888  E_coul = 55.08018578781517
init E= -128.494149264574
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77377968809894  LUMO = 1.04753684212124
  mo_energy =
[-3.25542983e+01 -1.85128747e+00 -7.73779688e-01 -7.73779688e-01
 -7.73779688e-01  1.04753684e+00  1.04753684e+00  1.04753684e+00
  1.98347023e+00  5.28902249e+00  5.28902249e+00  5.28902249e+00
  1.92112897e+01  2.18826378e+01  2.18826378e+01  2.18826378e+01
  9.36308089e+01  1.03776090e+02  1.03776090e+02  1.03776090e+02
  3.56000968e+02  1.34939367e+03  5.83586243e+03  3.50985104e+04]
E1 = -182.0834573003968  E_coul = 53.55962484414622
cycle= 1 E= -128.523832456251  delta_E= -0.0297  |g|= 0.204  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.45822
diis-c [-0.20996599  1.        ]
  HOMO = -0.880983565018999  LUMO = 1.01205764487349
  mo_energy =
[-3.28784458e+01 -1.96333322e+00 -8.80983565e-01 -8.80983565e-01
 -8.80983565e-01  1.01205764e+00  1.01205764e+00  1.01205764e+00
  1.90958898e+00  5.16638300e+00  5.16638300e+00  5.16638300e+00
  1.89901288e+01  2.16513521e+01  2.16513521e+01  2.16513521e+01
  9.33256700e+01  1.03455631e+02  1.03455631e+02  1.03455631e+02
  3.55647723e+02  1.34900210e+03  5.83543898e+03  3.50980653e+04]
E1 = -182.83195569395707  E_coul = 54.305514819912574
cycle= 2 E= -128.526440874045  delta_E= -0.00261  |g|= 0.102  |ddm|= 0.0773
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.228388
diis-c [-5.84399359e-04  3.31691209e-01  6.68308791e-01]
  HOMO = -0.845814377495754  LUMO = 1.02380817111508
  mo_energy =
[-3.27712065e+01 -1.92624977e+00 -8.45814377e-01 -8.45814377e-01
 -8.45814377e-01  1.02380817e+00  1.02380817e+00  1.02380817e+00
  1.93390759e+00  5.20651447e+00  5.20651447e+00  5.20651447e+00
  1.90636458e+01  2.17280768e+01  2.17280768e+01  2.17280768e+01
  9.34269210e+01  1.03561177e+02  1.03561177e+02  1.03561177e+02
  3.55761793e+02  1.34912243e+03  5.83556226e+03  3.50981898e+04]
E1 = -182.5814261517969  E_coul = 54.054103670697245
cycle= 3 E= -128.5273224811  delta_E= -0.000882  |g|= 0.000476  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00110409
diis-c [-1.47387592e-07 -2.10063424e-03  3.29930177e-04  1.00177070e+00]
  HOMO = -0.846018975044835  LUMO = 1.02378137803661
  mo_energy =
[-3.27716209e+01 -1.92636956e+00 -8.46018975e-01 -8.46018975e-01
 -8.46018975e-01  1.02378138e+00  1.02378138e+00  1.02378138e+00
  1.93386122e+00  5.20635197e+00  5.20635197e+00  5.20635197e+00
  1.90633955e+01  2.17277876e+01  2.17277876e+01  2.17277876e+01
  9.34265379e+01  1.03560761e+02  1.03560761e+02  1.03560761e+02
  3.55761280e+02  1.34912177e+03  5.83556148e+03  3.50981889e+04]
E1 = -182.5820408229346  E_coul = 54.05471832075263
cycle= 4 E= -128.527322502182  delta_E= -2.11e-08  |g|= 8.02e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000191858
diis-c [-7.28199150e-10  2.80016181e-04  5.92702873e-04 -2.00958340e-01
  1.20008562e+00]
  HOMO = -0.846052045386403  LUMO = 1.02376980366838
  mo_energy =
[-3.27716914e+01 -1.92638799e+00 -8.46052045e-01 -8.46052045e-01
 -8.46052045e-01  1.02376980e+00  1.02376980e+00  1.02376980e+00
  1.93384831e+00  5.20631560e+00  5.20631560e+00  5.20631560e+00
  1.90633465e+01  2.17277318e+01  2.17277318e+01  2.17277318e+01
  9.34264707e+01  1.03560691e+02  1.03560691e+02  1.03560691e+02
  3.55761199e+02  1.34912167e+03  5.83556138e+03  3.50981888e+04]
E1 = -182.5822124400871  E_coul = 54.054889937152275
cycle= 5 E= -128.527322502935  delta_E= -7.53e-10  |g|= 5.4e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5822124400871  E_coul = 54.054889937152275
  HOMO = -0.84604900584838  LUMO = 1.02377100003681
  mo_energy =
[-3.27716850e+01 -1.92638431e+00 -8.46049006e-01 -8.46049006e-01
 -8.46049006e-01  1.02377100e+00  1.02377100e+00  1.02377100e+00
  1.93385108e+00  5.20631915e+00  5.20631915e+00  5.20631915e+00
  1.90633521e+01  2.17277373e+01  2.17277373e+01  2.17277373e+01
  9.34264770e+01  1.03560697e+02  1.03560697e+02  1.03560697e+02
  3.55761205e+02  1.34912168e+03  5.83556139e+03  3.50981888e+04]
E1 = -182.58219792745354  E_coul = 54.05487542451662
Extra cycle  E= -128.527322502937  delta_E= -2.1e-12  |g|= 2.03e-06  |ddm|= 2.38e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 236.20130744815467
E1 = -182.58219792745354  E_coul = 54.05487542451662
init E= -128.527322502937
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.846050023170495  LUMO = 1.02377067687086
  mo_energy =
[-3.27716882e+01 -1.92638527e+00 -8.46050023e-01 -8.46050023e-01
 -8.46050023e-01  1.02377068e+00  1.02377068e+00  1.02377068e+00
  1.93385048e+00  5.20631800e+00  5.20631800e+00  5.20631800e+00
  1.90633499e+01  2.17277351e+01  2.17277351e+01  2.17277351e+01
  9.34264740e+01  1.03560694e+02  1.03560694e+02  1.03560694e+02
  3.55761202e+02  1.34912167e+03  5.83556138e+03  3.50981888e+04]
E1 = -182.58220578567673  E_coul = 54.054883282739546
cycle= 1 E= -128.527322502937  delta_E= -2.56e-13  |g|= 1.07e-06  |ddm|= 7.94e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58220578567673  E_coul = 54.054883282739546
  HOMO = -0.846049470783022  LUMO = 1.02377086394487
  mo_energy =
[-3.27716865e+01 -1.92638467e+00 -8.46049471e-01 -8.46049471e-01
 -8.46049471e-01  1.02377086e+00  1.02377086e+00  1.02377086e+00
  1.93385088e+00  5.20631863e+00  5.20631863e+00  5.20631863e+00
  1.90633511e+01  2.17277363e+01  2.17277363e+01  2.17277363e+01
  9.34264756e+01  1.03560696e+02  1.03560696e+02  1.03560696e+02
  3.55761203e+02  1.34912167e+03  5.83556138e+03  3.50981888e+04]
E1 = -182.5822018989506  E_coul = 54.05487939601324
Extra cycle  E= -128.527322502937  delta_E= -1.71e-13  |g|= 5.27e-07  |ddm|= 4.34e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498473e+02 1.74907375e+02
 2.05178781e+01 5.69526437e+01 4.71617967e-01 7.78543301e+00
 1.62871798e+00 3.35526942e+00 1.13995086e+01 4.76636011e+01
 3.16666204e-01 1.05987994e+00]
grad_E = [-1.03667606e-09  5.46019547e-08 -1.07775859e-06  1.22343509e-05
  2.89581210e-04 -8.15773940e-05 -1.89283994e-02 -3.90010621e-04
  3.29443781e-03 -9.08576505e-03  2.45083581e-03 -2.81627898e-04
  6.22519070e-03  5.77476469e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682507        1
[INPUT] 0    0    [1    /1   ]  617.498471366        1
[INPUT] 0    0    [1    /1   ]  174.907400251        1
[INPUT] 0    0    [1    /1   ]  20.5195058425        1
[INPUT] 0    0    [1    /1   ]  56.9524708112        1
[INPUT] 0    0    [1    /1   ]  0.480692364073       1
[INPUT] 0    0    [1    /1   ]  7.7838867272         1
[INPUT] 0    0    [1    /1   ]  1.63462688397        1
[INPUT] 1    0    [1    /1   ]  3.58450239055        1
[INPUT] 1    0    [1    /1   ]  11.8122908243        1
[INPUT] 1    0    [1    /1   ]  48.4806033207        1
[INPUT] 1    0    [1    /1   ]  0.327318095091       1
[INPUT] 1    0    [1    /1   ]  1.12638965307        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729961585, 1.0]], [0, [2712.0968250669334, 1.0]], [0, [617.4984713659873, 1.0]], [0, [174.9074002514447, 1.0]], [0, [20.519505842477724, 1.0]], [0, [56.952470811219165, 1.0]], [0, [0.4806923640730145, 1.0]], [0, [7.783886727199262, 1.0]], [0, [1.6346268839723173, 1.0]], [1, [3.584502390548661, 1.0]], [1, [11.812290824326574, 1.0]], [1, [48.48060332071787, 1.0]], [1, [0.3273180950912987, 1.0]], [1, [1.1263896530682722, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872996]
bas 1, expnt(s) = [2712.09682507]
bas 2, expnt(s) = [617.49847137]
bas 3, expnt(s) = [174.90740025]
bas 4, expnt(s) = [20.51950584]
bas 5, expnt(s) = [56.95247081]
bas 6, expnt(s) = [0.48069236]
bas 7, expnt(s) = [7.78388673]
bas 8, expnt(s) = [1.63462688]
bas 9, expnt(s) = [3.58450239]
bas 10, expnt(s) = [11.81229082]
bas 11, expnt(s) = [48.48060332]
bas 12, expnt(s) = [0.3273181]
bas 13, expnt(s) = [1.12638965]
CPU time:       119.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498471e+02 3.12962238e+02 1.74907400e+02 1.21512558e+02
 2.05195058e+01 2.43579199e+01 5.69524708e+01 5.23780652e+01
 4.80692364e-01 1.45853025e+00 7.78388673e+00 1.17736848e+01
 1.63462688e+00 3.65240562e+00 3.58450239e+00 1.43886645e+01
 1.18122908e+01 6.38854644e+01 4.84806033e+01 3.73202387e+02
 3.27318095e-01 7.22265568e-01 1.12638965e+00 3.38528478e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998140917379633
cond(S) = 237.00645356614945
E1 = -183.574347392097  E_coul = 55.07984062181686
init E= -128.49450677028
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773804924991396  LUMO = 1.10048982610835
  mo_energy =
[-3.25544972e+01 -1.85132689e+00 -7.73804925e-01 -7.73804925e-01
 -7.73804925e-01  1.10048983e+00  1.10048983e+00  1.10048983e+00
  2.01958920e+00  5.65331568e+00  5.65331568e+00  5.65331568e+00
  1.92745108e+01  2.32222906e+01  2.32222906e+01  2.32222906e+01
  9.36882542e+01  1.07190439e+02  1.07190439e+02  1.07190439e+02
  3.56052847e+02  1.34944014e+03  5.83590321e+03  3.50985441e+04]
E1 = -182.1050565816805  E_coul = 53.580676151819496
cycle= 1 E= -128.524380429861  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.451776
diis-c [-0.20410127  1.        ]
  HOMO = -0.879366097347614  LUMO = 1.0632548464658
  mo_energy =
[-3.28744393e+01 -1.96186188e+00 -8.79366097e-01 -8.79366097e-01
 -8.79366097e-01  1.06325485e+00  1.06325485e+00  1.06325485e+00
  1.94605520e+00  5.52671035e+00  5.52671035e+00  5.52671035e+00
  1.90564780e+01  2.29908703e+01  2.29908703e+01  2.29908703e+01
  9.33871080e+01  1.06873570e+02  1.06873570e+02  1.06873570e+02
  3.55703890e+02  1.34905286e+03  5.83548406e+03  3.50981033e+04]
E1 = -182.84014020385953  E_coul = 54.313220915779745
cycle= 2 E= -128.52691928808  delta_E= -0.00254  |g|=  0.1  |ddm|= 0.0771
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224326
diis-c [-5.75235720e-04  3.30832371e-01  6.69167629e-01]
  HOMO = -0.844811985120775  LUMO = 1.07557510242924
  mo_energy =
[-3.27688549e+01 -1.92544126e+00 -8.44811985e-01 -8.44811985e-01
 -8.44811985e-01  1.07557510e+00  1.07557510e+00  1.07557510e+00
  1.97014913e+00  5.56805880e+00  5.56805880e+00  5.56805880e+00
  1.91287814e+01  2.30674384e+01  2.30674384e+01  2.30674384e+01
  9.34867754e+01  1.06977650e+02  1.06977650e+02  1.06977650e+02
  3.55816221e+02  1.34917139e+03  5.83560551e+03  3.50982259e+04]
E1 = -182.5945029056522  E_coul = 54.0667330319499
cycle= 3 E= -128.527769873702  delta_E= -0.000851  |g|= 0.000458  |ddm|= 0.0264
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107914
diis-c [-9.54572443e-08 -2.10352779e-03  3.85304878e-04  1.00171822e+00]
  HOMO = -0.845024205002951  LUMO = 1.07553970085856
  mo_energy =
[-3.27692918e+01 -1.92559417e+00 -8.45024205e-01 -8.45024205e-01
 -8.45024205e-01  1.07553970e+00  1.07553970e+00  1.07553970e+00
  1.97007605e+00  5.56787351e+00  5.56787351e+00  5.56787351e+00
  1.91285045e+01  2.30671208e+01  2.30671208e+01  2.30671208e+01
  9.34863686e+01  1.06977211e+02  1.06977211e+02  1.06977211e+02
  3.55815693e+02  1.34917072e+03  5.83560473e+03  3.50982251e+04]
E1 = -182.59517234504187  E_coul = 54.067402454882945
cycle= 4 E= -128.527769890159  delta_E= -1.65e-08  |g|= 6.47e-05  |ddm|= 9.68e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000156569
diis-c [-4.84733513e-10  2.19242402e-04  4.71221447e-04 -1.61136764e-01
  1.16044630e+00]
  HOMO = -0.845052935927397  LUMO = 1.07552869114271
  mo_energy =
[-3.27693524e+01 -1.92561418e+00 -8.45052936e-01 -8.45052936e-01
 -8.45052936e-01  1.07552869e+00  1.07552869e+00  1.07552869e+00
  1.97006142e+00  5.56784017e+00  5.56784017e+00  5.56784017e+00
  1.91284604e+01  2.30670715e+01  2.30670715e+01  2.30670715e+01
  9.34863106e+01  1.06977151e+02  1.06977151e+02  1.06977151e+02
  3.55815624e+02  1.34917064e+03  5.83560464e+03  3.50982250e+04]
E1 = -182.5953149646423  E_coul = 54.06754507405519
cycle= 5 E= -128.527769890587  delta_E= -4.28e-10  |g|= 4.07e-06  |ddm|= 2.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5953149646423  E_coul = 54.06754507405519
  HOMO = -0.845050926855869  LUMO = 1.07552954097633
  mo_energy =
[-3.27693481e+01 -1.92561152e+00 -8.45050927e-01 -8.45050927e-01
 -8.45050927e-01  1.07552954e+00  1.07552954e+00  1.07552954e+00
  1.97006344e+00  5.56784263e+00  5.56784263e+00  5.56784263e+00
  1.91284643e+01  2.30670752e+01  2.30670752e+01  2.30670752e+01
  9.34863147e+01  1.06977155e+02  1.06977155e+02  1.06977155e+02
  3.55815628e+02  1.34917065e+03  5.83560465e+03  3.50982250e+04]
E1 = -182.59530537283004  E_coul = 54.06753548224195
Extra cycle  E= -128.527769890588  delta_E= -9.66e-13  |g|= 1.37e-06  |ddm|= 2.07e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498471e+02 1.74907400e+02
 2.05195058e+01 5.69524708e+01 4.80692364e-01 7.78388673e+00
 1.63462688e+00 3.58450239e+00 1.18122908e+01 4.84806033e+01
 3.27318095e-01 1.12638965e+00]
E = -128.5277698905881
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:39:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682507        1
[INPUT] 0    0    [1    /1   ]  617.498471366        1
[INPUT] 0    0    [1    /1   ]  174.907400251        1
[INPUT] 0    0    [1    /1   ]  20.5195058425        1
[INPUT] 0    0    [1    /1   ]  56.9524708112        1
[INPUT] 0    0    [1    /1   ]  0.480692364073       1
[INPUT] 0    0    [1    /1   ]  7.7838867272         1
[INPUT] 0    0    [1    /1   ]  1.63462688397        1
[INPUT] 1    0    [1    /1   ]  3.58450239055        1
[INPUT] 1    0    [1    /1   ]  11.8122908243        1
[INPUT] 1    0    [1    /1   ]  48.4806033207        1
[INPUT] 1    0    [1    /1   ]  0.327318095091       1
[INPUT] 1    0    [1    /1   ]  1.12638965307        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729961585, 1.0]], [0, [2712.0968250669334, 1.0]], [0, [617.4984713659873, 1.0]], [0, [174.9074002514447, 1.0]], [0, [20.519505842477724, 1.0]], [0, [56.952470811219165, 1.0]], [0, [0.4806923640730145, 1.0]], [0, [7.783886727199262, 1.0]], [0, [1.6346268839723173, 1.0]], [1, [3.584502390548661, 1.0]], [1, [11.812290824326574, 1.0]], [1, [48.48060332071787, 1.0]], [1, [0.3273180950912987, 1.0]], [1, [1.1263896530682722, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872996]
bas 1, expnt(s) = [2712.09682507]
bas 2, expnt(s) = [617.49847137]
bas 3, expnt(s) = [174.90740025]
bas 4, expnt(s) = [20.51950584]
bas 5, expnt(s) = [56.95247081]
bas 6, expnt(s) = [0.48069236]
bas 7, expnt(s) = [7.78388673]
bas 8, expnt(s) = [1.63462688]
bas 9, expnt(s) = [3.58450239]
bas 10, expnt(s) = [11.81229082]
bas 11, expnt(s) = [48.48060332]
bas 12, expnt(s) = [0.3273181]
bas 13, expnt(s) = [1.12638965]
CPU time:       120.54
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498471e+02 3.12962238e+02 1.74907400e+02 1.21512558e+02
 2.05195058e+01 2.43579199e+01 5.69524708e+01 5.23780652e+01
 4.80692364e-01 1.45853025e+00 7.78388673e+00 1.17736848e+01
 1.63462688e+00 3.65240562e+00 3.58450239e+00 1.43886645e+01
 1.18122908e+01 6.38854644e+01 4.84806033e+01 3.73202387e+02
 3.27318095e-01 7.22265568e-01 1.12638965e+00 3.38528478e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998140917379633
cond(S) = 237.00645356614945
E1 = -183.574347392097  E_coul = 55.07984062181686
init E= -128.49450677028
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773804924991396  LUMO = 1.10048982610835
  mo_energy =
[-3.25544972e+01 -1.85132689e+00 -7.73804925e-01 -7.73804925e-01
 -7.73804925e-01  1.10048983e+00  1.10048983e+00  1.10048983e+00
  2.01958920e+00  5.65331568e+00  5.65331568e+00  5.65331568e+00
  1.92745108e+01  2.32222906e+01  2.32222906e+01  2.32222906e+01
  9.36882542e+01  1.07190439e+02  1.07190439e+02  1.07190439e+02
  3.56052847e+02  1.34944014e+03  5.83590321e+03  3.50985441e+04]
E1 = -182.1050565816805  E_coul = 53.580676151819496
cycle= 1 E= -128.524380429861  delta_E= -0.0299  |g|= 0.201  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.451776
diis-c [-0.20410127  1.        ]
  HOMO = -0.879366097347614  LUMO = 1.0632548464658
  mo_energy =
[-3.28744393e+01 -1.96186188e+00 -8.79366097e-01 -8.79366097e-01
 -8.79366097e-01  1.06325485e+00  1.06325485e+00  1.06325485e+00
  1.94605520e+00  5.52671035e+00  5.52671035e+00  5.52671035e+00
  1.90564780e+01  2.29908703e+01  2.29908703e+01  2.29908703e+01
  9.33871080e+01  1.06873570e+02  1.06873570e+02  1.06873570e+02
  3.55703890e+02  1.34905286e+03  5.83548406e+03  3.50981033e+04]
E1 = -182.84014020385953  E_coul = 54.313220915779745
cycle= 2 E= -128.52691928808  delta_E= -0.00254  |g|=  0.1  |ddm|= 0.0771
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.224326
diis-c [-5.75235720e-04  3.30832371e-01  6.69167629e-01]
  HOMO = -0.844811985120775  LUMO = 1.07557510242924
  mo_energy =
[-3.27688549e+01 -1.92544126e+00 -8.44811985e-01 -8.44811985e-01
 -8.44811985e-01  1.07557510e+00  1.07557510e+00  1.07557510e+00
  1.97014913e+00  5.56805880e+00  5.56805880e+00  5.56805880e+00
  1.91287814e+01  2.30674384e+01  2.30674384e+01  2.30674384e+01
  9.34867754e+01  1.06977650e+02  1.06977650e+02  1.06977650e+02
  3.55816221e+02  1.34917139e+03  5.83560551e+03  3.50982259e+04]
E1 = -182.5945029056522  E_coul = 54.0667330319499
cycle= 3 E= -128.527769873702  delta_E= -0.000851  |g|= 0.000458  |ddm|= 0.0264
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107914
diis-c [-9.54572443e-08 -2.10352779e-03  3.85304878e-04  1.00171822e+00]
  HOMO = -0.845024205002951  LUMO = 1.07553970085856
  mo_energy =
[-3.27692918e+01 -1.92559417e+00 -8.45024205e-01 -8.45024205e-01
 -8.45024205e-01  1.07553970e+00  1.07553970e+00  1.07553970e+00
  1.97007605e+00  5.56787351e+00  5.56787351e+00  5.56787351e+00
  1.91285045e+01  2.30671208e+01  2.30671208e+01  2.30671208e+01
  9.34863686e+01  1.06977211e+02  1.06977211e+02  1.06977211e+02
  3.55815693e+02  1.34917072e+03  5.83560473e+03  3.50982251e+04]
E1 = -182.59517234504187  E_coul = 54.067402454882945
cycle= 4 E= -128.527769890159  delta_E= -1.65e-08  |g|= 6.47e-05  |ddm|= 9.68e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000156569
diis-c [-4.84733513e-10  2.19242402e-04  4.71221447e-04 -1.61136764e-01
  1.16044630e+00]
  HOMO = -0.845052935927397  LUMO = 1.07552869114271
  mo_energy =
[-3.27693524e+01 -1.92561418e+00 -8.45052936e-01 -8.45052936e-01
 -8.45052936e-01  1.07552869e+00  1.07552869e+00  1.07552869e+00
  1.97006142e+00  5.56784017e+00  5.56784017e+00  5.56784017e+00
  1.91284604e+01  2.30670715e+01  2.30670715e+01  2.30670715e+01
  9.34863106e+01  1.06977151e+02  1.06977151e+02  1.06977151e+02
  3.55815624e+02  1.34917064e+03  5.83560464e+03  3.50982250e+04]
E1 = -182.5953149646423  E_coul = 54.06754507405519
cycle= 5 E= -128.527769890587  delta_E= -4.28e-10  |g|= 4.07e-06  |ddm|= 2.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5953149646423  E_coul = 54.06754507405519
  HOMO = -0.845050926855869  LUMO = 1.07552954097633
  mo_energy =
[-3.27693481e+01 -1.92561152e+00 -8.45050927e-01 -8.45050927e-01
 -8.45050927e-01  1.07552954e+00  1.07552954e+00  1.07552954e+00
  1.97006344e+00  5.56784263e+00  5.56784263e+00  5.56784263e+00
  1.91284643e+01  2.30670752e+01  2.30670752e+01  2.30670752e+01
  9.34863147e+01  1.06977155e+02  1.06977155e+02  1.06977155e+02
  3.55815628e+02  1.34917065e+03  5.83560465e+03  3.50982250e+04]
E1 = -182.59530537283004  E_coul = 54.06753548224195
Extra cycle  E= -128.527769890588  delta_E= -9.66e-13  |g|= 1.37e-06  |ddm|= 2.07e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 237.00645356614945
E1 = -182.59530537283004  E_coul = 54.06753548224195
init E= -128.527769890588
    CPU time for initialize scf      0.17 sec, wall time      0.16 sec
  HOMO = -0.845051607684803  LUMO = 1.07552931127782
  mo_energy =
[-3.27693503e+01 -1.92561212e+00 -8.45051608e-01 -8.45051608e-01
 -8.45051608e-01  1.07552931e+00  1.07552931e+00  1.07552931e+00
  1.97006307e+00  5.56784183e+00  5.56784183e+00  5.56784183e+00
  1.91284629e+01  2.30670737e+01  2.30670737e+01  2.30670737e+01
  9.34863127e+01  1.06977153e+02  1.06977153e+02  1.06977153e+02
  3.55815626e+02  1.34917064e+03  5.83560464e+03  3.50982250e+04]
E1 = -182.59531059752837  E_coul = 54.067540706939724
cycle= 1 E= -128.527769890589  delta_E= -5.4e-13  |g|= 7.21e-07  |ddm|= 5.36e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59531059752837  E_coul = 54.067540706939724
  HOMO = -0.84505124246901  LUMO = 1.07552944367034
  mo_energy =
[-3.27693492e+01 -1.92561171e+00 -8.45051242e-01 -8.45051242e-01
 -8.45051242e-01  1.07552944e+00  1.07552944e+00  1.07552944e+00
  1.97006334e+00  5.56784227e+00  5.56784227e+00  5.56784227e+00
  1.91284636e+01  2.30670745e+01  2.30670745e+01  2.30670745e+01
  9.34863138e+01  1.06977154e+02  1.06977154e+02  1.06977154e+02
  3.55815627e+02  1.34917065e+03  5.83560465e+03  3.50982250e+04]
E1 = -182.59530803333587  E_coul = 54.06753814274746
Extra cycle  E= -128.527769890588  delta_E= 2.27e-13  |g|= 3.48e-07  |ddm|= 3.02e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498471e+02 1.74907400e+02
 2.05195058e+01 5.69524708e+01 4.80692364e-01 7.78388673e+00
 1.63462688e+00 3.58450239e+00 1.18122908e+01 4.84806033e+01
 3.27318095e-01 1.12638965e+00]
grad_E = [-1.14322971e-09  6.03094849e-08 -1.18815620e-06  1.35860627e-05
  3.42663033e-04 -9.11094807e-05 -2.55551053e-03 -5.01849102e-04
 -6.98449615e-04 -1.07469659e-03  8.04223271e-04 -2.38622511e-04
 -3.79158681e-03  3.35803435e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682505        1
[INPUT] 0    0    [1    /1   ]  617.498472135        1
[INPUT] 0    0    [1    /1   ]  174.907405601        1
[INPUT] 0    0    [1    /1   ]  20.5211162259        1
[INPUT] 0    0    [1    /1   ]  56.9524322411        1
[INPUT] 0    0    [1    /1   ]  0.485397222663       1
[INPUT] 0    0    [1    /1   ]  7.7828260299         1
[INPUT] 0    0    [1    /1   ]  1.65111919963        1
[INPUT] 1    0    [1    /1   ]  3.60523151069        1
[INPUT] 1    0    [1    /1   ]  11.9763884394        1
[INPUT] 1    0    [1    /1   ]  49.7248713602        1
[INPUT] 1    0    [1    /1   ]  0.327689217167       1
[INPUT] 1    0    [1    /1   ]  1.12832618832        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729959115, 1.0]], [0, [2712.096825052229, 1.0]], [0, [617.4984721347306, 1.0]], [0, [174.90740560136155, 1.0]], [0, [20.521116225870262, 1.0]], [0, [56.95243224113373, 1.0]], [0, [0.48539722266286334, 1.0]], [0, [7.782826029895978, 1.0]], [0, [1.651119199625551, 1.0]], [1, [3.605231510686645, 1.0]], [1, [11.976388439432759, 1.0]], [1, [49.7248713602026, 1.0]], [1, [0.32768921716700966, 1.0]], [1, [1.1283261883206106, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872996]
bas 1, expnt(s) = [2712.09682505]
bas 2, expnt(s) = [617.49847213]
bas 3, expnt(s) = [174.9074056]
bas 4, expnt(s) = [20.52111623]
bas 5, expnt(s) = [56.95243224]
bas 6, expnt(s) = [0.48539722]
bas 7, expnt(s) = [7.78282603]
bas 8, expnt(s) = [1.6511192]
bas 9, expnt(s) = [3.60523151]
bas 10, expnt(s) = [11.97638844]
bas 11, expnt(s) = [49.72487136]
bas 12, expnt(s) = [0.32768922]
bas 13, expnt(s) = [1.12832619]
CPU time:       123.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498472e+02 3.12962239e+02 1.74907406e+02 1.21512561e+02
 2.05211162e+01 2.43593536e+01 5.69524322e+01 5.23780386e+01
 4.85397223e-01 1.46922392e+00 7.78282603e+00 1.17724815e+01
 1.65111920e+00 3.68000870e+00 3.60523151e+00 1.44927513e+01
 1.19763884e+01 6.49967639e+01 4.97248714e+01 3.85213481e+02
 3.27689217e-01 7.23289368e-01 1.12832619e+00 3.39256149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998108762265797
cond(S) = 238.02928268463384
E1 = -183.57470030512889  E_coul = 55.07991753437889
init E= -128.49478277075
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773824276134607  LUMO = 1.10238064980881
  mo_energy =
[-3.25544792e+01 -1.85132230e+00 -7.73824276e-01 -7.73824276e-01
 -7.73824276e-01  1.10238065e+00  1.10238065e+00  1.10238065e+00
  2.05028823e+00  5.67294989e+00  5.67294989e+00  5.67294989e+00
  1.93610185e+01  2.34530597e+01  2.34530597e+01  2.34530597e+01
  9.37737939e+01  1.09640227e+02  1.09640227e+02  1.09640227e+02
  3.56131042e+02  1.34951031e+03  5.83596483e+03  3.50985951e+04]
E1 = -182.10869994949186  E_coul = 53.58413390360848
cycle= 1 E= -128.524566045883  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.449495
diis-c [-0.20204582  1.        ]
  HOMO = -0.879115454200175  LUMO = 1.06517258602685
  mo_energy =
[-3.28737532e+01 -1.96165278e+00 -8.79115454e-01 -8.79115454e-01
 -8.79115454e-01  1.06517259e+00  1.06517259e+00  1.06517259e+00
  1.97612963e+00  5.54616820e+00  5.54616820e+00  5.54616820e+00
  1.91433765e+01  2.32210467e+01  2.32210467e+01  2.32210467e+01
  9.34733038e+01  1.09322879e+02  1.09322879e+02  1.09322879e+02
  3.55782794e+02  1.34912379e+03  5.83554646e+03  3.50981551e+04]
E1 = -182.841938360746  E_coul = 54.314843792367625
cycle= 2 E= -128.527094568378  delta_E= -0.00253  |g|= 0.0999  |ddm|= 0.0771
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.223194
diis-c [-5.74872528e-04  3.30823585e-01  6.69176415e-01]
  HOMO = -0.844652769690477  LUMO = 1.07748825052504
  mo_energy =
[-3.27684161e+01 -1.92532383e+00 -8.44652770e-01 -8.44652770e-01
 -8.44652770e-01  1.07748825e+00  1.07748825e+00  1.07748825e+00
  2.00041585e+00  5.58757366e+00  5.58757366e+00  5.58757366e+00
  1.92155160e+01  2.32977983e+01  2.32977983e+01  2.32977983e+01
  9.35727272e+01  1.09427046e+02  1.09427046e+02  1.09427046e+02
  3.55894867e+02  1.34924205e+03  5.83566765e+03  3.50982774e+04]
E1 = -182.59699442341278  E_coul = 54.06905340483432
cycle= 3 E= -128.527941018578  delta_E= -0.000846  |g|= 0.000443  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103984
diis-c [-8.41578532e-08 -2.08173031e-03  2.93009852e-04  1.00178872e+00]
  HOMO = -0.844860749020056  LUMO = 1.07745414527971
  mo_energy =
[-3.27688433e+01 -1.92547636e+00 -8.44860749e-01 -8.44860749e-01
 -8.44860749e-01  1.07745415e+00  1.07745415e+00  1.07745415e+00
  2.00034200e+00  5.58739214e+00  5.58739214e+00  5.58739214e+00
  1.92152433e+01  2.32974863e+01  2.32974863e+01  2.32974863e+01
  9.35723293e+01  1.09426614e+02  1.09426614e+02  1.09426614e+02
  3.55894352e+02  1.34924140e+03  5.83566689e+03  3.50982766e+04]
E1 = -182.5976459406619  E_coul = 54.06970490695151
cycle= 4 E= -128.52794103371  delta_E= -1.51e-08  |g|= 6.14e-05  |ddm|= 9.01e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000148147
diis-c [-4.48939531e-10  2.10769485e-04  4.61363696e-04 -1.55624012e-01
  1.15495188e+00]
  HOMO = -0.844888296320249  LUMO = 1.07744352486051
  mo_energy =
[-3.27689012e+01 -1.92549608e+00 -8.44888296e-01 -8.44888296e-01
 -8.44888296e-01  1.07744352e+00  1.07744352e+00  1.07744352e+00
  2.00032739e+00  5.58736001e+00  5.58736001e+00  5.58736001e+00
  1.92152008e+01  2.32974388e+01  2.32974388e+01  2.32974388e+01
  9.35722738e+01  1.09426556e+02  1.09426556e+02  1.09426556e+02
  3.55894287e+02  1.34924133e+03  5.83566681e+03  3.50982765e+04]
E1 = -182.597781906659  E_coul = 54.06984087257038
cycle= 5 E= -128.527941034089  delta_E= -3.78e-10  |g|= 3.83e-06  |ddm|= 1.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.597781906659  E_coul = 54.06984087257038
  HOMO = -0.844886430128979  LUMO = 1.07744431612129
  mo_energy =
[-3.27688972e+01 -1.92549358e+00 -8.44886430e-01 -8.44886430e-01
 -8.44886430e-01  1.07744432e+00  1.07744432e+00  1.07744432e+00
  2.00032929e+00  5.58736231e+00  5.58736231e+00  5.58736231e+00
  1.92152044e+01  2.32974423e+01  2.32974423e+01  2.32974423e+01
  9.35722776e+01  1.09426560e+02  1.09426560e+02  1.09426560e+02
  3.55894290e+02  1.34924133e+03  5.83566681e+03  3.50982765e+04]
E1 = -182.59777297320306  E_coul = 54.06983193911317
Extra cycle  E= -128.52794103409  delta_E= -1.28e-12  |g|= 1.28e-06  |ddm|= 1.96e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498472e+02 1.74907406e+02
 2.05211162e+01 5.69524322e+01 4.85397223e-01 7.78282603e+00
 1.65111920e+00 3.60523151e+00 1.19763884e+01 4.97248714e+01
 3.27689217e-01 1.12832619e+00]
E = -128.5279410340899
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682505        1
[INPUT] 0    0    [1    /1   ]  617.498472135        1
[INPUT] 0    0    [1    /1   ]  174.907405601        1
[INPUT] 0    0    [1    /1   ]  20.5211162259        1
[INPUT] 0    0    [1    /1   ]  56.9524322411        1
[INPUT] 0    0    [1    /1   ]  0.485397222663       1
[INPUT] 0    0    [1    /1   ]  7.7828260299         1
[INPUT] 0    0    [1    /1   ]  1.65111919963        1
[INPUT] 1    0    [1    /1   ]  3.60523151069        1
[INPUT] 1    0    [1    /1   ]  11.9763884394        1
[INPUT] 1    0    [1    /1   ]  49.7248713602        1
[INPUT] 1    0    [1    /1   ]  0.327689217167       1
[INPUT] 1    0    [1    /1   ]  1.12832618832        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729959115, 1.0]], [0, [2712.096825052229, 1.0]], [0, [617.4984721347306, 1.0]], [0, [174.90740560136155, 1.0]], [0, [20.521116225870262, 1.0]], [0, [56.95243224113373, 1.0]], [0, [0.48539722266286334, 1.0]], [0, [7.782826029895978, 1.0]], [0, [1.651119199625551, 1.0]], [1, [3.605231510686645, 1.0]], [1, [11.976388439432759, 1.0]], [1, [49.7248713602026, 1.0]], [1, [0.32768921716700966, 1.0]], [1, [1.1283261883206106, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872996]
bas 1, expnt(s) = [2712.09682505]
bas 2, expnt(s) = [617.49847213]
bas 3, expnt(s) = [174.9074056]
bas 4, expnt(s) = [20.52111623]
bas 5, expnt(s) = [56.95243224]
bas 6, expnt(s) = [0.48539722]
bas 7, expnt(s) = [7.78282603]
bas 8, expnt(s) = [1.6511192]
bas 9, expnt(s) = [3.60523151]
bas 10, expnt(s) = [11.97638844]
bas 11, expnt(s) = [49.72487136]
bas 12, expnt(s) = [0.32768922]
bas 13, expnt(s) = [1.12832619]
CPU time:       124.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498472e+02 3.12962239e+02 1.74907406e+02 1.21512561e+02
 2.05211162e+01 2.43593536e+01 5.69524322e+01 5.23780386e+01
 4.85397223e-01 1.46922392e+00 7.78282603e+00 1.17724815e+01
 1.65111920e+00 3.68000870e+00 3.60523151e+00 1.44927513e+01
 1.19763884e+01 6.49967639e+01 4.97248714e+01 3.85213481e+02
 3.27689217e-01 7.23289368e-01 1.12832619e+00 3.39256149e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998108762265797
cond(S) = 238.02928268463384
E1 = -183.57470030512889  E_coul = 55.07991753437889
init E= -128.49478277075
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773824276134607  LUMO = 1.10238064980881
  mo_energy =
[-3.25544792e+01 -1.85132230e+00 -7.73824276e-01 -7.73824276e-01
 -7.73824276e-01  1.10238065e+00  1.10238065e+00  1.10238065e+00
  2.05028823e+00  5.67294989e+00  5.67294989e+00  5.67294989e+00
  1.93610185e+01  2.34530597e+01  2.34530597e+01  2.34530597e+01
  9.37737939e+01  1.09640227e+02  1.09640227e+02  1.09640227e+02
  3.56131042e+02  1.34951031e+03  5.83596483e+03  3.50985951e+04]
E1 = -182.10869994949186  E_coul = 53.58413390360848
cycle= 1 E= -128.524566045883  delta_E= -0.0298  |g|= 0.201  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.449495
diis-c [-0.20204582  1.        ]
  HOMO = -0.879115454200175  LUMO = 1.06517258602685
  mo_energy =
[-3.28737532e+01 -1.96165278e+00 -8.79115454e-01 -8.79115454e-01
 -8.79115454e-01  1.06517259e+00  1.06517259e+00  1.06517259e+00
  1.97612963e+00  5.54616820e+00  5.54616820e+00  5.54616820e+00
  1.91433765e+01  2.32210467e+01  2.32210467e+01  2.32210467e+01
  9.34733038e+01  1.09322879e+02  1.09322879e+02  1.09322879e+02
  3.55782794e+02  1.34912379e+03  5.83554646e+03  3.50981551e+04]
E1 = -182.841938360746  E_coul = 54.314843792367625
cycle= 2 E= -128.527094568378  delta_E= -0.00253  |g|= 0.0999  |ddm|= 0.0771
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.223194
diis-c [-5.74872528e-04  3.30823585e-01  6.69176415e-01]
  HOMO = -0.844652769690477  LUMO = 1.07748825052504
  mo_energy =
[-3.27684161e+01 -1.92532383e+00 -8.44652770e-01 -8.44652770e-01
 -8.44652770e-01  1.07748825e+00  1.07748825e+00  1.07748825e+00
  2.00041585e+00  5.58757366e+00  5.58757366e+00  5.58757366e+00
  1.92155160e+01  2.32977983e+01  2.32977983e+01  2.32977983e+01
  9.35727272e+01  1.09427046e+02  1.09427046e+02  1.09427046e+02
  3.55894867e+02  1.34924205e+03  5.83566765e+03  3.50982774e+04]
E1 = -182.59699442341278  E_coul = 54.06905340483432
cycle= 3 E= -128.527941018578  delta_E= -0.000846  |g|= 0.000443  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103984
diis-c [-8.41578532e-08 -2.08173031e-03  2.93009852e-04  1.00178872e+00]
  HOMO = -0.844860749020056  LUMO = 1.07745414527971
  mo_energy =
[-3.27688433e+01 -1.92547636e+00 -8.44860749e-01 -8.44860749e-01
 -8.44860749e-01  1.07745415e+00  1.07745415e+00  1.07745415e+00
  2.00034200e+00  5.58739214e+00  5.58739214e+00  5.58739214e+00
  1.92152433e+01  2.32974863e+01  2.32974863e+01  2.32974863e+01
  9.35723293e+01  1.09426614e+02  1.09426614e+02  1.09426614e+02
  3.55894352e+02  1.34924140e+03  5.83566689e+03  3.50982766e+04]
E1 = -182.5976459406619  E_coul = 54.06970490695151
cycle= 4 E= -128.52794103371  delta_E= -1.51e-08  |g|= 6.14e-05  |ddm|= 9.01e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000148147
diis-c [-4.48939531e-10  2.10769485e-04  4.61363696e-04 -1.55624012e-01
  1.15495188e+00]
  HOMO = -0.844888296320249  LUMO = 1.07744352486051
  mo_energy =
[-3.27689012e+01 -1.92549608e+00 -8.44888296e-01 -8.44888296e-01
 -8.44888296e-01  1.07744352e+00  1.07744352e+00  1.07744352e+00
  2.00032739e+00  5.58736001e+00  5.58736001e+00  5.58736001e+00
  1.92152008e+01  2.32974388e+01  2.32974388e+01  2.32974388e+01
  9.35722738e+01  1.09426556e+02  1.09426556e+02  1.09426556e+02
  3.55894287e+02  1.34924133e+03  5.83566681e+03  3.50982765e+04]
E1 = -182.597781906659  E_coul = 54.06984087257038
cycle= 5 E= -128.527941034089  delta_E= -3.78e-10  |g|= 3.83e-06  |ddm|= 1.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.597781906659  E_coul = 54.06984087257038
  HOMO = -0.844886430128979  LUMO = 1.07744431612129
  mo_energy =
[-3.27688972e+01 -1.92549358e+00 -8.44886430e-01 -8.44886430e-01
 -8.44886430e-01  1.07744432e+00  1.07744432e+00  1.07744432e+00
  2.00032929e+00  5.58736231e+00  5.58736231e+00  5.58736231e+00
  1.92152044e+01  2.32974423e+01  2.32974423e+01  2.32974423e+01
  9.35722776e+01  1.09426560e+02  1.09426560e+02  1.09426560e+02
  3.55894290e+02  1.34924133e+03  5.83566681e+03  3.50982765e+04]
E1 = -182.59777297320306  E_coul = 54.06983193911317
Extra cycle  E= -128.52794103409  delta_E= -1.28e-12  |g|= 1.28e-06  |ddm|= 1.96e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.02928268463384
E1 = -182.59777297320306  E_coul = 54.06983193911317
init E= -128.52794103409
    CPU time for initialize scf      0.17 sec, wall time      0.16 sec
  HOMO = -0.844887064771936  LUMO = 1.07744410149876
  mo_energy =
[-3.27688992e+01 -1.92549414e+00 -8.44887065e-01 -8.44887065e-01
 -8.44887065e-01  1.07744410e+00  1.07744410e+00  1.07744410e+00
  2.00032895e+00  5.58736156e+00  5.58736156e+00  5.58736156e+00
  1.92152031e+01  2.32974409e+01  2.32974409e+01  2.32974409e+01
  9.35722758e+01  1.09426558e+02  1.09426558e+02  1.09426558e+02
  3.55894288e+02  1.34924133e+03  5.83566681e+03  3.50982765e+04]
E1 = -182.59777783929374  E_coul = 54.06983680520364
cycle= 1 E= -128.52794103409  delta_E= -1.99e-13  |g|= 6.72e-07  |ddm|= 5.01e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59777783929374  E_coul = 54.06983680520364
  HOMO = -0.844886724765208  LUMO = 1.07744422505327
  mo_energy =
[-3.27688982e+01 -1.92549376e+00 -8.44886725e-01 -8.44886725e-01
 -8.44886725e-01  1.07744423e+00  1.07744423e+00  1.07744423e+00
  2.00032920e+00  5.58736197e+00  5.58736197e+00  5.58736197e+00
  1.92152038e+01  2.32974416e+01  2.32974416e+01  2.32974416e+01
  9.35722767e+01  1.09426559e+02  1.09426559e+02  1.09426559e+02
  3.55894289e+02  1.34924133e+03  5.83566681e+03  3.50982765e+04]
E1 = -182.59777545286133  E_coul = 54.069834418771244
Extra cycle  E= -128.52794103409  delta_E= 2.84e-14  |g|= 3.24e-07  |ddm|= 2.82e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498472e+02 1.74907406e+02
 2.05211162e+01 5.69524322e+01 4.85397223e-01 7.78282603e+00
 1.65111920e+00 3.60523151e+00 1.19763884e+01 4.97248714e+01
 3.27689217e-01 1.12832619e+00]
grad_E = [-1.16251252e-09  6.11698177e-08 -1.20895938e-06  1.37262134e-05
  3.32021803e-04 -9.22316305e-05 -1.82972287e-03 -4.97962205e-04
  1.76093414e-04 -1.14408456e-03  8.04514986e-04 -1.97473172e-04
 -2.20946293e-03  2.15889236e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682494        1
[INPUT] 0    0    [1    /1   ]  617.498475751        1
[INPUT] 0    0    [1    /1   ]  174.90740804         1
[INPUT] 0    0    [1    /1   ]  20.5260284179        1
[INPUT] 0    0    [1    /1   ]  56.952401776         1
[INPUT] 0    0    [1    /1   ]  0.490086333041       1
[INPUT] 0    0    [1    /1   ]  7.77899841612        1
[INPUT] 0    0    [1    /1   ]  1.65886525795        1
[INPUT] 1    0    [1    /1   ]  3.67469424194        1
[INPUT] 1    0    [1    /1   ]  12.4328124248        1
[INPUT] 1    0    [1    /1   ]  53.2413739549        1
[INPUT] 1    0    [1    /1   ]  0.33119640725        1
[INPUT] 1    0    [1    /1   ]  1.14249526489        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729953506, 1.0]], [0, [2712.096824943269, 1.0]], [0, [617.4984757511963, 1.0]], [0, [174.90740804033928, 1.0]], [0, [20.52602841794657, 1.0]], [0, [56.95240177599187, 1.0]], [0, [0.49008633304125016, 1.0]], [0, [7.778998416123603, 1.0]], [0, [1.6588652579487788, 1.0]], [1, [3.6746942419380026, 1.0]], [1, [12.432812424823423, 1.0]], [1, [53.24137395491845, 1.0]], [1, [0.33119640724959115, 1.0]], [1, [1.1424952648884084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872995]
bas 1, expnt(s) = [2712.09682494]
bas 2, expnt(s) = [617.49847575]
bas 3, expnt(s) = [174.90740804]
bas 4, expnt(s) = [20.52602842]
bas 5, expnt(s) = [56.95240178]
bas 6, expnt(s) = [0.49008633]
bas 7, expnt(s) = [7.77899842]
bas 8, expnt(s) = [1.65886526]
bas 9, expnt(s) = [3.67469424]
bas 10, expnt(s) = [12.43281242]
bas 11, expnt(s) = [53.24137395]
bas 12, expnt(s) = [0.33119641]
bas 13, expnt(s) = [1.14249526]
CPU time:       126.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498476e+02 3.12962240e+02 1.74907408e+02 1.21512562e+02
 2.05260284e+01 2.43637267e+01 5.69524018e+01 5.23780176e+01
 4.90086333e-01 1.47985603e+00 7.77899842e+00 1.17681389e+01
 1.65886526e+00 3.69294941e+00 3.67469424e+00 1.48426314e+01
 1.24328124e+01 6.81076851e+01 5.32413740e+01 4.19561820e+02
 3.31196407e-01 7.32978800e-01 1.14249526e+00 3.44589789e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998006820301576
cond(S) = 238.58499888984446
E1 = -183.57474428824443  E_coul = 55.07969858023863
init E= -128.495045708006
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773866439591986  LUMO = 1.11795877555523
  mo_energy =
[-3.25545349e+01 -1.85132502e+00 -7.73866440e-01 -7.73866440e-01
 -7.73866440e-01  1.11795878e+00  1.11795878e+00  1.11795878e+00
  2.07309680e+00  5.76831035e+00  5.76831035e+00  5.76831035e+00
  1.94089381e+01  2.41713970e+01  2.41713970e+01  2.41713970e+01
  9.38209254e+01  1.16659442e+02  1.16659442e+02  1.16659442e+02
  3.56178246e+02  1.34955427e+03  5.83600380e+03  3.50986274e+04]
E1 = -182.12026307208396  E_coul = 53.595423597810544
cycle= 1 E= -128.524839474273  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.177
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443302
diis-c [-0.19651626  1.        ]
  HOMO = -0.878207128273786  LUMO = 1.08051949297229
  mo_energy =
[-3.28718307e+01 -1.96075415e+00 -8.78207128e-01 -8.78207128e-01
 -8.78207128e-01  1.08051949e+00  1.08051949e+00  1.08051949e+00
  1.99912552e+00  5.64092479e+00  5.64092479e+00  5.64092479e+00
  1.91929135e+01  2.39380663e+01  2.39380663e+01  2.39380663e+01
  9.35223473e+01  1.16341096e+02  1.16341096e+02  1.16341096e+02
  3.55832002e+02  1.34916976e+03  5.83558746e+03  3.50981894e+04]
E1 = -182.84703474124592  E_coul = 54.319699540603104
cycle= 2 E= -128.527335200643  delta_E= -0.0025  |g|= 0.099  |ddm|= 0.0769
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219727
diis-c [-5.70573627e-04  3.30404884e-01  6.69595116e-01]
  HOMO = -0.844037204146785  LUMO = 1.09292924856241
  mo_energy =
[-3.27673126e+01 -1.92473792e+00 -8.44037204e-01 -8.44037204e-01
 -8.44037204e-01  1.09292925e+00  1.09292925e+00  1.09292925e+00
  2.02335587e+00  5.68254704e+00  5.68254704e+00  5.68254704e+00
  1.92644648e+01  2.40151872e+01  2.40151872e+01  2.40151872e+01
  9.36209904e+01  1.16445302e+02  1.16445302e+02  1.16445302e+02
  3.55943221e+02  1.34928714e+03  5.83570775e+03  3.50983108e+04]
E1 = -182.60459276556836  E_coul = 54.07642657528922
cycle= 3 E= -128.528166190279  delta_E= -0.000831  |g|= 0.000426  |ddm|= 0.0262
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00099128
diis-c [-6.78792223e-08 -2.05212292e-03  2.23393543e-04  1.00182873e+00]
  HOMO = -0.844239988225072  LUMO = 1.09289549665613
  mo_energy =
[-3.27677343e+01 -1.92489373e+00 -8.44239988e-01 -8.44239988e-01
 -8.44239988e-01  1.09289550e+00  1.09289550e+00  1.09289550e+00
  2.02327879e+00  5.68236719e+00  5.68236719e+00  5.68236719e+00
  1.92641942e+01  2.40148754e+01  2.40148754e+01  2.40148754e+01
  9.36205977e+01  1.16444871e+02  1.16444871e+02  1.16444871e+02
  3.55942715e+02  1.34928650e+03  5.83570701e+03  3.50983100e+04]
E1 = -182.60523756540016  E_coul = 54.07707136174696
cycle= 4 E= -128.528166203653  delta_E= -1.34e-08  |g|= 5.52e-05  |ddm|= 7.64e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131936
diis-c [-3.58811036e-10  1.83288923e-04  4.20035536e-04 -1.39638901e-01
  1.13903558e+00]
  HOMO = -0.844265231022221  LUMO = 1.09288552293713
  mo_energy =
[-3.27677871e+01 -1.92491298e+00 -8.44265231e-01 -8.44265231e-01
 -8.44265231e-01  1.09288552e+00  1.09288552e+00  1.09288552e+00
  2.02326434e+00  5.68233731e+00  5.68233731e+00  5.68233731e+00
  1.92641548e+01  2.40148315e+01  2.40148315e+01  2.40148315e+01
  9.36205470e+01  1.16444818e+02  1.16444818e+02  1.16444818e+02
  3.55942657e+02  1.34928644e+03  5.83570694e+03  3.50983100e+04]
E1 = -182.60536030645264  E_coul = 54.07719410250902
cycle= 5 E= -128.528166203944  delta_E= -2.9e-10  |g|= 3.23e-06  |ddm|= 1.48e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60536030645264  E_coul = 54.07719410250902
  HOMO = -0.844263749311791  LUMO = 1.09288616239705
  mo_energy =
[-3.27677839e+01 -1.92491093e+00 -8.44263749e-01 -8.44263749e-01
 -8.44263749e-01  1.09288616e+00  1.09288616e+00  1.09288616e+00
  2.02326591e+00  5.68233916e+00  5.68233916e+00  5.68233916e+00
  1.92641577e+01  2.40148343e+01  2.40148343e+01  2.40148343e+01
  9.36205501e+01  1.16444821e+02  1.16444821e+02  1.16444821e+02
  3.55942659e+02  1.34928644e+03  5.83570694e+03  3.50983100e+04]
E1 = -182.60535311688582  E_coul = 54.077186912941606
Extra cycle  E= -128.528166203944  delta_E= -5.97e-13  |g|= 1.04e-06  |ddm|= 1.71e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498476e+02 1.74907408e+02
 2.05260284e+01 5.69524018e+01 4.90086333e-01 7.77899842e+00
 1.65886526e+00 3.67469424e+00 1.24328124e+01 5.32413740e+01
 3.31196407e-01 1.14249526e+00]
E = -128.5281662039442
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682494        1
[INPUT] 0    0    [1    /1   ]  617.498475751        1
[INPUT] 0    0    [1    /1   ]  174.90740804         1
[INPUT] 0    0    [1    /1   ]  20.5260284179        1
[INPUT] 0    0    [1    /1   ]  56.952401776         1
[INPUT] 0    0    [1    /1   ]  0.490086333041       1
[INPUT] 0    0    [1    /1   ]  7.77899841612        1
[INPUT] 0    0    [1    /1   ]  1.65886525795        1
[INPUT] 1    0    [1    /1   ]  3.67469424194        1
[INPUT] 1    0    [1    /1   ]  12.4328124248        1
[INPUT] 1    0    [1    /1   ]  53.2413739549        1
[INPUT] 1    0    [1    /1   ]  0.33119640725        1
[INPUT] 1    0    [1    /1   ]  1.14249526489        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729953506, 1.0]], [0, [2712.096824943269, 1.0]], [0, [617.4984757511963, 1.0]], [0, [174.90740804033928, 1.0]], [0, [20.52602841794657, 1.0]], [0, [56.95240177599187, 1.0]], [0, [0.49008633304125016, 1.0]], [0, [7.778998416123603, 1.0]], [0, [1.6588652579487788, 1.0]], [1, [3.6746942419380026, 1.0]], [1, [12.432812424823423, 1.0]], [1, [53.24137395491845, 1.0]], [1, [0.33119640724959115, 1.0]], [1, [1.1424952648884084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872995]
bas 1, expnt(s) = [2712.09682494]
bas 2, expnt(s) = [617.49847575]
bas 3, expnt(s) = [174.90740804]
bas 4, expnt(s) = [20.52602842]
bas 5, expnt(s) = [56.95240178]
bas 6, expnt(s) = [0.49008633]
bas 7, expnt(s) = [7.77899842]
bas 8, expnt(s) = [1.65886526]
bas 9, expnt(s) = [3.67469424]
bas 10, expnt(s) = [12.43281242]
bas 11, expnt(s) = [53.24137395]
bas 12, expnt(s) = [0.33119641]
bas 13, expnt(s) = [1.14249526]
CPU time:       127.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498476e+02 3.12962240e+02 1.74907408e+02 1.21512562e+02
 2.05260284e+01 2.43637267e+01 5.69524018e+01 5.23780176e+01
 4.90086333e-01 1.47985603e+00 7.77899842e+00 1.17681389e+01
 1.65886526e+00 3.69294941e+00 3.67469424e+00 1.48426314e+01
 1.24328124e+01 6.81076851e+01 5.32413740e+01 4.19561820e+02
 3.31196407e-01 7.32978800e-01 1.14249526e+00 3.44589789e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998006820301576
cond(S) = 238.58499888984446
E1 = -183.57474428824443  E_coul = 55.07969858023863
init E= -128.495045708006
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773866439591986  LUMO = 1.11795877555523
  mo_energy =
[-3.25545349e+01 -1.85132502e+00 -7.73866440e-01 -7.73866440e-01
 -7.73866440e-01  1.11795878e+00  1.11795878e+00  1.11795878e+00
  2.07309680e+00  5.76831035e+00  5.76831035e+00  5.76831035e+00
  1.94089381e+01  2.41713970e+01  2.41713970e+01  2.41713970e+01
  9.38209254e+01  1.16659442e+02  1.16659442e+02  1.16659442e+02
  3.56178246e+02  1.34955427e+03  5.83600380e+03  3.50986274e+04]
E1 = -182.12026307208396  E_coul = 53.595423597810544
cycle= 1 E= -128.524839474273  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.177
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443302
diis-c [-0.19651626  1.        ]
  HOMO = -0.878207128273786  LUMO = 1.08051949297229
  mo_energy =
[-3.28718307e+01 -1.96075415e+00 -8.78207128e-01 -8.78207128e-01
 -8.78207128e-01  1.08051949e+00  1.08051949e+00  1.08051949e+00
  1.99912552e+00  5.64092479e+00  5.64092479e+00  5.64092479e+00
  1.91929135e+01  2.39380663e+01  2.39380663e+01  2.39380663e+01
  9.35223473e+01  1.16341096e+02  1.16341096e+02  1.16341096e+02
  3.55832002e+02  1.34916976e+03  5.83558746e+03  3.50981894e+04]
E1 = -182.84703474124592  E_coul = 54.319699540603104
cycle= 2 E= -128.527335200643  delta_E= -0.0025  |g|= 0.099  |ddm|= 0.0769
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219727
diis-c [-5.70573627e-04  3.30404884e-01  6.69595116e-01]
  HOMO = -0.844037204146785  LUMO = 1.09292924856241
  mo_energy =
[-3.27673126e+01 -1.92473792e+00 -8.44037204e-01 -8.44037204e-01
 -8.44037204e-01  1.09292925e+00  1.09292925e+00  1.09292925e+00
  2.02335587e+00  5.68254704e+00  5.68254704e+00  5.68254704e+00
  1.92644648e+01  2.40151872e+01  2.40151872e+01  2.40151872e+01
  9.36209904e+01  1.16445302e+02  1.16445302e+02  1.16445302e+02
  3.55943221e+02  1.34928714e+03  5.83570775e+03  3.50983108e+04]
E1 = -182.60459276556836  E_coul = 54.07642657528922
cycle= 3 E= -128.528166190279  delta_E= -0.000831  |g|= 0.000426  |ddm|= 0.0262
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00099128
diis-c [-6.78792223e-08 -2.05212292e-03  2.23393543e-04  1.00182873e+00]
  HOMO = -0.844239988225072  LUMO = 1.09289549665613
  mo_energy =
[-3.27677343e+01 -1.92489373e+00 -8.44239988e-01 -8.44239988e-01
 -8.44239988e-01  1.09289550e+00  1.09289550e+00  1.09289550e+00
  2.02327879e+00  5.68236719e+00  5.68236719e+00  5.68236719e+00
  1.92641942e+01  2.40148754e+01  2.40148754e+01  2.40148754e+01
  9.36205977e+01  1.16444871e+02  1.16444871e+02  1.16444871e+02
  3.55942715e+02  1.34928650e+03  5.83570701e+03  3.50983100e+04]
E1 = -182.60523756540016  E_coul = 54.07707136174696
cycle= 4 E= -128.528166203653  delta_E= -1.34e-08  |g|= 5.52e-05  |ddm|= 7.64e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000131936
diis-c [-3.58811036e-10  1.83288923e-04  4.20035536e-04 -1.39638901e-01
  1.13903558e+00]
  HOMO = -0.844265231022221  LUMO = 1.09288552293713
  mo_energy =
[-3.27677871e+01 -1.92491298e+00 -8.44265231e-01 -8.44265231e-01
 -8.44265231e-01  1.09288552e+00  1.09288552e+00  1.09288552e+00
  2.02326434e+00  5.68233731e+00  5.68233731e+00  5.68233731e+00
  1.92641548e+01  2.40148315e+01  2.40148315e+01  2.40148315e+01
  9.36205470e+01  1.16444818e+02  1.16444818e+02  1.16444818e+02
  3.55942657e+02  1.34928644e+03  5.83570694e+03  3.50983100e+04]
E1 = -182.60536030645264  E_coul = 54.07719410250902
cycle= 5 E= -128.528166203944  delta_E= -2.9e-10  |g|= 3.23e-06  |ddm|= 1.48e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60536030645264  E_coul = 54.07719410250902
  HOMO = -0.844263749311791  LUMO = 1.09288616239705
  mo_energy =
[-3.27677839e+01 -1.92491093e+00 -8.44263749e-01 -8.44263749e-01
 -8.44263749e-01  1.09288616e+00  1.09288616e+00  1.09288616e+00
  2.02326591e+00  5.68233916e+00  5.68233916e+00  5.68233916e+00
  1.92641577e+01  2.40148343e+01  2.40148343e+01  2.40148343e+01
  9.36205501e+01  1.16444821e+02  1.16444821e+02  1.16444821e+02
  3.55942659e+02  1.34928644e+03  5.83570694e+03  3.50983100e+04]
E1 = -182.60535311688582  E_coul = 54.077186912941606
Extra cycle  E= -128.528166203944  delta_E= -5.97e-13  |g|= 1.04e-06  |ddm|= 1.71e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.58499888984446
E1 = -182.60535311688582  E_coul = 54.077186912941606
init E= -128.528166203944
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.844264262878307  LUMO = 1.0928859859708
  mo_energy =
[-3.27677855e+01 -1.92491137e+00 -8.44264263e-01 -8.44264263e-01
 -8.44264263e-01  1.09288599e+00  1.09288599e+00  1.09288599e+00
  2.02326564e+00  5.68233854e+00  5.68233854e+00  5.68233854e+00
  1.92641567e+01  2.40148332e+01  2.40148332e+01  2.40148332e+01
  9.36205486e+01  1.16444819e+02  1.16444819e+02  1.16444819e+02
  3.55942658e+02  1.34928644e+03  5.83570694e+03  3.50983100e+04]
E1 = -182.60535702911977  E_coul = 54.0771908251753
cycle= 1 E= -128.528166203944  delta_E= -2.56e-13  |g|= 5.43e-07  |ddm|= 4.09e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60535702911977  E_coul = 54.0771908251753
  HOMO = -0.844263990107912  LUMO = 1.0928860867893
  mo_energy =
[-3.27677847e+01 -1.92491106e+00 -8.44263990e-01 -8.44263990e-01
 -8.44263990e-01  1.09288609e+00  1.09288609e+00  1.09288609e+00
  2.02326585e+00  5.68233888e+00  5.68233888e+00  5.68233888e+00
  1.92641573e+01  2.40148338e+01  2.40148338e+01  2.40148338e+01
  9.36205493e+01  1.16444820e+02  1.16444820e+02  1.16444820e+02
  3.55942659e+02  1.34928644e+03  5.83570694e+03  3.50983100e+04]
E1 = -182.60535511695534  E_coul = 54.07718891301078
Extra cycle  E= -128.528166203945  delta_E= -8.53e-14  |g|= 2.6e-07  |ddm|= 2.3e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498476e+02 1.74907408e+02
 2.05260284e+01 5.69524018e+01 4.90086333e-01 7.77899842e+00
 1.65886526e+00 3.67469424e+00 1.24328124e+01 5.32413740e+01
 3.31196407e-01 1.14249526e+00]
grad_E = [-1.30955277e-09  6.88780888e-08 -1.36166229e-06  1.54665360e-05
  3.76210801e-04 -1.04081203e-04  3.98750222e-03 -5.79538849e-04
 -8.71358663e-04 -1.82435032e-03  8.01238015e-04 -1.01375751e-04
  2.14860954e-03  1.11716471e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682483        1
[INPUT] 0    0    [1    /1   ]  617.49847837         1
[INPUT] 0    0    [1    /1   ]  174.907391481        1
[INPUT] 0    0    [1    /1   ]  20.5270629491        1
[INPUT] 0    0    [1    /1   ]  56.9525094572        1
[INPUT] 0    0    [1    /1   ]  0.490880660663       1
[INPUT] 0    0    [1    /1   ]  7.77860653276        1
[INPUT] 0    0    [1    /1   ]  1.66750034482        1
[INPUT] 1    0    [1    /1   ]  3.70350810022        1
[INPUT] 1    0    [1    /1   ]  12.5563689222        1
[INPUT] 1    0    [1    /1   ]  54.3515510872        1
[INPUT] 1    0    [1    /1   ]  0.331932816242       1
[INPUT] 1    0    [1    /1   ]  1.14961336704        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729953167, 1.0]], [0, [2712.0968248332915, 1.0]], [0, [617.4984783697741, 1.0]], [0, [174.90739148119712, 1.0]], [0, [20.52706294909697, 1.0]], [0, [56.952509457202154, 1.0]], [0, [0.49088066066290953, 1.0]], [0, [7.778606532760003, 1.0]], [0, [1.6675003448248493, 1.0]], [1, [3.7035081002231025, 1.0]], [1, [12.55636892220261, 1.0]], [1, [54.35155108716342, 1.0]], [1, [0.3319328162422185, 1.0]], [1, [1.1496133670437283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872995]
bas 1, expnt(s) = [2712.09682483]
bas 2, expnt(s) = [617.49847837]
bas 3, expnt(s) = [174.90739148]
bas 4, expnt(s) = [20.52706295]
bas 5, expnt(s) = [56.95250946]
bas 6, expnt(s) = [0.49088066]
bas 7, expnt(s) = [7.77860653]
bas 8, expnt(s) = [1.66750034]
bas 9, expnt(s) = [3.7035081]
bas 10, expnt(s) = [12.55636892]
bas 11, expnt(s) = [54.35155109]
bas 12, expnt(s) = [0.33193282]
bas 13, expnt(s) = [1.14961337]
CPU time:       130.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498478e+02 3.12962241e+02 1.74907391e+02 1.21512553e+02
 2.05270629e+01 2.43646476e+01 5.69525095e+01 5.23780918e+01
 4.90880661e-01 1.48165457e+00 7.77860653e+00 1.17676943e+01
 1.66750034e+00 3.70735756e+00 3.70350810e+00 1.49882530e+01
 1.25563689e+01 6.89547958e+01 5.43515511e+01 4.30525937e+02
 3.31932816e-01 7.35016572e-01 1.14961337e+00 3.47275503e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99796639056919
cond(S) = 239.02330428440138
E1 = -183.57491007596863  E_coul = 55.07981859419663
init E= -128.495091481772
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773867817744214  LUMO = 1.1225530692157
  mo_energy =
[-3.25544977e+01 -1.85131783e+00 -7.73867818e-01 -7.73867818e-01
 -7.73867818e-01  1.12255307e+00  1.12255307e+00  1.12255307e+00
  2.08356837e+00  5.80925948e+00  5.80925948e+00  5.80925948e+00
  1.94468574e+01  2.44060521e+01  2.44060521e+01  2.44060521e+01
  9.38602893e+01  1.18854902e+02  1.18854902e+02  1.18854902e+02
  3.56215177e+02  1.34958775e+03  5.83603330e+03  3.50986518e+04]
E1 = -182.1192590444077  E_coul = 53.594380522957394
cycle= 1 E= -128.52487852145  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442477
diis-c [-0.19578607  1.        ]
  HOMO = -0.878340154577396  LUMO = 1.08483305516551
  mo_energy =
[-3.28718669e+01 -1.96086123e+00 -8.78340155e-01 -8.78340155e-01
 -8.78340155e-01  1.08483306e+00  1.08483306e+00  1.08483306e+00
  2.00919569e+00  5.68101522e+00  5.68101522e+00  5.68101522e+00
  1.92306258e+01  2.41718065e+01  2.41718065e+01  2.41718065e+01
  9.35616364e+01  1.18535613e+02  1.18535613e+02  1.18535613e+02
  3.55868858e+02  1.34920318e+03  5.83561689e+03  3.50982138e+04]
E1 = -182.84612638048867  E_coul = 54.318751224952756
cycle= 2 E= -128.527375155536  delta_E= -0.0025  |g|= 0.0991  |ddm|= 0.0769
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.21933
diis-c [-5.70409174e-04  3.30413319e-01  6.69586681e-01]
  HOMO = -0.844170182496142  LUMO = 1.09732073544304
  mo_energy =
[-3.27673234e+01 -1.92484155e+00 -8.44170182e-01 -8.44170182e-01
 -8.44170182e-01  1.09732074e+00  1.09732074e+00  1.09732074e+00
  2.03352732e+00  5.72287776e+00  5.72287776e+00  5.72287776e+00
  1.93021998e+01  2.42492135e+01  2.42492135e+01  2.42492135e+01
  9.36602993e+01  1.18640089e+02  1.18640089e+02  1.18640089e+02
  3.55980105e+02  1.34932059e+03  5.83573722e+03  3.50983352e+04]
E1 = -182.60358546938608  E_coul = 54.0753786034128
cycle= 3 E= -128.528206865973  delta_E= -0.000832  |g|= 0.000436  |ddm|= 0.0262
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010094
diis-c [-7.15208119e-08 -2.07296792e-03  2.67089075e-04  1.00180588e+00]
  HOMO = -0.844377675983584  LUMO = 1.09728490086225
  mo_energy =
[-3.27677494e+01 -1.92499955e+00 -8.44377676e-01 -8.44377676e-01
 -8.44377676e-01  1.09728490e+00  1.09728490e+00  1.09728490e+00
  2.03344791e+00  5.72269191e+00  5.72269191e+00  5.72269191e+00
  1.93019236e+01  2.42488959e+01  2.42488959e+01  2.42488959e+01
  9.36599020e+01  1.18639651e+02  1.18639651e+02  1.18639651e+02
  3.55979595e+02  1.34931995e+03  5.83573648e+03  3.50983344e+04]
E1 = -182.60424379419055  E_coul = 54.07603691405024
cycle= 4 E= -128.52820688014  delta_E= -1.42e-08  |g|= 5.68e-05  |ddm|= 8.11e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135489
diis-c [-3.84999514e-10  1.98016875e-04  4.29268860e-04 -1.46277933e-01
  1.14565065e+00]
  HOMO = -0.844403503045215  LUMO = 1.09727467588564
  mo_energy =
[-3.27678033e+01 -1.92501878e+00 -8.44403503e-01 -8.44403503e-01
 -8.44403503e-01  1.09727468e+00  1.09727468e+00  1.09727468e+00
  2.03343346e+00  5.72266126e+00  5.72266126e+00  5.72266126e+00
  1.93018835e+01  2.42488510e+01  2.42488510e+01  2.42488510e+01
  9.36598502e+01  1.18639597e+02  1.18639597e+02  1.18639597e+02
  3.55979535e+02  1.34931988e+03  5.83573640e+03  3.50983343e+04]
E1 = -182.60436981278832  E_coul = 54.07616293233446
cycle= 5 E= -128.528206880454  delta_E= -3.14e-10  |g|= 3.45e-06  |ddm|= 1.6e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60436981278832  E_coul = 54.07616293233446
  HOMO = -0.84440186899912  LUMO = 1.09727538353141
  mo_energy =
[-3.27677998e+01 -1.92501656e+00 -8.44401869e-01 -8.44401869e-01
 -8.44401869e-01  1.09727538e+00  1.09727538e+00  1.09727538e+00
  2.03343516e+00  5.72266330e+00  5.72266330e+00  5.72266330e+00
  1.93018866e+01  2.42488541e+01  2.42488541e+01  2.42488541e+01
  9.36598536e+01  1.18639600e+02  1.18639600e+02  1.18639600e+02
  3.55979538e+02  1.34931988e+03  5.83573640e+03  3.50983344e+04]
E1 = -182.60436196756075  E_coul = 54.076155087105896
Extra cycle  E= -128.528206880455  delta_E= -9.95e-13  |g|= 1.13e-06  |ddm|= 1.78e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498478e+02 1.74907391e+02
 2.05270629e+01 5.69525095e+01 4.90880661e-01 7.77860653e+00
 1.66750034e+00 3.70350810e+00 1.25563689e+01 5.43515511e+01
 3.31932816e-01 1.14961337e+00]
E = -128.52820688045486
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682483        1
[INPUT] 0    0    [1    /1   ]  617.49847837         1
[INPUT] 0    0    [1    /1   ]  174.907391481        1
[INPUT] 0    0    [1    /1   ]  20.5270629491        1
[INPUT] 0    0    [1    /1   ]  56.9525094572        1
[INPUT] 0    0    [1    /1   ]  0.490880660663       1
[INPUT] 0    0    [1    /1   ]  7.77860653276        1
[INPUT] 0    0    [1    /1   ]  1.66750034482        1
[INPUT] 1    0    [1    /1   ]  3.70350810022        1
[INPUT] 1    0    [1    /1   ]  12.5563689222        1
[INPUT] 1    0    [1    /1   ]  54.3515510872        1
[INPUT] 1    0    [1    /1   ]  0.331932816242       1
[INPUT] 1    0    [1    /1   ]  1.14961336704        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729953167, 1.0]], [0, [2712.0968248332915, 1.0]], [0, [617.4984783697741, 1.0]], [0, [174.90739148119712, 1.0]], [0, [20.52706294909697, 1.0]], [0, [56.952509457202154, 1.0]], [0, [0.49088066066290953, 1.0]], [0, [7.778606532760003, 1.0]], [0, [1.6675003448248493, 1.0]], [1, [3.7035081002231025, 1.0]], [1, [12.55636892220261, 1.0]], [1, [54.35155108716342, 1.0]], [1, [0.3319328162422185, 1.0]], [1, [1.1496133670437283, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872995]
bas 1, expnt(s) = [2712.09682483]
bas 2, expnt(s) = [617.49847837]
bas 3, expnt(s) = [174.90739148]
bas 4, expnt(s) = [20.52706295]
bas 5, expnt(s) = [56.95250946]
bas 6, expnt(s) = [0.49088066]
bas 7, expnt(s) = [7.77860653]
bas 8, expnt(s) = [1.66750034]
bas 9, expnt(s) = [3.7035081]
bas 10, expnt(s) = [12.55636892]
bas 11, expnt(s) = [54.35155109]
bas 12, expnt(s) = [0.33193282]
bas 13, expnt(s) = [1.14961337]
CPU time:       130.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498478e+02 3.12962241e+02 1.74907391e+02 1.21512553e+02
 2.05270629e+01 2.43646476e+01 5.69525095e+01 5.23780918e+01
 4.90880661e-01 1.48165457e+00 7.77860653e+00 1.17676943e+01
 1.66750034e+00 3.70735756e+00 3.70350810e+00 1.49882530e+01
 1.25563689e+01 6.89547958e+01 5.43515511e+01 4.30525937e+02
 3.31932816e-01 7.35016572e-01 1.14961337e+00 3.47275503e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99796639056919
cond(S) = 239.02330428440138
E1 = -183.57491007596863  E_coul = 55.07981859419663
init E= -128.495091481772
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773867817744214  LUMO = 1.1225530692157
  mo_energy =
[-3.25544977e+01 -1.85131783e+00 -7.73867818e-01 -7.73867818e-01
 -7.73867818e-01  1.12255307e+00  1.12255307e+00  1.12255307e+00
  2.08356837e+00  5.80925948e+00  5.80925948e+00  5.80925948e+00
  1.94468574e+01  2.44060521e+01  2.44060521e+01  2.44060521e+01
  9.38602893e+01  1.18854902e+02  1.18854902e+02  1.18854902e+02
  3.56215177e+02  1.34958775e+03  5.83603330e+03  3.50986518e+04]
E1 = -182.1192590444077  E_coul = 53.594380522957394
cycle= 1 E= -128.52487852145  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442477
diis-c [-0.19578607  1.        ]
  HOMO = -0.878340154577396  LUMO = 1.08483305516551
  mo_energy =
[-3.28718669e+01 -1.96086123e+00 -8.78340155e-01 -8.78340155e-01
 -8.78340155e-01  1.08483306e+00  1.08483306e+00  1.08483306e+00
  2.00919569e+00  5.68101522e+00  5.68101522e+00  5.68101522e+00
  1.92306258e+01  2.41718065e+01  2.41718065e+01  2.41718065e+01
  9.35616364e+01  1.18535613e+02  1.18535613e+02  1.18535613e+02
  3.55868858e+02  1.34920318e+03  5.83561689e+03  3.50982138e+04]
E1 = -182.84612638048867  E_coul = 54.318751224952756
cycle= 2 E= -128.527375155536  delta_E= -0.0025  |g|= 0.0991  |ddm|= 0.0769
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.21933
diis-c [-5.70409174e-04  3.30413319e-01  6.69586681e-01]
  HOMO = -0.844170182496142  LUMO = 1.09732073544304
  mo_energy =
[-3.27673234e+01 -1.92484155e+00 -8.44170182e-01 -8.44170182e-01
 -8.44170182e-01  1.09732074e+00  1.09732074e+00  1.09732074e+00
  2.03352732e+00  5.72287776e+00  5.72287776e+00  5.72287776e+00
  1.93021998e+01  2.42492135e+01  2.42492135e+01  2.42492135e+01
  9.36602993e+01  1.18640089e+02  1.18640089e+02  1.18640089e+02
  3.55980105e+02  1.34932059e+03  5.83573722e+03  3.50983352e+04]
E1 = -182.60358546938608  E_coul = 54.0753786034128
cycle= 3 E= -128.528206865973  delta_E= -0.000832  |g|= 0.000436  |ddm|= 0.0262
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010094
diis-c [-7.15208119e-08 -2.07296792e-03  2.67089075e-04  1.00180588e+00]
  HOMO = -0.844377675983584  LUMO = 1.09728490086225
  mo_energy =
[-3.27677494e+01 -1.92499955e+00 -8.44377676e-01 -8.44377676e-01
 -8.44377676e-01  1.09728490e+00  1.09728490e+00  1.09728490e+00
  2.03344791e+00  5.72269191e+00  5.72269191e+00  5.72269191e+00
  1.93019236e+01  2.42488959e+01  2.42488959e+01  2.42488959e+01
  9.36599020e+01  1.18639651e+02  1.18639651e+02  1.18639651e+02
  3.55979595e+02  1.34931995e+03  5.83573648e+03  3.50983344e+04]
E1 = -182.60424379419055  E_coul = 54.07603691405024
cycle= 4 E= -128.52820688014  delta_E= -1.42e-08  |g|= 5.68e-05  |ddm|= 8.11e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000135489
diis-c [-3.84999514e-10  1.98016875e-04  4.29268860e-04 -1.46277933e-01
  1.14565065e+00]
  HOMO = -0.844403503045215  LUMO = 1.09727467588564
  mo_energy =
[-3.27678033e+01 -1.92501878e+00 -8.44403503e-01 -8.44403503e-01
 -8.44403503e-01  1.09727468e+00  1.09727468e+00  1.09727468e+00
  2.03343346e+00  5.72266126e+00  5.72266126e+00  5.72266126e+00
  1.93018835e+01  2.42488510e+01  2.42488510e+01  2.42488510e+01
  9.36598502e+01  1.18639597e+02  1.18639597e+02  1.18639597e+02
  3.55979535e+02  1.34931988e+03  5.83573640e+03  3.50983343e+04]
E1 = -182.60436981278832  E_coul = 54.07616293233446
cycle= 5 E= -128.528206880454  delta_E= -3.14e-10  |g|= 3.45e-06  |ddm|= 1.6e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60436981278832  E_coul = 54.07616293233446
  HOMO = -0.84440186899912  LUMO = 1.09727538353141
  mo_energy =
[-3.27677998e+01 -1.92501656e+00 -8.44401869e-01 -8.44401869e-01
 -8.44401869e-01  1.09727538e+00  1.09727538e+00  1.09727538e+00
  2.03343516e+00  5.72266330e+00  5.72266330e+00  5.72266330e+00
  1.93018866e+01  2.42488541e+01  2.42488541e+01  2.42488541e+01
  9.36598536e+01  1.18639600e+02  1.18639600e+02  1.18639600e+02
  3.55979538e+02  1.34931988e+03  5.83573640e+03  3.50983344e+04]
E1 = -182.60436196756075  E_coul = 54.076155087105896
Extra cycle  E= -128.528206880455  delta_E= -9.95e-13  |g|= 1.13e-06  |ddm|= 1.78e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.02330428440138
E1 = -182.60436196756075  E_coul = 54.076155087105896
init E= -128.528206880455
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.844402427559572  LUMO = 1.09727519014211
  mo_energy =
[-3.27678016e+01 -1.92501704e+00 -8.44402428e-01 -8.44402428e-01
 -8.44402428e-01  1.09727519e+00  1.09727519e+00  1.09727519e+00
  2.03343486e+00  5.72266262e+00  5.72266262e+00  5.72266262e+00
  1.93018855e+01  2.42488528e+01  2.42488528e+01  2.42488528e+01
  9.36598520e+01  1.18639599e+02  1.18639599e+02  1.18639599e+02
  3.55979536e+02  1.34931988e+03  5.83573640e+03  3.50983344e+04]
E1 = -182.60436623296292  E_coul = 54.07615935250823
cycle= 1 E= -128.528206880455  delta_E= 1.71e-13  |g|= 5.91e-07  |ddm|= 4.44e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60436623296292  E_coul = 54.07615935250823
  HOMO = -0.844402129896955  LUMO = 1.09727530076132
  mo_energy =
[-3.27678007e+01 -1.92501671e+00 -8.44402130e-01 -8.44402130e-01
 -8.44402130e-01  1.09727530e+00  1.09727530e+00  1.09727530e+00
  2.03343509e+00  5.72266299e+00  5.72266299e+00  5.72266299e+00
  1.93018861e+01  2.42488535e+01  2.42488535e+01  2.42488535e+01
  9.36598528e+01  1.18639600e+02  1.18639600e+02  1.18639600e+02
  3.55979537e+02  1.34931988e+03  5.83573640e+03  3.50983344e+04]
E1 = -182.60436414578564  E_coul = 54.07615726533067
Extra cycle  E= -128.528206880455  delta_E= -2.84e-13  |g|= 2.83e-07  |ddm|= 2.49e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498478e+02 1.74907391e+02
 2.05270629e+01 5.69525095e+01 4.90880661e-01 7.77860653e+00
 1.66750034e+00 3.70350810e+00 1.25563689e+01 5.43515511e+01
 3.31932816e-01 1.14961337e+00]
grad_E = [-1.30414307e-09  6.84853202e-08 -1.35654168e-06  1.53337157e-05
  3.60304483e-04 -1.03158669e-04  9.41534491e-04 -5.54082080e-04
  4.58140877e-04 -1.54294843e-03  6.12326949e-04 -6.47857615e-05
 -1.67699752e-03  2.12144683e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682465        1
[INPUT] 0    0    [1    /1   ]  617.498482359        1
[INPUT] 0    0    [1    /1   ]  174.90735756         1
[INPUT] 0    0    [1    /1   ]  20.5275691519        1
[INPUT] 0    0    [1    /1   ]  56.9527323572        1
[INPUT] 0    0    [1    /1   ]  0.488836644048       1
[INPUT] 0    0    [1    /1   ]  7.77865169091        1
[INPUT] 0    0    [1    /1   ]  1.66182635867        1
[INPUT] 1    0    [1    /1   ]  3.72011126503        1
[INPUT] 1    0    [1    /1   ]  12.6212750056        1
[INPUT] 1    0    [1    /1   ]  55.2110687948        1
[INPUT] 1    0    [1    /1   ]  0.333170009772       1
[INPUT] 1    0    [1    /1   ]  1.15337089677        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.4787299548, 1.0]], [0, [2712.0968246506854, 1.0]], [0, [617.49848235879, 1.0]], [0, [174.9073575604168, 1.0]], [0, [20.527569151899712, 1.0]], [0, [56.95273235724871, 1.0]], [0, [0.48883664404809474, 1.0]], [0, [7.778651690913251, 1.0]], [0, [1.6618263586650959, 1.0]], [1, [3.720111265033729, 1.0]], [1, [12.62127500556089, 1.0]], [1, [55.21106879475179, 1.0]], [1, [0.33317000977172023, 1.0]], [1, [1.1533708967712337, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872995]
bas 1, expnt(s) = [2712.09682465]
bas 2, expnt(s) = [617.49848236]
bas 3, expnt(s) = [174.90735756]
bas 4, expnt(s) = [20.52756915]
bas 5, expnt(s) = [56.95273236]
bas 6, expnt(s) = [0.48883664]
bas 7, expnt(s) = [7.77865169]
bas 8, expnt(s) = [1.66182636]
bas 9, expnt(s) = [3.72011127]
bas 10, expnt(s) = [12.62127501]
bas 11, expnt(s) = [55.21106879]
bas 12, expnt(s) = [0.33317001]
bas 13, expnt(s) = [1.1533709]
CPU time:       133.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907358e+02 1.21512536e+02
 2.05275692e+01 2.43650983e+01 5.69527324e+01 5.23782456e+01
 4.88836644e-01 1.47702498e+00 7.77865169e+00 1.17677455e+01
 1.66182636e+00 3.69789229e+00 3.72011127e+00 1.50722922e+01
 1.26212750e+01 6.94006327e+01 5.52110688e+01 4.39053138e+02
 3.33170010e-01 7.38442645e-01 1.15337090e+00 3.48694926e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997946990549007
cond(S) = 238.63240592556807
E1 = -183.5749081673576  E_coul = 55.07979275432643
init E= -128.495115413031
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773872548189296  LUMO = 1.12745640464254
  mo_energy =
[-3.25545001e+01 -1.85132541e+00 -7.73872548e-01 -7.73872548e-01
 -7.73872548e-01  1.12745640e+00  1.12745640e+00  1.12745640e+00
  2.07149137e+00  5.83534507e+00  5.83534507e+00  5.83534507e+00
  1.94151076e+01  2.45351646e+01  2.45351646e+01  2.45351646e+01
  9.38305070e+01  1.20443142e+02  1.20443142e+02  1.20443142e+02
  3.56189878e+02  1.34956583e+03  5.83601424e+03  3.50986361e+04]
E1 = -182.12116907780603  E_coul = 53.596259528708764
cycle= 1 E= -128.524909549097  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.44171
diis-c [-0.19510745  1.        ]
  HOMO = -0.87820242930316  LUMO = 1.08964163418698
  mo_energy =
[-3.28715700e+01 -1.96064262e+00 -8.78202429e-01 -8.78202429e-01
 -8.78202429e-01  1.08964163e+00  1.08964163e+00  1.08964163e+00
  1.99760532e+00  5.70689473e+00  5.70689473e+00  5.70689473e+00
  1.91991183e+01  2.43007449e+01  2.43007449e+01  2.43007449e+01
  9.35321226e+01  1.20123508e+02  1.20123508e+02  1.20123508e+02
  3.55843821e+02  1.34918147e+03  5.83559803e+03  3.50981983e+04]
E1 = -182.84717179221482  E_coul = 54.31976870488748
cycle= 2 E= -128.527403087327  delta_E= -0.00249  |g|= 0.099  |ddm|= 0.0769
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.218784
diis-c [-5.67818234e-04  3.30244910e-01  6.69755090e-01]
  HOMO = -0.844065210840423  LUMO = 1.10217521108596
  mo_energy =
[-3.27671196e+01 -1.92466020e+00 -8.44065211e-01 -8.44065211e-01
 -8.44065211e-01  1.10217521e+00  1.10217521e+00  1.10217521e+00
  2.02181907e+00  5.74884709e+00  5.74884709e+00  5.74884709e+00
  1.92706208e+01  2.43782249e+01  2.43782249e+01  2.43782249e+01
  9.36307016e+01  1.20228073e+02  1.20228073e+02  1.20228073e+02
  3.55954970e+02  1.34929878e+03  5.83571825e+03  3.50983196e+04]
E1 = -182.6050694462247  E_coul = 54.076837126801884
cycle= 3 E= -128.528232319423  delta_E= -0.000829  |g|= 0.000438  |ddm|= 0.0262
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102368
diis-c [-8.02016825e-08 -2.06661791e-03  3.35886018e-04  1.00173073e+00]
  HOMO = -0.844269183847171  LUMO = 1.10214142240373
  mo_energy =
[-3.27675424e+01 -1.92480916e+00 -8.44269184e-01 -8.44269184e-01
 -8.44269184e-01  1.10214142e+00  1.10214142e+00  1.10214142e+00
  2.02174784e+00  5.74866535e+00  5.74866535e+00  5.74866535e+00
  1.92703505e+01  2.43779115e+01  2.43779115e+01  2.43779115e+01
  9.36303077e+01  1.20227637e+02  1.20227637e+02  1.20227637e+02
  3.55954461e+02  1.34929814e+03  5.83571750e+03  3.50983188e+04]
E1 = -182.60573499997682  E_coul = 54.077502665664575
cycle= 4 E= -128.528232334312  delta_E= -1.49e-08  |g|= 5.93e-05  |ddm|= 8.88e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000141697
diis-c [-4.35293839e-10  2.20201019e-04  4.46018790e-04 -1.58596640e-01
  1.15793042e+00]
  HOMO = -0.844295337303294  LUMO = 1.1021311740289
  mo_energy =
[-3.27675978e+01 -1.92482736e+00 -8.44295337e-01 -8.44295337e-01
 -8.44295337e-01  1.10213117e+00  1.10213117e+00  1.10213117e+00
  2.02173440e+00  5.74863437e+00  5.74863437e+00  5.74863437e+00
  1.92703101e+01  2.43778658e+01  2.43778658e+01  2.43778658e+01
  9.36302546e+01  1.20227581e+02  1.20227581e+02  1.20227581e+02
  3.55954399e+02  1.34929807e+03  5.83571743e+03  3.50983187e+04]
E1 = -182.60586637677122  E_coul = 54.077634042098936
cycle= 5 E= -128.528232334672  delta_E= -3.6e-10  |g|= 3.8e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60586637677122  E_coul = 54.077634042098936
  HOMO = -0.844293479176691  LUMO = 1.10213197753817
  mo_energy =
[-3.27675938e+01 -1.92482488e+00 -8.44293479e-01 -8.44293479e-01
 -8.44293479e-01  1.10213198e+00  1.10213198e+00  1.10213198e+00
  2.02173630e+00  5.74863669e+00  5.74863669e+00  5.74863669e+00
  1.92703137e+01  2.43778693e+01  2.43778693e+01  2.43778693e+01
  9.36302585e+01  1.20227585e+02  1.20227585e+02  1.20227585e+02
  3.55954402e+02  1.34929807e+03  5.83571743e+03  3.50983187e+04]
E1 = -182.60585740876476  E_coul = 54.07762507409141
Extra cycle  E= -128.528232334673  delta_E= -1.08e-12  |g|= 1.28e-06  |ddm|= 1.93e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907358e+02
 2.05275692e+01 5.69527324e+01 4.88836644e-01 7.77865169e+00
 1.66182636e+00 3.72011127e+00 1.26212750e+01 5.52110688e+01
 3.33170010e-01 1.15337090e+00]
E = -128.52823233467336
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682465        1
[INPUT] 0    0    [1    /1   ]  617.498482359        1
[INPUT] 0    0    [1    /1   ]  174.90735756         1
[INPUT] 0    0    [1    /1   ]  20.5275691519        1
[INPUT] 0    0    [1    /1   ]  56.9527323572        1
[INPUT] 0    0    [1    /1   ]  0.488836644048       1
[INPUT] 0    0    [1    /1   ]  7.77865169091        1
[INPUT] 0    0    [1    /1   ]  1.66182635867        1
[INPUT] 1    0    [1    /1   ]  3.72011126503        1
[INPUT] 1    0    [1    /1   ]  12.6212750056        1
[INPUT] 1    0    [1    /1   ]  55.2110687948        1
[INPUT] 1    0    [1    /1   ]  0.333170009772       1
[INPUT] 1    0    [1    /1   ]  1.15337089677        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.4787299548, 1.0]], [0, [2712.0968246506854, 1.0]], [0, [617.49848235879, 1.0]], [0, [174.9073575604168, 1.0]], [0, [20.527569151899712, 1.0]], [0, [56.95273235724871, 1.0]], [0, [0.48883664404809474, 1.0]], [0, [7.778651690913251, 1.0]], [0, [1.6618263586650959, 1.0]], [1, [3.720111265033729, 1.0]], [1, [12.62127500556089, 1.0]], [1, [55.21106879475179, 1.0]], [1, [0.33317000977172023, 1.0]], [1, [1.1533708967712337, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872995]
bas 1, expnt(s) = [2712.09682465]
bas 2, expnt(s) = [617.49848236]
bas 3, expnt(s) = [174.90735756]
bas 4, expnt(s) = [20.52756915]
bas 5, expnt(s) = [56.95273236]
bas 6, expnt(s) = [0.48883664]
bas 7, expnt(s) = [7.77865169]
bas 8, expnt(s) = [1.66182636]
bas 9, expnt(s) = [3.72011127]
bas 10, expnt(s) = [12.62127501]
bas 11, expnt(s) = [55.21106879]
bas 12, expnt(s) = [0.33317001]
bas 13, expnt(s) = [1.1533709]
CPU time:       134.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498482e+02 3.12962243e+02 1.74907358e+02 1.21512536e+02
 2.05275692e+01 2.43650983e+01 5.69527324e+01 5.23782456e+01
 4.88836644e-01 1.47702498e+00 7.77865169e+00 1.17677455e+01
 1.66182636e+00 3.69789229e+00 3.72011127e+00 1.50722922e+01
 1.26212750e+01 6.94006327e+01 5.52110688e+01 4.39053138e+02
 3.33170010e-01 7.38442645e-01 1.15337090e+00 3.48694926e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997946990549007
cond(S) = 238.63240592556807
E1 = -183.5749081673576  E_coul = 55.07979275432643
init E= -128.495115413031
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773872548189296  LUMO = 1.12745640464254
  mo_energy =
[-3.25545001e+01 -1.85132541e+00 -7.73872548e-01 -7.73872548e-01
 -7.73872548e-01  1.12745640e+00  1.12745640e+00  1.12745640e+00
  2.07149137e+00  5.83534507e+00  5.83534507e+00  5.83534507e+00
  1.94151076e+01  2.45351646e+01  2.45351646e+01  2.45351646e+01
  9.38305070e+01  1.20443142e+02  1.20443142e+02  1.20443142e+02
  3.56189878e+02  1.34956583e+03  5.83601424e+03  3.50986361e+04]
E1 = -182.12116907780603  E_coul = 53.596259528708764
cycle= 1 E= -128.524909549097  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.44171
diis-c [-0.19510745  1.        ]
  HOMO = -0.87820242930316  LUMO = 1.08964163418698
  mo_energy =
[-3.28715700e+01 -1.96064262e+00 -8.78202429e-01 -8.78202429e-01
 -8.78202429e-01  1.08964163e+00  1.08964163e+00  1.08964163e+00
  1.99760532e+00  5.70689473e+00  5.70689473e+00  5.70689473e+00
  1.91991183e+01  2.43007449e+01  2.43007449e+01  2.43007449e+01
  9.35321226e+01  1.20123508e+02  1.20123508e+02  1.20123508e+02
  3.55843821e+02  1.34918147e+03  5.83559803e+03  3.50981983e+04]
E1 = -182.84717179221482  E_coul = 54.31976870488748
cycle= 2 E= -128.527403087327  delta_E= -0.00249  |g|= 0.099  |ddm|= 0.0769
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.218784
diis-c [-5.67818234e-04  3.30244910e-01  6.69755090e-01]
  HOMO = -0.844065210840423  LUMO = 1.10217521108596
  mo_energy =
[-3.27671196e+01 -1.92466020e+00 -8.44065211e-01 -8.44065211e-01
 -8.44065211e-01  1.10217521e+00  1.10217521e+00  1.10217521e+00
  2.02181907e+00  5.74884709e+00  5.74884709e+00  5.74884709e+00
  1.92706208e+01  2.43782249e+01  2.43782249e+01  2.43782249e+01
  9.36307016e+01  1.20228073e+02  1.20228073e+02  1.20228073e+02
  3.55954970e+02  1.34929878e+03  5.83571825e+03  3.50983196e+04]
E1 = -182.6050694462247  E_coul = 54.076837126801884
cycle= 3 E= -128.528232319423  delta_E= -0.000829  |g|= 0.000438  |ddm|= 0.0262
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102368
diis-c [-8.02016825e-08 -2.06661791e-03  3.35886018e-04  1.00173073e+00]
  HOMO = -0.844269183847171  LUMO = 1.10214142240373
  mo_energy =
[-3.27675424e+01 -1.92480916e+00 -8.44269184e-01 -8.44269184e-01
 -8.44269184e-01  1.10214142e+00  1.10214142e+00  1.10214142e+00
  2.02174784e+00  5.74866535e+00  5.74866535e+00  5.74866535e+00
  1.92703505e+01  2.43779115e+01  2.43779115e+01  2.43779115e+01
  9.36303077e+01  1.20227637e+02  1.20227637e+02  1.20227637e+02
  3.55954461e+02  1.34929814e+03  5.83571750e+03  3.50983188e+04]
E1 = -182.60573499997682  E_coul = 54.077502665664575
cycle= 4 E= -128.528232334312  delta_E= -1.49e-08  |g|= 5.93e-05  |ddm|= 8.88e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000141697
diis-c [-4.35293839e-10  2.20201019e-04  4.46018790e-04 -1.58596640e-01
  1.15793042e+00]
  HOMO = -0.844295337303294  LUMO = 1.1021311740289
  mo_energy =
[-3.27675978e+01 -1.92482736e+00 -8.44295337e-01 -8.44295337e-01
 -8.44295337e-01  1.10213117e+00  1.10213117e+00  1.10213117e+00
  2.02173440e+00  5.74863437e+00  5.74863437e+00  5.74863437e+00
  1.92703101e+01  2.43778658e+01  2.43778658e+01  2.43778658e+01
  9.36302546e+01  1.20227581e+02  1.20227581e+02  1.20227581e+02
  3.55954399e+02  1.34929807e+03  5.83571743e+03  3.50983187e+04]
E1 = -182.60586637677122  E_coul = 54.077634042098936
cycle= 5 E= -128.528232334672  delta_E= -3.6e-10  |g|= 3.8e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60586637677122  E_coul = 54.077634042098936
  HOMO = -0.844293479176691  LUMO = 1.10213197753817
  mo_energy =
[-3.27675938e+01 -1.92482488e+00 -8.44293479e-01 -8.44293479e-01
 -8.44293479e-01  1.10213198e+00  1.10213198e+00  1.10213198e+00
  2.02173630e+00  5.74863669e+00  5.74863669e+00  5.74863669e+00
  1.92703137e+01  2.43778693e+01  2.43778693e+01  2.43778693e+01
  9.36302585e+01  1.20227585e+02  1.20227585e+02  1.20227585e+02
  3.55954402e+02  1.34929807e+03  5.83571743e+03  3.50983187e+04]
E1 = -182.60585740876476  E_coul = 54.07762507409141
Extra cycle  E= -128.528232334673  delta_E= -1.08e-12  |g|= 1.28e-06  |ddm|= 1.93e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.63240592556807
E1 = -182.60585740876476  E_coul = 54.07762507409141
init E= -128.528232334673
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.844294116095737  LUMO = 1.10213175529884
  mo_energy =
[-3.27675958e+01 -1.92482545e+00 -8.44294116e-01 -8.44294116e-01
 -8.44294116e-01  1.10213176e+00  1.10213176e+00  1.10213176e+00
  2.02173594e+00  5.74863591e+00  5.74863591e+00  5.74863591e+00
  1.92703124e+01  2.43778679e+01  2.43778679e+01  2.43778679e+01
  9.36302567e+01  1.20227583e+02  1.20227583e+02  1.20227583e+02
  3.55954400e+02  1.34929807e+03  5.83571743e+03  3.50983187e+04]
E1 = -182.6058622609372  E_coul = 54.07762992626384
cycle= 1 E= -128.528232334673  delta_E=    0  |g|= 6.7e-07  |ddm|= 5.01e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6058622609372  E_coul = 54.07762992626384
  HOMO = -0.84429377721959  LUMO = 1.10213188165145
  mo_energy =
[-3.27675948e+01 -1.92482507e+00 -8.44293777e-01 -8.44293777e-01
 -8.44293777e-01  1.10213188e+00  1.10213188e+00  1.10213188e+00
  2.02173620e+00  5.74863633e+00  5.74863633e+00  5.74863633e+00
  1.92703131e+01  2.43778686e+01  2.43778686e+01  2.43778686e+01
  9.36302576e+01  1.20227584e+02  1.20227584e+02  1.20227584e+02
  3.55954401e+02  1.34929807e+03  5.83571743e+03  3.50983187e+04]
E1 = -182.6058598844172  E_coul = 54.07762754974369
Extra cycle  E= -128.528232334674  delta_E= -1.71e-13  |g|= 3.23e-07  |ddm|= 2.81e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498482e+02 1.74907358e+02
 2.05275692e+01 5.69527324e+01 4.88836644e-01 7.77865169e+00
 1.66182636e+00 3.72011127e+00 1.26212750e+01 5.52110688e+01
 3.33170010e-01 1.15337090e+00]
grad_E = [-1.31225208e-09  6.89515141e-08 -1.36486681e-06  1.54554350e-05
  3.66194756e-04 -1.03898661e-04 -3.07090456e-04 -5.57510158e-04
  4.29642683e-04 -5.22449902e-04  3.21273170e-04 -2.75228535e-05
  2.69823450e-03 -3.63912085e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682445        1
[INPUT] 0    0    [1    /1   ]  617.49848638         1
[INPUT] 0    0    [1    /1   ]  174.907313835        1
[INPUT] 0    0    [1    /1   ]  20.5267705462        1
[INPUT] 0    0    [1    /1   ]  56.9530245064        1
[INPUT] 0    0    [1    /1   ]  0.487380686966       1
[INPUT] 0    0    [1    /1   ]  7.77992238849        1
[INPUT] 0    0    [1    /1   ]  1.65702026827        1
[INPUT] 1    0    [1    /1   ]  3.71011537753        1
[INPUT] 1    0    [1    /1   ]  12.5703000439        1
[INPUT] 1    0    [1    /1   ]  55.3280426196        1
[INPUT] 1    0    [1    /1   ]  0.331959550161       1
[INPUT] 1    0    [1    /1   ]  1.15114311477        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729958395, 1.0]], [0, [2712.0968244504597, 1.0]], [0, [617.4984863796502, 1.0]], [0, [174.90731383457947, 1.0]], [0, [20.526770546184675, 1.0]], [0, [56.953024506449296, 1.0]], [0, [0.4873806869655584, 1.0]], [0, [7.779922388489775, 1.0]], [0, [1.6570202682742252, 1.0]], [1, [3.7101153775321793, 1.0]], [1, [12.570300043934667, 1.0]], [1, [55.32804261955145, 1.0]], [1, [0.33195955016145934, 1.0]], [1, [1.1511431147653008, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872996]
bas 1, expnt(s) = [2712.09682445]
bas 2, expnt(s) = [617.49848638]
bas 3, expnt(s) = [174.90731383]
bas 4, expnt(s) = [20.52677055]
bas 5, expnt(s) = [56.95302451]
bas 6, expnt(s) = [0.48738069]
bas 7, expnt(s) = [7.77992239]
bas 8, expnt(s) = [1.65702027]
bas 9, expnt(s) = [3.71011538]
bas 10, expnt(s) = [12.57030004]
bas 11, expnt(s) = [55.32804262]
bas 12, expnt(s) = [0.33195955]
bas 13, expnt(s) = [1.15114311]
CPU time:       137.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498486e+02 3.12962244e+02 1.74907314e+02 1.21512513e+02
 2.05267705e+01 2.43643873e+01 5.69530245e+01 5.23784471e+01
 4.87380687e-01 1.47372436e+00 7.77992239e+00 1.17691873e+01
 1.65702027e+00 3.68986851e+00 3.71011538e+00 1.50216854e+01
 1.25703000e+01 6.90504396e+01 5.53280426e+01 4.40216205e+02
 3.31959550e-01 7.35090570e-01 1.15114311e+00 3.47853232e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997978031224523
cond(S) = 238.35583040965616
E1 = -183.57478942157724  E_coul = 55.07972459012783
init E= -128.495064831449
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773881423088058  LUMO = 1.1230346176723
  mo_energy =
[-3.25545163e+01 -1.85133252e+00 -7.73881423e-01 -7.73881423e-01
 -7.73881423e-01  1.12303462e+00  1.12303462e+00  1.12303462e+00
  2.06224619e+00  5.81906985e+00  5.81906985e+00  5.81906985e+00
  1.93909359e+01  2.44407028e+01  2.44407028e+01  2.44407028e+01
  9.38080907e+01  1.20425932e+02  1.20425932e+02  1.20425932e+02
  3.56169987e+02  1.34954826e+03  5.83599889e+03  3.50986234e+04]
E1 = -182.11708888880935  E_coul = 53.59218194005935
cycle= 1 E= -128.52490694875  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442498
diis-c [-0.19580408  1.        ]
  HOMO = -0.878539154235268  LUMO = 1.08520989640323
  mo_energy =
[-3.28722619e+01 -1.96098978e+00 -8.78539154e-01 -8.78539154e-01
 -8.78539154e-01  1.08520990e+00  1.08520990e+00  1.08520990e+00
  1.98831227e+00  5.69042862e+00  5.69042862e+00  5.69042862e+00
  1.91744236e+01  2.42060220e+01  2.42060220e+01  2.42060220e+01
  9.35090466e+01  1.20105537e+02  1.20105537e+02  1.20105537e+02
  3.55823210e+02  1.34916314e+03  5.83558190e+03  3.50981848e+04]
E1 = -182.8451492553747  E_coul = 54.3177390509616
cycle= 2 E= -128.527410204413  delta_E= -0.0025  |g|= 0.0992  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219347
diis-c [-5.67281616e-04  3.30425572e-01  6.69574428e-01]
  HOMO = -0.844310880757855  LUMO = 1.09773324003586
  mo_energy =
[-3.27675577e+01 -1.92491139e+00 -8.44310881e-01 -8.44310881e-01
 -8.44310881e-01  1.09773324e+00  1.09773324e+00  1.09773324e+00
  2.01251809e+00  5.73242344e+00  5.73242344e+00  5.73242344e+00
  1.92461049e+01  2.42835978e+01  2.42835978e+01  2.42835978e+01
  9.36078700e+01  1.20210379e+02  1.20210379e+02  1.20210379e+02
  3.55934626e+02  1.34928073e+03  5.83570241e+03  3.50983064e+04]
E1 = -182.60219370529998  E_coul = 54.07394918597923
cycle= 3 E= -128.528244519321  delta_E= -0.000834  |g|= 0.000443  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103103
diis-c [-8.15862042e-08 -2.07255662e-03  3.47436736e-04  1.00172512e+00]
  HOMO = -0.844518774393509  LUMO = 1.09769790181349
  mo_energy =
[-3.27679842e+01 -1.92506447e+00 -8.44518774e-01 -8.44518774e-01
 -8.44518774e-01  1.09769790e+00  1.09769790e+00  1.09769790e+00
  2.01244357e+00  5.73223765e+00  5.73223765e+00  5.73223765e+00
  1.92458303e+01  2.42832803e+01  2.42832803e+01  2.42832803e+01
  9.36074723e+01  1.20209939e+02  1.20209939e+02  1.20209939e+02
  3.55934113e+02  1.34928009e+03  5.83570165e+03  3.50983056e+04]
E1 = -182.6028604277792  E_coul = 54.07461589332201
cycle= 4 E= -128.528244534457  delta_E= -1.51e-08  |g|= 6e-05  |ddm|= 8.9e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143093
diis-c [-4.34028170e-10  2.16594824e-04  4.46531754e-04 -1.57199271e-01
  1.15653614e+00]
  HOMO = -0.844545459348385  LUMO = 1.09768743713833
  mo_energy =
[-3.27680404e+01 -1.92508330e+00 -8.44545459e-01 -8.44545459e-01
 -8.44545459e-01  1.09768744e+00  1.09768744e+00  1.09768744e+00
  2.01242964e+00  5.73220605e+00  5.73220605e+00  5.73220605e+00
  1.92457892e+01  2.42832339e+01  2.42832339e+01  2.42832339e+01
  9.36074184e+01  1.20209882e+02  1.20209882e+02  1.20209882e+02
  3.55934050e+02  1.34928001e+03  5.83570158e+03  3.50983056e+04]
E1 = -182.60299311228093  E_coul = 54.074748577459694
cycle= 5 E= -128.528244534821  delta_E= -3.64e-10  |g|= 3.81e-06  |ddm|= 1.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60299311228093  E_coul = 54.074748577459694
  HOMO = -0.844543593900781  LUMO = 1.09768824235769
  mo_energy =
[-3.27680364e+01 -1.92508081e+00 -8.44543594e-01 -8.44543594e-01
 -8.44543594e-01  1.09768824e+00  1.09768824e+00  1.09768824e+00
  2.01243154e+00  5.73220838e+00  5.73220838e+00  5.73220838e+00
  1.92457928e+01  2.42832374e+01  2.42832374e+01  2.42832374e+01
  9.36074223e+01  1.20209886e+02  1.20209886e+02  1.20209886e+02
  3.55934054e+02  1.34928002e+03  5.83570158e+03  3.50983056e+04]
E1 = -182.60298415229934  E_coul = 54.07473961747701
Extra cycle  E= -128.528244534822  delta_E= -1.11e-12  |g|= 1.28e-06  |ddm|= 1.94e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498486e+02 1.74907314e+02
 2.05267705e+01 5.69530245e+01 4.87380687e-01 7.77992239e+00
 1.65702027e+00 3.71011538e+00 1.25703000e+01 5.53280426e+01
 3.31959550e-01 1.15114311e+00]
E = -128.52824453482233
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682445        1
[INPUT] 0    0    [1    /1   ]  617.49848638         1
[INPUT] 0    0    [1    /1   ]  174.907313835        1
[INPUT] 0    0    [1    /1   ]  20.5267705462        1
[INPUT] 0    0    [1    /1   ]  56.9530245064        1
[INPUT] 0    0    [1    /1   ]  0.487380686966       1
[INPUT] 0    0    [1    /1   ]  7.77992238849        1
[INPUT] 0    0    [1    /1   ]  1.65702026827        1
[INPUT] 1    0    [1    /1   ]  3.71011537753        1
[INPUT] 1    0    [1    /1   ]  12.5703000439        1
[INPUT] 1    0    [1    /1   ]  55.3280426196        1
[INPUT] 1    0    [1    /1   ]  0.331959550161       1
[INPUT] 1    0    [1    /1   ]  1.15114311477        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729958395, 1.0]], [0, [2712.0968244504597, 1.0]], [0, [617.4984863796502, 1.0]], [0, [174.90731383457947, 1.0]], [0, [20.526770546184675, 1.0]], [0, [56.953024506449296, 1.0]], [0, [0.4873806869655584, 1.0]], [0, [7.779922388489775, 1.0]], [0, [1.6570202682742252, 1.0]], [1, [3.7101153775321793, 1.0]], [1, [12.570300043934667, 1.0]], [1, [55.32804261955145, 1.0]], [1, [0.33195955016145934, 1.0]], [1, [1.1511431147653008, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872996]
bas 1, expnt(s) = [2712.09682445]
bas 2, expnt(s) = [617.49848638]
bas 3, expnt(s) = [174.90731383]
bas 4, expnt(s) = [20.52677055]
bas 5, expnt(s) = [56.95302451]
bas 6, expnt(s) = [0.48738069]
bas 7, expnt(s) = [7.77992239]
bas 8, expnt(s) = [1.65702027]
bas 9, expnt(s) = [3.71011538]
bas 10, expnt(s) = [12.57030004]
bas 11, expnt(s) = [55.32804262]
bas 12, expnt(s) = [0.33195955]
bas 13, expnt(s) = [1.15114311]
CPU time:       137.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498486e+02 3.12962244e+02 1.74907314e+02 1.21512513e+02
 2.05267705e+01 2.43643873e+01 5.69530245e+01 5.23784471e+01
 4.87380687e-01 1.47372436e+00 7.77992239e+00 1.17691873e+01
 1.65702027e+00 3.68986851e+00 3.71011538e+00 1.50216854e+01
 1.25703000e+01 6.90504396e+01 5.53280426e+01 4.40216205e+02
 3.31959550e-01 7.35090570e-01 1.15114311e+00 3.47853232e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.997978031224523
cond(S) = 238.35583040965616
E1 = -183.57478942157724  E_coul = 55.07972459012783
init E= -128.495064831449
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773881423088058  LUMO = 1.1230346176723
  mo_energy =
[-3.25545163e+01 -1.85133252e+00 -7.73881423e-01 -7.73881423e-01
 -7.73881423e-01  1.12303462e+00  1.12303462e+00  1.12303462e+00
  2.06224619e+00  5.81906985e+00  5.81906985e+00  5.81906985e+00
  1.93909359e+01  2.44407028e+01  2.44407028e+01  2.44407028e+01
  9.38080907e+01  1.20425932e+02  1.20425932e+02  1.20425932e+02
  3.56169987e+02  1.34954826e+03  5.83599889e+03  3.50986234e+04]
E1 = -182.11708888880935  E_coul = 53.59218194005935
cycle= 1 E= -128.52490694875  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442498
diis-c [-0.19580408  1.        ]
  HOMO = -0.878539154235268  LUMO = 1.08520989640323
  mo_energy =
[-3.28722619e+01 -1.96098978e+00 -8.78539154e-01 -8.78539154e-01
 -8.78539154e-01  1.08520990e+00  1.08520990e+00  1.08520990e+00
  1.98831227e+00  5.69042862e+00  5.69042862e+00  5.69042862e+00
  1.91744236e+01  2.42060220e+01  2.42060220e+01  2.42060220e+01
  9.35090466e+01  1.20105537e+02  1.20105537e+02  1.20105537e+02
  3.55823210e+02  1.34916314e+03  5.83558190e+03  3.50981848e+04]
E1 = -182.8451492553747  E_coul = 54.3177390509616
cycle= 2 E= -128.527410204413  delta_E= -0.0025  |g|= 0.0992  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219347
diis-c [-5.67281616e-04  3.30425572e-01  6.69574428e-01]
  HOMO = -0.844310880757855  LUMO = 1.09773324003586
  mo_energy =
[-3.27675577e+01 -1.92491139e+00 -8.44310881e-01 -8.44310881e-01
 -8.44310881e-01  1.09773324e+00  1.09773324e+00  1.09773324e+00
  2.01251809e+00  5.73242344e+00  5.73242344e+00  5.73242344e+00
  1.92461049e+01  2.42835978e+01  2.42835978e+01  2.42835978e+01
  9.36078700e+01  1.20210379e+02  1.20210379e+02  1.20210379e+02
  3.55934626e+02  1.34928073e+03  5.83570241e+03  3.50983064e+04]
E1 = -182.60219370529998  E_coul = 54.07394918597923
cycle= 3 E= -128.528244519321  delta_E= -0.000834  |g|= 0.000443  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103103
diis-c [-8.15862042e-08 -2.07255662e-03  3.47436736e-04  1.00172512e+00]
  HOMO = -0.844518774393509  LUMO = 1.09769790181349
  mo_energy =
[-3.27679842e+01 -1.92506447e+00 -8.44518774e-01 -8.44518774e-01
 -8.44518774e-01  1.09769790e+00  1.09769790e+00  1.09769790e+00
  2.01244357e+00  5.73223765e+00  5.73223765e+00  5.73223765e+00
  1.92458303e+01  2.42832803e+01  2.42832803e+01  2.42832803e+01
  9.36074723e+01  1.20209939e+02  1.20209939e+02  1.20209939e+02
  3.55934113e+02  1.34928009e+03  5.83570165e+03  3.50983056e+04]
E1 = -182.6028604277792  E_coul = 54.07461589332201
cycle= 4 E= -128.528244534457  delta_E= -1.51e-08  |g|= 6e-05  |ddm|= 8.9e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143093
diis-c [-4.34028170e-10  2.16594824e-04  4.46531754e-04 -1.57199271e-01
  1.15653614e+00]
  HOMO = -0.844545459348385  LUMO = 1.09768743713833
  mo_energy =
[-3.27680404e+01 -1.92508330e+00 -8.44545459e-01 -8.44545459e-01
 -8.44545459e-01  1.09768744e+00  1.09768744e+00  1.09768744e+00
  2.01242964e+00  5.73220605e+00  5.73220605e+00  5.73220605e+00
  1.92457892e+01  2.42832339e+01  2.42832339e+01  2.42832339e+01
  9.36074184e+01  1.20209882e+02  1.20209882e+02  1.20209882e+02
  3.55934050e+02  1.34928001e+03  5.83570158e+03  3.50983056e+04]
E1 = -182.60299311228093  E_coul = 54.074748577459694
cycle= 5 E= -128.528244534821  delta_E= -3.64e-10  |g|= 3.81e-06  |ddm|= 1.86e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60299311228093  E_coul = 54.074748577459694
  HOMO = -0.844543593900781  LUMO = 1.09768824235769
  mo_energy =
[-3.27680364e+01 -1.92508081e+00 -8.44543594e-01 -8.44543594e-01
 -8.44543594e-01  1.09768824e+00  1.09768824e+00  1.09768824e+00
  2.01243154e+00  5.73220838e+00  5.73220838e+00  5.73220838e+00
  1.92457928e+01  2.42832374e+01  2.42832374e+01  2.42832374e+01
  9.36074223e+01  1.20209886e+02  1.20209886e+02  1.20209886e+02
  3.55934054e+02  1.34928002e+03  5.83570158e+03  3.50983056e+04]
E1 = -182.60298415229934  E_coul = 54.07473961747701
Extra cycle  E= -128.528244534822  delta_E= -1.11e-12  |g|= 1.28e-06  |ddm|= 1.94e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.35583040965616
E1 = -182.60298415229934  E_coul = 54.07473961747701
init E= -128.528244534822
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.844544230203463  LUMO = 1.09768802131231
  mo_energy =
[-3.27680384e+01 -1.92508137e+00 -8.44544230e-01 -8.44544230e-01
 -8.44544230e-01  1.09768802e+00  1.09768802e+00  1.09768802e+00
  2.01243118e+00  5.73220761e+00  5.73220761e+00  5.73220761e+00
  1.92457915e+01  2.42832359e+01  2.42832359e+01  2.42832359e+01
  9.36074204e+01  1.20209884e+02  1.20209884e+02  1.20209884e+02
  3.55934052e+02  1.34928002e+03  5.83570158e+03  3.50983056e+04]
E1 = -182.6029890101372  E_coul = 54.074744475314354
cycle= 1 E= -128.528244534823  delta_E= -5.12e-13  |g|= 6.71e-07  |ddm|= 5.02e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6029890101372  E_coul = 54.074744475314354
  HOMO = -0.844543890881068  LUMO = 1.09768814743005
  mo_energy =
[-3.27680374e+01 -1.92508099e+00 -8.44543891e-01 -8.44543891e-01
 -8.44543891e-01  1.09768815e+00  1.09768815e+00  1.09768815e+00
  2.01243144e+00  5.73220803e+00  5.73220803e+00  5.73220803e+00
  1.92457922e+01  2.42832367e+01  2.42832367e+01  2.42832367e+01
  9.36074214e+01  1.20209885e+02  1.20209885e+02  1.20209885e+02
  3.55934053e+02  1.34928002e+03  5.83570158e+03  3.50983056e+04]
E1 = -182.6029866293418  E_coul = 54.07474209451909
Extra cycle  E= -128.528244534823  delta_E= 1.14e-13  |g|= 3.23e-07  |ddm|= 2.82e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498486e+02 1.74907314e+02
 2.05267705e+01 5.69530245e+01 4.87380687e-01 7.77992239e+00
 1.65702027e+00 3.71011538e+00 1.25703000e+01 5.53280426e+01
 3.31959550e-01 1.15114311e+00]
grad_E = [-1.28321920e-09  6.74673810e-08 -1.33479609e-06  1.51416660e-05
  3.61926034e-04 -1.01771966e-04 -7.87325012e-04 -5.47144011e-04
  2.69759865e-04 -3.38556449e-04  1.29467031e-04 -5.20148270e-06
 -1.72435432e-03  8.85879588e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682427        1
[INPUT] 0    0    [1    /1   ]  617.498489712        1
[INPUT] 0    0    [1    /1   ]  174.907271868        1
[INPUT] 0    0    [1    /1   ]  20.5253097754        1
[INPUT] 0    0    [1    /1   ]  56.9533075078        1
[INPUT] 0    0    [1    /1   ]  0.487036548117       1
[INPUT] 0    0    [1    /1   ]  7.78176231188        1
[INPUT] 0    0    [1    /1   ]  1.65553666676        1
[INPUT] 1    0    [1    /1   ]  3.69022572987        1
[INPUT] 1    0    [1    /1   ]  12.4734171453        1
[INPUT] 1    0    [1    /1   ]  54.9899619124        1
[INPUT] 1    0    [1    /1   ]  0.331311799661       1
[INPUT] 1    0    [1    /1   ]  1.14650485021        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.4787299625, 1.0]], [0, [2712.096824274858, 1.0]], [0, [617.4984897123377, 1.0]], [0, [174.90727186790065, 1.0]], [0, [20.52530977540458, 1.0]], [0, [56.95330750779031, 1.0]], [0, [0.48703654811702746, 1.0]], [0, [7.781762311882054, 1.0]], [0, [1.6555366667622688, 1.0]], [1, [3.690225729874429, 1.0]], [1, [12.473417145269666, 1.0]], [1, [54.98996191239824, 1.0]], [1, [0.3313117996611825, 1.0]], [1, [1.1465048502089823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872996]
bas 1, expnt(s) = [2712.09682427]
bas 2, expnt(s) = [617.49848971]
bas 3, expnt(s) = [174.90727187]
bas 4, expnt(s) = [20.52530978]
bas 5, expnt(s) = [56.95330751]
bas 6, expnt(s) = [0.48703655]
bas 7, expnt(s) = [7.78176231]
bas 8, expnt(s) = [1.65553667]
bas 9, expnt(s) = [3.69022573]
bas 10, expnt(s) = [12.47341715]
bas 11, expnt(s) = [54.98996191]
bas 12, expnt(s) = [0.3313118]
bas 13, expnt(s) = [1.14650485]
CPU time:       140.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498490e+02 3.12962245e+02 1.74907272e+02 1.21512491e+02
 2.05253098e+01 2.43630869e+01 5.69533075e+01 5.23786423e+01
 4.87036548e-01 1.47294384e+00 7.78176231e+00 1.17712747e+01
 1.65553667e+00 3.68739046e+00 3.69022573e+00 1.49210903e+01
 1.24734171e+01 6.83858424e+01 5.49899619e+01 4.36856363e+02
 3.31311800e-01 7.33298036e-01 1.14650485e+00 3.46102123e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998002358832153
cond(S) = 238.31984228649486
E1 = -183.57480382357775  E_coul = 55.07973056544342
init E= -128.495073258134
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773879745613179  LUMO = 1.11947568753981
  mo_energy =
[-3.25545251e+01 -1.85133195e+00 -7.73879746e-01 -7.73879746e-01
 -7.73879746e-01  1.11947569e+00  1.11947569e+00  1.11947569e+00
  2.05978593e+00  5.79183936e+00  5.79183936e+00  5.79183936e+00
  1.93858287e+01  2.42649009e+01  2.42649009e+01  2.42649009e+01
  9.38041807e+01  1.19528611e+02  1.19528611e+02  1.19528611e+02
  3.56165907e+02  1.34954447e+03  5.83599554e+03  3.50986207e+04]
E1 = -182.1166809417157  E_coul = 53.59177179932894
cycle= 1 E= -128.524909142387  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443023
diis-c [-0.19626946  1.        ]
  HOMO = -0.8785634049125  LUMO = 1.08181084545288
  mo_energy =
[-3.28723721e+01 -1.96101550e+00 -8.78563405e-01 -8.78563405e-01
 -8.78563405e-01  1.08181085e+00  1.08181085e+00  1.08181085e+00
  1.98590244e+00  5.66363689e+00  5.66363689e+00  5.66363689e+00
  1.91692384e+01  2.40307567e+01  2.40307567e+01  2.40307567e+01
  9.35050366e+01  1.19208376e+02  1.19208376e+02  1.19208376e+02
  3.55819007e+02  1.34915921e+03  5.83557840e+03  3.50981819e+04]
E1 = -182.84523330568783  E_coul = 54.31781872785518
cycle= 2 E= -128.527414577833  delta_E= -0.00251  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.21966
diis-c [-5.66162359e-04  3.30483734e-01  6.69516266e-01]
  HOMO = -0.844312917585937  LUMO = 1.09428771285093
  mo_energy =
[-3.27676146e+01 -1.92491356e+00 -8.44312918e-01 -8.44312918e-01
 -8.44312918e-01  1.09428771e+00  1.09428771e+00  1.09428771e+00
  2.01010574e+00  5.70550276e+00  5.70550276e+00  5.70550276e+00
  1.92409614e+01  2.41081726e+01  2.41081726e+01  2.41081726e+01
  9.36039118e+01  1.19313197e+02  1.19313197e+02  1.19313197e+02
  3.55930478e+02  1.34927685e+03  5.83569896e+03  3.50983036e+04]
E1 = -182.6021275905732  E_coul = 54.07387770586507
cycle= 3 E= -128.528249884708  delta_E= -0.000835  |g|= 0.000438  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102035
diis-c [-8.18579879e-08 -2.05634180e-03  3.23123642e-04  1.00173322e+00]
  HOMO = -0.844517455145436  LUMO = 1.09425416460706
  mo_energy =
[-3.27680349e+01 -1.92506262e+00 -8.44517455e-01 -8.44517455e-01
 -8.44517455e-01  1.09425416e+00  1.09425416e+00  1.09425416e+00
  2.01003460e+00  5.70532180e+00  5.70532180e+00  5.70532180e+00
  1.92406923e+01  2.41078615e+01  2.41078615e+01  2.41078615e+01
  9.36035202e+01  1.19312765e+02  1.19312765e+02  1.19312765e+02
  3.55929972e+02  1.34927622e+03  5.83569821e+03  3.50983028e+04]
E1 = -182.6027822876208  E_coul = 54.07453238807168
cycle= 4 E= -128.528249899549  delta_E= -1.48e-08  |g|= 6.01e-05  |ddm|= 8.94e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143488
diis-c [-4.40386735e-10  2.17549569e-04  4.52409497e-04 -1.58636909e-01
  1.15796695e+00]
  HOMO = -0.844544055756462  LUMO = 1.09424379788041
  mo_energy =
[-3.27680911e+01 -1.92508121e+00 -8.44544056e-01 -8.44544056e-01
 -8.44544056e-01  1.09424380e+00  1.09424380e+00  1.09424380e+00
  2.01002088e+00  5.70529041e+00  5.70529041e+00  5.70529041e+00
  1.92406513e+01  2.41078151e+01  2.41078151e+01  2.41078151e+01
  9.36034663e+01  1.19312708e+02  1.19312708e+02  1.19312708e+02
  3.55929909e+02  1.34927614e+03  5.83569814e+03  3.50983027e+04]
E1 = -182.60291524709697  E_coul = 54.074665347180144
cycle= 5 E= -128.528249899917  delta_E= -3.68e-10  |g|= 3.84e-06  |ddm|= 1.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60291524709697  E_coul = 54.074665347180144
  HOMO = -0.844542171148307  LUMO = 1.09424460742893
  mo_energy =
[-3.27680871e+01 -1.92507870e+00 -8.44542171e-01 -8.44542171e-01
 -8.44542171e-01  1.09424461e+00  1.09424461e+00  1.09424461e+00
  2.01002280e+00  5.70529276e+00  5.70529276e+00  5.70529276e+00
  1.92406549e+01  2.41078187e+01  2.41078187e+01  2.41078187e+01
  9.36034703e+01  1.19312712e+02  1.19312712e+02  1.19312712e+02
  3.55929913e+02  1.34927615e+03  5.83569814e+03  3.50983027e+04]
E1 = -182.60290616666686  E_coul = 54.07465626674894
Extra cycle  E= -128.528249899918  delta_E= -1.08e-12  |g|= 1.3e-06  |ddm|= 1.95e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498490e+02 1.74907272e+02
 2.05253098e+01 5.69533075e+01 4.87036548e-01 7.78176231e+00
 1.65553667e+00 3.69022573e+00 1.24734171e+01 5.49899619e+01
 3.31311800e-01 1.14650485e+00]
E = -128.5282498999179
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682427        1
[INPUT] 0    0    [1    /1   ]  617.498489712        1
[INPUT] 0    0    [1    /1   ]  174.907271868        1
[INPUT] 0    0    [1    /1   ]  20.5253097754        1
[INPUT] 0    0    [1    /1   ]  56.9533075078        1
[INPUT] 0    0    [1    /1   ]  0.487036548117       1
[INPUT] 0    0    [1    /1   ]  7.78176231188        1
[INPUT] 0    0    [1    /1   ]  1.65553666676        1
[INPUT] 1    0    [1    /1   ]  3.69022572987        1
[INPUT] 1    0    [1    /1   ]  12.4734171453        1
[INPUT] 1    0    [1    /1   ]  54.9899619124        1
[INPUT] 1    0    [1    /1   ]  0.331311799661       1
[INPUT] 1    0    [1    /1   ]  1.14650485021        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.4787299625, 1.0]], [0, [2712.096824274858, 1.0]], [0, [617.4984897123377, 1.0]], [0, [174.90727186790065, 1.0]], [0, [20.52530977540458, 1.0]], [0, [56.95330750779031, 1.0]], [0, [0.48703654811702746, 1.0]], [0, [7.781762311882054, 1.0]], [0, [1.6555366667622688, 1.0]], [1, [3.690225729874429, 1.0]], [1, [12.473417145269666, 1.0]], [1, [54.98996191239824, 1.0]], [1, [0.3313117996611825, 1.0]], [1, [1.1465048502089823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872996]
bas 1, expnt(s) = [2712.09682427]
bas 2, expnt(s) = [617.49848971]
bas 3, expnt(s) = [174.90727187]
bas 4, expnt(s) = [20.52530978]
bas 5, expnt(s) = [56.95330751]
bas 6, expnt(s) = [0.48703655]
bas 7, expnt(s) = [7.78176231]
bas 8, expnt(s) = [1.65553667]
bas 9, expnt(s) = [3.69022573]
bas 10, expnt(s) = [12.47341715]
bas 11, expnt(s) = [54.98996191]
bas 12, expnt(s) = [0.3313118]
bas 13, expnt(s) = [1.14650485]
CPU time:       141.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498490e+02 3.12962245e+02 1.74907272e+02 1.21512491e+02
 2.05253098e+01 2.43630869e+01 5.69533075e+01 5.23786423e+01
 4.87036548e-01 1.47294384e+00 7.78176231e+00 1.17712747e+01
 1.65553667e+00 3.68739046e+00 3.69022573e+00 1.49210903e+01
 1.24734171e+01 6.83858424e+01 5.49899619e+01 4.36856363e+02
 3.31311800e-01 7.33298036e-01 1.14650485e+00 3.46102123e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998002358832153
cond(S) = 238.31984228649486
E1 = -183.57480382357775  E_coul = 55.07973056544342
init E= -128.495073258134
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773879745613179  LUMO = 1.11947568753981
  mo_energy =
[-3.25545251e+01 -1.85133195e+00 -7.73879746e-01 -7.73879746e-01
 -7.73879746e-01  1.11947569e+00  1.11947569e+00  1.11947569e+00
  2.05978593e+00  5.79183936e+00  5.79183936e+00  5.79183936e+00
  1.93858287e+01  2.42649009e+01  2.42649009e+01  2.42649009e+01
  9.38041807e+01  1.19528611e+02  1.19528611e+02  1.19528611e+02
  3.56165907e+02  1.34954447e+03  5.83599554e+03  3.50986207e+04]
E1 = -182.1166809417157  E_coul = 53.59177179932894
cycle= 1 E= -128.524909142387  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443023
diis-c [-0.19626946  1.        ]
  HOMO = -0.8785634049125  LUMO = 1.08181084545288
  mo_energy =
[-3.28723721e+01 -1.96101550e+00 -8.78563405e-01 -8.78563405e-01
 -8.78563405e-01  1.08181085e+00  1.08181085e+00  1.08181085e+00
  1.98590244e+00  5.66363689e+00  5.66363689e+00  5.66363689e+00
  1.91692384e+01  2.40307567e+01  2.40307567e+01  2.40307567e+01
  9.35050366e+01  1.19208376e+02  1.19208376e+02  1.19208376e+02
  3.55819007e+02  1.34915921e+03  5.83557840e+03  3.50981819e+04]
E1 = -182.84523330568783  E_coul = 54.31781872785518
cycle= 2 E= -128.527414577833  delta_E= -0.00251  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.21966
diis-c [-5.66162359e-04  3.30483734e-01  6.69516266e-01]
  HOMO = -0.844312917585937  LUMO = 1.09428771285093
  mo_energy =
[-3.27676146e+01 -1.92491356e+00 -8.44312918e-01 -8.44312918e-01
 -8.44312918e-01  1.09428771e+00  1.09428771e+00  1.09428771e+00
  2.01010574e+00  5.70550276e+00  5.70550276e+00  5.70550276e+00
  1.92409614e+01  2.41081726e+01  2.41081726e+01  2.41081726e+01
  9.36039118e+01  1.19313197e+02  1.19313197e+02  1.19313197e+02
  3.55930478e+02  1.34927685e+03  5.83569896e+03  3.50983036e+04]
E1 = -182.6021275905732  E_coul = 54.07387770586507
cycle= 3 E= -128.528249884708  delta_E= -0.000835  |g|= 0.000438  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102035
diis-c [-8.18579879e-08 -2.05634180e-03  3.23123642e-04  1.00173322e+00]
  HOMO = -0.844517455145436  LUMO = 1.09425416460706
  mo_energy =
[-3.27680349e+01 -1.92506262e+00 -8.44517455e-01 -8.44517455e-01
 -8.44517455e-01  1.09425416e+00  1.09425416e+00  1.09425416e+00
  2.01003460e+00  5.70532180e+00  5.70532180e+00  5.70532180e+00
  1.92406923e+01  2.41078615e+01  2.41078615e+01  2.41078615e+01
  9.36035202e+01  1.19312765e+02  1.19312765e+02  1.19312765e+02
  3.55929972e+02  1.34927622e+03  5.83569821e+03  3.50983028e+04]
E1 = -182.6027822876208  E_coul = 54.07453238807168
cycle= 4 E= -128.528249899549  delta_E= -1.48e-08  |g|= 6.01e-05  |ddm|= 8.94e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000143488
diis-c [-4.40386735e-10  2.17549569e-04  4.52409497e-04 -1.58636909e-01
  1.15796695e+00]
  HOMO = -0.844544055756462  LUMO = 1.09424379788041
  mo_energy =
[-3.27680911e+01 -1.92508121e+00 -8.44544056e-01 -8.44544056e-01
 -8.44544056e-01  1.09424380e+00  1.09424380e+00  1.09424380e+00
  2.01002088e+00  5.70529041e+00  5.70529041e+00  5.70529041e+00
  1.92406513e+01  2.41078151e+01  2.41078151e+01  2.41078151e+01
  9.36034663e+01  1.19312708e+02  1.19312708e+02  1.19312708e+02
  3.55929909e+02  1.34927614e+03  5.83569814e+03  3.50983027e+04]
E1 = -182.60291524709697  E_coul = 54.074665347180144
cycle= 5 E= -128.528249899917  delta_E= -3.68e-10  |g|= 3.84e-06  |ddm|= 1.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60291524709697  E_coul = 54.074665347180144
  HOMO = -0.844542171148307  LUMO = 1.09424460742893
  mo_energy =
[-3.27680871e+01 -1.92507870e+00 -8.44542171e-01 -8.44542171e-01
 -8.44542171e-01  1.09424461e+00  1.09424461e+00  1.09424461e+00
  2.01002280e+00  5.70529276e+00  5.70529276e+00  5.70529276e+00
  1.92406549e+01  2.41078187e+01  2.41078187e+01  2.41078187e+01
  9.36034703e+01  1.19312712e+02  1.19312712e+02  1.19312712e+02
  3.55929913e+02  1.34927615e+03  5.83569814e+03  3.50983027e+04]
E1 = -182.60290616666686  E_coul = 54.07465626674894
Extra cycle  E= -128.528249899918  delta_E= -1.08e-12  |g|= 1.3e-06  |ddm|= 1.95e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.31984228649486
E1 = -182.60290616666686  E_coul = 54.07465626674894
init E= -128.528249899918
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.844542815933941  LUMO = 1.09424438437632
  mo_energy =
[-3.27680891e+01 -1.92507928e+00 -8.44542816e-01 -8.44542816e-01
 -8.44542816e-01  1.09424438e+00  1.09424438e+00  1.09424438e+00
  2.01002244e+00  5.70529198e+00  5.70529198e+00  5.70529198e+00
  1.92406536e+01  2.41078172e+01  2.41078172e+01  2.41078172e+01
  9.36034684e+01  1.19312710e+02  1.19312710e+02  1.19312710e+02
  3.55929911e+02  1.34927615e+03  5.83569814e+03  3.50983027e+04]
E1 = -182.60291108742703  E_coul = 54.07466118750913
cycle= 1 E= -128.528249899918  delta_E=    0  |g|= 6.8e-07  |ddm|= 5.08e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60291108742703  E_coul = 54.07466118750913
  HOMO = -0.844542472168413  LUMO = 1.09424451157755
  mo_energy =
[-3.27680880e+01 -1.92507889e+00 -8.44542472e-01 -8.44542472e-01
 -8.44542472e-01  1.09424451e+00  1.09424451e+00  1.09424451e+00
  2.01002270e+00  5.70529240e+00  5.70529240e+00  5.70529240e+00
  1.92406543e+01  2.41078180e+01  2.41078180e+01  2.41078180e+01
  9.36034694e+01  1.19312711e+02  1.19312711e+02  1.19312711e+02
  3.55929912e+02  1.34927615e+03  5.83569814e+03  3.50983027e+04]
E1 = -182.60290867524395  E_coul = 54.07465877532578
Extra cycle  E= -128.528249899918  delta_E= -2.56e-13  |g|= 3.28e-07  |ddm|= 2.85e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498490e+02 1.74907272e+02
 2.05253098e+01 5.69533075e+01 4.87036548e-01 7.78176231e+00
 1.65553667e+00 3.69022573e+00 1.24734171e+01 5.49899619e+01
 3.31311800e-01 1.14650485e+00]
grad_E = [-1.23286967e-09  6.48398596e-08 -1.28277079e-06  1.45627507e-05
  3.49226218e-04 -9.79184139e-05 -7.47895510e-04 -5.26848359e-04
  1.67893793e-04  1.10402581e-04 -2.96860989e-05  5.11633951e-06
  3.11472714e-04 -1.73568321e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682417        1
[INPUT] 0    0    [1    /1   ]  617.498491736        1
[INPUT] 0    0    [1    /1   ]  174.907245092        1
[INPUT] 0    0    [1    /1   ]  20.5242391199        1
[INPUT] 0    0    [1    /1   ]  56.9534888189        1
[INPUT] 0    0    [1    /1   ]  0.487357650298       1
[INPUT] 0    0    [1    /1   ]  7.78307495981        1
[INPUT] 0    0    [1    /1   ]  1.65558337321        1
[INPUT] 1    0    [1    /1   ]  3.67760795237        1
[INPUT] 1    0    [1    /1   ]  12.4184341026        1
[INPUT] 1    0    [1    /1   ]  54.6898226734        1
[INPUT] 1    0    [1    /1   ]  0.330610909043       1
[INPUT] 1    0    [1    /1   ]  1.14335724344        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729965227, 1.0]], [0, [2712.096824166095, 1.0]], [0, [617.4984917363657, 1.0]], [0, [174.90724509245828, 1.0]], [0, [20.524239119947367, 1.0]], [0, [56.95348881886503, 1.0]], [0, [0.4873576502984049, 1.0]], [0, [7.783074959807192, 1.0]], [0, [1.6555833732123335, 1.0]], [1, [3.6776079523693035, 1.0]], [1, [12.41843410261602, 1.0]], [1, [54.689822673444986, 1.0]], [1, [0.33061090904286916, 1.0]], [1, [1.1433572434382764, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682417]
bas 2, expnt(s) = [617.49849174]
bas 3, expnt(s) = [174.90724509]
bas 4, expnt(s) = [20.52423912]
bas 5, expnt(s) = [56.95348882]
bas 6, expnt(s) = [0.48735765]
bas 7, expnt(s) = [7.78307496]
bas 8, expnt(s) = [1.65558337]
bas 9, expnt(s) = [3.67760795]
bas 10, expnt(s) = [12.4184341]
bas 11, expnt(s) = [54.68982267]
bas 12, expnt(s) = [0.33061091]
bas 13, expnt(s) = [1.14335724]
CPU time:       143.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498492e+02 3.12962246e+02 1.74907245e+02 1.21512477e+02
 2.05242391e+01 2.43621338e+01 5.69534888e+01 5.23787674e+01
 4.87357650e-01 1.47367211e+00 7.78307496e+00 1.17727639e+01
 1.65558337e+00 3.68746848e+00 3.67760795e+00 1.48573440e+01
 1.24184341e+01 6.80092427e+01 5.46898227e+01 4.33877907e+02
 3.30610909e-01 7.31359433e-01 1.14335724e+00 3.44914798e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99802062258642
cond(S) = 238.38158734888196
E1 = -183.57478572082974  E_coul = 55.079715988793055
init E= -128.495069732037
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773880191713234  LUMO = 1.11631015295969
  mo_energy =
[-3.25545337e+01 -1.85133225e+00 -7.73880192e-01 -7.73880192e-01
 -7.73880192e-01  1.11631015e+00  1.11631015e+00  1.11631015e+00
  2.06095174e+00  5.77271390e+00  5.77271390e+00  5.77271390e+00
  1.93891690e+01  2.41591493e+01  2.41591493e+01  2.41591493e+01
  9.38080415e+01  1.18846960e+02  1.18846960e+02  1.18846960e+02
  3.56168831e+02  1.34954690e+03  5.83599762e+03  3.50986224e+04]
E1 = -182.11590272041406  E_coul = 53.59099530830278
cycle= 1 E= -128.524907412111  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443408
diis-c [-0.19661036  1.        ]
  HOMO = -0.878617198127402  LUMO = 1.07874636970855
  mo_energy =
[-3.28725209e+01 -1.96109534e+00 -8.78617198e-01 -8.78617198e-01
 -8.78617198e-01  1.07874637e+00  1.07874637e+00  1.07874637e+00
  1.98698197e+00  5.64474244e+00  5.64474244e+00  5.64474244e+00
  1.91724729e+01  2.39252451e+01  2.39252451e+01  2.39252451e+01
  9.35087654e+01  1.18526814e+02  1.18526814e+02  1.18526814e+02
  3.55821788e+02  1.34916150e+03  5.83558034e+03  3.50981835e+04]
E1 = -182.84496080366333  E_coul = 54.31754598479977
cycle= 2 E= -128.527414818864  delta_E= -0.00251  |g|= 0.0994  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219927
diis-c [-5.66180636e-04  3.30562925e-01  6.69437075e-01]
  HOMO = -0.844345557861247  LUMO = 1.0911889123142
  mo_energy =
[-3.27677092e+01 -1.92497060e+00 -8.44345558e-01 -8.44345558e-01
 -8.44345558e-01  1.09118891e+00  1.09118891e+00  1.09118891e+00
  2.01120831e+00  5.68653423e+00  5.68653423e+00  5.68653423e+00
  1.92442378e+01  2.40025861e+01  2.40025861e+01  2.40025861e+01
  9.36076920e+01  1.18631625e+02  1.18631625e+02  1.18631625e+02
  3.55933317e+02  1.34927920e+03  5.83570096e+03  3.50983052e+04]
E1 = -182.60164805063164  E_coul = 54.073396697607414
cycle= 3 E= -128.528251353024  delta_E= -0.000837  |g|= 0.000434  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101002
diis-c [-7.89775786e-08 -2.04921526e-03  2.90947507e-04  1.00175827e+00]
  HOMO = -0.844549463886211  LUMO = 1.09115562385292
  mo_energy =
[-3.27681275e+01 -1.92512057e+00 -8.44549464e-01 -8.44549464e-01
 -8.44549464e-01  1.09115562e+00  1.09115562e+00  1.09115562e+00
  2.01113629e+00  5.68635433e+00  5.68635433e+00  5.68635433e+00
  1.92439696e+01  2.40022766e+01  2.40022766e+01  2.40022766e+01
  9.36073022e+01  1.18631195e+02  1.18631195e+02  1.18631195e+02
  3.55932813e+02  1.34927857e+03  5.83570022e+03  3.50983044e+04]
E1 = -182.6022946276476  E_coul = 54.07404326019908
cycle= 4 E= -128.528251367449  delta_E= -1.44e-08  |g|= 5.92e-05  |ddm|= 8.68e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000141498
diis-c [-4.26489731e-10  2.10500902e-04  4.49143660e-04 -1.55210466e-01
  1.15455082e+00]
  HOMO = -0.844575893621869  LUMO = 1.09114531888456
  mo_energy =
[-3.27681831e+01 -1.92513939e+00 -8.44575894e-01 -8.44575894e-01
 -8.44575894e-01  1.09114532e+00  1.09114532e+00  1.09114532e+00
  2.01112236e+00  5.68632317e+00  5.68632317e+00  5.68632317e+00
  1.92439288e+01  2.40022306e+01  2.40022306e+01  2.40022306e+01
  9.36072489e+01  1.18631139e+02  1.18631139e+02  1.18631139e+02
  3.55932751e+02  1.34927849e+03  5.83570015e+03  3.50983043e+04]
E1 = -182.6024258818953  E_coul = 54.07417451409374
cycle= 5 E= -128.528251367802  delta_E= -3.53e-10  |g|= 3.74e-06  |ddm|= 1.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6024258818953  E_coul = 54.07417451409374
  HOMO = -0.844574077014182  LUMO = 1.09114609801933
  mo_energy =
[-3.27681792e+01 -1.92513696e+00 -8.44574077e-01 -8.44574077e-01
 -8.44574077e-01  1.09114610e+00  1.09114610e+00  1.09114610e+00
  2.01112421e+00  5.68632543e+00  5.68632543e+00  5.68632543e+00
  1.92439323e+01  2.40022341e+01  2.40022341e+01  2.40022341e+01
  9.36072527e+01  1.18631143e+02  1.18631143e+02  1.18631143e+02
  3.55932754e+02  1.34927850e+03  5.83570015e+03  3.50983043e+04]
E1 = -182.60241713075368  E_coul = 54.074165762951274
Extra cycle  E= -128.528251367802  delta_E= -8.53e-13  |g|= 1.25e-06  |ddm|= 1.91e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498492e+02 1.74907245e+02
 2.05242391e+01 5.69534888e+01 4.87357650e-01 7.78307496e+00
 1.65558337e+00 3.67760795e+00 1.24184341e+01 5.46898227e+01
 3.30610909e-01 1.14335724e+00]
E = -128.5282513678024
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682417        1
[INPUT] 0    0    [1    /1   ]  617.498491736        1
[INPUT] 0    0    [1    /1   ]  174.907245092        1
[INPUT] 0    0    [1    /1   ]  20.5242391199        1
[INPUT] 0    0    [1    /1   ]  56.9534888189        1
[INPUT] 0    0    [1    /1   ]  0.487357650298       1
[INPUT] 0    0    [1    /1   ]  7.78307495981        1
[INPUT] 0    0    [1    /1   ]  1.65558337321        1
[INPUT] 1    0    [1    /1   ]  3.67760795237        1
[INPUT] 1    0    [1    /1   ]  12.4184341026        1
[INPUT] 1    0    [1    /1   ]  54.6898226734        1
[INPUT] 1    0    [1    /1   ]  0.330610909043       1
[INPUT] 1    0    [1    /1   ]  1.14335724344        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729965227, 1.0]], [0, [2712.096824166095, 1.0]], [0, [617.4984917363657, 1.0]], [0, [174.90724509245828, 1.0]], [0, [20.524239119947367, 1.0]], [0, [56.95348881886503, 1.0]], [0, [0.4873576502984049, 1.0]], [0, [7.783074959807192, 1.0]], [0, [1.6555833732123335, 1.0]], [1, [3.6776079523693035, 1.0]], [1, [12.41843410261602, 1.0]], [1, [54.689822673444986, 1.0]], [1, [0.33061090904286916, 1.0]], [1, [1.1433572434382764, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682417]
bas 2, expnt(s) = [617.49849174]
bas 3, expnt(s) = [174.90724509]
bas 4, expnt(s) = [20.52423912]
bas 5, expnt(s) = [56.95348882]
bas 6, expnt(s) = [0.48735765]
bas 7, expnt(s) = [7.78307496]
bas 8, expnt(s) = [1.65558337]
bas 9, expnt(s) = [3.67760795]
bas 10, expnt(s) = [12.4184341]
bas 11, expnt(s) = [54.68982267]
bas 12, expnt(s) = [0.33061091]
bas 13, expnt(s) = [1.14335724]
CPU time:       144.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498492e+02 3.12962246e+02 1.74907245e+02 1.21512477e+02
 2.05242391e+01 2.43621338e+01 5.69534888e+01 5.23787674e+01
 4.87357650e-01 1.47367211e+00 7.78307496e+00 1.17727639e+01
 1.65558337e+00 3.68746848e+00 3.67760795e+00 1.48573440e+01
 1.24184341e+01 6.80092427e+01 5.46898227e+01 4.33877907e+02
 3.30610909e-01 7.31359433e-01 1.14335724e+00 3.44914798e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99802062258642
cond(S) = 238.38158734888196
E1 = -183.57478572082974  E_coul = 55.079715988793055
init E= -128.495069732037
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773880191713234  LUMO = 1.11631015295969
  mo_energy =
[-3.25545337e+01 -1.85133225e+00 -7.73880192e-01 -7.73880192e-01
 -7.73880192e-01  1.11631015e+00  1.11631015e+00  1.11631015e+00
  2.06095174e+00  5.77271390e+00  5.77271390e+00  5.77271390e+00
  1.93891690e+01  2.41591493e+01  2.41591493e+01  2.41591493e+01
  9.38080415e+01  1.18846960e+02  1.18846960e+02  1.18846960e+02
  3.56168831e+02  1.34954690e+03  5.83599762e+03  3.50986224e+04]
E1 = -182.11590272041406  E_coul = 53.59099530830278
cycle= 1 E= -128.524907412111  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443408
diis-c [-0.19661036  1.        ]
  HOMO = -0.878617198127402  LUMO = 1.07874636970855
  mo_energy =
[-3.28725209e+01 -1.96109534e+00 -8.78617198e-01 -8.78617198e-01
 -8.78617198e-01  1.07874637e+00  1.07874637e+00  1.07874637e+00
  1.98698197e+00  5.64474244e+00  5.64474244e+00  5.64474244e+00
  1.91724729e+01  2.39252451e+01  2.39252451e+01  2.39252451e+01
  9.35087654e+01  1.18526814e+02  1.18526814e+02  1.18526814e+02
  3.55821788e+02  1.34916150e+03  5.83558034e+03  3.50981835e+04]
E1 = -182.84496080366333  E_coul = 54.31754598479977
cycle= 2 E= -128.527414818864  delta_E= -0.00251  |g|= 0.0994  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219927
diis-c [-5.66180636e-04  3.30562925e-01  6.69437075e-01]
  HOMO = -0.844345557861247  LUMO = 1.0911889123142
  mo_energy =
[-3.27677092e+01 -1.92497060e+00 -8.44345558e-01 -8.44345558e-01
 -8.44345558e-01  1.09118891e+00  1.09118891e+00  1.09118891e+00
  2.01120831e+00  5.68653423e+00  5.68653423e+00  5.68653423e+00
  1.92442378e+01  2.40025861e+01  2.40025861e+01  2.40025861e+01
  9.36076920e+01  1.18631625e+02  1.18631625e+02  1.18631625e+02
  3.55933317e+02  1.34927920e+03  5.83570096e+03  3.50983052e+04]
E1 = -182.60164805063164  E_coul = 54.073396697607414
cycle= 3 E= -128.528251353024  delta_E= -0.000837  |g|= 0.000434  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101002
diis-c [-7.89775786e-08 -2.04921526e-03  2.90947507e-04  1.00175827e+00]
  HOMO = -0.844549463886211  LUMO = 1.09115562385292
  mo_energy =
[-3.27681275e+01 -1.92512057e+00 -8.44549464e-01 -8.44549464e-01
 -8.44549464e-01  1.09115562e+00  1.09115562e+00  1.09115562e+00
  2.01113629e+00  5.68635433e+00  5.68635433e+00  5.68635433e+00
  1.92439696e+01  2.40022766e+01  2.40022766e+01  2.40022766e+01
  9.36073022e+01  1.18631195e+02  1.18631195e+02  1.18631195e+02
  3.55932813e+02  1.34927857e+03  5.83570022e+03  3.50983044e+04]
E1 = -182.6022946276476  E_coul = 54.07404326019908
cycle= 4 E= -128.528251367449  delta_E= -1.44e-08  |g|= 5.92e-05  |ddm|= 8.68e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000141498
diis-c [-4.26489731e-10  2.10500902e-04  4.49143660e-04 -1.55210466e-01
  1.15455082e+00]
  HOMO = -0.844575893621869  LUMO = 1.09114531888456
  mo_energy =
[-3.27681831e+01 -1.92513939e+00 -8.44575894e-01 -8.44575894e-01
 -8.44575894e-01  1.09114532e+00  1.09114532e+00  1.09114532e+00
  2.01112236e+00  5.68632317e+00  5.68632317e+00  5.68632317e+00
  1.92439288e+01  2.40022306e+01  2.40022306e+01  2.40022306e+01
  9.36072489e+01  1.18631139e+02  1.18631139e+02  1.18631139e+02
  3.55932751e+02  1.34927849e+03  5.83570015e+03  3.50983043e+04]
E1 = -182.6024258818953  E_coul = 54.07417451409374
cycle= 5 E= -128.528251367802  delta_E= -3.53e-10  |g|= 3.74e-06  |ddm|= 1.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6024258818953  E_coul = 54.07417451409374
  HOMO = -0.844574077014182  LUMO = 1.09114609801933
  mo_energy =
[-3.27681792e+01 -1.92513696e+00 -8.44574077e-01 -8.44574077e-01
 -8.44574077e-01  1.09114610e+00  1.09114610e+00  1.09114610e+00
  2.01112421e+00  5.68632543e+00  5.68632543e+00  5.68632543e+00
  1.92439323e+01  2.40022341e+01  2.40022341e+01  2.40022341e+01
  9.36072527e+01  1.18631143e+02  1.18631143e+02  1.18631143e+02
  3.55932754e+02  1.34927850e+03  5.83570015e+03  3.50983043e+04]
E1 = -182.60241713075368  E_coul = 54.074165762951274
Extra cycle  E= -128.528251367802  delta_E= -8.53e-13  |g|= 1.25e-06  |ddm|= 1.91e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.38158734888196
E1 = -182.60241713075368  E_coul = 54.074165762951274
init E= -128.528251367802
    CPU time for initialize scf      0.15 sec, wall time      0.15 sec
  HOMO = -0.844574698961731  LUMO = 1.09114588381355
  mo_energy =
[-3.27681812e+01 -1.92513751e+00 -8.44574699e-01 -8.44574699e-01
 -8.44574699e-01  1.09114588e+00  1.09114588e+00  1.09114588e+00
  2.01112387e+00  5.68632468e+00  5.68632468e+00  5.68632468e+00
  1.92439310e+01  2.40022327e+01  2.40022327e+01  2.40022327e+01
  9.36072508e+01  1.18631141e+02  1.18631141e+02  1.18631141e+02
  3.55932752e+02  1.34927849e+03  5.83570015e+03  3.50983043e+04]
E1 = -182.60242187985148  E_coul = 54.07417051204897
cycle= 1 E= -128.528251367803  delta_E= -1.14e-13  |g|= 6.56e-07  |ddm|= 4.9e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60242187985148  E_coul = 54.07417051204897
  HOMO = -0.844574367265966  LUMO = 1.09114600618676
  mo_energy =
[-3.27681802e+01 -1.92513714e+00 -8.44574367e-01 -8.44574367e-01
 -8.44574367e-01  1.09114601e+00  1.09114601e+00  1.09114601e+00
  2.01112412e+00  5.68632509e+00  5.68632509e+00  5.68632509e+00
  1.92439317e+01  2.40022334e+01  2.40022334e+01  2.40022334e+01
  9.36072518e+01  1.18631142e+02  1.18631142e+02  1.18631142e+02
  3.55932753e+02  1.34927850e+03  5.83570015e+03  3.50983043e+04]
E1 = -182.602419552394  E_coul = 54.07416818459133
Extra cycle  E= -128.528251367803  delta_E= -1.71e-13  |g|= 3.16e-07  |ddm|= 2.76e-07
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498492e+02 1.74907245e+02
 2.05242391e+01 5.69534888e+01 4.87357650e-01 7.78307496e+00
 1.65558337e+00 3.67760795e+00 1.24184341e+01 5.46898227e+01
 3.30610909e-01 1.14335724e+00]
grad_E = [-1.19777388e-09  6.30041541e-08 -1.24653209e-06  1.41572470e-05
  3.40261291e-04 -9.52418258e-05 -1.18745486e-04 -5.14223286e-04
  9.87937629e-06  9.48629401e-05 -4.24172950e-05  3.20773359e-06
 -9.32060437e-05 -6.65560022e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682405        1
[INPUT] 0    0    [1    /1   ]  617.498493959        1
[INPUT] 0    0    [1    /1   ]  174.907218165        1
[INPUT] 0    0    [1    /1   ]  20.5233987863        1
[INPUT] 0    0    [1    /1   ]  56.9536706171        1
[INPUT] 0    0    [1    /1   ]  0.487632747624       1
[INPUT] 0    0    [1    /1   ]  7.78421829539        1
[INPUT] 0    0    [1    /1   ]  1.65606927169        1
[INPUT] 1    0    [1    /1   ]  3.67292878174        1
[INPUT] 1    0    [1    /1   ]  12.3990714443        1
[INPUT] 1    0    [1    /1   ]  54.5598373885        1
[INPUT] 1    0    [1    /1   ]  0.330402916708       1
[INPUT] 1    0    [1    /1   ]  1.14220823628        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.4787299677, 1.0]], [0, [2712.096824050899, 1.0]], [0, [617.498493959096, 1.0]], [0, [174.90721816498709, 1.0]], [0, [20.52339878627999, 1.0]], [0, [56.953670617077464, 1.0]], [0, [0.4876327476236198, 1.0]], [0, [7.784218295391411, 1.0]], [0, [1.6560692716911012, 1.0]], [1, [3.6729287817442624, 1.0]], [1, [12.399071444318254, 1.0]], [1, [54.55983738852777, 1.0]], [1, [0.3304029167075156, 1.0]], [1, [1.1422082362789543, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682405]
bas 2, expnt(s) = [617.49849396]
bas 3, expnt(s) = [174.90721816]
bas 4, expnt(s) = [20.52339879]
bas 5, expnt(s) = [56.95367062]
bas 6, expnt(s) = [0.48763275]
bas 7, expnt(s) = [7.7842183]
bas 8, expnt(s) = [1.65606927]
bas 9, expnt(s) = [3.67292878]
bas 10, expnt(s) = [12.39907144]
bas 11, expnt(s) = [54.55983739]
bas 12, expnt(s) = [0.33040292]
bas 13, expnt(s) = [1.14220824]
CPU time:       147.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498494e+02 3.12962247e+02 1.74907218e+02 1.21512463e+02
 2.05233988e+01 2.43613857e+01 5.69536706e+01 5.23788928e+01
 4.87632748e-01 1.47429595e+00 7.78421830e+00 1.17740609e+01
 1.65606927e+00 3.68828013e+00 3.67292878e+00 1.48337183e+01
 1.23990714e+01 6.78767197e+01 5.45598374e+01 4.32589254e+02
 3.30402917e-01 7.30784342e-01 1.14220824e+00 3.44481578e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998025859439657
cond(S) = 238.4557373150345
E1 = -183.574787443304  E_coul = 55.07971765964936
init E= -128.495069783655
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773879549153361  LUMO = 1.11530303732649
  mo_energy =
[-3.25545354e+01 -1.85133202e+00 -7.73879549e-01 -7.73879549e-01
 -7.73879549e-01  1.11530304e+00  1.11530304e+00  1.11530304e+00
  2.06235019e+00  5.76582327e+00  5.76582327e+00  5.76582327e+00
  1.93938748e+01  2.41213439e+01  2.41213439e+01  2.41213439e+01
  9.38134234e+01  1.18568924e+02  1.18568924e+02  1.18568924e+02
  3.56173390e+02  1.34955088e+03  5.83600109e+03  3.50986252e+04]
E1 = -182.1158673758723  E_coul = 53.590959484447154
cycle= 1 E= -128.524907891425  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443502
diis-c [-0.19669359  1.        ]
  HOMO = -0.878616019268569  LUMO = 1.07778148084507
  mo_energy =
[-3.28725324e+01 -1.96110574e+00 -8.78616019e-01 -8.78616019e-01
 -8.78616019e-01  1.07778148e+00  1.07778148e+00  1.07778148e+00
  1.98833908e+00  5.63796312e+00  5.63796312e+00  5.63796312e+00
  1.91771677e+01  2.38875594e+01  2.38875594e+01  2.38875594e+01
  9.35141404e+01  1.18248869e+02  1.18248869e+02  1.18248869e+02
  3.55826340e+02  1.34916547e+03  5.83558381e+03  3.50981863e+04]
E1 = -182.84498249258226  E_coul = 54.317567122549995
cycle= 2 E= -128.527415370032  delta_E= -0.00251  |g|= 0.0994  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219995
diis-c [-5.66250905e-04  3.30585081e-01  6.69414919e-01]
  HOMO = -0.844342522018696  LUMO = 1.09021028089835
  mo_energy =
[-3.27677174e+01 -1.92497880e+00 -8.44342522e-01 -8.44342522e-01
 -8.44342522e-01  1.09021028e+00  1.09021028e+00  1.09021028e+00
  2.01257751e+00  5.67971980e+00  5.67971980e+00  5.67971980e+00
  1.92489378e+01  2.39648612e+01  2.39648612e+01  2.39648612e+01
  9.36130698e+01  1.18353656e+02  1.18353656e+02  1.18353656e+02
  3.55937871e+02  1.34928318e+03  5.83570443e+03  3.50983081e+04]
E1 = -182.60164501133625  E_coul = 54.07339296538481
cycle= 3 E= -128.528252045951  delta_E= -0.000837  |g|= 0.000432  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100479
diis-c [-7.75559677e-08 -2.04594551e-03  2.75022768e-04  1.00177092e+00]
  HOMO = -0.84454593438434  LUMO = 1.09017717461203
  mo_energy =
[-3.27681346e+01 -1.92512899e+00 -8.44545934e-01 -8.44545934e-01
 -8.44545934e-01  1.09017717e+00  1.09017717e+00  1.09017717e+00
  2.01250524e+00  5.67954057e+00  5.67954057e+00  5.67954057e+00
  1.92486702e+01  2.39645526e+01  2.39645526e+01  2.39645526e+01
  9.36126811e+01  1.18353227e+02  1.18353227e+02  1.18353227e+02
  3.55937369e+02  1.34928255e+03  5.83570370e+03  3.50983073e+04]
E1 = -182.60228788710302  E_coul = 54.07403582692716
cycle= 4 E= -128.528252060176  delta_E= -1.42e-08  |g|= 5.88e-05  |ddm|= 8.55e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000140462
diis-c [-4.20041352e-10  2.07538678e-04  4.47520504e-04 -1.53707308e-01
  1.15305225e+00]
  HOMO = -0.844572247970049  LUMO = 1.09016691117621
  mo_energy =
[-3.27681899e+01 -1.92514787e+00 -8.44572248e-01 -8.44572248e-01
 -8.44572248e-01  1.09016691e+00  1.09016691e+00  1.09016691e+00
  2.01249124e+00  5.67950955e+00  5.67950955e+00  5.67950955e+00
  1.92486296e+01  2.39645069e+01  2.39645069e+01  2.39645069e+01
  9.36126280e+01  1.18353171e+02  1.18353171e+02  1.18353171e+02
  3.55937307e+02  1.34928248e+03  5.83570362e+03  3.50983072e+04]
E1 = -182.60241824226028  E_coul = 54.074166181738605
cycle= 5 E= -128.528252060522  delta_E= -3.46e-10  |g|= 3.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60241824226028  E_coul = 54.074166181738605
  HOMO = -0.844570463539881  LUMO = 1.09016767617386
  mo_energy =
[-3.27681861e+01 -1.92514547e+00 -8.44570464e-01 -8.44570464e-01
 -8.44570464e-01  1.09016768e+00  1.09016768e+00  1.09016768e+00
  2.01249307e+00  5.67951177e+00  5.67951177e+00  5.67951177e+00
  1.92486330e+01  2.39645103e+01  2.39645103e+01  2.39645103e+01
  9.36126318e+01  1.18353175e+02  1.18353175e+02  1.18353175e+02
  3.55937311e+02  1.34928248e+03  5.83570362e+03  3.50983072e+04]
E1 = -182.60240964447334  E_coul = 54.07415758395037
Extra cycle  E= -128.528252060523  delta_E= -1.28e-12  |g|= 1.23e-06  |ddm|= 1.89e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498494e+02 1.74907218e+02
 2.05233988e+01 5.69536706e+01 4.87632748e-01 7.78421830e+00
 1.65606927e+00 3.67292878e+00 1.23990714e+01 5.45598374e+01
 3.30402917e-01 1.14220824e+00]
E = -128.52825206052296
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682405        1
[INPUT] 0    0    [1    /1   ]  617.498493959        1
[INPUT] 0    0    [1    /1   ]  174.907218165        1
[INPUT] 0    0    [1    /1   ]  20.5233987863        1
[INPUT] 0    0    [1    /1   ]  56.9536706171        1
[INPUT] 0    0    [1    /1   ]  0.487632747624       1
[INPUT] 0    0    [1    /1   ]  7.78421829539        1
[INPUT] 0    0    [1    /1   ]  1.65606927169        1
[INPUT] 1    0    [1    /1   ]  3.67292878174        1
[INPUT] 1    0    [1    /1   ]  12.3990714443        1
[INPUT] 1    0    [1    /1   ]  54.5598373885        1
[INPUT] 1    0    [1    /1   ]  0.330402916708       1
[INPUT] 1    0    [1    /1   ]  1.14220823628        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.4787299677, 1.0]], [0, [2712.096824050899, 1.0]], [0, [617.498493959096, 1.0]], [0, [174.90721816498709, 1.0]], [0, [20.52339878627999, 1.0]], [0, [56.953670617077464, 1.0]], [0, [0.4876327476236198, 1.0]], [0, [7.784218295391411, 1.0]], [0, [1.6560692716911012, 1.0]], [1, [3.6729287817442624, 1.0]], [1, [12.399071444318254, 1.0]], [1, [54.55983738852777, 1.0]], [1, [0.3304029167075156, 1.0]], [1, [1.1422082362789543, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872997]
bas 1, expnt(s) = [2712.09682405]
bas 2, expnt(s) = [617.49849396]
bas 3, expnt(s) = [174.90721816]
bas 4, expnt(s) = [20.52339879]
bas 5, expnt(s) = [56.95367062]
bas 6, expnt(s) = [0.48763275]
bas 7, expnt(s) = [7.7842183]
bas 8, expnt(s) = [1.65606927]
bas 9, expnt(s) = [3.67292878]
bas 10, expnt(s) = [12.39907144]
bas 11, expnt(s) = [54.55983739]
bas 12, expnt(s) = [0.33040292]
bas 13, expnt(s) = [1.14220824]
CPU time:       148.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497700e+02
 6.17498494e+02 3.12962247e+02 1.74907218e+02 1.21512463e+02
 2.05233988e+01 2.43613857e+01 5.69536706e+01 5.23788928e+01
 4.87632748e-01 1.47429595e+00 7.78421830e+00 1.17740609e+01
 1.65606927e+00 3.68828013e+00 3.67292878e+00 1.48337183e+01
 1.23990714e+01 6.78767197e+01 5.45598374e+01 4.32589254e+02
 3.30402917e-01 7.30784342e-01 1.14220824e+00 3.44481578e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998025859439657
cond(S) = 238.4557373150345
E1 = -183.574787443304  E_coul = 55.07971765964936
init E= -128.495069783655
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773879549153361  LUMO = 1.11530303732649
  mo_energy =
[-3.25545354e+01 -1.85133202e+00 -7.73879549e-01 -7.73879549e-01
 -7.73879549e-01  1.11530304e+00  1.11530304e+00  1.11530304e+00
  2.06235019e+00  5.76582327e+00  5.76582327e+00  5.76582327e+00
  1.93938748e+01  2.41213439e+01  2.41213439e+01  2.41213439e+01
  9.38134234e+01  1.18568924e+02  1.18568924e+02  1.18568924e+02
  3.56173390e+02  1.34955088e+03  5.83600109e+03  3.50986252e+04]
E1 = -182.1158673758723  E_coul = 53.590959484447154
cycle= 1 E= -128.524907891425  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443502
diis-c [-0.19669359  1.        ]
  HOMO = -0.878616019268569  LUMO = 1.07778148084507
  mo_energy =
[-3.28725324e+01 -1.96110574e+00 -8.78616019e-01 -8.78616019e-01
 -8.78616019e-01  1.07778148e+00  1.07778148e+00  1.07778148e+00
  1.98833908e+00  5.63796312e+00  5.63796312e+00  5.63796312e+00
  1.91771677e+01  2.38875594e+01  2.38875594e+01  2.38875594e+01
  9.35141404e+01  1.18248869e+02  1.18248869e+02  1.18248869e+02
  3.55826340e+02  1.34916547e+03  5.83558381e+03  3.50981863e+04]
E1 = -182.84498249258226  E_coul = 54.317567122549995
cycle= 2 E= -128.527415370032  delta_E= -0.00251  |g|= 0.0994  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219995
diis-c [-5.66250905e-04  3.30585081e-01  6.69414919e-01]
  HOMO = -0.844342522018696  LUMO = 1.09021028089835
  mo_energy =
[-3.27677174e+01 -1.92497880e+00 -8.44342522e-01 -8.44342522e-01
 -8.44342522e-01  1.09021028e+00  1.09021028e+00  1.09021028e+00
  2.01257751e+00  5.67971980e+00  5.67971980e+00  5.67971980e+00
  1.92489378e+01  2.39648612e+01  2.39648612e+01  2.39648612e+01
  9.36130698e+01  1.18353656e+02  1.18353656e+02  1.18353656e+02
  3.55937871e+02  1.34928318e+03  5.83570443e+03  3.50983081e+04]
E1 = -182.60164501133625  E_coul = 54.07339296538481
cycle= 3 E= -128.528252045951  delta_E= -0.000837  |g|= 0.000432  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100479
diis-c [-7.75559677e-08 -2.04594551e-03  2.75022768e-04  1.00177092e+00]
  HOMO = -0.84454593438434  LUMO = 1.09017717461203
  mo_energy =
[-3.27681346e+01 -1.92512899e+00 -8.44545934e-01 -8.44545934e-01
 -8.44545934e-01  1.09017717e+00  1.09017717e+00  1.09017717e+00
  2.01250524e+00  5.67954057e+00  5.67954057e+00  5.67954057e+00
  1.92486702e+01  2.39645526e+01  2.39645526e+01  2.39645526e+01
  9.36126811e+01  1.18353227e+02  1.18353227e+02  1.18353227e+02
  3.55937369e+02  1.34928255e+03  5.83570370e+03  3.50983073e+04]
E1 = -182.60228788710302  E_coul = 54.07403582692716
cycle= 4 E= -128.528252060176  delta_E= -1.42e-08  |g|= 5.88e-05  |ddm|= 8.55e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000140462
diis-c [-4.20041352e-10  2.07538678e-04  4.47520504e-04 -1.53707308e-01
  1.15305225e+00]
  HOMO = -0.844572247970049  LUMO = 1.09016691117621
  mo_energy =
[-3.27681899e+01 -1.92514787e+00 -8.44572248e-01 -8.44572248e-01
 -8.44572248e-01  1.09016691e+00  1.09016691e+00  1.09016691e+00
  2.01249124e+00  5.67950955e+00  5.67950955e+00  5.67950955e+00
  1.92486296e+01  2.39645069e+01  2.39645069e+01  2.39645069e+01
  9.36126280e+01  1.18353171e+02  1.18353171e+02  1.18353171e+02
  3.55937307e+02  1.34928248e+03  5.83570362e+03  3.50983072e+04]
E1 = -182.60241824226028  E_coul = 54.074166181738605
cycle= 5 E= -128.528252060522  delta_E= -3.46e-10  |g|= 3.69e-06  |ddm|= 1.77e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60241824226028  E_coul = 54.074166181738605
  HOMO = -0.844570463539881  LUMO = 1.09016767617386
  mo_energy =
[-3.27681861e+01 -1.92514547e+00 -8.44570464e-01 -8.44570464e-01
 -8.44570464e-01  1.09016768e+00  1.09016768e+00  1.09016768e+00
  2.01249307e+00  5.67951177e+00  5.67951177e+00  5.67951177e+00
  1.92486330e+01  2.39645103e+01  2.39645103e+01  2.39645103e+01
  9.36126318e+01  1.18353175e+02  1.18353175e+02  1.18353175e+02
  3.55937311e+02  1.34928248e+03  5.83570362e+03  3.50983072e+04]
E1 = -182.60240964447334  E_coul = 54.07415758395037
Extra cycle  E= -128.528252060523  delta_E= -1.28e-12  |g|= 1.23e-06  |ddm|= 1.89e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.4557373150345
E1 = -182.60240964447334  E_coul = 54.07415758395037
init E= -128.528252060523
    CPU time for initialize scf      0.15 sec, wall time      0.15 sec
  HOMO = -0.84457107483621  LUMO = 1.09016746596387
  mo_energy =
[-3.27681880e+01 -1.92514601e+00 -8.44571075e-01 -8.44571075e-01
 -8.44571075e-01  1.09016747e+00  1.09016747e+00  1.09016747e+00
  2.01249273e+00  5.67951103e+00  5.67951103e+00  5.67951103e+00
  1.92486317e+01  2.39645089e+01  2.39645089e+01  2.39645089e+01
  9.36126300e+01  1.18353173e+02  1.18353173e+02  1.18353173e+02
  3.55937309e+02  1.34928248e+03  5.83570362e+03  3.50983072e+04]
E1 = -182.60241431268872  E_coul = 54.074162252165934
cycle= 1 E= -128.528252060523  delta_E= 1.71e-13  |g|= 6.45e-07  |ddm|= 4.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60241431268872  E_coul = 54.074162252165934
  HOMO = -0.844570748828504  LUMO = 1.09016758611951
  mo_energy =
[-3.27681870e+01 -1.92514564e+00 -8.44570749e-01 -8.44570749e-01
 -8.44570749e-01  1.09016759e+00  1.09016759e+00  1.09016759e+00
  2.01249298e+00  5.67951143e+00  5.67951143e+00  5.67951143e+00
  1.92486324e+01  2.39645096e+01  2.39645096e+01  2.39645096e+01
  9.36126309e+01  1.18353174e+02  1.18353174e+02  1.18353174e+02
  3.55937310e+02  1.34928248e+03  5.83570362e+03  3.50983072e+04]
E1 = -182.6024120252394  E_coul = 54.0741599647167
Extra cycle  E= -128.528252060523  delta_E= 8.53e-14  |g|= 3.11e-07  |ddm|= 2.71e-07
    CPU time for scf_cycle      0.20 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498494e+02 1.74907218e+02
 2.05233988e+01 5.69536706e+01 4.87632748e-01 7.78421830e+00
 1.65606927e+00 3.67292878e+00 1.23990714e+01 5.45598374e+01
 3.30402917e-01 1.14220824e+00]
grad_E = [-1.16677545e-09  6.13760540e-08 -1.21455517e-06  1.37947097e-05
  3.31377998e-04 -9.28409326e-05  1.75753665e-04 -5.01357458e-04
 -3.40192535e-05  5.43075470e-05 -3.14791981e-05  8.00509059e-07
 -2.30592899e-05 -5.14342607e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682367        1
[INPUT] 0    0    [1    /1   ]  617.498501339        1
[INPUT] 0    0    [1    /1   ]  174.907132069        1
[INPUT] 0    0    [1    /1   ]  20.5210678724        1
[INPUT] 0    0    [1    /1   ]  56.9542507814        1
[INPUT] 0    0    [1    /1   ]  0.488072597464       1
[INPUT] 0    0    [1    /1   ]  7.78757360262        1
[INPUT] 0    0    [1    /1   ]  1.65680236971        1
[INPUT] 1    0    [1    /1   ]  3.66660769834        1
[INPUT] 1    0    [1    /1   ]  12.3739670851        1
[INPUT] 1    0    [1    /1   ]  54.3844852287        1
[INPUT] 1    0    [1    /1   ]  0.330108577826       1
[INPUT] 1    0    [1    /1   ]  1.14062086506        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729975246, 1.0]], [0, [2712.0968236740337, 1.0]], [0, [617.4985013394689, 1.0]], [0, [174.90713206875105, 1.0]], [0, [20.521067872427576, 1.0]], [0, [56.95425078143309, 1.0]], [0, [0.4880725974644545, 1.0]], [0, [7.787573602616581, 1.0]], [0, [1.656802369709872, 1.0]], [1, [3.666607698341548, 1.0]], [1, [12.373967085080848, 1.0]], [1, [54.38448522871341, 1.0]], [1, [0.33010857782569436, 1.0]], [1, [1.140620865063624, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872998]
bas 1, expnt(s) = [2712.09682367]
bas 2, expnt(s) = [617.49850134]
bas 3, expnt(s) = [174.90713207]
bas 4, expnt(s) = [20.52106787]
bas 5, expnt(s) = [56.95425078]
bas 6, expnt(s) = [0.4880726]
bas 7, expnt(s) = [7.7875736]
bas 8, expnt(s) = [1.65680237]
bas 9, expnt(s) = [3.6666077]
bas 10, expnt(s) = [12.37396709]
bas 11, expnt(s) = [54.38448523]
bas 12, expnt(s) = [0.33010858]
bas 13, expnt(s) = [1.14062087]
CPU time:       150.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498501e+02 3.12962250e+02 1.74907132e+02 1.21512418e+02
 2.05210679e+01 2.43593105e+01 5.69542508e+01 5.23792929e+01
 4.88072597e-01 1.47529321e+00 7.78757360e+00 1.17778670e+01
 1.65680237e+00 3.68950459e+00 3.66660770e+00 1.48018143e+01
 1.23739671e+01 6.77049759e+01 5.43844852e+01 4.30852056e+02
 3.30108578e-01 7.29970660e-01 1.14062087e+00 3.43883258e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998032969175393
cond(S) = 238.6183923859232
E1 = -183.574782255424  E_coul = 55.079720573184886
init E= -128.495061682239
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773878449004892  LUMO = 1.11389407774139
  mo_energy =
[-3.25545373e+01 -1.85133269e+00 -7.73878449e-01 -7.73878449e-01
 -7.73878449e-01  1.11389408e+00  1.11389408e+00  1.11389408e+00
  2.06458028e+00  5.75635354e+00  5.75635354e+00  5.75635354e+00
  1.94032792e+01  2.40712350e+01  2.40712350e+01  2.40712350e+01
  9.38252713e+01  1.18197031e+02  1.18197031e+02  1.18197031e+02
  3.56183567e+02  1.34955985e+03  5.83600893e+03  3.50986317e+04]
E1 = -182.1158561312239  E_coul = 53.59094667230311
cycle= 1 E= -128.524909458921  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443604
diis-c [-0.19678413  1.        ]
  HOMO = -0.878610922399396  LUMO = 1.07643206050908
  mo_energy =
[-3.28725405e+01 -1.96112029e+00 -8.78610922e-01 -8.78610922e-01
 -8.78610922e-01  1.07643206e+00  1.07643206e+00  1.07643206e+00
  1.99050448e+00  5.62864827e+00  5.62864827e+00  5.62864827e+00
  1.91865535e+01  2.38376117e+01  2.38376117e+01  2.38376117e+01
  9.35259867e+01  1.17877106e+02  1.17877106e+02  1.17877106e+02
  3.55836517e+02  1.34917445e+03  5.83559165e+03  3.50981928e+04]
E1 = -182.8450240698632  E_coul = 54.3176072065156
cycle= 2 E= -128.527416863348  delta_E= -0.00251  |g|= 0.0994  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.220078
diis-c [-5.66410626e-04  3.30618052e-01  6.69381948e-01]
  HOMO = -0.84433621116096  LUMO = 1.08884128495334
  mo_energy =
[-3.27677249e+01 -1.92499173e+00 -8.44336211e-01 -8.44336211e-01
 -8.44336211e-01  1.08884128e+00  1.08884128e+00  1.08884128e+00
  2.01476112e+00  5.67035577e+00  5.67035577e+00  5.67035577e+00
  1.92583315e+01  2.39148593e+01  2.39148593e+01  2.39148593e+01
  9.36249161e+01  1.17981856e+02  1.17981856e+02  1.17981856e+02
  3.55948049e+02  1.34929216e+03  5.83571228e+03  3.50983145e+04]
E1 = -182.60166097820152  E_coul = 54.07340729926085
cycle= 3 E= -128.528253678941  delta_E= -0.000837  |g|= 0.000428  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000996307
diis-c [-7.52549506e-08 -2.04120526e-03  2.48561681e-04  1.00179264e+00]
  HOMO = -0.84453887466699  LUMO = 1.08880843350603
  mo_energy =
[-3.27681404e+01 -1.92514234e+00 -8.44538875e-01 -8.44538875e-01
 -8.44538875e-01  1.08880843e+00  1.08880843e+00  1.08880843e+00
  2.01468838e+00  5.67017752e+00  5.67017752e+00  5.67017752e+00
  1.92580648e+01  2.39145522e+01  2.39145522e+01  2.39145522e+01
  9.36245291e+01  1.17981429e+02  1.17981429e+02  1.17981429e+02
  3.55947550e+02  1.34929153e+03  5.83571155e+03  3.50983138e+04]
E1 = -182.60229801743407  E_coul = 54.07404432458597
cycle= 4 E= -128.528253692848  delta_E= -1.39e-08  |g|= 5.81e-05  |ddm|= 8.36e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138731
diis-c [-4.09286559e-10  2.02678548e-04  4.44672359e-04 -1.51196173e-01
  1.15054882e+00]
  HOMO = -0.844564993589974  LUMO = 1.08879823685954
  mo_energy =
[-3.27681952e+01 -1.92516131e+00 -8.44564994e-01 -8.44564994e-01
 -8.44564994e-01  1.08879824e+00  1.08879824e+00  1.08879824e+00
  2.01467426e+00  5.67014673e+00  5.67014673e+00  5.67014673e+00
  1.92580243e+01  2.39145068e+01  2.39145068e+01  2.39145068e+01
  9.36244765e+01  1.17981373e+02  1.17981373e+02  1.17981373e+02
  3.55947488e+02  1.34929146e+03  5.83571147e+03  3.50983137e+04]
E1 = -182.60242686860389  E_coul = 54.074173175421855
cycle= 5 E= -128.528253693182  delta_E= -3.34e-10  |g|= 3.61e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60242686860389  E_coul = 54.074173175421855
  HOMO = -0.844563262963896  LUMO = 1.08879897845758
  mo_energy =
[-3.27681915e+01 -1.92515898e+00 -8.44563263e-01 -8.44563263e-01
 -8.44563263e-01  1.08879898e+00  1.08879898e+00  1.08879898e+00
  2.01467605e+00  5.67014889e+00  5.67014889e+00  5.67014889e+00
  1.92580277e+01  2.39145101e+01  2.39145101e+01  2.39145101e+01
  9.36244801e+01  1.17981377e+02  1.17981377e+02  1.17981377e+02
  3.55947492e+02  1.34929146e+03  5.83571147e+03  3.50983137e+04]
E1 = -182.6024185269087  E_coul = 54.074164833725234
Extra cycle  E= -128.528253693183  delta_E= -1.45e-12  |g|= 1.2e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498501e+02 1.74907132e+02
 2.05210679e+01 5.69542508e+01 4.88072597e-01 7.78757360e+00
 1.65680237e+00 3.66660770e+00 1.23739671e+01 5.43844852e+01
 3.30108578e-01 1.14062087e+00]
E = -128.52825369318347
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682367        1
[INPUT] 0    0    [1    /1   ]  617.498501339        1
[INPUT] 0    0    [1    /1   ]  174.907132069        1
[INPUT] 0    0    [1    /1   ]  20.5210678724        1
[INPUT] 0    0    [1    /1   ]  56.9542507814        1
[INPUT] 0    0    [1    /1   ]  0.488072597464       1
[INPUT] 0    0    [1    /1   ]  7.78757360262        1
[INPUT] 0    0    [1    /1   ]  1.65680236971        1
[INPUT] 1    0    [1    /1   ]  3.66660769834        1
[INPUT] 1    0    [1    /1   ]  12.3739670851        1
[INPUT] 1    0    [1    /1   ]  54.3844852287        1
[INPUT] 1    0    [1    /1   ]  0.330108577826       1
[INPUT] 1    0    [1    /1   ]  1.14062086506        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478729975246, 1.0]], [0, [2712.0968236740337, 1.0]], [0, [617.4985013394689, 1.0]], [0, [174.90713206875105, 1.0]], [0, [20.521067872427576, 1.0]], [0, [56.95425078143309, 1.0]], [0, [0.4880725974644545, 1.0]], [0, [7.787573602616581, 1.0]], [0, [1.656802369709872, 1.0]], [1, [3.666607698341548, 1.0]], [1, [12.373967085080848, 1.0]], [1, [54.38448522871341, 1.0]], [1, [0.33010857782569436, 1.0]], [1, [1.140620865063624, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872998]
bas 1, expnt(s) = [2712.09682367]
bas 2, expnt(s) = [617.49850134]
bas 3, expnt(s) = [174.90713207]
bas 4, expnt(s) = [20.52106787]
bas 5, expnt(s) = [56.95425078]
bas 6, expnt(s) = [0.4880726]
bas 7, expnt(s) = [7.7875736]
bas 8, expnt(s) = [1.65680237]
bas 9, expnt(s) = [3.6666077]
bas 10, expnt(s) = [12.37396709]
bas 11, expnt(s) = [54.38448523]
bas 12, expnt(s) = [0.33010858]
bas 13, expnt(s) = [1.14062087]
CPU time:       151.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498501e+02 3.12962250e+02 1.74907132e+02 1.21512418e+02
 2.05210679e+01 2.43593105e+01 5.69542508e+01 5.23792929e+01
 4.88072597e-01 1.47529321e+00 7.78757360e+00 1.17778670e+01
 1.65680237e+00 3.68950459e+00 3.66660770e+00 1.48018143e+01
 1.23739671e+01 6.77049759e+01 5.43844852e+01 4.30852056e+02
 3.30108578e-01 7.29970660e-01 1.14062087e+00 3.43883258e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998032969175393
cond(S) = 238.6183923859232
E1 = -183.574782255424  E_coul = 55.079720573184886
init E= -128.495061682239
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773878449004892  LUMO = 1.11389407774139
  mo_energy =
[-3.25545373e+01 -1.85133269e+00 -7.73878449e-01 -7.73878449e-01
 -7.73878449e-01  1.11389408e+00  1.11389408e+00  1.11389408e+00
  2.06458028e+00  5.75635354e+00  5.75635354e+00  5.75635354e+00
  1.94032792e+01  2.40712350e+01  2.40712350e+01  2.40712350e+01
  9.38252713e+01  1.18197031e+02  1.18197031e+02  1.18197031e+02
  3.56183567e+02  1.34955985e+03  5.83600893e+03  3.50986317e+04]
E1 = -182.1158561312239  E_coul = 53.59094667230311
cycle= 1 E= -128.524909458921  delta_E= -0.0298  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443604
diis-c [-0.19678413  1.        ]
  HOMO = -0.878610922399396  LUMO = 1.07643206050908
  mo_energy =
[-3.28725405e+01 -1.96112029e+00 -8.78610922e-01 -8.78610922e-01
 -8.78610922e-01  1.07643206e+00  1.07643206e+00  1.07643206e+00
  1.99050448e+00  5.62864827e+00  5.62864827e+00  5.62864827e+00
  1.91865535e+01  2.38376117e+01  2.38376117e+01  2.38376117e+01
  9.35259867e+01  1.17877106e+02  1.17877106e+02  1.17877106e+02
  3.55836517e+02  1.34917445e+03  5.83559165e+03  3.50981928e+04]
E1 = -182.8450240698632  E_coul = 54.3176072065156
cycle= 2 E= -128.527416863348  delta_E= -0.00251  |g|= 0.0994  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.220078
diis-c [-5.66410626e-04  3.30618052e-01  6.69381948e-01]
  HOMO = -0.84433621116096  LUMO = 1.08884128495334
  mo_energy =
[-3.27677249e+01 -1.92499173e+00 -8.44336211e-01 -8.44336211e-01
 -8.44336211e-01  1.08884128e+00  1.08884128e+00  1.08884128e+00
  2.01476112e+00  5.67035577e+00  5.67035577e+00  5.67035577e+00
  1.92583315e+01  2.39148593e+01  2.39148593e+01  2.39148593e+01
  9.36249161e+01  1.17981856e+02  1.17981856e+02  1.17981856e+02
  3.55948049e+02  1.34929216e+03  5.83571228e+03  3.50983145e+04]
E1 = -182.60166097820152  E_coul = 54.07340729926085
cycle= 3 E= -128.528253678941  delta_E= -0.000837  |g|= 0.000428  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000996307
diis-c [-7.52549506e-08 -2.04120526e-03  2.48561681e-04  1.00179264e+00]
  HOMO = -0.84453887466699  LUMO = 1.08880843350603
  mo_energy =
[-3.27681404e+01 -1.92514234e+00 -8.44538875e-01 -8.44538875e-01
 -8.44538875e-01  1.08880843e+00  1.08880843e+00  1.08880843e+00
  2.01468838e+00  5.67017752e+00  5.67017752e+00  5.67017752e+00
  1.92580648e+01  2.39145522e+01  2.39145522e+01  2.39145522e+01
  9.36245291e+01  1.17981429e+02  1.17981429e+02  1.17981429e+02
  3.55947550e+02  1.34929153e+03  5.83571155e+03  3.50983138e+04]
E1 = -182.60229801743407  E_coul = 54.07404432458597
cycle= 4 E= -128.528253692848  delta_E= -1.39e-08  |g|= 5.81e-05  |ddm|= 8.36e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138731
diis-c [-4.09286559e-10  2.02678548e-04  4.44672359e-04 -1.51196173e-01
  1.15054882e+00]
  HOMO = -0.844564993589974  LUMO = 1.08879823685954
  mo_energy =
[-3.27681952e+01 -1.92516131e+00 -8.44564994e-01 -8.44564994e-01
 -8.44564994e-01  1.08879824e+00  1.08879824e+00  1.08879824e+00
  2.01467426e+00  5.67014673e+00  5.67014673e+00  5.67014673e+00
  1.92580243e+01  2.39145068e+01  2.39145068e+01  2.39145068e+01
  9.36244765e+01  1.17981373e+02  1.17981373e+02  1.17981373e+02
  3.55947488e+02  1.34929146e+03  5.83571147e+03  3.50983137e+04]
E1 = -182.60242686860389  E_coul = 54.074173175421855
cycle= 5 E= -128.528253693182  delta_E= -3.34e-10  |g|= 3.61e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60242686860389  E_coul = 54.074173175421855
  HOMO = -0.844563262963896  LUMO = 1.08879897845758
  mo_energy =
[-3.27681915e+01 -1.92515898e+00 -8.44563263e-01 -8.44563263e-01
 -8.44563263e-01  1.08879898e+00  1.08879898e+00  1.08879898e+00
  2.01467605e+00  5.67014889e+00  5.67014889e+00  5.67014889e+00
  1.92580277e+01  2.39145101e+01  2.39145101e+01  2.39145101e+01
  9.36244801e+01  1.17981377e+02  1.17981377e+02  1.17981377e+02
  3.55947492e+02  1.34929146e+03  5.83571147e+03  3.50983137e+04]
E1 = -182.6024185269087  E_coul = 54.074164833725234
Extra cycle  E= -128.528253693183  delta_E= -1.45e-12  |g|= 1.2e-06  |ddm|= 1.86e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.6183923859232
E1 = -182.6024185269087  E_coul = 54.074164833725234
init E= -128.528253693183
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.844563856466022  LUMO = 1.08879877482243
  mo_energy =
[-3.27681934e+01 -1.92515949e+00 -8.44563856e-01 -8.44563856e-01
 -8.44563856e-01  1.08879877e+00  1.08879877e+00  1.08879877e+00
  2.01467572e+00  5.67014817e+00  5.67014817e+00  5.67014817e+00
  1.92580264e+01  2.39145088e+01  2.39145088e+01  2.39145088e+01
  9.36244783e+01  1.17981375e+02  1.17981375e+02  1.17981375e+02
  3.55947490e+02  1.34929146e+03  5.83571147e+03  3.50983137e+04]
E1 = -182.6024230596603  E_coul = 54.07416936647705
cycle= 1 E= -128.528253693183  delta_E= 1.99e-13  |g|= 6.27e-07  |ddm|= 4.69e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6024230596603  E_coul = 54.07416936647705
  HOMO = -0.844563539984478  LUMO = 1.08879889131131
  mo_energy =
[-3.27681924e+01 -1.92515914e+00 -8.44563540e-01 -8.44563540e-01
 -8.44563540e-01  1.08879889e+00  1.08879889e+00  1.08879889e+00
  2.01467597e+00  5.67014856e+00  5.67014856e+00  5.67014856e+00
  1.92580271e+01  2.39145095e+01  2.39145095e+01  2.39145095e+01
  9.36244793e+01  1.17981376e+02  1.17981376e+02  1.17981376e+02
  3.55947491e+02  1.34929146e+03  5.83571147e+03  3.50983137e+04]
E1 = -182.60242083919965  E_coul = 54.07416714601611
Extra cycle  E= -128.528253693184  delta_E= -2.84e-13  |g|= 3.01e-07  |ddm|= 2.64e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498501e+02 1.74907132e+02
 2.05210679e+01 5.69542508e+01 4.88072597e-01 7.78757360e+00
 1.65680237e+00 3.66660770e+00 1.23739671e+01 5.43844852e+01
 3.30108578e-01 1.14062087e+00]
grad_E = [-1.07691783e-09  5.66596185e-08 -1.12186102e-06  1.27455143e-05
  3.05608058e-04 -8.58715453e-05  6.44087244e-04 -4.62873748e-04
 -1.02252835e-04 -2.11580924e-05 -9.84255371e-06 -2.99020922e-06
  3.11779609e-05 -6.42469346e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682272        1
[INPUT] 0    0    [1    /1   ]  617.49852005         1
[INPUT] 0    0    [1    /1   ]  174.906917222        1
[INPUT] 0    0    [1    /1   ]  20.5156351903        1
[INPUT] 0    0    [1    /1   ]  56.9556973816        1
[INPUT] 0    0    [1    /1   ]  0.488597711402       1
[INPUT] 0    0    [1    /1   ]  7.79561641124        1
[INPUT] 0    0    [1    /1   ]  1.65756104289        1
[INPUT] 1    0    [1    /1   ]  3.66012069101        1
[INPUT] 1    0    [1    /1   ]  12.3490401561        1
[INPUT] 1    0    [1    /1   ]  54.203176085         1
[INPUT] 1    0    [1    /1   ]  0.329813585659       1
[INPUT] 1    0    [1    /1   ]  1.1389840898         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47872999369, 1.0]], [0, [2712.0968227244803, 1.0]], [0, [617.4985200495149, 1.0]], [0, [174.9069172221333, 1.0]], [0, [20.51563519034652, 1.0]], [0, [56.955697381613966, 1.0]], [0, [0.4885977114019004, 1.0]], [0, [7.7956164112420465, 1.0]], [0, [1.6575610428940994, 1.0]], [1, [3.660120691012495, 1.0]], [1, [12.34904015608069, 1.0]], [1, [54.203176084980974, 1.0]], [1, [0.3298135856591155, 1.0]], [1, [1.1389840897973476, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872999]
bas 1, expnt(s) = [2712.09682272]
bas 2, expnt(s) = [617.49852005]
bas 3, expnt(s) = [174.90691722]
bas 4, expnt(s) = [20.51563519]
bas 5, expnt(s) = [56.95569738]
bas 6, expnt(s) = [0.48859771]
bas 7, expnt(s) = [7.79561641]
bas 8, expnt(s) = [1.65756104]
bas 9, expnt(s) = [3.66012069]
bas 10, expnt(s) = [12.34904016]
bas 11, expnt(s) = [54.20317608]
bas 12, expnt(s) = [0.32981359]
bas 13, expnt(s) = [1.13898409]
CPU time:       154.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498520e+02 3.12962257e+02 1.74906917e+02 1.21512306e+02
 2.05156352e+01 2.43544738e+01 5.69556974e+01 5.23802907e+01
 4.88597711e-01 1.47648349e+00 7.79561641e+00 1.17869888e+01
 1.65756104e+00 3.69077162e+00 3.66012069e+00 1.47690871e+01
 1.23490402e+01 6.75345322e+01 5.42031761e+01 4.29057316e+02
 3.29813586e-01 7.29155354e-01 1.13898409e+00 3.43266534e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99803994890288
cond(S) = 238.92942327140184
E1 = -183.57476038679337  E_coul = 55.07972874582284
init E= -128.495031640971
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77387652384179  LUMO = 1.11247027724462
  mo_energy =
[-3.25545369e+01 -1.85133579e+00 -7.73876524e-01 -7.73876524e-01
 -7.73876524e-01  1.11247028e+00  1.11247028e+00  1.11247028e+00
  2.06722663e+00  5.74662732e+00  5.74662732e+00  5.74662732e+00
  1.94194585e+01  2.40207105e+01  2.40207105e+01  2.40207105e+01
  9.38478855e+01  1.17816086e+02  1.17816086e+02  1.17816086e+02
  3.56203178e+02  1.34957725e+03  5.83602416e+03  3.50986443e+04]
E1 = -182.11595963074396  E_coul = 53.59104629981917
cycle= 1 E= -128.524913330925  delta_E= -0.0299  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443658
diis-c [-0.19683234  1.        ]
  HOMO = -0.878595933007618  LUMO = 1.07507236623144
  mo_energy =
[-3.28725257e+01 -1.96113180e+00 -8.78595933e-01 -8.78595933e-01
 -8.78595933e-01  1.07507237e+00  1.07507237e+00  1.07507237e+00
  1.99307770e+00  5.61909302e+00  5.61909302e+00  5.61909302e+00
  1.92027057e+01  2.37872643e+01  2.37872643e+01  2.37872643e+01
  9.35486211e+01  1.17496323e+02  1.17496323e+02  1.17496323e+02
  3.55856156e+02  1.34919189e+03  5.83560692e+03  3.50982054e+04]
E1 = -182.8451120161402  E_coul = 54.31769177928973
cycle= 2 E= -128.52742023685  delta_E= -0.00251  |g|= 0.0994  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.220141
diis-c [-5.66672812e-04  3.30654573e-01  6.69345427e-01]
  HOMO = -0.844323405349547  LUMO = 1.08746035274796
  mo_energy =
[-3.27677200e+01 -1.92500526e+00 -8.44323405e-01 -8.44323405e-01
 -8.44323405e-01  1.08746035e+00  1.08746035e+00  1.08746035e+00
  2.01735400e+00  5.66074580e+00  5.66074580e+00  5.66074580e+00
  1.92744931e+01  2.38644502e+01  2.38644502e+01  2.38644502e+01
  9.36475409e+01  1.17601024e+02  1.17601024e+02  1.17601024e+02
  3.55967677e+02  1.34930958e+03  5.83572754e+03  3.50983272e+04]
E1 = -182.6017489355511  E_coul = 54.07349190289459
cycle= 3 E= -128.528257032656  delta_E= -0.000837  |g|= 0.000424  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985077
diis-c [-7.23947637e-08 -2.03564478e-03  2.12588816e-04  1.00182306e+00]
  HOMO = -0.844525036381852  LUMO = 1.08742783875387
  mo_energy =
[-3.27681331e+01 -1.92515629e+00 -8.44525036e-01 -8.44525036e-01
 -8.44525036e-01  1.08742784e+00  1.08742784e+00  1.08742784e+00
  2.01728075e+00  5.66056885e+00  5.66056885e+00  5.66056885e+00
  1.92742276e+01  2.38641449e+01  2.38641449e+01  2.38641449e+01
  9.36471562e+01  1.17600600e+02  1.17600600e+02  1.17600600e+02
  3.55967181e+02  1.34930896e+03  5.83572681e+03  3.50983264e+04]
E1 = -182.60237834732658  E_coul = 54.07412130115921
cycle= 4 E= -128.528257046167  delta_E= -1.35e-08  |g|= 5.71e-05  |ddm|= 8.13e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136492
diis-c [-3.95885849e-10  1.96685354e-04  4.41114331e-04 -1.48048068e-01
  1.14741027e+00]
  HOMO = -0.844550892484735  LUMO = 1.08741773063769
  mo_energy =
[-3.27681872e+01 -1.92517535e+00 -8.44550892e-01 -8.44550892e-01
 -8.44550892e-01  1.08741773e+00  1.08741773e+00  1.08741773e+00
  2.01726653e+00  5.66053838e+00  5.66053838e+00  5.66053838e+00
  1.92741874e+01  2.38641001e+01  2.38641001e+01  2.38641001e+01
  9.36471042e+01  1.17600545e+02  1.17600545e+02  1.17600545e+02
  3.55967120e+02  1.34930889e+03  5.83572674e+03  3.50983263e+04]
E1 = -182.6025052421817  E_coul = 54.07424819569439
cycle= 5 E= -128.528257046487  delta_E= -3.2e-10  |g|= 3.5e-06  |ddm|= 1.64e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6025052421817  E_coul = 54.07424819569439
  HOMO = -0.844549230536178  LUMO = 1.08741844265185
  mo_energy =
[-3.27681836e+01 -1.92517309e+00 -8.44549231e-01 -8.44549231e-01
 -8.44549231e-01  1.08741844e+00  1.08741844e+00  1.08741844e+00
  2.01726826e+00  5.66054044e+00  5.66054044e+00  5.66054044e+00
  1.92741907e+01  2.38641032e+01  2.38641032e+01  2.38641032e+01
  9.36471077e+01  1.17600549e+02  1.17600549e+02  1.17600549e+02
  3.55967123e+02  1.34930889e+03  5.83572674e+03  3.50983263e+04]
E1 = -182.6024972264486  E_coul = 54.07424017996023
Extra cycle  E= -128.528257046488  delta_E= -1.05e-12  |g|= 1.15e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498520e+02 1.74906917e+02
 2.05156352e+01 5.69556974e+01 4.88597711e-01 7.79561641e+00
 1.65756104e+00 3.66012069e+00 1.23490402e+01 5.42031761e+01
 3.29813586e-01 1.13898409e+00]
E = -128.52825704648836
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682272        1
[INPUT] 0    0    [1    /1   ]  617.49852005         1
[INPUT] 0    0    [1    /1   ]  174.906917222        1
[INPUT] 0    0    [1    /1   ]  20.5156351903        1
[INPUT] 0    0    [1    /1   ]  56.9556973816        1
[INPUT] 0    0    [1    /1   ]  0.488597711402       1
[INPUT] 0    0    [1    /1   ]  7.79561641124        1
[INPUT] 0    0    [1    /1   ]  1.65756104289        1
[INPUT] 1    0    [1    /1   ]  3.66012069101        1
[INPUT] 1    0    [1    /1   ]  12.3490401561        1
[INPUT] 1    0    [1    /1   ]  54.203176085         1
[INPUT] 1    0    [1    /1   ]  0.329813585659       1
[INPUT] 1    0    [1    /1   ]  1.1389840898         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47872999369, 1.0]], [0, [2712.0968227244803, 1.0]], [0, [617.4985200495149, 1.0]], [0, [174.9069172221333, 1.0]], [0, [20.51563519034652, 1.0]], [0, [56.955697381613966, 1.0]], [0, [0.4885977114019004, 1.0]], [0, [7.7956164112420465, 1.0]], [0, [1.6575610428940994, 1.0]], [1, [3.660120691012495, 1.0]], [1, [12.34904015608069, 1.0]], [1, [54.203176084980974, 1.0]], [1, [0.3298135856591155, 1.0]], [1, [1.1389840897973476, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872999]
bas 1, expnt(s) = [2712.09682272]
bas 2, expnt(s) = [617.49852005]
bas 3, expnt(s) = [174.90691722]
bas 4, expnt(s) = [20.51563519]
bas 5, expnt(s) = [56.95569738]
bas 6, expnt(s) = [0.48859771]
bas 7, expnt(s) = [7.79561641]
bas 8, expnt(s) = [1.65756104]
bas 9, expnt(s) = [3.66012069]
bas 10, expnt(s) = [12.34904016]
bas 11, expnt(s) = [54.20317608]
bas 12, expnt(s) = [0.32981359]
bas 13, expnt(s) = [1.13898409]
CPU time:       155.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498520e+02 3.12962257e+02 1.74906917e+02 1.21512306e+02
 2.05156352e+01 2.43544738e+01 5.69556974e+01 5.23802907e+01
 4.88597711e-01 1.47648349e+00 7.79561641e+00 1.17869888e+01
 1.65756104e+00 3.69077162e+00 3.66012069e+00 1.47690871e+01
 1.23490402e+01 6.75345322e+01 5.42031761e+01 4.29057316e+02
 3.29813586e-01 7.29155354e-01 1.13898409e+00 3.43266534e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99803994890288
cond(S) = 238.92942327140184
E1 = -183.57476038679337  E_coul = 55.07972874582284
init E= -128.495031640971
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77387652384179  LUMO = 1.11247027724462
  mo_energy =
[-3.25545369e+01 -1.85133579e+00 -7.73876524e-01 -7.73876524e-01
 -7.73876524e-01  1.11247028e+00  1.11247028e+00  1.11247028e+00
  2.06722663e+00  5.74662732e+00  5.74662732e+00  5.74662732e+00
  1.94194585e+01  2.40207105e+01  2.40207105e+01  2.40207105e+01
  9.38478855e+01  1.17816086e+02  1.17816086e+02  1.17816086e+02
  3.56203178e+02  1.34957725e+03  5.83602416e+03  3.50986443e+04]
E1 = -182.11595963074396  E_coul = 53.59104629981917
cycle= 1 E= -128.524913330925  delta_E= -0.0299  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443658
diis-c [-0.19683234  1.        ]
  HOMO = -0.878595933007618  LUMO = 1.07507236623144
  mo_energy =
[-3.28725257e+01 -1.96113180e+00 -8.78595933e-01 -8.78595933e-01
 -8.78595933e-01  1.07507237e+00  1.07507237e+00  1.07507237e+00
  1.99307770e+00  5.61909302e+00  5.61909302e+00  5.61909302e+00
  1.92027057e+01  2.37872643e+01  2.37872643e+01  2.37872643e+01
  9.35486211e+01  1.17496323e+02  1.17496323e+02  1.17496323e+02
  3.55856156e+02  1.34919189e+03  5.83560692e+03  3.50982054e+04]
E1 = -182.8451120161402  E_coul = 54.31769177928973
cycle= 2 E= -128.52742023685  delta_E= -0.00251  |g|= 0.0994  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.220141
diis-c [-5.66672812e-04  3.30654573e-01  6.69345427e-01]
  HOMO = -0.844323405349547  LUMO = 1.08746035274796
  mo_energy =
[-3.27677200e+01 -1.92500526e+00 -8.44323405e-01 -8.44323405e-01
 -8.44323405e-01  1.08746035e+00  1.08746035e+00  1.08746035e+00
  2.01735400e+00  5.66074580e+00  5.66074580e+00  5.66074580e+00
  1.92744931e+01  2.38644502e+01  2.38644502e+01  2.38644502e+01
  9.36475409e+01  1.17601024e+02  1.17601024e+02  1.17601024e+02
  3.55967677e+02  1.34930958e+03  5.83572754e+03  3.50983272e+04]
E1 = -182.6017489355511  E_coul = 54.07349190289459
cycle= 3 E= -128.528257032656  delta_E= -0.000837  |g|= 0.000424  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985077
diis-c [-7.23947637e-08 -2.03564478e-03  2.12588816e-04  1.00182306e+00]
  HOMO = -0.844525036381852  LUMO = 1.08742783875387
  mo_energy =
[-3.27681331e+01 -1.92515629e+00 -8.44525036e-01 -8.44525036e-01
 -8.44525036e-01  1.08742784e+00  1.08742784e+00  1.08742784e+00
  2.01728075e+00  5.66056885e+00  5.66056885e+00  5.66056885e+00
  1.92742276e+01  2.38641449e+01  2.38641449e+01  2.38641449e+01
  9.36471562e+01  1.17600600e+02  1.17600600e+02  1.17600600e+02
  3.55967181e+02  1.34930896e+03  5.83572681e+03  3.50983264e+04]
E1 = -182.60237834732658  E_coul = 54.07412130115921
cycle= 4 E= -128.528257046167  delta_E= -1.35e-08  |g|= 5.71e-05  |ddm|= 8.13e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136492
diis-c [-3.95885849e-10  1.96685354e-04  4.41114331e-04 -1.48048068e-01
  1.14741027e+00]
  HOMO = -0.844550892484735  LUMO = 1.08741773063769
  mo_energy =
[-3.27681872e+01 -1.92517535e+00 -8.44550892e-01 -8.44550892e-01
 -8.44550892e-01  1.08741773e+00  1.08741773e+00  1.08741773e+00
  2.01726653e+00  5.66053838e+00  5.66053838e+00  5.66053838e+00
  1.92741874e+01  2.38641001e+01  2.38641001e+01  2.38641001e+01
  9.36471042e+01  1.17600545e+02  1.17600545e+02  1.17600545e+02
  3.55967120e+02  1.34930889e+03  5.83572674e+03  3.50983263e+04]
E1 = -182.6025052421817  E_coul = 54.07424819569439
cycle= 5 E= -128.528257046487  delta_E= -3.2e-10  |g|= 3.5e-06  |ddm|= 1.64e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.6025052421817  E_coul = 54.07424819569439
  HOMO = -0.844549230536178  LUMO = 1.08741844265185
  mo_energy =
[-3.27681836e+01 -1.92517309e+00 -8.44549231e-01 -8.44549231e-01
 -8.44549231e-01  1.08741844e+00  1.08741844e+00  1.08741844e+00
  2.01726826e+00  5.66054044e+00  5.66054044e+00  5.66054044e+00
  1.92741907e+01  2.38641032e+01  2.38641032e+01  2.38641032e+01
  9.36471077e+01  1.17600549e+02  1.17600549e+02  1.17600549e+02
  3.55967123e+02  1.34930889e+03  5.83572674e+03  3.50983263e+04]
E1 = -182.6024972264486  E_coul = 54.07424017996023
Extra cycle  E= -128.528257046488  delta_E= -1.05e-12  |g|= 1.15e-06  |ddm|= 1.82e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.92942327140184
E1 = -182.6024972264486  E_coul = 54.07424017996023
init E= -128.528257046488
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.844549801379481  LUMO = 1.08741824725859
  mo_energy =
[-3.27681854e+01 -1.92517359e+00 -8.44549801e-01 -8.44549801e-01
 -8.44549801e-01  1.08741825e+00  1.08741825e+00  1.08741825e+00
  2.01726795e+00  5.66053976e+00  5.66053976e+00  5.66053976e+00
  1.92741895e+01  2.38641019e+01  2.38641019e+01  2.38641019e+01
  9.36471060e+01  1.17600547e+02  1.17600547e+02  1.17600547e+02
  3.55967121e+02  1.34930889e+03  5.83572674e+03  3.50983263e+04]
E1 = -182.6025015860947  E_coul = 54.07424453960623
cycle= 1 E= -128.528257046488  delta_E= -1.14e-13  |g|= 6.03e-07  |ddm|= 4.52e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6025015860947  E_coul = 54.07424453960623
  HOMO = -0.844549497070595  LUMO = 1.08741835912032
  mo_energy =
[-3.27681845e+01 -1.92517324e+00 -8.44549497e-01 -8.44549497e-01
 -8.44549497e-01  1.08741836e+00  1.08741836e+00  1.08741836e+00
  2.01726818e+00  5.66054013e+00  5.66054013e+00  5.66054013e+00
  1.92741901e+01  2.38641026e+01  2.38641026e+01  2.38641026e+01
  9.36471069e+01  1.17600548e+02  1.17600548e+02  1.17600548e+02
  3.55967122e+02  1.34930889e+03  5.83572674e+03  3.50983263e+04]
E1 = -182.60249945121717  E_coul = 54.07424240472887
Extra cycle  E= -128.528257046488  delta_E= 1.71e-13  |g|= 2.9e-07  |ddm|= 2.54e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498520e+02 1.74906917e+02
 2.05156352e+01 5.69556974e+01 4.88597711e-01 7.79561641e+00
 1.65756104e+00 3.66012069e+00 1.23490402e+01 5.42031761e+01
 3.29813586e-01 1.13898409e+00]
grad_E = [-8.62707348e-10  4.54233314e-08 -9.00856037e-07  1.02478048e-05
  2.44251997e-04 -6.92379564e-05  1.19562186e-03 -3.69643644e-04
 -1.79001755e-04 -1.18231608e-04  1.89976707e-05 -7.45394878e-06
  1.15136581e-04  5.08837697e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682095        1
[INPUT] 0    0    [1    /1   ]  617.498555162        1
[INPUT] 0    0    [1    /1   ]  174.906517755        1
[INPUT] 0    0    [1    /1   ]  20.5059650241        1
[INPUT] 0    0    [1    /1   ]  56.9583859058        1
[INPUT] 0    0    [1    /1   ]  0.488876768427       1
[INPUT] 0    0    [1    /1   ]  7.81019381676        1
[INPUT] 0    0    [1    /1   ]  1.65761930269        1
[INPUT] 1    0    [1    /1   ]  3.65855673485        1
[INPUT] 1    0    [1    /1   ]  12.3448555603        1
[INPUT] 1    0    [1    /1   ]  54.1508100942        1
[INPUT] 1    0    [1    /1   ]  0.329749641084       1
[INPUT] 1    0    [1    /1   ]  1.1385578422         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730027557, 1.0]], [0, [2712.0968209489433, 1.0]], [0, [617.4985551624778, 1.0]], [0, [174.90651775523037, 1.0]], [0, [20.505965024088407, 1.0]], [0, [56.95838590576723, 1.0]], [0, [0.488876768426961, 1.0]], [0, [7.81019381676233, 1.0]], [0, [1.6576193026911192, 1.0]], [1, [3.6585567348534522, 1.0]], [1, [12.344855560297432, 1.0]], [1, [54.15081009417139, 1.0]], [1, [0.329749641083652, 1.0]], [1, [1.1385578422034883, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682095]
bas 2, expnt(s) = [617.49855516]
bas 3, expnt(s) = [174.90651776]
bas 4, expnt(s) = [20.50596502]
bas 5, expnt(s) = [56.95838591]
bas 6, expnt(s) = [0.48887677]
bas 7, expnt(s) = [7.81019382]
bas 8, expnt(s) = [1.6576193]
bas 9, expnt(s) = [3.65855673]
bas 10, expnt(s) = [12.34485556]
bas 11, expnt(s) = [54.15081009]
bas 12, expnt(s) = [0.32974964]
bas 13, expnt(s) = [1.13855784]
CPU time:       158.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498555e+02 3.12962270e+02 1.74906518e+02 1.21512098e+02
 2.05059650e+01 2.43458635e+01 5.69583859e+01 5.23821451e+01
 4.88876768e-01 1.47711590e+00 7.81019382e+00 1.18035157e+01
 1.65761930e+00 3.69086891e+00 3.65855673e+00 1.47611990e+01
 1.23448556e+01 6.75059275e+01 5.41508101e+01 4.28539235e+02
 3.29749641e-01 7.28978646e-01 1.13855784e+00 3.43105963e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998041357971466
cond(S) = 239.39187539475728
E1 = -183.5747049506473  E_coul = 55.07974390284758
init E= -128.4949610478
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773874286333374  LUMO = 1.11214527152504
  mo_energy =
[-3.25545296e+01 -1.85134348e+00 -7.73874286e-01 -7.73874286e-01
 -7.73874286e-01  1.11214527e+00  1.11214527e+00  1.11214527e+00
  2.06854751e+00  5.74418059e+00  5.74418059e+00  5.74418059e+00
  1.94404816e+01  2.40103933e+01  2.40103933e+01  2.40103933e+01
  9.38812607e+01  1.17716618e+02  1.17716618e+02  1.17716618e+02
  3.56232384e+02  1.34960333e+03  5.83604703e+03  3.50986632e+04]
E1 = -182.1162346569256  E_coul = 53.59131462090078
cycle= 1 E= -128.524920036025  delta_E= -0.03  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443552
diis-c [-0.19673862  1.        ]
  HOMO = -0.878571428212354  LUMO = 1.07476985399229
  mo_energy =
[-3.28724689e+01 -1.96113024e+00 -8.78571428e-01 -8.78571428e-01
 -8.78571428e-01  1.07476985e+00  1.07476985e+00  1.07476985e+00
  1.99436592e+00  5.61671393e+00  5.61671393e+00  5.61671393e+00
  1.92236921e+01  2.37770143e+01  2.37770143e+01  2.37770143e+01
  9.35820508e+01  1.17396959e+02  1.17396959e+02  1.17396959e+02
  3.55885430e+02  1.34921806e+03  5.83562988e+03  3.50982244e+04]
E1 = -182.8452277391462  E_coul = 54.317801896429536
cycle= 2 E= -128.527425842717  delta_E= -0.00251  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.220107
diis-c [-5.67019656e-04  3.30672369e-01  6.69327631e-01]
  HOMO = -0.844307162565028  LUMO = 1.08714986054347
  mo_energy =
[-3.27676892e+01 -1.92501251e+00 -8.44307163e-01 -8.44307163e-01
 -8.44307163e-01  1.08714986e+00  1.08714986e+00  1.08714986e+00
  2.01864853e+00  5.65834392e+00  5.65834392e+00  5.65834392e+00
  1.92954887e+01  2.38541710e+01  2.38541710e+01  2.38541710e+01
  9.36809462e+01  1.17501622e+02  1.17501622e+02  1.17501622e+02
  3.55996923e+02  1.34933572e+03  5.83575047e+03  3.50983461e+04]
E1 = -182.60192286479037  E_coul = 54.07366059428983
cycle= 3 E= -128.528262270501  delta_E= -0.000836  |g|= 0.000421  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000975934
diis-c [-7.03508318e-08 -2.03244409e-03  1.81481284e-04  1.00185096e+00]
  HOMO = -0.844507873558381  LUMO = 1.08711762734541
  mo_energy =
[-3.27681002e+01 -1.92516358e+00 -8.44507874e-01 -8.44507874e-01
 -8.44507874e-01  1.08711763e+00  1.08711763e+00  1.08711763e+00
  2.01857513e+00  5.65816804e+00  5.65816804e+00  5.65816804e+00
  1.92952244e+01  2.38538673e+01  2.38538673e+01  2.38538673e+01
  9.36805636e+01  1.17501200e+02  1.17501200e+02  1.17501200e+02
  3.55996429e+02  1.34933510e+03  5.83574975e+03  3.50983453e+04]
E1 = -182.60254620531805  E_coul = 54.074283921599545
cycle= 4 E= -128.528262283719  delta_E= -1.32e-08  |g|= 5.64e-05  |ddm|= 7.98e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134799
diis-c [-3.87232460e-10  1.92889921e-04  4.39015889e-04 -1.45961612e-01
  1.14532971e+00]
  HOMO = -0.844533510509351  LUMO = 1.08710759051119
  mo_energy =
[-3.27681538e+01 -1.92518265e+00 -8.44533511e-01 -8.44533511e-01
 -8.44533511e-01  1.08710759e+00  1.08710759e+00  1.08710759e+00
  2.01856088e+00  5.65813781e+00  5.65813781e+00  5.65813781e+00
  1.92951845e+01  2.38538229e+01  2.38538229e+01  2.38538229e+01
  9.36805122e+01  1.17501146e+02  1.17501146e+02  1.17501146e+02
  3.55996370e+02  1.34933504e+03  5.83574967e+03  3.50983453e+04]
E1 = -182.60267160631474  E_coul = 54.074409322285746
cycle= 5 E= -128.528262284029  delta_E= -3.1e-10  |g|= 3.43e-06  |ddm|= 1.59e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60267160631474  E_coul = 54.074409322285746
  HOMO = -0.844531897485539  LUMO = 1.08710828202676
  mo_energy =
[-3.27681503e+01 -1.92518044e+00 -8.44531897e-01 -8.44531897e-01
 -8.44531897e-01  1.08710828e+00  1.08710828e+00  1.08710828e+00
  2.01856256e+00  5.65813982e+00  5.65813982e+00  5.65813982e+00
  1.92951877e+01  2.38538259e+01  2.38538259e+01  2.38538259e+01
  9.36805156e+01  1.17501149e+02  1.17501149e+02  1.17501149e+02
  3.55996373e+02  1.34933504e+03  5.83574968e+03  3.50983453e+04]
E1 = -182.6026638258446  E_coul = 54.0744015418147
Extra cycle  E= -128.52826228403  delta_E= -9.09e-13  |g|= 1.12e-06  |ddm|= 1.78e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498555e+02 1.74906518e+02
 2.05059650e+01 5.69583859e+01 4.88876768e-01 7.81019382e+00
 1.65761930e+00 3.65855673e+00 1.23448556e+01 5.41508101e+01
 3.29749641e-01 1.13855784e+00]
E = -128.5282622840299
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682095        1
[INPUT] 0    0    [1    /1   ]  617.498555162        1
[INPUT] 0    0    [1    /1   ]  174.906517755        1
[INPUT] 0    0    [1    /1   ]  20.5059650241        1
[INPUT] 0    0    [1    /1   ]  56.9583859058        1
[INPUT] 0    0    [1    /1   ]  0.488876768427       1
[INPUT] 0    0    [1    /1   ]  7.81019381676        1
[INPUT] 0    0    [1    /1   ]  1.65761930269        1
[INPUT] 1    0    [1    /1   ]  3.65855673485        1
[INPUT] 1    0    [1    /1   ]  12.3448555603        1
[INPUT] 1    0    [1    /1   ]  54.1508100942        1
[INPUT] 1    0    [1    /1   ]  0.329749641084       1
[INPUT] 1    0    [1    /1   ]  1.1385578422         1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730027557, 1.0]], [0, [2712.0968209489433, 1.0]], [0, [617.4985551624778, 1.0]], [0, [174.90651775523037, 1.0]], [0, [20.505965024088407, 1.0]], [0, [56.95838590576723, 1.0]], [0, [0.488876768426961, 1.0]], [0, [7.81019381676233, 1.0]], [0, [1.6576193026911192, 1.0]], [1, [3.6585567348534522, 1.0]], [1, [12.344855560297432, 1.0]], [1, [54.15081009417139, 1.0]], [1, [0.329749641083652, 1.0]], [1, [1.1385578422034883, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873003]
bas 1, expnt(s) = [2712.09682095]
bas 2, expnt(s) = [617.49855516]
bas 3, expnt(s) = [174.90651776]
bas 4, expnt(s) = [20.50596502]
bas 5, expnt(s) = [56.95838591]
bas 6, expnt(s) = [0.48887677]
bas 7, expnt(s) = [7.81019382]
bas 8, expnt(s) = [1.6576193]
bas 9, expnt(s) = [3.65855673]
bas 10, expnt(s) = [12.34485556]
bas 11, expnt(s) = [54.15081009]
bas 12, expnt(s) = [0.32974964]
bas 13, expnt(s) = [1.13855784]
CPU time:       158.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498555e+02 3.12962270e+02 1.74906518e+02 1.21512098e+02
 2.05059650e+01 2.43458635e+01 5.69583859e+01 5.23821451e+01
 4.88876768e-01 1.47711590e+00 7.81019382e+00 1.18035157e+01
 1.65761930e+00 3.69086891e+00 3.65855673e+00 1.47611990e+01
 1.23448556e+01 6.75059275e+01 5.41508101e+01 4.28539235e+02
 3.29749641e-01 7.28978646e-01 1.13855784e+00 3.43105963e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998041357971466
cond(S) = 239.39187539475728
E1 = -183.5747049506473  E_coul = 55.07974390284758
init E= -128.4949610478
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773874286333374  LUMO = 1.11214527152504
  mo_energy =
[-3.25545296e+01 -1.85134348e+00 -7.73874286e-01 -7.73874286e-01
 -7.73874286e-01  1.11214527e+00  1.11214527e+00  1.11214527e+00
  2.06854751e+00  5.74418059e+00  5.74418059e+00  5.74418059e+00
  1.94404816e+01  2.40103933e+01  2.40103933e+01  2.40103933e+01
  9.38812607e+01  1.17716618e+02  1.17716618e+02  1.17716618e+02
  3.56232384e+02  1.34960333e+03  5.83604703e+03  3.50986632e+04]
E1 = -182.1162346569256  E_coul = 53.59131462090078
cycle= 1 E= -128.524920036025  delta_E= -0.03  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443552
diis-c [-0.19673862  1.        ]
  HOMO = -0.878571428212354  LUMO = 1.07476985399229
  mo_energy =
[-3.28724689e+01 -1.96113024e+00 -8.78571428e-01 -8.78571428e-01
 -8.78571428e-01  1.07476985e+00  1.07476985e+00  1.07476985e+00
  1.99436592e+00  5.61671393e+00  5.61671393e+00  5.61671393e+00
  1.92236921e+01  2.37770143e+01  2.37770143e+01  2.37770143e+01
  9.35820508e+01  1.17396959e+02  1.17396959e+02  1.17396959e+02
  3.55885430e+02  1.34921806e+03  5.83562988e+03  3.50982244e+04]
E1 = -182.8452277391462  E_coul = 54.317801896429536
cycle= 2 E= -128.527425842717  delta_E= -0.00251  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.220107
diis-c [-5.67019656e-04  3.30672369e-01  6.69327631e-01]
  HOMO = -0.844307162565028  LUMO = 1.08714986054347
  mo_energy =
[-3.27676892e+01 -1.92501251e+00 -8.44307163e-01 -8.44307163e-01
 -8.44307163e-01  1.08714986e+00  1.08714986e+00  1.08714986e+00
  2.01864853e+00  5.65834392e+00  5.65834392e+00  5.65834392e+00
  1.92954887e+01  2.38541710e+01  2.38541710e+01  2.38541710e+01
  9.36809462e+01  1.17501622e+02  1.17501622e+02  1.17501622e+02
  3.55996923e+02  1.34933572e+03  5.83575047e+03  3.50983461e+04]
E1 = -182.60192286479037  E_coul = 54.07366059428983
cycle= 3 E= -128.528262270501  delta_E= -0.000836  |g|= 0.000421  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000975934
diis-c [-7.03508318e-08 -2.03244409e-03  1.81481284e-04  1.00185096e+00]
  HOMO = -0.844507873558381  LUMO = 1.08711762734541
  mo_energy =
[-3.27681002e+01 -1.92516358e+00 -8.44507874e-01 -8.44507874e-01
 -8.44507874e-01  1.08711763e+00  1.08711763e+00  1.08711763e+00
  2.01857513e+00  5.65816804e+00  5.65816804e+00  5.65816804e+00
  1.92952244e+01  2.38538673e+01  2.38538673e+01  2.38538673e+01
  9.36805636e+01  1.17501200e+02  1.17501200e+02  1.17501200e+02
  3.55996429e+02  1.34933510e+03  5.83574975e+03  3.50983453e+04]
E1 = -182.60254620531805  E_coul = 54.074283921599545
cycle= 4 E= -128.528262283719  delta_E= -1.32e-08  |g|= 5.64e-05  |ddm|= 7.98e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000134799
diis-c [-3.87232460e-10  1.92889921e-04  4.39015889e-04 -1.45961612e-01
  1.14532971e+00]
  HOMO = -0.844533510509351  LUMO = 1.08710759051119
  mo_energy =
[-3.27681538e+01 -1.92518265e+00 -8.44533511e-01 -8.44533511e-01
 -8.44533511e-01  1.08710759e+00  1.08710759e+00  1.08710759e+00
  2.01856088e+00  5.65813781e+00  5.65813781e+00  5.65813781e+00
  1.92951845e+01  2.38538229e+01  2.38538229e+01  2.38538229e+01
  9.36805122e+01  1.17501146e+02  1.17501146e+02  1.17501146e+02
  3.55996370e+02  1.34933504e+03  5.83574967e+03  3.50983453e+04]
E1 = -182.60267160631474  E_coul = 54.074409322285746
cycle= 5 E= -128.528262284029  delta_E= -3.1e-10  |g|= 3.43e-06  |ddm|= 1.59e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60267160631474  E_coul = 54.074409322285746
  HOMO = -0.844531897485539  LUMO = 1.08710828202676
  mo_energy =
[-3.27681503e+01 -1.92518044e+00 -8.44531897e-01 -8.44531897e-01
 -8.44531897e-01  1.08710828e+00  1.08710828e+00  1.08710828e+00
  2.01856256e+00  5.65813982e+00  5.65813982e+00  5.65813982e+00
  1.92951877e+01  2.38538259e+01  2.38538259e+01  2.38538259e+01
  9.36805156e+01  1.17501149e+02  1.17501149e+02  1.17501149e+02
  3.55996373e+02  1.34933504e+03  5.83574968e+03  3.50983453e+04]
E1 = -182.6026638258446  E_coul = 54.0744015418147
Extra cycle  E= -128.52826228403  delta_E= -9.09e-13  |g|= 1.12e-06  |ddm|= 1.78e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.39187539475728
E1 = -182.6026638258446  E_coul = 54.0744015418147
init E= -128.52826228403
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.844532451979211  LUMO = 1.08710809240403
  mo_energy =
[-3.27681521e+01 -1.92518093e+00 -8.44532452e-01 -8.44532452e-01
 -8.44532452e-01  1.08710809e+00  1.08710809e+00  1.08710809e+00
  2.01856226e+00  5.65813915e+00  5.65813915e+00  5.65813915e+00
  1.92951865e+01  2.38538247e+01  2.38538247e+01  2.38538247e+01
  9.36805139e+01  1.17501148e+02  1.17501148e+02  1.17501148e+02
  3.55996371e+02  1.34933504e+03  5.83574967e+03  3.50983453e+04]
E1 = -182.60266806021792  E_coul = 54.074405776187696
cycle= 1 E= -128.52826228403  delta_E= -3.41e-13  |g|= 5.86e-07  |ddm|= 4.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60266806021792  E_coul = 54.074405776187696
  HOMO = -0.844532156484562  LUMO = 1.08710820100751
  mo_energy =
[-3.27681512e+01 -1.92518059e+00 -8.44532156e-01 -8.44532156e-01
 -8.44532156e-01  1.08710820e+00  1.08710820e+00  1.08710820e+00
  2.01856249e+00  5.65813952e+00  5.65813952e+00  5.65813952e+00
  1.92951871e+01  2.38538253e+01  2.38538253e+01  2.38538253e+01
  9.36805148e+01  1.17501149e+02  1.17501149e+02  1.17501149e+02
  3.55996372e+02  1.34933504e+03  5.83574967e+03  3.50983453e+04]
E1 = -182.60266598733767  E_coul = 54.07440370330767
Extra cycle  E= -128.52826228403  delta_E= 2.27e-13  |g|= 2.81e-07  |ddm|= 2.47e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498555e+02 1.74906518e+02
 2.05059650e+01 5.69583859e+01 4.88876768e-01 7.81019382e+00
 1.65761930e+00 3.65855673e+00 1.23448556e+01 5.41508101e+01
 3.29749641e-01 1.13855784e+00]
grad_E = [-4.76167802e-10  2.51655688e-08 -5.01936029e-07  5.74884567e-06
  1.33967567e-04 -3.91859183e-05  1.49516988e-03 -2.00176374e-04
 -2.18614401e-04 -1.86981628e-04  4.23593186e-05 -9.99223170e-06
  1.75270846e-04  9.26835373e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681913        1
[INPUT] 0    0    [1    /1   ]  617.498591278        1
[INPUT] 0    0    [1    /1   ]  174.906110337        1
[INPUT] 0    0    [1    /1   ]  20.4965129199        1
[INPUT] 0    0    [1    /1   ]  56.9611270609        1
[INPUT] 0    0    [1    /1   ]  0.488456213862       1
[INPUT] 0    0    [1    /1   ]  7.82469524875        1
[INPUT] 0    0    [1    /1   ]  1.65632575504        1
[INPUT] 1    0    [1    /1   ]  3.66712222704        1
[INPUT] 1    0    [1    /1   ]  12.3809004531        1
[INPUT] 1    0    [1    /1   ]  54.36611489          1
[INPUT] 1    0    [1    /1   ]  0.330157075884       1
[INPUT] 1    0    [1    /1   ]  1.14067216764        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730061684, 1.0]], [0, [2712.096819128892, 1.0]], [0, [617.4985912779349, 1.0]], [0, [174.9061103374194, 1.0]], [0, [20.49651291987478, 1.0]], [0, [56.96112706087503, 1.0]], [0, [0.48845621386236393, 1.0]], [0, [7.824695248750102, 1.0]], [0, [1.6563257550407746, 1.0]], [1, [3.667122227044884, 1.0]], [1, [12.38090045306728, 1.0]], [1, [54.366114889974945, 1.0]], [1, [0.33015707588416654, 1.0]], [1, [1.1406721676419558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873006]
bas 1, expnt(s) = [2712.09681913]
bas 2, expnt(s) = [617.49859128]
bas 3, expnt(s) = [174.90611034]
bas 4, expnt(s) = [20.49651292]
bas 5, expnt(s) = [56.96112706]
bas 6, expnt(s) = [0.48845621]
bas 7, expnt(s) = [7.82469525]
bas 8, expnt(s) = [1.65632576]
bas 9, expnt(s) = [3.66712223]
bas 10, expnt(s) = [12.38090045]
bas 11, expnt(s) = [54.36611489]
bas 12, expnt(s) = [0.33015708]
bas 13, expnt(s) = [1.14067217]
CPU time:       161.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498591e+02 3.12962284e+02 1.74906110e+02 1.21511886e+02
 2.04965129e+01 2.43374465e+01 5.69611271e+01 5.23840358e+01
 4.88456214e-01 1.47616279e+00 7.82469525e+00 1.18199489e+01
 1.65632576e+00 3.68870853e+00 3.66712223e+00 1.48044107e+01
 1.23809005e+01 6.77523997e+01 5.43661149e+01 4.30670144e+02
 3.30157076e-01 7.30104717e-01 1.14067217e+00 3.43902592e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99803169896435
cond(S) = 239.74732492710748
E1 = -183.57463430614433  E_coul = 55.079761052836076
init E= -128.494873253308
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773873316897275  LUMO = 1.11407685526416
  mo_energy =
[-3.25545146e+01 -1.85135338e+00 -7.73873317e-01 -7.73873317e-01
 -7.73873317e-01  1.11407686e+00  1.11407686e+00  1.11407686e+00
  2.06626534e+00  5.75687635e+00  5.75687635e+00  5.75687635e+00
  1.94528276e+01  2.40803845e+01  2.40803845e+01  2.40803845e+01
  9.39065833e+01  1.18192246e+02  1.18192246e+02  1.18192246e+02
  3.56254853e+02  1.34962361e+03  5.83606486e+03  3.50986779e+04]
E1 = -182.11657295288575  E_coul = 53.59164663546182
cycle= 1 E= -128.524926317424  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443258
diis-c [-0.19647727  1.        ]
  HOMO = -0.878551975746847  LUMO = 1.0766294064132
  mo_energy =
[-3.28723853e+01 -1.96110784e+00 -8.78551976e-01 -8.78551976e-01
 -8.78551976e-01  1.07662941e+00  1.07662941e+00  1.07662941e+00
  1.99215262e+00  5.62923406e+00  5.62923406e+00  5.62923406e+00
  1.92360105e+01  2.38468197e+01  2.38468197e+01  2.38468197e+01
  9.36074412e+01  1.17872504e+02  1.17872504e+02  1.17872504e+02
  3.55907981e+02  1.34923843e+03  5.83564780e+03  3.50982392e+04]
E1 = -182.84528919319717  E_coul = 54.31785828781466
cycle= 2 E= -128.527430905383  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219932
diis-c [-5.67250358e-04  3.30641615e-01  6.69358385e-01]
  HOMO = -0.844299615264127  LUMO = 1.08903217198144
  mo_energy =
[-3.27676380e+01 -1.92500340e+00 -8.44299615e-01 -8.44299615e-01
 -8.44299615e-01  1.08903217e+00  1.08903217e+00  1.08903217e+00
  2.01641182e+00  5.67091791e+00  5.67091791e+00  5.67091791e+00
  1.93078099e+01  2.39240299e+01  2.39240299e+01  2.39240299e+01
  9.37063073e+01  1.17977182e+02  1.17977182e+02  1.17977182e+02
  3.56019439e+02  1.34935606e+03  5.83576835e+03  3.50983609e+04]
E1 = -182.6020956666169  E_coul = 54.07382900188515
cycle= 3 E= -128.528266664732  delta_E= -0.000836  |g|= 0.000422  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000978429
diis-c [-7.14261485e-08 -2.03608783e-03  1.86266707e-04  1.00184982e+00]
  HOMO = -0.844500389001295  LUMO = 1.08899988613144
  mo_energy =
[-3.27680492e+01 -1.92515377e+00 -8.44500389e-01 -8.44500389e-01
 -8.44500389e-01  1.08899989e+00  1.08899989e+00  1.08899989e+00
  2.01633906e+00  5.67074179e+00  5.67074179e+00  5.67074179e+00
  1.93075456e+01  2.39237260e+01  2.39237260e+01  2.39237260e+01
  9.37059247e+01  1.17976760e+02  1.17976760e+02  1.17976760e+02
  3.56018945e+02  1.34935544e+03  5.83576763e+03  3.50983601e+04]
E1 = -182.60272092551216  E_coul = 54.074454247430616
cycle= 4 E= -128.528266678082  delta_E= -1.33e-08  |g|= 5.68e-05  |ddm|= 8.09e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013558
diis-c [-3.95331293e-10  1.96703995e-04  4.41927230e-04 -1.47792851e-01
  1.14715422e+00]
  HOMO = -0.844526078688555  LUMO = 1.08898982735895
  mo_energy =
[-3.27681030e+01 -1.92517269e+00 -8.44526079e-01 -8.44526079e-01
 -8.44526079e-01  1.08898983e+00  1.08898983e+00  1.08898983e+00
  2.01632494e+00  5.67071149e+00  5.67071149e+00  5.67071149e+00
  1.93075057e+01  2.39236814e+01  2.39236814e+01  2.39236814e+01
  9.37058731e+01  1.17976705e+02  1.17976705e+02  1.17976705e+02
  3.56018885e+02  1.34935537e+03  5.83576756e+03  3.50983600e+04]
E1 = -182.60284698681303  E_coul = 54.07458030841493
cycle= 5 E= -128.528266678398  delta_E= -3.17e-10  |g|= 3.48e-06  |ddm|= 1.63e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60284698681303  E_coul = 54.07458030841493
  HOMO = -0.844524434227344  LUMO = 1.08899053357955
  mo_energy =
[-3.27680994e+01 -1.92517045e+00 -8.44524434e-01 -8.44524434e-01
 -8.44524434e-01  1.08899053e+00  1.08899053e+00  1.08899053e+00
  2.01632666e+00  5.67071353e+00  5.67071353e+00  5.67071353e+00
  1.93075089e+01  2.39236845e+01  2.39236845e+01  2.39236845e+01
  9.37058765e+01  1.17976709e+02  1.17976709e+02  1.17976709e+02
  3.56018889e+02  1.34935537e+03  5.83576756e+03  3.50983600e+04]
E1 = -182.60283906834593  E_coul = 54.07457238994676
Extra cycle  E= -128.528266678399  delta_E= -1.08e-12  |g|= 1.14e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498591e+02 1.74906110e+02
 2.04965129e+01 5.69611271e+01 4.88456214e-01 7.82469525e+00
 1.65632576e+00 3.66712223e+00 1.23809005e+01 5.43661149e+01
 3.30157076e-01 1.14067217e+00]
E = -128.52826667839918
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681913        1
[INPUT] 0    0    [1    /1   ]  617.498591278        1
[INPUT] 0    0    [1    /1   ]  174.906110337        1
[INPUT] 0    0    [1    /1   ]  20.4965129199        1
[INPUT] 0    0    [1    /1   ]  56.9611270609        1
[INPUT] 0    0    [1    /1   ]  0.488456213862       1
[INPUT] 0    0    [1    /1   ]  7.82469524875        1
[INPUT] 0    0    [1    /1   ]  1.65632575504        1
[INPUT] 1    0    [1    /1   ]  3.66712222704        1
[INPUT] 1    0    [1    /1   ]  12.3809004531        1
[INPUT] 1    0    [1    /1   ]  54.36611489          1
[INPUT] 1    0    [1    /1   ]  0.330157075884       1
[INPUT] 1    0    [1    /1   ]  1.14067216764        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730061684, 1.0]], [0, [2712.096819128892, 1.0]], [0, [617.4985912779349, 1.0]], [0, [174.9061103374194, 1.0]], [0, [20.49651291987478, 1.0]], [0, [56.96112706087503, 1.0]], [0, [0.48845621386236393, 1.0]], [0, [7.824695248750102, 1.0]], [0, [1.6563257550407746, 1.0]], [1, [3.667122227044884, 1.0]], [1, [12.38090045306728, 1.0]], [1, [54.366114889974945, 1.0]], [1, [0.33015707588416654, 1.0]], [1, [1.1406721676419558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873006]
bas 1, expnt(s) = [2712.09681913]
bas 2, expnt(s) = [617.49859128]
bas 3, expnt(s) = [174.90611034]
bas 4, expnt(s) = [20.49651292]
bas 5, expnt(s) = [56.96112706]
bas 6, expnt(s) = [0.48845621]
bas 7, expnt(s) = [7.82469525]
bas 8, expnt(s) = [1.65632576]
bas 9, expnt(s) = [3.66712223]
bas 10, expnt(s) = [12.38090045]
bas 11, expnt(s) = [54.36611489]
bas 12, expnt(s) = [0.33015708]
bas 13, expnt(s) = [1.14067217]
CPU time:       162.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498591e+02 3.12962284e+02 1.74906110e+02 1.21511886e+02
 2.04965129e+01 2.43374465e+01 5.69611271e+01 5.23840358e+01
 4.88456214e-01 1.47616279e+00 7.82469525e+00 1.18199489e+01
 1.65632576e+00 3.68870853e+00 3.66712223e+00 1.48044107e+01
 1.23809005e+01 6.77523997e+01 5.43661149e+01 4.30670144e+02
 3.30157076e-01 7.30104717e-01 1.14067217e+00 3.43902592e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99803169896435
cond(S) = 239.74732492710748
E1 = -183.57463430614433  E_coul = 55.079761052836076
init E= -128.494873253308
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773873316897275  LUMO = 1.11407685526416
  mo_energy =
[-3.25545146e+01 -1.85135338e+00 -7.73873317e-01 -7.73873317e-01
 -7.73873317e-01  1.11407686e+00  1.11407686e+00  1.11407686e+00
  2.06626534e+00  5.75687635e+00  5.75687635e+00  5.75687635e+00
  1.94528276e+01  2.40803845e+01  2.40803845e+01  2.40803845e+01
  9.39065833e+01  1.18192246e+02  1.18192246e+02  1.18192246e+02
  3.56254853e+02  1.34962361e+03  5.83606486e+03  3.50986779e+04]
E1 = -182.11657295288575  E_coul = 53.59164663546182
cycle= 1 E= -128.524926317424  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443258
diis-c [-0.19647727  1.        ]
  HOMO = -0.878551975746847  LUMO = 1.0766294064132
  mo_energy =
[-3.28723853e+01 -1.96110784e+00 -8.78551976e-01 -8.78551976e-01
 -8.78551976e-01  1.07662941e+00  1.07662941e+00  1.07662941e+00
  1.99215262e+00  5.62923406e+00  5.62923406e+00  5.62923406e+00
  1.92360105e+01  2.38468197e+01  2.38468197e+01  2.38468197e+01
  9.36074412e+01  1.17872504e+02  1.17872504e+02  1.17872504e+02
  3.55907981e+02  1.34923843e+03  5.83564780e+03  3.50982392e+04]
E1 = -182.84528919319717  E_coul = 54.31785828781466
cycle= 2 E= -128.527430905383  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219932
diis-c [-5.67250358e-04  3.30641615e-01  6.69358385e-01]
  HOMO = -0.844299615264127  LUMO = 1.08903217198144
  mo_energy =
[-3.27676380e+01 -1.92500340e+00 -8.44299615e-01 -8.44299615e-01
 -8.44299615e-01  1.08903217e+00  1.08903217e+00  1.08903217e+00
  2.01641182e+00  5.67091791e+00  5.67091791e+00  5.67091791e+00
  1.93078099e+01  2.39240299e+01  2.39240299e+01  2.39240299e+01
  9.37063073e+01  1.17977182e+02  1.17977182e+02  1.17977182e+02
  3.56019439e+02  1.34935606e+03  5.83576835e+03  3.50983609e+04]
E1 = -182.6020956666169  E_coul = 54.07382900188515
cycle= 3 E= -128.528266664732  delta_E= -0.000836  |g|= 0.000422  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000978429
diis-c [-7.14261485e-08 -2.03608783e-03  1.86266707e-04  1.00184982e+00]
  HOMO = -0.844500389001295  LUMO = 1.08899988613144
  mo_energy =
[-3.27680492e+01 -1.92515377e+00 -8.44500389e-01 -8.44500389e-01
 -8.44500389e-01  1.08899989e+00  1.08899989e+00  1.08899989e+00
  2.01633906e+00  5.67074179e+00  5.67074179e+00  5.67074179e+00
  1.93075456e+01  2.39237260e+01  2.39237260e+01  2.39237260e+01
  9.37059247e+01  1.17976760e+02  1.17976760e+02  1.17976760e+02
  3.56018945e+02  1.34935544e+03  5.83576763e+03  3.50983601e+04]
E1 = -182.60272092551216  E_coul = 54.074454247430616
cycle= 4 E= -128.528266678082  delta_E= -1.33e-08  |g|= 5.68e-05  |ddm|= 8.09e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00013558
diis-c [-3.95331293e-10  1.96703995e-04  4.41927230e-04 -1.47792851e-01
  1.14715422e+00]
  HOMO = -0.844526078688555  LUMO = 1.08898982735895
  mo_energy =
[-3.27681030e+01 -1.92517269e+00 -8.44526079e-01 -8.44526079e-01
 -8.44526079e-01  1.08898983e+00  1.08898983e+00  1.08898983e+00
  2.01632494e+00  5.67071149e+00  5.67071149e+00  5.67071149e+00
  1.93075057e+01  2.39236814e+01  2.39236814e+01  2.39236814e+01
  9.37058731e+01  1.17976705e+02  1.17976705e+02  1.17976705e+02
  3.56018885e+02  1.34935537e+03  5.83576756e+03  3.50983600e+04]
E1 = -182.60284698681303  E_coul = 54.07458030841493
cycle= 5 E= -128.528266678398  delta_E= -3.17e-10  |g|= 3.48e-06  |ddm|= 1.63e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60284698681303  E_coul = 54.07458030841493
  HOMO = -0.844524434227344  LUMO = 1.08899053357955
  mo_energy =
[-3.27680994e+01 -1.92517045e+00 -8.44524434e-01 -8.44524434e-01
 -8.44524434e-01  1.08899053e+00  1.08899053e+00  1.08899053e+00
  2.01632666e+00  5.67071353e+00  5.67071353e+00  5.67071353e+00
  1.93075089e+01  2.39236845e+01  2.39236845e+01  2.39236845e+01
  9.37058765e+01  1.17976709e+02  1.17976709e+02  1.17976709e+02
  3.56018889e+02  1.34935537e+03  5.83576756e+03  3.50983600e+04]
E1 = -182.60283906834593  E_coul = 54.07457238994676
Extra cycle  E= -128.528266678399  delta_E= -1.08e-12  |g|= 1.14e-06  |ddm|= 1.81e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.74732492710748
E1 = -182.60283906834593  E_coul = 54.07457238994676
init E= -128.528266678399
    CPU time for initialize scf      0.17 sec, wall time      0.17 sec
  HOMO = -0.844524998343215  LUMO = 1.08899034019083
  mo_energy =
[-3.27681012e+01 -1.92517094e+00 -8.44524998e-01 -8.44524998e-01
 -8.44524998e-01  1.08899034e+00  1.08899034e+00  1.08899034e+00
  2.01632635e+00  5.67071286e+00  5.67071286e+00  5.67071286e+00
  1.93075078e+01  2.39236832e+01  2.39236832e+01  2.39236832e+01
  9.37058749e+01  1.17976707e+02  1.17976707e+02  1.17976707e+02
  3.56018887e+02  1.34935537e+03  5.83576756e+03  3.50983600e+04]
E1 = -182.60284337635852  E_coul = 54.07457669795918
cycle= 1 E= -128.528266678399  delta_E= -1.71e-13  |g|= 5.96e-07  |ddm|= 4.47e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60284337635852  E_coul = 54.07457669795918
  HOMO = -0.844524697687204  LUMO = 1.08899045091562
  mo_energy =
[-3.27681003e+01 -1.92517060e+00 -8.44524698e-01 -8.44524698e-01
 -8.44524698e-01  1.08899045e+00  1.08899045e+00  1.08899045e+00
  2.01632658e+00  5.67071323e+00  5.67071323e+00  5.67071323e+00
  1.93075084e+01  2.39236839e+01  2.39236839e+01  2.39236839e+01
  9.37058757e+01  1.17976708e+02  1.17976708e+02  1.17976708e+02
  3.56018888e+02  1.34935537e+03  5.83576756e+03  3.50983600e+04]
E1 = -182.6028412673191  E_coul = 54.07457458891981
Extra cycle  E= -128.528266678399  delta_E= 5.68e-14  |g|= 2.86e-07  |ddm|= 2.52e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.22 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498591e+02 1.74906110e+02
 2.04965129e+01 5.69611271e+01 4.88456214e-01 7.82469525e+00
 1.65632576e+00 3.66712223e+00 1.23809005e+01 5.43661149e+01
 3.30157076e-01 1.14067217e+00]
grad_E = [-9.30015963e-11  5.10590103e-09 -1.06340566e-07  1.29839269e-06
  2.51159921e-05 -9.34720150e-06  1.06017254e-03 -3.08622512e-05
 -1.52626321e-04 -1.46281904e-04  3.66865183e-05 -7.13383146e-06
  1.40674478e-04  7.49016758e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681852        1
[INPUT] 0    0    [1    /1   ]  617.498603527        1
[INPUT] 0    0    [1    /1   ]  174.905974642        1
[INPUT] 0    0    [1    /1   ]  20.4936752232        1
[INPUT] 0    0    [1    /1   ]  56.9620396745        1
[INPUT] 0    0    [1    /1   ]  0.487763993445       1
[INPUT] 0    0    [1    /1   ]  7.82923846561        1
[INPUT] 0    0    [1    /1   ]  1.65483533937        1
[INPUT] 1    0    [1    /1   ]  3.67765742317        1
[INPUT] 1    0    [1    /1   ]  12.4232546277        1
[INPUT] 1    0    [1    /1   ]  54.637939769         1
[INPUT] 1    0    [1    /1   ]  0.330648784465       1
[INPUT] 1    0    [1    /1   ]  1.14330384309        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873007273, 1.0]], [0, [2712.0968185163174, 1.0]], [0, [617.4986035270201, 1.0]], [0, [174.90597464233758, 1.0]], [0, [20.493675223199663, 1.0]], [0, [56.962039674499756, 1.0]], [0, [0.4877639934448402, 1.0]], [0, [7.829238465614321, 1.0]], [0, [1.6548353393651527, 1.0]], [1, [3.6776574231669716, 1.0]], [1, [12.423254627728648, 1.0]], [1, [54.63793976897741, 1.0]], [1, [0.33064878446470813, 1.0]], [1, [1.1433038430861315, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681852]
bas 2, expnt(s) = [617.49860353]
bas 3, expnt(s) = [174.90597464]
bas 4, expnt(s) = [20.49367522]
bas 5, expnt(s) = [56.96203967]
bas 6, expnt(s) = [0.48776399]
bas 7, expnt(s) = [7.82923847]
bas 8, expnt(s) = [1.65483534]
bas 9, expnt(s) = [3.67765742]
bas 10, expnt(s) = [12.42325463]
bas 11, expnt(s) = [54.63793977]
bas 12, expnt(s) = [0.33064878]
bas 13, expnt(s) = [1.14330384]
CPU time:       165.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498604e+02 3.12962289e+02 1.74905975e+02 1.21511815e+02
 2.04936752e+01 2.43349194e+01 5.69620397e+01 5.23846653e+01
 4.87763993e-01 1.47459354e+00 7.82923847e+00 1.18250957e+01
 1.65483534e+00 3.68621884e+00 3.67765742e+00 1.48575939e+01
 1.24232546e+01 6.80422437e+01 5.46379398e+01 4.33363456e+02
 3.30648784e-01 7.31464167e-01 1.14330384e+00 3.44894661e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998020038628773
cond(S) = 239.77281758410328
E1 = -183.57460423753636  E_coul = 55.07976894237234
init E= -128.494835295164
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773873784138856  LUMO = 1.11642790108033
  mo_energy =
[-3.25545047e+01 -1.85135820e+00 -7.73873784e-01 -7.73873784e-01
 -7.73873784e-01  1.11642790e+00  1.11642790e+00  1.11642790e+00
  2.06266404e+00  5.77259232e+00  5.77259232e+00  5.77259232e+00
  1.94498309e+01  2.41645077e+01  2.41645077e+01  2.41645077e+01
  9.39081882e+01  1.18782270e+02  1.18782270e+02  1.18782270e+02
  3.56256569e+02  1.34962536e+03  5.83606646e+03  3.50986792e+04]
E1 = -182.1167117474707  E_coul = 53.59178313160805
cycle= 1 E= -128.524928615863  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443027
diis-c [-0.1962731  1.       ]
  HOMO = -0.87855109181306  LUMO = 1.07888415061717
  mo_energy =
[-3.28723421e+01 -1.96108585e+00 -8.78551092e-01 -8.78551092e-01
 -8.78551092e-01  1.07888415e+00  1.07888415e+00  1.07888415e+00
  1.98865292e+00  5.64470548e+00  5.64470548e+00  5.64470548e+00
  1.92330093e+01  2.39306880e+01  2.39306880e+01  2.39306880e+01
  9.36090748e+01  1.18462359e+02  1.18462359e+02  1.18462359e+02
  3.55909731e+02  1.34924022e+03  5.83564942e+03  3.50982406e+04]
E1 = -182.8452586779329  E_coul = 54.31782589713061
cycle= 2 E= -128.527432780802  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219772
diis-c [-5.67246336e-04  3.30594227e-01  6.69405773e-01]
  HOMO = -0.844304869472001  LUMO = 1.09131798691452
  mo_energy =
[-3.27676087e+01 -1.92498859e+00 -8.44304869e-01 -8.44304869e-01
 -8.44304869e-01  1.09131799e+00  1.09131799e+00  1.09131799e+00
  2.01288135e+00  5.68646588e+00  5.68646588e+00  5.68646588e+00
  1.93048056e+01  2.40079793e+01  2.40079793e+01  2.40079793e+01
  9.37079289e+01  1.18567081e+02  1.18567081e+02  1.18567081e+02
  3.56021175e+02  1.34935783e+03  5.83576996e+03  3.50983622e+04]
E1 = -182.60213801232342  E_coul = 54.073869894796296
cycle= 3 E= -128.528268117527  delta_E= -0.000835  |g|= 0.000426  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000988472
diis-c [-7.43057401e-08 -2.04282045e-03  2.15889048e-04  1.00182693e+00]
  HOMO = -0.844506452670396  LUMO = 1.09128541592369
  mo_energy =
[-3.27680217e+01 -1.92513816e+00 -8.44506453e-01 -8.44506453e-01
 -8.44506453e-01  1.09128542e+00  1.09128542e+00  1.09128542e+00
  2.01280942e+00  5.68628864e+00  5.68628864e+00  5.68628864e+00
  1.93045404e+01  2.40076738e+01  2.40076738e+01  2.40076738e+01
  9.37075447e+01  1.18566657e+02  1.18566657e+02  1.18566657e+02
  3.56020678e+02  1.34935721e+03  5.83576923e+03  3.50983615e+04]
E1 = -182.60277017305313  E_coul = 54.0745020417879
cycle= 4 E= -128.528268131265  delta_E= -1.37e-08  |g|= 5.77e-05  |ddm|= 8.35e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001378
diis-c [-4.10946896e-10  2.03841410e-04  4.46718426e-04 -1.51416601e-01
  1.15076604e+00]
  HOMO = -0.844532376822733  LUMO = 1.09127527531454
  mo_energy =
[-3.27680762e+01 -1.92515691e+00 -8.44532377e-01 -8.44532377e-01
 -8.44532377e-01  1.09127528e+00  1.09127528e+00  1.09127528e+00
  2.01279548e+00  5.68625805e+00  5.68625805e+00  5.68625805e+00
  1.93045002e+01  2.40076288e+01  2.40076288e+01  2.40076288e+01
  9.37074925e+01  1.18566602e+02  1.18566602e+02  1.18566602e+02
  3.56020618e+02  1.34935714e+03  5.83576916e+03  3.50983614e+04]
E1 = -182.60289815172237  E_coul = 54.07463002012599
cycle= 5 E= -128.528268131596  delta_E= -3.31e-10  |g|= 3.59e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60289815172237  E_coul = 54.07463002012599
  HOMO = -0.844530659621358  LUMO = 1.09127601367823
  mo_energy =
[-3.27680725e+01 -1.92515459e+00 -8.44530660e-01 -8.44530660e-01
 -8.44530660e-01  1.09127601e+00  1.09127601e+00  1.09127601e+00
  2.01279726e+00  5.68626018e+00  5.68626018e+00  5.68626018e+00
  1.93045035e+01  2.40076320e+01  2.40076320e+01  2.40076320e+01
  9.37074961e+01  1.18566606e+02  1.18566606e+02  1.18566606e+02
  3.56020621e+02  1.34935714e+03  5.83576916e+03  3.50983614e+04]
E1 = -182.60288989462939  E_coul = 54.07462176303179
Extra cycle  E= -128.528268131598  delta_E= -1.22e-12  |g|= 1.19e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498604e+02 1.74905975e+02
 2.04936752e+01 5.69620397e+01 4.87763993e-01 7.82923847e+00
 1.65483534e+00 3.67765742e+00 1.24232546e+01 5.46379398e+01
 3.30648784e-01 1.14330384e+00]
E = -128.5282681315976
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681852        1
[INPUT] 0    0    [1    /1   ]  617.498603527        1
[INPUT] 0    0    [1    /1   ]  174.905974642        1
[INPUT] 0    0    [1    /1   ]  20.4936752232        1
[INPUT] 0    0    [1    /1   ]  56.9620396745        1
[INPUT] 0    0    [1    /1   ]  0.487763993445       1
[INPUT] 0    0    [1    /1   ]  7.82923846561        1
[INPUT] 0    0    [1    /1   ]  1.65483533937        1
[INPUT] 1    0    [1    /1   ]  3.67765742317        1
[INPUT] 1    0    [1    /1   ]  12.4232546277        1
[INPUT] 1    0    [1    /1   ]  54.637939769         1
[INPUT] 1    0    [1    /1   ]  0.330648784465       1
[INPUT] 1    0    [1    /1   ]  1.14330384309        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.47873007273, 1.0]], [0, [2712.0968185163174, 1.0]], [0, [617.4986035270201, 1.0]], [0, [174.90597464233758, 1.0]], [0, [20.493675223199663, 1.0]], [0, [56.962039674499756, 1.0]], [0, [0.4877639934448402, 1.0]], [0, [7.829238465614321, 1.0]], [0, [1.6548353393651527, 1.0]], [1, [3.6776574231669716, 1.0]], [1, [12.423254627728648, 1.0]], [1, [54.63793976897741, 1.0]], [1, [0.33064878446470813, 1.0]], [1, [1.1433038430861315, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681852]
bas 2, expnt(s) = [617.49860353]
bas 3, expnt(s) = [174.90597464]
bas 4, expnt(s) = [20.49367522]
bas 5, expnt(s) = [56.96203967]
bas 6, expnt(s) = [0.48776399]
bas 7, expnt(s) = [7.82923847]
bas 8, expnt(s) = [1.65483534]
bas 9, expnt(s) = [3.67765742]
bas 10, expnt(s) = [12.42325463]
bas 11, expnt(s) = [54.63793977]
bas 12, expnt(s) = [0.33064878]
bas 13, expnt(s) = [1.14330384]
CPU time:       166.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498604e+02 3.12962289e+02 1.74905975e+02 1.21511815e+02
 2.04936752e+01 2.43349194e+01 5.69620397e+01 5.23846653e+01
 4.87763993e-01 1.47459354e+00 7.82923847e+00 1.18250957e+01
 1.65483534e+00 3.68621884e+00 3.67765742e+00 1.48575939e+01
 1.24232546e+01 6.80422437e+01 5.46379398e+01 4.33363456e+02
 3.30648784e-01 7.31464167e-01 1.14330384e+00 3.44894661e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998020038628773
cond(S) = 239.77281758410328
E1 = -183.57460423753636  E_coul = 55.07976894237234
init E= -128.494835295164
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773873784138856  LUMO = 1.11642790108033
  mo_energy =
[-3.25545047e+01 -1.85135820e+00 -7.73873784e-01 -7.73873784e-01
 -7.73873784e-01  1.11642790e+00  1.11642790e+00  1.11642790e+00
  2.06266404e+00  5.77259232e+00  5.77259232e+00  5.77259232e+00
  1.94498309e+01  2.41645077e+01  2.41645077e+01  2.41645077e+01
  9.39081882e+01  1.18782270e+02  1.18782270e+02  1.18782270e+02
  3.56256569e+02  1.34962536e+03  5.83606646e+03  3.50986792e+04]
E1 = -182.1167117474707  E_coul = 53.59178313160805
cycle= 1 E= -128.524928615863  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.443027
diis-c [-0.1962731  1.       ]
  HOMO = -0.87855109181306  LUMO = 1.07888415061717
  mo_energy =
[-3.28723421e+01 -1.96108585e+00 -8.78551092e-01 -8.78551092e-01
 -8.78551092e-01  1.07888415e+00  1.07888415e+00  1.07888415e+00
  1.98865292e+00  5.64470548e+00  5.64470548e+00  5.64470548e+00
  1.92330093e+01  2.39306880e+01  2.39306880e+01  2.39306880e+01
  9.36090748e+01  1.18462359e+02  1.18462359e+02  1.18462359e+02
  3.55909731e+02  1.34924022e+03  5.83564942e+03  3.50982406e+04]
E1 = -182.8452586779329  E_coul = 54.31782589713061
cycle= 2 E= -128.527432780802  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219772
diis-c [-5.67246336e-04  3.30594227e-01  6.69405773e-01]
  HOMO = -0.844304869472001  LUMO = 1.09131798691452
  mo_energy =
[-3.27676087e+01 -1.92498859e+00 -8.44304869e-01 -8.44304869e-01
 -8.44304869e-01  1.09131799e+00  1.09131799e+00  1.09131799e+00
  2.01288135e+00  5.68646588e+00  5.68646588e+00  5.68646588e+00
  1.93048056e+01  2.40079793e+01  2.40079793e+01  2.40079793e+01
  9.37079289e+01  1.18567081e+02  1.18567081e+02  1.18567081e+02
  3.56021175e+02  1.34935783e+03  5.83576996e+03  3.50983622e+04]
E1 = -182.60213801232342  E_coul = 54.073869894796296
cycle= 3 E= -128.528268117527  delta_E= -0.000835  |g|= 0.000426  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000988472
diis-c [-7.43057401e-08 -2.04282045e-03  2.15889048e-04  1.00182693e+00]
  HOMO = -0.844506452670396  LUMO = 1.09128541592369
  mo_energy =
[-3.27680217e+01 -1.92513816e+00 -8.44506453e-01 -8.44506453e-01
 -8.44506453e-01  1.09128542e+00  1.09128542e+00  1.09128542e+00
  2.01280942e+00  5.68628864e+00  5.68628864e+00  5.68628864e+00
  1.93045404e+01  2.40076738e+01  2.40076738e+01  2.40076738e+01
  9.37075447e+01  1.18566657e+02  1.18566657e+02  1.18566657e+02
  3.56020678e+02  1.34935721e+03  5.83576923e+03  3.50983615e+04]
E1 = -182.60277017305313  E_coul = 54.0745020417879
cycle= 4 E= -128.528268131265  delta_E= -1.37e-08  |g|= 5.77e-05  |ddm|= 8.35e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0001378
diis-c [-4.10946896e-10  2.03841410e-04  4.46718426e-04 -1.51416601e-01
  1.15076604e+00]
  HOMO = -0.844532376822733  LUMO = 1.09127527531454
  mo_energy =
[-3.27680762e+01 -1.92515691e+00 -8.44532377e-01 -8.44532377e-01
 -8.44532377e-01  1.09127528e+00  1.09127528e+00  1.09127528e+00
  2.01279548e+00  5.68625805e+00  5.68625805e+00  5.68625805e+00
  1.93045002e+01  2.40076288e+01  2.40076288e+01  2.40076288e+01
  9.37074925e+01  1.18566602e+02  1.18566602e+02  1.18566602e+02
  3.56020618e+02  1.34935714e+03  5.83576916e+03  3.50983614e+04]
E1 = -182.60289815172237  E_coul = 54.07463002012599
cycle= 5 E= -128.528268131596  delta_E= -3.31e-10  |g|= 3.59e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60289815172237  E_coul = 54.07463002012599
  HOMO = -0.844530659621358  LUMO = 1.09127601367823
  mo_energy =
[-3.27680725e+01 -1.92515459e+00 -8.44530660e-01 -8.44530660e-01
 -8.44530660e-01  1.09127601e+00  1.09127601e+00  1.09127601e+00
  2.01279726e+00  5.68626018e+00  5.68626018e+00  5.68626018e+00
  1.93045035e+01  2.40076320e+01  2.40076320e+01  2.40076320e+01
  9.37074961e+01  1.18566606e+02  1.18566606e+02  1.18566606e+02
  3.56020621e+02  1.34935714e+03  5.83576916e+03  3.50983614e+04]
E1 = -182.60288989462939  E_coul = 54.07462176303179
Extra cycle  E= -128.528268131598  delta_E= -1.22e-12  |g|= 1.19e-06  |ddm|= 1.85e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.77281758410328
E1 = -182.60288989462939  E_coul = 54.07462176303179
init E= -128.528268131598
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.844531247288569  LUMO = 1.09127581151334
  mo_energy =
[-3.27680743e+01 -1.92515510e+00 -8.44531247e-01 -8.44531247e-01
 -8.44531247e-01  1.09127581e+00  1.09127581e+00  1.09127581e+00
  2.01279693e+00  5.68625948e+00  5.68625948e+00  5.68625948e+00
  1.93045023e+01  2.40076307e+01  2.40076307e+01  2.40076307e+01
  9.37074943e+01  1.18566604e+02  1.18566604e+02  1.18566604e+02
  3.56020619e+02  1.34935714e+03  5.83576916e+03  3.50983614e+04]
E1 = -182.60289438239138  E_coul = 54.07462625079356
cycle= 1 E= -128.528268131598  delta_E= -2.27e-13  |g|= 6.21e-07  |ddm|= 4.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60289438239138  E_coul = 54.07462625079356
  HOMO = -0.844530934002066  LUMO = 1.09127592715601
  mo_energy =
[-3.27680734e+01 -1.92515475e+00 -8.44530934e-01 -8.44530934e-01
 -8.44530934e-01  1.09127593e+00  1.09127593e+00  1.09127593e+00
  2.01279717e+00  5.68625986e+00  5.68625986e+00  5.68625986e+00
  1.93045030e+01  2.40076314e+01  2.40076314e+01  2.40076314e+01
  9.37074952e+01  1.18566605e+02  1.18566605e+02  1.18566605e+02
  3.56020620e+02  1.34935714e+03  5.83576916e+03  3.50983614e+04]
E1 = -182.60289218461426  E_coul = 54.07462405301646
Extra cycle  E= -128.528268131598  delta_E= 2.84e-14  |g|= 2.98e-07  |ddm|= 2.61e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498604e+02 1.74905975e+02
 2.04936752e+01 5.69620397e+01 4.87763993e-01 7.82923847e+00
 1.65483534e+00 3.67765742e+00 1.24232546e+01 5.46379398e+01
 3.30648784e-01 1.14330384e+00]
grad_E = [ 2.66745946e-11 -1.15194472e-09  1.72599778e-08 -8.82356898e-08
 -8.79542914e-06 -5.22431898e-09  3.36793328e-04  2.37529814e-05
 -4.64714815e-05 -5.03127845e-05  1.36525945e-05 -2.34114025e-06
  4.84370302e-05  2.71463477e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681862        1
[INPUT] 0    0    [1    /1   ]  617.498601433        1
[INPUT] 0    0    [1    /1   ]  174.905999644        1
[INPUT] 0    0    [1    /1   ]  20.4944419353        1
[INPUT] 0    0    [1    /1   ]  56.9618716685        1
[INPUT] 0    0    [1    /1   ]  0.487466666684       1
[INPUT] 0    0    [1    /1   ]  7.82816458864        1
[INPUT] 0    0    [1    /1   ]  1.65427960563        1
[INPUT] 1    0    [1    /1   ]  3.68156643765        1
[INPUT] 1    0    [1    /1   ]  12.4386790294        1
[INPUT] 1    0    [1    /1   ]  54.7417636766        1
[INPUT] 1    0    [1    /1   ]  0.330828559373       1
[INPUT] 1    0    [1    /1   ]  1.14428341335        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730070434, 1.0]], [0, [2712.096818624824, 1.0]], [0, [617.4986014327512, 1.0]], [0, [174.9059996439537, 1.0]], [0, [20.494441935304142, 1.0]], [0, [56.961871668488655, 1.0]], [0, [0.48746666668411337, 1.0]], [0, [7.8281645886373274, 1.0]], [0, [1.6542796056251363, 1.0]], [1, [3.6815664376529433, 1.0]], [1, [12.438679029373082, 1.0]], [1, [54.74176367655044, 1.0]], [1, [0.3308285593730334, 1.0]], [1, [1.144283413352823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681862]
bas 2, expnt(s) = [617.49860143]
bas 3, expnt(s) = [174.90599964]
bas 4, expnt(s) = [20.49444194]
bas 5, expnt(s) = [56.96187167]
bas 6, expnt(s) = [0.48746667]
bas 7, expnt(s) = [7.82816459]
bas 8, expnt(s) = [1.65427961]
bas 9, expnt(s) = [3.68156644]
bas 10, expnt(s) = [12.43867903]
bas 11, expnt(s) = [54.74176368]
bas 12, expnt(s) = [0.33082856]
bas 13, expnt(s) = [1.14428341]
CPU time:       169.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906000e+02 1.21511828e+02
 2.04944419e+01 2.43356022e+01 5.69618717e+01 5.23845494e+01
 4.87466667e-01 1.47391934e+00 7.82816459e+00 1.18238792e+01
 1.65427961e+00 3.68529036e+00 3.68156644e+00 1.48773368e+01
 1.24386790e+01 6.81478595e+01 5.47417637e+01 4.34393056e+02
 3.30828559e-01 7.31961325e-01 1.14428341e+00 3.45264078e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998015786070697
cond(S) = 239.6950126477844
E1 = -183.57460579003495  E_coul = 55.079768706339294
init E= -128.494837083696
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773874313803083  LUMO = 1.11729208143194
  mo_energy =
[-3.25545031e+01 -1.85135846e+00 -7.73874314e-01 -7.73874314e-01
 -7.73874314e-01  1.11729208e+00  1.11729208e+00  1.11729208e+00
  2.06112815e+00  5.77843316e+00  5.77843316e+00  5.77843316e+00
  1.94448352e+01  2.41954221e+01  2.41954221e+01  2.41954221e+01
  9.39025361e+01  1.19004959e+02  1.19004959e+02  1.19004959e+02
  3.56251717e+02  1.34962110e+03  5.83606274e+03  3.50986762e+04]
E1 = -182.11670520125614  E_coul = 53.591776412496785
cycle= 1 E= -128.524928788759  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442968
diis-c [-0.1962209  1.       ]
  HOMO = -0.87855553910473  LUMO = 1.0797110975677
  mo_energy =
[-3.28723391e+01 -1.96107884e+00 -8.78555539e-01 -8.78555539e-01
 -8.78555539e-01  1.07971110e+00  1.07971110e+00  1.07971110e+00
  1.98715922e+00  5.65044968e+00  5.65044968e+00  5.65044968e+00
  1.92280181e+01  2.39615016e+01  2.39615016e+01  2.39615016e+01
  9.36034217e+01  1.18684970e+02  1.18684970e+02  1.18684970e+02
  3.55904877e+02  1.34923595e+03  5.83564570e+03  3.50982375e+04]
E1 = -182.84522543986768  E_coul = 54.317792416350166
cycle= 2 E= -128.527433023518  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219724
diis-c [-5.67182274e-04  3.30574628e-01  6.69425372e-01]
  HOMO = -0.844309792645083  LUMO = 1.09215707922997
  mo_energy =
[-3.27676055e+01 -1.92498231e+00 -8.44309793e-01 -8.44309793e-01
 -8.44309793e-01  1.09215708e+00  1.09215708e+00  1.09215708e+00
  2.01137553e+00  5.69224065e+00  5.69224065e+00  5.69224065e+00
  1.92998119e+01  2.40388263e+01  2.40388263e+01  2.40388263e+01
  9.37022764e+01  1.18789715e+02  1.18789715e+02  1.18789715e+02
  3.56016321e+02  1.34935357e+03  5.83576624e+03  3.50983592e+04]
E1 = -182.60211832565795  E_coul = 54.07385003858988
cycle= 3 E= -128.528268287068  delta_E= -0.000835  |g|= 0.000428  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993643
diis-c [-7.57231614e-08 -2.04581914e-03  2.31714366e-04  1.00181410e+00]
  HOMO = -0.844511828387465  LUMO = 1.09212435598953
  mo_energy =
[-3.27680196e+01 -1.92513160e+00 -8.44511828e-01 -8.44511828e-01
 -8.44511828e-01  1.09212436e+00  1.09212436e+00  1.09212436e+00
  2.01130391e+00  5.69206282e+00  5.69206282e+00  5.69206282e+00
  1.92995461e+01  2.40385200e+01  2.40385200e+01  2.40385200e+01
  9.37018912e+01  1.18789289e+02  1.18789289e+02  1.18789289e+02
  3.56015823e+02  1.34935294e+03  5.83576551e+03  3.50983584e+04]
E1 = -182.60275398656717  E_coul = 54.07448568556713
cycle= 4 E= -128.528268301  delta_E= -1.39e-08  |g|= 5.82e-05  |ddm|= 8.48e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138883
diis-c [-4.17795312e-10  2.06933189e-04  4.48661223e-04 -1.53011734e-01
  1.15235614e+00]
  HOMO = -0.844537874367656  LUMO = 1.09211417365191
  mo_energy =
[-3.27680743e+01 -1.92515030e+00 -8.44537874e-01 -8.44537874e-01
 -8.44537874e-01  1.09211417e+00  1.09211417e+00  1.09211417e+00
  2.01129004e+00  5.69203208e+00  5.69203208e+00  5.69203208e+00
  1.92995059e+01  2.40384748e+01  2.40384748e+01  2.40384748e+01
  9.37018387e+01  1.18789234e+02  1.18789234e+02  1.18789234e+02
  3.56015762e+02  1.34935287e+03  5.83576543e+03  3.50983583e+04]
E1 = -182.60288290232475  E_coul = 54.074614600986415
cycle= 5 E= -128.528268301338  delta_E= -3.38e-10  |g|= 3.65e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60288290232475  E_coul = 54.074614600986415
  HOMO = -0.844536123568967  LUMO = 1.09211492665425
  mo_energy =
[-3.27680705e+01 -1.92514794e+00 -8.44536124e-01 -8.44536124e-01
 -8.44536124e-01  1.09211493e+00  1.09211493e+00  1.09211493e+00
  2.01129185e+00  5.69203426e+00  5.69203426e+00  5.69203426e+00
  1.92995092e+01  2.40384781e+01  2.40384781e+01  2.40384781e+01
  9.37018424e+01  1.18789237e+02  1.18789237e+02  1.18789237e+02
  3.56015766e+02  1.34935288e+03  5.83576543e+03  3.50983583e+04]
E1 = -182.6028744857982  E_coul = 54.07460618445869
Extra cycle  E= -128.528268301339  delta_E= -1.17e-12  |g|= 1.21e-06  |ddm|= 1.87e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906000e+02
 2.04944419e+01 5.69618717e+01 4.87466667e-01 7.82816459e+00
 1.65427961e+00 3.68156644e+00 1.24386790e+01 5.47417637e+01
 3.30828559e-01 1.14428341e+00]
E = -128.5282683013395
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681862        1
[INPUT] 0    0    [1    /1   ]  617.498601433        1
[INPUT] 0    0    [1    /1   ]  174.905999644        1
[INPUT] 0    0    [1    /1   ]  20.4944419353        1
[INPUT] 0    0    [1    /1   ]  56.9618716685        1
[INPUT] 0    0    [1    /1   ]  0.487466666684       1
[INPUT] 0    0    [1    /1   ]  7.82816458864        1
[INPUT] 0    0    [1    /1   ]  1.65427960563        1
[INPUT] 1    0    [1    /1   ]  3.68156643765        1
[INPUT] 1    0    [1    /1   ]  12.4386790294        1
[INPUT] 1    0    [1    /1   ]  54.7417636766        1
[INPUT] 1    0    [1    /1   ]  0.330828559373       1
[INPUT] 1    0    [1    /1   ]  1.14428341335        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730070434, 1.0]], [0, [2712.096818624824, 1.0]], [0, [617.4986014327512, 1.0]], [0, [174.9059996439537, 1.0]], [0, [20.494441935304142, 1.0]], [0, [56.961871668488655, 1.0]], [0, [0.48746666668411337, 1.0]], [0, [7.8281645886373274, 1.0]], [0, [1.6542796056251363, 1.0]], [1, [3.6815664376529433, 1.0]], [1, [12.438679029373082, 1.0]], [1, [54.74176367655044, 1.0]], [1, [0.3308285593730334, 1.0]], [1, [1.144283413352823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681862]
bas 2, expnt(s) = [617.49860143]
bas 3, expnt(s) = [174.90599964]
bas 4, expnt(s) = [20.49444194]
bas 5, expnt(s) = [56.96187167]
bas 6, expnt(s) = [0.48746667]
bas 7, expnt(s) = [7.82816459]
bas 8, expnt(s) = [1.65427961]
bas 9, expnt(s) = [3.68156644]
bas 10, expnt(s) = [12.43867903]
bas 11, expnt(s) = [54.74176368]
bas 12, expnt(s) = [0.33082856]
bas 13, expnt(s) = [1.14428341]
CPU time:       170.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906000e+02 1.21511828e+02
 2.04944419e+01 2.43356022e+01 5.69618717e+01 5.23845494e+01
 4.87466667e-01 1.47391934e+00 7.82816459e+00 1.18238792e+01
 1.65427961e+00 3.68529036e+00 3.68156644e+00 1.48773368e+01
 1.24386790e+01 6.81478595e+01 5.47417637e+01 4.34393056e+02
 3.30828559e-01 7.31961325e-01 1.14428341e+00 3.45264078e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998015786070697
cond(S) = 239.6950126477844
E1 = -183.57460579003495  E_coul = 55.079768706339294
init E= -128.494837083696
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773874313803083  LUMO = 1.11729208143194
  mo_energy =
[-3.25545031e+01 -1.85135846e+00 -7.73874314e-01 -7.73874314e-01
 -7.73874314e-01  1.11729208e+00  1.11729208e+00  1.11729208e+00
  2.06112815e+00  5.77843316e+00  5.77843316e+00  5.77843316e+00
  1.94448352e+01  2.41954221e+01  2.41954221e+01  2.41954221e+01
  9.39025361e+01  1.19004959e+02  1.19004959e+02  1.19004959e+02
  3.56251717e+02  1.34962110e+03  5.83606274e+03  3.50986762e+04]
E1 = -182.11670520125614  E_coul = 53.591776412496785
cycle= 1 E= -128.524928788759  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442968
diis-c [-0.1962209  1.       ]
  HOMO = -0.87855553910473  LUMO = 1.0797110975677
  mo_energy =
[-3.28723391e+01 -1.96107884e+00 -8.78555539e-01 -8.78555539e-01
 -8.78555539e-01  1.07971110e+00  1.07971110e+00  1.07971110e+00
  1.98715922e+00  5.65044968e+00  5.65044968e+00  5.65044968e+00
  1.92280181e+01  2.39615016e+01  2.39615016e+01  2.39615016e+01
  9.36034217e+01  1.18684970e+02  1.18684970e+02  1.18684970e+02
  3.55904877e+02  1.34923595e+03  5.83564570e+03  3.50982375e+04]
E1 = -182.84522543986768  E_coul = 54.317792416350166
cycle= 2 E= -128.527433023518  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219724
diis-c [-5.67182274e-04  3.30574628e-01  6.69425372e-01]
  HOMO = -0.844309792645083  LUMO = 1.09215707922997
  mo_energy =
[-3.27676055e+01 -1.92498231e+00 -8.44309793e-01 -8.44309793e-01
 -8.44309793e-01  1.09215708e+00  1.09215708e+00  1.09215708e+00
  2.01137553e+00  5.69224065e+00  5.69224065e+00  5.69224065e+00
  1.92998119e+01  2.40388263e+01  2.40388263e+01  2.40388263e+01
  9.37022764e+01  1.18789715e+02  1.18789715e+02  1.18789715e+02
  3.56016321e+02  1.34935357e+03  5.83576624e+03  3.50983592e+04]
E1 = -182.60211832565795  E_coul = 54.07385003858988
cycle= 3 E= -128.528268287068  delta_E= -0.000835  |g|= 0.000428  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000993643
diis-c [-7.57231614e-08 -2.04581914e-03  2.31714366e-04  1.00181410e+00]
  HOMO = -0.844511828387465  LUMO = 1.09212435598953
  mo_energy =
[-3.27680196e+01 -1.92513160e+00 -8.44511828e-01 -8.44511828e-01
 -8.44511828e-01  1.09212436e+00  1.09212436e+00  1.09212436e+00
  2.01130391e+00  5.69206282e+00  5.69206282e+00  5.69206282e+00
  1.92995461e+01  2.40385200e+01  2.40385200e+01  2.40385200e+01
  9.37018912e+01  1.18789289e+02  1.18789289e+02  1.18789289e+02
  3.56015823e+02  1.34935294e+03  5.83576551e+03  3.50983584e+04]
E1 = -182.60275398656717  E_coul = 54.07448568556713
cycle= 4 E= -128.528268301  delta_E= -1.39e-08  |g|= 5.82e-05  |ddm|= 8.48e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000138883
diis-c [-4.17795312e-10  2.06933189e-04  4.48661223e-04 -1.53011734e-01
  1.15235614e+00]
  HOMO = -0.844537874367656  LUMO = 1.09211417365191
  mo_energy =
[-3.27680743e+01 -1.92515030e+00 -8.44537874e-01 -8.44537874e-01
 -8.44537874e-01  1.09211417e+00  1.09211417e+00  1.09211417e+00
  2.01129004e+00  5.69203208e+00  5.69203208e+00  5.69203208e+00
  1.92995059e+01  2.40384748e+01  2.40384748e+01  2.40384748e+01
  9.37018387e+01  1.18789234e+02  1.18789234e+02  1.18789234e+02
  3.56015762e+02  1.34935287e+03  5.83576543e+03  3.50983583e+04]
E1 = -182.60288290232475  E_coul = 54.074614600986415
cycle= 5 E= -128.528268301338  delta_E= -3.38e-10  |g|= 3.65e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60288290232475  E_coul = 54.074614600986415
  HOMO = -0.844536123568967  LUMO = 1.09211492665425
  mo_energy =
[-3.27680705e+01 -1.92514794e+00 -8.44536124e-01 -8.44536124e-01
 -8.44536124e-01  1.09211493e+00  1.09211493e+00  1.09211493e+00
  2.01129185e+00  5.69203426e+00  5.69203426e+00  5.69203426e+00
  1.92995092e+01  2.40384781e+01  2.40384781e+01  2.40384781e+01
  9.37018424e+01  1.18789237e+02  1.18789237e+02  1.18789237e+02
  3.56015766e+02  1.34935288e+03  5.83576543e+03  3.50983583e+04]
E1 = -182.6028744857982  E_coul = 54.07460618445869
Extra cycle  E= -128.528268301339  delta_E= -1.17e-12  |g|= 1.21e-06  |ddm|= 1.87e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.6950126477844
E1 = -182.6028744857982  E_coul = 54.07460618445869
init E= -128.528268301339
    CPU time for initialize scf      0.16 sec, wall time      0.15 sec
  HOMO = -0.844536722315475  LUMO = 1.09211472039164
  mo_energy =
[-3.27680724e+01 -1.92514846e+00 -8.44536722e-01 -8.44536722e-01
 -8.44536722e-01  1.09211472e+00  1.09211472e+00  1.09211472e+00
  2.01129152e+00  5.69203354e+00  5.69203354e+00  5.69203354e+00
  1.92995080e+01  2.40384767e+01  2.40384767e+01  2.40384767e+01
  9.37018406e+01  1.18789236e+02  1.18789236e+02  1.18789236e+02
  3.56015764e+02  1.34935287e+03  5.83576543e+03  3.50983583e+04]
E1 = -182.60287905790915  E_coul = 54.074610756569385
cycle= 1 E= -128.52826830134  delta_E= -2.84e-13  |g|= 6.32e-07  |ddm|= 4.74e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60287905790915  E_coul = 54.074610756569385
  HOMO = -0.844536403097538  LUMO = 1.09211483831985
  mo_energy =
[-3.27680715e+01 -1.92514810e+00 -8.44536403e-01 -8.44536403e-01
 -8.44536403e-01  1.09211484e+00  1.09211484e+00  1.09211484e+00
  2.01129176e+00  5.69203393e+00  5.69203393e+00  5.69203393e+00
  1.92995087e+01  2.40384774e+01  2.40384774e+01  2.40384774e+01
  9.37018415e+01  1.18789237e+02  1.18789237e+02  1.18789237e+02
  3.56015765e+02  1.34935287e+03  5.83576543e+03  3.50983583e+04]
E1 = -182.60287681841965  E_coul = 54.07460851707982
Extra cycle  E= -128.52826830134  delta_E= -5.68e-14  |g|= 3.04e-07  |ddm|= 2.66e-07
    CPU time for scf_cycle      0.21 sec, wall time      0.20 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906000e+02
 2.04944419e+01 5.69618717e+01 4.87466667e-01 7.82816459e+00
 1.65427961e+00 3.68156644e+00 1.24386790e+01 5.47417637e+01
 3.30828559e-01 1.14428341e+00]
grad_E = [-1.74789523e-12  3.37842984e-10 -1.20879037e-08  2.43009390e-07
 -7.05987455e-07 -2.21441378e-06  3.33095240e-05  1.22855615e-05
 -4.10075328e-06 -6.00794699e-06  1.89280070e-06 -2.75729431e-07
  4.78848184e-06  3.80173501e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968187         1
[INPUT] 0    0    [1    /1   ]  617.498599923        1
[INPUT] 0    0    [1    /1   ]  174.90601681         1
[INPUT] 0    0    [1    /1   ]  20.4948782521        1
[INPUT] 0    0    [1    /1   ]  56.9617567584        1
[INPUT] 0    0    [1    /1   ]  0.487430605889       1
[INPUT] 0    0    [1    /1   ]  7.82750196851        1
[INPUT] 0    0    [1    /1   ]  1.65422572399        1
[INPUT] 1    0    [1    /1   ]  3.68193862965        1
[INPUT] 1    0    [1    /1   ]  12.4401062697        1
[INPUT] 1    0    [1    /1   ]  54.752648301         1
[INPUT] 1    0    [1    /1   ]  0.330845310349       1
[INPUT] 1    0    [1    /1   ]  1.14437726912        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730068942, 1.0]], [0, [2712.096818701675, 1.0]], [0, [617.4985999230122, 1.0]], [0, [174.9060168103256, 1.0]], [0, [20.494878252052462, 1.0]], [0, [56.96175675843163, 1.0]], [0, [0.4874306058886835, 1.0]], [0, [7.82750196851329, 1.0]], [0, [1.6542257239856788, 1.0]], [1, [3.6819386296497383, 1.0]], [1, [12.440106269745918, 1.0]], [1, [54.752648300984625, 1.0]], [1, [0.3308453103493317, 1.0]], [1, [1.1443772691236038, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968187]
bas 2, expnt(s) = [617.49859992]
bas 3, expnt(s) = [174.90601681]
bas 4, expnt(s) = [20.49487825]
bas 5, expnt(s) = [56.96175676]
bas 6, expnt(s) = [0.48743061]
bas 7, expnt(s) = [7.82750197]
bas 8, expnt(s) = [1.65422572]
bas 9, expnt(s) = [3.68193863]
bas 10, expnt(s) = [12.44010627]
bas 11, expnt(s) = [54.7526483]
bas 12, expnt(s) = [0.33084531]
bas 13, expnt(s) = [1.14437727]
CPU time:       172.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906017e+02 1.21511837e+02
 2.04948783e+01 2.43359907e+01 5.69617568e+01 5.23844701e+01
 4.87430606e-01 1.47383756e+00 7.82750197e+00 1.18231286e+01
 1.65422572e+00 3.68520033e+00 3.68193863e+00 1.48792169e+01
 1.24401063e+01 6.81576339e+01 5.47526483e+01 4.34501025e+02
 3.30845310e-01 7.32007653e-01 1.14437727e+00 3.45299477e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998015401398039
cond(S) = 239.66986063271614
E1 = -183.57460853177471  E_coul = 55.079767983439694
init E= -128.494840548335
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.773874445866589  LUMO = 1.11737320360975
  mo_energy =
[-3.25545034e+01 -1.85135819e+00 -7.73874446e-01 -7.73874446e-01
 -7.73874446e-01  1.11737320e+00  1.11737320e+00  1.11737320e+00
  2.06094261e+00  5.77899161e+00  5.77899161e+00  5.77899161e+00
  1.94435695e+01  2.41983190e+01  2.41983190e+01  2.41983190e+01
  9.39007185e+01  1.19027575e+02  1.19027575e+02  1.19027575e+02
  3.56250128e+02  1.34961969e+03  5.83606151e+03  3.50986751e+04]
E1 = -182.11669403535672  E_coul = 53.591765298481775
cycle= 1 E= -128.524928736875  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442967
diis-c [-0.19622012  1.        ]
  HOMO = -0.878556834475661  LUMO = 1.07978839963696
  mo_energy =
[-3.28723413e+01 -1.96107832e+00 -8.78556834e-01 -8.78556834e-01
 -8.78556834e-01  1.07978840e+00  1.07978840e+00  1.07978840e+00
  1.98697865e+00  5.65099781e+00  5.65099781e+00  5.65099781e+00
  1.92267544e+01  2.39643876e+01  2.39643876e+01  2.39643876e+01
  9.36016017e+01  1.18707575e+02  1.18707575e+02  1.18707575e+02
  3.55903285e+02  1.34923454e+03  5.83564446e+03  3.50982365e+04]
E1 = -182.8452184760969  E_coul = 54.3177854551328
cycle= 2 E= -128.527433020964  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219721
diis-c [-5.67161981e-04  3.30572341e-01  6.69427659e-01]
  HOMO = -0.844310794795565  LUMO = 1.09223565699374
  mo_energy =
[-3.27676066e+01 -1.92498150e+00 -8.44310795e-01 -8.44310795e-01
 -8.44310795e-01  1.09223566e+00  1.09223566e+00  1.09223566e+00
  2.01119366e+00  5.69279211e+00  5.69279211e+00  5.69279211e+00
  1.92985475e+01  2.40417163e+01  2.40417163e+01  2.40417163e+01
  9.37004575e+01  1.18812323e+02  1.18812323e+02  1.18812323e+02
  3.56014730e+02  1.34935215e+03  5.83576500e+03  3.50983582e+04]
E1 = -182.60211015519246  E_coul = 54.073841862134024
cycle= 3 E= -128.528268293058  delta_E= -0.000835  |g|= 0.000428  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000994414
diis-c [-7.59220208e-08 -2.04618557e-03  2.34189288e-04  1.00181200e+00]
  HOMO = -0.844512902228765  LUMO = 1.09220291072387
  mo_energy =
[-3.27680209e+01 -1.92513076e+00 -8.44512902e-01 -8.44512902e-01
 -8.44512902e-01  1.09220291e+00  1.09220291e+00  1.09220291e+00
  2.01112207e+00  5.69261419e+00  5.69261419e+00  5.69261419e+00
  1.92982817e+01  2.40414098e+01  2.40414098e+01  2.40414098e+01
  9.37000721e+01  1.18811897e+02  1.18811897e+02  1.18811897e+02
  3.56014232e+02  1.34935153e+03  5.83576427e+03  3.50983574e+04]
E1 = -182.6027463324414  E_coul = 54.07447802542332
cycle= 4 E= -128.528268307018  delta_E= -1.4e-08  |g|= 5.82e-05  |ddm|= 8.49e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000139035
diis-c [-4.18659727e-10  2.07317646e-04  4.48882820e-04 -1.53215205e-01
  1.15255900e+00]
  HOMO = -0.844538966474452  LUMO = 1.09219272226458
  mo_energy =
[-3.27680757e+01 -1.92514945e+00 -8.44538966e-01 -8.44538966e-01
 -8.44538966e-01  1.09219272e+00  1.09219272e+00  1.09219272e+00
  2.01110821e+00  5.69258343e+00  5.69258343e+00  5.69258343e+00
  1.92982414e+01  2.40413645e+01  2.40413645e+01  2.40413645e+01
  9.37000196e+01  1.18811842e+02  1.18811842e+02  1.18811842e+02
  3.56014171e+02  1.34935146e+03  5.83576419e+03  3.50983573e+04]
E1 = -182.60287538114613  E_coul = 54.07460707378858
cycle= 5 E= -128.528268307358  delta_E= -3.39e-10  |g|= 3.65e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60287538114613  E_coul = 54.07460707378858
  HOMO = -0.844537211151277  LUMO = 1.09219347720528
  mo_energy =
[-3.27680719e+01 -1.92514709e+00 -8.44537211e-01 -8.44537211e-01
 -8.44537211e-01  1.09219348e+00  1.09219348e+00  1.09219348e+00
  2.01111002e+00  5.69258562e+00  5.69258562e+00  5.69258562e+00
  1.92982448e+01  2.40413679e+01  2.40413679e+01  2.40413679e+01
  9.37000232e+01  1.18811846e+02  1.18811846e+02  1.18811846e+02
  3.56014174e+02  1.34935146e+03  5.83576419e+03  3.50983573e+04]
E1 = -182.60286694281254  E_coul = 54.07459863545414
Extra cycle  E= -128.528268307358  delta_E= -8.53e-13  |g|= 1.21e-06  |ddm|= 1.88e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906017e+02
 2.04948783e+01 5.69617568e+01 4.87430606e-01 7.82750197e+00
 1.65422572e+00 3.68193863e+00 1.24401063e+01 5.47526483e+01
 3.30845310e-01 1.14437727e+00]
E = -128.52826830735842
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968187         1
[INPUT] 0    0    [1    /1   ]  617.498599923        1
[INPUT] 0    0    [1    /1   ]  174.90601681         1
[INPUT] 0    0    [1    /1   ]  20.4948782521        1
[INPUT] 0    0    [1    /1   ]  56.9617567584        1
[INPUT] 0    0    [1    /1   ]  0.487430605889       1
[INPUT] 0    0    [1    /1   ]  7.82750196851        1
[INPUT] 0    0    [1    /1   ]  1.65422572399        1
[INPUT] 1    0    [1    /1   ]  3.68193862965        1
[INPUT] 1    0    [1    /1   ]  12.4401062697        1
[INPUT] 1    0    [1    /1   ]  54.752648301         1
[INPUT] 1    0    [1    /1   ]  0.330845310349       1
[INPUT] 1    0    [1    /1   ]  1.14437726912        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730068942, 1.0]], [0, [2712.096818701675, 1.0]], [0, [617.4985999230122, 1.0]], [0, [174.9060168103256, 1.0]], [0, [20.494878252052462, 1.0]], [0, [56.96175675843163, 1.0]], [0, [0.4874306058886835, 1.0]], [0, [7.82750196851329, 1.0]], [0, [1.6542257239856788, 1.0]], [1, [3.6819386296497383, 1.0]], [1, [12.440106269745918, 1.0]], [1, [54.752648300984625, 1.0]], [1, [0.3308453103493317, 1.0]], [1, [1.1443772691236038, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968187]
bas 2, expnt(s) = [617.49859992]
bas 3, expnt(s) = [174.90601681]
bas 4, expnt(s) = [20.49487825]
bas 5, expnt(s) = [56.96175676]
bas 6, expnt(s) = [0.48743061]
bas 7, expnt(s) = [7.82750197]
bas 8, expnt(s) = [1.65422572]
bas 9, expnt(s) = [3.68193863]
bas 10, expnt(s) = [12.44010627]
bas 11, expnt(s) = [54.7526483]
bas 12, expnt(s) = [0.33084531]
bas 13, expnt(s) = [1.14437727]
CPU time:       173.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906017e+02 1.21511837e+02
 2.04948783e+01 2.43359907e+01 5.69617568e+01 5.23844701e+01
 4.87430606e-01 1.47383756e+00 7.82750197e+00 1.18231286e+01
 1.65422572e+00 3.68520033e+00 3.68193863e+00 1.48792169e+01
 1.24401063e+01 6.81576339e+01 5.47526483e+01 4.34501025e+02
 3.30845310e-01 7.32007653e-01 1.14437727e+00 3.45299477e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998015401398039
cond(S) = 239.66986063271614
E1 = -183.57460853177471  E_coul = 55.079767983439694
init E= -128.494840548335
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773874445866589  LUMO = 1.11737320360975
  mo_energy =
[-3.25545034e+01 -1.85135819e+00 -7.73874446e-01 -7.73874446e-01
 -7.73874446e-01  1.11737320e+00  1.11737320e+00  1.11737320e+00
  2.06094261e+00  5.77899161e+00  5.77899161e+00  5.77899161e+00
  1.94435695e+01  2.41983190e+01  2.41983190e+01  2.41983190e+01
  9.39007185e+01  1.19027575e+02  1.19027575e+02  1.19027575e+02
  3.56250128e+02  1.34961969e+03  5.83606151e+03  3.50986751e+04]
E1 = -182.11669403535672  E_coul = 53.591765298481775
cycle= 1 E= -128.524928736875  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442967
diis-c [-0.19622012  1.        ]
  HOMO = -0.878556834475661  LUMO = 1.07978839963696
  mo_energy =
[-3.28723413e+01 -1.96107832e+00 -8.78556834e-01 -8.78556834e-01
 -8.78556834e-01  1.07978840e+00  1.07978840e+00  1.07978840e+00
  1.98697865e+00  5.65099781e+00  5.65099781e+00  5.65099781e+00
  1.92267544e+01  2.39643876e+01  2.39643876e+01  2.39643876e+01
  9.36016017e+01  1.18707575e+02  1.18707575e+02  1.18707575e+02
  3.55903285e+02  1.34923454e+03  5.83564446e+03  3.50982365e+04]
E1 = -182.8452184760969  E_coul = 54.3177854551328
cycle= 2 E= -128.527433020964  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219721
diis-c [-5.67161981e-04  3.30572341e-01  6.69427659e-01]
  HOMO = -0.844310794795565  LUMO = 1.09223565699374
  mo_energy =
[-3.27676066e+01 -1.92498150e+00 -8.44310795e-01 -8.44310795e-01
 -8.44310795e-01  1.09223566e+00  1.09223566e+00  1.09223566e+00
  2.01119366e+00  5.69279211e+00  5.69279211e+00  5.69279211e+00
  1.92985475e+01  2.40417163e+01  2.40417163e+01  2.40417163e+01
  9.37004575e+01  1.18812323e+02  1.18812323e+02  1.18812323e+02
  3.56014730e+02  1.34935215e+03  5.83576500e+03  3.50983582e+04]
E1 = -182.60211015519246  E_coul = 54.073841862134024
cycle= 3 E= -128.528268293058  delta_E= -0.000835  |g|= 0.000428  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000994414
diis-c [-7.59220208e-08 -2.04618557e-03  2.34189288e-04  1.00181200e+00]
  HOMO = -0.844512902228765  LUMO = 1.09220291072387
  mo_energy =
[-3.27680209e+01 -1.92513076e+00 -8.44512902e-01 -8.44512902e-01
 -8.44512902e-01  1.09220291e+00  1.09220291e+00  1.09220291e+00
  2.01112207e+00  5.69261419e+00  5.69261419e+00  5.69261419e+00
  1.92982817e+01  2.40414098e+01  2.40414098e+01  2.40414098e+01
  9.37000721e+01  1.18811897e+02  1.18811897e+02  1.18811897e+02
  3.56014232e+02  1.34935153e+03  5.83576427e+03  3.50983574e+04]
E1 = -182.6027463324414  E_coul = 54.07447802542332
cycle= 4 E= -128.528268307018  delta_E= -1.4e-08  |g|= 5.82e-05  |ddm|= 8.49e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000139035
diis-c [-4.18659727e-10  2.07317646e-04  4.48882820e-04 -1.53215205e-01
  1.15255900e+00]
  HOMO = -0.844538966474452  LUMO = 1.09219272226458
  mo_energy =
[-3.27680757e+01 -1.92514945e+00 -8.44538966e-01 -8.44538966e-01
 -8.44538966e-01  1.09219272e+00  1.09219272e+00  1.09219272e+00
  2.01110821e+00  5.69258343e+00  5.69258343e+00  5.69258343e+00
  1.92982414e+01  2.40413645e+01  2.40413645e+01  2.40413645e+01
  9.37000196e+01  1.18811842e+02  1.18811842e+02  1.18811842e+02
  3.56014171e+02  1.34935146e+03  5.83576419e+03  3.50983573e+04]
E1 = -182.60287538114613  E_coul = 54.07460707378858
cycle= 5 E= -128.528268307358  delta_E= -3.39e-10  |g|= 3.65e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60287538114613  E_coul = 54.07460707378858
  HOMO = -0.844537211151277  LUMO = 1.09219347720528
  mo_energy =
[-3.27680719e+01 -1.92514709e+00 -8.44537211e-01 -8.44537211e-01
 -8.44537211e-01  1.09219348e+00  1.09219348e+00  1.09219348e+00
  2.01111002e+00  5.69258562e+00  5.69258562e+00  5.69258562e+00
  1.92982448e+01  2.40413679e+01  2.40413679e+01  2.40413679e+01
  9.37000232e+01  1.18811846e+02  1.18811846e+02  1.18811846e+02
  3.56014174e+02  1.34935146e+03  5.83576419e+03  3.50983573e+04]
E1 = -182.60286694281254  E_coul = 54.07459863545414
Extra cycle  E= -128.528268307358  delta_E= -8.53e-13  |g|= 1.21e-06  |ddm|= 1.88e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.66986063271614
E1 = -182.60286694281254  E_coul = 54.07459863545414
init E= -128.528268307358
    CPU time for initialize scf      0.16 sec, wall time      0.16 sec
  HOMO = -0.844537811412568  LUMO = 1.09219327039007
  mo_energy =
[-3.27680738e+01 -1.92514761e+00 -8.44537811e-01 -8.44537811e-01
 -8.44537811e-01  1.09219327e+00  1.09219327e+00  1.09219327e+00
  2.01110969e+00  5.69258489e+00  5.69258489e+00  5.69258489e+00
  1.92982435e+01  2.40413665e+01  2.40413665e+01  2.40413665e+01
  9.37000215e+01  1.18811844e+02  1.18811844e+02  1.18811844e+02
  3.56014172e+02  1.34935146e+03  5.83576419e+03  3.50983573e+04]
E1 = -182.60287152645037  E_coul = 54.074603219091685
cycle= 1 E= -128.528268307359  delta_E= -2.84e-13  |g|= 6.34e-07  |ddm|= 4.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.60287152645037  E_coul = 54.074603219091685
  HOMO = -0.844537491383638  LUMO = 1.09219338862624
  mo_energy =
[-3.27680728e+01 -1.92514725e+00 -8.44537491e-01 -8.44537491e-01
 -8.44537491e-01  1.09219339e+00  1.09219339e+00  1.09219339e+00
  2.01110993e+00  5.69258529e+00  5.69258529e+00  5.69258529e+00
  1.92982442e+01  2.40413672e+01  2.40413672e+01  2.40413672e+01
  9.37000224e+01  1.18811845e+02  1.18811845e+02  1.18811845e+02
  3.56014173e+02  1.34935146e+03  5.83576419e+03  3.50983573e+04]
E1 = -182.60286928125387  E_coul = 54.074600973895286
Extra cycle  E= -128.528268307359  delta_E= 1.14e-13  |g|= 3.05e-07  |ddm|= 2.67e-07
    CPU time for scf_cycle      0.22 sec, wall time      0.21 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906017e+02
 2.04948783e+01 5.69617568e+01 4.87430606e-01 7.82750197e+00
 1.65422572e+00 3.68193863e+00 1.24401063e+01 5.47526483e+01
 3.30845310e-01 1.14437727e+00]
grad_E = [-1.91045726e-11  1.24652284e-09 -3.00150263e-08  4.44826040e-07
  4.23972179e-06 -3.56879665e-06 -1.56595137e-06  4.77222544e-06
  2.10300765e-07  6.44795506e-08  2.04166675e-08  2.45826038e-09
 -1.92317394e-07  4.23666862e-08]
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -128.52826830735842
       x: [ 1.808e+04  2.712e+03 ...  3.308e-01  1.144e+00]
     nit: 55
     jac: [-1.910e-11  1.247e-09 ... -1.923e-07  4.237e-08]
    nfev: 61
    njev: 55
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s5p"

exps = np.zeros((14, 2))
exps[:-1, 0] = basis_sets["9s4p"][:]
exps[-1, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:40:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968187         1
[INPUT] 0    0    [1    /1   ]  617.498599923        1
[INPUT] 0    0    [1    /1   ]  174.90601681         1
[INPUT] 0    0    [1    /1   ]  20.4948782521        1
[INPUT] 0    0    [1    /1   ]  56.9617567584        1
[INPUT] 0    0    [1    /1   ]  0.487430605889       1
[INPUT] 0    0    [1    /1   ]  7.82750196851        1
[INPUT] 0    0    [1    /1   ]  1.65422572399        1
[INPUT] 1    0    [1    /1   ]  3.68193862965        1
[INPUT] 1    0    [1    /1   ]  12.4401062697        1
[INPUT] 1    0    [1    /1   ]  54.752648301         1
[INPUT] 1    0    [1    /1   ]  0.330845310349       1
[INPUT] 1    0    [1    /1   ]  1.14437726912        1

nuclear repulsion = 0
number of shells = 14
number of NR pGTOs = 24
number of NR cGTOs = 24
basis = {'Ne': [[0, [18076.478730068942, 1.0]], [0, [2712.096818701675, 1.0]], [0, [617.4985999230122, 1.0]], [0, [174.9060168103256, 1.0]], [0, [20.494878252052462, 1.0]], [0, [56.96175675843163, 1.0]], [0, [0.4874306058886835, 1.0]], [0, [7.82750196851329, 1.0]], [0, [1.6542257239856788, 1.0]], [1, [3.6819386296497383, 1.0]], [1, [12.440106269745918, 1.0]], [1, [54.752648300984625, 1.0]], [1, [0.3308453103493317, 1.0]], [1, [1.1443772691236038, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968187]
bas 2, expnt(s) = [617.49859992]
bas 3, expnt(s) = [174.90601681]
bas 4, expnt(s) = [20.49487825]
bas 5, expnt(s) = [56.96175676]
bas 6, expnt(s) = [0.48743061]
bas 7, expnt(s) = [7.82750197]
bas 8, expnt(s) = [1.65422572]
bas 9, expnt(s) = [3.68193863]
bas 10, expnt(s) = [12.44010627]
bas 11, expnt(s) = [54.7526483]
bas 12, expnt(s) = [0.33084531]
bas 13, expnt(s) = [1.14437727]
CPU time:       176.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906017e+02 1.21511837e+02
 2.04948783e+01 2.43359907e+01 5.69617568e+01 5.23844701e+01
 4.87430606e-01 1.47383756e+00 7.82750197e+00 1.18231286e+01
 1.65422572e+00 3.68520033e+00 3.68193863e+00 1.48792169e+01
 1.24401063e+01 6.81576339e+01 5.47526483e+01 4.34501025e+02
 3.30845310e-01 7.32007653e-01 1.14437727e+00 3.45299477e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998015401398039
cond(S) = 239.66986063271614
E1 = -183.57460853177471  E_coul = 55.079767983439694
init E= -128.494840548335
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.773874445866589  LUMO = 1.11737320360975
  mo_energy =
[-3.25545034e+01 -1.85135819e+00 -7.73874446e-01 -7.73874446e-01
 -7.73874446e-01  1.11737320e+00  1.11737320e+00  1.11737320e+00
  2.06094261e+00  5.77899161e+00  5.77899161e+00  5.77899161e+00
  1.94435695e+01  2.41983190e+01  2.41983190e+01  2.41983190e+01
  9.39007185e+01  1.19027575e+02  1.19027575e+02  1.19027575e+02
  3.56250128e+02  1.34961969e+03  5.83606151e+03  3.50986751e+04]
E1 = -182.11669403535672  E_coul = 53.591765298481775
cycle= 1 E= -128.524928736875  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.442967
diis-c [-0.19622012  1.        ]
  HOMO = -0.878556834475661  LUMO = 1.07978839963696
  mo_energy =
[-3.28723413e+01 -1.96107832e+00 -8.78556834e-01 -8.78556834e-01
 -8.78556834e-01  1.07978840e+00  1.07978840e+00  1.07978840e+00
  1.98697865e+00  5.65099781e+00  5.65099781e+00  5.65099781e+00
  1.92267544e+01  2.39643876e+01  2.39643876e+01  2.39643876e+01
  9.36016017e+01  1.18707575e+02  1.18707575e+02  1.18707575e+02
  3.55903285e+02  1.34923454e+03  5.83564446e+03  3.50982365e+04]
E1 = -182.8452184760969  E_coul = 54.3177854551328
cycle= 2 E= -128.527433020964  delta_E= -0.0025  |g|= 0.0993  |ddm|= 0.077
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.219721
diis-c [-5.67161981e-04  3.30572341e-01  6.69427659e-01]
  HOMO = -0.844310794795565  LUMO = 1.09223565699374
  mo_energy =
[-3.27676066e+01 -1.92498150e+00 -8.44310795e-01 -8.44310795e-01
 -8.44310795e-01  1.09223566e+00  1.09223566e+00  1.09223566e+00
  2.01119366e+00  5.69279211e+00  5.69279211e+00  5.69279211e+00
  1.92985475e+01  2.40417163e+01  2.40417163e+01  2.40417163e+01
  9.37004575e+01  1.18812323e+02  1.18812323e+02  1.18812323e+02
  3.56014730e+02  1.34935215e+03  5.83576500e+03  3.50983582e+04]
E1 = -182.60211015519246  E_coul = 54.073841862134024
cycle= 3 E= -128.528268293058  delta_E= -0.000835  |g|= 0.000428  |ddm|= 0.0263
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000994414
diis-c [-7.59220208e-08 -2.04618557e-03  2.34189288e-04  1.00181200e+00]
  HOMO = -0.844512902228765  LUMO = 1.09220291072387
  mo_energy =
[-3.27680209e+01 -1.92513076e+00 -8.44512902e-01 -8.44512902e-01
 -8.44512902e-01  1.09220291e+00  1.09220291e+00  1.09220291e+00
  2.01112207e+00  5.69261419e+00  5.69261419e+00  5.69261419e+00
  1.92982817e+01  2.40414098e+01  2.40414098e+01  2.40414098e+01
  9.37000721e+01  1.18811897e+02  1.18811897e+02  1.18811897e+02
  3.56014232e+02  1.34935153e+03  5.83576427e+03  3.50983574e+04]
E1 = -182.6027463324414  E_coul = 54.07447802542332
cycle= 4 E= -128.528268307018  delta_E= -1.4e-08  |g|= 5.82e-05  |ddm|= 8.49e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000139035
diis-c [-4.18659727e-10  2.07317646e-04  4.48882820e-04 -1.53215205e-01
  1.15255900e+00]
  HOMO = -0.844538966474452  LUMO = 1.09219272226458
  mo_energy =
[-3.27680757e+01 -1.92514945e+00 -8.44538966e-01 -8.44538966e-01
 -8.44538966e-01  1.09219272e+00  1.09219272e+00  1.09219272e+00
  2.01110821e+00  5.69258343e+00  5.69258343e+00  5.69258343e+00
  1.92982414e+01  2.40413645e+01  2.40413645e+01  2.40413645e+01
  9.37000196e+01  1.18811842e+02  1.18811842e+02  1.18811842e+02
  3.56014171e+02  1.34935146e+03  5.83576419e+03  3.50983573e+04]
E1 = -182.60287538114613  E_coul = 54.07460707378858
cycle= 5 E= -128.528268307358  delta_E= -3.39e-10  |g|= 3.65e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.60287538114613  E_coul = 54.07460707378858
  HOMO = -0.844537211151277  LUMO = 1.09219347720528
  mo_energy =
[-3.27680719e+01 -1.92514709e+00 -8.44537211e-01 -8.44537211e-01
 -8.44537211e-01  1.09219348e+00  1.09219348e+00  1.09219348e+00
  2.01111002e+00  5.69258562e+00  5.69258562e+00  5.69258562e+00
  1.92982448e+01  2.40413679e+01  2.40413679e+01  2.40413679e+01
  9.37000232e+01  1.18811846e+02  1.18811846e+02  1.18811846e+02
  3.56014174e+02  1.34935146e+03  5.83576419e+03  3.50983573e+04]
E1 = -182.60286694281254  E_coul = 54.07459863545414
Extra cycle  E= -128.528268307358  delta_E= -8.53e-13  |g|= 1.21e-06  |ddm|= 1.88e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906017e+02
 2.04948783e+01 5.69617568e+01 4.87430606e-01 7.82750197e+00
 1.65422572e+00 3.68193863e+00 1.24401063e+01 5.47526483e+01
 3.30845310e-01 1.14437727e+00]
E = -128.52826830735842
E = -128.52826830735842
exponents = [
S
1.8076478730068942e+04
2.7120968187016751e+03
6.1749859992301219e+02
1.7490601681032561e+02
2.0494878252052462e+01
5.6961756758431633e+01
4.8743060588868348e-01
7.8275019685132898e+00
1.6542257239856788e+00

P
3.6819386296497383e+00
1.2440106269745918e+01
5.4752648300984625e+01
3.3084531034933168e-01
1.1443772691236038e+00

]
exp = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
