#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98686019        1
[INPUT] 0    0    [1    /1   ]  503.798686019        1
[INPUT] 0    0    [1    /1   ]  75.8238111816        1
[INPUT] 0    0    [1    /1   ]  17.1878570306        1
[INPUT] 0    0    [1    /1   ]  4.71331044402        1
[INPUT] 0    0    [1    /1   ]  1.41880355283        1
[INPUT] 0    0    [1    /1   ]  0.104548908447       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986860191136, 1.0]], [0, [503.7986860191136, 1.0]], [0, [75.82381118159361, 1.0]], [0, [17.187857030572196, 1.0]], [0, [4.713310444019635, 1.0]], [0, [1.4188035528345215, 1.0]], [0, [0.10454890844699254, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98686019]
bas 1, expnt(s) = [503.79868602]
bas 2, expnt(s) = [75.82381118]
bas 3, expnt(s) = [17.18785703]
bas 4, expnt(s) = [4.71331044]
bas 5, expnt(s) = [1.41880355]
bas 6, expnt(s) = [0.10454891]
CPU time:         1.62
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798686e+02 2.68662961e+02
 7.58238112e+01 6.49186129e+01 1.71878570e+01 2.13270763e+01
 4.71331044e+00 8.08182716e+00 1.41880355e+00 3.28440515e+00
 1.04548908e-01 4.64520250e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987336813697735
cond(S) = 43.77395816426766
E1 = -19.062732766185107  E_coul = 4.5289522976263275
init E= -14.5337804685588
    CPU time for initialize scf      0.11 sec, wall time      0.11 sec
  HOMO = -0.300697698299347  LUMO = 3.72715245679481
  mo_energy =
[-4.71381824e+00 -3.00697698e-01  3.72715246e+00  2.63309064e+01
  1.37710980e+02  8.99212185e+02  8.66897218e+03]
E1 = -19.05663782244476  E_coul = 4.498171395360906
cycle= 1 E= -14.5584664270839  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.25 sec, wall time      0.26 sec
diis-norm(errvec)=0.0143088
diis-c [-2.04743041e-04  1.00000000e+00]
  HOMO = -0.300655780782569  LUMO = 3.72295380742851
  mo_energy =
[-4.72950902e+00 -3.00655781e-01  3.72295381e+00  2.63137259e+01
  1.37687192e+02  8.99182644e+02  8.66893986e+03]
E1 = -19.05338371013891  E_coul = 4.494879854811427
cycle= 2 E= -14.5585038553275  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.07 sec, wall time      0.07 sec
diis-norm(errvec)=0.00171061
diis-c [-7.71052132e-07 -1.14566256e-01  1.11456626e+00]
  HOMO = -0.300811307896137  LUMO = 3.72224658892899
  mo_energy =
[-4.73118956e+00 -3.00811308e-01  3.72224659e+00  2.63120431e+01
  1.37685201e+02  8.99180461e+02  8.66893761e+03]
E1 = -19.053115347159128  E_coul = 4.494611221662962
cycle= 3 E= -14.5585041254962  delta_E= -2.7e-07  |g|= 3.09e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.01712e-05
diis-c [-2.60999487e-10  9.02629071e-04 -5.59376357e-04  9.99656747e-01]
  HOMO = -0.300807548912314  LUMO = 3.72226965328038
  mo_energy =
[-4.73113737e+00 -3.00807549e-01  3.72226965e+00  2.63121116e+01
  1.37685306e+02  8.99180592e+02  8.66893775e+03]
E1 = -19.053122379243085  E_coul = 4.494618253649997
cycle= 4 E= -14.5585041255931  delta_E= -9.69e-11  |g|= 1.21e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053122379243085  E_coul = 4.494618253649997
  HOMO = -0.300807439010929  LUMO = 3.72227046833716
  mo_energy =
[-4.73113550e+00 -3.00807439e-01  3.72227047e+00  2.63121142e+01
  1.37685310e+02  8.99180597e+02  8.66893776e+03]
E1 = -19.053122635153386  E_coul = 4.494618509560178
Extra cycle  E= -14.5585041255932  delta_E= -1.19e-13  |g|= 8.56e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.46 sec, wall time      0.47 sec
exp = [5.03798686e+03 5.03798686e+02 7.58238112e+01 1.71878570e+01
 4.71331044e+00 1.41880355e+00 1.04548908e-01]
E = -14.558504125593208
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98686019        1
[INPUT] 0    0    [1    /1   ]  503.798686019        1
[INPUT] 0    0    [1    /1   ]  75.8238111816        1
[INPUT] 0    0    [1    /1   ]  17.1878570306        1
[INPUT] 0    0    [1    /1   ]  4.71331044402        1
[INPUT] 0    0    [1    /1   ]  1.41880355283        1
[INPUT] 0    0    [1    /1   ]  0.104548908447       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986860191136, 1.0]], [0, [503.7986860191136, 1.0]], [0, [75.82381118159361, 1.0]], [0, [17.187857030572196, 1.0]], [0, [4.713310444019635, 1.0]], [0, [1.4188035528345215, 1.0]], [0, [0.10454890844699254, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98686019]
bas 1, expnt(s) = [503.79868602]
bas 2, expnt(s) = [75.82381118]
bas 3, expnt(s) = [17.18785703]
bas 4, expnt(s) = [4.71331044]
bas 5, expnt(s) = [1.41880355]
bas 6, expnt(s) = [0.10454891]
CPU time:         2.22
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798686e+02 2.68662961e+02
 7.58238112e+01 6.49186129e+01 1.71878570e+01 2.13270763e+01
 4.71331044e+00 8.08182716e+00 1.41880355e+00 3.28440515e+00
 1.04548908e-01 4.64520250e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987336813697735
cond(S) = 43.77395816426766
E1 = -19.062732766185107  E_coul = 4.5289522976263275
init E= -14.5337804685588
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300697698299347  LUMO = 3.72715245679481
  mo_energy =
[-4.71381824e+00 -3.00697698e-01  3.72715246e+00  2.63309064e+01
  1.37710980e+02  8.99212185e+02  8.66897218e+03]
E1 = -19.05663782244476  E_coul = 4.498171395360906
cycle= 1 E= -14.5584664270839  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143088
diis-c [-2.04743041e-04  1.00000000e+00]
  HOMO = -0.300655780782569  LUMO = 3.72295380742851
  mo_energy =
[-4.72950902e+00 -3.00655781e-01  3.72295381e+00  2.63137259e+01
  1.37687192e+02  8.99182644e+02  8.66893986e+03]
E1 = -19.05338371013891  E_coul = 4.494879854811427
cycle= 2 E= -14.5585038553275  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171061
diis-c [-7.71052132e-07 -1.14566256e-01  1.11456626e+00]
  HOMO = -0.300811307896137  LUMO = 3.72224658892899
  mo_energy =
[-4.73118956e+00 -3.00811308e-01  3.72224659e+00  2.63120431e+01
  1.37685201e+02  8.99180461e+02  8.66893761e+03]
E1 = -19.053115347159128  E_coul = 4.494611221662962
cycle= 3 E= -14.5585041254962  delta_E= -2.7e-07  |g|= 3.09e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.01712e-05
diis-c [-2.60999487e-10  9.02629071e-04 -5.59376357e-04  9.99656747e-01]
  HOMO = -0.300807548912314  LUMO = 3.72226965328038
  mo_energy =
[-4.73113737e+00 -3.00807549e-01  3.72226965e+00  2.63121116e+01
  1.37685306e+02  8.99180592e+02  8.66893775e+03]
E1 = -19.053122379243085  E_coul = 4.494618253649997
cycle= 4 E= -14.5585041255931  delta_E= -9.69e-11  |g|= 1.21e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053122379243085  E_coul = 4.494618253649997
  HOMO = -0.300807439010929  LUMO = 3.72227046833716
  mo_energy =
[-4.73113550e+00 -3.00807439e-01  3.72227047e+00  2.63121142e+01
  1.37685310e+02  8.99180597e+02  8.66893776e+03]
E1 = -19.053122635153386  E_coul = 4.494618509560178
Extra cycle  E= -14.5585041255932  delta_E= -1.19e-13  |g|= 8.56e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.06 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.77395816426766
E1 = -19.053122635153386  E_coul = 4.494618509560178
init E= -14.5585041255932
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.300807431027148  LUMO = 3.7222705203441
  mo_energy =
[-4.73113538e+00 -3.00807431e-01  3.72227052e+00  2.63121144e+01
  1.37685310e+02  8.99180597e+02  8.66893776e+03]
E1 = -19.05312265257817  E_coul = 4.494618526984954
cycle= 1 E= -14.5585041255932  delta_E= -8.88e-15  |g|= 6.34e-09  |ddm|= 5.89e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.05312265257817  E_coul = 4.494618526984954
  HOMO = -0.300807430424469  LUMO = 3.72227052384387
  mo_energy =
[-4.73113537e+00 -3.00807430e-01  3.72227052e+00  2.63121144e+01
  1.37685310e+02  8.99180597e+02  8.66893776e+03]
E1 = -19.053122653821195  E_coul = 4.494618528227995
Extra cycle  E= -14.5585041255932  delta_E= 1.78e-14  |g|= 5.01e-10  |ddm|= 4.61e-09
    CPU time for scf_cycle      0.82 sec, wall time      0.83 sec
exp = [5.03798686e+03 5.03798686e+02 7.58238112e+01 1.71878570e+01
 4.71331044e+00 1.41880355e+00 1.04548908e-01]
grad_E = [ 4.86352298e-08  9.30958976e-06 -3.81654503e-05  1.01246204e-04
 -1.99386711e-04  2.34912906e-04 -5.15669233e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98686014        1
[INPUT] 0    0    [1    /1   ]  503.79867671         1
[INPUT] 0    0    [1    /1   ]  75.823849347         1
[INPUT] 0    0    [1    /1   ]  17.1877557844        1
[INPUT] 0    0    [1    /1   ]  4.71350983073        1
[INPUT] 0    0    [1    /1   ]  1.41856863993        1
[INPUT] 0    0    [1    /1   ]  0.10506457768        1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.9868601425005, 1.0]], [0, [503.7986767095238, 1.0]], [0, [75.82384934704389, 1.0]], [0, [17.187755784368267, 1.0]], [0, [4.7135098307310495, 1.0]], [0, [1.4185686399288726, 1.0]], [0, [0.10506457768012727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98686014]
bas 1, expnt(s) = [503.79867671]
bas 2, expnt(s) = [75.82384935]
bas 3, expnt(s) = [17.18775578]
bas 4, expnt(s) = [4.71350983]
bas 5, expnt(s) = [1.41856864]
bas 6, expnt(s) = [0.10506458]
CPU time:         6.50
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798677e+02 2.68662957e+02
 7.58238493e+01 6.49186374e+01 1.71877558e+01 2.13269821e+01
 4.71350983e+00 8.08208358e+00 1.41856864e+00 3.28399729e+00
 1.05064578e-01 4.66237567e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9872932382465147
cond(S) = 43.78702391481652
E1 = -19.066463734854473  E_coul = 4.5314972229766335
init E= -14.5349665118778
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300410455486417  LUMO = 3.73005474250546
  mo_energy =
[-4.71284602e+00 -3.00410455e-01  3.73005474e+00  2.63331570e+01
  1.37712983e+02  8.99213988e+02  8.66897376e+03]
E1 = -19.060812368050147  E_coul = 4.502349014094164
cycle= 1 E= -14.558463353956  delta_E= -0.0235  |g|= 0.0181  |ddm|= 0.232
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0139215
diis-c [-1.93808119e-04  1.00000000e+00]
  HOMO = -0.300279641341204  LUMO = 3.72620515000949
  mo_energy =
[-4.72779382e+00 -3.00279641e-01  3.72620515e+00  2.63167859e+01
  1.37690197e+02  8.99185579e+02  8.66894261e+03]
E1 = -19.057648540458228  E_coul = 4.499149904272648
cycle= 2 E= -14.5584986361856  delta_E= -3.53e-05  |g|= 0.00143  |ddm|= 0.0135
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00166128
diis-c [-7.54854176e-07 -1.13475004e-01  1.11347500e+00]
  HOMO = -0.300430867373175  LUMO = 3.72551897485988
  mo_energy =
[-4.72942531e+00 -3.00430867e-01  3.72551897e+00  2.63151520e+01
  1.37688260e+02  8.99183452e+02  8.66894042e+03]
E1 = -19.057387835145306  E_coul = 4.498888943887681
cycle= 3 E= -14.5584988912576  delta_E= -2.55e-07  |g|= 2.89e-05  |ddm|= 0.00118
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.86539e-05
diis-c [-2.45382851e-10  8.87337366e-04 -1.56114791e-03  1.00067381e+00]
  HOMO = -0.3004273723548  LUMO = 3.72554066965165
  mo_energy =
[-4.72937627e+00 -3.00427372e-01  3.72554067e+00  2.63152169e+01
  1.37688361e+02  8.99183578e+02  8.66894056e+03]
E1 = -19.057394397067576  E_coul = 4.498895505727394
cycle= 4 E= -14.5584988913402  delta_E= -8.26e-11  |g|= 1.18e-06  |ddm|= 2.22e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.057394397067576  E_coul = 4.498895505727394
  HOMO = -0.300427263474425  LUMO = 3.72554146920684
  mo_energy =
[-4.72937443e+00 -3.00427263e-01  3.72554147e+00  2.63152195e+01
  1.37688364e+02  8.99183583e+02  8.66894056e+03]
E1 = -19.057394648623532  E_coul = 4.49889575728324
Extra cycle  E= -14.5584988913403  delta_E= -1.1e-13  |g|= 8.4e-08  |ddm|= 7.78e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.06 sec
exp = [5.03798686e+03 5.03798677e+02 7.58238493e+01 1.71877558e+01
 4.71350983e+00 1.41856864e+00 1.05064578e-01]
E = -14.558498891340292
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98686019        1
[INPUT] 0    0    [1    /1   ]  503.798685088        1
[INPUT] 0    0    [1    /1   ]  75.8238149981        1
[INPUT] 0    0    [1    /1   ]  17.187846906         1
[INPUT] 0    0    [1    /1   ]  4.71333038269        1
[INPUT] 0    0    [1    /1   ]  1.41878006154        1
[INPUT] 0    0    [1    /1   ]  0.10460047537        1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986860186272, 1.0]], [0, [503.7986850881546, 1.0]], [0, [75.82381499813864, 1.0]], [0, [17.187846905951805, 1.0]], [0, [4.713330382690777, 1.0]], [0, [1.4187800615439567, 1.0]], [0, [0.104600475370306, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98686019]
bas 1, expnt(s) = [503.79868509]
bas 2, expnt(s) = [75.823815]
bas 3, expnt(s) = [17.18784691]
bas 4, expnt(s) = [4.71333038]
bas 5, expnt(s) = [1.41878006]
bas 6, expnt(s) = [0.10460048]
CPU time:         6.61
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798685e+02 2.68662961e+02
 7.58238150e+01 6.49186153e+01 1.71878469e+01 2.13270669e+01
 4.71333038e+00 8.08185281e+00 1.41878006e+00 3.28436437e+00
 1.04600475e-01 4.64692077e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873335725550065
cond(S) = 43.77526296679584
E1 = -19.06311042595428  E_coul = 4.52920858003346
init E= -14.5339018459208
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300668998935758  LUMO = 3.72744335793093
  mo_energy =
[-4.71372037e+00 -3.00668999e-01  3.72744336e+00  2.63311320e+01
  1.37711181e+02  8.99212366e+02  8.66897234e+03]
E1 = -19.05705656839077  E_coul = 4.498589940881421
cycle= 1 E= -14.5584666275094  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142699
diis-c [-2.03630026e-04  1.00000000e+00]
  HOMO = -0.300618355061422  LUMO = 3.72327920914084
  mo_energy =
[-4.72933717e+00 -3.00618355e-01  3.72327921e+00  2.63140322e+01
  1.37687493e+02  8.99182938e+02  8.66894014e+03]
E1 = -19.053811487133  E_coul = 4.4953076492299715
cycle= 2 E= -14.558503837903  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170567
diis-c [-7.69431808e-07 -1.14461825e-01  1.11446182e+00]
  HOMO = -0.300773452668732  LUMO = 3.72257409578484
  mo_energy =
[-4.73101281e+00 -3.00773453e-01  3.72257410e+00  2.63123543e+01
  1.37685507e+02  8.99180761e+02  8.66893789e+03]
E1 = -19.05354388916339  E_coul = 4.495039782622732
cycle= 3 E= -14.5585041065407  delta_E= -2.69e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00141e-05
diis-c [-2.59412784e-10  9.01055951e-04 -6.54789168e-04  9.99753733e-01]
  HOMO = -0.300769719830915  LUMO = 3.72259702413081
  mo_energy =
[-4.73096093e+00 -3.00769720e-01  3.72259702e+00  2.63124224e+01
  1.37685612e+02  8.99180891e+02  8.66893803e+03]
E1 = -19.05355087465295  E_coul = 4.495046768016858
cycle= 4 E= -14.5585041066361  delta_E= -9.54e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05355087465295  E_coul = 4.495046768016858
  HOMO = -0.300769610025658  LUMO = 3.72259783766396
  mo_energy =
[-4.73095906e+00 -3.00769610e-01  3.72259784e+00  2.63124250e+01
  1.37685616e+02  8.99180896e+02  8.66893804e+03]
E1 = -19.0535511301371  E_coul = 4.495047023500884
Extra cycle  E= -14.5585041066362  delta_E= -1.28e-13  |g|= 8.54e-08  |ddm|= 7.87e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.06 sec
exp = [5.03798686e+03 5.03798685e+02 7.58238150e+01 1.71878469e+01
 4.71333038e+00 1.41878006e+00 1.04600475e-01]
E = -14.558504106636217
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98686019        1
[INPUT] 0    0    [1    /1   ]  503.798685711        1
[INPUT] 0    0    [1    /1   ]  75.8238124464        1
[INPUT] 0    0    [1    /1   ]  17.1878536752        1
[INPUT] 0    0    [1    /1   ]  4.71331705187        1
[INPUT] 0    0    [1    /1   ]  1.41879576761        1
[INPUT] 0    0    [1    /1   ]  0.104565998182       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986860189524, 1.0]], [0, [503.7986857105855, 1.0]], [0, [75.82381244643044, 1.0]], [0, [17.18785367518334, 1.0]], [0, [4.71331705187182, 1.0]], [0, [1.4187957676127998, 1.0]], [0, [0.10456599818203244, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98686019]
bas 1, expnt(s) = [503.79868571]
bas 2, expnt(s) = [75.82381245]
bas 3, expnt(s) = [17.18785368]
bas 4, expnt(s) = [4.71331705]
bas 5, expnt(s) = [1.41879577]
bas 6, expnt(s) = [0.104566]
CPU time:         6.71
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798686e+02 2.68662961e+02
 7.58238124e+01 6.49186137e+01 1.71878537e+01 2.13270732e+01
 4.71331705e+00 8.08183566e+00 1.41879577e+00 3.28439164e+00
 1.04565998e-01 4.64577198e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987335767176354
cond(S) = 43.774390543715704
E1 = -19.062858038732664  E_coul = 4.529037276090048
init E= -14.5338207626426
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300688187691902  LUMO = 3.72724888061675
  mo_energy =
[-4.71378579e+00 -3.00688188e-01  3.72724888e+00  2.63309812e+01
  1.37711047e+02  8.99212245e+02  8.66897223e+03]
E1 = -19.05677663044026  E_coul = 4.498310124396656
cycle= 1 E= -14.5584665060436  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142959
diis-c [-2.04373696e-04  1.00000000e+00]
  HOMO = -0.300643382215767  LUMO = 3.72306165503774
  mo_energy =
[-4.72945206e+00 -3.00643382e-01  3.72306166e+00  2.63138274e+01
  1.37687292e+02  8.99182741e+02  8.66893996e+03]
E1 = -19.053525511164377  E_coul = 4.495021649154784
cycle= 2 E= -14.5585038620096  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170897
diis-c [-7.70515115e-07 -1.14531759e-01  1.11453176e+00]
  HOMO = -0.3007987670021  LUMO = 3.72235513422081
  mo_energy =
[-4.73113097e+00 -3.00798767e-01  3.72235513e+00  2.63121463e+01
  1.37685302e+02  8.99180561e+02  8.66893771e+03]
E1 = -19.053257401696907  E_coul = 4.494753270026561
cycle= 3 E= -14.5585041316703  delta_E= -2.7e-07  |g|= 3.08e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.0119e-05
diis-c [-2.60473031e-10  9.02106602e-04 -5.90882478e-04  9.99688776e-01]
  HOMO = -0.300795016677153  LUMO = 3.72237815352217
  mo_energy =
[-4.73107889e+00 -3.00795017e-01  3.72237815e+00  2.63122146e+01
  1.37685408e+02  8.99180691e+02  8.66893785e+03]
E1 = -19.05326441834942  E_coul = 4.494760286582645
cycle= 4 E= -14.5585041317668  delta_E= -9.64e-11  |g|= 1.21e-06  |ddm|= 2.4e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05326441834942  E_coul = 4.494760286582645
  HOMO = -0.300794906807477  LUMO = 3.72237896807469
  mo_energy =
[-4.73107702e+00 -3.00794907e-01  3.72237897e+00  2.63122172e+01
  1.37685412e+02  8.99180696e+02  8.66893785e+03]
E1 = -19.05326467411872  E_coul = 4.494760542351816
Extra cycle  E= -14.5585041317669  delta_E= -1.26e-13  |g|= 8.55e-08  |ddm|= 7.87e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.06 sec
exp = [5.03798686e+03 5.03798686e+02 7.58238124e+01 1.71878537e+01
 4.71331705e+00 1.41879577e+00 1.04565998e-01]
E = -14.558504131766902
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98686019        1
[INPUT] 0    0    [1    /1   ]  503.798685711        1
[INPUT] 0    0    [1    /1   ]  75.8238124464        1
[INPUT] 0    0    [1    /1   ]  17.1878536752        1
[INPUT] 0    0    [1    /1   ]  4.71331705187        1
[INPUT] 0    0    [1    /1   ]  1.41879576761        1
[INPUT] 0    0    [1    /1   ]  0.104565998182       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986860189524, 1.0]], [0, [503.7986857105855, 1.0]], [0, [75.82381244643044, 1.0]], [0, [17.18785367518334, 1.0]], [0, [4.71331705187182, 1.0]], [0, [1.4187957676127998, 1.0]], [0, [0.10456599818203244, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98686019]
bas 1, expnt(s) = [503.79868571]
bas 2, expnt(s) = [75.82381245]
bas 3, expnt(s) = [17.18785368]
bas 4, expnt(s) = [4.71331705]
bas 5, expnt(s) = [1.41879577]
bas 6, expnt(s) = [0.104566]
CPU time:         6.82
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798686e+02 2.68662961e+02
 7.58238124e+01 6.49186137e+01 1.71878537e+01 2.13270732e+01
 4.71331705e+00 8.08183566e+00 1.41879577e+00 3.28439164e+00
 1.04565998e-01 4.64577198e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987335767176354
cond(S) = 43.774390543715704
E1 = -19.062858038732664  E_coul = 4.529037276090048
init E= -14.5338207626426
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300688187691902  LUMO = 3.72724888061675
  mo_energy =
[-4.71378579e+00 -3.00688188e-01  3.72724888e+00  2.63309812e+01
  1.37711047e+02  8.99212245e+02  8.66897223e+03]
E1 = -19.05677663044026  E_coul = 4.498310124396656
cycle= 1 E= -14.5584665060436  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142959
diis-c [-2.04373696e-04  1.00000000e+00]
  HOMO = -0.300643382215767  LUMO = 3.72306165503774
  mo_energy =
[-4.72945206e+00 -3.00643382e-01  3.72306166e+00  2.63138274e+01
  1.37687292e+02  8.99182741e+02  8.66893996e+03]
E1 = -19.053525511164377  E_coul = 4.495021649154784
cycle= 2 E= -14.5585038620096  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170897
diis-c [-7.70515115e-07 -1.14531759e-01  1.11453176e+00]
  HOMO = -0.3007987670021  LUMO = 3.72235513422081
  mo_energy =
[-4.73113097e+00 -3.00798767e-01  3.72235513e+00  2.63121463e+01
  1.37685302e+02  8.99180561e+02  8.66893771e+03]
E1 = -19.053257401696907  E_coul = 4.494753270026561
cycle= 3 E= -14.5585041316703  delta_E= -2.7e-07  |g|= 3.08e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.0119e-05
diis-c [-2.60473031e-10  9.02106602e-04 -5.90882478e-04  9.99688776e-01]
  HOMO = -0.300795016677153  LUMO = 3.72237815352217
  mo_energy =
[-4.73107889e+00 -3.00795017e-01  3.72237815e+00  2.63122146e+01
  1.37685408e+02  8.99180691e+02  8.66893785e+03]
E1 = -19.05326441834942  E_coul = 4.494760286582645
cycle= 4 E= -14.5585041317668  delta_E= -9.64e-11  |g|= 1.21e-06  |ddm|= 2.4e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05326441834942  E_coul = 4.494760286582645
  HOMO = -0.300794906807477  LUMO = 3.72237896807469
  mo_energy =
[-4.73107702e+00 -3.00794907e-01  3.72237897e+00  2.63122172e+01
  1.37685412e+02  8.99180696e+02  8.66893785e+03]
E1 = -19.05326467411872  E_coul = 4.494760542351816
Extra cycle  E= -14.5585041317669  delta_E= -1.26e-13  |g|= 8.55e-08  |ddm|= 7.87e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.06 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.774390543715704
E1 = -19.05326467411872  E_coul = 4.494760542351816
init E= -14.5585041317669
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300794898825879  LUMO = 3.72237902005012
  mo_energy =
[-4.73107690e+00 -3.00794899e-01  3.72237902e+00  2.63122174e+01
  1.37685412e+02  8.99180696e+02  8.66893785e+03]
E1 = -19.053264691534903  E_coul = 4.494760559768004
cycle= 1 E= -14.5585041317669  delta_E= 3.55e-15  |g|= 6.33e-09  |ddm|= 5.88e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053264691534903  E_coul = 4.494760559768004
  HOMO = -0.300794898223318  LUMO = 3.72237902354789
  mo_energy =
[-4.73107689e+00 -3.00794898e-01  3.72237902e+00  2.63122174e+01
  1.37685412e+02  8.99180696e+02  8.66893785e+03]
E1 = -19.05326469277747  E_coul = 4.494760561010559
Extra cycle  E= -14.5585041317669  delta_E= -1.42e-14  |g|= 5.01e-10  |ddm|= 4.61e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798686e+02 7.58238124e+01 1.71878537e+01
 4.71331705e+00 1.41879577e+00 1.04565998e-01]
grad_E = [ 4.86361560e-08  9.30947365e-06 -3.81579998e-05  1.01114947e-04
 -1.98687854e-04  2.33242686e-04  2.06032595e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98686012        1
[INPUT] 0    0    [1    /1   ]  503.798672703        1
[INPUT] 0    0    [1    /1   ]  75.8238657671        1
[INPUT] 0    0    [1    /1   ]  17.1877123364        1
[INPUT] 0    0    [1    /1   ]  4.71359495369        1
[INPUT] 0    0    [1    /1   ]  1.4184691967         1
[INPUT] 0    0    [1    /1   ]  0.104564944437       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986860121566, 1.0]], [0, [503.79867270252765, 1.0]], [0, [75.82386576708998, 1.0]], [0, [17.187712336359354, 1.0]], [0, [4.713594953692686, 1.0]], [0, [1.4184691966972016, 1.0]], [0, [0.10456494443680349, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98686012]
bas 1, expnt(s) = [503.7986727]
bas 2, expnt(s) = [75.82386577]
bas 3, expnt(s) = [17.18771234]
bas 4, expnt(s) = [4.71359495]
bas 5, expnt(s) = [1.4184692]
bas 6, expnt(s) = [0.10456494]
CPU time:         8.72
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798673e+02 2.68662956e+02
 7.58238658e+01 6.49186479e+01 1.71877123e+01 2.13269417e+01
 4.71359495e+00 8.08219304e+00 1.41846920e+00 3.28382463e+00
 1.04564944e-01 4.64573686e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873355834481785
cond(S) = 43.765396549589425
E1 = -19.06284230817258  E_coul = 4.529032884218389
init E= -14.5338094239542
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300687343726419  LUMO = 3.72662399754388
  mo_energy =
[-4.71378873e+00 -3.00687344e-01  3.72662400e+00  2.63303777e+01
  1.37710514e+02  8.99211839e+02  8.66897192e+03]
E1 = -19.05673075172044  E_coul = 4.49826414644282
cycle= 1 E= -14.5584666052776  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142966
diis-c [-2.04392985e-04  1.00000000e+00]
  HOMO = -0.300644183669632  LUMO = 3.72242571037554
  mo_energy =
[-4.72947431e+00 -3.00644184e-01  3.72242571e+00  2.63131946e+01
  1.37686726e+02  8.99182293e+02  8.66893960e+03]
E1 = -19.053476403976692  E_coul = 4.494972424007165
cycle= 2 E= -14.5585039799695  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0017095
diis-c [-7.70804640e-07 -1.14570725e-01  1.11457073e+00]
  HOMO = -0.300799665563088  LUMO = 3.72171833078771
  mo_energy =
[-4.73115500e+00 -3.00799666e-01  3.72171833e+00  2.63115107e+01
  1.37684732e+02  8.99180108e+02  8.66893735e+03]
E1 = -19.05320799298891  E_coul = 4.4947037432509305
cycle= 3 E= -14.558504249738  delta_E= -2.7e-07  |g|= 3.09e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.01707e-05
diis-c [-2.61154291e-10  8.99954399e-04 -5.31834379e-04  9.99631880e-01]
  HOMO = -0.300795907683665  LUMO = 3.72174139720544
  mo_energy =
[-4.73110281e+00 -3.00795908e-01  3.72174140e+00  2.63115792e+01
  1.37684838e+02  8.99180239e+02  8.66893749e+03]
E1 = -19.05321502628911  E_coul = 4.494710776454269
cycle= 4 E= -14.5585042498348  delta_E= -9.69e-11  |g|= 1.21e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05321502628911  E_coul = 4.494710776454269
  HOMO = -0.300795797727505  LUMO = 3.72174221306572
  mo_energy =
[-4.73110094e+00 -3.00795798e-01  3.72174221e+00  2.63115818e+01
  1.37684842e+02  8.99180244e+02  8.66893749e+03]
E1 = -19.053215282430642  E_coul = 4.494711032595687
Extra cycle  E= -14.558504249835  delta_E= -1.15e-13  |g|= 8.57e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798673e+02 7.58238658e+01 1.71877123e+01
 4.71359495e+00 1.41846920e+00 1.04564944e-01]
E = -14.558504249834956
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98686012        1
[INPUT] 0    0    [1    /1   ]  503.798672703        1
[INPUT] 0    0    [1    /1   ]  75.8238657671        1
[INPUT] 0    0    [1    /1   ]  17.1877123364        1
[INPUT] 0    0    [1    /1   ]  4.71359495369        1
[INPUT] 0    0    [1    /1   ]  1.4184691967         1
[INPUT] 0    0    [1    /1   ]  0.104564944437       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986860121566, 1.0]], [0, [503.79867270252765, 1.0]], [0, [75.82386576708998, 1.0]], [0, [17.187712336359354, 1.0]], [0, [4.713594953692686, 1.0]], [0, [1.4184691966972016, 1.0]], [0, [0.10456494443680349, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98686012]
bas 1, expnt(s) = [503.7986727]
bas 2, expnt(s) = [75.82386577]
bas 3, expnt(s) = [17.18771234]
bas 4, expnt(s) = [4.71359495]
bas 5, expnt(s) = [1.4184692]
bas 6, expnt(s) = [0.10456494]
CPU time:         8.85
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798673e+02 2.68662956e+02
 7.58238658e+01 6.49186479e+01 1.71877123e+01 2.13269417e+01
 4.71359495e+00 8.08219304e+00 1.41846920e+00 3.28382463e+00
 1.04564944e-01 4.64573686e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873355834481785
cond(S) = 43.765396549589425
E1 = -19.06284230817258  E_coul = 4.529032884218389
init E= -14.5338094239542
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300687343726419  LUMO = 3.72662399754388
  mo_energy =
[-4.71378873e+00 -3.00687344e-01  3.72662400e+00  2.63303777e+01
  1.37710514e+02  8.99211839e+02  8.66897192e+03]
E1 = -19.05673075172044  E_coul = 4.49826414644282
cycle= 1 E= -14.5584666052776  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142966
diis-c [-2.04392985e-04  1.00000000e+00]
  HOMO = -0.300644183669632  LUMO = 3.72242571037554
  mo_energy =
[-4.72947431e+00 -3.00644184e-01  3.72242571e+00  2.63131946e+01
  1.37686726e+02  8.99182293e+02  8.66893960e+03]
E1 = -19.053476403976692  E_coul = 4.494972424007165
cycle= 2 E= -14.5585039799695  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0017095
diis-c [-7.70804640e-07 -1.14570725e-01  1.11457073e+00]
  HOMO = -0.300799665563088  LUMO = 3.72171833078771
  mo_energy =
[-4.73115500e+00 -3.00799666e-01  3.72171833e+00  2.63115107e+01
  1.37684732e+02  8.99180108e+02  8.66893735e+03]
E1 = -19.05320799298891  E_coul = 4.4947037432509305
cycle= 3 E= -14.558504249738  delta_E= -2.7e-07  |g|= 3.09e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.01707e-05
diis-c [-2.61154291e-10  8.99954399e-04 -5.31834379e-04  9.99631880e-01]
  HOMO = -0.300795907683665  LUMO = 3.72174139720544
  mo_energy =
[-4.73110281e+00 -3.00795908e-01  3.72174140e+00  2.63115792e+01
  1.37684838e+02  8.99180239e+02  8.66893749e+03]
E1 = -19.05321502628911  E_coul = 4.494710776454269
cycle= 4 E= -14.5585042498348  delta_E= -9.69e-11  |g|= 1.21e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05321502628911  E_coul = 4.494710776454269
  HOMO = -0.300795797727505  LUMO = 3.72174221306572
  mo_energy =
[-4.73110094e+00 -3.00795798e-01  3.72174221e+00  2.63115818e+01
  1.37684842e+02  8.99180244e+02  8.66893749e+03]
E1 = -19.053215282430642  E_coul = 4.494711032595687
Extra cycle  E= -14.558504249835  delta_E= -1.15e-13  |g|= 8.57e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.06 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.765396549589425
E1 = -19.053215282430642  E_coul = 4.494711032595687
init E= -14.558504249835
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300795789741661  LUMO = 3.72174226512868
  mo_energy =
[-4.73110082e+00 -3.00795790e-01  3.72174227e+00  2.63115820e+01
  1.37684842e+02  8.99180244e+02  8.66893749e+03]
E1 = -19.053215299870658  E_coul = 4.494711050035698
cycle= 1 E= -14.558504249835  delta_E= -5.33e-15  |g|= 6.34e-09  |ddm|= 5.89e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053215299870658  E_coul = 4.494711050035698
  HOMO = -0.300795789138933  LUMO = 3.7217422686321
  mo_energy =
[-4.73110081e+00 -3.00795789e-01  3.72174227e+00  2.63115820e+01
  1.37684842e+02  8.99180244e+02  8.66893749e+03]
E1 = -19.053215301114676  E_coul = 4.494711051279717
Extra cycle  E= -14.558504249835  delta_E= 1.78e-15  |g|= 5e-10  |ddm|= 4.61e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798673e+02 7.58238658e+01 1.71877123e+01
 4.71359495e+00 1.41846920e+00 1.04564944e-01]
grad_E = [ 4.86705326e-08  9.30214489e-06 -3.77831367e-05  9.49323436e-05
 -1.52251112e-04  9.21228359e-05  1.22423198e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685996        1
[INPUT] 0    0    [1    /1   ]  503.798641745        1
[INPUT] 0    0    [1    /1   ]  75.8239918118        1
[INPUT] 0    0    [1    /1   ]  17.1873910667        1
[INPUT] 0    0    [1    /1   ]  4.71414188583        1
[INPUT] 0    0    [1    /1   ]  1.41804038364        1
[INPUT] 0    0    [1    /1   ]  0.104563363078       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986859959652, 1.0]], [0, [503.79864174461693, 1.0]], [0, [75.82399181184034, 1.0]], [0, [17.18739106674824, 1.0]], [0, [4.714141885833052, 1.0]], [0, [1.418040383641774, 1.0]], [0, [0.10456336307775727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685996]
bas 1, expnt(s) = [503.79864174]
bas 2, expnt(s) = [75.82399181]
bas 3, expnt(s) = [17.18739107]
bas 4, expnt(s) = [4.71414189]
bas 5, expnt(s) = [1.41804038]
bas 6, expnt(s) = [0.10456336]
CPU time:        10.77
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798642e+02 2.68662943e+02
 7.58239918e+01 6.49187289e+01 1.71873911e+01 2.13266427e+01
 4.71414189e+00 8.08289638e+00 1.41804038e+00 3.28308006e+00
 1.04563363e-01 4.64568417e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987335267236037
cond(S) = 43.75439738582782
E1 = -19.062817778745828  E_coul = 4.529025174533534
init E= -14.5337926042123
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300686296810394  LUMO = 3.72588347289169
  mo_energy =
[-4.71379345e+00 -3.00686297e-01  3.72588347e+00  2.63299682e+01
  1.37710128e+02  8.99211586e+02  8.66897170e+03]
E1 = -19.056664759211536  E_coul = 4.498198085525502
cycle= 1 E= -14.558466673686  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142977
diis-c [-2.04425621e-04  1.00000000e+00]
  HOMO = -0.300645399237452  LUMO = 3.7216693937169
  mo_energy =
[-4.72950617e+00 -3.00645399e-01  3.72166939e+00  2.63127437e+01
  1.37686293e+02  8.99181980e+02  8.66893933e+03]
E1 = -19.05340594750085  E_coul = 4.4949018740936735
cycle= 2 E= -14.5585040734072  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171021
diis-c [-7.71166672e-07 -1.14622433e-01  1.11462243e+00]
  HOMO = -0.300801009646969  LUMO = 3.72096080932919
  mo_energy =
[-4.73118932e+00 -3.00801010e-01  3.72096081e+00  2.63110559e+01
  1.37684294e+02  8.99179790e+02  8.66893707e+03]
E1 = -19.05313712724016  E_coul = 4.494632783940082
cycle= 3 E= -14.5585043433001  delta_E= -2.7e-07  |g|= 3.1e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02435e-05
diis-c [-2.62093288e-10  8.96726045e-04 -4.46664100e-04  9.99549938e-01]
  HOMO = -0.300797241351279  LUMO = 3.72098394201852
  mo_energy =
[-4.73113700e+00 -3.00797241e-01  3.72098394e+00  2.63111246e+01
  1.37684400e+02  8.99179921e+02  8.66893721e+03]
E1 = -19.053144183646914  E_coul = 4.49463984024937
cycle= 4 E= -14.5585043433975  delta_E= -9.75e-11  |g|= 1.21e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053144183646914  E_coul = 4.49463984024937
  HOMO = -0.300797131282386  LUMO = 3.72098475972413
  mo_energy =
[-4.73113512e+00 -3.00797131e-01  3.72098476e+00  2.63111272e+01
  1.37684404e+02  8.99179926e+02  8.66893721e+03]
E1 = -19.05314444029823  E_coul = 4.494640096900562
Extra cycle  E= -14.5585043433977  delta_E= -1.24e-13  |g|= 8.59e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798642e+02 7.58239918e+01 1.71873911e+01
 4.71414189e+00 1.41804038e+00 1.04563363e-01]
E = -14.558504343397669
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685996        1
[INPUT] 0    0    [1    /1   ]  503.798641745        1
[INPUT] 0    0    [1    /1   ]  75.8239918118        1
[INPUT] 0    0    [1    /1   ]  17.1873910667        1
[INPUT] 0    0    [1    /1   ]  4.71414188583        1
[INPUT] 0    0    [1    /1   ]  1.41804038364        1
[INPUT] 0    0    [1    /1   ]  0.104563363078       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986859959652, 1.0]], [0, [503.79864174461693, 1.0]], [0, [75.82399181184034, 1.0]], [0, [17.18739106674824, 1.0]], [0, [4.714141885833052, 1.0]], [0, [1.418040383641774, 1.0]], [0, [0.10456336307775727, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685996]
bas 1, expnt(s) = [503.79864174]
bas 2, expnt(s) = [75.82399181]
bas 3, expnt(s) = [17.18739107]
bas 4, expnt(s) = [4.71414189]
bas 5, expnt(s) = [1.41804038]
bas 6, expnt(s) = [0.10456336]
CPU time:        10.91
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798642e+02 2.68662943e+02
 7.58239918e+01 6.49187289e+01 1.71873911e+01 2.13266427e+01
 4.71414189e+00 8.08289638e+00 1.41804038e+00 3.28308006e+00
 1.04563363e-01 4.64568417e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987335267236037
cond(S) = 43.75439738582782
E1 = -19.062817778745828  E_coul = 4.529025174533534
init E= -14.5337926042123
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300686296810394  LUMO = 3.72588347289169
  mo_energy =
[-4.71379345e+00 -3.00686297e-01  3.72588347e+00  2.63299682e+01
  1.37710128e+02  8.99211586e+02  8.66897170e+03]
E1 = -19.056664759211536  E_coul = 4.498198085525502
cycle= 1 E= -14.558466673686  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142977
diis-c [-2.04425621e-04  1.00000000e+00]
  HOMO = -0.300645399237452  LUMO = 3.7216693937169
  mo_energy =
[-4.72950617e+00 -3.00645399e-01  3.72166939e+00  2.63127437e+01
  1.37686293e+02  8.99181980e+02  8.66893933e+03]
E1 = -19.05340594750085  E_coul = 4.4949018740936735
cycle= 2 E= -14.5585040734072  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171021
diis-c [-7.71166672e-07 -1.14622433e-01  1.11462243e+00]
  HOMO = -0.300801009646969  LUMO = 3.72096080932919
  mo_energy =
[-4.73118932e+00 -3.00801010e-01  3.72096081e+00  2.63110559e+01
  1.37684294e+02  8.99179790e+02  8.66893707e+03]
E1 = -19.05313712724016  E_coul = 4.494632783940082
cycle= 3 E= -14.5585043433001  delta_E= -2.7e-07  |g|= 3.1e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02435e-05
diis-c [-2.62093288e-10  8.96726045e-04 -4.46664100e-04  9.99549938e-01]
  HOMO = -0.300797241351279  LUMO = 3.72098394201852
  mo_energy =
[-4.73113700e+00 -3.00797241e-01  3.72098394e+00  2.63111246e+01
  1.37684400e+02  8.99179921e+02  8.66893721e+03]
E1 = -19.053144183646914  E_coul = 4.49463984024937
cycle= 4 E= -14.5585043433975  delta_E= -9.75e-11  |g|= 1.21e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053144183646914  E_coul = 4.49463984024937
  HOMO = -0.300797131282386  LUMO = 3.72098475972413
  mo_energy =
[-4.73113512e+00 -3.00797131e-01  3.72098476e+00  2.63111272e+01
  1.37684404e+02  8.99179926e+02  8.66893721e+03]
E1 = -19.05314444029823  E_coul = 4.494640096900562
Extra cycle  E= -14.5585043433977  delta_E= -1.24e-13  |g|= 8.59e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.75439738582782
E1 = -19.05314444029823  E_coul = 4.494640096900562
init E= -14.5585043433977
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300797123291606  LUMO = 3.72098481190921
  mo_energy =
[-4.73113500e+00 -3.00797123e-01  3.72098481e+00  2.63111274e+01
  1.37684404e+02  8.99179926e+02  8.66893721e+03]
E1 = -19.05314445777018  E_coul = 4.4946401143725065
cycle= 1 E= -14.5585043433977  delta_E= -5.33e-15  |g|= 6.35e-09  |ddm|= 5.89e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.05314445777018  E_coul = 4.4946401143725065
  HOMO = -0.300797122688753  LUMO = 3.72098481542041
  mo_energy =
[-4.73113499e+00 -3.00797123e-01  3.72098482e+00  2.63111274e+01
  1.37684404e+02  8.99179926e+02  8.66893721e+03]
E1 = -19.05314445901604  E_coul = 4.494640115618382
Extra cycle  E= -14.5585043433977  delta_E= 1.6e-14  |g|= 5e-10  |ddm|= 4.6e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798642e+02 7.58239918e+01 1.71873911e+01
 4.71414189e+00 1.41804038e+00 1.04563363e-01]
grad_E = [ 4.87272242e-08  9.29010471e-06 -3.71731335e-05  8.51457996e-05
 -8.20260169e-05 -1.13347980e-04 -2.97587917e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685985        1
[INPUT] 0    0    [1    /1   ]  503.798620639        1
[INPUT] 0    0    [1    /1   ]  75.8240770336        1
[INPUT] 0    0    [1    /1   ]  17.18718428          1
[INPUT] 0    0    [1    /1   ]  4.71442596884        1
[INPUT] 0    0    [1    /1   ]  1.41800869192        1
[INPUT] 0    0    [1    /1   ]  0.104562976032       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986859849115, 1.0]], [0, [503.7986206388963, 1.0]], [0, [75.82407703358761, 1.0]], [0, [17.18718427997899, 1.0]], [0, [4.714425968843888, 1.0]], [0, [1.41800869191613, 1.0]], [0, [0.10456297603150726, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685985]
bas 1, expnt(s) = [503.79862064]
bas 2, expnt(s) = [75.82407703]
bas 3, expnt(s) = [17.18718428]
bas 4, expnt(s) = [4.71442597]
bas 5, expnt(s) = [1.41800869]
bas 6, expnt(s) = [0.10456298]
CPU time:        12.76
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798621e+02 2.68662935e+02
 7.58240770e+01 6.49187836e+01 1.71871843e+01 2.13264503e+01
 4.71442597e+00 8.08326170e+00 1.41800869e+00 3.28302503e+00
 1.04562976e-01 4.64567127e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873351526709317
cond(S) = 43.75466059177338
E1 = -19.062811092830934  E_coul = 4.529021985403431
init E= -14.5337891074275
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300686305080177  LUMO = 3.72593601996712
  mo_energy =
[-4.71379502e+00 -3.00686305e-01  3.72593602e+00  2.63304494e+01
  1.37710516e+02  8.99211940e+02  8.66897195e+03]
E1 = -19.056652250781926  E_coul = 4.498185542130159
cycle= 1 E= -14.5584667086518  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142981
diis-c [-2.04434786e-04  1.00000000e+00]
  HOMO = -0.300645714213464  LUMO = 3.72171906432474
  mo_energy =
[-4.72951214e+00 -3.00645714e-01  3.72171906e+00  2.63132180e+01
  1.37686673e+02  8.99182324e+02  8.66893956e+03]
E1 = -19.053392810676126  E_coul = 4.494888700047462
cycle= 2 E= -14.5585041106287  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171029
diis-c [-7.71141818e-07 -1.14628233e-01  1.11462823e+00]
  HOMO = -0.300801335519401  LUMO = 3.72101028738035
  mo_energy =
[-4.73119564e+00 -3.00801336e-01  3.72101029e+00  2.63115296e+01
  1.37684674e+02  8.99180133e+02  8.66893731e+03]
E1 = -19.05312394224732  E_coul = 4.494619561739999
cycle= 3 E= -14.5585043805073  delta_E= -2.7e-07  |g|= 3.1e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02555e-05
diis-c [-2.62205185e-10  8.95926039e-04 -4.28972363e-04  9.99533046e-01]
  HOMO = -0.300797565631635  LUMO = 3.72103343152057
  mo_energy =
[-4.73114330e+00 -3.00797566e-01  3.72103343e+00  2.63115983e+01
  1.37684780e+02  8.99180264e+02  8.66893745e+03]
E1 = -19.05313100228457  E_coul = 4.4946266216796955
cycle= 4 E= -14.5585043806049  delta_E= -9.76e-11  |g|= 1.21e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05313100228457  E_coul = 4.4946266216796955
  HOMO = -0.300797455552907  LUMO = 3.7210342495455
  mo_energy =
[-4.73114142e+00 -3.00797456e-01  3.72103425e+00  2.63116009e+01
  1.37684784e+02  8.99180269e+02  8.66893745e+03]
E1 = -19.05313125900618  E_coul = 4.494626878401168
Extra cycle  E= -14.558504380605  delta_E= -1.39e-13  |g|= 8.6e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.06 sec
exp = [5.03798686e+03 5.03798621e+02 7.58240770e+01 1.71871843e+01
 4.71442597e+00 1.41800869e+00 1.04562976e-01]
E = -14.558504380605012
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685985        1
[INPUT] 0    0    [1    /1   ]  503.798620639        1
[INPUT] 0    0    [1    /1   ]  75.8240770336        1
[INPUT] 0    0    [1    /1   ]  17.18718428          1
[INPUT] 0    0    [1    /1   ]  4.71442596884        1
[INPUT] 0    0    [1    /1   ]  1.41800869192        1
[INPUT] 0    0    [1    /1   ]  0.104562976032       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986859849115, 1.0]], [0, [503.7986206388963, 1.0]], [0, [75.82407703358761, 1.0]], [0, [17.18718427997899, 1.0]], [0, [4.714425968843888, 1.0]], [0, [1.41800869191613, 1.0]], [0, [0.10456297603150726, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685985]
bas 1, expnt(s) = [503.79862064]
bas 2, expnt(s) = [75.82407703]
bas 3, expnt(s) = [17.18718428]
bas 4, expnt(s) = [4.71442597]
bas 5, expnt(s) = [1.41800869]
bas 6, expnt(s) = [0.10456298]
CPU time:        12.90
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798621e+02 2.68662935e+02
 7.58240770e+01 6.49187836e+01 1.71871843e+01 2.13264503e+01
 4.71442597e+00 8.08326170e+00 1.41800869e+00 3.28302503e+00
 1.04562976e-01 4.64567127e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873351526709317
cond(S) = 43.75466059177338
E1 = -19.062811092830934  E_coul = 4.529021985403431
init E= -14.5337891074275
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300686305080177  LUMO = 3.72593601996712
  mo_energy =
[-4.71379502e+00 -3.00686305e-01  3.72593602e+00  2.63304494e+01
  1.37710516e+02  8.99211940e+02  8.66897195e+03]
E1 = -19.056652250781926  E_coul = 4.498185542130159
cycle= 1 E= -14.5584667086518  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142981
diis-c [-2.04434786e-04  1.00000000e+00]
  HOMO = -0.300645714213464  LUMO = 3.72171906432474
  mo_energy =
[-4.72951214e+00 -3.00645714e-01  3.72171906e+00  2.63132180e+01
  1.37686673e+02  8.99182324e+02  8.66893956e+03]
E1 = -19.053392810676126  E_coul = 4.494888700047462
cycle= 2 E= -14.5585041106287  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171029
diis-c [-7.71141818e-07 -1.14628233e-01  1.11462823e+00]
  HOMO = -0.300801335519401  LUMO = 3.72101028738035
  mo_energy =
[-4.73119564e+00 -3.00801336e-01  3.72101029e+00  2.63115296e+01
  1.37684674e+02  8.99180133e+02  8.66893731e+03]
E1 = -19.05312394224732  E_coul = 4.494619561739999
cycle= 3 E= -14.5585043805073  delta_E= -2.7e-07  |g|= 3.1e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02555e-05
diis-c [-2.62205185e-10  8.95926039e-04 -4.28972363e-04  9.99533046e-01]
  HOMO = -0.300797565631635  LUMO = 3.72103343152057
  mo_energy =
[-4.73114330e+00 -3.00797566e-01  3.72103343e+00  2.63115983e+01
  1.37684780e+02  8.99180264e+02  8.66893745e+03]
E1 = -19.05313100228457  E_coul = 4.4946266216796955
cycle= 4 E= -14.5585043806049  delta_E= -9.76e-11  |g|= 1.21e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05313100228457  E_coul = 4.4946266216796955
  HOMO = -0.300797455552907  LUMO = 3.7210342495455
  mo_energy =
[-4.73114142e+00 -3.00797456e-01  3.72103425e+00  2.63116009e+01
  1.37684784e+02  8.99180269e+02  8.66893745e+03]
E1 = -19.05313125900618  E_coul = 4.494626878401168
Extra cycle  E= -14.558504380605  delta_E= -1.39e-13  |g|= 8.6e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.06 sec, wall time      0.06 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.75466059177338
E1 = -19.05313125900618  E_coul = 4.494626878401168
init E= -14.558504380605
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300797447562403  LUMO = 3.72103430175006
  mo_energy =
[-4.73114130e+00 -3.00797448e-01  3.72103430e+00  2.63116010e+01
  1.37684784e+02  8.99180269e+02  8.66893745e+03]
E1 = -19.053131276481658  E_coul = 4.4946268958766495
cycle= 1 E= -14.558504380605  delta_E= 3.55e-15  |g|= 6.35e-09  |ddm|= 5.89e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053131276481658  E_coul = 4.4946268958766495
  HOMO = -0.300797446959648  LUMO = 3.72103430526227
  mo_energy =
[-4.73114130e+00 -3.00797447e-01  3.72103431e+00  2.63116010e+01
  1.37684784e+02  8.99180269e+02  8.66893745e+03]
E1 = -19.053131277727662  E_coul = 4.494626897122662
Extra cycle  E= -14.558504380605  delta_E= 7.11e-15  |g|= 5e-10  |ddm|= 4.6e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798621e+02 7.58240770e+01 1.71871843e+01
 4.71442597e+00 1.41800869e+00 1.04562976e-01]
grad_E = [ 4.87468977e-08  9.28597344e-06 -3.69703305e-05  8.21867577e-05
 -6.45042253e-05 -1.55315399e-04 -2.67843471e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685914        1
[INPUT] 0    0    [1    /1   ]  503.79848557         1
[INPUT] 0    0    [1    /1   ]  75.8246209402        1
[INPUT] 0    0    [1    /1   ]  17.1858850189        1
[INPUT] 0    0    [1    /1   ]  4.71608760232        1
[INPUT] 0    0    [1    /1   ]  1.41821875756        1
[INPUT] 0    0    [1    /1   ]  0.104561609607       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986859141394, 1.0]], [0, [503.798485570109, 1.0]], [0, [75.82462094015148, 1.0]], [0, [17.185885018914345, 1.0]], [0, [4.716087602319003, 1.0]], [0, [1.4182187575551453, 1.0]], [0, [0.1045616096068472, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685914]
bas 1, expnt(s) = [503.79848557]
bas 2, expnt(s) = [75.82462094]
bas 3, expnt(s) = [17.18588502]
bas 4, expnt(s) = [4.7160876]
bas 5, expnt(s) = [1.41821876]
bas 6, expnt(s) = [0.10456161]
CPU time:        14.75
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798486e+02 2.68662881e+02
 7.58246209e+01 6.49191328e+01 1.71858850e+01 2.13252411e+01
 4.71608760e+00 8.08539836e+00 1.41821876e+00 3.28338979e+00
 1.04561610e-01 4.64562574e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873345902103603
cond(S) = 43.76858359823535
E1 = -19.06278460902558  E_coul = 4.529005015144006
init E= -14.5337795938816
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300687496955431  LUMO = 3.72714849427937
  mo_energy =
[-4.71380239e+00 -3.00687497e-01  3.72714849e+00  2.63346941e+01
  1.37713983e+02  8.99215004e+02  8.66897413e+03]
E1 = -19.056624145032863  E_coul = 4.498157208614702
cycle= 1 E= -14.5584669364182  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142993
diis-c [-2.04471153e-04  1.00000000e+00]
  HOMO = -0.300646903724753  LUMO = 3.72292572860514
  mo_energy =
[-4.72952523e+00 -3.00646904e-01  3.72292573e+00  2.63174524e+01
  1.37690133e+02  8.99185372e+02  8.66894173e+03]
E1 = -19.053364529198642  E_coul = 4.494860199948069
cycle= 2 E= -14.5585043292506  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171014
diis-c [-7.70550414e-07 -1.14618776e-01  1.11461878e+00]
  HOMO = -0.300802473108089  LUMO = 3.72221672220399
  mo_energy =
[-4.73120886e+00 -3.00802473e-01  3.72221672e+00  2.63157632e+01
  1.37688133e+02  8.99183181e+02  8.66893947e+03]
E1 = -19.05309571940814  E_coul = 4.494591120526015
cycle= 3 E= -14.5585045988821  delta_E= -2.7e-07  |g|= 3.1e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02725e-05
diis-c [-2.62074093e-10  8.93051224e-04 -3.80228206e-04  9.99487177e-01]
  HOMO = -0.300798701793499  LUMO = 3.72223988582503
  mo_energy =
[-4.73115649e+00 -3.00798702e-01  3.72223989e+00  2.63158319e+01
  1.37688239e+02  8.99183312e+02  8.66893961e+03]
E1 = -19.053102783372935  E_coul = 4.4945981843930864
cycle= 4 E= -14.5585045989798  delta_E= -9.77e-11  |g|= 1.22e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053102783372935  E_coul = 4.4945981843930864
  HOMO = -0.300798591756793  LUMO = 3.7222407044003
  mo_energy =
[-4.73115462e+00 -3.00798592e-01  3.72224070e+00  2.63158346e+01
  1.37688243e+02  8.99183316e+02  8.66893962e+03]
E1 = -19.053103040104993  E_coul = 4.494598441125022
Extra cycle  E= -14.55850459898  delta_E= -1.24e-13  |g|= 8.6e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798486e+02 7.58246209e+01 1.71858850e+01
 4.71608760e+00 1.41821876e+00 1.04561610e-01]
E = -14.558504598979972
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685914        1
[INPUT] 0    0    [1    /1   ]  503.79848557         1
[INPUT] 0    0    [1    /1   ]  75.8246209402        1
[INPUT] 0    0    [1    /1   ]  17.1858850189        1
[INPUT] 0    0    [1    /1   ]  4.71608760232        1
[INPUT] 0    0    [1    /1   ]  1.41821875756        1
[INPUT] 0    0    [1    /1   ]  0.104561609607       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986859141394, 1.0]], [0, [503.798485570109, 1.0]], [0, [75.82462094015148, 1.0]], [0, [17.185885018914345, 1.0]], [0, [4.716087602319003, 1.0]], [0, [1.4182187575551453, 1.0]], [0, [0.1045616096068472, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685914]
bas 1, expnt(s) = [503.79848557]
bas 2, expnt(s) = [75.82462094]
bas 3, expnt(s) = [17.18588502]
bas 4, expnt(s) = [4.7160876]
bas 5, expnt(s) = [1.41821876]
bas 6, expnt(s) = [0.10456161]
CPU time:        14.91
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798486e+02 2.68662881e+02
 7.58246209e+01 6.49191328e+01 1.71858850e+01 2.13252411e+01
 4.71608760e+00 8.08539836e+00 1.41821876e+00 3.28338979e+00
 1.04561610e-01 4.64562574e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873345902103603
cond(S) = 43.76858359823535
E1 = -19.06278460902558  E_coul = 4.529005015144006
init E= -14.5337795938816
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300687496955431  LUMO = 3.72714849427937
  mo_energy =
[-4.71380239e+00 -3.00687497e-01  3.72714849e+00  2.63346941e+01
  1.37713983e+02  8.99215004e+02  8.66897413e+03]
E1 = -19.056624145032863  E_coul = 4.498157208614702
cycle= 1 E= -14.5584669364182  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142993
diis-c [-2.04471153e-04  1.00000000e+00]
  HOMO = -0.300646903724753  LUMO = 3.72292572860514
  mo_energy =
[-4.72952523e+00 -3.00646904e-01  3.72292573e+00  2.63174524e+01
  1.37690133e+02  8.99185372e+02  8.66894173e+03]
E1 = -19.053364529198642  E_coul = 4.494860199948069
cycle= 2 E= -14.5585043292506  delta_E= -3.74e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171014
diis-c [-7.70550414e-07 -1.14618776e-01  1.11461878e+00]
  HOMO = -0.300802473108089  LUMO = 3.72221672220399
  mo_energy =
[-4.73120886e+00 -3.00802473e-01  3.72221672e+00  2.63157632e+01
  1.37688133e+02  8.99183181e+02  8.66893947e+03]
E1 = -19.05309571940814  E_coul = 4.494591120526015
cycle= 3 E= -14.5585045988821  delta_E= -2.7e-07  |g|= 3.1e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02725e-05
diis-c [-2.62074093e-10  8.93051224e-04 -3.80228206e-04  9.99487177e-01]
  HOMO = -0.300798701793499  LUMO = 3.72223988582503
  mo_energy =
[-4.73115649e+00 -3.00798702e-01  3.72223989e+00  2.63158319e+01
  1.37688239e+02  8.99183312e+02  8.66893961e+03]
E1 = -19.053102783372935  E_coul = 4.4945981843930864
cycle= 4 E= -14.5585045989798  delta_E= -9.77e-11  |g|= 1.22e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053102783372935  E_coul = 4.4945981843930864
  HOMO = -0.300798591756793  LUMO = 3.7222407044003
  mo_energy =
[-4.73115462e+00 -3.00798592e-01  3.72224070e+00  2.63158346e+01
  1.37688243e+02  8.99183316e+02  8.66893962e+03]
E1 = -19.053103040104993  E_coul = 4.494598441125022
Extra cycle  E= -14.55850459898  delta_E= -1.24e-13  |g|= 8.6e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.76858359823535
E1 = -19.053103040104993  E_coul = 4.494598441125022
init E= -14.55850459898
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300798583773688  LUMO = 3.72224075662781
  mo_energy =
[-4.73115450e+00 -3.00798584e-01  3.72224076e+00  2.63158347e+01
  1.37688243e+02  8.99183317e+02  8.66893962e+03]
E1 = -19.053103057574422  E_coul = 4.49459845859446
cycle= 1 E= -14.55850459898  delta_E= 1.07e-14  |g|= 6.34e-09  |ddm|= 5.88e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053103057574422  E_coul = 4.49459845859446
  HOMO = -0.30079858317181  LUMO = 3.72224076014023
  mo_energy =
[-4.73115449e+00 -3.00798583e-01  3.72224076e+00  2.63158347e+01
  1.37688243e+02  8.99183317e+02  8.66893962e+03]
E1 = -19.053103058819374  E_coul = 4.494598459839401
Extra cycle  E= -14.55850459898  delta_E= -1.07e-14  |g|= 4.99e-10  |ddm|= 4.59e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798486e+02 7.58246209e+01 1.71858850e+01
 4.71608760e+00 1.41821876e+00 1.04561610e-01]
grad_E = [ 4.88419042e-08  9.26617274e-06 -3.60188371e-05  6.92701852e-05
 -1.29651885e-06 -2.66662315e-04 -1.04549351e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685741        1
[INPUT] 0    0    [1    /1   ]  503.798154377        1
[INPUT] 0    0    [1    /1   ]  75.8259517809        1
[INPUT] 0    0    [1    /1   ]  17.1827423712        1
[INPUT] 0    0    [1    /1   ]  4.71992182549        1
[INPUT] 0    0    [1    /1   ]  1.41925601007        1
[INPUT] 0    0    [1    /1   ]  0.104559707117       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986857405402, 1.0]], [0, [503.7981543766752, 1.0]], [0, [75.82595178093472, 1.0]], [0, [17.182742371245986, 1.0]], [0, [4.719921825488948, 1.0]], [0, [1.4192560100746787, 1.0]], [0, [0.10455970711718525, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685741]
bas 1, expnt(s) = [503.79815438]
bas 2, expnt(s) = [75.82595178]
bas 3, expnt(s) = [17.18274237]
bas 4, expnt(s) = [4.71992183]
bas 5, expnt(s) = [1.41925601]
bas 6, expnt(s) = [0.10455971]
CPU time:        16.75
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798154e+02 2.68662748e+02
 7.58259518e+01 6.49199874e+01 1.71827424e+01 2.13223164e+01
 4.71992183e+00 8.09032799e+00 1.41925601e+00 3.28519067e+00
 1.04559707e-01 4.64556234e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873334442098343
cond(S) = 43.818096022167154
E1 = -19.062741024219008  E_coul = 4.528968230161453
init E= -14.5337727940576
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300691845826681  LUMO = 3.73121169236878
  mo_energy =
[-4.71381679e+00 -3.00691846e-01  3.73121169e+00  2.63464696e+01
  1.37723617e+02  8.99223432e+02  8.66898015e+03]
E1 = -19.05662214392294  E_coul = 4.498154780963896
cycle= 1 E= -14.558467362959  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143014
diis-c [-2.04531067e-04  1.00000000e+00]
  HOMO = -0.300648736224806  LUMO = 3.72699092192393
  mo_energy =
[-4.72952480e+00 -3.00648736e-01  3.72699092e+00  2.63292463e+01
  1.37699799e+02  8.99193827e+02  8.66894779e+03]
E1 = -19.053367010250096  E_coul = 4.494862306836564
cycle= 2 E= -14.5585047034135  delta_E= -3.73e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170893
diis-c [-7.68576752e-07 -1.14535635e-01  1.11453563e+00]
  HOMO = -0.30080402439597  LUMO = 3.72628263977601
  mo_energy =
[-4.73120604e+00 -3.00804024e-01  3.72628264e+00  2.63275593e+01
  1.37697802e+02  8.99191639e+02  8.66894553e+03]
E1 = -19.053098810692592  E_coul = 4.494593838445329
cycle= 3 E= -14.5585049722473  delta_E= -2.69e-07  |g|= 3.1e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02359e-05
diis-c [-2.60672387e-10  8.88950688e-04 -3.45074992e-04  9.99456124e-01]
  HOMO = -0.300800260908057  LUMO = 3.72630578143875
  mo_energy =
[-4.73115377e+00 -3.00800261e-01  3.72630578e+00  2.63276280e+01
  1.37697908e+02  8.99191770e+02  8.66894567e+03]
E1 = -19.053105859355615  E_coul = 4.494600887010935
cycle= 4 E= -14.5585049723447  delta_E= -9.74e-11  |g|= 1.22e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053105859355615  E_coul = 4.494600887010935
  HOMO = -0.300800151106637  LUMO = 3.72630659944303
  mo_energy =
[-4.73115189e+00 -3.00800151e-01  3.72630660e+00  2.63276306e+01
  1.37697912e+02  8.99191775e+02  8.66894568e+03]
E1 = -19.053106115553604  E_coul = 4.494601143208807
Extra cycle  E= -14.5585049723448  delta_E= -1.17e-13  |g|= 8.59e-08  |ddm|= 7.86e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798154e+02 7.58259518e+01 1.71827424e+01
 4.71992183e+00 1.41925601e+00 1.04559707e-01]
E = -14.558504972344796
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685741        1
[INPUT] 0    0    [1    /1   ]  503.798154377        1
[INPUT] 0    0    [1    /1   ]  75.8259517809        1
[INPUT] 0    0    [1    /1   ]  17.1827423712        1
[INPUT] 0    0    [1    /1   ]  4.71992182549        1
[INPUT] 0    0    [1    /1   ]  1.41925601007        1
[INPUT] 0    0    [1    /1   ]  0.104559707117       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986857405402, 1.0]], [0, [503.7981543766752, 1.0]], [0, [75.82595178093472, 1.0]], [0, [17.182742371245986, 1.0]], [0, [4.719921825488948, 1.0]], [0, [1.4192560100746787, 1.0]], [0, [0.10455970711718525, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685741]
bas 1, expnt(s) = [503.79815438]
bas 2, expnt(s) = [75.82595178]
bas 3, expnt(s) = [17.18274237]
bas 4, expnt(s) = [4.71992183]
bas 5, expnt(s) = [1.41925601]
bas 6, expnt(s) = [0.10455971]
CPU time:        16.93
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080286e+03 5.03798154e+02 2.68662748e+02
 7.58259518e+01 6.49199874e+01 1.71827424e+01 2.13223164e+01
 4.71992183e+00 8.09032799e+00 1.41925601e+00 3.28519067e+00
 1.04559707e-01 4.64556234e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873334442098343
cond(S) = 43.818096022167154
E1 = -19.062741024219008  E_coul = 4.528968230161453
init E= -14.5337727940576
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300691845826681  LUMO = 3.73121169236878
  mo_energy =
[-4.71381679e+00 -3.00691846e-01  3.73121169e+00  2.63464696e+01
  1.37723617e+02  8.99223432e+02  8.66898015e+03]
E1 = -19.05662214392294  E_coul = 4.498154780963896
cycle= 1 E= -14.558467362959  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143014
diis-c [-2.04531067e-04  1.00000000e+00]
  HOMO = -0.300648736224806  LUMO = 3.72699092192393
  mo_energy =
[-4.72952480e+00 -3.00648736e-01  3.72699092e+00  2.63292463e+01
  1.37699799e+02  8.99193827e+02  8.66894779e+03]
E1 = -19.053367010250096  E_coul = 4.494862306836564
cycle= 2 E= -14.5585047034135  delta_E= -3.73e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170893
diis-c [-7.68576752e-07 -1.14535635e-01  1.11453563e+00]
  HOMO = -0.30080402439597  LUMO = 3.72628263977601
  mo_energy =
[-4.73120604e+00 -3.00804024e-01  3.72628264e+00  2.63275593e+01
  1.37697802e+02  8.99191639e+02  8.66894553e+03]
E1 = -19.053098810692592  E_coul = 4.494593838445329
cycle= 3 E= -14.5585049722473  delta_E= -2.69e-07  |g|= 3.1e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02359e-05
diis-c [-2.60672387e-10  8.88950688e-04 -3.45074992e-04  9.99456124e-01]
  HOMO = -0.300800260908057  LUMO = 3.72630578143875
  mo_energy =
[-4.73115377e+00 -3.00800261e-01  3.72630578e+00  2.63276280e+01
  1.37697908e+02  8.99191770e+02  8.66894567e+03]
E1 = -19.053105859355615  E_coul = 4.494600887010935
cycle= 4 E= -14.5585049723447  delta_E= -9.74e-11  |g|= 1.22e-06  |ddm|= 2.41e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053105859355615  E_coul = 4.494600887010935
  HOMO = -0.300800151106637  LUMO = 3.72630659944303
  mo_energy =
[-4.73115189e+00 -3.00800151e-01  3.72630660e+00  2.63276306e+01
  1.37697912e+02  8.99191775e+02  8.66894568e+03]
E1 = -19.053106115553604  E_coul = 4.494601143208807
Extra cycle  E= -14.5585049723448  delta_E= -1.17e-13  |g|= 8.59e-08  |ddm|= 7.86e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.818096022167154
E1 = -19.053106115553604  E_coul = 4.494601143208807
init E= -14.5585049723448
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300800143148561  LUMO = 3.72630665159714
  mo_energy =
[-4.73115177e+00 -3.00800143e-01  3.72630665e+00  2.63276307e+01
  1.37697912e+02  8.99191775e+02  8.66894568e+03]
E1 = -19.053106132971788  E_coul = 4.494601160626993
cycle= 1 E= -14.5585049723448  delta_E=    0  |g|= 6.33e-09  |ddm|= 5.86e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053106132971788  E_coul = 4.494601160626993
  HOMO = -0.300800142549157  LUMO = 3.72630665510139
  mo_energy =
[-4.73115176e+00 -3.00800143e-01  3.72630666e+00  2.63276307e+01
  1.37697912e+02  8.99191775e+02  8.66894568e+03]
E1 = -19.05310613421186  E_coul = 4.494601161867061
Extra cycle  E= -14.5585049723448  delta_E= -1.78e-15  |g|= 4.97e-10  |ddm|= 4.57e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03798154e+02 7.58259518e+01 1.71827424e+01
 4.71992183e+00 1.41925601e+00 1.04559707e-01]
grad_E = [ 4.90334332e-08  9.22653003e-06 -3.41485614e-05  4.56145617e-05
  8.94445183e-05 -3.35944550e-04 -1.76096162e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685618        1
[INPUT] 0    0    [1    /1   ]  503.797920788        1
[INPUT] 0    0    [1    /1   ]  75.8268867069        1
[INPUT] 0    0    [1    /1   ]  17.1805791197        1
[INPUT] 0    0    [1    /1   ]  4.72237484544        1
[INPUT] 0    0    [1    /1   ]  1.42038912718        1
[INPUT] 0    0    [1    /1   ]  0.104559551579       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.9868561801695, 1.0]], [0, [503.7979207883886, 1.0]], [0, [75.82688670687246, 1.0]], [0, [17.180579119664756, 1.0]], [0, [4.722374845435782, 1.0]], [0, [1.420389127184237, 1.0]], [0, [0.10455955157850177, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685618]
bas 1, expnt(s) = [503.79792079]
bas 2, expnt(s) = [75.82688671]
bas 3, expnt(s) = [17.18057912]
bas 4, expnt(s) = [4.72237485]
bas 5, expnt(s) = [1.42038913]
bas 6, expnt(s) = [0.10455955]
CPU time:        18.81
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797921e+02 2.68662655e+02
 7.58268867e+01 6.49205878e+01 1.71805791e+01 2.13203030e+01
 4.72237485e+00 8.09348129e+00 1.42038913e+00 3.28715762e+00
 1.04559552e-01 4.64555716e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873328356464177
cond(S) = 43.8646026576918
E1 = -19.062728480815466  E_coul = 4.528946780306927
init E= -14.5337817005085
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300695984492567  LUMO = 3.73488697906678
  mo_energy =
[-4.71382379e+00 -3.00695984e-01  3.73488698e+00  2.63556632e+01
  1.37731101e+02  8.99229933e+02  8.66898482e+03]
E1 = -19.056674459644864  E_coul = 4.498206832444297
cycle= 1 E= -14.5584676272006  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143019
diis-c [-2.04545452e-04  1.00000000e+00]
  HOMO = -0.300649132576347  LUMO = 3.73068059296287
  mo_energy =
[-4.72949848e+00 -3.00649133e-01  3.73068059e+00  2.63384875e+01
  1.37707346e+02  8.99200398e+02  8.66895253e+03]
E1 = -19.053426335416415  E_coul = 4.494921427892442
cycle= 2 E= -14.558504907524  delta_E= -3.73e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170744
diis-c [-7.66741337e-07 -1.14433106e-01  1.11443311e+00]
  HOMO = -0.300804104655381  LUMO = 3.72997383603178
  mo_energy =
[-4.73117593e+00 -3.00804105e-01  3.72997384e+00  2.63368054e+01
  1.37705356e+02  8.99198217e+02  8.66895028e+03]
E1 = -19.05315892732723  E_coul = 4.494653751672601
cycle= 3 E= -14.5585051756546  delta_E= -2.68e-07  |g|= 3.09e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.01497e-05
diis-c [-2.58833828e-10  8.88493787e-04 -3.86030065e-04  9.99497536e-01]
  HOMO = -0.300800355200304  LUMO = 3.72999690867238
  mo_energy =
[-4.73112383e+00 -3.00800355e-01  3.72999691e+00  2.63368738e+01
  1.37705461e+02  8.99198348e+02  8.66895042e+03]
E1 = -19.053165946265228  E_coul = 4.494660770513894
cycle= 4 E= -14.5585051757513  delta_E= -9.67e-11  |g|= 1.21e-06  |ddm|= 2.4e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053165946265228  E_coul = 4.494660770513894
  HOMO = -0.300800245666604  LUMO = 3.72999772475013
  mo_energy =
[-4.73112196e+00 -3.00800246e-01  3.72999772e+00  2.63368764e+01
  1.37705465e+02  8.99198353e+02  8.66895042e+03]
E1 = -19.053166201649475  E_coul = 4.494661025898001
Extra cycle  E= -14.5585051757515  delta_E= -1.4e-13  |g|= 8.56e-08  |ddm|= 7.84e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03797921e+02 7.58268867e+01 1.71805791e+01
 4.72237485e+00 1.42038913e+00 1.04559552e-01]
E = -14.558505175751474
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685618        1
[INPUT] 0    0    [1    /1   ]  503.797920788        1
[INPUT] 0    0    [1    /1   ]  75.8268867069        1
[INPUT] 0    0    [1    /1   ]  17.1805791197        1
[INPUT] 0    0    [1    /1   ]  4.72237484544        1
[INPUT] 0    0    [1    /1   ]  1.42038912718        1
[INPUT] 0    0    [1    /1   ]  0.104559551579       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.9868561801695, 1.0]], [0, [503.7979207883886, 1.0]], [0, [75.82688670687246, 1.0]], [0, [17.180579119664756, 1.0]], [0, [4.722374845435782, 1.0]], [0, [1.420389127184237, 1.0]], [0, [0.10455955157850177, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685618]
bas 1, expnt(s) = [503.79792079]
bas 2, expnt(s) = [75.82688671]
bas 3, expnt(s) = [17.18057912]
bas 4, expnt(s) = [4.72237485]
bas 5, expnt(s) = [1.42038913]
bas 6, expnt(s) = [0.10455955]
CPU time:        18.99
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797921e+02 2.68662655e+02
 7.58268867e+01 6.49205878e+01 1.71805791e+01 2.13203030e+01
 4.72237485e+00 8.09348129e+00 1.42038913e+00 3.28715762e+00
 1.04559552e-01 4.64555716e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873328356464177
cond(S) = 43.8646026576918
E1 = -19.062728480815466  E_coul = 4.528946780306927
init E= -14.5337817005085
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300695984492567  LUMO = 3.73488697906678
  mo_energy =
[-4.71382379e+00 -3.00695984e-01  3.73488698e+00  2.63556632e+01
  1.37731101e+02  8.99229933e+02  8.66898482e+03]
E1 = -19.056674459644864  E_coul = 4.498206832444297
cycle= 1 E= -14.5584676272006  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143019
diis-c [-2.04545452e-04  1.00000000e+00]
  HOMO = -0.300649132576347  LUMO = 3.73068059296287
  mo_energy =
[-4.72949848e+00 -3.00649133e-01  3.73068059e+00  2.63384875e+01
  1.37707346e+02  8.99200398e+02  8.66895253e+03]
E1 = -19.053426335416415  E_coul = 4.494921427892442
cycle= 2 E= -14.558504907524  delta_E= -3.73e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170744
diis-c [-7.66741337e-07 -1.14433106e-01  1.11443311e+00]
  HOMO = -0.300804104655381  LUMO = 3.72997383603178
  mo_energy =
[-4.73117593e+00 -3.00804105e-01  3.72997384e+00  2.63368054e+01
  1.37705356e+02  8.99198217e+02  8.66895028e+03]
E1 = -19.05315892732723  E_coul = 4.494653751672601
cycle= 3 E= -14.5585051756546  delta_E= -2.68e-07  |g|= 3.09e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.01497e-05
diis-c [-2.58833828e-10  8.88493787e-04 -3.86030065e-04  9.99497536e-01]
  HOMO = -0.300800355200304  LUMO = 3.72999690867238
  mo_energy =
[-4.73112383e+00 -3.00800355e-01  3.72999691e+00  2.63368738e+01
  1.37705461e+02  8.99198348e+02  8.66895042e+03]
E1 = -19.053165946265228  E_coul = 4.494660770513894
cycle= 4 E= -14.5585051757513  delta_E= -9.67e-11  |g|= 1.21e-06  |ddm|= 2.4e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053165946265228  E_coul = 4.494660770513894
  HOMO = -0.300800245666604  LUMO = 3.72999772475013
  mo_energy =
[-4.73112196e+00 -3.00800246e-01  3.72999772e+00  2.63368764e+01
  1.37705465e+02  8.99198353e+02  8.66895042e+03]
E1 = -19.053166201649475  E_coul = 4.494661025898001
Extra cycle  E= -14.5585051757515  delta_E= -1.4e-13  |g|= 8.56e-08  |ddm|= 7.84e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.8646026576918
E1 = -19.053166201649475  E_coul = 4.494661025898001
init E= -14.5585051757515
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300800237731273  LUMO = 3.72999777675008
  mo_energy =
[-4.73112184e+00 -3.00800238e-01  3.72999778e+00  2.63368766e+01
  1.37705465e+02  8.99198353e+02  8.66895042e+03]
E1 = -19.053166219003394  E_coul = 4.494661043251924
cycle= 1 E= -14.5585051757515  delta_E= 3.55e-15  |g|= 6.31e-09  |ddm|= 5.84e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053166219003394  E_coul = 4.494661043251924
  HOMO = -0.300800237133819  LUMO = 3.72999778024202
  mo_energy =
[-4.73112183e+00 -3.00800237e-01  3.72999778e+00  2.63368766e+01
  1.37705465e+02  8.99198353e+02  8.66895042e+03]
E1 = -19.053166220238264  E_coul = 4.494661044486789
Extra cycle  E= -14.5585051757515  delta_E= -3.55e-15  |g|= 4.96e-10  |ddm|= 4.56e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03797921e+02 7.58268867e+01 1.71805791e+01
 4.72237485e+00 1.42038913e+00 1.04559552e-01]
grad_E = [ 4.91331991e-08  9.20614033e-06 -3.32224808e-05  3.56309930e-05
  1.01051867e-04 -2.21054720e-04 -1.30424207e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.9868556         1
[INPUT] 0    0    [1    /1   ]  503.79781016         1
[INPUT] 0    0    [1    /1   ]  75.8273244298        1
[INPUT] 0    0    [1    /1   ]  17.1796241506        1
[INPUT] 0    0    [1    /1   ]  4.72325534572        1
[INPUT] 0    0    [1    /1   ]  1.42119570617        1
[INPUT] 0    0    [1    /1   ]  0.104560396795       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986855598716, 1.0]], [0, [503.7978101599528, 1.0]], [0, [75.82732442975885, 1.0]], [0, [17.179624150627557, 1.0]], [0, [4.723255345722147, 1.0]], [0, [1.4211957061733227, 1.0]], [0, [0.10456039679466379, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.9868556]
bas 1, expnt(s) = [503.79781016]
bas 2, expnt(s) = [75.82732443]
bas 3, expnt(s) = [17.17962415]
bas 4, expnt(s) = [4.72325535]
bas 5, expnt(s) = [1.42119571]
bas 6, expnt(s) = [0.1045604]
CPU time:        20.87
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797810e+02 2.68662611e+02
 7.58273244e+01 6.49208688e+01 1.71796242e+01 2.13194142e+01
 4.72325535e+00 8.09461305e+00 1.42119571e+00 3.28855750e+00
 1.04560397e-01 4.64558533e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873327158341243
cond(S) = 43.893983457861665
E1 = -19.06273702780602  E_coul = 4.528940847132945
init E= -14.5337961806731
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698622960609  LUMO = 3.73712218029464
  mo_energy =
[-4.71382444e+00 -3.00698623e-01  3.73712218e+00  2.63603403e+01
  1.37734800e+02  8.99233136e+02  8.66898712e+03]
E1 = -19.056738844369587  E_coul = 4.4982710890372415
cycle= 1 E= -14.5584677553323  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143014
diis-c [-2.04530176e-04  1.00000000e+00]
  HOMO = -0.300648615355484  LUMO = 3.73293209083319
  mo_energy =
[-4.72946692e+00 -3.00648615e-01  3.73293209e+00  2.63432123e+01
  1.37711104e+02  8.99203671e+02  8.66895490e+03]
E1 = -19.05349675060556  E_coul = 4.494991759059681
cycle= 2 E= -14.5585049915459  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170628
diis-c [-7.65577237e-07 -1.14355269e-01  1.11435527e+00]
  HOMO = -0.300803358432466  LUMO = 3.73222678129759
  mo_energy =
[-4.73114108e+00 -3.00803358e-01  3.73222678e+00  2.63415348e+01
  1.37709120e+02  8.99201496e+02  8.66895266e+03]
E1 = -19.05322996676355  E_coul = 4.494724707503454
cycle= 3 E= -14.5585052592601  delta_E= -2.68e-07  |g|= 3.08e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00666e-05
diis-c [-2.57377855e-10  8.90181714e-04 -4.53774762e-04  9.99563593e-01]
  HOMO = -0.300799621528148  LUMO = 3.73224978323841
  mo_energy =
[-4.73108914e+00 -3.00799622e-01  3.73224978e+00  2.63416030e+01
  1.37709225e+02  8.99201627e+02  8.66895280e+03]
E1 = -19.053236958392503  E_coul = 4.494731699036358
cycle= 4 E= -14.5585052593561  delta_E= -9.61e-11  |g|= 1.21e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053236958392503  E_coul = 4.494731699036358
  HOMO = -0.300799512192143  LUMO = 3.73225059729292
  mo_energy =
[-4.73108727e+00 -3.00799512e-01  3.73225060e+00  2.63416056e+01
  1.37709229e+02  8.99201632e+02  8.66895280e+03]
E1 = -19.053237213080973  E_coul = 4.4947319537246955
Extra cycle  E= -14.5585052593563  delta_E= -1.31e-13  |g|= 8.54e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03797810e+02 7.58273244e+01 1.71796242e+01
 4.72325535e+00 1.42119571e+00 1.04560397e-01]
E = -14.558505259356277
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.9868556         1
[INPUT] 0    0    [1    /1   ]  503.79781016         1
[INPUT] 0    0    [1    /1   ]  75.8273244298        1
[INPUT] 0    0    [1    /1   ]  17.1796241506        1
[INPUT] 0    0    [1    /1   ]  4.72325534572        1
[INPUT] 0    0    [1    /1   ]  1.42119570617        1
[INPUT] 0    0    [1    /1   ]  0.104560396795       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986855598716, 1.0]], [0, [503.7978101599528, 1.0]], [0, [75.82732442975885, 1.0]], [0, [17.179624150627557, 1.0]], [0, [4.723255345722147, 1.0]], [0, [1.4211957061733227, 1.0]], [0, [0.10456039679466379, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.9868556]
bas 1, expnt(s) = [503.79781016]
bas 2, expnt(s) = [75.82732443]
bas 3, expnt(s) = [17.17962415]
bas 4, expnt(s) = [4.72325535]
bas 5, expnt(s) = [1.42119571]
bas 6, expnt(s) = [0.1045604]
CPU time:        21.07
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797810e+02 2.68662611e+02
 7.58273244e+01 6.49208688e+01 1.71796242e+01 2.13194142e+01
 4.72325535e+00 8.09461305e+00 1.42119571e+00 3.28855750e+00
 1.04560397e-01 4.64558533e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873327158341243
cond(S) = 43.893983457861665
E1 = -19.06273702780602  E_coul = 4.528940847132945
init E= -14.5337961806731
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698622960609  LUMO = 3.73712218029464
  mo_energy =
[-4.71382444e+00 -3.00698623e-01  3.73712218e+00  2.63603403e+01
  1.37734800e+02  8.99233136e+02  8.66898712e+03]
E1 = -19.056738844369587  E_coul = 4.4982710890372415
cycle= 1 E= -14.5584677553323  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143014
diis-c [-2.04530176e-04  1.00000000e+00]
  HOMO = -0.300648615355484  LUMO = 3.73293209083319
  mo_energy =
[-4.72946692e+00 -3.00648615e-01  3.73293209e+00  2.63432123e+01
  1.37711104e+02  8.99203671e+02  8.66895490e+03]
E1 = -19.05349675060556  E_coul = 4.494991759059681
cycle= 2 E= -14.5585049915459  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170628
diis-c [-7.65577237e-07 -1.14355269e-01  1.11435527e+00]
  HOMO = -0.300803358432466  LUMO = 3.73222678129759
  mo_energy =
[-4.73114108e+00 -3.00803358e-01  3.73222678e+00  2.63415348e+01
  1.37709120e+02  8.99201496e+02  8.66895266e+03]
E1 = -19.05322996676355  E_coul = 4.494724707503454
cycle= 3 E= -14.5585052592601  delta_E= -2.68e-07  |g|= 3.08e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00666e-05
diis-c [-2.57377855e-10  8.90181714e-04 -4.53774762e-04  9.99563593e-01]
  HOMO = -0.300799621528148  LUMO = 3.73224978323841
  mo_energy =
[-4.73108914e+00 -3.00799622e-01  3.73224978e+00  2.63416030e+01
  1.37709225e+02  8.99201627e+02  8.66895280e+03]
E1 = -19.053236958392503  E_coul = 4.494731699036358
cycle= 4 E= -14.5585052593561  delta_E= -9.61e-11  |g|= 1.21e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053236958392503  E_coul = 4.494731699036358
  HOMO = -0.300799512192143  LUMO = 3.73225059729292
  mo_energy =
[-4.73108727e+00 -3.00799512e-01  3.73225060e+00  2.63416056e+01
  1.37709229e+02  8.99201632e+02  8.66895280e+03]
E1 = -19.053237213080973  E_coul = 4.4947319537246955
Extra cycle  E= -14.5585052593563  delta_E= -1.31e-13  |g|= 8.54e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.893983457861665
E1 = -19.053237213080973  E_coul = 4.4947319537246955
init E= -14.5585052593563
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300799504270891  LUMO = 3.73225064914605
  mo_energy =
[-4.73108715e+00 -3.00799504e-01  3.73225065e+00  2.63416057e+01
  1.37709229e+02  8.99201632e+02  8.66895280e+03]
E1 = -19.053237230384845  E_coul = 4.494731971028566
cycle= 1 E= -14.5585052593563  delta_E= -1.78e-15  |g|= 6.29e-09  |ddm|= 5.84e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053237230384845  E_coul = 4.494731971028566
  HOMO = -0.300799503674468  LUMO = 3.73225065262738
  mo_energy =
[-4.73108714e+00 -3.00799504e-01  3.73225065e+00  2.63416057e+01
  1.37709229e+02  8.99201632e+02  8.66895280e+03]
E1 = -19.053237231616077  E_coul = 4.494731972259797
Extra cycle  E= -14.5585052593563  delta_E= -1.78e-15  |g|= 4.95e-10  |ddm|= 4.56e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03797810e+02 7.58273244e+01 1.71796242e+01
 4.72325535e+00 1.42119571e+00 1.04560397e-01]
grad_E = [ 4.91510509e-08  9.20275256e-06 -3.31085342e-05  3.62921226e-05
  6.63541932e-05 -4.51613511e-05 -3.66184298e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685558        1
[INPUT] 0    0    [1    /1   ]  503.797807516        1
[INPUT] 0    0    [1    /1   ]  75.8273294762        1
[INPUT] 0    0    [1    /1   ]  17.1796734972        1
[INPUT] 0    0    [1    /1   ]  4.7230188408         1
[INPUT] 0    0    [1    /1   ]  1.42130892166        1
[INPUT] 0    0    [1    /1   ]  0.104560901662       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986855583548, 1.0]], [0, [503.7978075163113, 1.0]], [0, [75.82732947616664, 1.0]], [0, [17.17967349724549, 1.0]], [0, [4.723018840796284, 1.0]], [0, [1.421308921662101, 1.0]], [0, [0.10456090166235299, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685558]
bas 1, expnt(s) = [503.79780752]
bas 2, expnt(s) = [75.82732948]
bas 3, expnt(s) = [17.1796735]
bas 4, expnt(s) = [4.72301884]
bas 5, expnt(s) = [1.42130892]
bas 6, expnt(s) = [0.1045609]
CPU time:        22.97
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797808e+02 2.68662610e+02
 7.58273295e+01 6.49208721e+01 1.71796735e+01 2.13194602e+01
 4.72301884e+00 8.09430906e+00 1.42130892e+00 3.28875397e+00
 1.04560902e-01 4.64560215e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873328316083416
cond(S) = 43.896640123809384
E1 = -19.062745362333636  E_coul = 4.528943828616475
init E= -14.5338015337172
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698867967172  LUMO = 3.73727744347736
  mo_energy =
[-4.71382278e+00 -3.00698868e-01  3.73727744e+00  2.63601735e+01
  1.37734505e+02  8.99232900e+02  8.66898695e+03]
E1 = -19.056758975269986  E_coul = 4.498291200268182
cycle= 1 E= -14.5584677750018  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.014301
diis-c [-2.0451721e-04  1.0000000e+00]
  HOMO = -0.300648219410805  LUMO = 3.73309209882101
  mo_energy =
[-4.72945726e+00 -3.00648219e-01  3.73309210e+00  2.63430579e+01
  1.37710823e+02  8.99203453e+02  8.66895474e+03]
E1 = -19.053518151789184  E_coul = 4.495013147279586
cycle= 2 E= -14.5585050045096  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170608
diis-c [-7.65472347e-07 -1.14342399e-01  1.11434240e+00]
  HOMO = -0.300802928750573  LUMO = 3.73238713943897
  mo_energy =
[-4.73113072e+00 -3.00802929e-01  3.73238714e+00  2.63413814e+01
  1.37708840e+02  8.99201280e+02  8.66895250e+03]
E1 = -19.053251480299316  E_coul = 4.494746208099775
cycle= 3 E= -14.5585052721995  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.0046e-05
diis-c [-2.57109823e-10  8.91239689e-04 -4.79020811e-04  9.99587781e-01]
  HOMO = -0.300799194655784  LUMO = 3.7324101226441
  mo_energy =
[-4.73107882e+00 -3.00799195e-01  3.73241012e+00  2.63414496e+01
  1.37708945e+02  8.99201410e+02  8.66895264e+03]
E1 = -19.05325846557724  E_coul = 4.494753193281809
cycle= 4 E= -14.5585052722954  delta_E= -9.59e-11  |g|= 1.21e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05325846557724  E_coul = 4.494753193281809
  HOMO = -0.300799085350309  LUMO = 3.73241093614931
  mo_energy =
[-4.73107695e+00 -3.00799085e-01  3.73241094e+00  2.63414522e+01
  1.37708949e+02  8.99201415e+02  8.66895265e+03]
E1 = -19.053258720120773  E_coul = 4.494753447825221
Extra cycle  E= -14.5585052722956  delta_E= -1.21e-13  |g|= 8.53e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03797808e+02 7.58273295e+01 1.71796735e+01
 4.72301884e+00 1.42130892e+00 1.04560902e-01]
E = -14.558505272295552
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685558        1
[INPUT] 0    0    [1    /1   ]  503.797807516        1
[INPUT] 0    0    [1    /1   ]  75.8273294762        1
[INPUT] 0    0    [1    /1   ]  17.1796734972        1
[INPUT] 0    0    [1    /1   ]  4.7230188408         1
[INPUT] 0    0    [1    /1   ]  1.42130892166        1
[INPUT] 0    0    [1    /1   ]  0.104560901662       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986855583548, 1.0]], [0, [503.7978075163113, 1.0]], [0, [75.82732947616664, 1.0]], [0, [17.17967349724549, 1.0]], [0, [4.723018840796284, 1.0]], [0, [1.421308921662101, 1.0]], [0, [0.10456090166235299, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685558]
bas 1, expnt(s) = [503.79780752]
bas 2, expnt(s) = [75.82732948]
bas 3, expnt(s) = [17.1796735]
bas 4, expnt(s) = [4.72301884]
bas 5, expnt(s) = [1.42130892]
bas 6, expnt(s) = [0.1045609]
CPU time:        23.19
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797808e+02 2.68662610e+02
 7.58273295e+01 6.49208721e+01 1.71796735e+01 2.13194602e+01
 4.72301884e+00 8.09430906e+00 1.42130892e+00 3.28875397e+00
 1.04560902e-01 4.64560215e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873328316083416
cond(S) = 43.896640123809384
E1 = -19.062745362333636  E_coul = 4.528943828616475
init E= -14.5338015337172
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698867967172  LUMO = 3.73727744347736
  mo_energy =
[-4.71382278e+00 -3.00698868e-01  3.73727744e+00  2.63601735e+01
  1.37734505e+02  8.99232900e+02  8.66898695e+03]
E1 = -19.056758975269986  E_coul = 4.498291200268182
cycle= 1 E= -14.5584677750018  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.014301
diis-c [-2.0451721e-04  1.0000000e+00]
  HOMO = -0.300648219410805  LUMO = 3.73309209882101
  mo_energy =
[-4.72945726e+00 -3.00648219e-01  3.73309210e+00  2.63430579e+01
  1.37710823e+02  8.99203453e+02  8.66895474e+03]
E1 = -19.053518151789184  E_coul = 4.495013147279586
cycle= 2 E= -14.5585050045096  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170608
diis-c [-7.65472347e-07 -1.14342399e-01  1.11434240e+00]
  HOMO = -0.300802928750573  LUMO = 3.73238713943897
  mo_energy =
[-4.73113072e+00 -3.00802929e-01  3.73238714e+00  2.63413814e+01
  1.37708840e+02  8.99201280e+02  8.66895250e+03]
E1 = -19.053251480299316  E_coul = 4.494746208099775
cycle= 3 E= -14.5585052721995  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.0046e-05
diis-c [-2.57109823e-10  8.91239689e-04 -4.79020811e-04  9.99587781e-01]
  HOMO = -0.300799194655784  LUMO = 3.7324101226441
  mo_energy =
[-4.73107882e+00 -3.00799195e-01  3.73241012e+00  2.63414496e+01
  1.37708945e+02  8.99201410e+02  8.66895264e+03]
E1 = -19.05325846557724  E_coul = 4.494753193281809
cycle= 4 E= -14.5585052722954  delta_E= -9.59e-11  |g|= 1.21e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05325846557724  E_coul = 4.494753193281809
  HOMO = -0.300799085350309  LUMO = 3.73241093614931
  mo_energy =
[-4.73107695e+00 -3.00799085e-01  3.73241094e+00  2.63414522e+01
  1.37708949e+02  8.99201415e+02  8.66895265e+03]
E1 = -19.053258720120773  E_coul = 4.494753447825221
Extra cycle  E= -14.5585052722956  delta_E= -1.21e-13  |g|= 8.53e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.896640123809384
E1 = -19.053258720120773  E_coul = 4.494753447825221
init E= -14.5585052722956
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300799077430159  LUMO = 3.73241098796681
  mo_energy =
[-4.73107683e+00 -3.00799077e-01  3.73241099e+00  2.63414523e+01
  1.37708949e+02  8.99201415e+02  8.66895265e+03]
E1 = -19.053258737415856  E_coul = 4.494753465120297
cycle= 1 E= -14.5585052722956  delta_E= -7.11e-15  |g|= 6.29e-09  |ddm|= 5.84e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053258737415856  E_coul = 4.494753465120297
  HOMO = -0.300799076833738  LUMO = 3.73241099144594
  mo_energy =
[-4.73107683e+00 -3.00799077e-01  3.73241099e+00  2.63414523e+01
  1.37708949e+02  8.99201415e+02  8.66895265e+03]
E1 = -19.053258738646594  E_coul = 4.494753466351046
Extra cycle  E= -14.5585052722955  delta_E= 1.07e-14  |g|= 4.95e-10  |ddm|= 4.56e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03797808e+02 7.58273295e+01 1.71796735e+01
 4.72301884e+00 1.42130892e+00 1.04560902e-01]
grad_E = [ 4.91331322e-08  9.20656100e-06 -3.33052070e-05  3.94764908e-05
  4.41208930e-05  1.78803316e-05  1.49729893e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685555        1
[INPUT] 0    0    [1    /1   ]  503.797801781        1
[INPUT] 0    0    [1    /1   ]  75.8273445983        1
[INPUT] 0    0    [1    /1   ]  17.179722913         1
[INPUT] 0    0    [1    /1   ]  4.72274204536        1
[INPUT] 0    0    [1    /1   ]  1.42131422924        1
[INPUT] 0    0    [1    /1   ]  0.104561191968       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986855551614, 1.0]], [0, [503.79780178149815, 1.0]], [0, [75.82734459834377, 1.0]], [0, [17.179722912976818, 1.0]], [0, [4.72274204535675, 1.0]], [0, [1.4213142292428813, 1.0]], [0, [0.10456119196824731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685555]
bas 1, expnt(s) = [503.79780178]
bas 2, expnt(s) = [75.8273446]
bas 3, expnt(s) = [17.17972291]
bas 4, expnt(s) = [4.72274205]
bas 5, expnt(s) = [1.42131423]
bas 6, expnt(s) = [0.10456119]
CPU time:        25.14
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797802e+02 2.68662607e+02
 7.58273446e+01 6.49208818e+01 1.71797229e+01 2.13195062e+01
 4.72274205e+00 8.09395328e+00 1.42131423e+00 3.28876318e+00
 1.04561192e-01 4.64561182e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987332936902691
cond(S) = 43.89581861672049
E1 = -19.06275083787026  E_coul = 4.5289466948288695
init E= -14.5338041430414
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698791483011  LUMO = 3.73716798490288
  mo_energy =
[-4.71382145e+00 -3.00698791e-01  3.73716798e+00  2.63594890e+01
  1.37733688e+02  8.99232247e+02  8.66898646e+03]
E1 = -19.056767818814567  E_coul = 4.498300034423038
cycle= 1 E= -14.5584677843915  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143006
diis-c [-2.04508116e-04  1.00000000e+00]
  HOMO = -0.300647975682544  LUMO = 3.73298459803197
  mo_energy =
[-4.72945310e+00 -3.00647976e-01  3.73298460e+00  2.63423779e+01
  1.37710010e+02  8.99202806e+02  8.66895426e+03]
E1 = -19.05352735237294  E_coul = 4.495022339123992
cycle= 2 E= -14.5585050132489  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170605
diis-c [-7.65506678e-07 -1.14340629e-01  1.11434063e+00]
  HOMO = -0.300802682574409  LUMO = 3.7322797584279
  mo_energy =
[-4.73112636e+00 -3.00802683e-01  3.73227976e+00  2.63407019e+01
  1.37708028e+02  8.99200634e+02  8.66895202e+03]
E1 = -19.05326070303681  E_coul = 4.494755422074295
cycle= 3 E= -14.5585052809625  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00387e-05
diis-c [-2.57046890e-10  8.91880977e-04 -4.91339621e-04  9.99599459e-01]
  HOMO = -0.300798949330313  LUMO = 3.73230273458374
  mo_energy =
[-4.73107446e+00 -3.00798949e-01  3.73230273e+00  2.63407700e+01
  1.37708133e+02  8.99200764e+02  8.66895216e+03]
E1 = -19.053267686271724  E_coul = 4.494762405213384
cycle= 4 E= -14.5585052810583  delta_E= -9.58e-11  |g|= 1.21e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053267686271724  E_coul = 4.494762405213384
  HOMO = -0.300798840028067  LUMO = 3.73230354787476
  mo_energy =
[-4.73107260e+00 -3.00798840e-01  3.73230355e+00  2.63407726e+01
  1.37708137e+02  8.99200769e+02  8.66895216e+03]
E1 = -19.053267940775445  E_coul = 4.494762659716988
Extra cycle  E= -14.5585052810585  delta_E= -1.17e-13  |g|= 8.53e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03797802e+02 7.58273446e+01 1.71797229e+01
 4.72274205e+00 1.42131423e+00 1.04561192e-01]
E = -14.558505281058457
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685555        1
[INPUT] 0    0    [1    /1   ]  503.797801781        1
[INPUT] 0    0    [1    /1   ]  75.8273445983        1
[INPUT] 0    0    [1    /1   ]  17.179722913         1
[INPUT] 0    0    [1    /1   ]  4.72274204536        1
[INPUT] 0    0    [1    /1   ]  1.42131422924        1
[INPUT] 0    0    [1    /1   ]  0.104561191968       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986855551614, 1.0]], [0, [503.79780178149815, 1.0]], [0, [75.82734459834377, 1.0]], [0, [17.179722912976818, 1.0]], [0, [4.72274204535675, 1.0]], [0, [1.4213142292428813, 1.0]], [0, [0.10456119196824731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685555]
bas 1, expnt(s) = [503.79780178]
bas 2, expnt(s) = [75.8273446]
bas 3, expnt(s) = [17.17972291]
bas 4, expnt(s) = [4.72274205]
bas 5, expnt(s) = [1.42131423]
bas 6, expnt(s) = [0.10456119]
CPU time:        25.39
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797802e+02 2.68662607e+02
 7.58273446e+01 6.49208818e+01 1.71797229e+01 2.13195062e+01
 4.72274205e+00 8.09395328e+00 1.42131423e+00 3.28876318e+00
 1.04561192e-01 4.64561182e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987332936902691
cond(S) = 43.89581861672049
E1 = -19.06275083787026  E_coul = 4.5289466948288695
init E= -14.5338041430414
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698791483011  LUMO = 3.73716798490288
  mo_energy =
[-4.71382145e+00 -3.00698791e-01  3.73716798e+00  2.63594890e+01
  1.37733688e+02  8.99232247e+02  8.66898646e+03]
E1 = -19.056767818814567  E_coul = 4.498300034423038
cycle= 1 E= -14.5584677843915  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143006
diis-c [-2.04508116e-04  1.00000000e+00]
  HOMO = -0.300647975682544  LUMO = 3.73298459803197
  mo_energy =
[-4.72945310e+00 -3.00647976e-01  3.73298460e+00  2.63423779e+01
  1.37710010e+02  8.99202806e+02  8.66895426e+03]
E1 = -19.05352735237294  E_coul = 4.495022339123992
cycle= 2 E= -14.5585050132489  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170605
diis-c [-7.65506678e-07 -1.14340629e-01  1.11434063e+00]
  HOMO = -0.300802682574409  LUMO = 3.7322797584279
  mo_energy =
[-4.73112636e+00 -3.00802683e-01  3.73227976e+00  2.63407019e+01
  1.37708028e+02  8.99200634e+02  8.66895202e+03]
E1 = -19.05326070303681  E_coul = 4.494755422074295
cycle= 3 E= -14.5585052809625  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00387e-05
diis-c [-2.57046890e-10  8.91880977e-04 -4.91339621e-04  9.99599459e-01]
  HOMO = -0.300798949330313  LUMO = 3.73230273458374
  mo_energy =
[-4.73107446e+00 -3.00798949e-01  3.73230273e+00  2.63407700e+01
  1.37708133e+02  8.99200764e+02  8.66895216e+03]
E1 = -19.053267686271724  E_coul = 4.494762405213384
cycle= 4 E= -14.5585052810583  delta_E= -9.58e-11  |g|= 1.21e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053267686271724  E_coul = 4.494762405213384
  HOMO = -0.300798840028067  LUMO = 3.73230354787476
  mo_energy =
[-4.73107260e+00 -3.00798840e-01  3.73230355e+00  2.63407726e+01
  1.37708137e+02  8.99200769e+02  8.66895216e+03]
E1 = -19.053267940775445  E_coul = 4.494762659716988
Extra cycle  E= -14.5585052810585  delta_E= -1.17e-13  |g|= 8.53e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.89581861672049
E1 = -19.053267940775445  E_coul = 4.494762659716988
init E= -14.5585052810585
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.300798832107324  LUMO = 3.73230359967996
  mo_energy =
[-4.73107248e+00 -3.00798832e-01  3.73230360e+00  2.63407727e+01
  1.37708137e+02  8.99200769e+02  8.66895216e+03]
E1 = -19.053267958068957  E_coul = 4.49476267701049
cycle= 1 E= -14.5585052810585  delta_E= -1.07e-14  |g|= 6.29e-09  |ddm|= 5.84e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053267958068957  E_coul = 4.49476267701049
  HOMO = -0.300798831510797  LUMO = 3.73230360315852
  mo_energy =
[-4.73107247e+00 -3.00798832e-01  3.73230360e+00  2.63407727e+01
  1.37708137e+02  8.99200769e+02  8.66895216e+03]
E1 = -19.053267959299692  E_coul = 4.494762678241231
Extra cycle  E= -14.5585052810585  delta_E= 5.33e-15  |g|= 4.95e-10  |ddm|= 4.56e-09
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [5.03798686e+03 5.03797802e+02 7.58273446e+01 1.71797229e+01
 4.72274205e+00 1.42131423e+00 1.04561192e-01]
grad_E = [ 4.91196552e-08  9.20940818e-06 -3.34510804e-05  4.17139132e-05
  3.09498680e-05  4.80808892e-05  2.08417341e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685529        1
[INPUT] 0    0    [1    /1   ]  503.797752585        1
[INPUT] 0    0    [1    /1   ]  75.827514836         1
[INPUT] 0    0    [1    /1   ]  17.1796140652        1
[INPUT] 0    0    [1    /1   ]  4.7221535735         1
[INPUT] 0    0    [1    /1   ]  1.42129141552        1
[INPUT] 0    0    [1    /1   ]  0.104561688512       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.98685528724, 1.0]], [0, [503.79775258541616, 1.0]], [0, [75.82751483603901, 1.0]], [0, [17.179614065201815, 1.0]], [0, [4.7221535735005755, 1.0]], [0, [1.4212914155205285, 1.0]], [0, [0.10456168851226388, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685529]
bas 1, expnt(s) = [503.79775259]
bas 2, expnt(s) = [75.82751484]
bas 3, expnt(s) = [17.17961407]
bas 4, expnt(s) = [4.72215357]
bas 5, expnt(s) = [1.42129142]
bas 6, expnt(s) = [0.10456169]
CPU time:        27.44
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797753e+02 2.68662588e+02
 7.58275148e+01 6.49209911e+01 1.71796141e+01 2.13194048e+01
 4.72215357e+00 8.09319686e+00 1.42129142e+00 3.28872359e+00
 1.04561689e-01 4.64562837e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873331560952803
cond(S) = 43.89334931461394
E1 = -19.06276091751261  E_coul = 4.528952433539308
init E= -14.5338084839733
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698540047956  LUMO = 3.7368577395544
  mo_energy =
[-4.71381887e+00 -3.00698540e-01  3.73685774e+00  2.63577361e+01
  1.37731339e+02  8.99230430e+02  8.66898506e+03]
E1 = -19.056782022005056  E_coul = 4.49831421428759
cycle= 1 E= -14.5584678077175  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143
diis-c [-2.04489273e-04  1.00000000e+00]
  HOMO = -0.300647545310586  LUMO = 3.7326773707636
  mo_energy =
[-4.72944645e+00 -3.00647545e-01  3.73267737e+00  2.63406319e+01
  1.37707668e+02  8.99200999e+02  8.66895287e+03]
E1 = -19.05354197517929  E_coul = 4.495036937951418
cycle= 2 E= -14.5585050372279  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170603
diis-c [-7.65612277e-07 -1.14341074e-01  1.11434107e+00]
  HOMO = -0.300802257689702  LUMO = 3.73197269589793
  mo_energy =
[-4.73111947e+00 -3.00802258e-01  3.73197270e+00  2.63389565e+01
  1.37705686e+02  8.99198827e+02  8.66895063e+03]
E1 = -19.053275340292984  E_coul = 4.494770035288538
cycle= 3 E= -14.5585053050044  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00282e-05
diis-c [-2.56973647e-10  8.93053208e-04 -5.11783605e-04  9.99618730e-01]
  HOMO = -0.300798525467663  LUMO = 3.731995661863
  mo_energy =
[-4.73106759e+00 -3.00798525e-01  3.73199566e+00  2.63390246e+01
  1.37705791e+02  8.99198958e+02  8.66895077e+03]
E1 = -19.053282320907936  E_coul = 4.494777015807739
cycle= 4 E= -14.5585053051002  delta_E= -9.58e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053282320907936  E_coul = 4.494777015807739
  HOMO = -0.300798416163183  LUMO = 3.73199647482998
  mo_energy =
[-4.73106573e+00 -3.00798416e-01  3.73199647e+00  2.63390271e+01
  1.37705795e+02  8.99198962e+02  8.66895078e+03]
E1 = -19.053282575365973  E_coul = 4.494777270265653
Extra cycle  E= -14.5585053051003  delta_E= -1.21e-13  |g|= 8.53e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798686e+03 5.03797753e+02 7.58275148e+01 1.71796141e+01
 4.72215357e+00 1.42129142e+00 1.04561689e-01]
E = -14.558505305100319
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685529        1
[INPUT] 0    0    [1    /1   ]  503.797752585        1
[INPUT] 0    0    [1    /1   ]  75.827514836         1
[INPUT] 0    0    [1    /1   ]  17.1796140652        1
[INPUT] 0    0    [1    /1   ]  4.7221535735         1
[INPUT] 0    0    [1    /1   ]  1.42129141552        1
[INPUT] 0    0    [1    /1   ]  0.104561688512       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.98685528724, 1.0]], [0, [503.79775258541616, 1.0]], [0, [75.82751483603901, 1.0]], [0, [17.179614065201815, 1.0]], [0, [4.7221535735005755, 1.0]], [0, [1.4212914155205285, 1.0]], [0, [0.10456168851226388, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685529]
bas 1, expnt(s) = [503.79775259]
bas 2, expnt(s) = [75.82751484]
bas 3, expnt(s) = [17.17961407]
bas 4, expnt(s) = [4.72215357]
bas 5, expnt(s) = [1.42129142]
bas 6, expnt(s) = [0.10456169]
CPU time:        27.71
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798686e+03 1.51080285e+03 5.03797753e+02 2.68662588e+02
 7.58275148e+01 6.49209911e+01 1.71796141e+01 2.13194048e+01
 4.72215357e+00 8.09319686e+00 1.42129142e+00 3.28872359e+00
 1.04561689e-01 4.64562837e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873331560952803
cond(S) = 43.89334931461394
E1 = -19.06276091751261  E_coul = 4.528952433539308
init E= -14.5338084839733
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698540047956  LUMO = 3.7368577395544
  mo_energy =
[-4.71381887e+00 -3.00698540e-01  3.73685774e+00  2.63577361e+01
  1.37731339e+02  8.99230430e+02  8.66898506e+03]
E1 = -19.056782022005056  E_coul = 4.49831421428759
cycle= 1 E= -14.5584678077175  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0143
diis-c [-2.04489273e-04  1.00000000e+00]
  HOMO = -0.300647545310586  LUMO = 3.7326773707636
  mo_energy =
[-4.72944645e+00 -3.00647545e-01  3.73267737e+00  2.63406319e+01
  1.37707668e+02  8.99200999e+02  8.66895287e+03]
E1 = -19.05354197517929  E_coul = 4.495036937951418
cycle= 2 E= -14.5585050372279  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170603
diis-c [-7.65612277e-07 -1.14341074e-01  1.11434107e+00]
  HOMO = -0.300802257689702  LUMO = 3.73197269589793
  mo_energy =
[-4.73111947e+00 -3.00802258e-01  3.73197270e+00  2.63389565e+01
  1.37705686e+02  8.99198827e+02  8.66895063e+03]
E1 = -19.053275340292984  E_coul = 4.494770035288538
cycle= 3 E= -14.5585053050044  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00282e-05
diis-c [-2.56973647e-10  8.93053208e-04 -5.11783605e-04  9.99618730e-01]
  HOMO = -0.300798525467663  LUMO = 3.731995661863
  mo_energy =
[-4.73106759e+00 -3.00798525e-01  3.73199566e+00  2.63390246e+01
  1.37705791e+02  8.99198958e+02  8.66895077e+03]
E1 = -19.053282320907936  E_coul = 4.494777015807739
cycle= 4 E= -14.5585053051002  delta_E= -9.58e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053282320907936  E_coul = 4.494777015807739
  HOMO = -0.300798416163183  LUMO = 3.73199647482998
  mo_energy =
[-4.73106573e+00 -3.00798416e-01  3.73199647e+00  2.63390271e+01
  1.37705795e+02  8.99198962e+02  8.66895078e+03]
E1 = -19.053282575365973  E_coul = 4.494777270265653
Extra cycle  E= -14.5585053051003  delta_E= -1.21e-13  |g|= 8.53e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.89334931461394
E1 = -19.053282575365973  E_coul = 4.494777270265653
init E= -14.5585053051003
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.300798408240691  LUMO = 3.73199652661813
  mo_energy =
[-4.73106561e+00 -3.00798408e-01  3.73199653e+00  2.63390273e+01
  1.37705795e+02  8.99198963e+02  8.66895078e+03]
E1 = -19.053282592658665  E_coul = 4.494777287558339
cycle= 1 E= -14.5585053051003  delta_E= -7.11e-15  |g|= 6.29e-09  |ddm|= 5.84e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053282592658665  E_coul = 4.494777287558339
  HOMO = -0.300798407643916  LUMO = 3.73199653009596
  mo_energy =
[-4.73106560e+00 -3.00798408e-01  3.73199653e+00  2.63390273e+01
  1.37705795e+02  8.99198963e+02  8.66895078e+03]
E1 = -19.05328259388958  E_coul = 4.494777288789256
Extra cycle  E= -14.5585053051003  delta_E=    0  |g|= 4.96e-10  |ddm|= 4.56e-09
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [5.03798686e+03 5.03797753e+02 7.58275148e+01 1.71796141e+01
 4.72215357e+00 1.42129142e+00 1.04561689e-01]
grad_E = [ 4.90988475e-08  9.21384887e-06 -3.36900316e-05  4.56087753e-05
  8.03969634e-06  9.80644818e-05  5.33010171e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685432        1
[INPUT] 0    0    [1    /1   ]  503.797570959        1
[INPUT] 0    0    [1    /1   ]  75.8281682868        1
[INPUT] 0    0    [1    /1   ]  17.1788842419        1
[INPUT] 0    0    [1    /1   ]  4.72107186011        1
[INPUT] 0    0    [1    /1   ]  1.42121715626        1
[INPUT] 0    0    [1    /1   ]  0.104562425605       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986854317095, 1.0]], [0, [503.7975709586109, 1.0]], [0, [75.82816828676124, 1.0]], [0, [17.17888424189968, 1.0]], [0, [4.721071860114789, 1.0]], [0, [1.4212171562613547, 1.0]], [0, [0.10456242560544844, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685432]
bas 1, expnt(s) = [503.79757096]
bas 2, expnt(s) = [75.82816829]
bas 3, expnt(s) = [17.17888424]
bas 4, expnt(s) = [4.72107186]
bas 5, expnt(s) = [1.42121716]
bas 6, expnt(s) = [0.10456243]
CPU time:        29.76
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798685e+03 1.51080285e+03 5.03797571e+02 2.68662515e+02
 7.58281683e+01 6.49214107e+01 1.71788842e+01 2.13187256e+01
 4.72107186e+00 8.09180638e+00 1.42121716e+00 3.28859472e+00
 1.04562426e-01 4.64565293e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987333559783202
cond(S) = 43.88863729423087
E1 = -19.062777331432535  E_coul = 4.528962359249249
init E= -14.5338149721833
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698006536906  LUMO = 3.73621477069069
  mo_energy =
[-4.71381450e+00 -3.00698007e-01  3.73621477e+00  2.63539754e+01
  1.37725692e+02  8.99226180e+02  8.66898175e+03]
E1 = -19.056802767055938  E_coul = 4.498334903733861
cycle= 1 E= -14.5584678633221  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142987
diis-c [-2.04453317e-04  1.00000000e+00]
  HOMO = -0.300646881592765  LUMO = 3.73203858704253
  mo_energy =
[-4.72943680e+00 -3.00646882e-01  3.73203859e+00  2.63368807e+01
  1.37702029e+02  8.99196761e+02  8.66894958e+03]
E1 = -19.053563113272798  E_coul = 4.49505801714824
cycle= 2 E= -14.5585050961246  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170603
diis-c [-7.65822172e-07 -1.14346901e-01  1.11434690e+00]
  HOMO = -0.300801615373251  LUMO = 3.73133411098374
  mo_energy =
[-4.73110959e+00 -3.00801615e-01  3.73133411e+00  2.63352059e+01
  1.37700048e+02  8.99194591e+02  8.66894734e+03]
E1 = -19.053296468836486  E_coul = 4.494791104809023
cycle= 3 E= -14.5585053640275  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00145e-05
diis-c [-2.56885934e-10  8.94982131e-04 -5.42182914e-04  9.99647201e-01]
  HOMO = -0.300797884075979  LUMO = 3.73135706402216
  mo_energy =
[-4.73105773e+00 -3.00797884e-01  3.73135706e+00  2.63352740e+01
  1.37700153e+02  8.99194721e+02  8.66894748e+03]
E1 = -19.053303446704184  E_coul = 4.494798082581053
cycle= 4 E= -14.5585053641231  delta_E= -9.57e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053303446704184  E_coul = 4.494798082581053
  HOMO = -0.300797774758358  LUMO = 3.73135787654248
  mo_energy =
[-4.73105587e+00 -3.00797775e-01  3.73135788e+00  2.63352766e+01
  1.37700157e+02  8.99194726e+02  8.66894748e+03]
E1 = -19.053303701121234  E_coul = 4.494798336997978
Extra cycle  E= -14.5585053641233  delta_E= -1.24e-13  |g|= 8.52e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798685e+03 5.03797571e+02 7.58281683e+01 1.71788842e+01
 4.72107186e+00 1.42121716e+00 1.04562426e-01]
E = -14.558505364123256
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685432        1
[INPUT] 0    0    [1    /1   ]  503.797570959        1
[INPUT] 0    0    [1    /1   ]  75.8281682868        1
[INPUT] 0    0    [1    /1   ]  17.1788842419        1
[INPUT] 0    0    [1    /1   ]  4.72107186011        1
[INPUT] 0    0    [1    /1   ]  1.42121715626        1
[INPUT] 0    0    [1    /1   ]  0.104562425605       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986854317095, 1.0]], [0, [503.7975709586109, 1.0]], [0, [75.82816828676124, 1.0]], [0, [17.17888424189968, 1.0]], [0, [4.721071860114789, 1.0]], [0, [1.4212171562613547, 1.0]], [0, [0.10456242560544844, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685432]
bas 1, expnt(s) = [503.79757096]
bas 2, expnt(s) = [75.82816829]
bas 3, expnt(s) = [17.17888424]
bas 4, expnt(s) = [4.72107186]
bas 5, expnt(s) = [1.42121716]
bas 6, expnt(s) = [0.10456243]
CPU time:        30.03
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798685e+03 1.51080285e+03 5.03797571e+02 2.68662515e+02
 7.58281683e+01 6.49214107e+01 1.71788842e+01 2.13187256e+01
 4.72107186e+00 8.09180638e+00 1.42121716e+00 3.28859472e+00
 1.04562426e-01 4.64565293e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987333559783202
cond(S) = 43.88863729423087
E1 = -19.062777331432535  E_coul = 4.528962359249249
init E= -14.5338149721833
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300698006536906  LUMO = 3.73621477069069
  mo_energy =
[-4.71381450e+00 -3.00698007e-01  3.73621477e+00  2.63539754e+01
  1.37725692e+02  8.99226180e+02  8.66898175e+03]
E1 = -19.056802767055938  E_coul = 4.498334903733861
cycle= 1 E= -14.5584678633221  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142987
diis-c [-2.04453317e-04  1.00000000e+00]
  HOMO = -0.300646881592765  LUMO = 3.73203858704253
  mo_energy =
[-4.72943680e+00 -3.00646882e-01  3.73203859e+00  2.63368807e+01
  1.37702029e+02  8.99196761e+02  8.66894958e+03]
E1 = -19.053563113272798  E_coul = 4.49505801714824
cycle= 2 E= -14.5585050961246  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170603
diis-c [-7.65822172e-07 -1.14346901e-01  1.11434690e+00]
  HOMO = -0.300801615373251  LUMO = 3.73133411098374
  mo_energy =
[-4.73110959e+00 -3.00801615e-01  3.73133411e+00  2.63352059e+01
  1.37700048e+02  8.99194591e+02  8.66894734e+03]
E1 = -19.053296468836486  E_coul = 4.494791104809023
cycle= 3 E= -14.5585053640275  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00145e-05
diis-c [-2.56885934e-10  8.94982131e-04 -5.42182914e-04  9.99647201e-01]
  HOMO = -0.300797884075979  LUMO = 3.73135706402216
  mo_energy =
[-4.73105773e+00 -3.00797884e-01  3.73135706e+00  2.63352740e+01
  1.37700153e+02  8.99194721e+02  8.66894748e+03]
E1 = -19.053303446704184  E_coul = 4.494798082581053
cycle= 4 E= -14.5585053641231  delta_E= -9.57e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053303446704184  E_coul = 4.494798082581053
  HOMO = -0.300797774758358  LUMO = 3.73135787654248
  mo_energy =
[-4.73105587e+00 -3.00797775e-01  3.73135788e+00  2.63352766e+01
  1.37700157e+02  8.99194726e+02  8.66894748e+03]
E1 = -19.053303701121234  E_coul = 4.494798336997978
Extra cycle  E= -14.5585053641233  delta_E= -1.24e-13  |g|= 8.52e-08  |ddm|= 7.83e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.88863729423087
E1 = -19.053303701121234  E_coul = 4.494798336997978
init E= -14.5585053641233
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300797766832223  LUMO = 3.73135792830956
  mo_energy =
[-4.73105575e+00 -3.00797767e-01  3.73135793e+00  2.63352767e+01
  1.37700158e+02  8.99194726e+02  8.66894748e+03]
E1 = -19.0533037184152  E_coul = 4.494798354291949
cycle= 1 E= -14.5585053641233  delta_E= 3.55e-15  |g|= 6.29e-09  |ddm|= 5.84e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.0533037184152  E_coul = 4.494798354291949
  HOMO = -0.300797766234981  LUMO = 3.73135793178687
  mo_energy =
[-4.73105574e+00 -3.00797766e-01  3.73135793e+00  2.63352767e+01
  1.37700158e+02  8.99194726e+02  8.66894748e+03]
E1 = -19.053303719646586  E_coul = 4.494798355523324
Extra cycle  E= -14.5585053641233  delta_E= -8.88e-15  |g|= 4.96e-10  |ddm|= 4.56e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798685e+03 5.03797571e+02 7.58281683e+01 1.71788842e+01
 4.72107186e+00 1.42121716e+00 1.04562426e-01]
grad_E = [ 4.90770517e-08  9.21865825e-06 -3.39867682e-05  5.12374564e-05
 -2.67055124e-05  1.72535302e-04  1.01854390e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685126        1
[INPUT] 0    0    [1    /1   ]  503.79699822         1
[INPUT] 0    0    [1    /1   ]  75.8302565649        1
[INPUT] 0    0    [1    /1   ]  17.1762175893        1
[INPUT] 0    0    [1    /1   ]  4.71887600544        1
[INPUT] 0    0    [1    /1   ]  1.4210077927         1
[INPUT] 0    0    [1    /1   ]  0.104563561168       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.9868512643825, 1.0]], [0, [503.79699821985184, 1.0]], [0, [75.83025656492683, 1.0]], [0, [17.176217589311264, 1.0]], [0, [4.718876005436012, 1.0]], [0, [1.421007792697136, 1.0]], [0, [0.10456356116837445, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685126]
bas 1, expnt(s) = [503.79699822]
bas 2, expnt(s) = [75.83025656]
bas 3, expnt(s) = [17.17621759]
bas 4, expnt(s) = [4.71887601]
bas 5, expnt(s) = [1.42100779]
bas 6, expnt(s) = [0.10456356]
CPU time:        32.29
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798685e+03 1.51080285e+03 5.03796998e+02 2.68662286e+02
 7.58302566e+01 6.49227516e+01 1.71762176e+01 2.13162436e+01
 4.71887601e+00 8.08898348e+00 1.42100779e+00 3.28823138e+00
 1.04563561e-01 4.64569077e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873343845649836
cond(S) = 43.87911385692656
E1 = -19.06280640615004  E_coul = 4.528981183937207
init E= -14.5338252222128
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300696803214704  LUMO = 3.73477836845182
  mo_energy =
[-4.71380640e+00 -3.00696803e-01  3.73477837e+00  2.63451880e+01
  1.37711304e+02  8.99215556e+02  8.66897339e+03]
E1 = -19.056834469625358  E_coul = 4.498366464375227
cycle= 1 E= -14.5584680052501  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.014296
diis-c [-2.04376483e-04  1.00000000e+00]
  HOMO = -0.300645795589534  LUMO = 3.73060801955179
  mo_energy =
[-4.72942218e+00 -3.00645796e-01  3.73060802e+00  2.63281065e+01
  1.37687651e+02  8.99186153e+02  8.66894123e+03]
E1 = -19.053594888980797  E_coul = 4.495089640350466
cycle= 2 E= -14.5585052486303  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170614
diis-c [-7.66263412e-07 -1.14368654e-01  1.11436865e+00]
  HOMO = -0.300800594174588  LUMO = 3.72990374550565
  mo_energy =
[-4.73109491e+00 -3.00800594e-01  3.72990375e+00  2.63264325e+01
  1.37685671e+02  8.99183983e+02  8.66893899e+03]
E1 = -19.05332815606081  E_coul = 4.49482263925327
cycle= 3 E= -14.5585055168075  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.99979e-05
diis-c [-2.56785151e-10  8.98461107e-04 -5.89580768e-04  9.99691120e-01]
  HOMO = -0.300796862862011  LUMO = 3.72992668377785
  mo_energy =
[-4.73104306e+00 -3.00796863e-01  3.72992668e+00  2.63265005e+01
  1.37685776e+02  8.99184113e+02  8.66893913e+03]
E1 = -19.05333513243404  E_coul = 4.494829615530896
cycle= 4 E= -14.5585055169031  delta_E= -9.56e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05333513243404  E_coul = 4.494829615530896
  HOMO = -0.300796753501175  LUMO = 3.72992749567724
  mo_energy =
[-4.73104120e+00 -3.00796754e-01  3.72992750e+00  2.63265031e+01
  1.37685780e+02  8.99184118e+02  8.66893913e+03]
E1 = -19.053335386849817  E_coul = 4.494829869946549
Extra cycle  E= -14.5585055169033  delta_E= -1.24e-13  |g|= 8.52e-08  |ddm|= 7.84e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798685e+03 5.03796998e+02 7.58302566e+01 1.71762176e+01
 4.71887601e+00 1.42100779e+00 1.04563561e-01]
E = -14.558505516903267
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98685126        1
[INPUT] 0    0    [1    /1   ]  503.79699822         1
[INPUT] 0    0    [1    /1   ]  75.8302565649        1
[INPUT] 0    0    [1    /1   ]  17.1762175893        1
[INPUT] 0    0    [1    /1   ]  4.71887600544        1
[INPUT] 0    0    [1    /1   ]  1.4210077927         1
[INPUT] 0    0    [1    /1   ]  0.104563561168       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.9868512643825, 1.0]], [0, [503.79699821985184, 1.0]], [0, [75.83025656492683, 1.0]], [0, [17.176217589311264, 1.0]], [0, [4.718876005436012, 1.0]], [0, [1.421007792697136, 1.0]], [0, [0.10456356116837445, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98685126]
bas 1, expnt(s) = [503.79699822]
bas 2, expnt(s) = [75.83025656]
bas 3, expnt(s) = [17.17621759]
bas 4, expnt(s) = [4.71887601]
bas 5, expnt(s) = [1.42100779]
bas 6, expnt(s) = [0.10456356]
CPU time:        32.57
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798685e+03 1.51080285e+03 5.03796998e+02 2.68662286e+02
 7.58302566e+01 6.49227516e+01 1.71762176e+01 2.13162436e+01
 4.71887601e+00 8.08898348e+00 1.42100779e+00 3.28823138e+00
 1.04563561e-01 4.64569077e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873343845649836
cond(S) = 43.87911385692656
E1 = -19.06280640615004  E_coul = 4.528981183937207
init E= -14.5338252222128
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300696803214704  LUMO = 3.73477836845182
  mo_energy =
[-4.71380640e+00 -3.00696803e-01  3.73477837e+00  2.63451880e+01
  1.37711304e+02  8.99215556e+02  8.66897339e+03]
E1 = -19.056834469625358  E_coul = 4.498366464375227
cycle= 1 E= -14.5584680052501  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.014296
diis-c [-2.04376483e-04  1.00000000e+00]
  HOMO = -0.300645795589534  LUMO = 3.73060801955179
  mo_energy =
[-4.72942218e+00 -3.00645796e-01  3.73060802e+00  2.63281065e+01
  1.37687651e+02  8.99186153e+02  8.66894123e+03]
E1 = -19.053594888980797  E_coul = 4.495089640350466
cycle= 2 E= -14.5585052486303  delta_E= -3.72e-05  |g|= 0.00146  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170614
diis-c [-7.66263412e-07 -1.14368654e-01  1.11436865e+00]
  HOMO = -0.300800594174588  LUMO = 3.72990374550565
  mo_energy =
[-4.73109491e+00 -3.00800594e-01  3.72990375e+00  2.63264325e+01
  1.37685671e+02  8.99183983e+02  8.66893899e+03]
E1 = -19.05332815606081  E_coul = 4.49482263925327
cycle= 3 E= -14.5585055168075  delta_E= -2.68e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.99979e-05
diis-c [-2.56785151e-10  8.98461107e-04 -5.89580768e-04  9.99691120e-01]
  HOMO = -0.300796862862011  LUMO = 3.72992668377785
  mo_energy =
[-4.73104306e+00 -3.00796863e-01  3.72992668e+00  2.63265005e+01
  1.37685776e+02  8.99184113e+02  8.66893913e+03]
E1 = -19.05333513243404  E_coul = 4.494829615530896
cycle= 4 E= -14.5585055169031  delta_E= -9.56e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05333513243404  E_coul = 4.494829615530896
  HOMO = -0.300796753501175  LUMO = 3.72992749567724
  mo_energy =
[-4.73104120e+00 -3.00796754e-01  3.72992750e+00  2.63265031e+01
  1.37685780e+02  8.99184118e+02  8.66893913e+03]
E1 = -19.053335386849817  E_coul = 4.494829869946549
Extra cycle  E= -14.5585055169033  delta_E= -1.24e-13  |g|= 8.52e-08  |ddm|= 7.84e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.87911385692656
E1 = -19.053335386849817  E_coul = 4.494829869946549
init E= -14.5585055169033
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300796745566906  LUMO = 3.7299275474214
  mo_energy =
[-4.73104108e+00 -3.00796746e-01  3.72992755e+00  2.63265033e+01
  1.37685780e+02  8.99184118e+02  8.66893913e+03]
E1 = -19.0533354041517  E_coul = 4.4948298872484225
cycle= 1 E= -14.5585055169033  delta_E= -1.07e-14  |g|= 6.3e-09  |ddm|= 5.85e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.0533354041517  E_coul = 4.4948298872484225
  HOMO = -0.300796744968692  LUMO = 3.7299275508988
  mo_energy =
[-4.73104107e+00 -3.00796745e-01  3.72992755e+00  2.63265033e+01
  1.37685780e+02  8.99184118e+02  8.66893913e+03]
E1 = -19.053335405384313  E_coul = 4.494829888481046
Extra cycle  E= -14.5585055169033  delta_E= 1.07e-14  |g|= 4.97e-10  |ddm|= 4.57e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798685e+03 5.03796998e+02 7.58302566e+01 1.71762176e+01
 4.71887601e+00 1.42100779e+00 1.04563561e-01]
grad_E = [ 4.90688415e-08  9.22108381e-06 -3.42792101e-05  5.94011046e-05
 -8.21492266e-05  2.89463769e-04  1.78297317e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98684302        1
[INPUT] 0    0    [1    /1   ]  503.795449826        1
[INPUT] 0    0    [1    /1   ]  75.8359378514        1
[INPUT] 0    0    [1    /1   ]  17.1685348653        1
[INPUT] 0    0    [1    /1   ]  4.71452147603        1
[INPUT] 0    0    [1    /1   ]  1.42047855294        1
[INPUT] 0    0    [1    /1   ]  0.104565093818       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986843019762, 1.0]], [0, [503.79544982614556, 1.0]], [0, [75.8359378514342, 1.0]], [0, [17.168534865304505, 1.0]], [0, [4.714521476033576, 1.0]], [0, [1.4204785529424062, 1.0]], [0, [0.10456509381832578, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98684302]
bas 1, expnt(s) = [503.79544983]
bas 2, expnt(s) = [75.83593785]
bas 3, expnt(s) = [17.16853487]
bas 4, expnt(s) = [4.71452148]
bas 5, expnt(s) = [1.42047855]
bas 6, expnt(s) = [0.10456509]
CPU time:        34.65
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798684e+03 1.51080285e+03 5.03795450e+02 2.68661667e+02
 7.58359379e+01 6.49263997e+01 1.71685349e+01 2.13090923e+01
 4.71452148e+00 8.08338451e+00 1.42047855e+00 3.28731283e+00
 1.04565094e-01 4.64574184e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873360338014487
cond(S) = 43.86046907537996
E1 = -19.06285574543312  E_coul = 4.529015875359793
init E= -14.5338398700733
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300694186977833  LUMO = 3.73167521296537
  mo_energy =
[-4.71379184e+00 -3.00694187e-01  3.73167521e+00  2.63254486e+01
  1.37676875e+02  8.99190470e+02  8.66895348e+03]
E1 = -19.056876844599497  E_coul = 4.498408501569456
cycle= 1 E= -14.55846834303  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142904
diis-c [-2.04215057e-04  1.00000000e+00]
  HOMO = -0.300644162447413  LUMO = 3.72751118756552
  mo_energy =
[-4.72940297e+00 -3.00644162e-01  3.72751119e+00  2.63083813e+01
  1.37653229e+02  8.99161079e+02  8.66892133e+03]
E1 = -19.053635983550926  E_coul = 4.49513036858924
cycle= 2 E= -14.5585056149617  delta_E= -3.73e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170652
diis-c [-7.67150816e-07 -1.14432020e-01  1.11443202e+00]
  HOMO = -0.300799131596752  LUMO = 3.72680691665671
  mo_energy =
[-4.73107637e+00 -3.00799132e-01  3.72680692e+00  2.63067076e+01
  1.37651249e+02  8.99158910e+02  8.66891910e+03]
E1 = -19.053368938917586  E_coul = 4.494863055200065
cycle= 3 E= -14.5585058837175  delta_E= -2.69e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.99867e-05
diis-c [-2.56728175e-10  9.04517009e-04 -6.54859799e-04  9.99750343e-01]
  HOMO = -0.300795396426111  LUMO = 3.72682984867525
  mo_energy =
[-4.73102450e+00 -3.00795396e-01  3.72682985e+00  2.63067757e+01
  1.37651355e+02  8.99159040e+02  8.66891923e+03]
E1 = -19.053375920538283  E_coul = 4.494870036725049
cycle= 4 E= -14.5585058838132  delta_E= -9.57e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053375920538283  E_coul = 4.494870036725049
  HOMO = -0.300795286947788  LUMO = 3.72683065990254
  mo_energy =
[-4.73102264e+00 -3.00795287e-01  3.72683066e+00  2.63067783e+01
  1.37651358e+02  8.99159045e+02  8.66891924e+03]
E1 = -19.053376175111566  E_coul = 4.494870291298204
Extra cycle  E= -14.5585058838134  delta_E= -1.3e-13  |g|= 8.52e-08  |ddm|= 7.85e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798684e+03 5.03795450e+02 7.58359379e+01 1.71685349e+01
 4.71452148e+00 1.42047855e+00 1.04565094e-01]
E = -14.558505883813362
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98684302        1
[INPUT] 0    0    [1    /1   ]  503.795449826        1
[INPUT] 0    0    [1    /1   ]  75.8359378514        1
[INPUT] 0    0    [1    /1   ]  17.1685348653        1
[INPUT] 0    0    [1    /1   ]  4.71452147603        1
[INPUT] 0    0    [1    /1   ]  1.42047855294        1
[INPUT] 0    0    [1    /1   ]  0.104565093818       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986843019762, 1.0]], [0, [503.79544982614556, 1.0]], [0, [75.8359378514342, 1.0]], [0, [17.168534865304505, 1.0]], [0, [4.714521476033576, 1.0]], [0, [1.4204785529424062, 1.0]], [0, [0.10456509381832578, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98684302]
bas 1, expnt(s) = [503.79544983]
bas 2, expnt(s) = [75.83593785]
bas 3, expnt(s) = [17.16853487]
bas 4, expnt(s) = [4.71452148]
bas 5, expnt(s) = [1.42047855]
bas 6, expnt(s) = [0.10456509]
CPU time:        34.95
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798684e+03 1.51080285e+03 5.03795450e+02 2.68661667e+02
 7.58359379e+01 6.49263997e+01 1.71685349e+01 2.13090923e+01
 4.71452148e+00 8.08338451e+00 1.42047855e+00 3.28731283e+00
 1.04565094e-01 4.64574184e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873360338014487
cond(S) = 43.86046907537996
E1 = -19.06285574543312  E_coul = 4.529015875359793
init E= -14.5338398700733
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300694186977833  LUMO = 3.73167521296537
  mo_energy =
[-4.71379184e+00 -3.00694187e-01  3.73167521e+00  2.63254486e+01
  1.37676875e+02  8.99190470e+02  8.66895348e+03]
E1 = -19.056876844599497  E_coul = 4.498408501569456
cycle= 1 E= -14.55846834303  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142904
diis-c [-2.04215057e-04  1.00000000e+00]
  HOMO = -0.300644162447413  LUMO = 3.72751118756552
  mo_energy =
[-4.72940297e+00 -3.00644162e-01  3.72751119e+00  2.63083813e+01
  1.37653229e+02  8.99161079e+02  8.66892133e+03]
E1 = -19.053635983550926  E_coul = 4.49513036858924
cycle= 2 E= -14.5585056149617  delta_E= -3.73e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170652
diis-c [-7.67150816e-07 -1.14432020e-01  1.11443202e+00]
  HOMO = -0.300799131596752  LUMO = 3.72680691665671
  mo_energy =
[-4.73107637e+00 -3.00799132e-01  3.72680692e+00  2.63067076e+01
  1.37651249e+02  8.99158910e+02  8.66891910e+03]
E1 = -19.053368938917586  E_coul = 4.494863055200065
cycle= 3 E= -14.5585058837175  delta_E= -2.69e-07  |g|= 3.07e-05  |ddm|= 0.00121
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.99867e-05
diis-c [-2.56728175e-10  9.04517009e-04 -6.54859799e-04  9.99750343e-01]
  HOMO = -0.300795396426111  LUMO = 3.72682984867525
  mo_energy =
[-4.73102450e+00 -3.00795396e-01  3.72682985e+00  2.63067757e+01
  1.37651355e+02  8.99159040e+02  8.66891923e+03]
E1 = -19.053375920538283  E_coul = 4.494870036725049
cycle= 4 E= -14.5585058838132  delta_E= -9.57e-11  |g|= 1.2e-06  |ddm|= 2.39e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053375920538283  E_coul = 4.494870036725049
  HOMO = -0.300795286947788  LUMO = 3.72683065990254
  mo_energy =
[-4.73102264e+00 -3.00795287e-01  3.72683066e+00  2.63067783e+01
  1.37651358e+02  8.99159045e+02  8.66891924e+03]
E1 = -19.053376175111566  E_coul = 4.494870291298204
Extra cycle  E= -14.5585058838134  delta_E= -1.3e-13  |g|= 8.52e-08  |ddm|= 7.85e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.86046907537996
E1 = -19.053376175111566  E_coul = 4.494870291298204
init E= -14.5585058838134
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300795278995974  LUMO = 3.72683071163986
  mo_energy =
[-4.73102252e+00 -3.00795279e-01  3.72683071e+00  2.63067784e+01
  1.37651359e+02  8.99159045e+02  8.66891924e+03]
E1 = -19.053376192439398  E_coul = 4.4948703086260275
cycle= 1 E= -14.5585058838134  delta_E= -8.88e-15  |g|= 6.31e-09  |ddm|= 5.87e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053376192439398  E_coul = 4.4948703086260275
  HOMO = -0.300795278395812  LUMO = 3.72683071511997
  mo_energy =
[-4.73102251e+00 -3.00795278e-01  3.72683072e+00  2.63067784e+01
  1.37651359e+02  8.99159045e+02  8.66891924e+03]
E1 = -19.053376193675135  E_coul = 4.494870309861785
Extra cycle  E= -14.5585058838133  delta_E= 2.13e-14  |g|= 4.99e-10  |ddm|= 4.59e-09
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [5.03798684e+03 5.03795450e+02 7.58359379e+01 1.71685349e+01
 4.71452148e+00 1.42047855e+00 1.04565094e-01]
grad_E = [ 4.91252141e-08  9.21110300e-06 -3.42350956e-05  6.90547155e-05
 -1.62106012e-04  4.53735784e-04  2.86156428e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98682356        1
[INPUT] 0    0    [1    /1   ]  503.791793671        1
[INPUT] 0    0    [1    /1   ]  75.8494001726        1
[INPUT] 0    0    [1    /1   ]  17.1497565169        1
[INPUT] 0    0    [1    /1   ]  4.70638761487        1
[INPUT] 0    0    [1    /1   ]  1.41928064536        1
[INPUT] 0    0    [1    /1   ]  0.104566626979       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986823563094, 1.0]], [0, [503.79179367100284, 1.0]], [0, [75.8494001725755, 1.0]], [0, [17.149756516896254, 1.0]], [0, [4.706387614872715, 1.0]], [0, [1.4192806453625832, 1.0]], [0, [0.10456662697895702, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98682356]
bas 1, expnt(s) = [503.79179367]
bas 2, expnt(s) = [75.84940017]
bas 3, expnt(s) = [17.14975652]
bas 4, expnt(s) = [4.70638761]
bas 5, expnt(s) = [1.41928065]
bas 6, expnt(s) = [0.10456663]
CPU time:        37.13
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798682e+03 1.51080285e+03 5.03791794e+02 2.68660204e+02
 7.58494002e+01 6.49350437e+01 1.71497565e+01 2.12916095e+01
 4.70638761e+00 8.07292269e+00 1.41928065e+00 3.28523344e+00
 1.04566627e-01 4.64579293e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873391481770097
cond(S) = 43.82621432134019
E1 = -19.06293296237788  E_coul = 4.529075876638491
init E= -14.5338570857394
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300688879692772  LUMO = 3.7254131286292
  mo_energy =
[-4.71376738e+00 -3.00688880e-01  3.72541313e+00  2.62843055e+01
  1.37601662e+02  8.99136199e+02  8.66891019e+03]
E1 = -19.056918435782485  E_coul = 4.498449370937703
cycle= 1 E= -14.5584690648448  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142791
diis-c [-2.03892844e-04  1.00000000e+00]
  HOMO = -0.300642071433144  LUMO = 3.72125128474547
  mo_energy =
[-4.72938502e+00 -3.00642071e-01  3.72125128e+00  2.62672431e+01
  1.37578005e+02  8.99106797e+02  8.66887802e+03]
E1 = -19.05367255957914  E_coul = 4.495166155721052
cycle= 2 E= -14.5585064038581  delta_E= -3.73e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170755
diis-c [-7.68792502e-07 -1.14589557e-01  1.11458956e+00]
  HOMO = -0.300797437204616  LUMO = 3.72054628780568
  mo_energy =
[-4.73106111e+00 -3.00797437e-01  3.72054629e+00  2.62655678e+01
  1.37576022e+02  8.99104624e+02  8.66887578e+03]
E1 = -19.053404680283425  E_coul = 4.49489800652409
cycle= 3 E= -14.5585066737593  delta_E= -2.7e-07  |g|= 3.07e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00069e-05
diis-c [-2.56863723e-10  9.14308967e-04 -7.22605846e-04  9.99808297e-01]
  HOMO = -0.300793687493983  LUMO = 3.7205692516681
  mo_energy =
[-4.73100912e+00 -3.00793687e-01  3.72056925e+00  2.62656360e+01
  1.37576128e+02  8.99104755e+02  8.66887592e+03]
E1 = -19.05341168732033  E_coul = 4.494905013464662
cycle= 4 E= -14.5585066738557  delta_E= -9.63e-11  |g|= 1.2e-06  |ddm|= 2.4e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05341168732033  E_coul = 4.494905013464662
  HOMO = -0.300793577737219  LUMO = 3.72057006266673
  mo_energy =
[-4.73100725e+00 -3.00793578e-01  3.72057006e+00  2.62656385e+01
  1.37576132e+02  8.99104759e+02  8.66887593e+03]
E1 = -19.0534119424836  E_coul = 4.494905268627808
Extra cycle  E= -14.5585066738558  delta_E= -1.24e-13  |g|= 8.53e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798682e+03 5.03791794e+02 7.58494002e+01 1.71497565e+01
 4.70638761e+00 1.41928065e+00 1.04566627e-01]
E = -14.558506673855792
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98682356        1
[INPUT] 0    0    [1    /1   ]  503.791793671        1
[INPUT] 0    0    [1    /1   ]  75.8494001726        1
[INPUT] 0    0    [1    /1   ]  17.1497565169        1
[INPUT] 0    0    [1    /1   ]  4.70638761487        1
[INPUT] 0    0    [1    /1   ]  1.41928064536        1
[INPUT] 0    0    [1    /1   ]  0.104566626979       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986823563094, 1.0]], [0, [503.79179367100284, 1.0]], [0, [75.8494001725755, 1.0]], [0, [17.149756516896254, 1.0]], [0, [4.706387614872715, 1.0]], [0, [1.4192806453625832, 1.0]], [0, [0.10456662697895702, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98682356]
bas 1, expnt(s) = [503.79179367]
bas 2, expnt(s) = [75.84940017]
bas 3, expnt(s) = [17.14975652]
bas 4, expnt(s) = [4.70638761]
bas 5, expnt(s) = [1.41928065]
bas 6, expnt(s) = [0.10456663]
CPU time:        37.45
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798682e+03 1.51080285e+03 5.03791794e+02 2.68660204e+02
 7.58494002e+01 6.49350437e+01 1.71497565e+01 2.12916095e+01
 4.70638761e+00 8.07292269e+00 1.41928065e+00 3.28523344e+00
 1.04566627e-01 4.64579293e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873391481770097
cond(S) = 43.82621432134019
E1 = -19.06293296237788  E_coul = 4.529075876638491
init E= -14.5338570857394
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300688879692772  LUMO = 3.7254131286292
  mo_energy =
[-4.71376738e+00 -3.00688880e-01  3.72541313e+00  2.62843055e+01
  1.37601662e+02  8.99136199e+02  8.66891019e+03]
E1 = -19.056918435782485  E_coul = 4.498449370937703
cycle= 1 E= -14.5584690648448  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.239
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142791
diis-c [-2.03892844e-04  1.00000000e+00]
  HOMO = -0.300642071433144  LUMO = 3.72125128474547
  mo_energy =
[-4.72938502e+00 -3.00642071e-01  3.72125128e+00  2.62672431e+01
  1.37578005e+02  8.99106797e+02  8.66887802e+03]
E1 = -19.05367255957914  E_coul = 4.495166155721052
cycle= 2 E= -14.5585064038581  delta_E= -3.73e-05  |g|= 0.00147  |ddm|= 0.0139
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170755
diis-c [-7.68792502e-07 -1.14589557e-01  1.11458956e+00]
  HOMO = -0.300797437204616  LUMO = 3.72054628780568
  mo_energy =
[-4.73106111e+00 -3.00797437e-01  3.72054629e+00  2.62655678e+01
  1.37576022e+02  8.99104624e+02  8.66887578e+03]
E1 = -19.053404680283425  E_coul = 4.49489800652409
cycle= 3 E= -14.5585066737593  delta_E= -2.7e-07  |g|= 3.07e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.00069e-05
diis-c [-2.56863723e-10  9.14308967e-04 -7.22605846e-04  9.99808297e-01]
  HOMO = -0.300793687493983  LUMO = 3.7205692516681
  mo_energy =
[-4.73100912e+00 -3.00793687e-01  3.72056925e+00  2.62656360e+01
  1.37576128e+02  8.99104755e+02  8.66887592e+03]
E1 = -19.05341168732033  E_coul = 4.494905013464662
cycle= 4 E= -14.5585066738557  delta_E= -9.63e-11  |g|= 1.2e-06  |ddm|= 2.4e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05341168732033  E_coul = 4.494905013464662
  HOMO = -0.300793577737219  LUMO = 3.72057006266673
  mo_energy =
[-4.73100725e+00 -3.00793578e-01  3.72057006e+00  2.62656385e+01
  1.37576132e+02  8.99104759e+02  8.66887593e+03]
E1 = -19.0534119424836  E_coul = 4.494905268627808
Extra cycle  E= -14.5585066738558  delta_E= -1.24e-13  |g|= 8.53e-08  |ddm|= 7.88e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.82621432134019
E1 = -19.0534119424836  E_coul = 4.494905268627808
init E= -14.5585066738558
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300793569749936  LUMO = 3.72057011446253
  mo_energy =
[-4.73100713e+00 -3.00793570e-01  3.72057011e+00  2.62656387e+01
  1.37576132e+02  8.99104760e+02  8.66887593e+03]
E1 = -19.05341195987907  E_coul = 4.494905286023284
cycle= 1 E= -14.5585066738558  delta_E= 5.33e-15  |g|= 6.33e-09  |ddm|= 5.9e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.05341195987907  E_coul = 4.494905286023284
  HOMO = -0.300793569146066  LUMO = 3.72057011795236
  mo_energy =
[-4.73100712e+00 -3.00793569e-01  3.72057012e+00  2.62656387e+01
  1.37576132e+02  8.99104760e+02  8.66887593e+03]
E1 = -19.0534119611219  E_coul = 4.494905287266107
Extra cycle  E= -14.5585066738558  delta_E= -5.33e-15  |g|= 5.02e-10  |ddm|= 4.63e-09
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [5.03798682e+03 5.03791794e+02 7.58494002e+01 1.71497565e+01
 4.70638761e+00 1.41928065e+00 1.04566627e-01]
grad_E = [ 4.93653630e-08  9.16504095e-06 -3.29941283e-05  7.49864607e-05
 -2.56212049e-04  6.36480997e-04  4.07340841e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98678851        1
[INPUT] 0    0    [1    /1   ]  503.785203605        1
[INPUT] 0    0    [1    /1   ]  75.8737233592        1
[INPUT] 0    0    [1    /1   ]  17.115109391         1
[INPUT] 0    0    [1    /1   ]  4.69446606982        1
[INPUT] 0    0    [1    /1   ]  1.41718355795        1
[INPUT] 0    0    [1    /1   ]  0.104566711858       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986788506476, 1.0]], [0, [503.78520360463904, 1.0]], [0, [75.873723359156, 1.0]], [0, [17.11510939101597, 1.0]], [0, [4.6944660698184855, 1.0]], [0, [1.417183557946288, 1.0]], [0, [0.10456671185785352, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98678851]
bas 1, expnt(s) = [503.7852036]
bas 2, expnt(s) = [75.87372336]
bas 3, expnt(s) = [17.11510939]
bas 4, expnt(s) = [4.69446607]
bas 5, expnt(s) = [1.41718356]
bas 6, expnt(s) = [0.10456671]
CPU time:        39.58
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798679e+03 1.51080284e+03 5.03785204e+02 2.68657569e+02
 7.58737234e+01 6.49506605e+01 1.71151094e+01 2.12593403e+01
 4.69446607e+00 8.05758095e+00 1.41718356e+00 3.28159214e+00
 1.04566712e-01 4.64579576e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873437855497995
cond(S) = 43.776934802160824
E1 = -19.063022462913064  E_coul = 4.5291562572519135
init E= -14.5338662056612
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300680406745844  LUMO = 3.71547946205766
  mo_energy =
[-4.71373587e+00 -3.00680407e-01  3.71547946e+00  2.62171143e+01
  1.37473839e+02  8.99044744e+02  8.66883690e+03]
E1 = -19.056918799244087  E_coul = 4.498448568334342
cycle= 1 E= -14.5584702309097  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142612
diis-c [-2.03381371e-04  1.00000000e+00]
  HOMO = -0.30064055970295  LUMO = 3.71130526797563
  mo_energy =
[-4.72938757e+00 -3.00640560e-01  3.71130527e+00  2.62000241e+01
  1.37450126e+02  8.99015268e+02  8.66880467e+03]
E1 = -19.053661301363046  E_coul = 4.495153611009459
cycle= 2 E= -14.5585076903536  delta_E= -3.75e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170957
diis-c [-7.71155110e-07 -1.14885854e-01  1.11488585e+00]
  HOMO = -0.30079663533542  LUMO = 3.71059801872649
  mo_energy =
[-4.73107000e+00 -3.00796635e-01  3.71059802e+00  2.61983428e+01
  1.37448135e+02  8.99013086e+02  8.66880242e+03]
E1 = -19.053391783971804  E_coul = 4.494883821929485
cycle= 3 E= -14.5585079620423  delta_E= -2.72e-07  |g|= 3.09e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.01025e-05
diis-c [-2.57417515e-10  9.26111485e-04 -7.32373954e-04  9.99806262e-01]
  HOMO = -0.30079285207167  LUMO = 3.71062110107342
  mo_energy =
[-4.73101766e+00 -3.00792852e-01  3.71062110e+00  2.61984112e+01
  1.37448241e+02  8.99013217e+02  8.66880256e+03]
E1 = -19.053398854268575  E_coul = 4.494890892128307
cycle= 4 E= -14.5585079621403  delta_E= -9.79e-11  |g|= 1.2e-06  |ddm|= 2.43e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053398854268575  E_coul = 4.494890892128307
  HOMO = -0.300792741800032  LUMO = 3.71062191344937
  mo_energy =
[-4.73101579e+00 -3.00792742e-01  3.71062191e+00  2.61984138e+01
  1.37448245e+02  8.99013222e+02  8.66880256e+03]
E1 = -19.053399110798697  E_coul = 4.494891148658304
Extra cycle  E= -14.5585079621404  delta_E= -1.24e-13  |g|= 8.56e-08  |ddm|= 7.93e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798679e+03 5.03785204e+02 7.58737234e+01 1.71151094e+01
 4.69446607e+00 1.41718356e+00 1.04566712e-01]
E = -14.558507962140393
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98678851        1
[INPUT] 0    0    [1    /1   ]  503.785203605        1
[INPUT] 0    0    [1    /1   ]  75.8737233592        1
[INPUT] 0    0    [1    /1   ]  17.115109391         1
[INPUT] 0    0    [1    /1   ]  4.69446606982        1
[INPUT] 0    0    [1    /1   ]  1.41718355795        1
[INPUT] 0    0    [1    /1   ]  0.104566711858       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986788506476, 1.0]], [0, [503.78520360463904, 1.0]], [0, [75.873723359156, 1.0]], [0, [17.11510939101597, 1.0]], [0, [4.6944660698184855, 1.0]], [0, [1.417183557946288, 1.0]], [0, [0.10456671185785352, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98678851]
bas 1, expnt(s) = [503.7852036]
bas 2, expnt(s) = [75.87372336]
bas 3, expnt(s) = [17.11510939]
bas 4, expnt(s) = [4.69446607]
bas 5, expnt(s) = [1.41718356]
bas 6, expnt(s) = [0.10456671]
CPU time:        39.92
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798679e+03 1.51080284e+03 5.03785204e+02 2.68657569e+02
 7.58737234e+01 6.49506605e+01 1.71151094e+01 2.12593403e+01
 4.69446607e+00 8.05758095e+00 1.41718356e+00 3.28159214e+00
 1.04566712e-01 4.64579576e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873437855497995
cond(S) = 43.776934802160824
E1 = -19.063022462913064  E_coul = 4.5291562572519135
init E= -14.5338662056612
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300680406745844  LUMO = 3.71547946205766
  mo_energy =
[-4.71373587e+00 -3.00680407e-01  3.71547946e+00  2.62171143e+01
  1.37473839e+02  8.99044744e+02  8.66883690e+03]
E1 = -19.056918799244087  E_coul = 4.498448568334342
cycle= 1 E= -14.5584702309097  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142612
diis-c [-2.03381371e-04  1.00000000e+00]
  HOMO = -0.30064055970295  LUMO = 3.71130526797563
  mo_energy =
[-4.72938757e+00 -3.00640560e-01  3.71130527e+00  2.62000241e+01
  1.37450126e+02  8.99015268e+02  8.66880467e+03]
E1 = -19.053661301363046  E_coul = 4.495153611009459
cycle= 2 E= -14.5585076903536  delta_E= -3.75e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00170957
diis-c [-7.71155110e-07 -1.14885854e-01  1.11488585e+00]
  HOMO = -0.30079663533542  LUMO = 3.71059801872649
  mo_energy =
[-4.73107000e+00 -3.00796635e-01  3.71059802e+00  2.61983428e+01
  1.37448135e+02  8.99013086e+02  8.66880242e+03]
E1 = -19.053391783971804  E_coul = 4.494883821929485
cycle= 3 E= -14.5585079620423  delta_E= -2.72e-07  |g|= 3.09e-05  |ddm|= 0.00122
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.01025e-05
diis-c [-2.57417515e-10  9.26111485e-04 -7.32373954e-04  9.99806262e-01]
  HOMO = -0.30079285207167  LUMO = 3.71062110107342
  mo_energy =
[-4.73101766e+00 -3.00792852e-01  3.71062110e+00  2.61984112e+01
  1.37448241e+02  8.99013217e+02  8.66880256e+03]
E1 = -19.053398854268575  E_coul = 4.494890892128307
cycle= 4 E= -14.5585079621403  delta_E= -9.79e-11  |g|= 1.2e-06  |ddm|= 2.43e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053398854268575  E_coul = 4.494890892128307
  HOMO = -0.300792741800032  LUMO = 3.71062191344937
  mo_energy =
[-4.73101579e+00 -3.00792742e-01  3.71062191e+00  2.61984138e+01
  1.37448245e+02  8.99013222e+02  8.66880256e+03]
E1 = -19.053399110798697  E_coul = 4.494891148658304
Extra cycle  E= -14.5585079621404  delta_E= -1.24e-13  |g|= 8.56e-08  |ddm|= 7.93e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.776934802160824
E1 = -19.053399110798697  E_coul = 4.494891148658304
init E= -14.5585079621404
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300792733755436  LUMO = 3.71062196545028
  mo_energy =
[-4.73101567e+00 -3.00792734e-01  3.71062197e+00  2.61984140e+01
  1.37448245e+02  8.99013222e+02  8.66880257e+03]
E1 = -19.053399128326333  E_coul = 4.494891166185934
cycle= 1 E= -14.5585079621404  delta_E= -7.11e-15  |g|= 6.38e-09  |ddm|= 5.95e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053399128326333  E_coul = 4.494891166185934
  HOMO = -0.300792733145934  LUMO = 3.71062196896236
  mo_energy =
[-4.73101566e+00 -3.00792733e-01  3.71062197e+00  2.61984140e+01
  1.37448245e+02  8.99013222e+02  8.66880257e+03]
E1 = -19.053399129581468  E_coul = 4.494891167441064
Extra cycle  E= -14.5585079621404  delta_E= -3.55e-15  |g|= 5.07e-10  |ddm|= 4.67e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798679e+03 5.03785204e+02 7.58737234e+01 1.71151094e+01
 4.69446607e+00 1.41718356e+00 1.04566712e-01]
grad_E = [ 4.99366428e-08  9.05312479e-06 -2.92854964e-05  6.38825339e-05
 -3.04324234e-04  7.03911469e-04  4.54951704e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98675136        1
[INPUT] 0    0    [1    /1   ]  503.778218812        1
[INPUT] 0    0    [1    /1   ]  75.8995603059        1
[INPUT] 0    0    [1    /1   ]  17.0775599321        1
[INPUT] 0    0    [1    /1   ]  4.68475408094        1
[INPUT] 0    0    [1    /1   ]  1.41499994801        1
[INPUT] 0    0    [1    /1   ]  0.104563864075       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986751362545, 1.0]], [0, [503.77821881212566, 1.0]], [0, [75.89956030587527, 1.0]], [0, [17.077559932111733, 1.0]], [0, [4.684754080942192, 1.0]], [0, [1.4149999480118245, 1.0]], [0, [0.10456386407515714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98675136]
bas 1, expnt(s) = [503.77821881]
bas 2, expnt(s) = [75.89956031]
bas 3, expnt(s) = [17.07755993]
bas 4, expnt(s) = [4.68475408]
bas 5, expnt(s) = [1.41499995]
bas 6, expnt(s) = [0.10456386]
CPU time:        41.95
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798675e+03 1.51080283e+03 5.03778219e+02 2.68654775e+02
 7.58995603e+01 6.49672478e+01 1.70775599e+01 2.12243495e+01
 4.68475408e+00 8.04507548e+00 1.41499995e+00 3.27779918e+00
 1.04563864e-01 4.64570086e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873476536797847
cond(S) = 43.73700579219945
E1 = -19.063062415953024  E_coul = 4.529211694923613
init E= -14.5338507210294
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300672504523697  LUMO = 3.70633366364136
  mo_energy =
[-4.71371602e+00 -3.00672505e-01  3.70633366e+00  2.61532552e+01
  1.37346582e+02  8.98954600e+02  8.66876431e+03]
E1 = -19.056836498841626  E_coul = 4.4983651754782645
cycle= 1 E= -14.5584713233634  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142451
diis-c [-2.02922457e-04  1.00000000e+00]
  HOMO = -0.3006414209409  LUMO = 3.70212828310074
  mo_energy =
[-4.72942901e+00 -3.00641421e-01  3.70212828e+00  2.61360943e+01
  1.37322769e+02  8.98924987e+02  8.66873194e+03]
E1 = -19.05356367361974  E_coul = 4.495054761781261
cycle= 2 E= -14.5585089118385  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171191
diis-c [-7.73228183e-07 -1.15208646e-01  1.11520865e+00]
  HOMO = -0.300798251462732  LUMO = 3.70141758157531
  mo_energy =
[-4.73111984e+00 -3.00798251e-01  3.70141758e+00  2.61344031e+01
  1.37320765e+02  8.98922790e+02  8.66872968e+03]
E1 = -19.053292253115192  E_coul = 4.494783067977232
cycle= 3 E= -14.558509185138  delta_E= -2.73e-07  |g|= 3.12e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02653e-05
diis-c [-2.58395279e-10  9.31821721e-04 -6.22875781e-04  9.99691054e-01]
  HOMO = -0.300794425157676  LUMO = 3.70144085396643
  mo_energy =
[-4.73106705e+00 -3.00794425e-01  3.70144085e+00  2.61344720e+01
  1.37320872e+02  8.98922922e+02  8.66872982e+03]
E1 = -19.053299408880417  E_coul = 4.4947902236422275
cycle= 4 E= -14.5585091852382  delta_E= -1e-10  |g|= 1.21e-06  |ddm|= 2.46e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053299408880417  E_coul = 4.4947902236422275
  HOMO = -0.300794314293271  LUMO = 3.70144166994077
  mo_energy =
[-4.73106517e+00 -3.00794314e-01  3.70144167e+00  2.61344746e+01
  1.37320876e+02  8.98922927e+02  8.66872982e+03]
E1 = -19.05329966726109  E_coul = 4.494790482022775
Extra cycle  E= -14.5585091852383  delta_E= -1.24e-13  |g|= 8.63e-08  |ddm|= 7.98e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798675e+03 5.03778219e+02 7.58995603e+01 1.70775599e+01
 4.68475408e+00 1.41499995e+00 1.04563864e-01]
E = -14.558509185238314
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98675136        1
[INPUT] 0    0    [1    /1   ]  503.778218812        1
[INPUT] 0    0    [1    /1   ]  75.8995603059        1
[INPUT] 0    0    [1    /1   ]  17.0775599321        1
[INPUT] 0    0    [1    /1   ]  4.68475408094        1
[INPUT] 0    0    [1    /1   ]  1.41499994801        1
[INPUT] 0    0    [1    /1   ]  0.104563864075       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986751362545, 1.0]], [0, [503.77821881212566, 1.0]], [0, [75.89956030587527, 1.0]], [0, [17.077559932111733, 1.0]], [0, [4.684754080942192, 1.0]], [0, [1.4149999480118245, 1.0]], [0, [0.10456386407515714, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98675136]
bas 1, expnt(s) = [503.77821881]
bas 2, expnt(s) = [75.89956031]
bas 3, expnt(s) = [17.07755993]
bas 4, expnt(s) = [4.68475408]
bas 5, expnt(s) = [1.41499995]
bas 6, expnt(s) = [0.10456386]
CPU time:        42.29
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798675e+03 1.51080283e+03 5.03778219e+02 2.68654775e+02
 7.58995603e+01 6.49672478e+01 1.70775599e+01 2.12243495e+01
 4.68475408e+00 8.04507548e+00 1.41499995e+00 3.27779918e+00
 1.04563864e-01 4.64570086e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873476536797847
cond(S) = 43.73700579219945
E1 = -19.063062415953024  E_coul = 4.529211694923613
init E= -14.5338507210294
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300672504523697  LUMO = 3.70633366364136
  mo_energy =
[-4.71371602e+00 -3.00672505e-01  3.70633366e+00  2.61532552e+01
  1.37346582e+02  8.98954600e+02  8.66876431e+03]
E1 = -19.056836498841626  E_coul = 4.4983651754782645
cycle= 1 E= -14.5584713233634  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.24
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142451
diis-c [-2.02922457e-04  1.00000000e+00]
  HOMO = -0.3006414209409  LUMO = 3.70212828310074
  mo_energy =
[-4.72942901e+00 -3.00641421e-01  3.70212828e+00  2.61360943e+01
  1.37322769e+02  8.98924987e+02  8.66873194e+03]
E1 = -19.05356367361974  E_coul = 4.495054761781261
cycle= 2 E= -14.5585089118385  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171191
diis-c [-7.73228183e-07 -1.15208646e-01  1.11520865e+00]
  HOMO = -0.300798251462732  LUMO = 3.70141758157531
  mo_energy =
[-4.73111984e+00 -3.00798251e-01  3.70141758e+00  2.61344031e+01
  1.37320765e+02  8.98922790e+02  8.66872968e+03]
E1 = -19.053292253115192  E_coul = 4.494783067977232
cycle= 3 E= -14.558509185138  delta_E= -2.73e-07  |g|= 3.12e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.02653e-05
diis-c [-2.58395279e-10  9.31821721e-04 -6.22875781e-04  9.99691054e-01]
  HOMO = -0.300794425157676  LUMO = 3.70144085396643
  mo_energy =
[-4.73106705e+00 -3.00794425e-01  3.70144085e+00  2.61344720e+01
  1.37320872e+02  8.98922922e+02  8.66872982e+03]
E1 = -19.053299408880417  E_coul = 4.4947902236422275
cycle= 4 E= -14.5585091852382  delta_E= -1e-10  |g|= 1.21e-06  |ddm|= 2.46e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053299408880417  E_coul = 4.4947902236422275
  HOMO = -0.300794314293271  LUMO = 3.70144166994077
  mo_energy =
[-4.73106517e+00 -3.00794314e-01  3.70144167e+00  2.61344746e+01
  1.37320876e+02  8.98922927e+02  8.66872982e+03]
E1 = -19.05329966726109  E_coul = 4.494790482022775
Extra cycle  E= -14.5585091852383  delta_E= -1.24e-13  |g|= 8.63e-08  |ddm|= 7.98e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.73700579219945
E1 = -19.05329966726109  E_coul = 4.494790482022775
init E= -14.5585091852383
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300794306192774  LUMO = 3.70144172228105
  mo_energy =
[-4.73106505e+00 -3.00794306e-01  3.70144172e+00  2.61344748e+01
  1.37320876e+02  8.98922927e+02  8.66872982e+03]
E1 = -19.053299684945113  E_coul = 4.494790499706784
cycle= 1 E= -14.5585091852383  delta_E= -1.42e-14  |g|= 6.42e-09  |ddm|= 5.99e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053299684945113  E_coul = 4.494790499706784
  HOMO = -0.300794305578273  LUMO = 3.70144172582267
  mo_energy =
[-4.73106504e+00 -3.00794306e-01  3.70144173e+00  2.61344748e+01
  1.37320876e+02  8.98922927e+02  8.66872982e+03]
E1 = -19.05329968621335  E_coul = 4.494790500975031
Extra cycle  E= -14.5585091852383  delta_E= 1.07e-14  |g|= 5.11e-10  |ddm|= 4.71e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798675e+03 5.03778219e+02 7.58995603e+01 1.70775599e+01
 4.68475408e+00 1.41499995e+00 1.04563864e-01]
grad_E = [ 5.06924653e-08  8.90341575e-06 -2.37481212e-05  2.80808233e-05
 -2.21544343e-04  4.86755801e-04  3.16077996e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98673811        1
[INPUT] 0    0    [1    /1   ]  503.775725249        1
[INPUT] 0    0    [1    /1   ]  75.9088238303        1
[INPUT] 0    0    [1    /1   ]  17.0635046411        1
[INPUT] 0    0    [1    /1   ]  4.68373592292        1
[INPUT] 0    0    [1    /1   ]  1.41421132278        1
[INPUT] 0    0    [1    /1   ]  0.104560306977       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986738110071, 1.0]], [0, [503.7757252485245, 1.0]], [0, [75.90882383027473, 1.0]], [0, [17.063504641053708, 1.0]], [0, [4.683735922917519, 1.0]], [0, [1.4142113227811899, 1.0]], [0, [0.1045603069773747, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98673811]
bas 1, expnt(s) = [503.77572525]
bas 2, expnt(s) = [75.90882383]
bas 3, expnt(s) = [17.06350464]
bas 4, expnt(s) = [4.68373592]
bas 5, expnt(s) = [1.41421132]
bas 6, expnt(s) = [0.10456031]
CPU time:        44.36
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798674e+03 1.51080283e+03 5.03775725e+02 2.68653778e+02
 7.59088238e+01 6.49731946e+01 1.70635046e+01 2.12112470e+01
 4.68373592e+00 8.04376409e+00 1.41421132e+00 3.27642897e+00
 1.04560307e-01 4.64558233e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873481165539553
cond(S) = 43.73131935800798
E1 = -19.063027973808598  E_coul = 4.529206129707494
init E= -14.5338218441011
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300670462198707  LUMO = 3.70412494064214
  mo_energy =
[-4.71372068e+00 -3.00670462e-01  3.70412494e+00  2.61364950e+01
  1.37308046e+02  8.98928081e+02  8.66874262e+03]
E1 = -19.056732751207072  E_coul = 4.498260989126013
cycle= 1 E= -14.5584717620811  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.241
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142424
diis-c [-2.02845021e-04  1.00000000e+00]
  HOMO = -0.300643861457775  LUMO = 3.6998920330372
  mo_energy =
[-4.72947890e+00 -3.00643861e-01  3.69989203e+00  2.61192710e+01
  1.37284159e+02  8.98898365e+02  8.66871015e+03]
E1 = -19.053451572539156  E_coul = 4.4949421717338005
cycle= 2 E= -14.5585094008054  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.001713
diis-c [-7.73816922e-07 -1.15327543e-01  1.11532754e+00]
  HOMO = -0.300800972963351  LUMO = 3.69917911638098
  mo_energy =
[-4.73117434e+00 -3.00800973e-01  3.69917912e+00  2.61175731e+01
  1.37282147e+02  8.98896158e+02  8.66870788e+03]
E1 = -19.05317930412291  E_coul = 4.494669629667962
cycle= 3 E= -14.5585096744549  delta_E= -2.74e-07  |g|= 3.14e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.03772e-05
diis-c [-2.59226517e-10  9.27744514e-04 -4.82720439e-04  9.99554976e-01]
  HOMO = -0.30079712540627  LUMO = 3.69920251078085
  mo_energy =
[-4.73112130e+00 -3.00797125e-01  3.69920251e+00  2.61176423e+01
  1.37282254e+02  8.98896290e+02  8.66870802e+03]
E1 = -19.05318650556137  E_coul = 4.494676831004953
cycle= 4 E= -14.5585096745564  delta_E= -1.01e-10  |g|= 1.22e-06  |ddm|= 2.48e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05318650556137  E_coul = 4.494676831004953
  HOMO = -0.300797014275553  LUMO = 3.69920333001269
  mo_energy =
[-4.73111941e+00 -3.00797014e-01  3.69920333e+00  2.61176449e+01
  1.37282258e+02  8.98896295e+02  8.66870803e+03]
E1 = -19.053186764988947  E_coul = 4.4946770904324085
Extra cycle  E= -14.5585096745565  delta_E= -1.21e-13  |g|= 8.67e-08  |ddm|= 8e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798674e+03 5.03775725e+02 7.59088238e+01 1.70635046e+01
 4.68373592e+00 1.41421132e+00 1.04560307e-01]
E = -14.55850967455654
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98673811        1
[INPUT] 0    0    [1    /1   ]  503.775725249        1
[INPUT] 0    0    [1    /1   ]  75.9088238303        1
[INPUT] 0    0    [1    /1   ]  17.0635046411        1
[INPUT] 0    0    [1    /1   ]  4.68373592292        1
[INPUT] 0    0    [1    /1   ]  1.41421132278        1
[INPUT] 0    0    [1    /1   ]  0.104560306977       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986738110071, 1.0]], [0, [503.7757252485245, 1.0]], [0, [75.90882383027473, 1.0]], [0, [17.063504641053708, 1.0]], [0, [4.683735922917519, 1.0]], [0, [1.4142113227811899, 1.0]], [0, [0.1045603069773747, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98673811]
bas 1, expnt(s) = [503.77572525]
bas 2, expnt(s) = [75.90882383]
bas 3, expnt(s) = [17.06350464]
bas 4, expnt(s) = [4.68373592]
bas 5, expnt(s) = [1.41421132]
bas 6, expnt(s) = [0.10456031]
CPU time:        44.72
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798674e+03 1.51080283e+03 5.03775725e+02 2.68653778e+02
 7.59088238e+01 6.49731946e+01 1.70635046e+01 2.12112470e+01
 4.68373592e+00 8.04376409e+00 1.41421132e+00 3.27642897e+00
 1.04560307e-01 4.64558233e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.9873481165539553
cond(S) = 43.73131935800798
E1 = -19.063027973808598  E_coul = 4.529206129707494
init E= -14.5338218441011
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300670462198707  LUMO = 3.70412494064214
  mo_energy =
[-4.71372068e+00 -3.00670462e-01  3.70412494e+00  2.61364950e+01
  1.37308046e+02  8.98928081e+02  8.66874262e+03]
E1 = -19.056732751207072  E_coul = 4.498260989126013
cycle= 1 E= -14.5584717620811  delta_E= -0.0246  |g|= 0.0186  |ddm|= 0.241
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142424
diis-c [-2.02845021e-04  1.00000000e+00]
  HOMO = -0.300643861457775  LUMO = 3.6998920330372
  mo_energy =
[-4.72947890e+00 -3.00643861e-01  3.69989203e+00  2.61192710e+01
  1.37284159e+02  8.98898365e+02  8.66871015e+03]
E1 = -19.053451572539156  E_coul = 4.4949421717338005
cycle= 2 E= -14.5585094008054  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.001713
diis-c [-7.73816922e-07 -1.15327543e-01  1.11532754e+00]
  HOMO = -0.300800972963351  LUMO = 3.69917911638098
  mo_energy =
[-4.73117434e+00 -3.00800973e-01  3.69917912e+00  2.61175731e+01
  1.37282147e+02  8.98896158e+02  8.66870788e+03]
E1 = -19.05317930412291  E_coul = 4.494669629667962
cycle= 3 E= -14.5585096744549  delta_E= -2.74e-07  |g|= 3.14e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.03772e-05
diis-c [-2.59226517e-10  9.27744514e-04 -4.82720439e-04  9.99554976e-01]
  HOMO = -0.30079712540627  LUMO = 3.69920251078085
  mo_energy =
[-4.73112130e+00 -3.00797125e-01  3.69920251e+00  2.61176423e+01
  1.37282254e+02  8.98896290e+02  8.66870802e+03]
E1 = -19.05318650556137  E_coul = 4.494676831004953
cycle= 4 E= -14.5585096745564  delta_E= -1.01e-10  |g|= 1.22e-06  |ddm|= 2.48e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05318650556137  E_coul = 4.494676831004953
  HOMO = -0.300797014275553  LUMO = 3.69920333001269
  mo_energy =
[-4.73111941e+00 -3.00797014e-01  3.69920333e+00  2.61176449e+01
  1.37282258e+02  8.98896295e+02  8.66870803e+03]
E1 = -19.053186764988947  E_coul = 4.4946770904324085
Extra cycle  E= -14.5585096745565  delta_E= -1.21e-13  |g|= 8.67e-08  |ddm|= 8e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.73131935800798
E1 = -19.053186764988947  E_coul = 4.4946770904324085
init E= -14.5585096745565
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300797006158487  LUMO = 3.69920338258789
  mo_energy =
[-4.73111929e+00 -3.00797006e-01  3.69920338e+00  2.61176451e+01
  1.37282258e+02  8.98896295e+02  8.66870803e+03]
E1 = -19.05318678274537  E_coul = 4.494677108188826
cycle= 1 E= -14.5585096745565  delta_E= -5.33e-15  |g|= 6.44e-09  |ddm|= 6e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.05318678274537  E_coul = 4.494677108188826
  HOMO = -0.300797005542994  LUMO = 3.69920338614571
  mo_energy =
[-4.73111928e+00 -3.00797006e-01  3.69920339e+00  2.61176451e+01
  1.37282258e+02  8.98896295e+02  8.66870803e+03]
E1 = -19.053186784018507  E_coul = 4.4946771094619695
Extra cycle  E= -14.5585096745565  delta_E= 7.11e-15  |g|= 5.11e-10  |ddm|= 4.72e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798674e+03 5.03775725e+02 7.59088238e+01 1.70635046e+01
 4.68373592e+00 1.41421132e+00 1.04560307e-01]
grad_E = [ 5.10874709e-08  8.82395606e-06 -2.04271223e-05 -5.18224656e-06
 -7.55032003e-05  1.52353646e-04  9.85507050e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98674126        1
[INPUT] 0    0    [1    /1   ]  503.776317593        1
[INPUT] 0    0    [1    /1   ]  75.9066479608        1
[INPUT] 0    0    [1    /1   ]  17.066334009         1
[INPUT] 0    0    [1    /1   ]  4.68608601942        1
[INPUT] 0    0    [1    /1   ]  1.41439100874        1
[INPUT] 0    0    [1    /1   ]  0.104559008699       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.98674126181, 1.0]], [0, [503.7763175933224, 1.0]], [0, [75.90664796083034, 1.0]], [0, [17.066334008975065, 1.0]], [0, [4.686086019419339, 1.0]], [0, [1.4143910087366847, 1.0]], [0, [0.10455900869896748, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98674126]
bas 1, expnt(s) = [503.77631759]
bas 2, expnt(s) = [75.90664796]
bas 3, expnt(s) = [17.06633401]
bas 4, expnt(s) = [4.68608602]
bas 5, expnt(s) = [1.41439101]
bas 6, expnt(s) = [0.10455901]
CPU time:        46.77
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798674e+03 1.51080283e+03 5.03776318e+02 2.68654015e+02
 7.59066480e+01 6.49717978e+01 1.70663340e+01 2.12138847e+01
 4.68608602e+00 8.04679091e+00 1.41439101e+00 3.27674118e+00
 1.04559009e-01 4.64553907e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987347208509083
cond(S) = 43.73989588689234
E1 = -19.062994757872065  E_coul = 4.529185733269541
init E= -14.5338090246025
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300671605006807  LUMO = 3.70555755986521
  mo_energy =
[-4.71372972e+00 -3.00671605e-01  3.70555756e+00  2.61457137e+01
  1.37323291e+02  8.98939389e+02  8.66875150e+03]
E1 = -19.056693746807735  E_coul = 4.498221910639143
cycle= 1 E= -14.5584718361686  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.241
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142456
diis-c [-2.02936451e-04  1.00000000e+00]
  HOMO = -0.30064509186866  LUMO = 3.70131710704518
  mo_energy =
[-4.72949725e+00 -3.00645092e-01  3.70131711e+00  2.61284722e+01
  1.37299389e+02  8.98909650e+02  8.66871902e+03]
E1 = -19.053412092702455  E_coul = 4.494902626328124
cycle= 2 E= -14.5585094663743  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171296
diis-c [-7.73503026e-07 -1.15303936e-01  1.11530394e+00]
  HOMO = -0.300802145538633  LUMO = 3.70060387381215
  mo_energy =
[-4.73119296e+00 -3.00802146e-01  3.70060387e+00  2.61267731e+01
  1.37297376e+02  8.98907442e+02  8.66871674e+03]
E1 = -19.05313988374776  E_coul = 4.4946301440031995
cycle= 3 E= -14.5585097397446  delta_E= -2.73e-07  |g|= 3.14e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.03983e-05
diis-c [-2.59450755e-10  9.23531954e-04 -4.28157576e-04  9.99504626e-01]
  HOMO = -0.300798297824277  LUMO = 3.70062728653662
  mo_energy =
[-4.73113990e+00 -3.00798298e-01  3.70062729e+00  2.61268424e+01
  1.37297482e+02  8.98907575e+02  8.66871688e+03]
E1 = -19.053147087561968  E_coul = 4.494637347715854
cycle= 4 E= -14.5585097398461  delta_E= -1.02e-10  |g|= 1.22e-06  |ddm|= 2.48e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053147087561968  E_coul = 4.494637347715854
  HOMO = -0.300798186716478  LUMO = 3.7006281066581
  mo_energy =
[-4.73113801e+00 -3.00798187e-01  3.70062811e+00  2.61268450e+01
  1.37297486e+02  8.98907579e+02  8.66871689e+03]
E1 = -19.05314734705909  E_coul = 4.4946376072128515
Extra cycle  E= -14.5585097398462  delta_E= -1.28e-13  |g|= 8.68e-08  |ddm|= 7.99e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798674e+03 5.03776318e+02 7.59066480e+01 1.70663340e+01
 4.68608602e+00 1.41439101e+00 1.04559009e-01]
E = -14.55850973984624
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:52:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98674126        1
[INPUT] 0    0    [1    /1   ]  503.776317593        1
[INPUT] 0    0    [1    /1   ]  75.9066479608        1
[INPUT] 0    0    [1    /1   ]  17.066334009         1
[INPUT] 0    0    [1    /1   ]  4.68608601942        1
[INPUT] 0    0    [1    /1   ]  1.41439100874        1
[INPUT] 0    0    [1    /1   ]  0.104559008699       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.98674126181, 1.0]], [0, [503.7763175933224, 1.0]], [0, [75.90664796083034, 1.0]], [0, [17.066334008975065, 1.0]], [0, [4.686086019419339, 1.0]], [0, [1.4143910087366847, 1.0]], [0, [0.10455900869896748, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98674126]
bas 1, expnt(s) = [503.77631759]
bas 2, expnt(s) = [75.90664796]
bas 3, expnt(s) = [17.06633401]
bas 4, expnt(s) = [4.68608602]
bas 5, expnt(s) = [1.41439101]
bas 6, expnt(s) = [0.10455901]
CPU time:        47.15
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798674e+03 1.51080283e+03 5.03776318e+02 2.68654015e+02
 7.59066480e+01 6.49717978e+01 1.70663340e+01 2.12138847e+01
 4.68608602e+00 8.04679091e+00 1.41439101e+00 3.27674118e+00
 1.04559009e-01 4.64553907e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987347208509083
cond(S) = 43.73989588689234
E1 = -19.062994757872065  E_coul = 4.529185733269541
init E= -14.5338090246025
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300671605006807  LUMO = 3.70555755986521
  mo_energy =
[-4.71372972e+00 -3.00671605e-01  3.70555756e+00  2.61457137e+01
  1.37323291e+02  8.98939389e+02  8.66875150e+03]
E1 = -19.056693746807735  E_coul = 4.498221910639143
cycle= 1 E= -14.5584718361686  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.241
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142456
diis-c [-2.02936451e-04  1.00000000e+00]
  HOMO = -0.30064509186866  LUMO = 3.70131710704518
  mo_energy =
[-4.72949725e+00 -3.00645092e-01  3.70131711e+00  2.61284722e+01
  1.37299389e+02  8.98909650e+02  8.66871902e+03]
E1 = -19.053412092702455  E_coul = 4.494902626328124
cycle= 2 E= -14.5585094663743  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171296
diis-c [-7.73503026e-07 -1.15303936e-01  1.11530394e+00]
  HOMO = -0.300802145538633  LUMO = 3.70060387381215
  mo_energy =
[-4.73119296e+00 -3.00802146e-01  3.70060387e+00  2.61267731e+01
  1.37297376e+02  8.98907442e+02  8.66871674e+03]
E1 = -19.05313988374776  E_coul = 4.4946301440031995
cycle= 3 E= -14.5585097397446  delta_E= -2.73e-07  |g|= 3.14e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.03983e-05
diis-c [-2.59450755e-10  9.23531954e-04 -4.28157576e-04  9.99504626e-01]
  HOMO = -0.300798297824277  LUMO = 3.70062728653662
  mo_energy =
[-4.73113990e+00 -3.00798298e-01  3.70062729e+00  2.61268424e+01
  1.37297482e+02  8.98907575e+02  8.66871688e+03]
E1 = -19.053147087561968  E_coul = 4.494637347715854
cycle= 4 E= -14.5585097398461  delta_E= -1.02e-10  |g|= 1.22e-06  |ddm|= 2.48e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.053147087561968  E_coul = 4.494637347715854
  HOMO = -0.300798186716478  LUMO = 3.7006281066581
  mo_energy =
[-4.73113801e+00 -3.00798187e-01  3.70062811e+00  2.61268450e+01
  1.37297486e+02  8.98907579e+02  8.66871689e+03]
E1 = -19.05314734705909  E_coul = 4.4946376072128515
Extra cycle  E= -14.5585097398462  delta_E= -1.28e-13  |g|= 8.68e-08  |ddm|= 7.99e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.73989588689234
E1 = -19.05314734705909  E_coul = 4.4946376072128515
init E= -14.5585097398462
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300798178606784  LUMO = 3.7006281592728
  mo_energy =
[-4.73113789e+00 -3.00798179e-01  3.70062816e+00  2.61268452e+01
  1.37297487e+02  8.98907580e+02  8.66871689e+03]
E1 = -19.053147364811444  E_coul = 4.494637624965208
cycle= 1 E= -14.5585097398462  delta_E= 3.55e-15  |g|= 6.44e-09  |ddm|= 5.99e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053147364811444  E_coul = 4.494637624965208
  HOMO = -0.300798177992253  LUMO = 3.70062816283149
  mo_energy =
[-4.73113788e+00 -3.00798178e-01  3.70062816e+00  2.61268452e+01
  1.37297487e+02  8.98907580e+02  8.66871689e+03]
E1 = -19.053147366083518  E_coul = 4.494637626237274
Extra cycle  E= -14.5585097398462  delta_E= -7.11e-15  |g|= 5.1e-10  |ddm|= 4.71e-09
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798674e+03 5.03776318e+02 7.59066480e+01 1.70663340e+01
 4.68608602e+00 1.41439101e+00 1.04559009e-01]
grad_E = [ 5.10991409e-08  8.82077692e-06 -2.00822696e-05 -1.46435902e-05
 -1.05904744e-05  1.10005305e-05  7.36485973e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:53:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98674326        1
[INPUT] 0    0    [1    /1   ]  503.776694625        1
[INPUT] 0    0    [1    /1   ]  75.9052442686        1
[INPUT] 0    0    [1    /1   ]  17.0683550485        1
[INPUT] 0    0    [1    /1   ]  4.68690472777        1
[INPUT] 0    0    [1    /1   ]  1.41451915687        1
[INPUT] 0    0    [1    /1   ]  0.10455891302        1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986743263175, 1.0]], [0, [503.7766946253094, 1.0]], [0, [75.90524426858897, 1.0]], [0, [17.068355048504177, 1.0]], [0, [4.686904727766843, 1.0]], [0, [1.4145191568664266, 1.0]], [0, [0.10455891302018443, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98674326]
bas 1, expnt(s) = [503.77669463]
bas 2, expnt(s) = [75.90524427]
bas 3, expnt(s) = [17.06835505]
bas 4, expnt(s) = [4.68690473]
bas 5, expnt(s) = [1.41451916]
bas 6, expnt(s) = [0.10455891]
CPU time:        49.25
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798674e+03 1.51080283e+03 5.03776695e+02 2.68654165e+02
 7.59052443e+01 6.49708967e+01 1.70683550e+01 2.12157689e+01
 4.68690473e+00 8.04784528e+00 1.41451916e+00 3.27696384e+00
 1.04558913e-01 4.64553588e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987346889301575
cond(S) = 43.743293153349235
E1 = -19.062987538091512  E_coul = 4.529179853459576
init E= -14.5338076846319
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300672149160231  LUMO = 3.70620361619298
  mo_energy =
[-4.71373213e+00 -3.00672149e-01  3.70620362e+00  2.61499868e+01
  1.37331236e+02  8.98945167e+02  8.66875610e+03]
E1 = -19.056690894923488  E_coul = 4.498219048203908
cycle= 1 E= -14.5584718467196  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.241
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142468
diis-c [-2.02969924e-04  1.00000000e+00]
  HOMO = -0.300645263430534  LUMO = 3.70196325007174
  mo_energy =
[-4.72949851e+00 -3.00645263e-01  3.70196325e+00  2.61327455e+01
  1.37307335e+02  8.98915431e+02  8.66872362e+03]
E1 = -19.053409839740162  E_coul = 4.4949003700679455
cycle= 2 E= -14.5585094696722  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171285
diis-c [-7.73333243e-07 -1.15286690e-01  1.11528669e+00]
  HOMO = -0.300802273919896  LUMO = 3.70125011481298
  mo_energy =
[-4.73119390e+00 -3.00802274e-01  3.70125011e+00  2.61310466e+01
  1.37305322e+02  8.98913224e+02  8.66872134e+03]
E1 = -19.053137724878464  E_coul = 4.494627981955531
cycle= 3 E= -14.5585097429229  delta_E= -2.73e-07  |g|= 3.14e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.03951e-05
diis-c [-2.59433953e-10  9.22590304e-04 -4.23023495e-04  9.99500433e-01]
  HOMO = -0.300798427948548  LUMO = 3.70127352282941
  mo_energy =
[-4.73114085e+00 -3.00798428e-01  3.70127352e+00  2.61311159e+01
  1.37305429e+02  8.98913356e+02  8.66872148e+03]
E1 = -19.05314492553722  E_coul = 4.494635182512808
cycle= 4 E= -14.5585097430244  delta_E= -1.01e-10  |g|= 1.22e-06  |ddm|= 2.47e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05314492553722  E_coul = 4.494635182512808
  HOMO = -0.300798316872037  LUMO = 3.70127434293631
  mo_energy =
[-4.73113896e+00 -3.00798317e-01  3.70127434e+00  2.61311185e+01
  1.37305433e+02  8.98913361e+02  8.66872149e+03]
E1 = -19.053145184962297  E_coul = 4.4946354419377625
Extra cycle  E= -14.5585097430245  delta_E= -1.21e-13  |g|= 8.68e-08  |ddm|= 7.99e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798674e+03 5.03776695e+02 7.59052443e+01 1.70683550e+01
 4.68690473e+00 1.41451916e+00 1.04558913e-01]
E = -14.558509743024533
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:53:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98674326        1
[INPUT] 0    0    [1    /1   ]  503.776694625        1
[INPUT] 0    0    [1    /1   ]  75.9052442686        1
[INPUT] 0    0    [1    /1   ]  17.0683550485        1
[INPUT] 0    0    [1    /1   ]  4.68690472777        1
[INPUT] 0    0    [1    /1   ]  1.41451915687        1
[INPUT] 0    0    [1    /1   ]  0.10455891302        1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986743263175, 1.0]], [0, [503.7766946253094, 1.0]], [0, [75.90524426858897, 1.0]], [0, [17.068355048504177, 1.0]], [0, [4.686904727766843, 1.0]], [0, [1.4145191568664266, 1.0]], [0, [0.10455891302018443, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98674326]
bas 1, expnt(s) = [503.77669463]
bas 2, expnt(s) = [75.90524427]
bas 3, expnt(s) = [17.06835505]
bas 4, expnt(s) = [4.68690473]
bas 5, expnt(s) = [1.41451916]
bas 6, expnt(s) = [0.10455891]
CPU time:        49.65
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798674e+03 1.51080283e+03 5.03776695e+02 2.68654165e+02
 7.59052443e+01 6.49708967e+01 1.70683550e+01 2.12157689e+01
 4.68690473e+00 8.04784528e+00 1.41451916e+00 3.27696384e+00
 1.04558913e-01 4.64553588e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987346889301575
cond(S) = 43.743293153349235
E1 = -19.062987538091512  E_coul = 4.529179853459576
init E= -14.5338076846319
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300672149160231  LUMO = 3.70620361619298
  mo_energy =
[-4.71373213e+00 -3.00672149e-01  3.70620362e+00  2.61499868e+01
  1.37331236e+02  8.98945167e+02  8.66875610e+03]
E1 = -19.056690894923488  E_coul = 4.498219048203908
cycle= 1 E= -14.5584718467196  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.241
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142468
diis-c [-2.02969924e-04  1.00000000e+00]
  HOMO = -0.300645263430534  LUMO = 3.70196325007174
  mo_energy =
[-4.72949851e+00 -3.00645263e-01  3.70196325e+00  2.61327455e+01
  1.37307335e+02  8.98915431e+02  8.66872362e+03]
E1 = -19.053409839740162  E_coul = 4.4949003700679455
cycle= 2 E= -14.5585094696722  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171285
diis-c [-7.73333243e-07 -1.15286690e-01  1.11528669e+00]
  HOMO = -0.300802273919896  LUMO = 3.70125011481298
  mo_energy =
[-4.73119390e+00 -3.00802274e-01  3.70125011e+00  2.61310466e+01
  1.37305322e+02  8.98913224e+02  8.66872134e+03]
E1 = -19.053137724878464  E_coul = 4.494627981955531
cycle= 3 E= -14.5585097429229  delta_E= -2.73e-07  |g|= 3.14e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.03951e-05
diis-c [-2.59433953e-10  9.22590304e-04 -4.23023495e-04  9.99500433e-01]
  HOMO = -0.300798427948548  LUMO = 3.70127352282941
  mo_energy =
[-4.73114085e+00 -3.00798428e-01  3.70127352e+00  2.61311159e+01
  1.37305429e+02  8.98913356e+02  8.66872148e+03]
E1 = -19.05314492553722  E_coul = 4.494635182512808
cycle= 4 E= -14.5585097430244  delta_E= -1.01e-10  |g|= 1.22e-06  |ddm|= 2.47e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05314492553722  E_coul = 4.494635182512808
  HOMO = -0.300798316872037  LUMO = 3.70127434293631
  mo_energy =
[-4.73113896e+00 -3.00798317e-01  3.70127434e+00  2.61311185e+01
  1.37305433e+02  8.98913361e+02  8.66872149e+03]
E1 = -19.053145184962297  E_coul = 4.4946354419377625
Extra cycle  E= -14.5585097430245  delta_E= -1.21e-13  |g|= 8.68e-08  |ddm|= 7.99e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 43.743293153349235
E1 = -19.053145184962297  E_coul = 4.4946354419377625
init E= -14.5585097430245
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.300798308766149  LUMO = 3.70127439554241
  mo_energy =
[-4.73113884e+00 -3.00798309e-01  3.70127440e+00  2.61311187e+01
  1.37305433e+02  8.98913361e+02  8.66872149e+03]
E1 = -19.053145202706915  E_coul = 4.494635459682388
cycle= 1 E= -14.5585097430245  delta_E= 7.11e-15  |g|= 6.44e-09  |ddm|= 5.99e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -19.053145202706915  E_coul = 4.494635459682388
  HOMO = -0.300798308152004  LUMO = 3.70127439909988
  mo_energy =
[-4.73113883e+00 -3.00798308e-01  3.70127440e+00  2.61311187e+01
  1.37305433e+02  8.98913361e+02  8.66872149e+03]
E1 = -19.05314520397821  E_coul = 4.494635460953667
Extra cycle  E= -14.5585097430245  delta_E= -1.78e-14  |g|= 5.09e-10  |ddm|= 4.7e-09
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [5.03798674e+03 5.03776695e+02 7.59052443e+01 1.70683550e+01
 4.68690473e+00 1.41451916e+00 1.04558913e-01]
grad_E = [ 5.10706773e-08  8.82624699e-06 -2.02467825e-05 -1.48277916e-05
 -2.86286182e-06 -3.53054380e-06 -1.79708652e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:53:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98674376        1
[INPUT] 0    0    [1    /1   ]  503.776789613        1
[INPUT] 0    0    [1    /1   ]  75.9048763001        1
[INPUT] 0    0    [1    /1   ]  17.068938788         1
[INPUT] 0    0    [1    /1   ]  4.68711416131        1
[INPUT] 0    0    [1    /1   ]  1.41455744819        1
[INPUT] 0    0    [1    /1   ]  0.104558913605       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986743762645, 1.0]], [0, [503.7767896130078, 1.0]], [0, [75.90487630009983, 1.0]], [0, [17.068938787974535, 1.0]], [0, [4.6871141613126985, 1.0]], [0, [1.4145574481918184, 1.0]], [0, [0.10455891360460608, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98674376]
bas 1, expnt(s) = [503.77678961]
bas 2, expnt(s) = [75.9048763]
bas 3, expnt(s) = [17.06893879]
bas 4, expnt(s) = [4.68711416]
bas 5, expnt(s) = [1.41455745]
bas 6, expnt(s) = [0.10455891]
CPU time:        51.77
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798674e+03 1.51080283e+03 5.03776790e+02 2.68654203e+02
 7.59048763e+01 6.49706605e+01 1.70689388e+01 2.12163131e+01
 4.68711416e+00 8.04811499e+00 1.41455745e+00 3.27703037e+00
 1.04558914e-01 4.64553590e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987346807838792
cond(S) = 43.74421839795051
E1 = -19.06298600906303  E_coul = 4.529178429171204
init E= -14.5338075798918
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300672301913927  LUMO = 3.70638132967808
  mo_energy =
[-4.71373270e+00 -3.00672302e-01  3.70638133e+00  2.61511533e+01
  1.37333476e+02  8.98946857e+02  8.66875743e+03]
E1 = -19.056690995392362  E_coul = 4.498219145467879
cycle= 1 E= -14.5584718499245  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.241
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142471
diis-c [-2.02978441e-04  1.00000000e+00]
  HOMO = -0.300645289267995  LUMO = 3.70214119463888
  mo_energy =
[-4.72949843e+00 -3.00645289e-01  3.70214119e+00  2.61339126e+01
  1.37309577e+02  8.98917122e+02  8.66872495e+03]
E1 = -19.05341015376475  E_coul = 4.494900683090754
cycle= 2 E= -14.558509470674  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171281
diis-c [-7.73283106e-07 -1.15281623e-01  1.11528162e+00]
  HOMO = -0.300802286866326  LUMO = 3.70142810063486
  mo_energy =
[-4.73119371e+00 -3.00802287e-01  3.70142810e+00  2.61322138e+01
  1.37307564e+02  8.98914914e+02  8.66872268e+03]
E1 = -19.053138068768995  E_coul = 4.494628324876812
cycle= 3 E= -14.5585097438922  delta_E= -2.73e-07  |g|= 3.14e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.03935e-05
diis-c [-2.59420594e-10  9.22390590e-04 -4.22729542e-04  9.99500339e-01]
  HOMO = -0.300798441472451  LUMO = 3.70145150662444
  mo_energy =
[-4.73114067e+00 -3.00798441e-01  3.70145151e+00  2.61322831e+01
  1.37307671e+02  8.98915047e+02  8.66872282e+03]
E1 = -19.05314526832488  E_coul = 4.494635524331257
cycle= 4 E= -14.5585097439936  delta_E= -1.01e-10  |g|= 1.22e-06  |ddm|= 2.47e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05314526832488  E_coul = 4.494635524331257
  HOMO = -0.300798330405859  LUMO = 3.70145232670217
  mo_energy =
[-4.73113878e+00 -3.00798330e-01  3.70145233e+00  2.61322857e+01
  1.37307675e+02  8.98915052e+02  8.66872282e+03]
E1 = -19.053145527723927  E_coul = 4.494635783730162
Extra cycle  E= -14.5585097439938  delta_E= -1.44e-13  |g|= 8.68e-08  |ddm|= 7.99e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798674e+03 5.03776790e+02 7.59048763e+01 1.70689388e+01
 4.68711416e+00 1.41455745e+00 1.04558914e-01]
E = -14.558509743993765
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -14.558509743993765
       x: [ 5.038e+03  5.038e+02  7.590e+01  1.707e+01  4.687e+00
            1.415e+00  1.046e-01]
     nit: 21
     jac: [ 5.107e-08  8.826e-06 -2.025e-05 -1.483e-05 -2.863e-06
           -3.531e-06 -1.797e-06]
    nfev: 24
    njev: 21
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Be_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np

from scipy import optimize

VERBOSITY = 9

def atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))

    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponent}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponent, exp_array=None):
    if exp_array is None:
        exp_array = np.zeros((exponent.size, 2))
        
    mol = gto.Mole()
    mol.atom = 'Be 0 0 0'  # in Angstrom

    basis_string = '\n'.join([f'''
    Be  S
        {exp_array[i, 0] if exp_array[i, 1] == 1 else exponent[i]}              1.0'''
        for i in range(exponent.shape[0])])
    mol.basis = {'Be': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponent}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(n, exp_array=None):
    # x0 = [0.5 * (n-i) for i in range(n)]
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(n))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
exp_Be_2s = [3.8693654806627906e+00,1.0012498644798325e-01]
exp_Be_3s = [1.9442821925479006e+01,2.7411959081016830e+00,1.0297349419021139e-01]
exp_Be_4s = [6.5991087567228320e+01,9.8486370415898303e+00,2.0503188162180708e+00,1.0386429206483960e-01]
exp_Be_5s = [1.9212671226013924e+02,2.8950720678587700e+01,6.4105353198681128e+00,1.6612105938420099e+00,1.0444120248462711e-01]
exp_Be_6s = [5.0379868601911357e+02,7.5823811181593612e+01,1.7187857030572196e+01,4.7133104440196352e+00,1.4188035528345215e+00,1.0454890844699254e-01]

N = 7

exps = np.zeros((N, 2))
exps[1:, 0] = exp_Be_6s[:]
exps[0, 0] = np.max(exp_Be_6s) * 10.0

minimize_energy(N, exps)
#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Tue Mar  7 18:53:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Be     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Be
[INPUT] 0    0    [1    /1   ]  5037.98674376        1
[INPUT] 0    0    [1    /1   ]  503.776789613        1
[INPUT] 0    0    [1    /1   ]  75.9048763001        1
[INPUT] 0    0    [1    /1   ]  17.068938788         1
[INPUT] 0    0    [1    /1   ]  4.68711416131        1
[INPUT] 0    0    [1    /1   ]  1.41455744819        1
[INPUT] 0    0    [1    /1   ]  0.104558913605       1

nuclear repulsion = 0
number of shells = 7
number of NR pGTOs = 7
number of NR cGTOs = 7
basis = {'Be': [[0, [5037.986743762645, 1.0]], [0, [503.7767896130078, 1.0]], [0, [75.90487630009983, 1.0]], [0, [17.068938787974535, 1.0]], [0, [4.6871141613126985, 1.0]], [0, [1.4145574481918184, 1.0]], [0, [0.10455891360460608, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [5037.98674376]
bas 1, expnt(s) = [503.77678961]
bas 2, expnt(s) = [75.9048763]
bas 3, expnt(s) = [17.06893879]
bas 4, expnt(s) = [4.68711416]
bas 5, expnt(s) = [1.41455745]
bas 6, expnt(s) = [0.10455891]
CPU time:        52.19
arg.atm = [[ 4 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 5.03798674e+03 1.51080283e+03 5.03776790e+02 2.68654203e+02
 7.59048763e+01 6.49706605e+01 1.70689388e+01 2.12163131e+01
 4.68711416e+00 8.04811499e+00 1.41455745e+00 3.27703037e+00
 1.04558914e-01 4.64553590e-01]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 3.987346807838792
cond(S) = 43.74421839795051
E1 = -19.06298600906303  E_coul = 4.529178429171204
init E= -14.5338075798918
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.300672301913927  LUMO = 3.70638132967808
  mo_energy =
[-4.71373270e+00 -3.00672302e-01  3.70638133e+00  2.61511533e+01
  1.37333476e+02  8.98946857e+02  8.66875743e+03]
E1 = -19.056690995392362  E_coul = 4.498219145467879
cycle= 1 E= -14.5584718499245  delta_E= -0.0247  |g|= 0.0186  |ddm|= 0.241
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0142471
diis-c [-2.02978441e-04  1.00000000e+00]
  HOMO = -0.300645289267995  LUMO = 3.70214119463888
  mo_energy =
[-4.72949843e+00 -3.00645289e-01  3.70214119e+00  2.61339126e+01
  1.37309577e+02  8.98917122e+02  8.66872495e+03]
E1 = -19.05341015376475  E_coul = 4.494900683090754
cycle= 2 E= -14.558509470674  delta_E= -3.76e-05  |g|= 0.00147  |ddm|= 0.014
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00171281
diis-c [-7.73283106e-07 -1.15281623e-01  1.11528162e+00]
  HOMO = -0.300802286866326  LUMO = 3.70142810063486
  mo_energy =
[-4.73119371e+00 -3.00802287e-01  3.70142810e+00  2.61322138e+01
  1.37307564e+02  8.98914914e+02  8.66872268e+03]
E1 = -19.053138068768995  E_coul = 4.494628324876812
cycle= 3 E= -14.5585097438922  delta_E= -2.73e-07  |g|= 3.14e-05  |ddm|= 0.00123
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.03935e-05
diis-c [-2.59420594e-10  9.22390590e-04 -4.22729542e-04  9.99500339e-01]
  HOMO = -0.300798441472451  LUMO = 3.70145150662444
  mo_energy =
[-4.73114067e+00 -3.00798441e-01  3.70145151e+00  2.61322831e+01
  1.37307671e+02  8.98915047e+02  8.66872282e+03]
E1 = -19.05314526832488  E_coul = 4.494635524331257
cycle= 4 E= -14.5585097439936  delta_E= -1.01e-10  |g|= 1.22e-06  |ddm|= 2.47e-05
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
E1 = -19.05314526832488  E_coul = 4.494635524331257
  HOMO = -0.300798330405859  LUMO = 3.70145232670217
  mo_energy =
[-4.73113878e+00 -3.00798330e-01  3.70145233e+00  2.61322857e+01
  1.37307675e+02  8.98915052e+02  8.66872282e+03]
E1 = -19.053145527723927  E_coul = 4.494635783730162
Extra cycle  E= -14.5585097439938  delta_E= -1.44e-13  |g|= 8.68e-08  |ddm|= 7.99e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [5.03798674e+03 5.03776790e+02 7.59048763e+01 1.70689388e+01
 4.68711416e+00 1.41455745e+00 1.04558914e-01]
E = -14.558509743993765
E = -14.558509743993765
exp = [5.0379867437626453e+03,5.0377678961300779e+02,7.5904876300099829e+01,1.7068938787974535e+01,4.6871141613126985e+00,1.4145574481918184e+00,1.0455891360460608e-01]
